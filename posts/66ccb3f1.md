<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ç®€ä»‹

ä¸€ç›´åœ¨ä½¿ç”¨ [TianliGPT](https://docs_s.tianli0.top/) ä½œä¸ºåšå®¢çš„æ‘˜è¦ç”ŸæˆæœåŠ¡, ä¾¿å®œå¥½ç”¨. å¹´å‰çˆ†ç«çš„ DeepSeek-R1 ç®—æ˜¯æŠŠ LLM API çš„ä»·æ ¼æ‰“ä¸‹æ¥äº†, ä¾¿æœ‰äº†æ›¿æ¢ AI æ–‡ç« æ‘˜è¦çš„æƒ³æ³•.

å…¶å®åœ¨ [[npx-card-dev|ä½¿ç”¨ Node.js å¼€å‘æ•°å­—åç‰‡å¹¶é›†æˆ Chat æœåŠ¡]] è¿™ç¯‡æ–‡ç« å·²ç»å°†æœ¬åœ°çš„ LLM API æœåŠ¡æ­å»ºå¥½äº†, å› ä¸º TianliGPT çš„è¯­éŸ³æ’­æŠ¥æœåŠ¡æ— æ³•ä½¿ç”¨, æ‰€ä»¥ä¸€ç›´åœ¨ç­‰ [Kokoro TTS](https://huggingface.co/hexgrad/Kokoro-82M) çš„ä¸­æ–‡æ¨¡å‹, æ­£å¥½ä»Šå¤©å¼€æºäº†, æ‰€ä»¥åˆå¯ä»¥å¼€å§‹æŠ˜è…¾äº†.

## éœ€æ±‚æ•´ç†

- ä½¿ç”¨è‡ªå»º AI API ä»£æ›¿ TianliGPT API æ¥ç”Ÿæˆæ–‡ç« æ‘˜è¦;
- ä½¿ç”¨ Kokoro TTS å°†æ–‡ç« æ‘˜è¦ç”Ÿæˆè¯­éŸ³å¹¶æ’­æ”¾;

éœ€æ±‚å…¶å®æŒºç®€å•, å°±æ˜¯æ›¿æ¢æˆéƒ¨ç½²åˆ° HomeLab çš„ API, So easy ğŸ™‰.

---

## æ¶æ„å›¾

![20250208223047_6SH1UonG.webp](https://cdn.dong4j.site/source/image/20250208223047_6SH1UonG.webp)

## ä¸€ã€ç¯å¢ƒå‡†å¤‡

### 1. æŠ€æœ¯æ ˆæ¦‚è¿°

- åšå®¢æ¡†æ¶ï¼šHexo
- AI æœåŠ¡ï¼šæœ¬åœ°éƒ¨ç½²çš„ LLM ä»¥åŠåœ¨çº¿å…è´¹çš„ LLM æœåŠ¡ API, é€šè¿‡ one-api ä»£ç†ï¼ˆæ›¿ä»£ TianliGPTï¼‰
- è¯­éŸ³åˆæˆï¼šKokoro TTS

### 2. ç¡¬ä»¶ä¸è½¯ä»¶è¦æ±‚

- æœåŠ¡å™¨ç¯å¢ƒ:
  - Mac mini M2(16G å†…å­˜), ç”¨äºéƒ¨ç½² Kokoro TTS;
  - M920x: ç”¨äºéƒ¨ç½²æ‘˜è¦æœåŠ¡å’Œè¯­éŸ³ç”Ÿæˆå®¢æˆ·ç«¯æœåŠ¡;
- å¼€å‘å·¥å…·:
  - Node.js: æ‘˜è¦æœåŠ¡;
  - Python: è¯­éŸ³ç”Ÿæˆå®¢æˆ·ç«¯æœåŠ¡;
  - pm2: æœåŠ¡å™¨éƒ¨ç½²ä½¿ç”¨;

---

## äºŒã€å®ç°ç»†èŠ‚

### 1. Hexo ä»£ç ä¿®æ”¹

é€šè¿‡ç›´æ¥ä¿®æ”¹ TianliGPT ä»£ç å®ç°, å®‰çŸ¥é±¼ä¸»é¢˜ä¸­çš„ `themes/anzhiyu/source/js/anzhiyu/ai_abstract.js` æ˜¯æ–‡ç« æ‘˜è¦æœåŠ¡çš„ä¸»è¦é€»è¾‘, æˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªæ–‡ä»¶æ‹·è´å‡ºæ¥è¿›è¡Œç›¸åº”çš„ä¿®æ”¹:

```javascript
(function () {
  const {
    randomNum,
    basicWordCount,
    btnLink,
    apiUrl,
    audioUrl,
    key: AIKey,
    Referer: AIReferer,
    gptName,
    switchBtn,
    mode: initialMode,
  } = GLOBAL_CONFIG.postHeadAiDescription;

  const { title, postAI, pageFillDescription } = GLOBAL_CONFIG_SITE;

  let lastAiRandomIndex = -1;
  let animationRunning = true;
  let mode = initialMode;
  let refreshNum = 0;
  let prevParam;
  let audio = null;
  let isPaused = false;
  let summaryID = null;

  const post_ai = document.querySelector(".post-ai-description");
  const aiTitleRefreshIcon = post_ai.querySelector(
    ".ai-title .anzhiyufont.anzhiyu-icon-arrow-rotate-right"
  );
  let aiReadAloudIcon = post_ai.querySelector(".anzhiyu-icon-circle-dot");
  const explanation = post_ai.querySelector(".ai-explanation");

  let aiStr = "";
  let aiStrLength = "";
  let delayInit = 600;
  let indexI = 0;
  let indexJ = 0;
  let timeouts = [];
  let elapsed = 0;

  const observer = createIntersectionObserver();
  const aiFunctions = [
    introduce,
    aiTitleRefreshIconClick,
    aiRecommend,
    aiGoHome,
    subscribe,
  ];

  const aiBtnList = post_ai.querySelectorAll(".ai-btn-item");
  const filteredHeadings = Array.from(aiBtnList)
    .filter((heading) => heading.id !== "go-tianli-blog")
    .filter((heading) => heading.id !== "read-audio")
    .filter((heading) => heading.id !== "go-comment");
  filteredHeadings.forEach((item, index) => {
    item.addEventListener("click", () => {
      aiFunctions[index]();
    });
  });

  document.getElementById("ai-tag").addEventListener("click", onAiTagClick);
  aiTitleRefreshIcon.addEventListener("click", onAiTitleRefreshIconClick);
  document.getElementById("go-tianli-blog").addEventListener("click", () => {
    window.open(btnLink, "_blank");
  });
  document.getElementById("go-comment").addEventListener("click", () => {
    anzhiyu.scrollToDest(document.body.scrollHeight, 500);
  });
  document.getElementById("read-audio").addEventListener("click", readAloud);
  aiReadAloudIcon.addEventListener("click", readAloud);

  async function readAloud() {
    if (!summaryID) {
      anzhiyu.snackbarShow("æ‘˜è¦è¿˜æ²¡åŠ è½½å®Œå‘¢ï¼Œè¯·ç¨åã€‚ã€‚ã€‚");
      return;
    }
    aiReadAloudIcon = post_ai.querySelector(".anzhiyu-icon-circle-dot");
    aiReadAloudIcon.style.opacity = "0.2";
    if (audio && !isPaused) {
      audio.pause();
      isPaused = true;
      aiReadAloudIcon.style.opacity = "1";
      aiReadAloudIcon.style.animation = "";
      aiReadAloudIcon.style.cssText =
        "animation: ''; opacity: 1;cursor: pointer;";
      return;
    }

    if (audio && isPaused) {
      audio.play();
      isPaused = false;
      aiReadAloudIcon.style.cssText =
        "animation: breathe .5s linear infinite; opacity: 0.2;cursor: pointer";
      return;
    }

    const options = {
      key: AIKey,
      Referer: AIReferer,
    };
    const requestParams = new URLSearchParams({
      key: options.key,
      id: summaryID,
    });

    const requestOptions = {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        Referer: options.Referer,
      },
    };

    try {
      const response = await fetch(
        `${audioUrl}?${requestParams}`,
        requestOptions
      );
      if (response.status === 403) {
        console.error("403 referä¸keyä¸åŒ¹é…ã€‚");
      } else if (response.status === 500) {
        console.error("500 ç³»ç»Ÿå†…éƒ¨é”™è¯¯");
      } else {
        const audioBlob = await response.blob();
        const audioURL = URL.createObjectURL(audioBlob);
        audio = new Audio(audioURL);
        audio.play();
        aiReadAloudIcon.style.cssText =
          "animation: breathe .5s linear infinite; opacity: 0.2;cursor: pointer";
        audio.addEventListener("ended", () => {
          audio = null;
          aiReadAloudIcon.style.opacity = "1";
          aiReadAloudIcon.style.animation = "";
        });
      }
    } catch (error) {
      console.error("è¯·æ±‚å‘ç”Ÿé”™è¯¯â");
    }
  }
  if (switchBtn) {
    document
      .getElementById("ai-Toggle")
      .addEventListener("click", changeShowMode);
  }

  aiAbstract();
  showAiBtn();

  function createIntersectionObserver() {
    return new IntersectionObserver(
      (entries) => {
        let isVisible = entries[0].isIntersecting;
        animationRunning = isVisible;
        if (animationRunning) {
          delayInit = indexI === 0 ? 200 : 20;
          timeouts[1] = setTimeout(() => {
            if (indexJ) {
              indexI = 0;
              indexJ = 0;
            }
            if (indexI === 0) {
              explanation.innerHTML = aiStr.charAt(0);
            }
            requestAnimationFrame(animate);
          }, delayInit);
        }
      },
      { threshold: 0 }
    );
  }

  function animate(timestamp) {
    if (!animationRunning) {
      return;
    }
    if (!animate.start) animate.start = timestamp;
    elapsed = timestamp - animate.start;
    if (elapsed >= 20) {
      animate.start = timestamp;
      if (indexI < aiStrLength - 1) {
        let char = aiStr.charAt(indexI + 1);
        let delay = /[,.ï¼Œã€‚!?ï¼ï¼Ÿ]/.test(char) ? 150 : 20;
        if (explanation.firstElementChild) {
          explanation.removeChild(explanation.firstElementChild);
        }
        explanation.innerHTML += char;
        let div = document.createElement("div");
        div.className = "ai-cursor";
        explanation.appendChild(div);
        indexI++;
        if (delay === 150) {
          post_ai.querySelector(".ai-explanation .ai-cursor").style.opacity =
            "0.2";
        }
        if (indexI === aiStrLength - 1) {
          observer.disconnect();
          explanation.removeChild(explanation.firstElementChild);
        }
        timeouts[0] = setTimeout(() => {
          requestAnimationFrame(animate);
        }, delay);
      }
    } else {
      requestAnimationFrame(animate);
    }
  }

  function clearTimeouts() {
    if (timeouts.length) {
      timeouts.forEach((item) => {
        if (item) {
          clearTimeout(item);
        }
      });
    }
  }

  function startAI(str, df = true) {
    indexI = 0;
    indexJ = 1;
    clearTimeouts();
    animationRunning = false;
    elapsed = 0;
    observer.disconnect();
    explanation.innerHTML = df ? "ç”Ÿæˆä¸­. . ." : "è¯·ç­‰å¾…. . .";
    aiStr = str;
    aiStrLength = aiStr.length;
    observer.observe(post_ai);
  }

  async function aiAbstract(num = basicWordCount) {
    if (mode === "online") {
      await aiAbstractTianli(num);
    } else {
      aiAbstractLocal();
    }
  }

  async function aiAbstractTianli(num) {
    indexI = 0;
    indexJ = 1;
    clearTimeouts();
    animationRunning = false;
    elapsed = 0;
    observer.disconnect();

    num = Math.max(10, Math.min(2000, num));
    const options = {
      key: AIKey,
      Referer: AIReferer,
    };
    const truncateDescription = (title + pageFillDescription)
      .trim()
      .substring(0, num);

    const url = new URL(location.href);
    const pathSegments = url.pathname.split("/").filter(Boolean); // è¿‡æ»¤æ‰ç©ºå­—ç¬¦ä¸²
    const id = pathSegments[pathSegments.length - 1]; // è·å–æœ€åä¸€ä¸ªéƒ¨åˆ†

    const requestBody = {
      key: options.key,
      content: truncateDescription,
      url: id,
    };

    const requestOptions = {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Referer: options.Referer,
      },
      body: JSON.stringify(requestBody),
    };
    try {
      let animationInterval = null;
      let summary;
      if (animationInterval) clearInterval(animationInterval);
      animationInterval = setInterval(() => {
        const animationText = "ç”Ÿæˆä¸­" + ".".repeat(indexJ);
        explanation.innerHTML = animationText;
        indexJ = (indexJ % 3) + 1;
      }, 500);
      const response = await fetch(apiUrl, requestOptions);
      let result;
      if (response.status === 403) {
        result = {
          summary: "403 referä¸keyä¸åŒ¹é…ã€‚",
        };
      } else if (response.status === 500) {
        result = {
          summary: "500 ç³»ç»Ÿå†…éƒ¨é”™è¯¯",
        };
      } else {
        result = await response.json();
      }

      summary = result.summary.trim();
      summaryID = result.id;

      setTimeout(() => {
        aiTitleRefreshIcon.style.opacity = "1";
      }, 300);
      if (summary) {
        startAI(summary);
      } else {
        startAI("æ‘˜è¦è·å–å¤±è´¥!!!è¯·æ£€æŸ¥ AI æ‘˜è¦æœåŠ¡æ˜¯å¦æ­£å¸¸!!!");
      }
      clearInterval(animationInterval);
    } catch (error) {
      console.error(error);
      explanation.innerHTML = "å‘ç”Ÿå¼‚å¸¸" + error;
    }
  }

  function aiAbstractLocal() {
    const strArr = postAI.split(",").map((item) => item.trim());
    if (strArr.length !== 1) {
      let randomIndex = Math.floor(Math.random() * strArr.length);
      while (randomIndex === lastAiRandomIndex) {
        randomIndex = Math.floor(Math.random() * strArr.length);
      }
      lastAiRandomIndex = randomIndex;
      startAI(strArr[randomIndex]);
    } else {
      startAI(strArr[0]);
    }
    setTimeout(() => {
      aiTitleRefreshIcon.style.opacity = "1";
    }, 600);
  }

  function aiRecommend() {
    indexI = 0;
    indexJ = 1;
    clearTimeouts();
    animationRunning = false;
    elapsed = 0;
    explanation.innerHTML = "ç”Ÿæˆä¸­. . .";
    aiStr = "";
    aiStrLength = "";
    observer.disconnect();
    timeouts[2] = setTimeout(() => {
      explanation.innerHTML = recommendList();
    }, 600);
  }

  function recommendList() {
    let thumbnail = document.querySelectorAll(".relatedPosts-list a");
    if (!thumbnail.length) {
      const cardRecentPost = document.querySelector(
        ".card-widget.card-recent-post"
      );
      if (!cardRecentPost) return "";

      thumbnail = cardRecentPost.querySelectorAll(".aside-list-item a");

      let list = "";
      for (let i = 0; i < thumbnail.length; i++) {
        const item = thumbnail[i];
        list += `<div class="ai-recommend-item"><span class="index">${
          i + 1
        }ï¼š</span><a href="javascript:;" onclick="pjax.loadUrl('${
          item.href
        }')" title="${item.title}" data-pjax-state="">${item.title}</a></div>`;
      }

      return `å¾ˆæŠ±æ­‰ï¼Œæ— æ³•æ‰¾åˆ°ç±»ä¼¼çš„æ–‡ç« ï¼Œä½ ä¹Ÿå¯ä»¥çœ‹çœ‹æœ¬ç«™æœ€æ–°å‘å¸ƒçš„æ–‡ç« ï¼š<br /><div class="ai-recommend">${list}</div>`;
    }

    let list = "";
    for (let i = 0; i < thumbnail.length; i++) {
      const item = thumbnail[i];
      list += `<div class="ai-recommend-item"><span>æ¨è${
        i + 1
      }ï¼š</span><a href="javascript:;" onclick="pjax.loadUrl('${
        item.href
      }')" title="${item.title}" data-pjax-state="">${item.title}</a></div>`;
    }

    return `æ¨èæ–‡ç« ï¼š<br /><div class="ai-recommend">${list}</div>`;
  }

  function aiGoHome() {
    startAI("æ­£åœ¨å‰å¾€åšå®¢ä¸»é¡µ...", false);
    timeouts[2] = setTimeout(() => {
      if (window.pjax) {
        pjax.loadUrl("/");
      } else {
        location.href = location.origin;
      }
    }, 1000);
  }

  function subscribe() {
    startAI("æ­£åœ¨å‰å¾€è®¢é˜…é¡µé¢...", false);
    timeouts[2] = setTimeout(() => {
      if (window.pjax) {
        pjax.loadUrl("/subscribe/");
      } else {
        location.href = location.origin;
      }
    }, 1000);
  }

  function introduce() {
    if (mode == "online") {
      startAI(
        "æˆ‘æ˜¯æ–‡ç« è¾…åŠ©AI: SummaryGPTï¼Œç‚¹å‡»ä¸‹æ–¹çš„æŒ‰é’®ï¼Œè®©æˆ‘ç”Ÿæˆæœ¬æ–‡ç®€ä»‹ã€æ¨èç›¸å…³æ–‡ç« ç­‰ã€‚"
      );
    } else {
      startAI(
        `æˆ‘æ˜¯æ–‡ç« è¾…åŠ©AI: ${gptName}GPTï¼Œç‚¹å‡»ä¸‹æ–¹çš„æŒ‰é’®ï¼Œè®©æˆ‘ç”Ÿæˆæœ¬æ–‡ç®€ä»‹ã€æ¨èç›¸å…³æ–‡ç« ç­‰ã€‚`
      );
    }
  }

  function aiTitleRefreshIconClick() {
    aiTitleRefreshIcon.click();
  }

  function onAiTagClick() {
    if (mode === "online") {
      post_ai
        .querySelectorAll(".ai-btn-item")
        .forEach((item) => (item.style.display = "none"));
      document.getElementById("go-tianli-blog").style.display = "block";
      startAI(
        "ä½ å¥½ ğŸ‰ï¼æˆ‘æ˜¯ dong4j åšå®¢çš„ AI æ–‡ç« æ‘˜è¦ç”ŸæˆåŠ©ç† SummaryGPTï¼Œä¸€æ¬¾åŸºäºæœ¬åœ°éƒ¨ç½²çš„å¤§å‹è¯­è¨€æ¨¡å‹æä¾›çš„ç”Ÿæˆå¼ AI æœåŠ¡ã€‚æˆ‘çš„ä¸»è¦èŒè´£æ˜¯é¢„ç”Ÿæˆå’Œå±•ç¤ºæ–‡ç« æ‘˜è¦ã€‚è¯·æ³¨æ„ï¼Œä½ æ— æ³•ç›´æ¥ä¸æˆ‘äº¤æµã€‚å¦‚æœä½ ä¹Ÿæƒ³æ‹¥æœ‰ä¸€ä¸ªè¿™æ ·çš„æ–‡ç« æ‘˜è¦åŠ©æ‰‹ï¼Œè¯·æŸ¥é˜…ä¸‹æ–¹çš„è¯¦ç»†éƒ¨ç½²æŒ‡å—ã€‚"
      );
    } else {
      post_ai
        .querySelectorAll(".ai-btn-item")
        .forEach((item) => (item.style.display = "block"));
      document.getElementById("go-tianli-blog").style.display = "none";
      startAI(
        `ä½ å¥½ ğŸ‰ï¼Œæˆ‘æ˜¯æœ¬ç«™æ–‡ç« æ‘˜è¦ç”ŸæˆåŠ©ç† ${gptName}GPTï¼Œä½¿ç”¨äº†é¢„å…ˆç”Ÿæˆçš„æ–‡ç« æ‘˜è¦ã€‚æˆ‘åœ¨è¿™é‡Œåªè´Ÿè´£æ‘˜è¦çš„æ˜¾ç¤ºï¼Œä½ æ— æ³•ä¸æˆ‘ç›´æ¥æ²Ÿé€šã€‚`
      );
    }
  }

  function onAiTitleRefreshIconClick() {
    const truncateDescription = (title + pageFillDescription)
      .trim()
      .substring(0, basicWordCount);

    aiTitleRefreshIcon.style.opacity = "0.2";
    aiTitleRefreshIcon.style.transitionDuration = "0.3s";
    aiTitleRefreshIcon.style.transform = "rotate(" + 360 * refreshNum + "deg)";
    if (truncateDescription.length <= basicWordCount) {
      let param =
        truncateDescription.length - Math.floor(Math.random() * randomNum);
      while (
        param === prevParam ||
        truncateDescription.length - param === prevParam
      ) {
        param =
          truncateDescription.length - Math.floor(Math.random() * randomNum);
      }
      prevParam = param;
      aiAbstract(param);
    } else {
      let value = Math.floor(Math.random() * randomNum) + basicWordCount;
      while (
        value === prevParam ||
        truncateDescription.length - value === prevParam
      ) {
        value = Math.floor(Math.random() * randomNum) + basicWordCount;
      }
      aiAbstract(value);
    }
    refreshNum++;
  }

  function changeShowMode() {
    mode = mode === "online" ? "local" : "online";
    if (mode === "online") {
      document.getElementById("ai-tag").innerHTML = "SummaryGPT";

      aiReadAloudIcon.style.opacity = "1";
      aiReadAloudIcon.style.cursor = "pointer";
    } else {
      aiReadAloudIcon.style.opacity = "0";
      aiReadAloudIcon.style.cursor = "auto";
      if ((document.getElementById("go-tianli-blog").style.display = "block")) {
        document
          .querySelectorAll(".ai-btn-item")
          .forEach((item) => (item.style.display = "block"));
        document.getElementById("go-tianli-blog").style.display = "none";
      }
      document.getElementById("ai-tag").innerHTML = gptName + " GPT";
    }
    aiAbstract();
  }

  function showAiBtn() {
    if (mode === "online") {
      document.getElementById("ai-tag").innerHTML = "SummaryGPT";
    } else {
      document.getElementById("ai-tag").innerHTML = gptName + " GPT";
    }
  }
})();
```

å½“ç„¶è¿˜éœ€è¦ä¿®æ”¹å¯¹åº”çš„ pug æ¨¡ç‰ˆæ–‡ä»¶(`themes/anzhiyu/layout/includes/anzhiyu/ai-info.pug`):

```javascript
- let pageFillDescription = get_page_fill_description()
- let gptName = theme.post_head_ai_description.gptName
- let mode = theme.post_head_ai_description.mode
- let switchBtn = theme.post_head_ai_description.switchBtn
if (pageFillDescription && page.ai)
  .post-ai-description
    .ai-title
      i.fa-regular.fa-robot.fa-fade
      .ai-title-text æ‘˜è¦åŠ©æ‰‹
      if (switchBtn)
        #ai-Toggle åˆ‡æ¢
      i.anzhiyufont.anzhiyu-icon-arrow-rotate-right
      i.anzhiyufont.anzhiyu-icon-circle-dot(title="æœ—è¯»æ‘˜è¦")
      #ai-tag
        if mode == "online"
          = "SummaryGPT"
        else
          = gptName + "GPT"
    .ai-explanation AI åˆå§‹åŒ–ä¸­...
    .ai-btn-box
      .ai-btn-item ä»‹ç»è‡ªå·± ğŸ™ˆ
      .ai-btn-item ç”Ÿæˆæ‘˜è¦ ğŸ‘‹
      .ai-btn-item æ¨èæ–‡ç«  ğŸ“–
      .ai-btn-item å‰å¾€ä¸»é¡µ ğŸ 
      .ai-btn-item å‰å¾€è®¢é˜… ğŸ’¥
      .ai-btn-item#go-comment å‰å¾€è¯„è®º ğŸ’¬
      .ai-btn-item#read-audio Kokoro TTS ğŸ™ï¸
      .ai-btn-item#go-tianli-blog ğŸ‘€ éƒ¨ç½²æ•™ç¨‹
    script(data-pjax src=url_for(theme.asset.ai_abstract_js))
```

æœ€åå°±æ˜¯é…ç½®:

```yaml
post_head_ai_description:
  enable: true
  gptName: Local
  mode: online # é»˜è®¤æ¨¡å¼ å¯é€‰å€¼: online/local
  switchBtn: true # å¯ä»¥é…ç½®æ˜¯å¦æ˜¾ç¤ºåˆ‡æ¢æŒ‰é’® ä»¥åˆ‡æ¢ online/local
  btnLink: https://github.com/dong4j/blog-summary-assistant-server
  randomNum: 3 # æŒ‰é’®æœ€å¤§çš„éšæœºæ¬¡æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸€ç¯‡æ–‡ç« æœ€å¤§éšæœºå‡ºæ¥å‡ ç§
  basicWordCount: 1999 # æœ€ä½è·å–å­—ç¬¦æ•°, æœ€å°1000, æœ€å¤§1999
  apiUrl: # æ–‡ç« æ‘˜è¦ç”ŸæˆæœåŠ¡ api
  audioUrl: # è¯­éŸ³ç”ŸæˆæœåŠ¡ api
  key: # æ ¹æ®è‡ªå·±éœ€è¦çœ‹æ˜¯å¦è¦éªŒè¯ key
  Referer: # æ ¹æ®è‡ªå·±éœ€è¦çœ‹æ˜¯å¦è¦éªŒè¯ Referer, æˆ‘è¿™é‡Œæ²¡æœ‰éªŒè¯
```

> Hexo ä¿®æ”¹æ²¡æœ‰å¤šå¤§éš¾åº¦, ä¸»è¦æ˜¯ç›´æ¥åˆ©ç”¨ anzhiyu ä¸»é¢˜é›†æˆçš„ TianliGPT æ¥å®ŒæˆæœåŠ¡è°ƒç”¨ä¸æ•°æ®å±•ç¤º, æ‰€ä»¥è¿™éƒ¨åˆ†å°±è§ä»è§æ™ºäº†, ä¸ªäººå¯éšæ„ä¿®æ”¹.

---

### 2. æ‘˜è¦æœåŠ¡éƒ¨ç½²ä¸é›†æˆ

LLM API ç›´æ¥ä½¿ç”¨ [[npx-card-dev|ä½¿ç”¨ Node.js å¼€å‘æ•°å­—åç‰‡å¹¶é›†æˆ Chat æœåŠ¡]] è¿™ç¯‡æ–‡ç« ä¸­å·²éƒ¨ç½²å¥½çš„ one-api, å¥½å¤„æ˜¯ä¸éœ€è¦å°†å‚å•† Key æ”¾åœ¨å‰ç«¯ä»£ç ä¸­, å¯ä»¥é¿å…ä¸€ç‚¹çš„å®‰å…¨é—®é¢˜, å¦å¤–åœ¨ one-api æˆ‘å¯ä»¥éšæ—¶æ·»åŠ  LLM å‚å•†æœåŠ¡, ä¸”å¯æ§åˆ¶æŒ‡å®š Key çš„ Token æ€»é‡ä¸æœ‰æ•ˆæœŸ, æ‰€ä»¥å¹¶ä¸æ˜¯å¤ªæ‹…å¿ƒè‡ªå·±çš„ Token è¢«æ¶æ„ä½¿ç”¨, å³ä½¿ç¬¬ä¸‰æ–¹çš„ Token è¢«æ¶æ„æ¶ˆè€—å®Œ, æˆ‘è¿˜å¯ä»¥ä½¿ç”¨æœ¬åœ°éƒ¨ç½² LLM æœåŠ¡, å¾—ç›Šäº one-api çš„ä»£ç†åŠŸèƒ½, ç®€å•çš„ä¿®æ”¹ one-api é…ç½®å³å¯ä½¿ç”¨, ä¸éœ€è¦é‡æ–°éƒ¨ç½²åšå®¢.

#### 2.1 åŠŸèƒ½

- æä¾›ä¸€ä¸ª `/api/summary` æ¥å£ç»™ Hexo åšå®¢è°ƒç”¨, å¹¶å°†ä¼ å…¥çš„åšå®¢å†…å®¹é€šè¿‡ one-api api ä¼ ç»™ LLM, å¹¶å¤„ç†è¿”å›çš„ç»“æœ;
- ç”Ÿæˆçš„æ–‡ç« æ‘˜è¦ä¼šè¢«ç¼“å­˜åˆ° Redis ä¸­, é¿å…é‡å¤ç”Ÿæˆ;
- é€šè¿‡ pm2 å¯åŠ¨æœåŠ¡;
- æä¾›è‡ªåŠ¨éƒ¨ç½²è„šæœ¬ä¸€é”®éƒ¨ç½²;

#### 2.2 ä½¿ç”¨æ–¹æ³•

```bash
git clone git@github.com:dong4j/blog-summary-assistant-server.git
cd summary-server
cp .env.template .env
```

ä¿®æ”¹ .env é…ç½®:

```bash
SERVER_PORT=3000
# ç¼“å­˜é…ç½®
REDIS_HOST=192.168.1.2
REDIS_PORT=6379
REDIS_PASSWORD=password
REDIS_DB=0
# æ‘˜è¦è¿‡æœŸæ—¶é—´
KEY_EXPIRATION=31536000

# LLM æœåŠ¡
OPENAI_API_KEY=sk-*****
# é…ç½®ä¸ºå‚å•†çš„ OpenAI API åœ°å€
OPENAI_API_BASE=https://api.openai.com/v1
# æ¨¡å‹åç§°
OPENAI_MODEL=xxx
```

#### 2.3 å¯åŠ¨æœåŠ¡

```bash
npm install
npm run server
```

æµ‹è¯•:

```bash
curl --request POST \
  --url http://192.168.1.3:3000/api/summary \
  --header 'Accept: */*' \
  --header 'Accept-Encoding: gzip, deflate, br' \
  --header 'Connection: keep-alive' \
  --header 'Content-Type: application/json' \
  --header 'User-Agent: PostmanRuntime-ApipostRuntime/1.1.0' \
  --data '{
    "key": "xxxx",
    "content": "HomeLab å…ˆå¯¼ç¯‡ï¼šå…¥é—¨æŒ‡å—-å¼€å¯ä½ çš„ä¸ªäººäº‘ç«¯å®éªŒå®¤ä¹‹æ—…å‰æè¯´æ˜, ä»€ä¹ˆæ˜¯ HomeLab, ä¸ºä»€ä¹ˆé€‰æ‹©è‡ªå»º HomeLab, HomeLab çš„åŸåˆ™, ç¡¬ä»¶æˆæœ¬, è½¯ä»¶æˆæœ¬, HomeLab çš„ç¡¬ä»¶, ç½‘ç»œæ¶æ„, è‡ªæ‰˜ç®¡æœåŠ¡, æ•°æ®å­˜å‚¨ä¸å¤‡ä»½, æ€»ç»“ä¸­å¹´ç”·äººçš„ä¸‰å¤§çˆ±å¥½å……ç”µå¤´è½¯è·¯ç”±è¿™ä¸‰å¤§çˆ±å¥½ä¸ä»…ä¸ºæˆ‘ä»¬çš„ç”Ÿæ´»å¸¦æ¥äº†ä¾¿åˆ©ä¹Ÿæˆä¸ºäº†æˆ‘ä»¬ç”Ÿæ´»çš„ä¸€éƒ¨åˆ†ä½œä¸ºä¸€ä¸ªè½¯ä»¶å¼€å‘è€…æˆ‘ä¸€ç›´æ¢¦æƒ³ç€æ‹¥æœ‰è‡ªå·±çš„æœåŠ¡å™¨è€Œå’Œè½¯è·¯ç”±åˆ™æ˜¯æˆ‘é€šå¾€è¿™ä¸ªæ¢¦æƒ³çš„æ¡¥æ¢è‡ªä»è´­ä¹°äº†æˆ‘çš„ç¬¬ä¸€å°ä»¥æ¥ä¾¿æ‰“å¼€äº†ä¸€æ‰‡æ–°ä¸–ç•Œçš„å¤§é—¨å³ç½‘ç»œé™„åŠ å­˜å‚¨å®ƒä¸ä»…æä¾›äº†ä¸€ä¸ªå®‰å…¨çš„æ•°æ®å­˜å‚¨è§£å†³æ–¹æ¡ˆè¿˜è®©æˆ‘èƒ½å¤Ÿå®ç°æ•°æ®çš„å¤‡ä»½å’Œå…±äº«éšç€æ—¶é—´çš„æ¨ç§»æˆ‘é™†ç»­è´­ä¹°äº†å…¶ä»–ç¡¬ä»¶äº§å“å¦‚è½¯è·¯ç”±å™¨æœåŠ¡å™¨ç­‰é€æ­¥æ­å»ºèµ·äº†å±äºæˆ‘çš„ä»Šå¤©æˆ‘æƒ³å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹æˆ‘æ­å»ºçš„è¿‡ç¨‹å¸Œæœ›èƒ½å¤Ÿå¸®åŠ©åˆ°é‚£äº›åŒæ ·æœ‰å¿—äºæ­å»ºçš„æœ‹å‹åœ¨æ¥ä¸‹æ¥çš„åšå®¢æ–‡ç« ä¸­æˆ‘å°†è¯¦ç»†ä»‹ç»å¦‚ä½•é€‰è´­åˆé€‚çš„è®¾å¤‡è½¯è·¯ç”±å™¨ä»¥åŠæœåŠ¡å™¨å¹¶åˆ†äº«æˆ‘åœ¨æ­å»ºè¿‡ç¨‹ä¸­é‡åˆ°çš„æŒ‘æˆ˜å’Œè§£å†³æ–¹æ¡ˆå¹¶éé¥ä¸å¯åŠåªè¦æˆ‘ä»¬ç”¨å¿ƒå»æ¢ç´¢å’Œå®è·µå°±èƒ½å¼€å¯å±äºè‡ªå·±çš„ä¸ªäººäº‘ç«¯å®éªŒå®¤ä¹‹æ—…è®©æˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº¤æµå’Œæˆé•¿å…±åŒæ‰“é€ ä¸€ä¸ªå±äºæˆ‘ä»¬çš„æ•°å­—ç‹å›½å‰æè¯´æ˜è™½ç„¶å…³äºçš„æ–‡ç« å·²ç»å¾ˆå¤šäº†ä½†æˆ‘è¿˜æ˜¯æƒ³è®°å½•ä¸‹è‡ªå·±æ­å»ºçš„ç»å†å’Œé‡åˆ°çš„é—®é¢˜ä»¥åŠå¦‚ä½•è§£å†³è¿™äº›é—®é¢˜ä¸»è¦ä¼šæ¶‰åŠåˆ°ä»¥ä¸‹å‡ ä¸ªæ–¹é¢å…ˆå¯¼ç¯‡æˆ‘çš„æ¦‚è¦ç¡¬ä»¶ç¯‡ä»‹ç»æˆ‘æ‰€æ‹¥æœ‰çš„ç¡¬ä»¶è®¾å¤‡ç½‘ç»œç¯‡åŒ…æ‹¬ç½‘ç»œç¯å¢ƒå¼‚åœ°ç»„ç½‘ä¸ç½‘ç»œå®‰å…¨æœåŠ¡ç¯‡ä½¿ç”¨æ­å»ºçš„å„ç±»æœåŠ¡æ•°æ®ç¯‡åŒ…æ‹¬æ•°æ®å­˜å‚¨æ–¹æ¡ˆå¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆæ•°æ®åŒæ­¥æ„å»ºé«˜æ•ˆçš„æ•°æ®åŒæ­¥ç½‘ç»œæ•°æ®å¤‡ä»½æ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿ç½‘ç»œç»­é›†å‡çº§ç½‘ç»œå†æˆ˜å¹´å†…ç½‘ç©¿é€è¯¦è§£æ­ç§˜ç½‘ç»œè¿æ¥èƒŒåçš„å¥¥ç§˜ä»€ä¹ˆæ˜¯é¡¾åæ€ä¹‰å°±æ˜¯å®¶åº­å®éªŒå®¤å®ƒå¯ä»¥ç†è§£ä¸ºå®¶åº­ç‰ˆçš„äº‘æœåŠ¡å™¨ç”¨æ¥æ­å»ºå„ç§æœåŠ¡æ¯”å¦‚ä¸ªäººç½‘ç›˜åª’ä½“æœåŠ¡å™¨ç­‰ç­‰çš„ç¡¬ä»¶è®¾å¤‡é€šå¸¸åŒ…æ‹¬æœåŠ¡å™¨å¯ä»¥æ˜¯ç‰©ç†æœåŠ¡å™¨æˆ–è™šæ‹Ÿæœºç”¨äºæ­å»ºå„ç±»æœåŠ¡å­˜å‚¨è®¾å¤‡å¦‚å’Œç¡¬ç›˜ç”¨äºå­˜å‚¨æ•°æ®ç½‘ç»œè®¾å¤‡å¦‚è½¯è·¯ç”±å’Œç¡¬è·¯ç”±ç”¨äºç®¡ç†ç½‘ç»œå…¶ä»–è®¾å¤‡å¦‚æ‘„åƒå¤´ä¼ æ„Ÿå™¨ç­‰ç”¨äºæ”¶é›†æ•°æ®ä¸ºä»€ä¹ˆé€‰æ‹©è‡ªå»ºå¯¹äºæˆ‘æ¥è¯´æ­å»ºæ˜¯ä¸€ç§æµªæ¼«çš„æŠ˜è…¾æˆ‘çš„ç›®æ ‡æ˜¯æ­å»ºå„ç§æ„Ÿå…´è¶£çš„æœåŠ¡çš„å®éªŒå®¤ä½œä¸ºä¸€ä¸ªå–œæ¬¢å°è¯•æ–°æŠ€æœ¯çš„äººæ¥è¯´æ­å»ºå„ç±»æœåŠ¡éå¸¸æœ‰è¶£æˆ‘å¯ä»¥å¿«é€Ÿå°è¯•å’ŒéªŒè¯æ–°çš„æŠ€æœ¯å’Œæ–¹æ¡ˆæ‹¥æœ‰ä¸€å¥—è‡ªå·±çš„å®éªŒå®¤å¯ä»¥è®©æˆ‘æ›´åŠ è‡ªç”±åœ°æ¢ç´¢ä¿è¯æ•°æ®å®‰å…¨æˆ‘å¯¹æ•°æ®å®‰å…¨éå¸¸é‡è§†æ‰€ä»¥æˆ‘ä¼šæŠŠæ‰€æœ‰çš„æ•°æ®éƒ½å­˜å‚¨åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šè€Œä¸æ˜¯ä½¿ç”¨äº‘å­˜å‚¨æœåŠ¡è¿™æ ·å¯ä»¥ä¿è¯æˆ‘çš„æ•°æ®ä¸ä¼šè¢«ç¬¬ä¸‰æ–¹æ§åˆ¶æˆ‘å·²ç»å—å¤Ÿäº†ä¸ƒç‰›äº‘çš„åŸŸåå˜æ›´å¯¼è‡´æˆ‘å¤§é‡å›¾ç‰‡æ— æ³•è®¿é—®æ›´å¥½çš„éšç§ä¿æŠ¤å®¶äººçš„ç…§ç‰‡å„¿å­çš„æˆ",
    "url": "abbrlink.html"
}'
```

å“åº”ç»“æœ:

```json
{
  "summary": "ğŸ¤– è¿™ç¯‡æ–‡ç« ä»‹ç»äº†: HomeLabçš„æ¦‚å¿µã€è‡ªå»ºHomeLabçš„åŸå› ã€åŸåˆ™ã€ç¡¬ä»¶å’Œè½¯ä»¶æˆæœ¬ã€ç¡¬ä»¶è®¾å¤‡ã€ç½‘ç»œæ¶æ„ã€è‡ªæ‰˜ç®¡æœåŠ¡ã€æ•°æ®å­˜å‚¨ä¸å¤‡ä»½ç­‰ã€‚ä½œè€…åˆ†äº«äº†è‡ªå·±æ­å»ºHomeLabçš„è¿‡ç¨‹ï¼ŒåŒ…æ‹¬é€‰è´­è®¾å¤‡ã€æ­å»ºè¿‡ç¨‹ä¸­é‡åˆ°çš„æŒ‘æˆ˜å’Œè§£å†³æ–¹æ¡ˆï¼Œæ—¨åœ¨å¸®åŠ©æœ‰å¿—äºæ­å»ºHomeLabçš„æœ‹å‹ã€‚æ–‡ç« è¿˜æ¶‰åŠäº†ç½‘ç»œç¯å¢ƒã€å¼‚åœ°ç»„ç½‘ã€ç½‘ç»œå®‰å…¨ã€æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆç­‰å†…å®¹ï¼Œå¼ºè°ƒäº†æ•°æ®å®‰å…¨å’Œéšç§ä¿æŠ¤çš„é‡è¦æ€§ã€‚",
  "id": "abbrlink",
  "fromCache": false
}
```

ç¬¬ä¸€æ¬¡ä¼šè°ƒç”¨ one-api api ç”Ÿæˆæ‘˜è¦ï¼Œç¬¬äºŒæ¬¡ä¼šä»ç¼“å­˜ä¸­è·å–æ‘˜è¦ã€‚

#### 2.4 éƒ¨ç½²

ä¿®æ”¹ `ecosystem.config.js` ç›¸å…³é…ç½®:

```javascript
module.exports = {
  apps: [
    {
      name: "summary-server", // åº”ç”¨åç§°
      namespace: "blog", // æŒ‡å®šå‘½åç©ºé—´(å¯é€‰)
      version: "1.0.0", // åº”ç”¨ç‰ˆæœ¬(å¯é€‰)
      cwd: "/path/to/deploy", // éƒ¨ç½²åˆ°æœåŠ¡å™¨çš„å·¥ä½œç›®å½•
      script: "./summaryServer.js", // ä¸»è„šæœ¬è·¯å¾„ï¼Œç›¸å¯¹äº cwd
      watch: true, // æ˜¯å¦å¯ç”¨æ–‡ä»¶ç›‘æ§
      ignore_watch: ["node_modules", "logs"], // å¿½ç•¥ç›‘æ§çš„æ–‡ä»¶æˆ–ç›®å½•
      exec_mode: "fork",
      instances: 1, // åº”ç”¨å®ä¾‹æ•°é‡
      autorestart: true, // æ˜¯å¦è‡ªåŠ¨é‡å¯
      env: {
        VERSION: "1.0.0", // è®¾ç½®ç‰ˆæœ¬å·ç¯å¢ƒå˜é‡
      },
      log_date_format: "YYYY-MM-DD HH:mm:ss", // æ—¥å¿—æ—¶é—´æ ¼å¼
      error_file: "./logs/error.log", // é”™è¯¯æ—¥å¿—æ–‡ä»¶
      out_file: "./logs/out.log", // è¾“å‡ºæ—¥å¿—æ–‡ä»¶
      merge_logs: true, // æ˜¯å¦åˆå¹¶æ—¥å¿—
    },
  ],
};
```

ä¿®æ”¹ `deploy.sh` è„šæœ¬ä¸­çš„ `DEFAULT_SSH_ALIAS` å’Œ `DEFAULT_REMOTE_DIR`:

- DEFAULT_SSH_ALIAS: .ssh ä¸­çš„ config é…ç½®åˆ«å, è¿™é‡Œåšäº†å…å¯†ç™»å½•å¤„ç†;
- DEFAULT_REMOTE_DIR: éƒ¨ç½²åˆ°æœåŠ¡å™¨çš„å·¥ä½œç›®å½•;

æœ€åæ‰§è¡Œéƒ¨ç½²è„šæœ¬:

```bash
./deploy.sh
```

ç¬¬ä¸€æ¬¡éƒ¨ç½²éœ€è¦åœ¨æœåŠ¡å™¨çš„éƒ¨ç½²ç›®å½•å®‰è£…ä¾èµ–:

```bash
npm install
```

#### 2.5 å¤–ç½‘é…ç½®

å®¶é‡Œçš„å®½å¸¦æœ‰å…¬ç½‘ IP, æ‰€ä»¥æˆ‘æ˜¯ç›´æ¥éƒ¨ç½²åˆ° HomeLab çš„æœåŠ¡å™¨ä¸Š, ç„¶åç»‘å®šç»‘å®šè‡ªå®šä¹‰åŸŸåå³å¯, å‡è®¾ç»‘å®šçš„åŸŸåä¸º: `https://summary.dong4j.tele:3000`,

é‚£ä¹ˆ Hexo çš„ AI æ‘˜è¦é…ç½®å°±è¦ä¿®æ”¹ä¸º:

```yaml
post_head_ai_description:
	...
  apiUrl: https://summary.dong4j.tele:3000/api/summary
	...
```

æ•ˆæœå¦‚ä¸‹:

![20250208212138_yyglInIu.webp](https://cdn.dong4j.site/source/image/20250208212138_yyglInIu.webp)

### 3. Kokoro TTS éƒ¨ç½²

#### 3.1 éƒ¨ç½²

æˆ‘ä½¿ç”¨çš„æ˜¯ [Kokoro-FastAPI](https://github.com/remsky/Kokoro-FastAPI), ä½¿ç”¨ CPU æ¨¡å¼éƒ¨ç½²åˆ° Mac mini M2 ä¸Š:

```bash
git clone https://github.com/remsky/Kokoro-FastAPI.git
cd Kokoro-FastAPI

cd docker/cpu
docker compose up -d --build
```

ä¸è¿‡æœ€æ–°çš„ **0.2.0** ç‰ˆæœ¬ä½¿ç”¨ docker éƒ¨ç½²è¿˜æœ‰ä¸€ç‚¹ [é—®é¢˜](https://github.com/remsky/Kokoro-FastAPI/issues/127), è§£å†³æ–¹æ³•å¦‚ä¸‹:

ä¿®æ”¹æ–‡ä»¶ `docker/cpu/Dockerfile`:

```dockerfile
# Install dependencies and check espeak location
RUN mkdir -p /usr/share/espeak-ng-data \
    && apt-get update && apt-get install -y \
        espeak-ng \
        espeak-ng-data \
        git \
        libsndfile1 \
        curl \
        ffmpeg \
        g++ \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && ln -s /usr/lib/*/espeak-ng-data/* /usr/share/espeak-ng-data/
```

**åº”è¯¥å…ˆæ‰§è¡Œ `mkdir -p /usr/share/espeak-ng-data`**.

> å¦‚æœä½ éœ€è¦ web-ui æœåŠ¡, éœ€è¦ä¿®æ”¹ docker-compose.yml, åˆ é™¤ web-ui æœåŠ¡çš„æ³¨é‡Š.

éƒ¨ç½²æ²¡é—®é¢˜çš„è¯, åº”è¯¥èƒ½çœ‹åˆ°ç›¸å…³çš„å®¹å™¨:

![20250208223048_VDtpJCBF.webp](https://cdn.dong4j.site/source/image/20250208223048_VDtpJCBF.webp)

#### 3.2 åˆ‡æ¢è¯­è¨€

Kokoro-FastAPI é»˜è®¤ä½¿ç”¨è‹±è¯­ç”Ÿæˆè¯­éŸ³, æ‰€ä»¥æˆ‘ä»¬è¦ä¿®æ”¹ä¸€ä¸‹ä»£ç æ¥æ”¯æŒä¸­æ–‡:

ä¿®æ”¹ `api/src/services/tts_service.py` ç¬¬ 297 è¡Œ:

```python
# å°† lang_code ä¿®æ”¹ä¸º 'z'
quiet_pipeline = KPipeline(lang_code='z', model=False)
```

ç„¶åé‡æ–°ä½¿ç”¨ docker-compose éƒ¨ç½²å³å¯.

**Gradio WebUI**:

![20250208214224_0h3tBPgJ.webp](https://cdn.dong4j.site/source/image/20250208214224_0h3tBPgJ.webp)

**è‡ªå¸¦ WebUI**:

![20250208220534_NqhGwId3.webp](https://cdn.dong4j.site/source/image/20250208220534_NqhGwId3.webp)

#### 3.3 åœé¡¿é—®é¢˜

å¦‚æœä½¿ç”¨ä¸­æ–‡æ ‡ç‚¹æœåŠ¡ä¼šå‡ºç°åœé¡¿æ—¶é—´è¾ƒçŸ­çš„é—®é¢˜, è§£å†³æ–¹æ³•å°±æ˜¯å°†ä¸­æ–‡æ ‡ç‚¹æœåŠ¡ä¿®æ”¹ä¸ºè‹±æ–‡æ ‡ç‚¹æœåŠ¡.

[ç›¸å…³è®¨è®º](https://huggingface.co/hexgrad/Kokoro-82M/discussions/89)

> è¿™ä¸ªå·²åœ¨ `audio-server` å¤„ç†è¿‡äº†.

#### 3.4 ä¸­è‹±æ–‡æ··åˆå¯¼è‡´è‹±è¯­å‘éŸ³ä¸æ­£å¸¸

è¿™ä¸ªé—®é¢˜è¿˜æ²¡æœ‰è§£å†³.

---

### 4. è¯­éŸ³æœåŠ¡ API éƒ¨ç½²ä¸é›†æˆ

#### 4.1 åŠŸèƒ½

- æä¾›ä¸€ä¸ª `/audio` æ¥å£ç»™ Hexo åšå®¢è°ƒç”¨, é€šè¿‡ id è·å– Redis ä¸­çš„æ‘˜è¦æ–‡æœ¬, ç„¶åè°ƒç”¨ Kokoro TTS FastAPI ç”Ÿæˆè¯­éŸ³;
- ç”Ÿæˆçš„ mp3 ä¼šä¿å­˜åˆ° `audios ç›®å½•`, é¿å…é‡å¤ç”Ÿæˆ;
- é€šè¿‡ pm2 å¯åŠ¨æœåŠ¡;
- æä¾›è‡ªåŠ¨éƒ¨ç½²è„šæœ¬ä¸€é”®éƒ¨ç½²;

#### 4.2 ä½¿ç”¨

```bash
git clone git@github.com:dong4j/blog-summary-assistant-server.git
cd audio-server
cp config.ini.template config.ini
# åˆå§‹åŒ– python ç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

ä¿®æ”¹ `config.ini` ä¸­çš„é…ç½®ä¿¡æ¯:

```ini
[redis]
host=192.168.1.2
port=6379
password=password
db=0

[kokoro]
base_url=http://192.168.31.5:8880/v1
```

æµ‹è¯•:

```python
python kokorotts_with_request.py
```

æˆåŠŸåä¼šåœ¨ `audios` ç›®å½•ä¸‹ç”Ÿæˆ mp3 æ–‡ä»¶, å¦‚æœéŸ³è‰²ä¸æ»¡æ„å¯ä»¥ä¿®æ”¹ç›¸å…³ä»£ç .

#### 4.3 éƒ¨ç½²

ä¿®æ”¹ `ecosystem.config.js` ç›¸å…³é…ç½®:

```javascript
module.exports = {
  apps: [
    {
      name: "audio-server", // åº”ç”¨åç§°
      namespace: "blog", // æŒ‡å®šå‘½åç©ºé—´
      version: "1.0.0", // åº”ç”¨ç‰ˆæœ¬
      cwd: "/path/to/deploy", // éƒ¨ç½²åˆ°æœåŠ¡å™¨çš„å·¥ä½œç›®å½•
      script: "./audioServer.py", // ä¸»è„šæœ¬è·¯å¾„ï¼Œç›¸å¯¹äº cwd
      interpreter: "/mnt/4.860.ssd/audio-server/venv/bin/python3",
      watch: true, // æ˜¯å¦å¯ç”¨æ–‡ä»¶ç›‘æ§
      ignore_watch: ["__pycache__", "venv", "audios", "logs"], // å¿½ç•¥ç›‘æ§çš„æ–‡ä»¶æˆ–ç›®å½•
      exec_mode: "fork",
      instances: 1, // åº”ç”¨å®ä¾‹æ•°é‡
      autorestart: true, // æ˜¯å¦è‡ªåŠ¨é‡å¯
      env: {},
      log_date_format: "YYYY-MM-DD HH:mm:ss", // æ—¥å¿—æ—¶é—´æ ¼å¼
      error_file: "./logs/error.log", // é”™è¯¯æ—¥å¿—æ–‡ä»¶
      out_file: "./logs/out.log", // è¾“å‡ºæ—¥å¿—æ–‡ä»¶
      merge_logs: true, // æ˜¯å¦åˆå¹¶æ—¥å¿—
    },
  ],
};
```

ä¿®æ”¹ `deploy.sh` è„šæœ¬ä¸­çš„ `DEFAULT_SSH_ALIAS` å’Œ `DEFAULT_REMOTE_DIR`:

- DEFAULT_SSH_ALIAS: .ssh ä¸­çš„ config é…ç½®åˆ«å, è¿™é‡Œåšäº†å…å¯†ç™»å½•å¤„ç†;
- DEFAULT_REMOTE_DIR: éƒ¨ç½²åˆ°æœåŠ¡å™¨çš„å·¥ä½œç›®å½•;

æœ€åæ‰§è¡Œéƒ¨ç½²è„šæœ¬:

```bash
./deploy.sh
```

ç¬¬ä¸€æ¬¡éƒ¨ç½²éœ€è¦åœ¨æœåŠ¡å™¨çš„éƒ¨ç½²ç›®å½•å®‰è£…ä¾èµ–:

```python
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

#### 4.4 å¤–ç½‘é…ç½®

å‡è®¾ç»‘å®šçš„åŸŸåä¸º: `https://audio.dong4j.tele:6668`, é‚£ä¹ˆ Hexo çš„ AI æ‘˜è¦é…ç½®å°±è¦ä¿®æ”¹ä¸º:

```yaml
post_head_ai_description:
  ...
  audioUrl: https://audio.dong4j.tele:6668/audio
  ...
```

æ•ˆæœå¦‚ä¸‹:

![20250209003039_KL0AlEW7.webp](https://cdn.dong4j.site/source/image/20250209003039_KL0AlEW7.webp)

{% audio https://cdn.dong4j.site/source/image/66ccb3f1.mp3 %}

## ä¸‰ã€æ³¨é‡Šäº‹é¡¹

- å¦‚æœæ˜¯éƒ¨ç½²åˆ°è‡ªå·±çš„æœåŠ¡å™¨ä¸Š, éœ€è¦åœ¨ Nginx å¤„ç†ä¸€ä¸‹è·¨åŸŸçš„é—®é¢˜;

---

## å››ã€é™„å½•

- å¼€æºä»£ç ä»“åº“åœ°å€: [https://github.com/dong4j/blog-summary-assistant-server](https://github.com/dong4j/blog-summary-assistant-server)
- ç›¸å…³å·¥å…·ä¸èµ„æºé“¾æ¥:
  - [Kokoro TTS éŸ³è‰²å¯¹æ¯”](https://huggingface.co/hexgrad/Kokoro-82M/blob/main/SAMPLES.md)
  - [Kokoro TTS åœ¨çº¿ä½“éªŒ](https://huggingface.co/spaces/hexgrad/Kokoro-TTS)