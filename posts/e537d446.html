<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>HomeLab 网络篇：互联世界-构建高效的自托管网络环境 | 司机带你开车</title><meta name="keywords" content="HomeLab,网络架构,安全性,异地组网,自托管"><meta name="author" content="dong4j"><meta name="copyright" content="dong4j"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="HomeLab 网络篇：互联世界-构建高效的自托管网络环境"><meta name="application-name" content="HomeLab 网络篇：互联世界-构建高效的自托管网络环境"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="HomeLab 网络篇：互联世界-构建高效的自托管网络环境"><meta property="og:url" content="https://blog.dong4j.site/posts/e537d446.html"><meta property="og:site_name" content="司机带你开车"><meta property="og:description" content="本文深入探讨了构建个人云端实验室（Homelab）中的家庭网络配置，涵盖了从基础的架构设计到高级的安全性和异地组网技术。文章详细阐述了如何选择合适的网络设备、部署网络覆盖、设置网络安全策略以及实现异地管理和操作。同时，还分享了实际操作的步骤和经验，帮助读者更好地理解和应用这些网络技术和概念。通过本文"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.dong4j.site/source/image/20241229154732_xLHg6epx.webp"><meta property="article:author" content="dong4j"><meta property="article:tag" content="dong4j, Java, Python, Golang, HomeLab, SpringBoot, 架构"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.dong4j.site/source/image/20241229154732_xLHg6epx.webp"><meta name="description" content="本文深入探讨了构建个人云端实验室（Homelab）中的家庭网络配置，涵盖了从基础的架构设计到高级的安全性和异地组网技术。文章详细阐述了如何选择合适的网络设备、部署网络覆盖、设置网络安全策略以及实现异地管理和操作。同时，还分享了实际操作的步骤和经验，帮助读者更好地理解和应用这些网络技术和概念。通过本文"><link rel="shortcut icon" href="https://cdn.dong4j.site/source/image/favicon.ico"><link rel="canonical" href="https://blog.dong4j.site/posts/e537d446.html"><link rel="preconnect" href="//cdn.cbd.int"><link rel="preconnect" href="//hm.baidu.com"><meta name="google-site-verification" content="xxx"><meta name="baidu-site-verification" content="codeva-D4HsBP841S"><meta name="msvalidate.01" content="xxx"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@1.0.17/lib/assets/font-awesome-animation.min.css"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media=&quot;all&quot;"><script>var _hmt=_hmt||[];(()=>{var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?61a751ac36d18d3ba293fe8ef3ec53eb",document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)})()</script><script>let GLOBAL_CONFIG={linkPageTop:{enable:!0,title:"与数百名博主无限进步",addFriendPlaceholder:"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},peoplecanvas:void 0,postHeadAiDescription:{enable:!0,gptName:"Local",mode:"online",switchBtn:!0,btnLink:"https://github.com/dong4j/blog-summary-assistant-server",randomNum:3,basicWordCount:1999,key:"84yT3Gkl6fp",Referer:"https://blog.dong4j.site:1024",apiUrl:"https://oneapi.dong4j.ink:1024/api/summary",audioUrl:"https://api.dong4j.ink:1024/audio"},diytitle:{enable:!0,leaveTitle:"兄台留步 🙏",backTitle:"兄台,别来无恙 👋"},LA51:{enable:!0,ck:"3Ki5mmyy6E5xtXuf",LingQueMonitorID:"3Ki5mmyy6E5xtXuf"},greetingBox:{enable:!0,default:"晚上好👋",list:[{greeting:"晚安😴",startTime:0,endTime:5},{greeting:"早上好鸭👋, 祝你一天好心情！",startTime:6,endTime:9},{greeting:"上午好👋, 状态很好，鼓励一下～",startTime:10,endTime:10},{greeting:"11点多啦, 在坚持一下就吃饭啦～",startTime:11,endTime:11},{greeting:"午安👋, 宝贝",startTime:12,endTime:14},{greeting:"🌈充实的一天辛苦啦！",startTime:14,endTime:18},{greeting:"19点喽, 奖励一顿丰盛的大餐吧🍔。",startTime:19,endTime:19},{greeting:"晚上好👋, 在属于自己的时间好好放松😌~",startTime:20,endTime:24}]},twikooEnvId:"https://twikoo.dong4j.ink:1024",commentBarrageConfig:{enable:!0,maxBarrage:1,barrageTime:4e3,accessToken:"3a358103e6024cfb97546ec8f8408f5a",mailMd5:"3435c7a74ba1cad3f5d57b0b61b9b25cee221b97599c47b32edbdb36038c5411"},music_page_default:"nav_music",root:"/",preloader:{source:"car"},friends_vue_info:{apiurl:"https://friends.dong4j.ink:1024/"},navMusic:!0,mainTone:{mode:"both",api:"https://img2color.dong4j.ink:1024/api?img=",cover_change:!0},authorStatus:{skills:["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","😎 HomeLab 折腾专家","🏃 脚踏实地行动派","🧱 团队小组发动机","👶 尿不湿更换专家"]},algolia:{appId:"JFMEP32WXP",apiKey:"8e3acd038435dda872706ba6777a54b3",indexName:"blog-index",hits:{per_page:10},languages:{input_placeholder:"输入关键词后按下回车查找",hits_empty:"找不到您查询的内容：${query}",hits_stats:"找到 ${hits} 条结果，用时 ${time} 毫秒"}},localSearch:void 0,translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"简",rightMenuMsgToTraditionalChinese:"转为繁体",rightMenuMsgToSimplifiedChinese:"转为简体"},noticeOutdate:{limitDay:365,position:"top",messagePrev:"该内容距离上次更新已经过了",messageNext:"天，文章内容可能已经过时。"},highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:330},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,simplehomepage:!0,post:!0},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{copy:!0,copyrightEbable:!1,limitCount:50,languages:{author:"作者: dong4j",link:"链接: ",source:"来源: 司机带你开车",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。",copySuccess:"复制成功，复制和转载请标注本文地址"}},lightbox:"mediumZoom",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#425AEF",bgDark:"#1f1f1f",position:"top-center"},source:{justifiedGallery:{js:"https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js",css:"https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!0,shortcutKey:{enable:!0,delay:100,shiftDelay:200},autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={configTitle:"司机带你开车",title:"HomeLab 网络篇：互联世界-构建高效的自托管网络环境",postAI:"本文深入探讨了构建个人云端实验室（Homelab）中的家庭网络配置，涵盖了从基础的架构设计到高级的安全性和异地组网技术。文章详细阐述了如何选择合适的网络设备、部署网络覆盖、设置网络安全策略以及实现异地管理和操作。同时，还分享了实际操作的步骤和经验，帮助读者更好地理解和应用这些网络技术和概念。通过本文的探讨，读者将能够了解到如何构建一个高效、安全且可扩展的自托管网络环境，满足日常工作和学习需求，并为个人云端实验室提供一个稳固的网络基础。",pageFillDescription:"阅读指引, 网络架构, 布线, 弱电箱, 拓扑图, 光猫改桥接, 电视柜, 书房, 网络拓扑图, 关于网线, 总结, 网速, 外网, 内网, 外网-gt家, 设备 IP 管理, IP 设置策略, IP 分配, 设备域名管理, Hosts, DNS 服务, Surge Hosts, 方案总结, 设备连接管理, SSH, 别名配置, SSH 免密登录, SSH 密钥认证, SSH 允许 root 登录, SSH 多因素认证, SSH 会话保持, SSH 端口转发, 1. 本地转发, 2. 远程转发, 3. 动态转发, SSH 跳板机, SSH 两级跳板, SSH 集中管理, 参考, RDP, VNC, 暴露服务到公网, 关于 IPv4, 为什么使用 DDNS, 什么是 DDNS, 动态 DNS 是如何工作的, DDNS 服务配置, dons-go 遇到的坑, 自建获取公网 IP 服务, 获取正确的 IPv4, 对于单网卡, 对于多网卡, 泛解析, 示例, 端口映射, Nginx Proxy Manager, 反向代理, HTTPS 证书申请, 开启 HTTPS 访问, 自定义位置, 高级配置, 代理局域网自定义域名, Surge + NPM, Surge + SmartDNS + NPM, IPv6, 中国的 IPv6 发展情况, 全球 IPv6 发展情况, 实现方式, 现状, IPv6 相关资源, 网络安全, HTTPS 证书, 雷池 Safeline, 用 WAF 替换 NPM, 配置域名代理, NAS 域名代理, NAS 自动部署 HTTPS 证书, 不使用 WAF 的证书管理, WAF 的代理的局限性, WAF 社区版的局限性, 自动部署 1Panel 申请的 HTTPS, 根据环境自动切换 Hosts, NPM, WAF, 自动切换域名映射, 内部服务使用 HTTPS 访问, mkcert 的安装与使用, 不暴露服务到公网, 功能对比, Tailscale, Headscale, ZeroTier, NetBird, Netmaker, 适用场景, 总结, 临时暴露服务到公网, 智能家居设备网络隔离, 广告过滤, Surge, AdGuard Home, 外网访问家庭网络, WireGuard VPN, 传统的 VPN 方案, OpenVPN, L2TPx2FIPsec, IKEv2x2FIPsec, WireGuard 是什么, 相关链接, WireGuard 使用场景, 1. 端到端直接连接, 2. 局域网到外网, 3. 两端都位于 NAT 之后, WireGuard 配置实例, 点对点, Ubuntu, NAS, OpenWrt, lan 改 wan 口, wg-easy 部署, 中继, 打洞, WireGuard 客户端, Surge 上配置 WireGuard, WireGuard 配置详解, 详细配置, Address 24 vs 32, AllowedIPs 的作用, 持久化 Endpoint, DDNS 问题, PostUP 和 PostDown, PersistentKeepalive, 共享 Peer 配置, 路由全部流量, IPv6, 常用命令汇总, 回家方案总结, 分流, 基于 Surge 集中式的分流方案, 方式一, 方式二, 经验总结, 最终方案, 总结在构建个人云端实验室的过程中硬件是基石而网络则是让这些硬件协同工作的血脉和灵魂本篇将深入探讨家庭网络的配置从基础的架构设计到高级的安全性和异地组网技术逐步展示如何搭建一个高效稳定且安全的自托管网络环境我将从以下几个方面进行详细阐述网络架构介绍如何选择合适的网络设备如路由器交换机等以及如何在不同的房间和位置部署网络覆盖安全性讨论如何设置网络安全策略包括防火墙规则配置加密通信等以确保数据的安全性和隐私保护异地组网展示如何通过远程访问技术将家庭实验室扩展到外部网络实现异地管理和操作实践案例分享实际操作步骤和经验帮助读者更好地理解和应用这些网络技术和概念通过本篇的探讨你将能够了解到如何构建一个高效安全且可扩展的自托管网络环境这不仅能够满足日常工作和学习的需求还能为你的个人云端实验室提供一个稳固的网络基础让我们一起揭开家庭网络配置的神秘面纱探索自托管的无限可能吧相关文章先导篇我的概要硬件篇介绍我所拥有的硬件设备网络篇包括网络环境异地组网与网络安全服务篇使用搭建的各类服务数据篇包括数据存储方案备份方案和数据恢复方案数据同步构建高效的数据同步网络数据备份打造坚实的数据安全防线网络续集升级网络再战年内网穿透详解揭秘网络连接背后的奥秘阅读指引由于篇幅较长且不想切分多篇文章影响阅读连续性因此这里给出一个阅读指引以帮助快速理解章节直接的逻辑关系从网络相关的硬件出发以网络布线开始到硬件设备连接重点介绍了弱电箱和书房的网络布局通过外网内网和外网家的网速测试验证宽带的可用性有了硬件和基础网络后如何合理的分配设备地址为了方便记忆为设备分配自定义域名完成上面步工作后接下来就是如何管理多台服务器内网配置完成后接下来就要考虑如何高效的从外网访问家中的设备和服务因为暴露到公网后首先需要考虑的就是网络安全问题出门在外如何快速且安全的访问家中网络看个小电影听听歌为了提升网络体验需要考虑如何屏蔽广告在外能够流畅访问家中的网络那么在家该如何访问公司的网络呢如何流畅的访问互联网世界只能说一点点最后的最后我们应该如何实时了解网络情况网络架构布线从装修开始就考虑到一定会组建自己的但是考虑到弱电箱不够大且没有条件增大只能将硬件放置到各个房间因此在弱电布线时就做了冗余得益于开发商根光纤入户使得宽带冗余方案得以实施同时遗憾的是无法增加更多的宽带数量从弱点箱预埋了总共根八类网线客厅根主卧和书房各根次卧根电信和联通通过弱电箱光纤入户电信宽带电信光猫通过网线连接电信机顶盒电信光猫通过网线连接电视柜中的千兆口由拨号上网的口通过网线回连至弱电箱的交换机交换机通过网线连接主卧和书房实现主要房间电信有线网络联通宽带联通光猫通过网线连接弱电箱旁边的口由拨号上网通过口连接弱电箱中的另一个交换机交换机通过网线连接主卧次卧和书房实现房间联通有线网络因为弱电箱小无法放下所有硬件因此只能采用这种迂回的方式布线关键点是需要额外预埋一条网线将网络从路由器接到交换机再由交换机将网络输送到各个房间如果在装修时没有考虑导致网线不够可以用其他方式实现网线一分为二四芯用于连接无线路由器这种方式当然不推荐网速达不到要求使用电力猫连接电视盒子网线连接无线路由器这种方式会导致电视信号稳定性不高单线复用使用支持的交换机划分两个逻辑独立的网络这种连接方式会增加配置复杂度这里有详细的视频教程弱电箱还好沙发后面有一个公分宽的木架不然这些设备弱电箱还塞不下拓扑图电视柜个网口实现路由器拨号上网与有线回程弱电箱的电信交换机连接和剩下的个网口接到主卧和书房联通光猫连接并由路由器拨号上网连接交换机与联通交换机连接其他网口接到主卧次卧和书房其中和都已将修改为口然后作为旁路由和轻量服务器是用跑了几个服务光猫改桥接光猫改桥接的优势提升网络性能在桥接模式下光猫只负责光电转换将路由功能交给专门的路由器处理这样可以减轻光猫的负担使网络性能得到提升同时所有的设备都位于同一子网内网络结构更加简单便于管理和配置增强网络稳定性光猫在桥接模式下只需完成光电转换简化了其任务从而降低了工作压力提升了家庭网络的稳定性便于故障排查由于路由功能由专门的路由器处理一旦出现问题可以迅速定位到路由器层面进行排查和修复而在路由模式下故障排查可能会涉及到光猫和路由器等多个设备增加了故障排查的难度提高灵活性桥接模式允许用户根据实际需求选择合适的路由器设备实现更灵活的网络配置例如用户可以选择具有更强路由性能的路由器来提升网络稳定性或者选择具有特殊功能的路由器来满足特定需求实现特殊功能光猫改桥接后路由器拨号用户可以实现更多的功能比如可以单线双拨增加带宽改桥接的方法可以网上搜索保险起见直接让运营商修改即可电视柜电视柜中的剩下的分别连接了小米壁画电视和书房书房承载了的网络设备因为设备是慢慢增加的所以一开始并没有直接购买太多网口的交换机后面设备增多后因为交换机体积的问题也没有直接更换成更多网口的交换机而是直接通过增加交换机数量进行网络扩展而因为接入了电信和联通每条宽带都需要增加双倍的交换机数量书房个网口分别有线接入电信和联通网络除了和单独的开发版书房所有供电全部来自于最右边的插座因此增加了一个小米智能插座来统计书房的耗电量因为书桌上设备太多总共通过个口插座和个小米插座来供电放一个书桌下面的走线图不能说乱吧只能说隐蔽工程做的不太漂亮网络拓扑图网络设备全部通过双网口接入电信和联通网络如果没有双网口的设备则通过或转网口实现现在还没有条件实现书房主要设备万兆局域网这将是下一步的升级目标由于早期申请了电信宽带当时申请公网相对容易正是因为这个公网当前宽带无法升级到经咨询升级可能会导致公网被收回鉴于现有带宽足够使用加上还有一条千兆联通宽带暂时没有升级的迫切需求宽带配置和使用情况电信宽带主要满足日常上网需求手机等常用设备优先接入电信网络联通宽带最初为免费赠送的带宽后来通过活动以每月元升级到千兆通过协商安装师傅也获取了一个公网联通宽带主要用于智能设备联网和文件下载作为电信宽带的备用网络双宽带优势两条独立宽带确保当一条线路的网络服务出现问题如运营商线路故障或光缆被挖断时仍可通过另一条线路访问家中设备但需注意如果停电两个网络都会中断目前还不具备部署大型备用电源的财力网络优化方案为减少信号干扰进行了以下调整管理关闭光猫和非主要路由器的功能使用及其设备台的提供全屋漫游覆盖智能设备专网配置作为智能硬件的网络接入点启用和频段为访客提供专用的访客保障主网络的安全性通过这种分工不仅可以优化网络性能还能减少干扰确保家庭网络的稳定性和可用性关于网线刚开始并没有考虑到全网光纤这是一大败笔现在换成光纤成本有点高还好预埋了八类网线不过当时功课没有最好感觉类型越高越好完全没有考虑价格导致弱电装修增加了不少成本家用网线超六类完全够用不同规格网线速率图规格类型速率接口备注五类线不推荐超五类线网络仅限米以内六类线万兆网络仅限米内超六类线米内可达万兆网络没有标准七类线带着遮蔽光纤不懂详见维基百科因为七类以上的网线有遮蔽罩需要正确接地处理反正来给我打水晶头的人不知道怎么接不过因为速度还是能达到万兆网速所有还没有深究这个问题等到有时间再去折腾吧总结上一篇说过为什么不通过双线多播和猫棒等手段来提升宽带速度主要是稳定性和容错考虑也否定了的方案避免的问题而是使用多个硬件承载不同的需求在硬件设备上我也实现了多台冗余的设计比如多个设备网络相关的服务集群部署等主要是保证可用性多年互联网开发经验告诉我多台服务器比单台性能强劲的服务器更加靠谱和经济实惠既能保证高可能还能提高可扩展性唯一的缺点就是多服务器的管理和配置难度上升网速外网电信联通内网内网主要设备全部实现通过雷雳直连的台能达到通过万兆交换机连接的和能达到速度外网家给一个逆天的网速测试截图就当图了乐设备管理从书房的网络拓扑图可以看出主要硬件设备的地址分配都保持有序这种规划方式的优势是只需记住设备的最后一位数字便能快速找到对应设备另一种常见方式是通过修改文件为每个设备设置对应的域名最理想的解决方案是自建服务以集中管理所有设备的解析任务更高效地应对设备数量的增加和变化设置策略由于设备较多且未来可能增加新设备因此未采用在设备端手动设置静态的方式原因灵活性某些设备如开发板可能频繁切换网络或连接不同宽带易管理通过路由器实现静态绑定既简单又高效可统一管理设备的地址分配设备分配方案按照网口数量进行粗略分组地址基于其连接的电信或联通宽带进行划分这种规划既便于扩展又确保了网络结构的清晰和可控性分配粗略按照网口对设备进行分类网口数量设备所需数量移动设备单网口小米电视单网口开发板双网口个千兆网口链路聚合成个网口另一个万兆网口电信联通各一个双网口网口网口组装机算下来只需要记住个当然都是有规律的比如电信联通电信联通分配规则为了便于管理和记忆主要设备的地址分配遵循以下规则前位分配给主要设备如设备需要连接直接在有线的基础上翻倍即可比如为就是如果某设备超过了位范围且有额外的连接需求则在有线后面添加一个比如为就是超出规则时的处理当添加导致超过时直接将下一位地址递增比如为就是确保分配合法避免使用非法其他设备的分配无关紧要的设备使用之后的地址当前段的数量尚充足如有需求可以再开放更多的段优势分析这种分配方式使主要设备的规划简单易记同时将无关紧要的设备划分至段后可以减少对主要设备地址段的干扰确保未来扩展设备时的灵活性和有序性设备域名管理通过修改文件为每个设备设置对应的域名是一种常见的本地解析方案然而这种方式存在以下问题每台终端需单独配置每次新增设备都需要在所有终端的文件中手动添加配置不支持泛域名解析系统自带的文件无法处理类似的泛域名因此这种方式管理效率较低扩展性差特别是设备数量多或频繁变动的场景显得尤为不适用推荐替代方案通过自建服务实现集中管理不仅支持泛域名解析还能减少每台终端的配置工作量提升管理效率和灵活性服务常见的自托管服务有功能特点轻量级和服务器支持本地解析缓存静态绑定适用场景家庭和小型局域网中使用配置简单资源占用极低优点轻量化易配置支持本地静态和域名绑定缺点高级功能较少不适合大型网络或复杂解析场景功能特点模块化插件化设计的服务适合现代云环境适用场景集群微服务架构的管理优点支持负载均衡缓存等高级功能插件化架构功能可扩展性强缺点配置和学习曲线相对较高对初学者可能显得过于复杂功能特点高性能解析器专注于提升解析速度和可靠性适用场景需优化解析速度的环境如加速海外解析影音服务优点支持多线路快速选择优化海外解析性能缺点功能专注于加速不适合复杂解析需求高级功能较少生态支持不如其他方案功能特点集成广告拦截的服务提供友好的管理界面适用场景家庭网络广告屏蔽和基础管理优点易用的界面配置简单直观集成广告拦截隐私保护功能缺点灵活性不足偏向家庭用户插件和高级扩展支持较弱功能特点以广告拦截为核心的服务可运行于或其他小型设备上适用场景家庭或小型办公网络中的广告屏蔽和基础管理优点强大的广告屏蔽功能配置简单支持轻量级部署缺点高级功能支持较弱更适合广告屏蔽用途不适合复杂网络需求功能特点高性能递归服务器支持和隐私保护适用场景需要安全高效的递归服务的环境优点支持适合需要隐私保护的场景配置灵活性能出色缺点缺少界面配置文件复杂度较高功能特点功能全面的权威服务器广泛用于企业环境适用场景企业级复杂解析需求的服务优点支持权威解析递归解析等功能功能全面企业标准缺点学习成本高适合有经验的管理员对系统资源的需求较高总结对比表工具轻量化高性能易用性插件扩展高级功能适用场景家庭小型网络微服务环境加速影音服务广告屏蔽家庭网络广告屏蔽基础管理安全递归服务企业环境权威服务方案选择推荐轻量化和便捷配置选择广告拦截和易用性选择或高性能递归解析选择复杂企业级需求选择云原生环境或微服务架构选择追求解析速度优化选择目前在用的是轻量级的和的固件中自带这个服务稍微配置即可实现自定义并具备广告拦截的功能只需要满足主要设备能通过域名访问其他服务器或服务即可因此没必要单独部署一个解析服务和更多的是用来拦截广告本身就具备管理功能且支持泛域名解析可以通过或服务来同步配置避免多端重复配置的代理所有的全部转发到的端口然后再通过转发到其他服务方案总结在实际使用中没有单一方案能够完全满足所有需求因此需要根据不同场景搭配多种方案我想实现的目标就是方便快捷的访问设备与服务避免记忆大量地址及端口号提升访问效率其实主要设备就那么几台记住几个也不是那么难且主要设备的肯定不会经常改动问题是每台服务器的服务需要通过端口区分如果是服务直接用这类服务来管理嫌麻烦就用书签推荐另一种则是通过自定义域名的方式减少需要记住的数量前面已经介绍过功能我将结合再次简化掉端口直接通过自定义域名访问所有服务具体的配置将在后续详细说明所以总结下来就以下几点使用浏览器书签管理常用服务在服务篇会使用开源的服务来管理使用实现端口访问自定义域名简化域名并减少记忆设备连接管理能通过连接的设备我这里统称为服务器那么在不算虚拟机的情况下总共有台设备如果需要同时访问多台设备在使用自带的终端或一个个手敲的话效率非常低不过我们可以通过多种方式提升效率别名配置首先想到的是为每台服务器设置一个简短好记的别名我们可以编辑文件来实现别名服务器连接方式别名免密登录为了避免每次都需要输入密码我们可以配置的免密登录客户端沈城密钥对这里输入新的密钥保存路径我没有直接保存到默认的中后续会共享这个密钥使用工具将公钥传输到目标服务器如果未安装可以手动传输公钥将公钥复制到剪贴板登录服务器在服务器上将公钥添加到验证免密是否生效如果没有提示输入密码则配置成功拷贝公钥到其他服务器后为了实现局域网服务器之间免密登录我会将第一步生成的也拷贝到其他所有服务器值得说明的是和可以通过进行配置密钥认证为了安全起见建议关闭密码认证只开启公钥认证编辑服务器上的配置文件完全禁止使用密码认证强制所有用户使用公钥认证启用公钥认证禁用空密码登录重启服务以应用更改注意不同的系统重启命令可能不一样配置本机的别名服务器允许登录数据篇中会讲到如何使用备份服务器上的重要数据前提是必须使用账号登录服务器所以这里顺带把允许登录一起写一下开启登录会增加潜在的安全风险及时只是在内网使用编辑服务器上的配置文件允许用户登录但仅限密钥认证不允许密码登录以下是增加安全性的常规手段限制登录的段仅允许密钥登录启用多因素认证使用自动封禁多次失败的登录尝试更改默认端口多因素认证更进一步你可以为开启多因素认证安装模块为登录用户生成一个基于时间的一次性密码配置扫描生成的二维码到或其他支持的应用编辑文件在文件的顶部添加以下内容编辑配置文件调整以下参数启用挑战响应认证保留或禁用密码认证根据需要下重启服务注意事项备份密钥与备用代码确保生成的密钥和备用代码保存在安全的地方排除特定用户可在配置中定义例外用户组跳过是无需的用户组结合密钥配置密钥认证与结合使用提升安全性会话保持同一主机的多次连接可以复用已有连接减少登录时间添加私钥到并允许其存储在密钥链中通过管理私钥特别适用于将私钥安全存储指定私钥路径对所有连接生效启用多路复用允许复用现有的连接无需每次重新认证指定控制套接字存储路径可使用或用户目录下的子文件夹如即使没有活动会话主连接仍保持最多小时启用数据压缩尤其适合低带宽网络心跳包设置防止连接因空闲超时被断开每秒发送一次心跳包心跳失败超过次后断开连接端口转发经常使用到且会用到端口转发功能这里仅做个记录本地转发本地转发是一种通过创建的隧道它允许你将本机的某个端口上的通信通过服务器转发到另一台远程服务器的指定端口在这个过程中服务器充当了一个中继的角色使得本地计算机能够访问那些它原本无法直接连接的远程服务本地转发是在本地机器上设置转发规则语法如下其中会指定本地端口服务器远程服务器和远程端口上面命令中有三个配置参数转发本地端口不发送任何命令只用来建立连接没有这个参数会在服务器打开一个将连接放到后台没有这个参数暂时不用连接时终端会失去响应假设本地开发机只能访问跳板机网络且跳板机因为多网卡能够访问网络拓扑图如下在本地开发机上执行关闭本地端口转发同时可以配置实现当在本地机器上访问时会将流量通过加密的连接转发到远程服务器的端口这里的加密的连接是指连接通道使用场景远程数据库访问将本地的端口映射到远程服务器的端口这样就可以使用本地的数据库管理工具访问远程数据库服务访问如果你正在远程服务器上开发应用并且需要从本地机器访问这个应用可以通过本地转发将远程服务器的端口映射到本地计算机的某个端口替代方案当你无法使用时可以通过本地转发来安全地访问远程网络中的资源远程转发远程转发指的是在远程服务器建立的转发规则它跟本地转发正好反过来建立本地计算机到远程服务器的隧道以后本地转发是通过本地计算机访问远程服务器而远程转发则是通过远程服务器访问本地计算机它的命令格式如下上面命令中参数表示远程端口转发是远程服务器的端口和是目标服务器及其端口是远程服务器远程转发主要针对内网的情况下面举两个例子第一个例子是内网某台服务器在端口开了一个服务可以通过远程转发将这个端口映射到具有公网地址的服务器的端口使得访问这个地址就可以访问到那台内网服务器的端口上面命令是在内网服务器上执行建立从到的隧道运行以后用户访问就会自动映射到第二个例子是本地计算机在外网跳板机和目标服务器都在内网必须通过跳板机才能访问目标服务器但是本地计算机无法访问内网之中的跳板机而跳板机可以访问本机计算机由于本机无法访问内网跳板机就无法从外网发起隧道建立端口转发必须反过来从跳板机发起隧道建立端口转发这时就形成了远程端口转发跳板机执行下面的命令绑定本地计算机的端口去访问上面命令是在跳板机上执行的建立跳板机到的隧道并且这条隧道的出口映射到显然远程转发要求本地计算机也安装了服务器这样才能接受跳板机的远程登录执行上面的命令以后跳板机到的隧道已经建立了然后就可以从本地计算机访问目标服务器了即在本机执行下面的命令本机执行上面的命令以后就会输出服务器的端口返回的内容示例假设本地开发机不能访问跳板机网络但是跳板机可以访问本地开发机且跳板机因为多网卡能够访问网络这时本地开发机想访问服务拓扑图如下在跳板机上执行同时可以配置实现使用场景将还在公司加班的你本机上的暴露到公网在家的同事就能和你愉快的调试接口了你本地的软路由具备分流能力你兄弟需要临时用一下查阅点学习资料动态转发动态转发指的是本机与服务器之间创建了一个加密连接然后本机内部针对某个端口的通信都通过这个加密连接转发它的一个使用场景就是访问所有外部网站都通过转发动态转发需要把本地端口绑定到服务器至于服务器要去访问哪一个网站完全是动态的取决于原始通信所以叫做动态转发上面命令中表示动态转发是本地端口是服务器表示这个连接只进行端口转发不登录远程不能执行远程命令只能充当隧道举例来说如果本地端口是那么动态转发的命令就是下面这样注意这种转发采用了协议访问外部网站时需要把请求转成协议才能把本地端口的请求转发出去下面是隧道建立后的一个使用实例上面命令中的参数指定代理服务器即通过协议的本地端口访问示例在上可以看到请求跳板机跳板机公网通过跳板登录到使用方式或者两级跳板首先我们需要在本机设置第一级隧道执行以下命令这条命令的作用是在本地机器上监听端口并将所有发往这个端口的请求通过隧道转发到这台机器的端口接下来在第一台跳板机上我们需要建立第二级隧道执行以下命令这条命令的含义是将上的端口通过隧道连接到然后再由转发到目标服务器的端口这样设置后当我们访问本机的端口时请求实际上会被转发到的端口应用场景这种多级端口转发的设置常用于以下情况访问内网服务器当目标服务器位于多层内网中直接访问受限时可以通过多级跳板机进行访问安全加固通过多级跳板机增加攻击者入侵的难度提高系统的安全性网络隔离在需要隔离不同网络环境的情况下通过跳板机实现数据的传输集中管理通过来管理多个服务器使用打开服务器列表但是并没有分组功能管理多个服务器不是特别方便这里有一些比较热门的终端管理工具目前我使用的是目前觉得完全满足我的大部分需求且部分特性还能带来一些小惊喜中的概念是将所有被管理的服务器集中持久化成一个文件因为这个文件会存在服务器连接信息所以还支持加密我可以将这个文件通过同步到其他上这就可以实现一次配置到处使用另外像端口映射安全网关密钥管理等这些常规功能全部支持另外比较惊喜的就是能通过插件机制支持等远程管理功能你一个比较惊喜的功能就是开启多个窗口在一台服务器上的操作会同步输出到其他服务器这个可以大大简化服务器的配置工作简洁的转发设置串口连接但是也有它的不足比如文件管理不方便连接分辨率无法动态适配等所以我使用了另一款工具它的优点是文件管理和系统监控亮点是基于的命令行提示双击文件即可直接编辑文件可拖拽上传下载文件服务器监控面板功能可视化的端口转发配置参考转发代理用法详解避免重复输入的應用在远程主机上使用本地的进行认证比如在远程主机上进行操作到另一台主机等避免将私钥到远程主机上在上配置强制进行双因素认证每次登录都需要输入提供的一次性动态密码上述款工具都不能很好的支持完美的远程桌面所有我使用了如何删除上安装搭建远程桌面后面远程桌面是可以了但是用户目录下生出了一个文件夹无论是不是都不能删除如果你有强迫症你就感觉不舒服一定要删除下面介绍如何删除打开并修改文件将修改为由于目录不存在所以不会创建文件夹也可以将放到目录下然后删除文件夹以后重新登陆也不会再出现并且远程连接共享剪贴板仍然有效如果只是连接的话官方的屏幕共享更值得推荐因为屏幕共享无法连接到树莓派所以使用或远程桌面每次重启后密码改变的解决方式问题描述服务器在启动时如果密钥环未解锁将无法访问存储的加密密码结果是每次服务器启动时都会自动生成一个新的密码问题原因在自动启动期间不会自动解锁密钥环这影响了服务器的正常使用解决方案打开密码和密钥实用工具转到实用工具菜单选择密码和密钥修改默认密钥环的密码在密码和密钥管理器中右键单击默认密钥环选择更改密码输入并确认操作系统将要求您输入当前的用户名密码在新密码和确认密码字段中不要输入任何内容保持空白接受风险警告系统会警告您密钥环上存储的所有密码将不再加密并将保持未加密状态如果您能够接受这个安全风险确认更改通过以上步骤可以解决中服务器在自动启动时无法访问加密密码的问题但是这样做会降低密码的安全性因此可以采用下面推荐的方式推荐的方式在密码和密钥应用程序中执行以下操作创建一个新的无密码密钥环打开密码和密钥应用程序创建一个新的密钥环并在创建过程中不设置密码将这个新的无密码密钥环设置为默认从登录密钥环中删除密码在密码和密钥应用程序中找到登录密钥环删除存储在登录密钥环中的密码重新启动计算机重启计算机以确保新的无密码密钥环成为默认密钥环重启后执行以下步骤重新输入密码在屏幕共享设置中重新输入密码这将把密码存储在新的不安全密钥环中恢复登录密钥环为默认回到密码和密钥应用程序将登录密钥环重新设置为默认密钥环再次重新启动计算机现在密码保持保存而默认密钥环也恢复为登录密钥环这种方法将所有密码保存为纯文本的不安全性降低到仅将密码保存为纯文本暴露服务到公网关于截至年地址已经全球接近耗尽自年正式宣布地址枯竭以来地址池的可用数量持续减少导致剩余的地址在二级市场上的价格不断上涨使用位地址空间可以提供超过亿个唯一地址然而随着互联网连接设备数量的激增这一地址池已经被耗尽北美亚洲和欧洲是剩余地址的主要持有地区其他地区的地址资源相对匮乏由于地址短缺许多组织和网络运营商开始依赖网络地址转换技术允许多个设备共享一个公共地址此外的推广也成为解决地址耗尽问题的重要手段但由于兼容性问题以及过渡成本较高的部署进展较慢目前地址的租赁和转售成为一种常见的做法尤其是在面临地址匮乏的企业中尽管如此这种做法仅是临时性的解决方案而的普及正在变得愈加迫切为什么使用我早期申请的电信和联通的公网都是动态的会被运营商不定期的修改为了避免因公网变更无法访问家中的服务的问题现在最常用的方案就是使用服务什么是动态是一项在地址发生变化时可以自动更新记录的服务域名将网络地址转换为人类可读的名称便于识别和使用将名称映射到地址的信息以表格形式记录在服务器上但是网络管理员会动态分配地址并经常更改每当地址发生变化时服务都会更新服务器记录借助域名管理变得更容易更高效动态是如何工作的以下是一般步骤向动态服务提供商注册域名并配置设置向提供商提供域名的初始地址使用更改的地址在设备或服务器实例上安装动态客户端客户端持续监控地址并检测任何更改客户端向动态提供商发送记录更新通知通知其新的地址动态提供商修改记录以指向新地址动态客户端会继续监控地址以了解进一步的更改每当发生新的更改时该过程都会重复简单来说宽带运营商只会给我们动态的公网这个会不定时变化为了能使域名映射到正确的上需要借助将当前最新的通过通知到服务运营商以修改为最新的我所使用的域名服务商分别是阿里云和腾讯云为了正常使用服务需要到对应的域名运营商申请后面使用会用到服务配置我目前的设备自带了服务的有外部访问这类系统服务阿里云和服务动态但是我并没有直接使用上述的服务而是选择使用部署这样可以方便的同步配置以便快速在其他设备上部署遇到的坑设置错误导致调用失败运营商的一般都是秒再快就得加钱了最好设置为自动避免调用失败通过接口获取太频繁被限流自带了几个用于获取的服务但是因为频繁调用被接口服务商限流通过接口获取的错误这是因为部署的设备同时部署了分流服务需要修改分流规则我采用第二种方式不使用接口获取通过网卡获取这种方式只能获取到局域网适用于通过命令获取最终采用这种方式且返回地址的服务通过在云服务器自建了一个获取的命令如下网卡名这种方式需要处理多网卡的情况因此需要参数通过网卡获取一般会有多个地址需要通过正则表达式筛选电信为开头移动为开头联通为开头启动前分钟具体几分钟记不得了反正越快越好才能设置账号密码最好禁用公网访问这样只能通过局域网访问可以配置变更通知我使用的是服务全平台可用且服务也能自托管自建获取公网服务我的目的很简单就是专为提供的查询服务因此没有加证书云服务器安装并添加配置关键的配置如下记得在安全组开端口端口号端口号访问即可返回文本格式的公网如果想自行部署可参考利用实现简易的公网查询获取正确的因为我有个公网域名分别对应不同的服务商宽带运营商域名服务商域名假设路由器电信阿里云联通腾讯云对于单网卡比如当前设备是这台路由器下的子设备按照上述表格应该获取到电信的公网并通知到阿里云的已将映射到正确的上对于多网卡为避免单点问题我同时在和上部署了服务它们同时具备多张网卡运行显示的路由表如下目标网关子网掩码标志跃点引用使用接口表头字段解析目标指向的目标网络或主机地址表示默认路由适用于所有未匹配其他路由的流量网关数据流量需要通过的下一跳如果为表示目标为直连网络第一行是表示经过联通路由器子网掩码定义目标网络的范围标志路由是活动的流量需要通过网关跃点优先级数值越小优先级越高后面修改网卡优先级也就是修改这个值引用保留字段通常为使用该路由表条目被命中的次数接口数据流量通过的网络接口路由表内容分析第一行目标网关子网掩码标志跃点引用默认路由匹配所有流量网关接口跃点优先级高于第二行第二行目标网关子网掩码标志跃点引用默认路由同样匹配所有流量网关接口跃点优先级低于第一行总结多默认路由两条默认路由同时存在系统会优先使用跃点较低的路由即故障转移如果优先路由不可用系统会自动尝试使用优先级较低的路由第一行跃点为且网关为表示会优先使用这张网卡走联通网络同理我们整理一张表格服务器第一优先级第二优先级联通电信电信联通联通电信为了保证获取正确的地址应该这样配置所在的服务器电信公网联通公网是前面说的自建的获取公网的服务一定要注意第一优先级的网卡对应的是哪个路由器以及路由器对应的宽带服务商泛解析前面通过使用动态域名解析服务我们将动态公网与一个泛域名例如绑定这样一来所有三级域名共享同一地址泛域名的配置意味着等三级域名都会指向同一个动态公网无需为每个子服务单独创建域名解析记录减少管理工作当公网变化时会自动更新与该关联的域名解析无需手动更新每个子域名的记录提高了效率和维护便利性便于扩展和服务管理不同的三级域名可以被路由到不同的内部服务或设备如等实现灵活的服务部署而不增加域名管理的复杂性示例假设公网动态变化且通过绑定到了泛域名以下请求都能被正确路由博客接口服务通过这种配置大大简化了域名管理流程同时适配动态环境端口映射前面我们已经将公网成功绑定到了指定域名上比如我需要访问的只需要在路由器上开放指定的端口并映射到正确的上最好修改外部端口号不要与内部端口号一样这样我们就可以通过访问内部的然而随着需要暴露的服务越来越多通过路由器进行端口转发管理会变得繁琐尤其是每个服务需要独占一个端口例如服务端口服务端口服务端口这种方式不仅难以记忆还会造成端口冲突并且极度浪费端口资源如果熟悉反向代理的话除了通过端口区分服务还能通过域名区分服务服务服务这样我们只需要一个端口即可代理多个服务以下是一个简单的配置用于将不同的域名路由到不同的内部服务映射到服务映射到服务映射到服务虽然的配置文件设计得非常简洁并支持热加载通过无需完全重启服务但是在命令行下操作确实有点不方便可视化操作配置目前成熟的方案非常多比如中的宝塔面板中的这类服务选择一个顺手的就行目前我使用的是为了安全起见已将所有服务迁移到雷池反向代理反向代理配置非常简单只需要配置域名协议内网一般选择外部访问如果需要则需要在选项卡中配置证书这个后面详细介绍转发主机内部服务所在的服务器转发端口服务端口我们以外网通过访问为例假设后面简称监听的端口为为那么配置步骤如下在路由器上配置端口转发端口指向的端口在添加代理服务配置访问即可访问的服务整体的流程为通过定时调用将获取到的最新公网推送给域名服务商在路由器将特定端口绑定到的端口比如在进行代理服务配置将域名映射到指定服务这样我们就能通过某个固定的端口结合不同的域名访问不同的服务也提供你可以玩一些比较花的操作比如通过脚本随时关闭开启某个代理服务证书申请还提供证书申请服务可申请个月的免费证书并能够自动续期需要验证你对证书中域名的控制权也就是说你要能证明这个域名是属于你的有两种验证方式一种是基于的验证方式另一种是基于的验证方式关于这方面的教程非常多所以这里就不在赘述了只说说我遇到的问题这里是解决方法进入容器在使用的过程中第一次申请证书会消耗大量时间出现多次申请失败的情况且自动续期经常会失败再尝试了通过的证书管理功能后果断弃用了的证书管理功能这个在网络安全证书证书一节中详细说明值得注意的是如果启用了在路由器的端口转发配置时需要将外部端口映射到的端口开启访问证书申请后给域名添加需要注意你的的端口号比如是那么在路由器配置端口转发时就要使用此端口号自定义位置自定义位置是在特殊场景下提供的一种定制化配置比如我的服务它的完整路径是这样的通常为位随机字符串这个会作为在多个地方使用且会有多个客户端的比如上面的就是将消息通知到手机而则是通知到为了方便记忆且在重置后不需要重新修改设备上的地址可以这样设置地址则变更为这里有一个通过搭建获取公网服务的说明高级配置如果上无法通过可视化配置满足你的需求你可以进入挂载的目录直接修改配置可以按照如下方式添加自定义配置片段文件包含在的顶部包含在的最末尾包含在主块的顶部包含在主块的末尾包含在事件块的末尾包含在主流块的末尾包含在每个代理服务器块的末尾包含在每个重定向服务器块的末尾包含在每个流服务器块的末尾包含在每个流服务器块的末尾包含在每个流服务器块的末尾更多的配置说明可自行查看官方文档代理局域网自定义域名后面会讲到使用雷池代替用替换所有代理服务都会迁移过去所以就沦为了局域网自定义域名的代理工具接下来设备域名映射一节中关于如何使用来简化域名访问的详细配置通过自定义域名减少需要记忆的数量流程大致如下配置自定义域名所有的全部解析成配置意思是来自的请求会被代理到上即的服务总结下来将全部解析成当请求时被发送到的端口根据域名判断应该代理请求到哪个服务为了简化我们使用的端口所以需要注意的的端口配置代理端口代理端口管理端口接下来就是在上重复添加代理配置了我的自定义域名规则作为顶级域名服务器作为二级域名比如服务名服务器作为三级域名比如值得注意的是因为不是有效的因此在第一次使用的时候需要输入完整的否则会被当成搜索请求成功打开一次后即可后面就不需要完整输入了当然你也可以将改成其他的比如补充说明因为只能代理协议如果协议也想使用域名你可以在添加一条配置比如的是我想使用连接使用方式其实还可以结合来达成同样的目的但是这种方式比多了一层这是没有采用的原因之一只是用来获取指定域名的地址用于解析的作用不变具体配置为配置修改为表示域名使用部署在上的提供的服务来获取解析配置如下官方文档说是支持这种通配符解析的但是本地测试并没有成功这是没有使用的原因之二其他域名配置同样是指向的意义在于作为一个服务为局域网设备提供解析服务问题是需要在多台服务器上进行地址配置我的目的只是在主要设备上实现域名访问显然更适合所以这也是没有使用的原因之三中国的发展情况截至年中国在的发展方面取得了显著进展以下是根据中国发展状况白皮书和相关报道总结的几个关键点用户数量截至年月中国的活跃用户数达到亿占全体网民总数的这个比例从年初的显著提高已分配地址的终端数达到亿其中移动网络终端为亿固定宽带接入网络终端为亿发展阶段中国的发展经历了起步期年至年中爬升期年中至年一季度和稳定期年一季度至今三个阶段网络流量移动网络流量占比达到固定网络流量占比为城域网总流量占全网总流量的网络性能网络性能得到显著提升其时延降低丢包率减少显示出在网络性能和稳定性方面的潜力基础资源中国在地址申请量和拥有量方面均位居世界第二自治系统数量占比达到政策支持中国政府高度重视的部署和应用自年推进互联网协议第六版规模部署行动计划发布以来已出台多项政策明确发展目标和时间表全球发展情况全球范围内的部署和应用也在加速推进以下是根据全球发展指数报告总结的几个关键点全球覆盖率年全球网络部署显著提速总体覆盖率首次突破部分领先国家的覆盖率已经达到或接近其移动流量占比也已超过技术发展随着网络的基本建成领先国家的规模部署及应用开始进入新的阶段政策聚焦逐渐从网络扩张转向技术的产品化落地和规模化应用数字经济作为数字基建的底座是互联网升级和网络技术创新的重要基石创新技术应用融合行业应用场景加速落地为各行业的数字化智能化转型提供了关键支持都在迅速发展已成为成为支撑现代互联网和数字经济发展的关键技术对于个人用户的一个巨大优势在于即使宽带运营商不提供公网也可以通过直接访问家中的设备的优势无限制在网络中运营商通常使用网络地址转换来将多个用户共享一个公网这限制了用户通过公网访问家中设备的能力而提供了几乎无限的地址空间每个设备都可以拥有独立的公网地址端到端通信支持真正的端到端通信消除了带来的复杂性这使得用户可以直接通过地址远程访问家中的路由器摄像头等设备无需依赖或复杂的端口映射更高的安全性内置了支持可以实现更安全的通信同时的分布式地址分配方式减少了攻击者扫描设备的可能性与和物联网结合随着和智能家居的发展更多设备开始支持这将进一步简化联网设备的配置和管理实现方式确认运营商支持确保宽带提供商已经开通服务当前中国主要的运营商如中国电信中国联通中国移动正在大力推进部署配置路由器确保家庭路由器支持并启用了开启后将为家中设备分配公网地址远程访问设备通过地址直接访问设备例如也可以使用服务将复杂的地址映射为易记的域名兼容性处理对于不支持的场景可以使用到的隧道技术如或来实现兼容通过这些方式即使没有公网地址也能利用更方便地管理家中的设备特别是在需要多设备远程访问的情况下现状我目前已经实现了主要设备的访问且通过绑定了域名但是因为安全性问题安全认证登录并没有覆盖到所有服务因为绑定了域名如果被猜测出端口号就会被非法访问暂时关闭了所有的访问开启路由器的防火墙与相关的服务配置比如等就自行搜索了本文不过多描述相关资源测试地址连接测试查询与检测报告国家发展监测平台中国发展状况全球发展指数报告网络安全网络安全涉及到的方面非常多大体包括强密码策略多因素认证使用或子网进行网络隔离使用加密协议部署防火墙定期更新服务修复已知漏洞蜜罐系统在环境中部署物理防火墙虽然是理想的安全方案但成本高昂对于普通用户并不现实相比之下使用加密协议是最容易实现且高效的安全措施之一而强密码策略多因素认证这个则是个人使用习惯我一般都会使用生成不重复且复杂的密码且开启具备多因素认证服务的二次认证在使用了来管理一次性密码这样的还有很多比如还有最近打算部署一个蜜罐系统玩玩儿它是一种攻防兼备的工具通过欺骗和分析攻击者来增强网络防御通过主动布防主动示弱攻击者并且进行反制使网络攻击不再是一个没有损失只有收益的事情证书前面介绍过使用来申请并自动续期免费的证书证书申请但因为不稳定而被弃用转而使用的的证书申请与管理服务的证书申请非常快且成功率可以采用手动的方式为雷池添加证书也可以自动化部署证书到自动部署申请的雷池雷池号称下一代应用防火墙社区版功能完全够用主要因为专业版太贵专业版多了告警负载均衡等功能用官方的测试工具玩了一下攻击检测日志中的信息非常全面且还有攻击分析后续我将使用代替雷池用替换买不起硬件防火墙软件防火墙我们还不能白嫖吗所以为了玩一玩这个号称这么牛逼的软防火墙将的代理全部迁移到了现在则沦为内网自定义域名的代理服务所以就直接使用台虚拟机通过部署了分别替代电信和联通网络的防护功能要比多几个且有展示访问与拦截情况配置域名代理与不同的是在配置域名时确认端口号而在启动时就确认了和端口所以的优势是能够为不同的域名设置不同的端口如上配置的话就需要在路由器分别为和配置端口转发规则局域网添加部署的服务器域名代理补充说明一下如何代理流量客户端全平台支持我在手机和电脑上使用了客户端假设我想使用来访问上的服务那么只需要在添加一个域名配置熟悉的朋友都知道是的的端口接着在路由器上配置端口转发将转发到然后在手机客户端上登录配置没问题的话应该就可以正常登录了如果登录失败请自行检查端口转发的端口号等是否设置正确然后如果你将上述的域名和端口配置到桌面版的会发现连接不上这是因为端程序开放的默认访问端口为对移动端的开放的默认访问端口为客户端会根据输入的域名或自动选择默认端口进行访问客户端如果未指定端口会默认使用移动客户端默认使用或如果用户明确填写了端口号客户端会优先使用指定的端口在局域网中直接输入的地址即可连接是否加端口号均可在外网访问时需要将外部端口转发到的相应内部端口例如服务使用的网络端口所以为了让桌面版的能正常使用我们需要在路由器上多配置一个端口转发规则因为它不支持转发的代理的局限性桌面版连接配置这里启用数据传输加密最好能勾选上但因为没有通过转发所有无法使用中的证书配置你需要在中配置证书后面会讲到为什么使用的证书管理代理的证书管理且实现申请证书并自动部署到这里会先用到的个证书如果没啥头绪可以先看完自动部署申请的自动部署申请的再回过来看这里新增证书入口控制面板安全性证书新增证书导入证书或从获取证书如果是更新证书就选第二项替换已有证书导入证书不要勾选设为默认证书如果你知道是什么操作可执行选择私钥证书中间证书可不填为配置自定义证书自动部署证书当然这又是另一个话题了我会单独出一个指南通过将证书自动部署到和相关链接两个优化点证书增加使用路径导入方式群晖通过全自动更新并部署证书记我群晖上的项目和不使用的证书管理无法申请泛域名证书所以就有点尴尬不过最新的情况是官方已经在考虑通过验证的方式来支持泛域名证书申请了所以还是可以期待一下的其他开发计划也可以关注一下的代理的局限性只能代理服务不支持四层代理转发官方的回答是不支持没必要只关注七层网络协议专注于流量的检测与清洗但是一般都是部署在公网之后的那台服务器作为所有流量的入口然后才是转发到后面的或其他服务如果只支持七层代理转发的话诸如这类层的流量还得单独配置可以看看这里的讨论不知道官方会不会支持为了解决上述问题我目前使用的方案如果是服务全部通过路由器转发到所在的服务器上然后由进行后续的转发其他服务比如等四层协议的流量则通过路由器直接转发至指定的服务器前面域名代理域名代理就是一个例子社区版的局限性和的配置自由度比起来社区版则不是那么具有可玩性因为会定时覆盖手动修改的配置文件不过也有不是那么优雅的解决方案接下来通过一个例子来说明一下操作方式首先在上创建一个站点用于返回当前时间和客户端真实点击创建好的站点然后渠道静态资源选项卡添加一个页面内容如下访问可返回当前时间接下来去服务器手动修改的配置文件刚刚添加的测试站点的配置文件为打开并编辑在中添加如下配置保存退出为了防止定期覆盖手动修改后的配置文件我们需要给刚刚的配置文件添加不可变属性重新加载配置最后访问可获取到客户端使用蜂窝网络的手机访问关键点是防止覆盖我们修改过后的文件如果需要再次编辑使用文件名恢复自动部署申请的使用一键部署脚本时会让你选择安装的目录我安装在目录下所以的目录你可以查看文件了解其他挂在的目录的位置我先添加一个测试站点对应的配置文件为可以看到用到的公钥证书和私钥分别是如果已经有多个证书后缀可能会是其他的数字他们对应的挂载目录为所以我们的目标就是自动换中的证书我们使用脚本来实现这一自动化过程在上配置推送证书到本地目录如果原来没有配置证书推送需要重新申请一次然后指定目录下会出现证书文件和密钥文件因为包含多个证书文件而默认只处理单个证书所以我们可以直接拷贝的内容接下来就是脚本部分脚本名称为查看脚本内容看到这里先别急着使用这个脚本接着往下看还有更好的方式这里只是记录一下折腾过程使用说明检查是否传入参数定义变量日志函数检查文件是否存在证书文件或密钥文件不存在请确保和存在复制证书和密钥正在复制证书和密钥到无法复制证书文件到无法复制密钥文件到证书和密钥文件已成功复制到修复文件权限正在修复文件权限无法修复文件权限文件权限修复完成重启容器正在重启容器无法重启容器容器已成功重启证书同步和更新完成我的部署在上且有台服务器分别对应电信和联通网络所以我将公共参数提出来使用脚本传参的方式处理和需要在中配置如果你看过别名配置应该不难还需要配置免密登录免密登录上的和名称需要根据你自己的情况修改如果你使用雷池一键安装脚本容器的名称应该是如果不是可自行修改值得注意的是在我的上以运行所以应该在目录下设置设置脚本最后在中重新申请证书即可结果大意了没有闪这种方式虽然能够成功替换挂载目录下的证书文件但是它把证书数据存在数据库里面的心中一万只草泥马飘过我是怎么发现的呢我拿八倍望远镜发现的重新申请证书后到中的证书管理页面查看发现证书时间没有更新且编辑证书后不是新的证书在目录下有个文件查看脚本内容是否重新生成的所有配置我重新执行了里面的结果将挂载目录下的证书给还原回去了翻遍了所有的挂载目录都没有发现备份的证书文件这才发现不简单所以看了文件其中就出现了数据库那么是不是证书数据被存储到数据了带着这个疑问我们将的端口暴露出来连上去看看的密码在同级目录下的中如图所示证书数据被保存在了中看来只能通过来操作了不过并没有提供文档也没有提供生成的操作控制台看了一下基于的认证简单的写了脚本模拟登录获取然后调用更新证书传统的方案是一种热门且高度安全的协议许多提供商都使用这种协议它运行在或互联网安全协议上能确保数据以正确的顺序完整传输而则专注于更快的速度优点开放源码这表示代码是公开的任何人都可以检查代码中是否存在可能危及安全的隐藏后门或漏洞多功能性这种协议能与一系列不同的加密和流量协议一起使用可以针对不同的用途进行配置也可以根据需要进行安全或轻量的配置安全性能搭配各种加密协议因此非常安全绕过多数防火墙就能够轻松绕过防火墙缺点设置复杂多功能性意味着如果多数用户试图建立自己的他们可能会因为复杂性而难以设置将用没必要上重量级的相对来说的专注主要功能即可和是两种网络协议经常组合使用以提供安全的虚拟专用网络连接用于建立隧道将数据封装在隧道中传输用于加密和验证数据包确保数据的安全性和完整性这种组合方式被称为是一种常见的协议用于在公共网络例如互联网上传输敏感数据需要占用个端口使用和穿越进行密钥交换协议使用端口进行通信优点安全性根本不提供任何安全性但却相当安全这是因为它能搭配各种加密协议使协议按需要变得更安全或轻量广泛可用在几乎适用于所有操作系统这代表管理员能轻易找到支持并使其运行缺点可能已被美国国家安全局破解与一样通常与搭配使用因此它也存在前面提到的漏洞速度慢该协议封装数据两次这种方法对某些应用程序很有用但与只封装数据一次的其他协议相比速度较慢无法绕过防火墙与其他协议不同没有其他方法来穿过防火墙面向监视的系统管理员使用防火墙来封锁而自行设置的人很容易被封锁是一种提供安全密钥交换会话的隧道协议该协议是微软和思科合作的成果与类似它通常与配对使用以提供身份验证和加密功能它由定义是协议的改进版本的主要功能是协商和管理加密密钥确保通信双方能够以安全和高效的方式加密数据配置相对复杂特别是在手动部署服务器时且需要占用个端口的默认端口用于初始连接和协商当穿越被检测到时切换到此端口优点稳定性使用一种名为的技术当流量在互联网传输时该技术可确保建立连接不中断使得成为移动设备最可靠和稳定的协议安全性作为套件的一部分可与大多数加密算法配合使用使其成为最安全的协议速度运行时占用很少的宽带而且它的穿透技术使其连接和通信更快速也有助于通过防火墙缺点兼容性有限与许多系统不兼容这对用户来说不是问题因为微软参与制定此协议但其他操作系统则可能需要第三方软件才能支持因从切换到移动数据时不会遗失连接常用在移动设备端是什么是整个行业都在谈论的最新最快速的通道协议这种协议使用最先进的加密技术使当前的领导者和黯然失色是由等人用语言编写的一个开源协议被视为下一代协议旨在解决许多困扰或等其他协议的问题声称其性能比大多数协议更好但这个事情有很多争议与在用户空间中运行的不同的优势在于直接集成到内核开始中这种集成使其能够更高效地处理数据包同时最大限度地减少用户空间和内核空间之间的上下文切换仅使用并且通常在单个端口上运行从而简化了其设置和操作这与形成对比后者可以使用或并且可能需要根据配置管理多个端口使用单一协议和端口降低了网络配置和防火墙规则的复杂性从而提高了整体性能然而精简就意味着功能缺失的局限性只能说目前方式对我来说完全够用优点免费和开源任何人都能查看代码这使得部署稽核和调试更加容易精简且速度极快仅由行代码组成是所有协议中最精简的协议相较之下代码行数是它的倍缺点不完整有望成为下一个大事件但其实施仍处于早期阶段还有很大的改进空间目前它无法为用户提供任何级别的匿名性尽管完全匿名是不可能的因此提供商需要找到定制的解决方案在不损失速度的情况下提供必要的安全性使用时机每当需要速度优先时都可以使用流媒体在线游戏或下载大型文件相关链接关于性能比较的更多信息可以参考下面几篇文档官方的基准测试两台具有以太网的服务器之间的基准测试关于加密的更多资料请参考下方链接下一代内核网络隧道协议的密码学分析的安全性分析技术分享评测新型具有显著优势下面是一些有助于密钥分发和部署的服务点对点连接的工具一组脚本简化和的设置用编写的自动安装程序配置生成器端配置生成器使用场景利用可以组建非常复杂的网络拓扑根据网络环境的不同通常有多种配置方式端到端直接连接这是最简单的拓扑所有的节点要么在同一个局域网要么直接通过公网访问这样可以直接连接到对端不需要中继跳转局域网到外网比如在家访问公司局域网或者在公司访问家庭局域网最简单的方案是通过公网暴露的一端作为服务端另一端指定服务端的公网地址和端口然后通过选项维持长连接让记得对应的映射关系两端都位于之后使用中继服务器大多数情况下当通信双方都在后面的时候会做源端口随机化处理直接连接可能比较困难可以加一个中继服务器通信双方都将中继服务器作为对端然后维持长连接流量就会通过中继服务器进行转发打洞上面也提到了当通信双方都在后面的时候直接连接不太现实因为大多数路由器对源端口的随机化相当严格不可能提前为双方协调一个固定开放的端口必须使用一个信令服务器自建它会在中间沟通分配给对方哪些随机源端口通信双方都会和公共信令服务器进行初始连接然后它记录下随机的源端口并将其返回给客户端这就是现代网络中的工作原理有时候即使有了信令服务器和两端已知的源端口也无法直接连接因为路由器严格规定只接受来自原始目的地址信令服务器的流量会要求新开一个随机源端口来接受来自其他的流量比如其他客户端试图使用原来的通信源端口运营商级别的就是这么干的比如蜂窝网络和一些企业网络它们专门用这种方法来防止打洞连接配置实例点对点常见的应用场景将一台计算机连接到远程网络并使其能够像在本地网络中一样访问所有资源例如连接到公司的内部网络远程提交代码访问公司内部的等远程连到家庭网络看个小电影听听的无损音乐什么的远程端点中的位置非常灵活它可以位于防火墙路由器或其他任何网络设备上这意味着我们可以根据实际需求选择最合适的部署位置简单说明一下在里客户端和服务端基本是平等的差别只是谁主动连接谁而已双方都会监听一个端口谁主动连接谁就是客户端主动连接的客户端需要指定对端的公网地址和端口被动连接的服务端不需要指定其他对等节点的地址和端口值得强调的是安装的的服务器既可以作为服务端也可以作为客户端后面我会直接是用服务端和客户端来简单区分不同的对端所以需要提前说明一下这个概念网络拓扑图公网路由器这幅图展示了典型的家庭小型公司网络拓扑结构通常会有一个由提供的光猫下面通过路由器拨号上网以及一些内部设备如和其他设备安装方法可以选择以下两种方法之一来部署在路由器上部署如果使用作为主路由系统的话这是最常见且简单的的方法在局域网中的另一个系统上部署比如在公司可能没有权限对路由器做任何配置但是申请开放一个端口映射还是可以的或者路由器无法安装的时只能使用这种方式比如我在公司部署了一台小型服务器在家庭网络也采用这种方式因为考虑到稳定性使用和作为主路由且没有开启权限只作为普通路由器使用服务端和客户端请注意在这种场景中部署的我称为服务端意思是不会有配置配置应该在需要访问家庭公司网络的外部设备上主动连接家庭公司网络中的服务我称为客户端我没有系统的主路由器所以需要在主路由上配置端口转发规则将指定流量转发到部署了的内部服务器上如果你的主路由器是系统可以自行查阅配置方式方式都大同小异下面我将在和系统作为二级路由器上部署服务这些系统覆盖了大多数常见的系统类型以此来说明在各个系统上如何部署配置与使用值得推荐的管理工具简单易用的服务端比前者稍微复杂一点不过功能更多部署了所以这里直接是用它来部署网络拓扑图只接入联通网络将作为的网络和现在的联通网络分开添加一个网卡并使用不需要自己去手动添加网卡部署启动成功后会自行添加外网的使用作为它的网络联通网络的段为我们的目的是让在外网的能通过接入到上部署的网络并且能访问家中联通网络下的任意设备接下来就是无聊的安装部署与配置环节总体流程安装生成公钥和私钥添加配置配置防火墙和转发添加节点客户端使用可从默认的软件源中获得这将安装模块和工具作为内核模块运行下面的操作都是用户为生成密钥生成私钥通过私钥生成公钥为生成密钥创建配置文件是数字不是字母我怕你字体有问题所以提醒一下的私钥的公钥这里不要搞混了填写的是当前主机的私钥对等点填写的是其他设备的公钥配置防火墙和转发防火墙我直接关闭如果不关闭就要放行端口配置转发用于允许内核在网络接口间转发流量如果需要在环境下启用还需要添加下面的配置使用使上述配置生效最后启动停止命令为启动成功后在上使用可以找到一个的虚拟网卡大概是这样的的配置下的在非国区免费下载的私钥的公钥的公网域名比如上创建的网卡信息然后我们可以是用来验证是否成功也能成功访问上的服务在上使用查看信息上述配置将局域网内的和外网的成功的加入到这个局域网内但是目前也只能在这个子网内通信如果我想让访问所在的这个局域网则需要如下配置的私钥的公钥的公网域名比如表示来自的流量全部通过的网卡上的网卡发往我们来详细了解一下整个链路是怎样的请求访问小米路由器的流量从的网卡发往解释如下目标网络网段这里是通常表示子网表示无需通过网关直接通过指定接口访问路由可达直接连接的网络静态路由是虚拟网络接口常见于或隧道连接单个主机地址表示通过物理或虚拟接口访问路由可达主机路由通常与相关表示接口状态可能是临时或动态的接口使用接口表示该路由将在秒后过期通常是动态路由数据包进入主机后内核会检查如果数据包的目标端口是配置的监听端口系统会将流量交给接口进行解密否则就会被丢弃解密后的流量会被系统路由表或表处理决定最终的流量去向而的路由表情况为内核路由表目标网关子网掩码标志跃点引用使用接口上面表示的流量会通过的网卡处理在上使用查看一下请求路径第一跳是隧道对端的虚拟通常是服务器的接口地址这说明流量通过接口成功进入隧道第二跳是目标地址表明隧道对端服务器接收了流量并通过服务器上的路由规则转发到了子网而的路由规则为如果数据包的目标地址属于子网并且没有其他更优的路由规则系统将通过接口发送这些数据包值得说明的是这个配置是转发流量的关键因为我的分别连接了电信和联通网络我的目的是通过的访问个网络下的所有设备和服务网络拓扑图接入电信和联通网络具备双网卡分别是电信和联通的保持不变为了满足上述需求我们需要修改的客户端配置的私钥的公钥的公网域名比如配置完成后即可访问家中个内网中所有的设备网卡优先级的问题上面的网络拓扑图我隐藏了一个细节只有在流量通过联通公网进入时才能访问家中的设备如果是从电信公网走你会发现通道都建立不上这里的意思是指的配置中的联通配置的是电信配置的是原因是多网卡优先级导致的流量进入网卡后的具体流程电信网络握手请求数据包从电信公网进入路由器根据路由器上设置的端口映射将流量转发至数据包进入的电信网卡服务接收数据包接收请求准备生成握手响应包数据包从默认路由返回因为联通网卡的优先级高握手响应包走联通网卡发出响应包的源为联通公网而客户端期待的是电信公网客户端丢弃响应包客户端验证响应包的源发现与握手请求的目标不一致认为这是无效包的握手过程依赖数据包并且会严格检查响应包的以下属性源必须与目标匹配客户端发送握手请求时记录目标比如电信公网如果服务端返回的包源是联通公网客户端无法将其与最初的请求匹配四元组验证客户端会验证返回包的四元组源目标源端口目标端口如果源不对整个握手流程就失败网卡优先级联通电信当服务端收到客户端的握手包时解密后需要发送回客户端因为优先级高于所以会使用网卡回复响应数据包经过联通路由器时将源地址修改为联通公网导致客户端无法验证响应包的源最终握手失败添加自启动配置名你可以在同一台服务器上部署多个服务所以可以配置多个自启动比如现在的配置是那么配置名就是在清楚的基础配置与使用流程后环境下推荐直接使用一键部署脚本来简化操作另一个一键部署脚本需要安装包才能正常使用这里是各个版本的包下载地址如果你不放心也可以按照教程自行编译我使用第三方套件仓库安装的方式部署在套件中心新增套件来源矿神同时推荐添加上这个有较多的第三方使用登录然后按照要求执行一下修改完可以确定一下如果有问题还可以用去编辑为了能通过访问电信和联通的内网还需要转发配置转发用于允许内核在网络接口间转发流量后续的配置与在上一致最后使用配置名启动即可不需要显式设置自启动系统会自己启动同样支持可视化来配置且支持客户端模式推荐你直接刷自带的固件如果没有你也可以按照下图所示去安装必要的软件包可能需要替换软件源或直接通过安装在网络接口选项卡下新增一个接口在某些系统中只能添加一个接口比如的推荐你早点换掉不然后面无法玩儿更多的功能只需要填写私钥监听端口和地址即可只需要填写公钥允许的勾选路由允许的即可其他个可以在客户端配置上修改最后是配置防火墙允许进出即可因为我把划分到区域了所以这里是配置完成后最好重启一下接口最后配置客户端即可可到状态改口像和这类系统网口分别是一个口一个口有个口个千兆口但是我需要使用到个的网口作为口连接电信和联通网络为了满足通过一台设备即可同时访问家中的个内网需要将口改成口我以为例记录一下修改方式等把重新刷机再写部署最简单的方式是使用它支持在任何具有内核的主机上使用一键部署并自带不过目前还只能作为服务端使用幸运的是版本将开始支持客户端模式这里只是简要说明一下的部署方式不会详细展开客户端的使用方式所以需要你具备一点使用基础你的公网固定或的域名次后的密码管理端口默认为的端口默认为更多的配置说明请查看官方文档需要说明的有点密码生成方式生成出的密码记得将每个符号替换为两个符号和因为我有张网卡所以这里配置了个添加一个客户端并下载配置或直接使用二维码导入到的客户端最后一步就是在路由器上配置端口转发将的流量路由到所在的服务器因为目前的局限性更推荐使用手动配置的方式部署这种方式更加灵活能够支持更复杂的网络拓扑架构中继如果客户端和服务端都位于后面需要加一个中继服务器客户端和服务端都指定中继服务器作为对等节点它们的通信流量会先进入中继服务器然后再转发到对端接下来将要实现以阿里云作为中继服务器并将流量转发到电信和联通内网下面是一些基础情况的虚拟我们设置为局域网为张网卡分别接入了电信和联通网络外部设备能够在外部访问和电信联通内网中的所有设备和服务中继服务器配置如下中继服务器私钥端口号公钥公钥配置如下前面已经有一个作为服务端的配置下面是新增的作为客户端的配置私钥中继服务器公钥公网端口号启动的配置如下私钥中继服务器公钥公网端口号上述配置能让在外网的通过中继服务器将和的流量转发到而正好在内网可以通过本机网卡流量转发来访问个网段这里就实现了上述需求在本地执行来看看跃点路径第一跳来到了中继服务器第二跳为第三跳则是的联通网关接下来是整个流程的分析我们知道在启动完成后中的每个段都会被解析为一个路由下面是中继服务器的路由表从上面我们可以看出我们配置的的流量都会通过网卡发出而的路由表如下所示同样是创建了多条目标路由且由网卡处理流量而只有一条内核路由表目标网关子网掩码标志跃点引用使用接口所以整个流程如下发出流量需要访问网络流量的源地址为目标地址为根据的配置属于列表该流量会被路由到的隧道发送到中继服务器源地址目标地址出口设备中继服务器处理流量根据中继服务器的配置包括因此流量被转发到与的隧道中继服务器上的规则被触发将源地址改为中继服务器的地址源地址经过转换目标地址出口设备到接收流量收到从中继服务器来的流量源地址为目标地址为根据的配置包含因此流量被路由到本地网络流量离开进入其局域网接口并最终到达目标设备源地址目标地址出口设备目标设备的响应目标设备处理请求后发送响应回到源地址响应流量返回到的局域网接口源地址目标地址出口设备返回中继服务器根据隧道规则流量被发送回中继服务器源地址目标地址出口设备中继服务器返回根据中继服务器的规则恢复原始源地址将目标地址改为响应流量被转发回源地址目标地址出口设备到接收响应收到从返回的响应流量完成通信对于这种中继转发方式部署的服务其中是关键用于配置流量转发和添加一条规则允许从接口会被自动替换为实际接口名如进入的流量被转发目的确保来自客户端的流量能够通过服务器转发添加一条规则允许从其他网络流出的流量被转发到接口目的允许外部网络的数据包返回到客户端在表的链中添加一条规则对通过接口的流量进行地址伪装目的将客户端的私有如伪装成服务器的公网便于访问互联网或外部网络打洞上面的中继服务器是通过转发流量的方式达到异地访问的目的比如可以将公司和家庭网络打通组成一个大的局域网达到异地互访的效果但是打洞则不同这里的中继服务器有点像中的起到一个注册中心的作用不转发流量当隧道打通后两端是通过直连访问的看过之后肯定清楚打洞的原理只要隧道被打通后在记录失效之前约秒更新的配置并建立连接就可以直接通信实现细节可以参考这篇博客很有启发意义客户端各大应用商店直接搜即可免费好用但是会存在一个问题只能同时开启一个客户端配置对我我这种有多个服务端且需要做复杂均衡的需求就满足不了所以官方的客户端就没在使用了接下来我将在上配置多个服务端且根据网络情况自动选择最优的服务端上配置配置非常简单节点名客户端私钥客户端不用加子网掩码比如自定义服务端公钥服务端公网端口预共享密钥没有就不加我这里配置是所有流量后续会通过来分流特定流量然后在节点下使用此节点节点名可以是你内网的比如最后配置相应的规则所有来自的请求全部使用处理上述是一个最基础的配置其他更多的配置和注意事项可查看官方教程我的配置稍微复杂一点需求大致如下在公司异地能访问家里的电信和联通内网在公司访问公司内网走直连不走在家能访问公司内网在家访问电信和联通内网走直连不走如果只连接了电信或联通其中某一个内网也能通过访问另一个内网为了满足上述需求我们需要结合的和相关的特性下面是具体配置配置节点多节点配置客户端私钥客户端不用加子网掩码比如自定义服务端公钥服务端公网端口预共享密钥没有就不加客户端私钥客户端不用加子网掩码比如自定义服务端公钥服务端公网端口预共享密钥没有就不加客户端私钥客户端不用加子网掩码比如自定义服务端公钥服务端公网端口预共享密钥没有就不加客户端私钥客户端不用加子网掩码比如自定义服务端公钥服务端公网端口预共享密钥没有就不加客户端私钥客户端不用加子网掩码比如自定义服务端公钥服务端公网端口预共享密钥没有就不加客户端私钥客户端不用加子网掩码比如自定义服务端公钥服务端公网端口预共享密钥没有就不加客户端私钥客户端不用加子网掩码比如自定义服务端公钥服务端公网端口预共享密钥没有就不加客户端私钥客户端不用加子网掩码比如自定义服务端公钥服务端公网端口预共享密钥没有就不加客户端私钥客户端不用加子网掩码比如自定义服务端公钥服务端公网端口预共享密钥没有就不加配置节点阿里云和交错用于验证双网卡是否正常联通电信联通电信联通电信联通全球直连拒接连接表示通过隧道能访问的地址这里直接访问路由器的来测试如果愿意折腾的话也可以在自建检测服务和都是直连且测试地址是路由器网关同理的测试地址是公司内网的网关配置节点阿里云开启对于家庭网络直接是用来处理表示优先是用和因为前者是直连模式连接测试通过则表示连接了家庭网络则直接使用直连模式如果没有连接家庭内网测试会失败则回退到第二个规则组而组是由多个节点组成会选择延迟最低的一个连接到家庭网络公司网络则使用处理表示如果当前网络的网关是公司主路由器则使用组中延迟最低的节点现在只有个后面还可以扩展配置节点这就简单了根据或域名分流其中和是我自定义的内网域名分别对应电信和联通网络上述配置后个内网分别由多台服务器提供节点因为网卡优先级的原因分别划分到电信和联通宽带入口因为每台服务器至少存在个网口且分别连接电信和联通内网所以我只要任意连接一台服务器就能访问家中个网络多台设备起到负载均衡的作用且不会因为单点故障访问不了家庭网络停电不算关于更多的配置后续应该还会有文档输出配置详解详细配置服务端可选是否将持久化到配置文件中默认为必须当前节点在虚拟局域网的必须服务端监听的端口必须服务端密钥可选客户端将会使用这里指定的服务器来处理子网中的请求但也可以在客户端中覆盖此选项可选定义子网使用的路由表默认不需要设置默认值这里的是指可以使用来手动添加可选默认不需要设置一般由系统自动确定可选启动接口之前运行的命令这个选项可以指定多次按顺序执行可选启动接口之后运行的命令这个选项可以指定多次按顺序执行可选停止接口之前运行的命令这个选项可以指定多次按顺序执行可选停止接口之后运行的命令这个选项可以指定多次按顺序执行定义能够为一个或多个地址路由流量的对等节点的设置必须允许该对等节点发送过来的流量中的源地址范围分别在流量出站和入站时匹配并进行响应的处理必须客户端公钥可选根据场景配置可选预共享密钥使用此选项为添加另一层加密保护使用生成预共享密钥客户端的节点需要配置相同的密钥客户端必须必须可选覆盖服务端配置可选配置后将使用固定端口不在随机其他的可选字段参考服务端配置必须必须必须可选根据场景配置我看网上其他博客说如果是中继服务器就需要将服务端的配置成子网但是我测试过子网也不会出现问题那么究竟定义的是什么带着这个疑问我们来看看不同配置下路由的具体情况时启动后自动执行的操作如下创建名为的接口从配置文件加载的信息和密钥配置给接口分配的地址计算适当的如果需要可以在配置中覆盖推荐配置静态路由使和的流量通过接口添加的路由为意思是任何指向或的流量将直接通过接口发送无需经过网关时添加的路由为这条路由表示所有指向网络的流量将通过接口直接发送且数据包的源地址为和配置子网的唯一区别就是使用代替了单独配置的和然后我们看一下如何路由子网输出如下子网输出如下不管如何配置都是使用路由表不同的是多了一条广播配置意思是当要向广播地址发送数据包时流量会直接通过接口广播到同一子网内的其他设备所以我只是想确认一个问题和子网分别在什么场景下使用场景推荐子网理由点对点中继精确控制目标路由减少广播提升安全性多点或子网中继适合多个设备在同一子网通信简化路由管理需要节省路由表资源只处理特定避免大范围广播需要全网自动发现和广播通信允许所有同一子网的设备自动互联综上所述服务端的配置只是代表当前节点在局域网中的设备如果非要说影响我觉得只能是创建的路由数量不同导致的占用系统资源不同罢了所以个人建议如果只是少量设备直接配置成子网即可至于什么才是少量设备就需要自己去定夺了反正我节点全部配置成了子网的作用简单来说当发送数据包时列表表现为一种路由表而当接收数据包时允许的列表表现为一种访问控制列表前面我们已经知道启动后会将列表添加到路由表发送数据时根据这个路由表选择合适的节点加密数据并发送接受到数据时先解密成功后还需要对比指定节点的列表与数据表的源地址是否匹配为了更好地理解如何处理数据包的传输和安全性我们将详细介绍其加解密过程这将帮助我们深入理解参数的重要性发送数据加密过程生成会话密钥每个对等方客户端和服务端在建立连接时会使用算法生成共享密钥密钥交换这个密钥交换基于双方的公钥和私钥来生成会话密钥该密钥是对称的意味着双方都能用它加密和解密数据假设客户端的私钥为公钥为服务端的私钥为公钥为双方会通过交换公钥并用对方的公钥与自己私钥生成一个共享的会话密钥加密数据数据包会使用算法进行加密使用共享的会话密钥来加密发送的数据用于数据包的认证确保数据在传输过程中未被篡改它会生成一个消息验证码并附加到加密数据上加密的过程使用的是流加密的方式通过会话密钥生成的伪随机流来加密数据封装数据包加密后的数据会被封装成数据包其中包括目标地址加密后的有效负载消息认证码发送者的身份标识发送数据包数据包会通过发送到目标的远程端点例如地址和端口接收数据解密过程接收数据包接收方通过收到一个数据包这个数据包可能是加密的验证消息认证码解密前接收方会先使用算法检查数据的完整性确保数据包在传输过程中未被篡改如果验证失败数据包会被丢弃解密数据如果消息验证通过接收方使用算法与共享密钥解密数据共享密钥是通过双方的公钥和私钥生成的会话密钥来解密数据解密后恢复出原始的明文数据检查数据包的来源解密后接收方还需要检查数据包的来源如果数据包是来自一个未被授权的源或者不符合接收方的安全策略数据包将被丢弃客户端在发送数据时会通过选择节点源地址和匹配然后使用确定的会话密钥服务端的公钥和的私钥通过生成对数据进行加密当数据到达服务端时会用所有已知客户端的会话密钥逐一尝解密并试验证消息完整性一旦匹配到有效的会话密钥即可确认数据包是由对应的客户端发送解密后的数据包中有源地址中这时服务端的就会将源地址和客户端的进行匹配如果相同或在允许的子网内则接受数据包当服务端处理完后需要向客户端发送响应数据时服务端会查看响应数据的目标并将其与每个客户端的列表进行比较以确定将其发送到哪个客户端以上就是的加解密过程从中我们可以明确的作用那么问题来了不同的可以有相同的吗即和的都为或者都为如果一个的包含了另外一个的那么会落到哪个上即的为的为目的为的包会发送给还是呢为了解释上面的问题我们来看一下的具体实现使用前缀树来维护下面是实现逻辑用来存储找到的最近匹配的地址的长度通常是或如果目标与当前节点的前缀匹配长度大于等于当前节点的继续往下走如果当前节点关联了一个更新表示找到了一个更匹配的如果已检查完目标的所有字节结束查找根据当前地址的某一位决定往左子树还是右子树继续查找跳到子树节点整体流程逐层比较前缀从根节点开始逐层比较地址的前缀部分确认是否匹配当前节点更新匹配的如果当前节点匹配目标且关联将记录下来选择子树继续匹配根据地址的位信息选择左子树或右子树返回最终匹配返回最长前缀匹配的如果的为的为的为目的为它的前缀树看起来是这样子的所以对于上面个问题的答案是不能最后添加的会覆盖前面的第一次匹配到找到然后再次匹配到所以最后应该使用节点持久化在服务端有这么一个配置可选是否将持久化到配置文件中默认为如果设置为则会在必要时将最新的的公网和端口写入到配置文件中正常断开连接时当接口被关闭例如使用命令时会自动将当前连接的状态包括对等端的信息写入到配置文件中系统重启或服务重启时如果系统重启或服务重启会在重启前保存当前连接的状态包括信息动态更改时如果通过接收到的数据包自动更新了对等端的例如通过穿越时发生远程端点或端口的变化并且此时连接被手动断开或接口被重启最新的端点信息将被写入配置文件我们一般不会直接去配置服务端配置节点中的而客户端必须配置这样才能知道数据包应该发送到哪里而需要知道回复的数据包应该发送给谁所以需要将接受到的数据包中的源地址和端口记下来而如果客户端的出口公网端端口变化了则服务端就会动态去更新指定节点的问题只会在启动时解析域名如果你使用来动态更新域名解析那么每当发生变化时就需要重新启动粗暴点的解决方案是使用钩子每隔几分钟或几小时重新启动来强制解析域名上内核实现的内核只接受或的地址所以域名是在用户态由配置工具在配置时刻解析的那么的话解析记录更新内核也无法感知还需要用户态的监测并更新配置幸运的是提供了一个示例脚本它可以解析配置文件并自动重置端点地址需要定期运行以从已更改其的端点中恢复一种方法是通过计时器每三十秒更新一次所有端点脚本启用错误捕获一旦出错脚本将立即退出启用无大小写匹配和扩展模式设置语言环境为确保脚本在不同语言环境下行为一致获取第一个参数作为配置文件名如果参数是合法的文件名则使用路径下的配置文件使用正则提取接口名称从文件名中提取处理每个的函数只有当处于段且和不为空时才处理检查最新握手时间是否超过秒更新的公钥最新重置段信息初始化段逐行读取配置文件去除注释部分提取键和值并去除首尾空格如果是新的段落处理当前并重置段落状态如果进入段设置标志如果处于段提取和信息处理最后一个这个脚本用于自动更新中继服务器配置文件中的的当最新握手时间超过秒时通过更新的信息主要步骤读取配置文件路径并根据输入参数确定具体路径和接口名称使用函数检查每个根据握手时间判断是否需要更新通过正则匹配提取和然后动态调整配置下面是使用官方脚本的方式如果是系统安装的且作为客户端使用的话可以直接使用自带的看门狗脚本定时任务添加以下即可和启动接口之后运行的命令这个选项可以指定多次按顺序执行例如从文件或某个命令的输出中读取配置值添加一行日志到文件中调用添加路由添加规则启用数据包转发强制重新解析对端域名的地址停止接口之后运行的命令这个选项可以指定多次按顺序执行删除规则关闭数据包转发如果连接是从一个位于后面的对等节点到一个公网可达的对等节点那么后面的对等节点必须定期发送一个出站包来检查连通性如果有变化就会自动更新例如本地节点与对等节点可直连该字段不需要指定因为不需要连接检查对等节点位于后面该字段不需要指定因为维持连接是客户端连接的发起方的责任本地节点位于后面对等节点公网可达需要指定该字段表示每隔秒发送一次来检查连接共享配置如果某个的公钥与本地接口的私钥能够配对那么会忽略该利用这个特性我们可以在所有节点上共用同一个列表每个节点只需要单独定义一个就行了即使列表中有本节点也会被忽略具体方式如下每个对等节点都有一个单独的文件只包含部分的配置每个对等节点共用同一个文件其中包含了所有的文件中需要配置一个钩子内容为路由全部流量如果你想通过转发所有的流量包括子网和公网流量需要在客户端的的中添加即便只转发流量也要指定一个网段以避免将数据包泄露到之外详情参考例如私钥公钥如果某一个的配置成则会把路由加入到路由表中所有经过网卡的流量包都打上标志加一条策略路由规定不带标志的数据包才去查询路由表因为是默认路由而表中肯定已经存在默认路由了所以必须插入到一个新的路由表中比如从浏览器发起一个远端访问流程为发出的数据包到达对应的该数据包经过内核协议栈时会首先做本次会命中路由表所以包会被发送到网卡该数据包通过字符驱动直接发送到了应用层应用会将该普通数据包封装成数据包并打上发出的数据包到达对应的该数据包经过内核协议栈时会首先做由于该包带了所以不会命中路由表而是命中默认路由策略被发送到了网卡网卡将该数据包发送出去可以看出来如果不为数据包打上不添加策略路由而是将路由添加到表则步骤中的会再次把包送回到网卡形成路由环路如果配置启动完成后配置文件会变更为私钥公钥会多出一个配置项因为还没有客户端连接下还不会持久化前面的例子主要使用也支持例如常用命令汇总生成密钥生成私钥生成公钥启动与停止获取在配置目录下启动停止网络接口注册注销网络接口注册注销本地地址添加删除路由查看信息接口查看系统接口信息查看接口详细信息地址查看接口地址路由查看系统路由表获取到特定的路由参考上的网络分析一到底好在哪它的中文翻译基础教程路由策略解读米开朗基扬回家方案总结前面用大量篇幅介绍了我的的网络架构重点关注稳定性与可用性目的是保证随时随地都能异地访问家庭网络总结起来就是下面几点多宽带避免运营商故障灾备冗余多设备避免单点故障负载均衡如果没有公网我们还有很多方式实现异地访问公网被回收则启用公网中继内网穿透这里还有另一种方式有机会可以尝试一下分流分流分流有种方案终端设备安装分流服务只服务于当前设备优点自主可控每个设备独立运行分流服务配置灵活且不影响其他设备无需更改网络基础设施对路由器等网络设备无依赖避免复杂的网络配置稳定性高分流仅限于当前设备不会因其他设备或集中服务的故障而受影响缺点维护成本高需要在每台设备上手动安装配置和维护分流服务尤其当设备数量较多时工作量增加统一管理困难分流规则无法集中管理设备间的配置可能不一致已通过规则服务实现分流规则集中化管理性能受限于终端设备某些设备性能不足时分流可能会降低网络效率部署集中式的分流服务服务于整个网络优点集中管理所有设备共享一套分流规则配置统一且维护方便设备接入简单终端设备无需额外配置只需设置网关或高效的网络流量分配可充分利用高性能设备如专用服务器处理复杂的分流任务便于扩展新增设备时无需重复配置分流服务缺点单点故障风险集中服务出现故障会导致所有设备分流失效网络依赖性高对路由器或网关的网络配置依赖较大复杂网络环境中可能难以部署对硬件性能要求高需要高性能设备支撑处理所有设备的分流流量基于集中式的分流方案方式一部署在上配置也非常简单类似的还有的旁路由设置不同的是也需要填写的地址开启的增强模式在其他设备上设置配置名配置值网关的地址重点子网掩码保持不变虽然这种方式需要手动在每台终端上进行配置但分流这种操作本身比较特殊尽量在设备本地处理更为稳妥此外像这样的旁路由设备虽然也能提供类似功能独立配置每台需要分流的设备可以确保更高的自主性和稳定性最怕的就是因为规则的问题把流量用完的情况因此最好在需要分流的设备上手动开启分流服务方式二使用提供服务可以让接管路由器的和服务具体操作如下关闭路由器的功能在中启用功能在终端设备上手动设置网关和同上述配置未采用原因关闭路由器功能后不确定静态绑定记录是否会保留我可能会在将来切换回由路由器提供服务因此不希望因退出使用而引发额外配置问题主要设备上全部安装了非的系统则会是用的旁路由模式因此没必要采用这种集中式的方案经验总结此前曾将分流服务部署在过的路由器上接管全屋设备的上网需求以实现全屋设备无感知的分流但频繁的网络断线和部分网络不可用需要重启路由器违背了我追求稳定性的原则最终我将恢复为普通路由器仅用来提供静态绑定端口映射等常规功能目前对分流就一个原则手动开启分流功能每次手动开启虽然麻烦但是可以明确知道自己的操作会带来什么影响我觉得还是值得的对于设备开始还比较简单对于非设备则提供了脚本以简化操作需要时执行方法即可最终方案目前分流需求仅限于少数特定设备我的方案是这是结合设备独立分流和旁路由模式设备直接安装采用设备独立分流方案配置通过或同步非设备则使用旁路由模式或者设置确保分流服务的独立性和可控性总结我们已经基本介绍了家庭网络的配置包括网络架构安全性异地组网等方面每个章节都可以单独拿出来撰写一篇博客但由于保持连贯性我们选择将它们合并为一篇文章接下来我们将转向服务相关的内容作为软件开发者我深知工具对于工作效率的重要性因此在接下来的内容中我将重点关注各种工具类的自托管服务这些服务可能会包括代码管理持续集成和持续部署工具版本控制系统日志管理监控工具等虽然现在只是画出了一个大致的蓝图但我相信随着时间的推移我会不断探索和实践将这些服务逐步应用到我的个人云端实验室中我期待着与大家分享我在这个领域的经验挑战和解决方案感谢大家的关注和支持希望这些内容能够对您的自托管之旅有所帮助如果您有任何建议或问题欢迎在评论区留言让我们一起探讨和学习让我们继续前进共同打造属于我们的高效稳定且安全的个人云端实验室相关文章先导篇我的概要硬件篇介绍我所拥有的硬件设备网络篇包括网络环境异地组网与网络安全服务篇使用搭建的各类服务数据篇包括数据存储方案备份方案和数据恢复方案数据同步构建高效的数据同步网络数据备份打造坚实的数据安全防线网络续集升级网络再战年内网穿透详解揭秘网络连接背后的奥秘",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2025-04-03 20:08:00",postMainColor:""}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:(e,t,a)=>{var o;0!==a&&(o=Date.now(),localStorage.setItem(e,JSON.stringify({value:t,expiry:o+864e5*a})))},get:e=>{var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!(Date.now()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=(o,c={})=>new Promise((t,e)=>{let a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},Object.keys(c).forEach(e=>{a.setAttribute(e,c[e])}),document.head.appendChild(a)}),e.getCSS=(o,c=!1)=>new Promise((t,e)=>{let a=document.createElement("link");a.rel="stylesheet",a.href=o,c&&(a.id=c),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#18171d")},e.activateLightMode=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#f7f9fe")};var e=saveToLocal.get("theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches,a=window.matchMedia("(prefers-color-scheme: light)").matches,o=window.matchMedia("(prefers-color-scheme: no-preference)").matches,c=!t&&!a&&!o,t=(void 0===e?(a?activateLightMode():t?activateDarkMode():(o||c)&&((a=(new Date).getHours())<=8||22<=a?activateDarkMode:activateLightMode)(),window.matchMedia("(prefers-color-scheme: dark)").addListener(e=>{void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode:activateLightMode)()})):("light"===e?activateLightMode:activateDarkMode)(),saveToLocal.get("aside-status"));void 0!==t&&("hide"===t?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="https://s1.hdslb.com/bfs/static/jinkela/long/font/medium.css"><script src="https://cdn.dong4j.site/source/static/echarts.min.js"></script><link rel="stylesheet" href="https://cdn.dong4j.site/source/static/core.css"><link rel="stylesheet" href="https://cdn.dong4j.site/source/static/footer.css"><link rel="stylesheet" href="https://cdn.dong4j.site/source/static/index-imgloaded.css"><script src="https://cdn.dong4j.site/source/static/index-imgloaded.js"></script><script src="https://cdn.dong4j.site/source/static/detect-devtools.js"></script><script defer="" src="https://cdn.dong4j.site/source/static/umami.self.js" data-host-url="https://umami.dong4j.ink:1024" data-website-id="bd4721b7-a43f-4161-83ed-51c148a7ca9d"></script><script defer="" src="https://cdn.dong4j.site/source/static/counter.js" async="" id="online-counter" interval="60000" api="https://umami.dong4j.ink:1024/counter" room="000000001"></script><script src="https://cdn.dong4j.site/source/static/confetti.browser.min.js"></script><script src="https://cdn.dong4j.site/source/static/confetti.js"></script><meta name="generator" content="Hexo 7.2.0"><link rel="alternate" href="/atom.xml" title="司机带你开车" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="司机带你开车" type="application/rss+xml"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box"><div class="carplay"></div></div><script>let preloader={endLoading:()=>{document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",()=>{preloader.endLoading()}),setTimeout(function(){preloader.endLoading()},2e3),document.getElementById("loading-box").addEventListener("click",()=>{preloader.endLoading()}),document.addEventListener("pjax:send",()=>{preloader.initLoading()}),document.addEventListener("pjax:complete",()=>{preloader.endLoading()})</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"><script async="" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://home.dong4j.site" title="个人主页"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/homepage.webp" alt="个人主页"><span class="back-menu-item-text">个人主页</span></a><a class="back-menu-item" href="https://blog.dong4j.site" title="博客"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/blog.webp" alt="博客"><span class="back-menu-item-text">博客</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://resume.dong4j.site" title="简历"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/resume.webp" alt="简历"><span class="back-menu-item-text">简历</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://npx-card.dong4j.site" title="npx-card"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/npx-card.webp" alt="npx-card"><span class="back-menu-item-text">npx-card</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/watt-stack" title="Watt.Stack"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/watt.webp" alt="Watt.Stack"><span class="back-menu-item-text">Watt.Stack</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dong4j/markdown-image-kit" title="MIK"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/mik.webp" alt="MIK"><span class="back-menu-item-text">MIK</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dong4j/macOS-dev" title="macOS.dev"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/mac.webp" alt="macOS.dev"><span class="back-menu-item-text">macOS.dev</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://project.dong4j.site/" title="更多"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/project.webp" alt="更多"><span class="back-menu-item-text">更多</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">服务</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://uptime.dong4j.dev/status/services" title="服务状态"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/uptime-kuma.svg" alt="服务状态"><span class="back-menu-item-text">服务状态</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://nezha.dong4j.dev" title="服务面板"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/nezha.webp" alt="服务面板"><span class="back-menu-item-text">服务面板</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://nav.dong4j.dev" title="导航页"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/nav.webp" alt="导航页"><span class="back-menu-item-text">导航页</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://umami.dong4j.ink:1024/share/V7Rat8DdVw4npjl2/blog.dong4j.site" title="Umami"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/umami.webp" alt="Umami"><span class="back-menu-item-text">Umami</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://muselink.cc/dong4j 👈这是我的MuseLink数字名片！" title="数字名片"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/muse.lin.webp" alt="数字名片"><span class="back-menu-item-text">数字名片</span></a><a class="back-menu-item" href="/ai/deepseek-r1-webgpu/" title="DeepSeek"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/deepseek.webp" alt="DeepSeek"><span class="back-menu-item-text">DeepSeek</span></a><a class="back-menu-item" href="/ai/rmbg/playground/" title="RMBG"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/rmbg.webp" alt="RMBG"><span class="back-menu-item-text">RMBG</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://chat.dong4j.site/" title="Mini-Chat"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/emoji1.webp" alt="Mini-Chat"><span class="back-menu-item-text">Mini-Chat</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">司机带你开车</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)" rel="external nofollow noreferrer">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size:.9em"></i><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size:.9em"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/messages/"><i class="fa fa-comments faa-tada"></i><span> 最新评论</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="fa fa-line-chart faa-tada"></i><span> 统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size:.9em"></i><span> 我的装备</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size:.9em"></i><span> 小空调</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/memos/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size:.9em"></i><span> 备忘录</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/todolist/"><i class="fa-solid fa-map faa-tada"></i><span> 折腾清单</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/stars/"><i class="fa-brands fa-github faa-tada"></i><span> Star 清单</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.dong4j.dev"><span>小黑屋</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole()"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://cdn.dong4j.site/source/image/wechat-pay.webp" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://cdn.dong4j.site/source/image/wechat-pay.webp"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.dong4j.site/source/image/alipay.webp" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://cdn.dong4j.site/source/image/alipay.webp"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title">最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/checkedexception/" style="font-size:1.05rem;color:#148f76">CheckedException<sup>1</sup></a><a href="/tags/error/" style="font-size:1.05rem;color:#7caa4e">Error<sup>1</sup></a><a href="/tags/exception/" style="font-size:1.05rem;color:#6ca2ab">Exception<sup>1</sup></a><a href="/tags/java/" style="font-size:1.05rem;color:#72966d">Java<sup>48</sup></a><a href="/tags/javabean/" style="font-size:1.05rem;color:#860ac1">JavaBean<sup>1</sup></a><a href="/tags/math/" style="font-size:1.05rem;color:#a75222">Math<sup>1</sup></a><a href="/tags/random/" style="font-size:1.05rem;color:#967478">Random<sup>1</sup></a><a href="/tags/runtimeexception/" style="font-size:1.05rem;color:#94aec3">RuntimeException<sup>1</sup></a><a href="/tags/string/" style="font-size:1.05rem;color:#453533">String<sup>2</sup></a><a href="/tags/stringbuffer/" style="font-size:1.05rem;color:#3f431c">StringBuffer<sup>2</sup></a><a href="/tags/stringbuilder/" style="font-size:1.05rem;color:#a0673c">StringBuilder<sup>1</sup></a><a href="/tags/throwable/" style="font-size:1.05rem;color:#ad4b80">Throwable<sup>1</sup></a><a href="/tags/final/" style="font-size:1.05rem;color:#77b142">final<sup>2</sup></a><a href="/tags/finalize/" style="font-size:1.05rem;color:#9a5c58">finalize<sup>1</sup></a><a href="/tags/finally/" style="font-size:1.05rem;color:#4fad4c">finally<sup>2</sup></a><a href="/tags/getter/" style="font-size:1.05rem;color:#a5c25f">getter<sup>1</sup></a><a href="/tags/new%E5%85%B3%E9%94%AE%E5%AD%97/" style="font-size:1.05rem;color:#050f6f">new关键字<sup>1</sup></a><a href="/tags/setter/" style="font-size:1.05rem;color:#85a1b8">setter<sup>1</sup></a><a href="/tags/static/" style="font-size:1.05rem;color:#096286">static<sup>1</sup></a><a href="/tags/super/" style="font-size:1.05rem;color:#4f916e">super<sup>2</sup></a><a href="/tags/this/" style="font-size:1.05rem;color:#869dc2">this<sup>1</sup></a><a href="/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/" style="font-size:1.05rem;color:#4d7499">二进制<sup>1</sup></a><a href="/tags/%E5%8C%85%E8%A3%85%E7%B1%BB/" style="font-size:1.05rem;color:#410937">包装类<sup>1</sup></a><a href="/tags/%E5%B0%81%E8%A3%85/" style="font-size:1.05rem;color:#768122">封装<sup>3</sup></a><a href="/tags/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" style="font-size:1.05rem;color:#501f70">异常处理<sup>3</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" style="font-size:1.05rem;color:#690252">数据类型<sup>4</sup></a><a href="/tags/%E6%96%B9%E6%B3%95%E9%87%8D%E8%BD%BD/" style="font-size:1.05rem;color:#a38b10">方法重载<sup>1</sup></a><a href="/tags/%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95/" style="font-size:1.05rem;color:#95a701">构造方法<sup>1</sup></a><a href="/tags/%E6%BA%A2%E5%87%BA/" style="font-size:1.05rem;color:#bf8181">溢出<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size:1.05rem;color:#4ec37b">算法<sup>1</sup></a><a href="/tags/%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/" style="font-size:1.05rem;color:#34c54f">类型转换<sup>3</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/" style="font-size:1.05rem;color:#74835a">线程安全<sup>1</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E5%AE%9E%E8%B7%B5/" style="font-size:1.05rem;color:#702108">编程实践<sup>2</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A8%8B%E5%BA%8F/" style="font-size:1.05rem;color:#3d022e">计算机程序<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%AF%AD%E8%A8%80/" style="font-size:1.05rem;color:#4c85aa">计算机语言<sup>1</sup></a><a href="/tags/%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6/" style="font-size:1.05rem;color:#23b3be">访问控制<sup>1</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6/" style="font-size:1.05rem;color:#95198d">软件<sup>1</sup></a><a href="/tags/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/" style="font-size:1.05rem;color:#92b58f">错误处理<sup>2</sup></a><a href="/tags/%E9%9A%8F%E6%9C%BA%E6%95%B0/" style="font-size:1.05rem;color:#34929b">随机数<sup>1</sup></a><a href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" style="font-size:1.05rem;color:#53ab26">面向对象<sup>6</sup></a></div></div><hr></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多"> <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/02/"><span class="card-archive-list-date">二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/01/"><span class="card-archive-list-date">一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/12/"><span class="card-archive-list-date">十二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">十一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/11/"><span class="card-archive-list-date">十一月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/10/"><span class="card-archive-list-date">十月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/06/"><span class="card-archive-list-date">六月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2022/11/"><span class="card-archive-list-date">十一月 2022</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div><div class="console-btn-item" id="consoleKeyboard" onclick="anzhiyu.keyboardToggle()" title="快捷键开关"><a class="keyboard-switch"><i class="anzhiyufont anzhiyu-icon-keyboard"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);" rel="external nofollow noreferrer"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/homelab-%E4%B8%AD%E5%B9%B4%E7%94%B7%E4%BA%BA%E7%9A%84%E5%BF%AB%E4%B9%90%E6%BA%90%E6%B3%89/" itemprop="url">HomeLab:中年男人的快乐源泉</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/homelab/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>HomeLab</span></a><a class="article-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>网络架构</span></a><a class="article-meta__tags" href="/tags/%E5%AE%89%E5%85%A8%E6%80%A7/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>安全性</span></a><a class="article-meta__tags" href="/tags/%E5%BC%82%E5%9C%B0%E7%BB%84%E7%BD%91/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>异地组网</span></a><a class="article-meta__tags" href="/tags/%E8%87%AA%E6%89%98%E7%AE%A1/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>自托管</span></a></span></div></div><h1 class="post-title" itemprop="name headline">HomeLab 网络篇：互联世界-构建高效的自托管网络环境</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2020-04-11T16:00:00.000Z" title="发表于 2020-04-12 00:00:00">2020-04-12</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-04-03T12:08:00.694Z" title="更新于 2025-04-03 20:08:00">2025-04-03</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">40.1k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>142分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" data-flag-title="HomeLab 网络篇：互联世界-构建高效的自托管网络环境"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator"> </span><span class="post-meta-position" title="作者IP属地为成都"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>成都</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/e537d446.html#post-comment" tabindex="-1"><span id="twikoo-count"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://cdn.dong4j.site/source/image/20241229154732_xLHg6epx.webp"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div class="post-ai-description"><div class="ai-title"><i class="fa-regular fa-robot fa-fade"></i><div class="ai-title-text">摘要助手</div><div id="ai-Toggle">切换</div><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i><i class="anzhiyufont anzhiyu-icon-circle-dot" title="朗读摘要"></i><div id="ai-tag">SummaryGPT</div></div><div class="ai-explanation">AI 初始化中...</div><div class="ai-btn-box"><div class="ai-btn-item">介绍自己 🙈</div><div class="ai-btn-item">生成摘要 👋</div><div class="ai-btn-item">推荐文章 📖</div><div class="ai-btn-item">前往主页 🏠</div><div class="ai-btn-item">前往订阅 💥</div><div class="ai-btn-item" id="go-comment">前往评论 💬</div><div class="ai-btn-item" id="read-audio">Kokoro TTS 🎙️</div><div class="ai-btn-item" id="go-tianli-blog">👀 部署教程</div></div><script data-pjax="" src="https://cdn.dong4j.site/source/static/ai_abstract.js"></script></div><article class="post-content" id="article-container" itemscope="" itemtype="https://blog.dong4j.site/posts/e537d446.html"><header><a class="post-meta-categories" href="/categories/homelab-%E4%B8%AD%E5%B9%B4%E7%94%B7%E4%BA%BA%E7%9A%84%E5%BF%AB%E4%B9%90%E6%BA%90%E6%B3%89/" itemprop="url">HomeLab:中年男人的快乐源泉</a><a href="/tags/homelab/" tabindex="-1" itemprop="url">HomeLab</a><a href="/tags/%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84/" tabindex="-1" itemprop="url">网络架构</a><a href="/tags/%E5%AE%89%E5%85%A8%E6%80%A7/" tabindex="-1" itemprop="url">安全性</a><a href="/tags/%E5%BC%82%E5%9C%B0%E7%BB%84%E7%BD%91/" tabindex="-1" itemprop="url">异地组网</a><a href="/tags/%E8%87%AA%E6%89%98%E7%AE%A1/" tabindex="-1" itemprop="url">自托管</a><h1 id="CrawlerTitle" itemprop="name headline">HomeLab 网络篇：互联世界-构建高效的自托管网络环境</h1><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">dong4j</span><time itemprop="dateCreated datePublished" datetime="2020-04-11T16:00:00.000Z" title="发表于 2020-04-12 00:00:00">2020-04-12</time><time itemprop="dateCreated datePublished" datetime="2025-04-03T12:08:00.694Z" title="更新于 2025-04-03 20:08:00">2025-04-03</time></header><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_xLHg6epx.webp" alt="/images/cover/20241229154732_xLHg6epx.webp"></p><p>在构建个人云端实验室 (HomeLab) 的过程中, 硬件是基石, 而网络则是让这些硬件协同工作的血脉和灵魂. 本篇将深入探讨家庭网络的配置, 从基础的架构设计到高级的安全性和异地组网技术, 逐步展示如何搭建一个高效、稳定且安全的自托管网络环境.</p><p>我将从以下几个方面进行详细阐述:</p><ol><li><strong>网络架构</strong>: 介绍如何选择合适的网络设备 (如路由器、交换机等) , 以及如何在不同的房间和位置部署网络覆盖.</li><li><strong>安全性</strong>: 讨论如何设置网络安全策略, 包括防火墙规则、VPN 配置、加密通信等, 以确保数据的安全性和隐私保护.</li><li><strong>异地组网</strong>: 展示如何通过远程访问技术, 将家庭实验室扩展到外部网络, 实现异地管理和操作.</li><li><strong>实践案例</strong>: 分享实际操作步骤和经验, 帮助读者更好地理解和应用这些网络技术和概念.</li></ol><p>通过本篇的探讨, 你将能够了解到如何构建一个高效、安全且可扩展的自托管网络环境. 这不仅能够满足日常工作和学习的需求, 还能为你的个人云端实验室提供一个稳固的网络基础. 让我们一起揭开家庭网络配置的神秘面纱, 探索自托管的无限可能吧！</p><p><strong>相关文章</strong>:</p><ol><li><a href="/posts/15433dee.html">先导篇</a>：我的 HomeLab 概要;</li><li><a href="/posts/1c3b04a.html">硬件篇</a>：介绍我所拥有的硬件设备;</li><li><a href="/posts/e537d446.html">网络篇</a>：包括网络环境、异地组网与网络安全;</li><li><a href="/posts/b2341239.html">服务篇</a>：使用 Docker 搭建的各类服务;</li><li><a href="/posts/b808f350.html">数据篇</a>：包括数据存储方案、备份方案和数据恢复方案;</li><li><a href="/posts/273b6766.html">HomeLab数据同步：构建高效的数据同步网络</a></li><li><a href="/posts/6c25aa66.html">HomeLab数据备份：打造坚实的数据安全防线</a></li><li><a href="/posts/7e09e56.html">HomeLab 网络续集：升级 10G 网络-再战 10 年</a></li><li><a href="/posts/15433dee.html">NAT 内网穿透详解：揭秘网络连接背后的奥秘</a></li></ol><h2 id="阅读指引"><a href="#阅读指引" class="headerlink" title="阅读指引"></a>阅读指引</h2><p>由于篇幅较长且不想切分多篇文章影响阅读连续性, 因此这里给出一个阅读指引, 以帮助快速理解章节直接的逻辑关系:</p><ol><li><a href="#%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84">从网络相关的硬件出发, 以网络布线开始到硬件设备连接, 重点介绍了弱电箱和书房的网络布局</a></li><li><a href="#%E7%BD%91%E9%80%9F">通过外网, 内网和外网-&gt;家的网速测试验证宽带的可用性</a></li><li><a href="#%E8%AE%BE%E5%A4%87-IP-%E7%AE%A1%E7%90%86">有了硬件和基础网络后, 如何合理的分配设备 IP 地址</a></li><li><a href="#%E8%AE%BE%E5%A4%87%E5%9F%9F%E5%90%8D%E7%AE%A1%E7%90%86">为了方便记忆, 为设备分配自定义域名</a></li><li><a href="#%E8%AE%BE%E5%A4%87%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86">完成上面 2 步工作后, 接下来就是如何管理多台服务器</a></li><li><a href="#%E6%9A%B4%E9%9C%B2%E6%9C%8D%E5%8A%A1%E5%88%B0%E5%85%AC%E7%BD%91">内网配置完成后, 接下来就要考虑如何高效的从外网访问家中的设备和服务</a></li><li><a href="#%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8">因为暴露到公网后, 首先需要考虑的就是网络安全问题</a></li><li><a href="#%E5%A4%96%E7%BD%91%E8%AE%BF%E9%97%AE%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C">出门在外, 如何快速且安全的访问家中网络, 看个小电影, 听听歌</a></li><li><a href="#%E5%B9%BF%E5%91%8A%E8%BF%87%E6%BB%A4">为了提升网络体验, 需要考虑如何屏蔽广告</a></li><li><a href="#%E5%BC%82%E5%9C%B0%E7%BB%84%E7%BD%91">在外能够流畅访问家中的网络, 那么在家该如何访问公司的网络呢?</a></li><li><a href="#%E5%88%86%E6%B5%81">如何流畅的访问互联网世界, 只能说一点点</a></li><li><a href="#%E7%BD%91%E7%BB%9C%E7%9B%91%E6%B5%8B%E4%B8%8E%E9%80%9A%E7%9F%A5">最后的最后, 我们应该如何实时了解网络情况</a></li></ol><hr><h2 id="网络架构"><a href="#网络架构" class="headerlink" title="网络架构"></a>网络架构</h2><h3 id="布线"><a href="#布线" class="headerlink" title="布线"></a>布线</h3><p>从装修开始就考虑到一定会组建自己的 HomeLab, 但是考虑到弱电箱不够大且没有条件增大, 只能将硬件放置到各个房间, 因此在弱电布线时就做了冗余.</p><p>得益于开发商 2 根光纤入户, 使得宽带冗余方案得以实施, 同时遗憾的是无法增加更多的宽带数量.</p><p>从弱点箱预埋了总共 8 根八类网线, 客厅 3 根, 主卧和书房各 2 根, 次卧 1 根.</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/%E5%B9%B3%E9%9D%A2%E5%9B%BE.drawio.svg" alt="平面图.drawio.svg"></p><p>电信和联通通过弱电箱光纤入户</p><p><strong>电信宽带</strong>:</p><ol><li>电信光猫通过网线连接电信机顶盒;</li><li>电信光猫通过网线连接电视柜中 <code>AX9000</code> 的千兆 wan 口, 由 <code>AX9000</code> 拨号上网;</li><li><code>AX9000</code> 的 2.5G lan 口通过网线回连至弱电箱的 <code>TL-SH1005</code> 2.5G 交换机;</li><li><code>TL-SH1005</code> 交换机通过网线连接主卧和书房, 实现主要房间 2.5G 电信有线网络;</li></ol><p><strong>联通宽带</strong>:</p><ol><li>联通光猫通过网线连接弱电箱旁边 <code>6500Pro</code> 的 2.5G wan 口, 由 <code>6500Pro</code> 拨号上网;</li><li><code>6500Pro</code> 通过 2.5G lan 口连接弱电箱中的另一个 <code>TL-SH1005</code> 交换机;</li><li><code>TL-SH1005</code> 交换机通过网线连接主卧, 次卧和书房, 实现房间 2.5G 联通有线网络;</li></ol><p>因为弱电箱小无法放下所有硬件, 因此只能采用这种迂回的方式布线, 关键点是需要额外预埋一条网线将网络从路由器接到交换机, 再由交换机将网络输送到各个房间.</p><p>如果在装修时没有考虑导致网线不够, 可以用其他方式实现:</p><ol><li><p>网线一分为二, 四芯用于连接无线路由器, 这种方式当然 <strong>不推荐</strong>, 网速达不到要求;</p></li><li><p>使用电力猫连接 IPTV 电视盒子, 网线连接无线路由器, 这种方式会导致 IPTV 电视信号稳定性不高;</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_QgATxj9Q.webp" alt="20241229154732_QgATxj9Q.webp"></p></li><li><p>单线复用: 使用支持 VLAN 的交换机, 划分两个逻辑独立的网络. 这种连接方式会增加配置复杂度. <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj0xQ3V5RTVIWGhBOA==">这里有详细的视频教程</a></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_LTEiwoQJ.webp" alt="20241229154732_LTEiwoQJ.webp"></p></li></ol><h3 id="弱电箱"><a href="#弱电箱" class="headerlink" title="弱电箱"></a>弱电箱</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_bBOS3J6w.webp" alt="20241229154732_bBOS3J6w.webp"></p><p>还好沙发后面有一个 10 公分宽的木架, 不然这些设备弱电箱还塞不下.</p><h4 id="拓扑图"><a href="#拓扑图" class="headerlink" title="拓扑图"></a>拓扑图</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/%E5%BC%B1%E7%94%B5%E7%AE%B1.drawio.svg" alt="弱电箱.drawio.svg"></p><ol><li>电视柜 3 个网口实现 IPTV, 路由器拨号上网与有线回程;</li><li>弱电箱的电信交换机连接 R2S 和 R5S, 剩下的 2 个网口接到主卧和书房;</li><li>联通光猫连接 6500Pro 并由路由器拨号上网, 6500Pro 连接交换机与 R5S;</li><li>联通交换机连接 R2S, 其他网口接到主卧, 次卧和书房;</li></ol><p>其中 R5S 和 R2S 都已将 <strong>lan 修改为 wan 口</strong>, 然后作为旁路由和轻量服务器是用, 跑了几个 Docker 服务.</p><h4 id="光猫改桥接"><a href="#光猫改桥接" class="headerlink" title="光猫改桥接"></a>光猫改桥接</h4><p>光猫改桥接的优势:</p><ol><li><strong>提升网络性能</strong>: 在桥接模式下, 光猫只负责光电转换, 将路由功能交给专门的路由器处理, 这样可以减轻光猫的负担, 使网络性能得到提升. 同时, 所有的设备都位于同一子网内, 网络结构更加简单, 便于管理和配置.</li><li><strong>增强网络稳定性</strong>: 光猫在桥接模式下, 只需完成光电转换, 简化了其任务, 从而降低了工作压力, 提升了家庭网络的稳定性.</li><li><strong>便于故障排查</strong>: 由于路由功能由专门的路由器处理, 一旦出现问题, 可以迅速定位到路由器层面进行排查和修复. 而在路由模式下, 故障排查可能会涉及到光猫和路由器等多个设备, 增加了故障排查的难度.</li><li><strong>提高灵活性</strong>: 桥接模式允许用户根据实际需求选择合适的路由器设备, 实现更灵活的网络配置. 例如, 用户可以选择具有更强路由性能的路由器来提升网络稳定性, 或者选择具有特殊功能的路由器来满足特定需求.</li><li><strong>实现特殊功能</strong>: 光猫改桥接后, 路由器 PPPOE 拨号, 用户可以实现更多的功能. 比如可以单线双拨增加带宽.</li></ol><p>改桥接的方法可以网上搜索, 保险起见直接让运营商修改即可.</p><h3 id="电视柜"><a href="#电视柜" class="headerlink" title="电视柜"></a>电视柜</h3><p>电视柜中的 AX9000, 剩下的 lan 分别连接了小米壁画电视和 Apple TV.</p><h3 id="书房"><a href="#书房" class="headerlink" title="书房"></a>书房</h3><p>书房承载了 80% 的网络设备, 因为设备是慢慢增加的, 所以一开始并没有直接购买太多网口的交换机, 后面设备增多后, 因为交换机体积的问题, 也没有直接更换成更多网口的交换机, 而是直接通过增加交换机数量进行网络扩展. 而因为接入了电信和联通, 每条宽带都需要增加双倍的交换机数量.</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_9TrRPpHt.webp" alt="20241229154732_9TrRPpHt.webp"></p><p>书房 2 个网口, 分别有线接入电信和联通网络(2.5G).</p><p>除了 DS923+ 和单独的开发版, 书房所有供电全部来自于最右边的插座, 因此增加了一个小米智能插座来统计书房的耗电量.</p><p>因为书桌上设备太多, 总共通过 4 个 8 口 PDU 插座和 3 个小米插座来供电, 放一个书桌下面的走线图:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_ZtqbiHUy.webp" alt="20241229154732_ZtqbiHUy.webp"></p><p>不能说乱吧, 只能说隐蔽工程做的不太漂亮 😎.</p><h4 id="网络拓扑图"><a href="#网络拓扑图" class="headerlink" title="网络拓扑图"></a>网络拓扑图</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/network.drawio.svg" alt="network.drawio.svg"></p><ol><li>网络设备全部通过双网口接入电信和联通网络, 如果没有双网口的设备, 则通过 USB 或 type-c 转 2.5G 网口实现;</li><li>现在还没有条件实现书房主要设备万兆局域网, 这将是下一步的升级目标;</li></ol><p>由于早期申请了电信宽带, 当时申请<strong>公网 IP</strong>相对容易. 正是因为这个公网 IP, 当前宽带无法升级到 2000M. 经咨询, 升级可能会导致公网 IP 被收回. 鉴于现有带宽足够使用, 加上还有一条千兆联通宽带, 暂时没有升级的迫切需求.</p><p><strong>宽带配置和使用情况</strong></p><ol><li><p><strong>电信宽带</strong>:</p><ul><li>主要满足日常上网需求.</li><li>手机等常用设备优先接入电信网络.</li></ul></li><li><p><strong>联通宽带</strong>:</p><ul><li>最初为免费赠送的 300M 带宽, 后来通过活动以 <strong>每月 19 元</strong>升级到千兆.</li><li>通过协商安装师傅, 也获取了一个公网 IP.</li><li>联通宽带主要用于智能设备联网和文件下载, 作为电信宽带的<strong>备用网络</strong>.</li></ul></li><li><p><strong>双宽带优势</strong>:</p><ul><li>两条独立宽带确保当一条线路的网络服务出现问题 (如运营商线路故障或光缆被挖断) 时, 仍可通过另一条线路访问家中设备.</li><li>但需注意, 如果停电, 两个网络都会中断, 目前还不具备部署大型备用电源的财力 😅.</li></ul></li></ol><p><strong>网络优化方案</strong></p><p>为减少 WiFi 信号干扰, 进行了以下调整:</p><ol><li><p><strong>WiFi 管理</strong>:</p><ul><li>关闭光猫和非主要路由器的 WiFi 功能.</li><li>使用 <strong>AX9000</strong> 及其 <strong>Mesh 设备(2 台 AX1800)</strong> 的 WiFi 提供全屋漫游覆盖.</li></ul></li><li><p><strong>智能设备专网</strong>:</p><ul><li>配置 <strong>6500Pro</strong> 作为智能硬件的网络接入点, 启用 <strong>2.4G 和 5G 频段</strong>.</li><li>为访客提供专用的访客 WiFi, 保障主网络的安全性.</li></ul></li></ol><p>通过这种分工, 不仅可以优化网络性能, 还能减少干扰, 确保家庭网络的稳定性和可用性.</p><h3 id="关于网线"><a href="#关于网线" class="headerlink" title="关于网线"></a>关于网线</h3><p>刚开始并没有考虑到全网光纤, 这是一大败笔, 现在换成光纤成本有点高, 还好预埋了 <strong>八类网线</strong>, 不过当时功课没有最好, 感觉类型越高越好, 完全没有考虑价格, 导致弱电装修增加了不少成本. 家用网线超六类完全够用.</p><p>不同规格网线速率图:</p><table><thead><tr><th>规格</th><th>类型</th><th>速率</th><th>接口</th><th>备注</th></tr></thead><tbody><tr><td>五类线 CAT 5</td><td>100Base-T 10Base-T</td><td>100Mbps</td><td>RJ45</td><td>不推荐</td></tr><tr><td>超五类线 CAT 5E</td><td>100Base-T</td><td>1000Mbps 2.5Gbps<a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9pY3lsZWFmLmNvbS8yMDIzLzAxL2hvdy10by1ob21lbGFiLXBhcnQtMS1oYXJkd2FyZS1hbmQtYXJjaGl0ZWN0dXJlLyNmbjo3">7</a></td><td>RJ45</td><td>2.5G 网络<a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMXAxNHkxMzd2Mw==">仅限 100 米以内</a></td></tr><tr><td>六类线 CAT 6</td><td>100Base-T</td><td>1Gbps 10Gbps</td><td>RJ45</td><td>万兆网络仅限 50 米内</td></tr><tr><td>超六类线 CAT 6A</td><td>100Base-T</td><td>10Gbps</td><td>RJ45</td><td>200 米内可达万兆网络 没有 6E 标准</td></tr><tr><td>七类线 CAT 7</td><td>100Base-T</td><td>10Gbps</td><td>GG45/TERA</td><td>带着遮蔽</td></tr><tr><td>光纤</td><td>-</td><td>-</td><td>-</td><td>不懂, 详见<a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3poLWNuLyVFNSU4NSU4OSVFNyVCQSU5NiVFOSU4MCU5QSVFOCVBOCU4QQ==">维基百科</a></td></tr></tbody></table><p>因为七类以上的网线有遮蔽罩, 需要正确接地处理, 反正来给我打水晶头的人不知道怎么接, 不过因为速度还是能达到万兆网速, 所有还没有深究这个问题, 等到有时间再去折腾吧.</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>上一篇说过为什么不通过双线多播和猫棒等手段来提升宽带速度, 主要是 <strong>稳定性和容错</strong> 考虑, 也否定了 <strong>All In One</strong> 的方案, 避免 <strong>All In Boom</strong> 的问题, 而是使用多个硬件承载不同的需求.</p><p>在硬件设备上, 我也实现了多台冗余的设计, 比如多个 R2S 设备, 网络相关的服务集群部署等, 主要是保证可用性.</p><p>多年互联网开发经验告诉我, 多台服务器比单台性能强劲的服务器更加靠谱和经济实惠, 既能保证高可能还能提高可扩展性, 唯一的缺点就是多服务器的管理和配置难度上升.</p><hr><h2 id="网速"><a href="#网速" class="headerlink" title="网速"></a>网速</h2><h3 id="外网"><a href="#外网" class="headerlink" title="外网"></a>外网</h3><p><strong>电信</strong>:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_Fnvmpxzj.webp" alt="20241229154732_Fnvmpxzj.webp"></p><p><strong>联通</strong>:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_gnLMAsbn.webp" alt="20241229154732_gnLMAsbn.webp"></p><h3 id="内网"><a href="#内网" class="headerlink" title="内网"></a>内网</h3><p>内网主要设备全部实现 2.5G:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_cdFkeuv1.webp" alt="20241229154732_cdFkeuv1.webp"></p><p>通过雷雳 3 直连的 2 台 Mac mini 能达到 20G:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_b9rVcsdz.webp" alt="20241229154732_b9rVcsdz.webp"></p><p>通过万兆交换机连接的 Mac mini 2018 和 DS923+ 能达到 10G 速度:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_yx0Zo8we.webp" alt="20241229154732_yx0Zo8we.webp"></p><h3 id="外网-家"><a href="#外网-家" class="headerlink" title="外网->家"></a>外网-&gt;家</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_GedNor8D.webp" alt="20241229154732_GedNor8D.webp"></p><p>给一个逆天的网速测试截图, 就当图了乐 🤩:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_CbAogrJy.webp" alt="20241229154732_CbAogrJy.webp"></p><h2 id="设备-IP-管理"><a href="#设备-IP-管理" class="headerlink" title="设备 IP 管理"></a>设备 IP 管理</h2><p>从书房的网络拓扑图可以看出, 主要硬件设备的 IP 地址分配都保持有序. 这种规划方式的优势是: <strong>只需记住设备的最后一位数字</strong>, 便能快速找到对应设备.</p><p>另一种常见方式是通过修改 <strong>hosts 文件</strong>, 为每个设备设置对应的域名.</p><p>最理想的解决方案是<strong>自建 DNS 服务</strong>, 以集中管理所有设备的 DNS 解析任务, 更高效地应对设备数量的增加和变化.</p><h3 id="IP-设置策略"><a href="#IP-设置策略" class="headerlink" title="IP 设置策略"></a>IP 设置策略</h3><p>由于设备较多, 且未来可能增加新设备, 因此未采用在设备端手动设置静态 IP 的方式.</p><p><strong>原因</strong>:</p><ol><li><strong>灵活性</strong>: 某些设备 (如开发板) 可能频繁切换网络或连接不同宽带.</li><li><strong>易管理</strong>: 通过路由器实现静态 IP 绑定既简单又高效, 可统一管理设备的 IP 地址分配.</li></ol><p>设备 IP 分配方案按照网口数量进行粗略分组, IP 地址基于其连接的电信或联通宽带进行划分. 这种规划既便于扩展, 又确保了网络结构的清晰和可控性.</p><h3 id="IP-分配"><a href="#IP-分配" class="headerlink" title="IP 分配"></a>IP 分配</h3><p>粗略按照网口对设备进行分类:</p><table><thead><tr><th>网口数量</th><th>设备</th><th>所需 IP 数量</th></tr></thead><tbody><tr><td>WiFi</td><td><code>移动设备 * 4</code></td><td>4</td></tr><tr><td>单网口</td><td>Apple TV, 小米电视</td><td>2</td></tr><tr><td>单网口 + WiFi</td><td><code>开发板 * 7</code></td><td>14</td></tr><tr><td>双网口</td><td><code>R2S * 2</code>, DS218+, DS923+(2 个千兆网口链路聚合成 1 个网口, 另一个万兆网口)</td><td>4(电信联通各一个)</td></tr><tr><td>双网口 + WiFI</td><td>MBP, Mac mini M2, Mac mini 2018</td><td>6</td></tr><tr><td>3 网口</td><td>R5S</td><td>1</td></tr><tr><td>4 网口</td><td>M920x. 组装机</td><td>4</td></tr></tbody></table><p>算下来只需要记住 35 个 IP 😅, 当然都是有规律的:</p><p>比如 MBP:</p><ul><li>电信 RJ45: 192.168.31.8</li><li>联通 RJ45: 192.168.21.8</li><li>电信 WiFi: 192.169.31.88</li><li>联通 WiFi: 192.169.21.88</li></ul><p><strong>IP 分配规则</strong></p><p>为了便于管理和记忆, 主要设备的 IP 地址分配遵循以下规则:</p><ol><li><p><strong>前 10 位 IP 分配给主要设备</strong>:</p><ul><li>如设备需要连接 WiFi, 直接在有线 IP 的基础上 <strong>double</strong> (翻倍) 即可, 比如 RJ45 IP 为 <code>192.168.31.8</code>, WiFi IP 就是 <code>192.168.31.88</code>.</li><li>如果某设备超过了 10 位范围, 且有额外的 WiFi 连接需求, 则在有线 IP 后面添加一个 <strong>0</strong>, 比如 RJ45 IP 为 <code>192.168.31.11</code>, WiFi IP 就是 <code>192.168.31.110</code>.</li></ul></li><li><p><strong>超出规则时的处理</strong>:</p><ul><li>当添加 <strong>0</strong> 导致 IP 超过 <strong>254</strong> 时, 直接将下一位 IP 地址递增, 比如 RJ45 IP 为 <code>192.168.31.33</code>, WiFi IP 就是 <code>192.168.31.34</code>.</li><li>确保分配合法, 避免使用非法 IP.</li></ul></li><li><p><strong>其他设备的分配</strong>:</p><ul><li>无关紧要的设备使用 <strong>200 之后</strong>的 IP 地址.</li><li>当前 <strong>200 段</strong>的 IP 数量尚充足, 如有需求可以再开放更多的 IP 段.</li></ul></li></ol><p><strong>优势分析</strong></p><p>这种分配方式使<strong>主要设备的 IP 规划简单易记</strong>, 同时将无关紧要的设备划分至 <strong>200 段</strong>后, 可以减少对主要设备 IP 地址段的干扰, 确保未来扩展设备时的灵活性和有序性.</p><hr><h2 id="设备域名管理"><a href="#设备域名管理" class="headerlink" title="设备域名管理"></a>设备域名管理</h2><h3 id="Hosts"><a href="#Hosts" class="headerlink" title="Hosts"></a>Hosts</h3><p>通过修改 <strong>hosts 文件</strong>, 为每个设备设置对应的域名是一种常见的本地解析方案.</p><p>然而, 这种方式存在以下问题:</p><ol><li><strong>每台终端需单独配置</strong>: 每次新增设备都需要在所有终端的 hosts 文件中手动添加配置.</li><li><strong>不支持泛域名解析</strong>: 系统自带的 hosts 文件无法处理类似 <code>*.xx.com</code> 的泛域名.</li></ol><p>因此这种方式管理效率较低, 扩展性差, 特别是设备数量多或频繁变动的场景, 显得尤为不适用.</p><p><strong>推荐替代方案</strong>: 通过自建 DNS 服务实现集中管理, 不仅支持泛域名解析, 还能减少每台终端的配置工作量, 提升管理效率和灵活性.</p><h3 id="DNS-服务"><a href="#DNS-服务" class="headerlink" title="DNS 服务"></a>DNS 服务</h3><details class="folding-tag"><summary>🪬 常见的自托管 DNS 服务有:</summary><div class="content"><ol><li><strong><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly90aGVrZWxsZXlzLm9yZy51ay9kbnNtYXNxLw==">dnsmasq</a></strong></li></ol><ul><li><strong>功能特点</strong>: 轻量级 DNS 和 DHCP 服务器, 支持本地解析、DNS 缓存、DHCP 静态绑定.</li><li><strong>适用场景</strong>: 家庭和小型局域网中使用, 配置简单, 资源占用极低.</li><li><strong>优点</strong>:<ul><li>轻量化, 易配置.</li><li>支持本地静态 IP 和域名绑定.</li></ul></li><li><strong>缺点</strong>:<ul><li>高级功能较少, 不适合大型网络或复杂解析场景.</li></ul></li></ul><ol start="2"><li><strong><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9jb3JlZG5zLmlvLw==">CoreDNS</a></strong></li></ol><ul><li><strong>功能特点</strong>: 模块化、插件化设计的 DNS 服务, 适合现代云环境.</li><li><strong>适用场景</strong>: Kubernetes 集群、微服务架构的 DNS 管理.</li><li><strong>优点</strong>:<ul><li>支持负载均衡、缓存、DNSSEC 等高级功能.</li><li>插件化架构, 功能可扩展性强.</li></ul></li><li><strong>缺点</strong>:<ul><li>配置和学习曲线相对较高.</li><li>对初学者可能显得过于复杂.</li></ul></li></ul><ol start="3"><li><strong><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9weW11bXUuZ2l0aHViLmlvL3NtYXJ0ZG5zLw==">SmartDNS</a></strong></li></ol><ul><li><strong>功能特点</strong>: 高性能 DNS 解析器, 专注于提升解析速度和可靠性.</li><li><strong>适用场景</strong>: 需优化 DNS 解析速度的环境, 如加速海外解析、影音服务.</li><li><strong>优点</strong>:<ul><li>支持多线路、快速 DNS 选择.</li><li>优化海外解析性能.</li></ul></li><li><strong>缺点</strong>:<ul><li>功能专注于加速, 不适合复杂解析需求.</li><li>高级功能较少, 生态支持不如其他方案.</li></ul></li></ul><ol start="4"><li><strong><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9hZGd1YXJkLmNvbS9lbi9hZGd1YXJkLWhvbWUvb3ZlcnZpZXcuaHRtbA==">AdGuard Home</a></strong></li></ol><ul><li><strong>功能特点</strong>: 集成广告拦截的 DNS 服务, 提供友好的 Web 管理界面.</li><li><strong>适用场景</strong>: 家庭网络广告屏蔽和基础 DNS 管理.</li><li><strong>优点</strong>:<ul><li>易用的 Web 界面, 配置简单直观.</li><li>集成广告拦截、隐私保护功能.</li></ul></li><li><strong>缺点</strong>:<ul><li>灵活性不足, 偏向家庭用户.</li><li>插件和高级扩展支持较弱.</li></ul></li></ul><ol start="5"><li><strong><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9waS1ob2xlLm5ldC8=">Pi-hole</a></strong></li></ol><ul><li><strong>功能特点</strong>: 以广告拦截为核心的 DNS 服务, 可运行于 Raspberry Pi 或其他小型设备上.</li><li><strong>适用场景</strong>: 家庭或小型办公网络中的广告屏蔽和基础 DNS 管理.</li><li><strong>优点</strong>:<ul><li>强大的广告屏蔽功能.</li><li>配置简单, 支持轻量级部署.</li></ul></li><li><strong>缺点</strong>:<ul><li>高级 DNS 功能支持较弱.</li><li>更适合广告屏蔽用途, 不适合复杂网络需求.</li></ul></li></ul><ol start="6"><li><strong><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL05MbmV0TGFicy91bmJvdW5k">Unbound</a></strong></li></ol><ul><li><strong>功能特点</strong>: 高性能递归 DNS 服务器, 支持 DNSSEC 和隐私保护.</li><li><strong>适用场景</strong>: 需要安全、高效的递归 DNS 服务的环境.</li><li><strong>优点</strong>:<ul><li>支持 DNSSEC, 适合需要隐私保护的场景.</li><li>配置灵活, 性能出色.</li></ul></li><li><strong>缺点</strong>:<ul><li>缺少 Web 界面, 配置文件复杂度较高.</li></ul></li></ul><ol start="7"><li><strong><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL2lzYy1wcm9qZWN0cy9iaW5kOQ==">BIND 9</a></strong></li></ol><ul><li><strong>功能特点</strong>: 功能全面的权威 DNS 服务器, 广泛用于企业环境.</li><li><strong>适用场景</strong>: 企业级、复杂解析需求的 DNS 服务.</li><li><strong>优点</strong>:<ul><li>支持权威解析、递归解析、DNSSEC 等功能.</li><li>功能全面, 企业标准.</li></ul></li><li><strong>缺点</strong>:<ul><li>学习成本高, 适合有经验的管理员.</li><li>对系统资源的需求较高.</li></ul></li></ul><p><strong>总结对比表</strong></p><table><thead><tr><th>工具</th><th>轻量化</th><th>高性能</th><th>易用性</th><th>插件扩展</th><th>高级功能</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>dnsmasq</strong></td><td>★★★★★</td><td>★★★★☆</td><td>★★★★★</td><td>★☆☆☆☆</td><td>★★☆☆☆</td><td>家庭、小型网络</td></tr><tr><td><strong>CoreDNS</strong></td><td>★★★☆☆</td><td>★★★★★</td><td>★★☆☆☆</td><td>★★★★★</td><td>★★★★☆</td><td>Kubernetes、微服务环境</td></tr><tr><td><strong>SmartDNS</strong></td><td>★★★★★</td><td>★★★★★</td><td>★★★★☆</td><td>★☆☆☆☆</td><td>★★☆☆☆</td><td>DNS 加速、影音服务</td></tr><tr><td><strong>AdGuard</strong></td><td>★★★★☆</td><td>★★★☆☆</td><td>★★★★★</td><td>★★☆☆☆</td><td>★★★☆☆</td><td>广告屏蔽、家庭网络</td></tr><tr><td><strong>Pi-hole</strong></td><td>★★★★☆</td><td>★★★☆☆</td><td>★★★★☆</td><td>★★☆☆☆</td><td>★★★☆☆</td><td>广告屏蔽、基础 DNS 管理</td></tr><tr><td><strong>Unbound</strong></td><td>★★★☆☆</td><td>★★★★★</td><td>★★☆☆☆</td><td>★★☆☆☆</td><td>★★★★★</td><td>安全递归 DNS 服务</td></tr><tr><td><strong>BIND 9</strong></td><td>★★☆☆☆</td><td>★★★★☆</td><td>★★☆☆☆</td><td>★★★☆☆</td><td>★★★★★</td><td>企业环境、权威 DNS 服务</td></tr></tbody></table><p><strong>方案选择推荐</strong>:</p><ul><li><strong>轻量化和便捷配置</strong>: 选择 <strong>dnsmasq</strong>.</li><li><strong>广告拦截和易用性</strong>: 选择 <strong>AdGuard Home</strong> 或 <strong>Pi-hole</strong>.</li><li><strong>高性能递归解析</strong>: 选择 <strong>Unbound</strong>.</li><li><strong>复杂企业级需求</strong>: 选择 <strong>BIND 9</strong>.</li><li><strong>云原生环境或微服务架构</strong>: 选择 <strong>CoreDNS</strong>.</li><li><strong>追求解析速度优化</strong>: 选择 <strong>SmartDNS</strong>.</li></ul><p>目前在用的是轻量级的 <strong>SmartDNS</strong> 和 <strong>AdGuard Home</strong>, R2S 的固件中自带这 2 个服务, 稍微配置即可实现自定义 DNS, 并具备广告拦截的功能.</p></div></details><h3 id="Surge-Hosts"><a href="#Surge-Hosts" class="headerlink" title="Surge Hosts"></a>Surge Hosts</h3><p>只需要满足主要设备能通过域名访问其他服务器或服务即可, 因此没必要单独部署一个 DNS 解析服务, <strong>SmartDNS</strong> 和 <strong>AdGuard Home</strong> 更多的是用来拦截广告.</p><p>Surge 本身就具备 hosts 管理功能, 且支持泛域名解析(可以通过 Synology Drive 或 iCloud 服务来同步配置, 避免多端重复配置):</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># R2ST 的 npm 代理, 所有的 *.npm 全部转发到 R2ST 的 80 端口, 然后再通过 NPM 转发到其他服务</span><br><span class="line">*.npm = 192.168.31.10</span><br></pre></td></tr></tbody></table></figure><h3 id="方案总结"><a href="#方案总结" class="headerlink" title="方案总结"></a>方案总结</h3><p>在实际使用中, 没有单一方案能够完全满足所有需求, 因此需要根据不同场景搭配多种方案.</p><p>我想实现的目标就是 <strong>方便快捷的访问设备与服务</strong>, 避免记忆大量 IP 地址及端口号, 提升访问效率.</p><p>其实, 主要设备就那么几台, 记住几个 IP 也不是那么难, 且主要设备的 IP 肯定不会经常改动. 问题是每台服务器的服务需要通过端口区分, 如果是 Web 服务, 直接用 Dashboard 这类服务来管理, 嫌麻烦就用书签, 推荐 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9jaHJvbWV3ZWJzdG9yZS5nb29nbGUuY29tL2RldGFpbC9tYXJrb29iLSVFNCVCOSVBNiVFNyVBRCVCRSVFNSU5MCVBRiVFNSU4QSVBOCVFNSU5OSVBOC9sbmhubGxrYWFjbW5rZmZuamdjbm9raWZha2Vja2lkbz9obD16aC1DTg==">Markoob</a>:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_sTNm93mn.webp" alt="20241229154732_sTNm93mn.webp"></p><p><a id="通过自定义域名减少需要记忆的 IP 数量" style="display:none"></a></p><p>另一种则是通过自定义域名的方式减少需要记住的 IP 数量, 前面 [Surge Hosts](#Surge Hosts) 已经介绍过 hosts 功能, 我将结合 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9uZ2lueHByb3h5bWFuYWdlci5jb20v">Nginx Proxy Manager</a> 再次简化掉端口, 直接通过自定义域名访问所有服务. <a href="#%E4%BB%A3%E7%90%86%E5%B1%80%E5%9F%9F%E7%BD%91%E8%87%AA%E5%AE%9A%E4%B9%89%E5%9F%9F%E5%90%8D">具体的配置将在后续详细说明</a>.</p><p>所以总结下来就以下几点:</p><ol><li>使用浏览器书签管理常用 Web 服务 (在服务篇会使用开源的 Dashboard 服务来管理);</li><li><a href="#%E4%BB%A3%E7%90%86%E5%B1%80%E5%9F%9F%E7%BD%91%E8%87%AA%E5%AE%9A%E4%B9%89%E5%9F%9F%E5%90%8D">使用 NPM + Surge Hosts 实现 80 端口访问自定义域名</a>, 简化域名并减少 IP 记忆;</li></ol><hr><h2 id="设备连接管理"><a href="#设备连接管理" class="headerlink" title="设备连接管理"></a>设备连接管理</h2><h3 id="SSH"><a href="#SSH" class="headerlink" title="SSH"></a>SSH</h3><p>能通过 SSH 连接的设备我这里统称为 <strong>服务器</strong>, 那么在不算虚拟机的情况下, 总共有 20 台设备, 如果需要同时访问多台设备, 在使用 macOS 自带的终端或 iTerm2 一个个手敲的话效率非常低, 不过我们可以通过多种方式提升效率.</p><h4 id="别名配置"><a href="#别名配置" class="headerlink" title="别名配置"></a>别名配置</h4><p>首先想到的是为每台服务器设置一个简短好记的别名, 我们可以编辑 <code>.ssh/config</code> 文件来实现:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Host 别名</span><br><span class="line">    HostName 服务器 IP</span><br><span class="line">    User username</span><br><span class="line">    Port ssh-port</span><br></pre></td></tr></tbody></table></figure><p>连接方式:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh 别名</span><br></pre></td></tr></tbody></table></figure><h4 id="SSH-免密登录"><a href="#SSH-免密登录" class="headerlink" title="SSH 免密登录"></a>SSH 免密登录</h4><p>为了避免每次都需要输入密码, 我们可以配置 SSH 的免密登录:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">客户端沈城 SSH 密钥对 ()</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ssh-keygen -t rsa -b 4096 -C <span class="string">"your_email@example.com"</span></span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/Users/dong4j/.ssh/id_rsa): 这里输入新的密钥保存路径 [我没有直接保存到默认的 id_rsa 中, 后续会共享这个密钥]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 ssh-copy-id 工具将公钥传输到目标服务器</span></span><br><span class="line">ssh-copy-id user@remote_server</span><br></pre></td></tr></tbody></table></figure><p>如果未安装 ssh-copy-id, 可以手动传输公钥:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将公钥复制到剪贴板</span></span><br><span class="line">cat ~/.ssh/server.pub | pbcopy  # macOS</span><br><span class="line">cat ~/.ssh/server.pub | xclip  # Linux</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">登录服务器</span></span><br><span class="line">ssh user@remote_server</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在服务器上将公钥添加到 authorized_keys</span></span><br><span class="line">echo "your-public-key" &gt;&gt; ~/.ssh/authorized_keys</span><br><span class="line">chmod 600 ~/.ssh/authorized_keys</span><br></pre></td></tr></tbody></table></figure><p>验证免密是否生效:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果没有提示输入密码, 则配置成功</span></span><br><span class="line">ssh user@remote_server</span><br></pre></td></tr></tbody></table></figure><p>拷贝公钥到其他服务器后, 为了实现局域网服务器之间 SSH 免密登录, 我会将第一步生成的 <code>server</code> 也拷贝到其他所有服务器.</p><p>值得说明的是, R2S 和 R5S 可以通过 WebUI 进行配置:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_SwNzaDIS.webp" alt="20241229154732_SwNzaDIS.webp"></p><h4 id="SSH-密钥认证"><a href="#SSH-密钥认证" class="headerlink" title="SSH 密钥认证"></a>SSH 密钥认证</h4><p>为了安全起见, 建议关闭密码认证, 只开启公钥认证.</p><p>编辑服务器上的 SSH 配置文件 /etc/ssh/sshd_config</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">完全禁止使用密码认证, 强制所有用户使用公钥认证</span></span><br><span class="line">PasswordAuthentication no</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用公钥认证</span></span><br><span class="line">PubkeyAuthentication yes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁用空密码登录</span></span><br><span class="line">PermitEmptyPasswords no</span><br></pre></td></tr></tbody></table></figure><p>重启 SSH 服务以应用更改:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意 不同的系统重启命令可能不一样</span></span><br><span class="line">sudo systemctl restart sshd</span><br></pre></td></tr></tbody></table></figure><p>配置本机的 <code>.ssh/config</code></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Host 别名</span><br><span class="line">    HostName 服务器 IP</span><br><span class="line">    User username</span><br><span class="line">    Port ssh-port</span><br><span class="line">    IdentityFile ~/.ssh/server</span><br></pre></td></tr></tbody></table></figure><h4 id="SSH-允许-root-登录"><a href="#SSH-允许-root-登录" class="headerlink" title="SSH 允许 root 登录"></a>SSH 允许 root 登录</h4><p>数据篇中会讲到如何 <strong>使用 Synology NAS 备份服务器上的重要数据</strong>, 前提是必须使用 root 账号登录服务器, 所以这里顺带把 SSH 允许 root 登录一起写一下 (开启 root 登录会增加潜在的安全风险, 及时只是在内网使用):</p><p>编辑服务器上的 SSH 配置文件 /etc/ssh/sshd_config</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">允许 root 用户登录, 但仅限密钥认证, 不允许密码登录</span></span><br><span class="line">PermitRootLogin prohibit-password</span><br></pre></td></tr></tbody></table></figure><p>以下是增加 SSH 安全性的常规手段:</p><ol><li>限制 root 登录的 IP 段;</li><li>仅允许密钥登录;</li><li>启用 MFA (多因素认证);</li><li>使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL2ZhaWwyYmFuL2ZhaWwyYmFu">Fail2Ban</a> 自动封禁多次失败的登录尝试;</li><li>更改 SSH 默认端口;</li></ol><h4 id="SSH-多因素认证"><a href="#SSH-多因素认证" class="headerlink" title="SSH 多因素认证"></a>SSH 多因素认证</h4><p>更进一步, 你可以为 SSH 开启多因素认证:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 Google Authenticator PAM 模块:</span></span><br><span class="line">brew install google-authenticator-libpam</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">为登录用户生成一个基于时间的一次性密码配置</span></span><br><span class="line">google-authenticator</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">扫描生成的二维码到 Google Authenticator、Authy 或其他支持 TOTP 的应用</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编辑 PAM 文件 /etc/pam.d/sshd, 在文件的顶部添加以下内容:</span></span><br><span class="line">auth required /opt/homebrew/lib/security/pam_google_authenticator.so</span><br></pre></td></tr></tbody></table></figure><p>编辑 SSH 配置文件 /etc/ssh/sshd_config, 调整以下参数:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用挑战响应认证</span></span><br><span class="line">ChallengeResponseAuthentication yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">保留或禁用密码认证 (根据需要)</span></span><br><span class="line">PasswordAuthentication yes</span><br></pre></td></tr></tbody></table></figure><p>macOS 下重启 SSH 服务</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo launchctl unload /System/Library/LaunchDaemons/ssh.plist</span><br><span class="line">sudo launchctl load /System/Library/LaunchDaemons/ssh.plist</span><br></pre></td></tr></tbody></table></figure><p><strong>注意事项</strong></p><ol><li><p><strong>备份密钥与备用代码</strong>:</p><p>确保生成的密钥和备用代码保存在安全的地方.</p></li><li><p><strong>排除特定用户</strong>:</p></li></ol><p>可在 PAM 配置中定义例外用户组, 跳过 MFA:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">o_mfa_users 是无需 MFA 的用户组</span></span><br><span class="line">auth [success=1 default=ignore] pam_succeed_if.so user ingroup no_mfa_users</span><br><span class="line">auth required pam_google_authenticator.so</span><br></pre></td></tr></tbody></table></figure><ol start="3"><li><strong>结合 SSH 密钥</strong>:</li></ol><p>配置 SSH 密钥认证与 MFA 结合使用, 提升安全性.</p><h4 id="SSH-会话保持"><a href="#SSH-会话保持" class="headerlink" title="SSH 会话保持"></a>SSH 会话保持</h4><p>同一主机的多次连接可以复用已有连接, 减少登录时间:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Host *</span><br><span class="line">    # 添加私钥到 ssh-agent 并允许其存储在 macOS 密钥链中</span><br><span class="line">    AddKeysToAgent yes</span><br><span class="line">    # 通过 ssh-agent 管理私钥, UseKeychain 特别适用于 macOS, 将私钥安全存储</span><br><span class="line">    UseKeychain yes</span><br><span class="line">    # 指定私钥路径, 对所有 SSH 连接生效</span><br><span class="line">    IdentityFile ~/.ssh/server</span><br><span class="line"></span><br><span class="line">    # 启用 SSH 多路复用: 允许复用现有的 SSH 连接, 无需每次重新认证</span><br><span class="line">    ControlMaster auto</span><br><span class="line">    # 指定控制套接字存储路径, 可使用 /tmp 或用户目录下的子文件夹 (如 ~/.ssh/session)</span><br><span class="line">    ControlPath /tmp/%r@%h:%p</span><br><span class="line"></span><br><span class="line">    # 即使没有活动会话, 主连接仍保持最多 4 小时</span><br><span class="line">    ControlPersist 4h</span><br><span class="line"></span><br><span class="line">    # 启用 SSH 数据压缩, 尤其适合低带宽网络</span><br><span class="line">    Compression yes</span><br><span class="line"></span><br><span class="line">    # 心跳包设置: 防止连接因空闲超时被断开</span><br><span class="line">    ServerAliveInterval 60  # 每 60 秒发送一次心跳包</span><br><span class="line">    ServerAliveCountMax 5   # 心跳失败超过 5 次后断开连接</span><br></pre></td></tr></tbody></table></figure><h4 id="SSH-端口转发"><a href="#SSH-端口转发" class="headerlink" title="SSH 端口转发"></a>SSH 端口转发</h4><p>经常使用到 SSH 且会用到端口转发功能, 这里仅做个记录.</p><h5 id="1-本地转发"><a href="#1-本地转发" class="headerlink" title="1. 本地转发"></a>1. 本地转发</h5><p>本地转发是一种通过 SSH 创建的隧道, 它允许你将本机的某个端口上的通信, 通过 SSH 服务器转发到另一台远程服务器的指定端口. 在这个过程中, SSH 服务器充当了一个中继的角色, 使得本地计算机能够访问那些它原本无法直接连接的远程服务. <strong>本地转发是在本地机器上设置转发规则</strong>.</p><p>语法如下, 其中会指定本地端口 (local-port) 、SSH 服务器 (tunnel-host) 、远程服务器 (target-host) 和远程端口 (target-port) .</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -N -f -L local-port:target-host:target-port username@tunnel-host</span><br></pre></td></tr></tbody></table></figure><p>上面命令中, 有三个配置参数.</p><p><code>-L</code>: 转发本地端口.</p><p><code>-N</code>: 不发送任何命令, 只用来建立连接. 没有这个参数, 会在 SSH 服务器打开一个 Shell.</p><p><code>-f</code>: 将 SSH 连接放到后台. 没有这个参数, 暂时不用 SSH 连接时, 终端会失去响应.</p><p>假设本地开发机只能访问跳板机(<code>192.168.31.x</code>) 网络, 且跳板机因为多网卡能够访问 <code>192.168.21.x</code> 网络, 拓扑图如下:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/SSH-LocalForward.drawio.svg" alt="SSH-LocalForward.drawio.svg"></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在本地开发机上执行</span></span><br><span class="line">ssh -N -f -L 9876:192.168.21.10:9876 root@192.168.31.33</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭本地端口转发</span></span><br><span class="line">ssh -O cancel -L 9876:192.168.21.10:9876 root@192.168.31.33</span><br></pre></td></tr></tbody></table></figure><p>同时可以配置 <code>.ssh/config</code> 实现:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Host lddns</span><br><span class="line">    HostName 192.168.31.33</span><br><span class="line">    User root</span><br><span class="line">    Port 22</span><br><span class="line">    IdentityFile ~/.ssh/server</span><br><span class="line">    # LocalForward client-IP:client-port target-host:target-port</span><br><span class="line">    LocalForward 9876 192.168.21.10:9876</span><br></pre></td></tr></tbody></table></figure><p>当在本地机器上访问 localhost:9876 时, SSH 会将流量通过 <strong>加密的 SSH 连接</strong> 转发到远程服务器 192.168.21.10 的 9876 端口.</p><p>这里的 <strong>加密的 SSH 连接</strong> 是指 <code>192.168.31.33</code> SSH 连接通道.</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_9jBdqLcR.webp" alt="20241229154732_9jBdqLcR.webp"></p><p><strong>使用场景</strong>:</p><ul><li><strong>远程数据库访问</strong>: 将本地的 3306 端口映射到远程服务器的 3306 端口, 这样就可以使用本地的数据库管理工具访问远程数据库.</li><li><strong>Web 服务访问</strong>: 如果你正在远程服务器上开发 Web 应用, 并且需要从本地机器访问这个应用, 可以通过本地转发将远程服务器的端口映射到本地计算机的某个端口.</li><li><strong>VPN 替代方案</strong>: 当你无法使用 VPN 时, 可以通过 SSH 本地转发来安全地访问远程网络中的资源.</li></ul><h5 id="2-远程转发"><a href="#2-远程转发" class="headerlink" title="2. 远程转发"></a>2. 远程转发</h5><p>远程转发指的是在远程 SSH 服务器建立的转发规则.</p><p>它跟本地转发正好反过来. 建立本地计算机到远程 SSH 服务器的隧道以后, 本地转发是通过本地计算机访问远程 SSH 服务器, 而远程转发则是通过远程 SSH 服务器访问本地计算机. 它的命令格式如下.</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ssh -R remote-port:target-host:target-port -N remotehost</span></span><br></pre></td></tr></tbody></table></figure><p>上面命令中, <code>-R</code> 参数表示远程端口转发, <code>remote-port</code> 是远程 SSH 服务器的端口, <code>target-host</code> 和 <code>target-port</code> 是目标服务器及其端口, <code>remotehost</code>是远程 SSH 服务器.</p><p>远程转发主要针对内网的情况. 下面举两个例子.</p><p>第一个例子是内网某台服务器 <code>localhost</code> 在 80 端口开了一个服务, 可以通过远程转发将这个 80 端口, 映射到具有公网 IP 地址的 <code>my.public.server</code> 服务器的 8080 端口, 使得访问 <code>my.public.server:8080</code> 这个地址, 就可以访问到那台内网服务器的 80 端口.</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ssh -R 8080:localhost:80 -N my.public.server</span></span><br></pre></td></tr></tbody></table></figure><p>上面命令是在内网 <code>localhost</code> 服务器上执行, 建立从 <code>localhost</code> 到 <code>my.public.server</code> 的 SSH 隧道. 运行以后, 用户访问 <code>my.public.server:8080</code>, 就会自动映射到 <code>localhost:80</code>.</p><p>第二个例子是本地计算机 <code>local</code> 在外网, SSH 跳板机和目标服务器 <code>my.private.server</code>都在内网, 必须通过 SSH 跳板机才能访问目标服务器. 但是, 本地计算机 <code>local</code> 无法访问内网之中的 SSH 跳板机, 而 SSH 跳板机可以访问本机计算机.</p><p>由于本机无法访问内网 SSH 跳板机, 就无法从外网发起 SSH 隧道, 建立端口转发. 必须反过来, 从 SSH 跳板机发起隧道, 建立端口转发, 这时就形成了远程端口转发. 跳板机执行下面的命令, 绑定本地计算机 <code>local</code> 的 <code>2121</code> 端口, 去访问 <code>my.private.server:80</code>.</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ssh -R 2121:my.private.server:80 -N <span class="built_in">local</span></span></span><br></pre></td></tr></tbody></table></figure><p>上面命令是在 SSH 跳板机上执行的, 建立跳板机到 <code>local</code> 的隧道, 并且这条隧道的出口映射到 <code>my.private.server:80</code>.</p><p>显然, 远程转发要求本地计算机 <code>local</code> 也安装了 SSH 服务器, 这样才能接受 SSH 跳板机的远程登录.</p><p>执行上面的命令以后, 跳板机到 <code>local</code> 的隧道已经建立了. 然后, 就可以从本地计算机访问目标服务器了, 即在本机执行下面的命令.</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl http://localhost:2121</span></span><br></pre></td></tr></tbody></table></figure><p>本机执行上面的命令以后, 就会输出服务器 <code>my.private.server</code> 的 80 端口返回的内容.</p><p><strong>示例</strong>:</p><p>假设本地开发机(<code>192.168.31.8</code>)不能访问跳板机(<code>192.168.31.x</code>) 网络, 但是跳板机可以访问本地开发机, 且跳板机因为多网卡能够访问 <code>192.168.21.x</code> 网络,</p><p>这时本地开发机想访问 <code>192.168.21.10:9876</code> 服务.</p><p>拓扑图如下:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/SSH-RemoteForward.drawio.svg" alt="SSH-RemoteForward.drawio.svg"></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在跳板机上执行</span></span><br><span class="line">ssh -R 1111:192.168.21.10:9876 -N dong4j@192.168.31.8</span><br></pre></td></tr></tbody></table></figure><p>同时可以配置 <code>.ssh/config</code> 实现:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Host rddns</span><br><span class="line">    HostName 192.168.31.8</span><br><span class="line">    User dong4j</span><br><span class="line">    Port 22</span><br><span class="line">    # RemoteForward remote-port target-host:target-port</span><br><span class="line">    RemoteForward 1111 192.168.21.10:9876</span><br></pre></td></tr></tbody></table></figure><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_uDiQ0P2q.webp" alt="20241229154732_uDiQ0P2q.webp"></p><p><strong>使用场景</strong>:</p><ul><li>将还在公司加班的你本机上的 API 暴露到公网, 在家的同事就能和你愉快的调试接口了;</li><li>你本地的软路由具备分流能力, 你兄弟需要临时用一下查阅点学习资料;</li></ul><h5 id="3-动态转发"><a href="#3-动态转发" class="headerlink" title="3. 动态转发"></a>3. 动态转发</h5><p>动态转发指的是, 本机与 SSH 服务器之间创建了一个加密连接, 然后本机内部针对某个端口的通信, 都通过这个加密连接转发. 它的一个使用场景就是, 访问所有外部网站, 都通过 SSH 转发.</p><p>动态转发需要把本地端口绑定到 SSH 服务器. 至于 SSH 服务器要去访问哪一个网站, 完全是动态的, 取决于原始通信, 所以叫做动态转发.</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ssh -D local-port tunnel-host -N</span></span><br></pre></td></tr></tbody></table></figure><p>上面命令中, <code>-D</code>表示动态转发, <code>local-port</code>是本地端口, <code>tunnel-host</code>是 SSH 服务器, <code>-N</code>表示这个 SSH 连接只进行端口转发, 不登录远程 Shell, 不能执行远程命令, 只能充当隧道.</p><p>举例来说, 如果本地端口是 <code>2121</code>, 那么动态转发的命令就是下面这样.</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ssh -D 2121 tunnel-host -N</span></span><br></pre></td></tr></tbody></table></figure><p>注意, 这种转发采用了 SOCKS5 协议. 访问外部网站时, 需要把 HTTP 请求转成 SOCKS5 协议, 才能把本地端口的请求转发出去.</p><p>下面是 SSH 隧道建立后的一个使用实例.</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -x socks5://localhost:2121 http://www.example.com</span></span><br></pre></td></tr></tbody></table></figure><p>上面命令中, curl 的 <code>-x</code> 参数指定代理服务器, 即通过 SOCKS5 协议的本地 <code>2121</code> 端口, 访问 <code>http://www.example.com</code>.</p><p><strong>示例</strong>:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -D 1234 intel -N</span><br><span class="line">curl -x socks5://localhost:1234 https://google.hk</span><br></pre></td></tr></tbody></table></figure><p>在 Mac mini 2018 上可以看到请求:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_SFzeDyB8.webp" alt="20241229154732_SFzeDyB8.webp"></p><h4 id="SSH-跳板机"><a href="#SSH-跳板机" class="headerlink" title="SSH 跳板机"></a>SSH 跳板机</h4><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">跳板机</span></span><br><span class="line">Host tjump</span><br><span class="line">    HostName 公网 ip</span><br><span class="line">    User {username}</span><br><span class="line">    Port {port}</span><br><span class="line"></span><br><span class="line">Host nas</span><br><span class="line">    HostName 192.168.1.20</span><br><span class="line">    User {username}</span><br><span class="line">    Port {port}</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过跳板登录到 192.168.1.20</span></span><br><span class="line">Host jnas</span><br><span class="line">    HostName 192.168.1.20</span><br><span class="line">    User {username}</span><br><span class="line">    Port {port}</span><br><span class="line">    ProxyJump tjump</span><br></pre></td></tr></tbody></table></figure><p>使用方式:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh jnas</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">或者</span></span><br><span class="line">ssh -J tjump nas</span><br></pre></td></tr></tbody></table></figure><h4 id="SSH-两级跳板"><a href="#SSH-两级跳板" class="headerlink" title="SSH 两级跳板"></a>SSH 两级跳板</h4><p>首先, 我们需要在本机设置第一级 SSH 隧道. 执行以下命令:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh -L 1999:localhost:2999 tunnel1-host</span><br></pre></td></tr></tbody></table></figure><p>这条命令的作用是, 在本地机器上监听 <code>1999</code> 端口, 并将所有发往这个端口的请求, 通过 SSH 隧道转发到 <code>tunnel1-host</code> 这台机器的 <code>2999</code> 端口.<br>接下来, 在第一台跳板机 (<code>tunnel1-host</code>) 上, 我们需要建立第二级 SSH 隧道. 执行以下命令:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh -L 2999:target-host:3999 tunnel2-host -N</span><br></pre></td></tr></tbody></table></figure><p>这条命令的含义是, 将 <code>tunnel1-host</code> 上的 <code>2999</code> 端口通过 SSH 隧道连接到 <code>tunnel2-host</code>, 然后再由 <code>tunnel2-host</code> 转发到目标服务器 <code>target-host</code> 的 <code>3999</code> 端口.<br>这样设置后, 当我们访问本机的 <code>1999</code> 端口时, 请求实际上会被转发到 <code>target-host</code> 的 <code>3999</code> 端口.</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/SSH-multi-stage.drawio.svg" alt="SSH-multi-stage.drawio.svg"></p><p><strong>应用场景</strong>:<br>这种多级端口转发的设置常用于以下情况:</p><ol><li>访问内网服务器: 当目标服务器位于多层内网中, 直接访问受限时, 可以通过多级跳板机进行访问.</li><li>安全加固: 通过多级跳板机, 增加攻击者入侵的难度, 提高系统的安全性.</li><li>网络隔离: 在需要隔离不同网络环境的情况下, 通过跳板机实现数据的传输.</li></ol><h4 id="SSH-集中管理"><a href="#SSH-集中管理" class="headerlink" title="SSH 集中管理"></a>SSH 集中管理</h4><p>iTerm2 通过 <code>Profiles</code> 来管理多个服务器(使用 <code>⌘ + O</code> 打开服务器列表), 但是并没有分组功能, 管理多个服务器不是特别方便.</p><p>这里有一些比较热门的终端管理工具:</p><ul><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly90ZXJtaXVzLmNvbS8=">Termius</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly93d3cud2FycC5kZXYv">Warp</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly90YWJieS5zaC8=">Tabby</a></li></ul><p>目前我使用的是 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9yb3lhbGFwcHMuY29tL3RzL21hYy9mZWF0dXJlcw==">Royal TSX</a>, 目前觉得完全满足我的大部分需求, 且部分特性还能带来一些小惊喜:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_qJtszN5c.webp" alt="20241229154732_qJtszN5c.webp"></p><p><strong>Royal TSX</strong> 中的 <code>document</code> 概念是将所有被管理的 SSH 服务器集中持久化成一个文件(因为这个文件会存在服务器连接信息, 所以还支持加密), 我可以将这个文件通过 Synology Drive 同步到其他 Mac 上, 这就可以实现 <code>一次配置, 到处使用</code>;</p><p>另外像端口映射, 安全网关, 密钥管理等这些常规功能全部支持. 另外比较惊喜的就是 <strong>Royal TSX</strong> 能通过插件机制支持 <strong>Web</strong>, <strong>RDP</strong>, <strong>VNC</strong> 等远程管理功能:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_qPkpKpIh.webp" alt="20241229154732_qPkpKpIh.webp"></p><p>你一个比较惊喜的功能就是: <code>Broadcast Input to all Terminal Sessions</code>, 开启多个窗口, 在一台服务器上的操作会同步输出到其他服务器, 这个可以大大简化服务器的配置工作.</p><p><strong>简洁的 SSH 转发设置</strong>:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_Y4Nd46Ht.webp" alt="20241229154732_Y4Nd46Ht.webp"></p><p><strong>串口连接</strong>:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_wjJjhY4o.webp" alt="20241229154732_wjJjhY4o.webp"></p><p>但是 <strong>Royal TSX</strong> 也有它的不足, 比如 <strong>文件管理不方便</strong>, RDP 连接分辨率无法动态适配等, 所以我使用了另一款工具: <strong>XTerminal</strong>, 它的优点是文件管理和系统监控, 亮点是基于 AI 的命令行提示.</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_ge0CQUf1.webp" alt="20241229154732_ge0CQUf1.webp"></p><ul><li>双击文件即可直接编辑文件</li><li>可拖拽上传下载文件</li><li>服务器监控面板</li></ul><p><strong>AI 功能</strong>:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_SEqIOKAz.webp" alt="20241229154732_SEqIOKAz.webp"></p><p><strong>可视化的 SSH 端口转发配置</strong>:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_bduEnWfP.webp" alt="20241229154732_bduEnWfP.webp"></p><hr><h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZi1jay1uZWVkLXUvcC8xMDQ4NDUzMS5odG1s">ssh 转发代理：ssh-agent 用法详解</a>: 避免重复输入 passphrase</li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9paG93ZXIudHcvYmxvZy9hcmNoaXZlcy83ODM3">SSH agent forwarding 的應用</a>: 在远程主机上使用本地的 ssh-agent 进行认证，比如在远程主机上进行 <code>git</code> 操作、<code>ssh</code> 到另一台主机等，避免将私钥 copy 到远程主机上。</li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9ibG9nLmxvbmd3aW4uY29tLnR3LzIwMTQvMTAvc3NoLWdvb2dsZS0yLWZhY3Rvci1hdXRoZW50aWNhdGlvbi0yMDE0Lw==">How to Set Up SSH 2fa (Two-Factor Authentication)</a>: 在 openssh server 上配置强制进行 2FA 双因素认证，每次登录都需要输入 Google Authenticator APP 提供的一次性动态密码。</li></ul><h3 id="RDP"><a href="#RDP" class="headerlink" title="RDP"></a>RDP</h3><p>上述 2 款工具都不能很好的支持完美的 RDP 远程桌面, 所有我使用了 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9hcHBzLmFwcGxlLmNvbS91cy9hcHAvd2luZG93cy1hcHAvaWQxMjk1MjAzNDY2P210PTEy">Microsoft Remote Desktop</a>,</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_mkDD0p2E.webp" alt="20241229154732_mkDD0p2E.webp"></p><details class="folding-tag"><summary>如何删除 thinclient_drives</summary><div class="content"><p><strong>ubuntu</strong>上安装 <strong>xrdp</strong> 搭建远程桌面, 后面远程桌面是可以了, 但是用户目录下生出了一个 thinclient_drives 文件夹, <strong>无论是不是 root 都不能删除</strong>, 如果你有强迫症, 你就感觉不舒服, 一定要删除, 下面介绍如何删除:</p><p>打开并修改 /etc/xrdp/sesman.ini 文件</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/xrdp/sesman.ini</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将 FuseMountName=thinclient_drives 修改为 FuseMountName=.xrdp/thinclient_drives</span></span><br></pre></td></tr></tbody></table></figure><p>由于 ~/.xrdp 目录不存在, 所以不会创建 <strong>thinclient_drives</strong> 文件夹.</p><p>也可以将 <strong>thinclient_drives</strong> 放到 /run 目录下:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FuseMountName=/run/user/%u/thinclient_drives</span><br></pre></td></tr></tbody></table></figure><p>然后删除 <strong>thinclient_drives</strong> 文件夹</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo umount thinclient_drives</span><br><span class="line">sudo rm -rf thinclient_drives</span><br></pre></td></tr></tbody></table></figure><p>以后重新登陆也不会再出现 <strong>thinclient_drives</strong>, 并且远程连接共享剪贴板仍然有效.</p></div></details><h3 id="VNC"><a href="#VNC" class="headerlink" title="VNC"></a>VNC</h3><p>如果只是连接 macOS 的话, 官方的 <strong>屏幕共享.app</strong> 更值得推荐.</p><p>因为 <strong>屏幕共享.app</strong> 无法连接到树莓派, 所以使用 <strong>RDP</strong> 或 <strong>VNC Viewer</strong>.</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_CI6WwtAR.webp" alt="20241229154732_CI6WwtAR.webp"></p><details class="folding-tag"><summary>🪬 Ubuntu 远程桌面每次重启后 VNC 密码改变的解决方式</summary><div class="content"><p><strong>问题描述</strong>:</p><ul><li>VNC 服务器在启动时如果密钥环未解锁, 将无法访问存储的加密 VNC 密码.</li><li>结果是, <strong>每次 VNC 服务器启动时</strong>, 都会自动生成一个新的密码.</li></ul><p><strong>问题原因</strong>:</p><ul><li>Ubuntu 22.04 在自动启动期间不会自动解锁密钥环, 这影响了 VNC 服务器的正常使用.</li></ul><p><strong>解决方案</strong>:</p><ol><li>打开“密码和密钥”实用工具:<ul><li>转到<strong>实用工具</strong>菜单, 选择<strong>密码和密钥</strong>.</li></ul></li><li>修改默认密钥环的密码:<ul><li>在<strong>密码和密钥</strong>管理器中, 右键单击<strong>默认密钥环</strong>.</li><li>选择<strong>更改密码</strong>.</li></ul></li><li>输入并确认操作:<ul><li>系统将要求您输入当前的用户名密码.</li><li>在<strong>新密码</strong>和<strong>确认密码</strong>字段中, 不要输入任何内容, 保持空白.</li></ul></li><li>接受风险警告:<ul><li>系统会警告您, 密钥环上存储的所有密码将不再加密, 并将保持未加密状态.</li><li>如果您能够接受这个安全风险, 确认更改.</li></ul></li></ol><p>通过以上步骤, 可以解决 Ubuntu 22.04 中 VNC 服务器在自动启动时无法访问加密密码的问题. 但是这样做会降低密码的安全性, 因此可以采用下面推荐的方式.</p><p><strong>推荐的方式</strong>:</p><p>在<strong>密码和密钥</strong>应用程序中执行以下操作:</p><ol><li><strong>创建一个新的无密码密钥环</strong>:<ul><li>打开<strong>密码和密钥</strong>应用程序.</li><li>创建一个新的密钥环, 并在创建过程中不设置密码.</li><li>将这个新的无密码密钥环设置为默认.</li></ul></li><li><strong>从登录密钥环中删除 VNC 密码</strong>:<ul><li>在<strong>密码和密钥</strong>应用程序中, 找到登录密钥环.</li><li>删除存储在登录密钥环中的 VNC 密码.</li></ul></li><li><strong>重新启动计算机</strong>:<ul><li>重启计算机以确保新的无密码密钥环成为默认密钥环.</li></ul></li></ol><p>重启后, 执行以下步骤:</p><ol><li><strong>重新输入 VNC 密码</strong>:<ul><li>在屏幕共享设置中重新输入 VNC 密码.</li><li>这将把 VNC 密码存储在新的不安全密钥环中.</li></ul></li><li><strong>恢复登录密钥环为默认</strong>:<ul><li>回到<strong>密码和密钥</strong>应用程序.</li><li>将登录密钥环重新设置为默认密钥环.</li></ul></li><li><strong>再次重新启动计算机</strong>:</li></ol><p>现在 VNC 密码保持保存, 而默认密钥环也恢复为登录密钥环.</p><p>这种方法将所有密码保存为纯文本的不安全性降低到仅将 VNC 密码保存为纯文本.</p></div></details><hr><h2 id="暴露服务到公网"><a href="#暴露服务到公网" class="headerlink" title="暴露服务到公网"></a>暴露服务到公网</h2><h3 id="关于-IPv4"><a href="#关于-IPv4" class="headerlink" title="关于 IPv4"></a>关于 IPv4</h3><p>截至 2024 年, IPv4 地址已经全球接近耗尽. 自 2011 年正式宣布 IPv4 地址枯竭以来, IPv4 地址池的可用数量持续减少, 导致剩余的地址在二级市场上的价格不断上涨 .</p><p>IPv4 使用 32 位地址空间, 可以提供超过 40 亿个唯一地址. 然而, 随着互联网连接设备数量的激增, 这一地址池已经被耗尽. 北美、亚洲和欧洲是剩余 IPv4 地址的主要持有地区, 其他地区的 IPv4 地址资源相对匮乏 .</p><p>由于 IPv4 地址短缺, 许多组织和网络运营商开始依赖 NAT (网络地址转换) 技术, 允许多个设备共享一个公共 IP 地址. 此外, IPv6 的推广也成为解决 IPv4 地址耗尽问题的重要手段, 但由于兼容性问题以及过渡成本较高, IPv6 的部署进展较慢 .</p><p>目前, IPv4 地址的租赁和转售成为一种常见的做法, 尤其是在面临 IPv4 地址匮乏的企业中. 尽管如此, 这种做法仅是临时性的解决方案, 而 IPv6 的普及正在变得愈加迫切 .</p><h3 id="为什么使用-DDNS"><a href="#为什么使用-DDNS" class="headerlink" title="为什么使用 DDNS"></a>为什么使用 DDNS</h3><p>我早期申请的电信和联通的公网 IP 都是动态的, 会被运营商不定期的修改, 为了避免因公网 IP 变更无法访问家中的服务的问题, 现在最常用的方案就是使用 DDNS 服务.</p><h3 id="什么是-DDNS"><a href="#什么是-DDNS" class="headerlink" title="什么是 DDNS"></a>什么是 DDNS</h3><p>动态 DNS (DDNS) 是一项在 IP 地址发生变化时可以自动更新 DNS 记录的服务. 域名将网络 IP 地址转换为人类可读的名称, 便于识别和使用. 将名称映射到 IP 地址的信息以表格形式记录在 DNS 服务器上. 但是, 网络管理员会动态分配 IP 地址并经常更改. 每当 IP 地址发生变化时, DDNS 服务都会更新 DNS 服务器记录. 借助 DDNS, 域名管理变得更容易、更高效.</p><h3 id="动态-DNS-是如何工作的"><a href="#动态-DNS-是如何工作的" class="headerlink" title="动态 DNS 是如何工作的"></a>动态 DNS 是如何工作的</h3><p>以下是一般步骤:</p><ol><li>向动态 DNS 服务提供商注册域名并配置 DNS 设置</li><li>向提供商提供域名的初始 IP 地址</li><li>使用更改的 IP 地址在设备或服务器实例上安装动态 DNS 客户端</li></ol><p>DDNS 客户端持续监控 IP 地址并检测任何更改. 客户端向动态 DNS 提供商发送 DNS 记录更新通知, 通知其新的 IP 地址. 动态 DNS 提供商修改记录以指向新 IP 地址.</p><p>动态 DNS 客户端会继续监控 IP 地址以了解进一步的更改. 每当发生新的更改时, 该过程都会重复.</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_h5KgUa28.webp" alt="20241229154732_h5KgUa28.webp"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_G1yaNntU.webp" alt="20241229154732_G1yaNntU.webp"></p><p>简单来说, 宽带运营商只会给我们动态的公网 IP, 这个 IP 会不定时变化, 为了能使域名映射到正确的 IP 上, 需要借助 DDNS 将当前最新的 IP 通过 API 通知到 DNS 服务运营商以修改为最新的 IP.</p><p>我所使用的域名服务商分别是阿里云和腾讯云, 为了正常使用 DDNS 服务, 需要到对应的域名运营商申请 API key, 后面使用 ddns-go 会用到.</p><h3 id="DDNS-服务配置"><a href="#DDNS-服务配置" class="headerlink" title="DDNS 服务配置"></a>DDNS 服务配置</h3><p>我目前的设备自带了 DDNS 服务的有:</p><ul><li>Synology NAS: <code>外部访问-DDNS</code></li><li>R2S 这类 OpenWrt 系统: <code>服务-阿里云 DDNS</code> 和 <code>服务-动态 DNS</code></li></ul><p>但是我并没有直接使用上述的服务, 而是选择使用 docker-compose 部署 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL2plZXNzeTIvZGRucy1nbw==">ddns-go</a>, 这样可以方便的同步配置以便快速在其他设备上部署.</p><h4 id="dons-go-遇到的坑"><a href="#dons-go-遇到的坑" class="headerlink" title="dons-go 遇到的坑"></a>dons-go 遇到的坑</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_zetykBpn.webp" alt="20241229154732_zetykBpn.webp"></p><ol><li><p>TTL 设置错误导致 API 调用失败</p><p>DNS 运营商的 TTL 一般都是 600 秒, 再快就得加钱了, ddns-go 最好设置为自动, 避免 API 调用失败.</p></li><li><p>通过接口获取 IPv4 太频繁被限流</p><p>ddns-go 自带了几个用于获取 IPv4 的 API 服务, 但是因为 ddns-go 频繁调用被 API 接口服务商限流;</p></li><li><p>通过接口获取的 IPv4 错误</p><p>这是因为部署 ddns-go 的设备同时部署了分流服务, 需要修改分流规则, 我采用第二种方式: 不使用接口获取;</p></li><li><p>通过网卡获取</p><p>这种方式只能获取到局域网 IP, 适用于 IPv6;</p></li><li><p>通过命令获取</p><p>最终采用这种方式, 且返回 IPv4 地址的服务通过 Nginx 在云服务器自建了一个, 获取 IPv4 的命令如下:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --interface 网卡名 url</span><br></pre></td></tr></tbody></table></figure><p>这种方式需要处理多网卡的情况, 因此需要 <code>--interface</code> 参数.</p></li><li><p>通过网卡获取 IPv6</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_oi7eabiD.webp" alt="20241229154732_oi7eabiD.webp"></p><p>IPv6 一般会有多个地址, 需要通过正则表达式筛选</p><blockquote><p>电信为 240e 开头 (240e::/20)</p><p>移动为 2409 开头 (2409:8000::/20)</p><p>联通为 2408 开头 (2408:8000::/20)</p></blockquote></li><li><p>ddns-go 启动前 10 分钟(具体几分钟记不得了, 反正越快越好)才能设置账号密码</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_XIzLrwv2.webp" alt="20241229154732_XIzLrwv2.webp"></p></li></ol><p>最好禁用公网访问, 这样只能通过局域网 IP 访问.</p><ol start="8"><li><p>ddns-go 可以配置 IP 变更通知, 我使用的是 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9iYXJrLmRheS5hcHAvIy8=">bark</a> 服务, 全平台可用, 且服务也能自托管:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_7ajHZeNd.webp" alt="20241229154732_7ajHZeNd.webp"></p></li></ol><h4 id="自建获取公网-IP-服务"><a href="#自建获取公网-IP-服务" class="headerlink" title="自建获取公网 IP 服务"></a>自建获取公网 IP 服务</h4><p>我的目的很简单, 就是专为 ddns-go 提供的 IP 查询服务, 因此没有加 HTTPS 证书, 云服务器安装 Nginx 并添加配置, 关键的配置如下(记得在安全组开端口):</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server {</span><br><span class="line">    listen 端口号;</span><br><span class="line">    listen [::]:端口号 ipv6only=on;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    server_tokens off;</span><br><span class="line"></span><br><span class="line">    location = /ip {</span><br><span class="line">        add_header Content-Type text/plain;</span><br><span class="line">        access_log off;</span><br><span class="line">        return 200 "$remote_addr\n";</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>访问 <code>http://ip:port/ip</code> 即可返回文本格式的公网 IP.</p><p>如果想自行部署, 可参考 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8yMjg2Mzk1">利用 Nginx 实现简易的公网 IP 查询</a>.</p><h4 id="获取正确的-IPv4"><a href="#获取正确的-IPv4" class="headerlink" title="获取正确的 IPv4"></a>获取正确的 IPv4</h4><p>因为我有 2 个公网 IP, 域名分别对应不同的 DNS 服务商:</p><table><thead><tr><th>宽带运营商</th><th>域名服务商</th><th>域名(假设)</th><th>路由器 IP</th></tr></thead><tbody><tr><td>电信</td><td>阿里云</td><td>dong4j.tele</td><td>192.168.31.1</td></tr><tr><td>联通</td><td>腾讯云</td><td>dong4j.unic</td><td>192.168.21.1</td></tr></tbody></table><h4 id="对于单网卡"><a href="#对于单网卡" class="headerlink" title="对于单网卡"></a>对于单网卡</h4><p>比如当前设备是 <code>192.168.31.1</code> 这台路由器下的子设备, 按照上述表格, 应该获取到电信的公网 IP 并通知到阿里云的 DNS 已将 dong4j.tele 映射到正确的 IP 上.</p><h4 id="对于多网卡"><a href="#对于多网卡" class="headerlink" title="对于多网卡"></a>对于多网卡</h4><p>为避免单点问题, 我同时在 M920x, DS218+和 DS923+ 上部署了 ddns-go 服务, 它们同时具备多张网卡.</p><p>运行 <code>route -n</code> 显示的路由表如下:</p><table><thead><tr><th>目标</th><th>网关</th><th>子网掩码</th><th>标志</th><th>跃点</th><th>引用</th><th>使用</th><th>接口</th></tr></thead><tbody><tr><td>0.0.0.0</td><td>192.168.21.1</td><td>0.0.0.0</td><td>UG</td><td>100</td><td>0</td><td>0</td><td>enx00e04c680012</td></tr><tr><td>0.0.0.0</td><td>192.168.31.1</td><td>0.0.0.0</td><td>UG</td><td>103</td><td>0</td><td>0</td><td>eno1</td></tr></tbody></table><p><strong>表头字段解析</strong></p><ul><li><strong>目标 (Destination)</strong>: 指向的目标网络或主机地址. <code>0.0.0.0</code> 表示默认路由, 适用于所有未匹配其他路由的流量.</li><li><strong>网关 (Gateway)</strong>: 数据流量需要通过的下一跳 IP. 如果为 <code>0.0.0.0</code>, 表示目标为直连网络, 第一行是 <code>192.168.21.1</code>, 表示经过联通路由器.</li><li><strong>子网掩码 (Genmask)</strong>: 定义目标网络的范围.</li><li><strong>标志 (Flags)</strong>:<ul><li><code>U</code>: 路由是活动的.</li><li><code>G</code>: 流量需要通过网关.</li></ul></li><li><strong>跃点 (Metric)</strong>: 优先级, 数值越小优先级越高 (<strong>后面修改网卡优先级也就是修改这个值</strong>).</li><li><strong>引用 (Ref)</strong>: 保留字段, 通常为 <code>0</code>.</li><li><strong>使用 (Use)</strong>: 该路由表条目被命中的次数.</li><li><strong>接口 (Iface)</strong>: 数据流量通过的网络接口.</li></ul><p><strong>路由表内容分析</strong></p><p><strong>第一行</strong></p><table><thead><tr><th>目标</th><th>网关</th><th>子网掩码</th><th>标志</th><th>跃点</th><th>引用</th></tr></thead><tbody><tr><td>0.0.0.0</td><td>192.168.21.1</td><td>0.0.0.0</td><td>UG</td><td>100</td><td>0</td></tr></tbody></table><ul><li><strong>默认路由</strong>: 匹配所有流量.</li><li><strong>网关</strong>: <code>192.168.21.1</code>.</li><li><strong>接口</strong>: <code>enx00e04c680012</code>.</li><li><strong>跃点</strong>: <code>100</code>, 优先级高于第二行.</li></ul><p><strong>第二行</strong></p><table><thead><tr><th>目标</th><th>网关</th><th>子网掩码</th><th>标志</th><th>跃点</th><th>引用</th></tr></thead><tbody><tr><td>0.0.0.0</td><td>192.168.31.1</td><td>0.0.0.0</td><td>UG</td><td>103</td><td>0</td></tr></tbody></table><ul><li><strong>默认路由</strong>: 同样匹配所有流量.</li><li><strong>网关</strong>: <code>192.168.31.1</code>.</li><li><strong>接口</strong>: <code>eno1</code>.</li><li><strong>跃点</strong>: <code>103</code>, 优先级低于第一行.</li></ul><p><strong>总结</strong></p><ol><li><strong>多默认路由</strong>: 两条默认路由同时存在, 系统会优先使用跃点较低的路由 (即 <code>192.168.21.1</code>) .</li><li><strong>故障转移</strong>: 如果优先路由 (<code>192.168.21.1</code>) 不可用, 系统会自动尝试使用优先级较低的路由 (<code>192.168.31.1</code>) .</li></ol><p>第一行跃点为 <code>100</code>, 且网关为 <code>192.168.21.1</code>, 表示 M920x 会优先使用 <code>enx00e04c680012</code> 这张网卡走联通网络.</p><p>同理我们整理一张表格:</p><table><thead><tr><th>服务器</th><th>第一优先级</th><th>第二优先级</th></tr></thead><tbody><tr><td>M920x</td><td><strong>enx00e04c680012</strong> (<strong>联通</strong>)</td><td>eno1 (电信)</td></tr><tr><td>DS218+</td><td><strong>ovs_eth1</strong>(<strong>电信</strong>)</td><td>ovs_eth0(联通)</td></tr><tr><td>DS923+</td><td><strong>ovs_eth2</strong>(<strong>联通</strong>)</td><td>ovs_bond0(电信)</td></tr></tbody></table><p>为了保证 ddns-go 获取正确的 IPv4 地址, 应该这样配置:</p><table><thead><tr><th>ddns-go 所在的服务器</th><th>电信公网 IP (Domains: <code>*.dong4j.tele</code>)</th><th>联通公网 IP (Domains: <code>*.dong4j.unic</code>)</th></tr></thead><tbody><tr><td>M920x</td><td><code>curl --interface eno1 http://ip:port/ip</code></td><td><code>curl --interface enx00e04c680012 http://ip:port/ip</code></td></tr><tr><td>DS218+</td><td><code>curl --interface ovs_eth1 http://ip:port/ip</code></td><td><code>curl --interface ovs_eth0 http://ip:port/ip</code></td></tr><tr><td>DS923+</td><td><code>curl --interface ovs_bond0 http://ip:port/ip</code></td><td><code>curl --interface ovs_eth2 http://ip:port/ip</code></td></tr></tbody></table><ul><li><code>http://ip:port/ip</code> 是前面说的自建的获取公网 IP 的服务;</li><li>一定要注意第一优先级的网卡对应的是哪个路由器以及路由器对应的宽带服务商;</li></ul><h3 id="泛解析"><a href="#泛解析" class="headerlink" title="泛解析"></a>泛解析</h3><p>前面通过使用 **DDNS (动态域名解析服务) **, 我们将动态公网 IP 与一个泛域名 (例如 <code>*.dong4j.tele</code>) 绑定. 这样一来:</p><ol><li><p><strong>所有三级域名共享同一 IP 地址</strong>:</p><ul><li>泛域名的配置意味着 <code>nas.dong4j.tele</code>、<code>blog.dong4j.tele</code>、<code>api.dong4j.tele</code> 等三级域名都会指向同一个动态公网 IP.</li><li>无需为每个子服务单独创建域名解析记录.</li></ul></li><li><p><strong>减少管理工作</strong>:</p><ul><li>当公网 IP 变化时, DDNS 会自动更新与该 IP 关联的域名解析.</li><li>无需手动更新每个子域名的记录, 提高了效率和维护便利性.</li></ul></li><li><p><strong>便于扩展和服务管理</strong>:</p><ul><li>不同的三级域名可以被路由到不同的内部服务或设备 (如 Web、FTP、SSH 等) .</li><li>实现灵活的服务部署, 而不增加域名管理的复杂性.</li></ul></li></ol><h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><p>假设公网 IP 动态变化且通过 DDNS 绑定到了泛域名 <code>*.dong4j.tele</code>, 以下请求都能被正确路由:</p><ul><li><code>nas.dong4j.tele</code> → DS218+ WebUI</li><li><code>blog.dong4j.tele</code> → 博客</li><li><code>api.dong4j.tele</code> → 接口服务</li></ul><p>通过这种配置, 大大简化了域名管理流程, 同时适配动态 IP 环境.</p><h3 id="端口映射"><a href="#端口映射" class="headerlink" title="端口映射"></a>端口映射</h3><p>前面我们已经将公网 IP 成功绑定到了指定域名上, 比如我需要访问 DS218+ 的 WebUI, 只需要在路由器上开放指定的端口并映射到正确的 IP 上:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_yTkBViDh.webp" alt="20241229154732_yTkBViDh.webp"></p><p><strong>最好修改外部端口号, 不要与内部端口号一样</strong></p><p>这样我们就可以通过 <code>http://nas.dong4j.tele:5000</code> 访问内部的 <code>http://192.168.31.3:5000</code>.</p><p>然而随着需要暴露的服务越来越多, 通过路由器进行端口转发管理会变得繁琐, 尤其是每个服务需要独占一个端口. 例如:</p><ul><li>服务 A → 8081 端口</li><li>服务 B → 8082 端口</li><li>服务 C → 8083 端口</li></ul><p>这种方式不仅难以记忆, 还会造成端口冲突, 并且极度浪费端口资源.</p><p>如果熟悉 Nginx 反向代理的话, 除了通过端口区分服务, 还能通过域名区分:</p><ul><li><code>nas.dong4j.tele:5000</code> → 服务 A</li><li><code>blog.dong4j.tele:5000</code> → 服务 B</li><li><code>api.dong4j.tele:5000</code> → 服务 C</li></ul><p>这样我们只需要一个端口即可代理多个服务.</p><p>以下是一个简单的 Nginx 配置, 用于将不同的域名路由到不同的内部服务:</p><figure class="highlight nginx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> {</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">5000</span>;</span><br><span class="line">  <span class="attribute">server_name</span> nas.dong4j.tele;</span><br><span class="line">  <span class="section">location</span> / {</span><br><span class="line">		<span class="attribute">proxy_pass</span> http://192.168.31.3:5000; <span class="comment"># 映射到服务 A</span></span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="section">server</span> {</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">5000</span>;</span><br><span class="line">  <span class="attribute">server_name</span> blog.dong4j.tele;</span><br><span class="line">  <span class="section">location</span> / {</span><br><span class="line">		<span class="attribute">proxy_pass</span> http://192.168.31.4:8080; <span class="comment"># 映射到服务 B</span></span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="section">server</span> {</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">5000</span>;</span><br><span class="line">  <span class="attribute">server_name</span> api.dong4j.tele;</span><br><span class="line">  <span class="section">location</span> / {</span><br><span class="line">		<span class="attribute">proxy_pass</span> http://192.168.31.5:1234; <span class="comment"># 映射到服务 C</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="Nginx-Proxy-Manager"><a href="#Nginx-Proxy-Manager" class="headerlink" title="Nginx Proxy Manager"></a>Nginx Proxy Manager</h3><p>虽然 Nginx 的配置文件设计得非常简洁, 并支持热加载 (通过 <code>nginx -s reload</code>) , 无需完全重启服务, 但是在命令行下操作确实有点不方便.</p><p>可视化操作 Nginx 配置目前成熟的方案非常多, 比如:</p><ul><li><a href="">nginx-proxy-manager</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly93d3cubmdpbnh3ZWJ1aS5jbi8=">nginxWebU</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9kby5jby9uZ2lueGNvbmZpZw==">NGINX Config</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9uZ2lueHByb3h5bWFuYWdlci5jb20v">Nginx Proxy Manager</a></li><li>1Panel 中的 OpenResty</li><li>宝塔面板中的 Nginx</li></ul><p>这类服务选择一个顺手的就行, 目前我使用的是 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9uZ2lueHByb3h5bWFuYWdlci5jb20v">Nginx Proxy Manager</a>:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_URyCJuXy.webp" alt="20241229154732_URyCJuXy.webp"></p><p><strong>为了安全起见, 已将所有服务迁移到 雷池 Safeline</strong>.</p><h4 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_D1jHvCKb.webp" alt="20241229154732_D1jHvCKb.webp"></p><p>反向代理配置非常简单, 只需要配置:</p><ul><li>域名</li><li>协议: 内网一般选择 http, 外部访问如果需要 HTTPS, 则需要在 SSL 选项卡中配置 HTTPS 证书, 这个后面详细介绍;</li><li>转发主机: 内部服务所在的服务器 IP</li><li>转发端口: 服务端口</li></ul><p>我们以外网通过 HTTP 访问 NAS (<code>192.168.31.3</code>) 为例, 假设 Nginx Proxy Manager (后面简称 <code>NPM</code> )监听的 HTTP 端口为 <code>6080</code>, IP 为 <code>192.168.31.10</code> , 那么配置步骤如下:</p><ul><li><p>在路由器上配置端口转发: <code>1020</code> 端口指向 <code>192.168.168.31.10</code> 的 6080 端口;</p></li><li><p>在 <code>NPM</code> 添加代理服务配置:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_xBkppcxh.webp" alt="20241229154732_xBkppcxh.webp"></p></li></ul><p>访问 <code>nas.dong4j.tele:1020</code> 即可访问 NAS 的 WebUI 服务.</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/NPM-HTTP.drawio.svg" alt="NPM-HTTP.drawio.svg"></p><p>整体的流程为:</p><ol><li>ddns-go 通过定时调用 API 将获取到的最新公网 IP 推送给域名服务商;</li><li>在路由器将特定端口绑定到 NPM 的 HTTP 端口, 比如 1020 -&gt; 6080;</li><li>在 NPM 进行代理服务配置, 将域名映射到指定服务;</li></ol><p>这样我们就能通过 <strong>某个固定的端口结合不同的域名访问不同的服务</strong>, NPM 也提供 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL05naW54UHJveHlNYW5hZ2VyL25naW54LXByb3h5LW1hbmFnZXIvYmxvYi9kZXZlbG9wL2JhY2tlbmQvc2NoZW1hL3N3YWdnZXIuanNvbg==">REST API</a>, 你可以玩一些比较花的操作, 比如通过脚本随时关闭/开启某个代理服务.</p><h4 id="HTTPS-证书申请"><a href="#HTTPS-证书申请" class="headerlink" title="HTTPS 证书申请"></a>HTTPS 证书申请</h4><p>NPM 还提供 <code>Let's Encrypt</code> 证书申请服务, 可申请 3 个月的免费证书并能够自动续期.</p><p>需要验证你对证书中域名的控制权, 也就是说你要能证明, 这个域名是属于你的. 有两种验证方式: 一种是基于 <code>HTTP</code> 的验证方式, 另一种是基于 <code>DNS</code> 的验证方式.</p><p>关于这方面的教程非常多, 所以这里就不在赘述了, 只说说我遇到的问题:</p><ol><li><p><code>ModuleNotFoundError: No module named 'zope' #2440</code></p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL05naW54UHJveHlNYW5hZ2VyL25naW54LXByb3h5LW1hbmFnZXIvaXNzdWVzLzI0NDA=">这里是 Issues</a></p><p>解决方法:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入 docker 容器</span></span><br><span class="line">docker exec -it /bin/bash xxxx</span><br><span class="line">pip install certbot-dns-dnspod</span><br><span class="line">pip install zope -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></tbody></table></figure></li><li><p><code>Another instance of Certbot is already running</code></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -type f -name '.certbot.lock' -exec rm {} \;</span><br></pre></td></tr></tbody></table></figure></li></ol><p>在使用的过程中, 第一次申请证书会消耗大量时间, 出现多次申请失败的情况, 且自动续期经常会失败, 再尝试了通过 <code>1Panel</code> 的证书管理功能后, 果断弃用了 NPM 的 HTTPS 证书管理功能, 这个在 [网络安全-HTTPS 证书](#HTTPS 证书) 一节中详细说明.</p><p><strong>值得注意的是, 如果启用了 HTTPS, 在路由器的端口转发配置时, 需要将外部端口映射到 NPM 的 HTTPS 端口.</strong></p><h4 id="开启-HTTPS-访问"><a href="#开启-HTTPS-访问" class="headerlink" title="开启 HTTPS 访问"></a>开启 HTTPS 访问</h4><p>HTTPS 证书申请后给域名添加 HTTPS, 需要注意你的 NPM 的 HTTPS 端口号, 比如是 <code>30443</code>, 那么在路由器配置端口转发时就要使用此端口号.</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/NPM-HTTPS.drawio.svg" alt="NPM-HTTPS.drawio.svg"></p><h4 id="自定义位置"><a href="#自定义位置" class="headerlink" title="自定义位置"></a>自定义位置</h4><p>自定义位置是在特殊场景下提供的一种定制化配置, 比如我的 <code>bark</code> 服务, 它的完整路径是这样的:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.31.20:8088/iphone-uuid/</span><br><span class="line">http://192.168.31.20:8088/mbp-uuid/</span><br><span class="line"># xxx-uuid 通常为 22 位随机字符串</span><br></pre></td></tr></tbody></table></figure><p>这个 URL 会作为 Webhook 在多个地方使用, 且会有多个客户端的 uuid, 比如上面的 <code>iphone-uuid</code> 就是将消息通知到手机, 而 <code>mbp-uuid</code> 则是通知到 MBP, 为了方便记忆, 且在 <code>bark</code> 重置 uuid 后不需要重新修改设备上的 Webhook 地址, 可以这样设置:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_Bt3WnONz.webp" alt="20241229154732_Bt3WnONz.webp"></p><p>Webhook 地址则变更为:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://bark.dong4j.tele:1020/iphone/</span><br><span class="line">http://bark.dong4j.tele:1020/mbp/</span><br></pre></td></tr></tbody></table></figure><p><a href="obtain_public_ip_address_using_nginx.md">这里有一个通过 NPM 搭建获取公网 IP 服务的说明</a></p><h4 id="高级配置"><a href="#高级配置" class="headerlink" title="高级配置"></a>高级配置</h4><p>如果 WebUI 上无法通过可视化配置满足你的需求, 你可以进入 NPM 挂载的目录直接修改配置:</p><p>可以按照如下方式添加自定义配置片段文件<code>/data/nginx/custom</code>:</p><ul><li><code>/data/nginx/custom/root_top.conf</code>: 包含在 nginx.conf 的顶部</li><li><code>/data/nginx/custom/root.conf</code>: 包含在 nginx.conf 的最末尾</li><li><code>/data/nginx/custom/http_top.conf</code>: 包含在主 http 块的顶部</li><li><code>/data/nginx/custom/http.conf</code>: 包含在主 http 块的末尾</li><li><code>/data/nginx/custom/events.conf</code>: 包含在事件块的末尾</li><li><code>/data/nginx/custom/stream.conf</code>: 包含在主流块的末尾</li><li><code>/data/nginx/custom/server_proxy.conf</code>: 包含在每个代理服务器块的末尾</li><li><code>/data/nginx/custom/server_redirect.conf</code>: 包含在每个重定向服务器块的末尾</li><li><code>/data/nginx/custom/server_stream.conf</code>: 包含在每个流服务器块的末尾</li><li><code>/data/nginx/custom/server_stream_tcp.conf</code>: 包含在每个 TCP 流服务器块的末尾</li><li><code>/data/nginx/custom/server_stream_udp.conf</code>: 包含在每个 UDP 流服务器块的末尾</li></ul><p>更多的配置说明可自行查看 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9uZ2lueHByb3h5bWFuYWdlci5jb20vYWR2YW5jZWQtY29uZmlnLw==">NPM 官方文档</a></p><h4 id="代理局域网自定义域名"><a href="#代理局域网自定义域名" class="headerlink" title="代理局域网自定义域名"></a>代理局域网自定义域名</h4><h5 id="Surge-NPM"><a href="#Surge-NPM" class="headerlink" title="Surge + NPM"></a>Surge + NPM</h5><p>后面会讲到 [使用 雷池 Safeline 代替 NPM](#用 WAF 替换 NPM), 所有代理服务都会迁移过去, 所以 NPM 就沦为了局域网自定义域名的代理工具, 接下来 <strong>设备域名映射一节</strong> 中关于如何使用 [NPM + Surge 来简化域名访问的详细配置](#通过自定义域名减少需要记忆的 IP 数量).</p><p>流程大致如下:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/NPM_Surge_proxy.drawio.svg" alt="NPM_Surge_proxy.drawio.svg"></p><ol><li><p>Surge 配置自定义域名:</p><figure class="highlight txt"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 所有的 *.npm 全部解析成 192.168.31.10</span><br><span class="line">*.npm = 192.168.31.10</span><br></pre></td></tr></tbody></table></figure></li><li><p>配置 NPM:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_oWNfAFQJ.webp" alt="20241229154732_oWNfAFQJ.webp"></p></li></ol><p>意思是来自 <code>nas.npm</code> 的请求会被代理到 <code>http://192.168.31.3:5000</code> 上, 即 DS218+ 的 WebUI 服务.</p><p><strong>总结下来</strong>:</p><ol><li>Surge 将 <code>*.npm</code> 全部解析成 <code>192.168.31.10</code>;</li><li>当请求 <code>xx.npm</code> 时被发送到 NPM 的 <code>80</code> 端口;</li><li>NPM 根据 <strong>域名</strong> 判断应该代理请求到哪个服务;</li></ol><p>为了简化, 我们使用 NPM 的 <code>80</code> 端口, 所以需要注意的 NPM 的端口配置:</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">'chishin/nginx-proxy-manager-zh:latest'</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'80:80'</span>				<span class="comment"># HTTP 代理端口</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'12443:443'</span> 	<span class="comment"># HTTPS 代理端口</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'1281:81'</span> 		<span class="comment"># WebUI 管理端口</span></span><br><span class="line">		<span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>接下来就是在 NPM 上重复添加代理配置了:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_Vc56ORPo.webp" alt="20241229154732_Vc56ORPo.webp"></p><p><strong>我的自定义域名规则</strong>:</p><ul><li><code>.npm</code> 作为顶级域名;</li><li><code>{服务器}.npm</code> 作为二级域名, 比如: <code>nas.npm</code>;</li><li><code>{服务名}.{服务器}.npm</code> 作为三级域名, 比如: <code>ddns.nas.npm</code></li></ul><p><strong>值得注意的是, 因为 .npm 不是有效的 TLD</strong>, 因此在 Chrome 第一次使用的时候, 需要输入完整的 URL: <code>http://nas.npm</code>, 否则会被当成搜索请求, 成功打开一次后即可, 后面就不需要完整输入 URL 了.</p><p>当然你也可以将 <code>.npm</code> 改成其他的比如: <code>.local</code>.</p><p><strong>补充说明</strong>:</p><p>因为 <strong>NPM</strong> 只能代理 <strong>HTTP</strong> 协议, 如果 <strong>TCP/UDP</strong> 协议也想使用域名, 你可以在 Surge 添加一条配置, 比如 DS218+ 的 IP 是 <code>192.168.31.3</code>, 我想使用 <code>ssh.nas.npm</code> 连接 SSH:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh.nas.npm = 192.168.31.3</span><br><span class="line">*.npm = 192.168.31.10</span><br></pre></td></tr></tbody></table></figure><p>使用方式:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@ssh.nas.npm</span><br></pre></td></tr></tbody></table></figure><h5 id="Surge-SmartDNS-NPM"><a href="#Surge-SmartDNS-NPM" class="headerlink" title="Surge + SmartDNS + NPM"></a>Surge + SmartDNS + NPM</h5><p>其实还可以结合 SmartDNS 来达成同样的目的, 但是这种方式比 <strong>Surge + NPM</strong> 多了一层, 这是没有采用的 <strong>原因之一</strong>.</p><p><strong>Surge</strong> 只是用来获取指定域名的 DNS 地址, <strong>SmartDNS</strong> 用于 DNS 解析, NPM 的作用不变.</p><p><strong>具体配置为</strong>:</p><ol><li><p>Surge Hosts 配置修改为:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*.npm = server:192.168.31.10</span><br></pre></td></tr></tbody></table></figure></li></ol><p>表示 <code>*.npm</code> 域名使用部署在 <code>192.168.31.10</code> 上的 <strong>SmartDNS</strong> 提供的 DNS 服务来获取解析.</p><ol start="2"><li><p><strong>SmartDNS</strong> 配置如下(官方文档说是支持 <code>*.npm</code> 这种通配符解析的, 但是本地测试并没有成功, 这是没有使用的 <strong>原因之二</strong> ):</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">address /nas.npm/192.168.31.10</span><br><span class="line">address /tnas.npm/192.168.31.10</span><br><span class="line">....</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">其他域名配置, 同样是指向 192.168.31.10</span></span><br></pre></td></tr></tbody></table></figure></li></ol><p><strong>SmartDNS</strong> 的意义在于作为一个 DNS 服务为局域网设备提供解析服务, 问题是需要在多台服务器上进行 DNS 地址配置, 我的目的只是在主要设备上实现域名访问, Surge 显然更适合, 所以这也是没有使用的 <strong>原因之三</strong>.</p><h3 id="IPv6"><a href="#IPv6" class="headerlink" title="IPv6"></a>IPv6</h3><h4 id="中国的-IPv6-发展情况"><a href="#中国的-IPv6-发展情况" class="headerlink" title="中国的 IPv6 发展情况"></a>中国的 IPv6 发展情况</h4><p>截至 2024 年, 中国在 IPv6 的发展方面取得了显著进展. 以下是根据《中国 IPv6 发展状况白皮书 (2024) 》和相关报道总结的几个关键点:</p><ol><li><strong>IPv6 用户数量</strong>: 截至 2024 年 5 月, 中国的 IPv6 活跃用户数达到 7.94 亿, 占全体网民总数的 72.7%. 这个比例从 2017 年初的 0.51% 显著提高. 已分配 IPv6 地址的终端数达到 17.65 亿, 其中移动网络终端为 13.50 亿, 固定宽带接入网络终端为 4.15 亿.</li><li><strong>发展阶段</strong>: 中国 IPv6 的发展经历了起步期 (2017 年至 2018 年中) 、爬升期 (2018 年中至 2023 年一季度) 和稳定期 (2023 年一季度至今) 三个阶段.</li><li><strong>网络流量</strong>: 移动网络 IPv6 流量占比达到 64.56%, 固定网络 IPv6 流量占比为 21.21%. 城域网 IPv6 总流量占全网总流量的 21.21%.</li><li><strong>网络性能</strong>: IPv6 网络性能得到显著提升, 其时延降低, 丢包率减少, 显示出在网络性能和稳定性方面的潜力.</li><li><strong>基础资源</strong>: 中国在 IPv6 地址申请量和拥有量方面均位居世界第二, IPv6 AS (自治系统) 数量占比达到 70.43%.</li><li><strong>政策支持</strong>: 中国政府高度重视 IPv6 的部署和应用, 自 2017 年《推进互联网协议第六版 (IPv6) 规模部署行动计划》发布以来, 已出台多项政策, 明确 IPv6 发展目标和时间表.</li></ol><h4 id="全球-IPv6-发展情况"><a href="#全球-IPv6-发展情况" class="headerlink" title="全球 IPv6 发展情况"></a>全球 IPv6 发展情况</h4><p>全球范围内, IPv6 的部署和应用也在加速推进. 以下是根据《2024 全球 IPv6 发展指数报告》总结的几个关键点:</p><ol><li><strong>全球覆盖率</strong>: 2023 年, 全球 IPv6 网络部署显著提速, 总体覆盖率首次突破 30%. 部分领先国家的 IPv6 覆盖率已经达到或接近 70%, 其 IPv6 移动流量占比也已超过 IPv4.</li><li><strong>技术发展</strong>: 随着 IPv6 网络的基本建成, 领先国家的 IPv6 规模部署及应用开始进入新的阶段, 政策聚焦逐渐从网络扩张转向 IPv6 Enhanced 技术的产品化落地和规模化应用.</li><li><strong>数字经济</strong>: IPv6 作为数字基建的底座, 是互联网升级和网络技术创新的重要基石. IPv6 创新技术应用融合行业应用场景加速落地, 为各行业的数字化、智能化转型提供了关键支持.</li></ol><p>IPv6 都在迅速发展, 已成为成为支撑现代互联网和数字经济发展的关键技术.</p><p>IPv6 对于个人用户的一个巨大优势在于, 即使宽带运营商不提供 IPv4 公网 IP, 也可以通过 IPv6 直接访问家中的设备.</p><p><strong>IPv6 的优势</strong>:</p><ol><li><p><strong>无 NAT 限制</strong><br>在 IPv4 网络中, 运营商通常使用 NAT (网络地址转换) 来将多个用户共享一个公网 IP, 这限制了用户通过公网访问家中设备的能力. 而 IPv6 提供了几乎无限的地址空间, 每个设备都可以拥有独立的公网 IPv6 地址.</p></li><li><p><strong>端到端通信</strong><br>IPv6 支持真正的端到端通信, 消除了 NAT 带来的复杂性. 这使得用户可以直接通过 IPv6 地址远程访问家中的路由器、NAS、摄像头等设备, 无需依赖 DDNS 或复杂的端口映射.</p></li><li><p><strong>更高的安全性</strong></p><p>IPv6 内置了 IPsec 支持, 可以实现更安全的通信. 同时, IPv6 的分布式地址分配方式, 减少了攻击者扫描设备的可能性.</p></li><li><p><strong>与 5G 和物联网结合</strong></p><p>随着 5G 和智能家居的发展, 更多设备开始支持 IPv6, 这将进一步简化联网设备的配置和管理.</p></li></ol><h4 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h4><ol><li><p><strong>确认运营商支持 IPv6</strong></p><p>确保宽带提供商已经开通 IPv6 服务. 当前中国主要的运营商 (如中国电信、中国联通、中国移动) 正在大力推进 IPv6 部署.</p></li><li><p><strong>配置路由器</strong></p><p>确保家庭路由器支持并启用了 IPv6, 开启后将为家中设备分配公网 IPv6 地址.</p></li><li><p><strong>远程访问设备</strong></p><p>通过 IPv6 地址直接访问设备, 例如: <code>http://[your-ipv6-address]:port</code>. 也可以使用 DDNS 服务将复杂的 IPv6 地址映射为易记的域名.</p></li><li><p><strong>兼容性处理</strong></p><p>对于不支持 IPv6 的场景, 可以使用 IPv6 到 IPv4 的隧道技术 (如 6to4 或 Teredo) 来实现兼容.</p></li></ol><p>通过这些方式, 即使没有 IPv4 公网地址, 也能利用 IPv6 更方便地管理家中的设备, 特别是在需要多设备远程访问的情况下.</p><h4 id="现状"><a href="#现状" class="headerlink" title="现状"></a>现状</h4><p>我目前已经实现了主要设备的 <strong>IPv6</strong> 访问, 且通过 DDNS-GO 绑定了域名, 但是因为安全性问题(安全认证登录并没有覆盖到所有服务, 因为绑定了域名, 如果被猜测出端口号, 就会被非法访问), 暂时关闭了所有的 <strong>IPv6</strong> 访问(开启路由器的 IPv6 防火墙).</p><p><strong>与 IPv6 相关的服务配置, 比如 Surge, OpenClash, ShellClash, Pass Wall 等就自行搜索了, 本文不过多描述.</strong></p><h4 id="IPv6-相关资源"><a href="#IPv6-相关资源" class="headerlink" title="IPv6 相关资源"></a>IPv6 相关资源</h4><p><strong>IPv6 测试地址</strong>:</p><ul><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly90ZXN0LWlwdjYuY29tLw==">IPv6 连接测试</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9pcHcuY24v">IPv6 查询与检测</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly93d3cuaXRkb2cuY24vcGluZ19pcHY2Lw==">ITDOG</a></li></ul><p><strong>IPv6 报告</strong>:</p><ul><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly93d3cuY2hpbmEtaXB2Ni5jbi8=">国家 IPv6 发展监测平台</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cDovL3d3dy5jYWljdC5hYy5jbi9reHlqL3F3ZmIvenRiZy8yMDE5MDcvUDAyMDE5MDcxMjU3NjU4NzEzODE3NC5wZGY=">中国 IPv6 发展状况(2019)</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly93d3cucm9sYW5kYmVyZ2VyLmNvbS9wdWJsaWNhdGlvbnMvcHVibGljYXRpb25fcGRmL0dsb2JhbC1JUHY2LURldmVsb3BtZW50LVJlcG9ydC0yMDI0X0NOLnBkZg==">全球 IPv6 发展指数报告 2024</a></li></ul><hr><h2 id="网络安全"><a href="#网络安全" class="headerlink" title="网络安全"></a>网络安全</h2><p>网络安全涉及到的方面非常多, 大体包括:</p><ol><li>强密码策略 + MFA 多因素认证;</li><li>使用 vLAN 或子网进行网络隔离;</li><li>使用 HTTPS 加密协议;</li><li>部署防火墙;</li><li>定期更新服务, 修复已知漏洞;</li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL3BhcmFsYXgvYXdlc29tZS1ob25leXBvdHM=">蜜罐系统</a>;</li></ol><p>在 Homelab 环境中, 部署物理防火墙虽然是理想的安全方案, 但成本高昂, 对于普通用户并不现实. 相比之下, <strong>使用 HTTPS 加密协议</strong> 是最容易实现且高效的安全措施之一.</p><p>而 <code>强密码策略 + MFA 多因素认证</code> 这个则是个人使用习惯, 我一般都会使用 <code>Bitwarden</code> 生成 <strong>不重复且复杂的</strong> 密码, 且开启具备 <code>MFA 多因素认证</code> 服务的二次认证, 在 macOS 使用了 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9zdGVwdHdvLmFwcC8=">Step Two</a> 来管理一次性密码, 这样的 APP 还有很多, 比如还有 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9wbGF5Lmdvb2dsZS5jb20vc3RvcmUvYXBwcy9kZXRhaWxzP2lkPWNvbS5nb29nbGUuYW5kcm9pZC5hcHBzLmF1dGhlbnRpY2F0b3IyJnBsaT0x">Authenticator</a>.</p><p>最近打算部署一个 蜜罐系统玩玩儿, 它是一种攻防兼备的工具, 通过欺骗和分析攻击者来增强网络防御, 通过主动布防, 主动示弱攻击者, 并且进行反制, 使网络攻击不再是一个没有损失、只有收益的事情.</p><h3 id="HTTPS-证书"><a href="#HTTPS-证书" class="headerlink" title="HTTPS 证书"></a>HTTPS 证书</h3><p>前面介绍过使用 [Nginx Proxy Manager 来申请并自动续期免费的 HTTPS 证书](#HTTPS 证书申请), 但因为不稳定而被弃用, 转而使用 1Panel 的 HTTPS 的证书申请与管理服务:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_SE63DzWC.webp" alt="20241229154732_SE63DzWC.webp"></p><p>1Panel 的证书申请非常快且成功率 100%, 可以采用手动的方式为 <strong>雷池 Safeline</strong> 添加证书, 也可以 [自动化部署 HTTPS 证书到 WAF](#自动部署 1Panel 申请的 HTTPS).</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_WrtceKg5.webp" alt="20241229154732_WrtceKg5.webp"></p><h3 id="雷池-Safeline"><a href="#雷池-Safeline" class="headerlink" title="雷池 Safeline"></a>雷池 Safeline</h3><p><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly93YWYtY2UuY2hhaXRpbi5jbi8=">雷池</a> 号称 <strong>下一代 Web 应用防火墙</strong>, 社区版功能完全够用(主要因为专业版太贵 🥲), 专业版多了告警, 负载均衡等功能:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_YRcE1Gho.webp" alt="20241229154732_YRcE1Gho.webp"></p><p>用 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL2NoYWl0aW4vYmxhemVodHRw">官方的测试工具</a> 玩了一下, 攻击检测日志中的信息非常全面:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_VxcQXWa4.webp" alt="20241229154732_VxcQXWa4.webp"></p><p>且还有 AI 攻击分析:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_iXXaoqbt.webp" alt="20241229154732_iXXaoqbt.webp"></p><p>后续我将使用 <strong>WAF</strong> 代替 <strong>雷池 Safeline</strong>.</p><h4 id="用-WAF-替换-NPM"><a href="#用-WAF-替换-NPM" class="headerlink" title="用 WAF 替换 NPM"></a>用 WAF 替换 NPM</h4><p>买不起硬件防火墙, 软件防火墙我们还不能白嫖吗?</p><p>所以为了玩一玩这个号称这么牛逼的软防火墙, 将 NPM 的代理全部迁移到了 WAF, 现在 NPM 则沦为 <a href="#%E4%BB%A3%E7%90%86%E5%B1%80%E5%9F%9F%E7%BD%91%E8%87%AA%E5%AE%9A%E4%B9%89%E5%9F%9F%E5%90%8D">内网自定义域名的代理服务</a>.</p><p>所以就直接使用 2 台虚拟机通过 Docker 部署了 WAF, 分别替代电信和联通网络的 NPM:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_iUHGX8ah.webp" alt="20241229154732_iUHGX8ah.webp"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_idtQIkzN.webp" alt="20241229154732_idtQIkzN.webp"></p><p>防护功能要比 NPM 多几个, 且有 Dashboard 展示访问与拦截情况.</p><h4 id="配置域名代理"><a href="#配置域名代理" class="headerlink" title="配置域名代理"></a>配置域名代理</h4><p>与 NPM 不同的是 WAF 在配置域名时确认端口号, 而 NPM 在启动时就确认了 HTTP 和 HTTPS 端口 , 所以 WAF 的优势是能够为不同的域名设置不同的端口:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_YMIhiIMR.webp" alt="20241229154732_YMIhiIMR.webp"></p><p>如上配置的话, 就需要在路由器分别为 <code>1443</code> 和 <code>2443</code> 配置端口转发规则, 局域网 IP 添加部署 WAF 的服务器 IP.</p><h5 id="NAS-域名代理"><a href="#NAS-域名代理" class="headerlink" title="NAS 域名代理"></a>NAS 域名代理</h5><p>补充说明一下如何代理 <code>Synology Drive</code> 流量.</p><p><code>Synology Drive</code> 客户端全平台支持, 我在手机和电脑上使用了 Drive 客户端.</p><p>假设我想使用 <code>nas.dongj4.tele:1443</code> 来访问 NAS 上(<code>192.168.31.3</code>) 的 <code>Synology Drive</code> 服务, 那么只需要在 WAF 添加一个域名配置:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_KQWn57pG.webp" alt="20241229154732_KQWn57pG.webp"></p><p>熟悉 Synology 的朋友都知道 <code>5000</code> 是 NAS 的 WebUI 的 HTTP 端口. 接着在路由器上配置端口转发, 将 <code>1443</code> 转发到 <code>192.168.31.10:1443</code>,</p><p>然后在手机客户端上登录:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_tGBKjnmU.webp" alt="20241229154732_tGBKjnmU.webp"></p><p>配置没问题的话应该就可以正常登录了, 如果登录失败请自行检查端口转发, NAS 的端口号等是否设置正确.</p><p>然后如果你将上述的域名和端口配置到桌面版的 Drive client 会发现连接不上, 这是因为 <strong>PC 端 Drive 程序开放的默认访问端口为 6690</strong>, 对移动端的 App 开放的默认访问端口为 <strong>5000</strong>.</p><blockquote><p>Synology Drive 客户端会根据输入的域名或 IP 自动选择默认端口进行访问:</p><ul><li><strong>PC 客户端</strong>: 如果未指定端口, 会默认使用 <strong>6690</strong></li><li><strong>移动客户端</strong>: 默认使用 <strong>5000</strong> (HTTP) 或 <strong>5001</strong> (HTTPS)</li></ul><p>如果用户明确填写了端口号, 客户端会优先使用指定的端口.</p><p>在局域网中, 直接输入 NAS 的 IP 地址即可连接, 是否加端口号均可；在外网访问时, 需要将外部端口转发到 NAS 的相应内部端口 (例如 6690)</p></blockquote><p><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9rYi5zeW5vbG9neS5jbi96aC1jbi9EU00vdHV0b3JpYWwvV2hhdF9uZXR3b3JrX3BvcnRzX2FyZV91c2VkX2J5X1N5bm9sb2d5X3NlcnZpY2Vz">DSM 服务使用的网络端口</a></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_lHY8HjzL.webp" alt="20241229154732_lHY8HjzL.webp"></p><p>所以为了让桌面版的 Drive client 能正常使用, 我们需要在路由器上多配置一个端口转发规则 ([因为 WAF 它不支持 TCP/UDP 转发](#WAF 的代理的局限性)):</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_nlmVvkzT.webp" alt="20241229154732_nlmVvkzT.webp"></p><p>桌面版 Drive 连接配置:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_m3hA6Drx.webp" alt="20241229154732_m3hA6Drx.webp"></p><p>这里 <strong>启用 SSL 数据传输加密</strong> 最好能勾选上, 但因为没有通过 WAF 转发, 所有无法使用 WAF 中的证书配置, 你需要在 NAS 中配置 HTTPS 证书:</p><blockquote><p>后面会讲到为什么使用 1Panel 的证书管理代理 WAF 的证书管理, 且实现 1Panel 申请证书并自动部署到 WAF.</p><p>这里会先用到 1Panel 的 2 个证书, 如果没啥头绪, 可以先看完 [自动部署 1Panel 申请的 HTTPS](#自动部署 1Panel 申请的 HTTPS) 再回过来看这里.</p></blockquote><p>NAS 新增证书:</p><ol><li><p>入口: 控制面板-安全性-证书</p></li><li><p>新增证书-导入证书或从 Let’s Encrypt 获取证书 (如果是更新证书就选第二项: <strong>替换已有证书</strong>)-导入证书(不要勾选 <strong>设为默认证书</strong>[如果你知道是什么操作可执行选择]):</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_8lNaX5kY.webp" alt="20241229154732_8lNaX5kY.webp"></p></li></ol><p>私钥: <strong>privkey.pem</strong></p><p>证书: <strong>fullchain.pem</strong></p><p>中间证书: 可不填</p><ol start="3"><li><p>为 Drive 配置自定义证书:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_LtfPm6CP.webp" alt="20241229154732_LtfPm6CP.webp"></p></li></ol><h5 id="NAS-自动部署-HTTPS-证书"><a href="#NAS-自动部署-HTTPS-证书" class="headerlink" title="NAS 自动部署 HTTPS 证书"></a>NAS 自动部署 HTTPS 证书</h5><p>当然这又是另一个话题了, 我会单独出一个指南, 通过 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL2FjbWVzaC1vZmZpY2lhbC9hY21lLnNo">acme.sh</a> 将证书自动部署到 NAS 和 WAF.</p><p>相关链接:</p><ul><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL2NoYWl0aW4vU2FmZUxpbmUvaXNzdWVzLzY2MA==">两个优化点 #660</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL2NoYWl0aW4vU2FmZUxpbmUvaXNzdWVzLzc4Mg==">证书增加使用路径导入方式 #782</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9ibG9nLnpha2lrdW4uY29tL2FyY2hpdmVzLzgwLmh0bWw=">群晖 DSM7.x 通过 acme.sh 全自动更新并部署 SSL 证书</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly93d3cuaWFtbG0uY29tL2Jsb2cvMTE5LiVFOCVBRSVCMCVFNiU4OCU5MSVFNyVCRSVBNCVFNiU5OSU5NiVFNCVCOCU4QSVFNyU5QSU4NERvY2tlciVFOSVBMSVCOSVFNyU5QiVBRSVFRiVCQyU5QWRkbnMtZ28lRTUlOTIlOENhY21lLnNoLw==">记我群晖上的 Docker 项目: ddns-go 和 acme.sh</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL2FjbWVzaC1vZmZpY2lhbC9hY21lLnNoL3dpa2kvU3lub2xvZ3ktTkFTLUd1aWRl">HTTPS certificates for your Synology NAS using acme.sh</a></li></ul><h4 id="不使用-WAF-的证书管理"><a href="#不使用-WAF-的证书管理" class="headerlink" title="不使用 WAF 的证书管理"></a>不使用 WAF 的证书管理</h4><p><strong>WAF</strong> 无法申请泛域名证书, 所以就有点尴尬.</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_cL5QfgRD.webp" alt="20241229154732_cL5QfgRD.webp"></p><p>不过最新的情况是官方已经在考虑 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL2NoYWl0aW4vU2FmZUxpbmUvaXNzdWVzLzU2Mw==">通过 DNS 验证的方式来支持泛域名证书申请了</a>, 所以还是可以期待一下.</p><p>WAF 的其他 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly93YWYtY2UuY2hhaXRpbi5jbi9jb21tdW5pdHk=">开发计划</a> 也可以关注一下.</p><h4 id="WAF-的代理的局限性"><a href="#WAF-的代理的局限性" class="headerlink" title="WAF 的代理的局限性"></a>WAF 的代理的局限性</h4><p><strong>只能代理 HTTP 服务</strong>, 不支持四层代理转发. 官方的回答是不支持, 没必要: <strong>WAF 只关注七层网络协议, 专注于 HTTP 流量的检测与清洗</strong>.</p><p>但是 WAF 一般都是部署在公网之后的那台服务器, 作为所有流量的入口, 然后才是转发到后面的 Nginx 或其他服务, 如果只支持七层代理转发的话, 诸如 SSH 这类 TCP/UDP 层的流量还得单独配置.</p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL2NoYWl0aW4vU2FmZUxpbmUvaXNzdWVzLzEyMw==">可以看看这里的讨论</a>, 不知道官方会不会支持.</p><p>为了解决上述问题, 我目前使用的方案:</p><ul><li>如果是 HTTP 服务, 全部通过路由器转发到 WAF 所在的服务器上, 然后由 WAF 进行后续的转发;</li><li>其他服务比如 WireGuard, Snell 等四层协议的流量则通过路由器直接转发至指定的服务器 (前面 [NAS 域名代理](#NAS 域名代理) 就是一个例子);</li></ul><h4 id="WAF-社区版的局限性"><a href="#WAF-社区版的局限性" class="headerlink" title="WAF 社区版的局限性"></a>WAF 社区版的局限性</h4><p>和 NPM 的配置自由度比起来, WAF 社区版则不是那么具有可玩性, 因为 WAF 会定时覆盖手动修改的配置文件, 不过也有不是那么优雅的解决方案, 接下来通过一个例子来说明一下操作方式.</p><p>首先在 WAF 上创建一个站点, 用于返回 <strong>当前时间</strong> 和 <strong>客户端真实 IP</strong>:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_lXVNRKcT.webp" alt="20241229154732_lXVNRKcT.webp"></p><p>点击创建好的站点, 然后渠道 <strong>静态资源</strong> 选项卡, 添加一个 <strong>index.html</strong> 页面, 内容如下:</p><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Current Time<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toLocaleTimeString</span>());</span></span><br><span class="line"><span class="language-javascript">      </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>访问 <code>https://test.dong4j.tele:1234</code> 可返回当前时间.</p><p>接下来去服务器手动修改 WAF 的 nginx 配置文件:</p><p>刚刚添加的测试站点的配置文件为: <code>/opt/safeline/resources/nginx/sites-enabled/IF_backend_13</code>,</p><p>打开并编辑, 在 <code>server</code> 中添加如下配置:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location = /ip {</span><br><span class="line">    add_header Content-Type text/plain;</span><br><span class="line">    access_log on;</span><br><span class="line">    return 200 "$remote_addr\n";</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>保存退出, 为了防止 WAF 定期覆盖手动修改后的配置文件, 我们需要给刚刚的配置文件添加 <strong>不可变属性</strong></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chattr +i IF_backend_13</span><br></pre></td></tr></tbody></table></figure><p>重新加载 Nginx 配置:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it safeline-tengine nginx -t   &amp;&amp; \</span><br><span class="line">docker exec -it safeline-tengine nginx -s reload</span><br></pre></td></tr></tbody></table></figure><p>最后访问 <code>https://test.dong4j.tele:1234/ip</code> 可获取到客户端 IP (使用蜂窝网络的手机访问).</p><p>关键点是 <code>chattr +i</code>, 防止 WAF 覆盖我们修改过后的文件, 如果需要再次编辑, 使用 <code>chattr -i 文件名</code> 恢复.</p><h3 id="自动部署-1Panel-申请的-HTTPS"><a href="#自动部署-1Panel-申请的-HTTPS" class="headerlink" title="自动部署 1Panel 申请的 HTTPS"></a>自动部署 1Panel 申请的 HTTPS</h3><p>使用 WAF 一键部署脚本时会让你选择安装的目录, 我安装在 <code>/opt</code> 目录下, 所以 Nginx 的目录: <code>/opt/safeline/resources/nginx/sites-enabled/</code> (你可以查看 <code>/opt/safeline/conpose.yaml</code> 文件, 了解其他挂在的目录的位置).</p><p><strong>我先添加一个测试站点</strong>:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_1zJBR0CJ.webp" alt="20241229154732_1zJBR0CJ.webp"></p><p>对应的 Nginx 配置文件为 <strong>IF_backend_15</strong>:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">upstream backend_15 {</span><br><span class="line">    server 192.168.31.10:9876;</span><br><span class="line">    keepalive 128;</span><br><span class="line">    keepalive_timeout 75;</span><br><span class="line">}</span><br><span class="line">...</span><br><span class="line">server {</span><br><span class="line">    listen 0.0.0.0:1443 ssl http2;</span><br><span class="line">    server_name test.dong4j.tele;</span><br><span class="line">    ssl_certificate /etc/nginx/certs/cert_1.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/certs/cert_1.key;</span><br><span class="line">		...</span><br><span class="line">    if ($host !~* ^(test\.dong4j\.tele)$) {</span><br><span class="line">        rewrite ^ /not_found_page last;</span><br><span class="line">    }</span><br><span class="line">    ....</span><br><span class="line">    location ^~ / {</span><br><span class="line">        proxy_pass http://backend_15;</span><br><span class="line">        ...</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p>可以看到用到的公钥证书和私钥分别是: <code>/etc/nginx/certs/cert_1.crt</code>, <code>/etc/nginx/certs/cert_1.key</code> (如果已经有多个 HTTPS 证书, 后缀可能会是其他的数字).</p><p>他们对应的挂载目录为: <code>/opt/safeline/resources/nginx/certs</code></p><p>所以我们的目标就是自动换 <code>certs</code> 中的证书, 我们使用脚本来实现这一自动化过程.</p><ol><li><p>在 1Panel 上配置 <strong>推送证书到本地目录</strong>:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_f0epxZwE.webp" alt="20241229154732_f0epxZwE.webp"></p></li></ol><p>如果原来没有配置证书推送, 需要重新申请一次:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_XqtbWGyP.webp" alt="20241229154732_XqtbWGyP.webp"></p><p>然后指定目录下会出现 证书文件<code>fullchain.pem</code> 和密钥文件 <code>privkey.pem</code>, 因为 <code>fullchain.pem</code> 包含多个证书文件, 而 <code>openssl x509</code> 默认只处理单个证书, 所以我们可以直接拷贝 <code>fullchain.pem</code> 的内容, 接下来就是脚本部分(脚本名称为: <code>sync_certs.sh</code>):</p><details class="folding-tag"><summary>🪬 查看 sync_certs.sh 脚本内容</summary><div class="content"><p><strong>看到这里先别急着使用这个脚本, 接着往下看, 还有更好的方式, 这里只是记录一下折腾过程.</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用说明</span></span><br><span class="line">usage() {</span><br><span class="line">    echo <span class="string">"Usage: $0 &lt;WAF_IP&gt;"</span></span><br><span class="line">    echo <span class="string">"Example: $0 waf.t"</span></span><br><span class="line">    exit <span class="number">1</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否传入参数</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"$1"</span> ]; then</span><br><span class="line">    usage</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义变量</span></span><br><span class="line">WAF=<span class="string">"$1"</span></span><br><span class="line">CERT_FILE=<span class="string">"fullchain.pem"</span></span><br><span class="line">KEY_FILE=<span class="string">"privkey.pem"</span></span><br><span class="line">CERT_PATH=<span class="string">"/opt/safeline/resources/nginx/certs/cert_1.crt"</span></span><br><span class="line">KEY_PATH=<span class="string">"/opt/safeline/resources/nginx/certs/cert_1.key"</span></span><br><span class="line">DOCKER_CONTAINER=<span class="string">"safeline-tengine"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志函数</span></span><br><span class="line">log() {</span><br><span class="line">    echo <span class="string">"[INFO] $1"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">error() {</span><br><span class="line">    echo <span class="string">"[ERROR] $1"</span> &gt;&amp;<span class="number">2</span></span><br><span class="line">    exit <span class="number">1</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查文件是否存在</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">"$CERT_FILE"</span> ] || [ ! -f <span class="string">"$KEY_FILE"</span> ]; then</span><br><span class="line">    error <span class="string">"证书文件或密钥文件不存在, 请确保 $CERT_FILE 和 $KEY_FILE 存在"</span></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制证书和密钥</span></span><br><span class="line">log <span class="string">"正在复制证书和密钥到 ${WAF}..."</span></span><br><span class="line">scp <span class="string">"$CERT_FILE"</span> <span class="string">"${WAF}:${CERT_PATH}"</span> || error <span class="string">"无法复制证书文件到 ${WAF}"</span></span><br><span class="line">scp <span class="string">"$KEY_FILE"</span> <span class="string">"${WAF}:${KEY_PATH}"</span> || error <span class="string">"无法复制密钥文件到 ${WAF}"</span></span><br><span class="line">log <span class="string">"证书和密钥文件已成功复制到 ${WAF}"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修复文件权限</span></span><br><span class="line">log <span class="string">"正在修复文件权限..."</span></span><br><span class="line">ssh <span class="string">"$WAF"</span> <span class="string">"chmod 644 ${CERT_PATH} ${KEY_PATH}"</span> || error <span class="string">"无法修复文件权限"</span></span><br><span class="line">log <span class="string">"文件权限修复完成"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启 Docker 容器</span></span><br><span class="line">log <span class="string">"正在重启 Docker 容器 ${DOCKER_CONTAINER}..."</span></span><br><span class="line">ssh <span class="string">"$WAF"</span> <span class="string">"docker restart ${DOCKER_CONTAINER}"</span> &gt; /dev/null || error <span class="string">"无法重启 Docker 容器"</span></span><br><span class="line">log <span class="string">"Docker 容器 ${DOCKER_CONTAINER} 已成功重启"</span></span><br><span class="line"></span><br><span class="line">log <span class="string">"证书同步和更新完成！"</span></span><br></pre></td></tr></tbody></table></figure></div></details><hr><p>我的 <code>1Panel</code> 部署在 DS218+ 上, 且有 2 台 WAF 服务器分别对应电信和联通网络, 所以我将公共参数提出来, 使用脚本传参的方式处理:</p><ol><li><code>waf.t</code> 和 <code>waf.u</code> 需要在 <code>.ssh/config</code> 中配置, 如果你看过 <a href="#%E5%88%AB%E5%90%8D%E9%85%8D%E7%BD%AE">SSH 别名配置</a> 应该不难;</li><li>还需要配置 [SSH 免密登录](#SSH 免密登录);</li><li>WAF 上的 <code>cert_1.crt</code> 和 <code>cert_1.key</code> 名称需要根据你自己的情况修改;</li><li>如果你使用雷池一键安装脚本, Nginx 容器的名称应该是 <code>safeline-tengine</code>, 如果不是可自行修改;</li></ol><p><strong>值得注意的是, 在我的 DS218+ 上 1Panel 以 root 运行, 所以 <code>.ssh/config</code> 应该在 /root/.ssh 目录下设置</strong>.</p><p><strong>设置脚本</strong>:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_IeHUcfoG.webp" alt="20241229154732_IeHUcfoG.webp"></p><p>最后在 1Panel 中重新申请证书即可:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_icVOxGzJ.webp" alt="20241229154732_icVOxGzJ.webp"></p><p><strong>结果大意了没有闪</strong>, 这种方式虽然能够成功替换挂载目录下的证书文件, 但是 <strong>WAF</strong> 它把 <strong>证书数据存在数据库里面的</strong> , 心中一万只草泥马飘过…..</p><p>我是怎么发现的呢? 我拿八倍望远镜发现的…..</p><p>重新申请证书后到 WAF 中的证书管理页面查看, 发现证书时间没有更新, 且编辑证书后不是新的证书. 在 <code>/opt/safeline</code> 目录下有个 <code>reset_tengine.sh</code> 文件.</p><details class="folding-tag"><summary>🪬 查看 reset_tengine.sh 脚本内容</summary><div class="content"><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">SCRIPT_DIR=$(dirname "$0")</span><br><span class="line"></span><br><span class="line">confirm() {</span><br><span class="line">    echo -e -n "\033[34m[SafeLine] $* \033[1;36m(Y/n)\033[0m"</span><br><span class="line">    read -n 1 -s opt</span><br><span class="line"></span><br><span class="line">    [[ "$opt" == $'\n' ]] || echo</span><br><span class="line"></span><br><span class="line">    case "$opt" in</span><br><span class="line">        'y' | 'Y' ) return 0;;</span><br><span class="line">        'n' | 'N' ) return 1;;</span><br><span class="line">        *) confirm "$1";;</span><br><span class="line">    esac</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">if ! confirm "是否重新生成 tengine 的所有配置"; then</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">nginx_path="${SCRIPT_DIR}/resources/nginx"</span><br><span class="line">backup_path="${SCRIPT_DIR}"/resources/nginx."$(date +%s)"</span><br><span class="line"></span><br><span class="line">if [ ! -d "${nginx_path}" ]; then</span><br><span class="line">    echo "website dir not found"</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">mv "${nginx_path}" "${backup_path}"</span><br><span class="line"></span><br><span class="line">docker restart safeline-tengine &gt; /dev/null</span><br><span class="line"></span><br><span class="line">docker exec safeline-mgt gentenginewebsite</span><br><span class="line"></span><br><span class="line">if [ -d "${backup_path}/static" ]; then</span><br><span class="line">    cp -r "${backup_path}/static" "${nginx_path}/static"</span><br><span class="line">fi</span><br></pre></td></tr></tbody></table></figure></div></details><p>我重新执行了里面的 <code>docker exec safeline-mgt gentenginewebsite</code>, 结果将挂载目录下的证书给还原回去了, 翻遍了所有的挂载目录都没有发现备份的证书文件, 这才发现不简单…..</p><p>所以看了 <code>compose.yaml</code> 文件, 其中就出现了 <code>postgres</code> 数据库, 那么是不是证书数据被存储到数据了? 带着这个疑问, 我们将 <code>postgres</code> 的端口暴露出来连上去看看(<code>postgres</code> 的密码在 同级目录下的 <code>.env</code> 中).</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_a0FdkfT3.webp" alt="20241229154732_a0FdkfT3.webp"></p><p>如图所示, 证书数据被保存在了 <code>mgt_ssl_cert</code> 中, 看来只能通过 Web API 来操作了, 不过 WAF 并没有提供 API 文档, 也没有提供生成 API key 的操作, 控制台看了一下, 基于 JWT 的认证, 简单的写了脚本, 模拟登录获取 JWT, 然后调用 <code>POST /api/open/cert</code> 更新证书:</p><p></p><h3 id="WireGuard-VPN"><a href="#WireGuard-VPN" class="headerlink" title="WireGuard VPN"></a>WireGuard VPN</h3><h4 id="传统的-VPN-方案"><a href="#传统的-VPN-方案" class="headerlink" title="传统的 VPN 方案"></a>传统的 VPN 方案</h4><h5 id="OpenVPN"><a href="#OpenVPN" class="headerlink" title="OpenVPN"></a>OpenVPN</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_np8YDoTV.webp" alt="20241229154732_np8YDoTV.webp"></p><p><strong>OpenVPN</strong> 是一种热门且高度安全的协议, 许多 VPN 提供商都使用这种协议. 它运行在 TCP 或 UDP 互联网安全协议上. TCP 能确保数据以正确的顺序完整传输, 而 UDP 则专注于更快的速度.</p><p><strong>优点</strong></p><ul><li>**开放源码, **这表示代码是公开的. 任何人都可以检查代码中是否存在可能危及 VPN 安全的隐藏后门或漏洞;</li><li>**多功能性. **这种协议能与一系列不同的加密和流量协议一起使用, 可以针对不同的用途进行配置, 也可以根据需要进行安全或轻量的配置;</li><li>**安全性. **能搭配各种加密协议, 因此非常安全;</li><li><strong>绕过多数防火墙</strong>: OpenVPN, 就能够轻松绕过防火墙;</li></ul><p><strong>缺点</strong></p><ul><li><strong>设置复杂</strong>: 多功能性意味着如果多数用户试图建立自己的 OpenVPN, 他们可能会因为复杂性而难以设置.</li></ul><p>将用没必要上 <strong>重量级的(相对 WireGuard 来说)</strong> 的 OpenVPN, 专注主要功能即可.</p><h5 id="L2TP-IPsec"><a href="#L2TP-IPsec" class="headerlink" title="L2TP/IPsec"></a>L2TP/IPsec</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_cZGNZPoV.webp" alt="20241229154732_cZGNZPoV.webp"></p><p>L2TP (Layer 2 Tunneling Protocol) 和 IPSec (Internet Protocol Security) 是两种网络协议, 经常组合使用以提供安全的 VPN (虚拟专用网络) 连接:</p><ul><li><strong>L2TP</strong> 用于建立隧道 (Tunneling) , 将数据封装在 VPN 隧道中传输.</li><li><strong>IPSec</strong> 用于加密和验证数据包, 确保数据的安全性和完整性.</li></ul><p>这种组合方式被称为 <strong>L2TP/IPsec</strong>, 是一种常见的 VPN 协议, 用于在公共网络 (例如互联网) 上传输敏感数据, 需要占用 3 个端口:</p><ul><li>使用 <strong>UDP 500</strong> 和 <strong>4500</strong> (NAT 穿越) 进行密钥交换 (IKE 协议) .</li><li>L2TP 使用 <strong>UDP 1701</strong> 端口进行通信.</li></ul><p><strong>优点</strong></p><ul><li><strong>安全性</strong>: L2TP 根本不提供任何安全性, 但却相当安全. 这是因为它能搭配各种加密协议, 使协议按需要变得更安全或轻量.</li><li><strong>广泛可用</strong>: L2TP 在几乎适用于所有操作系统, 这代表管理员能轻易找到支持并使其运行.</li></ul><p><strong>缺点</strong></p><ul><li><strong>可能已被美国国家安全局 (NSA) 破解</strong>: 与 IKEv2 一样, L2TP 通常与 IPsec 搭配使用, 因此它也存在前面提到的漏洞.</li><li><strong>速度慢</strong>: 该协议封装数据两次, 这种方法对某些应用程序很有用, 但与只封装数据一次的其他协议相比, 速度较慢.</li><li><strong>无法绕过防火墙</strong>: 与其他 VPN 协议不同, L2TP 没有其他方法来穿过防火墙. 面向监视的系统管理员使用防火墙来封锁 VPN, 而自行设置 L2TP 的人很容易被封锁.</li></ul><h5 id="IKEv2-IPsec"><a href="#IKEv2-IPsec" class="headerlink" title="IKEv2/IPsec"></a>IKEv2/IPsec</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_8IBikwmw.webp" alt="20241229154732_8IBikwmw.webp"></p><p>**IKEv2 (Internet Key Exchange version 2) ** 是一种提供安全密钥交换会话的隧道协议, 该协议是微软和思科合作的成果. 与 L2TP 类似, 它通常与 IPsec 配对使用以提供身份验证和加密功能. 它由 <strong>IETF RFC 7296</strong> 定义, 是 IKE (Internet Key Exchange) 协议的改进版本.</p><p>IKEv2 的主要功能是协商和管理加密密钥, 确保通信双方能够以安全和高效的方式加密数据.</p><p>配置相对复杂, 特别是在手动部署服务器时, 且需要占用 2 个端口:</p><ul><li><strong>UDP 500</strong>: IKEv2 的默认端口, 用于初始连接和 IKE 协商.</li><li><strong>UDP 4500</strong>: 当 NAT 穿越 (NAT-T) 被检测到时, IKEv2 切换到此端口.</li></ul><p><strong>优点</strong></p><ul><li><strong>稳定性</strong>: IKEv2/IPsec 使用一种名为 Mobility and Multi-homing Protocol (MOBIKE) 的技术, 当流量在互联网传输时, 该技术可确保建立 VPN 连接不中断, 使得 IKEv2/IPsec 成为移动设备最可靠和稳定的协议.</li><li><strong>安全性</strong>: 作为 IPsec 套件的一部分, IKEv2/IPsec 可与大多数加密算法配合使用, 使其成为最安全的 VPN 协议.</li><li><strong>速度</strong>: 运行时占用很少的宽带, 而且它的 NAT 穿透技术, 使其连接和通信更快速, 也有助于通过防火墙.</li></ul><p><strong>缺点</strong></p><ul><li><strong>兼容性有限</strong>: IKEv2/IPsec 与许多系统不兼容. 这对 Windows 用户来说不是问题, 因为微软参与制定此协议, 但其他操作系统则可能需要第三方软件才能支持.</li></ul><p>因从 Wi-Fi 切换到移动数据时不会遗失 VPN 连接, <strong>IKEv2/IPsec</strong> 常用在移动设备端.</p><h4 id="WireGuard-是什么"><a href="#WireGuard-是什么" class="headerlink" title="WireGuard 是什么"></a>WireGuard 是什么</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_cKnMu1Wu.webp" alt="20241229154732_cKnMu1Wu.webp"></p><p>是整个 VPN 行业都在谈论的最新、最快速的通道协议. 这种协议使用最先进的加密技术, 使当前的领导者——OpenVPN 和 IKEv2/IPsec 黯然失色.</p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL3BpcmF0ZS93aXJlZ3VhcmQtZG9jcw=="><strong>WireGuard</strong></a> 是由 <code>Jason Donenfeld</code> 等人用 <code>C</code> 语言编写的一个开源 VPN 协议, 被视为下一代 VPN 协议, 旨在解决许多困扰 <code>IPSec/IKEv2</code>、<code>OpenVPN</code> 或 <code>L2TP</code> 等其他 VPN 协议的问题.</p><p>WireGuard 声称其性能比大多数 VPN 协议更好, <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly93d3cuaXBmaXJlLm9yZy9ibG9nL3doeS1ub3Qtd2lyZWd1YXJk">但这个事情有很多争议</a>.</p><p>与在用户空间中运行的 OpenVPN 不同, WireGuard 的优势在于直接集成到 Linux 内核(5.6 开始)中. 这种集成使其能够更高效地处理数据包, 同时最大限度地减少用户空间和内核空间之间的上下文切换.</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_UGdpMK6l.webp" alt="20241229154732_UGdpMK6l.webp"></p><p>WireGuard 仅使用 UDP, 并且通常在 <strong>单个端口上</strong> 运行, 从而简化了其设置和操作. 这与 OpenVPN 形成对比, 后者可以使用 TCP 或 UDP, 并且可能需要根据配置管理多个端口. WireGuard 使用单一协议和端口, 降低了网络配置和防火墙规则的复杂性, 从而提高了整体性能.</p><p>然而精简就意味着功能缺失, <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly93d3cuaXBmaXJlLm9yZy9ibG9nL3doeS1ub3Qtd2lyZWd1YXJk">WireGuard 的局限性</a>, 只能说目前 WireGurad 方式对我来说完全够用.</p><p><strong>优点</strong></p><ul><li><p><strong>免费和开源</strong>: 任何人都能查看代码, 这使得部署、稽核和调试更加容易.</p></li><li><p><strong>精简且速度极快</strong>: 仅由 4000 行代码组成, 是所有协议中“最精简”的协议. 相较之下, OpenVPN 代码行数是它的 100 倍.</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_yJfQlqXb.webp" alt="20241229154732_yJfQlqXb.webp"></p></li></ul><p><strong>缺点</strong></p><ul><li><strong>不完整</strong>: WireGuard 有望成为“下一个大事件”, 但其实施仍处于早期阶段, 还有很大的改进空间. 目前, 它无法为用户提供任何级别的匿名性 (尽管完全匿名是不可能的) , 因此 VPN 提供商需要找到定制的解决方案, 在不损失速度的情况下提供必要的安全性.</li></ul><p><strong>使用时机</strong>: 每当需要速度优先时, 都可以使用 WireGuard: 流媒体、在线游戏或下载大型文件.</p><h5 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h5><p>关于性能比较的更多信息可以参考下面几篇文档:</p><ul><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly93d3cud2lyZWd1YXJkLmNvbS9wZXJmb3JtYW5jZS8=">官方的基准测试</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly93d3cucmVkZGl0LmNvbS9yL2xpbnV4L2NvbW1lbnRzLzlibm93by93aXJlZ3VhcmRfYmVuY2htYXJrX2JldHdlZW5fdHdvX3NlcnZlcnNfd2l0aF8xMC8=">两台具有 10 Gb 以太网的服务器之间的 WireGuard 基准测试</a></li></ul><p>关于 WireGuard 加密的更多资料请参考下方链接:</p><ul><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly93d3cud2lyZWd1YXJkLmNvbS9wYXBlcnMvd2lyZWd1YXJkLnBkZg==">WireGuard: 下一代内核网络隧道</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9lcHJpbnQuaWFjci5vcmcvMjAxOC8wODAucGRm">《WireGuard 协议的密码学分析》</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9jb3Vyc2VzLmNzYWlsLm1pdC5lZHUvNi44NTcvMjAxOC9wcm9qZWN0L0hlLVh1LVh1LVdpcmVHdWFyZC5wZGY=">WireGuard 的安全性分析</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly93d3cud2lyZWd1YXJkLmNvbS90YWxrcy9ibGFja2hhdDIwMTgtc2xpZGVzLnBkZg==">WireGuard 技术分享</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9hcnN0ZWNobmljYS5jb20vZ2FkZ2V0cy8yMDE4LzA4L3dpcmVndWFyZC12cG4tcmV2aWV3LWZhc3QtY29ubmVjdGlvbnMtYW1hemUtYnV0LXdpbmRvd3Mtc3VwcG9ydC1uZWVkcy10by1oYXBwZW4v">WireGuard 评测: 新型 VPN 具有显著优势</a></li></ul><p>下面是一些有助于密钥分发和部署的服务:</p><ul><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9weXBpLm9yZy9wcm9qZWN0L3dpcmVndWFyZC1wMnAv">WireGuard 点对点连接的工具</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL3RyYWlsb2ZiaXRzL2FsZ28=">一组 Ansible 脚本, 简化 WireGuard 和 IPsec VPN 的设置</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL1N0cmVpc2FuZEVmZmVjdC9zdHJlaXNhbmQ=">Streisand</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL2l0czB4MDgvd2ctaW5zdGFsbA==">用 Bash 编写的 WireGuard 自动安装程序</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL2JyaXR0c29uL3dpcmVndWFyZF9jb25maWdfbWFrZXI=">WireGuard 配置生成器</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly93d3cud2lyZWd1YXJkY29uZmlnLmNvbS8=">Web 端 WireGuard 配置生成器</a></li></ul><hr><h4 id="WireGuard-使用场景"><a href="#WireGuard-使用场景" class="headerlink" title="WireGuard 使用场景"></a>WireGuard 使用场景</h4><p>利用 WireGuard 可以组建非常复杂的网络拓扑, 根据网络环境的不同通常有多种配置方式:</p><h5 id="1-端到端直接连接"><a href="#1-端到端直接连接" class="headerlink" title="1. 端到端直接连接"></a>1. 端到端直接连接</h5><p>这是最简单的拓扑, 所有的节点要么在同一个局域网, 要么直接通过公网访问, 这样 <code>WireGuard</code> 可以直接连接到对端, 不需要中继跳转.</p><h5 id="2-局域网到外网"><a href="#2-局域网到外网" class="headerlink" title="2. 局域网到外网"></a>2. 局域网到外网</h5><p>比如在家访问公司局域网, 或者在公司访问家庭局域网. 最简单的方案是通过公网暴露的一端作为服务端, 另一端指定服务端的公网地址和端口, 然后通过 <code>persistent-keepalive</code> 选项维持长连接, 让 NAT 记得对应的映射关系.</p><h5 id="3-两端都位于-NAT-之后"><a href="#3-两端都位于-NAT-之后" class="headerlink" title="3. 两端都位于 NAT 之后"></a>3. 两端都位于 NAT 之后</h5><p><strong>3.1 使用中继服务器</strong></p><p>大多数情况下, 当通信双方都在 NAT 后面的时候, NAT 会做源端口随机化处理, 直接连接可能比较困难. 可以加一个 <strong>中继服务器</strong>, 通信双方都将中继服务器作为对端, 然后维持长连接, 流量就会通过中继服务器进行转发.</p><p><strong>3.2 打洞</strong></p><p>上面也提到了, 当通信双方都在 NAT 后面的时候, 直接连接不太现实, 因为大多数 NAT 路由器对源端口的随机化相当严格, 不可能提前为双方协调一个固定开放的端口. 必须使用一个信令服务器 (<code>STUN</code>, [[nat-guide|自建 STUN Server?]]), 它会在中间沟通分配给对方哪些随机源端口. 通信双方都会和公共信令服务器进行初始连接, 然后它记录下随机的源端口, 并将其返回给客户端.</p><blockquote><p>这就是现代 P2P 网络中 <code>WebRTC</code> 的工作原理. 有时候, 即使有了信令服务器和两端已知的源端口, 也无法直接连接, 因为 NAT 路由器严格规定只接受来自原始目的地址 (信令服务器) 的流量, 会要求新开一个随机源端口来接受来自其他 IP 的流量 (比如其他客户端试图使用原来的通信源端口) . 运营商级别的 NAT 就是这么干的, 比如蜂窝网络和一些企业网络, 它们专门用这种方法来防止打洞连接.</p></blockquote><hr><h3 id="WireGuard-配置实例"><a href="#WireGuard-配置实例" class="headerlink" title="WireGuard 配置实例"></a>WireGuard 配置实例</h3><h4 id="点对点"><a href="#点对点" class="headerlink" title="点对点"></a>点对点</h4><p>常见的应用场景: 将一台计算机连接到远程网络, 并使其能够像在本地网络中一样访问所有资源. 例如连接到公司的内部网络, 远程提交代码, 访问公司内部的 Wiki 等; 远程连到家庭网络看个小电影, 听听 NAS 的无损音乐什么的.</p><p>远程 WireGuard 端点中的位置非常灵活. 它可以位于防火墙、路由器或其他任何网络设备上. 这意味着我们可以根据实际需求选择最合适的部署位置.</p><blockquote><p>简单说明一下:</p><p><strong>在 WireGuard 里, 客户端和服务端基本是平等的, 差别只是谁主动连接谁而已</strong>.</p><p>双方都会监听一个 UDP 端口, 谁主动连接, 谁就是客户端. 主动连接的客户端需要指定对端的公网地址和端口, 被动连接的服务端不需要指定其他对等节点的地址和端口.</p><p>值得强调的是: <strong>安装的 WireGuard 的服务器, 既可以作为服务端也可以作为客户端.</strong></p><p>后面我会直接是用 <strong>服务端</strong> 和 <strong>客户端</strong> 来简单区分不同的对端, 所以需要提前说明一下这个概念.</p></blockquote><p><strong>网络拓扑图</strong>:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">                       公网</span><br><span class="line">                      xxxxxx             ppp0 ┌────────┐</span><br><span class="line">┌────┐               Xxx   xxxx             ──┤ 路由器  │</span><br><span class="line">│    ├─ppp0         xxx      xx               └───┬────┘</span><br><span class="line">│    │              xx        x                   │         home 192.168.31.0/24</span><br><span class="line">│    │               xxx    xxx                   └───┬─────────┬─────────┐</span><br><span class="line">└────┘                 xxxxx                          │         │         │</span><br><span class="line">                                                    ┌─┴─┐     ┌─┴─┐     ┌─┴─┐</span><br><span class="line">                                                    │   │     │   │     │   │</span><br><span class="line">                                                    │pi4│     │NAS│     │...│</span><br><span class="line">                                                    │   │     │   │     │   │</span><br><span class="line">                                                    └───┘     └───┘     └───┘</span><br></pre></td></tr></tbody></table></figure><p>这幅图展示了典型的家庭/小型公司网络拓扑结构. 通常会有一个由 ISP 提供的光猫, 下面通过路由器拨号上网, 以及一些内部设备, 如 Raspberry PI、NAS 和其他设备.</p><p><strong>安装方法</strong>:</p><p>可以选择以下两种方法之一来部署 WireGuard:</p><ol><li><strong>在路由器上部署</strong>: 如果使用 <strong>OpenWrt</strong> 作为主路由系统的话, 这是最常见且简单的的方法;</li><li><strong>在局域网中的另一个系统上部署</strong>: 比如在公司可能没有权限对路由器做任何配置(但是申请 <strong>开放一个端口映射</strong> 还是可以的), 或者路由器无法安装 <strong>WireGuard</strong> 的时, 只能使用这种方式(比如我在公司部署了一台 R2S 小型服务器); 在家庭网络也采用这种方式(因为考虑到稳定性, 使用 AX9000 和 6500Pro 作为主路由且没有开启 root 权限, 只作为普通路由器使用)</li></ol><p><strong>服务端和客户端</strong>:</p><p>请注意, 在这种场景中部署的 <strong>WireGuard</strong> 我称为 <strong>服务端</strong>, 意思是不会有 <strong>WireGuard Endpoint</strong> 配置, Endpoint 配置应该在需要访问家庭/公司网络的外部设备上(主动连接家庭/公司网络中的 WireGuard 服务, 我称为 <strong>客户端</strong>).</p><blockquote><p>我没有 <strong>OpenWrt</strong> 系统的主路由器, 所以需要在主路由上配置端口转发规则, 将指定流量转发到部署了 <strong>WireGuard</strong> 的内部服务器上.</p><p>如果你的主路由器是 OpenWrt 系统, 可以自行查阅配置方式, 方式都大同小异.</p></blockquote><p>下面我将在 <strong>Ubuntu</strong>, <strong>Armbian</strong>, <strong>NAS</strong> 和 <strong>R2S</strong> (OpenWrt 系统, 作为二级路由器) 上部署 <strong>WireGuard</strong> 服务, 这些系统覆盖了大多数常见的系统类型, 以此来说明在各个系统上如何部署, 配置与使用 <strong>WireGuard</strong>.</p><p>值得推荐的 <strong>WireGuard</strong> 管理工具:</p><ul><li><p><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL3dnLWVhc3kvd2ctZWFzeQ==">wg-easy</a>: 简单易用的 <strong>WireGuard 服务端</strong>;</p></li><li><p><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL25nb2R1eWtoYW5oL3dpcmVndWFyZC11aQ==">wireguard-ui</a>: 比前者稍微复杂一点, 不过功能更多;</p></li></ul><hr><h5 id="Ubuntu"><a href="#Ubuntu" class="headerlink" title="Ubuntu"></a>Ubuntu</h5><p>M920x 部署了 Ubuntu Server, 所以这里直接是用它来部署 <strong>WireGuard</strong>.</p><p>网络拓扑图 1: 只接入联通网络</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/ubuntu-wireguard.drawio.svg" alt="ubuntu-wireguard.drawio.svg"></p><ol><li>将 <strong>10.10.1.0/24</strong> 作为 <strong>WireGuard</strong> 的网络, 和现在的联通网络分开;</li><li>M920x 添加一个 <strong>wg0</strong> 网卡, 并使用 <strong>10.10.1.1/32</strong> (不需要自己去手动添加 <strong>wg0</strong> 网卡, <strong>WireGuard</strong> 部署启动成功后会自行添加);</li><li>外网的 MBP 使用 <strong>10.10.1.8/32</strong> 作为它的 <strong>WireGuard</strong> 网络 IP;</li><li>联通网络的 IP 段 为 <strong>192.168.21.0/24</strong>;</li></ol><blockquote><p>我们的目的是让在外网的 MBP 能通过 <strong>WireGuard</strong> 接入到 M920x 上部署的 <strong>wg0</strong> 网络, 并且能访问家中联通网络下的任意设备.</p><p>接下来就是无聊的安装部署与配置环节.</p><p>总体流程:</p><ol><li>安装 WireGuard;</li><li>生成公钥和私钥;</li><li>添加 wg0.conf 配置;</li><li>配置防火墙和 IP 转发;</li><li>添加 Peer 节点;</li><li>客户端使用;</li></ol></blockquote><hr><p><strong>WireGuard</strong> 可从默认的 Ubuntu 软件源中获得:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install wireguard</span><br></pre></td></tr></tbody></table></figure><p>这将安装 WireGuard 模块和工具, WireGuard 作为内核模块运行.</p><blockquote><p>下面的操作都是 root 用户.</p></blockquote><p>为 M920x 生成密钥:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/wireguard</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成私钥</span></span><br><span class="line">wg genkey &gt; m920x-private.key</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过私钥生成公钥</span></span><br><span class="line">wg pubkey &lt; m920x-private.key &gt; m920x-public.key</span><br></pre></td></tr></tbody></table></figure><p>为 MBP 生成密钥:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wg genkey &gt; mbp-private.key</span><br><span class="line">wg pubkey &lt; mbp-private.key &gt; mbp-public.key</span><br></pre></td></tr></tbody></table></figure><p>创建 <strong>wg0.conf</strong> 配置文件(是 <strong>数字 0</strong>, 不是字母 o, 我怕你字体有问题, 所以提醒一下):</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[Interface]</span><br><span class="line">Address = 10.10.1.1/32</span><br><span class="line">ListenPort = 51000</span><br><span class="line">PrivateKey = &lt;M920x 的私钥: m920x-private.key&gt;</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MBP</span></span><br><span class="line">PublicKey = &lt;MBP 的公钥: mbp-public.key&gt;</span><br><span class="line">AllowedIPs = 10.10.1.8/32</span><br></pre></td></tr></tbody></table></figure><blockquote><p>这里不要搞混了, Interface 填写的是当前主机的 <strong>私钥</strong>, 对等点(Peer) 填写的是其他设备的 <strong>公钥</strong>.</p></blockquote><p>配置防火墙和 IP 转发 (<code>vim /etc/sysctl.conf</code>):</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">防火墙我直接关闭, 如果不关闭就要放行 51000 端口</span></span><br><span class="line">sudo ufw allow 51000/udp</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置 IPv4 转发, 用于允许内核在网络接口间转发流量</span></span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果需要在 IPv6 环境下启用 WireGuard, 还需要添加下面的配置</span></span><br><span class="line">net.ipv6.conf.all.forwarding=1</span><br></pre></td></tr></tbody></table></figure><blockquote><p>使用 <code>sysctl -p</code> 使上述配置生效.</p></blockquote><p>最后启动 <strong>WireGuard</strong>:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wg-quick up wg0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止命令为:</span></span><br><span class="line">wg-quick down wg0</span><br></pre></td></tr></tbody></table></figure><p>启动成功后, 在 <strong>M920x</strong> 上使用 <code>ip a</code> 可以找到一个 <strong>wg0</strong> 的虚拟网卡, 大概是这样的:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wg0: &lt;POINTOPOINT,NOARP,UP,LOWER_UP&gt; mtu 1420 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">  link/none</span><br><span class="line">  inet 10.10.1.1/24 scope global wg0</span><br><span class="line">     valid_lft forever preferred_lft forever</span><br><span class="line">  inet6 fd45:da8::1/64 scope global</span><br><span class="line">     valid_lft forever preferred_lft forever</span><br></pre></td></tr></tbody></table></figure><p>MBP 的 <strong>WireGuard</strong> 配置 (macOS 下的 WireGuard 在 <strong>非国区</strong> App Store 免费下载):</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[Interface]</span><br><span class="line">PrivateKey = &lt;MBP 的私钥: mbp-private.key&gt;</span><br><span class="line">Address = 10.10.1.8/32</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = &lt;M920x 的公钥: m920x-public.key&gt;</span><br><span class="line">AllowedIPs = 10.10.1.0/24</span><br><span class="line">Endpoint = &lt;M920x 的公网域名, 比如 m920x.dong4j.tele:51000&gt;</span><br><span class="line">PersistentKeepalive = 25</span><br></pre></td></tr></tbody></table></figure><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_Z8p68U3k.webp" alt="20241229154732_Z8p68U3k.webp"></p><p>MBP 上 <strong>WireGuard</strong> 创建的网卡信息:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">utun6: flags=8051&lt;UP,POINTOPOINT,RUNNING,MULTICAST&gt; mtu 1420</span><br><span class="line">	options=6460&lt;TSO4,TSO6,CHANNEL_IO,PARTIAL_CSUM,ZEROINVERT_CSUM&gt;</span><br><span class="line">	inet 10.10.1.8 --&gt; 10.10.1.8 netmask 0xffffffff</span><br></pre></td></tr></tbody></table></figure><p>然后我们可以是用 <strong>ping</strong> 来验证是否成功:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_0ZJwRAa3.webp" alt="20241229154732_0ZJwRAa3.webp"></p><p>也能成功访问 M920x 上的服务:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_CinOUXRU.webp" alt="20241229154732_CinOUXRU.webp"></p><p>在 <strong>M920x</strong> 上使用 <strong>wg</strong> 查看 <strong>WireGuard</strong> 信息:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_4Yr9870g.webp" alt="20241229154732_4Yr9870g.webp"></p><hr><p>上述配置将局域网内的 M920x 和外网的 MBP 成功的加入到 <strong>10.10.1.0/24</strong> 这个局域网内, 但是目前也只能在这个子网内通信, 如果我想让 MBP 访问 M920x 所在的 <strong>192.168.21.0/24</strong> 这个局域网, MBP 则需要如下配置:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[Interface]</span><br><span class="line">PrivateKey = &lt;MBP 的私钥: mbp-private.key&gt;</span><br><span class="line">Address = 10.10.1.8/32</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = &lt;M920x 的公钥: m920x-public.key&gt;</span><br><span class="line">AllowedIPs = 10.10.1.0/24, 192.168.21.0/24</span><br><span class="line">Endpoint = &lt;M920x 的公网域名, 比如 m920x.dong4j.tele:51000&gt;</span><br><span class="line">PersistentKeepalive = 25</span><br></pre></td></tr></tbody></table></figure><p><code>AllowedIPs = 10.10.1.0/24, 192.168.21.0/24</code> 表示: 来自 <code>10.10.1.0/24, 192.168.21.0/24</code> 的流量全部通过 <strong>WireGuard</strong> 的网卡(MBP 上的 utun6 网卡)发往 <strong>M920x</strong>, 我们来详细了解一下整个链路是怎样的:</p><ol><li><p>MBP 请求 <strong><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cDovLzE5Mi4xNjguMjEuMS8=">http://192.168.21.1</a></strong> 访问小米路由器的 WebUI;</p></li><li><p>流量从 MBP 的 utun6 网卡发往 M920x:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">netstat -rn</span></span><br><span class="line">Routing tables</span><br><span class="line"></span><br><span class="line">Internet:</span><br><span class="line">Destination        Gateway            Flags               Netif Expire</span><br><span class="line">...</span><br><span class="line">192.168.21         link#34            UCS                 utun6</span><br><span class="line">192.168.21.1       link#34            UHW3I               utun6     82</span><br></pre></td></tr></tbody></table></figure><details class="folding-tag"><summary>🪬 解释如下:</summary><div class="content"><ol><li>192.168.21</li></ol><ul><li>Destination: 目标网络 (网段) , 这里是 192.168.21, 通常表示子网.</li><li>Gateway: link#34 表示无需通过网关, 直接通过指定接口访问.</li><li>Flags:<ul><li>U: 路由可达 (Up) .</li><li>C: 直接连接的网络 (Connected) .</li><li>S: 静态路由 (Static route) .</li></ul></li><li>Netif: utun6 是虚拟网络接口, 常见于 VPN 或隧道连接.</li></ul><ol start="2"><li>192.168.21.1</li></ol><ul><li>Destination: 单个主机地址.</li><li>Gateway: link#34, 表示通过物理或虚拟接口访问.</li><li>Flags:<ul><li>U: 路由可达.</li><li>H: 主机路由 (Host route) .</li><li>W3: 通常与 VPN 相关, 表示接口状态.</li><li>I: 可能是临时或动态的接口.</li></ul></li><li>Netif: 使用 utun6 接口.</li><li>Expire: 82 表示该路由将在 82 秒后过期, 通常是动态路由.</li></ul></div></details></li><li><p>数据包进入主机后, 内核会检查: 如果数据包的目标端口是 <strong>WireGuard</strong> 配置的 UDP 监听端口 (51000) , 系统会将流量交给 wg0 接口进行解密, 否则就会被丢弃;</p></li><li><p>解密后的流量会被系统路由表或 NAT 表处理, 决定最终的流量去向; 而 M920x 的路由表情况为:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">route -n</span></span><br><span class="line">内核 IP 路由表</span><br><span class="line">目标            网关            子网掩码        标志  跃点   引用  使用 接口</span><br><span class="line">0.0.0.0         192.168.21.1    0.0.0.0         UG    101    0        0 enx00e04c680012</span><br><span class="line">...</span><br><span class="line">10.10.1.8       0.0.0.0         255.255.255.255 UH    0      0        0 wg0</span><br><span class="line">192.168.21.0    0.0.0.0         255.255.255.0   U     101    0        0 enx00e04c680012</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure><p>上面表示 <strong>192.168.21.0</strong> 的流量会通过 M920x 的 <code>enx00e04c680012</code> 网卡处理;</p></li></ol><p>在 MBP 上使用 <code>traceroute 192.168.21.1</code> 查看一下请求路径:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">traceroute 192.168.21.1</span></span><br><span class="line">traceroute to 192.168.21.1 (192.168.21.1), 64 hops max, 40 byte packets</span><br><span class="line"> 1  10.10.1.1 (10.10.1.1)  35.225 ms  34.738 ms  35.507 ms</span><br><span class="line"> 2  192.168.21.1 (192.168.21.1)  37.286 ms  36.622 ms  38.947 ms</span><br></pre></td></tr></tbody></table></figure><ol><li><p><strong>第一跳</strong>: <code>10.10.1.1</code> 是 WireGuard 隧道对端的虚拟 IP, 通常是服务器的 WireGuard 接口地址. 这说明流量通过 wg0 接口成功进入 WireGuard 隧道.</p></li><li><p><strong>第二跳</strong>: <code>192.168.21.1</code> 是目标地址, 表明 WireGuard 隧道对端 (服务器) 接收了流量, 并通过服务器上的路由规则转发到了 <code>192.168.21.0/24</code> 子网.</p></li></ol><p>而 M920x 的路由规则为:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip route show 192.168.21.0/24</span></span><br><span class="line">192.168.21.0/24 dev enx00e04c680012 proto kernel scope link src 192.168.21.7 metric 101</span><br></pre></td></tr></tbody></table></figure><p>如果数据包的目标地址属于 <code>192.168.21.0/24</code> 子网, 并且没有其他更优的路由规则, 系统将通过 <code>enx00e04c680012</code> 接口发送这些数据包.</p><blockquote><p>值得说明的是, <code>net.ipv4.ip_forward = 1</code> 这个配置是转发流量的关键.</p></blockquote><hr><p>因为我的 M920x 分别连接了电信(192.168.31.0/24) 和联通(192.168.21.0/24) 网络, 我的目的是通过 M920x 的 <strong>WireGuard</strong> 访问 2 个网络下的所有设备和服务,</p><p>网络拓扑图 2: 接入电信和联通网络</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/ubuntu-wireguard-double.drawio.svg" alt="ubuntu-wireguard-double.drawio.svg"></p><ol><li>M920x 具备双网卡, IP 分别是 <code>192.168.31.7/32</code>(电信) 和 <code>192.168.21.7/32</code> (联通);</li><li>MBP 的 <strong>WireGuard</strong> IP 保持不变;</li></ol><p>为了满足上述需求, 我们需要修改 MBP 的 WireGuard 客户端配置:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[Interface]</span><br><span class="line">PrivateKey = &lt;MBP 的私钥: mbp-private.key&gt;</span><br><span class="line">Address = 10.10.1.8/32</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = &lt;M920x 的公钥: m920x-public.key&gt;</span><br><span class="line">AllowedIPs = 10.10.1.0/24, 192.168.21.0/24, 192.168.31.0/24</span><br><span class="line">Endpoint = &lt;M920x 的公网域名, 比如 m920x.dong4j.tele:51000&gt;</span><br><span class="line">PersistentKeepalive = 25</span><br></pre></td></tr></tbody></table></figure><p>配置完成后, 即可访问家中 2 个内网中所有的设备.</p><p><strong>网卡优先级的问题</strong> <a id="网卡优先级的问题" style="display:none"></a></p><p>上面的网络拓扑图我隐藏了一个细节: 只有在流量通过联通公网进入时才能访问家中的设备, 如果是从电信公网走, 你会发现 <strong>WireGuard</strong> VPN 通道都建立不上(这里的意思是指 MBP 的 WireGuard 配置中的 <strong>Endpoint</strong>, 联通配置的是 <code>m920x.dong4j.unic:51000</code>, 电信配置的是 <code>m920x.dong4j.tele:51000</code>).</p><p>原因是 <strong>多网卡优先级导致的</strong>:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/wireguard-nat1.drawio.svg" alt="wireguard-nat1.drawio.svg"></p><p><strong>流量进入网卡后的具体流程</strong>:</p><ol><li>电信网络握手请求：<ul><li>数据包从电信公网进入路由器，根据路由器上设置的端口映射将流量转发至 <code>192.168.31.7:51000</code>;</li><li>数据包进入 M920x 的电信网卡 (<code>192.168.31.7</code>);</li></ul></li><li>WireGuard 服务接收数据包：<ul><li>WireGuard 接收请求，准备生成握手响应包。</li></ul></li><li>数据包从默认路由返回：<ul><li>因为联通网卡 (<code>192.168.21.7</code>) 的优先级高，握手响应包走联通网卡发出。</li><li>响应包的源 IP 为联通公网 IP(<code>40.40.40.40</code>)，而客户端期待的是电信公网 IP(<code>20.20.20.20</code>)。</li></ul></li><li>客户端丢弃响应包：<ul><li>客户端验证响应包的源 IP (<code>40.40.40.40</code>)，发现与握手请求的目标 IP(<code>20.20.20.20</code>) 不一致，认为这是无效包。</li></ul></li></ol><p>WireGuard 的握手过程依赖 UDP 数据包，并且会严格检查响应包的以下属性：</p><ol><li>源 IP 必须与目标 IP 匹配：<ul><li>客户端发送握手请求时记录目标 IP（比如电信公网 IP）;</li><li>如果服务端返回的包源 IP 是联通公网 IP，客户端无法将其与最初的请求匹配;</li></ul></li><li>UDP 四元组验证：<ul><li>客户端会验证返回包的 UDP 四元组（源 IP、目标 IP、源端口、目标端口）;</li><li>如果源 IP 不对，整个握手流程就失败;</li></ul></li></ol><blockquote><p><strong>M920x</strong> 网卡优先级: enx00e04c680012(联通) &gt; en01(电信)</p><p>当 WireGuard 服务端收到客户端的握手包时, 解密后需要发送回客户端, 因为 enx00e04c680012 (102.168.31.7) 优先级高于 en01, 所以会使用 enx00e04c680012(192.168.21.7) 网卡回复响应, 数据包经过联通路由器时, NAT 将源地址修改为联通公网 IP, 导致客户端无法验证响应包的源 IP, 最终握手失败.</p></blockquote><hr><p><strong>添加自启动</strong></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable wg-quick@{配置名}</span><br></pre></td></tr></tbody></table></figure><p>你可以在同一台服务器上部署多个 WireGuard 服务, 所以可以配置多个自启动, 比如现在的配置是 <code>wg0.conf</code>, 那么 <strong>配置名</strong> 就是 <code>wg0</code>;</p><blockquote><p>在清楚 <strong>WireGuard</strong> 的基础配置与使用流程后 , Linux 环境下推荐直接使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL2h3ZHNsMi93aXJlZ3VhcmQtaW5zdGFsbA==">一键部署脚本</a> 来简化操作, 另一个 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL2FuZ3Jpc3Rhbi93aXJlZ3VhcmQtaW5zdGFsbA==">一键部署脚本</a>.</p></blockquote><hr><h5 id="NAS"><a href="#NAS" class="headerlink" title="NAS"></a>NAS</h5><p>NAS 需要安装 <strong>WireGuard</strong> SPK 包才能正常使用, 这里是 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly93d3cuYmxhY2t2b2lkLmNsdWIvd2lyZWd1YXJkLXNway1mb3IteW91ci1zeW5vbG9neS1uYXMv">各个 DMS 版本的 SPK 包下载地址</a>, 如果你不放心也可以按照教程自行编译.</p><p>我使用第三方套件仓库安装的方式部署:</p><p>在 <strong>套件中心</strong> 新增套件来源</p><ol><li>矿神: <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9zcGs3LmltbmtzLmNvbS8=">https://spk7.imnks.com/</a></li><li>SynoCommunity(同时推荐添加上这个, 有较多的第三方 SPK): <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9wYWNrYWdlcy5zeW5vY29tbXVuaXR5LmNvbS8=">https://packages.synocommunity.com/</a></li></ol><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_LMIScRak.webp" alt="20241229154732_LMIScRak.webp"></p><p>使用 SSH 登录 NAS, 然后按照要求执行一下:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i 's/package/root/g' /var/packages/WireGuard/conf/privilege</span><br></pre></td></tr></tbody></table></figure><p>修改完可以确定一下, 如果有问题还可以用 vi 去编辑:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@DS218:~# cat /var/packages/WireGuard/conf/privilege</span><br><span class="line">{</span><br><span class="line">    "defaults": {</span><br><span class="line">        "run-as": "root"</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>为了能通过 <strong>WireGuard</strong> 访问电信和联通的内网, 还需要 IP 转发 (<code>vim /etc/sysctl.conf</code>):</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 配置 IPv4 转发, 用于允许内核在网络接口间转发流量</span><br><span class="line">net.ipv4.ip_forward = 1</span><br></pre></td></tr></tbody></table></figure><p>后续的配置与在 Ubuntu 上一致, 最后使用 <code>wg-quick up {配置名}</code> 启动即可, 不需要显式设置自启动, DSM 系统会自己启动.</p><hr><h5 id="OpenWrt"><a href="#OpenWrt" class="headerlink" title="OpenWrt"></a>OpenWrt</h5><p><strong>OpenWrt</strong> 同样支持可视化 UI 来配置 <strong>WireGuard</strong>, 且支持 <strong>客户端</strong> 模式.</p><p>推荐你直接刷自带 <strong>WireGuard</strong> 的 <strong>OpenWrt 固件</strong>, 如果没有你也可以按照下图所示去安装必要的软件包(可能需要替换软件源, 或直接通过 pkg 安装):</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_XnylNG0m.webp" alt="20241229154732_XnylNG0m.webp"></p><p>在 <strong>网络-接口</strong> 选项卡下新增一个 <strong>WireGuard</strong> 接口:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_cXBSQwbO.webp" alt="20241229154732_cXBSQwbO.webp"></p><blockquote><p>在某些 <strong>OpenWrt</strong> 系统中, 只能添加一个 <strong>WireGuard</strong> 接口, 比如 NanoPI 的 FriendlyWrt, 推荐你早点换掉, 不然后面无法玩儿更多的功能.</p></blockquote><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_aCOYpRYa.webp" alt="20241229154732_aCOYpRYa.webp"></p><p>只需要填写 <strong>私钥</strong>, <strong>监听端口</strong> 和 IP 地址即可.</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_bMy4D8kx.webp" alt="20241229154732_bMy4D8kx.webp"></p><p>只需要填写 <strong>公钥</strong>, <strong>允许的 IP</strong>, <strong>勾选路由允许的 IP</strong> 即可, 其他 3 个可以在客户端配置上修改.</p><p>最后是配置防火墙, 允许 <strong>51000</strong> 进出即可(因为我把 <strong>WireGuard_Test</strong> 划分到 wan 区域了, 所以这里是 <strong>wan</strong>).</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_4ZWQaS6z.webp" alt="20241229154732_4ZWQaS6z.webp"></p><p>配置完成后, 最好重启一下 <strong>WireGuard_Test</strong> 接口, 最后配置客户端即可可到状态:</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_jWU0hNzh.webp" alt="20241229154732_jWU0hNzh.webp"></p><hr><h6 id="lan-改-wan-口"><a href="#lan-改-wan-口" class="headerlink" title="lan 改 wan 口"></a>lan 改 wan 口</h6><p>像 R2S, R5S 和 H28K 这类 OpenWrt 系统, 网口分别是一个 WAN 口一个 LAN 口(R5S 有 2 个 2.5G LAN 口, 1 个千兆 WAN 口, 但是我需要使用到 2 个 2.5G 的网口作为 WAN 口连接电信和联通网络), 为了满足通过一台设备即可同时访问家中的 2 个内网, 需要将 LAN 口改成 WAN 口.</p><p>我以 H28K 为例, 记录一下修改方式:</p><p>todo (等把 H28K 重新刷机再写)</p><hr><h5 id="wg-easy-部署"><a href="#wg-easy-部署" class="headerlink" title="wg-easy 部署"></a>wg-easy 部署</h5><p>最简单的方式是使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL3dnLWVhc3kvd2ctZWFzeQ==">wg-easy</a>, 它支持在任何具有 WireGuard 内核的主机上使用 <strong>Docker</strong> 一键部署, 并自带 WebUI. 不过目前 <strong>wg-easy</strong> 还只能作为 <strong>服务端</strong> 使用, 幸运的是 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL3dnLWVhc3kvd2ctZWFzeS9taWxlc3RvbmUvNA==">v15.0.0</a> 版本将开始支持 <strong>客户端</strong> 模式.</p><blockquote><p>这里只是简要说明一下 <strong>wg-easy</strong> 的部署方式, 不会详细展开客户端的使用方式, 所以需要你具备一点 <strong>WireGuard</strong> 使用基础.</p></blockquote><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">etc_wireguard:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">wg-easy:</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">LANG=chs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WG_HOST={你的公网固定</span> <span class="string">ip</span> <span class="string">或</span> <span class="string">DDNS</span> <span class="string">的域名}</span></span><br><span class="line">      <span class="comment"># Optional:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PASSWORD_HASH={2</span> <span class="string">次</span> <span class="string">hash</span> <span class="string">后的密码}</span></span><br><span class="line">      <span class="comment"># - PORT=WebUI 管理端口, 默认为 51821</span></span><br><span class="line">      <span class="comment"># - WG_PORT=WireGuard 的 UDP 端口, 默认为 51820</span></span><br><span class="line">      <span class="comment"># - WG_CONFIG_PORT=92820</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WG_DEFAULT_ADDRESS=10.10.8.x</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WG_DEFAULT_DNS=223.5.5.5</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WG_MTU=1420</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WG_ALLOWED_IPS=192.168.31.0/24,</span> <span class="number">192.168</span><span class="number">.21</span><span class="number">.0</span><span class="string">/24,</span> <span class="number">10.10</span><span class="number">.8</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WG_PERSISTENT_KEEPALIVE=25</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WG_POST_UP=iptables</span> <span class="string">-A</span> <span class="string">FORWARD</span> <span class="string">-i</span> <span class="string">wg0</span> <span class="string">-j</span> <span class="string">ACCEPT;</span> <span class="string">iptables</span> <span class="string">-A</span> <span class="string">FORWARD</span> <span class="string">-o</span> <span class="string">wg0</span> <span class="string">-j</span> <span class="string">ACCEPT;</span> <span class="string">iptables</span> <span class="string">-t</span> <span class="string">nat</span> <span class="string">-A</span> <span class="string">POSTROUTING</span> <span class="string">-o</span> <span class="string">eth1</span> <span class="string">-j</span> <span class="string">MASQUERADE;</span> <span class="string">iptables</span> <span class="string">-t</span> <span class="string">nat</span> <span class="string">-A</span> <span class="string">POSTROUTING</span> <span class="string">-o</span> <span class="string">eth2</span> <span class="string">-j</span> <span class="string">MASQUERADE</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WG_POST_DOWN=iptables</span> <span class="string">-D</span> <span class="string">FORWARD</span> <span class="string">-i</span> <span class="string">wg0</span> <span class="string">-j</span> <span class="string">ACCEPT;</span> <span class="string">iptables</span> <span class="string">-D</span> <span class="string">FORWARD</span> <span class="string">-o</span> <span class="string">wg0</span> <span class="string">-j</span> <span class="string">ACCEPT;</span> <span class="string">iptables</span> <span class="string">-t</span> <span class="string">nat</span> <span class="string">-D</span> <span class="string">POSTROUTING</span> <span class="string">-o</span> <span class="string">eth1</span> <span class="string">-j</span> <span class="string">MASQUERADE;</span> <span class="string">iptables</span> <span class="string">-t</span> <span class="string">nat</span> <span class="string">-D</span> <span class="string">POSTROUTING</span> <span class="string">-o</span> <span class="string">eth2</span> <span class="string">-j</span> <span class="string">MASQUERADE</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">UI_TRAFFIC_STATS=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">UI_CHART_TYPE=1</span> <span class="comment"># (0 Charts disabled, 1 # Line chart, 2 # Area chart, 3 # Bar chart)</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ghcr.io/wg-easy/wg-easy</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">wg-easy</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">etc_wireguard:/etc/wireguard</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"51820:51820/udp"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"51821:51821/tcp"</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">cap_add:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NET_ADMIN</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SYS_MODULE</span></span><br><span class="line">      <span class="comment"># - NET_RAW # ⚠️ Uncomment if using Podman</span></span><br><span class="line">    <span class="attr">sysctls:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">net.ipv4.ip_forward=1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">net.ipv4.conf.all.src_valid_mark=1</span></span><br></pre></td></tr></tbody></table></figure><blockquote><p>更多的配置说明请查看官方文档.</p></blockquote><p>需要说明的有 2 点:</p><ul><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL3dnLWVhc3kvd2ctZWFzeS9ibG9iL21hc3Rlci9Ib3dfdG9fZ2VuZXJhdGVfYW5fYmNyeXB0X2hhc2gubWQ=">密码生成方式</a>: 生成出的密码记得将每个<code>$</code>符号替换为两个<code>$$</code>符号;</li><li>WG_POST_UP 和 WG_POST_DOWN: 因为我有 2 张网卡, 所以这里配置了 2 个 iptables;</li></ul><p>添加一个客户端并下载配置, 或直接使用二维码导入到 WireGuard 的客户端. 最后一步就是在路由器上配置端口转发, 将 <strong>51820</strong> 的流量路由到 <strong>wg-easy</strong> 所在的服务器.</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_lYMPhJNz.webp" alt="20241229154732_lYMPhJNz.webp"></p><p>因为目前 <strong>wg-easy</strong> 的局限性, 更推荐使用手动配置的方式部署 <strong>WireGuard</strong>, 这种方式更加灵活, 能够支持更复杂的网络拓扑架构.</p><hr><h4 id="中继"><a href="#中继" class="headerlink" title="中继"></a>中继</h4><p>如果客户端和服务端都位于 NAT 后面, 需要加一个中继服务器, 客户端和服务端都指定中继服务器作为对等节点, 它们的通信流量会先进入中继服务器, 然后再转发到对端.</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/wireguard_relay.drawio.svg" alt="wireguard_relay.drawio.svg"></p><p>接下来将要实现以阿里云作为中继服务器, 并将流量转发到电信和联通内网, 下面是一些基础情况:</p><ol><li>WireGuard 的虚拟我们设置为局域网为 <code>10.10.4.0/24</code>;</li><li>M920x 2 张网卡分别接入了电信和联通网络;</li><li>外部设备(MBP) 能够在外部访问 <code>10.10.4.0/24</code> 和电信联通内网中的所有设备和服务;</li></ol><p><strong>中继服务器配置如下</strong>:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Interface]</span><br><span class="line">PrivateKey = &lt;中继服务器私钥&gt;</span><br><span class="line">Address = 10.10.4.1/32</span><br><span class="line">ListenPort = &lt;端口号&gt;</span><br><span class="line">PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span><br><span class="line">PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MBP</span></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = &lt;MBP 公钥&gt;</span><br><span class="line">AllowedIPs = 10.10.4.8/32</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">M920X</span></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = &lt;M920x 公钥&gt;</span><br><span class="line">AllowedIPs = 10.10.4.7/32, 192.168.31.0/24, 192.168.21.0/24</span><br></pre></td></tr></tbody></table></figure><p><strong>M920x 配置如下 (前面已经有一个作为服务端的 wg0.conf 配置, 下面是新增的 wg-aliyun.conf 作为客户端的配置)</strong>:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[Interface]</span><br><span class="line">PrivateKey = &lt;M920x 私钥&gt;</span><br><span class="line">Address = 10.10.4.7/32</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = &lt;中继服务器公钥&gt;</span><br><span class="line">AllowedIPs = 10.10.4.0/24</span><br><span class="line">Endpoint = 公网IP:&lt;端口号&gt;</span><br><span class="line">PersistentKeepalive = 25</span><br></pre></td></tr></tbody></table></figure><p>启动: <code>wg-quick up wg-aliyun</code></p><p><strong>MBP 的配置如下</strong>:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[Interface]</span><br><span class="line">PrivateKey = &lt;MBP 私钥&gt;</span><br><span class="line">Address = 10.10.4.8/32</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = &lt;中继服务器公钥&gt;</span><br><span class="line">AllowedIPs = 10.10.4.0/24, 192.168.31.0/24, 192.168.21.0/24</span><br><span class="line">Endpoint = 公网IP:&lt;端口号&gt;</span><br><span class="line">PersistentKeepalive = 25</span><br></pre></td></tr></tbody></table></figure><p>上述配置能让在外网的 MBP 通过中继服务器, 将 <code>192.168.31.0/24</code> 和 <code>192.168.21.0/24</code> 的流量转发到 M920x, 而 M920x 正好在内网, 可以通过本机网卡流量转发来访问 2 个网段, 这里就实现了上述需求.</p><p>在 MBP 本地执行 <code>traceroute 192.168.31.1</code> 来看看跃点路径:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ traceroute 192.168.31.1</span><br><span class="line">traceroute to 192.168.31.1 (192.168.31.1), 64 hops max, 40 byte packets</span><br><span class="line"> 1  10.10.4.1 (10.10.4.1)  12.971 ms  6.369 ms  6.320 ms</span><br><span class="line"> 2  10.10.4.7 (10.10.4.7)  10.887 ms  11.182 ms  11.753 ms</span><br><span class="line"> 3  192.168.31.1 (192.168.31.1)  12.963 ms  12.929 ms  17.214 ms</span><br></pre></td></tr></tbody></table></figure><ol><li>第一跳来到了中继服务器(<code>10.10.4.1</code>);</li><li>第二跳为 M920x (<code>10.10.4.7</code>);</li><li>第三跳则是 M920x 的联通网关 (<code>192.168.31.1</code>);</li></ol><p>接下来是整个流程的分析.</p><p>我们知道在 WireGuard 启动完成后, <code>[Peer]</code> 中的每个 IP 段都会被解析为一个路由, 下面是 <strong>中继服务器的路由表</strong>:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">10.10.4.7       0.0.0.0         255.255.255.255 UH    0      0        0 wg0</span><br><span class="line">10.10.4.8       0.0.0.0         255.255.255.255 UH    0      0        0 wg0</span><br><span class="line">...</span><br><span class="line">192.168.21.0    0.0.0.0         255.255.255.0   U     0      0        0 wg0</span><br><span class="line">192.168.31.0    0.0.0.0         255.255.255.0   U     0      0        0 wg0</span><br></pre></td></tr></tbody></table></figure><p>从上面我们可以看出我们配置的 IP 的流量都会通过 <strong>wg0</strong> 网卡发出.</p><p>而 MBP 的路由表如下所示:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ netstat -rn</span><br><span class="line">Routing tables</span><br><span class="line"></span><br><span class="line">Internet:</span><br><span class="line">Destination        Gateway            Flags               Netif Expire</span><br><span class="line">...</span><br><span class="line">10.10.4.0/24       link#45            UCS                 utun6</span><br><span class="line">10.10.4.7          link#45            UHWIi               utun6</span><br><span class="line">10.10.4.8          10.10.4.8          UH                  utun6</span><br><span class="line">192.168.21         link#45            UCSI                utun6</span><br><span class="line">192.168.31         link#45            UCSI                utun6</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure><p>同样是创建了多条目标路由, 且由 WireGuard 网卡处理流量</p><p>而 M920x 只有一条:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ route -n</span><br><span class="line">内核 IP 路由表</span><br><span class="line">目标            网关            子网掩码        标志  跃点   引用  使用 接口</span><br><span class="line">0.0.0.0        192.168.31.1    0.0.0.0         UG    101    0        0 eno1</span><br><span class="line">10.10.4.0      0.0.0.0         255.255.255.0   U     0      0        0 wg-aliyun</span><br></pre></td></tr></tbody></table></figure><p>所以整个流程如下:</p><ol><li><p><strong>MBP 发出流量</strong>:</p><ul><li><p>MBP 需要访问 192.168.31.0/24 网络, 流量的源地址为 10.10.4.8, 目标地址为 192.168.31.1.</p></li><li><p>根据 MBP 的 WireGuard 配置, 192.168.31.0/24 属于 AllowedIPs 列表.</p></li><li><p>该流量会被路由到 MBP 的 WireGuard 隧道, 发送到中继服务器.</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">源地址: 10.10.4.8</span><br><span class="line">目标地址: 192.168.31.1</span><br><span class="line">出口设备: utun6</span><br></pre></td></tr></tbody></table></figure></li></ul></li><li><p><strong>中继服务器处理流量</strong>:</p><ul><li><p>根据中继服务器的配置:</p><ul><li>AllowedIPs 包括 192.168.31.0/24, 因此流量被转发到与 M920x 的 WireGuard 隧道.</li></ul></li><li><p>中继服务器上的 MASQUERADE 规则被触发, 将源地址改为中继服务器的 WireGuard 地址 10.10.4.1.</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">源地址: 10.10.4.1 (经过 NAT 转换)</span><br><span class="line">目标地址: 192.168.31.1</span><br><span class="line">出口设备: wg0 (到 M920x)</span><br></pre></td></tr></tbody></table></figure></li></ul></li><li><p><strong>M920x 接收流量</strong>:</p><ul><li><p>M920x 收到从中继服务器来的流量:</p><ul><li>源地址为 10.10.4.1</li><li>目标地址为 192.168.31.1</li></ul></li><li><p>根据 M920x 的 WireGuard 配置:</p><ul><li>AllowedIPs 包含 192.168.31.0/24, 因此流量被路由到本地网络.</li></ul></li><li><p>流量离开 M920x, 进入其局域网接口 (eno1) , 并最终到达目标设备 192.168.31.1.</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">源地址: 10.10.4.1</span><br><span class="line">目标地址: 192.168.31.1</span><br><span class="line">出口设备: eno1</span><br></pre></td></tr></tbody></table></figure></li></ul></li><li><p><strong>目标设备的响应</strong>:</p><ul><li><p>目标设备 (192.168.31.1) 处理请求后, 发送响应回到源地址 10.10.4.1.</p></li><li><p>响应流量返回到 M920x 的局域网接口.</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">源地址: 192.168.31.1</span><br><span class="line">目标地址: 10.10.4.1</span><br><span class="line">出口设备: eno1</span><br></pre></td></tr></tbody></table></figure></li></ul></li><li><p><strong>M920x 返回中继服务器</strong>:</p><ul><li><p>根据 WireGuard 隧道规则, 流量被发送回中继服务器.</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">源地址: 192.168.31.1</span><br><span class="line">目标地址: 10.10.4.1</span><br><span class="line">出口设备: wg-aliyun</span><br></pre></td></tr></tbody></table></figure></li></ul></li><li><p><strong>中继服务器返回 MBP</strong>:</p><ul><li><p>根据中继服务器的 NAT 规则, 恢复原始源地址, 将目标地址改为 10.10.4.8.</p></li><li><p>响应流量被转发回 MBP.</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">源地址: 192.168.31.1</span><br><span class="line">目标地址: 10.10.4.8</span><br><span class="line">出口设备: wg0 (到 MBP)</span><br></pre></td></tr></tbody></table></figure></li></ul></li><li><p><strong>MBP 接收响应</strong></p><ul><li>MBP 收到从 192.168.31.1 返回的响应流量, 完成通信.</li></ul></li></ol><p>对于这种中继转发方式部署的 <strong>WireGuard</strong> 服务, 其中 PostUp 是关键:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span><br><span class="line">PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span><br></pre></td></tr></tbody></table></figure><p>用于配置流量转发和 NAT:</p><ol><li><p><code>iptables -A FORWARD -i %i -j ACCEPT</code></p><ul><li>添加一条规则, 允许从 WireGuard 接口 (%i 会被 WireGuard 自动替换为实际接口名, 如 wg0) 进入的流量被转发.</li><li>目的: 确保来自 VPN 客户端的流量能够通过服务器转发.</li></ul></li><li><p><code>iptables -A FORWARD -o %i -j ACCEPT</code></p><ul><li>添加一条规则, 允许从其他网络流出的流量被转发到 WireGuard 接口.</li><li>目的: 允许外部网络的数据包返回到 VPN 客户端.</li></ul></li><li><p><code>iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</code></p><ul><li>在 NAT 表的 POSTROUTING 链中添加一条规则, 对通过 eth0 接口的流量进行地址伪装.</li><li>目的: 将 VPN 客户端的私有 IP (如 10.10.4.0/24) 伪装成服务器的 eth0 公网 IP, 便于访问互联网或外部网络.</li></ul></li></ol><h4 id="打洞"><a href="#打洞" class="headerlink" title="打洞"></a>打洞</h4><p>上面的 <strong>中继服务器</strong> 是通过转发流量的方式达到异地访问的目的, 比如可以将公司和家庭网络打通, 组成一个大的局域网, 达到异地互访的效果.</p><p>但是打洞则不同, 这里的中继服务器有点像 <strong>Dubbo</strong> 中的 <strong>Zookeeper</strong>, 起到一个注册中心的作用, 不转发流量, 当隧道打通后, 两端是通过 <strong>直连</strong> 访问的.</p><p>看过 <a href="/posts/46fb4e89.html">NAT (Network Address Translation)</a> 之后肯定清楚打洞的原理, 只要隧道被打通后, 在 NAT 记录失效之前(UDP 约 30 秒)更新 <strong>WireGuard</strong> 的配置并建立连接就可以直接通信, 实现细节可以参考这篇博客: <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly93d3cuam9yZGFud2hpdGVkLmNvbS9wb3N0cy93aXJlZ3VhcmQtZW5kcG9pbnQtZGlzY292ZXJ5LW5hdC10cmF2ZXJzYWwv">WireGuard Endpoint Discovery and NAT Traversal using DNS-SD</a>, 很有启发意义.</p><hr><h4 id="WireGuard-客户端"><a href="#WireGuard-客户端" class="headerlink" title="WireGuard 客户端"></a>WireGuard 客户端</h4><p>各大应用商店直接搜 <strong>WireGuard</strong> 即可, 免费好用. 但是会存在一个问题: <strong>只能同时开启一个客户端配置</strong>, 对我我这种有多个服务端且需要做复杂均衡的需求就满足不了, 所以官方的客户端就没在使用了, 接下来我将在 Surge 上配置多个 WireGuard 服务端, 且根据网络情况自动选择最优的服务端.</p><h5 id="Surge-上配置-WireGuard"><a href="#Surge-上配置-WireGuard" class="headerlink" title="Surge 上配置 WireGuard"></a>Surge 上配置 WireGuard</h5><p>Surge 配置 WireGuard 非常简单:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[WireGuard 节点名]</span><br><span class="line">private-key = &lt;客户端私钥&gt;</span><br><span class="line">self-ip = 客户端 IP (不用加子网掩码, 比如 10.10.4.8)</span><br><span class="line">dns-server = 自定义</span><br><span class="line">mtu = 1420</span><br><span class="line">peer = (public-key = &lt;服务端公钥&gt;, allowed-ips = "0.0.0.0/0, ::/0", endpoint = &lt;服务端公网 IP&gt;:&lt;端口&gt;, preshared-key = &lt;预共享密钥, 没有就不加&gt;, keepalive = 45)</span><br></pre></td></tr></tbody></table></figure><p><strong>allowed-ips</strong> 我这里配置是所有流量, 后续会通过 <strong>Rule</strong> 来分流特定流量.</p><p>然后在 <strong>Proxy</strong> 节点下使用此节点:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">🧬 Node = wireguard, section-name=节点名, test-url=可以是你内网的 IP(比如 http://192.168.31.1), ip-version=v4-only</span><br><span class="line"></span><br><span class="line">🛜 AX9000 = direct, test-url=http://192.168.31.1, test-timeout=1</span><br></pre></td></tr></tbody></table></figure><p>最后配置相应的规则:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[Rule]</span><br><span class="line"># 所有来自 192.168.31.0/24 的请求全部使用 WireGuard 处理</span><br><span class="line">OR,((IP-CIDR,192.168.31.0/24,no-resolve), (DOMAIN-SUFFIX,xxx)),🧬 Node</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure><p>上述是一个最基础的配置, 其他更多的配置和注意事项可查看 <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9tYW51YWwubnNzdXJnZS5jb20vcG9saWN5L3dpcmVndWFyZC5odG1s">官方教程</a>.</p><p>我的配置稍微复杂一点, 需求大致如下:</p><ol><li>在公司(异地)能访问家里的电信和联通内网;</li><li>在公司访问公司内网走直连, 不走 WireGuard;</li><li>在家能访问公司内网;</li><li>在家访问电信和联通内网走直连, 不走 WireGuard;</li><li>如果只连接了电信或联通其中某一个内网, 也能通过 WireGuard 访问另一个内网;</li></ol><p>为了满足上述需求, 我们需要结合 Surge 的 <strong>fallback</strong> 和 <strong>subnet</strong> 相关的特性, 下面是具体配置.</p><ol><li><p>配置 <strong>WireGuard</strong> 节点:</p><details class="folding-tag"><summary>🪬 多节点配置:</summary><div class="content"><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[WireGuard H28K]</span><br><span class="line">private-key = &lt;客户端私钥&gt;</span><br><span class="line">self-ip = 客户端 IP (不用加子网掩码, 比如 10.10.4.8)</span><br><span class="line">dns-server = 自定义</span><br><span class="line">mtu = 1420</span><br><span class="line">peer = (public-key = &lt;服务端公钥&gt;, allowed-ips = "0.0.0.0/0, ::/0", endpoint = &lt;服务端公网 IP&gt;:&lt;端口&gt;, preshared-key = &lt;预共享密钥, 没有就不加&gt;, keepalive = 25)</span><br><span class="line"></span><br><span class="line">[WireGuard R2S.T]</span><br><span class="line">private-key = &lt;客户端私钥&gt;</span><br><span class="line">self-ip = 客户端 IP (不用加子网掩码, 比如 10.10.4.8)</span><br><span class="line">dns-server = 自定义</span><br><span class="line">mtu = 1420</span><br><span class="line">peer = (public-key = &lt;服务端公钥&gt;, allowed-ips = "0.0.0.0/0, ::/0", endpoint = &lt;服务端公网 IP&gt;:&lt;端口&gt;, preshared-key = &lt;预共享密钥, 没有就不加&gt;, keepalive = 25)</span><br><span class="line"></span><br><span class="line">[WireGuard R2S.U]</span><br><span class="line">private-key = &lt;客户端私钥&gt;</span><br><span class="line">self-ip = 客户端 IP (不用加子网掩码, 比如 10.10.4.8)</span><br><span class="line">dns-server = 自定义</span><br><span class="line">mtu = 1420</span><br><span class="line">peer = (public-key = &lt;服务端公钥&gt;, allowed-ips = "0.0.0.0/0, ::/0", endpoint = &lt;服务端公网 IP&gt;:&lt;端口&gt;, preshared-key = &lt;预共享密钥, 没有就不加&gt;, keepalive = 25)</span><br><span class="line"></span><br><span class="line">[WireGuard R5S]</span><br><span class="line">private-key = &lt;客户端私钥&gt;</span><br><span class="line">self-ip = 客户端 IP (不用加子网掩码, 比如 10.10.4.8)</span><br><span class="line">dns-server = 自定义</span><br><span class="line">mtu = 1420</span><br><span class="line">peer = (public-key = &lt;服务端公钥&gt;, allowed-ips = "0.0.0.0/0, ::/0", endpoint = &lt;服务端公网 IP&gt;:&lt;端口&gt;, preshared-key = &lt;预共享密钥, 没有就不加&gt;, keepalive = 25)</span><br><span class="line"></span><br><span class="line">[WireGuard M920X]</span><br><span class="line">private-key = &lt;客户端私钥&gt;</span><br><span class="line">self-ip = 客户端 IP (不用加子网掩码, 比如 10.10.4.8)</span><br><span class="line">dns-server = 自定义</span><br><span class="line">mtu = 1420</span><br><span class="line">peer = (public-key = &lt;服务端公钥&gt;, allowed-ips = "0.0.0.0/0, ::/0", endpoint = &lt;服务端公网 IP&gt;:&lt;端口&gt;, preshared-key = &lt;预共享密钥, 没有就不加&gt;, keepalive = 25)</span><br><span class="line"></span><br><span class="line">[WireGuard DS218+]</span><br><span class="line">private-key = &lt;客户端私钥&gt;</span><br><span class="line">self-ip = 客户端 IP (不用加子网掩码, 比如 10.10.4.8)</span><br><span class="line">dns-server = 自定义</span><br><span class="line">mtu = 1420</span><br><span class="line">peer = (public-key = &lt;服务端公钥&gt;, allowed-ips = "0.0.0.0/0, ::/0", endpoint = &lt;服务端公网 IP&gt;:&lt;端口&gt;, preshared-key = &lt;预共享密钥, 没有就不加&gt;, keepalive = 25)</span><br><span class="line"></span><br><span class="line">[WireGuard DS923+]</span><br><span class="line">private-key = &lt;客户端私钥&gt;</span><br><span class="line">self-ip = 客户端 IP (不用加子网掩码, 比如 10.10.4.8)</span><br><span class="line">dns-server = 自定义</span><br><span class="line">mtu = 1420</span><br><span class="line">peer = (public-key = &lt;服务端公钥&gt;, allowed-ips = "0.0.0.0/0, ::/0", endpoint = &lt;服务端公网 IP&gt;:&lt;端口&gt;, preshared-key = &lt;预共享密钥, 没有就不加&gt;, keepalive = 25)</span><br><span class="line"></span><br><span class="line">[WireGuard R2S.C]</span><br><span class="line">private-key = &lt;客户端私钥&gt;</span><br><span class="line">self-ip = 客户端 IP (不用加子网掩码, 比如 10.10.4.8)</span><br><span class="line">dns-server = 自定义</span><br><span class="line">mtu = 1420</span><br><span class="line">peer = (public-key = &lt;服务端公钥&gt;, allowed-ips = "0.0.0.0/0, ::/0", endpoint = &lt;服务端公网 IP&gt;:&lt;端口&gt;, preshared-key = &lt;预共享密钥, 没有就不加&gt;, keepalive = 25)</span><br><span class="line"></span><br><span class="line">[WireGuard Aliyun]</span><br><span class="line">private-key = &lt;客户端私钥&gt;</span><br><span class="line">self-ip = 客户端 IP (不用加子网掩码, 比如 10.10.4.8)</span><br><span class="line">dns-server = 自定义</span><br><span class="line">mtu = 1420</span><br><span class="line">peer = (public-key = &lt;服务端公钥&gt;, allowed-ips = "0.0.0.0/0, ::/0", endpoint = &lt;服务端公网 IP&gt;:&lt;端口&gt;, preshared-key = &lt;预共享密钥, 没有就不加&gt;, keepalive = 25)</span><br></pre></td></tr></tbody></table></figure></div></details></li><li><p>配置 <strong>Proxy</strong> 节点:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[Proxy]</span><br><span class="line">🍺 阿里云 = wireguard, section-name=Aliyun ip-version=v4-only</span><br><span class="line"># ########## home ###########</span><br><span class="line">🛜 AX9000 = direct, test-url=http://192.168.31.1, test-timeout=1</span><br><span class="line">🛜 6500 = direct, test-url=http://192.168.21.1, test-timeout=1</span><br><span class="line"></span><br><span class="line"># test-url 和 test-udp 交错, 用于验证双网卡是否正常</span><br><span class="line"># | 🌤️ H28K | 🦠 R2S.T | 🧬 R2S.U | 🎊 R5S | 🤿 M920X | 🎉 DS218+ | 👺 DS923+ |</span><br><span class="line"># |   联通  |    电信  |    联通   |   电信  |   联通   |    电信   |     联通  |</span><br><span class="line">🌤️ H28K = wireguard, section-name=H28K, test-url=http://192.168.31.1, ip-version=v4-only</span><br><span class="line">🦠 R2S.T = wireguard, section-name=R2S.T, test-url=http://192.168.21.1, ip-version=v4-only</span><br><span class="line">🧬 R2S.U = wireguard, section-name=R2S.U, test-url=http://192.168.31.1, ip-version=v4-only</span><br><span class="line">🎊 R5S = wireguard, section-name=R5S, test-url=http://192.168.21.1, ip-version=v4-only</span><br><span class="line">🤿 M920X = wireguard, section-name=M920X, test-url=http://192.168.31.1, ip-version=v4-only</span><br><span class="line">🎉 DS218+ = wireguard, section-name=DS218+, test-url=http://192.168.21.1, ip-version=v4-only</span><br><span class="line">👺 DS923+ = wireguard, section-name=DS923+, test-url=http://192.168.31.1, ip-version=v4-only</span><br><span class="line"># ########## home ###########</span><br><span class="line"></span><br><span class="line"># ########## work ###########</span><br><span class="line">🛜 H3C = direct, test-url=http://192.168.100.1, test-timeout=1</span><br><span class="line">🧩 R2S.C = wireguard, section-name=R2S.C, test-url=http://192.168.100.1, test-timeout=1</span><br><span class="line"># ########## work ###########</span><br><span class="line"></span><br><span class="line">🌐 全球直连 = direct</span><br><span class="line">🚫 拒接连接 = reject</span><br></pre></td></tr></tbody></table></figure><p><code>test-url</code> 表示通过 WireGuard 隧道能访问的地址, 这里直接访问路由器的 WebUI 来测试, 如果愿意折腾的话, 也可以在 HomeLab 自建 CaptivePortal 检测服务.</p><p>🛜 AX9000 和 🛜 6500 都是直连, 且测试地址是路由器网关; 同理 🛜 H3C 的测试地址是公司内网的网关.</p></li><li><p>配置 <strong>Proxy Group</strong> 节点:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[Proxy Group]</span><br><span class="line">🤿 Team = fallback, 🍺 阿里云</span><br><span class="line"></span><br><span class="line">🦠 ALL.in.One = url-test, 🛜 AX9000, 🛜 6500, 🌤️ H28K, 🦠 R2S.T, 🧬 R2S.U, 🎊 R5S, 🤿 M920X, 🎉 DS218+, 👺 DS923+, 🛜 H3C, 🧩 R2S.C, no-alert=true, interval = 600</span><br><span class="line">🏠 iHome = url-test, 🌤️ H28K, 🦠 R2S.T, 🧬 R2S.U, 🎊 R5S, 🤿 M920X, 🎉 DS218+, 👺 DS923+, tolerance=30, interval = 600</span><br><span class="line">💼 Company = url-test, 🧩 R2S.C, tolerance=30, interval = 600</span><br><span class="line"></span><br><span class="line"># mini-intel 开启 surge ponte</span><br><span class="line">🖥️ P.Intel = url-test, DEVICE:MINI-INTEL, hidden=true</span><br><span class="line">🖥️ P.TV = url-test, DEVICE:APPLETV, hidden=true</span><br><span class="line"></span><br><span class="line">🤿 Auto.T = fallback, 🛜 AX9000, 🏠 iHome, 🖥️ P.Intel, 🖥️ P.TV, no-alert=true</span><br><span class="line">🥋 Auto.U = fallback, 🛜 6500, 🏠 iHome, 🖥️ P.Intel, no-alert=true</span><br><span class="line"></span><br><span class="line">🚙 Work = subnet, default = 💼 Company, "192.168.100.1" = 🛜 H3C</span><br></pre></td></tr></tbody></table></figure></li></ol><p>对于家庭网络直接是用 <strong>fallback</strong> 来处理, 表示优先是用 🛜 AX9000 和 🛜 6500, 因为前者是直连模式, 连接测试通过则表示连接了家庭网络, 则直接使用直连 模式; 如果没有连接家庭内网测试会失败, 则回退到第二个规则:🏠 iHome 组, 而 🏠 iHome 组 是由多个 <strong>WireGuard</strong> 节点组成, 会选择延迟最低的一个连接到 家庭网络.</p><p>公司网络则使用 <code>subnet</code> 处理, 表示如果当前网络的网关是 <code>192.168.100.1</code> (公司主路由器), 则使用 💼 Company 组中延迟最低的节点, 现在只有 1 个, 后 面还可以扩展.</p><ol start="4"><li><p>配置 <strong>Rule</strong> 节点:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Rule]</span><br><span class="line">OR,((IP-CIDR,192.168.31.0/24,no-resolve), (DOMAIN-SUFFIX,tele)),🤿 Auto.T</span><br><span class="line">OR,((IP-CIDR,192.168.21.0/24,no-resolve), (DOMAIN-SUFFIX,unic)),🥋 Auto.U</span><br><span class="line"># ############################ work #############################</span><br><span class="line">OR,((IP-CIDR,192.168.100.0/24,no-resolve),(DOMAIN-SUFFIX,yy.xxx.com), (DOMAIN-SUFFIX,xxx.info)),🚙 Work</span><br></pre></td></tr></tbody></table></figure><p>这就简单了, 根据 IP 或域名分流. 其中 <strong>tele</strong> 和 <strong>unic</strong> 是我自定义的内网域名, 分别对应电信和联通网络.</p></li></ol><p>上述配置后, 2 个内网分别由多台服务器提供 WireGuard 节点, 因为 <a href="#%E7%BD%91%E5%8D%A1%E4%BC%98%E5%85%88%E7%BA%A7%E7%9A%84%E9%97%AE%E9%A2%98">网卡优先级的原因</a> 分别划分到电信和联通宽带入口, 因为每台服务器至少存在 2 个网口且分别连接电信和联通内网, 所以我只要任意连接一台服务器就能访问家中 2 个网络, 多台设备起到负载均衡的作用且不会因为单点故障访问不了家庭网络(停电不算).</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_KDb35qW4.webp" alt="20241229154732_KDb35qW4.webp"></p><blockquote><p>关于更多的 Surge 配置, 后续应该还会有文档输出.</p></blockquote><hr><h3 id="WireGuard-配置详解"><a href="#WireGuard-配置详解" class="headerlink" title="WireGuard 配置详解"></a>WireGuard 配置详解</h3><h4 id="详细配置"><a href="#详细配置" class="headerlink" title="详细配置"></a>详细配置</h4><p><strong>服务端</strong>:</p><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Interface]</span></span><br><span class="line"><span class="comment"># [可选] 是否将 Endpoint 持久化到配置文件中, 默认为 false</span></span><br><span class="line"><span class="attr">SaveConfig</span> = <span class="literal">false</span></span><br><span class="line"><span class="comment"># [必须] 当前节点在 WireGuard 虚拟局域网的 IP</span></span><br><span class="line"><span class="attr">Address</span> = <span class="number">10.10</span>.<span class="number">1.1</span>/<span class="number">32</span></span><br><span class="line"><span class="comment"># [必须] 服务端监听的端口</span></span><br><span class="line"><span class="attr">ListenPort</span> = <span class="number">51820</span></span><br><span class="line"><span class="comment"># [必须]</span></span><br><span class="line"><span class="attr">PrivateKey</span> = &lt;服务端密钥&gt;</span><br><span class="line"><span class="comment"># [可选] 客户端将会使用这里指定的 DNS 服务器来处理 VPN 子网中的 DNS 请求, 但也可以在客户端中覆盖此选项</span></span><br><span class="line"><span class="attr">DNS</span> = <span class="number">1.1</span>.<span class="number">1.1</span>,<span class="number">8.8</span>.<span class="number">8.8</span></span><br><span class="line"><span class="comment"># [可选] 定义 VPN 子网使用的路由表, 默认不需要设置, Table = auto (默认值)</span></span><br><span class="line"><span class="comment"># 这里的 Table 是指: /etc/iproute2/rt_tables</span></span><br><span class="line"><span class="comment"># 可以使用 ip route add default via 10.10.1.1 dev eno1 table 12345 来手动添加</span></span><br><span class="line"><span class="attr">Table</span> = <span class="number">12345</span></span><br><span class="line"><span class="comment"># [可选] 默认不需要设置, 一般由系统自动确定</span></span><br><span class="line"><span class="attr">MTU</span> = <span class="number">1500</span></span><br><span class="line"><span class="comment"># [可选] 启动 VPN 接口之前运行的命令. 这个选项可以指定多次, 按顺序执行</span></span><br><span class="line"><span class="attr">PreUp</span> = /bin/example arg1 arg2 %i</span><br><span class="line"><span class="comment"># [可选] 启动 VPN 接口之后运行的命令. 这个选项可以指定多次, 按顺序执行</span></span><br><span class="line"><span class="attr">PostUp</span> = /bin/example arg1 arg2 %i</span><br><span class="line"><span class="comment"># [可选] 停止 VPN 接口之前运行的命令. 这个选项可以指定多次, 按顺序执行</span></span><br><span class="line"><span class="attr">PreDown</span> = /bin/example arg1 arg2 %i</span><br><span class="line"><span class="comment"># [可选] 停止 VPN 接口之后运行的命令. 这个选项可以指定多次, 按顺序执行</span></span><br><span class="line"><span class="attr">PostDown</span> = /bin/example arg1 arg2 %i</span><br><span class="line"></span><br><span class="line"><span class="comment"># Peer: 定义能够为一个或多个地址路由流量的对等节点 (peer) 的 VPN 设置</span></span><br><span class="line"><span class="section">[Peer]</span></span><br><span class="line"><span class="comment"># [必须] 允许该对等节点 (peer) 发送过来的 VPN 流量中的源地址范围, 分别在流量出站和入站时匹配并进行响应的处理</span></span><br><span class="line"><span class="attr">AllowedIPs</span> = <span class="number">10.10</span>.<span class="number">1.2</span>/<span class="number">32</span></span><br><span class="line"><span class="comment"># [必须]</span></span><br><span class="line"><span class="attr">PublicKey</span> = &lt;客户端公钥&gt;</span><br><span class="line"><span class="comment"># [可选] 根据场景配置</span></span><br><span class="line"><span class="attr">PersistentKeepalive</span> = <span class="number">25</span></span><br><span class="line"><span class="comment"># [可选] 预共享密钥, 使用此选项为 VPN 添加另一层加密保护</span></span><br><span class="line"><span class="comment"># 使用 wg genpsk 生成预共享密钥, 客户端的 Peer 节点需要配置相同的密钥</span></span><br><span class="line"><span class="attr">PresharedKey</span> = xxxx</span><br></pre></td></tr></tbody></table></figure><p><strong>客户端</strong>:</p><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Interface]</span></span><br><span class="line"><span class="comment"># [必须]</span></span><br><span class="line"><span class="attr">PrivateKey</span> = +AbVMFfuV/b6WbZub9mxaza+YY7qHXA8QhW1wjouZng=</span><br><span class="line"><span class="comment"># [必须]</span></span><br><span class="line"><span class="attr">Address</span> = <span class="number">10.10</span>.<span class="number">1.2</span>/<span class="number">32</span></span><br><span class="line"><span class="comment"># [可选] 覆盖服务端 DNS 配置</span></span><br><span class="line"><span class="attr">DNS</span> = <span class="number">1.1</span>.<span class="number">1.1</span>,<span class="number">8.8</span>.<span class="number">8.8</span></span><br><span class="line"><span class="comment"># [可选] 配置后将使用固定端口, 不在随机</span></span><br><span class="line"><span class="attr">ListenPort</span> = <span class="number">51820</span></span><br><span class="line"><span class="comment"># 其他的可选字段参考 服务端配置</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Peer]</span></span><br><span class="line"><span class="comment"># [必须]</span></span><br><span class="line"><span class="attr">PublicKey</span> = p4U7Q+tz0brH/RFUU+<span class="number">4</span>yFVL7LcrxNFfMBe+NgYiOYj8=</span><br><span class="line"><span class="comment"># [必须]</span></span><br><span class="line"><span class="attr">AllowedIPs</span> = <span class="number">10.10</span>.<span class="number">1.0</span>/<span class="number">24</span>, <span class="number">192.168</span>.<span class="number">21.0</span>/<span class="number">24</span>, <span class="number">192.168</span>.<span class="number">31.0</span>/<span class="number">24</span></span><br><span class="line"><span class="comment"># [必须]</span></span><br><span class="line"><span class="attr">Endpoint</span> = &lt;homelab.site:port&gt;</span><br><span class="line"><span class="comment"># [可选] 根据场景配置</span></span><br><span class="line"><span class="attr">PersistentKeepalive</span> = <span class="number">25</span></span><br></pre></td></tr></tbody></table></figure><h4 id="Address-24-vs-32"><a href="#Address-24-vs-32" class="headerlink" title="Address: 24 vs 32"></a>Address: 24 vs 32</h4><p>我看网上其他博客说 <strong>如果是中继服务器, 就需要将服务端的 Address 配置成 /24 子网</strong>, 但是我测试过 <strong>/32</strong> 子网也不会出现问题, 那么 <strong>Address</strong> 究竟定义的是什么, 带着这个疑问, 我们来看看不同配置下路由的具体情况:</p><p><strong>Address = 10.10.1.1/32 时</strong>:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wg-quick up wg1</span></span><br><span class="line"><span class="meta prompt_">[#</span><span class="language-bash">] ip <span class="built_in">link</span> add wg1 <span class="built_in">type</span> wireguard</span></span><br><span class="line"><span class="meta prompt_">[#</span><span class="language-bash">] wg setconf wg1 /dev/fd/63</span></span><br><span class="line"><span class="meta prompt_">[#</span><span class="language-bash">] ip -4 address add 10.10.1.1/32 dev wg1</span></span><br><span class="line"><span class="meta prompt_">[#</span><span class="language-bash">] ip <span class="built_in">link</span> <span class="built_in">set</span> mtu 1420 up dev wg1</span></span><br><span class="line"><span class="meta prompt_">[#</span><span class="language-bash">] ip -4 route add 10.10.1.9/32 dev wg1</span></span><br><span class="line"><span class="meta prompt_">[#</span><span class="language-bash">] ip -4 route add 10.10.1.8/32 dev wg1</span></span><br></pre></td></tr></tbody></table></figure><p>启动 WireGuard 后, 自动执行的操作如下:</p><ol><li>创建名为 wg1 的 WireGuard 接口;</li><li>从配置文件加载 WireGuard 的 peer 信息和密钥配置;</li><li>给接口 wg1 分配 10.10.1.1/32 的 IP 地址;</li><li>计算适当的 MTU (如果需要, 可以在配置中覆盖, WireGuard 推荐 1420) ;</li><li>配置静态路由, 使 10.10.1.9 和 10.10.1.8 的流量通过 wg1 接口;</li></ol><p>添加的路由为:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip route show</span></span><br><span class="line">...</span><br><span class="line">10.10.1.8 dev wg1 scope link</span><br><span class="line">10.10.1.9 dev wg1 scope link</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure><p>意思是: <strong>任何指向 10.10.1.8 或 10.10.1.9 的流量将直接通过 wg1 接口发送, 无需经过网关</strong>.</p><p><strong>Address = 10.10.1.1/24 时</strong>:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wg-quick up wg1</span></span><br><span class="line"><span class="meta prompt_">[#</span><span class="language-bash">] ip <span class="built_in">link</span> add wg1 <span class="built_in">type</span> wireguard</span></span><br><span class="line"><span class="meta prompt_">[#</span><span class="language-bash">] wg setconf wg1 /dev/fd/63</span></span><br><span class="line"><span class="meta prompt_">[#</span><span class="language-bash">] ip -4 address add 10.10.1.1/24 dev wg1</span></span><br><span class="line"><span class="meta prompt_">[#</span><span class="language-bash">] ip <span class="built_in">link</span> <span class="built_in">set</span> mtu 1420 up dev wg1</span></span><br></pre></td></tr></tbody></table></figure><p>添加的路由为:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip route show</span></span><br><span class="line">...</span><br><span class="line">10.10.1.0/24 dev wg1 proto kernel scope link src 10.10.1.1</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure><p>这条路由表示: <strong>所有指向 10.10.1.0/24 网络的流量将通过 wg1 接口直接发送, 且数据包的源地址为 10.10.1.1.</strong></p><p>和配置 <strong>/24</strong> 子网的唯一区别就是使用 <code>10.10.1.0/24</code> 代替了单独配置的 <code>10.10.1.8</code>和 <code>10.10.1.9</code>, 然后我们看一下 <strong>10.10.1.1</strong> 如何路由:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip route get 10.10.1.1</span></span><br><span class="line">local 10.10.1.1 dev lo table local src 10.10.1.1 uid 0</span><br><span class="line">    cache &lt;local&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip route show table <span class="built_in">local</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/32 子网输出如下</span></span><br><span class="line">local 10.10.1.1 dev wg1 proto kernel scope host src 10.10.1.1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/24 子网输出如下</span></span><br><span class="line">local 10.10.1.1 dev wg1 proto kernel scope host src 10.10.1.1</span><br><span class="line">broadcast 10.10.1.255 dev wg1 proto kernel scope link src 10.10.1.1</span><br></pre></td></tr></tbody></table></figure><p>不管如何配置, 都是使用 local 路由表, 不同的是 <strong>/24</strong> 多了一条广播配置, 意思是当要向广播地址 10.10.1.255 发送数据包时, 流量会直接通过 wg1 接口广播到同一子网内的其他设备.</p><p><strong>所以我只是想确认一个问题: /32 和 /24 子网分别在什么场景下使用</strong>:</p><table><thead><tr><th><strong>场景</strong></th><th><strong>推荐子网</strong></th><th><strong>理由</strong></th></tr></thead><tbody><tr><td>点对点中继</td><td><code>/32</code></td><td>精确控制目标路由, 减少广播, 提升安全性.</td></tr><tr><td>多点或子网中继</td><td><code>/24</code></td><td>适合多个设备在同一子网通信, 简化路由管理.</td></tr><tr><td>需要节省路由表资源</td><td><code>/32</code></td><td>只处理特定 IP, 避免大范围广播.</td></tr><tr><td>需要全网自动发现和广播通信</td><td><code>/24</code></td><td>允许所有同一子网的设备自动互联.</td></tr></tbody></table><p>综上所述, <strong>服务端的 Address 配置只是代表当前节点在局域网中的设备 IP. 如果非要说影响, 我觉得只能是创建的路由数量不同导致的占用系统资源不同罢了.</strong></p><blockquote><p>所以个人建议如果只是少量设备, 直接配置成 /32 子网即可, 至于什么才是 <strong>少量设备</strong> 就需要自己去定夺了, 反正我 10+ 节点全部配置成了 /32 子网.</p></blockquote><hr><h4 id="AllowedIPs-的作用"><a href="#AllowedIPs-的作用" class="headerlink" title="AllowedIPs 的作用"></a>AllowedIPs 的作用</h4><p>简单来说: <strong>当发送数据包时, AllowedIPs 列表表现为一种路由表, 而当接收数据包时, 允许的 IP 列表表现为一种访问控制列表</strong>:</p><p>前面我们已经知道启动 WireGuard 后, 会将 AllowedIPs IP 列表添加到路由表;</p><ol><li>发送数据时根据这个路由表选择合适的节点加密数据并发送;</li><li>接受到数据时先解密, 成功后还需要对比指定节点的 AllowedIPs IP 列表与数据表的源地址是否匹配;</li></ol><p>为了更好地理解 <strong>WireGuard</strong> 如何处理数据包的传输和安全性, 我们将详细介绍其加解密过程, 这将帮助我们深入理解 <code>AllowedIPs</code> 参数的重要性.</p><p><strong>发送数据(加密过程)</strong>:</p><ol><li><p><strong>生成会话密钥</strong>:</p><ul><li>每个 WireGuard 对等方 (客户端和服务端) 在建立连接时会使用 <strong>Curve25519</strong> 算法生成 <strong>共享密钥</strong> (Diffie-Hellman 密钥交换) .</li><li>这个密钥交换基于双方的公钥和私钥来生成会话密钥, 该密钥是对称的, 意味着双方都能用它加密和解密数据.</li><li>假设客户端的私钥为 sk_c, 公钥为 pk_c, 服务端的私钥为 sk_s, 公钥为 pk_s. 双方会通过交换公钥并用对方的公钥与自己私钥生成一个共享的会话密钥.</li></ul></li><li><p><strong>加密数据</strong>:</p><ul><li>数据包会使用 <strong>ChaCha20</strong> 算法进行加密. 使用共享的会话密钥来加密发送的数据.</li><li><strong>Poly1305</strong> 用于数据包的认证, 确保数据在传输过程中未被篡改. 它会生成一个消息验证码 (MAC) , 并附加到加密数据上.</li><li>加密的过程使用的是流加密的方式, 通过会话密钥生成的伪随机流来加密数据.</li></ul></li><li><p><strong>封装数据包</strong>:</p><ul><li><p>加密后的数据会被封装成 WireGuard 数据包, 其中包括:</p><ul><li>目标地址</li><li>加密后的有效负载</li><li>消息认证码 (MAC)</li><li>发送者的身份标识</li></ul></li></ul></li><li><p><strong>发送数据包</strong>:</p><ul><li>数据包会通过 UDP 发送到目标的远程端点 (例如, IP 地址和端口) .</li></ul></li></ol><p><strong>接收数据(解密过程)</strong>:</p><ol><li><p><strong>接收数据包</strong>:</p><ul><li>接收方通过 UDP 收到一个数据包, 这个数据包可能是加密的.</li></ul></li><li><p><strong>验证消息认证码(MAC)</strong>:</p><ul><li>解密前, 接收方会先使用 <strong>Poly1305</strong> 算法检查数据的完整性, 确保数据包在传输过程中未被篡改.</li><li>如果验证失败, 数据包会被丢弃.</li></ul></li><li><p><strong>解密数据</strong>:</p><ul><li>如果消息验证通过, 接收方使用 <strong>ChaCha20</strong> 算法与共享密钥解密数据.</li><li>共享密钥是通过双方的公钥和私钥生成的 Diffie-Hellman 会话密钥来解密数据.</li><li>解密后, 恢复出原始的明文数据.</li></ul></li><li><p><strong>检查数据包的来源</strong>:</p><ul><li>解密后, 接收方还需要检查数据包的来源. 如果数据包是来自一个未被授权的源, 或者不符合接收方的安全策略, 数据包将被丢弃.</li></ul></li></ol><hr><p>客户端在发送数据时, 会通过 <strong>AllowedIPs</strong> 选择 Peer 节点(源地址 IP 和 AoolwedIPs 匹配), 然后使用确定的 Peer <strong>会话密钥</strong>(服务端的公钥和 Peer 的私钥通过 <strong>Curve25519</strong> 生成)对数据进行加密;</p><p>当数据到达服务端时, 会用所有已知客户端的会话密钥逐一尝解密并试验证消息完整性,一旦匹配到有效的会话密钥, 即可确认数据包是由对应的客户端发送, 解密后的数据包中有源地址(IP Header) 中, 这时服务端的 WireGuard 就会将源地址和客户端的 <strong>AllowedIPs</strong> 进行匹配, 如果相同或在允许的子网内, 则接受数据包;</p><p>当服务端处理完后需要向客户端发送响应数据时, 服务端会查看响应数据的目标 IP, 并将其与每个客户端的 <strong>AllowedIPs</strong> 列表进行比较, 以确定将其发送到哪个客户端.</p><p>以上就是 WireGuard 的加解密过程, 从中我们可以明确 <strong>AllowedIPs</strong> 的作用.</p><p>那么问题来了:</p><ol><li>不同的 Peer 可以有相同的 <strong>AllowedIPs</strong> 吗？即 Peer1 和 Peer2 的 <strong>AllowedIPs</strong> 都为 <code>1.1.1.1/32</code> 或者都为 <code>1.1.1.0/24</code>;</li><li>如果一个 Peer 的 <strong>AllowedIPs</strong> 包含了另外一个 Peer 的 <strong>AllowedIPs</strong>, 那么会落到哪个 Peer 上？即 Peer1 的 <strong>AllowedIPs</strong> 为 <code>1.1.1.0/24</code>, Peer2 的 <strong>AllowedIPs</strong> 为 <code>1.1.1.1/32</code>, 目的 IP 为 <code>1.1.1.1/32</code> 的包会发送给 Peer1 还是 Peer2 呢？</li></ol><p>为了解释上面的问题, 我们来看一下 <strong>AllowedIPs</strong> 的具体实现: WireGuard 使用前缀树来维护 <strong>AllowedIPs</strong>, 下面是实现逻辑:</p><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(node *trieEntry)</span></span> lookup(ip []<span class="type">byte</span>) *Peer {</span><br><span class="line">  <span class="comment">// 用来存储找到的最近匹配的 Peer</span></span><br><span class="line">	<span class="keyword">var</span> found *Peer</span><br><span class="line">  <span class="comment">// IP 地址的长度, 通常是 4 (IPv4) 或 16 (IPv6)</span></span><br><span class="line">	size := <span class="type">uint8</span>(<span class="built_in">len</span>(ip))</span><br><span class="line">  <span class="comment">// 如果目标 IP 与当前节点的前缀匹配长度大于等于当前节点的 CIDR, 继续往下走</span></span><br><span class="line">	<span class="keyword">for</span> node != <span class="literal">nil</span> &amp;&amp; commonBits(node.bits, ip) &gt;= node.cidr {</span><br><span class="line">    <span class="comment">// 如果当前节点关联了一个 Peer, 更新 found, 表示找到了一个更匹配的 Peer.</span></span><br><span class="line">		<span class="keyword">if</span> node.peer != <span class="literal">nil</span> {</span><br><span class="line">			found = node.peer</span><br><span class="line">		}</span><br><span class="line">    <span class="comment">// 如果已检查完目标 IP 的所有字节, 结束查找</span></span><br><span class="line">		<span class="keyword">if</span> node.bitAtByte == size {</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		}</span><br><span class="line">    <span class="comment">// 根据当前 IP 地址的某一位决定往左子树 (0) 还是右子树 (1) 继续查找</span></span><br><span class="line">		bit := node.choose(ip)</span><br><span class="line">    <span class="comment">// 跳到子树节点</span></span><br><span class="line">		node = node.child[bit]</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> found</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong>整体流程</strong>:</p><ol><li><strong>逐层比较前缀</strong>: 从根节点开始, 逐层比较 IP 地址的前缀部分, 确认是否匹配当前节点.</li><li><strong>更新匹配的</strong> Peer: 如果当前节点匹配目标 IP 且关联 Peer, 将 Peer 记录下来.</li><li><strong>选择子树继续匹配</strong>: 根据 IP 地址的位信息, 选择左子树或右子树.</li><li><strong>返回最终匹配</strong>: 返回最长前缀匹配的 Peer.</li></ol><hr><p>如果 Peer1 的 <strong>AllowedIPs</strong> 为 10.10.1.0/24, Peer2 的 <strong>AllowedIPs</strong> 为 10.10.1.2/32, Peer3 的 <strong>AllowedIPs</strong> 为 192.168.31.0/24, 目的 IP 为 10.10.1.2/32, 它的前缀树看起来是这样子的:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">           [root]</span><br><span class="line">           /    \</span><br><span class="line">    10.* ( )   192.* ( )</span><br><span class="line">      |             \</span><br><span class="line">   10.10.* ( )    168.*</span><br><span class="line">      |               \</span><br><span class="line">10.10.1.* (Peer1)    31.* (Peer3)</span><br><span class="line">      |</span><br><span class="line">10.10.1.2/32 (Peer2)</span><br></pre></td></tr></tbody></table></figure><p>所以对于上面 2 个问题的答案是:</p><ol><li>不能, 最后添加的 Peer 会覆盖前面的 Peer;</li><li>第一次匹配到 <code>10.10.1.*</code>, 找到 <code>10.10.1.0/24</code>(Peer1), 然后再次匹配到 <code>10.10.1.2/32</code>(Peer2), 所以最后应该使用 <strong>Peer2</strong> 节点.</li></ol><hr><h4 id="持久化-Endpoint"><a href="#持久化-Endpoint" class="headerlink" title="持久化 Endpoint"></a>持久化 Endpoint</h4><p>在服务端有这么一个配置:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Interface]</span><br><span class="line"># [可选] 是否将 Endpoint 持久化到配置文件中, 默认为 false</span><br><span class="line">SaveConfig = false</span><br></pre></td></tr></tbody></table></figure><p>如果设置为 true, 则会在必要时将最新的 Peer 的公网 IP 和端口写入到配置文件中:</p><ol><li><p>正常断开连接时:</p><p>当 WireGuard 接口被关闭 (例如使用 wg-quick down 命令时) , WireGuard 会自动将当前连接的状态, 包括对等端的 <strong>Endpoint</strong> 信息, 写入到配置文件中.</p></li><li><p>系统重启或服务重启时:</p><p>如果系统重启或 wg-quick 服务重启, WireGuard 会在重启前保存当前连接的状态, 包括 <strong>Endpoint</strong> 信息.</p></li><li><p>动态更改时:</p><p>如果 WireGuard 通过接收到的数据包自动更新了对等端的 <strong>Endpoint</strong> (例如, 通过 NAT 穿越时发生远程端点 IP 或端口的变化) , 并且此时连接被手动断开或接口被重启, 最新的端点信息将被写入配置文件.</p></li></ol><p>我们一般不会直接去配置服务端配置节点中的 EndPoint, 而客户端必须配置, 这样才能知道数据包应该发送到哪里, 而 WireGuard 需要知道回复的数据包应该发送给谁, 所以需要将接受到的数据包中的源地址 IP 和端口记下来, 而如果客户端的出口公网 IP 端端口变化了, 则服务端就会动态去更新指定节点的 Endpoint.</p><hr><h4 id="DDNS-问题"><a href="#DDNS-问题" class="headerlink" title="DDNS 问题"></a>DDNS 问题</h4><p>WireGuard 只会在启动时解析域名, 如果你使用 <code>DDNS</code> 来动态更新域名解析, 那么每当 IP 发生变化时, 就需要重新启动 WireGuard. 粗暴点的解决方案是使用 <code>PostUp</code> 钩子每隔几分钟或几小时重新启动 WireGuard 来强制解析域名.</p><blockquote><p>Linux 上内核实现的 WireGuard , 内核 API 只接受 AF_INET 或 AF_INET6 的 endpoint 地址, 所以域名是在用户态由 wg 配置工具在配置时刻解析的, 那么 DDNS 的话, 解析记录更新内核也无法感知. 还需要用户态的 daemon 监测并更新配置.</p></blockquote><p>幸运的是, wireguard-tools 提供了一个示例脚本 <code>reresolve-dns.sh</code>, 它可以解析 WG 配置文件并自动重置端点地址. 需要定期运行 <code>reresolve-dns.sh /etc/wireguard/wg.conf</code> 以从已更改其 IP 的端点中恢复. 一种方法是通过 systemd 计时器每三十秒更新一次所有 WireGuard 端点:</p><details class="folding-tag"><summary>🪬 reresolve-dns.sh 脚本:</summary><div class="content"><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">SPDX-License-Identifier: GPL-2.0</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (C) 2015-2020 Jason A. Donenfeld &lt;Jason@zx2c4.com&gt;. All Rights Reserved.</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用错误捕获, 一旦出错, 脚本将立即退出</span></span><br><span class="line">set -e</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用无大小写匹配和扩展模式</span></span><br><span class="line">shopt -s nocasematch</span><br><span class="line">shopt -s extglob</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置语言环境为 C, 确保脚本在不同语言环境下行为一致</span></span><br><span class="line">export LC_ALL=C</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取第一个参数作为配置文件名</span></span><br><span class="line">CONFIG_FILE="$1"</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果参数是合法的文件名, 则使用 /etc/wireguard 路径下的配置文件</span></span><br><span class="line">[[ $CONFIG_FILE =~ ^[a-zA-Z0-9_=+.-]{1,15}$ ]] &amp;&amp; CONFIG_FILE="/etc/wireguard/$CONFIG_FILE.conf"</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用正则提取接口名称 (从文件名中提取)</span></span><br><span class="line">[[ $CONFIG_FILE =~ /?([a-zA-Z0-9_=+.-]{1,15})\.conf$ ]]</span><br><span class="line">INTERFACE="${BASH_REMATCH[1]}"</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">处理每个 Peer 的函数</span></span><br><span class="line">process_peer() {</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">只有当处于 [Peer] 段且 PublicKey 和 Endpoint 不为空时才处理</span></span><br><span class="line">	[[ $PEER_SECTION -ne 1 || -z $PUBLIC_KEY || -z $ENDPOINT ]] &amp;&amp; return 0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">检查 WireGuard 最新握手时间是否超过 135 秒</span></span><br><span class="line">	[[ $(wg show "$INTERFACE" latest-handshakes) =~ ${PUBLIC_KEY//+/\\+}\	([0-9]+) ]] || return 0</span><br><span class="line">	(( ($EPOCHSECONDS - ${BASH_REMATCH[1]}) &gt; 135 )) || return 0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">更新 Peer 的 endpoint (wg <span class="built_in">set</span> wg0 peer <span class="string">"公钥"</span> endpoint <span class="string">"最新 IP"</span>)</span></span><br><span class="line">	wg set "$INTERFACE" peer "$PUBLIC_KEY" endpoint "$ENDPOINT"</span><br><span class="line">	reset_peer_section</span><br><span class="line">}</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重置 Peer 段信息</span></span><br><span class="line">reset_peer_section() {</span><br><span class="line">	PEER_SECTION=0</span><br><span class="line">	PUBLIC_KEY=""</span><br><span class="line">	ENDPOINT=""</span><br><span class="line">}</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">初始化 Peer 段</span></span><br><span class="line">reset_peer_section</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">逐行读取配置文件</span></span><br><span class="line">while read -r line || [[ -n $line ]]; do</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">去除注释部分</span></span><br><span class="line">	stripped="${line%%\#*}"</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">提取键和值, 并去除首尾空格</span></span><br><span class="line">	key="${stripped%%=*}"; key="${key##*([[:space:]])}"; key="${key%%*([[:space:]])}"</span><br><span class="line">	value="${stripped#*=}"; value="${value##*([[:space:]])}"; value="${value%%*([[:space:]])}"</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">如果是新的段落, 处理当前 Peer 并重置段落状态</span></span><br><span class="line">	[[ $key == "["* ]] &amp;&amp; { process_peer; reset_peer_section; }</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">如果进入 [Peer] 段, 设置标志</span></span><br><span class="line">	[[ $key == "[Peer]" ]] &amp;&amp; PEER_SECTION=1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">如果处于 [Peer] 段, 提取 PublicKey 和 Endpoint 信息</span></span><br><span class="line">	if [[ $PEER_SECTION -eq 1 ]]; then</span><br><span class="line">		case "$key" in</span><br><span class="line">		PublicKey) PUBLIC_KEY="$value"; continue ;;</span><br><span class="line">		Endpoint) ENDPOINT="$value"; continue ;;</span><br><span class="line">		esac</span><br><span class="line">	fi</span><br><span class="line">done &lt; "$CONFIG_FILE"</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">处理最后一个 Peer</span></span><br><span class="line">process_peer</span><br></pre></td></tr></tbody></table></figure><p>这个脚本用于自动更新 WireGuard 中继服务器配置文件中的 Peer 的 Endpoint, 当最新握手时间超过 135 秒时, 通过 wg set 更新 Peer 的 Endpoint 信息.</p><p><strong>主要步骤</strong>:</p><ol><li>读取配置文件路径, 并根据输入参数确定具体路径和接口名称;</li><li>使用 process_peer 函数检查每个 Peer, 根据握手时间判断是否需要更新;</li><li>通过正则匹配提取 PublicKey 和 Endpoint, 然后动态调整 WireGuard 配置;</li></ol></div></details><p><strong>下面是使用官方脚本的方式</strong>:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://git.zx2c4.com/wireguard-tools /usr/share/wireguard-tools</span><br></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sudo vim /etc/systemd/system/wireguard_reresolve-dns.timer</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Periodically reresolve DNS of all WireGuard endpoints</span><br><span class="line">[Timer]</span><br><span class="line">OnCalendar=*:*:0/30</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=timers.target</span><br></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sudo vim /etc/systemd/system/wireguard_reresolve-dns.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Reresolve DNS of all WireGuard endpoints</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line">ExecStart=/bin/sh -c <span class="string">'for i in /etc/wireguard/*.conf; do /usr/share/wireguard-tools/contrib/reresolve-dns/reresolve-dns.sh "$i"; done'</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> wireguard_reresolve-dns.service wireguard_reresolve-dns.timer --now</span><br></pre></td></tr></tbody></table></figure><p>如果是 <strong>OpenWrt</strong> 系统安装的 <strong>WireGuard</strong> 且作为客户端使用的话, 可以直接使用自带的 <strong>DDNS 看门狗脚本</strong>, 定时任务添加以下 <strong>cron</strong> 即可:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * /usr/bin/wireguard_watchdog</span><br></pre></td></tr></tbody></table></figure><hr><h4 id="PostUP-和-PostDown"><a href="#PostUP-和-PostDown" class="headerlink" title="PostUP 和 PostDown"></a>PostUP 和 PostDown</h4><p><strong>PostUP</strong>: 启动 VPN 接口之后运行的命令, 这个选项可以指定多次, 按顺序执行.</p><p>例如:</p><ul><li><p>从文件或某个命令的输出中读取配置值:</p><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">PostUp</span> = wg set %i private-key /etc/wireguard/wg0.key &lt;(some command here)</span><br></pre></td></tr></tbody></table></figure></li><li><p>添加一行日志到文件中:</p><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">PostUp</span> = echo <span class="string">"$(date +%s) WireGuard Started"</span> &gt;&gt; /var/log/wireguard.log</span><br></pre></td></tr></tbody></table></figure></li><li><p>调用 WebHook:</p><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">PostUp</span> = curl https://events.example.dev/wireguard/started/?key=abcdefg</span><br></pre></td></tr></tbody></table></figure></li><li><p>添加路由:</p><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">PostUp</span> = ip rule add ipproto tcp dport <span class="number">22</span> table <span class="number">1234</span></span><br></pre></td></tr></tbody></table></figure></li><li><p>添加 iptables 规则, 启用数据包转发:</p><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">PostUp</span> = iptables -A FORWARD -i %i -j ACCEPT<span class="comment">; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span></span><br></pre></td></tr></tbody></table></figure></li><li><p>强制 WireGuard 重新解析对端域名的 IP 地址:</p><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">PostUp</span> = resolvectl domain %i <span class="string">"~."</span><span class="comment">; resolvectl dns %i 192.0.2.1; resolvectl dnssec %i yes</span></span><br></pre></td></tr></tbody></table></figure></li></ul><p><strong>PostDown</strong>: 停止 VPN 接口之后运行的命令. 这个选项可以指定多次, 按顺序执行.</p><ul><li><p>删除 iptables 规则, 关闭数据包转发:</p><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">PostDown</span> = iptables -D FORWARD -i %i -j ACCEPT<span class="comment">; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span></span><br></pre></td></tr></tbody></table></figure></li></ul><hr><h4 id="PersistentKeepalive"><a href="#PersistentKeepalive" class="headerlink" title="PersistentKeepalive"></a>PersistentKeepalive</h4><p>如果连接是从一个位于 NAT 后面的对等节点 (peer) 到一个公网可达的对等节点 (peer) , 那么 NAT 后面的对等节点 (peer) 必须定期发送一个出站 ping 包来检查连通性, 如果 IP 有变化, 就会自动更新<code>Endpoint</code>.</p><p>例如:</p><ul><li>本地节点与对等节点 (peer) 可直连: 该字段不需要指定, 因为不需要连接检查.</li><li>对等节点 (peer) 位于 NAT 后面: 该字段不需要指定, 因为维持连接是客户端 (连接的发起方) 的责任.</li><li>本地节点位于 NAT 后面, 对等节点 (peer) 公网可达: 需要指定该字段 <code>PersistentKeepalive = 25</code>, 表示每隔 <code>25</code> 秒发送一次 ping 来检查连接.</li></ul><h4 id="共享-Peer-配置"><a href="#共享-Peer-配置" class="headerlink" title="共享 Peer 配置"></a>共享 Peer 配置</h4><p>如果某个 <code>peer</code> 的公钥与本地接口的私钥能够配对, 那么 WireGuard 会忽略该 <code>peer</code>.</p><p>利用这个特性, 我们可以在所有节点上共用同一个 peer 列表, 每个节点只需要单独定义一个 <code>[Interface]</code> 就行了, 即使列表中有本节点, 也会被忽略.</p><p>具体方式如下:</p><ul><li>每个对等节点 (peer) 都有一个单独的 <code>/etc/wireguard/wg0.conf</code> 文件, 只包含 <code>[Interface]</code> 部分的配置.</li><li>每个对等节点 (peer) 共用同一个 <code>/etc/wireguard/peers.conf</code> 文件, 其中包含了所有的 peer.</li><li>Wg0.conf 文件中需要配置一个 PostUp 钩子, 内容为 <code>PostUp = wg addconf /etc/wireguard/peers.conf</code>.</li></ul><hr><h4 id="路由全部流量"><a href="#路由全部流量" class="headerlink" title="路由全部流量"></a>路由全部流量</h4><p>如果你想通过 VPN 转发所有的流量, 包括 VPN 子网和公网流量, 需要在客户端的 <code>[Peer]</code> 的 <code>AllowedIPs</code> 中添加 <code>0.0.0.0/0, ::/0</code>.</p><p>即便只转发 <code>IPv4</code> 流量, 也要指定一个 <code>IPv6</code> 网段, 以避免将 <code>IPv6</code> 数据包泄露到 VPN 之外.</p><p>详情参考: <a href="/goto.html?u=aHR0cHM6Ly9pY2xvdWRuYXRpdmUuaW8vZ28vP3RhcmdldD1hSFIwY0hNNkx5OTNkM2N1Y21Wa1pHbDBMbU52YlM5eUwxZHBjbVZIZFdGeVpDOWpiMjF0Wlc1MGN5OWlNRzAxWnpJdmFYQjJObDlzWldGcmMxOXdjMkZmWm05eVgyRnVlVzl1WlY5b1pYSmxYM1Z6YVc1blgzZHBjbVZuZFdGeVpGOTBieTg9" rel="external nofollow noopener noreferrer" target="_blank">reddit.com/r/WireGuard/comments/b0m5g2/ipv6_leaks_psa_for_anyone_here_using_wireguard_to</a></p><p>例如:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Interface]</span><br><span class="line">Address = 10.10.1.1/32</span><br><span class="line">ListenPort = 44000</span><br><span class="line">PrivateKey = &lt;私钥&gt;</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = &lt;公钥&gt;</span><br><span class="line">AllowedIPs = 0.0.0.0/0</span><br></pre></td></tr></tbody></table></figure><p>如果某一个 peer 的 allowed ip 配置成 0.0.0.0/0, 则 wireguard 会</p><ul><li>把 0.0.0.0/0 路由加入到路由表 51820 中</li><li>所有经过 wg0 网卡的流量包都打上 51820 标志</li><li>加一条策略路由规定不带 51820 标志的数据包才去查询路由表 51820</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ wg-quick up wg2</span><br><span class="line">[#] ip link add wg2 type wireguard</span><br><span class="line">[#] wg setconf wg2 /dev/fd/63</span><br><span class="line">[#] ip -4 address add 10.10.1.1/32 dev wg2</span><br><span class="line">[#] ip link set mtu 1420 up dev wg2</span><br><span class="line">[#] wg set wg2 fwmark 51820</span><br><span class="line">[#] ip -4 rule add not fwmark 51820 table 51820</span><br><span class="line">[#] ip -4 rule add table main suppress_prefixlength 0</span><br><span class="line">[#] ip -4 route add 0.0.0.0/0 dev wg2 table 51820</span><br><span class="line">[#] sysctl -q net.ipv4.conf.all.src_valid_mark=1</span><br><span class="line">[#] nft -f /dev/fd/63</span><br></pre></td></tr></tbody></table></figure><p>因为 0.0.0.0/0 是默认路由, 而 main 表中肯定已经存在默认路由了, 所以必须插入到一个新的路由表中(<code>ip -4 rule add not fwmark 51820 table 51820</code>);</p><p>比如从浏览器发起一个远端访问, 流程为:</p><ol><li>chrome 发出的数据包到达对应的 socket；</li><li>该数据包经过内核协议栈时, 会首先做 route decision, 本次 routing decision 会命中 51820 路由表, 所以包会被发送到 wg0 网卡；</li><li>该数据包通过字符驱动直接发送到了应用层应用 wireguard, wireguard- 会将该普通数据包封装成 wireguard 数据包, 并打上 fwmark 0xca6c；</li><li>wireguard 发出的 wireguard 数据包到达对应的 socket；</li><li>该 wireguard 数据包经过内核协议栈时, 会首先做 routing decision, 由于该包带了 fwmark, 所以不会命中 51820 路由表, 而是命中默认路由策略, 被发送到了 eth0 网卡；</li><li>eth0 网卡将该 wireguard 数据包发送出去.</li></ol><p>可以看出来, 如果不为数据包打上 fwmark 0xca6c, 不添加策略路由而是将路由添加到 main 表, 则步骤 5 中的 routing decision 会再次把包送回到 wg0 网卡, 形成路由环路.</p><p>如果配置 <code>SaveConfig = tue</code>, 启动完成后配置文件会变更为:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Interface]</span><br><span class="line">Address = 10.10.1.1/32</span><br><span class="line">SaveConfig = true</span><br><span class="line">ListenPort = 44000</span><br><span class="line">FwMark = 0xca6c</span><br><span class="line">PrivateKey = &lt;私钥&gt;</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = &lt;公钥&gt;</span><br><span class="line">AllowedIPs = 0.0.0.0/0</span><br></pre></td></tr></tbody></table></figure><p>会多出一个 <strong>FwMark = 0xca6c</strong> 配置项, 因为还没有客户端连接, Peer 下还不会持久化 Endpoint.</p><hr><h4 id="IPv6-1"><a href="#IPv6-1" class="headerlink" title="IPv6"></a>IPv6</h4><p>前面的例子主要使用 <code>IPv4</code>, WireGuard 也支持 <code>IPv6</code>. 例如:</p><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Interface]</span></span><br><span class="line"><span class="attr">AllowedIps</span> = <span class="number">10.10</span>.<span class="number">1.1</span>/<span class="number">32</span>, fd45:da8::<span class="number">1</span>/<span class="number">128</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Peer]</span></span><br><span class="line">...</span><br><span class="line"><span class="attr">AllowedIPs</span> = <span class="number">0.0</span>.<span class="number">0.0</span>/<span class="number">0</span>, ::/<span class="number">0</span></span><br></pre></td></tr></tbody></table></figure><h4 id="常用命令汇总"><a href="#常用命令汇总" class="headerlink" title="常用命令汇总"></a>常用命令汇总</h4><p><strong>生成密钥</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#生成私钥</span></span><br><span class="line">$ wg genkey &gt; example.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成公钥</span></span><br><span class="line">$ wg pubkey &lt; example.key &gt; example.key.pub</span><br></pre></td></tr></tbody></table></figure><p><strong>启动与停止</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ wg-quick up /full/path/to/wg0.conf</span><br><span class="line">$ wg-quick down /full/path/to/wg0.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取在配置目录下</span></span><br><span class="line">$ wg-quick up wg0</span><br><span class="line">$ wg-quick down wg0</span><br></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动/停止 VPN 网络接口</span></span><br><span class="line">$ ip <span class="built_in">link</span> <span class="built_in">set</span> wg0 up</span><br><span class="line">$ ip <span class="built_in">link</span> <span class="built_in">set</span> wg0 down</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册/注销 VPN 网络接口</span></span><br><span class="line">$ ip <span class="built_in">link</span> add dev wg0 <span class="built_in">type</span> wireguard</span><br><span class="line">$ ip <span class="built_in">link</span> delete dev wg0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册/注销 本地 VPN 地址</span></span><br><span class="line">$ ip address add dev wg0 10.10.4.8/32</span><br><span class="line">$ ip address delete dev wg0 10.10.4.8/32</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加/删除 VPN 路由</span></span><br><span class="line">$ ip route add 10.10.4.8/32 dev wg0</span><br><span class="line">$ ip route delete 10.10.4.8/32 dev wg0</span><br></pre></td></tr></tbody></table></figure><p><strong>查看信息</strong></p><p>接口:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看系统 VPN 接口信息</span></span><br><span class="line">$ ip <span class="built_in">link</span> show wg0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 VPN 接口详细信息</span></span><br><span class="line">$ wg show all</span><br><span class="line">$ wg show wg0</span><br></pre></td></tr></tbody></table></figure><p>地址:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 VPN 接口地址</span></span><br><span class="line">$ ip address show wg0</span><br></pre></td></tr></tbody></table></figure><p>路由:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看系统路由表</span></span><br><span class="line">$ ip route show table main</span><br><span class="line">$ ip route show table <span class="built_in">local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取到特定 IP 的路由</span></span><br><span class="line">$ ip route get 10.10.4.1</span><br></pre></td></tr></tbody></table></figure><p>参考:</p><ul><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly90aGlzY3V0ZS53b3JsZC9wb3N0cy93aXJlZ3VhcmQtb24tbGludXgv">Linux 上的 WireGuard 网络分析（一）</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly93d3cud2lyZWd1YXJkLmNvbS9wcm90b2NvbC8=">wireguard protocol</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80MDQ0MDI5MzM=">WireGuard 到底好在哪？</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9yby1jaGUuaW5mby9hcnRpY2xlcy8yMDIxLTAyLTI3LWxpbnV4LXJvdXRpbmc=">Understanding modern Linux routing (and wg-quick)</a><ul><li>它的中文翻译：<a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9pY2xvdWRuYXRpdmUuaW8vcG9zdHMvbGludXgtcm91dGluZy1vZi13aXJlZ3VhcmQv">WireGuard 基础教程：wg-quick 路由策略解读 - 米开朗基扬</a></li></ul></li></ul><hr><h3 id="回家方案总结"><a href="#回家方案总结" class="headerlink" title="回家方案总结"></a>回家方案总结</h3><p>前面用大量篇幅介绍了我的 HomeLab 的网络架构, 重点关注稳定性与可用性, 目的是保证随时随地都能异地访问家庭网络, 总结起来就是下面几点:</p><ul><li>多宽带避免运营商故障: 灾备冗余;</li><li>多设备避免单点故障: 负载均衡;</li></ul><p>如果没有公网 IP, 我们还有很多方式实现异地访问:</p><ul><li>公网被回收则启用 IPv6;</li><li>公网中继;</li><li>内网穿透;</li></ul><p><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9jaGkubWlhbnRpYW8ubWUvcG9zdHMvd2l0aG91dC1pcHY0Lw==">这里还有另一种方式</a>, 有机会可以尝试一下.</p><hr><h2 id="分流"><a href="#分流" class="headerlink" title="分流"></a>分流</h2><details class="folding-tag"><summary>🪬 分流</summary><div class="content"><p>分流有 2 种方案:</p><ol><li>终端设备安装分流服务, 只服务于当前设备:<ul><li>优点:<ul><li><strong>自主可控</strong>: 每个设备独立运行分流服务, 配置灵活且不影响其他设备;</li><li><strong>无需更改网络基础设施</strong>: 对路由器等网络设备无依赖, 避免复杂的网络配置;</li><li><strong>稳定性高</strong>: 分流仅限于当前设备, 不会因其他设备或集中服务的故障而受影响;</li></ul></li><li>缺点:<ul><li><strong>维护成本高</strong>: 需要在每台设备上手动安装、配置和维护分流服务, 尤其当设备数量较多时工作量增加;</li><li><strong>统一管理困难</strong>: 分流规则无法集中管理, 设备间的配置可能不一致 (<strong>已通过规则服务实现分流规则集中化管理</strong>);</li><li><strong>性能受限于终端设备</strong>: 某些设备性能不足时, 分流可能会降低网络效率;</li></ul></li></ul></li><li>部署集中式的分流服务, 服务于整个网络;<ul><li>优点:<ul><li><strong>集中管理</strong>: 所有设备共享一套分流规则, 配置统一且维护方便;</li><li><strong>设备接入简单</strong>: 终端设备无需额外配置, 只需设置网关或 DNS;</li><li><strong>高效的网络流量分配</strong>: 可充分利用高性能设备 (如专用服务器) 处理复杂的分流任务;</li><li><strong>便于扩展</strong>: 新增设备时无需重复配置分流服务;</li></ul></li><li>缺点:<ul><li><strong>单点故障风险</strong>: 集中服务出现故障会导致所有设备分流失效;</li><li><strong>网络依赖性高</strong>: 对路由器或网关的网络配置依赖较大, 复杂网络环境中可能难以部署;</li><li><strong>对硬件性能要求高</strong>: 需要高性能设备支撑, 处理所有设备的分流流量;</li></ul></li></ul></li></ol><hr><h3 id="基于-Surge-集中式的分流方案"><a href="#基于-Surge-集中式的分流方案" class="headerlink" title="基于 Surge 集中式的分流方案"></a>基于 Surge 集中式的分流方案</h3><h4 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h4><p>Surge 部署在 Mac mini M2 上, 配置也非常简单(类似的还有 R2S 的旁路由设置, 不同的是 DNS 也需要填写 R2S 的 IP 地址):</p><ul><li><p>开启 Surge 的增强模式</p></li><li><p>在其他设备上设置:</p><table><thead><tr><th align="left">配置名</th><th align="left">配置值</th></tr></thead><tbody><tr><td align="left">网关</td><td align="left">Mac mini M2 的 IP 地址</td></tr><tr><td align="left">DNS</td><td align="left"><strong>198.18.0.2</strong> (重点)</td></tr><tr><td align="left">子网掩码</td><td align="left">255.255.255.0</td></tr><tr><td align="left">IP</td><td align="left">保持不变</td></tr></tbody></table></li></ul><p>虽然这种方式需要手动在每台终端上进行配置, 但分流这种操作本身比较特殊, 尽量在设备本地处理更为稳妥.</p><p>此外, 像 R2S 这样的旁路由设备虽然也能提供类似功能, 独立配置每台需要分流的设备可以确保更高的自主性和稳定性.</p><p><strong>最怕的就是因为规则的问题把流量用完的情况, 因此最好在需要分流的设备上手动开启分流服务.</strong></p><h4 id="方式二"><a href="#方式二" class="headerlink" title="方式二"></a>方式二</h4><p><strong>使用 Surge 提供 DHCP 服务</strong></p><p>可以让 Surge 接管路由器的 <strong>DHCP 和 DNS 服务</strong>, 具体操作如下:</p><ol><li>关闭路由器的 DHCP 功能.</li><li>在 Surge 中启用 DHCP 功能.</li><li>在终端设备上手动设置网关和 DNS (同上述配置) .</li></ol><p><strong>未采用原因</strong>:</p><ul><li>关闭路由器 DHCP 功能后, 不确定静态 IP 绑定记录是否会保留.</li><li>我可能会在将来切换回由路由器提供 DHCP 服务, 因此不希望因 Surge 退出使用而引发额外配置问题.</li><li>主要设备上全部安装了 Surge, 非 macOS 的系统则会是用 R2S 的旁路由模式, 因此没必要采用这种集中式的方案.</li></ul><h3 id="经验总结"><a href="#经验总结" class="headerlink" title="经验总结"></a>经验总结</h3><p>此前曾将分流服务部署在 root 过的 AX9000 路由器上, 接管全屋设备的上网需求, 以实现全屋设备无感知的分流, 但频繁的网络断线和部分网络不可用 (需要重启路由器) 违背了我追求稳定性的原则. 最终, 我将 AX9000 恢复为普通路由器, 仅用来提供静态 IP 绑定、端口映射等常规功能.</p><p>目前对分流就一个原则: <strong>手动开启分流功能</strong>.</p><p>每次手动开启虽然麻烦, 但是可以明确知道自己的操作会带来什么影响, 我觉得还是值得的.</p><p>对于 Apple 设备开始 Surge 还比较简单, 对于非 Apple 设备, 则提供了脚本以简化操作:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">proxy(){</span><br><span class="line">  export https_proxy=http://ip:port http_proxy=http://ip:port all_proxy=socks5://ip:port</span><br><span class="line">  echo "HTTP Proxy on"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">noproxy(){</span><br><span class="line">  unset http_proxy</span><br><span class="line">  unset https_proxy</span><br><span class="line">  unset all_proxy</span><br><span class="line">  echo "HTTP Proxy off"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>需要时执行 <code>proxy</code> 方法即可.</p><h3 id="最终方案"><a href="#最终方案" class="headerlink" title="最终方案"></a>最终方案</h3><p>目前分流需求仅限于少数特定设备, 我的方案是这是结合设备独立分流和旁路由模式:</p><ol><li><strong>Apple 设备直接安装 Surge</strong>, 采用设备独立分流方案, 配置通过 iCloud 或 Synology Drive 同步;</li><li>非 Apple 设备则使用 R2S 旁路由模式或者设置 <code>http_proxy</code>, 确保分流服务的 <strong>独立性和可控性</strong>;</li></ol></div></details><hr><h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>我们已经基本介绍了家庭网络的配置，包括网络架构、安全性、异地组网等方面。每个章节都可以单独拿出来撰写一篇博客，但由于保持连贯性，我们选择将它们合并为一篇文章。</p><p>接下来，我们将转向服务相关的内容。作为软件开发者，我深知工具对于工作效率的重要性。因此，在接下来的内容中，我将重点关注各种工具类的自托管服务。这些服务可能会包括代码管理、持续集成和持续部署（CI/CD）工具、版本控制系统、日志管理、监控工具等。</p><p>虽然现在只是画出了一个大致的蓝图，但我相信随着时间的推移，我会不断探索和实践，将这些服务逐步应用到我的个人云端实验室中。我期待着与大家分享我在这个领域的经验、挑战和解决方案。</p><p>感谢大家的关注和支持，希望这些内容能够对您的自托管之旅有所帮助。如果您有任何建议或问题，欢迎在评论区留言，让我们一起探讨和学习。让我们继续前进，共同打造属于我们的高效、稳定且安全的个人云端实验室！</p><p><strong>相关文章:</strong></p><ol><li><a href="/posts/15433dee.html">先导篇</a>：我的 HomeLab 概要;</li><li><a href="/posts/1c3b04a.html">硬件篇</a>：介绍我所拥有的硬件设备;</li><li><a href="/posts/e537d446.html">网络篇</a>：包括网络环境、异地组网与网络安全;</li><li><a href="/posts/b2341239.html">服务篇</a>：使用 Docker 搭建的各类服务;</li><li><a href="/posts/b808f350.html">数据篇</a>：包括数据存储方案、备份方案和数据恢复方案;</li><li><a href="/posts/273b6766.html">HomeLab数据同步：构建高效的数据同步网络</a></li><li><a href="/posts/6c25aa66.html">HomeLab数据备份：打造坚实的数据安全防线</a></li><li><a href="/posts/7e09e56.html">HomeLab 网络续集：升级 10G 网络-再战 10 年</a></li><li><a href="/posts/15433dee.html">NAT 内网穿透详解：揭秘网络连接背后的奥秘</a></li></ol></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/avatar1.webp" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/avatar.webp" title="头像" alt="头像"></a><div class="post-copyright__author_name">dong4j</div><div class="post-copyright__author_desc">岁月静好，诗酒趁年华🍺</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://blog.dong4j.site/posts/e537d446.html">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl(&quot;https://blog.dong4j.site/posts/e537d446.html&quot;)">HomeLab 网络篇：互联世界-构建高效的自托管网络环境</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://cdn.dong4j.site/source/image/wechat-pay.webp" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/wechat-pay.webp" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.dong4j.site/source/image/alipay.webp" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/alipay.webp" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display:none"></div><div class="reward-link mode"><a class="reward-link-button" href="/wechat/"><i class="anzhiyufont anzhiyu-icon-plant-fill"></i>运营模式与责任</a></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://blog.dong4j.site/posts/e537d446.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=HomeLab 网络篇：互联世界-构建高效的自托管网络环境&amp;url=https://blog.dong4j.site/posts/e537d446.html&amp;pic=https://cdn.dong4j.site/source/image/20241229154732_xLHg6epx.webp" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl(){var e=window.location.href,t=document.createElement("input");t.setAttribute("value",e),document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999),document.execCommand("copy"),document.body.removeChild(t)}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div><div class="share-link follow"><div class="share-button" id="post-share-url" title="订阅" onclick="icat.showFollowBox()"><i class="anzhiyufont anzhiyu-icon-rss"></i></div></div></div></div></div><div class="submit-box display"><form id="follow" action="https://api.follow.it/subscription-form/b29peEszNWYzK3FQbEw2dVlITEJMZ2pQRXh2dWRLVDE3SC96eFhRaGwwQWprcXpYYUp0NGFWemxVZllXRGU4Nm4yenNGSzNpV3l0Z1EwQzBXQU5xTG9pZWNzVCt5YWptWUt6TXppRXVXMXZxQTRZOGQ0NUVDRlRFOUYxSHMzMEJ8NmlodHY1VWhDQVZBaG8wM0pSV2pXSjdTNGRWS1o0RDVZbE11KzlEeWhuZz0=/8" method="post" target="_blank"><div class="follow-it-form-subscribe" style="position:relative"><div class="heading"><h5 style="font-weight:700;text-align:center">订阅本站文章：</h5></div><div class="input-field"><input type="email" id="email-input" name="email" placeholder="填入您的邮箱地址" spellcheck="false" oninput="validateEmail()"></div><div class="submit-button"><button type="submit" id="submit-button" onclick="ga(&quot;send&quot;,&quot;event&quot;,&quot;Form&quot;,&quot;Submit&quot;,&quot;Affiliate&quot;)" style="font-weight:700;font-size:14px;text-align:center" disabled="">确认订阅</button></div></div></form><style>#email-input{font-size:16px;font-weight:700;padding:10px;border:2px solid #ccc;border-radius:5px;width:100%;box-sizing:border-box}#email-input:focus{outline:0}#email-input.valid{border-color:green}#email-input.invalid{border-color:red}</style><script>function validateEmail(){var s=document.getElementById("email-input"),a=document.getElementById("submit-button"),e=s.value;/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?(a.disabled=!1,s.classList.add("valid"),s.classList.remove("invalid")):(a.disabled=!0,s.classList.add("invalid"),s.classList.remove("valid"))}</script></div><script>var icat={showFollowBox:function(){var s=document.querySelector(".submit-box");s.classList.contains("display")?s.classList.remove("display"):s.classList.add("display")}}</script><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.dong4j.site" target="_blank">司机带你开车</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__category-list"><a class="post-meta__box__categoryes" href="/categories/homelab-%E4%B8%AD%E5%B9%B4%E7%94%B7%E4%BA%BA%E7%9A%84%E5%BF%AB%E4%B9%90%E6%BA%90%E6%B3%89/"><span class="categoryes-punctuation"><i class="anzhiyufont anzhiyu-icon-inbox"></i></span>HomeLab:中年男人的快乐源泉<span class="categoryesPageCount">15</span></a></div><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/homelab/"><span class="tags-punctuation"><i class="anzhiyufont anzhiyu-icon-tag"></i></span>HomeLab<span class="tagsPageCount">17</span></a><a class="post-meta__box__tags" href="/tags/%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>网络架构<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/%E5%AE%89%E5%85%A8%E6%80%A7/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>安全性<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/%E5%BC%82%E5%9C%B0%E7%BB%84%E7%BD%91/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>异地组网<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/%E8%87%AA%E6%89%98%E7%AE%A1/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>自托管<span class="tagsPageCount">1</span></a></div></div><div class="post_share"><div class="addtoany"><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_button_facebook a2a_counter"></a><a class="a2a_button_x"></a><a class="a2a_button_threads"></a><a class="a2a_button_pocket"></a><a class="a2a_button_email"></a><a class="a2a_button_sms"></a><a class="a2a_dd" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.addtoany.com/share"></a></div></div><script async="" src="https://static.addtoany.com/menu/page.js"></script><script>var a2a_config=a2a_config||{};a2a_config.templates=a2a_config.templates||{},a2a_config.templates.email={subject:"来自 dong4j 的分享: ${title}",body:"一篇有意思的博文:\n${link}"},a2a_config.templates.sms={body:"给你分享一篇有意思的博客:\n${title}\n${link}"}</script></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/1c3b04a.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_REDUUGSE.webp" onerror="onerror=null,src=&quot;/img/404.webp&quot;" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">HomeLab 硬件篇：构建基石-自托管硬件的选购与实践</div></div></a></div><div class="next-post pull-right"><a href="/posts/46fb4e89.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_ygRx9mbO.webp" onerror="onerror=null,src=&quot;/img/404.webp&quot;" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">NAT 内网穿透详解：揭秘网络连接背后的奥秘</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size:1.5rem;margin-right:4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/posts/91f73d3b.html" title="Ubuntu 使用备忘录：好记性不如烂笔头"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?mg3iapx4" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-02-15</div><div class="title">Ubuntu 使用备忘录：好记性不如烂笔头</div></div></a></div><div><a href="/posts/5fa20a9e.html" title="使用 Cloudflare 增强公网服务安全性的实践"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?eb4q02fh" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-02-13</div><div class="title">使用 Cloudflare 增强公网服务安全性的实践</div></div></a></div><div><a href="/posts/b0f649a0.html" title="Ubuntu 系统下 LCD4Linux 的安装与配置指南"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?po6ikv1j" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-02-12</div><div class="title">Ubuntu 系统下 LCD4Linux 的安装与配置指南</div></div></a></div><div><a href="/posts/ded15d16.html" title="捡垃圾的快乐：因为一张显卡组装了一台服务器"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?esvhtge1" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-02-10</div><div class="title">捡垃圾的快乐：因为一张显卡组装了一台服务器</div></div></a></div><div><a href="/posts/adc3ac9e.html" title="哪吒面板配置指南：自托管与安全防控详解"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?minsr8vl" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-01-21</div><div class="title">哪吒面板配置指南：自托管与安全防控详解</div></div></a></div><div><a href="/posts/7e09e56.html" title="HomeLab 网络续集：升级 10G 网络-再战 10 年"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_0ssj32bq.webp" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-12-01</div><div class="title">HomeLab 网络续集：升级 10G 网络-再战 10 年</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)" rel="external nofollow noreferrer">匿名评论</a><a href="/privacy" style="margin-left:4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/avatar.webp" onerror="this.onerror=null,this.src=&quot;/img/friend_404.gif&quot;" alt="avatar"><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/coding.gif" alt="status"></div></div><div class="author-info__description"><div style="line-height:1.38;margin:.6rem 0;text-align:justify;color:rgba(255,255,255,.8)">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:.6rem 0;text-align:justify;color:rgba(255,255,255,.8)">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">dong4j</h1><div class="author-info__desc">岁月静好，诗酒趁年华 🍺</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/dong4j" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fa-brands fa-github faa-tada"></i></a><a class="social-icon faa-parent animated-hover" href="mailto:dong4j@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fa-solid fa-at faa-tada"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content"><div style="display:flex;align-items:center"><span>👋🏻 Hi，欢迎来到我的博客~</span><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/mario.gif" width="40"></div><span>❓ 如有问题欢迎评论区交流！🎉</span><br><span>😫 页面异常？试试<kbd>Ctrl</kbd>+<kbd>F5</kbd>🙉</span><br><span>📧 如需联系：<a href="mailto:dong4j@gmail.com" rel="external nofollow noreferrer"><b>发邮件给我吧 🚀</b></a></span><div id="welcome-info"></div><a id="my-card-info-btn" href="/subscribe/" data-pjax-state=""><i class="anzhiyufont anzhiyu-icon-rss"></i><span>订阅本站</span></a></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background:url(https://cdn.dong4j.site/source/image/63c02edf44033.webp) center center/100% no-repeat"></div><div class="back face" style="background:url(https://cdn.dong4j.site/source/image/645fa415e8694.webp) center center/100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%85%E8%AF%BB%E6%8C%87%E5%BC%95"><span class="toc-number">1.</span> <span class="toc-text">阅读指引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">网络架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%83%E7%BA%BF"><span class="toc-number">2.1.</span> <span class="toc-text">布线</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%B1%E7%94%B5%E7%AE%B1"><span class="toc-number">2.2.</span> <span class="toc-text">弱电箱</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%93%E6%89%91%E5%9B%BE"><span class="toc-number">2.2.1.</span> <span class="toc-text">拓扑图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%89%E7%8C%AB%E6%94%B9%E6%A1%A5%E6%8E%A5"><span class="toc-number">2.2.2.</span> <span class="toc-text">光猫改桥接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%B5%E8%A7%86%E6%9F%9C"><span class="toc-number">2.3.</span> <span class="toc-text">电视柜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%A6%E6%88%BF"><span class="toc-number">2.4.</span> <span class="toc-text">书房</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91%E5%9B%BE"><span class="toc-number">2.4.1.</span> <span class="toc-text">网络拓扑图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E7%BD%91%E7%BA%BF"><span class="toc-number">2.5.</span> <span class="toc-text">关于网线</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">2.6.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E9%80%9F"><span class="toc-number">3.</span> <span class="toc-text">网速</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%96%E7%BD%91"><span class="toc-number">3.1.</span> <span class="toc-text">外网</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%91"><span class="toc-number">3.2.</span> <span class="toc-text">内网</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%96%E7%BD%91-%E5%AE%B6"><span class="toc-number">3.3.</span> <span class="toc-text">外网-&gt;家</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87-IP-%E7%AE%A1%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">设备 IP 管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IP-%E8%AE%BE%E7%BD%AE%E7%AD%96%E7%95%A5"><span class="toc-number">4.1.</span> <span class="toc-text">IP 设置策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IP-%E5%88%86%E9%85%8D"><span class="toc-number">4.2.</span> <span class="toc-text">IP 分配</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E5%9F%9F%E5%90%8D%E7%AE%A1%E7%90%86"><span class="toc-number">5.</span> <span class="toc-text">设备域名管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Hosts"><span class="toc-number">5.1.</span> <span class="toc-text">Hosts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DNS-%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.2.</span> <span class="toc-text">DNS 服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Surge-Hosts"><span class="toc-number">5.3.</span> <span class="toc-text">Surge Hosts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93"><span class="toc-number">5.4.</span> <span class="toc-text">方案总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86"><span class="toc-number">6.</span> <span class="toc-text">设备连接管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SSH"><span class="toc-number">6.1.</span> <span class="toc-text">SSH</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%AB%E5%90%8D%E9%85%8D%E7%BD%AE"><span class="toc-number">6.1.1.</span> <span class="toc-text">别名配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SSH-%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95"><span class="toc-number">6.1.2.</span> <span class="toc-text">SSH 免密登录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SSH-%E5%AF%86%E9%92%A5%E8%AE%A4%E8%AF%81"><span class="toc-number">6.1.3.</span> <span class="toc-text">SSH 密钥认证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SSH-%E5%85%81%E8%AE%B8-root-%E7%99%BB%E5%BD%95"><span class="toc-number">6.1.4.</span> <span class="toc-text">SSH 允许 root 登录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SSH-%E5%A4%9A%E5%9B%A0%E7%B4%A0%E8%AE%A4%E8%AF%81"><span class="toc-number">6.1.5.</span> <span class="toc-text">SSH 多因素认证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SSH-%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81"><span class="toc-number">6.1.6.</span> <span class="toc-text">SSH 会话保持</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SSH-%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">6.1.7.</span> <span class="toc-text">SSH 端口转发</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%9C%AC%E5%9C%B0%E8%BD%AC%E5%8F%91"><span class="toc-number">6.1.7.1.</span> <span class="toc-text">1. 本地转发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E8%BF%9C%E7%A8%8B%E8%BD%AC%E5%8F%91"><span class="toc-number">6.1.7.2.</span> <span class="toc-text">2. 远程转发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E5%8A%A8%E6%80%81%E8%BD%AC%E5%8F%91"><span class="toc-number">6.1.7.3.</span> <span class="toc-text">3. 动态转发</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SSH-%E8%B7%B3%E6%9D%BF%E6%9C%BA"><span class="toc-number">6.1.8.</span> <span class="toc-text">SSH 跳板机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SSH-%E4%B8%A4%E7%BA%A7%E8%B7%B3%E6%9D%BF"><span class="toc-number">6.1.9.</span> <span class="toc-text">SSH 两级跳板</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SSH-%E9%9B%86%E4%B8%AD%E7%AE%A1%E7%90%86"><span class="toc-number">6.1.10.</span> <span class="toc-text">SSH 集中管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">6.1.11.</span> <span class="toc-text">参考</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RDP"><span class="toc-number">6.2.</span> <span class="toc-text">RDP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VNC"><span class="toc-number">6.3.</span> <span class="toc-text">VNC</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9A%B4%E9%9C%B2%E6%9C%8D%E5%8A%A1%E5%88%B0%E5%85%AC%E7%BD%91"><span class="toc-number">7.</span> <span class="toc-text">暴露服务到公网</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E-IPv4"><span class="toc-number">7.1.</span> <span class="toc-text">关于 IPv4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8-DDNS"><span class="toc-number">7.2.</span> <span class="toc-text">为什么使用 DDNS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-DDNS"><span class="toc-number">7.3.</span> <span class="toc-text">什么是 DDNS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81-DNS-%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84"><span class="toc-number">7.4.</span> <span class="toc-text">动态 DNS 是如何工作的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DDNS-%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE"><span class="toc-number">7.5.</span> <span class="toc-text">DDNS 服务配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#dons-go-%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91"><span class="toc-number">7.5.1.</span> <span class="toc-text">dons-go 遇到的坑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%BB%BA%E8%8E%B7%E5%8F%96%E5%85%AC%E7%BD%91-IP-%E6%9C%8D%E5%8A%A1"><span class="toc-number">7.5.2.</span> <span class="toc-text">自建获取公网 IP 服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%AD%A3%E7%A1%AE%E7%9A%84-IPv4"><span class="toc-number">7.5.3.</span> <span class="toc-text">获取正确的 IPv4</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E4%BA%8E%E5%8D%95%E7%BD%91%E5%8D%A1"><span class="toc-number">7.5.4.</span> <span class="toc-text">对于单网卡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E4%BA%8E%E5%A4%9A%E7%BD%91%E5%8D%A1"><span class="toc-number">7.5.5.</span> <span class="toc-text">对于多网卡</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%9B%E8%A7%A3%E6%9E%90"><span class="toc-number">7.6.</span> <span class="toc-text">泛解析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">7.6.1.</span> <span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84"><span class="toc-number">7.7.</span> <span class="toc-text">端口映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-Proxy-Manager"><span class="toc-number">7.8.</span> <span class="toc-text">Nginx Proxy Manager</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">7.8.1.</span> <span class="toc-text">反向代理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTPS-%E8%AF%81%E4%B9%A6%E7%94%B3%E8%AF%B7"><span class="toc-number">7.8.2.</span> <span class="toc-text">HTTPS 证书申请</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AF-HTTPS-%E8%AE%BF%E9%97%AE"><span class="toc-number">7.8.3.</span> <span class="toc-text">开启 HTTPS 访问</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BD%8D%E7%BD%AE"><span class="toc-number">7.8.4.</span> <span class="toc-text">自定义位置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE"><span class="toc-number">7.8.5.</span> <span class="toc-text">高级配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E5%B1%80%E5%9F%9F%E7%BD%91%E8%87%AA%E5%AE%9A%E4%B9%89%E5%9F%9F%E5%90%8D"><span class="toc-number">7.8.6.</span> <span class="toc-text">代理局域网自定义域名</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Surge-NPM"><span class="toc-number">7.8.6.1.</span> <span class="toc-text">Surge + NPM</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Surge-SmartDNS-NPM"><span class="toc-number">7.8.6.2.</span> <span class="toc-text">Surge + SmartDNS + NPM</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IPv6"><span class="toc-number">7.9.</span> <span class="toc-text">IPv6</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%AD%E5%9B%BD%E7%9A%84-IPv6-%E5%8F%91%E5%B1%95%E6%83%85%E5%86%B5"><span class="toc-number">7.9.1.</span> <span class="toc-text">中国的 IPv6 发展情况</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E7%90%83-IPv6-%E5%8F%91%E5%B1%95%E6%83%85%E5%86%B5"><span class="toc-number">7.9.2.</span> <span class="toc-text">全球 IPv6 发展情况</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">7.9.3.</span> <span class="toc-text">实现方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%B0%E7%8A%B6"><span class="toc-number">7.9.4.</span> <span class="toc-text">现状</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IPv6-%E7%9B%B8%E5%85%B3%E8%B5%84%E6%BA%90"><span class="toc-number">7.9.5.</span> <span class="toc-text">IPv6 相关资源</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8"><span class="toc-number">8.</span> <span class="toc-text">网络安全</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTPS-%E8%AF%81%E4%B9%A6"><span class="toc-number">8.1.</span> <span class="toc-text">HTTPS 证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%B7%E6%B1%A0-Safeline"><span class="toc-number">8.2.</span> <span class="toc-text">雷池 Safeline</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8-WAF-%E6%9B%BF%E6%8D%A2-NPM"><span class="toc-number">8.2.1.</span> <span class="toc-text">用 WAF 替换 NPM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%9F%9F%E5%90%8D%E4%BB%A3%E7%90%86"><span class="toc-number">8.2.2.</span> <span class="toc-text">配置域名代理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#NAS-%E5%9F%9F%E5%90%8D%E4%BB%A3%E7%90%86"><span class="toc-number">8.2.2.1.</span> <span class="toc-text">NAS 域名代理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#NAS-%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2-HTTPS-%E8%AF%81%E4%B9%A6"><span class="toc-number">8.2.2.2.</span> <span class="toc-text">NAS 自动部署 HTTPS 证书</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E4%BD%BF%E7%94%A8-WAF-%E7%9A%84%E8%AF%81%E4%B9%A6%E7%AE%A1%E7%90%86"><span class="toc-number">8.2.3.</span> <span class="toc-text">不使用 WAF 的证书管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WAF-%E7%9A%84%E4%BB%A3%E7%90%86%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7"><span class="toc-number">8.2.4.</span> <span class="toc-text">WAF 的代理的局限性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WAF-%E7%A4%BE%E5%8C%BA%E7%89%88%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7"><span class="toc-number">8.2.5.</span> <span class="toc-text">WAF 社区版的局限性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2-1Panel-%E7%94%B3%E8%AF%B7%E7%9A%84-HTTPS"><span class="toc-number">8.3.</span> <span class="toc-text">自动部署 1Panel 申请的 HTTPS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WireGuard-VPN"><span class="toc-number">8.4.</span> <span class="toc-text">WireGuard VPN</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E7%9A%84-VPN-%E6%96%B9%E6%A1%88"><span class="toc-number">8.4.1.</span> <span class="toc-text">传统的 VPN 方案</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#OpenVPN"><span class="toc-number">8.4.1.1.</span> <span class="toc-text">OpenVPN</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#L2TP-IPsec"><span class="toc-number">8.4.1.2.</span> <span class="toc-text">L2TP/IPsec</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#IKEv2-IPsec"><span class="toc-number">8.4.1.3.</span> <span class="toc-text">IKEv2/IPsec</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WireGuard-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">8.4.2.</span> <span class="toc-text">WireGuard 是什么</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E9%93%BE%E6%8E%A5"><span class="toc-number">8.4.2.1.</span> <span class="toc-text">相关链接</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WireGuard-%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">8.4.3.</span> <span class="toc-text">WireGuard 使用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E7%AB%AF%E5%88%B0%E7%AB%AF%E7%9B%B4%E6%8E%A5%E8%BF%9E%E6%8E%A5"><span class="toc-number">8.4.3.1.</span> <span class="toc-text">1. 端到端直接连接</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%B1%80%E5%9F%9F%E7%BD%91%E5%88%B0%E5%A4%96%E7%BD%91"><span class="toc-number">8.4.3.2.</span> <span class="toc-text">2. 局域网到外网</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E4%B8%A4%E7%AB%AF%E9%83%BD%E4%BD%8D%E4%BA%8E-NAT-%E4%B9%8B%E5%90%8E"><span class="toc-number">8.4.3.3.</span> <span class="toc-text">3. 两端都位于 NAT 之后</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WireGuard-%E9%85%8D%E7%BD%AE%E5%AE%9E%E4%BE%8B"><span class="toc-number">8.5.</span> <span class="toc-text">WireGuard 配置实例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%82%B9%E5%AF%B9%E7%82%B9"><span class="toc-number">8.5.1.</span> <span class="toc-text">点对点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Ubuntu"><span class="toc-number">8.5.1.1.</span> <span class="toc-text">Ubuntu</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#NAS"><span class="toc-number">8.5.1.2.</span> <span class="toc-text">NAS</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#OpenWrt"><span class="toc-number">8.5.1.3.</span> <span class="toc-text">OpenWrt</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#lan-%E6%94%B9-wan-%E5%8F%A3"><span class="toc-number">8.5.1.3.1.</span> <span class="toc-text">lan 改 wan 口</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#wg-easy-%E9%83%A8%E7%BD%B2"><span class="toc-number">8.5.1.4.</span> <span class="toc-text">wg-easy 部署</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%AD%E7%BB%A7"><span class="toc-number">8.5.2.</span> <span class="toc-text">中继</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%93%E6%B4%9E"><span class="toc-number">8.5.3.</span> <span class="toc-text">打洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WireGuard-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">8.5.4.</span> <span class="toc-text">WireGuard 客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Surge-%E4%B8%8A%E9%85%8D%E7%BD%AE-WireGuard"><span class="toc-number">8.5.4.1.</span> <span class="toc-text">Surge 上配置 WireGuard</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WireGuard-%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3"><span class="toc-number">8.6.</span> <span class="toc-text">WireGuard 配置详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E9%85%8D%E7%BD%AE"><span class="toc-number">8.6.1.</span> <span class="toc-text">详细配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Address-24-vs-32"><span class="toc-number">8.6.2.</span> <span class="toc-text">Address: 24 vs 32</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AllowedIPs-%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">8.6.3.</span> <span class="toc-text">AllowedIPs 的作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96-Endpoint"><span class="toc-number">8.6.4.</span> <span class="toc-text">持久化 Endpoint</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DDNS-%E9%97%AE%E9%A2%98"><span class="toc-number">8.6.5.</span> <span class="toc-text">DDNS 问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PostUP-%E5%92%8C-PostDown"><span class="toc-number">8.6.6.</span> <span class="toc-text">PostUP 和 PostDown</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PersistentKeepalive"><span class="toc-number">8.6.7.</span> <span class="toc-text">PersistentKeepalive</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB-Peer-%E9%85%8D%E7%BD%AE"><span class="toc-number">8.6.8.</span> <span class="toc-text">共享 Peer 配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%85%A8%E9%83%A8%E6%B5%81%E9%87%8F"><span class="toc-number">8.6.9.</span> <span class="toc-text">路由全部流量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IPv6-1"><span class="toc-number">8.6.10.</span> <span class="toc-text">IPv6</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%B1%87%E6%80%BB"><span class="toc-number">8.6.11.</span> <span class="toc-text">常用命令汇总</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E5%AE%B6%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93"><span class="toc-number">8.7.</span> <span class="toc-text">回家方案总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%B5%81"><span class="toc-number">9.</span> <span class="toc-text">分流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-Surge-%E9%9B%86%E4%B8%AD%E5%BC%8F%E7%9A%84%E5%88%86%E6%B5%81%E6%96%B9%E6%A1%88"><span class="toc-number">9.1.</span> <span class="toc-text">基于 Surge 集中式的分流方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%80"><span class="toc-number">9.1.1.</span> <span class="toc-text">方式一</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%BA%8C"><span class="toc-number">9.1.2.</span> <span class="toc-text">方式二</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93"><span class="toc-number">9.2.</span> <span class="toc-text">经验总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E6%96%B9%E6%A1%88"><span class="toc-number">9.3.</span> <span class="toc-text">最终方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-number">10.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/13e613ba.html" title="Proxmox VE 8.3 安装与配置指南"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?34n7j520" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" alt="Proxmox VE 8.3 安装与配置指南"></a><div class="content"><a class="title" href="/posts/13e613ba.html" title="Proxmox VE 8.3 安装与配置指南">Proxmox VE 8.3 安装与配置指南</a><time datetime="2025-02-17T11:52:42.000Z" title="发表于 2025-02-17 19:52:42">2025-02-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/91f73d3b.html" title="Ubuntu 使用备忘录：好记性不如烂笔头"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?mg3iapx4" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" alt="Ubuntu 使用备忘录：好记性不如烂笔头"></a><div class="content"><a class="title" href="/posts/91f73d3b.html" title="Ubuntu 使用备忘录：好记性不如烂笔头">Ubuntu 使用备忘录：好记性不如烂笔头</a><time datetime="2025-02-15T06:37:31.000Z" title="发表于 2025-02-15 14:37:31">2025-02-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/5fa20a9e.html" title="使用 Cloudflare 增强公网服务安全性的实践"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?eb4q02fh" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" alt="使用 Cloudflare 增强公网服务安全性的实践"></a><div class="content"><a class="title" href="/posts/5fa20a9e.html" title="使用 Cloudflare 增强公网服务安全性的实践">使用 Cloudflare 增强公网服务安全性的实践</a><time datetime="2025-02-12T16:17:11.000Z" title="发表于 2025-02-13 00:17:11">2025-02-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/b0f649a0.html" title="Ubuntu 系统下 LCD4Linux 的安装与配置指南"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?po6ikv1j" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" alt="Ubuntu 系统下 LCD4Linux 的安装与配置指南"></a><div class="content"><a class="title" href="/posts/b0f649a0.html" title="Ubuntu 系统下 LCD4Linux 的安装与配置指南">Ubuntu 系统下 LCD4Linux 的安装与配置指南</a><time datetime="2025-02-12T11:35:45.000Z" title="发表于 2025-02-12 19:35:45">2025-02-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/c78c58c7.html" title="树莓派与移远EC20 4G网卡集成及自动拨号方案解析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?56t44pn3" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" alt="树莓派与移远EC20 4G网卡集成及自动拨号方案解析"></a><div class="content"><a class="title" href="/posts/c78c58c7.html" title="树莓派与移远EC20 4G网卡集成及自动拨号方案解析">树莓派与移远EC20 4G网卡集成及自动拨号方案解析</a><time datetime="2025-02-12T06:55:16.000Z" title="发表于 2025-02-12 14:55:16">2025-02-12</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="mailto:dong4j@gmail.com" rel="external nofollow noreferrer" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://weibo.com/u/1884084142" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.facebook.com/dsj.array" title="facebook"><i class="anzhiyufont anzhiyu-icon-facebook1"></i></a><a class="deal_link" href="/atom.xml" title="RSS"><i class="anzhiyufont anzhiyu-icon-rss"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0,500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/avatar.webp" size="50px"><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dong4j" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://space.bilibili.com/1835978167" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://v.douyin.com/iUqoRYwb/" title="抖音"><i class="anzhiyufont anzhiyu-icon-tiktok"></i></a><a class="deal_link" href="/copyright" title="CC"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i></a></div><div id="workboard"><img class="workSituationImg boardsign" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.0.4/img/badge/安知鱼-上班摸鱼中.svg" alt="距离月入25k也就还差一个大佬带我~" title="距离月入25k也就还差一个大佬带我~"><div id="runtimeTextTip"></div></div><div id="anzhiyu-footer"><div class="footer-group"><div class="footer-title">服务</div><div class="footer-links"><a class="footer-item" title="51la统计" target="_blank" rel="noopener external nofollow noreferrer" href="https://v6.51.la/">51la统计</a><a class="footer-item" title="十年之约" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.foreverblog.cn/">十年之约</a><a class="footer-item" title="开往" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.travellings.cn/go.html">开往</a><a class="footer-item" title="服务状态" target="_blank" rel="noopener external nofollow noreferrer" href="https://uptime.dong4j.dev/status/services">服务状态</a></div></div><div class="footer-group"><div class="footer-title">项目</div><div class="footer-links"><a class="footer-item" title="Watt.Stack" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/watt-stack">Watt.Stack</a><a class="footer-item" title="MIK" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dong4j/markdown-image-kit">MIK</a><a class="footer-item" title="macOS.dev" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dong4j/macOS-dev">macOS.dev</a><a class="footer-item" title="更多" target="_blank" rel="noopener external nofollow noreferrer" href="https://project.dong4j.ink:1024/">更多</a></div></div><div class="footer-group"><div class="footer-title">导航</div><div class="footer-links"><a class="footer-item" title="我的装备" href="/equipment/">我的装备</a><a class="footer-item" title="即刻短文" href="/essay/">即刻短文</a><a class="footer-item" title="友链文章" href="/fcircle/">友链文章</a><a class="footer-item" title="留言板" href="/comments/">留言板</a></div></div><div class="footer-group"><div class="footer-title">协议</div><div class="footer-links"><a class="footer-item" title="隐私协议" href="/privacy/">隐私协议</a><a class="footer-item" title="Cookies" href="/cookies/">Cookies</a><a class="footer-item" title="版权协议" href="/copyright/">版权协议</a><a class="footer-item" title="更新日志" href="/update/">更新日志</a></div></div><div class="footer-group"><div class="footer-title-group"><div class="footer-title">友链</div><a class="random-friends-btn" id="footer-random-friends-btn" href="javascript:addFriendLinksInFooter();" rel="external nofollow noreferrer" title="换一批友情链接"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i></a></div><div class="footer-links" id="friend-links-in-footer"></div></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://nonbot.org/pledged/view/9e6e360a-4834-4dd0-b672-845baa0eb4de" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="Made By Humans" title="Made By Humans"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/nonbot_pledged_logo.svg" alt="Made By Humans"></a><a class="github-badge" target="_blank" href="https://notbyai.fyi/cn/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="Not By AI" title="Not By AI"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/written-by-human-not-by-ai-white.svg" alt="Not By AI"></a><a class="github-badge" target="_blank" href="https://hexo.io/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title="博客框架为Hexo_v5.4.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo_v5.4.0"></a><a class="github-badge" target="_blank" href="https://blog.anheyu.com/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站使用AnZhiYu主题" title="本站使用AnZhiYu主题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.9/img/Theme-AnZhiYu-2E67D3.svg" alt="本站使用AnZhiYu主题"></a><a class="github-badge" target="_blank" href="https://www.dogecloud.com/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站使用多吉云为静态资源提供CDN加速" title="本站使用多吉云为静态资源提供CDN加速"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/CDN-多吉云-3693F3.svg" alt="本站使用多吉云为静态资源提供CDN加速"></a><a class="github-badge" target="_blank" href="https://github.com/dong4j" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站项目由Github托管" title="本站项目由Github托管"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Source-Github.svg" alt="本站项目由Github托管"></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/Copyright-BY-NC-SA.svg" alt="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div><div id="footer-bar"><div class="footer-bar-links"><footer-bar-left><div id="footer-bar-tips"><div class="copyright" style="display:flex;align-items:center;gap:10px">©2013 - 2025 By <a class="footer-bar-link" href="/" title="dong4j" target="_blank">dong4j</a><span class="indicator" id="indicator" style="display:inline-block;width:8px;height:8px;border-radius:50%;background-color:green;margin-left:0;animation:subtle-breathing 1.2s infinite;box-shadow:0 0 5px rgba(255,0,0,.8)"></span><span>在线人数:</span><span id="online_user" style="font-size:1em;font-weight:700">1</span></div></div><div id="footer-type-tips"></div></footer-bar-left><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener external nofollow noreferrer" href="https://beian.miit.gov.cn/" title="蜀ICP备2025119258号">蜀ICP备2025119258号</a><a class="footer-bar-link cc" href="/copyright" title="cc协议"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-by-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nc-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nd-line"></i></a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">258</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">1094</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">18</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" rel="external nofollow noreferrer" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://home.dong4j.site" title="个人主页"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/homepage.webp" alt="个人主页"><span class="back-menu-item-text">个人主页</span></a><a class="back-menu-item" href="https://blog.dong4j.site" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/blog.webp" alt="博客"><span class="back-menu-item-text">博客</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://resume.dong4j.site" title="简历"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/resume.webp" alt="简历"><span class="back-menu-item-text">简历</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://npx-card.dong4j.site" title="npx-card"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/npx-card.webp" alt="npx-card"><span class="back-menu-item-text">npx-card</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/watt-stack" title="Watt.Stack"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/watt.webp" alt="Watt.Stack"><span class="back-menu-item-text">Watt.Stack</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dong4j/markdown-image-kit" title="MIK"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/mik.webp" alt="MIK"><span class="back-menu-item-text">MIK</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dong4j/macOS-dev" title="macOS.dev"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/mac.webp" alt="macOS.dev"><span class="back-menu-item-text">macOS.dev</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://project.dong4j.site/" title="更多"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/project.webp" alt="更多"><span class="back-menu-item-text">更多</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">服务</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://uptime.dong4j.dev/status/services" title="服务状态"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/uptime-kuma.svg" alt="服务状态"><span class="back-menu-item-text">服务状态</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://nezha.dong4j.dev" title="服务面板"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/nezha.webp" alt="服务面板"><span class="back-menu-item-text">服务面板</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://nav.dong4j.dev" title="导航页"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/nav.webp" alt="导航页"><span class="back-menu-item-text">导航页</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://umami.dong4j.ink:1024/share/V7Rat8DdVw4npjl2/blog.dong4j.site" title="Umami"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/umami.webp" alt="Umami"><span class="back-menu-item-text">Umami</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://muselink.cc/dong4j 👈这是我的MuseLink数字名片！" title="数字名片"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/muse.lin.webp" alt="数字名片"><span class="back-menu-item-text">数字名片</span></a><a class="back-menu-item" href="/ai/deepseek-r1-webgpu/" title="DeepSeek"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/deepseek.webp" alt="DeepSeek"><span class="back-menu-item-text">DeepSeek</span></a><a class="back-menu-item" href="/ai/rmbg/playground/" title="RMBG"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/rmbg.webp" alt="RMBG"><span class="back-menu-item-text">RMBG</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://chat.dong4j.site/" title="Mini-Chat"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/emoji1.webp" alt="Mini-Chat"><span class="back-menu-item-text">Mini-Chat</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size:.9em"></i><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size:.9em"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/messages/"><i class="fa fa-comments faa-tada"></i><span> 最新评论</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="fa fa-line-chart faa-tada"></i><span> 统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size:.9em"></i><span> 我的装备</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size:.9em"></i><span> 小空调</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/memos/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size:.9em"></i><span> 备忘录</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/todolist/"><i class="fa-solid fa-map faa-tada"></i><span> 折腾清单</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/stars/"><i class="fa-brands fa-github faa-tada"></i><span> Star 清单</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.dong4j.dev"><span>小黑屋</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/java/" style="font-size:.88rem;color:#556363;font-weight:500;color:var(--anzhiyu-lighttext)">Java<sup>48</sup></a><a href="/tags/final/" style="font-size:.88rem;color:#678a45">final<sup>2</sup></a><a href="/tags/finalize/" style="font-size:.88rem;color:#c069bc">finalize<sup>1</sup></a><a href="/tags/finally/" style="font-size:.88rem;color:#714840">finally<sup>2</sup></a><a href="/tags/new%E5%85%B3%E9%94%AE%E5%AD%97/" style="font-size:.88rem;color:#197f3d">new关键字<sup>1</sup></a><a href="/tags/static/" style="font-size:.88rem;color:#704a0d">static<sup>1</sup></a><a href="/tags/super/" style="font-size:.88rem;color:#338051">super<sup>2</sup></a><a href="/tags/this/" style="font-size:.88rem;color:#a224a6">this<sup>1</sup></a><a href="/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/" style="font-size:.88rem;color:#334e6b">二进制<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" style="font-size:.88rem;color:#2dbd22">数据类型<sup>4</sup></a><a href="/tags/%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95/" style="font-size:.88rem;color:#b7640c">构造方法<sup>1</sup></a><a href="/tags/%E6%BA%A2%E5%87%BA/" style="font-size:.88rem;color:#0b6ab5">溢出<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size:.88rem;color:#0e1424">算法<sup>1</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E5%AE%9E%E8%B7%B5/" style="font-size:.88rem;color:#000592">编程实践<sup>2</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A8%8B%E5%BA%8F/" style="font-size:.88rem;color:#56b352">计算机程序<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%AF%AD%E8%A8%80/" style="font-size:.88rem;color:#8a3737">计算机语言<sup>1</sup></a><a href="/tags/%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6/" style="font-size:.88rem;color:#a03027">访问控制<sup>1</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6/" style="font-size:.88rem;color:#0d6442">软件<sup>1</sup></a><a href="/tags/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/" style="font-size:.88rem;color:#c753c8">错误处理<sup>2</sup></a><a href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" style="font-size:.88rem;color:#c14483">面向对象<sup>6</sup></a></div></div><hr></div></div><div id="keyboard-tips"><div class="keyboardTitle">博客快捷键</div><div class="keybordList"><div class="keybordItem"><div class="keyGroup"><div class="key">shift K</div></div><div class="keyContent"><div class="content">关闭快捷键功能</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift A</div></div><div class="keyContent"><div class="content">打开/关闭中控台</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift M</div></div><div class="keyContent"><div class="content">播放/暂停音乐</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift D</div></div><div class="keyContent"><div class="content">深色/浅色显示模式</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift S</div></div><div class="keyContent"><div class="content">站内搜索</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift R</div></div><div class="keyContent"><div class="content">随机访问</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift H</div></div><div class="keyContent"><div class="content">返回首页</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift F</div></div><div class="keyContent"><div class="content">友链鱼塘</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift L</div></div><div class="keyContent"><div class="content">友链页面</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift P</div></div><div class="keyContent"><div class="content">关于本站</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift I</div></div><div class="keyContent"><div class="content">原版/本站右键菜单</div></div></div></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="share" type="button" title="分享链接" onclick="share()"><i class="fas fa-share-nodes"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="anzhiyufont anzhiyu-icon-comment-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" rel="external nofollow noreferrer" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="anzhiyu.scrollToDest(document.body.scrollHeight,500)"><i class="anzhiyufont anzhiyu-icon-arrow-down"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size:1rem"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display:none"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://cdn.cbd.int/pangu@4.0.7/dist/browser/pangu.min.js").then(()=>{pangu.autoSpacingPage()})}function panguInit(){panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><script>var HoldLog=console.log;console.log=function(){};let now1=new Date;queueMicrotask(()=>{function o(){HoldLog.apply(console,arguments)}var c=new Date("6/28/2018 00:00:00"),c=(now1.setTime(now1.getTime()+250),(now1-c)/1e3/60/60/24),c=["Hi there 👋，I'm dong4j, Welcome to my blog","岁月静好，诗酒趁年华🍺",`
        
      +========================================================+
      |  ██████╗  ██████╗ ███╗   ██╗ ██████╗ ██╗  ██╗     ██╗  |
      |  ██╔══██╗██╔═══██╗████╗  ██║██╔════╝ ██║  ██║     ██║  |
      |  ██║  ██║██║   ██║██╔██╗ ██║██║  ███╗███████║     ██║  |
      |  ██║  ██║██║   ██║██║╚██╗██║██║   ██║╚════██║██   ██║  |
      |  ██████╔╝╚██████╔╝██║ ╚████║╚██████╔╝     ██║╚█████╔╝  |
      |  ╚═════╝  ╚═════╝ ╚═╝  ╚═══╝ ╚═════╝      ╚═╝ ╚════╝   |
      +========================================================+
        
        `,"已上线",Math.floor(c),"天","Use 「npx dong4j」 and find me."],e=["NCC2-036","调用前置摄像头拍照成功，识别为【绝顶大佬】.","Photo captured: ","🤪"];setTimeout(o.bind(console,`
%c${c[0]} %c ${c[1]} %c ${c[2]} %c${c[3]}%c ${c[4]}%c ${c[5]}

%c ${c[6]}
`,"color:#425AEF","","color:#425AEF","color:#425AEF","","color:#425AEF","")),setTimeout(o.bind(console,`%c ${e[0]} %c ${e[1]} %c 
${e[2]} %c
${e[3]}
`,"color:white; background-color:#4fd953","","",'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%')),setTimeout(o.bind(console,"%c WELCOME %c 你好，绝顶大佬.","color:white; background-color:#4f90d9","")),setTimeout(console.warn.bind(console,"%c ⚡ Powered by 安知鱼 %c 你正在访问 dong4j 的博客.","color:white; background-color:#f0ad4e","")),setTimeout(o.bind(console,"%c W23-12 %c 你已打开控制台.","color:white; background-color:#4f90d9","")),setTimeout(console.warn.bind(console,"%c S013-782 %c 你现在正处于监控中.","color:white; background-color:#d9534f",""))})</script><script async="" src="/anzhiyu/random.js"></script><script async="">(()=>{var n,o,r,a,i,e=new Date("6/28/2018 00:00:00"),l=new Date;setInterval(()=>{var t;if(l=new Date,i=l.getHours(),t=(l-e)/1e3/60/60/24,n=Math.floor(t),t=(l-e)/1e3/60/60-24*n,o=Math.floor(t),1==String(o).length&&(o="0"+o),t=(l-e)/1e3/60-1440*n-60*o,r=Math.floor(t),1==String(r).length&&(r="0"+r),t=(l-e)/1e3-86400*n-3600*o-60*r,a=Math.round(t),1==String(a).length&&(a="0"+a),document.getElementById("footer")){let e="";e=(i<18&&9<=i||null!=(t=document.querySelector("#workboard .workSituationImg"))&&(t.src="https://npm.elemecdn.com/anzhiyu-blog@2.0.4/img/badge/安知鱼-下班啦.svg",t.title="下班了就该开开心心的玩耍，嘿嘿~",t.alt="下班了就该开开心心的玩耍，嘿嘿~"),`本站居然运行了 ${n} 天<span id='runtime'> ${o} 小时 ${r} 分 ${a} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`),document.getElementById("runtimeTextTip")&&(document.getElementById("runtimeTextTip").innerHTML=e)}},1e3)})()</script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(()=>{let t=document.querySelectorAll("#article-container .mermaid-wrap");if(0!==t.length){let e=()=>{window.loadMermaid=!0;let a="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";Array.from(t).forEach((e,t)=>{let d=e.firstElementChild;e="%%{init:{ 'theme':'"+a+"'}}%%\n"+d.textContent;let n=mermaid.render("mermaid-"+t,e);"string"==typeof n?(t=n,d.insertAdjacentHTML("afterend",t)):n.then(({svg:e})=>{d.insertAdjacentHTML("afterend",e)})})};var d=()=>{window.loadMermaid?e():getScript("https://cdn.cbd.int/mermaid@10.2.4/dist/mermaid.min.js").then(e)};anzhiyu.addGlobalFn("themeChange",e,"mermaid"),window.pjax?d():document.addEventListener("DOMContentLoaded",d)}})()</script><script>(()=>{let t=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"https://twikoo.dong4j.ink:1024",region:"",onCommentLoaded:()=>{anzhiyu.loadLightbox(document.querySelectorAll("#twikoo .tk-content img:not(.tk-owo-emotion)"))}},null))};var o=()=>{"object"==typeof twikoo?setTimeout(n,0):getScript("https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js").then(n)};let e=()=>{let o=document.getElementById("twikoo-count");o&&twikoo.getCommentsCount({envId:"https://twikoo.dong4j.ink:1024",region:"",urls:[window.location.pathname],includeReply:!1}).then(t=>{o.textContent=t[0].count}).catch(t=>{console.error(t)})},n=()=>{t(),GLOBAL_CONFIG_SITE.isPost&&e()};o()})()</script><input type="hidden" name="page-type" id="page-type" value="post"><script async="" src="/js/anzhiyu/comment_barrage.js"></script></div><script>window.addEventListener("load",()=>{let t=e=>e=""!==e&&150<(e=(e=(e=(e=e.replace(/<img.*?src="(.*?)"?[^\>]+>/gi,"[图片]")).replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi,"[链接]")).replace(/<pre><code>.*?<\/pre>/gi,"[代码]")).replace(/<[^>]+>/g,"")).length?e.substring(0,150)+"...":e,n=t=>{let n="";if(t.length)for(let e=0;e<t.length;e++)n=(n=(n+="<div class='aside-list-item'>")+`<a href='${t[e].url}' class='thumbnail'><img data-lazy-src='${t[e].avatar}' alt='${t[e].nick}'><div class='name'><span>${t[e].nick} </span></div></a>`)+`<div class='content'>
        <a class='comment' href='${t[e].url}' title='${t[e].content}'>${t[e].content}</a>
        <time datetime="${t[e].date}">${anzhiyu.diffDate(t[e].date,!0)}</time></div>
        </div>`;else n+="没有评论";var e=document.querySelector("#card-newest-comments .aside-list");e&&(e.innerHTML=n),window.lazyLoadInstance&&window.lazyLoadInstance.update(),window.pjax&&window.pjax.refresh(e)};var e=()=>{var e;document.querySelector("#card-newest-comments .aside-list")&&((e=saveToLocal.get("twikoo-newest-comments"))?n(JSON.parse(e)):(e=()=>{twikoo.getRecentComments({envId:"https://twikoo.dong4j.ink:1024",region:"",pageSize:6,includeReply:!0}).then(function(e){e=e.map(e=>({content:t(e.comment),avatar:e.avatar,nick:e.nick,url:e.url+"#"+e.id,date:new Date(e.created).toISOString()}));saveToLocal.set("twikoo-newest-comments",JSON.stringify(e),10/1440),n(e)}).catch(function(e){document.querySelector("#card-newest-comments .aside-list").textContent="无法获取评论，请确认相关配置是否正确"})},"object"==typeof twikoo?e():getScript("https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js").then(e)))};e(),document.addEventListener("pjax:complete",e)})</script><script>var visitorMail="996@icu.com"</script><script async="" data-pjax="" src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.dong4j.site/source/static/subscribe.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://cdn.dong4j.site/source/static/card-widget-today.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://cdn.dong4j.site/source/static/card-widget-calendar.css" media="print" onload="this.media=&quot;all&quot;"><script async="" data-pjax="" src="https://cdn.dong4j.site/source/static/automatic-redirection.js"></script><script src="https://cdn.dong4j.site/source/static/card-widget-welcome.js"></script><script async="" data-pjax="" src="https://cdn.dong4j.site/source/static/card-widget-comments.js"></script><script async="" data-pjax="" src="https://cdn.dong4j.site/source/static/card-widget-today.js"></script><script src="https://cdn.dong4j.site/source/static/card-widget-countdown.js"></script><script src="https://cdn.dong4j.site/source/static/card-widget-calendar.js"></script><script async="" data-pjax="" src="https://open.lightxi.com/unpkg/chinese-lunar@0.1.4/lib/chinese-lunar.js"></script><script async="" data-pjax="" src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script src="https://cdn.dong4j.site/source/static/custom.js"></script><script src="https://cdn.dong4j.site/source/static/geoip2-check.js"></script><script defer="" id="fluttering_ribbon" mobile="false" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-show-text" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="永不言败,勇往直前,砥砺前行,自强不息,笃行致远,厚德载物,持之以恒,奋发有为,志在四方,拼搏进取,实事求是，为人民服务,勤劳致富，共奔小康,爱国、创新、包容、厚德,敬业乐群，诚信友善,自强不息，厚德载物,以人为本，全面协调可持续发展,建设生态文明，构建和谐社会,坚持改革开放，推动科学发展,立党为公，执政为民,实现中华民族伟大复兴的中国梦" data-fontsize="15px" data-random="true" async=""></script><script src="//code.tidio.co/14aqpkwnauu3r5ngcmspfxwelvattym5.js" async=""></script><script>(()=>{{let i=!1,o=()=>{window.tidioChatApi.hide(),i=!1,document.body.style.position="relative",document.documentElement.style.overflow="auto"};var t=()=>{window.tidioChatApi.hide(),window.tidioChatApi.on("close",o)};window.tidioChatApi?window.tidioChatApi.on("ready",t):document.addEventListener("tidioChat-ready",t),window.chatBtnFn=()=>{window.tidioChatApi&&(i?o():(window.tidioChatApi.open(),window.tidioChatApi.show(),i=!0))}}})()</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media=&quot;all&quot;"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors=['meta[property="og:image"]','meta[property="og:title"]','meta[property="og:url"]','meta[property="og:type"]','meta[property="og:site_name"]','meta[property="og:description"]',"head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:send",function(){if(anzhiyu.removeGlobalFnEvent("pjax"),anzhiyu.removeGlobalFnEvent("themeChange"),document.getElementById("rightside").classList.remove("rightside-show"),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();var e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")}),document.addEventListener("pjax:complete",function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach(e=>{let t=document.createElement("script");var a=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(a)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll()}),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script><script async="" data-pjax="" data-prefix="busuanzi_value" src="https://cdn.dong4j.site/source/static/busuanzi.self.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div><script data-pjax="" src="https://cdn.dong4j.site/source/static/github-calendar.js"></script><script data-pjax="">function GithubCalendarConfig(){var t=document.getElementById("recent-posts");t&&"/"==location.pathname&&(console.log("已挂载hexo-github-calendar https://github.com/Barry-Flynn/hexo-github-calendar"),t.insertAdjacentHTML("afterbegin",'<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><div id="github_loading" style="width:10%;height:100%;margin:0 auto;display: block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg></div><div id="github_container"></div></div>')),GithubCalendar("https://github-calendar.dong4j.ink:1024/api?user=dong4j",["#ebedf0","#a2f7af","#6ce480","#54ad63","#469252","#31753c","#1f5f2a","#13531f","#084111","#032b09","#000000"],"dong4j")}document.getElementById("recent-posts")&&GithubCalendarConfig()</script><style>#github_container{min-height:280px}@media screen and (max-width:650px){#github_container{min-height:0}}</style><style></style></body></html>