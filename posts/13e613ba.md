<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ç®€ä»‹

æœ¬æ–‡æ±‡æ€»äº†æˆ‘åœ¨ä¸‰å°è”æƒ³ M920x ä¸Šæ­å»ºå’Œä½¿ç”¨ **PVE**ï¼ˆProxmox Virtual Environmentï¼‰è¿‡ç¨‹ä¸­çš„å¿ƒå¾—ä¸é‡åˆ°çš„é—®é¢˜ã€‚

åœ¨é€‰æ‹©è™šæ‹ŸåŒ–å¹³å°æ—¶ï¼Œæˆ‘å€¾å‘äº **PVE** è€Œé **ESXi**ï¼ˆvSphere Hypervisorï¼‰ã€‚

è¿™ä¸€é€‰æ‹©åŸºäº PVE çš„å¼€æºæ€§åŠå…¶åŸºäº Debian çš„æ¶æ„ï¼Œè¿™ä¸ºå®ƒå¸¦æ¥äº†ç›¸æ¯” ESXi æ›´å¤šçš„å¯ç©æ€§å’ŒæŠ˜è…¾ç©ºé—´ã€‚

> é€‰æ‹© PVE æˆ– ESXi å¹¶ä¸åœ¨äºå“ªä¸ªæ›´ä¼˜ç§€ï¼Œè€Œåœ¨äºå“ªä¸ªæ›´èƒ½æ»¡è¶³ä¸ªäººçš„ç‰¹å®šéœ€æ±‚ã€‚

## å®‰è£…å®Œæˆå IP ä¸å¯¹

å¯åŠ¨åå‡ºç°äº†ä¸€å¼  `vmbr0` ç½‘å¡, è¿™ä¸ªæ˜¯æ¡¥æ¥ç½‘å¡, å¯ä»¥æŸ¥çœ‹ç»‘å®šçš„ç‰©ç†ç½‘å¡:

```bash
ip link show master vmbr0
```

ä¿®æ”¹ä¸€ä¸‹ 3 ä¸ªæ–‡ä»¶:

```bash
# /etc/network/interfaces

auto lo
iface lo inet loopback

iface enp92s0 inet manual

auto vmbr0
iface vmbr0 inet static
	address 192.168.100.100/24
	gateway 192.168.100.1
	bridge-ports enp92s0
	bridge-stp off
	bridge-fd 0

# /etc/issue
Welcome to the Proxmox Virtual Environment. Please use your web browser to
configure this server - connect to:

  https://192.168.100.100:8006/

# /etc/hosts

127.0.0.1 localhost.localdomain localhost
192.168.100.100 nuc.ihome nuc
```

**å‚è€ƒ:**

- https://www.zhihu.com/tardis/zm/art/492484833?source_id=1003

---

## æ›´æ¢æº

```bash
apt install apt-transport-https ca-certificates

wget https://mirrors.ustc.edu.cn/proxmox/debian/proxmox-release-bookworm.gpg -O /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg
```

### é€šç”¨è½¯ä»¶æº

```bash
cp /etc/apt/sources.list /etc/apt/sources.list.bak
vim /etc/apt/sources.list
```

```bash
# é»˜è®¤æ³¨é‡Šäº†æºç é•œåƒä»¥æé«˜ apt update é€Ÿåº¦ï¼Œå¦‚æœ‰éœ€è¦å¯è‡ªè¡Œå–æ¶ˆæ³¨é‡Š
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm main contrib non-free-firmware

# deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm main contrib non-free-firmware
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm-updates main contrib non-free-firmware
# deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm-updates main contrib non-free-firmware
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm-backports main contrib non-free-firmware
# deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm-backports main contrib non-free-firmware
deb https://mirrors.tuna.tsinghua.edu.cn/debian-security bookworm-security main contrib non-free-firmware
# deb-src https://mirrors.tuna.tsinghua.edu.cn/debian-security bookworm-security main contrib non-free-firmware
```

### pve è½¯ä»¶æº

```bash
cp /etc/apt/sources.list.d/pve-enterprise.list /etc/apt/sources.list.d/pve-enterprise.list.bak

# æ¸…ç©º /etc/apt/sources.list.d/pve-enterprise.list
```

```bash
# ä½¿ç”¨Proxmoxéä¼ä¸šç‰ˆæº
echo "deb https://mirrors.ustc.edu.cn/proxmox/debian bookworm pve-no-subscription" > /etc/apt/sources.list.d/pve-no-subscription.list
```

### Ceph æº

```bash
cp /etc/apt/sources.list.d/ceph.list /etc/apt/sources.list.d/ceph.list.bak

echo "deb https://mirrors.ustc.edu.cn/proxmox/debian/ceph-quincy bookworm no-subscription" > /etc/apt/sources.list.d/ceph.list
```

### CT é•œåƒä¸‹è½½æº

å°† /usr/share/perl5/PVE/APLInfo.pm æ–‡ä»¶ä¸­é»˜è®¤çš„æºåœ°å€ http://download.proxmox.com æ›¿æ¢ä¸º https://mirrors.tuna.tsinghua.edu.cn/proxmox å³å¯ã€‚

```bash
cp /usr/share/perl5/PVE/APLInfo.pm /usr/share/perl5/PVE/APLInfo.pm.bak

sed -i 's|http://download.proxmox.com|https://mirrors.ustc.edu.cn/proxmox|g' /usr/share/perl5/PVE/APLInfo.pm
```

```
{
    host => "mirrors.ustc.edu.cn",
    url => "https://mirrors.ustc.edu.cn/turnkeylinux/metadata/pve",
    file => 'aplinfo.dat',
}
```

```bash
systemctl restart pvedaemon.service && pveam update && pveam available
```

## åˆ é™¤è®¢é˜…å¼¹çª—

```bash
sed -Ezi.bak "s/(Ext.Msg.show\(\{\s+title: gettext\('No valid sub)/void\(\{ \/\/\1/g" /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js && systemctl restart pveproxy.service
```

---

## oh-my-zsh

```bash

apt update && apt install git zsh curl \
	&& sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"

git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting \
	&& git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions \
  && git clone https://github.com/zsh-users/zsh-completions ${ZSH_CUSTOM:-${ZSH:-~/.oh-my-zsh}/custom}/plugins/zsh-completions
```

---

## è¿æ¥ WiFi

```bash
apt-get install wpasupplicant wireless-tools -y

ip link set wlp91s0 up
iwlist wlp91s0 scanning | grep "ESSID"

wpa_passphrase [WIFIåç§°] [WIFIå¯†ç ]
```

> [No wpa_supplicant executable](https://raspberrypi.stackexchange.com/questions/137121/no-wpa-supplicant-executable)

ä¼šå¾—åˆ°ç±»ä¼¼ä»¥ä¸‹çš„è¾“å‡º(ä¹Ÿå¯ä»¥ä½¿ç”¨ç½‘é¡µå·¥å…·è®¡ç®—: https://www.wireshark.org/tools/wpa-psk.html:

```
network={
    ssid="[WIFIåç§°]"
    #psk="[WIFIå¯†ç ]"
    psk=[WIFIå¯†ç çš„å¯†é’¥å€¼]
}
```

æˆ‘ä»¬éœ€è¦å¤åˆ¶è¿™ä¸ª PSK å€¼ã€‚

---

1. æ‰“å¼€`/etc/network/interfaces`æ–‡ä»¶
2. æ·»åŠ ä»¥ä¸‹å†…å®¹

```
auto [ç½‘å¡åç§°]

# å¦‚æœä½ ä½¿ç”¨é™æ€IP
iface [ç½‘å¡åç§°] inet static
    address [ä½ è¦åˆ†é…çš„IPåœ°å€ï¼Œå¦‚192.168.4.1/24]
    gateway [ç½‘å…³åœ°å€]
    wpa-ssid [WIFIåç§°]
    wpa-psk [WIFIå¯†ç çš„å¯†é’¥å€¼]

# å¦‚æœä½ ä½¿ç”¨åŠ¨æ€IP
iface [ç½‘å¡åç§°] inet dhcp
    wpa-ssid [WIFIåç§°]
    wpa-psk [WIFIå¯†ç çš„å¯†é’¥å€¼]
```

> ä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œæˆ‘ä»¬æ¨èä½ ä½¿ç”¨é™æ€ IP 3. é‡å¯ç½‘ç»œ

```
ifdown [ç½‘å¡åç§°]
ifup [ç½‘å¡åç§°]
```

**å®‰è£… iw å·¥å…·**

```bash
apt install iw -y
```

**æŸ¥çœ‹ WiFi ä¿¡æ¯**

```bash
$ iwconfig wlp91s0
wlp91s0   IEEE 802.11  ESSID:"xxxxx"
          Mode:Managed  Frequency:5.745 GHz  Access Point: 9C:9D:7E:7C:90:19
          Bit Rate=29.2 Mb/s   Tx-Power=22 dBm
          Retry short limit:7   RTS thr:off   Fragment thr:off
          Encryption key:off
          Power Management:on
          Link Quality=48/70  Signal level=-62 dBm
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:92   Missed beacon:0
```

**å‚è€ƒ**

- [åŸºäº PVE ä¸ AX210 æ— çº¿ç½‘å¡çš„ NAS ä¸»æœºè°ƒè¯•è®°å½•](https://www.bilibili.com/opus/938437808628957191)
- [proxmox ä¸­ä½¿ç”¨ ax210 è¿æ¥æ— çº¿ç½‘ç»œ](https://foxi.buduanwang.vip/virtualization/pve/1939.html/)

---

## Web æ‰“ä¸å¼€

`501 no such file '/PVE/StdWorkspace.js'`

```bash
apt install --reinstall proxmox-widget-toolkit

apt update && apt upgrade
apt install -f

apt dist-upgrade
pvecm updatecerts --force
service pveproxy restart
```

---

## pve_source è„šæœ¬

https://bbs.x86pi.cn/thread?topicId=20

**ç¨³å®šç‰ˆ**

```bash
wget -q -O /root/pve_source.tar.gz 'https://bbs.x86pi.cn/file/topic/2023-11-28/file/01ac88d7d2b840cb88c15cb5e19d4305b2.gz' && tar zxvf /root/pve_source.tar.gz && /root/./pve_source
```

å¼€å‘ç‰ˆ (PVE ç³»ç»Ÿé…ç½® IOMMUã€æ ¸æ˜¾ç›´é€šã€æ ¸æ˜¾ SR-IOV è°ƒæ•´ä¸ºå®šåˆ¶å‘å¯¼+æ¨èæ–¹æ¡ˆ)

```bash
wget -q -O /root/pve_source.tar.gz 'https://bbs.x86pi.cn/file/topic/2024-01-06/file/24f723efc6ab4913b1f99c97a1d1a472b2.gz' && tar zxvf /root/pve_source.tar.gz && /root/./pve_source
```

---

## è¿ç§» Ubuntu ç³»ç»Ÿåˆ° PVE

**åˆ—ä¸¾ä¸€ä¸‹å·²å­˜åœ¨çš„ M.2 å›ºæ€ç¡¬ç›˜ä¿¡æ¯:**

![20250218100813_9YKCDhZZ.webp](https://cdn.dong4j.site/source/image/20250218100813_9YKCDhZZ.webp)

ä¸€å…± 1T \*4 M.2 å›ºæ€ç¡¬ç›˜, å…¶ä¸­ **nvme0n1** å®‰è£…çš„ PVE, å…¶ä»– 3 æ ¹è¿˜æœªä½¿ç”¨.

### é•œåƒæ‰“åŒ…

åŸæ¥å®‰è£… Ubuntu çš„ M.2 500G å›ºæ€ç¡¬ç›˜å·²ç»ä»æœºå™¨ä¸Šæ‹”ä¸‹æ¥äº†, ä¸ºäº†å°†æ­¤å›ºæ€ç¡¬ç›˜ä¸­çš„ç³»ç»Ÿæ‰“åŒ…æˆé•œåƒç„¶åæ¢å¤åˆ° PVE ä¸­, è¿™é‡Œä½¿ç”¨äº† Clonezilla æ¥å®Œæˆè¿™é¡¹å·¥ä½œ.

ä½¿ç”¨åˆ°çš„å·¥å…·:

1. [Clonezilla](https://clonezilla.org/)
2. [Ventoy](https://www.ventoy.net/)

![20250218105012_ChdOGfq8.webp](https://cdn.dong4j.site/source/image/20250218105012_ChdOGfq8.webp)

![20250221012151_nPtdL8DT.webp](https://cdn.dong4j.site/source/image/20250221012151_nPtdL8DT.webp)

æ‰§è¡Œå®Œæˆåä¼šåœ¨æŒ‡å®šçš„ U ç›˜ç”Ÿæˆä¸€äº›ç³»ç»Ÿæ–‡ä»¶, ä½†æ˜¯è¿™ä¸ªè¿˜ä¸èƒ½ç›´æ¥ä½¿ç”¨, æ‰€ä»¥æˆ‘åˆä½¿ç”¨ Clonezilla å°†è¿™äº›æ–‡ä»¶æ‰“åŒ…æˆ ISO.

> æœ€ç»ˆçš„ç›®çš„æ˜¯å°† Ubuntu ç³»ç»Ÿæ‰“åŒ…æˆ ISO, ç„¶ååœ¨ PVE ä¸­ä½¿ç”¨è™šæ‹Ÿæœºå®‰è£….

**å‚è€ƒ**

- [clonezilla(å†ç”Ÿé¾™)å…‹éš† linux ç³»ç»Ÿ æ“ä½œæŒ‡å—](https://blog.csdn.net/weixin_36432129/article/details/130502411)
- [ä½¿ç”¨å†ç”Ÿé¾™ CloneZilla è¿›è¡Œ Linux ç³»ç»Ÿçš„é•œåƒå®Œå…¨å°è£…å’Œè¿˜åŸ](https://zhuanlan.zhihu.com/p/354584111)

### å®‰è£…åˆ° PVE

åœ¨ PVE ä¸‹æŸ¥çœ‹ P40 æ˜¾å¡çš„ä¿¡æ¯ï¼š

```bash
lspci |  grep 3D
81:00.0 3D controller: NVIDIA Corporation GP102 [P102-100] (rev a1)
```

è¦ç›´é€šè¿™å—å¡ç»™ Ubuntu 24.04 è™šæ‹Ÿæœºï¼Œéœ€è¦å‡†å¤‡ï¼š

- å¼€å¯ pcie ç›´é€š
- å®‰è£… Ubuntu 24.04 è™šæ‹Ÿæœº(å°±æ˜¯ä¸Šä¸€æ­¥æ‰“åŒ…çš„ ISO)

---

## å®‰è£… Windows

https://www.mulingyuer.com/archives/1027/

https://willxup.top/archives/pve-install-win11

https://imacos.top/2023/09/07/pve-windows-11/

### æ ¸æ˜¾ç›´é€šä¸è™šæ‹Ÿæ ¸æ˜¾ç›´é€š

**ç‰©ç†æ ¸æ˜¾ç›´é€š vs SRIOV vGPU çš„ä¼˜ç¼ºç‚¹å¯¹æ¯”ï¼š**

|                    | ä¼˜ç‚¹                                                                              | ç¼ºç‚¹                                                                                                                                                                                                                                                                                                                                                                        |
| ------------------ | --------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ç‰©ç†æ ¸æ˜¾ç›´é€š       | 1ã€æ€§èƒ½å¼º 2ã€æ”¯æŒç‰©ç†æ˜¾ç¤ºè¾“å‡º (VGA/DP/HDMI/Type-C) 3ã€å…¼å®¹æ€§å¥½ï¼Œä¸å¦¨ç¢ PVE å‡çº§ã€‚ | ç‹¬å ï¼ˆä¸æ”¯æŒç›´é€šç»™å¤šä¸ªè™šæ‹Ÿæœºï¼‰ ç›´é€šåï¼ŒPVE å®¿ä¸»ä¸èƒ½åŒæ—¶ç”¨æ ¸æ˜¾ã€‚                                                                                                                                                                                                                                                                                                             |
| SRIOV è™šæ‹Ÿæ ¸æ˜¾ç›´é€š | å¯åˆ†ä¸ºå¤šä¸ª VF è™šæ‹Ÿæ˜¾å¡ï¼Œ ç»™ä¸åŒçš„è™šæ‹Ÿæœºä½¿ç”¨ã€‚                                     | 1ã€æ€§èƒ½æ‹†åˆ†ï¼ˆåˆ†æˆå¤šä¸ª VF æ˜¾å¡å…·ä½“å¦‚ä½•åˆ†é…æ€§èƒ½ä¸è¯¦ï¼‰ å¦‚ N100 ç­‰ä¸å»ºè®®è¶…è¿‡ 3 ä¸ª VF æ˜¾å¡ï¼Œå…·æœ‰æ€§èƒ½é«˜æ ¸æ˜¾çš„å¤„ç†å™¨å¯ä»¥åˆ†ä¸ºæœ€é«˜ 7 ä¸ªï¼‰ï¼› 2ã€ä¸æ”¯æŒç‰©ç†æ˜¾ç¤ºè¾“å‡ºï¼Œè™½å¯ä½¿ç”¨ Todesk ç­‰è½¯ä»¶è¿œç¨‹æ¡Œé¢ï¼Œä½† CPU å ç”¨ç‡è¾ƒé«˜ã€‚åœ¨ä½œä¸ºæœåŠ¡å™¨çš„å°ä¸»æœºä¸Šï¼Œè®©åŸæœ¬ç´§å¼ çš„èµ„æºæ›´åŠ æ‰è¥Ÿè§è‚˜ã€‚ 3ã€å¯¹å†…æ ¸ header ä¾èµ–ï¼ˆ6.1-6.5ï¼‰ï¼ŒPVE å‡çº§å—é™ã€‚ 4ã€å…¼å®¹æ€§ç¨³å®šæ€§ä¸€èˆ¬ï¼Œéƒ¨åˆ†æµåª’ä½“è½¯ä»¶ç¡¬è§£/è½¬ç åŠŸèƒ½å—é™ã€‚ |

### è™šæ‹Ÿæ ¸æ˜¾ç›´é€š

```bash
apt install pve-kernel-$(uname -r)
proxmox-boot-tool kernel pin $(uname -r)
apt install pve-headers-$(uname -r)

wget https://github.com/moetayuko/intel-gpu-i915-backports/releases/download/I915MT65-24.1.19-6/intel-i915-dkms_1.24.1.19.240119.1.nodrm+i6-1_all.deb

apt update & apt install build-* pve-headers-$(uname -r) git dkms sysfsutils flex bison -y

wget -O /lib/firmware/updates/i915/tgl_guc_70.9.1.bin https://github.com/intel-gpu/intel-gpu-firmware/blob/main/firmware/tgl_guc_70.9.1.bin

dpkg -i intel-i915-dkms_1.24.1.19.240119.1.nodrm+i6-1_all.deb

vim /etc/default/grub
```

åœ¨ `quiet` åæ·»åŠ  `intel_iommu=on iommu=pt i915.enable_guc=3 i915.max_vfs=7`

```bash
update-grub
update-initramfs -u

apt install -y sysfsutils
```

```bash
echo "devices/pci0000:00/0000:00:02.0/sriov_numvfs = 3" > /etc/sysfs.conf

----------------
#æœ‰ä¿®æ”¹è™šæ‹Ÿæ ¸æ˜¾æ•°é‡çš„éœ€æ±‚
nano /etc/sysfs.conf
#å°†åŸæ¥å†™å…¥çš„å‚æ•°æ³¨é‡Šæ‰
#devices/pci0000:00/0000:00:02.0/sriov_numvfs = 3
#æ”¹æˆä½ éœ€è¦çš„æ•°é‡ï¼Œä¾‹å¦‚ä¸‹è¿°ä¸º5ä¸ª
devices/pci0000:00/0000:00:02.0/sriov_numvfs = 5
```

```bash
reboot
```

```bash
$ dkms status
intel-i915-dkms/1.24.1.19.240119.1.nodrm, 6.8.12-8-pve, x86_64: installed
```

```bash
$ dmesg |grep i915

...
[    4.564128] i915 0000:00:02.0: Enabled 3 VFs
```

```bash
vim /etc/pve/qemu-server/100.conf

args: -set device.hostpci0.addr=02.0 -set device.hostpci0.x-igd-gms=0x2
```

**å‚è€ƒ**

- [ã€PVEã€‘All in One çš„å¿«ä¹ä¹‹ç³»ç»Ÿé…ç½®åŠæ ¸æ˜¾ SR-IOV ç›´é€š](https://www.cloudstaymoon.com/2024/04/10/all-in-one-1)

- [ä¸€è¾¹åŸç¥ä¸€è¾¹ galgame ï¼šåŒæ—¶ç‹¬æ˜¾ç›´é€šå’Œæ ¸æ˜¾è™šæ‹ŸåŒ–](https://zhuanlan.zhihu.com/p/571224296)

- [ç©è½¬ AIGCï¼šæ‰“é€ æœ¬åœ°å¤§æ¨¡å‹åœ°åŸºï¼ŒPVE é…ç½®æ˜¾å¡ç›´é€š](https://juejin.cn/post/7364224622681112610)
- [PVE8 ç›´é€š ubuntu 22.04](https://skyao.io/learning-computer-hardware/graphics/p102/pve-ubuntu2204/)
- [Proxmox VE (Tesla P40) vGPU é…ç½®](https://azhuge233.com/proxmox-ve-tesla-p40-vgpu-%e9%85%8d%e7%bd%ae/)
- [Proxmox VE 8 Tesla P40 vGPU é…ç½®](https://azhuge233.com/proxmox-ve-8-tesla-p40-vgpu-%E9%85%8D%E7%BD%AE/)
- [Proxmox VE æ˜¾å¡ï¼ˆTesla P40ï¼‰ç›´é€š](https://azhuge233.com/proxmox-ve-%E6%98%BE%E5%8D%A1%EF%BC%88tesla-p40%EF%BC%89%E7%9B%B4%E9%80%9A/)
- [PVE ç›´é€šæ˜¾å¡ & Intel SRIOV](https://juejin.cn/post/7330920549771837481)
- [PCI Passthrough](https://pve.proxmox.com/wiki/PCI_Passthrough)

---

## å®‰è£… Ubuntu

PVEï¼ˆProxmox VEï¼‰ä¸­çš„ç½‘ç»œæ¨¡å‹é€‰æ‹©å–å†³äº **è™šæ‹Ÿæœºçš„ç”¨é€”å’Œæ€§èƒ½éœ€æ±‚**ã€‚ä¸åŒçš„ç½‘å¡æ¨¡å‹æœ‰ä¸åŒçš„**å…¼å®¹æ€§**å’Œ**æ€§èƒ½**ï¼Œä»¥ä¸‹æ˜¯å¯¹æ¯”ï¼š

**1. VirtIOï¼ˆåŠè™šæ‹ŸåŒ–ï¼‰ï¼ˆâœ… æ¨èï¼‰**

- **ä¼˜ç‚¹**ï¼š

  - **æ€§èƒ½æœ€ä½³**ï¼Œæ”¯æŒ **é«˜ååé‡**ï¼Œ**ä½ CPU å¼€é”€**ã€‚
  - **å»¶è¿Ÿæœ€ä½**ï¼Œé€‚åˆé«˜æ€§èƒ½æœåŠ¡å™¨ã€æ•°æ®åº“ã€Web æœåŠ¡ç­‰åº”ç”¨ã€‚
  - ç°ä»£ Linuxï¼ˆUbuntuã€Debianã€CentOSï¼‰**è‡ªå¸¦ VirtIO é©±åŠ¨**ï¼Œæ— éœ€é¢å¤–å®‰è£…ã€‚

- **ç¼ºç‚¹**ï¼š
  - Windows éœ€è¦ **æ‰‹åŠ¨å®‰è£… VirtIO é©±åŠ¨**ï¼ˆå¯ä»¥ä»[è¿™é‡Œ](https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/)ä¸‹è½½ï¼‰ã€‚

âœ… **æ¨èç”¨äºï¼šLinux è™šæ‹Ÿæœºã€Windowsï¼ˆå®‰è£… VirtIO é©±åŠ¨ï¼‰ã€é«˜æ€§èƒ½åº”ç”¨**

**2. Intel E1000 / E1000Eï¼ˆğŸŸ¡ å…¼å®¹æ€§å¥½ï¼Œä½†æ€§èƒ½ä¸€èˆ¬ï¼‰**

- **ä¼˜ç‚¹**ï¼š

  - å…¼å®¹æ€§**éå¸¸å¥½**ï¼Œå‡ ä¹æ‰€æœ‰æ“ä½œç³»ç»Ÿéƒ½**è‡ªå¸¦é©±åŠ¨**ï¼Œæ— éœ€é¢å¤–å®‰è£…ã€‚
  - é€‚ç”¨äº**è€æ—§æ“ä½œç³»ç»Ÿ**ï¼ˆå¦‚ Windows XP/2003ï¼‰ã€‚

- **ç¼ºç‚¹**ï¼š
  - **CPU å¼€é”€å¤§**ï¼Œæ•°æ®åŒ…å¤„ç†æ•ˆç‡ä½ã€‚
  - **å¸¦å®½é™åˆ¶åœ¨ 1Gbps**ï¼Œæ— æ³•å‘æŒ¥ç°ä»£ç¡¬ä»¶çš„æœ€å¤§æ€§èƒ½ã€‚

ğŸŸ¡ **é€‚ç”¨äºï¼šè€æ—§æ“ä½œç³»ç»Ÿï¼ˆå¦‚ Windows XP/2003ï¼‰ã€å…¼å®¹æ€§ä¼˜å…ˆçš„ç¯å¢ƒ**

**3. Realtek RTL8139ï¼ˆâš ï¸ æè€ï¼Œå‡ ä¹ä¸æ¨èï¼‰**

- **ä¼˜ç‚¹**ï¼š

  - å…¼å®¹æ€§å¥½ï¼Œé€‚ç”¨äºä¸€äº›**æè€çš„æ“ä½œç³»ç»Ÿ**ï¼ˆå¦‚ Windows 98ï¼‰ã€‚

- **ç¼ºç‚¹**ï¼š
  - **æ€§èƒ½æœ€å·®**ï¼Œå¸¦å®½ **100Mbps**ï¼Œå®Œå…¨è·Ÿä¸ä¸Šç°ä»£ç½‘ç»œéœ€æ±‚ã€‚
  - é«˜ CPU è´Ÿè½½ï¼Œä¸é€‚åˆç”Ÿäº§ç¯å¢ƒã€‚

âŒ **ä¸æ¨èï¼Œé™¤éä½ è¦è¿è¡Œ Windows 98 è¿™ç±»è€ç³»ç»Ÿã€‚**

**4. VMware vmxnet3ï¼ˆğŸŸ¡ é€‚ç”¨äº VMware å…¼å®¹ç¯å¢ƒï¼‰**

- **ä¼˜ç‚¹**ï¼š

  - **é€‚åˆä» VMware è¿ç§»çš„è™šæ‹Ÿæœº**ï¼Œå¯æ— ç¼å…¼å®¹ VMware ç¯å¢ƒã€‚
  - ä½ CPU å¼€é”€ï¼Œæ€§èƒ½æ¯” Intel E1000 å¥½ã€‚

- **ç¼ºç‚¹**ï¼š
  - éœ€è¦å®‰è£… **VMware Tools** æ‰èƒ½æ­£å¸¸å·¥ä½œï¼Œå¦åˆ™æ€§èƒ½ä½ä¸‹ã€‚
  - å¦‚æœä¸æ˜¯ä» VMware è¿ç§»è¿‡æ¥çš„ VMï¼Œ**VirtIO ä»ç„¶æ˜¯æ›´å¥½çš„é€‰æ‹©**ã€‚

ğŸŸ¡ **é€‚ç”¨äºï¼šä» VMware è¿ç§»è¿‡æ¥çš„è™šæ‹Ÿæœº**

**æ€»ç»“**

| **é€‰é¡¹**               | **æ€§èƒ½**    | **å…¼å®¹æ€§**                             | **é€‚ç”¨åœºæ™¯**                                | **æ¨èåº¦** |
| ---------------------- | ----------- | -------------------------------------- | ------------------------------------------- | ---------- |
| **VirtIOï¼ˆåŠè™šæ‹ŸåŒ–ï¼‰** | **âœ… æœ€ä½³** | éœ€è¦é©±åŠ¨ï¼ˆLinux è‡ªå¸¦ï¼ŒWindows éœ€å®‰è£…ï¼‰ | ç°ä»£ Linuxã€Windowsï¼ˆå®‰è£…é©±åŠ¨ï¼‰ã€é«˜åååº”ç”¨ | â­â­â­â­â­ |
| **Intel E1000/E1000E** | ğŸŸ¡ ä¸€èˆ¬     | **æ— éœ€é©±åŠ¨**                           | è€æ—§ Windows/Linux å…¼å®¹æ€§ä¼˜å…ˆ               | â­â­â­     |
| **Realtek RTL8139**    | âŒ æœ€å·®     | **æ— éœ€é©±åŠ¨**                           | **æè€ç³»ç»Ÿï¼ˆWindows 98/2000ï¼‰**             | â­         |
| **VMware vmxnet3**     | ğŸŸ¡ è¾ƒå¥½     | éœ€è¦ VMware Tools                      | ä» VMware è¿ç§»çš„ VM                         | â­â­â­     |

**æ¨è**

- **Linuxï¼ˆUbuntuã€Debianã€CentOSï¼‰â†’ é€‰ VirtIO**
- **Windowsï¼ˆ10/11/Serverï¼‰â†’ é€‰ VirtIOï¼ˆå®‰è£… VirtIO é©±åŠ¨ï¼‰**
- **Windows XP/2003 â†’ é€‰ Intel E1000**
- **VMware è¿ç§»è¿‡æ¥çš„ VM â†’ é€‰ vmxnet3**

**âœ… æœ€ç»ˆå»ºè®®ï¼šå¦‚æœæ˜¯ Linux æˆ–ç°ä»£ Windowsï¼Œ**è¯·ä½¿ç”¨ **VirtIOï¼ˆåŠè™šæ‹ŸåŒ–ï¼‰**ï¼Œå®ƒçš„æ€§èƒ½æœ€ä½³ã€‚

---

### å¼€å¯ SSH ç™»å½•

1. å®‰è£… openssh-server

   ```bash
   sudo apt install openssh-server
   ```

2. å®‰è£…å®Œæˆåï¼ŒSSH æœåŠ¡é»˜è®¤è‡ªåŠ¨å¯åŠ¨ï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ ¡éªŒæœåŠ¡è¿è¡ŒçŠ¶æ€ï¼š

   ```bash
   sudo systemctl status ssh
   ```

3. å¦‚æœä½ å¯ç”¨äº†é˜²ç«å¢™ï¼Œè¯·ç¡®ä¿é˜²ç«å¢™æ‰“å¼€äº† SSH ç«¯å£ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š

   ```bash
   sudo ufw allow ssh
   ```

4. å…è®¸è¿œç¨‹ç™»å½•

   ```bash
   sudo nano /etc/ssh/sshd_config
   # ä¿®æ”¹é…ç½®
   PubkeyAuthentication yes
   ```

5. é‡å¯ ssh æœåŠ¡

   ```bash
   service ssh restart
   ```

### å¼€å¯è¿œç¨‹æ¡Œé¢

å› ä¸ºé€šè¿‡ PVE æ§åˆ¶å°é“¾æ¥ Ubuntu å, è¿›å…¥è®¾ç½®é¡µé¢æ‰“å¼€è¿œç¨‹æ¡Œé¢è€æ˜¯å¡æ­», æ‰€ä»¥ç›´æ¥é€šè¿‡å‘½ä»¤è¡Œæ“ä½œ.

```bash
sudo apt update && sudo apt install xrdp -y && sudo systemctl enable --now xrdp
```

### å®‰è£… docker

> æ‰§è¡Œå‰å…ˆå¼€å¯ä»£ç†

```bash
apt remove -y docker docker-engine docker.io containerd runc || echo "Docker components may not be installed, skipping removal" \
  && apt update \
  && apt install -y gpg \
  && mkdir -p /etc/apt/keyrings \
  && curl -fsSL https://download.docker.com/linux/ubuntu/gpg | tee /etc/apt/keyrings/docker.asc > /dev/null \
  && chmod a+r /etc/apt/keyrings/docker.asc \
  && gpg --dearmor -o /etc/apt/keyrings/docker.gpg /etc/apt/keyrings/docker.asc \
  && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null \
  && apt update \
  && apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

#### docker é•œåƒæº

```bash
# å°†å†…å®¹å†™å…¥ /etc/docker/daemon.json æ–‡ä»¶ï¼Œroot ç”¨æˆ·å¯ä»¥å»æ‰ sudo
# é…ç½® Docker é•œåƒï¼Œä½¿ç”¨å¤šä¸ªé•œåƒæºæ¥æé«˜é•œåƒä¸‹è½½é€Ÿåº¦
echo '{
  "registry-mirrors": [
    "https://docker.1ms.run",
    "https://proxy.1panel.live",
    "https://docker.ketches.cn"
  ]
}' | sudo tee /etc/docker/daemon.json
# é‡å¯ Docker æœåŠ¡ä»¥ä½¿é…ç½®ç”Ÿæ•ˆ
sudo systemctl restart docker
```

### ä¿®æ”¹æ—¶åŒº

```bash
timedatectl set-timezone Asia/Shanghai
```

### ç»ˆç«¯æ”¯æŒä¸­æ–‡æ˜¾ç¤º

```bash
apt update && apt install -y language-pack-zh-hans && localectl set-locale LANG=zh_CN.UTF-8 && source /etc/default/locale
```

### ç›´é€š nvme

å› ä¸ºåŒå“ç‰Œ nvme å›ºæ€ç¡¬ç›˜åœ¨ PVE WebUI çš„ç¡¬ä»¶åˆ—è¡¨ä¸­æ— æ³•åŒºåˆ†, æ‰€ä»¥éœ€è¦åœ¨å‘½ä»¤è¡Œåœ¨æ‰¾åˆ°å…·ä½“çš„ PCI ID æ‰èƒ½ç›´é€šç»™è™šæ‹Ÿæœº, é¿å…é”™è¯¯çš„å°†å®‰è£…äº† PVE ç³»ç»Ÿçš„ nvem åˆ†é…ç»™è™šæ‹Ÿæœºå¯¼è‡´ PVE å´©æºƒ.

```bash
# æŸ¥çœ‹ nvme çš„ PCI åˆ—è¡¨
$ lspci | grep -i nvme

01:00.0 Non-Volatile memory controller: Yangtze Memory Technologies Co.,Ltd ZHITAI TiPro5000 NVMe SSD (rev 01)
81:00.0 Non-Volatile memory controller: Yangtze Memory Technologies Co.,Ltd ZHITAI TiPro5000 NVMe SSD (rev 01)

# æŸ¥çœ‹ç³»ç»Ÿå®‰è£…åœ¨å“ªå—ç›˜
$ lsblk -o NAME,MAJ:MIN,RM,TYPE,SIZE,MOUNTPOINT,UUID

NAME                         MAJ:MIN RM TYPE   SIZE MOUNTPOINT UUID
nvme0n1                      259:0    0 disk 953.9G
â””â”€nvme0n1p1                  259:2    0 part 953.9G            1a8fd1dd-021a-4e59-bcde-d77502ecc0e7
nvme1n1                      259:1    0 disk 953.9G
â”œâ”€nvme1n1p1                  259:3    0 part  1007K
â”œâ”€nvme1n1p2                  259:4    0 part     1G /boot/efi  4773-0652
â””â”€nvme1n1p3                  259:5    0 part 952.9G            5v5ZMp-dJCX-EEep-rBgv-U5ry-q4E4-8vGhuC
  â”œâ”€pve-swap                 252:0    0 lvm      8G [SWAP]     ad3ef0fd-b31a-49a3-b72d-8a059358f99a
  â”œâ”€pve-root                 252:1    0 lvm     96G /          877cad13-9e68-4d5c-b4bf-fe92ffc241d8
  â”œâ”€pve-data_tmeta           252:2    0 lvm    8.3G
  â”‚ â””â”€pve-data-tpool         252:4    0 lvm  816.2G
  â”‚   â”œâ”€pve-data             252:5    0 lvm  816.2G
  â”‚   â””â”€pve-vm--102--disk--0 252:6    0 lvm     32G
  â””â”€pve-data_tdata           252:3    0 lvm  816.2G
    â””â”€pve-data-tpool         252:4    0 lvm  816.2G
      â”œâ”€pve-data             252:5    0 lvm  816.2G
      â””â”€pve-vm--102--disk--0 252:6    0 lvm     32G
```

ä¸Šé¢çš„è¾“å‡ºå¾—çŸ¥ PVE å®‰è£…åœ¨ **nvme1n1**, å› æ­¤ **nvme0n1** å°±æ˜¯åº”è¯¥ç›´é€šç»™è™šæ‹Ÿæœºçš„ç›˜, è®©æˆ‘ä»¬æ‰¾å‡ºå®ƒçš„ PCI ID:

```bash
$ udevadm info -q path -n /dev/nvme0n1 | grep -oP '\d+:\d+\.\d+'

00:01.0
01:00.0
```

æ‰¾åˆ°äº†: **01:00.0**.

> æˆ–è€…è¿™æ ·ä¹Ÿè¡Œ:
>
> ```bash
> $ cd /sys/block/nvme0n1/device && ls -al
>
> ...
> lrwxrwxrwx  1 root root    0 Feb 19 17:23 device -> ../../../0000:01:00.0
> ...
> ```

### LVM æ‰©å®¹

åˆšå¼€å§‹åªç»™äº† 32G ç£ç›˜, åé¢å…‰å®‰è£…æ˜¾å¡é©±åŠ¨å°±ä¸å¤Ÿç”¨äº†, æ‰€ä»¥åœ¨ PVE æ§åˆ¶å¤©æ–°æ·»åŠ äº† 100G ç©ºé—´ç»™ Ubuntu:

```bash
âœ  ~ lsblk
NAME                      MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
loop0                       7:0    0  73.9M  1 loop /snap/core22/1748
loop1                       7:1    0  44.4M  1 loop /snap/snapd/23545
sda                         8:0    0    32G  0 disk
â”œâ”€sda1                      8:1    0     1M  0 part
â”œâ”€sda2                      8:2    0     2G  0 part /boot
â””â”€sda3                      8:3    0    30G  0 part
  â”œâ”€ubuntu--vg-ubuntu--lv 252:0    0    15G  0 lvm  /
  â””â”€ubuntu--vg-lv--0      252:1    0    15G  0 lvm  /home
sdb                         8:16   0   100G  0 disk
sr0                        11:0    1   2.6G  0 rom
nvme0n1                   259:0    0 953.9G  0 disk
â””â”€nvme0n1p1               259:1    0 953.9G  0 part
```

å…¶ä¸­ **sdb** æ˜¯æ–°å¢çš„ç£ç›˜, éœ€è¦å°†è¿™ 100G ç©ºé—´æ·»åŠ åˆ°æ ¹åˆ†åŒºä¸­:

```bash
# å°† sdb æ·»åŠ ä¸ºä¸€ä¸ªç‰©ç†å·ï¼ˆPVï¼‰ï¼š
sudo pvcreate /dev/sdb
# å°†æ–°åˆ›å»ºçš„ç‰©ç†å·æ·»åŠ åˆ°ç°æœ‰çš„å·ç»„ä¸­
sudo vgextend ubuntu-vg /dev/sdb
# æ‰©å±•çš„æ˜¯æ ¹åˆ†åŒºï¼ˆ/dev/ubuntu-vg/ubuntu-lvï¼‰
sudo lvextend -l +100%FREE /dev/ubuntu-vg/ubuntu-lv
# æ‰©å±•å®Œé€»è¾‘å·åï¼Œéœ€è¦æ‰©å±•æ–‡ä»¶ç³»ç»Ÿï¼Œä½¿å…¶èƒ½å¤Ÿä½¿ç”¨æ–°çš„ç©ºé—´(ext4 æ–‡ä»¶ç³»ç»Ÿ)
sudo resize2fs /dev/ubuntu-vg/ubuntu-lv
# xfs æ–‡ä»¶ç³»ç»Ÿ
# sudo xfs_growfs /dev/ubuntu-vg/ubuntu-lv
# æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦æˆåŠŸæ‰©å±•
df -h
```

**å‚è€ƒ**:

- [PVE ç³»åˆ—æ•™ç¨‹(äºŒåäºŒ)ã€å®‰è£… Ubuntu24.04(æ¡Œé¢ç‰ˆ)](http://www.huerpu.cc:7000/?p=729)
- [ç©è½¬ AIGCï¼šæ‰“é€ æœ¬åœ° AI å¤§æ¨¡å‹åœ°åŸºï¼ŒPVE åˆ¶ä½œ Ubuntu 24.04 LTS æ¨¡æ¿](https://juejin.cn/post/7365764222838210598)

---

## ç£ç›˜å…±äº«

### æµ‹è¯• NVMe è¯»å†™é€Ÿåº¦

å¯ä»¥ä½¿ç”¨ **fioã€ddã€nvme-cli** ç­‰å·¥å…·ï¼Œä¸‹é¢æ˜¯å…·ä½“çš„æ¨èåŠä½¿ç”¨æ–¹æ³•ï¼š

**ğŸ”¥ æ¨èå·¥å…· 1ï¼šfioï¼ˆæœ€ä½³é€‰æ‹©ï¼Œé€‚ç”¨äºçœŸå®è´Ÿè½½ï¼‰**

**fio** æ˜¯ä¸“ä¸šçš„å­˜å‚¨æµ‹è¯•å·¥å…·ï¼Œå¯ä»¥æ¨¡æ‹Ÿå¤šçº¿ç¨‹ã€é«˜å¹¶å‘è¯»å†™ï¼Œé€‚åˆè¯„ä¼° NVMe çš„çœŸå®æ€§èƒ½ã€‚

**1ï¸âƒ£ å®‰è£… fio**

```
sudo apt update && sudo apt install fio -y
```

**2ï¸âƒ£ æµ‹è¯• NVMe é¡ºåºå†™ï¼ˆæœ€å¤§å†™å…¥é€Ÿåº¦ï¼‰**

```
fio --name=write_test --filename=/mnt/nvme/testfile --size=10G --rw=write --bs=1M --numjobs=4 --ioengine=libaio --direct=1
```

- bs=1Mï¼ˆå—å¤§å° 1MBï¼‰
- numjobs=4ï¼ˆ4 çº¿ç¨‹å¹¶å‘ï¼‰
- direct=1ï¼ˆç»•è¿‡ç³»ç»Ÿç¼“å­˜ï¼‰
- rw=writeï¼ˆé¡ºåºå†™ï¼‰

**é¢„æœŸç»“æœ**

```
WRITE: bw=3000MiB/s, iops=3000, runt=3000ms
```

**NVMe Gen3 x4**ï¼šå†™å…¥ 2.5GB/s ~ 3.2GB/s

**NVMe Gen4 x4**ï¼šå†™å…¥ 4GB/s ~ 7GB/s

**3ï¸âƒ£ æµ‹è¯• NVMe é¡ºåºè¯»å–ï¼ˆæœ€å¤§è¯»å–é€Ÿåº¦ï¼‰**

```
fio --name=read_test --filename=/mnt/nvme/testfile --size=10G --rw=read --bs=1M --numjobs=4 --ioengine=libaio --direct=1
```

- rw=readï¼ˆé¡ºåºè¯»å–ï¼‰

**é¢„æœŸç»“æœ**

```
READ: bw=3500MiB/s, iops=3500, runt=3000ms
```

è¯»å–é€Ÿåº¦ä¸€èˆ¬é«˜äºå†™å…¥é€Ÿåº¦ã€‚

**4ï¸âƒ£ æµ‹è¯• NVMe éšæœº 4K è¯»å†™ï¼ˆI/O æ€§èƒ½ï¼‰**

```
fio --name=random_test --filename=/mnt/nvme/testfile --size=10G --rw=randrw --bs=4K --numjobs=4 --iodepth=32 --ioengine=libaio --direct=1 --rwmixread=70
```

- rw=randrwï¼ˆéšæœºè¯»å†™ï¼‰
- bs=4Kï¼ˆ4KB å—å¤§å°ï¼‰
- iodepth=32ï¼ˆæ·±åº¦ 32ï¼‰
- rwmixread=70ï¼ˆ70% è¯»ï¼Œ30% å†™ï¼‰

**éšæœºè¯»å†™ä¸»è¦çœ‹ IOPS**ï¼Œé«˜ç«¯ NVMe å¯èƒ½è¾¾åˆ° **500K IOPS+**ã€‚

**ğŸ”¹ æ¨èå·¥å…· 2ï¼šddï¼ˆå¿«é€Ÿæµ‹è¯•ï¼‰**

dd å¯ä»¥ç”¨äºç®€å•çš„è¯»å†™æµ‹è¯•ï¼Œä½†ä¸èƒ½å‡†ç¡®åæ˜ çœŸå® NVMe æ€§èƒ½ã€‚

**1ï¸âƒ£ é¡ºåºå†™**

```
dd if=/dev/zero of=/mnt/nvme/testfile bs=1G count=10 oflag=direct
```

**è¾“å‡ºç¤ºä¾‹**

```
10+0 records in
10+0 records out
10737418240 bytes (10 GB) copied, 3.42 s, 3.1 GB/s
```

**NVMe Gen3 x4**ï¼š2.5GB/s ~ 3.5GB/s

**NVMe Gen4 x4**ï¼š5GB/s ~ 7GB/s

**2ï¸âƒ£ é¡ºåºè¯»**

```
dd if=/mnt/nvme/testfile of=/dev/null bs=1G count=10 iflag=direct
```

è¯»å–é€Ÿåº¦é€šå¸¸æ¯”å†™å…¥æ›´å¿«ã€‚

**ğŸ”¹ æ¨èå·¥å…· 3ï¼šnvme-cliï¼ˆæŸ¥çœ‹é©±åŠ¨å’Œç¡¬ä»¶ä¿¡æ¯ï¼‰**

```
sudo apt install nvme-cli -y
nvme list
```

**å¯ä»¥æŸ¥çœ‹ NVMe å‹å·ã€åè®®ã€æ¥å£é€Ÿåº¦**

```
nvme smart-log /dev/nvme0n1
```

**æŸ¥çœ‹ NVMe çš„å¯¿å‘½ã€æ¸©åº¦ã€é”™è¯¯ç»Ÿè®¡**

**ğŸ¯ ç»“è®º**

| **æµ‹è¯•æ–¹å¼** | **ä¼˜ç‚¹**                   | **é€‚ç”¨åœºæ™¯**                 |
| ------------ | -------------------------- | ---------------------------- |
| fio          | ä¸“ä¸šçº§ï¼Œæ”¯æŒå¤šçº¿ç¨‹ã€é«˜å¹¶å‘ | **æœ€ç²¾å‡†çš„ NVMe æµ‹è¯•**       |
| dd           | ç®€å•æ˜“ç”¨ï¼Œé€‚åˆå¿«é€Ÿæµ‹è¯•     | **å¿«é€Ÿæµ‹è¯•é¡ºåºè¯»å†™**         |
| nvme-cli     | é€‚ç”¨äº NVMe è®¾å¤‡ç®¡ç†       | **æŸ¥çœ‹ NVMe ä¿¡æ¯å’Œå¥åº·çŠ¶æ€** |

---

### Ceph èŠ‚ç‚¹ç®€ä»‹

- Ceph MONï¼šCeph ç›‘è§†å™¨ï¼ˆ**Mon**itorï¼‰ï¼Œè´Ÿè´£ç»´æŠ¤é›†ç¾¤çŠ¶æ€æ˜ å°„ï¼Œå¸®åŠ©åè°ƒ Ceph å®ˆæŠ¤è¿›ç¨‹ï¼Œå¹¶è´Ÿè´£ç®¡ç†å®ˆæŠ¤è¿›ç¨‹ä¸å®¢æˆ·ç«¯ä¹‹é—´çš„èº«ä»½éªŒè¯ã€‚é€šå¸¸éœ€è¦è‡³å°‘ä¸‰ä¸ª MON èŠ‚ç‚¹ã€‚
- Ceph MGRï¼šCeph ç®¡ç†å™¨å®ˆæŠ¤è¿›ç¨‹ï¼ˆ**M**ana**g**e**r** Daemonï¼‰ï¼Œè´Ÿè´£è·Ÿè¸ªè¿è¡Œæ—¶æŒ‡æ ‡å’Œ Ceph å½“å‰è¿è¡ŒçŠ¶æ€ï¼Œå¹¶è´Ÿè´£ç®¡ç†å’Œå…¬å¼€ Ceph é›†ç¾¤ä¿¡æ¯ã€‚é€šå¸¸éœ€è¦è‡³å°‘ä¸¤ä¸ª MAN èŠ‚ç‚¹ã€‚
- Ceph OSDï¼šCeph å¯¹è±¡å­˜å‚¨å®ˆæŠ¤è¿›ç¨‹ï¼ˆ**O**bject **S**torage **D**aemonï¼‰ï¼Œè´Ÿè´£å­˜å‚¨æ•°æ®ã€å¤„ç†æ•°æ®å¤åˆ¶ã€æ¢å¤ã€é‡æ–°å¹³è¡¡ï¼Œå¹¶é€šè¿‡æ£€æŸ¥å…¶ä»– OSD å¿ƒè·³å‘ Ceph ç›‘è§†å™¨å’Œç®¡ç†å™¨æä¾›ç›‘è§†ä¿¡æ¯ã€‚é€šå¸¸éœ€è¦è‡³å°‘ä¸‰ä¸ª OSD èŠ‚ç‚¹ã€‚
- Ceph MDSï¼šCeph å…ƒæ•°æ®æœåŠ¡å™¨ï¼ˆ**M**eta**d**ata **S**erverï¼‰ï¼Œè´Ÿè´£å­˜å‚¨å…ƒæ•°æ®ï¼Œå¹¶å…è®¸ CephFS ç”¨æˆ·è¿è¡ŒåŸºæœ¬å‘½ä»¤ï¼Œè€Œä¸ä¸º Ceph å­˜å‚¨é›†ç¾¤å¸¦æ¥è´Ÿæ‹…ã€‚

#### æ—¶é—´åŒæ­¥

```bash
apt install chrony -y && systemctl enable chronyd && systemctl start chronyd
```

ä¿®æ”¹ NTP æœåŠ¡å™¨åœ°å€:

`/etc/chrony/chrony.conf`

```bash
server ntp.aliyun.com minpoll 4 maxpoll 10 iburst
server ntp1.aliyun.com minpoll 4 maxpoll 10 iburst
server ntp2.aliyun.com minpoll 4 maxpoll 10 iburst
server ntp3.aliyun.com minpoll 4 maxpoll 10 iburst
server ntp4.aliyun.com minpoll 4 maxpoll 10 iburst
server ntp5.aliyun.com minpoll 4 maxpoll 10 iburst
server ntp6.aliyun.com minpoll 4 maxpoll 10 iburst
server ntp7.aliyun.com minpoll 4 maxpoll 10 iburst
# å…è®¸NTPå®¢æˆ·åŒæ­¥ ip æ®µ  NTPåŒæ­¥æ—¶éœ€è¦é…ç½®
allow 192.168.0.0/16
```

```bash
systemctl restart chronyd.service

# æ‰‹åŠ¨åŒæ­¥
chronyc makestep
# æŸ¥çœ‹æœ¬æœºæ—¶é—´åŒæ­¥çŠ¶æ€
chronyc tracking
# æŸ¥çœ‹æ—¶é—´åŒæ­¥æœåŠ¡å™¨åˆ—è¡¨
chronyc -n sources -v
```

**å‚è€ƒ**

- [ç®¡ç†æ—¶é—´åŒæ­¥æœåŠ¡](https://help.aliyun.com/zh/ecs/user-guide/alibaba-cloud-ntp-server)

### å®‰è£… Ceph

ç›´æ¥åœ¨ PVE Web ç«¯å®‰è£…, ä½†æ˜¯å®‰è£…åæŠ¥é”™:

```
rados_connect failed - No such file or directory (500)
```

åŸå› æ˜¯ MON èŠ‚ç‚¹å¯åŠ¨å¤±è´¥, ä½†æ˜¯åœ¨ Web ç«¯æœ‰æ²¡æœ‰ MON èŠ‚ç‚¹æ˜¾ç¤º, åˆ›å»ºçš„æ—¶å€™æŠ¥é”™:

```
Multiple IPs for ceph public network '192.168.31.99/24' detected on nuc: 192.168.31.99 192.168.31.9 use 'mon-address' to specify one of them. (500)
```

æ‰€ä»¥ç›´æ¥ä½¿ç”¨å‘½ä»¤è¡Œæ¥å¤„ç†:

```bash
# NUC èŠ‚ç‚¹
pveceph mon create --mon-address 192.168.31.99
# Station èŠ‚ç‚¹
pveceph mon create --mon-address 192.168.31.66
```

### é…ç½® Ceph

NUC èŠ‚ç‚¹ä¸Šçš„ nvme:

```bash
$ lsblk
NAME                         MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
nvme3n1                      259:0    0 953.9G  0 disk
nvme2n1                      259:1    0 953.9G  0 disk
nvme1n1                      259:2    0 931.5G  0 disk
â”œâ”€nvme1n1p1                  259:3    0  1007K  0 part
â”œâ”€nvme1n1p2                  259:4    0     1G  0 part /boot/efi
â””â”€nvme1n1p3                  259:5    0 930.5G  0 part
  â”œâ”€pve-swap                 252:0    0     8G  0 lvm  [SWAP]
  â”œâ”€pve-root                 252:1    0    96G  0 lvm  /
  â”œâ”€pve-data_tmeta           252:2    0   8.1G  0 lvm
  â”‚ â””â”€pve-data-tpool         252:4    0 794.3G  0 lvm
  â”‚   â”œâ”€pve-data             252:5    0 794.3G  1 lvm
  â”‚   â”œâ”€pve-vm--100--disk--0 252:6    0     4M  0 lvm
  â”‚   â”œâ”€pve-vm--100--disk--1 252:7    0   200G  0 lvm
  â”‚   â”œâ”€pve-vm--100--disk--2 252:8    0     4M  0 lvm
  â”‚   â””â”€pve-vm--103--disk--0 252:9    0   128G  0 lvm
  â””â”€pve-data_tdata           252:3    0 794.3G  0 lvm
    â””â”€pve-data-tpool         252:4    0 794.3G  0 lvm
      â”œâ”€pve-data             252:5    0 794.3G  1 lvm
      â”œâ”€pve-vm--100--disk--0 252:6    0     4M  0 lvm
      â”œâ”€pve-vm--100--disk--1 252:7    0   200G  0 lvm
      â”œâ”€pve-vm--100--disk--2 252:8    0     4M  0 lvm
      â””â”€pve-vm--103--disk--0 252:9    0   128G  0 lvm
nvme0n1                      259:6    0 931.5G  0 disk
```

æ‰€ä»¥æœ‰ `nvme0n1`, `nvme2n1` å’Œ `nvme3n1` å¯ä»¥ä½¿ç”¨, Station ä¸Šçš„ nvme:

```bash
$ lsblk
NAME                         MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
nvme0n1                      259:0    0 953.9G  0 disk
â”œâ”€nvme0n1p1                  259:1    0  1007K  0 part
â”œâ”€nvme0n1p2                  259:2    0     1G  0 part /boot/efi
â””â”€nvme0n1p3                  259:3    0 952.9G  0 part
  â”œâ”€pve-swap                 252:0    0     8G  0 lvm  [SWAP]
  â”œâ”€pve-root                 252:1    0    96G  0 lvm  /
  â”œâ”€pve-data_tmeta           252:2    0   8.3G  0 lvm
  â”‚ â””â”€pve-data-tpool         252:4    0 816.2G  0 lvm
  â”‚   â”œâ”€pve-data             252:5    0 816.2G  1 lvm
  â”‚   â”œâ”€pve-vm--102--disk--0 252:6    0    32G  0 lvm
  â”‚   â””â”€pve-vm--102--disk--1 252:7    0   100G  0 lvm
  â””â”€pve-data_tdata           252:3    0 816.2G  0 lvm
    â””â”€pve-data-tpool         252:4    0 816.2G  0 lvm
      â”œâ”€pve-data             252:5    0 816.2G  1 lvm
      â”œâ”€pve-vm--102--disk--0 252:6    0    32G  0 lvm
      â””â”€pve-vm--102--disk--1 252:7    0   100G  0 lvm
```

ä¸Šé¢æ˜¯ PVE ç³»ç»Ÿç›˜, å¦ä¸€å—ç›´é€šç»™ Ubuntu ä½¿ç”¨äº†, æ‰€ä»¥æ²¡æœ‰æ˜¾ç¤ºå‡ºæ¥, è¿™ä¸ªåœ¨æ•°æ®è¿ç§»å®Œæˆåå†å¤„ç†, æˆ‘ä»¬å…ˆå°† NUC èŠ‚ç‚¹çš„ 3 å— nvme æ·»åŠ åˆ° OSD.

è¿™é‡Œå°†æ¯å— NVMe ç›˜æ‹†åˆ†ä¸º 4 ä¸ªåˆ†åŒºï¼Œç„¶å å°†è¿™äº›åˆ†åŒºåˆ†åˆ«æ·»åŠ ä¸ºç‹¬ç«‹çš„ OSDã€‚è¿™æ ·å¯ä»¥è®© Ceph æ›´åŠ  é«˜æ•ˆåˆ©ç”¨ NVMe èµ„æºï¼ŒåŒæ—¶ å‡å°‘ IO é˜»å¡ï¼Œæé«˜å¹¶å‘æ€§èƒ½ã€‚

```bash
for disk in /dev/nvme0n1 /dev/nvme2n1 /dev/nvme3n1; do
  parted --script $disk mklabel gpt
  parted --script $disk mkpart primary 0% 25%
  parted --script $disk mkpart primary 25% 50%
  parted --script $disk mkpart primary 50% 75%
  parted --script $disk mkpart primary 75% 100%
done
```

```bash
$ lsblk
NAME                         MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
nvme3n1                      259:0    0 953.9G  0 disk
â”œâ”€nvme3n1p1                  259:11   0 238.5G  0 part
â”œâ”€nvme3n1p2                  259:16   0 238.5G  0 part
â”œâ”€nvme3n1p3                  259:21   0 238.5G  0 part
â””â”€nvme3n1p4                  259:22   0 238.5G  0 part
nvme2n1                      259:1    0 953.9G  0 disk
â”œâ”€nvme2n1p1                  259:12   0 238.5G  0 part
â”œâ”€nvme2n1p2                  259:13   0 238.5G  0 part
â”œâ”€nvme2n1p3                  259:17   0 238.5G  0 part
â””â”€nvme2n1p4                  259:18   0 238.5G  0 part
nvme1n1                      259:2    0 931.5G  0 disk
â”œâ”€nvme1n1p1                  259:3    0  1007K  0 part
â”œâ”€nvme1n1p2                  259:4    0     1G  0 part /boot/efi
â””â”€nvme1n1p3                  259:5    0 930.5G  0 part
  â””â”€ ...
nvme0n1                      259:6    0 931.5G  0 disk
â”œâ”€nvme0n1p1                  259:8    0 232.9G  0 part
â”œâ”€nvme0n1p2                  259:9    0 232.9G  0 part
â”œâ”€nvme0n1p3                  259:10   0 232.9G  0 part
â””â”€nvme0n1p4                  259:14   0 232.9G  0 part
```

**ä½¿ç”¨ pveceph osd create å‘½ä»¤ï¼Œå°†è¿™äº›åˆ†åŒºä½œä¸º OSDï¼š**

```bash
$ for part in {1..4}; do
  pveceph osd create /dev/nvme0n1p$part
  pveceph osd create /dev/nvme2n1p$part
  pveceph osd create /dev/nvme3n1p$part
done
```

**æ£€æŸ¥ç»“æœ**

```bash
$ ceph osd tree
ID  CLASS  WEIGHT   TYPE NAME       STATUS  REWEIGHT  PRI-AFF
-1         2.77271  root default
-3         2.77271      host nuc
 0    ssd  0.22739          osd.0       up   1.00000  1.00000
 1    ssd  0.23289          osd.1       up   1.00000  1.00000
 2    ssd  0.23289          osd.2       up   1.00000  1.00000
 3    ssd  0.22739          osd.3       up   1.00000  1.00000
 4    ssd  0.23289          osd.4       up   1.00000  1.00000
 5    ssd  0.23289          osd.5       up   1.00000  1.00000
 6    ssd  0.22739          osd.6       up   1.00000  1.00000
 7    ssd  0.23289          osd.7       up   1.00000  1.00000
 8    ssd  0.23289          osd.8       up   1.00000  1.00000
 9    ssd  0.22739          osd.9       up   1.00000  1.00000
10    ssd  0.23289          osd.10      up   1.00000  1.00000
11    ssd  0.23289          osd.11      up   1.00000  1.00000
```

æ¥ä¸‹æ¥è¿˜éœ€è¦é…ç½®å­˜å‚¨æ± , å¹¶å°†å­˜å‚¨æ± æ·»åŠ åˆ° RBD å’Œ CephFS.

### ä½¿ç”¨

#### åœ¨ PVE è™šæ‹Ÿæœºä¸­æŒ‚è½½ CephFS

1. åˆ›å»º CephFSï¼š

   ```javascript
   ceph fs new cephfs cephfs_metadata cephfs_data
   ```

2. æ·»åŠ åˆ° PVE Web UI ä¸­çš„ CephFSï¼š

3. åœ¨ VM æˆ– LXC ä¸­æŒ‚è½½ CephFSï¼š

   ```bash
   mkdir /mnt/cephfs
   mount -t ceph 192.168.31.99:6789:/ /mnt/cephfs -o name=admin,secret=<ceph-secret>
   ```

#### åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨ RBDï¼ˆå—å­˜å‚¨ï¼‰

1. æŸ¥çœ‹ Ceph å­˜å‚¨æ± ï¼š

   ```bash
   rbd pool ls
   ```

2. åˆ›å»º RBDï¼š

   ```sql
   rbd create --size 10G vm_storage/test-disk
   ```

3. åœ¨ VM å†…éƒ¨æ˜ å°„ RBD ç£ç›˜å¹¶è¿›è¡ŒåŸºæœ¬è®¾ç½®ï¼š

   ```bash
   rbd map vm_storage/test-disk --name client.admin
   mkfs.ext4 /dev/rbd0
   mount /dev/rbd0 /mnt
   ```

**å‚è€ƒ**:

- [éƒ¨ç½²è¶…èåˆ Ceph é›†ç¾¤](https://pve-doc-cn.readthedocs.io/zh-cn/latest/chapter_pveceph/index.html)

- [Proxmox VE + Ceph è¶…èåˆé›†ç¾¤éƒ¨ç½²å®å½•](https://macesuted.moe/article/hyper-convergence)
- [proxmox+ceph é›†ç¾¤å®Œæ•´æ–¹æ¡ˆ/å®Œæ•´æ–¹æ¡ˆ](https://zhuanlan.zhihu.com/p/617024637)

> PVE ä¸Šä½¿ç”¨ Ceph çš„æƒ³æ³•ç®—äº†æ€»ç»“äº†, å¤ªå¤æ‚äº†, ç°åœ¨ 12 ä¸ª OSD è·‘äº†ä¸€æ™šä¸Šæ•°æ®è¿˜æ²¡æœ‰åŒæ­¥å®Œæˆ, æ‰€ä»¥æ‰“ç®—ç©ç© ZFS, å®¶ç”¨åº”è¯¥ä¹Ÿå¤Ÿäº†.
>
> [For Best Performance - Proxmox Cluster with CEPH or ZFS?](https://forum.proxmox.com/threads/for-best-performance-proxmox-cluster-with-ceph-or-zfs.129635/)

---

### Dashboard

```bash
apt install ceph-mgr-dashboard (on all service manager nodes)
ceph mgr module enable dashboard

# generate new pw and paste it in the dashboard-pw file
cd /etc/ceph
vim dashboard-pw
chmod 600 /etc/ceph/dashboard-pw

# ceph dashboard ac-user-create <user> -i <pw file> <role>
ceph dashboard set-login-credentials username -i dashboard
ceph config-key set mgr/dashboard/server_addr ::

# generate certificate
openssl req -newkey rsa:4096 -nodes -x509 \
-keyout /etc/ceph/dashboard-key.pem -out /etc/ceph/dashboard-crt.pem -sha512 \
-days 3650 -subj "/CN=IT/O=ceph-mgr-dashboard" -utf8

ceph config-key set mgr/dashboard/key -i /etc/ceph/dashboard-key.pem
ceph config-key set mgr/dashboard/crt -i /etc/ceph/dashboard-crt.pem

ceph mgr module disable dashboard
ceph mgr module enable dashboard
systemctl restart ceph-mgr@[servername].service

Afterwards, go to the dashboard URL: https://[IP or FQDN]:8443 or http://[IP or FQDN]:8080
```

**å‚è€ƒ**

- [ProxmoxVE å¯ç”¨ Ceph Dashboard ä»ªè¡¨ç›˜ï¼Œé…ç½® Object Getaway å¯¹è±¡ç½‘å…³](https://blog.csdn.net/qq_35485875/article/details/128906403)

### å¸è½½ Ceph ğŸ™‰

**1. åœæ­¢å¹¶ç¦ç”¨ Ceph æœåŠ¡**

é¦–å…ˆï¼Œç¡®ä¿åœæ­¢æ‰€æœ‰ä¸ Ceph ç›¸å…³çš„æœåŠ¡ï¼ŒåŒ…æ‹¬ **Monitorï¼ˆmonï¼‰**ã€**OSD**ã€**MDS**ã€**Managerï¼ˆmgrï¼‰** ç­‰ï¼š

```
systemctl stop ceph-mon.target
systemctl stop ceph-osd.target
systemctl stop ceph-mgr.target
systemctl stop ceph-mds.target
```

ç„¶åï¼Œç¦ç”¨è¿™äº›æœåŠ¡ï¼Œä»¥ç¡®ä¿å®ƒä»¬ä¸ä¼šåœ¨ç³»ç»Ÿé‡å¯åè‡ªåŠ¨å¯åŠ¨ï¼š

```
systemctl disable ceph-mon.target
systemctl disable ceph-osd.target
systemctl disable ceph-mgr.target
systemctl disable ceph-mds.target
```

**2. å¸è½½ Ceph è½¯ä»¶åŒ…**

å¸è½½æ‰€æœ‰ Ceph ç›¸å…³çš„åŒ…ï¼š

```
apt-get remove --purge ceph ceph-common ceph-mds ceph-mon ceph-osd ceph-mgr ceph-fuse librados2 librgw1 libcephfs1 librados-dev librgw-dev libboost-iostreams1.58.0 libboost-filesystem1.58.0 libboost-system1.58.0 librados2 librgw1
```

è¿™å°†åˆ é™¤æ‰€æœ‰ Ceph ç›¸å…³çš„è½¯ä»¶åŒ…åŠå…¶ä¾èµ–ã€‚

**3. åˆ é™¤ Ceph é…ç½®å’Œæ•°æ®**

åˆ é™¤ Ceph çš„é…ç½®æ–‡ä»¶å’Œæ•°æ®ç›®å½•ï¼š

```
rm -rf /etc/ceph
rm -rf /var/lib/ceph
rm -rf /var/log/ceph
```

è¿™äº›ç›®å½•åŒ…å«äº† Ceph çš„æ‰€æœ‰é…ç½®ã€æ—¥å¿—å’Œæ•°æ®æ–‡ä»¶ã€‚

**4. æ¸…ç† LVM å·å’Œ Ceph OSD æ•°æ®**

å¦‚æœæ‚¨ä½¿ç”¨äº† **LVM** æ¥ç®¡ç† Ceph OSDï¼Œç¡®ä¿åˆ é™¤æ‰€æœ‰çš„ LVM å·å’Œå·ç»„ã€‚é¦–å…ˆï¼ŒæŸ¥çœ‹å½“å‰çš„ LVM é…ç½®ï¼š

```
sudo lvdisplay
sudo vgdisplay
sudo pvdisplay
```

å¦‚æœå­˜åœ¨ Ceph ä½¿ç”¨çš„ **LVM é€»è¾‘å·**ï¼Œ**å·ç»„** æˆ– **ç‰©ç†å·**ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ é™¤å®ƒä»¬ï¼š

1. åˆ é™¤ LVM é€»è¾‘å·ï¼š

```
sudo lvremove /dev/ceph/<volume_group>/<logical_volume>
```

2. åˆ é™¤ LVM å·ç»„ï¼š

```
sudo vgremove <volume_group>
```

3. åˆ é™¤ç‰©ç†å·ï¼š

```
sudo pvremove /dev/<device>
```

4. åˆ é™¤ Ceph OSD è®¾å¤‡ï¼š

```
sudo wipefs -a /dev/<device>   # ç”¨å®é™…çš„è®¾å¤‡è·¯å¾„æ›¿æ¢ <device>
```

**5. åˆ é™¤ Ceph ç›¸å…³çš„ç³»ç»ŸæœåŠ¡æ–‡ä»¶**

æ¸…ç† Ceph æœåŠ¡æ–‡ä»¶ï¼Œç¡®ä¿æ²¡æœ‰æœåŠ¡æ–‡ä»¶æ®‹ç•™ï¼š

```
rm -f /etc/systemd/system/ceph-*
rm -f /etc/systemd/system/ceph-mgr@*.service
rm -f /etc/systemd/system/ceph-mon@*.service
rm -f /etc/systemd/system/ceph-mds@*.service
rm -f /etc/systemd/system/ceph-osd@*.service
```

**6. æ¸…é™¤ Ceph é›†ç¾¤é…ç½®å’Œå¯†é’¥**

å¦‚æœè¿˜æ²¡æœ‰åˆ é™¤ Ceph é›†ç¾¤çš„å¯†é’¥ç¯å’Œé…ç½®æ–‡ä»¶ï¼Œå¯ä»¥æ‰‹åŠ¨æ¸…ç†ï¼š

```
rm -f /etc/ceph/ceph.client.admin.keyring
rm -f /etc/ceph/ceph.mon.keyring
rm -f /etc/ceph/ceph-osd.keyring
```

**7. åˆ é™¤ ceph-crash**

```bash
systemctl stop ceph-crash
systemctl disable ceph-crash
systemctl mask ceph-crash

rm -rf /etc/systemd/system/multi-user.target.wants/ceph-crash.service
rm -rf /var/lib/ceph/crash
rm -f /usr/bin/ceph-crash
```

**8. æ¸…ç†ç½‘ç»œå’Œå­˜å‚¨è®¾ç½®**

å¦‚æœé…ç½®äº† Ceph ä½¿ç”¨çš„ç‰¹å®š **ç½‘ç»œæ¥å£** æˆ– **é˜²ç«å¢™è§„åˆ™**ï¼Œè¯·æ‰‹åŠ¨æ¸…ç†è¿™äº›è®¾ç½®ï¼š

- æ¸…ç†é˜²ç«å¢™è§„åˆ™ï¼šä½¿ç”¨ iptables æˆ– firewalld æ¸…ç† Ceph ä½¿ç”¨çš„ç«¯å£ã€‚

- åˆ é™¤ **è™šæ‹Ÿç½‘ç»œæ¥å£**ï¼ˆå¦‚ virtio ç­‰ï¼‰å’Œ **å­˜å‚¨æŒ‚è½½ç‚¹**ã€‚

**9. é‡å¯ç³»ç»Ÿ**

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œæœ€å¥½é‡å¯ç³»ç»Ÿä»¥ç¡®ä¿æ‰€æœ‰ Ceph ç»„ä»¶å®Œå…¨å¸è½½ï¼š

```
reboot
```

**10. æ£€æŸ¥ç³»ç»ŸçŠ¶æ€**

é‡å¯åï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ç³»ç»Ÿä¸­æ˜¯å¦ä»ç„¶å­˜åœ¨ä¸ Ceph ç›¸å…³çš„è¿›ç¨‹æˆ–é…ç½®ï¼š

1. æ£€æŸ¥æ˜¯å¦æœ‰ Ceph ç›¸å…³çš„è¿›ç¨‹ï¼š

```
ps aux | grep ceph
```

2. æ£€æŸ¥ Ceph é…ç½®æ˜¯å¦è¢«å®Œå…¨æ¸…é™¤ï¼š

```
ls /etc/ceph
ls /var/lib/ceph
```

3. æ£€æŸ¥ LVM æ˜¯å¦æœ‰æ®‹ç•™çš„ Ceph å·ï¼š

```
sudo lvdisplay
```

4. ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—æ˜¯å¦ä»æœ‰ Ceph ç›¸å…³çš„é”™è¯¯ï¼š

```
tail -f /var/log/syslog
```

---

## ZFS

æˆ‘ 2 å— 1T çš„ pcie4 Gen3 çš„ nvme å›ºæ€ç¡¬ç›˜, åˆ†åˆ«æ˜¯ nvme2n1 å’Œ nvme3n1, è¿˜æœ‰ä¸€å— 1T çš„ pcie4 Gen4: nvme0n1. è€Œä¸”åæœŸæˆ‘å¯èƒ½è¿˜ä¼šå¢åŠ å…¶ä»– nvme å’Œ ssd. ç°åœ¨æˆ‘æƒ³åœ¨ pve é›†ç¾¤ä¸­ä½¿ç”¨ ZFS, åˆæ­¥è®¡åˆ’æ˜¯è®© nvme0n1 åˆ’åˆ†ä¸º 2 ä¸ªåˆ†åŒº, åˆ†åˆ«ä½œä¸º zfs çš„è¯»å†™ç¼“å­˜, è€Œå…¶ä»–ç›˜ä½œä¸ºæ•°æ®ç›˜.

ä¸‹é¢æ˜¯å…·ä½“æ“ä½œ:

```bash
parted /dev/nvme0n1

(parted) mklabel gpt
(parted) print
(parted) mkpart primary 0GB 500GB
(parted) mkpart primary 500GB 100%
(parted) quit
```

```bash
zpool create nvmes mirror /dev/nvme2n1 /dev/nvme3n1

zfs set secondarycache=all nvmes
zfs set recordsize=128k  nvmes

zpool add nvmes cache /dev/nvme0n1p1
zpool add nvmes log /dev/nvme0n1p2
```

![20250221012158_iZntJA26.webp](https://cdn.dong4j.site/source/image/20250221012158_iZntJA26.webp)

### ä½¿ç”¨

**1. åœ¨ PVE å®¿ä¸»æœºä¸­ä½¿ç”¨ ZFS å­˜å‚¨**

PVE æ”¯æŒç›´æ¥åœ¨å®¿ä¸»æœºä¸­ä½¿ç”¨ ZFS å­˜å‚¨æ± ã€‚å¯ä»¥å°† ZFS å­˜å‚¨æ± æŒ‚è½½åˆ°å®¿ä¸»æœºçš„ç‰¹å®šç›®å½•ï¼Œç„¶åå°†è™šæ‹Ÿæœºå’Œ LXC å®¹å™¨é…ç½®ä¸ºä½¿ç”¨è¯¥å­˜å‚¨ã€‚

**æŒ‚è½½ ZFS å­˜å‚¨ï¼š**

```
zfs set mountpoint=/mnt/nvmes nvmes
```

è¿™å°†æŠŠä½ çš„ mypool ZFS å­˜å‚¨æ± æŒ‚è½½åˆ° /mnt/nvmes ç›®å½•ã€‚å¯ä»¥åœ¨è¿™ä¸ªç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶å¹¶è®¿é—®ã€‚

**åˆ›å»º ZFS å¿«ç…§ï¼š**

å¦‚æœä½ æƒ³å¯¹ ZFS å­˜å‚¨æ± è¿›è¡Œå¿«ç…§ï¼Œå¯ä»¥ä½¿ç”¨ï¼š

```
zfs snapshot nvmes@snapshot_name
```

**2. åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨ ZFS å­˜å‚¨**

è¦åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨ ZFS å­˜å‚¨ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š

**æ–¹å¼ 1: ä½¿ç”¨ ZFS ä½œä¸ºè™šæ‹Ÿæœºçš„ç£ç›˜**

åœ¨å®¿ä¸»æœºä¸­åˆ›å»ºä¸€ä¸ª ZFS æ•°æ®é›†ä½œä¸ºè™šæ‹Ÿæœºçš„ç£ç›˜ï¼š

```
zfs create nvmes/nvmes-disk
```

åœ¨ PVE ä¸­çš„è™šæ‹Ÿæœºé…ç½®ä¸­ï¼Œå°† nvmes/nvmes-disk æ•°æ®é›†ä½œä¸ºè™šæ‹Ÿç£ç›˜æŒ‚è½½ç»™è™šæ‹Ÿæœºã€‚ä¾‹å¦‚ï¼Œé€šè¿‡ PVE Web ç•Œé¢ï¼Œå¯ä»¥åœ¨è™šæ‹Ÿæœºçš„ç¡¬ç›˜è®¾ç½®ä¸­é€‰æ‹©è¯¥æ•°æ®é›†ï¼Œæˆ–è€…é€šè¿‡å‘½ä»¤è¡Œä½¿ç”¨ï¼š

```
qm set VMID -ide0 /dev/zvol/nvmes/nvmes-disk
```

**æ–¹å¼ 2: ä½¿ç”¨ ZFS æ–‡ä»¶å…±äº«ç»™è™šæ‹Ÿæœº**

å¦‚æœä¸å¸Œæœ›ç›´æ¥å°† ZFS å­˜å‚¨æ± ä½œä¸ºè™šæ‹Ÿç£ç›˜ï¼Œå¯ä»¥å°† ZFS å­˜å‚¨æ± ä¸­çš„æŸä¸ªç›®å½•æŒ‚è½½ä¸ºå…±äº«ç›®å½•ï¼Œè™šæ‹Ÿæœºé€šè¿‡ç½‘ç»œè®¿é—®ã€‚

1. åœ¨å®¿ä¸»æœºä¸­åˆ›å»ºç›®å½•ï¼š

```
mkdir /mnt/nvmes/share
```

2. è®¾ç½®æƒé™ï¼š

```
chmod -R 777 /mnt/nvmes/share
```

3. åœ¨è™šæ‹Ÿæœºå†…æŒ‚è½½ NFS æˆ– Samba å…±äº«ï¼ˆè§ä¸‹é¢çš„â€œå…±äº« ZFS å­˜å‚¨åˆ°å±€åŸŸç½‘â€éƒ¨åˆ†ï¼‰ã€‚

**3. åœ¨ LXC å®¹å™¨ä¸­ä½¿ç”¨ ZFS å­˜å‚¨**

LXC å®¹å™¨ä¸è™šæ‹Ÿæœºç±»ä¼¼ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è®¿é—®å®¿ä¸»æœºä¸Šçš„ ZFS å­˜å‚¨æ± ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å°† ZFS å­˜å‚¨æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨ï¼š

1. **æŒ‚è½½ ZFS å­˜å‚¨åˆ°å®¹å™¨ç›®å½•ï¼š**

å¯ä»¥å°†å®¿ä¸»æœºä¸Šçš„ ZFS å­˜å‚¨æ± æŒ‚è½½åˆ°å®¹å™¨çš„æŸä¸ªç›®å½•ã€‚å‡è®¾å°† nvmes/share æŒ‚è½½åˆ°å®¹å™¨ä¸­çš„ /mnt/storageï¼Œå¯ä»¥åœ¨å®¹å™¨é…ç½®ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

ç¼–è¾‘ /etc/pve/lxc/VMID.conf é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ ï¼š

```
mp0: /mnt/nvmes/share,mp=/mnt/storage
```

2. **é‡æ–°å¯åŠ¨å®¹å™¨ï¼š**

```
pct restart VMID
```

å®¹å™¨å°±èƒ½è®¿é—®å®¿ä¸»æœºä¸Šçš„ ZFS å­˜å‚¨äº†ã€‚

**4. åœ¨å±€åŸŸç½‘ä¸­å…±äº« ZFS å­˜å‚¨**

å¦‚æœå¸Œæœ›å°† ZFS å­˜å‚¨å…±äº«ç»™å±€åŸŸç½‘ä¸­çš„å…¶ä»–è®¾å¤‡ï¼ˆæ¯”å¦‚å…¶ä»–è®¡ç®—æœºã€æœåŠ¡å™¨æˆ–è™šæ‹Ÿæœºï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ NFS æˆ– Sambaã€‚

**ä½¿ç”¨ NFS å…±äº« ZFS å­˜å‚¨ï¼š**

1. å®‰è£… NFS æœåŠ¡ï¼š

```
apt install nfs-kernel-server
```

2. é…ç½® NFS å…±äº«ç›®å½•ï¼š

åœ¨ /etc/exports æ–‡ä»¶ä¸­æ·»åŠ  ZFS å­˜å‚¨ç›®å½•ï¼š

```
/mnt/nvmes/share *(rw,sync,no_subtree_check)
```

3. é‡æ–°å¯åŠ¨ NFS æœåŠ¡ï¼š

```
systemctl restart nfs-kernel-server
```

4. åœ¨å®¢æˆ·ç«¯ï¼ˆå…¶ä»–è®¡ç®—æœºï¼‰æŒ‚è½½å…±äº«ï¼š

```
mount -t nfs <å®¿ä¸»æœº_IP>:/mnt/nvmes/share /mnt/nfs_share
```

- [macOS ä¸Šé€šè¿‡ NFS æŒ‚è½½ PVE ZFS çš„é—®é¢˜](https://www.cnblogs.com/wangmo/p/15048045.html)
- [åœ¨ macOS ä¸Šè¯»å– ZFS ç¡¬ç›˜](https://ecnelises.com/2022/08/reading-zfs-on-macos/)

- [How to mount nfs drive on macOS with read+write access?](https://apple.stackexchange.com/questions/285390/how-to-mount-nfs-drive-on-macos-with-readwrite-access)

- [Proxmox VE pve æ·»åŠ  nfs/smb/iscsi/NTFS å‚¨å­˜](https://foxi.buduanwang.vip/virtualization/270.html/)

**ä½¿ç”¨ Samba å…±äº« ZFS å­˜å‚¨ï¼š**

1. å®‰è£… Sambaï¼š

```
apt install samba
```

2. é…ç½®å…±äº«ç›®å½•ï¼š

ç¼–è¾‘ /etc/samba/smb.conf æ–‡ä»¶ï¼Œæ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```
[nvmes]
   path = /mnt/nvmes
   browsable = yes
   read only = no
   guest ok = yes        # å…è®¸åŒ¿åè®¿é—®
   create mask = 0775    # è®¾ç½®æ–‡ä»¶çš„åˆ›å»ºæƒé™
   directory mask = 0775 # è®¾ç½®ç›®å½•çš„åˆ›å»ºæƒé™
```

```bash
chmod -R 775 /mnt/nvmes
chown -R nobody:nogroup /mnt/nvmes
```

3. é‡å¯ Samba æœåŠ¡ï¼š

```
systemctl restart smbd
```

4. åœ¨å®¢æˆ·ç«¯ï¼ˆå…¶ä»–è®¡ç®—æœºï¼‰è®¿é—®å…±äº«ï¼š

é€šè¿‡ smb:// åè®®æŒ‚è½½å…±äº«ï¼š

```
smbclient //å®¿ä¸»æœº_IP/nvmes
```

---

## ç½‘ç»œ

### ç­–ç•¥è·¯ç”±

æ¯å° PVE éƒ½æœ‰è‡³å°‘ 2 ä¸ªç½‘å¡, ä¸”åˆ†åˆ«é“¾æ¥åˆ°ç”µä¿¡å’Œè”é€šå®½å¸¦, å› ä¸º PVE åªèƒ½è®¾ç½®ä¸€ä¸ªç½‘å…³, æ‰€ä»¥éœ€è¦é€šè¿‡ç­–ç•¥è·¯ç”±çš„æ–¹å¼è®©ç¬¬äºŒå—ç½‘å¡å¯ä»¥é“¾æ¥å¤–ç½‘.

æ¯”å¦‚ **vmbr0** æ˜¯ç¬¬ä¸€å—ç½‘å¡, ä¸”èƒ½å¤ŸæˆåŠŸé“¾æ¥å¤–ç½‘, **vmbr1** æ˜¯å¦ä¸€å—ç½‘å¡, éœ€è¦é…ç½®ç­–ç•¥è·¯ç”±:

```bash
# æ·»åŠ ç¬¬äºŒä¸ªé»˜è®¤è·¯ç”±
ip route add default via 192.168.21.1 dev vmbr1 table 100

# åˆ›å»ºè§„åˆ™
ip rule add from 192.168.21.0/24 table 100
```

ç„¶åä½¿ç”¨ curl æµ‹è¯•ä¸åŒçš„ç½‘å¡:

```bash
curl --interface vmbr0 https://4.ipw.cn ; curl --interface vmbr1 https://4.ipw.cn
```

èƒ½å¤ŸæˆåŠŸè¿”å›æ­£ç¡®çš„å¤–ç½‘ IP åœ°å€.

**æŒä¹…åŒ–**

ç¼–è¾‘ `/etc/network/interfaces`:

```bash
auto vmbr1
iface vmbr1 inet static
				...
        post-up ip route add default via 192.168.21.1 dev vmbr1 table 100
        post-up ip rule add from 192.168.21.0/24 table 100
        pre-down ip rule del from 192.168.21.0/24 table 100
        pre-down ip route del default via 192.168.21.1 dev vmbr1 table 100
```

```bash
systemctl restart systemd-networkd
```

#### åŸºäº debian çš„è™šæ‹Ÿæœºé…ç½®

åŒä¸Š, éœ€è¦ä¿®æ”¹ä¸€ä¸‹ç½‘å¡å

#### åŸºäº ubuntu çš„è™šæ‹Ÿæœºé…ç½®

ç¼–è¾‘ `/etc/systemd/network/eth1.network`

```bash
[Match]
Name = eth1

[Network]
Description = Interface eth1 autoconfigured by PVE
Address = 192.168.21.100/24
Gateway=192.168.21.1
DHCP=ipv6
IPv6AcceptRA=false

[RoutingPolicyRule]
Priority=1000
From=192.168.21.0/24
Table=100

[Route]
Destination=0.0.0.0/0
Gateway=192.168.21.1
Table=100
```

```bash
systemctl restart systemd-networkd
```

```bash
curl --interface eth0 https://4.ipw.cn ; curl --interface eth1 https://4.ipw.cn
```

#### é—®é¢˜

ä¸Šè¿°é…ç½®å, è™½ç„¶èƒ½å¤Ÿé€šè¿‡ä¸¤å¼ ç½‘å¡åŒæ—¶è®¿é—®å¤–ç½‘, ä½†æ˜¯å±€åŸŸç½‘çš„å…¶ä»–è®¾å¤‡åˆ™æ— æ³•é€šè¿‡ç½‘å¡ 2 è®¿é—® pve å’Œ è™šæ‹Ÿæœº.

é—®é¢˜åœ¨äºæ²¡æœ‰ä¸Šè¿°é…ç½®æ—¶, å¦‚æœä»å…¶ä»–è®¾å¤‡è®¿é—® PVE æ—¶, PVE çŸ¥é“è¯·æ±‚æ¥è‡ª vmbr1ï¼Œç›´æ¥é€šè¿‡ vmbr1 è¿”å› `192.168.21.x`ï¼Œå› ä¸º**åŒç½‘æ®µçš„æµé‡ä¸ä¼šèµ°è·¯ç”±è¡¨**ï¼Œåªè¦ vmbr1 æœ‰ IPï¼Œæµé‡å°±ä¼šæ­£å¸¸å¾€è¿”.

ä¸ºäº†èƒ½è®©ç¬¬äºŒå—ç½‘å¡ä¹Ÿèƒ½è®¿é—®å¤–ç½‘, æˆ‘ä»¬æ·»åŠ äº†å¦‚ä¸‹é…ç½®:

```bash
# å®šä¹‰ table 100ï¼Œè®©å®ƒçš„é»˜è®¤ç½‘å…³æ˜¯ 192.168.21.1
post-up ip route add default via 192.168.21.1 dev vmbr1 table 100
# è®© ä» 192.168.21.x å‘å‡ºçš„æµé‡ èµ° table 100ï¼Œä¹Ÿå°±æ˜¯ vmbr1
post-up ip rule add from 192.168.21.0/24 table 100
```

è¿™æ ·ï¼Œ**å¦‚æœ PVE é€šè¿‡ 192.168.21.119 è®¿é—®å¤–ç½‘ï¼Œå®ƒå°±ä¼šä» vmbr1 èµ° 192.168.21.1**ï¼Œä»è€Œå®ç°ä¸¤å¼ ç½‘å¡éƒ½èƒ½è®¿é—®å¤–ç½‘çš„ç›®æ ‡.

ä½†æ˜¯å½“å±€åŸŸç½‘è®¾å¤‡è®¿é—® `192.168.21.x` æ—¶, **Linux çš„è·¯ç”±ç­–ç•¥é»˜è®¤ä½¿ç”¨â€œä¸»è·¯ç”±è¡¨â€å†³å®šå›åŒ…è·¯å¾„**, è€Œé»˜è®¤è·¯ç”±å®šä¹‰çš„æ˜¯ç½‘å¡ 1, æ‰€ä»¥ä¼šæŠŠé»˜è®¤ä»ç½‘å¡ 1 å‡ºå», å¯¼è‡´è¯·æ±‚çš„è®¾å¤‡æ— æ³•æ­£ç¡®æ¥æ”¶æ•°æ®.

**ä¸ºä»€ä¹ˆ 192.168.21.x è®¾å¤‡æ— æ³•æ­£ç¡®æ¥æ”¶æ•°æ®ï¼Ÿ**

**1. PVE æ”¶åˆ° 192.168.21.x è®¾å¤‡çš„è¯·æ±‚**

æ¯”å¦‚ 192.168.21.50 æƒ³è®¿é—® PVEï¼ˆ192.168.21.119ï¼‰ï¼Œå®ƒå‘é€æ•°æ®åŒ…ï¼š

```
src: 192.168.21.50  â†’ dst: 192.168.21.119
```

è¿™ä¸ªåŒ…ä¼šé€šè¿‡ vmbr1 æ¥æ”¶ã€‚

**2. PVE çš„é»˜è®¤è·¯ç”±é€‰æ‹© 31.x å‡ºå£**

- PVE æ—¢æœ‰ 192.168.21.119ï¼Œä¹Ÿæœ‰ 192.168.31.119ï¼ˆå‡è®¾ï¼‰ã€‚

- å› ä¸º PVE **çš„é»˜è®¤ç½‘å…³æ˜¯ 192.168.31.1**ï¼Œæ‰€ä»¥å®ƒçš„é»˜è®¤è·¯ç”±æ˜¯ï¼š

```
default via 192.168.31.1 dev vmbr0
```

- **Linux é»˜è®¤ä½¿ç”¨ â€œä¸»è·¯ç”±è¡¨â€ è¿›è¡Œè·¯ç”±æŸ¥æ‰¾ï¼Œè€Œä¸æ˜¯åŸºäºå…¥å£æ¥å£å›åŒ…**

- äºæ˜¯ PVE å‘é€å›åŒ…ï¼š

```
src: 192.168.21.119  â†’ dst: 192.168.21.50
```

ä½†æ˜¯, **å®ƒä» 31.x çš„ç½‘å…³ 192.168.31.1 å‡ºå»äº†**.

**3. å›åŒ…ä» 31.x å‡ºå»ï¼Œå¯¼è‡´ NAT å¤±è´¥**

- 192.168.21.50 è®¾å¤‡æœ¬æ¥æœŸæœ›ï¼š

  - **è¯·æ±‚**ï¼š21.50 -> 21.119
  - **å›åŒ…**ï¼š21.119 -> 21.50

- ä½†å®é™…ä¸Šå‘ç”Ÿäº†ï¼š
  - **è¯·æ±‚**ï¼š21.50 -> 21.119
  - **å›åŒ…**ï¼š21.119 -> 21.50ï¼ˆ**å´ä» 31.x å‡ºå»**ï¼‰

è¿™å¯¼è‡´ 192.168.21.50 **æ”¶åˆ°çš„å›åŒ…æº IP è¿˜æ˜¯ 21.119**ï¼Œä½†è·¯ç”±å™¨å¯èƒ½ä¼š **ä¸¢å¼ƒè¯¥åŒ…**ï¼Œå› ä¸ºï¼š

- å®ƒçš„**å…¥ç«™è¿æ¥ä¸æ˜¯ä» 31.x å‘å‡ºçš„**ï¼Œè€Œæ˜¯ä» 21.x æ¥çš„ï¼Œ**è¿™å¯¼è‡´ NAT ä¸åŒ¹é…**ã€‚

- è®¸å¤šé˜²ç«å¢™ï¼ˆç‰¹åˆ«æ˜¯ä¼ä¸šè·¯ç”±å™¨ï¼‰é»˜è®¤ä¼š**ä¸¢å¼ƒâ€éå¯¹ç§°è·¯ç”±â€çš„å›åŒ…**ï¼Œå› ä¸ºå®ƒå¯èƒ½æ˜¯ä¼ªé€ æµé‡ã€‚

---

#### è§£å†³åŠæ³•

ä¸ºäº†æ»¡è¶³ä»¥ä¸‹è¦æ±‚:

1. PVE çš„ä¸¤å¼ ç½‘å¡éƒ½èƒ½è®¿é—®å¤–ç½‘;
2. å±€åŸŸç½‘èƒ½å¤Ÿæ­£å¸¸è®¿é—® PVE çš„ä¸¤å¼ ç½‘å¡;

æˆ‘ä»¬éœ€è¦åšå¦‚ä¸‹é…ç½®.

##### åŸºäº debian

```bash
post-up ip route add 192.168.21.0/24 dev vmbr1 table 100
post-up ip route add default via 192.168.21.1 dev vmbr1 table 100
post-up ip rule add from 192.168.21.0/24 table 100
post-up ip rule add to 192.168.21.0/24 table 100
post-up ip rule add iif vmbr1 table 100

post-down ip rule del from all iif vmbr1 lookup 100
post-down ip rule del from all to 192.168.21.0/24 lookup 100
post-down ip rule del from 192.168.21.0/24 lookup 100
post-down ip route del 192.168.21.0/24 dev vmbr1 scope link table 100
post-down ip route del default via 192.168.21.1 dev vmbr1 table 100
```

> LXC æˆ–è™šæ‹Ÿæœºä¸­, åªéœ€è¦ä¿®æ”¹ä¸€ä¸‹ç½‘å¡åç§°

##### åŸºäº ubuntu

```bash
[Match]
Name=eth1

[Network]
Description=Interface eth1 autoconfigured by PVE
Address=192.168.21.103/24
Gateway=192.168.21.1
DHCP=ipv6
IPv6AcceptRA=false

[RoutingPolicyRule]
Priority=1000
From=192.168.21.0/24
Table=100

[RoutingPolicyRule]
Priority=1001
To=192.168.21.0/24
Table=100

[RoutingPolicyRule]
Priority=1002
IncomingInterface=eth1
Table=100

[Route]
Destination=192.168.21.0/24
Table=100

[Route]
Destination=0.0.0.0/0
Gateway=192.168.21.1
Table=100
```

æœ€åæˆ‘ä»¬å¯ä»¥ä»¥ä¸‹å‘½ä»¤éªŒè¯:

```bash
$ ip rule show
0:      from all lookup local
1000:   from 192.168.21.0/24 lookup 100 proto static
1001:   from all to 192.168.21.0/24 lookup 100 proto static
1002:   from all iif eth1 lookup 100 proto static
32766:  from all lookup main
32767:  from all lookup default

$ ip route show table 100
default via 192.168.21.1 dev eth1 proto static
192.168.21.0/24 dev eth1 proto static scope link
```

---

##### æµç¨‹å›¾

```mermaid
graph TD;
    subgraph "å¤–éƒ¨è®¾å¤‡"
        Client31["è®¾å¤‡ (192.168.31.x)"]
        Client21["è®¾å¤‡ (192.168.21.x)"]
    end

    subgraph "PVE æœåŠ¡å™¨"
        vmbr0["vmbr0 (192.168.31.119)"]
        vmbr1["vmbr1 (192.168.21.119)"]
        RouteTable["è·¯ç”±è¡¨ (ç­–ç•¥è·¯ç”±)"]
    end

    subgraph "ç½‘å…³"
        GW31["192.168.31.1 (é»˜è®¤ç½‘å…³)"]
        GW21["192.168.21.1"]
    end

    %% è¿æ¥è®¾å¤‡åˆ° PVE
    Client31 -- "æµé‡è¿›å…¥" --> vmbr0
    Client21 -- "æµé‡è¿›å…¥" --> vmbr1

    %% PVE çš„è·¯ç”±å¤„ç†
    vmbr0 -- "é»˜è®¤æµé‡èµ°ä¸»è·¯ç”±è¡¨ (via 192.168.31.1)" --> GW31
    vmbr1 -- "åŒ¹é…è§„åˆ™: iif vmbr1" --> RouteTable
    RouteTable -- "å‡ºå£: vmbr1 (via 192.168.21.1)" --> GW21

    %% è®¾å¤‡è®¿é—®è¿”å›æµé‡
    GW31 -- "å›åŒ…æµé‡" --> vmbr0 -- "è¿”å› Client31" --> Client31
    GW21 -- "å›åŒ…æµé‡" --> vmbr1 -- "è¿”å› Client21" --> Client21
```

---

### qemu-guest-agent

è™šæ‹Ÿæœºæ‰§è¡Œå‘½ä»¤:

```bash
sudo apt install qemu-guest-agent -y

sudo systemctl start qemu-guest-agent
```

ä¸è¿‡æŠ¥é”™äº†:

```
(base) âœ  ~ sudo systemctl start qemu-guest-agent
^@A dependency job for qemu-guest-agent.service failed. See 'journalctl -xe' for details.

Feb 20 06:26:26 ai systemd[1]: dev-virtio\x2dports-org.qemu.guest_agent.0.device: Job dev-virtio\x2dports-org.qemu.guest_agent.0.device/start timed out.
Feb 20 06:26:26 ai systemd[1]: Timed out waiting for device dev-virtio\x2dports-org.qemu.guest_agent.0.device - /dev/virtio-ports/org.qemu.guest_agent.0.
```

**è™šæ‹Ÿæœºå†…çš„ QEMU Guest Agent æ— æ³•æ‰¾åˆ° /dev/virtio-ports/org.qemu.guest_agent.0 è®¾å¤‡**ï¼Œé€šå¸¸æ˜¯å› ä¸º **PVE çš„ VM é…ç½®æ²¡æœ‰æ­£ç¡®å¯ç”¨ QEMU Guest Agent**ã€‚

æ‰€ä»¥éœ€è¦åœ¨ PVE å®¿ä¸»æœºä¸Šå¼€å¯è™šæ‹Ÿæœºçš„ Guest Agent:

```bash
qm set 102 --agent enabled=1

qm reboot 102
```

ç„¶åè¿˜æ˜¯å¯åŠ¨å¤±è´¥:

```bash
(base) âœ  ~ sudo systemctl status qemu-guest-agent
â—‹ qemu-guest-agent.service - QEMU Guest Agent
     Loaded: loaded (/usr/lib/systemd/system/qemu-guest-agent.service; static)
     Active: inactive (dead)

Feb 20 06:34:46 ai systemd[1]: qemu-guest-agent.service: Bound to unit dev-virtio\x2dports-org.qemu.guest_agent.0.device, but unit isn't active.
Feb 20 06:34:46 ai systemd[1]: Dependency failed for qemu-guest-agent.service - QEMU Guest Agent.
Feb 20 06:34:46 ai systemd[1]: qemu-guest-agent.service: Job qemu-guest-agent.service/start failed with result 'dependency'.
```

æŸ¥é˜…èµ„æ–™åå‘ç°æ˜¯éœ€è¦æ·»åŠ ä¸€ä¸ª **virtio-serial** çš„è®¾å¤‡:

```bash
qm set 102 -serial0 socket

qm reboot 102
```

ç„¶åå†æ¬¡å¯åŠ¨ agent:

```bash
(base) âœ  ~ sudo systemctl status qemu-guest-agent
â— qemu-guest-agent.service - QEMU Guest Agent
     Loaded: loaded (/usr/lib/systemd/system/qemu-guest-agent.service; static)
     Active: active (running) since Thu 2025-02-20 06:37:46 UTC; 3s ago
   Main PID: 1549 (qemu-ga)
      Tasks: 2 (limit: 38427)
     Memory: 416.0K (peak: 840.0K)
        CPU: 5ms
     CGroup: /system.slice/qemu-guest-agent.service
             â””â”€1549 /usr/sbin/qemu-ga

Feb 20 06:37:46 ai systemd[1]: Started qemu-guest-agent.service - QEMU Guest Agent.
```

æ˜¾ç¤ºå¯åŠ¨æˆåŠŸäº†, èƒ½å¤Ÿæ­£å¸¸è·å– IP ä¿¡æ¯:

![20250221012204_Kp7lflpS.webp](https://cdn.dong4j.site/source/image/20250221012204_Kp7lflpS.webp)

æœåŠ¡å™¨ä¸ŠæŸ¥çœ‹è™šæ‹Ÿæœºä¿¡æ¯:

```bash
qm agent <vmid> <cmd>

    fsfreeze-freeze
    fsfreeze-status
    fsfreeze-thaw
    fstrim                      #æŸ¥çœ‹ssdâ€”â€”trim
    get-fsinfo                  #æŸ¥çœ‹ç£ç›˜ä¿¡æ¯
    get-host-name               #æŸ¥çœ‹ä¸»æœºå
    get-memory-block-info       #æŸ¥çœ‹å†…å­˜å— ä¿¡æ¯
    get-memory-blocks           #æŸ¥çœ‹æ‚¨å†…å­˜
    get-osinfo                  #æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯
    get-time                    #æŸ¥çœ‹æ—¶é—´
    get-timezone                #æŸ¥çœ‹æ—¶åŒº
    get-users                   #ç”¨æˆ·
    get-vcpus                   #æŸ¥çœ‹CPUæ•°é‡
    info                        #æŸ¥çœ‹æ”¯æŒçš„å‘½ä»¤
    network-get-interfaces      #æŸ¥çœ‹ç½‘ç»œ
    ping                        #ä¸æ˜
    shutdown                    #å…³æœº
    suspend-disk                #ä¼‘çœ ï¼Œå‚¨å­˜åˆ°ç¡¬ç›˜
    suspend-hybrid              #ä¼‘çœ ï¼Œæ··åˆ
    suspend-ram                 #æŒ‚èµ·/ä¼‘çœ  å†…å­˜
```

**å‚è€ƒ:**

- [PVE ä¸­ qemu guest agent çš„å®‰è£…å’Œä½¿ç”¨](https://foxi.buduanwang.vip/virtualization/pve/530.html/)

### åˆ å‡ PCIe è®¾å¤‡åç½‘å¡åç§°å˜æ›´

ç½‘å¡åç§°å‘ç”Ÿå˜åŒ–æ˜¯å› ä¸ºç³»ç»Ÿä½¿ç”¨äº† **udev**ï¼ˆè®¾å¤‡ç®¡ç†å™¨ï¼‰æ¥è‡ªåŠ¨ä¸ºç½‘ç»œæ¥å£åˆ†é…åç§°ï¼Œé»˜è®¤ä½¿ç”¨ **Predictable Network Interface Names**ï¼ˆå¯é¢„æµ‹çš„ç½‘ç»œæ¥å£åç§°ï¼‰è§„åˆ™ã€‚è¿™ä¸ªè§„åˆ™åŸºäºç½‘å¡çš„ç¡¬ä»¶åœ°å€ï¼ˆMAC åœ°å€ï¼‰æˆ–è€…è®¾å¤‡è·¯å¾„ï¼ˆä¾‹å¦‚ PCI åœ°å€ï¼‰æ¥å‘½åç½‘å¡ã€‚

å½“æ‹”æ‰ GPU åï¼Œç³»ç»Ÿå¯èƒ½é‡æ–°åˆ†é…äº†ç½‘å¡æ¥å£çš„åç§°ï¼Œè¿™ä¸»è¦æ˜¯å› ä¸º PCI æ’æ§½é¡ºåºã€è®¾å¤‡åˆå§‹åŒ–é¡ºåºç­‰å› ç´ çš„å˜åŒ–ï¼Œå¯¼è‡´äº† udev ç»™ç½‘å¡åˆ†é…äº†ä¸åŒçš„åç§°ã€‚

è¿™ä¼šå¯¼è‡´ PVE ç³»ç»Ÿä¸­å·²ç»é…ç½®å¥½çš„ç½‘ç»œä¼šæ— æ³•è·å– IP.

æˆ‘ä»¬å¯ä»¥ **é€šè¿‡ udev è§„åˆ™å›ºå®šç½‘å¡åç§°**:

```bash
vim /etc/udev/rules.d/99-network.rules

SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="1c:69:7a:d0:c5:11", NAME="enp92s0"
SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="18:9b:a5:80:5a:22", NAME="enp2s0f0"
SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="18:9b:a5:80:5a:33", NAME="enp2s0f1"
SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="28:df:eb:5c:ab:44", NAME="wlp91s0"
```

é‡æ–°åŠ è½½ udev è§„åˆ™:

```bash
udevadm control --reload
```

> æˆ‘é‡æ–°åŠ è½½åæ²¡æœ‰ç”Ÿæ•ˆ, æ˜¯é‡å¯è§£å†³çš„

è¿™æ ·ï¼Œç³»ç»Ÿæ¯æ¬¡å¯åŠ¨æ—¶ï¼Œéƒ½ä¼šæ ¹æ®è¿™ä¸ªè§„åˆ™å°†æŒ‡å®šçš„ç½‘å¡åç§°å›ºå®šä¸ºä½ æŒ‡å®šçš„åç§°ã€‚

---

### 4G ç½‘å¡æ‹¨å·(qmi_wwan)

```
sudo apt update
sudo apt install libqmi-utils udhcpc
```

**é…ç½® 4G ç½‘å¡å¹¶æ‹¨å·ä¸Šç½‘**

```
# æŸ¥çœ‹ç³»ç»Ÿä¸­è¯†åˆ«åˆ°çš„ QMI è®¾å¤‡
qmicli -d /dev/cdc-wdm0 --device-open-proxy --dms-get-model

# è·å– 4G å¡çš„è®¾å¤‡ ID ä¿¡æ¯
qmicli -d /dev/cdc-wdm0 --device-open-proxy --dms-get-ids

# è·å– 4G å¡çš„ SIM å¡çŠ¶æ€
qmicli -d /dev/cdc-wdm0 --device-open-proxy --uim-get-card-status

# è·å–ç½‘ç»œä¿¡å·å¼ºåº¦ä¿¡æ¯
qmicli -d /dev/cdc-wdm0 --device-open-proxy --nas-get-signal-strength

# è·å–è¿è¥å•†ç½‘ç»œçŠ¶æ€
qmicli -d /dev/cdc-wdm0 --device-open-proxy --nas-get-serving-system

# è®¾ç½® APN å¹¶å¯åŠ¨æ‹¨å·è¿æ¥ï¼ˆæ›¿æ¢ `your_apn` ä¸ºå®é™… APNï¼‰[ä¸­å›½ç§»åŠ¨ï¼šcmnet ä¸­å›½è”é€šï¼š3gnet ä¸­å›½ç”µä¿¡ï¼šctnet]
qmicli -d /dev/cdc-wdm0 --device-open-proxy --wds-start-network="apn=your_apn,ip-type=4" --client-no-release-cid
```

**è·å–æ‹¨å·åçš„ç½‘ç»œé…ç½®**

```
# è·å–å½“å‰ç½‘ç»œé…ç½®ï¼ŒåŒ…æ‹¬ IP åœ°å€ã€å­ç½‘æ©ç å’Œç½‘å…³
qmicli -d /dev/cdc-wdm0 --device-open-proxy --wds-get-current-settings
```

**é…ç½®åŠ¨æ€è·å– IPï¼ˆDHCPï¼‰**

```
# ä¸º wwan0 æ¥å£é…ç½® DHCP åŠ¨æ€è·å– IP åœ°å€
sudo nano /etc/network/interfaces

# åœ¨æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹
# é…ç½® wwan0 ä½¿ç”¨ DHCP åŠ¨æ€è·å– IP åœ°å€
auto wwan0
iface wwan0 inet dhcp
```

**å¯åŠ¨å¹¶æ£€æŸ¥ç½‘ç»œæ¥å£**

```
# é‡å¯ç½‘ç»œæœåŠ¡ä»¥ä½¿é…ç½®ç”Ÿæ•ˆ
sudo systemctl restart networking

# ç¡®è®¤ wwan0 æ¥å£å·²æ­£ç¡®è·å– IP åœ°å€
ip a show wwan0

# æŸ¥çœ‹ç½‘ç»œè·¯ç”±ï¼Œç¡®ä¿é»˜è®¤è·¯ç”±é€šè¿‡ 4G ç½‘å¡
ip route show
```

**æ‰‹åŠ¨è¯·æ±‚ DHCP è·å– IPï¼ˆå¯é€‰ï¼‰**

```
# ä½¿ç”¨ dhclient æ‰‹åŠ¨è¯·æ±‚ DHCP æœåŠ¡å™¨åˆ†é… IP åœ°å€
sudo dhclient wwan0

# å†æ¬¡æ£€æŸ¥æ¥å£çŠ¶æ€ï¼Œç¡®è®¤æ˜¯å¦å·²è·å–åˆ° IP åœ°å€
ip a show wwan0
```

**æ·»åŠ é»˜è®¤è·¯ç”±ï¼ˆå¦‚æœéœ€è¦ï¼‰**

```
# å¦‚æœ IP åœ°å€å·²æ­£ç¡®åˆ†é…ï¼Œä½†é»˜è®¤è·¯ç”±æ²¡æœ‰è®¾ç½®ï¼Œå¯ä»¥æ‰‹åŠ¨æ·»åŠ é»˜è®¤è·¯ç”±
sudo ip route add default via <your_gateway> dev wwan0
```

**é…ç½® DNSï¼ˆå¯é€‰ï¼‰**

```
# æ‰‹åŠ¨æ·»åŠ  DNS æœåŠ¡å™¨
echo "nameserver 218.6.200.139" | sudo tee /etc/resolv.conf
echo "nameserver 61.139.2.69" | sudo tee -a /etc/resolv.conf
```

**é…ç½®è™šæ‹Ÿç½‘ç»œæ¡¥æ¥ï¼ˆPVEï¼‰**

```
# ç¼–è¾‘ç½‘ç»œé…ç½®æ–‡ä»¶ï¼Œç¡®ä¿ wwan0 æ¥å£æ¡¥æ¥åˆ°è™šæ‹Ÿç½‘æ¡¥ vmbr0
sudo nano /etc/network/interfaces

# æ·»åŠ å¦‚ä¸‹é…ç½®ï¼Œä½¿è™šæ‹Ÿæœºé€šè¿‡ 4G ç½‘ç»œè¿æ¥
auto vmbr0
iface vmbr0 inet static
    address 10.165.54.10
    netmask 255.255.255.0
    gateway 10.165.54.153
    bridge_ports wwan0
    bridge_stp off
    bridge_fd 0
```

**æµ‹è¯•ç½‘ç»œè¿æ¥**

```
# æµ‹è¯•ç½‘ç»œæ˜¯å¦èƒ½æ­£å¸¸è¿æ¥åˆ°å¤–éƒ¨åœ°å€
ping 8.8.8.8

# æµ‹è¯• DNS æ˜¯å¦èƒ½è§£æåŸŸå
dig @218.6.200.139 google.com
```

**åŠ¨æ€æ›´æ–° IP åœ°å€å’Œè·¯ç”±ï¼ˆå¦‚æœéœ€è¦é™æ€é…ç½®ï¼‰**

```
# åˆ›å»ºè„šæœ¬æ¥åŠ¨æ€æ›´æ–° IP åœ°å€å’Œè·¯ç”±ï¼ˆå½“ IP å˜åŒ–æ—¶ï¼‰
sudo nano /etc/network/if-up.d/update-wwan0-ip

# æ·»åŠ ä»¥ä¸‹å†…å®¹
#!/bin/bash
if [ "$IFACE" == "wwan0" ]; then
    IP=$(ip addr show wwan0 | grep 'inet ' | awk '{print $2}' | cut -d/ -f1)
    GATEWAY=$(ip route show dev wwan0 | grep default | awk '{print $3}')
    DNS1="218.6.200.139"
    DNS2="61.139.2.69"

    # æ›´æ–° resolv.conf
    echo "nameserver $DNS1" > /etc/resolv.conf
    echo "nameserver $DNS2" >> /etc/resolv.conf

    # æ›´æ–°é»˜è®¤è·¯ç”±
    ip route del default
    ip route add default via "$GATEWAY"

    # æ›´æ–° wwan0 çš„ IP åœ°å€ï¼ˆä»…åœ¨ä½ ä½¿ç”¨é™æ€ IP æ—¶æ‰éœ€è¦ï¼‰
    ip addr add "$IP/30" dev wwan0
fi

# èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
sudo chmod +x /etc/network/if-up.d/update-wwan0-ip
```

#### è‡ªåŠ¨æ‹¨å·

```bash
vim /etc/systemd/system/qmi-network.service

[Unit]
Description=QMI 4G Network
After=network.target

[Service]
ExecStart=/usr/bin/qmicli -d /dev/cdc-wdm0 --device-open-proxy --wds-start-network="apn=ctnet,ip-type=4" --client-no-release-cid
ExecStartPost=/sbin/udhcpc -i wwan0
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

```bash
sudo systemctl daemon-reload
sudo systemctl enable qmi-network
sudo systemctl start qmi-network
```

**å‚è€ƒ**

- [debian-QMICLI](https://manpages.debian.org/testing/libqmi-utils/qmicli.1.en.html)

---

### 4G ç½‘å¡æ‹¨å·(wvdial)

```bash
apt install wvdial

# æ‰“å¼€é…ç½®æ–‡ä»¶
vim /etc/wvdial.conf
```

```bash
# ç”µä¿¡
[Dialer T]
Init1 = ATZ
Init2 = ATQ0 V1 E1 S0=0 &C1 &D2 +FCLASS=0
Modem Type = Analog Modem
Baud = 9600
New PPPD = yes
Modem = /dev/ttyUSB3
ISDN = 0
Phone = *99#
Password = card
Username = card
```

**æ‹¨å·**

```bash
$ wvdial  T
--> WvDial: Internet dialer version 1.61
--> Initializing modem.
--> Sending: ATZ
ATZ
OK
--> Sending: ATQ0 V1 E1 S0=0 &C1 &D2 +FCLASS=0
ATQ0 V1 E1 S0=0 &C1 &D2 +FCLASS=0
OK
--> Modem initialized.
--> Sending: ATDT*99#
--> Waiting for carrier.
ATDT*99#
CONNECT 150000000
--> Carrier detected.  Waiting for prompt.
--> Don't know what to do!  Starting pppd and hoping for the best.
--> Starting pppd at Mon Feb 24 18:23:27 2025
--> Pid of pppd: 6407
--> Using interface ppp0
--> local  IP address 10.165.54.154
--> remote IP address 10.64.64.64
--> primary   DNS address 218.6.200.139
--> secondary DNS address 61.139.2.69
```

#### è‡ªåŠ¨æ‹¨å·

```bash
#! /bin/bash

#è¿è¡Œæ­¥éª¤å˜é‡åˆå§‹åŒ–
ec20_step=0

#è¶…æ—¶è®¡æ•°åˆå§‹åŒ–
over_time=0

#å¾ªç¯
while [ 1 ]
do
	#ç¬¬ä¸€æ­¥å…ˆæ£€æŸ¥é©±åŠ¨
	if [ $ec20_step -eq 0 ]; then
	#ä½¿ç”¨lsusbæŸ¥çœ‹æ˜¯å¦æœ‰ec20é©±åŠ¨ grepæŸ¥è¯¢ç»“æœæ˜¯å¦åŒ…å«Quectel
		result=$(lsusb | grep Quectel)
		echo "1. æ£€æŸ¥é©±åŠ¨: " $result
		if [[ $result =~ "EC25" ]]; then
			ec20_step=1

		else
			ec20_step=0
		fi
		#å»¶æ—¶2s
		sleep 2
	#ç¬¬äºŒæ­¥ å¼€å§‹ä½¿ç”¨ wvdial æ‹¨å·
	elif [ $ec20_step -eq 1 ]; then
		echo "2. wvdial æ‹¨å·"
		echo "password" | sudo nohup wvdial T &
		ec20_step=2

		sleep 2
	#ç¬¬ä¸‰æ­¥ æŸ¥è¯¢è·¯ç”±æ˜¯å¦åŒ…å« ppp0 ç½‘å¡ï¼Œæ‹¨å·æˆåŠŸåˆ™ä¼šåŒ…å«æœ‰ ppp0 ç½‘å¡
	elif [ $ec20_step -eq 2 ]; then
		result=$(route -n | grep ppp0)

		echo "3. æ£€æŸ¥æ˜¯å¦å­˜åœ¨ ppp0 ç½‘å¡" $result

		if [[ $result =~ "ppp0" ]]; then
			echo "3.1 åŒ…å«ç½‘å¡ï¼Œæ·»åŠ é»˜è®¤è·¯ç”±"
			#è‹¥åŒ…å«ç½‘å¡ï¼Œåˆ™æ·»åŠ é»˜è®¤è·¯ç”±
			echo "password" | sudo route add default dev ppp0
			ec20_step=3
			over_time=0
		else
			echo "3.2 ä¸åŒ…å«ç½‘å¡, å†æ¬¡å¾ªç¯æŸ¥è¯¢, å¾ªç¯æ¬¡æ•°:" $over_time
			#è¶…æ—¶è®¡æ•°
			let over_time++
		fi
		#è‹¥ä¸€åˆ†é’Ÿéƒ½æ²¡æœ‰è·¯ç”±ç½‘å¡åˆ™è¯´æ˜æ²¡æœ‰æ‹¨å·æˆåŠŸ
		if [ $over_time -eq 12 ]; then
			echo "12 æ¬¡æ£€æŸ¥ä¸å­˜åœ¨è·¯ç”±ç½‘å¡, è¯´æ˜æ²¡æœ‰æ‹¨å·æˆåŠŸ, è¿›å…¥é‡å¯é€»è¾‘"
			over_time=0
			#è¶…æ—¶æ‹¨å·åˆ™è·³å…¥é‡å¯æ­¥éª¤
			ec20_step=4
		fi

		sleep 5
	#ç¬¬å››æ­¥ é€šè¿‡ ping å‘½ä»¤æ£€æŸ¥ç½‘ç»œçŠ¶æ€
	elif [ $ec20_step -eq 3 ]; then
		result=$(ping -I ppp0 -c 1 www.baidu.com)

		echo "4. é€šè¿‡ ping å‘½ä»¤æ£€æŸ¥ç½‘ç»œçŠ¶æ€" $result

		if [[ $result =~ "1 received" ]]; then
			echo "4.1 ping æˆåŠŸ"
			over_time=0
		else
			echo "4.2 ping å¤±è´¥, å†æ¬¡å¾ªç¯æŸ¥è¯¢"
			let over_time++

		fi
		#è¶…æ—¶åˆ™æ€æ‰æ‹¨å·çº¿ç¨‹ï¼Œå¹¶è¿›å…¥é‡å¯æ­¥éª¤
		if [ $over_time -eq 6 ]; then
			echo "6 æ¬¡ ping å¤±è´¥, è¿›å…¥é‡å¯é€»è¾‘"
			over_time=0
			ec20_step=4
			echo "password" | sudo pkill wvdial
		fi
		sleep 5

	#ç¬¬äº”æ­¥é‡å¯æ¨¡å—
	elif [ $ec20_step -eq 4 ]; then
		echo "é‡å¯ç½‘å¡"
		echo -e "AT+CFUN=1,1\r\n" > /dev/ttyUSB2
		ec20_step=0
		#é‡å¯å‘½ä»¤åå»¶æ—¶ç¨å¾®é•¿ä¸€ç‚¹
		sleep 15
	fi

done
exit 0
```

---

### æ­å»º 40G/56G å†…ç½‘

#### 40G

è´­ä¹°çš„ è¿ˆç»œæ€ 354A-FCCT é»˜è®¤ä¸º ETH æ¨¡å¼, æ‰€ä»¥ç›´æ¥è¿æ¥ç„¶åæµ‹è¯•:

```bash
iperf -c 1.0.0.18 -t 30 -i 1 -P 10
------------------------------------------------------------
Client connecting to 1.0.0.18, TCP port 5001
TCP window size: 16.0 KByte (default)
------------------------------------------------------------
[  2] local 1.0.0.19 port 39866 connected with 1.0.0.18 port 5001 (icwnd/mss/irtt=87/8948/370)
[  9] local 1.0.0.19 port 39958 connected with 1.0.0.18 port 5001 (icwnd/mss/irtt=87/8948/193)
[  5] local 1.0.0.19 port 39870 connected with 1.0.0.18 port 5001 (icwnd/mss/irtt=87/8948/343)
[ 10] local 1.0.0.19 port 39954 connected with 1.0.0.18 port 5001 (icwnd/mss/irtt=87/8948/196)
[  7] local 1.0.0.19 port 39952 connected with 1.0.0.18 port 5001 (icwnd/mss/irtt=87/8948/394)
[  8] local 1.0.0.19 port 39936 connected with 1.0.0.18 port 5001 (icwnd/mss/irtt=87/8948/411)
[  6] local 1.0.0.19 port 39922 connected with 1.0.0.18 port 5001 (icwnd/mss/irtt=87/8948/320)
[  1] local 1.0.0.19 port 39864 connected with 1.0.0.18 port 5001 (icwnd/mss/irtt=87/8948/381)
[  4] local 1.0.0.19 port 39862 connected with 1.0.0.18 port 5001 (icwnd/mss/irtt=87/8948/369)
[  3] local 1.0.0.19 port 39868 connected with 1.0.0.18 port 5001 (icwnd/mss/irtt=87/8948/364)
[ ID] Interval       Transfer     Bandwidth
[  6] 0.0000-1.0000 sec   794 MBytes  6.66 Gbits/sec
[  9] 0.0000-1.0000 sec   802 MBytes  6.73 Gbits/sec
[ 10] 0.0000-1.0000 sec   399 MBytes  3.34 Gbits/sec
[  1] 0.0000-1.0000 sec   159 MBytes  1.33 Gbits/sec
[  7] 0.0000-1.0000 sec   403 MBytes  3.38 Gbits/sec
[  8] 0.0000-1.0000 sec   651 MBytes  5.46 Gbits/sec
[  3] 0.0000-1.0000 sec   420 MBytes  3.53 Gbits/sec
[  4] 0.0000-1.0000 sec   472 MBytes  3.96 Gbits/sec
[  5] 0.0000-1.0000 sec   385 MBytes  3.23 Gbits/sec
[  2] 0.0000-1.0000 sec   195 MBytes  1.64 Gbits/sec
[SUM] 0.0000-1.0000 sec  4.57 GBytes  39.3 Gbits/sec
```

åŸºæœ¬ä¸Šè·‘æ»¡äº† 40G å¸¦å®½.

#### 56G

56G éœ€è¦è®¾ç½®æˆ IB æ¨¡å¼.

##### å®‰è£… MFT

[Mellanox Firmware Tools (MFT) (nvidia.com)](https://network.nvidia.com/products/adapter-software/firmware-tools/)

å®‰è£…ä¾èµ–:

```bash
apt install -y dkms "build-*" pve-headers pve-headers-`uname -r`
```

å®‰è£… MFT æ—¶æŠ¥é”™:

```
âœ  mft-4.30.1-113-x86_64-deb mst start
Starting MST (Mellanox Software Tools) driver set
Loading MST PCI modulemodprobe: ERROR: could not insert 'mst_pci': Key was rejected by service
 - Failure: 1
Loading MST PCI configuration modulemodprobe: ERROR: could not insert 'mst_pciconf': Key was rejected by service
 - Failure: 1
Create devices

mst_pci driver not found
Unloading MST PCI module (unused) - Success
Unloading MST PCI configuration module (unused) - Success
```

æˆ‘åœ¨å¦ä¸€å° PVE ä¸Šå®‰è£…åˆ™æ²¡æœ‰é—®é¢˜, AI ç»™æˆ‘çš„å›ç­”æ˜¯ **Secure Boot é˜»æ­¢äº†æœªç­¾åçš„é©±åŠ¨**, æ‰€ä»¥æŸ¥çœ‹ä¸€ä¸‹ä¸¤å° PVE çš„ **Secure Boot** çš„çŠ¶æ€:

```bash
$ mokutil --sb-state
SecureBoot enabled
```

æŠ¥é”™çš„è¿™å°å¼€å¯äº† `SecureBoot`, å¦ä¸€å°åˆ™æ²¡æœ‰å¼€å¯, æ‰€ä»¥åŸºæœ¬ä¸Šç¡®è®¤æ˜¯è¿™ä¸ªé—®é¢˜, éœ€è¦å» BIOS ç¦ç”¨ **SecureBoot**, ç„¶åé‡æ–°å®‰è£… MFT.

ç¬¬ä¸€æ¬¡å®‰è£…çš„æ˜¯ 4.30 ç‰ˆæœ¬, å®‰è£…åä½¿ç”¨ `mst start` å‡ºç°å¦‚ä¸‹é—®é¢˜:

```bash
$ mst start
Starting MST (Mellanox Software Tools) driver set
Loading MST PCI module - Success
Loading MST PCI configuration module - Success
Create devices
Unloading MST PCI module (unused) - Success
Unloading MST PCI configuration module (unused) - Success
```

åŠ è½½æ¨¡å—ååˆè‡ªåŠ¨å¸è½½äº†, ä¸”ä½¿ç”¨ `mst status` æ— æ³•è·å–ç½‘å¡ä¿¡æ¯:

```bash
mst status
MST modules:
------------
    MST PCI module is not loaded
    MST PCI configuration module is not loaded

PCI Devices:
------------

	No devices were found.
```

æŸ¥é˜…ç›¸å…³ä¿¡æ¯å, æ˜¯å› ä¸º MFT ç‰ˆæœ¬é—®é¢˜, åœ¨å°è¯•äº†å¤šä¸ªç‰ˆæœ¬å, ç¡®è®¤ 4.24 ç‰ˆæœ¬å¯è¡Œ(**æˆ‘çš„ç½‘å¡æ˜¯ HP544+ å’Œ 354A-FCCT**):

```bash
$ mst status
MST modules:
------------
    MST PCI module loaded
    MST PCI configuration module loaded

MST devices:
------------
/dev/mst/mt4103_pciconf0         - PCI configuration cycles access.
                                   domain:bus:dev.fn=0000:01:00.0 addr.reg=88 data.reg=92 cr_bar.gw_offset=-1
                                   Chip revision is: 00
/dev/mst/mt4103_pci_cr0          - PCI direct access.
                                   domain:bus:dev.fn=0000:01:00.0 bar=0x6c600000 size=0x100000
                                   Chip revision is: 00
```

##### æŸ¥è¯¢å›ºä»¶ä¿¡æ¯

**MCX354A-FCCT**

```bash
$ mlxfwmanager
Querying Mellanox devices firmware ...

Device #1:
----------

  Device Type:      ConnectX3Pro
  Part Number:      MCX354A-FCC_Ax
  Description:      ConnectX-3 Pro VPI adapter card; dual-port QSFP; FDR IB (56Gb/s) and 40GigE;PCIe3.0 x8 8GT/s;RoHS R6
  PSID:             MT_1090111019
  PCI Device Name:  /dev/mst/mt4103_pci_cr0
  Port1 GUID:       e41d2d03004ab0c1
  Port2 GUID:       e41d2d03004ab0c2
  Versions:         Current        Available
     FW             2.42.5000      N/A
     PXE            3.4.0752       N/A

  Status:           No matching image found
```

**HP544+**

```bash
$ mlxfwmanager
Querying Mellanox devices firmware ...

Device #1:
----------

  Device Type:      ConnectX3Pro
  Part Number:      764285-B21_Ax
  Description:      HP InfiniBand FDR/Ethernet 10Gb/40Gb 2-port 544+FLR-QSFP Adapter
  PSID:             HP_1380110017
  PCI Device Name:  /dev/mst/mt4103_pci_cr0
  Port1 GUID:       88e9a4ffff1241a1
  Port2 MAC:        88e9a41241a2
  Versions:         Current        Available
     FW             2.42.5700      N/A
     CLP            8025           N/A
     PXE            3.4.0754       N/A
     UEFI           14.11.0049     N/A

  Status:           No matching image found
```

##### åˆ‡æ¢ IB/Ethernet æ¨¡å¼

é¦–å…ˆæŸ¥è¯¢å½“å‰è¿æ¥æ¨¡å¼:

```bash
mlxconfig -d /dev/mst/mt4103_pci_cr0 query

Device #1:
----------

Device type:    ConnectX3Pro
Device:         /dev/mst/mt4103_pci_cr0

Configurations:                                      Next Boot
         SRIOV_EN                                    True(1)
         NUM_OF_VFS                                  8
         LINK_TYPE_P1                                ETH(2)
         LINK_TYPE_P2                                ETH(2)
         LOG_BAR_SIZE                                3
         BOOT_PKEY_P1                                0
         BOOT_PKEY_P2                                0
         BOOT_OPTION_ROM_EN_P1                       True(1)
         BOOT_VLAN_EN_P1                             False(0)
         BOOT_RETRY_CNT_P1                           0
         LEGACY_BOOT_PROTOCOL_P1                     PXE(1)
         BOOT_VLAN_P1                                1
         BOOT_OPTION_ROM_EN_P2                       True(1)
         BOOT_VLAN_EN_P2                             False(0)
         BOOT_RETRY_CNT_P2                           0
         LEGACY_BOOT_PROTOCOL_P2                     PXE(1)
         BOOT_VLAN_P2                                1
         IP_VER_P1                                   IPv4(0)
         IP_VER_P2                                   IPv4(0)
         CQ_TIMESTAMP                                True(1)
```

å…¶ä¸­ **LINK_TYPE_P1** ä¸º ETH, ä¿®æ”¹ä¸º IB æ¨¡å¼:

```bash
mlxconfig -d /dev/mst/mt4103_pciconf0 set LINK_TYPE_P1=1
mlxconfig -d /dev/mst/mt4103_pciconf0 set LINK_TYPE_P2=1
```

1. IB æ¨¡å¼
2. ETH æ¨¡å¼
3. VPI æ¨¡å¼

##### IB ç»„ç½‘

```bash
# å®‰è£…ç›¸å…³ä¾èµ–
apt update
apt install -y infiniband-diags rdma-core ibverbs-providers perftest
```

**æ£€æŸ¥ InfiniBand è®¾å¤‡æ˜¯å¦å¯ç”¨**

```bash
ibstat

CA 'mlx4_0'
	CA type: MT4103
	Number of ports: 2
	Firmware version: 2.42.5700
	Hardware version: 0
	Node GUID: 0x88e9a4ffff1241a0
	System image GUID: 0x88e9a4ffff1241a3
	Port 1:
		State: Initializing
		Physical state: LinkUp
		Rate: 56
		Base lid: 0
		LMC: 0
		SM lid: 0
		Capability mask: 0x02514868
		Port GUID: 0x88e9a4ffff1241a1
		Link layer: InfiniBand
	Port 2:
		State: Down
		Physical state: Disabled
		Rate: 10
		Base lid: 0
		LMC: 0
		SM lid: 0
		Capability mask: 0x00010000
		Port GUID: 0x8ae9a4fffe1241a2
		Link layer: Ethernet
```

##### InfiniBand å­ç½‘ç®¡ç†å™¨

ibstat è¾“å‡ºæ˜¾ç¤º **Port 1 ä»ç„¶å¤„äº â€œInitializingâ€ çŠ¶æ€**ï¼Œè¯´æ˜ InfiniBand è¿æ¥è¿˜æ²¡æœ‰å®Œå…¨å»ºç«‹ï¼Œå› ä¸º InfiniBand ç½‘ç»œéœ€è¦ **Subnet Manager (SM)** æ¥ç®¡ç†è¿æ¥ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœç½‘ç»œä¸­æ²¡æœ‰è¿è¡Œ InfiniBand äº¤æ¢æœºï¼ˆæ”¯æŒ SMï¼‰ï¼Œåˆ™éœ€è¦åœ¨ **è‡³å°‘ä¸€å° PVE æœåŠ¡å™¨ä¸Šè¿è¡Œ SM**ã€‚

> æ‰€æœ‰ InfiniBand ç½‘ç»œéƒ½å¿…é¡»è¿è¡Œå­ç½‘ç®¡ç†å™¨æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚å³ä½¿ä¸¤å°æœºå™¨æ²¡æœ‰ä½¿ç”¨äº¤æ¢æœºç›´æ¥è¿›è¡Œè¿æ¥ï¼Œä¹Ÿæ˜¯å¦‚æ­¤ã€‚
>
> æœ‰å¯èƒ½æœ‰ä¸€ä¸ªä»¥ä¸Šçš„å­ç½‘ç®¡ç†å™¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€ä¸ª master å……å½“ä¸€ä¸ªä¸»å­ç½‘ç®¡ç†å™¨ï¼Œå¦ä¸€ä¸ªå­ç½‘ç®¡ç†å™¨å……å½“ä»å±å­ç½‘ç®¡ç†å™¨ï¼Œå½“ä¸»å­ç½‘ç®¡ç†å™¨å‡ºç°æ•…éšœæ—¶å°†æ¥ç®¡ã€‚
>
> Red Hat Enterprise Linux æä¾› `OpenSM`ï¼Œè¿™æ˜¯ InfiniBand å­ç½‘ç®¡ç†å™¨çš„å®ç°ã€‚ä½†æ˜¯ï¼Œ`Open` SM çš„åŠŸèƒ½æ˜¯æœ‰é™çš„ï¼Œæ²¡æœ‰æ´»è·ƒçš„ä¸Šæ¸¸å¼€å‘ã€‚é€šå¸¸ï¼ŒInfiniBand äº¤æ¢æœºä¸­åµŒå…¥çš„å­ç½‘ç®¡ç†å™¨æä¾›æ›´å¤šåŠŸèƒ½ï¼Œå¹¶æ”¯æŒæœ€æ–°çš„ InfiniBand ç¡¬ä»¶ã€‚è¯¦æƒ…è¯·æŸ¥çœ‹ [å®‰è£…å’Œé…ç½® OpenSM InfiniBand å­ç½‘ç®¡ç†å™¨](https://access.redhat.com/articles/7087953?extIdCarryOver=true&sc_cid=701f2000001Css5AAC)ã€‚

```bash
apt install -y opensm
systemctl enable --now opensm
```

```bash
$ ibstat
CA 'mlx4_0'
	CA type: MT4103
	Number of ports: 2
	Firmware version: 2.42.5700
	Hardware version: 0
	Node GUID: 0x88e9a4ffff1241a0
	System image GUID: 0x88e9a4ffff1241a3
	Port 1:
		State: Active
		Physical state: LinkUp
		Rate: 56
		Base lid: 1
		LMC: 0
		SM lid: 1
		Capability mask: 0x0251486a
		Port GUID: 0x88e9a4ffff1241a1
		Link layer: InfiniBand
	Port 2:
		State: Down
		Physical state: Disabled
		Rate: 10
		Base lid: 0
		LMC: 0
		SM lid: 0
		Capability mask: 0x00010000
		Port GUID: 0x8ae9a4fffe1241a2
		Link layer: Ethernet
```

ç°åœ¨æ˜¾ç¤ºè¿æ¥æ­£å¸¸, ä¸”è‡ªåŠ¨æ–°å¢äº†ä¸€ä¸ª IB ç½‘ç»œ:

```bash
ip a

...
5: ibp1s0: <BROADCAST,MULTICAST> mtu 4092 qdisc noop state DOWN group default qlen 256
    link/infiniband 80:00:02:08:fe:80:00:00:00:00:00:00:e4:1d:2d:03:00:4a:b0:c1 brd 00:ff:ff:ff:ff:12:40:1b:ff:ff:00:00:00:00:00:00:ff:ff:ff:ff
...
```

æ¥ä¸‹æ¥å°±æ˜¯é…ç½®é™æ€ IP, å°†ä¸¤å° PVE é€šè¿‡ IB ç½‘ç»œè¿æ¥.

##### IP over Infiniband

InfiniBand æ˜¯ä¸€ç§é«˜é€Ÿç½‘ç»œé€šä¿¡æŠ€æœ¯ï¼Œç”¨äºåœ¨è®¡ç®—æœºç³»ç»Ÿå’Œæ•°æ®ä¸­å¿ƒä¸­è¿æ¥é«˜æ€§èƒ½è®¡ç®—ã€å­˜å‚¨å’Œç½‘ç»œè®¾å¤‡ã€‚InfiniBand æä¾›äº†ä¸€ç§é«˜æ•ˆçš„ä½å»¶è¿Ÿå’Œé«˜å¸¦å®½çš„è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡ä½¿ç”¨ä¸“ç”¨ç¡¬ä»¶å’Œåè®®æ¥æé«˜æ•°æ®ä¼ è¾“çš„é€Ÿåº¦å’Œå¯é æ€§ã€‚ä¸ä¼ ç»Ÿçš„ä»¥å¤ªç½‘æŠ€æœ¯ç›¸æ¯”ï¼ŒInfiniBand æä¾›äº†æ›´é«˜çš„å¸¦å®½å’Œæ›´ä½çš„å»¶è¿Ÿã€‚

ç„¶è€Œï¼Œä¸æ˜¯æ‰€æœ‰çš„è½¯ä»¶éƒ½æ”¯æŒ Infinibandï¼Œå› æ­¤èµ‹äºˆ infiniband ä¸€ä¸ª IP åˆ™å¯ä»¥è®©å®ƒå…¼å®¹å¤§éƒ¨åˆ†çš„è½¯ä»¶åè®®ï¼Œè¿™ç§æ–¹æ³•å°±æ˜¯ IP over Infiniband(IPoIB)ã€‚

**HP544+**

```bash
auto ibp1s0
iface ibp1s0 inet static
    address 1.0.0.1
    netmask 255.255.255.0
    mtu 65520
# IB
```

**MCX354A-FCCT**

```bash
auto ibp1s0
iface ibp1s0 inet static
    address 1.0.0.2
    netmask 255.255.255.0
    mtu 65520
# IB
```

**è‡ªåŠ¨åŠ è½½æ¨¡å—**

```bash
vim /etc/modules

+ ib_ipoib
+ ib_umad
```

**é‡å¯ç½‘ç»œ**

```bash
ip link set ibp1s0 down && ip link set ibp1s0 up
```

**æµ‹è¯•**

```bash
ping -c 4 1.0.0.2  # åœ¨ PVE1 ä¸Š
ping -c 4 1.0.0.1  # åœ¨ PVE2 ä¸Š
```

**ibping æµ‹è¯•**

é¦–å…ˆåœ¨ HP544+ çš„æœåŠ¡å™¨(èŠ‚ç‚¹ä¸º **NUC**)ä¸Šå¯åŠ¨æœåŠ¡ç«¯:

```bash
ibping -S
```

ç„¶åæŸ¥è¯¢ç›¸å…³ä¿¡æ¯:

```bash
$ ibnetdiscover

#
# Topology file: generated on Tue Mar  4 14:51:01 2025
#
# Initiated from node e41d2d03004ab0c0 port e41d2d03004ab0c1

vendid=0x2c9
devid=0x1007
sysimgguid=0x88e9a4ffff1241a3
caguid=0x88e9a4ffff1241a0
Ca	2 "H-88e9a4ffff1241a0"		# "nuc mlx4_0"
[1](88e9a4ffff1241a1) 	"H-e41d2d03004ab0c0"[1] (e41d2d03004ab0c1) 		# lid 1 lmc 0 "alpha mlx4_0" lid 2 4xFDR

vendid=0x2c9
devid=0x1007
sysimgguid=0xe41d2d03004ab0c3
caguid=0xe41d2d03004ab0c0
Ca	2 "H-e41d2d03004ab0c0"		# "alpha mlx4_0"
[1](e41d2d03004ab0c1) 	"H-88e9a4ffff1241a0"[1] (88e9a4ffff1241a1) 		# lid 2 lmc 0 "nuc mlx4_0" lid 1 4xFDR
```

æ˜¾ç¤ºæœ‰ 2 ä¸ªèŠ‚ç‚¹, åˆ†åˆ«æ˜¯ **nuc(lid = 1)** å’Œ **alpha(lid = 2)**, æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨èŠ‚ç‚¹ **alpha** ä¸Šä½œä¸ºå®¢æˆ·ç«¯å¯åŠ¨æµ‹è¯•:

```bash
$ ibping -L 1
Pong from nuc.(none) (Lid 1): time 0.040 ms
Pong from nuc.(none) (Lid 1): time 0.057 ms
Pong from nuc.(none) (Lid 1): time 0.045 ms
```

##### æµ‹è¯• IB ç½‘ç»œé€Ÿåº¦

åœ¨ **NUC** èŠ‚ç‚¹ä¸Šè¿è¡Œ:

```bash
$ ib_send_bw -d ibp1s0 -i 1

************************************
* Waiting for client to connect... *
************************************
```

åœ¨ **Aplha** èŠ‚ç‚¹ä¸Šè¿è¡Œ:

```bash
$ ib_send_bw -d ibp1s0 -i 1 1.0.0.1
---------------------------------------------------------------------------------------
                    Send BW Test
 Dual-port       : OFF		Device         : mlx4_0
 Number of qps   : 1		Transport type : IB
 Connection type : RC		Using SRQ      : OFF
 PCIe relax order: ON
 ibv_wr* API     : OFF
 TX depth        : 128
 CQ Moderation   : 1
 Mtu             : 2048[B]
 Link type       : IB
 Max inline data : 0[B]
 rdma_cm QPs	 : OFF
 Data ex. method : Ethernet
---------------------------------------------------------------------------------------
 local address: LID 0x02 QPN 0x020a PSN 0x749791
 remote address: LID 0x01 QPN 0x021a PSN 0xbd4c28
---------------------------------------------------------------------------------------
 #bytes     #iterations    BW peak[MB/sec]    BW average[MB/sec]   MsgRate[Mpps]
Conflicting CPU frequency values detected: 4511.015000 != 800.000000. CPU Frequency is not max.
 65536      1000             5757.44            5757.29		   0.092117
---------------------------------------------------------------------------------------
```

BW é€Ÿç‡æ¥è¿‘ **56Gbps**ï¼Œè¯´æ˜ IB é€Ÿç‡æ­£å¸¸ã€‚

##### ä½¿ç”¨ RDMA æå‡ IB ç½‘ç»œæ€§èƒ½

```bash
modprobe ib_ipoib
echo "options ib_ipoib ipoib_cm=1" > /etc/modprobe.d/ib_ipoib.conf
update-initramfs -u
reboot
```

ç„¶åæ£€æŸ¥ RDMA æ˜¯å¦å¯ç”¨ï¼š

```bash
cat /sys/module/ib_ipoib/parameters/ipoib_cm
```

å¦‚æœè¿”å› Yï¼Œè¯´æ˜ RDMA å·²å¼€å¯ï¼Œå¯ä»¥è¿›ä¸€æ­¥æå‡ InfiniBand ç½‘ç»œæ€§èƒ½ ğŸš€

> æœåŠ¡å™¨æœ‰å¤šä¸ªç½‘å¡å¹¶ä¸”å·²ç»é…ç½®å¥½è¿è¡Œå½“ä¸­ï¼Œå´æ²¡è®°å¾— eth0ã€eth1ã€eth2â€¦..åˆ†åˆ«å¯¹åº”çš„æ˜¯å“ªä¸ªç‰©ç†çš„ç½‘å¡ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤
>
> ```bash
> ethtool -p eth0
> ```
>
> æ­¤æ—¶å°±ä¼šçœ‹åˆ° eth0 å¯¹åº”çš„ç‰©ç†å£ä¸€ä¸ªç¯åœ¨ä¸åœçš„**é—ªçƒ**

**å‚è€ƒ**:

- [ç”µè„‘ç¡¬ä»¶å­¦ä¹ ç¬”è®°-HP544+-å›ºä»¶](https://skyao.io/learning-computer-hardware/nic/hp544/firmware/mft/)
- [ZFS:ä» 10Gbps å‡çº§åˆ° 40Gbps ç½‘ç»œ](https://blog.xjn819.com/post/Upgrade-from-10Gbps-to-40Gbps-network.html)
- [å®¶ç”¨ä¸‡å…†ç½‘ç»œæŒ‡å— 1 - ä¸å¦‚å…ˆæ¥ä¸ªæœ€ç®€å•çš„ 100G ç½‘ç»œ](https://zhuanlan.zhihu.com/p/74082377)
- [HP544+ ç½‘å¡æµ‹é€Ÿ](https://skyao.io/learning-computer-hardware/nic/hp544/speedtest/)
- [åœ¨ PVE8 ä¸­ä½¿ç”¨ HPE 544+FLR(ConnectX-3 Pro)](https://xsl.sh/2023/09/pve8-hpe-544-flr/)
- [é…ç½® InfiniBand å’Œ RDMA ç½‘ç»œ](https://docs.redhat.com/zh-cn/documentation/red_hat_enterprise_linux/8/html-single/configuring_infiniband_and_rdma_networks/index)
- [ib ç½‘ç»œä¸­ NFS èµ° RDMA åè®®](http://bbs.keinsci.com/thread-26947-1-1.html)
- [Mellanox ç½‘å¡å®‰è£…æ•™ç¨‹](https://www.hua-hang.cn/case/292.html)

---

### 82599ES ç½‘å¡ å¼€å¯ SR-IOV

**å‚è€ƒ**

- [PVE8.X å¼€å¯ç½‘å¡ SR-IOV è™šæ‹ŸåŒ–--åŸºäºè‹±ç‰¹å°” Intel 82576 ç½‘å¡](https://yangwenqing.com/archives/1875/)
- [**PVE 7.x-8.x Proxmox VE 7 8 ç½‘å¡ Sriov å¼€å¯ ä¿å§†çº§æ•™ç¨‹**](https://www.bilibili.com/opus/929162659226452001)

## è¿æ¥ USB æ‘„åƒå¤´

```bash
$ lsusb

Bus 003 Device 004: ID 1bcf:2c6a Sunplus Innovation Technology Inc. 5M Cam
```

**åŠ è½½é©±åŠ¨**

```bash
modprobe uvcvideo
```

**æ£€æŸ¥æ‘„åƒå¤´è®¾å¤‡æ–‡ä»¶**

```bash
$ ls /dev/video*

/dev/video0  /dev/video1
```

**å®‰è£… v4l-utils**

v4l-utils æ˜¯ç”¨äºè§†é¢‘è®¾å¤‡çš„å·¥å…·ï¼Œå¯ä»¥æµ‹è¯•å’Œé…ç½®æ‘„åƒå¤´ï¼š

```bash
$ apt install v4l-utils

$ v4l2-ctl --list-devices
5M Cam: 5M Cam (usb-0000:00:14.0-6):
	/dev/video0
	/dev/video1
	/dev/media0
```

**æ¨æµ**:

```bash
ffmpeg -f v4l2 -i /dev/video0 -vcodec libx264 -preset ultrafast -tune zerolatency -f flv rtmp://192.168.31.7/live/stream
```

å¦‚æœéœ€è¦ä¿®æ”¹åˆ†è¾¨ç‡, æˆ‘ä»¬éœ€è¦å…ˆæ”¯æŒæ‘„åƒå¤´æ”¯æŒå“ªäº›åˆ†è¾¨ç‡:

```bash
$ v4l2-ctl --list-formats-ext
ioctl: VIDIOC_ENUM_FMT
	Type: Video Capture

	[0]: 'YUYV' (YUYV 4:2:2)
		Size: Discrete 640x480
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 800x600
			Interval: Discrete 0.067s (15.000 fps)
		Size: Discrete 320x240
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 352x288
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 1024x768
			Interval: Discrete 0.125s (8.000 fps)
		Size: Discrete 1280x720
			Interval: Discrete 0.100s (10.000 fps)
		Size: Discrete 1280x960
			Interval: Discrete 0.125s (8.000 fps)
		Size: Discrete 1600x1200
			Interval: Discrete 0.200s (5.000 fps)
		Size: Discrete 1920x1080
			Interval: Discrete 0.200s (5.000 fps)
		Size: Discrete 2592x1944
			Interval: Discrete 0.333s (3.000 fps)
		Size: Discrete 2048x1536
			Interval: Discrete 0.333s (3.000 fps)
	[1]: 'MJPG' (Motion-JPEG, compressed)
		Size: Discrete 640x480
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 800x600
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 320x240
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 352x288
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 1024x768
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 1280x720
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 1280x960
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 1600x1200
			Interval: Discrete 0.067s (15.000 fps)
		Size: Discrete 1920x1080
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 2592x1944
			Interval: Discrete 0.067s (15.000 fps)
		Size: Discrete 2048x1536
			Interval: Discrete 0.067s (15.000 fps)
```

### æ¨æµ

```bash
ffmpeg -f v4l2 -i /dev/video0 -vcodec libx264 -preset ultrafast -tune zerolatency -s 1280x720 -f flv rtmp://192.168.31.7/live/stream
```

**å‚æ•°è§£æï¼š**

**1. -f v4l2**

- **ä½œç”¨**ï¼šæŒ‡å®šè¾“å…¥æ ¼å¼ä¸º v4l2ï¼Œå³ä½¿ç”¨ Video4Linux2 é©±åŠ¨æ¥æ•è·è§†é¢‘æµã€‚

- **èƒŒæ™¯**ï¼šv4l2 æ˜¯ Linux ç³»ç»Ÿä¸­å¤„ç†è§†é¢‘è®¾å¤‡ï¼ˆä¾‹å¦‚ USB æ‘„åƒå¤´ï¼‰çš„è§†é¢‘é©±åŠ¨æ ‡å‡†ã€‚æ­¤å‚æ•°å‘Šè¯‰ ffmpeg ä½¿ç”¨ v4l2 é©±åŠ¨æ¥æ•è·æ‘„åƒå¤´çš„å®æ—¶è§†é¢‘æµã€‚

**2. -i /dev/video0**

- **ä½œç”¨**ï¼šæŒ‡å®šè¾“å…¥è§†é¢‘æºï¼Œè¿™é‡Œæ˜¯ /dev/video0ï¼Œè¡¨ç¤ºè¿æ¥çš„ USB æ‘„åƒå¤´è®¾å¤‡ã€‚

- **èƒŒæ™¯**ï¼šåœ¨ Linux ç³»ç»Ÿä¸­ï¼Œè§†é¢‘è®¾å¤‡é€šå¸¸ä»¥ /dev/videoX çš„å½¢å¼è¡¨ç¤ºï¼ˆX æ˜¯æ•°å­—ï¼‰ã€‚ä½ å¯ä»¥é€šè¿‡ ls /dev/video\* å‘½ä»¤æŸ¥çœ‹è®¾å¤‡åç§°ï¼Œé€šå¸¸ç¬¬ä¸€ä¸ªæ‘„åƒå¤´æ˜¯ /dev/video0ã€‚

**3. -vcodec libx264**

- **ä½œç”¨**ï¼šæŒ‡å®šè§†é¢‘ç¼–ç å™¨ä½¿ç”¨ libx264ï¼Œå³ H.264 ç¼–ç æ ¼å¼ã€‚

- **èƒŒæ™¯**ï¼šlibx264 æ˜¯ä¸€ç§é«˜æ•ˆçš„ H.264 è§†é¢‘ç¼–ç å™¨ï¼Œå¹¿æ³›ç”¨äºè§†é¢‘æµå’Œè§†é¢‘æ–‡ä»¶çš„å‹ç¼©ã€‚H.264 æ˜¯ç°ä»£è§†é¢‘æµåª’ä½“ä¸­çš„å¸¸è§ç¼–ç æ ¼å¼ï¼Œå› ä¸ºå®ƒå¯ä»¥æä¾›è¾ƒé«˜çš„å‹ç¼©æ•ˆç‡å’Œè´¨é‡ã€‚

**4. -preset ultrafast**

- **ä½œç”¨**ï¼šè®¾ç½®ç¼–ç é¢„è®¾ä¸º ultrafastï¼Œè¿™æ˜¯ä¸€ä¸ªç¼–ç é€Ÿåº¦æœ€å¿«çš„è®¾ç½®ï¼Œä½†ä¼šç‰ºç‰²ä¸€å®šçš„è§†é¢‘å‹ç¼©ç‡ã€‚

- **èƒŒæ™¯**ï¼špreset æ§åˆ¶ libx264 ç¼–ç çš„é€Ÿåº¦å’Œå‹ç¼©æ•ˆç‡ï¼Œé€‰æ‹©è¾ƒå¿«çš„ç¼–ç é¢„è®¾å¯ä»¥å‡å°‘å»¶è¿Ÿã€‚ultrafast æ˜¯æœ€å¿«çš„é¢„è®¾ï¼Œä½†ä¼šä½¿æ–‡ä»¶ä½“ç§¯ç›¸å¯¹è¾ƒå¤§ï¼Œé€‚åˆä½å»¶è¿Ÿçš„å®æ—¶æµã€‚

**5. -tune zerolatency**

- **ä½œç”¨**ï¼šä¼˜åŒ–ç¼–ç å™¨ä»¥å‡å°‘å»¶è¿Ÿã€‚

- **èƒŒæ™¯**ï¼štune é€‰é¡¹æ§åˆ¶ libx264 ç¼–ç å™¨çš„è°ƒä¼˜æ¨¡å¼ã€‚zerolatency æ˜¯ä¸€ç§ä¸“é—¨ç”¨äºä½å»¶è¿Ÿæµçš„è®¾ç½®ï¼Œé€‚ç”¨äºç›´æ’­ã€è§†é¢‘ä¼šè®®ç­‰å®æ—¶åº”ç”¨ã€‚

**6. -s 1280x720**

- **ä½œç”¨**ï¼šè®¾ç½®è¾“å‡ºè§†é¢‘çš„åˆ†è¾¨ç‡ä¸º 1280x720ã€‚

- **èƒŒæ™¯**ï¼š-s é€‰é¡¹ç”¨äºè®¾ç½®è¾“å‡ºè§†é¢‘çš„åˆ†è¾¨ç‡ï¼Œ1280x720 æ˜¯å¸¸è§çš„é«˜æ¸…åˆ†è¾¨ç‡ã€‚å¦‚æœä½ çš„æ‘„åƒå¤´æ”¯æŒæ›´é«˜çš„åˆ†è¾¨ç‡ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œè°ƒæ•´ã€‚

**7. -f flv**

- **ä½œç”¨**ï¼šè®¾ç½®è¾“å‡ºæ ¼å¼ä¸º flvï¼ˆFlash Video æ ¼å¼ï¼‰ã€‚

- **èƒŒæ™¯**ï¼šflv æ˜¯ä¸€ç§å¸¸ç”¨äºæµåª’ä½“ä¼ è¾“çš„æ ¼å¼ï¼Œå°¤å…¶æ˜¯åœ¨ RTMPï¼ˆReal-Time Messaging Protocolï¼‰æµåª’ä½“ä¼ è¾“ä¸­ã€‚å¤§éƒ¨åˆ†æµåª’ä½“æœåŠ¡å™¨ï¼ˆå¦‚ NGINX å’Œ RTMPï¼‰æ”¯æŒè¿™ç§æ ¼å¼ã€‚

**8. rtmp://192.168.31.7/live/stream**

- **ä½œç”¨**ï¼šæŒ‡å®š RTMP æœåŠ¡å™¨åœ°å€ã€‚

- **èƒŒæ™¯**ï¼šè¿™æ˜¯ä½ è¦æ¨é€æµçš„ RTMP æœåŠ¡å™¨åœ°å€ã€‚rtmp://192.168.31.7/live/stream è¡¨ç¤ºæ¨é€æµåˆ° IP åœ°å€ 192.168.31.7 ä¸Šçš„ live/stream è·¯å¾„ã€‚ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„æœåŠ¡å™¨åœ°å€å’Œè·¯å¾„è¿›è¡Œä¿®æ”¹ã€‚

---

## Cloud-init

**å‚è€ƒ**

- [åœ¨ PVE 8 ä¸­ä½¿ç”¨ Cloud-init åˆå§‹åŒ– ubuntu cloud-image å¹¶åˆ›å»ºæ¨¡æ¿](https://never666.uk/2107/)
- [ä¸€é”®å˜èº«ï¼Cloud-Init è®© PVE é•œåƒåä¸½è½¬èº«ï¼Œå¿«æ¥çœ‹çœ‹æ€ä¹ˆåšï¼](https://blog.csdn.net/sinat_28521487/article/details/140126760)

---

## ä½¿ç”¨åŸŸåå¹¶æ·»åŠ  SSL è¯ä¹¦

```bash
mkcert "alpha.pve" 192.168.1.119

mkcert -install
```

åœ¨ PVE æ§åˆ¶å°æ·»åŠ  SSL è¯ä¹¦: **ç³»ç»Ÿ->å‡­è¯**

åœ¨ Surge è®¾ç½®è‡ªå®šä¹‰ Hosts:

```bash
alpha.pve = 192.168.1.119
```

åœ¨ Surge è®¾ç½®è§„åˆ™:

```bash
[Rule]
DOMAIN-SUFFIX,*.pve,DIRECT
```

**å‚è€ƒ**

https://post.smzdm.com/p/an3on89p/

---

## è‡ªåˆ¶ CT æ¨¡ç‰ˆ

**æ¸…ç†æ— ç”¨è½¯ä»¶åŒ…**

```bash
apt autoremove -y --purge
apt clean
```

**æ¸…é™¤ DNS å’Œä¸»æœºåé…ç½®**

```bash
rm /etc/resolv.conf
rm /etc/hostname
```

**æ¸…é™¤æ“ä½œå‘½ä»¤**

```bash
history -c
```

#### åˆ›å»ºå®¹å™¨å¤‡ä»½

```bash
vzdump 100 --dumpdir /var/lib/vz/dump --compress zstd
```

**ç§»åŠ¨åˆ° CT æ¨¡æ¿ç›®å½•**

```bash
mv /var/lib/vz/dump/vzdump-lxc-100-2025_03_06-12_35_47.tar.zst /var/lib/vz/template/cache/ubuntu-24.04-base.tar.zst
```

**å‚è€ƒ**:

- [Ubuntu 22 ç¯å¢ƒåˆå§‹åŒ–](https://blog.hellowood.dev/posts/ubuntu-22-%E7%8E%AF%E5%A2%83%E5%88%9D%E5%A7%8B%E5%8C%96/)

- [Proxmox VE åˆ›å»ºè‡ªå®šä¹‰çš„ LXC å®¹å™¨ CT æ¨¡æ¿](https://blog.hellowood.dev/posts/proxmox-ve-%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84-lxc-%E5%AE%B9%E5%99%A8-ct-%E6%A8%A1%E6%9D%BF/)

---

## å¤‡ä»½

https://zhuanlan.zhihu.com/p/661921259

https://kb.synology.cn/zh-cn/DSM/tutorial/back_up_restore_proxmox_vm

- [Proxmox Backup Server](https://www.proxmox.com/en/products/proxmox-backup-server/overview)
- [ä½¿ç”¨ Proxmox Backup Server å¤‡ä»½ Proxmox VE çš„å®¢æˆ·æœºä¸å®¿ä¸»æœº](https://blog.men.ci/backup-pve-with-pbs/)

---

## é›†ç¾¤

### é€€å‡ºé›†ç¾¤

åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸Šæ‰§è¡Œä¸€é¢çš„å‘½ä»¤:

```bash
systemctl stop pve-cluster.service
systemctl stop corosync.service
pmxcfs -l
rm /etc/pve/corosync.conf
rm -rf /etc/corosync/*
killall pmxcfs
systemctl start pve-cluster.service
```

åœæ­¢ PVE å’Œé›†ç¾¤çš„æœåŠ¡ï¼Œå¹¶è®¾ç½®æœ¬æœºæ“ä½œçš„å®¿ä¸»ä¸ºã€Œæœ¬åœ°æ¨¡å¼ã€ï¼Œåˆ é™¤ä¹‹å‰çš„é›†ç¾¤é…ç½®æ–‡ä»¶å’Œè¿›ç¨‹ï¼Œå†æ¬¡å¯åŠ¨å•ç‹¬çš„ PVE æœåŠ¡ã€‚

è¿˜éœ€è¦åˆ é™¤æœ¬æœºä»¥å¤–çš„å…¶ä»–é›†ç¾¤èŠ‚ç‚¹ï¼ˆNodeï¼‰ï¼Œä»¥ä¾¿ä» Web UI ä¸­ç§»é™¤ï¼š

```
cd /etc/pve/nodes
rm -rf [æœ¬æœºä¹‹å¤–çš„å…¶ä»–èŠ‚ç‚¹]
```

---

## ä¼˜åŒ–

### åŠŸè€—èŠ‚èƒ½

**å‚è€ƒ**

- [**å›½å…‰çš„ PVE ç¯å¢ƒæ­å»ºæ•™ç¨‹**- CPU èŠ‚èƒ½æ¨¡å¼](https://pve.sqlsec.com/4/6/)

## é—®é¢˜æ±‡æ€»

### ERROR Verification failed: (0x1A) Security Violation

https://www.mculoop.com/thread-201-1-1.html

### daemons have recently crashed

**å‚è€ƒ**

https://blog.csdn.net/QTM_Gitee/article/details/106004435

---

## è¿ç»´è„šæœ¬

- [Proxmox_VE_Status](https://github.com/KoolCore/Proxmox_VE_Status)
- **[ProxmoxVE](https://github.com/community-scripts/ProxmoxVE)**
- [Make managing your Homelab a breeze](https://community-scripts.github.io/ProxmoxVE/)

## å‚è€ƒ

- [2024 å¹´ PVE8 æœ€æ–°å®‰è£…ä½¿ç”¨æŒ‡å—|æ–°æ‰‹å…¥é—¨|å®‰è£…|ä¼˜åŒ–|Proxmox VE 8.1](https://post.smzdm.com/p/akle62mk/)
- [NUC11 AIO æŠ˜è…¾å°è®°](https://taplus.me/nuc11-aio-tinkering/)

- [**å›½å…‰çš„ PVE ç¯å¢ƒæ­å»ºæ•™ç¨‹**](https://github.com/sqlsec/PVE)
- [PVE å­¦ä¹ ç¬”è®°](https://skyao.io/learning-pve/) https://github.com/skyao/learning-pve
- [PVE doc](https://pve.proxmox.com/pve-docs/)
- [é…ç½® & æ¢ç´¢ Proxmox VE WebGUI ç®¡ç†é¡µé¢](https://quentin-blog.vercel.app/post/2---proxmox-ve-webgui-)
- [PVE ç³»ç»Ÿæœ€ä½³å®è·µ](https://tendcode.com/subject/article/pve-used/)

---