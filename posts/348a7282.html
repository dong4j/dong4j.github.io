<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>Zookeeper Curator高级特性实战指南 | 司机带你开车</title><meta name="keywords" content="Curator,Zookeeper,分布式锁,领导选举,缓存"><meta name="author" content="dong4j"><meta name="copyright" content="dong4j"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="Zookeeper Curator高级特性实战指南"><meta name="application-name" content="Zookeeper Curator高级特性实战指南"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="Zookeeper Curator高级特性实战指南"><meta property="og:url" content="https://blog.dong4j.site/posts/348a7282.html"><meta property="og:site_name" content="司机带你开车"><meta property="og:description" content="Curator 是 Netflix 公司开源的 zookeeper 客户端框架，简化了 Zookeeper 客户端的开发工作。本文介绍了 Curator 的一些高级特性，包括缓存、领导选举、分布式锁和计数器等。此外，还简要介绍了 Curator 提供的不同类型的队列和屏障功能。"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://api.dong4j.ink:1024/cover?t8hupgsj"><meta property="article:author" content="dong4j"><meta property="article:tag" content="dong4j, Java, Python, Golang, HomeLab, SpringBoot, 架构"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://api.dong4j.ink:1024/cover?t8hupgsj"><meta name="description" content="Curator 是 Netflix 公司开源的 zookeeper 客户端框架，简化了 Zookeeper 客户端的开发工作。本文介绍了 Curator 的一些高级特性，包括缓存、领导选举、分布式锁和计数器等。此外，还简要介绍了 Curator 提供的不同类型的队列和屏障功能。"><link rel="shortcut icon" href="https://cdn.dong4j.site/source/image/favicon.ico"><link rel="canonical" href="https://blog.dong4j.site/posts/348a7282.html"><link rel="preconnect" href="//cdn.cbd.int"><link rel="preconnect" href="//hm.baidu.com"><meta name="google-site-verification" content="xxx"><meta name="baidu-site-verification" content="codeva-D4HsBP841S"><meta name="msvalidate.01" content="xxx"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@1.0.17/lib/assets/font-awesome-animation.min.css"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media=&quot;all&quot;"><script>var _hmt=_hmt||[];(()=>{var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?61a751ac36d18d3ba293fe8ef3ec53eb",document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)})()</script><script>let GLOBAL_CONFIG={linkPageTop:{enable:!0,title:"与数百名博主无限进步",addFriendPlaceholder:"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},peoplecanvas:void 0,postHeadAiDescription:{enable:!0,gptName:"Local",mode:"online",switchBtn:!0,btnLink:"https://github.com/dong4j/blog-summary-assistant-server",randomNum:3,basicWordCount:1999,key:"84yT3Gkl6fp",Referer:"https://blog.dong4j.site:1024",apiUrl:"https://oneapi.dong4j.ink:1024/api/summary",audioUrl:"https://api.dong4j.ink:1024/audio"},diytitle:{enable:!0,leaveTitle:"兄台留步 🙏",backTitle:"兄台,别来无恙 👋"},LA51:{enable:!0,ck:"3Ki5mmyy6E5xtXuf",LingQueMonitorID:"3Ki5mmyy6E5xtXuf"},greetingBox:{enable:!0,default:"晚上好👋",list:[{greeting:"晚安😴",startTime:0,endTime:5},{greeting:"早上好鸭👋, 祝你一天好心情！",startTime:6,endTime:9},{greeting:"上午好👋, 状态很好，鼓励一下～",startTime:10,endTime:10},{greeting:"11点多啦, 在坚持一下就吃饭啦～",startTime:11,endTime:11},{greeting:"午安👋, 宝贝",startTime:12,endTime:14},{greeting:"🌈充实的一天辛苦啦！",startTime:14,endTime:18},{greeting:"19点喽, 奖励一顿丰盛的大餐吧🍔。",startTime:19,endTime:19},{greeting:"晚上好👋, 在属于自己的时间好好放松😌~",startTime:20,endTime:24}]},twikooEnvId:"https://twikoo.dong4j.ink:1024",commentBarrageConfig:{enable:!0,maxBarrage:1,barrageTime:4e3,accessToken:"3a358103e6024cfb97546ec8f8408f5a",mailMd5:"3435c7a74ba1cad3f5d57b0b61b9b25cee221b97599c47b32edbdb36038c5411"},music_page_default:"nav_music",root:"/",preloader:{source:"car"},friends_vue_info:{apiurl:"https://friends.dong4j.ink:1024/"},navMusic:!0,mainTone:{mode:"both",api:"https://img2color.dong4j.ink:1024/api?img=",cover_change:!0},authorStatus:{skills:["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","😎 HomeLab 折腾专家","🏃 脚踏实地行动派","🧱 团队小组发动机","👶 尿不湿更换专家"]},algolia:{appId:"JFMEP32WXP",apiKey:"8e3acd038435dda872706ba6777a54b3",indexName:"blog-index",hits:{per_page:10},languages:{input_placeholder:"输入关键词后按下回车查找",hits_empty:"找不到您查询的内容：${query}",hits_stats:"找到 ${hits} 条结果，用时 ${time} 毫秒"}},localSearch:void 0,translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"简",rightMenuMsgToTraditionalChinese:"转为繁体",rightMenuMsgToSimplifiedChinese:"转为简体"},noticeOutdate:{limitDay:365,position:"top",messagePrev:"该内容距离上次更新已经过了",messageNext:"天，文章内容可能已经过时。"},highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:330},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,simplehomepage:!0,post:!0},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{copy:!0,copyrightEbable:!1,limitCount:50,languages:{author:"作者: dong4j",link:"链接: ",source:"来源: 司机带你开车",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。",copySuccess:"复制成功，复制和转载请标注本文地址"}},lightbox:"mediumZoom",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#425AEF",bgDark:"#1f1f1f",position:"top-center"},source:{justifiedGallery:{js:"https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js",css:"https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!0,shortcutKey:{enable:!0,delay:100,shiftDelay:200},autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={configTitle:"司机带你开车",title:"Zookeeper Curator高级特性实战指南",postAI:"Curator 是 Netflix 公司开源的 zookeeper 客户端框架，简化了 Zookeeper 客户端的开发工作。本文介绍了 Curator 的一些高级特性，包括缓存、领导选举、分布式锁和计数器等。此外，还简要介绍了 Curator 提供的不同类型的队列和屏障功能。",pageFillDescription:"Curator 的基本 Api, 创建会话, 1.使用静态工程方法创建客户端, 2.使用 Fluent 风格的 Api 创建会话, 3.创建包含隔离命名空间的会话, 启动客户端, 数据节点操作, 创建数据节点, 删除数据节点, 读取数据节点数据, 更新数据节点数据, 检查节点是否存在, 获取某个节点的所有子节点路径, 事务, 异步接口, Curator 食谱 (高级特性), 缓存, Path Cache, Node Cache, Tree Cache, Leader 选举, LeaderLatch, LeaderSelector, 分布式锁, 可重入共享锁—Shared Reentrant Lock, 不可重入共享锁—Shared Lock, 可重入读写锁—Shared Reentrant Read Write Lock, 信号量—Shared Semaphore, 多共享锁对象 —Multi Shared Lock, 分布式计数器, 分布式 int 计数器—SharedCount, 分布式 long 计数器—DistributedAtomicLong, 分布式队列, 分布式队列—DistributedQueue, 带 Id 的分布式队列—DistributedIdQueue, 优先级分布式队列—DistributedPriorityQueue, 分布式延迟队列—DistributedDelayQueue, SimpleDistributedQueue, 分布式屏障—Barrier, DistributedBarrier, 双栅栏—DistributedDoubleBarrier是公司开源的一套客户端框架解决了很多客户端非常底层的细节开发工作包括连接重连反复注册和异常等等以一句给予高度评价引子和趣闻名字的由来是比较有趣的下面的片段摘抄自从到分布式一致性原理与实践一书最早起源于雅虎的研究院的一个研究小组在当时研究人员发现在雅虎内部很多大型的系统需要依赖一个类似的系统进行分布式协调但是这些系统往往存在分布式单点问题所以雅虎的开发人员就试图开发一个通用的无单点问题的分布式协调框架在立项初期考虑到很多项目都是用动物的名字来命名的例如著名的项目雅虎的工程师希望给这个项目也取一个动物的名字时任研究院的首席科学家开玩笑说再这样下去我们这儿就变成动物园了此话一出大家纷纷表示就叫动物园管理员吧因为各个以动物命名的分布式组件放在一起雅虎的整个分布式系统看上去就像一个大型的动物园了而正好用来进行分布式环境的协调于是的名字由此诞生了无疑是客户端中的瑞士军刀它译作馆长或者管理者不知道是不是开发小组有意而为之笔者猜测有可能这样命名的原因是说明就是的馆长脑洞有点大就是动物园的园长包含了几个包对的底层的一些封装提供一些客户端的操作例如重试策略等封装了一些高级特性如事件监听选举分布式锁分布式计数器分布式等依赖使用的版本对应的版本为如果跨版本会有兼容性问题很有可能导致节点操作失败的基本创建会话使用静态工程方法创建客户端一个例子如下静态工厂方法包含四个主要参数参数名说明服务器列表格式重试策略内建有四种重试策略也可以自行实现接口会话超时时间单位毫秒默认连接创建超时时间单位毫秒默认使用风格的创建会话核心参数变为流式设置一个列子如下创建包含隔离命名空间的会话为了实现不同的业务之间的隔离需要为每个业务分配一个独立的命名空间即指定一个的根路径官方术语为添加特性例如下面的例子当客户端指定了独立命名空间为那么该客户端对上的数据节点的操作都是基于该目录进行的通过设置可以将客户端应用与服务端的一课子树相对应在多个应用共用一个集群的场景下这对于实现不同应用之间的相互隔离十分有意义启动客户端当创建会话成功得到的实例然后可以直接调用其方法数据节点操作创建数据节点的节点创建模式持久化持久化并且带序列号临时临时并且带序列号创建一个节点初始内容为空注意如果没有设置节点属性节点创建模式默认为持久化节点内容默认为空创建一个节点附带初始化内容创建一个节点指定创建模式临时节点内容为空创建一个节点指定创建模式临时节点附带初始化内容创建一个节点指定创建模式临时节点附带初始化内容并且自动递归创建父节点这个接口非常有用因为一般情况开发人员在创建一个子节点必须判断它的父节点是否存在如果不存在直接创建会抛出使用之后能够自动递归创建所有所需的父节点删除数据节点删除一个节点注意此方法只能删除叶子节点否则会抛出异常删除一个节点并且递归删除其所有的子节点删除一个节点强制指定版本进行删除删除一个节点强制保证删除接口是一个保障措施只要客户端会话有效那么会在后台持续进行删除操作直到删除节点成功注意上面的多个流式接口是可以自由组合的例如读取数据节点数据读取一个节点的数据内容注意此方法返的返回值是读取一个节点的数据内容同时获取到该节点的更新数据节点数据更新一个节点的数据内容注意该接口会返回一个实例更新一个节点的数据内容强制指定版本进行更新检查节点是否存在注意该方法返回一个实例用于检查是否存在的操作可以调用额外的方法监控或者后台处理并在最后调用指定要操作的获取某个节点的所有子节点路径注意该方法的返回值为获得的子节点列表可以调用额外的方法监控后台处理或者获取状态并在最后调用指定要操作的父事务的实例包含接口方法调用此方法开启一个事务可以复合等操作然后调用作为一个原子操作提交一个例子如下异步接口上面提到的创建删除更新读取等方法都是同步的提供异步接口引入了接口用于处理异步接口调用之后服务端返回的结果信息接口中一个重要的回调值为里面包含事件类型响应吗和节点的详细信息事件类型对应实例的方法响应码响应码意义即调用成功即客户端与服务端断开连接即节点已经存在即会话过期一个异步创建节点的例子如下注意如果方法不指定那么会默认使用的去进行异步处理食谱高级特性提醒首先你必须添加依赖下文仅仅对一些特性的使用进行解释和举例不打算进行源码级别的探讨重要提醒强烈推荐使用监控连接的状态当连接状态为下的所有将会失效或者过期尽管后面所有的例子都没有使用到缓存原生支持通过注册来进行事件监听但是开发者需要反复注册只能单次注册单次使用是中对事件监听的包装可以看作是对事件监听的本地缓存视图能够自动为开发者处理反复注册监听提供了三种来监听结点的变化用来监控一个的子节点当一个子节点增加更新删除时会改变它的状态会包含最新的子节点子节点的数据和状态而状态的更变将通过通知实际使用时会涉及到四个类通过下面的构造函数创建想使用必须调用它的方法使用完后调用方法可以设置来实现启动的模式有下面几种正常初始化在调用之前会调用当初始化数据后发送一个事件可以增加监听缓存的变化方法返回一个对象可以遍历所有的子节点设置更新移除其实是使用来操作不通过操作事件类型节点数据注意如果中的参数值设置为则示例中的将返回将不会缓存节点数据注意示例中的可以注释掉但是注释后事件监听的触发次数会不全这可能与的实现原理有关不能太过频繁的触发事件与类似只是监听某一个特定的节点它涉及到下面的三个类实现类节点监听器节点数据注意使用依然要调用它的方法使用完后调用方法将得到节点当前的状态通过它的状态可以得到当前的值节点数据节点被删除注意示例中的可以注释但是注释后事件监听的触发次数会不全这可能与的实现原理有关不能太过频繁的触发事件注意只能监听一个节点的状态变化可以监控整个树上的所有节点类似于和的组合主要涉及到下面四个类实现类监听器类触发的事件类节点数据事件类型路径注意在此示例中没有使用但是事件触发次数也是正常的注意在初始化调用方法的时候会回调实例一个事而回调的对象的为为此时很有可能导致空指针异常这里应该主动处理并避免这种情况选举在分布式计算中是很重要的一个功能这个选举过程是这样子的指派一个进程作为组织者将任务分发给各节点在任务开始前哪个节点都不知道谁是领导者或者协调者当选举算法开始执行后每个节点最终会得到一个唯一的节点作为任务除此之外选举还经常会发生在意外宕机的情况下新的要被选举出来在集群中负责写操作然后通过协议实现的同步或者都可以处理读操作有两种选举的分别是和前者是所有存活的客户端不间断的轮流做大同社会后者是一旦选举出除非有客户端挂掉重新触发选举否则不会交出领导权某党有两个构造函数的启动一旦启动会和其它使用相同的其它交涉然后其中一个最终会被选举为可以通过方法查看实例是否返回说明当前实例是类似的在请求成为会阻塞一旦不使用了必须调用方法如果它是会释放其它的参与者将会选举一个异常处理实例可以增加来监听网络连接问题当或时不再认为自己还是当后连接重连后会删除先前的然后重新创建一个用户必须考虑导致丢失的连接问题强烈推荐你使用一个的使用例子可以添加的依赖方便进行测试不需要启动真实的服务端首先我们创建了个启动后它们中的一个会被选举为因为选举会花费一些时间后并不能马上就得到通过查看自己是否是如果是的话返回可以通过可以得到当前的的只能通过释放当前的领导权是一个阻塞方法尝试获取地位但是未必能上位使用的时候主要涉及下面几个类核心类是它的构造函数如下类似必须一旦启动当实例取得领导权时你的的方法被调用而方法只有领导权被释放时才返回当你不再使用实例时应该调用它的方法异常处理类继承必须小心连接状态的改变如果实例成为它应该响应或当状态出现时实例必须假定在重新连接成功之前它可能不再是了如果状态出现实例不再是方法返回重要推荐处理方式是当收到或时抛出异常这会导致实例中断并取消执行方法的异常这非常重要你必须考虑扩展提供了推荐的处理逻辑下面的一个例子摘抄自官方你可以在进行任务的分配等等并且不要返回如果你想要要此实例一直是的话可以加一个死循环调用保证在此实例释放领导权之后还可能获得领导权在这里我们使用来记录此获得领导权的次数它是每个有平等的机会获得领导权对比可知必须调用方法才会释放领导权而对于通过可以对领导权进行控制在适当的时候释放领导权这样每个节点都有可能获得领导权从而具有更好的灵活性和可控性建议有应用场景下优先使用分布式锁提醒推荐使用监控连接的状态因为当连接时你不再拥有锁分布式的锁全局同步这意味着任何一个时间点不会有两个客户端都拥有相同的锁可重入共享锁意味着锁是全局可见的客户端都可以请求锁和的类似即可重入意味着同一个客户端在拥有锁的同时可以多次获取不会被阻塞它是由类来实现它的构造函数为通过获得锁并提供超时机制通过方法释放锁实例可以重用定义了可协商的撤销机制为了撤销调用下面的方法将锁设为可撤销的当别的进程或线程想让你释放锁时会被调用如果你请求撤销当前的锁调用方法注意锁释放时将会回调二次提醒错误处理还是强烈推荐你使用处理连接状态的改变当连接时你不再拥有锁首先让我们创建一个模拟的共享资源这个资源期望只能单线程的访问否则会有并发问题真实环境中我们会在这里访问维护一个共享的资源这个例子在使用锁的情况下不会非法并发异常但是在无锁的情况由于了一段时间很容易抛出异常然后创建一个类它负责请求锁使用资源释放锁这样一个完整的访问过程代码也很简单生成个每个重复执行次请求锁访问资源释放锁的过程每个都在独立的线程中结果可以看到锁是随机的被每个实例排他性的使用既然是可重用的你可以在一个线程中多次调用在线程拥有锁时它总是返回你不应该在多个线程中用同一个你可以在每个线程中都生成一个新的实例它们的都一样这样它们可以共享同一个锁不可重入共享锁这个锁和上面的相比就是少了的功能也就意味着它不能在同一个线程中重入这个类是使用方法和类似不能得到互斥锁已获取到互斥锁不能得到互斥锁再次获取到互斥锁获取锁几次释放锁也要几次运行后发现有且只有一个成功获取第一个锁第一个方法返回然后它自己阻塞在第二个方法获取第二个锁超时其他所有的客户端都阻塞在第一个方法超时并且抛出异常这样也就验证了实现的锁是不可重入的可重入读写锁类似的一个读写锁管理一对相关的锁一个负责读操作另外一个负责写操作读操作在写锁没被使用时可同时由多个进程使用而写锁在使用时不允许读阻塞此锁是可重入的一个拥有写锁的线程可重入读锁但是读锁却不能进入写锁这也意味着写锁可以降级成读锁比如请求写锁请求读锁释放读锁释放写锁从读锁升级成写锁是不行的可重入读写锁主要由两个类实现使用时首先创建一个实例然后再根据你的需求得到读锁或者写锁读写锁的类型是注意只能先得到写锁再得到读锁不能反过来不能得到写锁已得到写锁不能得到读锁已得到读锁使用资源释放读写锁信号量一个计数的信号量类似的中维护的一组许可而中称之为租约有两种方式可以决定的最大租约数第一种方式是用户给定并且指定最大第二种方式用户给定并且使用类如果不使用必须保证所有实例在多进程中使用相同的最大租约数量否则有可能出现进程中的实例持有最大租约数量为但是在进程中持有的最大租约数量为此时租约的意义就失效了这次调用会返回一个租约对象客户端必须在中这些租约对象否则这些租约会丢失掉但是但是如果客户端由于某种原因比如丢掉那么这些客户端持有的租约会自动这样其它客户端可以继续使用这些租约租约还可以通过下面的方式返还注意你可以一次性请求多个租约如果当前的租约不够则请求线程会被阻塞同时还提供了超时的重载方法使用的主要类包括下面几个首先我们先获得了个租约最后我们把它还给了接着请求了一个租约因为还有个租约所以请求可以满足返回一个租约还剩个租约然后再请求一个租约因为租约不够阻塞到超时还是没能满足返回结果为租约不足会阻塞到超时然后返回不会主动抛出异常如果不设置超时时间会一致阻塞上面说讲的锁都是公平锁总的角度看每个客户端都按照请求的顺序获得锁不存在非公平的抢占的情况多共享锁对象是一个锁的容器当调用所有的锁都会被如果请求失败所有的锁都会被同样调用时所有的锁都被失败被忽略基本上它就是组锁的代表在它上面的请求释放操作都会传递给它包含的所有的锁主要涉及两个类它的构造函数需要包含的锁的集合或者一组的用法和相同新建一个包含一个重入锁和一个非重入锁调用后可以看到线程同时拥有了这两个锁调用看到这两个锁都被释放了最后再重申一次强烈推荐使用监控连接的状态当连接状态为锁将会丢失分布式计数器顾名思义计数器是用来计数的利用可以实现一个集群共享的计数器只要使用相同的就可以得到最新的计数器值这是由的一致性保证的有两个计数器一个是用来计数一个用来计数分布式计数器这个类使用类型来计数主要涉及三个类代表计数器可以为它增加一个当计数器改变时此可以监听到改变的事件而可以读取到最新的值包括字面值和带版本信息的值在这个例子中我们使用来监听计数值方法来添加任意的只要使用相同的都可以得到这个计数值然后我们使用个线程为计数值增加一个以内的随机数相同的的对计数值进行更改将会回调给的这里我们使用去设置计数器第一个参数提供当前的如果期间其它更新了此计数值你的更新可能不成功但是这时你的更新了最新的值所以失败了你可以尝试再更新一次而是强制更新计数器的值注意计数器必须使用完之后必须调用关闭它强烈推荐使用在本例中扩展分布式计数器再看一个类型的计数器除了计数的范围比大了之外它首先尝试使用乐观锁的方式设置计数器如果不成功比如期间计数器已经被其它更新了它使用方式来更新计数值可以从它的内部实现中看出此计数器有一系列的操作获取当前值加一减一增加特定的值减去特定的值尝试设置计数值强制设置计数值你必须检查返回结果的它代表此操作是否成功如果操作成功代表操作前的值代表操作后的值分布式队列使用也可以简化临时节点的操作也提供的分布式队列实现利用的节点可以保证放入到队列中的项目是按照顺序排队的如果单一的消费者从队列中取数据那么它是先入先出的这也是队列的特点如果你严格要求顺序你就的使用单一的消费者可以使用选举只让作为唯一的消费者但是根据的作者所说真心不适合做或者说没有实现一个好的详细内容可以看原因有五有的传输限制实践中必须相对较小而队列包含成千上万的消息非常的大如果有很多节点启动时相当的慢而使用会导致好多你需要显著增大和很大的时候很难清理不得不创建了一个专门的程序做这事当很大量的包含成千上万的子节点的时的性能变得不好的数据库完全放在内存中大量的意味着会占用很多的内存空间尽管如此还是创建了各种的实现如果的数据量不太多数据量不太大的情况下酌情考虑还是可以使用的分布式队列是最普通的一种队列它设计以下四个类创建队列使用它也是其它队列的创建类队列中的消息消费者接口队列消息序列化和反序列化接口提供了对队列中的对象的序列化和反序列化队列实现类是消费者它可以接收队列的数据处理队列中的数据的代码逻辑可以放在中正常情况下先将消息从队列中移除再交给消费者消费但这是两个步骤不是原子的可以调用的消费者加锁当消费者消费数据时持有锁这样其它消费者不能消费此消息如果消费失败或者进程死掉消息可以交给其它进程这会带来一点性能的损失最好还是单消费者模式使用队列等待消息消费完成队列消息序列化实现类定义队列消费者连接状态改变消费消息例子中定义了两个分布式队列和两个消费者因为是相同的会存在消费者抢占消费消息的情况带的分布式队列和上面的队列类似但是可以为队列中的每一个元素设置一个可以通过把队列中任意的元素移除它涉及几个类通过下面方法创建放入元素时移除元素时在这个例子中有些元素还没有被消费者消费前就移除了这样消费者不会收到删除的消息优先级分布式队列优先级队列对队列中的元素按照优先级进行排序越小元素越靠前越先被消费掉它涉及下面几个类通过方法创建当优先级队列得到元素增删消息时它会暂停处理当前的元素队列然后刷新队列指定刷新前当前活动的队列的最小数量主要设置你的程序可以容忍的不排序的最小值放入队列时需要指定优先级例子有时候你可能会有错觉优先级设置并没有起效那是因为优先级是对于队列积压的元素而言如果消费速度过快有可能出现在后一个元素入队操作之前前一个元素已经被消费这种情况下会退化为分布式延迟队列中也有不知道你是否熟悉也提供了类似的功能元素有个值消费者隔一段时间才能收到元素涉及到下面四个类通过下面的语句创建放入元素时可以指定注意不是离现在的一个时间间隔比如毫秒而是未来的一个时间戳如秒如果的时间已经过去消息会立刻被消费者接收前面虽然实现了各种队列但是你注意到没有这些队列并没有实现类似一样的接口提供了和基本一致的接口但是没有实现接口创建很简单增加元素删除元素另外还提供了其它方法没有方法多了方法方法在成功返回之前会被阻塞而方法在队列为空时直接返回发送一条消息成功发送一条消息失败消费一条消息成功但是实际上发送了条消息消费完第一条之后后面的消息无法消费目前没找到原因查看一下官方文档推荐的使用下面几个但是实际使用发现还是存在消费阻塞问题分布式屏障分布式是这样一个类它会阻塞所有节点上的等待进程直到某一个被满足然后所有的节点继续进行比如赛马比赛中等赛马陆续来到起跑线前一声令下所有的赛马都飞奔而出类实现了栅栏的功能它的构造函数如下首先你需要设置栅栏它将阻塞在它上面等待的线程然后需要阻塞的线程调用方法等待放行条件当条件满足时移除栅栏所有等待的线程将继续执行异常处理会监控连接状态当连接断掉时方法会抛出异常这个例子创建了来设置栅栏和移除栅栏我们创建了个线程在此上等待最后移除栅栏后所有的线程才继续执行如果你开始不设置栅栏所有的线程就不会阻塞住双栅栏双栅栏允许客户端在计算的开始和结束时同步当足够的进程加入到双栅栏时进程开始计算当计算完成时离开栅栏双栅栏类是构造函数为是成员数量当方法被调用时成员被阻塞直到所有的成员都调用了当方法被调用时它也阻塞调用线程直到所有的成员都调用了就像百米赛跑比赛发令枪响所有的运动员开始跑等所有的运动员跑过终点线比赛才结束会监控连接状态当连接断掉时和方法会抛出异常参考资料从到分布式一致性原理与实践跟着实例学习的用法博客系列",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2025-02-07 21:48:04",postMainColor:""}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:(e,t,a)=>{var o;0!==a&&(o=Date.now(),localStorage.setItem(e,JSON.stringify({value:t,expiry:o+864e5*a})))},get:e=>{var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!(Date.now()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=(o,c={})=>new Promise((t,e)=>{let a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},Object.keys(c).forEach(e=>{a.setAttribute(e,c[e])}),document.head.appendChild(a)}),e.getCSS=(o,c=!1)=>new Promise((t,e)=>{let a=document.createElement("link");a.rel="stylesheet",a.href=o,c&&(a.id=c),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#18171d")},e.activateLightMode=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#f7f9fe")};var e=saveToLocal.get("theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches,a=window.matchMedia("(prefers-color-scheme: light)").matches,o=window.matchMedia("(prefers-color-scheme: no-preference)").matches,c=!t&&!a&&!o,t=(void 0===e?(a?activateLightMode():t?activateDarkMode():(o||c)&&((a=(new Date).getHours())<=8||22<=a?activateDarkMode:activateLightMode)(),window.matchMedia("(prefers-color-scheme: dark)").addListener(e=>{void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode:activateLightMode)()})):("light"===e?activateLightMode:activateDarkMode)(),saveToLocal.get("aside-status"));void 0!==t&&("hide"===t?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="https://s1.hdslb.com/bfs/static/jinkela/long/font/medium.css"><script src="https://cdn.dong4j.site/source/static/echarts.min.js"></script><link rel="stylesheet" href="https://cdn.dong4j.site/source/static/core.css"><link rel="stylesheet" href="https://cdn.dong4j.site/source/static/footer.css"><link rel="stylesheet" href="https://cdn.dong4j.site/source/static/index-imgloaded.css"><script src="https://cdn.dong4j.site/source/static/index-imgloaded.js"></script><script src="https://cdn.dong4j.site/source/static/detect-devtools.js"></script><script defer="" src="https://cdn.dong4j.site/source/static/umami.self.js" data-host-url="https://umami.dong4j.ink:1024" data-website-id="bd4721b7-a43f-4161-83ed-51c148a7ca9d"></script><script defer="" src="https://cdn.dong4j.site/source/static/counter.js" async="" id="online-counter" interval="60000" api="https://umami.dong4j.ink:1024/counter" room="000000001"></script><script src="https://cdn.dong4j.site/source/static/confetti.browser.min.js"></script><script src="https://cdn.dong4j.site/source/static/confetti.js"></script><meta name="generator" content="Hexo 7.2.0"><link rel="alternate" href="/atom.xml" title="司机带你开车" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="司机带你开车" type="application/rss+xml"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box"><div class="carplay"></div></div><script>let preloader={endLoading:()=>{document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",()=>{preloader.endLoading()}),setTimeout(function(){preloader.endLoading()},2e3),document.getElementById("loading-box").addEventListener("click",()=>{preloader.endLoading()}),document.addEventListener("pjax:send",()=>{preloader.initLoading()}),document.addEventListener("pjax:complete",()=>{preloader.endLoading()})</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"><script async="" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://home.dong4j.site" title="个人主页"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/homepage.webp" alt="个人主页"><span class="back-menu-item-text">个人主页</span></a><a class="back-menu-item" href="https://blog.dong4j.site" title="博客"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/blog.webp" alt="博客"><span class="back-menu-item-text">博客</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://resume.dong4j.site" title="简历"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/resume.webp" alt="简历"><span class="back-menu-item-text">简历</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://npx-card.dong4j.site" title="npx-card"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/npx-card.webp" alt="npx-card"><span class="back-menu-item-text">npx-card</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/watt-stack" title="Watt.Stack"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/watt.webp" alt="Watt.Stack"><span class="back-menu-item-text">Watt.Stack</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dong4j/markdown-image-kit" title="MIK"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/mik.webp" alt="MIK"><span class="back-menu-item-text">MIK</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dong4j/macOS-dev" title="macOS.dev"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/mac.webp" alt="macOS.dev"><span class="back-menu-item-text">macOS.dev</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://project.dong4j.site/" title="更多"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/project.webp" alt="更多"><span class="back-menu-item-text">更多</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">服务</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://uptime.dong4j.ink:1024/status/services" title="服务状态"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/uptime-kuma.svg" alt="服务状态"><span class="back-menu-item-text">服务状态</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://nezha.dong4j.ink:1024?f=blog" title="服务面板"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/nezha.webp" alt="服务面板"><span class="back-menu-item-text">服务面板</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://nav.dong4j.ink:1024/" title="导航页"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/nav.webp" alt="导航页"><span class="back-menu-item-text">导航页</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://umami.dong4j.ink:1024/share/V7Rat8DdVw4npjl2/blog.dong4j.site" title="Umami"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/umami.webp" alt="Umami"><span class="back-menu-item-text">Umami</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://muselink.cc/dong4j 👈这是我的MuseLink数字名片！" title="数字名片"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/muse.lin.webp" alt="数字名片"><span class="back-menu-item-text">数字名片</span></a><a class="back-menu-item" href="/ai/deepseek-r1-webgpu/" title="DeepSeek"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/deepseek.webp" alt="DeepSeek"><span class="back-menu-item-text">DeepSeek</span></a><a class="back-menu-item" href="/ai/rmbg/playground/" title="RMBG"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/rmbg.webp" alt="RMBG"><span class="back-menu-item-text">RMBG</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="http://chat.dong4j.ink:1024/chat" title="Mini-Chat"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/emoji1.webp" alt="Mini-Chat"><span class="back-menu-item-text">Mini-Chat</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">司机带你开车</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)" rel="external nofollow noreferrer">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size:.9em"></i><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size:.9em"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/messages/"><i class="fa fa-comments faa-tada"></i><span> 最新评论</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="fa fa-line-chart faa-tada"></i><span> 统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size:.9em"></i><span> 我的装备</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size:.9em"></i><span> 小空调</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/memos/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size:.9em"></i><span> 备忘录</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/todolist/"><i class="fa-solid fa-map faa-tada"></i><span> 折腾清单</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/stars/"><i class="fa-brands fa-github faa-tada"></i><span> Star 清单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole()"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://cdn.dong4j.site/source/image/wechat-pay.webp" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://cdn.dong4j.site/source/image/wechat-pay.webp"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.dong4j.site/source/image/alipay.webp" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://cdn.dong4j.site/source/image/alipay.webp"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title">最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/%E8%BF%90%E7%AE%97%E7%AC%A6/" style="font-size:1.05rem;color:#0b673b">+运算符<sup>1</sup></a><a href="/tags/checkedexception/" style="font-size:1.05rem;color:#3e9b0a">CheckedException<sup>1</sup></a><a href="/tags/error/" style="font-size:1.05rem;color:#33b1bf">Error<sup>1</sup></a><a href="/tags/exception/" style="font-size:1.05rem;color:#b83165">Exception<sup>1</sup></a><a href="/tags/java/" style="font-size:1.05rem;color:#336726">Java<sup>48</sup></a><a href="/tags/javabean/" style="font-size:1.05rem;color:#081d9f">JavaBean<sup>1</sup></a><a href="/tags/oop/" style="font-size:1.05rem;color:#aca690">OOP<sup>1</sup></a><a href="/tags/runtimeexception/" style="font-size:1.05rem;color:#b44b76">RuntimeException<sup>1</sup></a><a href="/tags/throwable/" style="font-size:1.05rem;color:#0821a4">Throwable<sup>1</sup></a><a href="/tags/final/" style="font-size:1.05rem;color:#2fc1b6">final<sup>2</sup></a><a href="/tags/finalize/" style="font-size:1.05rem;color:#28b07b">finalize<sup>1</sup></a><a href="/tags/finally/" style="font-size:1.05rem;color:#ae771e">finally<sup>2</sup></a><a href="/tags/getter/" style="font-size:1.05rem;color:#3d7b5d">getter<sup>1</sup></a><a href="/tags/new%E5%85%B3%E9%94%AE%E5%AD%97/" style="font-size:1.05rem;color:#535353">new关键字<sup>1</sup></a><a href="/tags/setter/" style="font-size:1.05rem;color:#746b4e">setter<sup>1</sup></a><a href="/tags/static/" style="font-size:1.05rem;color:#541232">static<sup>1</sup></a><a href="/tags/super/" style="font-size:1.05rem;color:#88861e">super<sup>2</sup></a><a href="/tags/this/" style="font-size:1.05rem;color:#9339c2">this<sup>1</sup></a><a href="/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/" style="font-size:1.05rem;color:#9483b3">二进制<sup>1</sup></a><a href="/tags/%E5%B0%81%E8%A3%85/" style="font-size:1.05rem;color:#1b420f">封装<sup>3</sup></a><a href="/tags/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" style="font-size:1.05rem;color:#45c53b">异常处理<sup>3</sup></a><a href="/tags/%E6%8A%BD%E8%B1%A1%E7%B1%BB/" style="font-size:1.05rem;color:#1d04c3">抽象类<sup>1</sup></a><a href="/tags/%E6%8E%A5%E5%8F%A3/" style="font-size:1.05rem;color:#041328">接口<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" style="font-size:1.05rem;color:#4096a9">数据类型<sup>4</sup></a><a href="/tags/%E6%96%B9%E6%B3%95%E9%87%8D%E8%BD%BD/" style="font-size:1.05rem;color:#45905a">方法重载<sup>1</sup></a><a href="/tags/%E6%9D%A1%E4%BB%B6%E8%BF%90%E7%AE%97%E7%AC%A6/" style="font-size:1.05rem;color:#15bea8">条件运算符<sup>1</sup></a><a href="/tags/%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95/" style="font-size:1.05rem;color:#459d99">构造方法<sup>1</sup></a><a href="/tags/%E6%BA%A2%E5%87%BA/" style="font-size:1.05rem;color:#410bba">溢出<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size:1.05rem;color:#9c121a">算法<sup>1</sup></a><a href="/tags/%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/" style="font-size:1.05rem;color:#777091">类型转换<sup>3</sup></a><a href="/tags/%E7%BB%A7%E6%89%BF/" style="font-size:1.05rem;color:#6a5bba">继承<sup>2</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E5%AE%9E%E8%B7%B5/" style="font-size:1.05rem;color:#116aa7">编程实践<sup>2</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A8%8B%E5%BA%8F/" style="font-size:1.05rem;color:#ba377b">计算机程序<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%AF%AD%E8%A8%80/" style="font-size:1.05rem;color:#8821c4">计算机语言<sup>1</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size:1.05rem;color:#b90a07">设计模式<sup>3</sup></a><a href="/tags/%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6/" style="font-size:1.05rem;color:#380340">访问控制<sup>1</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6/" style="font-size:1.05rem;color:#39ab64">软件<sup>1</sup></a><a href="/tags/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/" style="font-size:1.05rem;color:#62a971">错误处理<sup>2</sup></a><a href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" style="font-size:1.05rem;color:#9945bc">面向对象<sup>6</sup></a><a href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B/" style="font-size:1.05rem;color:#3051ad">面向对象编程<sup>4</sup></a></div></div><hr></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多"> <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/01/"><span class="card-archive-list-date">一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/12/"><span class="card-archive-list-date">十二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">十一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/11/"><span class="card-archive-list-date">十一月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/10/"><span class="card-archive-list-date">十月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/06/"><span class="card-archive-list-date">六月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2022/11/"><span class="card-archive-list-date">十一月 2022</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/07/"><span class="card-archive-list-date">七月 2021</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div><div class="console-btn-item" id="consoleKeyboard" onclick="anzhiyu.keyboardToggle()" title="快捷键开关"><a class="keyboard-switch"><i class="anzhiyufont anzhiyu-icon-keyboard"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);" rel="external nofollow noreferrer"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/ai-%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" itemprop="url">AI:人工智能</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/zookeeper/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>Zookeeper</span></a><a class="article-meta__tags" href="/tags/curator/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>Curator</span></a><a class="article-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>分布式锁</span></a><a class="article-meta__tags" href="/tags/%E9%A2%86%E5%AF%BC%E9%80%89%E4%B8%BE/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>领导选举</span></a><a class="article-meta__tags" href="/tags/%E7%BC%93%E5%AD%98/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>缓存</span></a></span></div></div><h1 class="post-title" itemprop="name headline">Zookeeper Curator高级特性实战指南</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2013-02-21T16:00:00.000Z" title="发表于 2013-02-22 00:00:00">2013-02-22</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-02-07T13:48:04.513Z" title="更新于 2025-02-07 21:48:04">2025-02-07</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">13.1k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>56分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" data-flag-title="Zookeeper Curator高级特性实战指南"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator"> </span><span class="post-meta-position" title="作者IP属地为成都"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>成都</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/348a7282.html#post-comment" tabindex="-1"><span id="twikoo-count"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://api.dong4j.ink:1024/cover?t8hupgsj"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div class="post-ai-description"><div class="ai-title"><i class="fa-regular fa-robot fa-fade"></i><div class="ai-title-text">摘要助手</div><div id="ai-Toggle">切换</div><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i><i class="anzhiyufont anzhiyu-icon-circle-dot" title="朗读摘要"></i><div id="ai-tag">SummaryGPT</div></div><div class="ai-explanation">AI初始化中...</div><div class="ai-btn-box"><div class="ai-btn-item">介绍自己 🙈</div><div class="ai-btn-item">生成本文简介 👋</div><div class="ai-btn-item">推荐相关文章 📖</div><div class="ai-btn-item">前往主页 🏠</div><div class="ai-btn-item">前往订阅 💥</div><div class="ai-btn-item" id="go-comment">前往评论 💬</div><div class="ai-btn-item" id="go-tianli-blog">👀 部署教程</div></div><script data-pjax="" src="https://cdn.dong4j.site/source/static/ai_abstract.js"></script></div><article class="post-content" id="article-container" itemscope="" itemtype="https://blog.dong4j.site/posts/348a7282.html"><header><a class="post-meta-categories" href="/categories/ai-%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" itemprop="url">AI:人工智能</a><a href="/tags/zookeeper/" tabindex="-1" itemprop="url">Zookeeper</a><a href="/tags/curator/" tabindex="-1" itemprop="url">Curator</a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" tabindex="-1" itemprop="url">分布式锁</a><a href="/tags/%E9%A2%86%E5%AF%BC%E9%80%89%E4%B8%BE/" tabindex="-1" itemprop="url">领导选举</a><a href="/tags/%E7%BC%93%E5%AD%98/" tabindex="-1" itemprop="url">缓存</a><h1 id="CrawlerTitle" itemprop="name headline">Zookeeper Curator高级特性实战指南</h1><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">dong4j</span><time itemprop="dateCreated datePublished" datetime="2013-02-21T16:00:00.000Z" title="发表于 2013-02-22 00:00:00">2013-02-22</time><time itemprop="dateCreated datePublished" datetime="2025-02-07T13:48:04.513Z" title="更新于 2025-02-07 21:48:04">2025-02-07</time></header><meta name="referrer" content="no-referrer"><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?spm=ct2dqy7h" alt="random-pic-api"></p><p>Curator 是 Netflix 公司开源的一套 zookeeper 客户端框架，解决了很多 Zookeeper 客户端非常底层的细节开发工作，包括连接重连、反复注册 Watcher 和 NodeExistsException 异常等等。Patrixck Hunt（Zookeeper）以一句“Guava is to Java that Curator to Zookeeper”给 Curator 予高度评价。<br><strong>引子和趣闻：</strong><br>Zookeeper 名字的由来是比较有趣的，下面的片段摘抄自《从 PAXOS 到 ZOOKEEPER 分布式一致性原理与实践》一书：<br>Zookeeper 最早起源于雅虎的研究院的一个研究小组。在当时，研究人员发现，在雅虎内部很多大型的系统需要依赖一个类似的系统进行分布式协调，但是这些系统往往存在分布式单点问题。所以雅虎的开发人员就试图开发一个通用的无单点问题的分布式协调框架。在立项初期，考虑到很多项目都是用动物的名字来命名的 (例如著名的 Pig 项目)，雅虎的工程师希望给这个项目也取一个动物的名字。时任研究院的首席科学家 Raghu Ramakrishnan 开玩笑说：再这样下去，我们这儿就变成动物园了。此话一出，大家纷纷表示就叫动物园管理员吧——因为各个以动物命名的分布式组件放在一起，雅虎的整个分布式系统看上去就像一个大型的动物园了，而 Zookeeper 正好用来进行分布式环境的协调——于是，Zookeeper 的名字由此诞生了。</p><p>Curator 无疑是 Zookeeper 客户端中的瑞士军刀，它译作 “ 馆长 “ 或者 ‘’ 管理者 ‘’，不知道是不是开发小组有意而为之，笔者猜测有可能这样命名的原因是说明 Curator 就是 Zookeeper 的馆长 (脑洞有点大：Curator 就是动物园的园长)。<br>Curator 包含了几个包：<br><strong>curator-framework：</strong>对 zookeeper 的底层 api 的一些封装<br><strong>curator-client：</strong>提供一些客户端的操作，例如重试策略等<br><strong>curator-recipes：</strong>封装了一些高级特性，如：Cache 事件监听、选举、分布式锁、分布式计数器、分布式 Barrier 等<br>Maven 依赖 (使用 curator 的版本：2.12.0，对应 Zookeeper 的版本为：3.4.x，<strong>如果跨版本会有兼容性问题，很有可能导致节点操作失败</strong>)：</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h1 id="Curator-的基本-Api"><a href="#Curator-的基本-Api" class="headerlink" title="Curator 的基本 Api"></a>Curator 的基本 Api</h1><h2 id="创建会话"><a href="#创建会话" class="headerlink" title="创建会话"></a>创建会话</h2><h3 id="1-使用静态工程方法创建客户端"><a href="#1-使用静态工程方法创建客户端" class="headerlink" title="1.使用静态工程方法创建客户端"></a>1.使用静态工程方法创建客户端</h3><p>一个例子如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RetryPolicy</span> <span class="variable">retryPolicy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>);</span><br><span class="line"><span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span></span><br><span class="line">CuratorFrameworkFactory.newClient(</span><br><span class="line">                        connectionInfo,</span><br><span class="line">                        <span class="number">5000</span>,</span><br><span class="line">                        <span class="number">3000</span>,</span><br><span class="line">                        retryPolicy);</span><br></pre></td></tr></tbody></table></figure><p>newClient 静态工厂方法包含四个主要参数：</p><table><thead><tr><th align="left">参数名</th><th align="center">说明</th></tr></thead><tbody><tr><td align="left">connectionString</td><td align="center">服务器列表，格式 host1:port1,host2:port2,…</td></tr><tr><td align="left">retryPolicy</td><td align="center">重试策略,内建有四种重试策略,也可以自行实现 RetryPolicy 接口</td></tr><tr><td align="left">sessionTimeoutMs</td><td align="center">会话超时时间，单位毫秒，默认 60000ms</td></tr><tr><td align="left">connectionTimeoutMs</td><td align="center">连接创建超时时间，单位毫秒，默认 60000ms</td></tr></tbody></table><h3 id="2-使用-Fluent-风格的-Api-创建会话"><a href="#2-使用-Fluent-风格的-Api-创建会话" class="headerlink" title="2.使用 Fluent 风格的 Api 创建会话"></a>2.使用 Fluent 风格的 Api 创建会话</h3><p>核心参数变为流式设置，一个列子如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RetryPolicy</span> <span class="variable">retryPolicy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>);</span><br><span class="line"><span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span></span><br><span class="line">CuratorFrameworkFactory.builder()</span><br><span class="line">        .connectString(connectionInfo)</span><br><span class="line">        .sessionTimeoutMs(<span class="number">5000</span>)</span><br><span class="line">        .connectionTimeoutMs(<span class="number">5000</span>)</span><br><span class="line">        .retryPolicy(retryPolicy)</span><br><span class="line">        .build();</span><br></pre></td></tr></tbody></table></figure><h3 id="3-创建包含隔离命名空间的会话"><a href="#3-创建包含隔离命名空间的会话" class="headerlink" title="3.创建包含隔离命名空间的会话"></a>3.创建包含隔离命名空间的会话</h3><p>为了实现不同的 Zookeeper 业务之间的隔离，需要为每个业务分配一个独立的命名空间（<strong>NameSpace</strong>），即指定一个 Zookeeper 的根路径（官方术语：**<em>为 Zookeeper 添加“Chroot”特性</em>**）。例如（下面的例子）当客户端指定了独立命名空间为“/base”，那么该客户端对 Zookeeper 上的数据节点的操作都是基于该目录进行的。通过设置 Chroot 可以将客户端应用与 Zookeeper 服务端的一课子树相对应，在多个应用共用一个 Zookeeper 集群的场景下，这对于实现不同应用之间的相互隔离十分有意义。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RetryPolicy</span> <span class="variable">retryPolicy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>);</span><br><span class="line">        <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span></span><br><span class="line">        CuratorFrameworkFactory.builder()</span><br><span class="line">                .connectString(connectionInfo)</span><br><span class="line">                .sessionTimeoutMs(<span class="number">5000</span>)</span><br><span class="line">                .connectionTimeoutMs(<span class="number">5000</span>)</span><br><span class="line">                .retryPolicy(retryPolicy)</span><br><span class="line">                .namespace(<span class="string">"base"</span>)</span><br><span class="line">                .build();</span><br></pre></td></tr></tbody></table></figure><h2 id="启动客户端"><a href="#启动客户端" class="headerlink" title="启动客户端"></a>启动客户端</h2><p>当创建会话成功，得到 client 的实例然后可以直接调用其 start( ) 方法：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.start();</span><br></pre></td></tr></tbody></table></figure><h2 id="数据节点操作"><a href="#数据节点操作" class="headerlink" title="数据节点操作"></a>数据节点操作</h2><h3 id="创建数据节点"><a href="#创建数据节点" class="headerlink" title="创建数据节点"></a>创建数据节点</h3><p><strong>Zookeeper 的节点创建模式：</strong></p><ul><li>PERSISTENT：持久化</li><li>PERSISTENT_SEQUENTIAL：持久化并且带序列号</li><li>EPHEMERAL：临时</li><li>EPHEMERAL_SEQUENTIAL：临时并且带序列号</li></ul><p><strong>创建一个节点，初始内容为空</strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.create().forPath(<span class="string">"path"</span>);</span><br></pre></td></tr></tbody></table></figure><p>注意：如果没有设置节点属性，节点创建模式默认为持久化节点，内容默认为空</p><p><strong>创建一个节点，附带初始化内容</strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.create().forPath(<span class="string">"path"</span>,<span class="string">"init"</span>.getBytes());</span><br></pre></td></tr></tbody></table></figure><p><strong>创建一个节点，指定创建模式（临时节点），内容为空</strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.create().withMode(CreateMode.EPHEMERAL).forPath(<span class="string">"path"</span>);</span><br></pre></td></tr></tbody></table></figure><p><strong>创建一个节点，指定创建模式（临时节点），附带初始化内容</strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.create().withMode(CreateMode.EPHEMERAL).forPath(<span class="string">"path"</span>,<span class="string">"init"</span>.getBytes());</span><br></pre></td></tr></tbody></table></figure><p><strong>创建一个节点，指定创建模式（临时节点），附带初始化内容，并且自动递归创建父节点</strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">client.create()</span><br><span class="line">      .creatingParentContainersIfNeeded()</span><br><span class="line">      .withMode(CreateMode.EPHEMERAL)</span><br><span class="line">      .forPath(<span class="string">"path"</span>,<span class="string">"init"</span>.getBytes());</span><br></pre></td></tr></tbody></table></figure><p>这个 creatingParentContainersIfNeeded() 接口非常有用，因为一般情况开发人员在创建一个子节点必须判断它的父节点是否存在，如果不存在直接创建会抛出 NoNodeException，使用 creatingParentContainersIfNeeded() 之后 Curator 能够自动递归创建所有所需的父节点。</p><h3 id="删除数据节点"><a href="#删除数据节点" class="headerlink" title="删除数据节点"></a>删除数据节点</h3><p><strong>删除一个节点</strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.delete().forPath(<span class="string">"path"</span>);</span><br></pre></td></tr></tbody></table></figure><p>注意，此方法只能删除<strong>叶子节点</strong>，否则会抛出异常。</p><p><strong>删除一个节点，并且递归删除其所有的子节点</strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.delete().deletingChildrenIfNeeded().forPath(<span class="string">"path"</span>);</span><br></pre></td></tr></tbody></table></figure><p><strong>删除一个节点，强制指定版本进行删除</strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.delete().withVersion(<span class="number">10086</span>).forPath(<span class="string">"path"</span>);</span><br></pre></td></tr></tbody></table></figure><p><strong>删除一个节点，强制保证删除</strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.delete().guaranteed().forPath(<span class="string">"path"</span>);</span><br></pre></td></tr></tbody></table></figure><p>guaranteed() 接口是一个保障措施，只要客户端会话有效，那么 Curator 会在后台持续进行删除操作，直到删除节点成功。</p><p><strong>注意：</strong>上面的多个流式接口是可以自由组合的，例如：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.delete().guaranteed().deletingChildrenIfNeeded().withVersion(<span class="number">10086</span>).forPath(<span class="string">"path"</span>);</span><br></pre></td></tr></tbody></table></figure><h3 id="读取数据节点数据"><a href="#读取数据节点数据" class="headerlink" title="读取数据节点数据"></a>读取数据节点数据</h3><p><strong>读取一个节点的数据内容</strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.getData().forPath(<span class="string">"path"</span>);</span><br></pre></td></tr></tbody></table></figure><p>注意，此方法返的返回值是 byte[ ];</p><p><strong>读取一个节点的数据内容，同时获取到该节点的 stat</strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Stat</span> <span class="variable">stat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Stat</span>();</span><br><span class="line">client.getData().storingStatIn(stat).forPath(<span class="string">"path"</span>);</span><br></pre></td></tr></tbody></table></figure><h3 id="更新数据节点数据"><a href="#更新数据节点数据" class="headerlink" title="更新数据节点数据"></a>更新数据节点数据</h3><p><strong>更新一个节点的数据内容</strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.setData().forPath(<span class="string">"path"</span>,<span class="string">"data"</span>.getBytes());</span><br></pre></td></tr></tbody></table></figure><p>注意：该接口会返回一个 Stat 实例</p><p><strong>更新一个节点的数据内容，强制指定版本进行更新</strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.setData().withVersion(<span class="number">10086</span>).forPath(<span class="string">"path"</span>,<span class="string">"data"</span>.getBytes());</span><br></pre></td></tr></tbody></table></figure><h3 id="检查节点是否存在"><a href="#检查节点是否存在" class="headerlink" title="检查节点是否存在"></a>检查节点是否存在</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.checkExists().forPath(<span class="string">"path"</span>);</span><br></pre></td></tr></tbody></table></figure><p>注意：该方法返回一个 Stat 实例，用于检查 ZNode 是否存在的操作. 可以调用额外的方法 (监控或者后台处理) 并在最后调用 forPath( ) 指定要操作的 ZNode</p><h3 id="获取某个节点的所有子节点路径"><a href="#获取某个节点的所有子节点路径" class="headerlink" title="获取某个节点的所有子节点路径"></a>获取某个节点的所有子节点路径</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.getChildren().forPath(<span class="string">"path"</span>);</span><br></pre></td></tr></tbody></table></figure><p>注意：该方法的返回值为 List,获得 ZNode 的子节点 Path 列表。 可以调用额外的方法 (监控、后台处理或者获取状态 watch, background or get stat) 并在最后调用 forPath() 指定要操作的父 ZNode</p><h3 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h3><p>CuratorFramework 的实例包含 inTransaction( ) 接口方法，调用此方法开启一个 ZooKeeper 事务. 可以复合 create, setData, check, and/or delete 等操作然后调用 commit() 作为一个原子操作提交。一个例子如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">client.inTransaction().check().forPath(<span class="string">"path"</span>)</span><br><span class="line">      .and()</span><br><span class="line">      .create().withMode(CreateMode.EPHEMERAL).forPath(<span class="string">"path"</span>,<span class="string">"data"</span>.getBytes())</span><br><span class="line">      .and()</span><br><span class="line">      .setData().withVersion(<span class="number">10086</span>).forPath(<span class="string">"path"</span>,<span class="string">"data2"</span>.getBytes())</span><br><span class="line">      .and()</span><br><span class="line">      .commit();</span><br></pre></td></tr></tbody></table></figure><h3 id="异步接口"><a href="#异步接口" class="headerlink" title="异步接口"></a>异步接口</h3><p>上面提到的创建、删除、更新、读取等方法都是同步的，Curator 提供异步接口，引入了<strong>BackgroundCallback</strong>接口用于处理异步接口调用之后服务端返回的结果信息。<strong>BackgroundCallback</strong>接口中一个重要的回调值为 CuratorEvent，里面包含事件类型、响应吗和节点的详细信息。</p><p><strong>CuratorEventType</strong></p><table><thead><tr><th align="center">事件类型</th><th align="center">对应 CuratorFramework 实例的方法</th></tr></thead><tbody><tr><td align="center">CREATE</td><td align="center">#create()</td></tr><tr><td align="center">DELETE</td><td align="center">#delete()</td></tr><tr><td align="center">EXISTS</td><td align="center">#checkExists()</td></tr><tr><td align="center">GET_DATA</td><td align="center">#getData()</td></tr><tr><td align="center">SET_DATA</td><td align="center">#setData()</td></tr><tr><td align="center">CHILDREN</td><td align="center">#getChildren()</td></tr><tr><td align="center">SYNC</td><td align="center">#sync(String,Object)</td></tr><tr><td align="center">GET_ACL</td><td align="center">#getACL()</td></tr><tr><td align="center">SET_ACL</td><td align="center">#setACL()</td></tr><tr><td align="center">WATCHED</td><td align="center">#Watcher(Watcher)</td></tr><tr><td align="center">CLOSING</td><td align="center">#close()</td></tr></tbody></table><p><strong>响应码 (#getResultCode())</strong></p><table><thead><tr><th align="center">响应码</th><th align="center">意义</th></tr></thead><tbody><tr><td align="center">0</td><td align="center">OK，即调用成功</td></tr><tr><td align="center">-4</td><td align="center">ConnectionLoss，即客户端与服务端断开连接</td></tr><tr><td align="center">-110</td><td align="center">NodeExists，即节点已经存在</td></tr><tr><td align="center">-112</td><td align="center">SessionExpired，即会话过期</td></tr></tbody></table><p>一个异步创建节点的例子如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Executor</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">client.create()</span><br><span class="line">      .creatingParentsIfNeeded()</span><br><span class="line">      .withMode(CreateMode.EPHEMERAL)</span><br><span class="line">      .inBackground((curatorFramework, curatorEvent) -&gt; {      System.out.println(String.format(<span class="string">"eventType:%s,resultCode:%s"</span>,curatorEvent.getType(),curatorEvent.getResultCode()));</span><br><span class="line">      },executor)</span><br><span class="line">      .forPath(<span class="string">"path"</span>);</span><br></pre></td></tr></tbody></table></figure><p>注意：如果#inBackground() 方法不指定 executor，那么会默认使用 Curator 的 EventThread 去进行异步处理。</p><h2 id="Curator-食谱-高级特性"><a href="#Curator-食谱-高级特性" class="headerlink" title="Curator 食谱 (高级特性)"></a>Curator 食谱 (高级特性)</h2><p><strong>提醒：首先你必须添加 curator-recipes 依赖，下文仅仅对 recipes 一些特性的使用进行解释和举例，不打算进行源码级别的探讨</strong></p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p><strong>重要提醒：强烈推荐使用 ConnectionStateListener 监控连接的状态，当连接状态为 LOST，curator-recipes 下的所有 Api 将会失效或者过期，尽管后面所有的例子都没有使用到 ConnectionStateListener。</strong></p><h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><p>Zookeeper 原生支持通过注册 Watcher 来进行事件监听，但是开发者需要反复注册 (Watcher 只能单次注册单次使用)。Cache 是 Curator 中对事件监听的包装，可以看作是对事件监听的本地缓存视图，能够自动为开发者处理反复注册监听。Curator 提供了三种 Watcher(Cache) 来监听结点的变化。</p><h4 id="Path-Cache"><a href="#Path-Cache" class="headerlink" title="Path Cache"></a>Path Cache</h4><p>Path Cache 用来监控一个 ZNode 的子节点. 当一个子节点增加， 更新，删除时， Path Cache 会改变它的状态， 会包含最新的子节点， 子节点的数据和状态，而状态的更变将通过 PathChildrenCacheListener 通知。</p><p>实际使用时会涉及到四个类：</p><ul><li>PathChildrenCache</li><li>PathChildrenCacheEvent</li><li>PathChildrenCacheListener</li><li>ChildData</li></ul><p>通过下面的构造函数创建 Path Cache:</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">PathChildrenCache</span><span class="params">(CuratorFramework client, String path, <span class="type">boolean</span> cacheData)</span></span><br></pre></td></tr></tbody></table></figure><p>想使用 cache，必须调用它的 <code>start</code> 方法，使用完后调用 <code>close</code> 方法。 可以设置 StartMode 来实现启动的模式，</p><p>StartMode 有下面几种：</p><ol><li>NORMAL：正常初始化。</li><li>BUILD_INITIAL_CACHE：在调用 <code>start()</code> 之前会调用 <code>rebuild()</code>。</li><li>POST_INITIALIZED_EVENT： 当 Cache 初始化数据后发送一个 PathChildrenCacheEvent.Type#INITIALIZED 事件</li></ol><p><code>public void addListener(PathChildrenCacheListener listener)</code> 可以增加 listener 监听缓存的变化。</p><p><code>getCurrentData()</code> 方法返回一个 <code>List&lt;ChildData&gt;</code> 对象，可以遍历所有的子节点。</p><p><strong>设置/更新、移除其实是使用 client (CuratorFramework) 来操作, 不通过 PathChildrenCache 操作：</strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PathCacheDemo</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PATH</span> <span class="operator">=</span> <span class="string">"/example/pathCache"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">TestingServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestingServer</span>();</span><br><span class="line">        <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">        client.start();</span><br><span class="line">        <span class="type">PathChildrenCache</span> <span class="variable">cache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PathChildrenCache</span>(client, PATH, <span class="literal">true</span>);</span><br><span class="line">        cache.start();</span><br><span class="line">        <span class="type">PathChildrenCacheListener</span> <span class="variable">cacheListener</span> <span class="operator">=</span> (client1, event) -&gt; {</span><br><span class="line">            System.out.println(<span class="string">"事件类型："</span> + event.getType());</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != event.getData()) {</span><br><span class="line">                System.out.println(<span class="string">"节点数据："</span> + event.getData().getPath() + <span class="string">" = "</span> + <span class="keyword">new</span> <span class="title class_">String</span>(event.getData().getData()));</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">        cache.getListenable().addListener(cacheListener);</span><br><span class="line">        client.create().creatingParentsIfNeeded().forPath(<span class="string">"/example/pathCache/test01"</span>, <span class="string">"01"</span>.getBytes());</span><br><span class="line">        Thread.sleep(<span class="number">10</span>);</span><br><span class="line">        client.create().creatingParentsIfNeeded().forPath(<span class="string">"/example/pathCache/test02"</span>, <span class="string">"02"</span>.getBytes());</span><br><span class="line">        Thread.sleep(<span class="number">10</span>);</span><br><span class="line">        client.setData().forPath(<span class="string">"/example/pathCache/test01"</span>, <span class="string">"01_V2"</span>.getBytes());</span><br><span class="line">        Thread.sleep(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">for</span> (ChildData data : cache.getCurrentData()) {</span><br><span class="line">            System.out.println(<span class="string">"getCurrentData:"</span> + data.getPath() + <span class="string">" = "</span> + <span class="keyword">new</span> <span class="title class_">String</span>(data.getData()));</span><br><span class="line">        }</span><br><span class="line">        client.delete().forPath(<span class="string">"/example/pathCache/test01"</span>);</span><br><span class="line">        Thread.sleep(<span class="number">10</span>);</span><br><span class="line">        client.delete().forPath(<span class="string">"/example/pathCache/test02"</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span> * <span class="number">5</span>);</span><br><span class="line">        cache.close();</span><br><span class="line">        client.close();</span><br><span class="line">        System.out.println(<span class="string">"OK!"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong>注意：</strong>如果 new PathChildrenCache(client, PATH, true) 中的参数 cacheData 值设置为 false，则示例中的 event.getData().getData()、data.getData() 将返回 null，cache 将不会缓存节点数据。</p><p><strong>注意：</strong>示例中的 Thread.sleep(10) 可以注释掉，但是注释后事件监听的触发次数会不全，这可能与 PathCache 的实现原理有关，不能太过频繁的触发事件！</p><h4 id="Node-Cache"><a href="#Node-Cache" class="headerlink" title="Node Cache"></a>Node Cache</h4><p>Node Cache 与 Path Cache 类似，Node Cache 只是监听某一个特定的节点。它涉及到下面的三个类：</p><ul><li><code>NodeCache</code>&nbsp;- Node Cache 实现类</li><li><code>NodeCacheListener</code>&nbsp;- 节点监听器</li><li><code>ChildData</code>&nbsp;- 节点数据</li></ul><p><strong>注意：</strong>使用 cache，依然要调用它的 <code>start()</code> 方法，使用完后调用 <code>close()</code> 方法。</p><p>getCurrentData() 将得到节点当前的状态，通过它的状态可以得到当前的值。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NodeCacheDemo</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PATH</span> <span class="operator">=</span> <span class="string">"/example/cache"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">TestingServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestingServer</span>();</span><br><span class="line">        <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">        client.start();</span><br><span class="line">        client.create().creatingParentsIfNeeded().forPath(PATH);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">NodeCache</span> <span class="variable">cache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NodeCache</span>(client, PATH);</span><br><span class="line">        <span class="type">NodeCacheListener</span> <span class="variable">listener</span> <span class="operator">=</span> () -&gt; {</span><br><span class="line">            <span class="type">ChildData</span> <span class="variable">data</span> <span class="operator">=</span> cache.getCurrentData();</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != data) {</span><br><span class="line">                System.out.println(<span class="string">"节点数据："</span> + <span class="keyword">new</span> <span class="title class_">String</span>(cache.getCurrentData().getData()));</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                System.out.println(<span class="string">"节点被删除!"</span>);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">        cache.getListenable().addListener(listener);</span><br><span class="line">        cache.start();</span><br><span class="line">        client.setData().forPath(PATH, <span class="string">"01"</span>.getBytes());</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        client.setData().forPath(PATH, <span class="string">"02"</span>.getBytes());</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        client.delete().deletingChildrenIfNeeded().forPath(PATH);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span> * <span class="number">2</span>);</span><br><span class="line">        cache.close();</span><br><span class="line">        client.close();</span><br><span class="line">        System.out.println(<span class="string">"OK!"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong>注意：</strong>示例中的 Thread.sleep(10) 可以注释，但是注释后事件监听的触发次数会不全，这可能与 NodeCache 的实现原理有关，不能太过频繁的触发事件！</p><p><strong>注意：</strong>NodeCache 只能监听一个节点的状态变化。</p><h4 id="Tree-Cache"><a href="#Tree-Cache" class="headerlink" title="Tree Cache"></a>Tree Cache</h4><p>Tree Cache 可以监控整个树上的所有节点，类似于 PathCache 和 NodeCache 的组合，主要涉及到下面四个类：</p><ul><li>TreeCache - Tree Cache 实现类</li><li>TreeCacheListener - 监听器类</li><li>TreeCacheEvent - 触发的事件类</li><li>ChildData - 节点数据</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TreeCacheDemo</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PATH</span> <span class="operator">=</span> <span class="string">"/example/cache"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">TestingServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestingServer</span>();</span><br><span class="line">        <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">        client.start();</span><br><span class="line">        client.create().creatingParentsIfNeeded().forPath(PATH);</span><br><span class="line">        <span class="type">TreeCache</span> <span class="variable">cache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TreeCache</span>(client, PATH);</span><br><span class="line">        <span class="type">TreeCacheListener</span> <span class="variable">listener</span> <span class="operator">=</span> (client1, event) -&gt;</span><br><span class="line">                System.out.println(<span class="string">"事件类型："</span> + event.getType() +</span><br><span class="line">                        <span class="string">" | 路径："</span> + (<span class="literal">null</span> != event.getData() ? event.getData().getPath() : <span class="literal">null</span>));</span><br><span class="line">        cache.getListenable().addListener(listener);</span><br><span class="line">        cache.start();</span><br><span class="line">        client.setData().forPath(PATH, <span class="string">"01"</span>.getBytes());</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        client.setData().forPath(PATH, <span class="string">"02"</span>.getBytes());</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        client.delete().deletingChildrenIfNeeded().forPath(PATH);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span> * <span class="number">2</span>);</span><br><span class="line">        cache.close();</span><br><span class="line">        client.close();</span><br><span class="line">        System.out.println(<span class="string">"OK!"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong>注意：</strong>在此示例中没有使用 Thread.sleep(10)，但是事件触发次数也是正常的。</p><p><strong>注意：</strong>TreeCache 在初始化 (调用 <code>start()</code> 方法) 的时候会回调 <code>TreeCacheListener</code> 实例一个事 TreeCacheEvent，而回调的 TreeCacheEvent 对象的 Type 为 INITIALIZED，ChildData 为 null，此时 <code>event.getData().getPath()</code> 很有可能导致空指针异常，这里应该主动处理并避免这种情况。</p><h3 id="Leader-选举"><a href="#Leader-选举" class="headerlink" title="Leader 选举"></a>Leader 选举</h3><p>在分布式计算中，&nbsp;<strong>leader elections</strong>是很重要的一个功能， 这个选举过程是这样子的： 指派一个进程作为组织者，将任务分发给各节点。 在任务开始前， 哪个节点都不知道谁是 leader(领导者) 或者 coordinator(协调者). 当选举算法开始执行后， 每个节点最终会得到一个唯一的节点作为任务 leader. 除此之外， 选举还经常会发生在 leader 意外宕机的情况下，新的 leader 要被选举出来。</p><p>在 zookeeper 集群中，leader 负责写操作，然后通过 Zab 协议实现 follower 的同步，leader 或者 follower 都可以处理读操作。</p><p>Curator 有两种 leader 选举的 recipe,分别是<strong>LeaderSelector</strong>和<strong>LeaderLatch</strong>。</p><p>前者是所有存活的客户端不间断的轮流做 Leader，大同社会。后者是一旦选举出 Leader，除非有客户端挂掉重新触发选举，否则不会交出领导权。某党?</p><h4 id="LeaderLatch"><a href="#LeaderLatch" class="headerlink" title="LeaderLatch"></a>LeaderLatch</h4><p>LeaderLatch 有两个构造函数：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">LeaderLatch</span><span class="params">(CuratorFramework client, String latchPath)</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">LeaderLatch</span><span class="params">(CuratorFramework client, String latchPath,  String id)</span></span><br></pre></td></tr></tbody></table></figure><p>LeaderLatch 的启动：</p><p><strong>leaderLatch.start( );</strong></p><p>一旦启动，LeaderLatch 会和其它使用相同 latch path 的其它 LeaderLatch 交涉，然后其中一个最终会被选举为 leader，可以通过 <code>hasLeadership</code> 方法查看 LeaderLatch 实例是否 leader：</p><p><strong>leaderLatch.hasLeadership( );</strong>&nbsp;//返回 true 说明当前实例是 leader</p><p>类似 JDK 的 CountDownLatch， LeaderLatch 在请求成为 leadership 会 block(阻塞)，一旦不使用 LeaderLatch 了，必须调用 <code>close</code> 方法。 如果它是 leader,会释放 leadership， 其它的参与者将会选举一个 leader。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException,EOFException</span><br><span class="line"><span class="comment">/*Causes the current thread to wait until this instance acquires leadership</span></span><br><span class="line"><span class="comment">unless the thread is interrupted or closed.*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">await</span><span class="params">(<span class="type">long</span> timeout,TimeUnit unit)</span><span class="keyword">throws</span> InterruptedException</span><br></pre></td></tr></tbody></table></figure><p><strong>异常处理：</strong>&nbsp;LeaderLatch 实例可以增加 ConnectionStateListener 来监听网络连接问题。 当 SUSPENDED 或 LOST 时, leader 不再认为自己还是 leader。当 LOST 后连接重连后 RECONNECTED,LeaderLatch 会删除先前的 ZNode 然后重新创建一个。LeaderLatch 用户必须考虑导致 leadership 丢失的连接问题。 强烈推荐你使用 ConnectionStateListener。</p><p>一个 LeaderLatch 的使用例子：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LeaderLatchDemo</span> <span class="keyword">extends</span> <span class="title class_">BaseConnectionInfo</span> {</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">PATH</span> <span class="operator">=</span> <span class="string">"/francis/leader"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CLIENT_QTY</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        List&lt;CuratorFramework&gt; clients = Lists.newArrayList();</span><br><span class="line">        List&lt;LeaderLatch&gt; examples = Lists.newArrayList();</span><br><span class="line">        TestingServer server=<span class="keyword">new</span> <span class="title class_">TestingServer</span>();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; CLIENT_QTY; i++) {</span><br><span class="line">                <span class="type">CuratorFramework</span> <span class="variable">client</span></span><br><span class="line">                        <span class="operator">=</span> CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">20000</span>, <span class="number">3</span>));</span><br><span class="line">                clients.add(client);</span><br><span class="line">                <span class="type">LeaderLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LeaderLatch</span>(client, PATH, <span class="string">"Client #"</span> + i);</span><br><span class="line">                latch.addListener(<span class="keyword">new</span> <span class="title class_">LeaderLatchListener</span>() {</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">isLeader</span><span class="params">()</span> {</span><br><span class="line">                        <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">                        System.out.println(<span class="string">"I am Leader"</span>);</span><br><span class="line">                    }</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notLeader</span><span class="params">()</span> {</span><br><span class="line">                        <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">                        System.out.println(<span class="string">"I am not Leader"</span>);</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line">                examples.add(latch);</span><br><span class="line">                client.start();</span><br><span class="line">                latch.start();</span><br><span class="line">            }</span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">            <span class="type">LeaderLatch</span> <span class="variable">currentLeader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (LeaderLatch latch : examples) {</span><br><span class="line">                <span class="keyword">if</span> (latch.hasLeadership()) {</span><br><span class="line">                    currentLeader = latch;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            System.out.println(<span class="string">"current leader is "</span> + currentLeader.getId());</span><br><span class="line">            System.out.println(<span class="string">"release the leader "</span> + currentLeader.getId());</span><br><span class="line">            currentLeader.close();</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (LeaderLatch latch : examples) {</span><br><span class="line">                <span class="keyword">if</span> (latch.hasLeadership()) {</span><br><span class="line">                    currentLeader = latch;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            System.out.println(<span class="string">"current leader is "</span> + currentLeader.getId());</span><br><span class="line">            System.out.println(<span class="string">"release the leader "</span> + currentLeader.getId());</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            <span class="keyword">for</span> (LeaderLatch latch : examples) {</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != latch.getState())</span><br><span class="line">                CloseableUtils.closeQuietly(latch);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">for</span> (CuratorFramework client : clients) {</span><br><span class="line">                CloseableUtils.closeQuietly(client);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>可以添加 test module 的依赖方便进行测试，不需要启动真实的 zookeeper 服务端：</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>首先我们创建了 10 个 LeaderLatch，启动后它们中的一个会被选举为 leader。 因为选举会花费一些时间，start 后并不能马上就得到 leader。<br>通过 <code>hasLeadership</code> 查看自己是否是 leader， 如果是的话返回 true。<br>可以通过 <code>.getLeader().getId()</code> 可以得到当前的 leader 的 ID。<br>只能通过 <code>close</code> 释放当前的领导权。<br><code>await</code> 是一个阻塞方法， 尝试获取 leader 地位，但是未必能上位。</p><h4 id="LeaderSelector"><a href="#LeaderSelector" class="headerlink" title="LeaderSelector"></a>LeaderSelector</h4><p>LeaderSelector 使用的时候主要涉及下面几个类：</p><ul><li>LeaderSelector</li><li>LeaderSelectorListener</li><li>LeaderSelectorListenerAdapter</li><li>CancelLeadershipException</li></ul><p>核心类是 LeaderSelector，它的构造函数如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">LeaderSelector</span><span class="params">(CuratorFramework client, String mutexPath,LeaderSelectorListener listener)</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">LeaderSelector</span><span class="params">(CuratorFramework client, String mutexPath, ThreadFactory threadFactory, Executor executor, LeaderSelectorListener listener)</span></span><br></pre></td></tr></tbody></table></figure><p>类似 LeaderLatch,LeaderSelector 必须 <code>start</code>:&nbsp;<code>leaderSelector.start();</code>&nbsp; 一旦启动，当实例取得领导权时你的 listener 的 <code>takeLeadership()</code> 方法被调用。而 takeLeadership() 方法只有领导权被释放时才返回。 当你不再使用 LeaderSelector 实例时，应该调用它的 close 方法。</p><p><strong>异常处理</strong>&nbsp;LeaderSelectorListener 类继承 ConnectionStateListener。LeaderSelector 必须小心连接状态的改变。如果实例成为 leader, 它应该响应 SUSPENDED 或 LOST。 当 SUSPENDED 状态出现时， 实例必须假定在重新连接成功之前它可能不再是 leader 了。 如果 LOST 状态出现， 实例不再是 leader， takeLeadership 方法返回。</p><p><strong>重要</strong>: 推荐处理方式是当收到 SUSPENDED 或 LOST 时抛出 CancelLeadershipException 异常.。这会导致 LeaderSelector 实例中断并取消执行 takeLeadership 方法的异常.。这非常重要， 你必须考虑扩展 LeaderSelectorListenerAdapter. LeaderSelectorListenerAdapter 提供了推荐的处理逻辑。</p><p>下面的一个例子摘抄自官方：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LeaderSelectorAdapter</span> <span class="keyword">extends</span> <span class="title class_">LeaderSelectorListenerAdapter</span> <span class="keyword">implements</span> <span class="title class_">Closeable</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LeaderSelector leaderSelector;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">leaderCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LeaderSelectorAdapter</span><span class="params">(CuratorFramework client, String path, String name)</span> {</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        leaderSelector = <span class="keyword">new</span> <span class="title class_">LeaderSelector</span>(client, path, <span class="built_in">this</span>);</span><br><span class="line">        leaderSelector.autoRequeue();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        leaderSelector.start();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        leaderSelector.close();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">takeLeadership</span><span class="params">(CuratorFramework client)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">waitSeconds</span> <span class="operator">=</span> (<span class="type">int</span>) (<span class="number">5</span> * Math.random()) + <span class="number">1</span>;</span><br><span class="line">        System.out.println(name + <span class="string">" is now the leader. Waiting "</span> + waitSeconds + <span class="string">" seconds..."</span>);</span><br><span class="line">        System.out.println(name + <span class="string">" has been leader "</span> + leaderCount.getAndIncrement() + <span class="string">" time(s) before."</span>);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Thread.sleep(TimeUnit.SECONDS.toMillis(waitSeconds));</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            System.err.println(name + <span class="string">" was interrupted."</span>);</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            System.out.println(name + <span class="string">" relinquishing leadership.\n"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>你可以在 takeLeadership 进行任务的分配等等，并且不要返回，如果你想要要此实例一直是 leader 的话可以加一个死循环。调用 &nbsp;<code>leaderSelector.autoRequeue();</code> 保证在此实例释放领导权之后还可能获得领导权。 在这里我们使用 AtomicInteger 来记录此 client 获得领导权的次数， 它是”fair”， 每个 client 有平等的机会获得领导权。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LeaderSelectorDemo</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">PATH</span> <span class="operator">=</span> <span class="string">"/francis/leader"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CLIENT_QTY</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        List&lt;CuratorFramework&gt; clients = Lists.newArrayList();</span><br><span class="line">        List&lt;LeaderSelectorAdapter&gt; examples = Lists.newArrayList();</span><br><span class="line">        <span class="type">TestingServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestingServer</span>();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; CLIENT_QTY; i++) {</span><br><span class="line">                <span class="type">CuratorFramework</span> <span class="variable">client</span></span><br><span class="line">                        <span class="operator">=</span> CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">20000</span>, <span class="number">3</span>));</span><br><span class="line">                clients.add(client);</span><br><span class="line">                <span class="type">LeaderSelectorAdapter</span> <span class="variable">selectorAdapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LeaderSelectorAdapter</span>(client, PATH, <span class="string">"Client #"</span> + i);</span><br><span class="line">                examples.add(selectorAdapter);</span><br><span class="line">                client.start();</span><br><span class="line">                selectorAdapter.start();</span><br><span class="line">            }</span><br><span class="line">            System.out.println(<span class="string">"Press enter/return to quit\n"</span>);</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(System.in)).readLine();</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            System.out.println(<span class="string">"Shutting down..."</span>);</span><br><span class="line">            <span class="keyword">for</span> (LeaderSelectorAdapter exampleClient : examples) {</span><br><span class="line">                CloseableUtils.closeQuietly(exampleClient);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">for</span> (CuratorFramework client : clients) {</span><br><span class="line">                CloseableUtils.closeQuietly(client);</span><br><span class="line">            }</span><br><span class="line">            CloseableUtils.closeQuietly(server);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>对比可知，LeaderLatch 必须调用 <code>close()</code> 方法才会释放领导权，而对于 LeaderSelector，通过 <code>LeaderSelectorListener</code> 可以对领导权进行控制， 在适当的时候释放领导权，这样每个节点都有可能获得领导权。从而，LeaderSelector 具有更好的灵活性和可控性，建议有 LeaderElection 应用场景下优先使用 LeaderSelector。</p><h3 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h3><p><strong>提醒：</strong></p><p>1.推荐使用 ConnectionStateListener 监控连接的状态，因为当连接 LOST 时你不再拥有锁</p><p>2.分布式的锁全局同步， 这意味着任何一个时间点不会有两个客户端都拥有相同的锁。</p><h4 id="可重入共享锁—Shared-Reentrant-Lock"><a href="#可重入共享锁—Shared-Reentrant-Lock" class="headerlink" title="可重入共享锁—Shared Reentrant Lock"></a>可重入共享锁—Shared Reentrant Lock</h4><p><strong>Shared 意味着锁是全局可见的</strong>， 客户端都可以请求锁。 Reentrant 和 JDK 的 ReentrantLock 类似，即可重入， 意味着同一个客户端在拥有锁的同时，可以多次获取，不会被阻塞。 它是由类 <code>InterProcessMutex</code> 来实现。 它的构造函数为：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InterProcessMutex</span><span class="params">(CuratorFramework client, String path)</span></span><br></pre></td></tr></tbody></table></figure><p>通过 <code>acquire()</code> 获得锁，并提供超时机制：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">()</span></span><br><span class="line">Acquire the mutex - blocking until it<span class="string">'s available. Note: the same thread can call acquire</span></span><br><span class="line"><span class="string">re-entrantly. Each call to acquire must be balanced by a call to release()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">public boolean acquire(long time,TimeUnit unit)</span></span><br><span class="line"><span class="string">Acquire the mutex - blocks until it'</span>s available or the given time expires. Note: the same thread can call acquire re-entrantly. Each call to acquire that returns <span class="literal">true</span> must be balanced by a call to <span class="title function_">release</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line">Parameters:</span><br><span class="line">time - time to wait</span><br><span class="line">unit - time unit</span><br><span class="line">Returns:</span><br><span class="line"><span class="literal">true</span> <span class="keyword">if</span> the mutex was acquired, <span class="literal">false</span> <span class="keyword">if</span> not</span><br></pre></td></tr></tbody></table></figure><p>通过 <code>release()</code> 方法释放锁。 InterProcessMutex 实例可以重用。</p><p><strong>Revoking</strong>&nbsp;ZooKeeper recipes wiki 定义了可协商的撤销机制。 为了撤销 mutex, 调用下面的方法：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">makeRevocable</span><span class="params">(RevocationListener&lt;T&gt; listener)</span></span><br><span class="line">将锁设为可撤销的. 当别的进程或线程想让你释放锁时Listener会被调用。</span><br><span class="line">Parameters:</span><br><span class="line">listener - the listener</span><br></pre></td></tr></tbody></table></figure><p>如果你请求撤销当前的锁， 调用 <code>attemptRevoke()</code> 方法,注意锁释放时 <code>RevocationListener</code> 将会回调。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">attemptRevoke</span><span class="params">(CuratorFramework client,String path)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">Utility to mark a lock <span class="keyword">for</span> revocation. Assuming that the lock has been registered</span><br><span class="line">with a RevocationListener, it will get called and the lock should be released. Note,</span><br><span class="line">however, that revocation is cooperative.</span><br><span class="line">Parameters:</span><br><span class="line">client - the client</span><br><span class="line">path - the path of the lock - usually from something like InterProcessMutex.getParticipantNodes()</span><br></pre></td></tr></tbody></table></figure><p><strong>二次提醒：错误处理</strong>&nbsp; 还是强烈推荐你使用 <code>ConnectionStateListener</code> 处理连接状态的改变。 当连接 LOST 时你不再拥有锁。</p><p>首先让我们创建一个模拟的共享资源， 这个资源期望只能单线程的访问，否则会有并发问题。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FakeLimitedResource</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicBoolean</span> <span class="variable">inUse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">use</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">        <span class="comment">// 真实环境中我们会在这里访问/维护一个共享的资源</span></span><br><span class="line">        <span class="comment">//这个例子在使用锁的情况下不会非法并发异常IllegalStateException</span></span><br><span class="line">        <span class="comment">//但是在无锁的情况由于sleep了一段时间，很容易抛出异常</span></span><br><span class="line">        <span class="keyword">if</span> (!inUse.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">"Needs to be used by one client at a time"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Thread.sleep((<span class="type">long</span>) (<span class="number">3</span> * Math.random()));</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            inUse.set(<span class="literal">false</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>然后创建一个 <code>InterProcessMutexDemo</code> 类， 它负责请求锁， 使用资源，释放锁这样一个完整的访问过程。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InterProcessMutexDemo</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> InterProcessMutex lock;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FakeLimitedResource resource;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String clientName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InterProcessMutexDemo</span><span class="params">(CuratorFramework client, String lockPath, FakeLimitedResource resource, String clientName)</span> {</span><br><span class="line">        <span class="built_in">this</span>.resource = resource;</span><br><span class="line">        <span class="built_in">this</span>.clientName = clientName;</span><br><span class="line">        <span class="built_in">this</span>.lock = <span class="keyword">new</span> <span class="title class_">InterProcessMutex</span>(client, lockPath);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doWork</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="keyword">if</span> (!lock.acquire(time, unit)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(clientName + <span class="string">" could not acquire the lock"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            System.out.println(clientName + <span class="string">" get the lock"</span>);</span><br><span class="line">            resource.use(); <span class="comment">//access resource exclusively</span></span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            System.out.println(clientName + <span class="string">" releasing the lock"</span>);</span><br><span class="line">            lock.release(); <span class="comment">// always release the lock in a finally block</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">QTY</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REPETITIONS</span> <span class="operator">=</span> QTY * <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PATH</span> <span class="operator">=</span> <span class="string">"/examples/locks"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">FakeLimitedResource</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FakeLimitedResource</span>();</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(QTY);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">TestingServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestingServer</span>();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; QTY; ++i) {</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> i;</span><br><span class="line">                Callable&lt;Void&gt; task = <span class="keyword">new</span> <span class="title class_">Callable</span>&lt;Void&gt;() {</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Void <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                        <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">                        <span class="keyword">try</span> {</span><br><span class="line">                            client.start();</span><br><span class="line">                            <span class="keyword">final</span> <span class="type">InterProcessMutexDemo</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterProcessMutexDemo</span>(client, PATH, resource, <span class="string">"Client "</span> + index);</span><br><span class="line">                            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; REPETITIONS; ++j) {</span><br><span class="line">                                example.doWork(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">                            }</span><br><span class="line">                        } <span class="keyword">catch</span> (Throwable e) {</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        } <span class="keyword">finally</span> {</span><br><span class="line">                            CloseableUtils.closeQuietly(client);</span><br><span class="line">                        }</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    }</span><br><span class="line">                };</span><br><span class="line">                service.submit(task);</span><br><span class="line">            }</span><br><span class="line">            service.shutdown();</span><br><span class="line">            service.awaitTermination(<span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            CloseableUtils.closeQuietly(server);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>代码也很简单，生成 10 个 client， 每个 client 重复执行 10 次 请求锁–访问资源–释放锁的过程。每个 client 都在独立的线程中。 结果可以看到，锁是随机的被每个实例排他性的使用。</p><p>既然是可重用的，你可以在一个线程中多次调用 <code>acquire()</code>,在线程拥有锁时它总是返回 true。</p><p>**你不应该在多个线程中用同一个 <code>InterProcessMutex</code>**， 你可以在每个线程中都生成一个新的 InterProcessMutex 实例，它们的 path 都一样，这样它们可以共享同一个锁。</p><h4 id="不可重入共享锁—Shared-Lock"><a href="#不可重入共享锁—Shared-Lock" class="headerlink" title="不可重入共享锁—Shared Lock"></a>不可重入共享锁—Shared Lock</h4><p>这个锁和上面的 <code>InterProcessMutex</code> 相比，就是少了 Reentrant 的功能，也就意味着它不能在同一个线程中重入。这个类是 <code>InterProcessSemaphoreMutex</code>,使用方法和 <code>InterProcessMutex</code> 类似</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InterProcessSemaphoreMutexDemo</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> InterProcessSemaphoreMutex lock;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FakeLimitedResource resource;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String clientName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InterProcessSemaphoreMutexDemo</span><span class="params">(CuratorFramework client, String lockPath, FakeLimitedResource resource, String clientName)</span> {</span><br><span class="line">        <span class="built_in">this</span>.resource = resource;</span><br><span class="line">        <span class="built_in">this</span>.clientName = clientName;</span><br><span class="line">        <span class="built_in">this</span>.lock = <span class="keyword">new</span> <span class="title class_">InterProcessSemaphoreMutex</span>(client, lockPath);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doWork</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="keyword">if</span> (!lock.acquire(time, unit))</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(clientName + <span class="string">" 不能得到互斥锁"</span>);</span><br><span class="line">        }</span><br><span class="line">        System.out.println(clientName + <span class="string">" 已获取到互斥锁"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!lock.acquire(time, unit))</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(clientName + <span class="string">" 不能得到互斥锁"</span>);</span><br><span class="line">        }</span><br><span class="line">        System.out.println(clientName + <span class="string">" 再次获取到互斥锁"</span>);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            System.out.println(clientName + <span class="string">" get the lock"</span>);</span><br><span class="line">            resource.use(); <span class="comment">//access resource exclusively</span></span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            System.out.println(clientName + <span class="string">" releasing the lock"</span>);</span><br><span class="line">            lock.release(); <span class="comment">// always release the lock in a finally block</span></span><br><span class="line">            lock.release(); <span class="comment">// 获取锁几次 释放锁也要几次</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">QTY</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REPETITIONS</span> <span class="operator">=</span> QTY * <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PATH</span> <span class="operator">=</span> <span class="string">"/examples/locks"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">FakeLimitedResource</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FakeLimitedResource</span>();</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(QTY);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">TestingServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestingServer</span>();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; QTY; ++i) {</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> i;</span><br><span class="line">                Callable&lt;Void&gt; task = <span class="keyword">new</span> <span class="title class_">Callable</span>&lt;Void&gt;() {</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Void <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                        <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">                        <span class="keyword">try</span> {</span><br><span class="line">                            client.start();</span><br><span class="line">                            <span class="keyword">final</span> <span class="type">InterProcessSemaphoreMutexDemo</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterProcessSemaphoreMutexDemo</span>(client, PATH, resource, <span class="string">"Client "</span> + index);</span><br><span class="line">                            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; REPETITIONS; ++j) {</span><br><span class="line">                                example.doWork(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">                            }</span><br><span class="line">                        } <span class="keyword">catch</span> (Throwable e) {</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        } <span class="keyword">finally</span> {</span><br><span class="line">                            CloseableUtils.closeQuietly(client);</span><br><span class="line">                        }</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    }</span><br><span class="line">                };</span><br><span class="line">                service.submit(task);</span><br><span class="line">            }</span><br><span class="line">            service.shutdown();</span><br><span class="line">            service.awaitTermination(<span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            CloseableUtils.closeQuietly(server);</span><br><span class="line">        }</span><br><span class="line">        Thread.sleep(Integer.MAX_VALUE);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>运行后发现，有且只有一个 client 成功获取第一个锁 (第一个 <code>acquire()</code> 方法返回 true)，然后它自己阻塞在第二个 <code>acquire()</code> 方法，获取第二个锁超时；其他所有的客户端都阻塞在第一个 <code>acquire()</code> 方法超时并且抛出异常。</p><p>这样也就验证了 <code>InterProcessSemaphoreMutex</code> 实现的锁是不可重入的。</p><h4 id="可重入读写锁—Shared-Reentrant-Read-Write-Lock"><a href="#可重入读写锁—Shared-Reentrant-Read-Write-Lock" class="headerlink" title="可重入读写锁—Shared Reentrant Read Write Lock"></a>可重入读写锁—Shared Reentrant Read Write Lock</h4><p>类似 JDK 的<strong>ReentrantReadWriteLock</strong>。一个读写锁管理一对相关的锁。一个负责读操作，另外一个负责写操作。读操作在写锁没被使用时可同时由多个进程使用，而写锁在使用时不允许读 (阻塞)。</p><p>此锁是可重入的。<strong>一个拥有写锁的线程可重入读锁，但是读锁却不能进入写锁</strong>。这也意味着<strong>写锁可以降级成读锁， 比如请求写锁 —&gt;请求读锁 —&gt;释放读锁 —-&gt;释放写锁</strong>。从读锁升级成写锁是不行的。</p><p>可重入读写锁主要由两个类实现：<code>InterProcessReadWriteLock</code>、<code>InterProcessMutex</code>。使用时首先创建一个 <code>InterProcessReadWriteLock</code> 实例，然后再根据你的需求得到读锁或者写锁，读写锁的类型是 <code>InterProcessMutex</code>。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReentrantReadWriteLockDemo</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InterProcessReadWriteLock lock;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InterProcessMutex readLock;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InterProcessMutex writeLock;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FakeLimitedResource resource;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String clientName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ReentrantReadWriteLockDemo</span><span class="params">(CuratorFramework client, String lockPath, FakeLimitedResource resource, String clientName)</span> {</span><br><span class="line">        <span class="built_in">this</span>.resource = resource;</span><br><span class="line">        <span class="built_in">this</span>.clientName = clientName;</span><br><span class="line">        lock = <span class="keyword">new</span> <span class="title class_">InterProcessReadWriteLock</span>(client, lockPath);</span><br><span class="line">        readLock = lock.readLock();</span><br><span class="line">        writeLock = lock.writeLock();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doWork</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="comment">// 注意只能先得到写锁再得到读锁，不能反过来！！！</span></span><br><span class="line">        <span class="keyword">if</span> (!writeLock.acquire(time, unit)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(clientName + <span class="string">" 不能得到写锁"</span>);</span><br><span class="line">        }</span><br><span class="line">        System.out.println(clientName + <span class="string">" 已得到写锁"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!readLock.acquire(time, unit)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(clientName + <span class="string">" 不能得到读锁"</span>);</span><br><span class="line">        }</span><br><span class="line">        System.out.println(clientName + <span class="string">" 已得到读锁"</span>);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            resource.use(); <span class="comment">// 使用资源</span></span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            System.out.println(clientName + <span class="string">" 释放读写锁"</span>);</span><br><span class="line">            readLock.release();</span><br><span class="line">            writeLock.release();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">QTY</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REPETITIONS</span> <span class="operator">=</span> QTY ;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PATH</span> <span class="operator">=</span> <span class="string">"/examples/locks"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">FakeLimitedResource</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FakeLimitedResource</span>();</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(QTY);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">TestingServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestingServer</span>();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; QTY; ++i) {</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> i;</span><br><span class="line">                Callable&lt;Void&gt; task = <span class="keyword">new</span> <span class="title class_">Callable</span>&lt;Void&gt;() {</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Void <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                        <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">                        <span class="keyword">try</span> {</span><br><span class="line">                            client.start();</span><br><span class="line">                            <span class="keyword">final</span> <span class="type">ReentrantReadWriteLockDemo</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLockDemo</span>(client, PATH, resource, <span class="string">"Client "</span> + index);</span><br><span class="line">                            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; REPETITIONS; ++j) {</span><br><span class="line">                                example.doWork(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">                            }</span><br><span class="line">                        } <span class="keyword">catch</span> (Throwable e) {</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        } <span class="keyword">finally</span> {</span><br><span class="line">                            CloseableUtils.closeQuietly(client);</span><br><span class="line">                        }</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    }</span><br><span class="line">                };</span><br><span class="line">                service.submit(task);</span><br><span class="line">            }</span><br><span class="line">            service.shutdown();</span><br><span class="line">            service.awaitTermination(<span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            CloseableUtils.closeQuietly(server);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="信号量—Shared-Semaphore"><a href="#信号量—Shared-Semaphore" class="headerlink" title="信号量—Shared Semaphore"></a>信号量—Shared Semaphore</h4><p>一个计数的信号量类似 JDK 的 Semaphore。 JDK 中 Semaphore 维护的一组许可 (<strong>permits</strong>)，而 Curator 中称之为租约 (<strong>Lease</strong>)。 有两种方式可以决定 semaphore 的最大租约数。第一种方式是用户给定 path 并且指定最大 LeaseSize。第二种方式用户给定 path 并且使用 <code>SharedCountReader</code> 类。<strong>如果不使用 SharedCountReader, 必须保证所有实例在多进程中使用相同的 (最大) 租约数量,否则有可能出现 A 进程中的实例持有最大租约数量为 10，但是在 B 进程中持有的最大租约数量为 20，此时租约的意义就失效了。</strong></p><p>这次调用 <code>acquire()</code> 会返回一个租约对象。 客户端必须在 finally 中 close 这些租约对象，否则这些租约会丢失掉。 但是， 但是，如果客户端 session 由于某种原因比如 crash 丢掉， 那么这些客户端持有的租约会自动 close， 这样其它客户端可以继续使用这些租约。 租约还可以通过下面的方式返还：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnAll</span><span class="params">(Collection&lt;Lease&gt; leases)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnLease</span><span class="params">(Lease lease)</span></span><br></pre></td></tr></tbody></table></figure><p>注意你可以一次性请求多个租约，如果 Semaphore 当前的租约不够，则请求线程会被阻塞。 同时还提供了超时的重载方法。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Lease <span class="title function_">acquire</span><span class="params">()</span></span><br><span class="line"><span class="keyword">public</span> Collection&lt;Lease&gt; <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> qty)</span></span><br><span class="line"><span class="keyword">public</span> Lease <span class="title function_">acquire</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span></span><br><span class="line"><span class="keyword">public</span> Collection&lt;Lease&gt; <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> qty, <span class="type">long</span> time, TimeUnit unit)</span></span><br></pre></td></tr></tbody></table></figure><p>Shared Semaphore 使用的主要类包括下面几个：</p><ul><li><code>InterProcessSemaphoreV2</code></li><li><code>Lease</code></li><li><code>SharedCountReader</code></li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InterProcessSemaphoreDemo</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_LEASE</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PATH</span> <span class="operator">=</span> <span class="string">"/examples/locks"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">FakeLimitedResource</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FakeLimitedResource</span>();</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">TestingServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestingServer</span>()) {</span><br><span class="line"></span><br><span class="line">            <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">            client.start();</span><br><span class="line"></span><br><span class="line">            <span class="type">InterProcessSemaphoreV2</span> <span class="variable">semaphore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterProcessSemaphoreV2</span>(client, PATH, MAX_LEASE);</span><br><span class="line">            Collection&lt;Lease&gt; leases = semaphore.acquire(<span class="number">5</span>);</span><br><span class="line">            System.out.println(<span class="string">"get "</span> + leases.size() + <span class="string">" leases"</span>);</span><br><span class="line">            <span class="type">Lease</span> <span class="variable">lease</span> <span class="operator">=</span> semaphore.acquire();</span><br><span class="line">            System.out.println(<span class="string">"get another lease"</span>);</span><br><span class="line"></span><br><span class="line">            resource.use();</span><br><span class="line"></span><br><span class="line">            Collection&lt;Lease&gt; leases2 = semaphore.acquire(<span class="number">5</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">            System.out.println(<span class="string">"Should timeout and acquire return "</span> + leases2);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">"return one lease"</span>);</span><br><span class="line">            semaphore.returnLease(lease);</span><br><span class="line">            System.out.println(<span class="string">"return another 5 leases"</span>);</span><br><span class="line">            semaphore.returnAll(leases);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>首先我们先获得了 5 个租约， 最后我们把它还给了 semaphore。 接着请求了一个租约，因为 semaphore 还有 5 个租约，所以请求可以满足，返回一个租约，还剩 4 个租约。 然后再请求一个租约，因为租约不够，<strong>阻塞到超时，还是没能满足，返回结果为 null(租约不足会阻塞到超时，然后返回 null，不会主动抛出异常；如果不设置超时时间，会一致阻塞)。</strong></p><p>上面说讲的锁都是公平锁 (fair)。 总 ZooKeeper 的角度看， 每个客户端都按照请求的顺序获得锁，不存在非公平的抢占的情况。</p><h4 id="多共享锁对象-—Multi-Shared-Lock"><a href="#多共享锁对象-—Multi-Shared-Lock" class="headerlink" title="多共享锁对象 —Multi Shared Lock"></a>多共享锁对象 —Multi Shared Lock</h4><p>Multi Shared Lock 是一个锁的容器。 当调用 <code>acquire()</code>， 所有的锁都会被 <code>acquire()</code>，如果请求失败，所有的锁都会被 release。 同样调用 release 时所有的锁都被 release(<strong>失败被忽略</strong>)。 基本上，它就是组锁的代表，在它上面的请求释放操作都会传递给它包含的所有的锁。</p><p>主要涉及两个类：</p><ul><li><code>InterProcessMultiLock</code></li><li><code>InterProcessLock</code></li></ul><p>它的构造函数需要包含的锁的集合，或者一组 ZooKeeper 的 path。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InterProcessMultiLock</span><span class="params">(List&lt;InterProcessLock&gt; locks)</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">InterProcessMultiLock</span><span class="params">(CuratorFramework client, List&lt;String&gt; paths)</span></span><br></pre></td></tr></tbody></table></figure><p>用法和 Shared Lock 相同。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiSharedLockDemo</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PATH1</span> <span class="operator">=</span> <span class="string">"/examples/locks1"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PATH2</span> <span class="operator">=</span> <span class="string">"/examples/locks2"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">FakeLimitedResource</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FakeLimitedResource</span>();</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">TestingServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestingServer</span>()) {</span><br><span class="line">            <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">            client.start();</span><br><span class="line"></span><br><span class="line">            <span class="type">InterProcessLock</span> <span class="variable">lock1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterProcessMutex</span>(client, PATH1);</span><br><span class="line">            <span class="type">InterProcessLock</span> <span class="variable">lock2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterProcessSemaphoreMutex</span>(client, PATH2);</span><br><span class="line"></span><br><span class="line">            <span class="type">InterProcessMultiLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterProcessMultiLock</span>(Arrays.asList(lock1, lock2));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!lock.acquire(<span class="number">10</span>, TimeUnit.SECONDS)) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">"could not acquire the lock"</span>);</span><br><span class="line">            }</span><br><span class="line">            System.out.println(<span class="string">"has got all lock"</span>);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">"has got lock1: "</span> + lock1.isAcquiredInThisProcess());</span><br><span class="line">            System.out.println(<span class="string">"has got lock2: "</span> + lock2.isAcquiredInThisProcess());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                resource.use(); <span class="comment">//access resource exclusively</span></span><br><span class="line">            } <span class="keyword">finally</span> {</span><br><span class="line">                System.out.println(<span class="string">"releasing the lock"</span>);</span><br><span class="line">                lock.release(); <span class="comment">// always release the lock in a finally block</span></span><br><span class="line">            }</span><br><span class="line">            System.out.println(<span class="string">"has got lock1: "</span> + lock1.isAcquiredInThisProcess());</span><br><span class="line">            System.out.println(<span class="string">"has got lock2: "</span> + lock2.isAcquiredInThisProcess());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>新建一个 <code>InterProcessMultiLock</code>， 包含一个重入锁和一个非重入锁。 调用 <code>acquire()</code> 后可以看到线程同时拥有了这两个锁。 调用 <code>release()</code> 看到这两个锁都被释放了。</p><p><strong>最后再重申一次， 强烈推荐使用 ConnectionStateListener 监控连接的状态，当连接状态为 LOST，锁将会丢失。</strong></p><h3 id="分布式计数器"><a href="#分布式计数器" class="headerlink" title="分布式计数器"></a>分布式计数器</h3><p>顾名思义，计数器是用来计数的, 利用 ZooKeeper 可以实现一个集群共享的计数器。 只要使用相同的 path 就可以得到最新的计数器值， 这是由 ZooKeeper 的一致性保证的。Curator 有两个计数器， 一个是用 int 来计数 (<code>SharedCount</code>)，一个用 long 来计数 (<code>DistributedAtomicLong</code>)。</p><h4 id="分布式-int-计数器—SharedCount"><a href="#分布式-int-计数器—SharedCount" class="headerlink" title="分布式 int 计数器—SharedCount"></a>分布式 int 计数器—SharedCount</h4><p>这个类使用 int 类型来计数。 主要涉及三个类。</p><ul><li>SharedCount</li><li>SharedCountReader</li><li>SharedCountListener</li></ul><p><code>SharedCount</code> 代表计数器， 可以为它增加一个 <code>SharedCountListener</code>，当计数器改变时此 Listener 可以监听到改变的事件，而 <code>SharedCountReader</code> 可以读取到最新的值， 包括字面值和带版本信息的值 VersionedValue。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SharedCounterDemo</span> <span class="keyword">implements</span> <span class="title class_">SharedCountListener</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">QTY</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PATH</span> <span class="operator">=</span> <span class="string">"/examples/counter"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, Exception {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Random</span> <span class="variable">rand</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="type">SharedCounterDemo</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SharedCounterDemo</span>();</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">TestingServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestingServer</span>()) {</span><br><span class="line">            <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">            client.start();</span><br><span class="line"></span><br><span class="line">            <span class="type">SharedCount</span> <span class="variable">baseCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SharedCount</span>(client, PATH, <span class="number">0</span>);</span><br><span class="line">            baseCount.addListener(example);</span><br><span class="line">            baseCount.start();</span><br><span class="line"></span><br><span class="line">            List&lt;SharedCount&gt; examples = Lists.newArrayList();</span><br><span class="line">            <span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(QTY);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; QTY; ++i) {</span><br><span class="line">                <span class="keyword">final</span> <span class="type">SharedCount</span> <span class="variable">count</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SharedCount</span>(client, PATH, <span class="number">0</span>);</span><br><span class="line">                examples.add(count);</span><br><span class="line">                Callable&lt;Void&gt; task = () -&gt; {</span><br><span class="line">                    count.start();</span><br><span class="line">                    Thread.sleep(rand.nextInt(<span class="number">10000</span>));</span><br><span class="line">                    System.out.println(<span class="string">"Increment:"</span> + count.trySetCount(count.getVersionedValue(), count.getCount() + rand.nextInt(<span class="number">10</span>)));</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                };</span><br><span class="line">                service.submit(task);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            service.shutdown();</span><br><span class="line">            service.awaitTermination(<span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; QTY; ++i) {</span><br><span class="line">                examples.get(i).close();</span><br><span class="line">            }</span><br><span class="line">            baseCount.close();</span><br><span class="line">        }</span><br><span class="line">        Thread.sleep(Integer.MAX_VALUE);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stateChanged</span><span class="params">(CuratorFramework arg0, ConnectionState arg1)</span> {</span><br><span class="line">        System.out.println(<span class="string">"State changed: "</span> + arg1.toString());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">countHasChanged</span><span class="params">(SharedCountReader sharedCount, <span class="type">int</span> newCount)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        System.out.println(<span class="string">"Counter's value is changed to "</span> + newCount);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>在这个例子中，我们使用 <code>baseCount</code> 来监听计数值 (<code>addListener</code> 方法来添加 SharedCountListener )。 任意的 SharedCount， 只要使用相同的 path，都可以得到这个计数值。 然后我们使用 5 个线程为计数值增加一个 10 以内的随机数。相同的 path 的 SharedCount 对计数值进行更改，将会回调给 <code>baseCount</code> 的 SharedCountListener。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">count.trySetCount(count.getVersionedValue(), count.getCount() + rand.nextInt(<span class="number">10</span>))</span><br></pre></td></tr></tbody></table></figure><p>这里我们使用 <code>trySetCount</code> 去设置计数器。&nbsp;<strong>第一个参数提供当前的 VersionedValue,如果期间其它 client 更新了此计数值， 你的更新可能不成功， 但是这时你的 client 更新了最新的值，所以失败了你可以尝试再更新一次。 而 <code>setCount</code> 是强制更新计数器的值</strong>。</p><p>注意计数器必须 <code>start</code>,使用完之后必须调用 <code>close</code> 关闭它。</p><p>强烈推荐使用 <code>ConnectionStateListener</code>。 在本例中 <code>SharedCountListener</code> 扩展 <code>ConnectionStateListener</code>。</p><h4 id="分布式-long-计数器—DistributedAtomicLong"><a href="#分布式-long-计数器—DistributedAtomicLong" class="headerlink" title="分布式 long 计数器—DistributedAtomicLong"></a>分布式 long 计数器—DistributedAtomicLong</h4><p>再看一个 Long 类型的计数器。 除了计数的范围比 <code>SharedCount</code> 大了之外， 它首先尝试使用乐观锁的方式设置计数器， 如果不成功 (比如期间计数器已经被其它 client 更新了)， 它使用 <code>InterProcessMutex</code> 方式来更新计数值。</p><p>可以从它的内部实现 <code>DistributedAtomicValue.trySet()</code> 中看出：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">AtomicValue&lt;<span class="type">byte</span>[]&gt;   trySet(MakeValue makeValue) <span class="keyword">throws</span> Exception</span><br><span class="line"> {</span><br><span class="line">     MutableAtomicValue&lt;<span class="type">byte</span>[]&gt;  result = <span class="keyword">new</span> <span class="title class_">MutableAtomicValue</span>&lt;<span class="type">byte</span>[]&gt;(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">     tryOptimistic(result, makeValue);</span><br><span class="line">     <span class="keyword">if</span> ( !result.succeeded() &amp;&amp; (mutex != <span class="literal">null</span>) )</span><br><span class="line">     {</span><br><span class="line">         tryWithMutex(result, makeValue);</span><br><span class="line">     }</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> result;</span><br><span class="line"> }</span><br></pre></td></tr></tbody></table></figure><p>此计数器有一系列的操作：</p><ul><li>get(): 获取当前值</li><li>increment()： 加一</li><li>decrement(): 减一</li><li>add()： 增加特定的值</li><li>subtract(): 减去特定的值</li><li>trySet(): 尝试设置计数值</li><li>forceSet(): 强制设置计数值</li></ul><p>你<strong>必须</strong>检查返回结果的 <code>succeeded()</code>， 它代表此操作是否成功。 如果操作成功，&nbsp;<code>preValue()</code> 代表操作前的值，&nbsp;<code>postValue()</code> 代表操作后的值。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedAtomicLongDemo</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">QTY</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PATH</span> <span class="operator">=</span> <span class="string">"/examples/counter"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, Exception {</span><br><span class="line">        List&lt;DistributedAtomicLong&gt; examples = Lists.newArrayList();</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">TestingServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestingServer</span>()) {</span><br><span class="line">            <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">            client.start();</span><br><span class="line">            <span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(QTY);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; QTY; ++i) {</span><br><span class="line">                <span class="keyword">final</span> <span class="type">DistributedAtomicLong</span> <span class="variable">count</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DistributedAtomicLong</span>(client, PATH, <span class="keyword">new</span> <span class="title class_">RetryNTimes</span>(<span class="number">10</span>, <span class="number">10</span>));</span><br><span class="line"></span><br><span class="line">                examples.add(count);</span><br><span class="line">                Callable&lt;Void&gt; task = () -&gt; {</span><br><span class="line">                    <span class="keyword">try</span> {</span><br><span class="line">                        AtomicValue&lt;Long&gt; value = count.increment();</span><br><span class="line">                        System.out.println(<span class="string">"succeed: "</span> + value.succeeded());</span><br><span class="line">                        <span class="keyword">if</span> (value.succeeded())</span><br><span class="line">                            System.out.println(<span class="string">"Increment: from "</span> + value.preValue() + <span class="string">" to "</span> + value.postValue());</span><br><span class="line">                    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                };</span><br><span class="line">                service.submit(task);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            service.shutdown();</span><br><span class="line">            service.awaitTermination(<span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">            Thread.sleep(Integer.MAX_VALUE);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="分布式队列"><a href="#分布式队列" class="headerlink" title="分布式队列"></a>分布式队列</h3><p>使用 Curator 也可以简化 Ephemeral Node (<strong>临时节点</strong>) 的操作。Curator 也提供 ZK Recipe 的分布式队列实现。 利用 ZK 的 PERSISTENTS_EQUENTIAL 节点， 可以保证放入到队列中的项目是按照顺序排队的。 如果单一的消费者从队列中取数据， 那么它是先入先出的，这也是队列的特点。 如果你严格要求顺序，你就的使用单一的消费者，可以使用 Leader 选举只让 Leader 作为唯一的消费者。</p><p>但是， 根据 Netflix 的 Curator 作者所说， ZooKeeper 真心不适合做 Queue，或者说 ZK 没有实现一个好的 Queue，详细内容可以看 &nbsp;<a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9jd2lraS5hcGFjaGUub3JnL2NvbmZsdWVuY2UvZGlzcGxheS9DVVJBVE9SL1RONA==">Tech Note 4</a>， 原因有五：</p><ol><li>ZK 有 1MB 的传输限制。 实践中 ZNode 必须相对较小，而队列包含成千上万的消息，非常的大。</li><li>如果有很多节点，ZK 启动时相当的慢。 而使用 queue 会导致好多 ZNode. 你需要显著增大 initLimit 和 syncLimit.</li><li>ZNode 很大的时候很难清理。Netflix 不得不创建了一个专门的程序做这事。</li><li>当很大量的包含成千上万的子节点的 ZNode 时， ZK 的性能变得不好</li><li>ZK 的数据库完全放在内存中。 大量的 Queue 意味着会占用很多的内存空间。</li></ol><p>尽管如此， Curator 还是创建了各种 Queue 的实现。 如果 Queue 的数据量不太多，数据量不太大的情况下，酌情考虑，还是可以使用的。</p><h4 id="分布式队列—DistributedQueue"><a href="#分布式队列—DistributedQueue" class="headerlink" title="分布式队列—DistributedQueue"></a>分布式队列—DistributedQueue</h4><p>DistributedQueue 是最普通的一种队列。 它设计以下四个类：</p><ul><li>QueueBuilder - 创建队列使用 QueueBuilder,它也是其它队列的创建类</li><li>QueueConsumer - 队列中的消息消费者接口</li><li>QueueSerializer - 队列消息序列化和反序列化接口，提供了对队列中的对象的序列化和反序列化</li><li>DistributedQueue - 队列实现类</li></ul><p>QueueConsumer 是消费者，它可以接收队列的数据。处理队列中的数据的代码逻辑可以放在 QueueConsumer.consumeMessage() 中。</p><p>正常情况下先将消息从队列中移除，再交给消费者消费。但这是两个步骤，不是原子的。可以调用 Builder 的 lockPath() 消费者加锁，当消费者消费数据时持有锁，这样其它消费者不能消费此消息。如果消费失败或者进程死掉，消息可以交给其它进程。这会带来一点性能的损失。最好还是单消费者模式使用队列。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedQueueDemo</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PATH</span> <span class="operator">=</span> <span class="string">"/example/queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">TestingServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestingServer</span>();</span><br><span class="line">        <span class="type">CuratorFramework</span> <span class="variable">clientA</span> <span class="operator">=</span> CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">        clientA.start();</span><br><span class="line">        <span class="type">CuratorFramework</span> <span class="variable">clientB</span> <span class="operator">=</span> CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">        clientB.start();</span><br><span class="line">        DistributedQueue&lt;String&gt; queueA;</span><br><span class="line">        QueueBuilder&lt;String&gt; builderA = QueueBuilder.builder(clientA, createQueueConsumer(<span class="string">"A"</span>), createQueueSerializer(), PATH);</span><br><span class="line">        queueA = builderA.buildQueue();</span><br><span class="line">        queueA.start();</span><br><span class="line"></span><br><span class="line">        DistributedQueue&lt;String&gt; queueB;</span><br><span class="line">        QueueBuilder&lt;String&gt; builderB = QueueBuilder.builder(clientB, createQueueConsumer(<span class="string">"B"</span>), createQueueSerializer(), PATH);</span><br><span class="line">        queueB = builderB.buildQueue();</span><br><span class="line">        queueB.start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) {</span><br><span class="line">            queueA.put(<span class="string">" test-A-"</span> + i);</span><br><span class="line">            Thread.sleep(<span class="number">10</span>);</span><br><span class="line">            queueB.put(<span class="string">" test-B-"</span> + i);</span><br><span class="line">        }</span><br><span class="line">        Thread.sleep(<span class="number">1000</span> * <span class="number">10</span>);<span class="comment">// 等待消息消费完成</span></span><br><span class="line">        queueB.close();</span><br><span class="line">        queueA.close();</span><br><span class="line">        clientB.close();</span><br><span class="line">        clientA.close();</span><br><span class="line">        System.out.println(<span class="string">"OK!"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 队列消息序列化实现类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> QueueSerializer&lt;String&gt; <span class="title function_">createQueueSerializer</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QueueSerializer</span>&lt;String&gt;() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">byte</span>[] serialize(String item) {</span><br><span class="line">                <span class="keyword">return</span> item.getBytes();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> {</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义队列消费者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> QueueConsumer&lt;String&gt; <span class="title function_">createQueueConsumer</span><span class="params">(<span class="keyword">final</span> String name)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QueueConsumer</span>&lt;String&gt;() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stateChanged</span><span class="params">(CuratorFramework client, ConnectionState newState)</span> {</span><br><span class="line">                System.out.println(<span class="string">"连接状态改变: "</span> + newState.name());</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">consumeMessage</span><span class="params">(String message)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                System.out.println(<span class="string">"消费消息("</span> + name + <span class="string">"): "</span> + message);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>例子中定义了两个分布式队列和两个消费者，因为 PATH 是相同的，会存在消费者抢占消费消息的情况。</p><h4 id="带-Id-的分布式队列—DistributedIdQueue"><a href="#带-Id-的分布式队列—DistributedIdQueue" class="headerlink" title="带 Id 的分布式队列—DistributedIdQueue"></a>带 Id 的分布式队列—DistributedIdQueue</h4><p>DistributedIdQueue 和上面的队列类似，<strong>但是可以为队列中的每一个元素设置一个 ID</strong>。 可以通过 ID 把队列中任意的元素移除。 它涉及几个类：</p><ul><li>QueueBuilder</li><li>QueueConsumer</li><li>QueueSerializer</li><li>DistributedQueue</li></ul><p>通过下面方法创建：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builder.buildIdQueue()</span><br></pre></td></tr></tbody></table></figure><p>放入元素时：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">queue.put(aMessage, messageId);</span><br></pre></td></tr></tbody></table></figure><p>移除元素时：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">numberRemoved</span> <span class="operator">=</span> queue.remove(messageId);</span><br></pre></td></tr></tbody></table></figure><p>在这个例子中， 有些元素还没有被消费者消费前就移除了，这样消费者不会收到删除的消息。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedIdQueueDemo</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PATH</span> <span class="operator">=</span> <span class="string">"/example/queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">TestingServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestingServer</span>();</span><br><span class="line">        <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        DistributedIdQueue&lt;String&gt; queue = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            client = CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">            client.getCuratorListenable().addListener((client1, event) -&gt; System.out.println(<span class="string">"CuratorEvent: "</span> + event.getType().name()));</span><br><span class="line"></span><br><span class="line">            client.start();</span><br><span class="line">            QueueConsumer&lt;String&gt; consumer = createQueueConsumer();</span><br><span class="line">            QueueBuilder&lt;String&gt; builder = QueueBuilder.builder(client, consumer, createQueueSerializer(), PATH);</span><br><span class="line">            queue = builder.buildIdQueue();</span><br><span class="line">            queue.start();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</span><br><span class="line">                queue.put(<span class="string">" test-"</span> + i, <span class="string">"Id"</span> + i);</span><br><span class="line">                Thread.sleep((<span class="type">long</span>) (<span class="number">15</span> * Math.random()));</span><br><span class="line">                queue.remove(<span class="string">"Id"</span> + i);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">20000</span>);</span><br><span class="line"></span><br><span class="line">        } <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line"></span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            CloseableUtils.closeQuietly(queue);</span><br><span class="line">            CloseableUtils.closeQuietly(client);</span><br><span class="line">            CloseableUtils.closeQuietly(server);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> QueueSerializer&lt;String&gt; <span class="title function_">createQueueSerializer</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QueueSerializer</span>&lt;String&gt;() {</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">byte</span>[] serialize(String item) {</span><br><span class="line">                <span class="keyword">return</span> item.getBytes();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> {</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> QueueConsumer&lt;String&gt; <span class="title function_">createQueueConsumer</span><span class="params">()</span> {</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QueueConsumer</span>&lt;String&gt;() {</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stateChanged</span><span class="params">(CuratorFramework client, ConnectionState newState)</span> {</span><br><span class="line">                System.out.println(<span class="string">"connection new state: "</span> + newState.name());</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">consumeMessage</span><span class="params">(String message)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                System.out.println(<span class="string">"consume one message: "</span> + message);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="优先级分布式队列—DistributedPriorityQueue"><a href="#优先级分布式队列—DistributedPriorityQueue" class="headerlink" title="优先级分布式队列—DistributedPriorityQueue"></a>优先级分布式队列—DistributedPriorityQueue</h4><p>优先级队列对队列中的元素按照优先级进行排序。&nbsp;<strong>Priority 越小， 元素越靠前， 越先被消费掉</strong>。 它涉及下面几个类：</p><ul><li>QueueBuilder</li><li>QueueConsumer</li><li>QueueSerializer</li><li>DistributedPriorityQueue</li></ul><p>通过 builder.buildPriorityQueue(minItemsBeforeRefresh) 方法创建。 当优先级队列得到元素增删消息时，它会暂停处理当前的元素队列，然后刷新队列。minItemsBeforeRefresh 指定刷新前当前活动的队列的最小数量。 主要设置你的程序可以容忍的不排序的最小值。</p><p>放入队列时需要指定优先级：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">queue.put(aMessage, priority);</span><br></pre></td></tr></tbody></table></figure><p>例子：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedPriorityQueueDemo</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PATH</span> <span class="operator">=</span> <span class="string">"/example/queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">TestingServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestingServer</span>();</span><br><span class="line">        <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        DistributedPriorityQueue&lt;String&gt; queue = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            client = CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">            client.getCuratorListenable().addListener((client1, event) -&gt; System.out.println(<span class="string">"CuratorEvent: "</span> + event.getType().name()));</span><br><span class="line"></span><br><span class="line">            client.start();</span><br><span class="line">            QueueConsumer&lt;String&gt; consumer = createQueueConsumer();</span><br><span class="line">            QueueBuilder&lt;String&gt; builder = QueueBuilder.builder(client, consumer, createQueueSerializer(), PATH);</span><br><span class="line">            queue = builder.buildPriorityQueue(<span class="number">0</span>);</span><br><span class="line">            queue.start();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</span><br><span class="line">                <span class="type">int</span> <span class="variable">priority</span> <span class="operator">=</span> (<span class="type">int</span>) (Math.random() * <span class="number">100</span>);</span><br><span class="line">                System.out.println(<span class="string">"test-"</span> + i + <span class="string">" priority:"</span> + priority);</span><br><span class="line">                queue.put(<span class="string">"test-"</span> + i, priority);</span><br><span class="line">                Thread.sleep((<span class="type">long</span>) (<span class="number">50</span> * Math.random()));</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">20000</span>);</span><br><span class="line"></span><br><span class="line">        } <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line"></span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            CloseableUtils.closeQuietly(queue);</span><br><span class="line">            CloseableUtils.closeQuietly(client);</span><br><span class="line">            CloseableUtils.closeQuietly(server);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> QueueSerializer&lt;String&gt; <span class="title function_">createQueueSerializer</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QueueSerializer</span>&lt;String&gt;() {</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">byte</span>[] serialize(String item) {</span><br><span class="line">                <span class="keyword">return</span> item.getBytes();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> {</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> QueueConsumer&lt;String&gt; <span class="title function_">createQueueConsumer</span><span class="params">()</span> {</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QueueConsumer</span>&lt;String&gt;() {</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stateChanged</span><span class="params">(CuratorFramework client, ConnectionState newState)</span> {</span><br><span class="line">                System.out.println(<span class="string">"connection new state: "</span> + newState.name());</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">consumeMessage</span><span class="params">(String message)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                System.out.println(<span class="string">"consume one message: "</span> + message);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>有时候你可能会有错觉，优先级设置并没有起效。那是因为优先级是对于队列积压的元素而言，如果消费速度过快有可能出现在后一个元素入队操作之前前一个元素已经被消费，这种情况下 DistributedPriorityQueue 会退化为 DistributedQueue。</p><h4 id="分布式延迟队列—DistributedDelayQueue"><a href="#分布式延迟队列—DistributedDelayQueue" class="headerlink" title="分布式延迟队列—DistributedDelayQueue"></a>分布式延迟队列—DistributedDelayQueue</h4><p>JDK 中也有 DelayQueue，不知道你是否熟悉。 DistributedDelayQueue 也提供了类似的功能， 元素有个 delay 值， 消费者隔一段时间才能收到元素。 涉及到下面四个类。</p><ul><li>QueueBuilder</li><li>QueueConsumer</li><li>QueueSerializer</li><li>DistributedDelayQueue</li></ul><p>通过下面的语句创建：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">QueueBuilder&lt;MessageType&gt;    builder = QueueBuilder.builder(client, consumer, serializer, path);</span><br><span class="line">... more builder method calls as needed ...</span><br><span class="line">DistributedDelayQueue&lt;MessageType&gt; queue = builder.buildDelayQueue();</span><br></pre></td></tr></tbody></table></figure><p>放入元素时可以指定 <code>delayUntilEpoch</code>：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">queue.put(aMessage, delayUntilEpoch);</span><br></pre></td></tr></tbody></table></figure><p>注意 <code>delayUntilEpoch</code> 不是离现在的一个时间间隔， 比如 20 毫秒，而是未来的一个时间戳，如 System.currentTimeMillis() + 10 秒。 如果 delayUntilEpoch 的时间已经过去，消息会立刻被消费者接收。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedDelayQueueDemo</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PATH</span> <span class="operator">=</span> <span class="string">"/example/queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">TestingServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestingServer</span>();</span><br><span class="line">        <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        DistributedDelayQueue&lt;String&gt; queue = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            client = CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">            client.getCuratorListenable().addListener((client1, event) -&gt; System.out.println(<span class="string">"CuratorEvent: "</span> + event.getType().name()));</span><br><span class="line"></span><br><span class="line">            client.start();</span><br><span class="line">            QueueConsumer&lt;String&gt; consumer = createQueueConsumer();</span><br><span class="line">            QueueBuilder&lt;String&gt; builder = QueueBuilder.builder(client, consumer, createQueueSerializer(), PATH);</span><br><span class="line">            queue = builder.buildDelayQueue();</span><br><span class="line">            queue.start();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</span><br><span class="line">                queue.put(<span class="string">"test-"</span> + i, System.currentTimeMillis() + <span class="number">10000</span>);</span><br><span class="line">            }</span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>().getTime() + <span class="string">": already put all items"</span>);</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">20000</span>);</span><br><span class="line"></span><br><span class="line">        } <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line"></span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            CloseableUtils.closeQuietly(queue);</span><br><span class="line">            CloseableUtils.closeQuietly(client);</span><br><span class="line">            CloseableUtils.closeQuietly(server);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> QueueSerializer&lt;String&gt; <span class="title function_">createQueueSerializer</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QueueSerializer</span>&lt;String&gt;() {</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">byte</span>[] serialize(String item) {</span><br><span class="line">                <span class="keyword">return</span> item.getBytes();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> {</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> QueueConsumer&lt;String&gt; <span class="title function_">createQueueConsumer</span><span class="params">()</span> {</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QueueConsumer</span>&lt;String&gt;() {</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stateChanged</span><span class="params">(CuratorFramework client, ConnectionState newState)</span> {</span><br><span class="line">                System.out.println(<span class="string">"connection new state: "</span> + newState.name());</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">consumeMessage</span><span class="params">(String message)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>().getTime() + <span class="string">": consume one message: "</span> + message);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="SimpleDistributedQueue"><a href="#SimpleDistributedQueue" class="headerlink" title="SimpleDistributedQueue"></a>SimpleDistributedQueue</h4><p>前面虽然实现了各种队列，但是你注意到没有，这些队列并没有实现类似 JDK 一样的接口。&nbsp;<code>SimpleDistributedQueue</code> 提供了和 JDK 基本一致的接口 (但是没有实现 Queue 接口)。 创建很简单：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SimpleDistributedQueue</span><span class="params">(CuratorFramework client,String path)</span></span><br></pre></td></tr></tbody></table></figure><p>增加元素：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(<span class="type">byte</span>[] data)</span> <span class="keyword">throws</span> Exception</span><br></pre></td></tr></tbody></table></figure><p>删除元素：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] take() <span class="keyword">throws</span> Exception</span><br></pre></td></tr></tbody></table></figure><p>另外还提供了其它方法：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] peek() <span class="keyword">throws</span> Exception</span><br><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] poll(<span class="type">long</span> timeout, TimeUnit unit) <span class="keyword">throws</span> Exception</span><br><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] poll() <span class="keyword">throws</span> Exception</span><br><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] remove() <span class="keyword">throws</span> Exception</span><br><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] element() <span class="keyword">throws</span> Exception</span><br></pre></td></tr></tbody></table></figure><p>没有 <code>add</code> 方法， 多了 <code>take</code> 方法。</p><p><code>take</code> 方法在成功返回之前会被阻塞。 而 <code>poll</code> 方法在队列为空时直接返回 null。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleDistributedQueueDemo</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PATH</span> <span class="operator">=</span> <span class="string">"/example/queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">TestingServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestingServer</span>();</span><br><span class="line">        <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        SimpleDistributedQueue queue;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            client = CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">            client.getCuratorListenable().addListener((client1, event) -&gt; System.out.println(<span class="string">"CuratorEvent: "</span> + event.getType().name()));</span><br><span class="line">            client.start();</span><br><span class="line">            queue = <span class="keyword">new</span> <span class="title class_">SimpleDistributedQueue</span>(client, PATH);</span><br><span class="line">            <span class="type">Producer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Producer</span>(queue);</span><br><span class="line">            <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Consumer</span>(queue);</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(producer, <span class="string">"producer"</span>).start();</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(consumer, <span class="string">"consumer"</span>).start();</span><br><span class="line">            Thread.sleep(<span class="number">20000</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line"></span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            CloseableUtils.closeQuietly(client);</span><br><span class="line">            CloseableUtils.closeQuietly(server);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Producer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> {</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> SimpleDistributedQueue queue;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Producer</span><span class="params">(SimpleDistributedQueue queue)</span> {</span><br><span class="line">            <span class="built_in">this</span>.queue = queue;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> queue.offer((<span class="string">"zjc-"</span> + i).getBytes());</span><br><span class="line">                    <span class="keyword">if</span> (flag) {</span><br><span class="line">                        System.out.println(<span class="string">"发送一条消息成功："</span> + <span class="string">"zjc-"</span> + i);</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        System.out.println(<span class="string">"发送一条消息失败："</span> + <span class="string">"zjc-"</span> + i);</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> {</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> SimpleDistributedQueue queue;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Consumer</span><span class="params">(SimpleDistributedQueue queue)</span> {</span><br><span class="line">            <span class="built_in">this</span>.queue = queue;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="type">byte</span>[] datas = queue.take();</span><br><span class="line">                System.out.println(<span class="string">"消费一条消息成功："</span> + <span class="keyword">new</span> <span class="title class_">String</span>(datas, <span class="string">"UTF-8"</span>));</span><br><span class="line">            } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>但是实际上发送了 100 条消息，消费完第一条之后，后面的消息无法消费，目前没找到原因。查看一下官方文档推荐的 demo 使用下面几个 Api：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Creating a SimpleDistributedQueue</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">SimpleDistributedQueue</span><span class="params">(CuratorFramework client,</span></span><br><span class="line"><span class="params">                              String path)</span></span><br><span class="line">Parameters:</span><br><span class="line">client - the client</span><br><span class="line">path - path to store queue nodes</span><br><span class="line">Add to the queue</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(<span class="type">byte</span>[] data)</span></span><br><span class="line">             <span class="keyword">throws</span> Exception</span><br><span class="line">Inserts data into queue.</span><br><span class="line">Parameters:</span><br><span class="line">data - the data</span><br><span class="line">Returns:</span><br><span class="line"><span class="literal">true</span> <span class="keyword">if</span> data was successfully added</span><br><span class="line">Take from the queue</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] take()</span><br><span class="line">           <span class="keyword">throws</span> Exception</span><br><span class="line">Removes the head of the queue and returns it, blocks until it succeeds.</span><br><span class="line">Returns:</span><br><span class="line">The former head of the queue</span><br><span class="line">NOTE: see the Javadoc <span class="keyword">for</span> additional methods</span><br></pre></td></tr></tbody></table></figure><p>但是实际使用发现还是存在消费阻塞问题。</p><h3 id="分布式屏障—Barrier"><a href="#分布式屏障—Barrier" class="headerlink" title="分布式屏障—Barrier"></a>分布式屏障—Barrier</h3><p>分布式 Barrier 是这样一个类： 它会阻塞所有节点上的等待进程，直到某一个被满足， 然后所有的节点继续进行。</p><p>比如赛马比赛中， 等赛马陆续来到起跑线前。 一声令下，所有的赛马都飞奔而出。</p><h4 id="DistributedBarrier"><a href="#DistributedBarrier" class="headerlink" title="DistributedBarrier"></a>DistributedBarrier</h4><p><code>DistributedBarrier</code> 类实现了栅栏的功能。 它的构造函数如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">DistributedBarrier</span><span class="params">(CuratorFramework client, String barrierPath)</span></span><br><span class="line">Parameters:</span><br><span class="line">client - client</span><br><span class="line">barrierPath - path to use as the barrier</span><br></pre></td></tr></tbody></table></figure><p>首先你需要设置栅栏，它将阻塞在它上面等待的线程:</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setBarrier();</span><br></pre></td></tr></tbody></table></figure><p>然后需要阻塞的线程调用方法等待放行条件:</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">waitOnBarrier</span><span class="params">()</span></span><br></pre></td></tr></tbody></table></figure><p>当条件满足时，移除栅栏，所有等待的线程将继续执行：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">removeBarrier();</span><br></pre></td></tr></tbody></table></figure><p><strong>异常处理</strong>&nbsp;DistributedBarrier 会监控连接状态，当连接断掉时 <code>waitOnBarrier()</code> 方法会抛出异常。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedBarrierDemo</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">QTY</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PATH</span> <span class="operator">=</span> <span class="string">"/examples/barrier"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">TestingServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestingServer</span>()) {</span><br><span class="line">            <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">            client.start();</span><br><span class="line">            <span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(QTY);</span><br><span class="line">            <span class="type">DistributedBarrier</span> <span class="variable">controlBarrier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DistributedBarrier</span>(client, PATH);</span><br><span class="line">            controlBarrier.setBarrier();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; QTY; ++i) {</span><br><span class="line">                <span class="keyword">final</span> <span class="type">DistributedBarrier</span> <span class="variable">barrier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DistributedBarrier</span>(client, PATH);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> i;</span><br><span class="line">                Callable&lt;Void&gt; task = () -&gt; {</span><br><span class="line">                    Thread.sleep((<span class="type">long</span>) (<span class="number">3</span> * Math.random()));</span><br><span class="line">                    System.out.println(<span class="string">"Client #"</span> + index + <span class="string">" waits on Barrier"</span>);</span><br><span class="line">                    barrier.waitOnBarrier();</span><br><span class="line">                    System.out.println(<span class="string">"Client #"</span> + index + <span class="string">" begins"</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                };</span><br><span class="line">                service.submit(task);</span><br><span class="line">            }</span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">            System.out.println(<span class="string">"all Barrier instances should wait the condition"</span>);</span><br><span class="line">            controlBarrier.removeBarrier();</span><br><span class="line">            service.shutdown();</span><br><span class="line">            service.awaitTermination(<span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">20000</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>这个例子创建了 <code>controlBarrier</code> 来设置栅栏和移除栅栏。 我们创建了 5 个线程，在此 Barrier 上等待。 最后移除栅栏后所有的线程才继续执行。</p><p>如果你开始不设置栅栏，所有的线程就不会阻塞住。</p><h4 id="双栅栏—DistributedDoubleBarrier"><a href="#双栅栏—DistributedDoubleBarrier" class="headerlink" title="双栅栏—DistributedDoubleBarrier"></a>双栅栏—DistributedDoubleBarrier</h4><p>双栅栏允许客户端在计算的开始和结束时同步。当足够的进程加入到双栅栏时，进程开始计算， 当计算完成时，离开栅栏。 双栅栏类是 <code>DistributedDoubleBarrier</code>。 构造函数为:</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">DistributedDoubleBarrier</span><span class="params">(CuratorFramework client,</span></span><br><span class="line"><span class="params">                                String barrierPath,</span></span><br><span class="line"><span class="params">                                <span class="type">int</span> memberQty)</span></span><br><span class="line">Creates the barrier abstraction. memberQty is the number of members in the barrier. When <span class="title function_">enter</span><span class="params">()</span> is called, it blocks until</span><br><span class="line">all members have entered. When <span class="title function_">leave</span><span class="params">()</span> is called, it blocks until all members have left.</span><br><span class="line"></span><br><span class="line">Parameters:</span><br><span class="line">client - the client</span><br><span class="line">barrierPath - path to use</span><br><span class="line">memberQty - the number of members in the barrier</span><br></pre></td></tr></tbody></table></figure><p><code>memberQty</code> 是成员数量，当 <code>enter()</code> 方法被调用时，成员被阻塞，直到所有的成员都调用了 <code>enter()</code>。 当 <code>leave()</code> 方法被调用时，它也阻塞调用线程，直到所有的成员都调用了 <code>leave()</code>。 就像百米赛跑比赛， 发令枪响， 所有的运动员开始跑，等所有的运动员跑过终点线，比赛才结束。</p><p>DistributedDoubleBarrier 会监控连接状态，当连接断掉时 <code>enter()</code> 和 <code>leave()</code> 方法会抛出异常。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedDoubleBarrierDemo</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">QTY</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PATH</span> <span class="operator">=</span> <span class="string">"/examples/barrier"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">TestingServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestingServer</span>()) {</span><br><span class="line">            <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">            client.start();</span><br><span class="line">            <span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(QTY);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; QTY; ++i) {</span><br><span class="line">                <span class="keyword">final</span> <span class="type">DistributedDoubleBarrier</span> <span class="variable">barrier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DistributedDoubleBarrier</span>(client, PATH, QTY);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> i;</span><br><span class="line">                Callable&lt;Void&gt; task = () -&gt; {</span><br><span class="line"></span><br><span class="line">                    Thread.sleep((<span class="type">long</span>) (<span class="number">3</span> * Math.random()));</span><br><span class="line">                    System.out.println(<span class="string">"Client #"</span> + index + <span class="string">" enters"</span>);</span><br><span class="line">                    barrier.enter();</span><br><span class="line">                    System.out.println(<span class="string">"Client #"</span> + index + <span class="string">" begins"</span>);</span><br><span class="line">                    Thread.sleep((<span class="type">long</span>) (<span class="number">3000</span> * Math.random()));</span><br><span class="line">                    barrier.leave();</span><br><span class="line">                    System.out.println(<span class="string">"Client #"</span> + index + <span class="string">" left"</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                };</span><br><span class="line">                service.submit(task);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            service.shutdown();</span><br><span class="line">            service.awaitTermination(<span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">            Thread.sleep(Integer.MAX_VALUE);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong>参考资料：</strong><br>《从 PAXOS 到 ZOOKEEPER 分布式一致性原理与实践》<br>《 跟着实例学习 ZooKeeper 的用法》博客系列</p></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/avatar1.webp" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/avatar.webp" title="头像" alt="头像"></a><div class="post-copyright__author_name">dong4j</div><div class="post-copyright__author_desc">岁月静好，诗酒趁年华🍺</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://blog.dong4j.site/posts/348a7282.html">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl(&quot;https://blog.dong4j.site/posts/348a7282.html&quot;)">Zookeeper Curator高级特性实战指南</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://cdn.dong4j.site/source/image/wechat-pay.webp" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/wechat-pay.webp" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.dong4j.site/source/image/alipay.webp" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/alipay.webp" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display:none"></div><div class="reward-link mode"><a class="reward-link-button" href="/wechat/"><i class="anzhiyufont anzhiyu-icon-plant-fill"></i>运营模式与责任</a></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://blog.dong4j.site/posts/348a7282.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=Zookeeper Curator高级特性实战指南&amp;url=https://blog.dong4j.site/posts/348a7282.html&amp;pic=https://api.dong4j.ink:1024/cover?t8hupgsj" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl(){var e=window.location.href,t=document.createElement("input");t.setAttribute("value",e),document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999),document.execCommand("copy"),document.body.removeChild(t)}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div><div class="share-link follow"><div class="share-button" id="post-share-url" title="订阅" onclick="icat.showFollowBox()"><i class="anzhiyufont anzhiyu-icon-rss"></i></div></div></div></div></div><div class="submit-box hidden"><form id="follow" action="https://api.follow.it/subscription-form/b29peEszNWYzK3FQbEw2dVlITEJMZ2pQRXh2dWRLVDE3SC96eFhRaGwwQWprcXpYYUp0NGFWemxVZllXRGU4Nm4yenNGSzNpV3l0Z1EwQzBXQU5xTG9pZWNzVCt5YWptWUt6TXppRXVXMXZxQTRZOGQ0NUVDRlRFOUYxSHMzMEJ8NmlodHY1VWhDQVZBaG8wM0pSV2pXSjdTNGRWS1o0RDVZbE11KzlEeWhuZz0=/8" method="post" target="_blank"><div class="follow-it-form-subscribe" style="position:relative"><div class="heading"><h5 style="font-weight:700;text-align:center">订阅本站文章：</h5></div><div class="input-field"><input type="email" id="email-input" name="email" placeholder="填入您的邮箱地址" spellcheck="false" oninput="validateEmail()"></div><div class="submit-button"><button type="submit" id="submit-button" onclick="ga(&quot;send&quot;,&quot;event&quot;,&quot;Form&quot;,&quot;Submit&quot;,&quot;Affiliate&quot;)" style="font-weight:700;font-size:14px;text-align:center" disabled="">确认订阅</button></div></div></form><style>#email-input{font-size:16px;font-weight:700;padding:10px;border:2px solid #ccc;border-radius:5px;width:100%;box-sizing:border-box}#email-input:focus{outline:0}#email-input.valid{border-color:green}#email-input.invalid{border-color:red}</style><script>function validateEmail(){var s=document.getElementById("email-input"),a=document.getElementById("submit-button"),e=s.value;/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?(a.disabled=!1,s.classList.add("valid"),s.classList.remove("invalid")):(a.disabled=!0,s.classList.add("invalid"),s.classList.remove("valid"))}</script></div><script>var icat={showFollowBox:function(){var s=document.querySelector(".submit-box");s.classList.contains("display")?s.classList.remove("display"):s.classList.add("display")}}</script><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.dong4j.site" target="_blank">司机带你开车</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__category-list"><a class="post-meta__box__categoryes" href="/categories/ai-%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/"><span class="categoryes-punctuation"><i class="anzhiyufont anzhiyu-icon-inbox"></i></span>AI:人工智能<span class="categoryesPageCount">9</span></a></div><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/zookeeper/"><span class="tags-punctuation"><i class="anzhiyufont anzhiyu-icon-tag"></i></span>Zookeeper<span class="tagsPageCount">6</span></a><a class="post-meta__box__tags" href="/tags/curator/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Curator<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>分布式锁<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/%E9%A2%86%E5%AF%BC%E9%80%89%E4%B8%BE/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>领导选举<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/%E7%BC%93%E5%AD%98/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>缓存<span class="tagsPageCount">1</span></a></div></div><div class="post_share"><div class="addtoany"><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_button_x"></a><a class="a2a_button_twitter"></a><a class="a2a_button_threads"></a><a class="a2a_button_wechat"></a><a class="a2a_button_sina_weibo"></a><a class="a2a_button_pocket"></a><a class="a2a_button_instapaper"></a><a class="a2a_button_email"></a><a class="a2a_button_sms"></a><a class="a2a_dd" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.addtoany.com/share"></a></div></div><script async="" src="https://static.addtoany.com/menu/page.js"></script><script>var a2a_config=a2a_config||{};a2a_config.templates=a2a_config.templates||{},a2a_config.templates.email={subject:"来自 dong4j 的分享: ${title}",body:"一篇有意思的博文:\n${link}"},a2a_config.templates.sms={body:"给你分享一篇有意思的博客:\n${title}\n${link}"}</script></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/5567a46d.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?iltvmh2x" onerror="onerror=null,src=&quot;/img/404.webp&quot;" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Redis高效处理：字符串、哈希、列表和有序集合</div></div></a></div><div class="next-post pull-right"><a href="/posts/f1119903.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?bdil40zs" onerror="onerror=null,src=&quot;/img/404.webp&quot;" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">掌握这6种算法，成为负载均衡高手！</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size:1.5rem;margin-right:4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/posts/8872e19a.html" title="动态调整日志：JMX与Zookeeper的强大组合"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?c481qs3g" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2018-09-14</div><div class="title">动态调整日志：JMX与Zookeeper的强大组合</div></div></a></div><div><a href="/posts/ffbf019e.html" title="zheng 框架解析 (二)：从环境搭建到部署实战"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?ynrjsqrs" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2017-07-06</div><div class="title">zheng 框架解析 (二)：从环境搭建到部署实战</div></div></a></div><div><a href="/posts/508e9afc.html" title="深入解析Zheng框架：搭建与部署实战指南"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?z4ibxu2p" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2017-07-02</div><div class="title">深入解析Zheng框架：搭建与部署实战指南</div></div></a></div><div><a href="/posts/ffa1ef45.html" title="ZooKeeper配置中心：简化你的开发部署过程"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?fzp9ki5u" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2017-03-29</div><div class="title">ZooKeeper配置中心：简化你的开发部署过程</div></div></a></div><div><a href="/posts/5f2cc770.html" title="Zookeeper 概述：核心概念与应用场景"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?0qklstj8" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2016-09-24</div><div class="title">Zookeeper 概述：核心概念与应用场景</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)" rel="external nofollow noreferrer">匿名评论</a><a href="/privacy" style="margin-left:4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/avatar.webp" onerror="this.onerror=null,this.src=&quot;/img/friend_404.gif&quot;" alt="avatar"><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/coding.gif" alt="status"></div></div><div class="author-info__description"><div style="line-height:1.38;margin:.6rem 0;text-align:justify;color:rgba(255,255,255,.8)">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:.6rem 0;text-align:justify;color:rgba(255,255,255,.8)">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">dong4j</h1><div class="author-info__desc">岁月静好，诗酒趁年华 🍺</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/dong4j" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fa-brands fa-github faa-tada"></i></a><a class="social-icon faa-parent animated-hover" href="mailto:dong4j@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fa-solid fa-at faa-tada"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content"><div style="display:flex;align-items:center"><span>👋🏻 Hi，欢迎来到我的博客~</span><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/mario.gif" width="40"></div><span>❓ 如有问题欢迎评论区交流！🎉</span><br><span>😫 页面异常？试试<kbd>Ctrl</kbd>+<kbd>F5</kbd>🙉</span><br><span>📧 如需联系：<a href="mailto:dong4j@gmail.com" rel="external nofollow noreferrer"><b>发邮件给我吧 🚀</b></a></span><div id="welcome-info"></div><a id="my-card-info-btn" href="/subscribe/" data-pjax-state=""><i class="anzhiyufont anzhiyu-icon-rss"></i><span>订阅本站</span></a></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background:url(https://cdn.dong4j.site/source/image/63c02edf44033.webp) center center/100% no-repeat"></div><div class="back face" style="background:url(https://cdn.dong4j.site/source/image/645fa415e8694.webp) center center/100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Curator-%E7%9A%84%E5%9F%BA%E6%9C%AC-Api"><span class="toc-number">1.</span> <span class="toc-text">Curator 的基本 Api</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BC%9A%E8%AF%9D"><span class="toc-number">1.1.</span> <span class="toc-text">创建会话</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BD%BF%E7%94%A8%E9%9D%99%E6%80%81%E5%B7%A5%E7%A8%8B%E6%96%B9%E6%B3%95%E5%88%9B%E5%BB%BA%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.使用静态工程方法创建客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8-Fluent-%E9%A3%8E%E6%A0%BC%E7%9A%84-Api-%E5%88%9B%E5%BB%BA%E4%BC%9A%E8%AF%9D"><span class="toc-number">1.1.2.</span> <span class="toc-text">2.使用 Fluent 风格的 Api 创建会话</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%88%9B%E5%BB%BA%E5%8C%85%E5%90%AB%E9%9A%94%E7%A6%BB%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E7%9A%84%E4%BC%9A%E8%AF%9D"><span class="toc-number">1.1.3.</span> <span class="toc-text">3.创建包含隔离命名空间的会话</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.2.</span> <span class="toc-text">启动客户端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E8%8A%82%E7%82%B9%E6%93%8D%E4%BD%9C"><span class="toc-number">1.3.</span> <span class="toc-text">数据节点操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E8%8A%82%E7%82%B9"><span class="toc-number">1.3.1.</span> <span class="toc-text">创建数据节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE%E8%8A%82%E7%82%B9"><span class="toc-number">1.3.2.</span> <span class="toc-text">删除数据节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE%E8%8A%82%E7%82%B9%E6%95%B0%E6%8D%AE"><span class="toc-number">1.3.3.</span> <span class="toc-text">读取数据节点数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E8%8A%82%E7%82%B9%E6%95%B0%E6%8D%AE"><span class="toc-number">1.3.4.</span> <span class="toc-text">更新数据节点数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E8%8A%82%E7%82%B9%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="toc-number">1.3.5.</span> <span class="toc-text">检查节点是否存在</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%9F%90%E4%B8%AA%E8%8A%82%E7%82%B9%E7%9A%84%E6%89%80%E6%9C%89%E5%AD%90%E8%8A%82%E7%82%B9%E8%B7%AF%E5%BE%84"><span class="toc-number">1.3.6.</span> <span class="toc-text">获取某个节点的所有子节点路径</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.3.7.</span> <span class="toc-text">事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.3.8.</span> <span class="toc-text">异步接口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Curator-%E9%A3%9F%E8%B0%B1-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7"><span class="toc-number">1.4.</span> <span class="toc-text">Curator 食谱 (高级特性)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98"><span class="toc-number">1.4.1.</span> <span class="toc-text">缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Path-Cache"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">Path Cache</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Node-Cache"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">Node Cache</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Tree-Cache"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">Tree Cache</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Leader-%E9%80%89%E4%B8%BE"><span class="toc-number">1.4.2.</span> <span class="toc-text">Leader 选举</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LeaderLatch"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">LeaderLatch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LeaderSelector"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">LeaderSelector</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">1.4.3.</span> <span class="toc-text">分布式锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E9%87%8D%E5%85%A5%E5%85%B1%E4%BA%AB%E9%94%81%E2%80%94Shared-Reentrant-Lock"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">可重入共享锁—Shared Reentrant Lock</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%85%A5%E5%85%B1%E4%BA%AB%E9%94%81%E2%80%94Shared-Lock"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">不可重入共享锁—Shared Lock</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E9%87%8D%E5%85%A5%E8%AF%BB%E5%86%99%E9%94%81%E2%80%94Shared-Reentrant-Read-Write-Lock"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">可重入读写锁—Shared Reentrant Read Write Lock</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E9%87%8F%E2%80%94Shared-Semaphore"><span class="toc-number">1.4.3.4.</span> <span class="toc-text">信号量—Shared Semaphore</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E5%85%B1%E4%BA%AB%E9%94%81%E5%AF%B9%E8%B1%A1-%E2%80%94Multi-Shared-Lock"><span class="toc-number">1.4.3.5.</span> <span class="toc-text">多共享锁对象 —Multi Shared Lock</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E6%95%B0%E5%99%A8"><span class="toc-number">1.4.4.</span> <span class="toc-text">分布式计数器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F-int-%E8%AE%A1%E6%95%B0%E5%99%A8%E2%80%94SharedCount"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">分布式 int 计数器—SharedCount</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F-long-%E8%AE%A1%E6%95%B0%E5%99%A8%E2%80%94DistributedAtomicLong"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">分布式 long 计数器—DistributedAtomicLong</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%98%9F%E5%88%97"><span class="toc-number">1.4.5.</span> <span class="toc-text">分布式队列</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%98%9F%E5%88%97%E2%80%94DistributedQueue"><span class="toc-number">1.4.5.1.</span> <span class="toc-text">分布式队列—DistributedQueue</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%A6-Id-%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E9%98%9F%E5%88%97%E2%80%94DistributedIdQueue"><span class="toc-number">1.4.5.2.</span> <span class="toc-text">带 Id 的分布式队列—DistributedIdQueue</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%85%88%E7%BA%A7%E5%88%86%E5%B8%83%E5%BC%8F%E9%98%9F%E5%88%97%E2%80%94DistributedPriorityQueue"><span class="toc-number">1.4.5.3.</span> <span class="toc-text">优先级分布式队列—DistributedPriorityQueue</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E2%80%94DistributedDelayQueue"><span class="toc-number">1.4.5.4.</span> <span class="toc-text">分布式延迟队列—DistributedDelayQueue</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SimpleDistributedQueue"><span class="toc-number">1.4.5.5.</span> <span class="toc-text">SimpleDistributedQueue</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E5%B1%8F%E9%9A%9C%E2%80%94Barrier"><span class="toc-number">1.4.6.</span> <span class="toc-text">分布式屏障—Barrier</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DistributedBarrier"><span class="toc-number">1.4.6.1.</span> <span class="toc-text">DistributedBarrier</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8C%E6%A0%85%E6%A0%8F%E2%80%94DistributedDoubleBarrier"><span class="toc-number">1.4.6.2.</span> <span class="toc-text">双栅栏—DistributedDoubleBarrier</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/b902d8fd.html" title="从零开始开发一个 Hexo 插件：以 hexo-plugin-llmstxt 为例"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?lbi2q79v" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" alt="从零开始开发一个 Hexo 插件：以 hexo-plugin-llmstxt 为例"></a><div class="content"><a class="title" href="/posts/b902d8fd.html" title="从零开始开发一个 Hexo 插件：以 hexo-plugin-llmstxt 为例">从零开始开发一个 Hexo 插件：以 hexo-plugin-llmstxt 为例</a><time datetime="2025-01-30T03:34:10.000Z" title="发表于 2025-01-30 11:34:10">2025-01-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/bb4018e9.html" title="使用 Node.js 开发数字名片并集成 Chat 服务"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20250115192416_nhXEcB8o.webp" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" alt="使用 Node.js 开发数字名片并集成 Chat 服务"></a><div class="content"><a class="title" href="/posts/bb4018e9.html" title="使用 Node.js 开发数字名片并集成 Chat 服务">使用 Node.js 开发数字名片并集成 Chat 服务</a><time datetime="2025-01-15T02:47:34.000Z" title="发表于 2025-01-15 10:47:34">2025-01-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/621bb677.html" title="从零开始开发 VSCode 插件：从 Hello World 到图片处理工具"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20250114004440_j6VHuwA4.webp" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" alt="从零开始开发 VSCode 插件：从 Hello World 到图片处理工具"></a><div class="content"><a class="title" href="/posts/621bb677.html" title="从零开始开发 VSCode 插件：从 Hello World 到图片处理工具">从零开始开发 VSCode 插件：从 Hello World 到图片处理工具</a><time datetime="2025-01-13T15:54:10.000Z" title="发表于 2025-01-13 23:54:10">2025-01-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/af11d9f5.html" title="Chrome 插件开发实战：从零开始开发一个图片上传工具"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20250113235017_acCTt6s4.webp" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" alt="Chrome 插件开发实战：从零开始开发一个图片上传工具"></a><div class="content"><a class="title" href="/posts/af11d9f5.html" title="Chrome 插件开发实战：从零开始开发一个图片上传工具">Chrome 插件开发实战：从零开始开发一个图片上传工具</a><time datetime="2025-01-10T16:48:57.000Z" title="发表于 2025-01-11 00:48:57">2025-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f5478013.html" title="利用 AI 对博客文章进行智能分类"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20250103004028_E1ep6rty.webp" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" alt="利用 AI 对博客文章进行智能分类"></a><div class="content"><a class="title" href="/posts/f5478013.html" title="利用 AI 对博客文章进行智能分类">利用 AI 对博客文章进行智能分类</a><time datetime="2024-12-31T16:00:00.000Z" title="发表于 2025-01-01 00:00:00">2025-01-01</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="mailto:dong4j@gmail.com" rel="external nofollow noreferrer" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://weibo.com/u/1884084142" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.facebook.com/dsj.array" title="facebook"><i class="anzhiyufont anzhiyu-icon-facebook1"></i></a><a class="deal_link" href="/atom.xml" title="RSS"><i class="anzhiyufont anzhiyu-icon-rss"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0,500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/avatar.webp" size="50px"><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dong4j" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://space.bilibili.com/1835978167" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://v.douyin.com/iUqoRYwb/" title="抖音"><i class="anzhiyufont anzhiyu-icon-tiktok"></i></a><a class="deal_link" href="/copyright" title="CC"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i></a></div><div id="workboard"><img class="workSituationImg boardsign" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.0.4/img/badge/安知鱼-上班摸鱼中.svg" alt="距离月入25k也就还差一个大佬带我~" title="距离月入25k也就还差一个大佬带我~"><div id="runtimeTextTip"></div></div><div id="anzhiyu-footer"><div class="footer-group"><div class="footer-title">服务</div><div class="footer-links"><a class="footer-item" title="51la统计" target="_blank" rel="noopener external nofollow noreferrer" href="https://v6.51.la/">51la统计</a><a class="footer-item" title="十年之约" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.foreverblog.cn/">十年之约</a><a class="footer-item" title="开往" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.travellings.cn/go.html">开往</a><a class="footer-item" title="服务状态" target="_blank" rel="noopener external nofollow noreferrer" href="https://uptime.dong4j.ink:1024/status/services">服务状态</a></div></div><div class="footer-group"><div class="footer-title">项目</div><div class="footer-links"><a class="footer-item" title="Watt.Stack" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/watt-stack">Watt.Stack</a><a class="footer-item" title="MIK" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dong4j/markdown-image-kit">MIK</a><a class="footer-item" title="macOS.dev" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dong4j/macOS-dev">macOS.dev</a><a class="footer-item" title="更多" target="_blank" rel="noopener external nofollow noreferrer" href="https://project.dong4j.ink:1024/">更多</a></div></div><div class="footer-group"><div class="footer-title">导航</div><div class="footer-links"><a class="footer-item" title="我的装备" href="/equipment/">我的装备</a><a class="footer-item" title="即刻短文" href="/essay/">即刻短文</a><a class="footer-item" title="友链文章" href="/fcircle/">友链文章</a><a class="footer-item" title="留言板" href="/comments/">留言板</a></div></div><div class="footer-group"><div class="footer-title">协议</div><div class="footer-links"><a class="footer-item" title="隐私协议" href="/privacy/">隐私协议</a><a class="footer-item" title="Cookies" href="/cookies/">Cookies</a><a class="footer-item" title="版权协议" href="/copyright/">版权协议</a><a class="footer-item" title="更新日志" href="/update/">更新日志</a></div></div><div class="footer-group"><div class="footer-title-group"><div class="footer-title">友链</div><a class="random-friends-btn" id="footer-random-friends-btn" href="javascript:addFriendLinksInFooter();" rel="external nofollow noreferrer" title="换一批友情链接"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i></a></div><div class="footer-links" id="friend-links-in-footer"></div></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title="博客框架为Hexo_v5.4.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo_v5.4.0"></a><a class="github-badge" target="_blank" href="https://blog.anheyu.com/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站使用AnZhiYu主题" title="本站使用AnZhiYu主题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.9/img/Theme-AnZhiYu-2E67D3.svg" alt="本站使用AnZhiYu主题"></a><a class="github-badge" target="_blank" href="https://www.dogecloud.com/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站使用多吉云为静态资源提供CDN加速" title="本站使用多吉云为静态资源提供CDN加速"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/CDN-多吉云-3693F3.svg" alt="本站使用多吉云为静态资源提供CDN加速"></a><a class="github-badge" target="_blank" href="https://github.com/dong4j" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站项目由Github托管" title="本站项目由Github托管"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Source-Github.svg" alt="本站项目由Github托管"></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/Copyright-BY-NC-SA.svg" alt="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div><div id="footer-bar"><div class="footer-bar-links"><footer-bar-left><div id="footer-bar-tips"><div class="copyright" style="display:flex;align-items:center;gap:10px">©2013 - 2025 By <a class="footer-bar-link" href="/" title="dong4j" target="_blank">dong4j</a><span class="indicator" id="indicator" style="display:inline-block;width:8px;height:8px;border-radius:50%;background-color:green;margin-left:0;animation:subtle-breathing 1.2s infinite;box-shadow:0 0 5px rgba(255,0,0,.8)"></span><span>在线人数:</span><span id="online_user" style="font-size:1em;font-weight:700">1</span></div></div><div id="footer-type-tips"></div></footer-bar-left><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener external nofollow noreferrer" href="https://beian.miit.gov.cn/" title="蜀ICP备2025119258号">蜀ICP备2025119258号</a><a class="footer-bar-link cc" href="/copyright" title="cc协议"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-by-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nc-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nd-line"></i></a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">240</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">1088</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">10</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" rel="external nofollow noreferrer" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://home.dong4j.site" title="个人主页"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/homepage.webp" alt="个人主页"><span class="back-menu-item-text">个人主页</span></a><a class="back-menu-item" href="https://blog.dong4j.site" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/blog.webp" alt="博客"><span class="back-menu-item-text">博客</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://resume.dong4j.site" title="简历"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/resume.webp" alt="简历"><span class="back-menu-item-text">简历</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://npx-card.dong4j.site" title="npx-card"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/npx-card.webp" alt="npx-card"><span class="back-menu-item-text">npx-card</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/watt-stack" title="Watt.Stack"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/watt.webp" alt="Watt.Stack"><span class="back-menu-item-text">Watt.Stack</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dong4j/markdown-image-kit" title="MIK"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/mik.webp" alt="MIK"><span class="back-menu-item-text">MIK</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dong4j/macOS-dev" title="macOS.dev"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/mac.webp" alt="macOS.dev"><span class="back-menu-item-text">macOS.dev</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://project.dong4j.site/" title="更多"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/project.webp" alt="更多"><span class="back-menu-item-text">更多</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">服务</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://uptime.dong4j.ink:1024/status/services" title="服务状态"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/uptime-kuma.svg" alt="服务状态"><span class="back-menu-item-text">服务状态</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://nezha.dong4j.ink:1024?f=blog" title="服务面板"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/nezha.webp" alt="服务面板"><span class="back-menu-item-text">服务面板</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://nav.dong4j.ink:1024/" title="导航页"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/nav.webp" alt="导航页"><span class="back-menu-item-text">导航页</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://umami.dong4j.ink:1024/share/V7Rat8DdVw4npjl2/blog.dong4j.site" title="Umami"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/umami.webp" alt="Umami"><span class="back-menu-item-text">Umami</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://muselink.cc/dong4j 👈这是我的MuseLink数字名片！" title="数字名片"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/muse.lin.webp" alt="数字名片"><span class="back-menu-item-text">数字名片</span></a><a class="back-menu-item" href="/ai/deepseek-r1-webgpu/" title="DeepSeek"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/deepseek.webp" alt="DeepSeek"><span class="back-menu-item-text">DeepSeek</span></a><a class="back-menu-item" href="/ai/rmbg/playground/" title="RMBG"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/rmbg.webp" alt="RMBG"><span class="back-menu-item-text">RMBG</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="http://chat.dong4j.ink:1024/chat" title="Mini-Chat"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/emoji1.webp" alt="Mini-Chat"><span class="back-menu-item-text">Mini-Chat</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size:.9em"></i><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size:.9em"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/messages/"><i class="fa fa-comments faa-tada"></i><span> 最新评论</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="fa fa-line-chart faa-tada"></i><span> 统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size:.9em"></i><span> 我的装备</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size:.9em"></i><span> 小空调</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/memos/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size:.9em"></i><span> 备忘录</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/todolist/"><i class="fa-solid fa-map faa-tada"></i><span> 折腾清单</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/stars/"><i class="fa-brands fa-github faa-tada"></i><span> Star 清单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/java/" style="font-size:.88rem;color:#9b7e27;font-weight:500;color:var(--anzhiyu-lighttext)">Java<sup>48</sup></a><a href="/tags/final/" style="font-size:.88rem;color:#4e5ca8">final<sup>2</sup></a><a href="/tags/finalize/" style="font-size:.88rem;color:#63728c">finalize<sup>1</sup></a><a href="/tags/finally/" style="font-size:.88rem;color:#0b49c5">finally<sup>2</sup></a><a href="/tags/new%E5%85%B3%E9%94%AE%E5%AD%97/" style="font-size:.88rem;color:#384b4d">new关键字<sup>1</sup></a><a href="/tags/static/" style="font-size:.88rem;color:#74528f">static<sup>1</sup></a><a href="/tags/super/" style="font-size:.88rem;color:#05322e">super<sup>2</sup></a><a href="/tags/this/" style="font-size:.88rem;color:#2f931c">this<sup>1</sup></a><a href="/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/" style="font-size:.88rem;color:#1c4e9b">二进制<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" style="font-size:.88rem;color:#c0aba8">数据类型<sup>4</sup></a><a href="/tags/%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95/" style="font-size:.88rem;color:#b55038">构造方法<sup>1</sup></a><a href="/tags/%E6%BA%A2%E5%87%BA/" style="font-size:.88rem;color:#4bb108">溢出<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size:.88rem;color:#7c8f52">算法<sup>1</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E5%AE%9E%E8%B7%B5/" style="font-size:.88rem;color:#b24ec1">编程实践<sup>2</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A8%8B%E5%BA%8F/" style="font-size:.88rem;color:#c11f0b">计算机程序<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%AF%AD%E8%A8%80/" style="font-size:.88rem;color:#bc5f25">计算机语言<sup>1</sup></a><a href="/tags/%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6/" style="font-size:.88rem;color:#879abe">访问控制<sup>1</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6/" style="font-size:.88rem;color:#153344">软件<sup>1</sup></a><a href="/tags/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/" style="font-size:.88rem;color:#9ab688">错误处理<sup>2</sup></a><a href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" style="font-size:.88rem;color:#4d09a0">面向对象<sup>6</sup></a></div></div><hr></div></div><div id="keyboard-tips"><div class="keyboardTitle">博客快捷键</div><div class="keybordList"><div class="keybordItem"><div class="keyGroup"><div class="key">shift K</div></div><div class="keyContent"><div class="content">关闭快捷键功能</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift A</div></div><div class="keyContent"><div class="content">打开/关闭中控台</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift M</div></div><div class="keyContent"><div class="content">播放/暂停音乐</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift D</div></div><div class="keyContent"><div class="content">深色/浅色显示模式</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift S</div></div><div class="keyContent"><div class="content">站内搜索</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift R</div></div><div class="keyContent"><div class="content">随机访问</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift H</div></div><div class="keyContent"><div class="content">返回首页</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift F</div></div><div class="keyContent"><div class="content">友链鱼塘</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift L</div></div><div class="keyContent"><div class="content">友链页面</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift P</div></div><div class="keyContent"><div class="content">关于本站</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift I</div></div><div class="keyContent"><div class="content">原版/本站右键菜单</div></div></div></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="share" type="button" title="分享链接" onclick="share()"><i class="fas fa-share-nodes"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="anzhiyufont anzhiyu-icon-comment-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" rel="external nofollow noreferrer" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="anzhiyu.scrollToDest(document.body.scrollHeight,500)"><i class="anzhiyufont anzhiyu-icon-arrow-down"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size:1rem"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display:none"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://cdn.cbd.int/pangu@4.0.7/dist/browser/pangu.min.js").then(()=>{pangu.autoSpacingPage()})}function panguInit(){panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><script>var HoldLog=console.log;console.log=function(){};let now1=new Date;queueMicrotask(()=>{function o(){HoldLog.apply(console,arguments)}var c=new Date("6/28/2018 00:00:00"),c=(now1.setTime(now1.getTime()+250),(now1-c)/1e3/60/60/24),c=["Hi there 👋，I'm dong4j, Welcome to my blog","岁月静好，诗酒趁年华🍺",`
        
      +========================================================+
      |  ██████╗  ██████╗ ███╗   ██╗ ██████╗ ██╗  ██╗     ██╗  |
      |  ██╔══██╗██╔═══██╗████╗  ██║██╔════╝ ██║  ██║     ██║  |
      |  ██║  ██║██║   ██║██╔██╗ ██║██║  ███╗███████║     ██║  |
      |  ██║  ██║██║   ██║██║╚██╗██║██║   ██║╚════██║██   ██║  |
      |  ██████╔╝╚██████╔╝██║ ╚████║╚██████╔╝     ██║╚█████╔╝  |
      |  ╚═════╝  ╚═════╝ ╚═╝  ╚═══╝ ╚═════╝      ╚═╝ ╚════╝   |
      +========================================================+
        
        `,"已上线",Math.floor(c),"天","Use 「npx dong4j」 and find me."],e=["NCC2-036","调用前置摄像头拍照成功，识别为【绝顶大佬】.","Photo captured: ","🤪"];setTimeout(o.bind(console,`
%c${c[0]} %c ${c[1]} %c ${c[2]} %c${c[3]}%c ${c[4]}%c ${c[5]}

%c ${c[6]}
`,"color:#425AEF","","color:#425AEF","color:#425AEF","","color:#425AEF","")),setTimeout(o.bind(console,`%c ${e[0]} %c ${e[1]} %c 
${e[2]} %c
${e[3]}
`,"color:white; background-color:#4fd953","","",'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%')),setTimeout(o.bind(console,"%c WELCOME %c 你好，绝顶大佬.","color:white; background-color:#4f90d9","")),setTimeout(console.warn.bind(console,"%c ⚡ Powered by 安知鱼 %c 你正在访问 dong4j 的博客.","color:white; background-color:#f0ad4e","")),setTimeout(o.bind(console,"%c W23-12 %c 你已打开控制台.","color:white; background-color:#4f90d9","")),setTimeout(console.warn.bind(console,"%c S013-782 %c 你现在正处于监控中.","color:white; background-color:#d9534f",""))})</script><script async="" src="/anzhiyu/random.js"></script><script async="">(()=>{var n,o,r,a,i,e=new Date("6/28/2018 00:00:00"),l=new Date;setInterval(()=>{var t;if(l=new Date,i=l.getHours(),t=(l-e)/1e3/60/60/24,n=Math.floor(t),t=(l-e)/1e3/60/60-24*n,o=Math.floor(t),1==String(o).length&&(o="0"+o),t=(l-e)/1e3/60-1440*n-60*o,r=Math.floor(t),1==String(r).length&&(r="0"+r),t=(l-e)/1e3-86400*n-3600*o-60*r,a=Math.round(t),1==String(a).length&&(a="0"+a),document.getElementById("footer")){let e="";e=(i<18&&9<=i||null!=(t=document.querySelector("#workboard .workSituationImg"))&&(t.src="https://npm.elemecdn.com/anzhiyu-blog@2.0.4/img/badge/安知鱼-下班啦.svg",t.title="下班了就该开开心心的玩耍，嘿嘿~",t.alt="下班了就该开开心心的玩耍，嘿嘿~"),`本站居然运行了 ${n} 天<span id='runtime'> ${o} 小时 ${r} 分 ${a} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`),document.getElementById("runtimeTextTip")&&(document.getElementById("runtimeTextTip").innerHTML=e)}},1e3)})()</script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(()=>{let t=document.querySelectorAll("#article-container .mermaid-wrap");if(0!==t.length){let e=()=>{window.loadMermaid=!0;let a="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";Array.from(t).forEach((e,t)=>{let d=e.firstElementChild;e="%%{init:{ 'theme':'"+a+"'}}%%\n"+d.textContent;let n=mermaid.render("mermaid-"+t,e);"string"==typeof n?(t=n,d.insertAdjacentHTML("afterend",t)):n.then(({svg:e})=>{d.insertAdjacentHTML("afterend",e)})})};var d=()=>{window.loadMermaid?e():getScript("https://cdn.cbd.int/mermaid@10.2.4/dist/mermaid.min.js").then(e)};anzhiyu.addGlobalFn("themeChange",e,"mermaid"),window.pjax?d():document.addEventListener("DOMContentLoaded",d)}})()</script><script>(()=>{let t=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"https://twikoo.dong4j.ink:1024",region:"",onCommentLoaded:()=>{anzhiyu.loadLightbox(document.querySelectorAll("#twikoo .tk-content img:not(.tk-owo-emotion)"))}},null))};var o=()=>{"object"==typeof twikoo?setTimeout(n,0):getScript("https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js").then(n)};let e=()=>{let o=document.getElementById("twikoo-count");o&&twikoo.getCommentsCount({envId:"https://twikoo.dong4j.ink:1024",region:"",urls:[window.location.pathname],includeReply:!1}).then(t=>{o.textContent=t[0].count}).catch(t=>{console.error(t)})},n=()=>{t(),GLOBAL_CONFIG_SITE.isPost&&e()};o()})()</script><input type="hidden" name="page-type" id="page-type" value="post"><script async="" src="/js/anzhiyu/comment_barrage.js"></script></div><script>window.addEventListener("load",()=>{let t=e=>e=""!==e&&150<(e=(e=(e=(e=e.replace(/<img.*?src="(.*?)"?[^\>]+>/gi,"[图片]")).replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi,"[链接]")).replace(/<pre><code>.*?<\/pre>/gi,"[代码]")).replace(/<[^>]+>/g,"")).length?e.substring(0,150)+"...":e,n=t=>{let n="";if(t.length)for(let e=0;e<t.length;e++)n=(n=(n+="<div class='aside-list-item'>")+`<a href='${t[e].url}' class='thumbnail'><img data-lazy-src='${t[e].avatar}' alt='${t[e].nick}'><div class='name'><span>${t[e].nick} </span></div></a>`)+`<div class='content'>
        <a class='comment' href='${t[e].url}' title='${t[e].content}'>${t[e].content}</a>
        <time datetime="${t[e].date}">${anzhiyu.diffDate(t[e].date,!0)}</time></div>
        </div>`;else n+="没有评论";var e=document.querySelector("#card-newest-comments .aside-list");e&&(e.innerHTML=n),window.lazyLoadInstance&&window.lazyLoadInstance.update(),window.pjax&&window.pjax.refresh(e)};var e=()=>{var e;document.querySelector("#card-newest-comments .aside-list")&&((e=saveToLocal.get("twikoo-newest-comments"))?n(JSON.parse(e)):(e=()=>{twikoo.getRecentComments({envId:"https://twikoo.dong4j.ink:1024",region:"",pageSize:6,includeReply:!0}).then(function(e){e=e.map(e=>({content:t(e.comment),avatar:e.avatar,nick:e.nick,url:e.url+"#"+e.id,date:new Date(e.created).toISOString()}));saveToLocal.set("twikoo-newest-comments",JSON.stringify(e),10/1440),n(e)}).catch(function(e){document.querySelector("#card-newest-comments .aside-list").textContent="无法获取评论，请确认相关配置是否正确"})},"object"==typeof twikoo?e():getScript("https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js").then(e)))};e(),document.addEventListener("pjax:complete",e)})</script><script>var visitorMail="996@icu.com"</script><script async="" data-pjax="" src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.dong4j.site/source/static/subscribe.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://cdn.dong4j.site/source/static/card-widget-today.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://cdn.dong4j.site/source/static/card-widget-calendar.css" media="print" onload="this.media=&quot;all&quot;"><script async="" data-pjax="" src="https://cdn.dong4j.site/source/static/automatic-redirection.js"></script><script src="https://cdn.dong4j.site/source/static/card-widget-welcome.js"></script><script async="" data-pjax="" src="https://cdn.dong4j.site/source/static/card-widget-comments.js"></script><script async="" data-pjax="" src="https://cdn.dong4j.site/source/static/card-widget-today.js"></script><script src="https://cdn.dong4j.site/source/static/card-widget-countdown.js"></script><script src="https://cdn.dong4j.site/source/static/card-widget-calendar.js"></script><script async="" data-pjax="" src="https://open.lightxi.com/unpkg/chinese-lunar@0.1.4/lib/chinese-lunar.js"></script><script async="" data-pjax="" src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script src="https://cdn.dong4j.site/source/static/custom.js"></script><script src="https://cdn.dong4j.site/source/static/geoip2-check.js"></script><script defer="" id="fluttering_ribbon" mobile="false" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-show-text" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="永不言败,勇往直前,砥砺前行,自强不息,笃行致远,厚德载物,持之以恒,奋发有为,志在四方,拼搏进取,实事求是，为人民服务,勤劳致富，共奔小康,爱国、创新、包容、厚德,敬业乐群，诚信友善,自强不息，厚德载物,以人为本，全面协调可持续发展,建设生态文明，构建和谐社会,坚持改革开放，推动科学发展,立党为公，执政为民,实现中华民族伟大复兴的中国梦" data-fontsize="15px" data-random="true" async=""></script><script src="//code.tidio.co/14aqpkwnauu3r5ngcmspfxwelvattym5.js" async=""></script><script>(()=>{{let i=!1,o=()=>{window.tidioChatApi.hide(),i=!1,document.body.style.position="relative",document.documentElement.style.overflow="auto"};var t=()=>{window.tidioChatApi.hide(),window.tidioChatApi.on("close",o)};window.tidioChatApi?window.tidioChatApi.on("ready",t):document.addEventListener("tidioChat-ready",t),window.chatBtnFn=()=>{window.tidioChatApi&&(i?o():(window.tidioChatApi.open(),window.tidioChatApi.show(),i=!0))}}})()</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media=&quot;all&quot;"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors=['meta[property="og:image"]','meta[property="og:title"]','meta[property="og:url"]','meta[property="og:type"]','meta[property="og:site_name"]','meta[property="og:description"]',"head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:send",function(){if(anzhiyu.removeGlobalFnEvent("pjax"),anzhiyu.removeGlobalFnEvent("themeChange"),document.getElementById("rightside").classList.remove("rightside-show"),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();var e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")}),document.addEventListener("pjax:complete",function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach(e=>{let t=document.createElement("script");var a=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(a)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll()}),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script><script async="" data-pjax="" data-prefix="busuanzi_value" src="https://cdn.dong4j.site/source/static/busuanzi.self.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div><script data-pjax="" src="https://cdn.jsdelivr.net/gh/barry-flynn/hexo-github-calendar/hexo_githubcalendar.js"></script><script data-pjax="">function GithubCalendarConfig(){var t=document.getElementById("recent-posts");t&&"/"==location.pathname&&(console.log("已挂载hexo-github-calendar https://github.com/Barry-Flynn/hexo-github-calendar"),t.insertAdjacentHTML("afterbegin",'<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><div id="github_loading" style="width:10%;height:100%;margin:0 auto;display: block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg></div><div id="github_container"></div></div>')),GithubCalendar("https://github-calendar.dong4j.ink:1024/api?user=dong4j",["#ebedf0","#a2f7af","#6ce480","#54ad63","#469252","#31753c","#1f5f2a","#13531f","#084111","#032b09","#000000"],"dong4j")}document.getElementById("recent-posts")&&GithubCalendarConfig()</script><style>#github_container{min-height:280px}@media screen and (max-width:650px){#github_container{min-height:0}}</style><style></style></body></html>