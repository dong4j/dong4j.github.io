<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>Google Dapper：揭秘分布式跟踪系统的秘密 | 司机带你开车</title><meta name="keywords" content="Dapper,分布式跟踪系统,Google,性能监控,采样率"><meta name="author" content="dong4j"><meta name="copyright" content="dong4j"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="Google Dapper：揭秘分布式跟踪系统的秘密"><meta name="application-name" content="Google Dapper：揭秘分布式跟踪系统的秘密"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="Google Dapper：揭秘分布式跟踪系统的秘密"><meta property="og:url" content="https://blog.dong4j.site/posts/a69881a6.html"><meta property="og:site_name" content="司机带你开车"><meta property="og:description" content="Dapper 是一个 Google 生产环境下的分布式跟踪系统，用于收集和呈现复杂分布式系统的行为信息。它通过低损耗、应用透明和大范围部署满足需求。Dapper 设计之初参考了 Magpie 和 X-Trace 等分布式系统的理念，并通过采样率的使用和代码植入限制在一小部分公共库的改造上实现了成功应"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://api.dong4j.ink:1024/cover?3cu41jed"><meta property="article:author" content="dong4j"><meta property="article:tag" content="dong4j, Java, Python, Golang, HomeLab, SpringBoot, 架构"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://api.dong4j.ink:1024/cover?3cu41jed"><meta name="description" content="Dapper 是一个 Google 生产环境下的分布式跟踪系统，用于收集和呈现复杂分布式系统的行为信息。它通过低损耗、应用透明和大范围部署满足需求。Dapper 设计之初参考了 Magpie 和 X-Trace 等分布式系统的理念，并通过采样率的使用和代码植入限制在一小部分公共库的改造上实现了成功应"><link rel="shortcut icon" href="https://cdn.dong4j.site/source/image/favicon.ico"><link rel="canonical" href="https://blog.dong4j.site/posts/a69881a6.html"><link rel="preconnect" href="//cdn.cbd.int"><link rel="preconnect" href="//hm.baidu.com"><meta name="google-site-verification" content="xxx"><meta name="baidu-site-verification" content="codeva-D4HsBP841S"><meta name="msvalidate.01" content="xxx"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@1.0.17/lib/assets/font-awesome-animation.min.css"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media=&quot;all&quot;"><script>var _hmt=_hmt||[];(()=>{var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?61a751ac36d18d3ba293fe8ef3ec53eb",document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)})()</script><script>let GLOBAL_CONFIG={linkPageTop:{enable:!0,title:"与数百名博主无限进步",addFriendPlaceholder:"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},peoplecanvas:void 0,postHeadAiDescription:{enable:!0,gptName:"Local",mode:"online",switchBtn:!0,btnLink:"https://github.com/dong4j/blog-summary-assistant-server",randomNum:3,basicWordCount:1999,key:"84yT3Gkl6fp",Referer:"https://blog.dong4j.site:1024",apiUrl:"https://oneapi.dong4j.ink:1024/api/summary",audioUrl:"https://api.dong4j.ink:1024/audio"},diytitle:{enable:!0,leaveTitle:"兄台留步 🙏",backTitle:"兄台,别来无恙 👋"},LA51:{enable:!0,ck:"3Ki5mmyy6E5xtXuf",LingQueMonitorID:"3Ki5mmyy6E5xtXuf"},greetingBox:{enable:!0,default:"晚上好👋",list:[{greeting:"晚安😴",startTime:0,endTime:5},{greeting:"早上好鸭👋, 祝你一天好心情！",startTime:6,endTime:9},{greeting:"上午好👋, 状态很好，鼓励一下～",startTime:10,endTime:10},{greeting:"11点多啦, 在坚持一下就吃饭啦～",startTime:11,endTime:11},{greeting:"午安👋, 宝贝",startTime:12,endTime:14},{greeting:"🌈充实的一天辛苦啦！",startTime:14,endTime:18},{greeting:"19点喽, 奖励一顿丰盛的大餐吧🍔。",startTime:19,endTime:19},{greeting:"晚上好👋, 在属于自己的时间好好放松😌~",startTime:20,endTime:24}]},twikooEnvId:"https://twikoo.dong4j.ink:1024",commentBarrageConfig:{enable:!0,maxBarrage:1,barrageTime:4e3,accessToken:"3a358103e6024cfb97546ec8f8408f5a",mailMd5:"3435c7a74ba1cad3f5d57b0b61b9b25cee221b97599c47b32edbdb36038c5411"},music_page_default:"nav_music",root:"/",preloader:{source:"car"},friends_vue_info:{apiurl:"https://friends.dong4j.ink:1024/"},navMusic:!0,mainTone:{mode:"both",api:"https://img2color.dong4j.ink:1024/api?img=",cover_change:!0},authorStatus:{skills:["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","😎 HomeLab 折腾专家","🏃 脚踏实地行动派","🧱 团队小组发动机","👶 尿不湿更换专家"]},algolia:{appId:"JFMEP32WXP",apiKey:"8e3acd038435dda872706ba6777a54b3",indexName:"blog-index",hits:{per_page:10},languages:{input_placeholder:"输入关键词后按下回车查找",hits_empty:"找不到您查询的内容：${query}",hits_stats:"找到 ${hits} 条结果，用时 ${time} 毫秒"}},localSearch:void 0,translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"简",rightMenuMsgToTraditionalChinese:"转为繁体",rightMenuMsgToSimplifiedChinese:"转为简体"},noticeOutdate:{limitDay:365,position:"top",messagePrev:"该内容距离上次更新已经过了",messageNext:"天，文章内容可能已经过时。"},highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:330},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,simplehomepage:!0,post:!0},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{copy:!0,copyrightEbable:!1,limitCount:50,languages:{author:"作者: dong4j",link:"链接: ",source:"来源: 司机带你开车",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。",copySuccess:"复制成功，复制和转载请标注本文地址"}},lightbox:"mediumZoom",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#425AEF",bgDark:"#1f1f1f",position:"top-center"},source:{justifiedGallery:{js:"https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js",css:"https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!0,shortcutKey:{enable:!0,delay:100,shiftDelay:200},autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={configTitle:"司机带你开车",title:"Google Dapper：揭秘分布式跟踪系统的秘密",postAI:"Dapper 是一个 Google 生产环境下的分布式跟踪系统，用于收集和呈现复杂分布式系统的行为信息。它通过低损耗、应用透明和大范围部署满足需求。Dapper 设计之初参考了 Magpie 和 X-Trace 等分布式系统的理念，并通过采样率的使用和代码植入限制在一小部分公共库的改造上实现了成功应用。本文介绍了 Dapper 的构建和部署过程，包括使用 Dapper 搭建的分析工具、在 Google 内部使用的统计数据和使用场景等，并讨论了从 Dapper 收获的经验和教训。",pageFillDescription:"概述, 1. 介绍, 1.1 文献的总结, 2. Dapper 的分布式跟踪, 2.1 跟踪树和 span, 2.2 植入点, 2.3 Annotation, 2.4 采样率, 2.5 跟踪的收集, 2.5.1 带外数据跟踪收集, 2.6 安全和隐私考虑, 3. Dapper 部署状况, 3.1 Dapper 运行库, 3.2 生产环境下的涵盖面, 3.3 跟踪 Annotation 的使用, 4. 处理跟踪损耗, 4.1 生成跟踪的损耗, 4.2 跟踪收集的消耗, 4.3 在生产环境下对负载的影响, 4.4 可变采样, 4.5 应对积极采样 (Coping with aggressive sampling), 4.6 在收集过程中额外的采样, 5. 通用的 Dapper 工具, 5.1 Dapper Depot API, 5.1.1 DAPI 在 Google 内部的使用, 5.2 Dapper 的用户接口, 6. 经验, 6.1 在开发中使用 Dapper, 6.1.1 与异常监控的集成, 6.2 解决延迟的长尾效应, 6.3 推断服务依赖, 6.4 不同服务的网络使用率, 6.5 分层和共享存储系统, 6.6 Dapper 的救火能力 (Firefighting), 7. 其他收获, 8. 相关产品, 9. 总结, Acknowledgments, References概述当代的互联网的服务通常都是用复杂的大规模分布式集群来实现的互联网应用构建在不同的软件模块集上这些软件模块有可能是由不同的团队开发可能使用不同的编程语言来实现有可能布在了几千台服务器横跨多个不同的数据中心因此就需要一些可以帮助理解系统行为用于分析性能问题的工具生产环境下的分布式跟踪系统应运而生那么我们就来介绍一个大规模集群的跟踪系统它是如何满足一个低损耗应用透明的大范围部署这三个需求的当然设计之初参考了一些其他分布式系统的理念尤其是和但是我们之所以能成功应用在生产环境上还需要一些画龙点睛之笔例如采样率的使用以及把代码植入限制在一小部分公共库的改造上自从发展成为一流的监控系统之后给其他应用的开发者和运维团队帮了大忙所以我们今天才发表这篇论文来汇报一下这两年来是怎么构建和部署的最初只是作为一个自给自足的监控工具起步的但最终进化成一个监控平台这个监控平台促生出多种多样的监控工具有些甚至已经不是由团队开发的了下面我们会介绍一些使用搭建的分析工具分享一下这些工具在内部使用的统计数据展现一些使用场景最后会讨论一下我们迄今为止从收获了些什么介绍我们开发是为了收集更多的复杂分布式系统的行为信息然后呈现给的开发者们这样的分布式系统有一个特殊的好处因为那些大规模的低端服务器作为互联网服务的载体是一个特殊的经济划算的平台想要在这个上下文中理解分布式系统的行为就需要监控那些横跨了不同的应用不同的服务器之间的关联动作下面举一个跟搜索相关的例子这个例子阐述了可以应对哪些挑战比如一个前段服务可能对上百台查询服务器发起了一个查询每一个查询都有自己的这个查询可能会被发送到多个的子系统这些子系统分别用来处理广告进行拼写检查或是查找一些像图片视频或新闻这样的特殊结果根据每个子系统的查询结果进行筛选得到最终结果最后汇总到页面上我们把这种搜索模型称为全局搜索总的来说这一次全局搜索有可能调用上千台服务器涉及各种服务而且用户对搜索的耗时是很敏感的而任何一个子系统的低效都导致导致最终的搜索耗时如果一个工程师只能知道这个查询耗时不正常但是他无从知晓这个问题到底是由哪个服务调用造成的或者为什么这个调用性能差强人意首先这个工程师可能无法准确的定位到这次全局搜索是调用了哪些服务因为新的服务乃至服务上的某个片段都有可能在任何时间上过线或修改过有可能是面向用户功能也有可能是一些例如针对性能或安全认证方面的功能改进其次你不能苛求这个工程师对所有参与这次全局搜索的服务都了如指掌每一个服务都有可能是由不同的团队开发或维护的再次这些暴露出来的服务或服务器有可能同时还被其他客户端使用着所以这次全局搜索的性能问题甚至有可能是由其他应用造成的举个例子一个后台服务可能要应付各种各样的请求类型而一个使用效率很高的存储系统比如有可能正被反复读写着因为上面跑着各种各样的应用上面这个案例中我们可以看到对我们只有两点要求无所不在的部署持续的监控无所不在的重要性不言而喻因为在使用跟踪系统的进行监控时即便只有一小部分没被监控到那么人们对这个系统是不是值得信任都会产生巨大的质疑另外监控应该是小时的毕竟系统异常或是那些重要的系统行为有可能出现过一次就很难甚至不太可能重现那么根据这两个明确的需求我们可以直接推出三个具体的设计目标低消耗跟踪系统对在线服务的影响应该做到足够小在一些高度优化过的服务即使一点点损耗也会很容易察觉到而且有可能迫使在线服务的部署团队不得不将跟踪系统关停应用级的透明对于应用的程序员来说是不需要知道有跟踪系统这回事的如果一个跟踪系统想生效就必须需要依赖应用的开发者主动配合那么这个跟踪系统也太脆弱了往往由于跟踪系统在应用中植入代码的或疏忽导致应用出问题这样才是无法满足对跟踪系统无所不在的部署这个需求面对当下想这样的快节奏的开发环境来说尤其重要延展性至少在未来几年的服务和集群的规模监控系统都应该能完全把控住一个额外的设计目标是为跟踪数据产生之后进行分析的速度要快理想情况是数据存入跟踪仓库后一分钟内就能统计出来尽管跟踪系统对一小时前的旧数据进行统计也是相当有价值的但如果跟踪系统能提供足够快的信息反馈就可以对生产环境下的异常状况做出快速反应做到真正的应用级别的透明这应该是当下面临的最挑战性的设计目标我们把核心跟踪代码做的很轻巧然后把它植入到那些无所不在的公共组件种比如线程调用控制流以及库使用自适应的采样率可以使跟踪系统变得可伸缩并降低性能损耗这些内容将在第节中提及结果展示的相关系统也需要包含一些用来收集跟踪数据的代码用来图形化的工具以及用来分析大规模跟踪数据的库和虽然单独使用有时就足够让开发人员查明异常的来源但是的初衷不是要取代所有其他监控的工具我们发现的数据往往侧重性能方面的调查所以其他监控工具也有他们各自的用处文献的总结分布式系统跟踪工具的设计空间已经被一些优秀文章探索过了其中的和和最为相近这些系统在其发展过程的早期倾向于写入研究报告中即便他们还没来得及清楚地评估系统当中一些设计的重要性相比之下由于已经在大规模生产环境中摸爬滚打了多年经过这么多生产环境的验证之后我们认为这篇论文最适合重点阐述在部署的过程中我们有那些收获我们的设计思想是如何决定的以及以什么样的方式实现它才会最有用作为一个平台承载基于开发的性能分析工具以及自身的监测工具它的价值在于我们可以在回顾评估中找出一些意想不到的结果虽然在许多高阶的设计思想上吸取了和的研究成果但在分布式跟踪这个领域中的实现包含了许多新的贡献例如我们想实现低损耗的话特别是在高度优化的而且趋于极端延迟敏感的服务中采样率是很必要的或许更令人惊讶的是我们发现即便是的采样率对于跟踪数据的通用使用层面上也可以提供足够多的信息我们的系统的另一个重要的特征就是我们能实现的应用级的透明我们的组件对应用的侵入被先限制在足够低的水平上即使想网页搜索这么大规模的分布式系统也可以直接进行跟踪而无需加入额外的标注虽然由于我们的部署系统有幸是一定程度的同质化的所以更容易做到对应用层的透明这点但是我们证明了这是实现这种程度的透明性的充分条件的分布式跟踪图这个路径由用户的请求发起穿过一个简单的服务系统用字母标识的节点代表分布式系统中的不同处理过程分布式服务的跟踪系统需要记录在一次特定的请求后系统中完成的所有工作的信息举个例子图展现的是一个和台服务器相关的一个服务包括前端两个中间层和以及两个后端和当一个用户这个用例的发起人发起一个请求时首先到达前端然后发送两个到服务器和会马上做出反应但是需要和后端的和交互之后再返还给由来响应最初的请求对于这样一个请求简单实用的分布式跟踪的实现就是为服务器上每一次你发送和接收动作来收集跟踪标识符和时间戳为了将所有记录条目与一个给定的发起者例如图中的关联上并记录所有信息现在有两种解决方案黑盒和基于标注的监控方案黑盒方案假定需要跟踪的除了上述信息之外没有额外的信息这样使用统计回归技术来推断两者之间的关系基于标注的方案依赖于应用程序或中间件明确地标记一个全局从而连接每一条记录和发起者的请求虽然黑盒方案比标注方案更轻便他们需要更多的数据以获得足够的精度因为他们依赖于统计推论基于标注的方案最主要的缺点是很明显需要代码植入在我们的生产环境中因为所有的应用程序都使用相同的线程模型控制流和系统我们发现可以把代码植入限制在一个很小的通用组件库中从而实现了监测系统的应用对开发人员是有效地透明我们倾向于认为的跟踪架构像是内嵌在调用的树形结构然而我们的核心数据模型不只局限于我们的特定的框架我们还能跟踪其他行为例如的会话外界的请求和外部对服务器的查询等从形式上看我们的跟踪模型使用的树形结构以及跟踪树和在跟踪树结构中树节点是整个架构的基本单元而每一个节点又是对的引用节点之间的连线表示的和它的父直接的关系虽然在日志文件中只是简单的代表的开始和结束时间他们在整个树形结构中却是相对独立的任何相关的时间数据零个或多个特定应用程序的的相关内容会在节中讨论图个在跟踪树种短暂的关联关系在图中说明了在一个大的跟踪过程中是什么样的记录了名称以及每个的和父以重建在一次追踪过程中不同之间的关系如果一个没有父被称为所有都挂在一个特定的跟踪上也共用一个跟踪在图中未示出所有这些用全局唯一的位整数标示在一个典型的跟踪中我们希望为每一个对应到一个单一的上而且每一个额外的组件层都对应一个跟踪树型结构的层级图在图中所示的一个单独的的细节图图给出了一个更详细的典型的跟踪的记录点的视图在图中这种某个表述了两个的分别为端和端的开始时间和结束时间以及任何的时间信息都通过在组件库的植入记录下来如果应用程序开发者选择在跟踪中增加他们自己的注释如图中的注释业务数据这些信息也会和其他信息一样记录下来记住任何一个可以包含来自不同的主机信息这些也要记录下来事实上每一个可以包含客户端和服务器两个过程的注释使得链接两个主机的会成为模型中所说的由于客户端和服务器上的时间戳来自不同的主机我们必须考虑到时间偏差在我们的分析工具我们利用了这个事实客户端发送一个请求之后服务器端才能接收到对于响应也是一样的服务器先响应然后客户端才能接收到这个响应这样一来服务器端的就有一个时间戳的一个上限和下限植入点可以以对应用开发者近乎零浸入的成本对分布式控制路径进行跟踪几乎完全依赖于基于少量通用组件库的改造如下当一个线程在处理跟踪控制路径的过程中把这次跟踪的上下文的在中进行存储追踪上下文是一个小而且容易复制的容器其中承载了的属性比如跟踪和当计算过程是延迟调用的或是异步的大多数开发者通过线程池或其他执行器使用一个通用的控制流库来回调确保所有这样的回调可以存储这次跟踪的上下文而当回调函数被触发时这次跟踪的上下文会与适当的线程关联上在这种方式下可以使用和来辅助构建异步调用的路径几乎所有的的进程间通信是建立在一个用和开发的框架上我们把跟踪植入该框架来定义中所有的的和跟踪的会从客户端发送到服务端像那样的基于的系统被广泛使用在中这是一个重要的植入点当那些非通信框架发展成熟并找到了自己的用户群之后我们会计划对通信框架进行植入的跟踪数据是独立于语言的很多在生产环境中的跟踪结合了用和写的进程的数据在节中我们讨论应用程序的透明度时我们会把这些理论的是如何实践的进行讨论上述植入点足够推导出复杂的分布式系统的跟踪细节使得的核心功能在不改动应用的情况下可用然而还允许应用程序开发人员在跟踪的过程中添加额外的信息以监控更高级别的系统行为或帮助调试问题我们允许用户通过一个简单的定义带时间戳的核心的示例代码入图所示这些可以添加任意内容为了保护的用户意外的过分热衷于日志的记录每一个跟踪有一个可配置的总量的上限但是应用程序级的是不能替代用于表示结构的信息和记录着相关的信息除了简单的文本也支持的映射的提供给开发人员更强的跟踪能力如持续的计数器二进制消息记录和在一个进程上跑着的任意的用户数据键值对的方式用来在分布式追踪的上下文中定义某个特定应用程序的相关类型采样率低损耗的是的一个关键的设计目标因为如果这个工具价值未被证实但又对性能有影响的话你可以理解服务运营人员为什么不愿意部署它况且我们想让开发人员使用的而不用担心额外的开销我们还发现某些类型的服务对植入带来的性能损耗确实非常敏感因此除了把的收集工作对基本组件的性能损耗限制的尽可能小之外我们还有进一步控制损耗的办法那就是遇到大量请求时只记录其中的一小部分我们将在节中讨论跟踪的采样率方案的更多细节图收集管道的总览跟踪的收集的跟踪记录和收集管道的过程分为三个阶段参见图首先数据写入本地日志文件中然后的守护进程和收集组件把这些数据从生产环境的主机中拉出来最终写到的仓库中一次跟踪被设计成中的一行每一列相当于一个的支持稀疏表格布局正适合这种情况因为每一次跟踪可以有任意多个跟踪数据收集即从应用中的二进制数据传输到中央仓库所花费的时间的延迟中位数少于秒第百分位的延迟往往随着时间的推移呈现双峰型大约的时间第百分位的延迟时间小于分钟但是另外大约的时间它可以增涨到几个小时还提供了一个来简化访问我们仓库中的跟踪数据的开发人员用这个以构建通用和特定应用程序的分析工具第节包含更多如何使用它的信息带外数据跟踪收集带外数据传输层协议使用带外数据来发送一些重要的数据如果通信一方有重要的数据需要通知对方时协议能够将这些数据快速地发送到对方为了发送这些数据协议一般不使用与普通数据相同的通道而是使用另外的通道这里指的策略是把跟踪数据随着调用链进行传送是通过其他的链路进行跟踪数据的收集的写日志然后进行日志采集的方式就属于策略系统请求树树自身进行跟踪记录和收集带外数据这样做是为两个不相关的原因首先带内收集方案这里跟踪数据会以响应头的形式被返回会影响应用程序网络动态在里的许多规模较大的系统中一次跟踪成千上万的并不少见然而回应大小甚至是接近大型分布式的跟踪的根节点的这种情况下仍然是比较小的通常小于在这种情况下带内的跟踪数据会让应用程序数据和倾向于使用后续分析结果的数据量相形见绌其次带内收集方案假定所有的是完美嵌套的我们发现在所有的后端的系统返回的最终结果之前有许多中间件会把结果返回给他们的调用者带内收集系统是无法解释这种非嵌套的分布式执行模式的安全和隐私考虑记录一定量的有效负载信息将丰富的跟踪能力因为分析工具能够在有效载荷数据方法传递的参数中找到相关的样例这些样例可以解释被监控系统的为何表现异常然而有些情况下有效载荷数据可能包含的一些不应该透露给未经授权用户包括正在的工程师的内部信息由于安全和隐私问题是不可忽略的中的虽然存储方法的名称但在这个时候不记录任何有效载荷数据相反应用程序级别的提供了一个方便的可选机制应用程序开发人员可以在中选择关联那些为以后分析提供价值的数据还提供了一些安全上的便利是它的设计者事先没有预料到的通过跟踪公开的安全协议参数可以通过相应级别的认证或加密来监视应用程序是否满足安全策略例如还可以提供信息以基于策略的的隔离系统按预期执行例如支撑敏感数据的应用程序不与未经授权的系统组件进行了交互这样的测算提供了比源码审核更强大的保障部署状况作为我们生产环境下的跟踪系统已经超过两年在本节中我们会汇报系统状态把重点放在如何满足了我们的目标无处不在的部署和应用级的透明运行库也许代码中中最关键的部分就是对基础线程控制和流程控制的组件库的植入其中包括的创建采样率的设置以及把日志写入本地磁盘除了做到轻量级植入的代码更需要稳定和健壮因为它与海量的应用对接维护和修复变得困难植入的核心代码是由未超过行的和不超过行代码组成为了支持键值对的还添加了额外的行代码生产环境下的涵盖面的渗透可以总结为两个方面一方面是可以创建跟踪的过程与植入的组件库相关和生产环境下的服务器上在运行跟踪收集守护进程的守护进程的分布相当于我们服务器的简单的拓扑图它存在于几乎所有的服务器上这很难确定精确的进程部分因为过程即便不产生跟踪信息也是无从知晓的尽管如此考虑到无处不在组件的植入库我们估计几乎每一个的生产进程都是支持跟踪的在某些情况下的是不能正确的跟踪控制路径的这些通常源于使用非标准的控制流或是的错误的把路径关联归到不相关的事件上提供了一个简单的库来帮助开发者手动控制跟踪传播作为一种变通方法目前有个应用程序和个应用程序需要一些手动控制的追踪传播不过这只是上千个的跟踪中的一小部分也有非常小的一部分程序使用的非组件性质的通信库比如原生的或因此不能直接支持的跟踪但是这些应用可以单独接入到中如果需要的话考虑到生产环境的安全的跟踪也可以关闭事实上它在部署的早起就是默认关闭的直到我们对的稳定性和低损耗有了足够的信心之后才把它开启的团队偶尔会执行审查寻找跟踪配置的变化来看看那些服务关闭了的跟踪但这种情况不多见而且通常是源于对监控对性能消耗的担忧经过了对实际性能消耗的进一步调查和测量所有这些关闭跟踪都已经恢复开启了不过这些已经不重要了跟踪的使用程序员倾向于使用特定应用程序的无论是作为一种分布式调试日志文件还是通过一些应用程序特定的功能对跟踪进行分类例如所有的的请求会把被访问的表名也记录到中目前的和的所有跟踪都至少有一个特殊应用的个应用和个应用中都添加自定义的为了更好地理解应用程序中的在他们的服务中的行为值得注意的是迄今为止我们的开发者比开发者更多的在每一个跟踪上采用的这可能是因为我们的应用的作用域往往是更接近最终用户偏底层这些类型的应用程序经常处理更广泛的请求组合因此具有比较复杂的控制路径处理跟踪损耗跟踪系统的成本由两部分组成正在被监控的系统在生成追踪和收集追踪数据的消耗导致系统性能下降需要使用一部分资源来存储和分析跟踪数据虽然你可以说一个有价值的组件植入跟踪带来一部分性能损耗是值得的我们相信如果基本损耗能达到可以忽略的程度那么对跟踪系统最初的推广会有极大的帮助在本节中我们会展现一下三个方面组件操作的消耗跟踪收集的消耗以及对生产环境负载的影响我们还介绍了可调节的采样率机制如何帮我们处理低损耗和跟踪代表性之间的平衡和取舍生成跟踪的损耗生成跟踪的开销是性能影响中最关键的部分因为收集和分析可以更容易在紧急情况下被关闭运行库中最重要的跟踪生成消耗在于创建和销毁和并记录到本地磁盘供后续的收集根的创建和销毁需要损耗平均纳秒的时间而同样的操作在其他上需要消耗纳秒时间上的差别主要在于需要在跟上给这次跟踪分配一个全局唯一的如果一个没有被采样的话那么这个额外的下创建的成本几乎可以忽略不计他由在运行期对查找操作构成这平均只消耗纳秒如果这个被计入采样的话会用一个用字符串进行标注在图中有展现平均需要消耗纳秒这些数据都是在的服务器上采集的在运行期写入到本地磁盘是最昂贵的操作但是他们的可见损耗大大减少因为写入日志文件和操作相对于被跟踪的应用系统来说都是异步的不过日志写入的操作如果在大流量的情况尤其是每一个请求都被跟踪的情况下就会变得可以察觉到我们记录了在节展示了一次搜索的负载下的性能消耗跟踪收集的消耗读出跟踪数据也会对正在被监控的负载产生干扰表展示的是最坏情况下收集日志的守护进程在高于实际情况的负载基准下进行测试时的使用率在生产环境下跟踪数据处理中这个守护进程从来没有超过的单核使用率而且只有很少量的内存使用以及堆碎片的噪音我们还限制了守护进程为内核最低的优先级以防在一台高负载的服务器上发生竞争也是一个带宽资源的轻量级的消费者每一个在我们的仓库中传输只占用了平均的作为网络行为中的极小部分的数据收集在的生产环境中的只占用了的网络资源表守护进程在负载测试时的资源使用率在生产环境下对负载的影响每个请求都会利用到大量的服务器的高吞吐量的线上服务这是对有效跟踪最主要的需求之一这种情况需要生成大量的跟踪数据并且他们对性能的影响是最敏感的在表中我们用集群下的网络搜索服务作为例子我们通过调整采样率来衡量在延迟和吞吐量方面对性能的影响表网络搜索集群中对不同采样率对网络延迟和吞吐的影响延迟和吞吐的实验误差分别是和我们看到虽然对吞吐量的影响不是很明显但为了避免明显的延迟跟踪的采样还是必要的然而延迟和吞吐量的带来的损失在把采样率调整到小于之后就全部在实验误差范围内在实践中我们发现即便采样率调整到仍然是有足够量的跟踪数据的用来跟踪大量的服务保持的性能损耗基线在一个非常低的水平是很重要的因为它为那些应用提供了一个宽松的环境使用完整的而无惧性能损失使用较低的采样率还有额外的好处可以让持久化到硬盘中的跟踪数据在垃圾回收机制处理之前保留更长的时间这样为的收集组件给了更多的灵活性可变采样任何给定进程的的消耗和每个进程单位时间的跟踪的采样率成正比的第一个生产版本在内部的所有进程上使用统一的采样率为这个简单的方案是对我们的高吞吐量的线上服务来说是非常有用因为那些感兴趣的事件在大吞吐量的情况下仍然很有可能经常出现并且通常足以被捕捉到然而在较低的采样率和较低的传输负载下可能会导致错过重要事件而想用较高的采样率就需要能接受的性能损耗对于这样的系统的解决方案就是覆盖默认的采样率这需要手动干预的这种情况是我们试图避免在中出现的我们在部署可变采样的过程中参数化配置采样率时不是使用一个统一的采样方案而是使用一个采样期望率来标识单位时间内采样的追踪这样一来低流量低负载自动提高采样率而在高流量高负载的情况下会降低采样率使损耗一直保持在控制之下实际使用的采样率会随着跟踪本身记录下来这有利于从的跟踪数据中准确的分析应对积极采样新的用户往往觉得低采样率在高吞吐量的服务下经常低至将会不利于他们的分析我们在的经验使我们相信对于高吞吐量服务积极采样并不妨碍最重要的分析如果一个显着的操作在系统中出现一次他就会出现上千次低吞吐量的服务也许是每秒请求几十次而不是几十万可以负担得起跟踪每一个请求这是促使我们下决心使用自适应采样率的原因在收集过程中额外的采样上述采样机制被设计为尽量减少与运行库协作的应用程序中明显的性能损耗的团队还需要控制写入中央资料库的数据的总规模因此为达到这个目的我们结合了二级采样目前我们的生产集群每天产生超过的采样跟踪数据的用户希望生产环境下的进程的跟踪数据从被记录之后能保存至少两周的时间逐渐增长的追踪数据的密度必须和中央仓库所消耗的服务器及硬盘存储进行权衡对请求的高采样率还使得收集器接近写入吞吐量的上限为了维持物质资源的需求和渐增的的吞吐之间的灵活性我们在收集系统自身上增加了额外的采样率的支持我们充分利用所有都来自一个特定的跟踪并分享同一个跟踪这个事实虽然这些有可能横跨了数千个主机对于在收集系统中的每一个我们用算法把跟踪转成一个标量这里如果比我们收集系统中的系数低的话我们就保留这个信息并写入到中反之我们就抛弃他通过在采样决策中的跟踪我们要么保存要么抛弃整个跟踪而不是单独处理跟踪内的我们发现有了这个额外的配置参数使管理我们的收集管道变得简单多了因为我们可以很容易地在配置文件中调整我们的全局写入率这个参数如果整个跟踪过程和收集系统只使用一个采样率参数确实会简单一些但是这就不能应对快速调整在所有部署的节点上的运行期采样率配置的这个要求我们选择了运行期采样率这样就可以优雅的去掉我们无法写入到仓库中的多余数据我们还可以通过调节收集系统中的二级采样率系数来调整这个运行期采样率的管道维护变得更容易因为我们就可以通过修改我们的二级采样率的配置直接增加或减少我们的全局覆盖率和写入速度通用的工具几年前当还只是个原型的时候它只能在开发者耐心的支持下使用从那时起我们逐渐迭代的建立了收集组件编程接口和基于的交互式用户界面帮助的用户独立解决自己的问题在本节中我们会总结一下哪些的方法有用哪些用处不大我们还提供关于这些通用的分析工具的基本的使用信息的或称作提供在的区域仓库中对分布式跟踪数据一个直接访问和跟踪仓库被设计成串联的而且意味着对仓库中的元数据暴露一个干净和直观的的接口我们使用了以下推荐的三种方式去暴露这样的接口通过跟踪来访问可以通过他的全局唯一的跟踪读取任何一次跟踪信息批量访问可以利用的提供对上亿条跟踪数据的并行读取用户重写一个虚拟函数它接受一个的跟踪信息作为其唯一的参数该框架将在用户指定的时间窗口中调用每一次收集到的跟踪信息索引访问的仓库支持一个符合我们通用调用模板的唯一索引该索引根据通用请求跟踪特性进行绘制来识别的跟踪信息因为跟踪是根据伪随机的规则创建的这是最好的办法去访问跟某个服务或主机相关的跟踪数据所有这三种访问模式把用户指向不同的跟踪记录正如第节所述的的由组成的跟踪数据是用树形结构建模的因此跟踪数据的数据结构也是一个简单的由组成遍历树就相当于调用在这种情况下的时间信息是可用的带时间戳的特殊的应用标注也是可以通过这个结构来访问的选择一个合适的自定义索引是设计中最具挑战性的部分压缩存储要求在跟踪数据种建立一个索引的情况只比实际数据小所以消耗是巨大的最初我们部署了两个索引第一个是主机索引另一个是服务名的索引然而我们并没有找到主机索引和存储成本之间的利害关系当用户对每一台主机感兴趣的时候他们也会对特定的服务感兴趣所以我们最终选择把两者相结合成为一个组合索引它允许以服务名称主机和时间戳的顺序进行有效的查找在内部的使用在谷歌的使用有三类使利用的持续的线上应用维护良好的可以在控制台上调用的基于的工具可以被写入运行不过大部分已经被忘记了的一次性分析工具我们知道的有个持久性的基于的应用程序个额外的按需定制的基于分析工具以及使用框架构建的约一次性的分析工具在这之后的工具就这是很难说明了因为开发者可以构建运行和丢弃这些项目而不需要团队的技术支持的用户接口绝大多数用户使用发生在基于的用户交互接口篇幅有限我们不能列出每一个特点而只能把典型的用户工作流在图中展示用户描述的他们关心的服务和时间和其他任何他们可以用来区分跟踪模板的信息比如的名称他们还可以指定与他们的搜索最相关的成本度量比如服务响应时间一个关于性能概要的大表格对应确定的服务关联的所有分布式处理图表用户可以把这些执行图标排序成他们想要的并选择一种直方图去展现出更多的细节一旦某个单一的分布式执行部分被选中后用户能看到关于执行部分的的图形化描述被选中的服务被高亮展示在该图的中心在生成与步骤中选中的成本度量维度相关的统计信息之后的用户界面会提供了一个简单的直方图在这个例子中我们可以看到一个大致的所选中部分的分布式响应时间分布图用户还会看到一个关于具体的跟踪信息的列表展现跟踪信息在直方图中被划分为的不同区域在这个例子中用户点击列表种第二个跟踪信息实例时会在下方看到这个跟踪信息的详细视图步骤绝大多数的使用者最终的会检查某个跟踪的情况希望能收集一些信息去了解系统行为的根源所在我们没有足够的空间来做跟踪视图的审查但我们使用由一个全局时间轴在上方可以看到并能够展开和折叠树形结构的交互方式这也很有特点分布式跟踪树的连续层用内嵌的不同颜色的矩形表示每一个的被从时间上分解为一个服务器进程中的消耗绿色部分和在网络上的消耗蓝色部分用户没有显示在这个截图中但他们可以选择性的以的形式包含在全局时间轴上为了让用户查询实时数据的用户界面能够直接与每一台生产环境下的服务器上的守护进程进行交互在该模式下不可能指望能看到上面所说的系统级的图表展示但仍然可以很容易基于性能和网络特性选取一个特定的跟踪在这种模式下可在几秒钟内查到实时的数据根据我们的记录大约有个不同的工程师在一天内使用的的在一周的过程中大约有不同的用户这些用户数在新功能的内部通告上是按月连续的通常用户会发送特定跟踪的连接这将不可避免地在查询跟踪情况时中产生很多一次性的持续时间较短的交互经验在被广泛应用一部分直接通过的用户界面另一部分间接地通过对的二次开发或者建立在基于的应用上在本节中我们并不打算罗列出每一种已知的使用方式而是试图覆盖使用方式的基本向量并努力来说明什么样的应用是最成功的在开发中使用系统是围绕一个大型的关键词定位准则和相关文字广告的数据库搭建的当新的关键字或广告被插入或修改时它们必须通过服务策略术语的检查如检查不恰当的语言这个过程如果使用自动复查系统来做的话会更加有效当轮到从头重新设计一个广告审查服务时这个团队迭代的从第一个系统原型开始使用并且最终用一直维护着他们的系统帮助他们从以下几个方面改进了他们的服务性能开发人员针对请求延迟的目标进行跟踪并对容易优化的地方进行定位也被用来确定在关键路径上不必要的串行请求通常来源于不是开发者自己开发的子系统并促使团队持续修复他们正确性广告审查服务围绕大型数据库系统搭建系统同时具有只读副本策略数据访问廉价和读写的主策略访问代价高被用来在很多种情况中确定哪些查询是无需通过主策略访问而可以采用副本策略访问现在可以负责监控哪些主策略被直接访问并对重要的系统常量进行保障理解性广告审查查询跨越了各种类型的系统包括之前提到的那个数据库多维索引服务以及其他各种和后端服务的跟踪用来评估总查询成本促进重新对业务的设计用以在他们的系统依赖上减少负载测试新的代码版本会经过一个使用进行跟踪的过程用来验证正确的系统行为和性能在跑测试的过程中能发现很多问题这些问题来自广告审查系统自身的代码或是他的依赖包广告审查团队广泛使用了开源的框架用来在重要的软件组件上标注这些跟踪信息可以进一步被标注包含重要子路径的输入输出大小基础信息其他调试信息所有这些信息将会额外发送到日志文件中同时我们也发现了一些广告审查小组在使用方面的不足比如他们想根据他们所有跟踪的信息在一个交互时间段内进行搜索然而这就必须跑一个自定义的或进行每一个跟踪的手动检查另外在还有一些其他的系统在也从通用调试日志中收集和集中信息把那些系统的海量数据和仓库整合也是有价值的总的来说即便如此广告审查团队仍然对的作用进行了以下评估通过使用的跟踪平台的数据分析他们的服务延迟性已经优化了两个数量级与异常监控的集成维护了一个从运行进程中不断收集并集中异常信息报告的服务如果这些异常发生在跟踪采样的上下文中那么相应的跟踪和的也会作为元数据记录在异常报告中异常监测服务的前端会提供一个链接从特定的异常信息的报告直接导向到他们各自的分布式跟踪广告审查团队使用这个功能可以了解发生的更大范围的上下文通过暴露基于简单的唯一构建的接口平台被集成到其他事件监测系统会相对容易解决延迟的长尾效应考虑到移动部件的数量代码库的规模部署的范围调试一个像全文搜索那样服务第节里提到过是非常具有挑战性的在这节我们描述了我们在减轻全文搜索的延迟分布的长尾效应上做的各种努力能够验证端到端的延迟的假设更具体地说能够验证对于搜索请求的关键路径当一个系统不仅涉及数个子系统而是几十个开发团队的涉及到的系统的情况下端到端性能较差的根本原因到底在哪这个问题即使是我们最好的和最有经验的工程师也无法正确回答在这种情况下可以提供急需的数据而且可以对许多重要的性能问题得出结论图全局搜索的跟踪片段在不常遇到高网络延迟的情况下在沿着关键路径的端到端的请求延迟如图所示在调试延迟长尾效应的过程中工程师可以建立一个小型库这个小型库可以根据跟踪对象来推断关键路径的层级结构这些关键路径的结构可以被用来诊断问题并且为全文搜索提供可优先处理的预期的性能改进的这项工作导致了下列发现在关键路径上的短暂的网络性能退化不影响系统的吞吐量但它可能会对延迟异常值产生极大的影响在图中可以看出大部分的全局搜索的缓慢的跟踪都来源于关键路径的网络性能退化许多问题和代价很高的查询模式来源于一些意想不到的服务之间的交互一旦发现往往容易纠正它们但是出现之前想找出这些问题是相当困难的通用的查询从之外的安全日志仓库中收取并使用唯一的跟踪与的仓库做关联然后该映射用来建立关于在全局搜索中的每一个独立子系统都很慢的实例查询的列表推断服务依赖在任何给定的时间内内部的一个典型的计算集群是一个汇集了成千上万个逻辑任务的主机一套的处理器在执行一个通用的方法维护着许多这样的集群当然事实上我们发现在一个集群上计算着的这些任务通常依赖于其他的集群上的任务由于任务们之间的依赖是动态改变的所以不可能仅从配置信息上推断出所有这些服务之间的依赖关系不过除了其他方面的原因之外在公司内部的各个流程需要准确的服务依赖关系信息以确定瓶颈所在以及计划服务的迁移的可称为的项目是通过使用跟踪和接口来实现自动化确定服务依赖归属的核心组件与跟踪一并使用的情况下项目能够推算出任务各自之间的依赖以及任务和其他软件组件之间的依赖比如所有的的操作会加上与受影响的表名称相关的标记运用的平台团队就可以自动的推算出依赖于命名的不同资源的服务粒度不同服务的网络使用率投入了大量的人力和物力资源在他的网络结构上从前网络管理员可能只关注独立的硬件信息常用工具及以及搭建出的各种全局网络鸟瞰图的上的信息网络管理员确实可以一览整个网络的健康状况但是当遇到问题时他们很少有能够准确查找网络负载的工具用来定位应用程序级别的罪魁祸首虽然不是设计用来做链路级的监控的但是我们发现它是非常适合去做集群之间网络活动性的应用级任务的分析能够利用这个平台建立一个不断更新的控制台来显示集群之间最活跃的网络流量的应用级的热点此外使用我们能够为昂贵的网络请求提供指出的构成原因的跟踪而不是面对不同服务器之间的信息孤岛而无所适从建立一个基于的总共没花超过周的时间分层和共享存储系统在的许多存储系统是由多重独立复杂层级的分布式基础设备组成的例如的就是搭建在一个可扩展的实体存储系统上的该实体存储系统在基于上公开某些功能的同时使用分布式锁系统及再者像这样的系统简化了部署并更好的利用了计算资源在这种分层的系统并不总是很容易确定最终用户资源的消费模式例如来自于一个给定的单元格的大信息量主要来自于一个用户或是由多个用户产生但是在层面这两种明显的使用场景是很难界定而且如果缺乏一个像一样的工具的情况下对共享服务的竞争可能会同样难于调试第节中所示的的用户界面可以聚合那些调用任意公共服务的多个客户端的跟踪的性能信息这就很容易让提供这些服务的源从多个维度给他们的用户排名例如入站的网络负载出站的网络负载或服务请求的总时间的救火能力对于一些救火任务可以处理其中的一部分救火任务在这里是指一些有风险很高的在分布式系统上的操作通常情况下用户当正在进行救火任务时需要使用新的数据并且没有时间写新的代码或等待周期性的报告运行对于那些高延迟不可能更糟糕的那些在正常负载下都会响应超时的服务用户界面通常会把这些延迟瓶颈的位置隔离出来通过与守护进程的直接通信那些特定的高延迟的跟踪数据轻易的收集到当出现灾难性故障时通常是没有必要去看统计数据以确定根本原因只查看示例跟踪就足够了因为前文提到过从守护进程中几乎可以立即获得跟踪数据但是如在节中描述的共享的存储服务要求当用户活动过程中突然中断时能尽可能快的汇总信息对于事件发生之后共享服务仍然可以利用汇总的的数据但是除非收集到的数据的批量分析能在问题出现分钟之内完成否则面对与共享存储服务相关的救火任务就很难按预想的那般顺利完成其他收获虽然迄今为止我们在上的经验已经大致符合我们的预期但是也出现了一些积极的方面是我们没有充分预料到的首先我们获得了超出预期的使用用例的数量对此我们可谓欢心鼓舞另外在除了几个的在第节使用经验中提到过的一些用例之外还包括资源核算系统对指定的通讯模式敏感的服务的检查工具以及一种对压缩策略的分析器等等我们认为这些意想不到的用例一定程度上是由于我们向开发者以一种简单的编程接口的方式开放了跟踪数据存储的缘故这使得我们能够充分利用这个大的多的社区的创造力除此之外对旧的负载的支持也比预期的要简单只需要在程序中引入一个用新版本的重新编译过的公共组件库包含常规的线程使用控制流和框架即可在内部的广泛使用还为我们在的局限性上提供了宝贵的反馈意见下面我们将介绍一些我们已知的最重要的的不足合并的影响我们的模型隐含的前提是不同的子系统在处理的都是来自同一个被跟踪的请求在某些情况下缓冲一部分请求然后一次性操作一个请求集会更加有效比如磁盘上的一次合并写入操作在这种情况下一个被跟踪的请求可以看似是一个大型工作单元此外当有多个追踪请求被收集在一起他们当中只有一个会用来生成那个唯一的跟踪用来给其他使用所以就无法跟踪下去了我们正在考虑的解决方案希望在可以识别这种情况的前提下用尽可能少的记录来解决这个问题跟踪批处理负载的设计主要是针对在线服务系统最初的目标是了解一个用户请求产生的系统行为然而离线的密集型负载例如符合模型的情况也可以受益于性能挖潜在这种情况下我们需要把跟踪与一些其他的有意义的工作单元做关联诸如输入数据中的键值或键值的范围或是一个寻找根源可以有效地确定系统中的哪一部分致使系统整个速度变慢但并不总是能够找出问题的根源例如一个请求很慢有可能不是因为它自己的行为而是由于队列中其他排在它前面的请求还没处理完程序可以使用应用级的把队列的大小或过载情况写入跟踪系统此外如果这种情况屡见不鲜那么在中提到的成对的采样技术可以解决这个问题它由两个时间重叠的采样率组成并观察它们在整个系统中的相对延迟记录内核级的信息一些内核可见的事件的详细信息有时对确定问题根源是很有用的我们有一些工具能够跟踪或以其他方式描述内核的执行但是想用通用的或是不那么突兀的方式是很难把这些信息到捆绑到用户级别的跟踪上下文中我们正在研究一种妥协的解决方案我们在用户层面上把一些内核级的活动参数做快照然后绑定他们到一个活动的上相关产品在分布式系统跟踪领域有一套完整的体系一部分系统主要关注定位到故障位置其他的目标是针对性能进行优化确实被用于发现系统问题但它更通常用于探查性能不足以及提高全面大规模的工作负载下的系统行为的理解与相关的黑盒监控系统比如和可以说不依赖运行库的情况下黑盒监控系统能够实现更高的应用级透明黑盒的缺点是一定程度上不够精确并可能在统计推断关键路径时带来更大的系统损耗对于分布式系统监控来说基于的中间件或应用自身是一个可能是更受欢迎的解决办法拿和系统举例他们更依赖于应用级的而和大多集中在对库和中间件的修改更接近后者像和早期版本的一样采用了全局标识符把分布式系统中各部分相关的事件联系在一起和这些系统类似尝试避免使用应用级而是把的植入隐藏在通用组件模块内放弃使用全局仍然试图正确的完成请求的正确传播他通过采用应用系统各自写入的事件策略最终也能精确描述不同事件之间关系但是目前还不清楚在实际环境中实现透明性这些策略到底多么有效的核心比更有野心一些因为系统对于跟踪的收集不仅在跟踪节点层面上而且在节点内部不同的软件层也会进行跟踪而我们对于组件的低性能损耗的要求迫使我们不能采用这样的模型而是朝着把一个请求连接起来完整跟踪所能做到的最小代价而努力而的跟踪仍然可以从可选的应用级中获益总结在本文中我们介绍这个的生产环境下的分布式系统跟踪平台并汇报了我们开发和使用它的相关经验几乎在部署在所有的系统上并可以在不需要应用级修改的情况下进行跟踪而且没有明显的性能影响对于开发人员和运维团队带来的好处可以从我们主要的跟踪用户界面的广泛使用上看出来另外我们还列举了一些的使用用例来说明的作用这些用例有些甚至都没有开发团队参与而是被应用的开发者开发出来的据我们所知这是第一篇汇报生产环境下分布式系统跟踪框架的论文事实上我们的主要贡献源于这个事实论文中回顾的这个系统已经运行两年之久我们发现结合对开发人员提供简单和对应用系统完全透明来增强跟踪的这个决定是非常值得的我们相信比以前的基于的分布式跟踪达到更高的应用透明度这一点已经通过只需要少量人工干预的工作量得以证明虽然一定程度上得益于我们的系统的同质性但它本身仍然是一个重大的挑战最重要的是我们的设计提出了一些实现应用级透明性的充分条件对此我们希望能够对更错杂环境下的解决方案的开发有所帮助最后通过开放跟踪仓库给内部开发者我们促使更多的基于跟踪仓库的分析工具的产生而仅仅由团队默默的在信息孤岛中埋头苦干的结果远达不到现在这么大的规模这个决定促使了设计和实施的展开",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2025-04-03 20:08:00",postMainColor:""}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:(e,t,a)=>{var o;0!==a&&(o=Date.now(),localStorage.setItem(e,JSON.stringify({value:t,expiry:o+864e5*a})))},get:e=>{var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!(Date.now()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=(o,c={})=>new Promise((t,e)=>{let a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},Object.keys(c).forEach(e=>{a.setAttribute(e,c[e])}),document.head.appendChild(a)}),e.getCSS=(o,c=!1)=>new Promise((t,e)=>{let a=document.createElement("link");a.rel="stylesheet",a.href=o,c&&(a.id=c),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#18171d")},e.activateLightMode=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#f7f9fe")};var e=saveToLocal.get("theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches,a=window.matchMedia("(prefers-color-scheme: light)").matches,o=window.matchMedia("(prefers-color-scheme: no-preference)").matches,c=!t&&!a&&!o,t=(void 0===e?(a?activateLightMode():t?activateDarkMode():(o||c)&&((a=(new Date).getHours())<=8||22<=a?activateDarkMode:activateLightMode)(),window.matchMedia("(prefers-color-scheme: dark)").addListener(e=>{void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode:activateLightMode)()})):("light"===e?activateLightMode:activateDarkMode)(),saveToLocal.get("aside-status"));void 0!==t&&("hide"===t?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="https://s1.hdslb.com/bfs/static/jinkela/long/font/medium.css"><script src="https://cdn.dong4j.site/source/static/echarts.min.js"></script><link rel="stylesheet" href="https://cdn.dong4j.site/source/static/core.css"><link rel="stylesheet" href="https://cdn.dong4j.site/source/static/footer.css"><link rel="stylesheet" href="https://cdn.dong4j.site/source/static/index-imgloaded.css"><script src="https://cdn.dong4j.site/source/static/index-imgloaded.js"></script><script src="https://cdn.dong4j.site/source/static/detect-devtools.js"></script><script defer="" src="https://cdn.dong4j.site/source/static/umami.self.js" data-host-url="https://umami.dong4j.ink:1024" data-website-id="bd4721b7-a43f-4161-83ed-51c148a7ca9d"></script><script defer="" src="https://cdn.dong4j.site/source/static/counter.js" async="" id="online-counter" interval="60000" api="https://umami.dong4j.ink:1024/counter" room="000000001"></script><script src="https://cdn.dong4j.site/source/static/confetti.browser.min.js"></script><script src="https://cdn.dong4j.site/source/static/confetti.js"></script><meta name="generator" content="Hexo 7.2.0"><link rel="alternate" href="/atom.xml" title="司机带你开车" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="司机带你开车" type="application/rss+xml"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box"><div class="carplay"></div></div><script>let preloader={endLoading:()=>{document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",()=>{preloader.endLoading()}),setTimeout(function(){preloader.endLoading()},2e3),document.getElementById("loading-box").addEventListener("click",()=>{preloader.endLoading()}),document.addEventListener("pjax:send",()=>{preloader.initLoading()}),document.addEventListener("pjax:complete",()=>{preloader.endLoading()})</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"><script async="" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://home.dong4j.site" title="个人主页"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/homepage.webp" alt="个人主页"><span class="back-menu-item-text">个人主页</span></a><a class="back-menu-item" href="https://blog.dong4j.site" title="博客"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/blog.webp" alt="博客"><span class="back-menu-item-text">博客</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://resume.dong4j.site" title="简历"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/resume.webp" alt="简历"><span class="back-menu-item-text">简历</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://npx-card.dong4j.site" title="npx-card"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/npx-card.webp" alt="npx-card"><span class="back-menu-item-text">npx-card</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/watt-stack" title="Watt.Stack"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/watt.webp" alt="Watt.Stack"><span class="back-menu-item-text">Watt.Stack</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dong4j/markdown-image-kit" title="MIK"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/mik.webp" alt="MIK"><span class="back-menu-item-text">MIK</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dong4j/macOS-dev" title="macOS.dev"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/mac.webp" alt="macOS.dev"><span class="back-menu-item-text">macOS.dev</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://project.dong4j.site/" title="更多"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/project.webp" alt="更多"><span class="back-menu-item-text">更多</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">服务</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://uptime.dong4j.dev/status/services" title="服务状态"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/uptime-kuma.svg" alt="服务状态"><span class="back-menu-item-text">服务状态</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://nezha.dong4j.dev" title="服务面板"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/nezha.webp" alt="服务面板"><span class="back-menu-item-text">服务面板</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://nav.dong4j.dev" title="导航页"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/nav.webp" alt="导航页"><span class="back-menu-item-text">导航页</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://umami.dong4j.ink:1024/share/V7Rat8DdVw4npjl2/blog.dong4j.site" title="Umami"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/umami.webp" alt="Umami"><span class="back-menu-item-text">Umami</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://muselink.cc/dong4j 👈这是我的MuseLink数字名片！" title="数字名片"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/muse.lin.webp" alt="数字名片"><span class="back-menu-item-text">数字名片</span></a><a class="back-menu-item" href="/ai/deepseek-r1-webgpu/" title="DeepSeek"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/deepseek.webp" alt="DeepSeek"><span class="back-menu-item-text">DeepSeek</span></a><a class="back-menu-item" href="/ai/rmbg/playground/" title="RMBG"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/rmbg.webp" alt="RMBG"><span class="back-menu-item-text">RMBG</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://chat.dong4j.site/" title="Mini-Chat"><img class="back-menu-item-icon" src="https://cdn.dong4j.site/source/image/emoji1.webp" alt="Mini-Chat"><span class="back-menu-item-text">Mini-Chat</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">司机带你开车</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)" rel="external nofollow noreferrer">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size:.9em"></i><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size:.9em"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/messages/"><i class="fa fa-comments faa-tada"></i><span> 最新评论</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="fa fa-line-chart faa-tada"></i><span> 统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size:.9em"></i><span> 我的装备</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size:.9em"></i><span> 小空调</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/memos/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size:.9em"></i><span> 备忘录</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/todolist/"><i class="fa-solid fa-map faa-tada"></i><span> 折腾清单</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/stars/"><i class="fa-brands fa-github faa-tada"></i><span> Star 清单</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.dong4j.dev"><span>小黑屋</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole()"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://cdn.dong4j.site/source/image/wechat-pay.webp" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://cdn.dong4j.site/source/image/wechat-pay.webp"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.dong4j.site/source/image/alipay.webp" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://cdn.dong4j.site/source/image/alipay.webp"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title">最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/checkedexception/" style="font-size:1.05rem;color:#148f76">CheckedException<sup>1</sup></a><a href="/tags/error/" style="font-size:1.05rem;color:#7caa4e">Error<sup>1</sup></a><a href="/tags/exception/" style="font-size:1.05rem;color:#6ca2ab">Exception<sup>1</sup></a><a href="/tags/java/" style="font-size:1.05rem;color:#72966d">Java<sup>48</sup></a><a href="/tags/javabean/" style="font-size:1.05rem;color:#860ac1">JavaBean<sup>1</sup></a><a href="/tags/math/" style="font-size:1.05rem;color:#a75222">Math<sup>1</sup></a><a href="/tags/random/" style="font-size:1.05rem;color:#967478">Random<sup>1</sup></a><a href="/tags/runtimeexception/" style="font-size:1.05rem;color:#94aec3">RuntimeException<sup>1</sup></a><a href="/tags/string/" style="font-size:1.05rem;color:#453533">String<sup>2</sup></a><a href="/tags/stringbuffer/" style="font-size:1.05rem;color:#3f431c">StringBuffer<sup>2</sup></a><a href="/tags/stringbuilder/" style="font-size:1.05rem;color:#a0673c">StringBuilder<sup>1</sup></a><a href="/tags/throwable/" style="font-size:1.05rem;color:#ad4b80">Throwable<sup>1</sup></a><a href="/tags/final/" style="font-size:1.05rem;color:#77b142">final<sup>2</sup></a><a href="/tags/finalize/" style="font-size:1.05rem;color:#9a5c58">finalize<sup>1</sup></a><a href="/tags/finally/" style="font-size:1.05rem;color:#4fad4c">finally<sup>2</sup></a><a href="/tags/getter/" style="font-size:1.05rem;color:#a5c25f">getter<sup>1</sup></a><a href="/tags/new%E5%85%B3%E9%94%AE%E5%AD%97/" style="font-size:1.05rem;color:#050f6f">new关键字<sup>1</sup></a><a href="/tags/setter/" style="font-size:1.05rem;color:#85a1b8">setter<sup>1</sup></a><a href="/tags/static/" style="font-size:1.05rem;color:#096286">static<sup>1</sup></a><a href="/tags/super/" style="font-size:1.05rem;color:#4f916e">super<sup>2</sup></a><a href="/tags/this/" style="font-size:1.05rem;color:#869dc2">this<sup>1</sup></a><a href="/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/" style="font-size:1.05rem;color:#4d7499">二进制<sup>1</sup></a><a href="/tags/%E5%8C%85%E8%A3%85%E7%B1%BB/" style="font-size:1.05rem;color:#410937">包装类<sup>1</sup></a><a href="/tags/%E5%B0%81%E8%A3%85/" style="font-size:1.05rem;color:#768122">封装<sup>3</sup></a><a href="/tags/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" style="font-size:1.05rem;color:#501f70">异常处理<sup>3</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" style="font-size:1.05rem;color:#690252">数据类型<sup>4</sup></a><a href="/tags/%E6%96%B9%E6%B3%95%E9%87%8D%E8%BD%BD/" style="font-size:1.05rem;color:#a38b10">方法重载<sup>1</sup></a><a href="/tags/%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95/" style="font-size:1.05rem;color:#95a701">构造方法<sup>1</sup></a><a href="/tags/%E6%BA%A2%E5%87%BA/" style="font-size:1.05rem;color:#bf8181">溢出<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size:1.05rem;color:#4ec37b">算法<sup>1</sup></a><a href="/tags/%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/" style="font-size:1.05rem;color:#34c54f">类型转换<sup>3</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/" style="font-size:1.05rem;color:#74835a">线程安全<sup>1</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E5%AE%9E%E8%B7%B5/" style="font-size:1.05rem;color:#702108">编程实践<sup>2</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A8%8B%E5%BA%8F/" style="font-size:1.05rem;color:#3d022e">计算机程序<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%AF%AD%E8%A8%80/" style="font-size:1.05rem;color:#4c85aa">计算机语言<sup>1</sup></a><a href="/tags/%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6/" style="font-size:1.05rem;color:#23b3be">访问控制<sup>1</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6/" style="font-size:1.05rem;color:#95198d">软件<sup>1</sup></a><a href="/tags/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/" style="font-size:1.05rem;color:#92b58f">错误处理<sup>2</sup></a><a href="/tags/%E9%9A%8F%E6%9C%BA%E6%95%B0/" style="font-size:1.05rem;color:#34929b">随机数<sup>1</sup></a><a href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" style="font-size:1.05rem;color:#53ab26">面向对象<sup>6</sup></a></div></div><hr></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多"> <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/02/"><span class="card-archive-list-date">二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/01/"><span class="card-archive-list-date">一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/12/"><span class="card-archive-list-date">十二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">十一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/11/"><span class="card-archive-list-date">十一月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/10/"><span class="card-archive-list-date">十月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/06/"><span class="card-archive-list-date">六月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2022/11/"><span class="card-archive-list-date">十一月 2022</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div><div class="console-btn-item" id="consoleKeyboard" onclick="anzhiyu.keyboardToggle()" title="快捷键开关"><a class="keyboard-switch"><i class="anzhiyufont anzhiyu-icon-keyboard"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);" rel="external nofollow noreferrer"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/ai-%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" itemprop="url">AI:人工智能</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/dapper/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>Dapper</span></a><a class="article-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E8%B7%9F%E8%B8%AA%E7%B3%BB%E7%BB%9F/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>分布式跟踪系统</span></a><a class="article-meta__tags" href="/tags/google/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>Google</span></a><a class="article-meta__tags" href="/tags/%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>性能监控</span></a><a class="article-meta__tags" href="/tags/%E9%87%87%E6%A0%B7%E7%8E%87/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>采样率</span></a></span></div></div><h1 class="post-title" itemprop="name headline">Google Dapper：揭秘分布式跟踪系统的秘密</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2017-06-24T16:00:00.000Z" title="发表于 2017-06-25 00:00:00">2017-06-25</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-04-03T12:08:00.664Z" title="更新于 2025-04-03 20:08:00">2025-04-03</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">17.2k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>54分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" data-flag-title="Google Dapper：揭秘分布式跟踪系统的秘密"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator"> </span><span class="post-meta-position" title="作者IP属地为成都"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>成都</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/a69881a6.html#post-comment" tabindex="-1"><span id="twikoo-count"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://api.dong4j.ink:1024/cover?3cu41jed"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div class="post-ai-description"><div class="ai-title"><i class="fa-regular fa-robot fa-fade"></i><div class="ai-title-text">摘要助手</div><div id="ai-Toggle">切换</div><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i><i class="anzhiyufont anzhiyu-icon-circle-dot" title="朗读摘要"></i><div id="ai-tag">SummaryGPT</div></div><div class="ai-explanation">AI 初始化中...</div><div class="ai-btn-box"><div class="ai-btn-item">介绍自己 🙈</div><div class="ai-btn-item">生成摘要 👋</div><div class="ai-btn-item">推荐文章 📖</div><div class="ai-btn-item">前往主页 🏠</div><div class="ai-btn-item">前往订阅 💥</div><div class="ai-btn-item" id="go-comment">前往评论 💬</div><div class="ai-btn-item" id="read-audio">Kokoro TTS 🎙️</div><div class="ai-btn-item" id="go-tianli-blog">👀 部署教程</div></div><script data-pjax="" src="https://cdn.dong4j.site/source/static/ai_abstract.js"></script></div><article class="post-content" id="article-container" itemscope="" itemtype="https://blog.dong4j.site/posts/a69881a6.html"><header><a class="post-meta-categories" href="/categories/ai-%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" itemprop="url">AI:人工智能</a><a href="/tags/dapper/" tabindex="-1" itemprop="url">Dapper</a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E8%B7%9F%E8%B8%AA%E7%B3%BB%E7%BB%9F/" tabindex="-1" itemprop="url">分布式跟踪系统</a><a href="/tags/google/" tabindex="-1" itemprop="url">Google</a><a href="/tags/%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7/" tabindex="-1" itemprop="url">性能监控</a><a href="/tags/%E9%87%87%E6%A0%B7%E7%8E%87/" tabindex="-1" itemprop="url">采样率</a><h1 id="CrawlerTitle" itemprop="name headline">Google Dapper：揭秘分布式跟踪系统的秘密</h1><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">dong4j</span><time itemprop="dateCreated datePublished" datetime="2017-06-24T16:00:00.000Z" title="发表于 2017-06-25 00:00:00">2017-06-25</time><time itemprop="dateCreated datePublished" datetime="2025-04-03T12:08:00.664Z" title="更新于 2025-04-03 20:08:00">2025-04-03</time></header><meta name="referrer" content="no-referrer"><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?spm=4xu4xlmf" alt="random-pic-api"></p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL2JpZ2J1bGx5L0RhcHBlci10cmFuc2xhdGlvbg==">View project onGitHub</a></p><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>当代的互联网的服务，通常都是用复杂的、大规模分布式集群来实现的。互联网应用构建在不同的软件模块集上，这些软件模块，有可能是由不同的团队开发、可能使用不同的编程语言来实现、有可能布在了几千台服务器，横跨多个不同的数据中心。因此，就需要一些可以帮助理解系统行为、用于分析性能问题的工具。</p><p>Dapper–Google 生产环境下的分布式跟踪系统，应运而生。那么我们就来介绍一个大规模集群的跟踪系统，它是如何满足一个低损耗、应用透明的、大范围部署这三个需求的。当然<br>Dapper 设计之初，参考了一些其他分布式系统的理念，尤其是 Magpie 和 X-Trace，但是我们之所以能成功应用在生产环境上，还需要一些画龙点睛之笔，例如采样率的使用以及把代码植入限制在一小部分公共库的改造上。</p><p>自从 Dapper 发展成为一流的监控系统之后，给其他应用的开发者和运维团队帮了大忙，所以我们今天才发表这篇论文，来汇报一下这两年来，Dapper<br>是怎么构建和部署的。Dapper 最初只是作为一个自给自足的监控工具起步的，但最终进化成一个监控平台，这个监控平台促生出多种多样的监控工具，有些甚至已经不是由<br>Dapper 团队开发的了。下面我们会介绍一些使用 Dapper 搭建的分析工具，分享一下这些工具在 google 内部使用的统计数据，展现一些使用场景，最后会讨论一下我们迄今为止从<br>Dapper 收获了些什么。</p><h3 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h3><p>我们开发 Dapper 是为了收集更多的复杂分布式系统的行为信息，然后呈现给 Google<br>的开发者们。这样的分布式系统有一个特殊的好处，因为那些大规模的低端服务器，作为互联网服务的载体，是一个特殊的经济划算的平台。想要在这个上下文中理解分布式系统的行为，就需要监控那些横跨了不同的应用、不同的服务器之间的关联动作。</p><p>下面举一个跟搜索相关的例子，这个例子阐述了 Dapper 可以应对哪些挑战。比如一个前段服务可能对上百台查询服务器发起了一个 Web 查询，每一个查询都有自己的<br>Index。这个查询可能会被发送到多个的子系统，这些子系统分别用来处理广告、进行拼写检查或是查找一些像图片、视频或新闻这样的特殊结果。根据每个子系统的查询结果进行筛选，得到最终结果，最后汇总到页面上。我们把这种搜索模型称为<br>“全局搜索”（universal<br>search）。总的来说，这一次全局搜索有可能调用上千台服务器，涉及各种服务。而且，用户对搜索的耗时是很敏感的，而任何一个子系统的低效都导致导致最终的搜索耗时。如果一个工程师只能知道这个查询耗时不正常，但是他无从知晓这个问题到底是由哪个服务调用造成的，或者为什么这个调用性能差强人意。首先，这个工程师可能无法准确的定位到这次全局搜索是调用了哪些服务，因为新的服务、乃至服务上的某个片段，都有可能在任何时间上过线或修改过，有可能是面向用户功能，也有可能是一些例如针对性能或安全认证方面的功能改进。其次，你不能苛求这个工程师对所有参与这次全局搜索的服务都了如指掌，每一个服务都有可能是由不同的团队开发或维护的。再次，这些暴露出来的服务或服务器有可能同时还被其他客户端使用着，所以这次全局搜索的性能问题甚至有可能是由其他应用造成的。举个例子，一个后台服务可能要应付各种各样的请求类型，而一个使用效率很高的存储系统，比如<br>Bigtable，有可能正被反复读写着，因为上面跑着各种各样的应用。</p><p>上面这个案例中我们可以看到，对 Dapper 我们只有两点要求：无所不在的部署，持续的监控。无所不在的重要性不言而喻，因为在使用跟踪系统的进行监控时，即便只有一小部分没被监控到，那么人们对这个系统是不是值得信任都会产生巨大的质疑。另外，监控应该是<br>7x24 小时的，毕竟，系统异常或是那些重要的系统行为有可能出现过一次，就很难甚至不太可能重现。那么，根据这两个明确的需求，我们可以直接推出三个具体的设计目标：</p><ol><li>低消耗：跟踪系统对在线服务的影响应该做到足够小。在一些高度优化过的服务，即使一点点损耗也会很容易察觉到，而且有可能迫使在线服务的部署团队不得不将跟踪系统关停。</li><li>应用级的透明：对于应用的程序员来说，是不需要知道有跟踪系统这回事的。如果一个跟踪系统想生效，就必须需要依赖应用的开发者主动配合，那么这个跟踪系统也太脆弱了，往往由于跟踪系统在应用中植入代码的<br>bug 或疏忽导致应用出问题，这样才是无法满足对跟踪系统 “无所不在的部署” 这个需求。面对当下想 Google 这样的快节奏的开发环境来说，尤其重要。</li><li>延展性：Google 至少在未来几年的服务和集群的规模，监控系统都应该能完全把控住。</li></ol><p>一个额外的设计目标是为跟踪数据产生之后，进行分析的速度要快，理想情况是数据存入跟踪仓库后一分钟内就能统计出来。尽管跟踪系统对一小时前的旧数据进行统计也是相当有价值的，但如果跟踪系统能提供足够快的信息反馈，就可以对生产环境下的异常状况做出快速反应。</p><p>做到真正的应用级别的透明，这应该是当下面临的最挑战性的设计目标，我们把核心跟踪代码做的很轻巧，然后把它植入到那些无所不在的公共组件种，比如线程调用、控制流以及<br>RPC 库。使用自适应的采样率可以使跟踪系统变得可伸缩，并降低性能损耗，这些内容将在第 4.4<br>节中提及。结果展示的相关系统也需要包含一些用来收集跟踪数据的代码，用来图形化的工具，以及用来分析大规模跟踪数据的库和 API。虽然单独使用 Dapper<br>有时就足够让开发人员查明异常的来源，但是 Dapper 的初衷不是要取代所有其他监控的工具。我们发现，Dapper 的数据往往侧重性能方面的调查，所以其他监控工具也有他们各自的用处。</p><h2 id="1-1-文献的总结"><a href="#1-1-文献的总结" class="headerlink" title="1.1 文献的总结"></a>1.1 文献的总结</h2><p>分布式系统跟踪工具的设计空间已经被一些优秀文章探索过了，其中的 Pinpoint[9]、Magpie[3] 和 X-Trace[12] 和 Dapper<br>最为相近。这些系统在其发展过程的早期倾向于写入研究报告中，即便他们还没来得及清楚地评估系统当中一些设计的重要性。相比之下，由于 Dapper<br>已经在大规模生产环境中摸爬滚打了多年，经过这么多生产环境的验证之后，我们认为这篇论文最适合重点阐述在部署 Dapper<br>的过程中我们有那些收获，我们的设计思想是如何决定的，以及以什么样的方式实现它才会最有用。Dappe 作为一个平台，承载基于 Dapper 开发的性能分析工具，以及<br>Dapper 自身的监测工具，它的价值在于我们可以在回顾评估中找出一些意想不到的结果。</p><p>虽然 Dapper 在许多高阶的设计思想上吸取了 Pinpoint 和 Magpie 的研究成果，但在分布式跟踪这个领域中，Dapper<br>的实现包含了许多新的贡献。例如，我们想实现低损耗的话，特别是在高度优化的而且趋于极端延迟敏感的 Web 服务中，采样率是很必要的。或许更令人惊讶的是，我们发现即便是<br>1/1000 的采样率，对于跟踪数据的通用使用层面上，也可以提供足够多的信息。</p><p>我们的系统的另一个重要的特征，就是我们能实现的应用级的透明。我们的组件对应用的侵入被先限制在足够低的水平上，即使想 Google<br>网页搜索这么大规模的分布式系统，也可以直接进行跟踪而无需加入额外的标注 (Annotation)<br>。虽然由于我们的部署系统有幸是一定程度的同质化的，所以更容易做到对应用层的透明这点，但是我们证明了这是实现这种程度的透明性的充分条件。</p><h2 id="2-Dapper-的分布式跟踪"><a href="#2-Dapper-的分布式跟踪" class="headerlink" title="2. Dapper 的分布式跟踪"></a>2. Dapper 的分布式跟踪</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_Sz5MQBI6.webp" alt="20241229154732_Sz5MQBI6.webp"></p><p>图 1：这个路径由用户的 X 请求发起，穿过一个简单的服务系统。用字母标识的节点代表分布式系统中的不同处理过程。</p><p>分布式服务的跟踪系统需要记录在一次特定的请求后系统中完成的所有工作的信息。举个例子，图 1 展现的是一个和 5 台服务器相关的一个服务，包括：前端（A），两个中间层（B<br>和 C），以及两个后端（D 和 E）。当一个用户（这个用例的发起人）发起一个请求时，首先到达前端，然后发送两个 RPC 到服务器 B 和 C。B 会马上做出反应，但是 C<br>需要和后端的 D 和 E 交互之后再返还给 A，由 A<br>来响应最初的请求。对于这样一个请求，简单实用的分布式跟踪的实现，就是为服务器上每一次你发送和接收动作来收集跟踪标识符 (message identifiers)<br>和时间戳 (timestamped events)。</p><p>为了将所有记录条目与一个给定的发起者（例如，图 1 中的 RequestX）关联上并记录所有信息，现在有两种解决方案，黑盒 (black-box) 和基于标注 (<br>annotation-based) 的监控方案。黑盒方案 [1，15，2]<br>假定需要跟踪的除了上述信息之外没有额外的信息，这样使用统计回归技术来推断两者之间的关系。基于标注的方案 [3，12，9，16] 依赖于应用程序或中间件明确地标记一个全局<br>ID，从而连接每一条记录和发起者的请求。虽然黑盒方案比标注方案更轻便，他们需要更多的数据，以获得足够的精度，因为他们依赖于统计推论。基于标注的方案最主要的缺点是，很明显，需要代码植入。在我们的生产环境中，因为所有的应用程序都使用相同的线程模型，控制流和<br>RPC 系统，我们发现，可以把代码植入限制在一个很小的通用组件库中，从而实现了监测系统的应用对开发人员是有效地透明。</p><p>我们倾向于认为，Dapper 的跟踪架构像是内嵌在 RPC 调用的树形结构。然而，我们的核心数据模型不只局限于我们的特定的 RPC 框架，我们还能跟踪其他行为，例如<br>Gmail 的 SMTP 会话，外界的 HTTP 请求，和外部对 SQL 服务器的查询等。从形式上看，我们的 Dapper 跟踪模型使用的树形结构，Span 以及 Annotation。</p><h2 id="2-1-跟踪树和-span"><a href="#2-1-跟踪树和-span" class="headerlink" title="2.1 跟踪树和 span"></a>2.1 跟踪树和 span</h2><p>在 Dapper 跟踪树结构中，树节点是整个架构的基本单元，而每一个节点又是对 span 的引用。节点之间的连线表示的 span 和它的父 span 直接的关系。虽然<br>span 在日志文件中只是简单的代表 span 的开始和结束时间，他们在整个树形结构中却是相对独立的，任何 RPC 相关的时间数据、零个或多个特定应用程序的<br>Annotation 的相关内容会在 2.3 节中讨论。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_HfF91uBJ.webp" alt="20241229154732_HfF91uBJ.webp"></p><p>图 2：5 个 span 在 Dapper 跟踪树种短暂的关联关系</p><p>在图 2 中说明了 span 在一个大的跟踪过程中是什么样的。Dapper 记录了 span 名称，以及每个 span 的 ID 和父 ID，以重建在一次追踪过程中不同 span<br>之间的关系。如果一个 span 没有父 ID 被称为 root span。所有 span 都挂在一个特定的跟踪上，也共用一个跟踪 id（在图中未示出）。所有这些 ID 用全局唯一的<br>64 位整数标示。在一个典型的 Dapper 跟踪中，我们希望为每一个 RPC 对应到一个单一的 span 上，而且每一个额外的组件层都对应一个跟踪树型结构的层级。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_XFQ7JCFQ.webp" alt="20241229154732_XFQ7JCFQ.webp"></p><p>图 3：在图 2 中所示的一个单独的 span 的细节图</p><p>图 3 给出了一个更详细的典型的 Dapper 跟踪 span 的记录点的视图。在图 2 中这种某个 span 表述了两个 “Helper.Call” 的 RPC(分别为 server 端和<br>client 端)。span 的开始时间和结束时间，以及任何 RPC 的时间信息都通过 Dapper 在 RPC 组件库的植入记录下来。如果应用程序开发者选择在跟踪中增加他们自己的注释（如图中<br>“foo” 的注释）(业务数据)，这些信息也会和其他 span 信息一样记录下来。</p><p>记住，任何一个 span 可以包含来自不同的主机信息，这些也要记录下来。事实上，每一个 RPC span 可以包含客户端和服务器两个过程的注释，使得链接两个主机的<br>span 会成为模型中所说的 span。由于客户端和服务器上的时间戳来自不同的主机，我们必须考虑到时间偏差。在我们的分析工具，我们利用了这个事实：RPC<br>客户端发送一个请求之后，服务器端才能接收到，对于响应也是一样的（服务器先响应，然后客户端才能接收到这个响应）。这样一来，服务器端的 RPC<br>就有一个时间戳的一个上限和下限。</p><h2 id="2-2-植入点"><a href="#2-2-植入点" class="headerlink" title="2.2 植入点"></a>2.2 植入点</h2><p>Dapper 可以以对应用开发者近乎零浸入的成本对分布式控制路径进行跟踪，几乎完全依赖于基于少量通用组件库的改造。如下：</p><ul><li>当一个线程在处理跟踪控制路径的过程中，Dapper 把这次跟踪的上下文的在 ThreadLocal 中进行存储。追踪上下文是一个小而且容易复制的容器，其中承载了<br>Scan 的属性比如跟踪 ID 和 span ID。</li><li>当计算过程是延迟调用的或是异步的，大多数 Google 开发者通过线程池或其他执行器，使用一个通用的控制流库来回调。Dapper<br>确保所有这样的回调可以存储这次跟踪的上下文，而当回调函数被触发时，这次跟踪的上下文会与适当的线程关联上。在这种方式下，Dapper 可以使用 trace ID<br>和 span ID 来辅助构建异步调用的路径。</li><li>几乎所有的 Google 的进程间通信是建立在一个用 C++ 和 Java 开发的 RPC 框架上。我们把跟踪植入该框架来定义 RPC 中所有的 span。span 的 ID 和跟踪的<br>ID 会从客户端发送到服务端。像那样的基于 RPC 的系统被广泛使用在 Google 中，这是一个重要的植入点。当那些非 RPC 通信框架发展成熟并找到了自己的用户群之后，我们会计划对<br>RPC 通信框架进行植入。</li></ul><p>Dapper 的跟踪数据是独立于语言的，很多在生产环境中的跟踪结合了用 C++ 和 Java 写的进程的数据。在 3.2 节中，我们讨论应用程序的透明度时我们会把这些理论的是如何实践的进行讨论。</p><h2 id="2-3-Annotation"><a href="#2-3-Annotation" class="headerlink" title="2.3 Annotation"></a>2.3 Annotation</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_P1fOvOJA.webp" alt="20241229154732_P1fOvOJA.webp"></p><p>上述植入点足够推导出复杂的分布式系统的跟踪细节，使得 Dapper 的核心功能在不改动 Google 应用的情况下可用。然而，Dapper 还允许应用程序开发人员在<br>Dapper 跟踪的过程中添加额外的信息，以监控更高级别的系统行为，或帮助调试问题。我们允许用户通过一个简单的 API 定义带时间戳的 Annotation，核心的示例代码入图<br>4 所示。这些 Annotation 可以添加任意内容。为了保护 Dapper 的用户意外的过分热衷于日志的记录，每一个跟踪 span 有一个可配置的总 Annotation<br>量的上限。但是，应用程序级的 Annotation 是不能替代用于表示 span 结构的信息和记录着 RPC 相关的信息。</p><p>除了简单的文本 Annotation，Dapper 也支持的 key-value 映射的 Annotation，提供给开发人员更强的跟踪能力，如持续的计数器，二进制消息记录和在一个进程上跑着的任意的用户数据。键值对的<br>Annotation 方式用来在分布式追踪的上下文中定义某个特定应用程序的相关类型。</p><h2 id="2-4-采样率"><a href="#2-4-采样率" class="headerlink" title="2.4 采样率"></a>2.4 采样率</h2><p>低损耗的是 Dapper 的一个关键的设计目标，因为如果这个工具价值未被证实但又对性能有影响的话，你可以理解服务运营人员为什么不愿意部署它。况且，我们想让开发人员使用<br>Annotation 的 API，而不用担心额外的开销。我们还发现，某些类型的 Web 服务对植入带来的性能损耗确实非常敏感。因此，除了把 Dapper<br>的收集工作对基本组件的性能损耗限制的尽可能小之外，我们还有进一步控制损耗的办法，那就是遇到大量请求时只记录其中的一小部分。我们将在 4.4<br>节中讨论跟踪的采样率方案的更多细节。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_ZrsnqkWv.webp" alt="20241229154732_ZrsnqkWv.webp"></p><p>图 5：Dapper 收集管道的总览</p><h2 id="2-5-跟踪的收集"><a href="#2-5-跟踪的收集" class="headerlink" title="2.5 跟踪的收集"></a>2.5 跟踪的收集</h2><p>Dapper 的跟踪记录和收集管道的过程分为三个阶段（参见图 5）。首先，span 数据写入（1）本地日志文件中。然后 Dapper<br>的守护进程和收集组件把这些数据从生产环境的主机中拉出来（2），最终写到（3）Dapper 的 Bigtable 仓库中。一次跟踪被设计成 Bigtable 中的一行，每一列相当于一个<br>span。Bigtable 的支持稀疏表格布局正适合这种情况，因为每一次跟踪可以有任意多个 span。跟踪数据收集（即从应用中的二进制数据传输到中央仓库所花费的时间）的延迟中位数少于<br>15 秒。第 98 百分位的延迟 (The 98th percentile latency) 往往随着时间的推移呈现双峰型; 大约 75% 的时间，第 98 百分位的延迟时间小于 2 分钟，但是另外大约<br>25% 的时间，它可以增涨到几个小时。</p><p>Dapper 还提供了一个 API 来简化访问我们仓库中的跟踪数据。 Google 的开发人员用这个 API，以构建通用和特定应用程序的分析工具。第 5.1 节包含更多如何使用它的信息。</p><h2 id="2-5-1-带外数据跟踪收集"><a href="#2-5-1-带外数据跟踪收集" class="headerlink" title="2.5.1 带外数据跟踪收集"></a>2.5.1 带外数据跟踪收集</h2><p>tip1: 带外数据: 传输层协议使用带外数据 (out-of-band，OOB) 来发送一些重要的数据, 如果通信一方有重要的数据需要通知对方时,<br>协议能够将这些数据快速地发送到对方。为了发送这些数据，协议一般不使用与普通数据相同的通道, 而是使用另外的通道。</p><p>tip2: 这里指的 in-band 策略是把跟踪数据随着调用链进行传送，out-of-band 是通过其他的链路进行跟踪数据的收集，Dapper 的写日志然后进行日志采集的方式就属于<br>out-of-band 策略</p><p>Dapper 系统请求树树自身进行跟踪记录和收集带外数据。这样做是为两个不相关的原因。首先，带内收集方案 – 这里跟踪数据会以 RPC 响应头的形式被返回 –<br>会影响应用程序网络动态。在 Google 里的许多规模较大的系统中，一次跟踪成千上万的 span 并不少见。然而，RPC 回应大小 –<br>甚至是接近大型分布式的跟踪的根节点的这种情况下 – 仍然是比较小的：通常小于 10K。在这种情况下，带内 Dapper<br>的跟踪数据会让应用程序数据和倾向于使用后续分析结果的数据量相形见绌。其次，带内收集方案假定所有的 RPC<br>是完美嵌套的。我们发现，在所有的后端的系统返回的最终结果之前，有许多中间件会把结果返回给他们的调用者。带内收集系统是无法解释这种非嵌套的分布式执行模式的。</p><h2 id="2-6-安全和隐私考虑"><a href="#2-6-安全和隐私考虑" class="headerlink" title="2.6 安全和隐私考虑"></a>2.6 安全和隐私考虑</h2><p>记录一定量的 RPC 有效负载信息将丰富 Dapper<br>的跟踪能力，因为分析工具能够在有效载荷数据（方法传递的参数）中找到相关的样例，这些样例可以解释被监控系统的为何表现异常。然而，有些情况下，有效载荷数据可能包含的一些不应该透露给未经授权用户 (<br>包括正在 debug 的工程师) 的内部信息。</p><p>由于安全和隐私问题是不可忽略的，dapper 中的虽然存储 RPC 方法的名称，但在这个时候不记录任何有效载荷数据。相反，应用程序级别的 Annotation<br>提供了一个方便的可选机制：应用程序开发人员可以在 span 中选择关联那些为以后分析提供价值的数据。</p><p>Dapper 还提供了一些安全上的便利，是它的设计者事先没有预料到的。通过跟踪公开的安全协议参数，Dapper 可以通过相应级别的认证或加密，来监视应用程序是否满足安全策略。例如。Dapper<br>还可以提供信息，以基于策略的的隔离系统按预期执行，例如支撑敏感数据的应用程序不与未经授权的系统组件进行了交互。这样的测算提供了比源码审核更强大的保障。</p><h2 id="3-Dapper-部署状况"><a href="#3-Dapper-部署状况" class="headerlink" title="3. Dapper 部署状况"></a>3. Dapper 部署状况</h2><p>Dapper 作为我们生产环境下的跟踪系统已经超过两年。在本节中，我们会汇报系统状态，把重点放在 Dapper 如何满足了我们的目标——无处不在的部署和应用级的透明。</p><h2 id="3-1-Dapper-运行库"><a href="#3-1-Dapper-运行库" class="headerlink" title="3.1 Dapper 运行库"></a>3.1 Dapper 运行库</h2><p>也许 Dapper 代码中中最关键的部分，就是对基础 RPC、线程控制和流程控制的组件库的植入，其中包括 span<br>的创建，采样率的设置，以及把日志写入本地磁盘。除了做到轻量级，植入的代码更需要稳定和健壮，因为它与海量的应用对接，维护和 bug 修复变得困难。植入的核心代码是由未超过<br>1000 行的 C++ 和不超过 800 行 Java 代码组成。为了支持键值对的 Annotation 还添加了额外的 500 行代码。</p><h2 id="3-2-生产环境下的涵盖面"><a href="#3-2-生产环境下的涵盖面" class="headerlink" title="3.2 生产环境下的涵盖面"></a>3.2 生产环境下的涵盖面</h2><p>Dapper 的渗透可以总结为两个方面：一方面是可以创建 Dapper 跟踪的过程 (与 Dapper 植入的组件库相关)，和生产环境下的服务器上在运行 Dapper<br>跟踪收集守护进程。Dapper 的守护进程的分布相当于我们服务器的简单的拓扑图，它存在于 Google 几乎所有的服务器上。这很难确定精确的 Dapper-ready<br>进程部分，因为过程即便不产生跟踪信息 Dapper 也是无从知晓的。尽管如此，考虑到无处不在 Dapper 组件的植入库，我们估计几乎每一个 Google<br>的生产进程都是支持跟踪的。</p><p>在某些情况下 Dapper 的是不能正确的跟踪控制路径的。这些通常源于使用非标准的控制流，或是 Dapper 的错误的把路径关联归到不相关的事件上。Dapper<br>提供了一个简单的库来帮助开发者手动控制跟踪传播作为一种变通方法。目前有 40 个 C++ 应用程序和 33 个 Java<br>应用程序需要一些手动控制的追踪传播，不过这只是上千个的跟踪中的一小部分。也有非常小的一部分程序使用的非组件性质的通信库（比如原生的 TCP Socket 或<br>SOAP RPC），因此不能直接支持 Dapper 的跟踪。但是这些应用可以单独接入到 Dapper 中，如果需要的话。</p><p>考虑到生产环境的安全，Dapper 的跟踪也可以关闭。事实上，它在部署的早起就是默认关闭的，直到我们对 Dapper 的稳定性和低损耗有了足够的信心之后才把它开启。Dapper<br>的团队偶尔会执行审查寻找跟踪配置的变化，来看看那些服务关闭了 Dapper 的跟踪。但这种情况不多见，而且通常是源于对监控对性能消耗的担忧。经过了对实际性能消耗的进一步调查和测量，所有这些关闭<br>Dapper 跟踪都已经恢复开启了，不过这些已经不重要了。</p><h2 id="3-3-跟踪-Annotation-的使用"><a href="#3-3-跟踪-Annotation-的使用" class="headerlink" title="3.3 跟踪 Annotation 的使用"></a>3.3 跟踪 Annotation 的使用</h2><p>程序员倾向于使用特定应用程序的 Annotation，无论是作为一种分布式调试日志文件，还是通过一些应用程序特定的功能对跟踪进行分类。例如，所有的 Bigtable<br>的请求会把被访问的表名也记录到 Annotation 中。目前，70％的 Dapper span 和 90％的所有 Dapper 跟踪都至少有一个特殊应用的 Annotation。</p><p>41 个 Java 应用和 68 个 C++ 应用中都添加自定义的 Annotation 为了更好地理解应用程序中的 span 在他们的服务中的行为。值得注意的是，迄今为止我们的<br>Java 开发者比 C++ 开发者更多的在每一个跟踪 span 上采用 Annotation 的 API。这可能是因为我们的 Java 应用的作用域往往是更接近最终用户 (C++<br>偏底层); 这些类型的应用程序经常处理更广泛的请求组合，因此具有比较复杂的控制路径。</p><h2 id="4-处理跟踪损耗"><a href="#4-处理跟踪损耗" class="headerlink" title="4. 处理跟踪损耗"></a>4. 处理跟踪损耗</h2><p>跟踪系统的成本由两部分组成：</p><ol><li>正在被监控的系统在生成追踪和收集追踪数据的消耗导致系统性能下降，</li><li>需要使用一部分资源来存储和分析跟踪数据。虽然你可以说一个有价值的组件植入跟踪带来一部分性能损耗是值得的，我们相信如果基本损耗能达到可以忽略的程度，那么对跟踪系统最初的推广会有极大的帮助。</li></ol><p>在本节中，我们会展现一下三个方面：Dapper 组件操作的消耗，跟踪收集的消耗，以及 Dapper 对生产环境负载的影响。我们还介绍了 Dapper<br>可调节的采样率机制如何帮我们处理低损耗和跟踪代表性之间的平衡和取舍。</p><h2 id="4-1-生成跟踪的损耗"><a href="#4-1-生成跟踪的损耗" class="headerlink" title="4.1 生成跟踪的损耗"></a>4.1 生成跟踪的损耗</h2><p>生成跟踪的开销是 Dapper 性能影响中最关键的部分，因为收集和分析可以更容易在紧急情况下被关闭。Dapper 运行库中最重要的跟踪生成消耗在于创建和销毁<br>span 和 annotation，并记录到本地磁盘供后续的收集。根 span 的创建和销毁需要损耗平均 204 纳秒的时间，而同样的操作在其他 span 上需要消耗 176<br>纳秒。时间上的差别主要在于需要在跟 span 上给这次跟踪分配一个全局唯一的 ID。</p><p>如果一个 span 没有被采样的话，那么这个额外的 span 下创建 annotation 的成本几乎可以忽略不计，他由在 Dapper 运行期对 ThreadLocal 查找操作构成，这平均只消耗<br>9 纳秒。如果这个 span 被计入采样的话，会用一个用字符串进行标注 – 在图 4 中有展现 – 平均需要消耗 40 纳秒。这些数据都是在 2.2GHz 的 x86<br>服务器上采集的。</p><p>在 Dapper 运行期写入到本地磁盘是最昂贵的操作，但是他们的可见损耗大大减少，因为写入日志文件和操作相对于被跟踪的应用系统来说都是异步的。不过，日志写入的操作如果在大流量的情况，尤其是每一个请求都被跟踪的情况下就会变得可以察觉到。我们记录了在<br>4.3 节展示了一次 Web 搜索的负载下的性能消耗。</p><h2 id="4-2-跟踪收集的消耗"><a href="#4-2-跟踪收集的消耗" class="headerlink" title="4.2 跟踪收集的消耗"></a>4.2 跟踪收集的消耗</h2><p>读出跟踪数据也会对正在被监控的负载产生干扰。表 1 展示的是最坏情况下，Dapper 收集日志的守护进程在高于实际情况的负载基准下进行测试时的 cpu<br>使用率。在生产环境下，跟踪数据处理中，这个守护进程从来没有超过 0.3% 的单核 cpu 使用率，而且只有很少量的内存使用（以及堆碎片的噪音）。我们还限制了<br>Dapper 守护进程为内核 scheduler 最低的优先级，以防在一台高负载的服务器上发生 cpu 竞争。</p><p>Dapper 也是一个带宽资源的轻量级的消费者，每一个 span 在我们的仓库中传输只占用了平均 426 的 byte。作为网络行为中的极小部分，Dapper 的数据收集在<br>Google 的生产环境中的只占用了 0.01% 的网络资源。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_jRzkp5pe.webp" alt="20241229154732_jRzkp5pe.webp"></p><p>表 1：Dapper 守护进程在负载测试时的 CPU 资源使用率</p><h2 id="4-3-在生产环境下对负载的影响"><a href="#4-3-在生产环境下对负载的影响" class="headerlink" title="4.3 在生产环境下对负载的影响"></a>4.3 在生产环境下对负载的影响</h2><p>每个请求都会利用到大量的服务器的高吞吐量的线上服务，这是对有效跟踪最主要的需求之一；这种情况需要生成大量的跟踪数据，并且他们对性能的影响是最敏感的。在表<br>2 中我们用集群下的网络搜索服务作为例子，我们通过调整采样率，来衡量 Dapper 在延迟和吞吐量方面对性能的影响。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_NRNUPfjs.webp" alt="20241229154732_NRNUPfjs.webp"></p><p>表 2：网络搜索集群中，对不同采样率对网络延迟和吞吐的影响。延迟和吞吐的实验误差分别是 2.5% 和 0.15%。</p><p>我们看到，虽然对吞吐量的影响不是很明显，但为了避免明显的延迟，跟踪的采样还是必要的。然而，延迟和吞吐量的带来的损失在把采样率调整到小于 1/16<br>之后就全部在实验误差范围内。在实践中，我们发现即便采样率调整到 1/1024 仍然是有足够量的跟踪数据的用来跟踪大量的服务。保持 Dapper<br>的性能损耗基线在一个非常低的水平是很重要的，因为它为那些应用提供了一个宽松的环境使用完整的 Annotation API<br>而无惧性能损失。使用较低的采样率还有额外的好处，可以让持久化到硬盘中的跟踪数据在垃圾回收机制处理之前保留更长的时间，这样为 Dapper<br>的收集组件给了更多的灵活性。</p><h2 id="4-4-可变采样"><a href="#4-4-可变采样" class="headerlink" title="4.4 可变采样"></a>4.4 可变采样</h2><p>任何给定进程的 Dapper 的消耗和每个进程单位时间的跟踪的采样率成正比。Dapper 的第一个生产版本在 Google 内部的所有进程上使用统一的采样率，为<br>1/1024。这个简单的方案是对我们的高吞吐量的线上服务来说是非常有用，因为那些感兴趣的事件 (在大吞吐量的情况下) 仍然很有可能经常出现，并且通常足以被捕捉到。</p><p>然而，在较低的采样率和较低的传输负载下可能会导致错过重要事件，而想用较高的采样率就需要能接受的性能损耗。对于这样的系统的解决方案就是覆盖默认的采样率，这需要手动干预的，这种情况是我们试图避免在<br>dapper 中出现的。</p><p>我们在部署可变采样的过程中，参数化配置采样率时，不是使用一个统一的采样方案，而是使用一个采样期望率来标识单位时间内采样的追踪。这样一来，低流量低负载自动提高采样率，而在高流量高负载的情况下会降低采样率，使损耗一直保持在控制之下。实际使用的采样率会随着跟踪本身记录下来，这有利于从<br>Dapper 的跟踪数据中准确的分析。</p><h2 id="4-5-应对积极采样-Coping-with-aggressive-sampling"><a href="#4-5-应对积极采样-Coping-with-aggressive-sampling" class="headerlink" title="4.5 应对积极采样 (Coping with aggressive sampling)"></a>4.5 应对积极采样 (Coping with aggressive sampling)</h2><p>新的 Dapper 用户往往觉得低采样率 – 在高吞吐量的服务下经常低至 0.01％– 将会不利于他们的分析。我们在 Google<br>的经验使我们相信，对于高吞吐量服务，积极采样 (aggressive sampling)<br>并不妨碍最重要的分析。如果一个显着的操作在系统中出现一次，他就会出现上千次。低吞吐量的服务 – 也许是每秒请求几十次，而不是几十万 –<br>可以负担得起跟踪每一个请求，这是促使我们下决心使用自适应采样率的原因。</p><h2 id="4-6-在收集过程中额外的采样"><a href="#4-6-在收集过程中额外的采样" class="headerlink" title="4.6 在收集过程中额外的采样"></a>4.6 在收集过程中额外的采样</h2><p>上述采样机制被设计为尽量减少与 Dapper 运行库协作的应用程序中明显的性能损耗。Dapper 的团队还需要控制写入中央资料库的数据的总规模，因此为达到这个目的，我们结合了二级采样。</p><p>目前我们的生产集群每天产生超过 1TB 的采样跟踪数据。Dapper 的用户希望生产环境下的进程的跟踪数据从被记录之后能保存至少两周的时间。逐渐增长的追踪数据的密度必须和<br>Dapper 中央仓库所消耗的服务器及硬盘存储进行权衡。对请求的高采样率还使得 Dapper 收集器接近写入吞吐量的上限。</p><p>为了维持物质资源的需求和渐增的 Bigtable 的吞吐之间的灵活性，我们在收集系统自身上增加了额外的采样率的支持。我们充分利用所有 span<br>都来自一个特定的跟踪并分享同一个跟踪 ID 这个事实，虽然这些 span 有可能横跨了数千个主机。对于在收集系统中的每一个 span，我们用 hash 算法把跟踪<br>ID 转成一个标量 Z，这里 0&lt;=Z&lt;=1。如果 Z 比我们收集系统中的系数低的话，我们就保留这个 span 信息，并写入到 Bigtable 中。反之，我们就抛弃他。通过在采样决策中的跟踪<br>ID，我们要么保存、要么抛弃整个跟踪，而不是单独处理跟踪内的 span。我们发现，有了这个额外的配置参数使管理我们的收集管道变得简单多了，因为我们可以很容易地在配置文件中调整我们的全局写入率这个参数。</p><p>如果整个跟踪过程和收集系统只使用一个采样率参数确实会简单一些，但是这就不能应对快速调整在所有部署的节点上的运行期采样率配置的这个要求。我们选择了运行期采样率，这样就可以优雅的去掉我们无法写入到仓库中的多余数据，我们还可以通过调节收集系统中的二级采样率系数来调整这个运行期采样率。Dapper<br>的管道维护变得更容易，因为我们就可以通过修改我们的二级采样率的配置，直接增加或减少我们的全局覆盖率和写入速度。</p><h2 id="5-通用的-Dapper-工具"><a href="#5-通用的-Dapper-工具" class="headerlink" title="5. 通用的 Dapper 工具"></a>5. 通用的 Dapper 工具</h2><p>几年前，当 Dapper 还只是个原型的时候，它只能在 Dapper 开发者耐心的支持下使用。从那时起，我们逐渐迭代的建立了收集组件，编程接口，和基于 Web<br>的交互式用户界面，帮助 Dapper 的用户独立解决自己的问题。在本节中，我们会总结一下哪些的方法有用，哪些用处不大，我们还提供关于这些通用的分析工具的基本的使用信息。</p><h2 id="5-1-Dapper-Depot-API"><a href="#5-1-Dapper-Depot-API" class="headerlink" title="5.1 Dapper Depot API"></a>5.1 Dapper Depot API</h2><p>Dapper 的 “Depot API” 或称作 DAPI，提供在 Dapper 的区域仓库中对分布式跟踪数据一个直接访问。DAPI 和 Dapper 跟踪仓库被设计成串联的，而且 DAPI<br>意味着对 Dapper 仓库中的元数据暴露一个干净和直观的的接口。我们使用了以下推荐的三种方式去暴露这样的接口：</p><ul><li>通过跟踪 ID 来访问：DAPI 可以通过他的全局唯一的跟踪 ID 读取任何一次跟踪信息。</li><li>批量访问：DAPI 可以利用的 MapReduce 提供对上亿条 Dapper 跟踪数据的并行读取。用户重写一个虚拟函数，它接受一个 Dapper<br>的跟踪信息作为其唯一的参数，该框架将在用户指定的时间窗口中调用每一次收集到的跟踪信息。</li><li>索引访问：Dapper 的仓库支持一个符合我们通用调用模板的唯一索引。该索引根据通用请求跟踪特性 (commonly-requested trace features) 进行绘制来识别<br>Dapper 的跟踪信息。因为跟踪 ID 是根据伪随机的规则创建的，这是最好的办法去访问跟某个服务或主机相关的跟踪数据。</li></ul><p>所有这三种访问模式把用户指向不同的 Dapper 跟踪记录。正如第 2.1 节所述的，Dapper 的由 span 组成的跟踪数据是用树形结构建模的，因此，跟踪数据的数据结构，也是一个简单的由<br>span 组成遍历树。Span 就相当于 RPC 调用，在这种情况下，RPC 的时间信息是可用的。带时间戳的特殊的应用标注也是可以通过这个 span 结构来访问的。</p><p>选择一个合适的自定义索引是 DAPI 设计中最具挑战性的部分。压缩存储要求在跟踪数据种建立一个索引的情况只比实际数据小<br>26%，所以消耗是巨大的。最初，我们部署了两个索引：第一个是主机索引，另一个是服务名的索引。然而，我们并没有找到主机索引和存储成本之间的利害关系。当用户对每一台主机感兴趣的时候，他们也会对特定的服务感兴趣，所以我们最终选择把两者相结合，成为一个组合索引，它允许以服务名称，主机，和时间戳的顺序进行有效的查找。</p><h2 id="5-1-1-DAPI-在-Google-内部的使用"><a href="#5-1-1-DAPI-在-Google-内部的使用" class="headerlink" title="5.1.1 DAPI 在 Google 内部的使用"></a>5.1.1 DAPI 在 Google 内部的使用</h2><p>DAPI 在谷歌的使用有三类：使利用 DAPI 的持续的线上 Web 应用，维护良好的可以在控制台上调用的基于 DAPI 的工具，可以被写入，运行、不过大部分已经被忘记了的一次性分析工具。我们知道的有<br>3 个持久性的基于 DAPI 的应用程序，8 个额外的按需定制的基于 DAPI 分析工具，以及使用 DAPI 框架构建的约 15~20<br>一次性的分析工具。在这之后的工具就这是很难说明了，因为开发者可以构建、运行和丢弃这些项目，而不需要 Dapper 团队的技术支持。</p><h2 id="5-2-Dapper-的用户接口"><a href="#5-2-Dapper-的用户接口" class="headerlink" title="5.2 Dapper 的用户接口"></a>5.2 Dapper 的用户接口</h2><p>绝大多数用户使用发生在基于 web 的用户交互接口。篇幅有限，我们不能列出每一个特点，而只能把典型的用户工作流在图 6 中展示。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_W4wKk8eh.webp" alt="20241229154732_W4wKk8eh.webp"></p><ol><li>用户描述的他们关心的服务和时间，和其他任何他们可以用来区分跟踪模板的信息（比如，span 的名称）。他们还可以指定与他们的搜索最相关的成本度量 (<br>cost metric)(比如，服务响应时间)。</li><li>一个关于性能概要的大表格，对应确定的服务关联的所有分布式处理图表。用户可以把这些执行图标排序成他们想要的，并选择一种直方图去展现出更多的细节。</li><li>一旦某个单一的分布式执行部分被选中后，用户能看到关于执行部分的的图形化描述。被选中的服务被高亮展示在该图的中心。</li><li>在生成与步骤 1 中选中的成本度量 (cost metric) 维度相关的统计信息之后，Dapper<br>的用户界面会提供了一个简单的直方图。在这个例子中，我们可以看到一个大致的所选中部分的分布式响应时间分布图。用户还会看到一个关于具体的跟踪信息的列表，展现跟踪信息在直方图中被划分为的不同区域。在这个例子中，用户点击列表种第二个跟踪信息实例时，会在下方看到这个跟踪信息的详细视图 (<br>步骤 5)。</li><li>绝大多数 Dapper<br>的使用者最终的会检查某个跟踪的情况，希望能收集一些信息去了解系统行为的根源所在。我们没有足够的空间来做跟踪视图的审查，但我们使用由一个全局时间轴（在上方可以看到），并能够展开和折叠树形结构的交互方式，这也很有特点。分布式跟踪树的连续层用内嵌的不同颜色的矩形表示。每一个<br>RPC 的 span 被从时间上分解为一个服务器进程中的消耗（绿色部分）和在网络上的消耗（蓝色部分）。用户 Annotation 没有显示在这个截图中，但他们可以选择性的以<br>span 的形式包含在全局时间轴上。</li></ol><p>为了让用户查询实时数据，Dapper 的用户界面能够直接与 Dapper<br>每一台生产环境下的服务器上的守护进程进行交互。在该模式下，不可能指望能看到上面所说的系统级的图表展示，但仍然可以很容易基于性能和网络特性选取一个特定的跟踪。在这种模式下，可在几秒钟内查到实时的数据。</p><p>根据我们的记录，大约有 200 个不同的 Google 工程师在一天内使用的 Dapper 的 UI; 在一周的过程中，大约有 750-1000<br>不同的用户。这些用户数，在新功能的内部通告上，是按月连续的。通常用户会发送特定跟踪的连接，这将不可避免地在查询跟踪情况时中产生很多一次性的，持续时间较短的交互。</p><h2 id="6-经验"><a href="#6-经验" class="headerlink" title="6. 经验"></a>6. 经验</h2><p>Dapper 在 Google 被广泛应用，一部分直接通过 Dapper 的用户界面，另一部分间接地通过对 Dapper API 的二次开发或者建立在基于 api<br>的应用上。在本节中，我们并不打算罗列出每一种已知的 Dapper 使用方式，而是试图覆盖 Dapper 使用方式的 “基本向量”，并努力来说明什么样的应用是最成功的。</p><h2 id="6-1-在开发中使用-Dapper"><a href="#6-1-在开发中使用-Dapper" class="headerlink" title="6.1 在开发中使用 Dapper"></a>6.1 在开发中使用 Dapper</h2><p>Google AdWords 系统是围绕一个大型的关键词定位准则和相关文字广告的数据库搭建的。当新的关键字或广告被插入或修改时，它们必须通过服务策略术语的检查（如检查不恰当的语言，这个过程如果使用自动复查系统来做的话会更加有效）。</p><p>当轮到从头重新设计一个广告审查服务时，这个团队迭代的从第一个系统原型开始使用 Dapper，并且，最终用 Dapper 一直维护着他们的系统。Dapper<br>帮助他们从以下几个方面改进了他们的服务：</p><ul><li>性能：开发人员针对请求延迟的目标进行跟踪，并对容易优化的地方进行定位。Dapper 也被用来确定在关键路径上不必要的串行请求 –<br>通常来源于不是开发者自己开发的子系统 – 并促使团队持续修复他们。</li><li>正确性：广告审查服务围绕大型数据库系统搭建。系统同时具有只读副本策略（数据访问廉价）和读写的主策略（访问代价高）。Dapper<br>被用来在很多种情况中确定，哪些查询是无需通过主策略访问而可以采用副本策略访问。Dapper 现在可以负责监控哪些主策略被直接访问，并对重要的系统常量进行保障。</li><li>理解性：广告审查查询跨越了各种类型的系统，包括 BigTable—之前提到的那个数据库，多维索引服务，以及其他各种 C++ 和 Java 后端服务。Dapper<br>的跟踪用来评估总查询成本，促进重新对业务的设计，用以在他们的系统依赖上减少负载。</li><li>测试：新的代码版本会经过一个使用 Dapper 进行跟踪的 QA 过程，用来验证正确的系统行为和性能。在跑测试的过程中能发现很多问题，这些问题来自广告审查系统自身的代码或是他的依赖包。</li></ul><p>广告审查团队广泛使用了 Dapper Annotation API。Guice[13] 开源的 AOP 框架用来在重要的软件组件上标注<br>“@Traced”。这些跟踪信息可以进一步被标注，包含：重要子路径的输入输出大小、基础信息、其他调试信息，所有这些信息将会额外发送到日志文件中。</p><p>同时，我们也发现了一些广告审查小组在使用方面的不足。比如：他们想根据他们所有跟踪的 Annotation 信息，在一个交互时间段内进行搜索，然而这就必须跑一个自定义的<br>MapReduce 或进行每一个跟踪的手动检查。另外，在 Google 还有一些其他的系统在也从通用调试日志中收集和集中信息，把那些系统的海量数据和 Dapper<br>仓库整合也是有价值的。</p><p>总的来说，即便如此，广告审查团队仍然对 Dapper 的作用进行了以下评估，通过使用 Dapper 的跟踪平台的数据分析，他们的服务延迟性已经优化了两个数量级。</p><h2 id="6-1-1-与异常监控的集成"><a href="#6-1-1-与异常监控的集成" class="headerlink" title="6.1.1 与异常监控的集成"></a>6.1.1 与异常监控的集成</h2><p>Google 维护了一个从运行进程中不断收集并集中异常信息报告的服务。如果这些异常发生在 Dapper 跟踪采样的上下文中，那么相应的跟踪 ID 和 span 的 ID<br>也会作为元数据记录在异常报告中。异常监测服务的前端会提供一个链接，从特定的异常信息的报告直接导向到他们各自的分布式跟踪。广告审查团队使用这个功能可以了解<br>bug 发生的更大范围的上下文。通过暴露基于简单的唯一 ID 构建的接口，Dapper 平台被集成到其他事件监测系统会相对容易。</p><h2 id="6-2-解决延迟的长尾效应"><a href="#6-2-解决延迟的长尾效应" class="headerlink" title="6.2 解决延迟的长尾效应"></a>6.2 解决延迟的长尾效应</h2><p>考虑到移动部件的数量、代码库的规模、部署的范围，调试一个像全文搜索那样服务（第 1 节里提到过）是非常具有挑战性的。在这节，我们描述了我们在减轻全文搜索的延迟分布的长尾效应上做的各种努力。Dapper<br>能够验证端到端的延迟的假设，更具体地说，Dapper<br>能够验证对于搜索请求的关键路径。当一个系统不仅涉及数个子系统，而是几十个开发团队的涉及到的系统的情况下，端到端性能较差的根本原因到底在哪，这个问题即使是我们最好的和最有经验的工程师也无法正确回答。在这种情况下，Dapper<br>可以提供急需的数据，而且可以对许多重要的性能问题得出结论。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/20241229154732_MdxLbMYD.webp" alt="20241229154732_MdxLbMYD.webp"></p><p>图 7：全局搜索的跟踪片段，在不常遇到高网络延迟的情况下，在沿着关键路径的端到端的请求延迟，如图所示。</p><p>在调试延迟长尾效应的过程中，工程师可以建立一个小型库，这个小型库可以根据 DAPI<br>跟踪对象来推断关键路径的层级结构。这些关键路径的结构可以被用来诊断问题，并且为全文搜索提供可优先处理的预期的性能改进。Dapper 的这项工作导致了下列发现：</p><ul><li>在关键路径上的短暂的网络性能退化不影响系统的吞吐量，但它可能会对延迟异常值产生极大的影响。在图 7 中可以看出，大部分的全局搜索的缓慢的跟踪都来源于关键路径的网络性能退化。</li><li>许多问题和代价很高的查询模式来源于一些意想不到的服务之间的交互。一旦发现，往往容易纠正它们，但是 Dapper 出现之前想找出这些问题是相当困难的。</li><li>通用的查询从 Dapper 之外的安全日志仓库中收取，并使用 Dapper 唯一的跟踪 ID，与 Dapper 的仓库做关联。然后，该映射用来建立关于在全局搜索中的每一个独立子系统都很慢的实例查询的列表。</li></ul><h2 id="6-3-推断服务依赖"><a href="#6-3-推断服务依赖" class="headerlink" title="6.3 推断服务依赖"></a>6.3 推断服务依赖</h2><p>在任何给定的时间内，Google 内部的一个典型的计算集群是一个汇集了成千上万个逻辑 “任务” 的主机，一套的处理器在执行一个通用的方法。Google<br>维护着许多这样的集群，当然，事实上，我们发现在一个集群上计算着的这些任务通常依赖于其他的集群上的任务。由于任务们之间的依赖是动态改变的，所以不可能仅从配置信息上推断出所有这些服务之间的依赖关系。不过，除了其他方面的原因之外，在公司内部的各个流程需要准确的服务依赖关系信息，以确定瓶颈所在，以及计划服务的迁移。Google<br>的可称为 “Service Dependencies” 的项目是通过使用跟踪 Annotation 和 DAPI MapReduce 接口来实现自动化确定服务依赖归属的。</p><p>Dapper 核心组件与 Dapper 跟踪 Annotation 一并使用的情况下，“Service Dependencies” 项目能够推算出任务各自之间的依赖，以及任务和其他软件组件之间的依赖。比如，所有的<br>BigTable 的操作会加上与受影响的表名称相关的标记。运用 Dapper 的平台，Service Dependencies 团队就可以自动的推算出依赖于命名的不同资源的服务粒度。</p><h2 id="6-4-不同服务的网络使用率"><a href="#6-4-不同服务的网络使用率" class="headerlink" title="6.4 不同服务的网络使用率"></a>6.4 不同服务的网络使用率</h2><p>Google 投入了大量的人力和物力资源在他的网络结构上。从前网络管理员可能只关注独立的硬件信息、常用工具及以及搭建出的各种全局网络鸟瞰图的<br>dashboard 上的信息。网络管理员确实可以一览整个网络的健康状况，但是，当遇到问题时，他们很少有能够准确查找网络负载的工具，用来定位应用程序级别的罪魁祸首。</p><p>虽然 Dapper 不是设计用来做链路级的监控的，但是我们发现，它是非常适合去做集群之间网络活动性的应用级任务的分析。Google 能够利用 Dapper<br>这个平台，建立一个不断更新的控制台，来显示集群之间最活跃的网络流量的应用级的热点。此外，使用 Dapper<br>我们能够为昂贵的网络请求提供指出的构成原因的跟踪，而不是面对不同服务器之间的信息孤岛而无所适从。建立一个基于 Dapper API 的 dashboard 总共没花超过<br>2 周的时间。</p><h2 id="6-5-分层和共享存储系统"><a href="#6-5-分层和共享存储系统" class="headerlink" title="6.5 分层和共享存储系统"></a>6.5 分层和共享存储系统</h2><p>在 Google 的许多存储系统是由多重独立复杂层级的分布式基础设备组成的。例如，Google 的 App Engine[5] 就是搭建在一个可扩展的实体存储系统上的。该实体存储系统在基于<br>BigTable 上公开某些 RDBMS 功能。 BigTable 的同时使用 Chubby[7]（分布式锁系统）及 GFS。再者，像 BigTable 这样的系统简化了部署，并更好的利用了计算资源。</p><p>在这种分层的系统，并不总是很容易确定最终用户资源的消费模式。例如，来自于一个给定的 BigTable 单元格的 GFS 大信息量主要来自于一个用户或是由多个用户产生，但是在<br>GFS 层面，这两种明显的使用场景是很难界定。而且，如果缺乏一个像 Dapper 一样的工具的情况下，对共享服务的竞争可能会同样难于调试。</p><p>第 5.2 节中所示的 Dapper 的用户界面可以聚合那些调用任意公共服务的多个客户端的跟踪的性能信息。这就很容易让提供这些服务的源从多个维度给他们的用户排名。（例如，入站的网络负载，出站的网络负载，或服务请求的总时间）</p><h2 id="6-6-Dapper-的救火能力-Firefighting"><a href="#6-6-Dapper-的救火能力-Firefighting" class="headerlink" title="6.6 Dapper 的救火能力 (Firefighting)"></a>6.6 Dapper 的救火能力 (Firefighting)</h2><p>对于一些 “救火” 任务，Dapper 可以处理其中的一部分。“救火” 任务在这里是指一些有风险很高的在分布式系统上的操作。通常情况下，Dapper 用户当正在进行<br>“救火” 任务时需要使用新的数据，并且没有时间写新的 DAPI 代码或等待周期性的报告运行。</p><p>对于那些高延迟，不，可能更糟糕的那些在正常负载下都会响应超时的服务，Dapper 用户界面通常会把这些延迟瓶颈的位置隔离出来。通过与 Dapper<br>守护进程的直接通信，那些特定的高延迟的跟踪数据轻易的收集到。当出现灾难性故障时，通常是没有必要去看统计数据以确定根本原因，只查看示例跟踪就足够了 (<br>因为前文提到过从 Dapper 守护进程中几乎可以立即获得跟踪数据)。</p><p>但是，如在 6.5 节中描述的共享的存储服务，要求当用户活动过程中突然中断时能尽可能快的汇总信息。对于事件发生之后，共享服务仍然可以利用汇总的的<br>Dapper 数据，但是，除非收集到的 Dapper 数据的批量分析能在问题出现 10 分钟之内完成，否则 Dapper 面对与共享存储服务相关的 “救火” 任务就很难按预想的那般顺利完成。</p><h2 id="7-其他收获"><a href="#7-其他收获" class="headerlink" title="7. 其他收获"></a>7. 其他收获</h2><p>虽然迄今为止，我们在 Dapper 上的经验已经大致符合我们的预期，但是也出现了一些积极的方面是我们没有充分预料到的。首先，我们获得了超出预期的 Dapper<br>使用用例的数量，对此我们可谓欢心鼓舞。另外，在除了几个的在第 6 节使用经验中提到过的一些用例之外，还包括资源核算系统，对指定的通讯模式敏感的服务的检查工具，以及一种对<br>RPC 压缩策略的分析器，等等。我们认为这些意想不到的用例一定程度上是由于我们向开发者以一种简单的编程接口的方式开放了跟踪数据存储的缘故，这使得我们能够充分利用这个大的多的社区的创造力。除此之外，Dapper<br>对旧的负载的支持也比预期的要简单，只需要在程序中引入一个用新版本的重新编译过的公共组件库 (包含常规的线程使用，控制流和 RPC 框架) 即可。</p><p>Dapper 在 Google 内部的广泛使用还为我们在 Dapper 的局限性上提供了宝贵的反馈意见。下面我们将介绍一些我们已知的最重要的 Dapper 的不足：</p><ul><li></li></ul><p>合并的影响：我们的模型隐含的前提是不同的子系统在处理的都是来自同一个被跟踪的请求。在某些情况下，缓冲一部分请求，然后一次性操作一个请求集会更加有效。（比如，磁盘上的一次合并写入操作）。在这种情况下，一个被跟踪的请求可以看似是一个大型工作单元。此外，当有多个追踪请求被收集在一起，他们当中只有一个会用来生成那个唯一的跟踪<br>ID，用来给其他 span 使用，所以就无法跟踪下去了。我们正在考虑的解决方案，希望在可以识别这种情况的前提下，用尽可能少的记录来解决这个问题。</p><ul><li>跟踪批处理负载：Dapper 的设计，主要是针对在线服务系统，最初的目标是了解一个用户请求产生的系统行为。然而，离线的密集型负载，例如符合<br>MapReduce[10] 模型的情况，也可以受益于性能挖潜。在这种情况下，我们需要把跟踪 ID 与一些其他的有意义的工作单元做关联，诸如输入数据中的键值（或键值的范围），或是一个<br>MapReduce shard。</li><li>寻找根源：Dapper<br>可以有效地确定系统中的哪一部分致使系统整个速度变慢，但并不总是能够找出问题的根源。例如，一个请求很慢有可能不是因为它自己的行为，而是由于队列中其他排在它前面的 (<br>queued ahead of) 请求还没处理完。程序可以使用应用级的 annotation 把队列的大小或过载情况写入跟踪系统。此外，如果这种情况屡见不鲜，那么在<br>ProfileMe[11] 中提到的成对的采样技术可以解决这个问题。它由两个时间重叠的采样率组成，并观察它们在整个系统中的相对延迟。</li><li></li></ul><p>记录内核级的信息：一些内核可见的事件的详细信息有时对确定问题根源是很有用的。我们有一些工具，能够跟踪或以其他方式描述内核的执行，但是，想用通用的或是不那么突兀的方式，是很难把这些信息到捆绑到用户级别的跟踪上下文中。我们正在研究一种妥协的解决方案，我们在用户层面上把一些内核级的活动参数做快照，然后绑定他们到一个活动的<br>span 上。</p><h2 id="8-相关产品"><a href="#8-相关产品" class="headerlink" title="8. 相关产品"></a>8. 相关产品</h2><p>在分布式系统跟踪领域，有一套完整的体系，一部分系统主要关注定位到故障位置，其他的目标是针对性能进行优化。 Dapper<br>确实被用于发现系统问题，但它更通常用于探查性能不足，以及提高全面大规模的工作负载下的系统行为的理解。</p><p>与 Dapper 相关的黑盒监控系统，比如 Project5[1]，WAP5[15] 和 Sherlock[2]<br>，可以说不依赖运行库的情况下，黑盒监控系统能够实现更高的应用级透明。黑盒的缺点是一定程度上不够精确，并可能在统计推断关键路径时带来更大的系统损耗。</p><p>对于分布式系统监控来说，基于 Annotation 的中间件或应用自身是一个可能是更受欢迎的解决办法. 拿 Pip[14] 和 Webmon[16] 系统举例，他们更依赖于应用级的<br>Annotation，而 X-Trace[12]，Pinpoint[9] 和 Magpie[3] 大多集中在对库和中间件的修改。Dapper 更接近后者。像 Pinpoint，X-Trace，和早期版本的 Magpie<br>一样，Dapper 采用了全局标识符把分布式系统中各部分相关的事件联系在一起。和这些系统类似，Dapper 尝试避免使用应用级<br>Annotation，而是把的植入隐藏在通用组件模块内。Magpie 放弃使用全局 ID，仍然试图正确的完成请求的正确传播，他通过采用应用系统各自写入的事件策略，最终也能精确描述不同事件之间关系。但是目前还不清楚<br>Magpie 在实际环境中实现透明性这些策略到底多么有效。 X-Trace 的核心 Annotation 比 Dapper 更有野心一些，因为 X-Trace<br>系统对于跟踪的收集，不仅在跟踪节点层面上，而且在节点内部不同的软件层也会进行跟踪。而我们对于组件的低性能损耗的要求迫使我们不能采用 X-Trace<br>这样的模型，而是朝着把一个请求连接起来完整跟踪所能做到的最小代价而努力。而 Dapper 的跟踪仍然可以从可选的应用级 Annotation 中获益。</p><h2 id="9-总结"><a href="#9-总结" class="headerlink" title="9. 总结"></a>9. 总结</h2><p>在本文中，我们介绍 Dapper 这个 Google 的生产环境下的分布式系统跟踪平台，并汇报了我们开发和使用它的相关经验。 Dapper 几乎在部署在所有的 Google<br>系统上，并可以在不需要应用级修改的情况下进行跟踪，而且没有明显的性能影响。Dapper 对于开发人员和运维团队带来的好处，可以从我们主要的跟踪用户界面的广泛使用上看出来，另外我们还列举了一些<br>Dapper 的使用用例来说明 Dapper 的作用，这些用例有些甚至都没有 Dapper 开发团队参与，而是被应用的开发者开发出来的。</p><p>据我们所知，这是第一篇汇报生产环境下分布式系统跟踪框架的论文。事实上，我们的主要贡献源于这个事实：论文中回顾的这个系统已经运行两年之久。我们发现，结合对开发人员提供简单<br>API 和对应用系统完全透明来增强跟踪的这个决定，是非常值得的。</p><p>我们相信，Dapper 比以前的基于 Annotation<br>的分布式跟踪达到更高的应用透明度，这一点已经通过只需要少量人工干预的工作量得以证明。虽然一定程度上得益于我们的系统的同质性，但它本身仍然是一个重大的挑战。最重要的是，我们的设计提出了一些实现应用级透明性的充分条件，对此我们希望能够对更错杂环境下的解决方案的开发有所帮助。</p><p>最后，通过开放 Dapper 跟踪仓库给内部开发者，我们促使更多的基于跟踪仓库的分析工具的产生，而仅仅由 Dapper<br>团队默默的在信息孤岛中埋头苦干的结果远达不到现在这么大的规模，这个决定促使了设计和实施的展开。</p><h3 id="Acknowledgments"><a href="#Acknowledgments" class="headerlink" title="Acknowledgments"></a>Acknowledgments</h3><p>We thank Mahesh Palekar, Cliff Biffle, Thomas Kotzmann, Kevin Gibbs, Yonatan Zunger, Michael Kleber, and Toby Smith for their experimental<br>data and feedback about Dapper experiences. We also thank Silvius Rus for his assistance with load testing. Most importantly, though, we<br>thank the outstanding team of engineers who have continued to develop and improve Dapper over the years; in order of appearance, Sharon<br>Perl, Dick Sites, Rob von Behren, Tony DeWitt, Don Pazel, Ofer Zajicek, Anthony Zana, Hyang-Ah Kim, Joshua MacDonald, Dan Sturman, Glenn<br>Willen, Alex Kehlenbeck, Brian McBarron, Michael Kleber, Chris Povirk, Bradley White, Toby Smith, Todd Derr, Michael De Rosa, and Athicha<br>Muthitacharoen. They have all done a tremendous amount of work to make Dapper a day-to-day reality at Google.</p><h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><p>[1] M. K. Aguilera, J. C. Mogul, J. L. Wiener, P. Reynolds, and A. Muthitacharoen. Performance Debugging for Distributed Systems of Black<br>Boxes. In Proceedings of the 19th ACM Symposium on Operating Systems Principles, December 2003.<br>[2] P. Bahl, R. Chandra, A. Greenberg, S. Kandula, D. A. Maltz, and M. Zhang. Towards Highly Reliable Enterprise Network Services Via<br>Inference of Multi-level Dependencies. In Proceedings of SIGCOMM, 2007.<br>[3] P. Barham, R. Isaacs, R. Mortier, and D. Narayanan. Magpie: online modelling and performance-aware systems. In Proceedings of USENIX<br>HotOS IX, 2003.<br>[4] L. A. Barroso, J. Dean, and U. Holzle. Web Search for a Planet: The Google Cluster Architecture. IEEE Micro, 23(2):22–28, March/April</p><ol start="2003"><li></li></ol><p>[5] T. O. G. Blog. Developers, start your engines. <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cDovL2dvb2dsZWJsb2cuYmxvZ3Nwb3QuY29tLzIwMDgvMDQvZGV2ZWxvcGVycy1zdGFydC15b3VyLWVuZ2luZXMuaHRtbCwyMDA3">http://googleblog.blogspot.com/2008/04/developers-start-your-engines.html,2007</a>.<br>[6] T. O. G. Blog. Universal search: The best answer is still the best<br>answer. <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cDovL2dvb2dsZWJsb2cuYmxvZ3Nwb3QuY29tLzIwMDcvMDUvdW5pdmVyc2FsLXNlYXJjaC1iZXN0LWFuc3dlci1pcy1zdGlsbC5odG1s">http://googleblog.blogspot.com/2007/05/universal-search-best-answer-is-still.html</a>, 2007.<br>[7] M. Burrows. The Chubby lock service for loosely-coupled distributed systems. In Proceedings of the 7th USENIX Symposium on Operating<br>Systems Design and Implementation, pages 335 – 350, 2006.<br>[8] F. Chang, J. Dean, S. Ghemawat, W. C. Hsieh, D. A. Wallach, M. Burrows, T. Chandra, A. Fikes, and R. E. Gruber. Bigtable: A Distributed<br>Storage System for Structured Data. In Proceedings of the 7th USENIX Symposium on Operating Systems Design and Implementation (OSDI’06),<br>November 2006.<br>[9] M. Y. Chen, E. Kiciman, E. Fratkin, A. fox, and E. Brewer. Pinpoint: Problem Determination in Large, Dynamic Internet Services. In<br>Proceedings of ACM International Conference on Dependable Systems and Networks, 2002.<br>[10] J. Dean and S. Ghemawat. MapReduce: Simplified Data Processing on Large Clusters. In Proceedings of the 6th USENIX Symposium on<br>Operating Systems Design and Implementation (OSDI’04), pages 137 – 150, December 2004.<br>[11] J. Dean, J. E. Hicks, C. A. Waldspurger, W. E. Weihl, and G. Chrysos. ProfileMe: Hardware Support for Instruction-Level Profiling on<br>Out-of-Order Processors. In Proceedings of the IEEE/ACM International Symposium on Microarchitecture, 1997.<br>[12] R. Fonseca, G. Porter, R. H. Katz, S. Shenker, and I. Stoica. X-Trace: A Pervasive Network Tracing Framework. In Proceedings of USENIX<br>NSDI, 2007.<br>[13] B. Lee and K. Bourrillion. The Guice Project Home Page. <a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9wL2dvb2dsZS1ndWljZS8=">http://code.google.com/p/google-guice/</a>, 2007.<br>[14] P. Reynolds, C. Killian, J. L. Wiener, J. C. Mogul, M. A. Shah, and A. Vahdat. Pip: Detecting the Unexpected in Distributed Systems. In<br>Proceedings of USENIX NSDI, 2006.<br>[15] P. Reynolds, J. L. Wiener, J. C. Mogul, M. K. Aguilera, and A. Vahdat. WAP5: Black Box Performance Debugging for Wide-Area Systems. In<br>Proceedings of the 15th International World Wide Web Conference, 2006.<br>[16] P. K. G. T. Gschwind, K. Eshghi and K. Wurster. WebMon: A Performance Profiler for Web Transactions. In E-Commerce Workshop, 2002.</p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL2JpZ2J1bGx5L0RhcHBlci10cmFuc2xhdGlvbg=="></a>is maintained by<a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cHM6Ly9naXRodWIuY29tL2JpZ2J1bGx5">bigbully</a>.</p><p>This page was generated by<a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cDovL2JpZ2J1bGx5LmdpdGh1Yi5pby9EYXBwZXItdHJhbnNsYXRpb24vcGFnZXMuZ2l0aHViLmNvbQ==">GitHub Pages</a>using the Architect theme<br>by<a target="_blank" rel="external nofollow noopener noreferrer" href="/goto.html?u=aHR0cDovL3R3aXR0ZXIuY29tL2phc29ubG9uZw==">Jason Long</a>.</p></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/avatar1.webp" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/avatar.webp" title="头像" alt="头像"></a><div class="post-copyright__author_name">dong4j</div><div class="post-copyright__author_desc">岁月静好，诗酒趁年华🍺</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://blog.dong4j.site/posts/a69881a6.html">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl(&quot;https://blog.dong4j.site/posts/a69881a6.html&quot;)">Google Dapper：揭秘分布式跟踪系统的秘密</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://cdn.dong4j.site/source/image/wechat-pay.webp" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/wechat-pay.webp" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.dong4j.site/source/image/alipay.webp" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/alipay.webp" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display:none"></div><div class="reward-link mode"><a class="reward-link-button" href="/wechat/"><i class="anzhiyufont anzhiyu-icon-plant-fill"></i>运营模式与责任</a></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://blog.dong4j.site/posts/a69881a6.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=Google Dapper：揭秘分布式跟踪系统的秘密&amp;url=https://blog.dong4j.site/posts/a69881a6.html&amp;pic=https://api.dong4j.ink:1024/cover?3cu41jed" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl(){var e=window.location.href,t=document.createElement("input");t.setAttribute("value",e),document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999),document.execCommand("copy"),document.body.removeChild(t)}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div><div class="share-link follow"><div class="share-button" id="post-share-url" title="订阅" onclick="icat.showFollowBox()"><i class="anzhiyufont anzhiyu-icon-rss"></i></div></div></div></div></div><div class="submit-box display"><form id="follow" action="https://api.follow.it/subscription-form/b29peEszNWYzK3FQbEw2dVlITEJMZ2pQRXh2dWRLVDE3SC96eFhRaGwwQWprcXpYYUp0NGFWemxVZllXRGU4Nm4yenNGSzNpV3l0Z1EwQzBXQU5xTG9pZWNzVCt5YWptWUt6TXppRXVXMXZxQTRZOGQ0NUVDRlRFOUYxSHMzMEJ8NmlodHY1VWhDQVZBaG8wM0pSV2pXSjdTNGRWS1o0RDVZbE11KzlEeWhuZz0=/8" method="post" target="_blank"><div class="follow-it-form-subscribe" style="position:relative"><div class="heading"><h5 style="font-weight:700;text-align:center">订阅本站文章：</h5></div><div class="input-field"><input type="email" id="email-input" name="email" placeholder="填入您的邮箱地址" spellcheck="false" oninput="validateEmail()"></div><div class="submit-button"><button type="submit" id="submit-button" onclick="ga(&quot;send&quot;,&quot;event&quot;,&quot;Form&quot;,&quot;Submit&quot;,&quot;Affiliate&quot;)" style="font-weight:700;font-size:14px;text-align:center" disabled="">确认订阅</button></div></div></form><style>#email-input{font-size:16px;font-weight:700;padding:10px;border:2px solid #ccc;border-radius:5px;width:100%;box-sizing:border-box}#email-input:focus{outline:0}#email-input.valid{border-color:green}#email-input.invalid{border-color:red}</style><script>function validateEmail(){var s=document.getElementById("email-input"),a=document.getElementById("submit-button"),e=s.value;/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?(a.disabled=!1,s.classList.add("valid"),s.classList.remove("invalid")):(a.disabled=!0,s.classList.add("invalid"),s.classList.remove("valid"))}</script></div><script>var icat={showFollowBox:function(){var s=document.querySelector(".submit-box");s.classList.contains("display")?s.classList.remove("display"):s.classList.add("display")}}</script><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.dong4j.site" target="_blank">司机带你开车</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__category-list"><a class="post-meta__box__categoryes" href="/categories/ai-%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/"><span class="categoryes-punctuation"><i class="anzhiyufont anzhiyu-icon-inbox"></i></span>AI:人工智能<span class="categoryesPageCount">9</span></a></div><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/dapper/"><span class="tags-punctuation"><i class="anzhiyufont anzhiyu-icon-tag"></i></span>Dapper<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E8%B7%9F%E8%B8%AA%E7%B3%BB%E7%BB%9F/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>分布式跟踪系统<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/google/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Google<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>性能监控<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/%E9%87%87%E6%A0%B7%E7%8E%87/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>采样率<span class="tagsPageCount">1</span></a></div></div><div class="post_share"><div class="addtoany"><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_button_facebook a2a_counter"></a><a class="a2a_button_x"></a><a class="a2a_button_threads"></a><a class="a2a_button_pocket"></a><a class="a2a_button_email"></a><a class="a2a_button_sms"></a><a class="a2a_dd" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.addtoany.com/share"></a></div></div><script async="" src="https://static.addtoany.com/menu/page.js"></script><script>var a2a_config=a2a_config||{};a2a_config.templates=a2a_config.templates||{},a2a_config.templates.email={subject:"来自 dong4j 的分享: ${title}",body:"一篇有意思的博文:\n${link}"},a2a_config.templates.sms={body:"给你分享一篇有意思的博客:\n${title}\n${link}"}</script></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/d2f9713d.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?gbed5qg3" onerror="onerror=null,src=&quot;/img/404.webp&quot;" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">IntelliJ IDEA 翻译插件开发 - 从概念到实践</div></div></a></div><div class="next-post pull-right"><a href="/posts/508e9afc.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?im3d2vii" onerror="onerror=null,src=&quot;/img/404.webp&quot;" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">深入解析Zheng框架：搭建与部署实战指南</div></div></a></div></nav><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)" rel="external nofollow noreferrer">匿名评论</a><a href="/privacy" style="margin-left:4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/avatar.webp" onerror="this.onerror=null,this.src=&quot;/img/friend_404.gif&quot;" alt="avatar"><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/coding.gif" alt="status"></div></div><div class="author-info__description"><div style="line-height:1.38;margin:.6rem 0;text-align:justify;color:rgba(255,255,255,.8)">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:.6rem 0;text-align:justify;color:rgba(255,255,255,.8)">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">dong4j</h1><div class="author-info__desc">岁月静好，诗酒趁年华 🍺</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/dong4j" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fa-brands fa-github faa-tada"></i></a><a class="social-icon faa-parent animated-hover" href="mailto:dong4j@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fa-solid fa-at faa-tada"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content"><div style="display:flex;align-items:center"><span>👋🏻 Hi，欢迎来到我的博客~</span><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/mario.gif" width="40"></div><span>❓ 如有问题欢迎评论区交流！🎉</span><br><span>😫 页面异常？试试<kbd>Ctrl</kbd>+<kbd>F5</kbd>🙉</span><br><span>📧 如需联系：<a href="mailto:dong4j@gmail.com" rel="external nofollow noreferrer"><b>发邮件给我吧 🚀</b></a></span><div id="welcome-info"></div><a id="my-card-info-btn" href="/subscribe/" data-pjax-state=""><i class="anzhiyufont anzhiyu-icon-rss"></i><span>订阅本站</span></a></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background:url(https://cdn.dong4j.site/source/image/63c02edf44033.webp) center center/100% no-repeat"></div><div class="back face" style="background:url(https://cdn.dong4j.site/source/image/645fa415e8694.webp) center center/100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.</span> <span class="toc-text">1. 介绍</span></a></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E6%96%87%E7%8C%AE%E7%9A%84%E6%80%BB%E7%BB%93"><span class="toc-number"></span> <span class="toc-text">1.1 文献的总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Dapper-%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E8%B7%9F%E8%B8%AA"><span class="toc-number"></span> <span class="toc-text">2. Dapper 的分布式跟踪</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E8%B7%9F%E8%B8%AA%E6%A0%91%E5%92%8C-span"><span class="toc-number"></span> <span class="toc-text">2.1 跟踪树和 span</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E6%A4%8D%E5%85%A5%E7%82%B9"><span class="toc-number"></span> <span class="toc-text">2.2 植入点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-Annotation"><span class="toc-number"></span> <span class="toc-text">2.3 Annotation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E9%87%87%E6%A0%B7%E7%8E%87"><span class="toc-number"></span> <span class="toc-text">2.4 采样率</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E8%B7%9F%E8%B8%AA%E7%9A%84%E6%94%B6%E9%9B%86"><span class="toc-number"></span> <span class="toc-text">2.5 跟踪的收集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-1-%E5%B8%A6%E5%A4%96%E6%95%B0%E6%8D%AE%E8%B7%9F%E8%B8%AA%E6%94%B6%E9%9B%86"><span class="toc-number"></span> <span class="toc-text">2.5.1 带外数据跟踪收集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-%E5%AE%89%E5%85%A8%E5%92%8C%E9%9A%90%E7%A7%81%E8%80%83%E8%99%91"><span class="toc-number"></span> <span class="toc-text">2.6 安全和隐私考虑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Dapper-%E9%83%A8%E7%BD%B2%E7%8A%B6%E5%86%B5"><span class="toc-number"></span> <span class="toc-text">3. Dapper 部署状况</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-Dapper-%E8%BF%90%E8%A1%8C%E5%BA%93"><span class="toc-number"></span> <span class="toc-text">3.1 Dapper 运行库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84%E6%B6%B5%E7%9B%96%E9%9D%A2"><span class="toc-number"></span> <span class="toc-text">3.2 生产环境下的涵盖面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E8%B7%9F%E8%B8%AA-Annotation-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number"></span> <span class="toc-text">3.3 跟踪 Annotation 的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%A4%84%E7%90%86%E8%B7%9F%E8%B8%AA%E6%8D%9F%E8%80%97"><span class="toc-number"></span> <span class="toc-text">4. 处理跟踪损耗</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E7%94%9F%E6%88%90%E8%B7%9F%E8%B8%AA%E7%9A%84%E6%8D%9F%E8%80%97"><span class="toc-number"></span> <span class="toc-text">4.1 生成跟踪的损耗</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E8%B7%9F%E8%B8%AA%E6%94%B6%E9%9B%86%E7%9A%84%E6%B6%88%E8%80%97"><span class="toc-number"></span> <span class="toc-text">4.2 跟踪收集的消耗</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E5%9C%A8%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%AF%B9%E8%B4%9F%E8%BD%BD%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-number"></span> <span class="toc-text">4.3 在生产环境下对负载的影响</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E5%8F%AF%E5%8F%98%E9%87%87%E6%A0%B7"><span class="toc-number"></span> <span class="toc-text">4.4 可变采样</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-%E5%BA%94%E5%AF%B9%E7%A7%AF%E6%9E%81%E9%87%87%E6%A0%B7-Coping-with-aggressive-sampling"><span class="toc-number"></span> <span class="toc-text">4.5 应对积极采样 (Coping with aggressive sampling)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6-%E5%9C%A8%E6%94%B6%E9%9B%86%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%A2%9D%E5%A4%96%E7%9A%84%E9%87%87%E6%A0%B7"><span class="toc-number"></span> <span class="toc-text">4.6 在收集过程中额外的采样</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E9%80%9A%E7%94%A8%E7%9A%84-Dapper-%E5%B7%A5%E5%85%B7"><span class="toc-number"></span> <span class="toc-text">5. 通用的 Dapper 工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-Dapper-Depot-API"><span class="toc-number"></span> <span class="toc-text">5.1 Dapper Depot API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-1-DAPI-%E5%9C%A8-Google-%E5%86%85%E9%83%A8%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number"></span> <span class="toc-text">5.1.1 DAPI 在 Google 内部的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-Dapper-%E7%9A%84%E7%94%A8%E6%88%B7%E6%8E%A5%E5%8F%A3"><span class="toc-number"></span> <span class="toc-text">5.2 Dapper 的用户接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E7%BB%8F%E9%AA%8C"><span class="toc-number"></span> <span class="toc-text">6. 经验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E5%9C%A8%E5%BC%80%E5%8F%91%E4%B8%AD%E4%BD%BF%E7%94%A8-Dapper"><span class="toc-number"></span> <span class="toc-text">6.1 在开发中使用 Dapper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-1-%E4%B8%8E%E5%BC%82%E5%B8%B8%E7%9B%91%E6%8E%A7%E7%9A%84%E9%9B%86%E6%88%90"><span class="toc-number"></span> <span class="toc-text">6.1.1 与异常监控的集成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E8%A7%A3%E5%86%B3%E5%BB%B6%E8%BF%9F%E7%9A%84%E9%95%BF%E5%B0%BE%E6%95%88%E5%BA%94"><span class="toc-number"></span> <span class="toc-text">6.2 解决延迟的长尾效应</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E6%8E%A8%E6%96%AD%E6%9C%8D%E5%8A%A1%E4%BE%9D%E8%B5%96"><span class="toc-number"></span> <span class="toc-text">6.3 推断服务依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-%E4%B8%8D%E5%90%8C%E6%9C%8D%E5%8A%A1%E7%9A%84%E7%BD%91%E7%BB%9C%E4%BD%BF%E7%94%A8%E7%8E%87"><span class="toc-number"></span> <span class="toc-text">6.4 不同服务的网络使用率</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-%E5%88%86%E5%B1%82%E5%92%8C%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F"><span class="toc-number"></span> <span class="toc-text">6.5 分层和共享存储系统</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-6-Dapper-%E7%9A%84%E6%95%91%E7%81%AB%E8%83%BD%E5%8A%9B-Firefighting"><span class="toc-number"></span> <span class="toc-text">6.6 Dapper 的救火能力 (Firefighting)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E5%85%B6%E4%BB%96%E6%94%B6%E8%8E%B7"><span class="toc-number"></span> <span class="toc-text">7. 其他收获</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E7%9B%B8%E5%85%B3%E4%BA%A7%E5%93%81"><span class="toc-number"></span> <span class="toc-text">8. 相关产品</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E6%80%BB%E7%BB%93"><span class="toc-number"></span> <span class="toc-text">9. 总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Acknowledgments"><span class="toc-number">1.</span> <span class="toc-text">Acknowledgments</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#References"><span class="toc-number">2.</span> <span class="toc-text">References</span></a></li></ol></li></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/13e613ba.html" title="Proxmox VE 8.3 安装与配置指南"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?34n7j520" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" alt="Proxmox VE 8.3 安装与配置指南"></a><div class="content"><a class="title" href="/posts/13e613ba.html" title="Proxmox VE 8.3 安装与配置指南">Proxmox VE 8.3 安装与配置指南</a><time datetime="2025-02-17T11:52:42.000Z" title="发表于 2025-02-17 19:52:42">2025-02-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/91f73d3b.html" title="Ubuntu 使用备忘录：好记性不如烂笔头"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?mg3iapx4" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" alt="Ubuntu 使用备忘录：好记性不如烂笔头"></a><div class="content"><a class="title" href="/posts/91f73d3b.html" title="Ubuntu 使用备忘录：好记性不如烂笔头">Ubuntu 使用备忘录：好记性不如烂笔头</a><time datetime="2025-02-15T06:37:31.000Z" title="发表于 2025-02-15 14:37:31">2025-02-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/5fa20a9e.html" title="使用 Cloudflare 增强公网服务安全性的实践"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?eb4q02fh" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" alt="使用 Cloudflare 增强公网服务安全性的实践"></a><div class="content"><a class="title" href="/posts/5fa20a9e.html" title="使用 Cloudflare 增强公网服务安全性的实践">使用 Cloudflare 增强公网服务安全性的实践</a><time datetime="2025-02-12T16:17:11.000Z" title="发表于 2025-02-13 00:17:11">2025-02-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/b0f649a0.html" title="Ubuntu 系统下 LCD4Linux 的安装与配置指南"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?po6ikv1j" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" alt="Ubuntu 系统下 LCD4Linux 的安装与配置指南"></a><div class="content"><a class="title" href="/posts/b0f649a0.html" title="Ubuntu 系统下 LCD4Linux 的安装与配置指南">Ubuntu 系统下 LCD4Linux 的安装与配置指南</a><time datetime="2025-02-12T11:35:45.000Z" title="发表于 2025-02-12 19:35:45">2025-02-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/c78c58c7.html" title="树莓派与移远EC20 4G网卡集成及自动拨号方案解析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://api.dong4j.ink:1024/cover?56t44pn3" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" alt="树莓派与移远EC20 4G网卡集成及自动拨号方案解析"></a><div class="content"><a class="title" href="/posts/c78c58c7.html" title="树莓派与移远EC20 4G网卡集成及自动拨号方案解析">树莓派与移远EC20 4G网卡集成及自动拨号方案解析</a><time datetime="2025-02-12T06:55:16.000Z" title="发表于 2025-02-12 14:55:16">2025-02-12</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="mailto:dong4j@gmail.com" rel="external nofollow noreferrer" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://weibo.com/u/1884084142" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.facebook.com/dsj.array" title="facebook"><i class="anzhiyufont anzhiyu-icon-facebook1"></i></a><a class="deal_link" href="/atom.xml" title="RSS"><i class="anzhiyufont anzhiyu-icon-rss"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0,500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/avatar.webp" size="50px"><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dong4j" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://space.bilibili.com/1835978167" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://v.douyin.com/iUqoRYwb/" title="抖音"><i class="anzhiyufont anzhiyu-icon-tiktok"></i></a><a class="deal_link" href="/copyright" title="CC"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i></a></div><div id="workboard"><img class="workSituationImg boardsign" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.0.4/img/badge/安知鱼-上班摸鱼中.svg" alt="距离月入25k也就还差一个大佬带我~" title="距离月入25k也就还差一个大佬带我~"><div id="runtimeTextTip"></div></div><div id="anzhiyu-footer"><div class="footer-group"><div class="footer-title">服务</div><div class="footer-links"><a class="footer-item" title="51la统计" target="_blank" rel="noopener external nofollow noreferrer" href="https://v6.51.la/">51la统计</a><a class="footer-item" title="十年之约" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.foreverblog.cn/">十年之约</a><a class="footer-item" title="开往" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.travellings.cn/go.html">开往</a><a class="footer-item" title="服务状态" target="_blank" rel="noopener external nofollow noreferrer" href="https://uptime.dong4j.dev/status/services">服务状态</a></div></div><div class="footer-group"><div class="footer-title">项目</div><div class="footer-links"><a class="footer-item" title="Watt.Stack" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/watt-stack">Watt.Stack</a><a class="footer-item" title="MIK" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dong4j/markdown-image-kit">MIK</a><a class="footer-item" title="macOS.dev" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dong4j/macOS-dev">macOS.dev</a><a class="footer-item" title="更多" target="_blank" rel="noopener external nofollow noreferrer" href="https://project.dong4j.ink:1024/">更多</a></div></div><div class="footer-group"><div class="footer-title">导航</div><div class="footer-links"><a class="footer-item" title="我的装备" href="/equipment/">我的装备</a><a class="footer-item" title="即刻短文" href="/essay/">即刻短文</a><a class="footer-item" title="友链文章" href="/fcircle/">友链文章</a><a class="footer-item" title="留言板" href="/comments/">留言板</a></div></div><div class="footer-group"><div class="footer-title">协议</div><div class="footer-links"><a class="footer-item" title="隐私协议" href="/privacy/">隐私协议</a><a class="footer-item" title="Cookies" href="/cookies/">Cookies</a><a class="footer-item" title="版权协议" href="/copyright/">版权协议</a><a class="footer-item" title="更新日志" href="/update/">更新日志</a></div></div><div class="footer-group"><div class="footer-title-group"><div class="footer-title">友链</div><a class="random-friends-btn" id="footer-random-friends-btn" href="javascript:addFriendLinksInFooter();" rel="external nofollow noreferrer" title="换一批友情链接"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i></a></div><div class="footer-links" id="friend-links-in-footer"></div></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://nonbot.org/pledged/view/9e6e360a-4834-4dd0-b672-845baa0eb4de" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="Made By Humans" title="Made By Humans"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/nonbot_pledged_logo.svg" alt="Made By Humans"></a><a class="github-badge" target="_blank" href="https://notbyai.fyi/cn/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="Not By AI" title="Not By AI"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/written-by-human-not-by-ai-white.svg" alt="Not By AI"></a><a class="github-badge" target="_blank" href="https://hexo.io/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title="博客框架为Hexo_v5.4.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo_v5.4.0"></a><a class="github-badge" target="_blank" href="https://blog.anheyu.com/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站使用AnZhiYu主题" title="本站使用AnZhiYu主题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.9/img/Theme-AnZhiYu-2E67D3.svg" alt="本站使用AnZhiYu主题"></a><a class="github-badge" target="_blank" href="https://www.dogecloud.com/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站使用多吉云为静态资源提供CDN加速" title="本站使用多吉云为静态资源提供CDN加速"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/CDN-多吉云-3693F3.svg" alt="本站使用多吉云为静态资源提供CDN加速"></a><a class="github-badge" target="_blank" href="https://github.com/dong4j" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站项目由Github托管" title="本站项目由Github托管"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Source-Github.svg" alt="本站项目由Github托管"></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/Copyright-BY-NC-SA.svg" alt="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div><div id="footer-bar"><div class="footer-bar-links"><footer-bar-left><div id="footer-bar-tips"><div class="copyright" style="display:flex;align-items:center;gap:10px">©2013 - 2025 By <a class="footer-bar-link" href="/" title="dong4j" target="_blank">dong4j</a><span class="indicator" id="indicator" style="display:inline-block;width:8px;height:8px;border-radius:50%;background-color:green;margin-left:0;animation:subtle-breathing 1.2s infinite;box-shadow:0 0 5px rgba(255,0,0,.8)"></span><span>在线人数:</span><span id="online_user" style="font-size:1em;font-weight:700">1</span></div></div><div id="footer-type-tips"></div></footer-bar-left><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener external nofollow noreferrer" href="https://beian.miit.gov.cn/" title="蜀ICP备2025119258号">蜀ICP备2025119258号</a><a class="footer-bar-link cc" href="/copyright" title="cc协议"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-by-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nc-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nd-line"></i></a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">258</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">1094</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">18</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" rel="external nofollow noreferrer" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://home.dong4j.site" title="个人主页"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/homepage.webp" alt="个人主页"><span class="back-menu-item-text">个人主页</span></a><a class="back-menu-item" href="https://blog.dong4j.site" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/blog.webp" alt="博客"><span class="back-menu-item-text">博客</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://resume.dong4j.site" title="简历"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/resume.webp" alt="简历"><span class="back-menu-item-text">简历</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://npx-card.dong4j.site" title="npx-card"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/npx-card.webp" alt="npx-card"><span class="back-menu-item-text">npx-card</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/watt-stack" title="Watt.Stack"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/watt.webp" alt="Watt.Stack"><span class="back-menu-item-text">Watt.Stack</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dong4j/markdown-image-kit" title="MIK"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/mik.webp" alt="MIK"><span class="back-menu-item-text">MIK</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dong4j/macOS-dev" title="macOS.dev"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/mac.webp" alt="macOS.dev"><span class="back-menu-item-text">macOS.dev</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://project.dong4j.site/" title="更多"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/project.webp" alt="更多"><span class="back-menu-item-text">更多</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">服务</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://uptime.dong4j.dev/status/services" title="服务状态"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/uptime-kuma.svg" alt="服务状态"><span class="back-menu-item-text">服务状态</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://nezha.dong4j.dev" title="服务面板"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/nezha.webp" alt="服务面板"><span class="back-menu-item-text">服务面板</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://nav.dong4j.dev" title="导航页"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/nav.webp" alt="导航页"><span class="back-menu-item-text">导航页</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://umami.dong4j.ink:1024/share/V7Rat8DdVw4npjl2/blog.dong4j.site" title="Umami"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/umami.webp" alt="Umami"><span class="back-menu-item-text">Umami</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://muselink.cc/dong4j 👈这是我的MuseLink数字名片！" title="数字名片"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/muse.lin.webp" alt="数字名片"><span class="back-menu-item-text">数字名片</span></a><a class="back-menu-item" href="/ai/deepseek-r1-webgpu/" title="DeepSeek"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/deepseek.webp" alt="DeepSeek"><span class="back-menu-item-text">DeepSeek</span></a><a class="back-menu-item" href="/ai/rmbg/playground/" title="RMBG"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/rmbg.webp" alt="RMBG"><span class="back-menu-item-text">RMBG</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://chat.dong4j.site/" title="Mini-Chat"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.webp&quot;" data-lazy-src="https://cdn.dong4j.site/source/image/emoji1.webp" alt="Mini-Chat"><span class="back-menu-item-text">Mini-Chat</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size:.9em"></i><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size:.9em"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/messages/"><i class="fa fa-comments faa-tada"></i><span> 最新评论</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="fa fa-line-chart faa-tada"></i><span> 统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size:.9em"></i><span> 我的装备</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size:.9em"></i><span> 小空调</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/memos/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size:.9em"></i><span> 备忘录</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/todolist/"><i class="fa-solid fa-map faa-tada"></i><span> 折腾清单</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/stars/"><i class="fa-brands fa-github faa-tada"></i><span> Star 清单</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.dong4j.dev"><span>小黑屋</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/java/" style="font-size:.88rem;color:#556363;font-weight:500;color:var(--anzhiyu-lighttext)">Java<sup>48</sup></a><a href="/tags/final/" style="font-size:.88rem;color:#678a45">final<sup>2</sup></a><a href="/tags/finalize/" style="font-size:.88rem;color:#c069bc">finalize<sup>1</sup></a><a href="/tags/finally/" style="font-size:.88rem;color:#714840">finally<sup>2</sup></a><a href="/tags/new%E5%85%B3%E9%94%AE%E5%AD%97/" style="font-size:.88rem;color:#197f3d">new关键字<sup>1</sup></a><a href="/tags/static/" style="font-size:.88rem;color:#704a0d">static<sup>1</sup></a><a href="/tags/super/" style="font-size:.88rem;color:#338051">super<sup>2</sup></a><a href="/tags/this/" style="font-size:.88rem;color:#a224a6">this<sup>1</sup></a><a href="/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/" style="font-size:.88rem;color:#334e6b">二进制<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" style="font-size:.88rem;color:#2dbd22">数据类型<sup>4</sup></a><a href="/tags/%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95/" style="font-size:.88rem;color:#b7640c">构造方法<sup>1</sup></a><a href="/tags/%E6%BA%A2%E5%87%BA/" style="font-size:.88rem;color:#0b6ab5">溢出<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size:.88rem;color:#0e1424">算法<sup>1</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E5%AE%9E%E8%B7%B5/" style="font-size:.88rem;color:#000592">编程实践<sup>2</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A8%8B%E5%BA%8F/" style="font-size:.88rem;color:#56b352">计算机程序<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%AF%AD%E8%A8%80/" style="font-size:.88rem;color:#8a3737">计算机语言<sup>1</sup></a><a href="/tags/%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6/" style="font-size:.88rem;color:#a03027">访问控制<sup>1</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6/" style="font-size:.88rem;color:#0d6442">软件<sup>1</sup></a><a href="/tags/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/" style="font-size:.88rem;color:#c753c8">错误处理<sup>2</sup></a><a href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" style="font-size:.88rem;color:#c14483">面向对象<sup>6</sup></a></div></div><hr></div></div><div id="keyboard-tips"><div class="keyboardTitle">博客快捷键</div><div class="keybordList"><div class="keybordItem"><div class="keyGroup"><div class="key">shift K</div></div><div class="keyContent"><div class="content">关闭快捷键功能</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift A</div></div><div class="keyContent"><div class="content">打开/关闭中控台</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift M</div></div><div class="keyContent"><div class="content">播放/暂停音乐</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift D</div></div><div class="keyContent"><div class="content">深色/浅色显示模式</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift S</div></div><div class="keyContent"><div class="content">站内搜索</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift R</div></div><div class="keyContent"><div class="content">随机访问</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift H</div></div><div class="keyContent"><div class="content">返回首页</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift F</div></div><div class="keyContent"><div class="content">友链鱼塘</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift L</div></div><div class="keyContent"><div class="content">友链页面</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift P</div></div><div class="keyContent"><div class="content">关于本站</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift I</div></div><div class="keyContent"><div class="content">原版/本站右键菜单</div></div></div></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="share" type="button" title="分享链接" onclick="share()"><i class="fas fa-share-nodes"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="anzhiyufont anzhiyu-icon-comment-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" rel="external nofollow noreferrer" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="anzhiyu.scrollToDest(document.body.scrollHeight,500)"><i class="anzhiyufont anzhiyu-icon-arrow-down"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size:1rem"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display:none"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://cdn.cbd.int/pangu@4.0.7/dist/browser/pangu.min.js").then(()=>{pangu.autoSpacingPage()})}function panguInit(){panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><script>var HoldLog=console.log;console.log=function(){};let now1=new Date;queueMicrotask(()=>{function o(){HoldLog.apply(console,arguments)}var c=new Date("6/28/2018 00:00:00"),c=(now1.setTime(now1.getTime()+250),(now1-c)/1e3/60/60/24),c=["Hi there 👋，I'm dong4j, Welcome to my blog","岁月静好，诗酒趁年华🍺",`
        
      +========================================================+
      |  ██████╗  ██████╗ ███╗   ██╗ ██████╗ ██╗  ██╗     ██╗  |
      |  ██╔══██╗██╔═══██╗████╗  ██║██╔════╝ ██║  ██║     ██║  |
      |  ██║  ██║██║   ██║██╔██╗ ██║██║  ███╗███████║     ██║  |
      |  ██║  ██║██║   ██║██║╚██╗██║██║   ██║╚════██║██   ██║  |
      |  ██████╔╝╚██████╔╝██║ ╚████║╚██████╔╝     ██║╚█████╔╝  |
      |  ╚═════╝  ╚═════╝ ╚═╝  ╚═══╝ ╚═════╝      ╚═╝ ╚════╝   |
      +========================================================+
        
        `,"已上线",Math.floor(c),"天","Use 「npx dong4j」 and find me."],e=["NCC2-036","调用前置摄像头拍照成功，识别为【绝顶大佬】.","Photo captured: ","🤪"];setTimeout(o.bind(console,`
%c${c[0]} %c ${c[1]} %c ${c[2]} %c${c[3]}%c ${c[4]}%c ${c[5]}

%c ${c[6]}
`,"color:#425AEF","","color:#425AEF","color:#425AEF","","color:#425AEF","")),setTimeout(o.bind(console,`%c ${e[0]} %c ${e[1]} %c 
${e[2]} %c
${e[3]}
`,"color:white; background-color:#4fd953","","",'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%')),setTimeout(o.bind(console,"%c WELCOME %c 你好，绝顶大佬.","color:white; background-color:#4f90d9","")),setTimeout(console.warn.bind(console,"%c ⚡ Powered by 安知鱼 %c 你正在访问 dong4j 的博客.","color:white; background-color:#f0ad4e","")),setTimeout(o.bind(console,"%c W23-12 %c 你已打开控制台.","color:white; background-color:#4f90d9","")),setTimeout(console.warn.bind(console,"%c S013-782 %c 你现在正处于监控中.","color:white; background-color:#d9534f",""))})</script><script async="" src="/anzhiyu/random.js"></script><script async="">(()=>{var n,o,r,a,i,e=new Date("6/28/2018 00:00:00"),l=new Date;setInterval(()=>{var t;if(l=new Date,i=l.getHours(),t=(l-e)/1e3/60/60/24,n=Math.floor(t),t=(l-e)/1e3/60/60-24*n,o=Math.floor(t),1==String(o).length&&(o="0"+o),t=(l-e)/1e3/60-1440*n-60*o,r=Math.floor(t),1==String(r).length&&(r="0"+r),t=(l-e)/1e3-86400*n-3600*o-60*r,a=Math.round(t),1==String(a).length&&(a="0"+a),document.getElementById("footer")){let e="";e=(i<18&&9<=i||null!=(t=document.querySelector("#workboard .workSituationImg"))&&(t.src="https://npm.elemecdn.com/anzhiyu-blog@2.0.4/img/badge/安知鱼-下班啦.svg",t.title="下班了就该开开心心的玩耍，嘿嘿~",t.alt="下班了就该开开心心的玩耍，嘿嘿~"),`本站居然运行了 ${n} 天<span id='runtime'> ${o} 小时 ${r} 分 ${a} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`),document.getElementById("runtimeTextTip")&&(document.getElementById("runtimeTextTip").innerHTML=e)}},1e3)})()</script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(()=>{let t=document.querySelectorAll("#article-container .mermaid-wrap");if(0!==t.length){let e=()=>{window.loadMermaid=!0;let a="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";Array.from(t).forEach((e,t)=>{let d=e.firstElementChild;e="%%{init:{ 'theme':'"+a+"'}}%%\n"+d.textContent;let n=mermaid.render("mermaid-"+t,e);"string"==typeof n?(t=n,d.insertAdjacentHTML("afterend",t)):n.then(({svg:e})=>{d.insertAdjacentHTML("afterend",e)})})};var d=()=>{window.loadMermaid?e():getScript("https://cdn.cbd.int/mermaid@10.2.4/dist/mermaid.min.js").then(e)};anzhiyu.addGlobalFn("themeChange",e,"mermaid"),window.pjax?d():document.addEventListener("DOMContentLoaded",d)}})()</script><script>(()=>{let t=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"https://twikoo.dong4j.ink:1024",region:"",onCommentLoaded:()=>{anzhiyu.loadLightbox(document.querySelectorAll("#twikoo .tk-content img:not(.tk-owo-emotion)"))}},null))};var o=()=>{"object"==typeof twikoo?setTimeout(n,0):getScript("https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js").then(n)};let e=()=>{let o=document.getElementById("twikoo-count");o&&twikoo.getCommentsCount({envId:"https://twikoo.dong4j.ink:1024",region:"",urls:[window.location.pathname],includeReply:!1}).then(t=>{o.textContent=t[0].count}).catch(t=>{console.error(t)})},n=()=>{t(),GLOBAL_CONFIG_SITE.isPost&&e()};o()})()</script><input type="hidden" name="page-type" id="page-type" value="post"><script async="" src="/js/anzhiyu/comment_barrage.js"></script></div><script>window.addEventListener("load",()=>{let t=e=>e=""!==e&&150<(e=(e=(e=(e=e.replace(/<img.*?src="(.*?)"?[^\>]+>/gi,"[图片]")).replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi,"[链接]")).replace(/<pre><code>.*?<\/pre>/gi,"[代码]")).replace(/<[^>]+>/g,"")).length?e.substring(0,150)+"...":e,n=t=>{let n="";if(t.length)for(let e=0;e<t.length;e++)n=(n=(n+="<div class='aside-list-item'>")+`<a href='${t[e].url}' class='thumbnail'><img data-lazy-src='${t[e].avatar}' alt='${t[e].nick}'><div class='name'><span>${t[e].nick} </span></div></a>`)+`<div class='content'>
        <a class='comment' href='${t[e].url}' title='${t[e].content}'>${t[e].content}</a>
        <time datetime="${t[e].date}">${anzhiyu.diffDate(t[e].date,!0)}</time></div>
        </div>`;else n+="没有评论";var e=document.querySelector("#card-newest-comments .aside-list");e&&(e.innerHTML=n),window.lazyLoadInstance&&window.lazyLoadInstance.update(),window.pjax&&window.pjax.refresh(e)};var e=()=>{var e;document.querySelector("#card-newest-comments .aside-list")&&((e=saveToLocal.get("twikoo-newest-comments"))?n(JSON.parse(e)):(e=()=>{twikoo.getRecentComments({envId:"https://twikoo.dong4j.ink:1024",region:"",pageSize:6,includeReply:!0}).then(function(e){e=e.map(e=>({content:t(e.comment),avatar:e.avatar,nick:e.nick,url:e.url+"#"+e.id,date:new Date(e.created).toISOString()}));saveToLocal.set("twikoo-newest-comments",JSON.stringify(e),10/1440),n(e)}).catch(function(e){document.querySelector("#card-newest-comments .aside-list").textContent="无法获取评论，请确认相关配置是否正确"})},"object"==typeof twikoo?e():getScript("https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js").then(e)))};e(),document.addEventListener("pjax:complete",e)})</script><script>var visitorMail="996@icu.com"</script><script async="" data-pjax="" src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.dong4j.site/source/static/subscribe.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://cdn.dong4j.site/source/static/card-widget-today.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://cdn.dong4j.site/source/static/card-widget-calendar.css" media="print" onload="this.media=&quot;all&quot;"><script async="" data-pjax="" src="https://cdn.dong4j.site/source/static/automatic-redirection.js"></script><script src="https://cdn.dong4j.site/source/static/card-widget-welcome.js"></script><script async="" data-pjax="" src="https://cdn.dong4j.site/source/static/card-widget-comments.js"></script><script async="" data-pjax="" src="https://cdn.dong4j.site/source/static/card-widget-today.js"></script><script src="https://cdn.dong4j.site/source/static/card-widget-countdown.js"></script><script src="https://cdn.dong4j.site/source/static/card-widget-calendar.js"></script><script async="" data-pjax="" src="https://open.lightxi.com/unpkg/chinese-lunar@0.1.4/lib/chinese-lunar.js"></script><script async="" data-pjax="" src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script src="https://cdn.dong4j.site/source/static/custom.js"></script><script src="https://cdn.dong4j.site/source/static/geoip2-check.js"></script><script defer="" id="fluttering_ribbon" mobile="false" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-show-text" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="永不言败,勇往直前,砥砺前行,自强不息,笃行致远,厚德载物,持之以恒,奋发有为,志在四方,拼搏进取,实事求是，为人民服务,勤劳致富，共奔小康,爱国、创新、包容、厚德,敬业乐群，诚信友善,自强不息，厚德载物,以人为本，全面协调可持续发展,建设生态文明，构建和谐社会,坚持改革开放，推动科学发展,立党为公，执政为民,实现中华民族伟大复兴的中国梦" data-fontsize="15px" data-random="true" async=""></script><script src="//code.tidio.co/14aqpkwnauu3r5ngcmspfxwelvattym5.js" async=""></script><script>(()=>{{let i=!1,o=()=>{window.tidioChatApi.hide(),i=!1,document.body.style.position="relative",document.documentElement.style.overflow="auto"};var t=()=>{window.tidioChatApi.hide(),window.tidioChatApi.on("close",o)};window.tidioChatApi?window.tidioChatApi.on("ready",t):document.addEventListener("tidioChat-ready",t),window.chatBtnFn=()=>{window.tidioChatApi&&(i?o():(window.tidioChatApi.open(),window.tidioChatApi.show(),i=!0))}}})()</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media=&quot;all&quot;"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors=['meta[property="og:image"]','meta[property="og:title"]','meta[property="og:url"]','meta[property="og:type"]','meta[property="og:site_name"]','meta[property="og:description"]',"head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:send",function(){if(anzhiyu.removeGlobalFnEvent("pjax"),anzhiyu.removeGlobalFnEvent("themeChange"),document.getElementById("rightside").classList.remove("rightside-show"),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();var e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")}),document.addEventListener("pjax:complete",function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach(e=>{let t=document.createElement("script");var a=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(a)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll()}),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script><script async="" data-pjax="" data-prefix="busuanzi_value" src="https://cdn.dong4j.site/source/static/busuanzi.self.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div><script data-pjax="" src="https://cdn.dong4j.site/source/static/github-calendar.js"></script><script data-pjax="">function GithubCalendarConfig(){var t=document.getElementById("recent-posts");t&&"/"==location.pathname&&(console.log("已挂载hexo-github-calendar https://github.com/Barry-Flynn/hexo-github-calendar"),t.insertAdjacentHTML("afterbegin",'<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><div id="github_loading" style="width:10%;height:100%;margin:0 auto;display: block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg></div><div id="github_container"></div></div>')),GithubCalendar("https://github-calendar.dong4j.ink:1024/api?user=dong4j",["#ebedf0","#a2f7af","#6ce480","#54ad63","#469252","#31753c","#1f5f2a","#13531f","#084111","#032b09","#000000"],"dong4j")}document.getElementById("recent-posts")&&GithubCalendarConfig()</script><style>#github_container{min-height:280px}@media screen and (max-width:650px){#github_container{min-height:0}}</style><style></style></body></html>