# å¸æœºå¸¦ä½ å¼€è½¦

> æŠ€æœ¯æ— å›½ç•Œ, æŠ˜è…¾æ— æ­¢å¢ƒ

## Article List

## [Proxmox VE 8.3 å®‰è£…ä¸é…ç½®æŒ‡å—](https://blog.dong4j.site/posts/13e613ba.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ç®€ä»‹

æœ¬æ–‡æ±‡æ€»äº†æˆ‘åœ¨ä¸‰å°è”æƒ³ M920x ä¸Šæ­å»ºå’Œä½¿ç”¨ **PVE**ï¼ˆProxmox Virtual Environmentï¼‰è¿‡ç¨‹ä¸­çš„å¿ƒå¾—ä¸é‡åˆ°çš„é—®é¢˜ã€‚

åœ¨é€‰æ‹©è™šæ‹ŸåŒ–å¹³å°æ—¶ï¼Œæˆ‘å€¾å‘äº **PVE** è€Œé **ESXi**ï¼ˆvSphere Hypervisorï¼‰ã€‚

è¿™ä¸€é€‰æ‹©åŸºäº PVE çš„å¼€æºæ€§åŠå…¶åŸºäº Debian çš„æ¶æ„ï¼Œè¿™ä¸ºå®ƒå¸¦æ¥äº†ç›¸æ¯” ESXi æ›´å¤šçš„å¯ç©æ€§å’ŒæŠ˜è…¾ç©ºé—´ã€‚

> é€‰æ‹© PVE æˆ– ESXi å¹¶ä¸åœ¨äºå“ªä¸ªæ›´ä¼˜ç§€ï¼Œè€Œåœ¨äºå“ªä¸ªæ›´èƒ½æ»¡è¶³ä¸ªäººçš„ç‰¹å®šéœ€æ±‚ã€‚

## å®‰è£…å®Œæˆå IP ä¸å¯¹

å¯åŠ¨åå‡ºç°äº†ä¸€å¼  `vmbr0` ç½‘å¡, è¿™ä¸ªæ˜¯æ¡¥æ¥ç½‘å¡, å¯ä»¥æŸ¥çœ‹ç»‘å®šçš„ç‰©ç†ç½‘å¡:

```bash
ip link show master vmbr0
```

ä¿®æ”¹ä¸€ä¸‹ 3 ä¸ªæ–‡ä»¶:

```bash
# /etc/network/interfaces

auto lo
iface lo inet loopback

iface enp92s0 inet manual

auto vmbr0
iface vmbr0 inet static
	address 192.168.100.100/24
	gateway 192.168.100.1
	bridge-ports enp92s0
	bridge-stp off
	bridge-fd 0

# /etc/issue
Welcome to the Proxmox Virtual Environment. Please use your web browser to
configure this server - connect to:

  https://192.168.100.100:8006/

# /etc/hosts

127.0.0.1 localhost.localdomain localhost
192.168.100.100 nuc.ihome nuc
```

**å‚è€ƒ:**

- https://www.zhihu.com/tardis/zm/art/492484833?source_id=1003

---

## æ›´æ¢æº

```bash
apt install apt-transport-https ca-certificates

wget https://mirrors.ustc.edu.cn/proxmox/debian/proxmox-release-bookworm.gpg -O /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg
```

### é€šç”¨è½¯ä»¶æº

```bash
cp /etc/apt/sources.list /etc/apt/sources.list.bak
vim /etc/apt/sources.list
```

```bash
# é»˜è®¤æ³¨é‡Šäº†æºç é•œåƒä»¥æé«˜ apt update é€Ÿåº¦ï¼Œå¦‚æœ‰éœ€è¦å¯è‡ªè¡Œå–æ¶ˆæ³¨é‡Š
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm main contrib non-free-firmware

# deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm main contrib non-free-firmware
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm-updates main contrib non-free-firmware
# deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm-updates main contrib non-free-firmware
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm-backports main contrib non-free-firmware
# deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm-backports main contrib non-free-firmware
deb https://mirrors.tuna.tsinghua.edu.cn/debian-security bookworm-security main contrib non-free-firmware
# deb-src https://mirrors.tuna.tsinghua.edu.cn/debian-security bookworm-security main contrib non-free-firmware
```

### pve è½¯ä»¶æº

```bash
cp /etc/apt/sources.list.d/pve-enterprise.list /etc/apt/sources.list.d/pve-enterprise.list.bak

# æ¸…ç©º /etc/apt/sources.list.d/pve-enterprise.list
```

```bash
# ä½¿ç”¨Proxmoxéä¼ä¸šç‰ˆæº
echo "deb https://mirrors.ustc.edu.cn/proxmox/debian bookworm pve-no-subscription" > /etc/apt/sources.list.d/pve-no-subscription.list
```

### Ceph æº

```bash
cp /etc/apt/sources.list.d/ceph.list /etc/apt/sources.list.d/ceph.list.bak

echo "deb https://mirrors.ustc.edu.cn/proxmox/debian/ceph-quincy bookworm no-subscription" > /etc/apt/sources.list.d/ceph.list
```

### CT é•œåƒä¸‹è½½æº

å°† /usr/share/perl5/PVE/APLInfo.pm æ–‡ä»¶ä¸­é»˜è®¤çš„æºåœ°å€ http://download.proxmox.com æ›¿æ¢ä¸º https://mirrors.tuna.tsinghua.edu.cn/proxmox å³å¯ã€‚

```bash
cp /usr/share/perl5/PVE/APLInfo.pm /usr/share/perl5/PVE/APLInfo.pm.bak

sed -i 's|http://download.proxmox.com|https://mirrors.ustc.edu.cn/proxmox|g' /usr/share/perl5/PVE/APLInfo.pm
```

```
{
    host => "mirrors.ustc.edu.cn",
    url => "https://mirrors.ustc.edu.cn/turnkeylinux/metadata/pve",
    file => 'aplinfo.dat',
}
```

```bash
systemctl restart pvedaemon.service && pveam update && pveam available
```

## åˆ é™¤è®¢é˜…å¼¹çª—

```bash
sed -Ezi.bak "s/(Ext.Msg.show\(\{\s+title: gettext\('No valid sub)/void\(\{ \/\/\1/g" /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js && systemctl restart pveproxy.service
```

---

## oh-my-zsh

```bash

apt update && apt install git zsh curl \
	&& sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"

git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting \
	&& git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions \
  && git clone https://github.com/zsh-users/zsh-completions ${ZSH_CUSTOM:-${ZSH:-~/.oh-my-zsh}/custom}/plugins/zsh-completions
```

---

## è¿æ¥ WiFi

```bash
apt-get install wpasupplicant wireless-tools -y

ip link set wlp91s0 up
iwlist wlp91s0 scanning | grep "ESSID"

wpa_passphrase [WIFIåç§°] [WIFIå¯†ç ]
```

> [No wpa_supplicant executable](https://raspberrypi.stackexchange.com/questions/137121/no-wpa-supplicant-executable)

ä¼šå¾—åˆ°ç±»ä¼¼ä»¥ä¸‹çš„è¾“å‡º(ä¹Ÿå¯ä»¥ä½¿ç”¨ç½‘é¡µå·¥å…·è®¡ç®—: https://www.wireshark.org/tools/wpa-psk.html:

```
network={
    ssid="[WIFIåç§°]"
    #psk="[WIFIå¯†ç ]"
    psk=[WIFIå¯†ç çš„å¯†é’¥å€¼]
}
```

æˆ‘ä»¬éœ€è¦å¤åˆ¶è¿™ä¸ª PSK å€¼ã€‚

---

1. æ‰“å¼€`/etc/network/interfaces`æ–‡ä»¶
2. æ·»åŠ ä»¥ä¸‹å†…å®¹

```
auto [ç½‘å¡åç§°]

# å¦‚æœä½ ä½¿ç”¨é™æ€IP
iface [ç½‘å¡åç§°] inet static
    address [ä½ è¦åˆ†é…çš„IPåœ°å€ï¼Œå¦‚192.168.4.1/24]
    gateway [ç½‘å…³åœ°å€]
    wpa-ssid [WIFIåç§°]
    wpa-psk [WIFIå¯†ç çš„å¯†é’¥å€¼]

# å¦‚æœä½ ä½¿ç”¨åŠ¨æ€IP
iface [ç½‘å¡åç§°] inet dhcp
    wpa-ssid [WIFIåç§°]
    wpa-psk [WIFIå¯†ç çš„å¯†é’¥å€¼]
```

> ä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œæˆ‘ä»¬æ¨èä½ ä½¿ç”¨é™æ€ IP 3. é‡å¯ç½‘ç»œ

```
ifdown [ç½‘å¡åç§°]
ifup [ç½‘å¡åç§°]
```

**å®‰è£… iw å·¥å…·**

```bash
apt install iw -y
```

**æŸ¥çœ‹ WiFi ä¿¡æ¯**

```bash
$ iwconfig wlp91s0
wlp91s0   IEEE 802.11  ESSID:"xxxxx"
          Mode:Managed  Frequency:5.745 GHz  Access Point: 9C:9D:7E:7C:90:19
          Bit Rate=29.2 Mb/s   Tx-Power=22 dBm
          Retry short limit:7   RTS thr:off   Fragment thr:off
          Encryption key:off
          Power Management:on
          Link Quality=48/70  Signal level=-62 dBm
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:92   Missed beacon:0
```

**å‚è€ƒ**

- [åŸºäº PVE ä¸ AX210 æ— çº¿ç½‘å¡çš„ NAS ä¸»æœºè°ƒè¯•è®°å½•](https://www.bilibili.com/opus/938437808628957191)
- [proxmox ä¸­ä½¿ç”¨ ax210 è¿æ¥æ— çº¿ç½‘ç»œ](https://foxi.buduanwang.vip/virtualization/pve/1939.html/)

---

## Web æ‰“ä¸å¼€

`501 no such file '/PVE/StdWorkspace.js'`

```bash
apt install --reinstall proxmox-widget-toolkit

apt update && apt upgrade
apt install -f

apt dist-upgrade
pvecm updatecerts --force
service pveproxy restart
```

---

## pve_source è„šæœ¬

https://bbs.x86pi.cn/thread?topicId=20

**ç¨³å®šç‰ˆ**

```bash
wget -q -O /root/pve_source.tar.gz 'https://bbs.x86pi.cn/file/topic/2023-11-28/file/01ac88d7d2b840cb88c15cb5e19d4305b2.gz' && tar zxvf /root/pve_source.tar.gz && /root/./pve_source
```

å¼€å‘ç‰ˆ (PVE ç³»ç»Ÿé…ç½® IOMMUã€æ ¸æ˜¾ç›´é€šã€æ ¸æ˜¾ SR-IOV è°ƒæ•´ä¸ºå®šåˆ¶å‘å¯¼+æ¨èæ–¹æ¡ˆ)

```bash
wget -q -O /root/pve_source.tar.gz 'https://bbs.x86pi.cn/file/topic/2024-01-06/file/24f723efc6ab4913b1f99c97a1d1a472b2.gz' && tar zxvf /root/pve_source.tar.gz && /root/./pve_source
```

---

## è¿ç§» Ubuntu ç³»ç»Ÿåˆ° PVE

**åˆ—ä¸¾ä¸€ä¸‹å·²å­˜åœ¨çš„ M.2 å›ºæ€ç¡¬ç›˜ä¿¡æ¯:**

![20250218100813_9YKCDhZZ.webp](https://cdn.dong4j.site/source/image/20250218100813_9YKCDhZZ.webp)

ä¸€å…± 1T \*4 M.2 å›ºæ€ç¡¬ç›˜, å…¶ä¸­ **nvme0n1** å®‰è£…çš„ PVE, å…¶ä»– 3 æ ¹è¿˜æœªä½¿ç”¨.

### é•œåƒæ‰“åŒ…

åŸæ¥å®‰è£… Ubuntu çš„ M.2 500G å›ºæ€ç¡¬ç›˜å·²ç»ä»æœºå™¨ä¸Šæ‹”ä¸‹æ¥äº†, ä¸ºäº†å°†æ­¤å›ºæ€ç¡¬ç›˜ä¸­çš„ç³»ç»Ÿæ‰“åŒ…æˆé•œåƒç„¶åæ¢å¤åˆ° PVE ä¸­, è¿™é‡Œä½¿ç”¨äº† Clonezilla æ¥å®Œæˆè¿™é¡¹å·¥ä½œ.

ä½¿ç”¨åˆ°çš„å·¥å…·:

1. [Clonezilla](https://clonezilla.org/)
2. [Ventoy](https://www.ventoy.net/)

![20250218105012_ChdOGfq8.webp](https://cdn.dong4j.site/source/image/20250218105012_ChdOGfq8.webp)

![20250221012151_nPtdL8DT.webp](https://cdn.dong4j.site/source/image/20250221012151_nPtdL8DT.webp)

æ‰§è¡Œå®Œæˆåä¼šåœ¨æŒ‡å®šçš„ U ç›˜ç”Ÿæˆä¸€äº›ç³»ç»Ÿæ–‡ä»¶, ä½†æ˜¯è¿™ä¸ªè¿˜ä¸èƒ½ç›´æ¥ä½¿ç”¨, æ‰€ä»¥æˆ‘åˆä½¿ç”¨ Clonezilla å°†è¿™äº›æ–‡ä»¶æ‰“åŒ…æˆ ISO.

> æœ€ç»ˆçš„ç›®çš„æ˜¯å°† Ubuntu ç³»ç»Ÿæ‰“åŒ…æˆ ISO, ç„¶ååœ¨ PVE ä¸­ä½¿ç”¨è™šæ‹Ÿæœºå®‰è£….

**å‚è€ƒ**

- [clonezilla(å†ç”Ÿé¾™)å…‹éš† linux ç³»ç»Ÿ æ“ä½œæŒ‡å—](https://blog.csdn.net/weixin_36432129/article/details/130502411)
- [ä½¿ç”¨å†ç”Ÿé¾™ CloneZilla è¿›è¡Œ Linux ç³»ç»Ÿçš„é•œåƒå®Œå…¨å°è£…å’Œè¿˜åŸ](https://zhuanlan.zhihu.com/p/354584111)

### å®‰è£…åˆ° PVE

åœ¨ PVE ä¸‹æŸ¥çœ‹ P40 æ˜¾å¡çš„ä¿¡æ¯ï¼š

```bash
lspci |  grep 3D
81:00.0 3D controller: NVIDIA Corporation GP102 [P102-100] (rev a1)
```

è¦ç›´é€šè¿™å—å¡ç»™ Ubuntu 24.04 è™šæ‹Ÿæœºï¼Œéœ€è¦å‡†å¤‡ï¼š

- å¼€å¯ pcie ç›´é€š
- å®‰è£… Ubuntu 24.04 è™šæ‹Ÿæœº(å°±æ˜¯ä¸Šä¸€æ­¥æ‰“åŒ…çš„ ISO)

---

## å®‰è£… Windows

https://www.mulingyuer.com/archives/1027/

https://willxup.top/archives/pve-install-win11

https://imacos.top/2023/09/07/pve-windows-11/

### æ ¸æ˜¾ç›´é€šä¸è™šæ‹Ÿæ ¸æ˜¾ç›´é€š

**ç‰©ç†æ ¸æ˜¾ç›´é€š vs SRIOV vGPU çš„ä¼˜ç¼ºç‚¹å¯¹æ¯”ï¼š**

|                    | ä¼˜ç‚¹                                                                              | ç¼ºç‚¹                                                                                                                                                                                                                                                                                                                                                                        |
| ------------------ | --------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ç‰©ç†æ ¸æ˜¾ç›´é€š       | 1ã€æ€§èƒ½å¼º 2ã€æ”¯æŒç‰©ç†æ˜¾ç¤ºè¾“å‡º (VGA/DP/HDMI/Type-C) 3ã€å…¼å®¹æ€§å¥½ï¼Œä¸å¦¨ç¢ PVE å‡çº§ã€‚ | ç‹¬å ï¼ˆä¸æ”¯æŒç›´é€šç»™å¤šä¸ªè™šæ‹Ÿæœºï¼‰ ç›´é€šåï¼ŒPVE å®¿ä¸»ä¸èƒ½åŒæ—¶ç”¨æ ¸æ˜¾ã€‚                                                                                                                                                                                                                                                                                                             |
| SRIOV è™šæ‹Ÿæ ¸æ˜¾ç›´é€š | å¯åˆ†ä¸ºå¤šä¸ª VF è™šæ‹Ÿæ˜¾å¡ï¼Œ ç»™ä¸åŒçš„è™šæ‹Ÿæœºä½¿ç”¨ã€‚                                     | 1ã€æ€§èƒ½æ‹†åˆ†ï¼ˆåˆ†æˆå¤šä¸ª VF æ˜¾å¡å…·ä½“å¦‚ä½•åˆ†é…æ€§èƒ½ä¸è¯¦ï¼‰ å¦‚ N100 ç­‰ä¸å»ºè®®è¶…è¿‡ 3 ä¸ª VF æ˜¾å¡ï¼Œå…·æœ‰æ€§èƒ½é«˜æ ¸æ˜¾çš„å¤„ç†å™¨å¯ä»¥åˆ†ä¸ºæœ€é«˜ 7 ä¸ªï¼‰ï¼› 2ã€ä¸æ”¯æŒç‰©ç†æ˜¾ç¤ºè¾“å‡ºï¼Œè™½å¯ä½¿ç”¨ Todesk ç­‰è½¯ä»¶è¿œç¨‹æ¡Œé¢ï¼Œä½† CPU å ç”¨ç‡è¾ƒé«˜ã€‚åœ¨ä½œä¸ºæœåŠ¡å™¨çš„å°ä¸»æœºä¸Šï¼Œè®©åŸæœ¬ç´§å¼ çš„èµ„æºæ›´åŠ æ‰è¥Ÿè§è‚˜ã€‚ 3ã€å¯¹å†…æ ¸ header ä¾èµ–ï¼ˆ6.1-6.5ï¼‰ï¼ŒPVE å‡çº§å—é™ã€‚ 4ã€å…¼å®¹æ€§ç¨³å®šæ€§ä¸€èˆ¬ï¼Œéƒ¨åˆ†æµåª’ä½“è½¯ä»¶ç¡¬è§£/è½¬ç åŠŸèƒ½å—é™ã€‚ |

### è™šæ‹Ÿæ ¸æ˜¾ç›´é€š

```bash
apt install pve-kernel-$(uname -r)
proxmox-boot-tool kernel pin $(uname -r)
apt install pve-headers-$(uname -r)

wget https://github.com/moetayuko/intel-gpu-i915-backports/releases/download/I915MT65-24.1.19-6/intel-i915-dkms_1.24.1.19.240119.1.nodrm+i6-1_all.deb

apt update & apt install build-* pve-headers-$(uname -r) git dkms sysfsutils flex bison -y

wget -O /lib/firmware/updates/i915/tgl_guc_70.9.1.bin https://github.com/intel-gpu/intel-gpu-firmware/blob/main/firmware/tgl_guc_70.9.1.bin

dpkg -i intel-i915-dkms_1.24.1.19.240119.1.nodrm+i6-1_all.deb

vim /etc/default/grub
```

åœ¨ `quiet` åæ·»åŠ  `intel_iommu=on iommu=pt i915.enable_guc=3 i915.max_vfs=7`

```bash
update-grub
update-initramfs -u

apt install -y sysfsutils
```

```bash
echo "devices/pci0000:00/0000:00:02.0/sriov_numvfs = 3" > /etc/sysfs.conf

----------------
#æœ‰ä¿®æ”¹è™šæ‹Ÿæ ¸æ˜¾æ•°é‡çš„éœ€æ±‚
nano /etc/sysfs.conf
#å°†åŸæ¥å†™å…¥çš„å‚æ•°æ³¨é‡Šæ‰
#devices/pci0000:00/0000:00:02.0/sriov_numvfs = 3
#æ”¹æˆä½ éœ€è¦çš„æ•°é‡ï¼Œä¾‹å¦‚ä¸‹è¿°ä¸º5ä¸ª
devices/pci0000:00/0000:00:02.0/sriov_numvfs = 5
```

```bash
reboot
```

```bash
$ dkms status
intel-i915-dkms/1.24.1.19.240119.1.nodrm, 6.8.12-8-pve, x86_64: installed
```

```bash
$ dmesg |grep i915

...
[    4.564128] i915 0000:00:02.0: Enabled 3 VFs
```

```bash
vim /etc/pve/qemu-server/100.conf

args: -set device.hostpci0.addr=02.0 -set device.hostpci0.x-igd-gms=0x2
```

**å‚è€ƒ**

- [ã€PVEã€‘All in One çš„å¿«ä¹ä¹‹ç³»ç»Ÿé…ç½®åŠæ ¸æ˜¾ SR-IOV ç›´é€š](https://www.cloudstaymoon.com/2024/04/10/all-in-one-1)

- [ä¸€è¾¹åŸç¥ä¸€è¾¹ galgame ï¼šåŒæ—¶ç‹¬æ˜¾ç›´é€šå’Œæ ¸æ˜¾è™šæ‹ŸåŒ–](https://zhuanlan.zhihu.com/p/571224296)

- [ç©è½¬ AIGCï¼šæ‰“é€ æœ¬åœ°å¤§æ¨¡å‹åœ°åŸºï¼ŒPVE é…ç½®æ˜¾å¡ç›´é€š](https://juejin.cn/post/7364224622681112610)
- [PVE8 ç›´é€š ubuntu 22.04](https://skyao.io/learning-computer-hardware/graphics/p102/pve-ubuntu2204/)
- [Proxmox VE (Tesla P40) vGPU é…ç½®](https://azhuge233.com/proxmox-ve-tesla-p40-vgpu-%e9%85%8d%e7%bd%ae/)
- [Proxmox VE 8 Tesla P40 vGPU é…ç½®](https://azhuge233.com/proxmox-ve-8-tesla-p40-vgpu-%E9%85%8D%E7%BD%AE/)
- [Proxmox VE æ˜¾å¡ï¼ˆTesla P40ï¼‰ç›´é€š](https://azhuge233.com/proxmox-ve-%E6%98%BE%E5%8D%A1%EF%BC%88tesla-p40%EF%BC%89%E7%9B%B4%E9%80%9A/)
- [PVE ç›´é€šæ˜¾å¡ & Intel SRIOV](https://juejin.cn/post/7330920549771837481)
- [PCI Passthrough](https://pve.proxmox.com/wiki/PCI_Passthrough)

---

## å®‰è£… Ubuntu

PVEï¼ˆProxmox VEï¼‰ä¸­çš„ç½‘ç»œæ¨¡å‹é€‰æ‹©å–å†³äº **è™šæ‹Ÿæœºçš„ç”¨é€”å’Œæ€§èƒ½éœ€æ±‚**ã€‚ä¸åŒçš„ç½‘å¡æ¨¡å‹æœ‰ä¸åŒçš„**å…¼å®¹æ€§**å’Œ**æ€§èƒ½**ï¼Œä»¥ä¸‹æ˜¯å¯¹æ¯”ï¼š

**1. VirtIOï¼ˆåŠè™šæ‹ŸåŒ–ï¼‰ï¼ˆâœ… æ¨èï¼‰**

- **ä¼˜ç‚¹**ï¼š

  - **æ€§èƒ½æœ€ä½³**ï¼Œæ”¯æŒ **é«˜ååé‡**ï¼Œ**ä½ CPU å¼€é”€**ã€‚
  - **å»¶è¿Ÿæœ€ä½**ï¼Œé€‚åˆé«˜æ€§èƒ½æœåŠ¡å™¨ã€æ•°æ®åº“ã€Web æœåŠ¡ç­‰åº”ç”¨ã€‚
  - ç°ä»£ Linuxï¼ˆUbuntuã€Debianã€CentOSï¼‰**è‡ªå¸¦ VirtIO é©±åŠ¨**ï¼Œæ— éœ€é¢å¤–å®‰è£…ã€‚

- **ç¼ºç‚¹**ï¼š
  - Windows éœ€è¦ **æ‰‹åŠ¨å®‰è£… VirtIO é©±åŠ¨**ï¼ˆå¯ä»¥ä»[è¿™é‡Œ](https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/)ä¸‹è½½ï¼‰ã€‚

âœ… **æ¨èç”¨äºï¼šLinux è™šæ‹Ÿæœºã€Windowsï¼ˆå®‰è£… VirtIO é©±åŠ¨ï¼‰ã€é«˜æ€§èƒ½åº”ç”¨**

**2. Intel E1000 / E1000Eï¼ˆğŸŸ¡ å…¼å®¹æ€§å¥½ï¼Œä½†æ€§èƒ½ä¸€èˆ¬ï¼‰**

- **ä¼˜ç‚¹**ï¼š

  - å…¼å®¹æ€§**éå¸¸å¥½**ï¼Œå‡ ä¹æ‰€æœ‰æ“ä½œç³»ç»Ÿéƒ½**è‡ªå¸¦é©±åŠ¨**ï¼Œæ— éœ€é¢å¤–å®‰è£…ã€‚
  - é€‚ç”¨äº**è€æ—§æ“ä½œç³»ç»Ÿ**ï¼ˆå¦‚ Windows XP/2003ï¼‰ã€‚

- **ç¼ºç‚¹**ï¼š
  - **CPU å¼€é”€å¤§**ï¼Œæ•°æ®åŒ…å¤„ç†æ•ˆç‡ä½ã€‚
  - **å¸¦å®½é™åˆ¶åœ¨ 1Gbps**ï¼Œæ— æ³•å‘æŒ¥ç°ä»£ç¡¬ä»¶çš„æœ€å¤§æ€§èƒ½ã€‚

ğŸŸ¡ **é€‚ç”¨äºï¼šè€æ—§æ“ä½œç³»ç»Ÿï¼ˆå¦‚ Windows XP/2003ï¼‰ã€å…¼å®¹æ€§ä¼˜å…ˆçš„ç¯å¢ƒ**

**3. Realtek RTL8139ï¼ˆâš ï¸ æè€ï¼Œå‡ ä¹ä¸æ¨èï¼‰**

- **ä¼˜ç‚¹**ï¼š

  - å…¼å®¹æ€§å¥½ï¼Œé€‚ç”¨äºä¸€äº›**æè€çš„æ“ä½œç³»ç»Ÿ**ï¼ˆå¦‚ Windows 98ï¼‰ã€‚

- **ç¼ºç‚¹**ï¼š
  - **æ€§èƒ½æœ€å·®**ï¼Œå¸¦å®½ **100Mbps**ï¼Œå®Œå…¨è·Ÿä¸ä¸Šç°ä»£ç½‘ç»œéœ€æ±‚ã€‚
  - é«˜ CPU è´Ÿè½½ï¼Œä¸é€‚åˆç”Ÿäº§ç¯å¢ƒã€‚

âŒ **ä¸æ¨èï¼Œé™¤éä½ è¦è¿è¡Œ Windows 98 è¿™ç±»è€ç³»ç»Ÿã€‚**

**4. VMware vmxnet3ï¼ˆğŸŸ¡ é€‚ç”¨äº VMware å…¼å®¹ç¯å¢ƒï¼‰**

- **ä¼˜ç‚¹**ï¼š

  - **é€‚åˆä» VMware è¿ç§»çš„è™šæ‹Ÿæœº**ï¼Œå¯æ— ç¼å…¼å®¹ VMware ç¯å¢ƒã€‚
  - ä½ CPU å¼€é”€ï¼Œæ€§èƒ½æ¯” Intel E1000 å¥½ã€‚

- **ç¼ºç‚¹**ï¼š
  - éœ€è¦å®‰è£… **VMware Tools** æ‰èƒ½æ­£å¸¸å·¥ä½œï¼Œå¦åˆ™æ€§èƒ½ä½ä¸‹ã€‚
  - å¦‚æœä¸æ˜¯ä» VMware è¿ç§»è¿‡æ¥çš„ VMï¼Œ**VirtIO ä»ç„¶æ˜¯æ›´å¥½çš„é€‰æ‹©**ã€‚

ğŸŸ¡ **é€‚ç”¨äºï¼šä» VMware è¿ç§»è¿‡æ¥çš„è™šæ‹Ÿæœº**

**æ€»ç»“**

| **é€‰é¡¹**               | **æ€§èƒ½**    | **å…¼å®¹æ€§**                             | **é€‚ç”¨åœºæ™¯**                                | **æ¨èåº¦** |
| ---------------------- | ----------- | -------------------------------------- | ------------------------------------------- | ---------- |
| **VirtIOï¼ˆåŠè™šæ‹ŸåŒ–ï¼‰** | **âœ… æœ€ä½³** | éœ€è¦é©±åŠ¨ï¼ˆLinux è‡ªå¸¦ï¼ŒWindows éœ€å®‰è£…ï¼‰ | ç°ä»£ Linuxã€Windowsï¼ˆå®‰è£…é©±åŠ¨ï¼‰ã€é«˜åååº”ç”¨ | â­â­â­â­â­ |
| **Intel E1000/E1000E** | ğŸŸ¡ ä¸€èˆ¬     | **æ— éœ€é©±åŠ¨**                           | è€æ—§ Windows/Linux å…¼å®¹æ€§ä¼˜å…ˆ               | â­â­â­     |
| **Realtek RTL8139**    | âŒ æœ€å·®     | **æ— éœ€é©±åŠ¨**                           | **æè€ç³»ç»Ÿï¼ˆWindows 98/2000ï¼‰**             | â­         |
| **VMware vmxnet3**     | ğŸŸ¡ è¾ƒå¥½     | éœ€è¦ VMware Tools                      | ä» VMware è¿ç§»çš„ VM                         | â­â­â­     |

**æ¨è**

- **Linuxï¼ˆUbuntuã€Debianã€CentOSï¼‰â†’ é€‰ VirtIO**
- **Windowsï¼ˆ10/11/Serverï¼‰â†’ é€‰ VirtIOï¼ˆå®‰è£… VirtIO é©±åŠ¨ï¼‰**
- **Windows XP/2003 â†’ é€‰ Intel E1000**
- **VMware è¿ç§»è¿‡æ¥çš„ VM â†’ é€‰ vmxnet3**

**âœ… æœ€ç»ˆå»ºè®®ï¼šå¦‚æœæ˜¯ Linux æˆ–ç°ä»£ Windowsï¼Œ**è¯·ä½¿ç”¨ **VirtIOï¼ˆåŠè™šæ‹ŸåŒ–ï¼‰**ï¼Œå®ƒçš„æ€§èƒ½æœ€ä½³ã€‚

---

### å¼€å¯ SSH ç™»å½•

1. å®‰è£… openssh-server

   ```bash
   sudo apt install openssh-server
   ```

2. å®‰è£…å®Œæˆåï¼ŒSSH æœåŠ¡é»˜è®¤è‡ªåŠ¨å¯åŠ¨ï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ ¡éªŒæœåŠ¡è¿è¡ŒçŠ¶æ€ï¼š

   ```bash
   sudo systemctl status ssh
   ```

3. å¦‚æœä½ å¯ç”¨äº†é˜²ç«å¢™ï¼Œè¯·ç¡®ä¿é˜²ç«å¢™æ‰“å¼€äº† SSH ç«¯å£ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š

   ```bash
   sudo ufw allow ssh
   ```

4. å…è®¸è¿œç¨‹ç™»å½•

   ```bash
   sudo nano /etc/ssh/sshd_config
   # ä¿®æ”¹é…ç½®
   PubkeyAuthentication yes
   ```

5. é‡å¯ ssh æœåŠ¡

   ```bash
   service ssh restart
   ```

### å¼€å¯è¿œç¨‹æ¡Œé¢

å› ä¸ºé€šè¿‡ PVE æ§åˆ¶å°é“¾æ¥ Ubuntu å, è¿›å…¥è®¾ç½®é¡µé¢æ‰“å¼€è¿œç¨‹æ¡Œé¢è€æ˜¯å¡æ­», æ‰€ä»¥ç›´æ¥é€šè¿‡å‘½ä»¤è¡Œæ“ä½œ.

```bash
sudo apt update && sudo apt install xrdp -y && sudo systemctl enable --now xrdp
```

### å®‰è£… docker

> æ‰§è¡Œå‰å…ˆå¼€å¯ä»£ç†

```bash
apt remove -y docker docker-engine docker.io containerd runc || echo "Docker components may not be installed, skipping removal" \
  && apt update \
  && apt install -y gpg \
  && mkdir -p /etc/apt/keyrings \
  && curl -fsSL https://download.docker.com/linux/ubuntu/gpg | tee /etc/apt/keyrings/docker.asc > /dev/null \
  && chmod a+r /etc/apt/keyrings/docker.asc \
  && gpg --dearmor -o /etc/apt/keyrings/docker.gpg /etc/apt/keyrings/docker.asc \
  && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null \
  && apt update \
  && apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

#### docker é•œåƒæº

```bash
# å°†å†…å®¹å†™å…¥ /etc/docker/daemon.json æ–‡ä»¶ï¼Œroot ç”¨æˆ·å¯ä»¥å»æ‰ sudo
# é…ç½® Docker é•œåƒï¼Œä½¿ç”¨å¤šä¸ªé•œåƒæºæ¥æé«˜é•œåƒä¸‹è½½é€Ÿåº¦
echo '{
  "registry-mirrors": [
    "https://docker.1ms.run",
    "https://proxy.1panel.live",
    "https://docker.ketches.cn"
  ]
}' | sudo tee /etc/docker/daemon.json
# é‡å¯ Docker æœåŠ¡ä»¥ä½¿é…ç½®ç”Ÿæ•ˆ
sudo systemctl restart docker
```

### ä¿®æ”¹æ—¶åŒº

```bash
timedatectl set-timezone Asia/Shanghai
```

### ç»ˆç«¯æ”¯æŒä¸­æ–‡æ˜¾ç¤º

```bash
apt update && apt install -y language-pack-zh-hans && localectl set-locale LANG=zh_CN.UTF-8 && source /etc/default/locale
```

### ç›´é€š nvme

å› ä¸ºåŒå“ç‰Œ nvme å›ºæ€ç¡¬ç›˜åœ¨ PVE WebUI çš„ç¡¬ä»¶åˆ—è¡¨ä¸­æ— æ³•åŒºåˆ†, æ‰€ä»¥éœ€è¦åœ¨å‘½ä»¤è¡Œåœ¨æ‰¾åˆ°å…·ä½“çš„ PCI ID æ‰èƒ½ç›´é€šç»™è™šæ‹Ÿæœº, é¿å…é”™è¯¯çš„å°†å®‰è£…äº† PVE ç³»ç»Ÿçš„ nvem åˆ†é…ç»™è™šæ‹Ÿæœºå¯¼è‡´ PVE å´©æºƒ.

```bash
# æŸ¥çœ‹ nvme çš„ PCI åˆ—è¡¨
$ lspci | grep -i nvme

01:00.0 Non-Volatile memory controller: Yangtze Memory Technologies Co.,Ltd ZHITAI TiPro5000 NVMe SSD (rev 01)
81:00.0 Non-Volatile memory controller: Yangtze Memory Technologies Co.,Ltd ZHITAI TiPro5000 NVMe SSD (rev 01)

# æŸ¥çœ‹ç³»ç»Ÿå®‰è£…åœ¨å“ªå—ç›˜
$ lsblk -o NAME,MAJ:MIN,RM,TYPE,SIZE,MOUNTPOINT,UUID

NAME                         MAJ:MIN RM TYPE   SIZE MOUNTPOINT UUID
nvme0n1                      259:0    0 disk 953.9G
â””â”€nvme0n1p1                  259:2    0 part 953.9G            1a8fd1dd-021a-4e59-bcde-d77502ecc0e7
nvme1n1                      259:1    0 disk 953.9G
â”œâ”€nvme1n1p1                  259:3    0 part  1007K
â”œâ”€nvme1n1p2                  259:4    0 part     1G /boot/efi  4773-0652
â””â”€nvme1n1p3                  259:5    0 part 952.9G            5v5ZMp-dJCX-EEep-rBgv-U5ry-q4E4-8vGhuC
  â”œâ”€pve-swap                 252:0    0 lvm      8G [SWAP]     ad3ef0fd-b31a-49a3-b72d-8a059358f99a
  â”œâ”€pve-root                 252:1    0 lvm     96G /          877cad13-9e68-4d5c-b4bf-fe92ffc241d8
  â”œâ”€pve-data_tmeta           252:2    0 lvm    8.3G
  â”‚ â””â”€pve-data-tpool         252:4    0 lvm  816.2G
  â”‚   â”œâ”€pve-data             252:5    0 lvm  816.2G
  â”‚   â””â”€pve-vm--102--disk--0 252:6    0 lvm     32G
  â””â”€pve-data_tdata           252:3    0 lvm  816.2G
    â””â”€pve-data-tpool         252:4    0 lvm  816.2G
      â”œâ”€pve-data             252:5    0 lvm  816.2G
      â””â”€pve-vm--102--disk--0 252:6    0 lvm     32G
```

ä¸Šé¢çš„è¾“å‡ºå¾—çŸ¥ PVE å®‰è£…åœ¨ **nvme1n1**, å› æ­¤ **nvme0n1** å°±æ˜¯åº”è¯¥ç›´é€šç»™è™šæ‹Ÿæœºçš„ç›˜, è®©æˆ‘ä»¬æ‰¾å‡ºå®ƒçš„ PCI ID:

```bash
$ udevadm info -q path -n /dev/nvme0n1 | grep -oP '\d+:\d+\.\d+'

00:01.0
01:00.0
```

æ‰¾åˆ°äº†: **01:00.0**.

> æˆ–è€…è¿™æ ·ä¹Ÿè¡Œ:
>
> ```bash
> $ cd /sys/block/nvme0n1/device && ls -al
>
> ...
> lrwxrwxrwx  1 root root    0 Feb 19 17:23 device -> ../../../0000:01:00.0
> ...
> ```

### LVM æ‰©å®¹

åˆšå¼€å§‹åªç»™äº† 32G ç£ç›˜, åé¢å…‰å®‰è£…æ˜¾å¡é©±åŠ¨å°±ä¸å¤Ÿç”¨äº†, æ‰€ä»¥åœ¨ PVE æ§åˆ¶å¤©æ–°æ·»åŠ äº† 100G ç©ºé—´ç»™ Ubuntu:

```bash
âœ  ~ lsblk
NAME                      MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
loop0                       7:0    0  73.9M  1 loop /snap/core22/1748
loop1                       7:1    0  44.4M  1 loop /snap/snapd/23545
sda                         8:0    0    32G  0 disk
â”œâ”€sda1                      8:1    0     1M  0 part
â”œâ”€sda2                      8:2    0     2G  0 part /boot
â””â”€sda3                      8:3    0    30G  0 part
  â”œâ”€ubuntu--vg-ubuntu--lv 252:0    0    15G  0 lvm  /
  â””â”€ubuntu--vg-lv--0      252:1    0    15G  0 lvm  /home
sdb                         8:16   0   100G  0 disk
sr0                        11:0    1   2.6G  0 rom
nvme0n1                   259:0    0 953.9G  0 disk
â””â”€nvme0n1p1               259:1    0 953.9G  0 part
```

å…¶ä¸­ **sdb** æ˜¯æ–°å¢çš„ç£ç›˜, éœ€è¦å°†è¿™ 100G ç©ºé—´æ·»åŠ åˆ°æ ¹åˆ†åŒºä¸­:

```bash
# å°† sdb æ·»åŠ ä¸ºä¸€ä¸ªç‰©ç†å·ï¼ˆPVï¼‰ï¼š
sudo pvcreate /dev/sdb
# å°†æ–°åˆ›å»ºçš„ç‰©ç†å·æ·»åŠ åˆ°ç°æœ‰çš„å·ç»„ä¸­
sudo vgextend ubuntu-vg /dev/sdb
# æ‰©å±•çš„æ˜¯æ ¹åˆ†åŒºï¼ˆ/dev/ubuntu-vg/ubuntu-lvï¼‰
sudo lvextend -l +100%FREE /dev/ubuntu-vg/ubuntu-lv
# æ‰©å±•å®Œé€»è¾‘å·åï¼Œéœ€è¦æ‰©å±•æ–‡ä»¶ç³»ç»Ÿï¼Œä½¿å…¶èƒ½å¤Ÿä½¿ç”¨æ–°çš„ç©ºé—´(ext4 æ–‡ä»¶ç³»ç»Ÿ)
sudo resize2fs /dev/ubuntu-vg/ubuntu-lv
# xfs æ–‡ä»¶ç³»ç»Ÿ
# sudo xfs_growfs /dev/ubuntu-vg/ubuntu-lv
# æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦æˆåŠŸæ‰©å±•
df -h
```

**å‚è€ƒ**:

- [PVE ç³»åˆ—æ•™ç¨‹(äºŒåäºŒ)ã€å®‰è£… Ubuntu24.04(æ¡Œé¢ç‰ˆ)](http://www.huerpu.cc:7000/?p=729)
- [ç©è½¬ AIGCï¼šæ‰“é€ æœ¬åœ° AI å¤§æ¨¡å‹åœ°åŸºï¼ŒPVE åˆ¶ä½œ Ubuntu 24.04 LTS æ¨¡æ¿](https://juejin.cn/post/7365764222838210598)

---

## ç£ç›˜å…±äº«

### æµ‹è¯• NVMe è¯»å†™é€Ÿåº¦

å¯ä»¥ä½¿ç”¨ **fioã€ddã€nvme-cli** ç­‰å·¥å…·ï¼Œä¸‹é¢æ˜¯å…·ä½“çš„æ¨èåŠä½¿ç”¨æ–¹æ³•ï¼š

**ğŸ”¥ æ¨èå·¥å…· 1ï¼šfioï¼ˆæœ€ä½³é€‰æ‹©ï¼Œé€‚ç”¨äºçœŸå®è´Ÿè½½ï¼‰**

**fio** æ˜¯ä¸“ä¸šçš„å­˜å‚¨æµ‹è¯•å·¥å…·ï¼Œå¯ä»¥æ¨¡æ‹Ÿå¤šçº¿ç¨‹ã€é«˜å¹¶å‘è¯»å†™ï¼Œé€‚åˆè¯„ä¼° NVMe çš„çœŸå®æ€§èƒ½ã€‚

**1ï¸âƒ£ å®‰è£… fio**

```
sudo apt update && sudo apt install fio -y
```

**2ï¸âƒ£ æµ‹è¯• NVMe é¡ºåºå†™ï¼ˆæœ€å¤§å†™å…¥é€Ÿåº¦ï¼‰**

```
fio --name=write_test --filename=/mnt/nvme/testfile --size=10G --rw=write --bs=1M --numjobs=4 --ioengine=libaio --direct=1
```

- bs=1Mï¼ˆå—å¤§å° 1MBï¼‰
- numjobs=4ï¼ˆ4 çº¿ç¨‹å¹¶å‘ï¼‰
- direct=1ï¼ˆç»•è¿‡ç³»ç»Ÿç¼“å­˜ï¼‰
- rw=writeï¼ˆé¡ºåºå†™ï¼‰

**é¢„æœŸç»“æœ**

```
WRITE: bw=3000MiB/s, iops=3000, runt=3000ms
```

**NVMe Gen3 x4**ï¼šå†™å…¥ 2.5GB/s ~ 3.2GB/s

**NVMe Gen4 x4**ï¼šå†™å…¥ 4GB/s ~ 7GB/s

**3ï¸âƒ£ æµ‹è¯• NVMe é¡ºåºè¯»å–ï¼ˆæœ€å¤§è¯»å–é€Ÿåº¦ï¼‰**

```
fio --name=read_test --filename=/mnt/nvme/testfile --size=10G --rw=read --bs=1M --numjobs=4 --ioengine=libaio --direct=1
```

- rw=readï¼ˆé¡ºåºè¯»å–ï¼‰

**é¢„æœŸç»“æœ**

```
READ: bw=3500MiB/s, iops=3500, runt=3000ms
```

è¯»å–é€Ÿåº¦ä¸€èˆ¬é«˜äºå†™å…¥é€Ÿåº¦ã€‚

**4ï¸âƒ£ æµ‹è¯• NVMe éšæœº 4K è¯»å†™ï¼ˆI/O æ€§èƒ½ï¼‰**

```
fio --name=random_test --filename=/mnt/nvme/testfile --size=10G --rw=randrw --bs=4K --numjobs=4 --iodepth=32 --ioengine=libaio --direct=1 --rwmixread=70
```

- rw=randrwï¼ˆéšæœºè¯»å†™ï¼‰
- bs=4Kï¼ˆ4KB å—å¤§å°ï¼‰
- iodepth=32ï¼ˆæ·±åº¦ 32ï¼‰
- rwmixread=70ï¼ˆ70% è¯»ï¼Œ30% å†™ï¼‰

**éšæœºè¯»å†™ä¸»è¦çœ‹ IOPS**ï¼Œé«˜ç«¯ NVMe å¯èƒ½è¾¾åˆ° **500K IOPS+**ã€‚

**ğŸ”¹ æ¨èå·¥å…· 2ï¼šddï¼ˆå¿«é€Ÿæµ‹è¯•ï¼‰**

dd å¯ä»¥ç”¨äºç®€å•çš„è¯»å†™æµ‹è¯•ï¼Œä½†ä¸èƒ½å‡†ç¡®åæ˜ çœŸå® NVMe æ€§èƒ½ã€‚

**1ï¸âƒ£ é¡ºåºå†™**

```
dd if=/dev/zero of=/mnt/nvme/testfile bs=1G count=10 oflag=direct
```

**è¾“å‡ºç¤ºä¾‹**

```
10+0 records in
10+0 records out
10737418240 bytes (10 GB) copied, 3.42 s, 3.1 GB/s
```

**NVMe Gen3 x4**ï¼š2.5GB/s ~ 3.5GB/s

**NVMe Gen4 x4**ï¼š5GB/s ~ 7GB/s

**2ï¸âƒ£ é¡ºåºè¯»**

```
dd if=/mnt/nvme/testfile of=/dev/null bs=1G count=10 iflag=direct
```

è¯»å–é€Ÿåº¦é€šå¸¸æ¯”å†™å…¥æ›´å¿«ã€‚

**ğŸ”¹ æ¨èå·¥å…· 3ï¼šnvme-cliï¼ˆæŸ¥çœ‹é©±åŠ¨å’Œç¡¬ä»¶ä¿¡æ¯ï¼‰**

```
sudo apt install nvme-cli -y
nvme list
```

**å¯ä»¥æŸ¥çœ‹ NVMe å‹å·ã€åè®®ã€æ¥å£é€Ÿåº¦**

```
nvme smart-log /dev/nvme0n1
```

**æŸ¥çœ‹ NVMe çš„å¯¿å‘½ã€æ¸©åº¦ã€é”™è¯¯ç»Ÿè®¡**

**ğŸ¯ ç»“è®º**

| **æµ‹è¯•æ–¹å¼** | **ä¼˜ç‚¹**                   | **é€‚ç”¨åœºæ™¯**                 |
| ------------ | -------------------------- | ---------------------------- |
| fio          | ä¸“ä¸šçº§ï¼Œæ”¯æŒå¤šçº¿ç¨‹ã€é«˜å¹¶å‘ | **æœ€ç²¾å‡†çš„ NVMe æµ‹è¯•**       |
| dd           | ç®€å•æ˜“ç”¨ï¼Œé€‚åˆå¿«é€Ÿæµ‹è¯•     | **å¿«é€Ÿæµ‹è¯•é¡ºåºè¯»å†™**         |
| nvme-cli     | é€‚ç”¨äº NVMe è®¾å¤‡ç®¡ç†       | **æŸ¥çœ‹ NVMe ä¿¡æ¯å’Œå¥åº·çŠ¶æ€** |

---

### Ceph èŠ‚ç‚¹ç®€ä»‹

- Ceph MONï¼šCeph ç›‘è§†å™¨ï¼ˆ**Mon**itorï¼‰ï¼Œè´Ÿè´£ç»´æŠ¤é›†ç¾¤çŠ¶æ€æ˜ å°„ï¼Œå¸®åŠ©åè°ƒ Ceph å®ˆæŠ¤è¿›ç¨‹ï¼Œå¹¶è´Ÿè´£ç®¡ç†å®ˆæŠ¤è¿›ç¨‹ä¸å®¢æˆ·ç«¯ä¹‹é—´çš„èº«ä»½éªŒè¯ã€‚é€šå¸¸éœ€è¦è‡³å°‘ä¸‰ä¸ª MON èŠ‚ç‚¹ã€‚
- Ceph MGRï¼šCeph ç®¡ç†å™¨å®ˆæŠ¤è¿›ç¨‹ï¼ˆ**M**ana**g**e**r** Daemonï¼‰ï¼Œè´Ÿè´£è·Ÿè¸ªè¿è¡Œæ—¶æŒ‡æ ‡å’Œ Ceph å½“å‰è¿è¡ŒçŠ¶æ€ï¼Œå¹¶è´Ÿè´£ç®¡ç†å’Œå…¬å¼€ Ceph é›†ç¾¤ä¿¡æ¯ã€‚é€šå¸¸éœ€è¦è‡³å°‘ä¸¤ä¸ª MAN èŠ‚ç‚¹ã€‚
- Ceph OSDï¼šCeph å¯¹è±¡å­˜å‚¨å®ˆæŠ¤è¿›ç¨‹ï¼ˆ**O**bject **S**torage **D**aemonï¼‰ï¼Œè´Ÿè´£å­˜å‚¨æ•°æ®ã€å¤„ç†æ•°æ®å¤åˆ¶ã€æ¢å¤ã€é‡æ–°å¹³è¡¡ï¼Œå¹¶é€šè¿‡æ£€æŸ¥å…¶ä»– OSD å¿ƒè·³å‘ Ceph ç›‘è§†å™¨å’Œç®¡ç†å™¨æä¾›ç›‘è§†ä¿¡æ¯ã€‚é€šå¸¸éœ€è¦è‡³å°‘ä¸‰ä¸ª OSD èŠ‚ç‚¹ã€‚
- Ceph MDSï¼šCeph å…ƒæ•°æ®æœåŠ¡å™¨ï¼ˆ**M**eta**d**ata **S**erverï¼‰ï¼Œè´Ÿè´£å­˜å‚¨å…ƒæ•°æ®ï¼Œå¹¶å…è®¸ CephFS ç”¨æˆ·è¿è¡ŒåŸºæœ¬å‘½ä»¤ï¼Œè€Œä¸ä¸º Ceph å­˜å‚¨é›†ç¾¤å¸¦æ¥è´Ÿæ‹…ã€‚

#### æ—¶é—´åŒæ­¥

```bash
apt install chrony -y && systemctl enable chronyd && systemctl start chronyd
```

ä¿®æ”¹ NTP æœåŠ¡å™¨åœ°å€:

`/etc/chrony/chrony.conf`

```bash
server ntp.aliyun.com minpoll 4 maxpoll 10 iburst
server ntp1.aliyun.com minpoll 4 maxpoll 10 iburst
server ntp2.aliyun.com minpoll 4 maxpoll 10 iburst
server ntp3.aliyun.com minpoll 4 maxpoll 10 iburst
server ntp4.aliyun.com minpoll 4 maxpoll 10 iburst
server ntp5.aliyun.com minpoll 4 maxpoll 10 iburst
server ntp6.aliyun.com minpoll 4 maxpoll 10 iburst
server ntp7.aliyun.com minpoll 4 maxpoll 10 iburst
# å…è®¸NTPå®¢æˆ·åŒæ­¥ ip æ®µ  NTPåŒæ­¥æ—¶éœ€è¦é…ç½®
allow 192.168.0.0/16
```

```bash
systemctl restart chronyd.service

# æ‰‹åŠ¨åŒæ­¥
chronyc makestep
# æŸ¥çœ‹æœ¬æœºæ—¶é—´åŒæ­¥çŠ¶æ€
chronyc tracking
# æŸ¥çœ‹æ—¶é—´åŒæ­¥æœåŠ¡å™¨åˆ—è¡¨
chronyc -n sources -v
```

**å‚è€ƒ**

- [ç®¡ç†æ—¶é—´åŒæ­¥æœåŠ¡](https://help.aliyun.com/zh/ecs/user-guide/alibaba-cloud-ntp-server)

### å®‰è£… Ceph

ç›´æ¥åœ¨ PVE Web ç«¯å®‰è£…, ä½†æ˜¯å®‰è£…åæŠ¥é”™:

```
rados_connect failed - No such file or directory (500)
```

åŸå› æ˜¯ MON èŠ‚ç‚¹å¯åŠ¨å¤±è´¥, ä½†æ˜¯åœ¨ Web ç«¯æœ‰æ²¡æœ‰ MON èŠ‚ç‚¹æ˜¾ç¤º, åˆ›å»ºçš„æ—¶å€™æŠ¥é”™:

```
Multiple IPs for ceph public network '192.168.31.99/24' detected on nuc: 192.168.31.99 192.168.31.9 use 'mon-address' to specify one of them. (500)
```

æ‰€ä»¥ç›´æ¥ä½¿ç”¨å‘½ä»¤è¡Œæ¥å¤„ç†:

```bash
# NUC èŠ‚ç‚¹
pveceph mon create --mon-address 192.168.31.99
# Station èŠ‚ç‚¹
pveceph mon create --mon-address 192.168.31.66
```

### é…ç½® Ceph

NUC èŠ‚ç‚¹ä¸Šçš„ nvme:

```bash
$ lsblk
NAME                         MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
nvme3n1                      259:0    0 953.9G  0 disk
nvme2n1                      259:1    0 953.9G  0 disk
nvme1n1                      259:2    0 931.5G  0 disk
â”œâ”€nvme1n1p1                  259:3    0  1007K  0 part
â”œâ”€nvme1n1p2                  259:4    0     1G  0 part /boot/efi
â””â”€nvme1n1p3                  259:5    0 930.5G  0 part
  â”œâ”€pve-swap                 252:0    0     8G  0 lvm  [SWAP]
  â”œâ”€pve-root                 252:1    0    96G  0 lvm  /
  â”œâ”€pve-data_tmeta           252:2    0   8.1G  0 lvm
  â”‚ â””â”€pve-data-tpool         252:4    0 794.3G  0 lvm
  â”‚   â”œâ”€pve-data             252:5    0 794.3G  1 lvm
  â”‚   â”œâ”€pve-vm--100--disk--0 252:6    0     4M  0 lvm
  â”‚   â”œâ”€pve-vm--100--disk--1 252:7    0   200G  0 lvm
  â”‚   â”œâ”€pve-vm--100--disk--2 252:8    0     4M  0 lvm
  â”‚   â””â”€pve-vm--103--disk--0 252:9    0   128G  0 lvm
  â””â”€pve-data_tdata           252:3    0 794.3G  0 lvm
    â””â”€pve-data-tpool         252:4    0 794.3G  0 lvm
      â”œâ”€pve-data             252:5    0 794.3G  1 lvm
      â”œâ”€pve-vm--100--disk--0 252:6    0     4M  0 lvm
      â”œâ”€pve-vm--100--disk--1 252:7    0   200G  0 lvm
      â”œâ”€pve-vm--100--disk--2 252:8    0     4M  0 lvm
      â””â”€pve-vm--103--disk--0 252:9    0   128G  0 lvm
nvme0n1                      259:6    0 931.5G  0 disk
```

æ‰€ä»¥æœ‰ `nvme0n1`, `nvme2n1` å’Œ `nvme3n1` å¯ä»¥ä½¿ç”¨, Station ä¸Šçš„ nvme:

```bash
$ lsblk
NAME                         MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
nvme0n1                      259:0    0 953.9G  0 disk
â”œâ”€nvme0n1p1                  259:1    0  1007K  0 part
â”œâ”€nvme0n1p2                  259:2    0     1G  0 part /boot/efi
â””â”€nvme0n1p3                  259:3    0 952.9G  0 part
  â”œâ”€pve-swap                 252:0    0     8G  0 lvm  [SWAP]
  â”œâ”€pve-root                 252:1    0    96G  0 lvm  /
  â”œâ”€pve-data_tmeta           252:2    0   8.3G  0 lvm
  â”‚ â””â”€pve-data-tpool         252:4    0 816.2G  0 lvm
  â”‚   â”œâ”€pve-data             252:5    0 816.2G  1 lvm
  â”‚   â”œâ”€pve-vm--102--disk--0 252:6    0    32G  0 lvm
  â”‚   â””â”€pve-vm--102--disk--1 252:7    0   100G  0 lvm
  â””â”€pve-data_tdata           252:3    0 816.2G  0 lvm
    â””â”€pve-data-tpool         252:4    0 816.2G  0 lvm
      â”œâ”€pve-data             252:5    0 816.2G  1 lvm
      â”œâ”€pve-vm--102--disk--0 252:6    0    32G  0 lvm
      â””â”€pve-vm--102--disk--1 252:7    0   100G  0 lvm
```

ä¸Šé¢æ˜¯ PVE ç³»ç»Ÿç›˜, å¦ä¸€å—ç›´é€šç»™ Ubuntu ä½¿ç”¨äº†, æ‰€ä»¥æ²¡æœ‰æ˜¾ç¤ºå‡ºæ¥, è¿™ä¸ªåœ¨æ•°æ®è¿ç§»å®Œæˆåå†å¤„ç†, æˆ‘ä»¬å…ˆå°† NUC èŠ‚ç‚¹çš„ 3 å— nvme æ·»åŠ åˆ° OSD.

è¿™é‡Œå°†æ¯å— NVMe ç›˜æ‹†åˆ†ä¸º 4 ä¸ªåˆ†åŒºï¼Œç„¶å å°†è¿™äº›åˆ†åŒºåˆ†åˆ«æ·»åŠ ä¸ºç‹¬ç«‹çš„ OSDã€‚è¿™æ ·å¯ä»¥è®© Ceph æ›´åŠ  é«˜æ•ˆåˆ©ç”¨ NVMe èµ„æºï¼ŒåŒæ—¶ å‡å°‘ IO é˜»å¡ï¼Œæé«˜å¹¶å‘æ€§èƒ½ã€‚

```bash
for disk in /dev/nvme0n1 /dev/nvme2n1 /dev/nvme3n1; do
  parted --script $disk mklabel gpt
  parted --script $disk mkpart primary 0% 25%
  parted --script $disk mkpart primary 25% 50%
  parted --script $disk mkpart primary 50% 75%
  parted --script $disk mkpart primary 75% 100%
done
```

```bash
$ lsblk
NAME                         MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
nvme3n1                      259:0    0 953.9G  0 disk
â”œâ”€nvme3n1p1                  259:11   0 238.5G  0 part
â”œâ”€nvme3n1p2                  259:16   0 238.5G  0 part
â”œâ”€nvme3n1p3                  259:21   0 238.5G  0 part
â””â”€nvme3n1p4                  259:22   0 238.5G  0 part
nvme2n1                      259:1    0 953.9G  0 disk
â”œâ”€nvme2n1p1                  259:12   0 238.5G  0 part
â”œâ”€nvme2n1p2                  259:13   0 238.5G  0 part
â”œâ”€nvme2n1p3                  259:17   0 238.5G  0 part
â””â”€nvme2n1p4                  259:18   0 238.5G  0 part
nvme1n1                      259:2    0 931.5G  0 disk
â”œâ”€nvme1n1p1                  259:3    0  1007K  0 part
â”œâ”€nvme1n1p2                  259:4    0     1G  0 part /boot/efi
â””â”€nvme1n1p3                  259:5    0 930.5G  0 part
  â””â”€ ...
nvme0n1                      259:6    0 931.5G  0 disk
â”œâ”€nvme0n1p1                  259:8    0 232.9G  0 part
â”œâ”€nvme0n1p2                  259:9    0 232.9G  0 part
â”œâ”€nvme0n1p3                  259:10   0 232.9G  0 part
â””â”€nvme0n1p4                  259:14   0 232.9G  0 part
```

**ä½¿ç”¨ pveceph osd create å‘½ä»¤ï¼Œå°†è¿™äº›åˆ†åŒºä½œä¸º OSDï¼š**

```bash
$ for part in {1..4}; do
  pveceph osd create /dev/nvme0n1p$part
  pveceph osd create /dev/nvme2n1p$part
  pveceph osd create /dev/nvme3n1p$part
done
```

**æ£€æŸ¥ç»“æœ**

```bash
$ ceph osd tree
ID  CLASS  WEIGHT   TYPE NAME       STATUS  REWEIGHT  PRI-AFF
-1         2.77271  root default
-3         2.77271      host nuc
 0    ssd  0.22739          osd.0       up   1.00000  1.00000
 1    ssd  0.23289          osd.1       up   1.00000  1.00000
 2    ssd  0.23289          osd.2       up   1.00000  1.00000
 3    ssd  0.22739          osd.3       up   1.00000  1.00000
 4    ssd  0.23289          osd.4       up   1.00000  1.00000
 5    ssd  0.23289          osd.5       up   1.00000  1.00000
 6    ssd  0.22739          osd.6       up   1.00000  1.00000
 7    ssd  0.23289          osd.7       up   1.00000  1.00000
 8    ssd  0.23289          osd.8       up   1.00000  1.00000
 9    ssd  0.22739          osd.9       up   1.00000  1.00000
10    ssd  0.23289          osd.10      up   1.00000  1.00000
11    ssd  0.23289          osd.11      up   1.00000  1.00000
```

æ¥ä¸‹æ¥è¿˜éœ€è¦é…ç½®å­˜å‚¨æ± , å¹¶å°†å­˜å‚¨æ± æ·»åŠ åˆ° RBD å’Œ CephFS.

### ä½¿ç”¨

#### åœ¨ PVE è™šæ‹Ÿæœºä¸­æŒ‚è½½ CephFS

1. åˆ›å»º CephFSï¼š

   ```javascript
   ceph fs new cephfs cephfs_metadata cephfs_data
   ```

2. æ·»åŠ åˆ° PVE Web UI ä¸­çš„ CephFSï¼š

3. åœ¨ VM æˆ– LXC ä¸­æŒ‚è½½ CephFSï¼š

   ```bash
   mkdir /mnt/cephfs
   mount -t ceph 192.168.31.99:6789:/ /mnt/cephfs -o name=admin,secret=<ceph-secret>
   ```

#### åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨ RBDï¼ˆå—å­˜å‚¨ï¼‰

1. æŸ¥çœ‹ Ceph å­˜å‚¨æ± ï¼š

   ```bash
   rbd pool ls
   ```

2. åˆ›å»º RBDï¼š

   ```sql
   rbd create --size 10G vm_storage/test-disk
   ```

3. åœ¨ VM å†…éƒ¨æ˜ å°„ RBD ç£ç›˜å¹¶è¿›è¡ŒåŸºæœ¬è®¾ç½®ï¼š

   ```bash
   rbd map vm_storage/test-disk --name client.admin
   mkfs.ext4 /dev/rbd0
   mount /dev/rbd0 /mnt
   ```

**å‚è€ƒ**:

- [éƒ¨ç½²è¶…èåˆ Ceph é›†ç¾¤](https://pve-doc-cn.readthedocs.io/zh-cn/latest/chapter_pveceph/index.html)

- [Proxmox VE + Ceph è¶…èåˆé›†ç¾¤éƒ¨ç½²å®å½•](https://macesuted.moe/article/hyper-convergence)
- [proxmox+ceph é›†ç¾¤å®Œæ•´æ–¹æ¡ˆ/å®Œæ•´æ–¹æ¡ˆ](https://zhuanlan.zhihu.com/p/617024637)

> PVE ä¸Šä½¿ç”¨ Ceph çš„æƒ³æ³•ç®—äº†æ€»ç»“äº†, å¤ªå¤æ‚äº†, ç°åœ¨ 12 ä¸ª OSD è·‘äº†ä¸€æ™šä¸Šæ•°æ®è¿˜æ²¡æœ‰åŒæ­¥å®Œæˆ, æ‰€ä»¥æ‰“ç®—ç©ç© ZFS, å®¶ç”¨åº”è¯¥ä¹Ÿå¤Ÿäº†.
>
> [For Best Performance - Proxmox Cluster with CEPH or ZFS?](https://forum.proxmox.com/threads/for-best-performance-proxmox-cluster-with-ceph-or-zfs.129635/)

---

### Dashboard

```bash
apt install ceph-mgr-dashboard (on all service manager nodes)
ceph mgr module enable dashboard

# generate new pw and paste it in the dashboard-pw file
cd /etc/ceph
vim dashboard-pw
chmod 600 /etc/ceph/dashboard-pw

# ceph dashboard ac-user-create <user> -i <pw file> <role>
ceph dashboard set-login-credentials username -i dashboard
ceph config-key set mgr/dashboard/server_addr ::

# generate certificate
openssl req -newkey rsa:4096 -nodes -x509 \
-keyout /etc/ceph/dashboard-key.pem -out /etc/ceph/dashboard-crt.pem -sha512 \
-days 3650 -subj "/CN=IT/O=ceph-mgr-dashboard" -utf8

ceph config-key set mgr/dashboard/key -i /etc/ceph/dashboard-key.pem
ceph config-key set mgr/dashboard/crt -i /etc/ceph/dashboard-crt.pem

ceph mgr module disable dashboard
ceph mgr module enable dashboard
systemctl restart ceph-mgr@[servername].service

Afterwards, go to the dashboard URL: https://[IP or FQDN]:8443 or http://[IP or FQDN]:8080
```

**å‚è€ƒ**

- [ProxmoxVE å¯ç”¨ Ceph Dashboard ä»ªè¡¨ç›˜ï¼Œé…ç½® Object Getaway å¯¹è±¡ç½‘å…³](https://blog.csdn.net/qq_35485875/article/details/128906403)

### å¸è½½ Ceph ğŸ™‰

**1. åœæ­¢å¹¶ç¦ç”¨ Ceph æœåŠ¡**

é¦–å…ˆï¼Œç¡®ä¿åœæ­¢æ‰€æœ‰ä¸ Ceph ç›¸å…³çš„æœåŠ¡ï¼ŒåŒ…æ‹¬ **Monitorï¼ˆmonï¼‰**ã€**OSD**ã€**MDS**ã€**Managerï¼ˆmgrï¼‰** ç­‰ï¼š

```
systemctl stop ceph-mon.target
systemctl stop ceph-osd.target
systemctl stop ceph-mgr.target
systemctl stop ceph-mds.target
```

ç„¶åï¼Œç¦ç”¨è¿™äº›æœåŠ¡ï¼Œä»¥ç¡®ä¿å®ƒä»¬ä¸ä¼šåœ¨ç³»ç»Ÿé‡å¯åè‡ªåŠ¨å¯åŠ¨ï¼š

```
systemctl disable ceph-mon.target
systemctl disable ceph-osd.target
systemctl disable ceph-mgr.target
systemctl disable ceph-mds.target
```

**2. å¸è½½ Ceph è½¯ä»¶åŒ…**

å¸è½½æ‰€æœ‰ Ceph ç›¸å…³çš„åŒ…ï¼š

```
apt-get remove --purge ceph ceph-common ceph-mds ceph-mon ceph-osd ceph-mgr ceph-fuse librados2 librgw1 libcephfs1 librados-dev librgw-dev libboost-iostreams1.58.0 libboost-filesystem1.58.0 libboost-system1.58.0 librados2 librgw1
```

è¿™å°†åˆ é™¤æ‰€æœ‰ Ceph ç›¸å…³çš„è½¯ä»¶åŒ…åŠå…¶ä¾èµ–ã€‚

**3. åˆ é™¤ Ceph é…ç½®å’Œæ•°æ®**

åˆ é™¤ Ceph çš„é…ç½®æ–‡ä»¶å’Œæ•°æ®ç›®å½•ï¼š

```
rm -rf /etc/ceph
rm -rf /var/lib/ceph
rm -rf /var/log/ceph
```

è¿™äº›ç›®å½•åŒ…å«äº† Ceph çš„æ‰€æœ‰é…ç½®ã€æ—¥å¿—å’Œæ•°æ®æ–‡ä»¶ã€‚

**4. æ¸…ç† LVM å·å’Œ Ceph OSD æ•°æ®**

å¦‚æœæ‚¨ä½¿ç”¨äº† **LVM** æ¥ç®¡ç† Ceph OSDï¼Œç¡®ä¿åˆ é™¤æ‰€æœ‰çš„ LVM å·å’Œå·ç»„ã€‚é¦–å…ˆï¼ŒæŸ¥çœ‹å½“å‰çš„ LVM é…ç½®ï¼š

```
sudo lvdisplay
sudo vgdisplay
sudo pvdisplay
```

å¦‚æœå­˜åœ¨ Ceph ä½¿ç”¨çš„ **LVM é€»è¾‘å·**ï¼Œ**å·ç»„** æˆ– **ç‰©ç†å·**ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ é™¤å®ƒä»¬ï¼š

1. åˆ é™¤ LVM é€»è¾‘å·ï¼š

```
sudo lvremove /dev/ceph/<volume_group>/<logical_volume>
```

2. åˆ é™¤ LVM å·ç»„ï¼š

```
sudo vgremove <volume_group>
```

3. åˆ é™¤ç‰©ç†å·ï¼š

```
sudo pvremove /dev/<device>
```

4. åˆ é™¤ Ceph OSD è®¾å¤‡ï¼š

```
sudo wipefs -a /dev/<device>   # ç”¨å®é™…çš„è®¾å¤‡è·¯å¾„æ›¿æ¢ <device>
```

**5. åˆ é™¤ Ceph ç›¸å…³çš„ç³»ç»ŸæœåŠ¡æ–‡ä»¶**

æ¸…ç† Ceph æœåŠ¡æ–‡ä»¶ï¼Œç¡®ä¿æ²¡æœ‰æœåŠ¡æ–‡ä»¶æ®‹ç•™ï¼š

```
rm -f /etc/systemd/system/ceph-*
rm -f /etc/systemd/system/ceph-mgr@*.service
rm -f /etc/systemd/system/ceph-mon@*.service
rm -f /etc/systemd/system/ceph-mds@*.service
rm -f /etc/systemd/system/ceph-osd@*.service
```

**6. æ¸…é™¤ Ceph é›†ç¾¤é…ç½®å’Œå¯†é’¥**

å¦‚æœè¿˜æ²¡æœ‰åˆ é™¤ Ceph é›†ç¾¤çš„å¯†é’¥ç¯å’Œé…ç½®æ–‡ä»¶ï¼Œå¯ä»¥æ‰‹åŠ¨æ¸…ç†ï¼š

```
rm -f /etc/ceph/ceph.client.admin.keyring
rm -f /etc/ceph/ceph.mon.keyring
rm -f /etc/ceph/ceph-osd.keyring
```

**7. åˆ é™¤ ceph-crash**

```bash
systemctl stop ceph-crash
systemctl disable ceph-crash
systemctl mask ceph-crash

rm -rf /etc/systemd/system/multi-user.target.wants/ceph-crash.service
rm -rf /var/lib/ceph/crash
rm -f /usr/bin/ceph-crash
```

**8. æ¸…ç†ç½‘ç»œå’Œå­˜å‚¨è®¾ç½®**

å¦‚æœé…ç½®äº† Ceph ä½¿ç”¨çš„ç‰¹å®š **ç½‘ç»œæ¥å£** æˆ– **é˜²ç«å¢™è§„åˆ™**ï¼Œè¯·æ‰‹åŠ¨æ¸…ç†è¿™äº›è®¾ç½®ï¼š

- æ¸…ç†é˜²ç«å¢™è§„åˆ™ï¼šä½¿ç”¨ iptables æˆ– firewalld æ¸…ç† Ceph ä½¿ç”¨çš„ç«¯å£ã€‚

- åˆ é™¤ **è™šæ‹Ÿç½‘ç»œæ¥å£**ï¼ˆå¦‚ virtio ç­‰ï¼‰å’Œ **å­˜å‚¨æŒ‚è½½ç‚¹**ã€‚

**9. é‡å¯ç³»ç»Ÿ**

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œæœ€å¥½é‡å¯ç³»ç»Ÿä»¥ç¡®ä¿æ‰€æœ‰ Ceph ç»„ä»¶å®Œå…¨å¸è½½ï¼š

```
reboot
```

**10. æ£€æŸ¥ç³»ç»ŸçŠ¶æ€**

é‡å¯åï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ç³»ç»Ÿä¸­æ˜¯å¦ä»ç„¶å­˜åœ¨ä¸ Ceph ç›¸å…³çš„è¿›ç¨‹æˆ–é…ç½®ï¼š

1. æ£€æŸ¥æ˜¯å¦æœ‰ Ceph ç›¸å…³çš„è¿›ç¨‹ï¼š

```
ps aux | grep ceph
```

2. æ£€æŸ¥ Ceph é…ç½®æ˜¯å¦è¢«å®Œå…¨æ¸…é™¤ï¼š

```
ls /etc/ceph
ls /var/lib/ceph
```

3. æ£€æŸ¥ LVM æ˜¯å¦æœ‰æ®‹ç•™çš„ Ceph å·ï¼š

```
sudo lvdisplay
```

4. ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—æ˜¯å¦ä»æœ‰ Ceph ç›¸å…³çš„é”™è¯¯ï¼š

```
tail -f /var/log/syslog
```

---

## ZFS

æˆ‘ 2 å— 1T çš„ pcie4 Gen3 çš„ nvme å›ºæ€ç¡¬ç›˜, åˆ†åˆ«æ˜¯ nvme2n1 å’Œ nvme3n1, è¿˜æœ‰ä¸€å— 1T çš„ pcie4 Gen4: nvme0n1. è€Œä¸”åæœŸæˆ‘å¯èƒ½è¿˜ä¼šå¢åŠ å…¶ä»– nvme å’Œ ssd. ç°åœ¨æˆ‘æƒ³åœ¨ pve é›†ç¾¤ä¸­ä½¿ç”¨ ZFS, åˆæ­¥è®¡åˆ’æ˜¯è®© nvme0n1 åˆ’åˆ†ä¸º 2 ä¸ªåˆ†åŒº, åˆ†åˆ«ä½œä¸º zfs çš„è¯»å†™ç¼“å­˜, è€Œå…¶ä»–ç›˜ä½œä¸ºæ•°æ®ç›˜.

ä¸‹é¢æ˜¯å…·ä½“æ“ä½œ:

```bash
parted /dev/nvme0n1

(parted) mklabel gpt
(parted) print
(parted) mkpart primary 0GB 500GB
(parted) mkpart primary 500GB 100%
(parted) quit
```

```bash
zpool create nvmes mirror /dev/nvme2n1 /dev/nvme3n1

zfs set secondarycache=all nvmes
zfs set recordsize=128k  nvmes

zpool add nvmes cache /dev/nvme0n1p1
zpool add nvmes log /dev/nvme0n1p2
```

![20250221012158_iZntJA26.webp](https://cdn.dong4j.site/source/image/20250221012158_iZntJA26.webp)

### ä½¿ç”¨

**1. åœ¨ PVE å®¿ä¸»æœºä¸­ä½¿ç”¨ ZFS å­˜å‚¨**

PVE æ”¯æŒç›´æ¥åœ¨å®¿ä¸»æœºä¸­ä½¿ç”¨ ZFS å­˜å‚¨æ± ã€‚å¯ä»¥å°† ZFS å­˜å‚¨æ± æŒ‚è½½åˆ°å®¿ä¸»æœºçš„ç‰¹å®šç›®å½•ï¼Œç„¶åå°†è™šæ‹Ÿæœºå’Œ LXC å®¹å™¨é…ç½®ä¸ºä½¿ç”¨è¯¥å­˜å‚¨ã€‚

**æŒ‚è½½ ZFS å­˜å‚¨ï¼š**

```
zfs set mountpoint=/mnt/nvmes nvmes
```

è¿™å°†æŠŠä½ çš„ mypool ZFS å­˜å‚¨æ± æŒ‚è½½åˆ° /mnt/nvmes ç›®å½•ã€‚å¯ä»¥åœ¨è¿™ä¸ªç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶å¹¶è®¿é—®ã€‚

**åˆ›å»º ZFS å¿«ç…§ï¼š**

å¦‚æœä½ æƒ³å¯¹ ZFS å­˜å‚¨æ± è¿›è¡Œå¿«ç…§ï¼Œå¯ä»¥ä½¿ç”¨ï¼š

```
zfs snapshot nvmes@snapshot_name
```

**2. åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨ ZFS å­˜å‚¨**

è¦åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨ ZFS å­˜å‚¨ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š

**æ–¹å¼ 1: ä½¿ç”¨ ZFS ä½œä¸ºè™šæ‹Ÿæœºçš„ç£ç›˜**

åœ¨å®¿ä¸»æœºä¸­åˆ›å»ºä¸€ä¸ª ZFS æ•°æ®é›†ä½œä¸ºè™šæ‹Ÿæœºçš„ç£ç›˜ï¼š

```
zfs create nvmes/nvmes-disk
```

åœ¨ PVE ä¸­çš„è™šæ‹Ÿæœºé…ç½®ä¸­ï¼Œå°† nvmes/nvmes-disk æ•°æ®é›†ä½œä¸ºè™šæ‹Ÿç£ç›˜æŒ‚è½½ç»™è™šæ‹Ÿæœºã€‚ä¾‹å¦‚ï¼Œé€šè¿‡ PVE Web ç•Œé¢ï¼Œå¯ä»¥åœ¨è™šæ‹Ÿæœºçš„ç¡¬ç›˜è®¾ç½®ä¸­é€‰æ‹©è¯¥æ•°æ®é›†ï¼Œæˆ–è€…é€šè¿‡å‘½ä»¤è¡Œä½¿ç”¨ï¼š

```
qm set VMID -ide0 /dev/zvol/nvmes/nvmes-disk
```

**æ–¹å¼ 2: ä½¿ç”¨ ZFS æ–‡ä»¶å…±äº«ç»™è™šæ‹Ÿæœº**

å¦‚æœä¸å¸Œæœ›ç›´æ¥å°† ZFS å­˜å‚¨æ± ä½œä¸ºè™šæ‹Ÿç£ç›˜ï¼Œå¯ä»¥å°† ZFS å­˜å‚¨æ± ä¸­çš„æŸä¸ªç›®å½•æŒ‚è½½ä¸ºå…±äº«ç›®å½•ï¼Œè™šæ‹Ÿæœºé€šè¿‡ç½‘ç»œè®¿é—®ã€‚

1. åœ¨å®¿ä¸»æœºä¸­åˆ›å»ºç›®å½•ï¼š

```
mkdir /mnt/nvmes/share
```

2. è®¾ç½®æƒé™ï¼š

```
chmod -R 777 /mnt/nvmes/share
```

3. åœ¨è™šæ‹Ÿæœºå†…æŒ‚è½½ NFS æˆ– Samba å…±äº«ï¼ˆè§ä¸‹é¢çš„â€œå…±äº« ZFS å­˜å‚¨åˆ°å±€åŸŸç½‘â€éƒ¨åˆ†ï¼‰ã€‚

**3. åœ¨ LXC å®¹å™¨ä¸­ä½¿ç”¨ ZFS å­˜å‚¨**

LXC å®¹å™¨ä¸è™šæ‹Ÿæœºç±»ä¼¼ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è®¿é—®å®¿ä¸»æœºä¸Šçš„ ZFS å­˜å‚¨æ± ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å°† ZFS å­˜å‚¨æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨ï¼š

1. **æŒ‚è½½ ZFS å­˜å‚¨åˆ°å®¹å™¨ç›®å½•ï¼š**

å¯ä»¥å°†å®¿ä¸»æœºä¸Šçš„ ZFS å­˜å‚¨æ± æŒ‚è½½åˆ°å®¹å™¨çš„æŸä¸ªç›®å½•ã€‚å‡è®¾å°† nvmes/share æŒ‚è½½åˆ°å®¹å™¨ä¸­çš„ /mnt/storageï¼Œå¯ä»¥åœ¨å®¹å™¨é…ç½®ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

ç¼–è¾‘ /etc/pve/lxc/VMID.conf é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ ï¼š

```
mp0: /mnt/nvmes/share,mp=/mnt/storage
```

2. **é‡æ–°å¯åŠ¨å®¹å™¨ï¼š**

```
pct restart VMID
```

å®¹å™¨å°±èƒ½è®¿é—®å®¿ä¸»æœºä¸Šçš„ ZFS å­˜å‚¨äº†ã€‚

**4. åœ¨å±€åŸŸç½‘ä¸­å…±äº« ZFS å­˜å‚¨**

å¦‚æœå¸Œæœ›å°† ZFS å­˜å‚¨å…±äº«ç»™å±€åŸŸç½‘ä¸­çš„å…¶ä»–è®¾å¤‡ï¼ˆæ¯”å¦‚å…¶ä»–è®¡ç®—æœºã€æœåŠ¡å™¨æˆ–è™šæ‹Ÿæœºï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ NFS æˆ– Sambaã€‚

**ä½¿ç”¨ NFS å…±äº« ZFS å­˜å‚¨ï¼š**

1. å®‰è£… NFS æœåŠ¡ï¼š

```
apt install nfs-kernel-server
```

2. é…ç½® NFS å…±äº«ç›®å½•ï¼š

åœ¨ /etc/exports æ–‡ä»¶ä¸­æ·»åŠ  ZFS å­˜å‚¨ç›®å½•ï¼š

```
/mnt/nvmes/share *(rw,sync,no_subtree_check)
```

3. é‡æ–°å¯åŠ¨ NFS æœåŠ¡ï¼š

```
systemctl restart nfs-kernel-server
```

4. åœ¨å®¢æˆ·ç«¯ï¼ˆå…¶ä»–è®¡ç®—æœºï¼‰æŒ‚è½½å…±äº«ï¼š

```
mount -t nfs <å®¿ä¸»æœº_IP>:/mnt/nvmes/share /mnt/nfs_share
```

- [macOS ä¸Šé€šè¿‡ NFS æŒ‚è½½ PVE ZFS çš„é—®é¢˜](https://www.cnblogs.com/wangmo/p/15048045.html)
- [åœ¨ macOS ä¸Šè¯»å– ZFS ç¡¬ç›˜](https://ecnelises.com/2022/08/reading-zfs-on-macos/)

- [How to mount nfs drive on macOS with read+write access?](https://apple.stackexchange.com/questions/285390/how-to-mount-nfs-drive-on-macos-with-readwrite-access)

- [Proxmox VE pve æ·»åŠ  nfs/smb/iscsi/NTFS å‚¨å­˜](https://foxi.buduanwang.vip/virtualization/270.html/)

**ä½¿ç”¨ Samba å…±äº« ZFS å­˜å‚¨ï¼š**

1. å®‰è£… Sambaï¼š

```
apt install samba
```

2. é…ç½®å…±äº«ç›®å½•ï¼š

ç¼–è¾‘ /etc/samba/smb.conf æ–‡ä»¶ï¼Œæ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```
[nvmes]
   path = /mnt/nvmes
   browsable = yes
   read only = no
   guest ok = yes        # å…è®¸åŒ¿åè®¿é—®
   create mask = 0775    # è®¾ç½®æ–‡ä»¶çš„åˆ›å»ºæƒé™
   directory mask = 0775 # è®¾ç½®ç›®å½•çš„åˆ›å»ºæƒé™
```

```bash
chmod -R 775 /mnt/nvmes
chown -R nobody:nogroup /mnt/nvmes
```

3. é‡å¯ Samba æœåŠ¡ï¼š

```
systemctl restart smbd
```

4. åœ¨å®¢æˆ·ç«¯ï¼ˆå…¶ä»–è®¡ç®—æœºï¼‰è®¿é—®å…±äº«ï¼š

é€šè¿‡ smb:// åè®®æŒ‚è½½å…±äº«ï¼š

```
smbclient //å®¿ä¸»æœº_IP/nvmes
```

---

## ç½‘ç»œ

### ç­–ç•¥è·¯ç”±

æ¯å° PVE éƒ½æœ‰è‡³å°‘ 2 ä¸ªç½‘å¡, ä¸”åˆ†åˆ«é“¾æ¥åˆ°ç”µä¿¡å’Œè”é€šå®½å¸¦, å› ä¸º PVE åªèƒ½è®¾ç½®ä¸€ä¸ªç½‘å…³, æ‰€ä»¥éœ€è¦é€šè¿‡ç­–ç•¥è·¯ç”±çš„æ–¹å¼è®©ç¬¬äºŒå—ç½‘å¡å¯ä»¥é“¾æ¥å¤–ç½‘.

æ¯”å¦‚ **vmbr0** æ˜¯ç¬¬ä¸€å—ç½‘å¡, ä¸”èƒ½å¤ŸæˆåŠŸé“¾æ¥å¤–ç½‘, **vmbr1** æ˜¯å¦ä¸€å—ç½‘å¡, éœ€è¦é…ç½®ç­–ç•¥è·¯ç”±:

```bash
# æ·»åŠ ç¬¬äºŒä¸ªé»˜è®¤è·¯ç”±
ip route add default via 192.168.21.1 dev vmbr1 table 100

# åˆ›å»ºè§„åˆ™
ip rule add from 192.168.21.0/24 table 100
```

ç„¶åä½¿ç”¨ curl æµ‹è¯•ä¸åŒçš„ç½‘å¡:

```bash
curl --interface vmbr0 https://4.ipw.cn ; curl --interface vmbr1 https://4.ipw.cn
```

èƒ½å¤ŸæˆåŠŸè¿”å›æ­£ç¡®çš„å¤–ç½‘ IP åœ°å€.

**æŒä¹…åŒ–**

ç¼–è¾‘ `/etc/network/interfaces`:

```bash
auto vmbr1
iface vmbr1 inet static
				...
        post-up ip route add default via 192.168.21.1 dev vmbr1 table 100
        post-up ip rule add from 192.168.21.0/24 table 100
        pre-down ip rule del from 192.168.21.0/24 table 100
        pre-down ip route del default via 192.168.21.1 dev vmbr1 table 100
```

```bash
systemctl restart systemd-networkd
```

#### åŸºäº debian çš„è™šæ‹Ÿæœºé…ç½®

åŒä¸Š, éœ€è¦ä¿®æ”¹ä¸€ä¸‹ç½‘å¡å

#### åŸºäº ubuntu çš„è™šæ‹Ÿæœºé…ç½®

ç¼–è¾‘ `/etc/systemd/network/eth1.network`

```bash
[Match]
Name = eth1

[Network]
Description = Interface eth1 autoconfigured by PVE
Address = 192.168.21.100/24
Gateway=192.168.21.1
DHCP=ipv6
IPv6AcceptRA=false

[RoutingPolicyRule]
Priority=1000
From=192.168.21.0/24
Table=100

[Route]
Destination=0.0.0.0/0
Gateway=192.168.21.1
Table=100
```

```bash
systemctl restart systemd-networkd
```

```bash
curl --interface eth0 https://4.ipw.cn ; curl --interface eth1 https://4.ipw.cn
```

#### é—®é¢˜

ä¸Šè¿°é…ç½®å, è™½ç„¶èƒ½å¤Ÿé€šè¿‡ä¸¤å¼ ç½‘å¡åŒæ—¶è®¿é—®å¤–ç½‘, ä½†æ˜¯å±€åŸŸç½‘çš„å…¶ä»–è®¾å¤‡åˆ™æ— æ³•é€šè¿‡ç½‘å¡ 2 è®¿é—® pve å’Œ è™šæ‹Ÿæœº.

é—®é¢˜åœ¨äºæ²¡æœ‰ä¸Šè¿°é…ç½®æ—¶, å¦‚æœä»å…¶ä»–è®¾å¤‡è®¿é—® PVE æ—¶, PVE çŸ¥é“è¯·æ±‚æ¥è‡ª vmbr1ï¼Œç›´æ¥é€šè¿‡ vmbr1 è¿”å› `192.168.21.x`ï¼Œå› ä¸º**åŒç½‘æ®µçš„æµé‡ä¸ä¼šèµ°è·¯ç”±è¡¨**ï¼Œåªè¦ vmbr1 æœ‰ IPï¼Œæµé‡å°±ä¼šæ­£å¸¸å¾€è¿”.

ä¸ºäº†èƒ½è®©ç¬¬äºŒå—ç½‘å¡ä¹Ÿèƒ½è®¿é—®å¤–ç½‘, æˆ‘ä»¬æ·»åŠ äº†å¦‚ä¸‹é…ç½®:

```bash
# å®šä¹‰ table 100ï¼Œè®©å®ƒçš„é»˜è®¤ç½‘å…³æ˜¯ 192.168.21.1
post-up ip route add default via 192.168.21.1 dev vmbr1 table 100
# è®© ä» 192.168.21.x å‘å‡ºçš„æµé‡ èµ° table 100ï¼Œä¹Ÿå°±æ˜¯ vmbr1
post-up ip rule add from 192.168.21.0/24 table 100
```

è¿™æ ·ï¼Œ**å¦‚æœ PVE é€šè¿‡ 192.168.21.119 è®¿é—®å¤–ç½‘ï¼Œå®ƒå°±ä¼šä» vmbr1 èµ° 192.168.21.1**ï¼Œä»è€Œå®ç°ä¸¤å¼ ç½‘å¡éƒ½èƒ½è®¿é—®å¤–ç½‘çš„ç›®æ ‡.

ä½†æ˜¯å½“å±€åŸŸç½‘è®¾å¤‡è®¿é—® `192.168.21.x` æ—¶, **Linux çš„è·¯ç”±ç­–ç•¥é»˜è®¤ä½¿ç”¨â€œä¸»è·¯ç”±è¡¨â€å†³å®šå›åŒ…è·¯å¾„**, è€Œé»˜è®¤è·¯ç”±å®šä¹‰çš„æ˜¯ç½‘å¡ 1, æ‰€ä»¥ä¼šæŠŠé»˜è®¤ä»ç½‘å¡ 1 å‡ºå», å¯¼è‡´è¯·æ±‚çš„è®¾å¤‡æ— æ³•æ­£ç¡®æ¥æ”¶æ•°æ®.

**ä¸ºä»€ä¹ˆ 192.168.21.x è®¾å¤‡æ— æ³•æ­£ç¡®æ¥æ”¶æ•°æ®ï¼Ÿ**

**1. PVE æ”¶åˆ° 192.168.21.x è®¾å¤‡çš„è¯·æ±‚**

æ¯”å¦‚ 192.168.21.50 æƒ³è®¿é—® PVEï¼ˆ192.168.21.119ï¼‰ï¼Œå®ƒå‘é€æ•°æ®åŒ…ï¼š

```
src: 192.168.21.50  â†’ dst: 192.168.21.119
```

è¿™ä¸ªåŒ…ä¼šé€šè¿‡ vmbr1 æ¥æ”¶ã€‚

**2. PVE çš„é»˜è®¤è·¯ç”±é€‰æ‹© 31.x å‡ºå£**

- PVE æ—¢æœ‰ 192.168.21.119ï¼Œä¹Ÿæœ‰ 192.168.31.119ï¼ˆå‡è®¾ï¼‰ã€‚

- å› ä¸º PVE **çš„é»˜è®¤ç½‘å…³æ˜¯ 192.168.31.1**ï¼Œæ‰€ä»¥å®ƒçš„é»˜è®¤è·¯ç”±æ˜¯ï¼š

```
default via 192.168.31.1 dev vmbr0
```

- **Linux é»˜è®¤ä½¿ç”¨ â€œä¸»è·¯ç”±è¡¨â€ è¿›è¡Œè·¯ç”±æŸ¥æ‰¾ï¼Œè€Œä¸æ˜¯åŸºäºå…¥å£æ¥å£å›åŒ…**

- äºæ˜¯ PVE å‘é€å›åŒ…ï¼š

```
src: 192.168.21.119  â†’ dst: 192.168.21.50
```

ä½†æ˜¯, **å®ƒä» 31.x çš„ç½‘å…³ 192.168.31.1 å‡ºå»äº†**.

**3. å›åŒ…ä» 31.x å‡ºå»ï¼Œå¯¼è‡´ NAT å¤±è´¥**

- 192.168.21.50 è®¾å¤‡æœ¬æ¥æœŸæœ›ï¼š

  - **è¯·æ±‚**ï¼š21.50 -> 21.119
  - **å›åŒ…**ï¼š21.119 -> 21.50

- ä½†å®é™…ä¸Šå‘ç”Ÿäº†ï¼š
  - **è¯·æ±‚**ï¼š21.50 -> 21.119
  - **å›åŒ…**ï¼š21.119 -> 21.50ï¼ˆ**å´ä» 31.x å‡ºå»**ï¼‰

è¿™å¯¼è‡´ 192.168.21.50 **æ”¶åˆ°çš„å›åŒ…æº IP è¿˜æ˜¯ 21.119**ï¼Œä½†è·¯ç”±å™¨å¯èƒ½ä¼š **ä¸¢å¼ƒè¯¥åŒ…**ï¼Œå› ä¸ºï¼š

- å®ƒçš„**å…¥ç«™è¿æ¥ä¸æ˜¯ä» 31.x å‘å‡ºçš„**ï¼Œè€Œæ˜¯ä» 21.x æ¥çš„ï¼Œ**è¿™å¯¼è‡´ NAT ä¸åŒ¹é…**ã€‚

- è®¸å¤šé˜²ç«å¢™ï¼ˆç‰¹åˆ«æ˜¯ä¼ä¸šè·¯ç”±å™¨ï¼‰é»˜è®¤ä¼š**ä¸¢å¼ƒâ€éå¯¹ç§°è·¯ç”±â€çš„å›åŒ…**ï¼Œå› ä¸ºå®ƒå¯èƒ½æ˜¯ä¼ªé€ æµé‡ã€‚

---

#### è§£å†³åŠæ³•

ä¸ºäº†æ»¡è¶³ä»¥ä¸‹è¦æ±‚:

1. PVE çš„ä¸¤å¼ ç½‘å¡éƒ½èƒ½è®¿é—®å¤–ç½‘;
2. å±€åŸŸç½‘èƒ½å¤Ÿæ­£å¸¸è®¿é—® PVE çš„ä¸¤å¼ ç½‘å¡;

æˆ‘ä»¬éœ€è¦åšå¦‚ä¸‹é…ç½®.

##### åŸºäº debian

```bash
post-up ip route add 192.168.21.0/24 dev vmbr1 table 100
post-up ip route add default via 192.168.21.1 dev vmbr1 table 100
post-up ip rule add from 192.168.21.0/24 table 100
post-up ip rule add to 192.168.21.0/24 table 100
post-up ip rule add iif vmbr1 table 100

post-down ip rule del from all iif vmbr1 lookup 100
post-down ip rule del from all to 192.168.21.0/24 lookup 100
post-down ip rule del from 192.168.21.0/24 lookup 100
post-down ip route del 192.168.21.0/24 dev vmbr1 scope link table 100
post-down ip route del default via 192.168.21.1 dev vmbr1 table 100
```

> LXC æˆ–è™šæ‹Ÿæœºä¸­, åªéœ€è¦ä¿®æ”¹ä¸€ä¸‹ç½‘å¡åç§°

##### åŸºäº ubuntu

```bash
[Match]
Name=eth1

[Network]
Description=Interface eth1 autoconfigured by PVE
Address=192.168.21.103/24
Gateway=192.168.21.1
DHCP=ipv6
IPv6AcceptRA=false

[RoutingPolicyRule]
Priority=1000
From=192.168.21.0/24
Table=100

[RoutingPolicyRule]
Priority=1001
To=192.168.21.0/24
Table=100

[RoutingPolicyRule]
Priority=1002
IncomingInterface=eth1
Table=100

[Route]
Destination=192.168.21.0/24
Table=100

[Route]
Destination=0.0.0.0/0
Gateway=192.168.21.1
Table=100
```

æœ€åæˆ‘ä»¬å¯ä»¥ä»¥ä¸‹å‘½ä»¤éªŒè¯:

```bash
$ ip rule show
0:      from all lookup local
1000:   from 192.168.21.0/24 lookup 100 proto static
1001:   from all to 192.168.21.0/24 lookup 100 proto static
1002:   from all iif eth1 lookup 100 proto static
32766:  from all lookup main
32767:  from all lookup default

$ ip route show table 100
default via 192.168.21.1 dev eth1 proto static
192.168.21.0/24 dev eth1 proto static scope link
```

---

##### æµç¨‹å›¾

```mermaid
graph TD;
    subgraph "å¤–éƒ¨è®¾å¤‡"
        Client31["è®¾å¤‡ (192.168.31.x)"]
        Client21["è®¾å¤‡ (192.168.21.x)"]
    end

    subgraph "PVE æœåŠ¡å™¨"
        vmbr0["vmbr0 (192.168.31.119)"]
        vmbr1["vmbr1 (192.168.21.119)"]
        RouteTable["è·¯ç”±è¡¨ (ç­–ç•¥è·¯ç”±)"]
    end

    subgraph "ç½‘å…³"
        GW31["192.168.31.1 (é»˜è®¤ç½‘å…³)"]
        GW21["192.168.21.1"]
    end

    %% è¿æ¥è®¾å¤‡åˆ° PVE
    Client31 -- "æµé‡è¿›å…¥" --> vmbr0
    Client21 -- "æµé‡è¿›å…¥" --> vmbr1

    %% PVE çš„è·¯ç”±å¤„ç†
    vmbr0 -- "é»˜è®¤æµé‡èµ°ä¸»è·¯ç”±è¡¨ (via 192.168.31.1)" --> GW31
    vmbr1 -- "åŒ¹é…è§„åˆ™: iif vmbr1" --> RouteTable
    RouteTable -- "å‡ºå£: vmbr1 (via 192.168.21.1)" --> GW21

    %% è®¾å¤‡è®¿é—®è¿”å›æµé‡
    GW31 -- "å›åŒ…æµé‡" --> vmbr0 -- "è¿”å› Client31" --> Client31
    GW21 -- "å›åŒ…æµé‡" --> vmbr1 -- "è¿”å› Client21" --> Client21
```

---

### qemu-guest-agent

è™šæ‹Ÿæœºæ‰§è¡Œå‘½ä»¤:

```bash
sudo apt install qemu-guest-agent -y

sudo systemctl start qemu-guest-agent
```

ä¸è¿‡æŠ¥é”™äº†:

```
(base) âœ  ~ sudo systemctl start qemu-guest-agent
^@A dependency job for qemu-guest-agent.service failed. See 'journalctl -xe' for details.

Feb 20 06:26:26 ai systemd[1]: dev-virtio\x2dports-org.qemu.guest_agent.0.device: Job dev-virtio\x2dports-org.qemu.guest_agent.0.device/start timed out.
Feb 20 06:26:26 ai systemd[1]: Timed out waiting for device dev-virtio\x2dports-org.qemu.guest_agent.0.device - /dev/virtio-ports/org.qemu.guest_agent.0.
```

**è™šæ‹Ÿæœºå†…çš„ QEMU Guest Agent æ— æ³•æ‰¾åˆ° /dev/virtio-ports/org.qemu.guest_agent.0 è®¾å¤‡**ï¼Œé€šå¸¸æ˜¯å› ä¸º **PVE çš„ VM é…ç½®æ²¡æœ‰æ­£ç¡®å¯ç”¨ QEMU Guest Agent**ã€‚

æ‰€ä»¥éœ€è¦åœ¨ PVE å®¿ä¸»æœºä¸Šå¼€å¯è™šæ‹Ÿæœºçš„ Guest Agent:

```bash
qm set 102 --agent enabled=1

qm reboot 102
```

ç„¶åè¿˜æ˜¯å¯åŠ¨å¤±è´¥:

```bash
(base) âœ  ~ sudo systemctl status qemu-guest-agent
â—‹ qemu-guest-agent.service - QEMU Guest Agent
     Loaded: loaded (/usr/lib/systemd/system/qemu-guest-agent.service; static)
     Active: inactive (dead)

Feb 20 06:34:46 ai systemd[1]: qemu-guest-agent.service: Bound to unit dev-virtio\x2dports-org.qemu.guest_agent.0.device, but unit isn't active.
Feb 20 06:34:46 ai systemd[1]: Dependency failed for qemu-guest-agent.service - QEMU Guest Agent.
Feb 20 06:34:46 ai systemd[1]: qemu-guest-agent.service: Job qemu-guest-agent.service/start failed with result 'dependency'.
```

æŸ¥é˜…èµ„æ–™åå‘ç°æ˜¯éœ€è¦æ·»åŠ ä¸€ä¸ª **virtio-serial** çš„è®¾å¤‡:

```bash
qm set 102 -serial0 socket

qm reboot 102
```

ç„¶åå†æ¬¡å¯åŠ¨ agent:

```bash
(base) âœ  ~ sudo systemctl status qemu-guest-agent
â— qemu-guest-agent.service - QEMU Guest Agent
     Loaded: loaded (/usr/lib/systemd/system/qemu-guest-agent.service; static)
     Active: active (running) since Thu 2025-02-20 06:37:46 UTC; 3s ago
   Main PID: 1549 (qemu-ga)
      Tasks: 2 (limit: 38427)
     Memory: 416.0K (peak: 840.0K)
        CPU: 5ms
     CGroup: /system.slice/qemu-guest-agent.service
             â””â”€1549 /usr/sbin/qemu-ga

Feb 20 06:37:46 ai systemd[1]: Started qemu-guest-agent.service - QEMU Guest Agent.
```

æ˜¾ç¤ºå¯åŠ¨æˆåŠŸäº†, èƒ½å¤Ÿæ­£å¸¸è·å– IP ä¿¡æ¯:

![20250221012204_Kp7lflpS.webp](https://cdn.dong4j.site/source/image/20250221012204_Kp7lflpS.webp)

æœåŠ¡å™¨ä¸ŠæŸ¥çœ‹è™šæ‹Ÿæœºä¿¡æ¯:

```bash
qm agent <vmid> <cmd>

    fsfreeze-freeze
    fsfreeze-status
    fsfreeze-thaw
    fstrim                      #æŸ¥çœ‹ssdâ€”â€”trim
    get-fsinfo                  #æŸ¥çœ‹ç£ç›˜ä¿¡æ¯
    get-host-name               #æŸ¥çœ‹ä¸»æœºå
    get-memory-block-info       #æŸ¥çœ‹å†…å­˜å— ä¿¡æ¯
    get-memory-blocks           #æŸ¥çœ‹æ‚¨å†…å­˜
    get-osinfo                  #æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯
    get-time                    #æŸ¥çœ‹æ—¶é—´
    get-timezone                #æŸ¥çœ‹æ—¶åŒº
    get-users                   #ç”¨æˆ·
    get-vcpus                   #æŸ¥çœ‹CPUæ•°é‡
    info                        #æŸ¥çœ‹æ”¯æŒçš„å‘½ä»¤
    network-get-interfaces      #æŸ¥çœ‹ç½‘ç»œ
    ping                        #ä¸æ˜
    shutdown                    #å…³æœº
    suspend-disk                #ä¼‘çœ ï¼Œå‚¨å­˜åˆ°ç¡¬ç›˜
    suspend-hybrid              #ä¼‘çœ ï¼Œæ··åˆ
    suspend-ram                 #æŒ‚èµ·/ä¼‘çœ  å†…å­˜
```

**å‚è€ƒ:**

- [PVE ä¸­ qemu guest agent çš„å®‰è£…å’Œä½¿ç”¨](https://foxi.buduanwang.vip/virtualization/pve/530.html/)

### åˆ å‡ PCIe è®¾å¤‡åç½‘å¡åç§°å˜æ›´

ç½‘å¡åç§°å‘ç”Ÿå˜åŒ–æ˜¯å› ä¸ºç³»ç»Ÿä½¿ç”¨äº† **udev**ï¼ˆè®¾å¤‡ç®¡ç†å™¨ï¼‰æ¥è‡ªåŠ¨ä¸ºç½‘ç»œæ¥å£åˆ†é…åç§°ï¼Œé»˜è®¤ä½¿ç”¨ **Predictable Network Interface Names**ï¼ˆå¯é¢„æµ‹çš„ç½‘ç»œæ¥å£åç§°ï¼‰è§„åˆ™ã€‚è¿™ä¸ªè§„åˆ™åŸºäºç½‘å¡çš„ç¡¬ä»¶åœ°å€ï¼ˆMAC åœ°å€ï¼‰æˆ–è€…è®¾å¤‡è·¯å¾„ï¼ˆä¾‹å¦‚ PCI åœ°å€ï¼‰æ¥å‘½åç½‘å¡ã€‚

å½“æ‹”æ‰ GPU åï¼Œç³»ç»Ÿå¯èƒ½é‡æ–°åˆ†é…äº†ç½‘å¡æ¥å£çš„åç§°ï¼Œè¿™ä¸»è¦æ˜¯å› ä¸º PCI æ’æ§½é¡ºåºã€è®¾å¤‡åˆå§‹åŒ–é¡ºåºç­‰å› ç´ çš„å˜åŒ–ï¼Œå¯¼è‡´äº† udev ç»™ç½‘å¡åˆ†é…äº†ä¸åŒçš„åç§°ã€‚

è¿™ä¼šå¯¼è‡´ PVE ç³»ç»Ÿä¸­å·²ç»é…ç½®å¥½çš„ç½‘ç»œä¼šæ— æ³•è·å– IP.

æˆ‘ä»¬å¯ä»¥ **é€šè¿‡ udev è§„åˆ™å›ºå®šç½‘å¡åç§°**:

```bash
vim /etc/udev/rules.d/99-network.rules

SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="1c:69:7a:d0:c5:11", NAME="enp92s0"
SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="18:9b:a5:80:5a:22", NAME="enp2s0f0"
SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="18:9b:a5:80:5a:33", NAME="enp2s0f1"
SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="28:df:eb:5c:ab:44", NAME="wlp91s0"
```

é‡æ–°åŠ è½½ udev è§„åˆ™:

```bash
udevadm control --reload
```

> æˆ‘é‡æ–°åŠ è½½åæ²¡æœ‰ç”Ÿæ•ˆ, æ˜¯é‡å¯è§£å†³çš„

è¿™æ ·ï¼Œç³»ç»Ÿæ¯æ¬¡å¯åŠ¨æ—¶ï¼Œéƒ½ä¼šæ ¹æ®è¿™ä¸ªè§„åˆ™å°†æŒ‡å®šçš„ç½‘å¡åç§°å›ºå®šä¸ºä½ æŒ‡å®šçš„åç§°ã€‚

---

### 4G ç½‘å¡æ‹¨å·(qmi_wwan)

```
sudo apt update
sudo apt install libqmi-utils udhcpc
```

**é…ç½® 4G ç½‘å¡å¹¶æ‹¨å·ä¸Šç½‘**

```
# æŸ¥çœ‹ç³»ç»Ÿä¸­è¯†åˆ«åˆ°çš„ QMI è®¾å¤‡
qmicli -d /dev/cdc-wdm0 --device-open-proxy --dms-get-model

# è·å– 4G å¡çš„è®¾å¤‡ ID ä¿¡æ¯
qmicli -d /dev/cdc-wdm0 --device-open-proxy --dms-get-ids

# è·å– 4G å¡çš„ SIM å¡çŠ¶æ€
qmicli -d /dev/cdc-wdm0 --device-open-proxy --uim-get-card-status

# è·å–ç½‘ç»œä¿¡å·å¼ºåº¦ä¿¡æ¯
qmicli -d /dev/cdc-wdm0 --device-open-proxy --nas-get-signal-strength

# è·å–è¿è¥å•†ç½‘ç»œçŠ¶æ€
qmicli -d /dev/cdc-wdm0 --device-open-proxy --nas-get-serving-system

# è®¾ç½® APN å¹¶å¯åŠ¨æ‹¨å·è¿æ¥ï¼ˆæ›¿æ¢ `your_apn` ä¸ºå®é™… APNï¼‰[ä¸­å›½ç§»åŠ¨ï¼šcmnet ä¸­å›½è”é€šï¼š3gnet ä¸­å›½ç”µä¿¡ï¼šctnet]
qmicli -d /dev/cdc-wdm0 --device-open-proxy --wds-start-network="apn=your_apn,ip-type=4" --client-no-release-cid
```

**è·å–æ‹¨å·åçš„ç½‘ç»œé…ç½®**

```
# è·å–å½“å‰ç½‘ç»œé…ç½®ï¼ŒåŒ…æ‹¬ IP åœ°å€ã€å­ç½‘æ©ç å’Œç½‘å…³
qmicli -d /dev/cdc-wdm0 --device-open-proxy --wds-get-current-settings
```

**é…ç½®åŠ¨æ€è·å– IPï¼ˆDHCPï¼‰**

```
# ä¸º wwan0 æ¥å£é…ç½® DHCP åŠ¨æ€è·å– IP åœ°å€
sudo nano /etc/network/interfaces

# åœ¨æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹
# é…ç½® wwan0 ä½¿ç”¨ DHCP åŠ¨æ€è·å– IP åœ°å€
auto wwan0
iface wwan0 inet dhcp
```

**å¯åŠ¨å¹¶æ£€æŸ¥ç½‘ç»œæ¥å£**

```
# é‡å¯ç½‘ç»œæœåŠ¡ä»¥ä½¿é…ç½®ç”Ÿæ•ˆ
sudo systemctl restart networking

# ç¡®è®¤ wwan0 æ¥å£å·²æ­£ç¡®è·å– IP åœ°å€
ip a show wwan0

# æŸ¥çœ‹ç½‘ç»œè·¯ç”±ï¼Œç¡®ä¿é»˜è®¤è·¯ç”±é€šè¿‡ 4G ç½‘å¡
ip route show
```

**æ‰‹åŠ¨è¯·æ±‚ DHCP è·å– IPï¼ˆå¯é€‰ï¼‰**

```
# ä½¿ç”¨ dhclient æ‰‹åŠ¨è¯·æ±‚ DHCP æœåŠ¡å™¨åˆ†é… IP åœ°å€
sudo dhclient wwan0

# å†æ¬¡æ£€æŸ¥æ¥å£çŠ¶æ€ï¼Œç¡®è®¤æ˜¯å¦å·²è·å–åˆ° IP åœ°å€
ip a show wwan0
```

**æ·»åŠ é»˜è®¤è·¯ç”±ï¼ˆå¦‚æœéœ€è¦ï¼‰**

```
# å¦‚æœ IP åœ°å€å·²æ­£ç¡®åˆ†é…ï¼Œä½†é»˜è®¤è·¯ç”±æ²¡æœ‰è®¾ç½®ï¼Œå¯ä»¥æ‰‹åŠ¨æ·»åŠ é»˜è®¤è·¯ç”±
sudo ip route add default via <your_gateway> dev wwan0
```

**é…ç½® DNSï¼ˆå¯é€‰ï¼‰**

```
# æ‰‹åŠ¨æ·»åŠ  DNS æœåŠ¡å™¨
echo "nameserver 218.6.200.139" | sudo tee /etc/resolv.conf
echo "nameserver 61.139.2.69" | sudo tee -a /etc/resolv.conf
```

**é…ç½®è™šæ‹Ÿç½‘ç»œæ¡¥æ¥ï¼ˆPVEï¼‰**

```
# ç¼–è¾‘ç½‘ç»œé…ç½®æ–‡ä»¶ï¼Œç¡®ä¿ wwan0 æ¥å£æ¡¥æ¥åˆ°è™šæ‹Ÿç½‘æ¡¥ vmbr0
sudo nano /etc/network/interfaces

# æ·»åŠ å¦‚ä¸‹é…ç½®ï¼Œä½¿è™šæ‹Ÿæœºé€šè¿‡ 4G ç½‘ç»œè¿æ¥
auto vmbr0
iface vmbr0 inet static
    address 10.165.54.10
    netmask 255.255.255.0
    gateway 10.165.54.153
    bridge_ports wwan0
    bridge_stp off
    bridge_fd 0
```

**æµ‹è¯•ç½‘ç»œè¿æ¥**

```
# æµ‹è¯•ç½‘ç»œæ˜¯å¦èƒ½æ­£å¸¸è¿æ¥åˆ°å¤–éƒ¨åœ°å€
ping 8.8.8.8

# æµ‹è¯• DNS æ˜¯å¦èƒ½è§£æåŸŸå
dig @218.6.200.139 google.com
```

**åŠ¨æ€æ›´æ–° IP åœ°å€å’Œè·¯ç”±ï¼ˆå¦‚æœéœ€è¦é™æ€é…ç½®ï¼‰**

```
# åˆ›å»ºè„šæœ¬æ¥åŠ¨æ€æ›´æ–° IP åœ°å€å’Œè·¯ç”±ï¼ˆå½“ IP å˜åŒ–æ—¶ï¼‰
sudo nano /etc/network/if-up.d/update-wwan0-ip

# æ·»åŠ ä»¥ä¸‹å†…å®¹
#!/bin/bash
if [ "$IFACE" == "wwan0" ]; then
    IP=$(ip addr show wwan0 | grep 'inet ' | awk '{print $2}' | cut -d/ -f1)
    GATEWAY=$(ip route show dev wwan0 | grep default | awk '{print $3}')
    DNS1="218.6.200.139"
    DNS2="61.139.2.69"

    # æ›´æ–° resolv.conf
    echo "nameserver $DNS1" > /etc/resolv.conf
    echo "nameserver $DNS2" >> /etc/resolv.conf

    # æ›´æ–°é»˜è®¤è·¯ç”±
    ip route del default
    ip route add default via "$GATEWAY"

    # æ›´æ–° wwan0 çš„ IP åœ°å€ï¼ˆä»…åœ¨ä½ ä½¿ç”¨é™æ€ IP æ—¶æ‰éœ€è¦ï¼‰
    ip addr add "$IP/30" dev wwan0
fi

# èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
sudo chmod +x /etc/network/if-up.d/update-wwan0-ip
```

#### è‡ªåŠ¨æ‹¨å·

```bash
vim /etc/systemd/system/qmi-network.service

[Unit]
Description=QMI 4G Network
After=network.target

[Service]
ExecStart=/usr/bin/qmicli -d /dev/cdc-wdm0 --device-open-proxy --wds-start-network="apn=ctnet,ip-type=4" --client-no-release-cid
ExecStartPost=/sbin/udhcpc -i wwan0
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

```bash
sudo systemctl daemon-reload
sudo systemctl enable qmi-network
sudo systemctl start qmi-network
```

**å‚è€ƒ**

- [debian-QMICLI](https://manpages.debian.org/testing/libqmi-utils/qmicli.1.en.html)

---

### 4G ç½‘å¡æ‹¨å·(wvdial)

```bash
apt install wvdial

# æ‰“å¼€é…ç½®æ–‡ä»¶
vim /etc/wvdial.conf
```

```bash
# ç”µä¿¡
[Dialer T]
Init1 = ATZ
Init2 = ATQ0 V1 E1 S0=0 &C1 &D2 +FCLASS=0
Modem Type = Analog Modem
Baud = 9600
New PPPD = yes
Modem = /dev/ttyUSB3
ISDN = 0
Phone = *99#
Password = card
Username = card
```

**æ‹¨å·**

```bash
$ wvdial  T
--> WvDial: Internet dialer version 1.61
--> Initializing modem.
--> Sending: ATZ
ATZ
OK
--> Sending: ATQ0 V1 E1 S0=0 &C1 &D2 +FCLASS=0
ATQ0 V1 E1 S0=0 &C1 &D2 +FCLASS=0
OK
--> Modem initialized.
--> Sending: ATDT*99#
--> Waiting for carrier.
ATDT*99#
CONNECT 150000000
--> Carrier detected.  Waiting for prompt.
--> Don't know what to do!  Starting pppd and hoping for the best.
--> Starting pppd at Mon Feb 24 18:23:27 2025
--> Pid of pppd: 6407
--> Using interface ppp0
--> local  IP address 10.165.54.154
--> remote IP address 10.64.64.64
--> primary   DNS address 218.6.200.139
--> secondary DNS address 61.139.2.69
```

#### è‡ªåŠ¨æ‹¨å·

```bash
#! /bin/bash

#è¿è¡Œæ­¥éª¤å˜é‡åˆå§‹åŒ–
ec20_step=0

#è¶…æ—¶è®¡æ•°åˆå§‹åŒ–
over_time=0

#å¾ªç¯
while [ 1 ]
do
	#ç¬¬ä¸€æ­¥å…ˆæ£€æŸ¥é©±åŠ¨
	if [ $ec20_step -eq 0 ]; then
	#ä½¿ç”¨lsusbæŸ¥çœ‹æ˜¯å¦æœ‰ec20é©±åŠ¨ grepæŸ¥è¯¢ç»“æœæ˜¯å¦åŒ…å«Quectel
		result=$(lsusb | grep Quectel)
		echo "1. æ£€æŸ¥é©±åŠ¨: " $result
		if [[ $result =~ "EC25" ]]; then
			ec20_step=1

		else
			ec20_step=0
		fi
		#å»¶æ—¶2s
		sleep 2
	#ç¬¬äºŒæ­¥ å¼€å§‹ä½¿ç”¨ wvdial æ‹¨å·
	elif [ $ec20_step -eq 1 ]; then
		echo "2. wvdial æ‹¨å·"
		echo "password" | sudo nohup wvdial T &
		ec20_step=2

		sleep 2
	#ç¬¬ä¸‰æ­¥ æŸ¥è¯¢è·¯ç”±æ˜¯å¦åŒ…å« ppp0 ç½‘å¡ï¼Œæ‹¨å·æˆåŠŸåˆ™ä¼šåŒ…å«æœ‰ ppp0 ç½‘å¡
	elif [ $ec20_step -eq 2 ]; then
		result=$(route -n | grep ppp0)

		echo "3. æ£€æŸ¥æ˜¯å¦å­˜åœ¨ ppp0 ç½‘å¡" $result

		if [[ $result =~ "ppp0" ]]; then
			echo "3.1 åŒ…å«ç½‘å¡ï¼Œæ·»åŠ é»˜è®¤è·¯ç”±"
			#è‹¥åŒ…å«ç½‘å¡ï¼Œåˆ™æ·»åŠ é»˜è®¤è·¯ç”±
			echo "password" | sudo route add default dev ppp0
			ec20_step=3
			over_time=0
		else
			echo "3.2 ä¸åŒ…å«ç½‘å¡, å†æ¬¡å¾ªç¯æŸ¥è¯¢, å¾ªç¯æ¬¡æ•°:" $over_time
			#è¶…æ—¶è®¡æ•°
			let over_time++
		fi
		#è‹¥ä¸€åˆ†é’Ÿéƒ½æ²¡æœ‰è·¯ç”±ç½‘å¡åˆ™è¯´æ˜æ²¡æœ‰æ‹¨å·æˆåŠŸ
		if [ $over_time -eq 12 ]; then
			echo "12 æ¬¡æ£€æŸ¥ä¸å­˜åœ¨è·¯ç”±ç½‘å¡, è¯´æ˜æ²¡æœ‰æ‹¨å·æˆåŠŸ, è¿›å…¥é‡å¯é€»è¾‘"
			over_time=0
			#è¶…æ—¶æ‹¨å·åˆ™è·³å…¥é‡å¯æ­¥éª¤
			ec20_step=4
		fi

		sleep 5
	#ç¬¬å››æ­¥ é€šè¿‡ ping å‘½ä»¤æ£€æŸ¥ç½‘ç»œçŠ¶æ€
	elif [ $ec20_step -eq 3 ]; then
		result=$(ping -I ppp0 -c 1 www.baidu.com)

		echo "4. é€šè¿‡ ping å‘½ä»¤æ£€æŸ¥ç½‘ç»œçŠ¶æ€" $result

		if [[ $result =~ "1 received" ]]; then
			echo "4.1 ping æˆåŠŸ"
			over_time=0
		else
			echo "4.2 ping å¤±è´¥, å†æ¬¡å¾ªç¯æŸ¥è¯¢"
			let over_time++

		fi
		#è¶…æ—¶åˆ™æ€æ‰æ‹¨å·çº¿ç¨‹ï¼Œå¹¶è¿›å…¥é‡å¯æ­¥éª¤
		if [ $over_time -eq 6 ]; then
			echo "6 æ¬¡ ping å¤±è´¥, è¿›å…¥é‡å¯é€»è¾‘"
			over_time=0
			ec20_step=4
			echo "password" | sudo pkill wvdial
		fi
		sleep 5

	#ç¬¬äº”æ­¥é‡å¯æ¨¡å—
	elif [ $ec20_step -eq 4 ]; then
		echo "é‡å¯ç½‘å¡"
		echo -e "AT+CFUN=1,1\r\n" > /dev/ttyUSB2
		ec20_step=0
		#é‡å¯å‘½ä»¤åå»¶æ—¶ç¨å¾®é•¿ä¸€ç‚¹
		sleep 15
	fi

done
exit 0
```

---

### æ­å»º 40G/56G å†…ç½‘

#### 40G

è´­ä¹°çš„ è¿ˆç»œæ€ 354A-FCCT é»˜è®¤ä¸º ETH æ¨¡å¼, æ‰€ä»¥ç›´æ¥è¿æ¥ç„¶åæµ‹è¯•:

```bash
iperf -c 1.0.0.18 -t 30 -i 1 -P 10
------------------------------------------------------------
Client connecting to 1.0.0.18, TCP port 5001
TCP window size: 16.0 KByte (default)
------------------------------------------------------------
[  2] local 1.0.0.19 port 39866 connected with 1.0.0.18 port 5001 (icwnd/mss/irtt=87/8948/370)
[  9] local 1.0.0.19 port 39958 connected with 1.0.0.18 port 5001 (icwnd/mss/irtt=87/8948/193)
[  5] local 1.0.0.19 port 39870 connected with 1.0.0.18 port 5001 (icwnd/mss/irtt=87/8948/343)
[ 10] local 1.0.0.19 port 39954 connected with 1.0.0.18 port 5001 (icwnd/mss/irtt=87/8948/196)
[  7] local 1.0.0.19 port 39952 connected with 1.0.0.18 port 5001 (icwnd/mss/irtt=87/8948/394)
[  8] local 1.0.0.19 port 39936 connected with 1.0.0.18 port 5001 (icwnd/mss/irtt=87/8948/411)
[  6] local 1.0.0.19 port 39922 connected with 1.0.0.18 port 5001 (icwnd/mss/irtt=87/8948/320)
[  1] local 1.0.0.19 port 39864 connected with 1.0.0.18 port 5001 (icwnd/mss/irtt=87/8948/381)
[  4] local 1.0.0.19 port 39862 connected with 1.0.0.18 port 5001 (icwnd/mss/irtt=87/8948/369)
[  3] local 1.0.0.19 port 39868 connected with 1.0.0.18 port 5001 (icwnd/mss/irtt=87/8948/364)
[ ID] Interval       Transfer     Bandwidth
[  6] 0.0000-1.0000 sec   794 MBytes  6.66 Gbits/sec
[  9] 0.0000-1.0000 sec   802 MBytes  6.73 Gbits/sec
[ 10] 0.0000-1.0000 sec   399 MBytes  3.34 Gbits/sec
[  1] 0.0000-1.0000 sec   159 MBytes  1.33 Gbits/sec
[  7] 0.0000-1.0000 sec   403 MBytes  3.38 Gbits/sec
[  8] 0.0000-1.0000 sec   651 MBytes  5.46 Gbits/sec
[  3] 0.0000-1.0000 sec   420 MBytes  3.53 Gbits/sec
[  4] 0.0000-1.0000 sec   472 MBytes  3.96 Gbits/sec
[  5] 0.0000-1.0000 sec   385 MBytes  3.23 Gbits/sec
[  2] 0.0000-1.0000 sec   195 MBytes  1.64 Gbits/sec
[SUM] 0.0000-1.0000 sec  4.57 GBytes  39.3 Gbits/sec
```

åŸºæœ¬ä¸Šè·‘æ»¡äº† 40G å¸¦å®½.

#### 56G

56G éœ€è¦è®¾ç½®æˆ IB æ¨¡å¼.

##### å®‰è£… MFT

[Mellanox Firmware Tools (MFT) (nvidia.com)](https://network.nvidia.com/products/adapter-software/firmware-tools/)

å®‰è£…ä¾èµ–:

```bash
apt install -y dkms "build-*" pve-headers pve-headers-`uname -r`
```

å®‰è£… MFT æ—¶æŠ¥é”™:

```
âœ  mft-4.30.1-113-x86_64-deb mst start
Starting MST (Mellanox Software Tools) driver set
Loading MST PCI modulemodprobe: ERROR: could not insert 'mst_pci': Key was rejected by service
 - Failure: 1
Loading MST PCI configuration modulemodprobe: ERROR: could not insert 'mst_pciconf': Key was rejected by service
 - Failure: 1
Create devices

mst_pci driver not found
Unloading MST PCI module (unused) - Success
Unloading MST PCI configuration module (unused) - Success
```

æˆ‘åœ¨å¦ä¸€å° PVE ä¸Šå®‰è£…åˆ™æ²¡æœ‰é—®é¢˜, AI ç»™æˆ‘çš„å›ç­”æ˜¯ **Secure Boot é˜»æ­¢äº†æœªç­¾åçš„é©±åŠ¨**, æ‰€ä»¥æŸ¥çœ‹ä¸€ä¸‹ä¸¤å° PVE çš„ **Secure Boot** çš„çŠ¶æ€:

```bash
$ mokutil --sb-state
SecureBoot enabled
```

æŠ¥é”™çš„è¿™å°å¼€å¯äº† `SecureBoot`, å¦ä¸€å°åˆ™æ²¡æœ‰å¼€å¯, æ‰€ä»¥åŸºæœ¬ä¸Šç¡®è®¤æ˜¯è¿™ä¸ªé—®é¢˜, éœ€è¦å» BIOS ç¦ç”¨ **SecureBoot**, ç„¶åé‡æ–°å®‰è£… MFT.

ç¬¬ä¸€æ¬¡å®‰è£…çš„æ˜¯ 4.30 ç‰ˆæœ¬, å®‰è£…åä½¿ç”¨ `mst start` å‡ºç°å¦‚ä¸‹é—®é¢˜:

```bash
$ mst start
Starting MST (Mellanox Software Tools) driver set
Loading MST PCI module - Success
Loading MST PCI configuration module - Success
Create devices
Unloading MST PCI module (unused) - Success
Unloading MST PCI configuration module (unused) - Success
```

åŠ è½½æ¨¡å—ååˆè‡ªåŠ¨å¸è½½äº†, ä¸”ä½¿ç”¨ `mst status` æ— æ³•è·å–ç½‘å¡ä¿¡æ¯:

```bash
mst status
MST modules:
------------
    MST PCI module is not loaded
    MST PCI configuration module is not loaded

PCI Devices:
------------

	No devices were found.
```

æŸ¥é˜…ç›¸å…³ä¿¡æ¯å, æ˜¯å› ä¸º MFT ç‰ˆæœ¬é—®é¢˜, åœ¨å°è¯•äº†å¤šä¸ªç‰ˆæœ¬å, ç¡®è®¤ 4.24 ç‰ˆæœ¬å¯è¡Œ(**æˆ‘çš„ç½‘å¡æ˜¯ HP544+ å’Œ 354A-FCCT**):

```bash
$ mst status
MST modules:
------------
    MST PCI module loaded
    MST PCI configuration module loaded

MST devices:
------------
/dev/mst/mt4103_pciconf0         - PCI configuration cycles access.
                                   domain:bus:dev.fn=0000:01:00.0 addr.reg=88 data.reg=92 cr_bar.gw_offset=-1
                                   Chip revision is: 00
/dev/mst/mt4103_pci_cr0          - PCI direct access.
                                   domain:bus:dev.fn=0000:01:00.0 bar=0x6c600000 size=0x100000
                                   Chip revision is: 00
```

##### æŸ¥è¯¢å›ºä»¶ä¿¡æ¯

**MCX354A-FCCT**

```bash
$ mlxfwmanager
Querying Mellanox devices firmware ...

Device #1:
----------

  Device Type:      ConnectX3Pro
  Part Number:      MCX354A-FCC_Ax
  Description:      ConnectX-3 Pro VPI adapter card; dual-port QSFP; FDR IB (56Gb/s) and 40GigE;PCIe3.0 x8 8GT/s;RoHS R6
  PSID:             MT_1090111019
  PCI Device Name:  /dev/mst/mt4103_pci_cr0
  Port1 GUID:       e41d2d03004ab0c1
  Port2 GUID:       e41d2d03004ab0c2
  Versions:         Current        Available
     FW             2.42.5000      N/A
     PXE            3.4.0752       N/A

  Status:           No matching image found
```

**HP544+**

```bash
$ mlxfwmanager
Querying Mellanox devices firmware ...

Device #1:
----------

  Device Type:      ConnectX3Pro
  Part Number:      764285-B21_Ax
  Description:      HP InfiniBand FDR/Ethernet 10Gb/40Gb 2-port 544+FLR-QSFP Adapter
  PSID:             HP_1380110017
  PCI Device Name:  /dev/mst/mt4103_pci_cr0
  Port1 GUID:       88e9a4ffff1241a1
  Port2 MAC:        88e9a41241a2
  Versions:         Current        Available
     FW             2.42.5700      N/A
     CLP            8025           N/A
     PXE            3.4.0754       N/A
     UEFI           14.11.0049     N/A

  Status:           No matching image found
```

##### åˆ‡æ¢ IB/Ethernet æ¨¡å¼

é¦–å…ˆæŸ¥è¯¢å½“å‰è¿æ¥æ¨¡å¼:

```bash
mlxconfig -d /dev/mst/mt4103_pci_cr0 query

Device #1:
----------

Device type:    ConnectX3Pro
Device:         /dev/mst/mt4103_pci_cr0

Configurations:                                      Next Boot
         SRIOV_EN                                    True(1)
         NUM_OF_VFS                                  8
         LINK_TYPE_P1                                ETH(2)
         LINK_TYPE_P2                                ETH(2)
         LOG_BAR_SIZE                                3
         BOOT_PKEY_P1                                0
         BOOT_PKEY_P2                                0
         BOOT_OPTION_ROM_EN_P1                       True(1)
         BOOT_VLAN_EN_P1                             False(0)
         BOOT_RETRY_CNT_P1                           0
         LEGACY_BOOT_PROTOCOL_P1                     PXE(1)
         BOOT_VLAN_P1                                1
         BOOT_OPTION_ROM_EN_P2                       True(1)
         BOOT_VLAN_EN_P2                             False(0)
         BOOT_RETRY_CNT_P2                           0
         LEGACY_BOOT_PROTOCOL_P2                     PXE(1)
         BOOT_VLAN_P2                                1
         IP_VER_P1                                   IPv4(0)
         IP_VER_P2                                   IPv4(0)
         CQ_TIMESTAMP                                True(1)
```

å…¶ä¸­ **LINK_TYPE_P1** ä¸º ETH, ä¿®æ”¹ä¸º IB æ¨¡å¼:

```bash
mlxconfig -d /dev/mst/mt4103_pciconf0 set LINK_TYPE_P1=1
mlxconfig -d /dev/mst/mt4103_pciconf0 set LINK_TYPE_P2=1
```

1. IB æ¨¡å¼
2. ETH æ¨¡å¼
3. VPI æ¨¡å¼

##### IB ç»„ç½‘

```bash
# å®‰è£…ç›¸å…³ä¾èµ–
apt update
apt install -y infiniband-diags rdma-core ibverbs-providers perftest
```

**æ£€æŸ¥ InfiniBand è®¾å¤‡æ˜¯å¦å¯ç”¨**

```bash
ibstat

CA 'mlx4_0'
	CA type: MT4103
	Number of ports: 2
	Firmware version: 2.42.5700
	Hardware version: 0
	Node GUID: 0x88e9a4ffff1241a0
	System image GUID: 0x88e9a4ffff1241a3
	Port 1:
		State: Initializing
		Physical state: LinkUp
		Rate: 56
		Base lid: 0
		LMC: 0
		SM lid: 0
		Capability mask: 0x02514868
		Port GUID: 0x88e9a4ffff1241a1
		Link layer: InfiniBand
	Port 2:
		State: Down
		Physical state: Disabled
		Rate: 10
		Base lid: 0
		LMC: 0
		SM lid: 0
		Capability mask: 0x00010000
		Port GUID: 0x8ae9a4fffe1241a2
		Link layer: Ethernet
```

##### InfiniBand å­ç½‘ç®¡ç†å™¨

ibstat è¾“å‡ºæ˜¾ç¤º **Port 1 ä»ç„¶å¤„äº â€œInitializingâ€ çŠ¶æ€**ï¼Œè¯´æ˜ InfiniBand è¿æ¥è¿˜æ²¡æœ‰å®Œå…¨å»ºç«‹ï¼Œå› ä¸º InfiniBand ç½‘ç»œéœ€è¦ **Subnet Manager (SM)** æ¥ç®¡ç†è¿æ¥ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœç½‘ç»œä¸­æ²¡æœ‰è¿è¡Œ InfiniBand äº¤æ¢æœºï¼ˆæ”¯æŒ SMï¼‰ï¼Œåˆ™éœ€è¦åœ¨ **è‡³å°‘ä¸€å° PVE æœåŠ¡å™¨ä¸Šè¿è¡Œ SM**ã€‚

> æ‰€æœ‰ InfiniBand ç½‘ç»œéƒ½å¿…é¡»è¿è¡Œå­ç½‘ç®¡ç†å™¨æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚å³ä½¿ä¸¤å°æœºå™¨æ²¡æœ‰ä½¿ç”¨äº¤æ¢æœºç›´æ¥è¿›è¡Œè¿æ¥ï¼Œä¹Ÿæ˜¯å¦‚æ­¤ã€‚
>
> æœ‰å¯èƒ½æœ‰ä¸€ä¸ªä»¥ä¸Šçš„å­ç½‘ç®¡ç†å™¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€ä¸ª master å……å½“ä¸€ä¸ªä¸»å­ç½‘ç®¡ç†å™¨ï¼Œå¦ä¸€ä¸ªå­ç½‘ç®¡ç†å™¨å……å½“ä»å±å­ç½‘ç®¡ç†å™¨ï¼Œå½“ä¸»å­ç½‘ç®¡ç†å™¨å‡ºç°æ•…éšœæ—¶å°†æ¥ç®¡ã€‚
>
> Red Hat Enterprise Linux æä¾› `OpenSM`ï¼Œè¿™æ˜¯ InfiniBand å­ç½‘ç®¡ç†å™¨çš„å®ç°ã€‚ä½†æ˜¯ï¼Œ`Open` SM çš„åŠŸèƒ½æ˜¯æœ‰é™çš„ï¼Œæ²¡æœ‰æ´»è·ƒçš„ä¸Šæ¸¸å¼€å‘ã€‚é€šå¸¸ï¼ŒInfiniBand äº¤æ¢æœºä¸­åµŒå…¥çš„å­ç½‘ç®¡ç†å™¨æä¾›æ›´å¤šåŠŸèƒ½ï¼Œå¹¶æ”¯æŒæœ€æ–°çš„ InfiniBand ç¡¬ä»¶ã€‚è¯¦æƒ…è¯·æŸ¥çœ‹ [å®‰è£…å’Œé…ç½® OpenSM InfiniBand å­ç½‘ç®¡ç†å™¨](https://access.redhat.com/articles/7087953?extIdCarryOver=true&sc_cid=701f2000001Css5AAC)ã€‚

```bash
apt install -y opensm
systemctl enable --now opensm
```

```bash
$ ibstat
CA 'mlx4_0'
	CA type: MT4103
	Number of ports: 2
	Firmware version: 2.42.5700
	Hardware version: 0
	Node GUID: 0x88e9a4ffff1241a0
	System image GUID: 0x88e9a4ffff1241a3
	Port 1:
		State: Active
		Physical state: LinkUp
		Rate: 56
		Base lid: 1
		LMC: 0
		SM lid: 1
		Capability mask: 0x0251486a
		Port GUID: 0x88e9a4ffff1241a1
		Link layer: InfiniBand
	Port 2:
		State: Down
		Physical state: Disabled
		Rate: 10
		Base lid: 0
		LMC: 0
		SM lid: 0
		Capability mask: 0x00010000
		Port GUID: 0x8ae9a4fffe1241a2
		Link layer: Ethernet
```

ç°åœ¨æ˜¾ç¤ºè¿æ¥æ­£å¸¸, ä¸”è‡ªåŠ¨æ–°å¢äº†ä¸€ä¸ª IB ç½‘ç»œ:

```bash
ip a

...
5: ibp1s0: <BROADCAST,MULTICAST> mtu 4092 qdisc noop state DOWN group default qlen 256
    link/infiniband 80:00:02:08:fe:80:00:00:00:00:00:00:e4:1d:2d:03:00:4a:b0:c1 brd 00:ff:ff:ff:ff:12:40:1b:ff:ff:00:00:00:00:00:00:ff:ff:ff:ff
...
```

æ¥ä¸‹æ¥å°±æ˜¯é…ç½®é™æ€ IP, å°†ä¸¤å° PVE é€šè¿‡ IB ç½‘ç»œè¿æ¥.

##### IP over Infiniband

InfiniBand æ˜¯ä¸€ç§é«˜é€Ÿç½‘ç»œé€šä¿¡æŠ€æœ¯ï¼Œç”¨äºåœ¨è®¡ç®—æœºç³»ç»Ÿå’Œæ•°æ®ä¸­å¿ƒä¸­è¿æ¥é«˜æ€§èƒ½è®¡ç®—ã€å­˜å‚¨å’Œç½‘ç»œè®¾å¤‡ã€‚InfiniBand æä¾›äº†ä¸€ç§é«˜æ•ˆçš„ä½å»¶è¿Ÿå’Œé«˜å¸¦å®½çš„è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡ä½¿ç”¨ä¸“ç”¨ç¡¬ä»¶å’Œåè®®æ¥æé«˜æ•°æ®ä¼ è¾“çš„é€Ÿåº¦å’Œå¯é æ€§ã€‚ä¸ä¼ ç»Ÿçš„ä»¥å¤ªç½‘æŠ€æœ¯ç›¸æ¯”ï¼ŒInfiniBand æä¾›äº†æ›´é«˜çš„å¸¦å®½å’Œæ›´ä½çš„å»¶è¿Ÿã€‚

ç„¶è€Œï¼Œä¸æ˜¯æ‰€æœ‰çš„è½¯ä»¶éƒ½æ”¯æŒ Infinibandï¼Œå› æ­¤èµ‹äºˆ infiniband ä¸€ä¸ª IP åˆ™å¯ä»¥è®©å®ƒå…¼å®¹å¤§éƒ¨åˆ†çš„è½¯ä»¶åè®®ï¼Œè¿™ç§æ–¹æ³•å°±æ˜¯ IP over Infiniband(IPoIB)ã€‚

**HP544+**

```bash
auto ibp1s0
iface ibp1s0 inet static
    address 1.0.0.1
    netmask 255.255.255.0
    mtu 65520
# IB
```

**MCX354A-FCCT**

```bash
auto ibp1s0
iface ibp1s0 inet static
    address 1.0.0.2
    netmask 255.255.255.0
    mtu 65520
# IB
```

**è‡ªåŠ¨åŠ è½½æ¨¡å—**

```bash
vim /etc/modules

+ ib_ipoib
+ ib_umad
```

**é‡å¯ç½‘ç»œ**

```bash
ip link set ibp1s0 down && ip link set ibp1s0 up
```

**æµ‹è¯•**

```bash
ping -c 4 1.0.0.2  # åœ¨ PVE1 ä¸Š
ping -c 4 1.0.0.1  # åœ¨ PVE2 ä¸Š
```

**ibping æµ‹è¯•**

é¦–å…ˆåœ¨ HP544+ çš„æœåŠ¡å™¨(èŠ‚ç‚¹ä¸º **NUC**)ä¸Šå¯åŠ¨æœåŠ¡ç«¯:

```bash
ibping -S
```

ç„¶åæŸ¥è¯¢ç›¸å…³ä¿¡æ¯:

```bash
$ ibnetdiscover

#
# Topology file: generated on Tue Mar  4 14:51:01 2025
#
# Initiated from node e41d2d03004ab0c0 port e41d2d03004ab0c1

vendid=0x2c9
devid=0x1007
sysimgguid=0x88e9a4ffff1241a3
caguid=0x88e9a4ffff1241a0
Ca	2 "H-88e9a4ffff1241a0"		# "nuc mlx4_0"
[1](88e9a4ffff1241a1) 	"H-e41d2d03004ab0c0"[1] (e41d2d03004ab0c1) 		# lid 1 lmc 0 "alpha mlx4_0" lid 2 4xFDR

vendid=0x2c9
devid=0x1007
sysimgguid=0xe41d2d03004ab0c3
caguid=0xe41d2d03004ab0c0
Ca	2 "H-e41d2d03004ab0c0"		# "alpha mlx4_0"
[1](e41d2d03004ab0c1) 	"H-88e9a4ffff1241a0"[1] (88e9a4ffff1241a1) 		# lid 2 lmc 0 "nuc mlx4_0" lid 1 4xFDR
```

æ˜¾ç¤ºæœ‰ 2 ä¸ªèŠ‚ç‚¹, åˆ†åˆ«æ˜¯ **nuc(lid = 1)** å’Œ **alpha(lid = 2)**, æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨èŠ‚ç‚¹ **alpha** ä¸Šä½œä¸ºå®¢æˆ·ç«¯å¯åŠ¨æµ‹è¯•:

```bash
$ ibping -L 1
Pong from nuc.(none) (Lid 1): time 0.040 ms
Pong from nuc.(none) (Lid 1): time 0.057 ms
Pong from nuc.(none) (Lid 1): time 0.045 ms
```

##### æµ‹è¯• IB ç½‘ç»œé€Ÿåº¦

åœ¨ **NUC** èŠ‚ç‚¹ä¸Šè¿è¡Œ:

```bash
$ ib_send_bw -d ibp1s0 -i 1

************************************
* Waiting for client to connect... *
************************************
```

åœ¨ **Aplha** èŠ‚ç‚¹ä¸Šè¿è¡Œ:

```bash
$ ib_send_bw -d ibp1s0 -i 1 1.0.0.1
---------------------------------------------------------------------------------------
                    Send BW Test
 Dual-port       : OFF		Device         : mlx4_0
 Number of qps   : 1		Transport type : IB
 Connection type : RC		Using SRQ      : OFF
 PCIe relax order: ON
 ibv_wr* API     : OFF
 TX depth        : 128
 CQ Moderation   : 1
 Mtu             : 2048[B]
 Link type       : IB
 Max inline data : 0[B]
 rdma_cm QPs	 : OFF
 Data ex. method : Ethernet
---------------------------------------------------------------------------------------
 local address: LID 0x02 QPN 0x020a PSN 0x749791
 remote address: LID 0x01 QPN 0x021a PSN 0xbd4c28
---------------------------------------------------------------------------------------
 #bytes     #iterations    BW peak[MB/sec]    BW average[MB/sec]   MsgRate[Mpps]
Conflicting CPU frequency values detected: 4511.015000 != 800.000000. CPU Frequency is not max.
 65536      1000             5757.44            5757.29		   0.092117
---------------------------------------------------------------------------------------
```

BW é€Ÿç‡æ¥è¿‘ **56Gbps**ï¼Œè¯´æ˜ IB é€Ÿç‡æ­£å¸¸ã€‚

##### ä½¿ç”¨ RDMA æå‡ IB ç½‘ç»œæ€§èƒ½

```bash
modprobe ib_ipoib
echo "options ib_ipoib ipoib_cm=1" > /etc/modprobe.d/ib_ipoib.conf
update-initramfs -u
reboot
```

ç„¶åæ£€æŸ¥ RDMA æ˜¯å¦å¯ç”¨ï¼š

```bash
cat /sys/module/ib_ipoib/parameters/ipoib_cm
```

å¦‚æœè¿”å› Yï¼Œè¯´æ˜ RDMA å·²å¼€å¯ï¼Œå¯ä»¥è¿›ä¸€æ­¥æå‡ InfiniBand ç½‘ç»œæ€§èƒ½ ğŸš€

> æœåŠ¡å™¨æœ‰å¤šä¸ªç½‘å¡å¹¶ä¸”å·²ç»é…ç½®å¥½è¿è¡Œå½“ä¸­ï¼Œå´æ²¡è®°å¾— eth0ã€eth1ã€eth2â€¦..åˆ†åˆ«å¯¹åº”çš„æ˜¯å“ªä¸ªç‰©ç†çš„ç½‘å¡ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤
>
> ```bash
> ethtool -p eth0
> ```
>
> æ­¤æ—¶å°±ä¼šçœ‹åˆ° eth0 å¯¹åº”çš„ç‰©ç†å£ä¸€ä¸ªç¯åœ¨ä¸åœçš„**é—ªçƒ**

**å‚è€ƒ**:

- [ç”µè„‘ç¡¬ä»¶å­¦ä¹ ç¬”è®°-HP544+-å›ºä»¶](https://skyao.io/learning-computer-hardware/nic/hp544/firmware/mft/)
- [ZFS:ä» 10Gbps å‡çº§åˆ° 40Gbps ç½‘ç»œ](https://blog.xjn819.com/post/Upgrade-from-10Gbps-to-40Gbps-network.html)
- [å®¶ç”¨ä¸‡å…†ç½‘ç»œæŒ‡å— 1 - ä¸å¦‚å…ˆæ¥ä¸ªæœ€ç®€å•çš„ 100G ç½‘ç»œ](https://zhuanlan.zhihu.com/p/74082377)
- [HP544+ ç½‘å¡æµ‹é€Ÿ](https://skyao.io/learning-computer-hardware/nic/hp544/speedtest/)
- [åœ¨ PVE8 ä¸­ä½¿ç”¨ HPE 544+FLR(ConnectX-3 Pro)](https://xsl.sh/2023/09/pve8-hpe-544-flr/)
- [é…ç½® InfiniBand å’Œ RDMA ç½‘ç»œ](https://docs.redhat.com/zh-cn/documentation/red_hat_enterprise_linux/8/html-single/configuring_infiniband_and_rdma_networks/index)
- [ib ç½‘ç»œä¸­ NFS èµ° RDMA åè®®](http://bbs.keinsci.com/thread-26947-1-1.html)
- [Mellanox ç½‘å¡å®‰è£…æ•™ç¨‹](https://www.hua-hang.cn/case/292.html)

---

### 82599ES ç½‘å¡ å¼€å¯ SR-IOV

**å‚è€ƒ**

- [PVE8.X å¼€å¯ç½‘å¡ SR-IOV è™šæ‹ŸåŒ–--åŸºäºè‹±ç‰¹å°” Intel 82576 ç½‘å¡](https://yangwenqing.com/archives/1875/)
- [**PVE 7.x-8.x Proxmox VE 7 8 ç½‘å¡ Sriov å¼€å¯ ä¿å§†çº§æ•™ç¨‹**](https://www.bilibili.com/opus/929162659226452001)

## è¿æ¥ USB æ‘„åƒå¤´

```bash
$ lsusb

Bus 003 Device 004: ID 1bcf:2c6a Sunplus Innovation Technology Inc. 5M Cam
```

**åŠ è½½é©±åŠ¨**

```bash
modprobe uvcvideo
```

**æ£€æŸ¥æ‘„åƒå¤´è®¾å¤‡æ–‡ä»¶**

```bash
$ ls /dev/video*

/dev/video0  /dev/video1
```

**å®‰è£… v4l-utils**

v4l-utils æ˜¯ç”¨äºè§†é¢‘è®¾å¤‡çš„å·¥å…·ï¼Œå¯ä»¥æµ‹è¯•å’Œé…ç½®æ‘„åƒå¤´ï¼š

```bash
$ apt install v4l-utils

$ v4l2-ctl --list-devices
5M Cam: 5M Cam (usb-0000:00:14.0-6):
	/dev/video0
	/dev/video1
	/dev/media0
```

**æ¨æµ**:

```bash
ffmpeg -f v4l2 -i /dev/video0 -vcodec libx264 -preset ultrafast -tune zerolatency -f flv rtmp://192.168.31.7/live/stream
```

å¦‚æœéœ€è¦ä¿®æ”¹åˆ†è¾¨ç‡, æˆ‘ä»¬éœ€è¦å…ˆæ”¯æŒæ‘„åƒå¤´æ”¯æŒå“ªäº›åˆ†è¾¨ç‡:

```bash
$ v4l2-ctl --list-formats-ext
ioctl: VIDIOC_ENUM_FMT
	Type: Video Capture

	[0]: 'YUYV' (YUYV 4:2:2)
		Size: Discrete 640x480
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 800x600
			Interval: Discrete 0.067s (15.000 fps)
		Size: Discrete 320x240
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 352x288
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 1024x768
			Interval: Discrete 0.125s (8.000 fps)
		Size: Discrete 1280x720
			Interval: Discrete 0.100s (10.000 fps)
		Size: Discrete 1280x960
			Interval: Discrete 0.125s (8.000 fps)
		Size: Discrete 1600x1200
			Interval: Discrete 0.200s (5.000 fps)
		Size: Discrete 1920x1080
			Interval: Discrete 0.200s (5.000 fps)
		Size: Discrete 2592x1944
			Interval: Discrete 0.333s (3.000 fps)
		Size: Discrete 2048x1536
			Interval: Discrete 0.333s (3.000 fps)
	[1]: 'MJPG' (Motion-JPEG, compressed)
		Size: Discrete 640x480
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 800x600
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 320x240
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 352x288
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 1024x768
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 1280x720
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 1280x960
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 1600x1200
			Interval: Discrete 0.067s (15.000 fps)
		Size: Discrete 1920x1080
			Interval: Discrete 0.033s (30.000 fps)
		Size: Discrete 2592x1944
			Interval: Discrete 0.067s (15.000 fps)
		Size: Discrete 2048x1536
			Interval: Discrete 0.067s (15.000 fps)
```

### æ¨æµ

```bash
ffmpeg -f v4l2 -i /dev/video0 -vcodec libx264 -preset ultrafast -tune zerolatency -s 1280x720 -f flv rtmp://192.168.31.7/live/stream
```

**å‚æ•°è§£æï¼š**

**1. -f v4l2**

- **ä½œç”¨**ï¼šæŒ‡å®šè¾“å…¥æ ¼å¼ä¸º v4l2ï¼Œå³ä½¿ç”¨ Video4Linux2 é©±åŠ¨æ¥æ•è·è§†é¢‘æµã€‚

- **èƒŒæ™¯**ï¼šv4l2 æ˜¯ Linux ç³»ç»Ÿä¸­å¤„ç†è§†é¢‘è®¾å¤‡ï¼ˆä¾‹å¦‚ USB æ‘„åƒå¤´ï¼‰çš„è§†é¢‘é©±åŠ¨æ ‡å‡†ã€‚æ­¤å‚æ•°å‘Šè¯‰ ffmpeg ä½¿ç”¨ v4l2 é©±åŠ¨æ¥æ•è·æ‘„åƒå¤´çš„å®æ—¶è§†é¢‘æµã€‚

**2. -i /dev/video0**

- **ä½œç”¨**ï¼šæŒ‡å®šè¾“å…¥è§†é¢‘æºï¼Œè¿™é‡Œæ˜¯ /dev/video0ï¼Œè¡¨ç¤ºè¿æ¥çš„ USB æ‘„åƒå¤´è®¾å¤‡ã€‚

- **èƒŒæ™¯**ï¼šåœ¨ Linux ç³»ç»Ÿä¸­ï¼Œè§†é¢‘è®¾å¤‡é€šå¸¸ä»¥ /dev/videoX çš„å½¢å¼è¡¨ç¤ºï¼ˆX æ˜¯æ•°å­—ï¼‰ã€‚ä½ å¯ä»¥é€šè¿‡ ls /dev/video\* å‘½ä»¤æŸ¥çœ‹è®¾å¤‡åç§°ï¼Œé€šå¸¸ç¬¬ä¸€ä¸ªæ‘„åƒå¤´æ˜¯ /dev/video0ã€‚

**3. -vcodec libx264**

- **ä½œç”¨**ï¼šæŒ‡å®šè§†é¢‘ç¼–ç å™¨ä½¿ç”¨ libx264ï¼Œå³ H.264 ç¼–ç æ ¼å¼ã€‚

- **èƒŒæ™¯**ï¼šlibx264 æ˜¯ä¸€ç§é«˜æ•ˆçš„ H.264 è§†é¢‘ç¼–ç å™¨ï¼Œå¹¿æ³›ç”¨äºè§†é¢‘æµå’Œè§†é¢‘æ–‡ä»¶çš„å‹ç¼©ã€‚H.264 æ˜¯ç°ä»£è§†é¢‘æµåª’ä½“ä¸­çš„å¸¸è§ç¼–ç æ ¼å¼ï¼Œå› ä¸ºå®ƒå¯ä»¥æä¾›è¾ƒé«˜çš„å‹ç¼©æ•ˆç‡å’Œè´¨é‡ã€‚

**4. -preset ultrafast**

- **ä½œç”¨**ï¼šè®¾ç½®ç¼–ç é¢„è®¾ä¸º ultrafastï¼Œè¿™æ˜¯ä¸€ä¸ªç¼–ç é€Ÿåº¦æœ€å¿«çš„è®¾ç½®ï¼Œä½†ä¼šç‰ºç‰²ä¸€å®šçš„è§†é¢‘å‹ç¼©ç‡ã€‚

- **èƒŒæ™¯**ï¼špreset æ§åˆ¶ libx264 ç¼–ç çš„é€Ÿåº¦å’Œå‹ç¼©æ•ˆç‡ï¼Œé€‰æ‹©è¾ƒå¿«çš„ç¼–ç é¢„è®¾å¯ä»¥å‡å°‘å»¶è¿Ÿã€‚ultrafast æ˜¯æœ€å¿«çš„é¢„è®¾ï¼Œä½†ä¼šä½¿æ–‡ä»¶ä½“ç§¯ç›¸å¯¹è¾ƒå¤§ï¼Œé€‚åˆä½å»¶è¿Ÿçš„å®æ—¶æµã€‚

**5. -tune zerolatency**

- **ä½œç”¨**ï¼šä¼˜åŒ–ç¼–ç å™¨ä»¥å‡å°‘å»¶è¿Ÿã€‚

- **èƒŒæ™¯**ï¼štune é€‰é¡¹æ§åˆ¶ libx264 ç¼–ç å™¨çš„è°ƒä¼˜æ¨¡å¼ã€‚zerolatency æ˜¯ä¸€ç§ä¸“é—¨ç”¨äºä½å»¶è¿Ÿæµçš„è®¾ç½®ï¼Œé€‚ç”¨äºç›´æ’­ã€è§†é¢‘ä¼šè®®ç­‰å®æ—¶åº”ç”¨ã€‚

**6. -s 1280x720**

- **ä½œç”¨**ï¼šè®¾ç½®è¾“å‡ºè§†é¢‘çš„åˆ†è¾¨ç‡ä¸º 1280x720ã€‚

- **èƒŒæ™¯**ï¼š-s é€‰é¡¹ç”¨äºè®¾ç½®è¾“å‡ºè§†é¢‘çš„åˆ†è¾¨ç‡ï¼Œ1280x720 æ˜¯å¸¸è§çš„é«˜æ¸…åˆ†è¾¨ç‡ã€‚å¦‚æœä½ çš„æ‘„åƒå¤´æ”¯æŒæ›´é«˜çš„åˆ†è¾¨ç‡ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œè°ƒæ•´ã€‚

**7. -f flv**

- **ä½œç”¨**ï¼šè®¾ç½®è¾“å‡ºæ ¼å¼ä¸º flvï¼ˆFlash Video æ ¼å¼ï¼‰ã€‚

- **èƒŒæ™¯**ï¼šflv æ˜¯ä¸€ç§å¸¸ç”¨äºæµåª’ä½“ä¼ è¾“çš„æ ¼å¼ï¼Œå°¤å…¶æ˜¯åœ¨ RTMPï¼ˆReal-Time Messaging Protocolï¼‰æµåª’ä½“ä¼ è¾“ä¸­ã€‚å¤§éƒ¨åˆ†æµåª’ä½“æœåŠ¡å™¨ï¼ˆå¦‚ NGINX å’Œ RTMPï¼‰æ”¯æŒè¿™ç§æ ¼å¼ã€‚

**8. rtmp://192.168.31.7/live/stream**

- **ä½œç”¨**ï¼šæŒ‡å®š RTMP æœåŠ¡å™¨åœ°å€ã€‚

- **èƒŒæ™¯**ï¼šè¿™æ˜¯ä½ è¦æ¨é€æµçš„ RTMP æœåŠ¡å™¨åœ°å€ã€‚rtmp://192.168.31.7/live/stream è¡¨ç¤ºæ¨é€æµåˆ° IP åœ°å€ 192.168.31.7 ä¸Šçš„ live/stream è·¯å¾„ã€‚ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„æœåŠ¡å™¨åœ°å€å’Œè·¯å¾„è¿›è¡Œä¿®æ”¹ã€‚

---

## Cloud-init

**å‚è€ƒ**

- [åœ¨ PVE 8 ä¸­ä½¿ç”¨ Cloud-init åˆå§‹åŒ– ubuntu cloud-image å¹¶åˆ›å»ºæ¨¡æ¿](https://never666.uk/2107/)
- [ä¸€é”®å˜èº«ï¼Cloud-Init è®© PVE é•œåƒåä¸½è½¬èº«ï¼Œå¿«æ¥çœ‹çœ‹æ€ä¹ˆåšï¼](https://blog.csdn.net/sinat_28521487/article/details/140126760)

---

## ä½¿ç”¨åŸŸåå¹¶æ·»åŠ  SSL è¯ä¹¦

```bash
mkcert "alpha.pve" 192.168.1.119

mkcert -install
```

åœ¨ PVE æ§åˆ¶å°æ·»åŠ  SSL è¯ä¹¦: **ç³»ç»Ÿ->å‡­è¯**

åœ¨ Surge è®¾ç½®è‡ªå®šä¹‰ Hosts:

```bash
alpha.pve = 192.168.1.119
```

åœ¨ Surge è®¾ç½®è§„åˆ™:

```bash
[Rule]
DOMAIN-SUFFIX,*.pve,DIRECT
```

**å‚è€ƒ**

https://post.smzdm.com/p/an3on89p/

---

## è‡ªåˆ¶ CT æ¨¡ç‰ˆ

**æ¸…ç†æ— ç”¨è½¯ä»¶åŒ…**

```bash
apt autoremove -y --purge
apt clean
```

**æ¸…é™¤ DNS å’Œä¸»æœºåé…ç½®**

```bash
rm /etc/resolv.conf
rm /etc/hostname
```

**æ¸…é™¤æ“ä½œå‘½ä»¤**

```bash
history -c
```

#### åˆ›å»ºå®¹å™¨å¤‡ä»½

```bash
vzdump 100 --dumpdir /var/lib/vz/dump --compress zstd
```

**ç§»åŠ¨åˆ° CT æ¨¡æ¿ç›®å½•**

```bash
mv /var/lib/vz/dump/vzdump-lxc-100-2025_03_06-12_35_47.tar.zst /var/lib/vz/template/cache/ubuntu-24.04-base.tar.zst
```

**å‚è€ƒ**:

- [Ubuntu 22 ç¯å¢ƒåˆå§‹åŒ–](https://blog.hellowood.dev/posts/ubuntu-22-%E7%8E%AF%E5%A2%83%E5%88%9D%E5%A7%8B%E5%8C%96/)

- [Proxmox VE åˆ›å»ºè‡ªå®šä¹‰çš„ LXC å®¹å™¨ CT æ¨¡æ¿](https://blog.hellowood.dev/posts/proxmox-ve-%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84-lxc-%E5%AE%B9%E5%99%A8-ct-%E6%A8%A1%E6%9D%BF/)

---

## å¤‡ä»½

https://zhuanlan.zhihu.com/p/661921259

https://kb.synology.cn/zh-cn/DSM/tutorial/back_up_restore_proxmox_vm

- [Proxmox Backup Server](https://www.proxmox.com/en/products/proxmox-backup-server/overview)
- [ä½¿ç”¨ Proxmox Backup Server å¤‡ä»½ Proxmox VE çš„å®¢æˆ·æœºä¸å®¿ä¸»æœº](https://blog.men.ci/backup-pve-with-pbs/)

---

## é›†ç¾¤

### é€€å‡ºé›†ç¾¤

åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸Šæ‰§è¡Œä¸€é¢çš„å‘½ä»¤:

```bash
systemctl stop pve-cluster.service
systemctl stop corosync.service
pmxcfs -l
rm /etc/pve/corosync.conf
rm -rf /etc/corosync/*
killall pmxcfs
systemctl start pve-cluster.service
```

åœæ­¢ PVE å’Œé›†ç¾¤çš„æœåŠ¡ï¼Œå¹¶è®¾ç½®æœ¬æœºæ“ä½œçš„å®¿ä¸»ä¸ºã€Œæœ¬åœ°æ¨¡å¼ã€ï¼Œåˆ é™¤ä¹‹å‰çš„é›†ç¾¤é…ç½®æ–‡ä»¶å’Œè¿›ç¨‹ï¼Œå†æ¬¡å¯åŠ¨å•ç‹¬çš„ PVE æœåŠ¡ã€‚

è¿˜éœ€è¦åˆ é™¤æœ¬æœºä»¥å¤–çš„å…¶ä»–é›†ç¾¤èŠ‚ç‚¹ï¼ˆNodeï¼‰ï¼Œä»¥ä¾¿ä» Web UI ä¸­ç§»é™¤ï¼š

```
cd /etc/pve/nodes
rm -rf [æœ¬æœºä¹‹å¤–çš„å…¶ä»–èŠ‚ç‚¹]
```

---

## ä¼˜åŒ–

### åŠŸè€—èŠ‚èƒ½

**å‚è€ƒ**

- [**å›½å…‰çš„ PVE ç¯å¢ƒæ­å»ºæ•™ç¨‹**- CPU èŠ‚èƒ½æ¨¡å¼](https://pve.sqlsec.com/4/6/)

## é—®é¢˜æ±‡æ€»

### ERROR Verification failed: (0x1A) Security Violation

https://www.mculoop.com/thread-201-1-1.html

### daemons have recently crashed

**å‚è€ƒ**

https://blog.csdn.net/QTM_Gitee/article/details/106004435

---

## è¿ç»´è„šæœ¬

- [Proxmox_VE_Status](https://github.com/KoolCore/Proxmox_VE_Status)
- **[ProxmoxVE](https://github.com/community-scripts/ProxmoxVE)**
- [Make managing your Homelab a breeze](https://community-scripts.github.io/ProxmoxVE/)

## å‚è€ƒ

- [2024 å¹´ PVE8 æœ€æ–°å®‰è£…ä½¿ç”¨æŒ‡å—|æ–°æ‰‹å…¥é—¨|å®‰è£…|ä¼˜åŒ–|Proxmox VE 8.1](https://post.smzdm.com/p/akle62mk/)
- [NUC11 AIO æŠ˜è…¾å°è®°](https://taplus.me/nuc11-aio-tinkering/)

- [**å›½å…‰çš„ PVE ç¯å¢ƒæ­å»ºæ•™ç¨‹**](https://github.com/sqlsec/PVE)
- [PVE å­¦ä¹ ç¬”è®°](https://skyao.io/learning-pve/) https://github.com/skyao/learning-pve
- [PVE doc](https://pve.proxmox.com/pve-docs/)
- [é…ç½® & æ¢ç´¢ Proxmox VE WebGUI ç®¡ç†é¡µé¢](https://quentin-blog.vercel.app/post/2---proxmox-ve-webgui-)
- [PVE ç³»ç»Ÿæœ€ä½³å®è·µ](https://tendcode.com/subject/article/pve-used/)

---

## [Ubuntu ä½¿ç”¨å¤‡å¿˜å½•ï¼šå¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´](https://blog.dong4j.site/posts/91f73d3b.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ç®€ä»‹

å®¶ä¸­çš„æœåŠ¡å™¨æœ‰ 3 å°å…¨éƒ¨å®‰è£…çš„æ˜¯ Ubuntu, æœ‰æ—¶å€™éœ€è¦æŠ˜è…¾ä¸€ä¸‹.

æ‰€ä»¥æƒ³ç”¨ä¸€ä¸ªæ–‡æ¡£æ¥è®°å½• Ubuntu ä¸Šé‡åˆ°è¿‡çš„é—®é¢˜, å¦å¤–å°±æ˜¯åšä¸€ä¸ªå¤‡å¿˜å½•, å°†å·²æ“ä½œè¿‡çš„è®°å½•ä¿å­˜ä¸‹æ¥, ä»¥ä¾¿åœ¨å…¶ä»–æœåŠ¡å™¨ä¸Šé‡ç°, é¿å…é‡å¤æŸ¥è¯¢èµ„æ–™.

## ä¼˜åŒ–å»ºè®®

### å¯ç”¨ Ubuntu Pro

Ubuntu Pro æ˜¯ Canonical æä¾›çš„ä¼ä¸šçº§ä¸“ä¸šæ”¯æŒæœåŠ¡ï¼Œä¸ªäººç”¨æˆ·å’Œå°å›¢é˜Ÿå¯å…è´¹ä½¿ç”¨ï¼ˆæœ€å¤š 5 å°è®¾å¤‡ï¼Œè¶…è¿‡éœ€ä»˜è´¹ï¼‰ã€‚å®ƒæä¾›äº†é•¿è¾¾ 10 å¹´çš„å®‰å…¨æ›´æ–°æ”¯æŒã€‚

1 æ‰“å¼€ã€Œè½¯ä»¶å’Œæ›´æ–°ã€ï¼Œåˆ‡æ¢åˆ°ã€ŒUbuntu Proã€é€‰é¡¹å¡ã€‚

2 ç‚¹å‡»ã€Œå¯ç”¨ Ubuntu Proã€ã€‚

3 è®¿é—® [Ubuntu Pro Dashboard](https://ubuntu.com/pro/dashboard) æ‹¿åˆ°åˆ†é…ç»™ä½ çš„`Token`ï¼Œå¡«å…¥ã€Œæ‰‹åŠ¨æ·»åŠ ä»¤ç‰Œã€ä¸­ï¼Œç„¶åç‚¹å‡»ã€Œç¡®å®šã€ã€‚

![20250215174904_W7jq8Wuq.webp](https://cdn.dong4j.site/source/image/20250215174904_W7jq8Wuq.webp)

![20250215150635_1GJSbDWq.webp](https://cdn.dong4j.site/source/image/20250215150635_1GJSbDWq.webp)

### å‚è€ƒ

- [æ–°æ‰‹å¿…å¤‡ï¼šå®‰è£… Ubuntu 24.04 LTS åçš„ 10 é¡¹åŸºæœ¬å»ºè®®](https://www.sysgeek.cn/10-essential-tips-after-installing-ubuntu-24-04/)

### Landscape Server

**å‚è€ƒ:**

- [[Landscape å®‰è£…é…ç½®é€Ÿè®°](https://linux.do/t/topic/68022)](https://linux.do/t/topic/68022)

---

## ç³»ç»Ÿå…‹éš†

åŸæ¥çš„ç³»ç»Ÿå®‰è£…åœ¨ä¸€å— PCIe Gen3 x4 çš„ M.2 å›ºæ€ä¸Š, æŸ¥é˜…èµ„æ–™å¾—çŸ¥è¿™ä¸ªæ’æ§½æ”¯æŒ PCIe Gen4 x4, ä¸ºäº†ä¸æµªè´¹èµ„æº, æ‰€ä»¥éœ€è¦ä½¿ç”¨ä¸€å— PCIe Gen4 x4 çš„ M.2 å›ºæ€æ›¿æ¢åŸæ¥é‚£å—ç³»ç»Ÿç›˜, ä½†æ˜¯åˆä¸æƒ³é‡æ–°å®‰è£…ç³»ç»Ÿ, æ‰€ä»¥æƒ³é€šè¿‡ç³»ç»Ÿå…‹éš†çš„æ–¹å¼è¿ç§».

### ä½¿ç”¨ dd å‘½ä»¤

1. **å¤‡ä»½æ•°æ®**ï¼šåœ¨è¿›è¡Œå…‹éš†æ“ä½œä¹‹å‰ï¼Œç¡®ä¿ä½ å·²ç»å¤‡ä»½äº†é‡è¦æ•°æ®ï¼Œä»¥é˜²ä¸‡ä¸€ã€‚

2. **å…³é—­ç³»ç»Ÿ**ï¼šå…³é—­ä½ çš„ Ubuntu ç³»ç»Ÿï¼Œå¹¶æ’å…¥æ–°çš„ 1T M.2 å›ºæ€ç¡¬ç›˜ã€‚

3. **è¿›å…¥ Live ç¯å¢ƒ**ï¼šä½¿ç”¨ Ubuntu å®‰è£…ä»‹è´¨ï¼ˆå¦‚ USB å¯åŠ¨ç›˜ï¼‰å¯åŠ¨åˆ° Live ç¯å¢ƒã€‚

4. **æ‰“å¼€ç»ˆç«¯**ï¼šåœ¨ Live ç¯å¢ƒä¸­æ‰“å¼€ç»ˆç«¯ã€‚

5. **æŸ¥æ‰¾ç¡¬ç›˜æ ‡è¯†**ï¼šä½¿ç”¨`lsblk`æˆ–`fdisk -l`å‘½ä»¤æŸ¥æ‰¾æ–°æ—§ç¡¬ç›˜çš„æ ‡è¯†ï¼ˆä¾‹å¦‚`/dev/nvme0n1`å’Œ`/dev/nvme1n1`ï¼‰ã€‚

6. **å…‹éš†ç¡¬ç›˜**ï¼šä½¿ç”¨`dd`å‘½ä»¤è¿›è¡Œå…‹éš†ã€‚ä»¥ä¸‹å‘½ä»¤å°†æ—§ç¡¬ç›˜å…‹éš†åˆ°æ–°ç¡¬ç›˜ï¼š

   ```
   sudo dd if=/dev/nvme0n1 of=/dev/nvme1n1 bs=4M status=progress
   ```

   æ³¨æ„ï¼šæ­¤æ“ä½œå°†å…‹éš†æ•´ä¸ªç¡¬ç›˜ï¼ŒåŒ…æ‹¬ç©ºé—²ç©ºé—´ï¼Œå› æ­¤éœ€è¦æ—¶é—´è¾ƒé•¿ã€‚

7. **è°ƒæ•´åˆ†åŒºå¤§å°**ï¼šå…‹éš†å®Œæˆåï¼Œä½¿ç”¨`gparted`æˆ–`fdisk`è°ƒæ•´æ–°ç¡¬ç›˜çš„åˆ†åŒºå¤§å°ä»¥åˆ©ç”¨é¢å¤–çš„ç©ºé—´ã€‚

8. **æ›´æ–°å¼•å¯¼å™¨**ï¼šå¦‚æœéœ€è¦ï¼Œæ›´æ–°å¼•å¯¼å™¨é…ç½®ï¼Œä¾‹å¦‚ä½¿ç”¨`bootctl update`ã€‚

9. **é‡å¯ç³»ç»Ÿ**ï¼šé‡å¯ç³»ç»Ÿï¼Œä»æ–°ç¡¬ç›˜å¯åŠ¨ã€‚

#### å‚è€ƒ

- [Ubuntu ç¡¬ç›˜å…‹éš†å®Œå…¨æŒ‡å— é«˜æ•ˆå®ç°æ•°æ®å¤‡ä»½ä¸æ¢å¤](https://my.oschina.net/emacs_8850517/blog/17420517)
- [Ubuntu æ— æŸè¿ç§»ã€å…‹éš†ç³»ç»Ÿ](https://zhuanlan.zhihu.com/p/731828327)
- [Ubuntu æ•´ç³»ç»Ÿè¿ç§»åˆ°å¦ä¸€ä¸ªç¡¬ç›˜ä¸­](https://blog.csdn.net/weixin_51995147/article/details/136380218)
- [Ubuntu ç³»ç»Ÿè¿ç§»å®è·µ](https://www.gaitpu.com/os/linux/ubuntu-system-migration)
- [æ€ä¹ˆæŠŠ ubuntu ç§»æ¤åˆ° centos æ— ç•Œé¢ç³»ç»Ÿä¸­ ubuntu ç³»ç»Ÿè¿ç§»åˆ°æ–°ç¡¬ç›˜](https://blog.51cto.com/u_16099179/10728092)

### ä½¿ç”¨ç¾¤æ™–çš„ ABB

è¿™ä¸ªåº”è¯¥ç®—æ˜¯æœ€ç®€å•çš„æ–¹æ³•äº†, æ­£å¥½æˆ‘ä¹Ÿæœ‰ç¾¤æ™–, æ‰€ä»¥ç›´æ¥ä½¿ç”¨è¿™ç§æ–¹å¼æ¢å¤é•œåƒå³å¯.

#### å‚è€ƒ

- [ã€NASã€‘æ•´æœºå¤‡ä»½è¿˜åŸ Windows/Linux ç³»ç»Ÿï¼Œç¾¤æ™–æœ€å¼ºå¥—ä»¶ ABB æ•™ç¨‹](https://zhuanlan.zhihu.com/p/556955811)
- [å®ä½“ä¼ºæœå™¨å¤‡ä»½åŠè¿˜åŸ-Linux](https://kb.synology.com/zh-tw/DSM/help/ActiveBackup/activebackup_business_physicalserver_linux?version=7)
- [Active Backup for Business ç®¡ç†å‘˜æŒ‡å— - é€‚ç”¨äº Linux](https://kb.synology.cn/zh-cn/UG/Synology_ABB_admin_guide_Linux/5)

---

## KVM

{% folding green, KVM å¸¸ç”¨å‘½ä»¤ %}

**1. å®‰è£… KVM å’Œ libvirt**

é¦–å…ˆï¼Œç¡®ä¿å·²å®‰è£… KVM å’Œ libvirtï¼Œè¿™é€šå¸¸æ˜¯ç®¡ç† KVM è™šæ‹Ÿæœºçš„åŸºç¡€ï¼š

```
# å®‰è£… KVM å’Œ libvirt
sudo apt update
sudo apt install qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils

# å¯åŠ¨å¹¶å¯ç”¨ libvirt æœåŠ¡
sudo systemctl enable --now libvirtd
```

**2. è™šæ‹Ÿæœºç®¡ç†ï¼ˆä½¿ç”¨ virshï¼‰**

virsh æ˜¯ç®¡ç† KVM è™šæ‹Ÿæœºçš„å‘½ä»¤è¡Œå·¥å…·ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§å‘½ä»¤ï¼š

**2.1 åˆ—å‡ºæ‰€æœ‰è™šæ‹Ÿæœº**

åˆ—å‡ºæ‰€æœ‰è™šæ‹Ÿæœºï¼ŒåŒ…æ‹¬è¿è¡Œä¸­çš„å’Œå·²å…³é—­çš„è™šæ‹Ÿæœºï¼š

```
sudo virsh list --all
```

**2.2 å¯åŠ¨è™šæ‹Ÿæœº**

å¯åŠ¨æŒ‡å®šçš„è™šæ‹Ÿæœºï¼š

```
sudo virsh start <vm_name>
```

ä¾‹å¦‚ï¼š

```
sudo virsh start myvm
```

**2.3 åœæ­¢è™šæ‹Ÿæœº**

ä¼˜é›…åœ°å…³é—­è™šæ‹Ÿæœºï¼š

```
sudo virsh shutdown <vm_name>
```

å¦‚æœè™šæ‹Ÿæœºæœªå“åº”ï¼Œå¯ä»¥ä½¿ç”¨å¼ºåˆ¶åœæ­¢å‘½ä»¤ï¼š

```
sudo virsh destroy <vm_name>
```

**2.4 æŸ¥çœ‹è™šæ‹Ÿæœºçš„çŠ¶æ€**

æŸ¥çœ‹è™šæ‹Ÿæœºçš„è¯¦ç»†çŠ¶æ€ï¼š

```
sudo virsh dominfo <vm_name>
```

**2.5 æŸ¥çœ‹è™šæ‹Ÿæœºçš„æ§åˆ¶å°**

è¿æ¥åˆ°è™šæ‹Ÿæœºçš„æ§åˆ¶å°ï¼Œé€‚ç”¨äºå‘½ä»¤è¡Œç•Œé¢è™šæ‹Ÿæœºï¼š

```
sudo virsh console <vm_name>
```

**3. è™šæ‹Ÿæœºè‡ªå¯åŠ¨**

å¯ç”¨æˆ–ç¦ç”¨è™šæ‹Ÿæœºçš„è‡ªå¯åŠ¨ï¼ˆåœ¨ç³»ç»Ÿé‡å¯æ—¶è‡ªåŠ¨å¯åŠ¨è™šæ‹Ÿæœºï¼‰ï¼š

**3.1 å¯ç”¨è‡ªå¯åŠ¨**

```
sudo virsh autostart <vm_name>
```

**3.2 ç¦ç”¨è‡ªå¯åŠ¨**

```
sudo virsh autostart --disable <vm_name>
```

**3.3 æŸ¥çœ‹è‡ªå¯åŠ¨è™šæ‹Ÿæœºåˆ—è¡¨**

```
sudo virsh autostart --list
```

**4. åˆ›å»ºã€åˆ é™¤è™šæ‹Ÿæœº**

**4.1 åˆ›å»ºè™šæ‹Ÿæœº**

ä½¿ç”¨ XML é…ç½®æ–‡ä»¶åˆ›å»ºè™šæ‹Ÿæœºï¼š

```
sudo virsh create <xml_file>
```

ä¾‹å¦‚ï¼š

```
sudo virsh create /path/to/your/vm_config.xml
```

**4.2 åˆ é™¤è™šæ‹Ÿæœº**

åˆ é™¤è™šæ‹Ÿæœºå’Œå…³è”çš„é…ç½®æ–‡ä»¶ï¼š

```
sudo virsh undefine <vm_name> --remove-all-storage
```

**5. è™šæ‹Ÿæœºç£ç›˜ç®¡ç†**

**5.1 æŸ¥çœ‹è™šæ‹Ÿæœºç£ç›˜**

æŸ¥çœ‹è™šæ‹Ÿæœºçš„ç£ç›˜é…ç½®ï¼š

```
sudo virsh vol-list --pool default
```

**5.2 åˆ›å»ºè™šæ‹Ÿæœºç£ç›˜**

ä½¿ç”¨ qemu-img åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç¡¬ç›˜é•œåƒï¼š

```
qemu-img create -f qcow2 /path/to/disk_image.qcow2 20G
```

**5.3 å¢åŠ è™šæ‹Ÿæœºç£ç›˜å¤§å°**

å¢åŠ è™šæ‹Ÿæœºç£ç›˜çš„å¤§å°ï¼ˆä¾‹å¦‚å°†ç£ç›˜å¤§å°å¢åŠ  10GBï¼‰ï¼š

```
qemu-img resize /path/to/disk_image.qcow2 +10G
```

**6. ç½‘ç»œé…ç½®**

**6.1 æŸ¥çœ‹ç½‘ç»œæ¡¥æ¥é…ç½®**

åˆ—å‡ºæ‰€æœ‰è™šæ‹Ÿç½‘ç»œï¼š

```
sudo virsh net-list --all
```

**6.2 å¯ç”¨è™šæ‹Ÿç½‘ç»œ**

å¯ç”¨è™šæ‹Ÿç½‘ç»œï¼ˆä¾‹å¦‚é»˜è®¤çš„ default ç½‘ç»œï¼‰ï¼š

```
sudo virsh net-start default
```

**6.3 é…ç½®è™šæ‹Ÿç½‘ç»œ**

ä½¿ç”¨ virsh ç¼–è¾‘è™šæ‹Ÿç½‘ç»œçš„é…ç½®ï¼š

```
sudo virsh net-edit default
```

**7. å¤‡ä»½å’Œè¿ç§»è™šæ‹Ÿæœº**

**7.1 è™šæ‹Ÿæœºå¿«ç…§**

åˆ›å»ºè™šæ‹Ÿæœºçš„å¿«ç…§ï¼š

```
sudo virsh snapshot-create-as <vm_name> <snapshot_name>
```

**7.2 è¿ç§»è™šæ‹Ÿæœº**

è¿ç§»è™šæ‹Ÿæœºåˆ°å¦ä¸€å°ä¸»æœºï¼ˆéœ€è¦ libvirt æ”¯æŒè¿ç§»ï¼‰ï¼š

```
sudo virsh migrate --live <vm_name> qemu+ssh://<user>@<remote_host>/system
```

**8. ä½¿ç”¨ virt-managerï¼ˆå›¾å½¢ç•Œé¢ï¼‰**

**8.1 å®‰è£… virt-manager**

åœ¨ Ubuntu ä¸Šå®‰è£… virt-managerï¼š

```
sudo apt install virt-manager
```

**8.2 å¯åŠ¨ virt-manager**

è¿è¡Œ virt-manager å›¾å½¢ç•Œé¢ï¼Œç®¡ç†è™šæ‹Ÿæœºï¼š

```
virt-manager
```

é€šè¿‡å›¾å½¢ç•Œé¢ï¼Œä½ å¯ä»¥åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢è™šæ‹Ÿæœºï¼ŒæŸ¥çœ‹æ—¥å¿—ã€èµ„æºä½¿ç”¨æƒ…å†µç­‰ã€‚

**9. ç›‘æ§è™šæ‹Ÿæœºèµ„æºä½¿ç”¨æƒ…å†µ**

**9.1 æŸ¥çœ‹è™šæ‹Ÿæœºçš„ CPUã€å†…å­˜å’Œç£ç›˜ä½¿ç”¨æƒ…å†µ**

```
sudo virsh stats <vm_name>
```

**9.2 æŸ¥çœ‹è™šæ‹Ÿæœºçš„å®æ—¶æ€§èƒ½æ•°æ®**

ä½ å¯ä»¥ä½¿ç”¨ virt-top å‘½ä»¤æ¥å®æ—¶æŸ¥çœ‹è™šæ‹Ÿæœºçš„æ€§èƒ½ï¼š

```
sudo virt-top
```

**10. å®‰è£…è™šæ‹Ÿæœºæ“ä½œç³»ç»Ÿ**

é€šè¿‡ virt-install å®‰è£…ä¸€ä¸ªæ–°è™šæ‹Ÿæœºæ“ä½œç³»ç»Ÿï¼š

```
sudo virt-install \
  --name <vm_name> \
  --vcpus 2 \
  --memory 2048 \
  --cdrom /path/to/iso_file.iso \
  --disk size=20 \
  --os-type linux \
  --os-variant ubuntu20.04
```

{% endfolding %}

---

## Cockpit

https://cockpit-project.org/

```bash
# ä¸»æœåŠ¡
sudo apt install cockpit
# KVM ç®¡ç†æ’ä»¶
sudo apt install cockpit-machines
```

### Docker

Cockpit å¼ºæ¨ Podman å®¹å™¨ï¼ŒDocker ç®¡ç†æ’ä»¶åœ¨å¾ˆæ—©ä¹‹å‰å°±æ²¡æœ‰ç»´æŠ¤äº†ã€‚å¥½åœ¨æ°‘é—´æœ‰ç»´æŠ¤ä¸€ä¸ªå¯ç”¨ç‰ˆæœ¬ï¼š[chabad360/cockpit-docker: Cockpit UI for docker containers (ported from cockpit-podman) (github.com)](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fchabad360%2Fcockpit-docker)ã€‚

```bash
git clone git@github.com:chabad360/cockpit-docker.git \
	&& cd cockpit-docker \
	&& export NODE_ENV=production \
	&& make \
	&& sudo make install
```

`sudo make install` å°†åŒ…å®‰è£…åˆ° usr/local/share/cockpit/ã€‚è¿™ä¾èµ–äº dist ç›®æ ‡ï¼Œè¯¥ç›®æ ‡ç”Ÿæˆåˆ†å‘å‹ç¼©åŒ…ã€‚ä½ ä¹Ÿå¯ä»¥è¿è¡Œ make rpm æ¥æ„å»ºæœ¬åœ°å®‰è£…çš„ RPMã€‚

åœ¨ç”Ÿäº§æ¨¡å¼ä¸‹ï¼Œæºæ–‡ä»¶ä¼šè‡ªåŠ¨å‹ç¼©å’Œæ··æ·†ã€‚å¦‚æœä½ æƒ³å¤åˆ¶è¿™ä¸ªè¡Œä¸ºï¼Œè¯·è®¾ç½® NODE_ENV=productionã€‚

[å…¶ä»–æ’ä»¶åˆ—è¡¨](https://cockpit-project.org/applications.html)

### Sensors

```bash
wget https://github.com/ocristopfer/cockpit-sensors/releases/latest/download/cockpit-sensors.tar.xz && \
  tar -xf cockpit-sensors.tar.xz cockpit-sensors/dist && \
  mv cockpit-sensors/dist /usr/share/cockpit/sensors && \
  rm -r cockpit-sensors && \
  rm cockpit-sensors.tar.xz
```

## è½¯ä»¶æ›´æ–°-ç£ç›˜ç©ºé—´ä¸è¶³

æœ‰ä¸€å¤©ä¸»æœº `/boot` ç©ºé—´åˆ†é…å¤ªå°‘äº†, ä¸€åˆ°æ›´æ–°å°±æŠ¥ `ç£ç›˜ç©ºé—´ä¸è¶³`:

> æ­¤å‡çº§ä¸€å…±éœ€è¦ 188 M çš„ç©ºé—²ç©ºé—´ï¼Œç£ç›˜ä¸º "/boot"ã€‚è¯·é¢å¤–é‡Šæ”¾è‡³å°‘ 69.5 M çš„ "/boot" ç£ç›˜ç©ºé—´ã€‚æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨ "sudo apt remove"å‘½ä»¤ç§»é™¤æ—§å†…æ ¸ï¼Œè¿˜å¯ä»¥åœ¨ /etc/initramfs-tools/initramfs.conf ä¸­æ·»åŠ â€œset COMPRESS=xz"é€‰é¡¹æ¥å‡å°‘ initramfs çš„å¤§å°ã€‚

### åˆ é™¤æ—§å†…æ ¸

```bash
$ uname -r
6.8.0-48-generic

# dong4j @ station in ~/cockpit-docker on git:main o [16:35:06]
$ dpkg --list | grep linux-image
ii  linux-image-6.8.0-45-generic     6.8.0-45.45~22.04.1                     amd64        Signed kernel image generic
ii  linux-image-6.8.0-48-generic     6.8.0-48.48~22.04.1                     amd64        Signed kernel image generic
ii  linux-image-generic-hwe-22.04    6.8.0-48.48~22.04.1                     amd64        Generic Linux kernel image

# åˆ é™¤æ—§å†…æ ¸
sudo apt remove --purge linux-image-6.8.0-45-generic
# æ¸…ç†æ— ç”¨ä¾èµ–
sudo apt autoremove --purge

# åˆ é™¤æ—§å†…æ ¸åï¼Œæ›´æ–° initramfs æ–‡ä»¶ä»¥ç¡®ä¿å½“å‰å†…æ ¸çš„æ–‡ä»¶æ˜¯æœ€æ–°çš„
sudo update-initramfs -u
```

### å‹ç¼©å‡å°‘ initramfs æ–‡ä»¶å¤§å°

ç¼–è¾‘ `/etc/initramfs-tools/initramfs.conf` æ–‡ä»¶ï¼Œæ·»åŠ  `set COMPRESS=xz `æ¥å‹ç¼© `initramfs` æ–‡ä»¶ï¼Œä»è€Œå‡å°‘ç©ºé—´å ç”¨ã€‚

**ç¼–è¾‘ initramfs.conf æ–‡ä»¶**

```bash
sudo vim /etc/initramfs-tools/initramfs.conf

COMPRESS=xz

# æ›´æ–° initramfs
sudo update-initramfs -u
```

### è‡ªåŠ¨æ¸…ç†æ—§å†…æ ¸

```bash
sudo apt install byobu
sudo byobu-disable
```

### boot æ‰©å®¹

å‚è€ƒ:

- [Ubuntu boot åˆ†åŒºæ‰©å®¹åŠåˆ†åŒºå»ºè®®](https://www.cnblogs.com/ldylan/p/14238205.html)
- [è§£å†³/boot ç©ºé—´ä¸è¶³é—®é¢˜](https://blog.csdn.net/TengYun_zhang/article/details/121858598)
- [Linux boot å’Œæ ¹ç›®å½•æ‰©å®¹](https://www.cnblogs.com/monkey6/p/18121267)

---

## Speedtest

æ¥æº: https://u.sb/debian-speedtest/

### å®‰è£… Speedtest CLI

[Speedtest CLI](https://www.speedtest.net/apps/cli) æ˜¯ [Ookla](https://www.speedtest.net/) å®˜æ–¹æ¨å‡ºçš„ Linux / BSD ä¸‹çš„ CLI å·¥å…·ï¼Œæ–¹ä¾¿æˆ‘ä»¬åœ¨æœåŠ¡å™¨é‡Œç›´æ¥æµ‹è¯•å…¬ç½‘å¸¦å®½é€Ÿåº¦ã€‚

é¦–å…ˆï¼Œå¯¼å…¥ GPG Key å¹¶æ·»åŠ æºï¼š

```bash
apt install -y lsb-release ca-certificates apt-transport-https curl gnupg dpkg
curl -sSL https://packagecloud.io/ookla/speedtest-cli/gpgkey | gpg --dearmor > /usr/share/keyrings/speedtest.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/speedtest.gpg] https://packagecloud.io/ookla/speedtest-cli/ubuntu/ $(lsb_release -sc) main" > /etc/apt/sources.list.d/speedtest.list
```

ç„¶åæ›´æ–°ç³»ç»Ÿå¹¶å®‰è£… `speedtest`ï¼š

```bash
apt update
apt install speedtest -y
```

### ä½¿ç”¨ Speedtest CLI

å®‰è£…å®Œæ¯•åæˆ‘ä»¬å³å¯ä½¿ç”¨é»˜è®¤çš„ `speedtest` å‘½ä»¤é€‰æ‹©æœ€è¿‘çš„èŠ‚ç‚¹å¹¶ä½¿ç”¨é»˜è®¤çš„ç½‘ç»œæµ‹é€Ÿï¼Œæç¤º `Do you accept the license? [type YES to accept]` æ—¶ï¼Œè¾“å…¥ `YES` å¹¶å›è½¦å³å¯ï¼š

![20250216223018_cLmr6owe.webp](https://cdn.dong4j.site/source/image/20250216223018_cLmr6owe.webp)

### é«˜çº§ç”¨æ³•

è¾“å…¥ `speedtest -h` å³å¯æŸ¥çœ‹ `speedtest` çš„å‘½ä»¤å‚æ•°ï¼š

```bash
root@debian ~ # speedtest -h
Speedtest by Ookla is the official command line client for testing the speed and performance of your internet connection.

Version: speedtest 1.1.1.28

Usage: speedtest [<options>]
  -h, --help                        Print usage information
  -V, --version                     Print version number
  -L, --servers                     List nearest servers
  -s, --server-id=#                 Specify a server from the server list using its id
  -I, --interface=ARG               Attempt to bind to the specified interface when connecting to servers
  -i, --ip=ARG                      Attempt to bind to the specified IP address when connecting to servers
  -o, --host=ARG                    Specify a server, from the server list, using its host's fully qualified domain name
  -p, --progress=yes|no             Enable or disable progress bar (Note: only available for 'human-readable'
                                    or 'json' and defaults to yes when interactive)
  -P, --precision=#                 Number of decimals to use (0-8, default=2)
  -f, --format=ARG                  Output format (see below for valid formats)
      --progress-update-interval=#  Progress update interval (100-1000 milliseconds)
  -u, --unit[=ARG]                  Output unit for displaying speeds (Note: this is only applicable
                                    for â€˜human-readableâ€™ output format and the default unit is Mbps)
  -a                                Shortcut for [-u auto-decimal-bits]
  -A                                Shortcut for [-u auto-decimal-bytes]
  -b                                Shortcut for [-u auto-binary-bits]
  -B                                Shortcut for [-u auto-binary-bytes]
      --selection-details           Show server selection details
      --ca-certificate=ARG          CA Certificate bundle path
  -v                                Logging verbosity. Specify multiple times for higher verbosity
      --output-header               Show output header for CSV and TSV formats

 Valid output formats: human-readable (default), csv, tsv, json, jsonl, json-pretty

 Machine readable formats (csv, tsv, json, jsonl, json-pretty) use bytes as the unit of measure with max precision

 Valid units for [-u] flag:
   Decimal prefix, bits per second:  bps, kbps, Mbps, Gbps
   Decimal prefix, bytes per second: B/s, kB/s, MB/s, GB/s
   Binary prefix, bits per second:   kibps, Mibps, Gibps
   Binary prefix, bytes per second:  kiB/s, MiB/s, GiB/s
   Auto-scaled prefix: auto-binary-bits, auto-binary-bytes, auto-decimal-bits, auto-decimal-bytes
```

æ¯”è¾ƒå®ç”¨çš„æœ‰ï¼š

æŒ‡å®šå‡ºå£ç½‘å¡ï¼š

```bash
speedtest -I æŒ‡å®šç½‘å¡åç§°
```

æŒ‡å®šå‡ºå£ IPï¼š

```bash
speedtest -i IP åœ°å€
```

_æ³¨æ„æŒ‡å®šç½‘å¡æˆ– IP åå¯èƒ½ä¼šå‡ºç° `[error] Error: [0] Cannot open socket` çš„é”™è¯¯æç¤ºï¼Œå¿½ç•¥å³å¯ã€‚_

æŸ¥çœ‹é™„è¿‘çš„æµ‹é€ŸèŠ‚ç‚¹åˆ—è¡¨ï¼š

```bash
speedtest -L
```

æŒ‡å®šæŸä¸ªæµ‹é€ŸèŠ‚ç‚¹ï¼š

```bash
speedtest -s æµ‹é€ŸèŠ‚ç‚¹ ID
```

## systemd-networkd-wait-online.service

å¦‚æœç”¨ `netplan` æ§åˆ¶ç½‘ç»œè®¾å¤‡ï¼ŒåŒæ—¶æŠŠè®¾å¤‡è®¾ç½®æˆå›ºå®š ipã€‚å¦‚æœå¯¹åº”çš„è®¾å¤‡ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆåœ¨ç³»ç»Ÿå¯åŠ¨å `systemd-networkd-wait-online.service` å°±ä¼šå¡ä½å‡ åˆ†é’Ÿï¼Œå¯¼è‡´åç»­çš„æœåŠ¡æ— æ³•æ‰§è¡Œã€‚

è¿™ä¸ªé—®é¢˜æœ‰å¤šç§æ–¹å¼å¯ä»¥è§£å†³:

1. å¦‚ä½•ä½¿ç”¨ `NetworkManager` ç®¡ç†ç½‘ç»œ, å¯ä»¥åœ¨ `netplan` é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  `renderer: NetworkManager`;

2. ä¿®æ”¹ `systemd-networkd-wait-online.service` çš„è¶…æ—¶æ—¶é—´:

   ```bash
   [Service]
   ExecStart=
   ExecStart=/usr/lib/systemd/systemd-networkd-wait-online --timeout=5
   ```

3. ä½¿ç”¨ `NetworkManager-wait-online.service` ä»£æ›¿;

å› ä¸ºæˆ‘å·²ç»ä½¿ç”¨ `NetworkManager` æ¥æ¥ç®¡ç½‘ç»œäº†, æ‰€ä»¥å®Œå…¨å¯ä»¥ç¦ç”¨ `systemd-networkd-wait-online.service`, è€Œä¸” `NetworkManager` ä¹Ÿè‡ªå¸¦ä¸€ä¸ª `NetworkManager-wait-online.service`, å¯ä»¥é¿å…ä¾èµ–ç½‘ç»œçš„è‡ªå¯åŠ¨æœåŠ¡åœ¨å¯åŠ¨æ—¶å‡ºç°é—®é¢˜:

```bash
sudo systemctl disable systemd-networkd-wait-online.service \
	&& sudo systemctl mask systemd-networkd-wait-online.service \
	&& sudo systemctl stop systemd-networkd-wait-online.service
```

> `systemd mask` çš„ä½œç”¨æ˜¯ **å½»åº•å±è”½ä¸€ä¸ªæœåŠ¡ï¼Œé˜²æ­¢å®ƒè¢«å¯åŠ¨**ï¼Œå³ä½¿å…¶ä»–æœåŠ¡æˆ–ä¾èµ–é¡¹å°è¯•å¯åŠ¨å®ƒï¼Œä¹Ÿä¸ä¼šç”Ÿæ•ˆã€‚
>
> | æ“ä½œ      | ä½œç”¨         | æ˜¯å¦å¯ä»¥è¢«æ‰‹åŠ¨å¯åŠ¨ï¼Ÿ      | ä¾èµ–çš„æœåŠ¡èƒ½å¦å¯åŠ¨å®ƒï¼Ÿ |
> | --------- | ------------ | ------------------------- | ---------------------- |
> | `disable` | å–æ¶ˆå¼€æœºè‡ªå¯ | âœ… å¯ä»¥ `systemctl start` | âœ… å…¶ä»–æœåŠ¡å¯ä»¥å¯åŠ¨    |
> | `mask`    | å®Œå…¨å±è”½     | âŒ æ— æ³•æ‰‹åŠ¨ `start`       | âŒ å…¶ä»–æœåŠ¡æ— æ³•å¯åŠ¨    |
>
> **ç®€å•ç†è§£ï¼š**
>
> - disable **åªæ˜¯ç¦æ­¢å¼€æœºè‡ªå¯**ï¼Œä½†ä»ç„¶å¯ä»¥æ‰‹åŠ¨æˆ–è¢«å…¶ä»–æœåŠ¡è°ƒç”¨å¯åŠ¨ã€‚
> - mask **å½»åº•å±è”½**ï¼Œå³ä½¿ä½ æ‰‹åŠ¨ systemctl start ä¹Ÿä¸ä¼šå¯åŠ¨ï¼Œä¼šæŠ¥é”™ï¼š
>
> ```bash
> Failed to start systemd-networkd-wait-online.service: Unit is masked.
> ```
>
> **åº”ç”¨åœºæ™¯**:
>
> å¯ä»¥ç”¨ mask æ¥å±è”½é‚£äº› **ä½ ä¸éœ€è¦ä¸”å¯èƒ½å¹²æ‰°ç³»ç»Ÿ** çš„æœåŠ¡ï¼Œæ¯”å¦‚ï¼š
>
> 1. **systemd-networkd-wait-online.service å½±å“å¯åŠ¨é€Ÿåº¦**ï¼ˆå¦‚æœä½ ç”¨ NetworkManager ï¼‰
> 2. **systemd-resolved.service å†²çª**ï¼ˆå¦‚æœä½ ç”¨ dnsmasq ï¼‰
> 3. **æŸäº›è‡ªåŠ¨æ›´æ–°æœåŠ¡**ï¼ˆå¦‚æœä¸å¸Œæœ›å®ƒä»¬è¿è¡Œï¼‰

### å‚è€ƒ:

- [systemd-networkd-wait-online æ‹–æ…¢ Ubuntu 18.04 äº‘ä¸»æœºå¼€æœºçš„æ’æŸ¥æ‰‹è®°](https://xzclip.cn/tech-records/systemd-networkd-wait-online-stuck-boot-ubuntu-1804/)

## [ä½¿ç”¨ Cloudflare å¢å¼ºå…¬ç½‘æœåŠ¡å®‰å…¨æ€§çš„å®è·µ](https://blog.dong4j.site/posts/5fa20a9e.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ç®€ä»‹

å‰å‡ å¤©åœ¨ Cloudflare ä¸Šä¹°äº†ä¸€ä¸ª dev åŸŸå, æƒ³ç€ä½¿ç”¨ Cloudflare å¼ºå¤§çš„ proxy åŠŸèƒ½å¢åŠ æš´éœ²åˆ°å…¬ç½‘æœåŠ¡çš„å®‰å…¨æ€§, ä»Šå¤©å°è¯•äº†ä¸€ä¸‹, æ„Ÿè§‰åŸºæœ¬æ»¡è¶³è¦æ±‚, ä¸‹é¢è¯´è¯´æŠ˜è…¾è¿‡ç¨‹.

## ç°çŠ¶

![20250213003153_vrv0wkOy.webp](https://cdn.dong4j.site/source/image/20250213003153_vrv0wkOy.webp)

ä¸Šå›¾æ˜¯ç°åœ¨çš„æµé‡è·¯å¾„:

1. è·¯ç”±å™¨å°† `1000` ç«¯å£çš„æµé‡å…¨éƒ¨è½¬å‘åˆ°é›·æ±  WAF æ‰€åœ¨çš„æœåŠ¡å™¨ä¸Š(192.168.1.2:1000);
2. é›·æ±  WAF çš„ 1000 ç«¯å£é…ç½®äº† HTTPS è¯ä¹¦, ç„¶ååœ¨åå‘ä»£ç†åˆ°å±€åŸŸç½‘å†…çœŸå®çš„æœåŠ¡å™¨ä¸Š;

ç°åœ¨çš„é—®é¢˜æ˜¯å¯ä»¥é€šè¿‡æš´éœ²å‡ºå»çš„åŸŸåå¾—åˆ°æˆ‘çœŸå®çš„å…¬ç½‘ IP åœ°å€, è™½ç„¶å…¬ç½‘ IP ä¼šä¸å®šæœŸå˜æ›´, ä½†æ˜¯æ„Ÿè§‰è¿˜ä¸æ˜¯ç‰¹åˆ«å®‰å…¨, æ‰€ä»¥æ‰“ç®—ä½¿ç”¨ Cloudflare æ¥å¢åŠ å®‰å…¨é˜²æŠ¤.

## ä½¿ç”¨ Cloudflare

æˆ‘è¿™é‡Œä»¥åœ¨å¤–ç½‘è®¿é—®å®¶ä¸­çš„ NAS ä¸ºä¾‹, æ–¹ä¾¿ç†è§£.

![20250213004537_s0Ig2NR4.webp](https://cdn.dong4j.site/source/image/20250213004537_s0Ig2NR4.webp)

æˆ‘é¢„æœŸçš„æ•ˆæœä¸º **é€šè¿‡ https://nas.dong4j.dev è®¿é—®å®¶ä¸­çš„ NAS**.

æˆ‘ä»¬éƒ½çŸ¥é“å®¶ç”¨å®½å¸¦çš„ 80 å’Œ 443 ç«¯å£æ˜¯è¢«è¿è¥å•†å°äº†çš„, ä¸ºäº†å®ç°ä¸Šé¢çš„æ•ˆæœ, æˆ‘ä»¬éœ€è¦å¯¹ CloudFlare æœ‰ä¸ªåŸºç¡€çš„äº†è§£.

---

### CloudFlare CDN æ”¯æŒçš„ç«¯å£

åœ¨æˆ‘ä»¬ä½¿ç”¨ CloudFlare CDN çš„æ—¶å€™ï¼Œå¯¹å…¶ CDN æ”¯æŒçš„ä¸€äº›ç«¯å£ä¸å¤ªç†Ÿæ‚‰ã€‚ä»¥ä¸º CloudFlare æ˜¯åªå…è®¸ 80/443 ç«¯å£èµ° CDN çš„ã€‚å…¶å®ä¸ç„¶ï¼ŒCloudFlare æœ‰ä¸€äº›ç«¯å£æ˜¯å…è®¸ HTTP/HTTPS æµé‡èµ° CDN çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒCloudflare ä¼šä»£ç†å‘å¾€ä¸‹é¢åˆ—å‡ºçš„ HTTP/HTTPS ç«¯å£çš„æµé‡:

| **HTTP ç«¯å£** | **HTTPS ç«¯å£** | **ç¦ç”¨ç¼“å­˜çš„ç«¯å£** |
| ------------- | -------------- | ------------------ |
| 80            | 443            | 2052               |
| 8080          | 2053           | 2053               |
| 8880          | 2083           | 2082               |
| 2052          | 2087           | 2083               |
| 2082          | 2096           | 2086               |
| 2086          | 8443           | 2087               |
| 2095          |                | 2095               |
|               |                | 2096               |
|               |                | 8880               |
|               |                | 8443               |

æ„æ€æ˜¯å‡è®¾ `nas.dong4j.dev` å¯¹åº”çš„ IP ä¸º `11.11.11.11`, å½“æˆ‘ä»¬è®¿é—® `https://nas.dong4j.dev:2053` æ—¶, ä¼šè¢«ä»£ç†åˆ° `https://11.11.11.11:2053`, ä½†æ˜¯ä¸å†ä¸Šè¿°åˆ—è¡¨çš„ç«¯å£åˆ™æ— æ³•ä»£ç†, æ¯”å¦‚ `https://nas.dong4j.dev:12053`

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ç‚¹æ¥ä»£ç†æˆ‘ä»¬å†…ç½‘çš„æœåŠ¡:

![20250213112400_2psIANxI.webp](https://cdn.dong4j.site/source/image/20250213112400_2psIANxI.webp)

**è·¯ç”±å™¨ç«¯å£è½¬å‘é…ç½®:**

![20250213112522_V7f18YZR.webp](https://cdn.dong4j.site/source/image/20250213112522_V7f18YZR.webp)

**é›·æ± ä»£ç†é…ç½®**

![20250213112754_qL4jNqd7.webp](https://cdn.dong4j.site/source/image/20250213112754_qL4jNqd7.webp)

å®Œæˆåæˆ‘ä»¬å³å¯é€šè¿‡ `https://nas.dong4j.dev:8443` è®¿é—®å†…ç½‘çš„ NAS.

![20250213113556_3IB6zEr0.webp](https://cdn.dong4j.site/source/image/20250213113556_3IB6zEr0.webp)

ä½†æˆ‘ä»¬æœ€ç»ˆçš„ç›®çš„æ˜¯ä½¿ç”¨ `https://nas.dong4j.dev`, å³åœ¨ä¸åŠ ç«¯å£çš„æƒ…å†µä¸‹è®¿é—®, è¿™é‡Œå°±è¦ä½¿ç”¨ Cloudflare çš„ Origin Rules.

### Cloudflare çš„ Rules

Cloudflare åŒ…å«äº†ä¼—å¤šçš„ Rules, ç›¸å½“äºè¿‡æ»¤å™¨èƒ½å¯¹è¿›å…¥çš„æµé‡æŒ‰ç…§è§„åˆ™ä¸€æ­¥ä¸€æ­¥å¤„ç†:

![20250213114150_xF30VFzi.webp](https://cdn.dong4j.site/source/image/20250213114150_xF30VFzi.webp)

ä¸ºäº†å®ç°ä¸Šè¿°éœ€æ±‚, æˆ‘ä»¬æœ‰å¤šç§æ–¹å¼:

#### Page Rules

![20250213115101_NT2lFPKB.webp](https://cdn.dong4j.site/source/image/20250213115101_NT2lFPKB.webp)

å°† `https://tonas.dong4j.dev` é‡å®šå‘åˆ° `https://nas.dong4j.dev:8443`

#### Origin Rules

å› ä¸º Page Rules å…è´¹ç”¨æˆ·æœ€å¤šæ·»åŠ  3 æ¡, æ•°é‡æ¯”è¾ƒå®è´µ, æ‰€ä»¥æˆ‘é€‰æ‹© Origin Rules æ¥å®ç°æˆ‘ä¸Šé¢çš„éœ€æ±‚.

![20250213115516_L2P6Piwy.webp](https://cdn.dong4j.site/source/image/20250213115516_L2P6Piwy.webp)

è¿™æ ·æˆ‘ä»¬è®¿é—® `https://nas.dong4j.dev` æ—¶ä¼šè‡ªåŠ¨é‡å®šå‘åˆ° `https://nas.dong4j.dev:8443`

### Cloudflare Workers

æœ€åä¸€ç§æ–¹æ³•æ˜¯åˆ©ç”¨åŠŸèƒ½å¼ºå¤§çš„ Cloudflare Workersï¼Œä½†æ˜¯éœ€è¦å†™ä»£ç ã€‚ä¸€ä¸ªç®€å•çš„è½¬å‘æ‰€æœ‰è¯·æ±‚åˆ°æ–°ç½‘å€çš„ worker ä»£ç ç¤ºä¾‹ï¼š

```javascript
export default {
  async fetch(request) {
    const base = "https://nas.dong4j.dev:8443"; // å®šä¹‰ç›®æ ‡åŸŸåå’Œç«¯å£
    const statusCode = 301; // è®¾ç½® HTTP çŠ¶æ€ç ä¸º 301ï¼Œè¡¨ç¤ºæ°¸ä¹…é‡å®šå‘

    const url = new URL(request.url); // è·å–å½“å‰è¯·æ±‚çš„ URL å¯¹è±¡
    const { pathname, search } = url; // ä» URL ä¸­æå–è·¯å¾„ï¼ˆpathnameï¼‰å’ŒæŸ¥è¯¢å­—ç¬¦ä¸²ï¼ˆsearchï¼‰

    const destinationURL = `${base}${pathname}${search}`; // æ„å»ºç›®æ ‡ URLï¼Œå°† base ä¸è¯·æ±‚çš„è·¯å¾„å’ŒæŸ¥è¯¢å‚æ•°æ‹¼æ¥åœ¨ä¸€èµ·
    return Response.redirect(destinationURL, statusCode); // è¿”å›ä¸€ä¸ª HTTP é‡å®šå‘å“åº”ï¼ŒæŒ‡å‘æ„å»ºçš„ç›®æ ‡ URLï¼Œå¹¶ä½¿ç”¨ 301 çŠ¶æ€ç 
  },
};
```

é€šè¿‡ Cloudflare workerï¼Œå®é™…ä¸Šå·²ç»èƒ½å®ç°æˆ‘ä»¬æ‰€æœ‰çš„éœ€æ±‚äº†ï¼Œä½†æ˜¯éƒ¨ç½²å’Œè°ƒè¯•æ›´éº»çƒ¦ï¼Œé€‚åˆé«˜çº§ç©å®¶ã€‚Cloudflare worker å¦å¤–ä¸€ä¸ªç¼ºç‚¹æ˜¯å…è´¹è´¦æˆ·æ¯å¤©è¯·æ±‚é™åˆ¶ 10 ä¸‡æ¬¡ï¼Œå½“ç„¶å¯¹äºä¸ªäººç”¨é€”ä¹Ÿè¶³å¤Ÿäº†ã€‚

### Cloudflare SSL

åœ¨ Cloudflare è´­ä¹°çš„ dev åŸŸåå¯ä»¥å…è´¹è·å– SSL è¯ä¹¦, æœ‰æ•ˆæœŸä¸º 3 ä¸ªæœˆ, ä¸è¿‡ä¸ç”¨æ‹…å¿ƒ, Cloudflare ä¼šè‡ªåŠ¨ç»­æœŸå¹¶éƒ¨ç½², è¿™ä¸€åˆ‡éƒ½ä¸éœ€è¦æˆ‘ä»¬åšä»»ä½•æ“ä½œ.

è¿™é‡Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸€ä¸‹ Cloudflare SSL ç›¸å…³çš„åŸºç¡€çŸ¥è¯†:

![20250213120432_XXRyhrfY.webp](https://cdn.dong4j.site/source/image/20250213120432_XXRyhrfY.webp)

Cloudflare ä½œä¸ºä¸­é—´ä»£ç†, æµé‡éœ€è¦ç»è¿‡ Cloudflare æœåŠ¡å™¨, ç„¶åå†è½¬å‘åˆ°æºæœåŠ¡å™¨, æ‰€ä»¥è¿™ä¸­é—´éœ€è¦ 2 ä¸ª SSL è¯ä¹¦:

- æµè§ˆå™¨åˆ° Cloudflare çš„æµé‡, é€šè¿‡ **è¾¹ç¼˜è¯ä¹¦** æ¥ä¿è¯æ•°æ®å®‰å…¨, è¿™ä¸ª **è¾¹ç¼˜è¯ä¹¦** ç”± Cloudflare ç®¡ç†, å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå·±çš„è¯ä¹¦, ä¸è¿‡éœ€è¦å‡çº§åˆ° Business è®¡åˆ’;
- Cloudflare åˆ°æºæœåŠ¡å™¨çš„æµé‡, é€šè¿‡ **æºæœåŠ¡å™¨è¯ä¹¦** æ¥ä¿è¯æ•°æ®å®‰å…¨, è¿™ä¸ªè¯ä¹¦å°±æ˜¯æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨ **[Let's Encrypt](https://letsencrypt.org/)** ç”³è¯·çš„è¯ä¹¦, è¿™ä¸ªéœ€è¦é…ç½®åˆ°æºæœåŠ¡å™¨ä¸Š, æ¯”å¦‚ Nginx;

Cloudflare çœŸçš„é…å¾—ä¸Š ã€**èµ›åšä½›ç¥–**ã€ çš„ç§°å·, å…è´¹çš„æœåŠ¡åŸºæœ¬ä¸Šèƒ½å¤Ÿæ»¡è¶³ç»å¤§å¤šæ•°ä¸ªäººéœ€æ±‚, è¿™é‡Œæˆ‘è¿˜ä» Cloudflare ç™½å«–äº†ä¸€ä¸ª 15 å¹´çš„å…è´¹ TLS è¯ä¹¦:

![20250213121227_57gxNRu6.webp](https://cdn.dong4j.site/source/image/20250213121227_57gxNRu6.webp)

ä¸Šé¢ä¸€ç•ªé…ç½®å, æˆ‘ä»¬çš„çœŸå® IP è¢« Cloudflare éšè—äº†:

```bash
$ dig nas.dong4j.dev

; <<>> DiG 9.18.30-0ubuntu0.24.04.2-Ubuntu <<>> nas.dong4j.dev
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 48841
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;nas.dong4j.dev.			IN	A

;; ANSWER SECTION:
nas.dong4j.dev.		1	IN	A	104.21.22.178
nas.dong4j.dev.		1	IN	A	172.67.206.92

;; Query time: 6 msec
;; SERVER: 127.0.0.53#53(127.0.0.53) (UDP)
;; WHEN: Thu Feb 13 12:16:14 CST 2025
;; MSG SIZE  rcvd: 75
```

ä¸”è¿˜å…·å¤‡å®Œå–„çš„ SSL åŠ å¯†, æ‰€ä»¥ä¸‹ä¸€æ­¥çš„è®¡åˆ’æ˜¯å°†æš´éœ²åˆ°å¤–ç½‘çš„ API å…¨éƒ¨ä½¿ç”¨ Cloudflare æ¥ä»£ç†, å¢å¼º Homelab çš„å®‰å…¨æ€§.

## æ€»ç»“

è¿™æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ Cloudflare, æˆ‘çš„ä½“ä¼šæ˜¯ Cloudflare å°±åƒä¸€ä¸ª Nginx, èƒ½å¤Ÿåœ¨ä¸Šé¢é…ç½®å„ç§è§„åˆ™, æ¯”å¦‚ç¼“å­˜, é‡å®šå‘, è´Ÿè½½å‡è¡¡ç­‰ç­‰, å½“ç„¶è¿™åªæ˜¯å…¶ä¸­ä¸€å°éƒ¨åˆ†åŠŸèƒ½, å…¶ä»–çš„åŠŸèƒ½æˆ‘ä¼šæŒç»­æŒ–æ˜, æ¯”å¦‚å¼ºå¤§çš„ Cloudflare Workers.

## å‚è€ƒ

- [How to enable Cloudflare's proxy for additional ports](https://developers.cloudflare.com/fundamentals/reference/network-ports/)
- [Where to? Introducing Origin Rules](https://blog.cloudflare.com/origin-rules/)
- [30 å¤©å…¥é—¨Cloudflare](https://medium.com/chouhsiang/cloudflare-30-days/home)

## [Ubuntu ç³»ç»Ÿä¸‹ LCD4Linux çš„å®‰è£…ä¸é…ç½®æŒ‡å—](https://blog.dong4j.site/posts/b0f649a0.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ç®€ä»‹

å¾ˆä¹…ä»¥å‰ä¹° R2S çš„æ—¶å€™ä¸€èµ·ä¹°äº†ä¸€ä¸ª LCD å°å±å¹•, ä¸€ç›´æ²¡ç”¨èµ·æ¥, è¿™æ¬¡è£…äº†ä¸ªå°ä¸»æœº, æƒ³ç€çœ‹èƒ½ä¸èƒ½åºŸç‰©åˆ©ç”¨ä¸€ä¸‹.

[LCD4Linux](https://wiki.lcd4linux.tk/doku.php/start) æ˜¯ä¸€ä¸ªå°ç¨‹åºï¼Œå®ƒä»å†…æ ¸å’Œä¸€äº›å­ç³»ç»ŸæŠ“å–ä¿¡æ¯å¹¶å°†å…¶æ˜¾ç¤ºåœ¨å¤–éƒ¨*æ¶²æ™¶æ˜¾ç¤ºå™¨*ä¸Šã€‚

ä¸‹é¢æ˜¯ä¸€äº›è¿è¡Œ LCD4Linux çš„å›¾ç‰‡:

**LCD4Linux åœ¨ä¸¤ä¸ªä¸åŒå°ºå¯¸çš„æ˜¾ç¤ºå™¨ä¸Š**

![20250212210620_gB8IzF5R.webp](https://cdn.dong4j.site/source/image/20250212210620_gB8IzF5R.webp)

**Iomega HMNHD-CE ä¸Š çš„ LCD4Linux**

![20250212210620_XB3aHdmZ.webp](https://cdn.dong4j.site/source/image/20250212210620_XB3aHdmZ.webp)

### å®‰è£… lcd4linux

```
$ sudo apt-get install lcd4linux
```

æŸ¥çœ‹ USB å±å¹•çš„è®¾å¤‡åç§°

```
$ lsusb
```

å°†ä¼šçœ‹åˆ°æœ‰`lcd2usb interface`çš„è®¾å¤‡å‡ºç°

```bash
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 003 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 003 Device 003: ID 8087:0032 Intel Corp. AX210 Bluetooth
Bus 003 Device 013: ID 0403:c630 Future Technology Devices International, Ltd lcd2usb interface
Bus 003 Device 014: ID 2c7c:0125 Quectel Wireless Solutions Co., Ltd. EC25 LTE modem
Bus 004 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 004 Device 002: ID 0bda:8156 Realtek Semiconductor Corp. USB 10/100/1G/2.5G LAN
```

> å¦‚æœçœ‹ä¸åˆ°, å¯ä»¥æ›´æ¢ä¸€æ ¹çº¿è¯•è¯•, æˆ‘å°±æ˜¯è¿™ä¹ˆè§£å†³çš„.

è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° å½“å‰è®¾å¤‡çš„è¿æ¥ä½ç½®æ˜¯åœ¨:

```bash
Bus 003 Device 013: ID 0403:c630 Future Technology Devices International, Ltd lcd2usb interface
```

ç„¶åå¯ä»¥åœ¨ `/dev/bus/usb/003/013` çœ‹åˆ°æˆ‘ä»¬çš„ USB å±å¹•,è®°ä¸‹è¿™ä¸ªè·¯å¾„, åç»­ä¼šåœ¨é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨åˆ°.

### é…ç½®

ç”±äºå®‰å…¨åŸå› ï¼ˆé…ç½®å¯èƒ½åŒ…å«é‚®ä»¶å¸æˆ·çš„ç”¨æˆ·å/å¯†ç ï¼‰ï¼Œé…ç½®æ–‡ä»¶å¿…é¡»ç¡®ä¿ä»…å…·æœ‰ç”¨æˆ·çš„æƒé™ã€‚å°ç»„æˆ–å…¶ä»–äººä¸å¾—è¯»å†™ï¼Œå¦åˆ™ lcd4linux æ‹’ç»å·¥ä½œï¼ å› æ­¤ï¼Œå¦‚æœä»¥ root èº«ä»½è¿è¡Œ lcd4linuxï¼Œ `/etc/libd4linux.conf` å¿…é¡»æ˜¯ï¼š

```
chmod 600 /etc/lcd4linux.conf
chown root.root /etc/lcd4linux.conf
```

```
$ cd /etc
$ sudo vi lcd4linux.conf
```

å…ˆæ¥ä¸ªç®€å•çš„ CPU ç›‘æ§æ˜¾ç¤ºé…ç½®:

```
Display LCD2USB {
    Driver     'LCD2USB' # æŒ‡å®šä½¿ç”¨LCD2USBé©±åŠ¨
    Size       '16x2' # LCD dimension: 1602
    Port       '`/dev/bus/usb/003/002`' # Port: /dev/usbdev3.2
}

# CPUä½¿ç”¨ç‡éƒ¨ä»¶
Widget CPU {
    class 'Text' #éƒ¨ä»¶ç±»å‹æŒ‡å®šä¸ºæ–‡æœ¬
    expression proc_stat::cpu('busy', 500)
    prefix 'CPU:' #å‰ç¼€
    postfix '% |' #åç¼€
    width 10  #éƒ¨ä»¶å ç”¨å­—ç¬¦æ•°
    precision 1
    align 'L' # L R åˆ†åˆ«è¡¨ç¤ºå·¦å¯¹é½ å’Œå³å¯¹é½
    update 500  # æ›´æ–°é¢‘ç‡ 500æ¯«ç§’
}

Widget RAM {
    class  'Text'
    expression meminfo('MemTotal')/1024
    prefix 'RAM:'
    postfix ' MB'
    width  8
    precision 0
    align  'R'
    update 500
}

Widget IPaddress {
    class  'Text' # Type: Text
    expression netinfo::ipaddr('vmbr0') # eth0's ip
    prefix '' # display "IP:"
    width 16 # display width: 16
    align  'C' # display: central
    update 1000
}

Widget Time {
    class 'Text'
    expression strftime('%a %H:%M:%S',time())
    width 16
    align 'C'
    update 1000
}

Layout Default {
    Row1 {
        Col1 'IPaddress'               	# Display Widget IPaddress in the first row and first column
    }
    Row2 {
        Col1 'CPU'	              			# Display Widget Time in the second row and first column
        # Col9 'RAM'
    }

}

Display 'LCD2USB'
Layout  'Default'
```

### å¯åŠ¨

å¯åŠ¨ lcd4linux å‰è¯·ç¡®å®šé…ç½®æ–‡ä»¶ `lcd4linux.conf`çš„æƒé™æ˜¯ 600. å¯åŠ¨å‘½ä»¤å¦‚ä¸‹, `-v` è¡¨ç¤ºæ˜¾ç¤ºå¯åŠ¨æ—¥å¿—,å¦‚æœå¤±è´¥å°†ä¼šæ˜¾ç¤ºé”™è¯¯åŸå› 

```
$ pkill lcd4linux
$ lcd4linux -v
```

![20250212210621_PfhvFnBe.webp](https://cdn.dong4j.site/source/image/20250212210621_PfhvFnBe.webp)

æˆ‘çš„è¿™å—æ˜¯ 16x2 çš„, æ˜¾ç¤ºä¸äº†å¤šå°‘ä¿¡æ¯, åé¢çœ‹èƒ½ä¸èƒ½æ¢ä¸€ä¸ªå¤§ç‚¹çš„ç©ç©.

## è¯¦ç»†é…ç½®è§£é‡Š

> é…æ–‡ä»¶å†…å®¹åˆ† 3 ä¸ªéƒ¨åˆ†

### å±å¹•é…ç½®

```
Display LCD2USB {
    Driver     'LCD2USB' # æŒ‡å®šä½¿ç”¨LCD2USBé©±åŠ¨
    Size       '16x2' # LCD dimension: 1602
    Port       '/dev/usbdev3.2' # Port: /dev/usbdev3.2
}
```

### å®šä¹‰æ˜¾ç¤ºéƒ¨ä»¶

æ­¤å¤„å¯ä»¥å®šä¹‰å¤šä¸ªéƒ¨ä»¶,éƒ¨ä»¶ä¸­çš„è¡¨è¾¾å¼å¯ä»¥å‚è€ƒ [å®˜æ–¹æä¾›çš„éƒ¨ä»¶åˆ—è¡¨ Plugins](https://wiki.lcd4linux.tk/doku.php/plugins)

å¸¸ç”¨åˆ°çš„æœ‰:

#### plugin_meminfo å†…å­˜æ’ä»¶

> è¯¥æ’ä»¶æä¾›äº† /proc/meminfo æ–‡ä»¶çš„æ¥å£ã€‚
> `meminfoï¼ˆkeyï¼‰/proc/meminfo å¹¶è¿”å›<key>çš„å€¼`
> 'key'å‚æ•°æ²¡æœ‰ä»»ä½•å›ºå®šå€¼ï¼Œä½†ä½œä¸ºæœç´¢é”®è¿›å…¥/ proc / meminfo æ–‡ä»¶ã€‚å¸¸ç”¨é”®æ˜¯â€œMemTotalâ€æˆ–â€œMemFreeâ€ã€‚æ‰§è¡Œ'cat / proc / meminfo'ä»¥æŸ¥çœ‹ç³»ç»Ÿä¸Šå¯ç”¨çš„å€¼ã€‚

```
Widget RAM {
    class  'Text'
    expression meminfo('MemTotal')/1024
    postfix ' MB RAM'
    width  11
    precision 0
    align  'R'
    update 0
}
```

#### plugin_proc_stat ç³»ç»ŸçŠ¶æ€æ’ä»¶

| è¡¨è¾¾å¼                              | è§£é‡Š                        |
| ----------------------------------- | --------------------------- |
| proc_stat(key)                      | ä»`/proc/stat`ç›´æ¥å–å€¼      |
| proc_stat(key, delay)               | ä»`/proc/stat`å–å˜åŒ–é‡      |
| proc_stat::cpu(key, delay)          | ä»`/proc/stat`è·å– CPU ä¿¡æ¯ |
| proc_stat::disk(device, key, delay) | ä»`/proc/stat`è·å–ç¡¬ç›˜ä¿¡æ¯  |

ç¤ºä¾‹:`CPU:12%`

```
Widget CPU {
    class 'Text'
    expression proc_stat::cpu('busy', 500)
    prefix 'CPU:'
    postfix '% |'
    width 10
    precision 1
    align 'L'
    update tick
}
Widget CPUBar {
    class 'Bar'
    expression  proc_stat::cpu('busy',   500)
    expression2 proc_stat::cpu('system', 500)
    length 10
    align 'L'
    direction 'E'
    update tack
}
```

#### uptime å¯åŠ¨æ—¶é—´æ’ä»¶

> æ­¤æ’ä»¶ä»¥ç§’æˆ–ä»¥ç”¨æˆ·å®šä¹‰çš„æ ¼å¼è¿”å›å½“å‰ç³»ç»Ÿçš„æ­£å¸¸è¿è¡Œæ—¶é—´

| è¡¨è¾¾å¼         | è§£é‡Š                   |
| -------------- | ---------------------- |
| uptime()       | è¿”å›ç³»ç»Ÿå¯åŠ¨çš„ç§’æ•°     |
| uptime(format) | ä»¥ç”¨æˆ·å®šä¹‰æ ¼å¼è¿”å›æ—¶é—´ |

format çš„å¯é€‰æ ¼å¼(æ ¼å¼æŒ‡å®šç±»ä¼¼äº `printf()`æ–¹æ³•)

| è¡¨è¾¾å¼ | è§£é‡Š              |
| ------ | ----------------- |
| %s     | æ€»ç§’æ•°            |
| %S     | ä» 00-59 çš„ç§’æ•°   |
| %m     | æ€»åˆ†é’Ÿæ•°          |
| %M     | ä» 00-59 çš„åˆ†é’Ÿæ•° |
| %h     | æ€»å°æ—¶æ•°          |
| %H     | ä» 00-23 çš„å°æ—¶æ•° |
| %d     | æ€»å¤©æ•°            |

ä¾‹å­: `Run 12 days 12:32:59`

```
Widget Uptime {
    class 'Text'
    expression uptime('%d days %H:%M:%S')
    width 20
    align 'L'
    prefix 'Run '
    update tick
}
```

è¿™é‡Œæ˜¯ä¸€éƒ¨åˆ†è¡¨è¾¾å¼çš„ç¤ºä¾‹,å…¶ä½™å¯ä»¥é€šè¿‡[å®˜æ–¹æä¾›çš„éƒ¨ä»¶åˆ—è¡¨ Plugins](https://link.juejin.cn?target=https%3A%2F%2Flcd4linux.bulix.org%2Fwiki%2FPlugins) è¿›è¡ŒæŸ¥çœ‹

### æŒ‡å®šå¸ƒå±€

> é€šè¿‡`Row è¡Œ`ä¸`Col æ ¼`è¿›è¡Œå¸ƒå±€å®‰æ’, åé¢çš„æ•°å­—è¡¨ç¤ºå…·ä½“çš„è¡Œæ•°å’Œæ ¼æ•°

```
Layout Default {
    Row1 {
      Col1 'MyInfo' # ä»ç¬¬ä¸€è¡Œç¬¬ä¸€æ ¼å¼€å§‹æ˜¾ç¤º
    }
   Row2 {
      Col1 'CPU' # ä»ç¬¬äºŒè¡Œç¬¬1æ ¼å¼€å§‹æ˜¾ç¤º
      Col11 'MEM' # ä»ç¬¬äºŒè¡Œç¬¬11æ ¼å¼€å§‹æ˜¾ç¤º(æˆ‘çš„è®¾å¤‡æ€»è®¡20æ ¼æ¯è¡Œ)
   }
   Row3 {
      Col1 'IPaddress'
   }
   Row4 {
      Col1 'Uptime'
   }
}
```

## å‚è€ƒèµ„æ–™

- [è¯¦è¿°ç¾¤æ™– NAS é…ç½® DPF æ•°ç ç›¸æ¡†å†ç¨‹ï¼Œåˆ†äº« lcd4linux ç²¾å¿ƒé…ç½® CONF](https://www.gebi1.com/forum.php?mod=viewthread&tid=243605&extra=page%3D1)
- [ç¼–è¯‘ LCD4Linux å¢åŠ  Image,VNC,X11 é©±åŠ¨](https://blog.joylau.cn/2024/10/31/Daily-LCD4Linux/)
- [Matrix - LCD2USB](https://wiki.friendlyelec.com/wiki/index.php/Matrix_-_LCD2USB)

## [æ ‘è“æ´¾ä¸ç§»è¿œEC20 4Gç½‘å¡é›†æˆåŠè‡ªåŠ¨æ‹¨å·æ–¹æ¡ˆè§£æ](https://blog.dong4j.site/posts/c78c58c7.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ç®€ä»‹

å‰æ®µæ—¶é—´åœ¨å°é»„é±¼ä¸Šæ¡äº† 2 å¼ ç§»è¿œçš„ EC20, ä»Šå¤©æŠ˜è…¾ä¸€ä¸‹è¿™å¼  4G ç½‘å¡.

## å®æˆ˜

- ç§»è¿œ EC20 mini PCIE æ¨¡å—
- usb è½¬ mini PCIE æ¨¡å—
- ipex1 ä»£è½¬ sma å†…å­”è½¬æ¥çº¿
- sma å†…é’ˆ 4G å¤©çº¿

![20250212192830_2BtPoWN6.webp](https://cdn.dong4j.site/source/image/20250212192830_2BtPoWN6.webp)

åŠ ä¸Šé£æ‰‡:

![20250212192830_NWDXX1ut.webp](https://cdn.dong4j.site/source/image/20250212192830_NWDXX1ut.webp)

åˆä½“åçš„æ ·å­:

![20250212192830_UdmIlPRM.webp](https://cdn.dong4j.site/source/image/20250212192830_UdmIlPRM.webp)

æ£€æŸ¥ USB è®¾å¤‡ä¸­æ˜¯å¦å­˜åœ¨ 4G æ¨¡å—

```bash
lsusb
Bus 001 Device 003: ID 2c7c:0125 Quectel Wireless Solutions Co., Ltd. EC25 LTE modem
Bus 001 Device 002: ID 2109:3431 VIA Labs, Inc. Hub
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
```

è·å– 4G æ¨¡å— USB è½¬ä¸²å£ç»ˆç«¯

```bash
ls /dev/ttyUSB*

/dev/ttyUSB0 /dev/ttyUSB1 /dev/ttyUSB2 /dev/ttyUSB3
```

### ppp0 æ‹¨å·

[ç¬¬ä¸‰èŠ‚ æ ‘è“æ´¾ EC20 ä¹‹ PPP æ‹¨å·ä¸Šç½‘\_æ ‘è“æ´¾æ‹¨å·ä¸Šç½‘-CSDN åšå®¢](https://blog.csdn.net/qq_30112663/article/details/124115912)

**å®‰è£…æ‹¨å·å·¥å…·**

```bash
sudo apt install wvdial

# æ‰“å¼€é…ç½®æ–‡ä»¶
sudo vim /etc/wvdial.conf
```

[Wvdial æ‹¨å·ä¸Šç½‘ - Waveshare Wiki](https://www.waveshare.net/wiki/Wvdial%E6%8B%A8%E5%8F%B7%E4%B8%8A%E7%BD%91)

```bash
# ç”µä¿¡
[Dialer T]
Init1 = ATZ
Init2 = ATQ0 V1 E1 S0=0 &C1 &D2 +FCLASS=0
Modem Type = Analog Modem
Baud = 9600
New PPPD = yes
Modem = /dev/ttyUSB3
ISDN = 0
Phone = *99#
Password = card
Username = card

# è”é€š
[Dialer U]
Init1 = ATZ
Init2 = ATQ0 V1 E1 S0=0 &C1 &D2 +FCLASS=0
Init3 = at+cgdcont=1,"ip","uninet"
Modem Type = Analog Modem
Baud = 9600
New PPPD = yes
Modem = /dev/ttyUSB3
ISDN = 0
Phone = *99#
Password = card
Username = card
```

**æ‹¨å·**

```bash
âœ  ~ sudo  wvdial  T
--> WvDial: Internet dialer version 1.61
--> Initializing modem.
--> Sending: ATZ
OK
--> Sending: ATQ0 V1 E1 S0=0 &C1 &D2 +FCLASS=0
ATQ0 V1 E1 S0=0 &C1 &D2 +FCLASS=0
OK
--> Modem initialized.
--> Sending: ATDT*99#
--> Waiting for carrier.
ATDT*99#
CONNECT 150000000
--> Carrier detected.  Waiting for prompt.
--> Don't know what to do!  Starting pppd and hoping for the best.
--> Starting pppd at Wed Feb 12 16:16:27 2025
--> Pid of pppd: 43894
--> Using interface ppp0
--> local  IP address 10.61.4.81
--> remote IP address 10.64.64.64
--> primary   DNS address 61.139.2.69
--> secondary DNS address 218.6.200.139
```

```bash
âœ  ppp0 ip a | grep ppp0
23: ppp0: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 3
    inet 10.61.4.81 peer 10.64.64.64/32 scope global ppp0
```

å·²ç»æˆåŠŸæ‹¨å·

**æµ‹è¯•**

```bash
âœ  ~ ping -I ppp0 8.8.8.8
PING 8.8.8.8 (8.8.8.8) from 10.61.4.81 ppp0: 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=54 time=133 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=54 time=44.1 ms
64 bytes from 8.8.8.8: icmp_seq=3 ttl=54 time=46.1 ms
64 bytes from 8.8.8.8: icmp_seq=4 ttl=54 time=52.8 ms
```

**ä»å…¬ç½‘è®¿é—® HomeLab**:

```bash
âœ  ~ iperf3 -c zzz.xxx.yyy
Connecting to host zzz.xxx.yyy, port 12421
[  5] local 10.61.4.81 port 41632 connected to 123.123.123.123 port 12421
[ ID] Interval           Transfer     Bitrate         Retr  Cwnd
[  5]   0.00-1.00   sec   852 KBytes  6.98 Mbits/sec    0   64.5 KBytes
[  5]   1.00-2.00   sec  1.24 MBytes  10.4 Mbits/sec    0    126 KBytes
[  5]   2.00-3.00   sec  2.22 MBytes  18.6 Mbits/sec    0    226 KBytes
[  5]   3.00-4.00   sec  2.53 MBytes  21.2 Mbits/sec    8    147 KBytes
[  5]   4.00-5.00   sec  1.85 MBytes  15.5 Mbits/sec    0    167 KBytes
[  5]   5.00-6.00   sec  2.22 MBytes  18.6 Mbits/sec    0    176 KBytes
[  5]   6.00-7.00   sec  1.91 MBytes  16.0 Mbits/sec   10    138 KBytes
[  5]   7.00-8.00   sec  1.85 MBytes  15.5 Mbits/sec    0    146 KBytes
[  5]   8.00-9.00   sec  1.85 MBytes  15.5 Mbits/sec    0    149 KBytes
[  5]   9.00-10.00  sec  1.85 MBytes  15.5 Mbits/sec    1    155 KBytes
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec  18.4 MBytes  15.4 Mbits/sec   19             sender
[  5]   0.00-10.08  sec  17.5 MBytes  14.6 Mbits/sec                  receiver
```

### æ›´æ¢é»˜è®¤è·¯ç”±

```bash
# æŸ¥çœ‹è·¯ç”±
sudo route -n

Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.31.1    0.0.0.0         UG    100    0        0 eth0
0.0.0.0         192.168.21.1    0.0.0.0         UG    600    0        0 wlan0
10.64.64.64     0.0.0.0         255.255.255.255 UH    0      0        0 ppp0

# æ·»åŠ  ppp0 ç½‘å¡è®¾å¤‡ä¸ºé»˜è®¤è·¯ç”±
sudo route add default dev ppp0
# åˆ é™¤æ“ä½œ
sudo route del default dev ppp0
```

æœ€åï¼Œå…¶å® ppp0 æ‹¨å·ï¼Œæ˜¯ 4g æ—¶ä»£ä»¥å‰æ‰€ä½¿ç”¨çš„æ‹¨å·æ–¹å¼ï¼Œä¹Ÿé™åˆ¶ ec20 çš„å…¥ç½‘é€Ÿåº¦ï¼Œå¯¹äºç°åœ¨ 4g/5g æ—¶ä»£ï¼Œppp0 æ‹¨å·å·²ç»æ— æ³•å‘æŒ¥æ¨¡å—çš„æ€§èƒ½ï¼Œå®˜æ–¹ä¹Ÿä¸å†å»ºè®®ä½¿ç”¨ ppp0 æ‹¨å·ï¼Œç›®å‰æœ€å¸¸ç”¨çš„ GobiNetï¼Œè€Œä¸”æ ‘è“æ´¾å†…æ ¸å·²ç»æ”¯æŒäº† qmi_wwan çš„é©±åŠ¨.

### qmi_wwan æ‹¨å·

[ç¬¬å››èŠ‚ æ ‘è“æ´¾ EC20 ä¹‹ QMI_WWAN æ‹¨å·\_quectel-cm-CSDN åšå®¢](https://blog.csdn.net/qq_30112663/article/details/124140466)

## è‡ªåŠ¨æ‹¨å·

[ç¬¬äº”èŠ‚ æ ‘è“æ´¾ EC20 è‡ªåŠ¨æ‹¨å·è„šæœ¬ç¼–å†™\_ec20 æ‹¨å·è„šæœ¬-CSDN åšå®¢](https://blog.csdn.net/qq_30112663/article/details/124228764)

```bash
#! /bin/bash

#è¿è¡Œæ­¥éª¤å˜é‡åˆå§‹åŒ–
ec20_step=0

#è¶…æ—¶è®¡æ•°åˆå§‹åŒ–
over_time=0

#å¾ªç¯
while [ 1 ]
do
	#ç¬¬ä¸€æ­¥å…ˆæ£€æŸ¥é©±åŠ¨
	if [ $ec20_step -eq 0 ]; then
	#ä½¿ç”¨lsusbæŸ¥çœ‹æ˜¯å¦æœ‰ec20é©±åŠ¨ grepæŸ¥è¯¢ç»“æœæ˜¯å¦åŒ…å«Quectel
		result=$(lsusb | grep Quectel)
		echo "1. æ£€æŸ¥é©±åŠ¨: " $result
		if [[ $result =~ "EC25" ]]; then
			ec20_step=1

		else
			ec20_step=0
		fi
		#å»¶æ—¶2s
		sleep 2
	#ç¬¬äºŒæ­¥ å¼€å§‹ä½¿ç”¨ wvdial æ‹¨å·
	elif [ $ec20_step -eq 1 ]; then
		echo "2. wvdial æ‹¨å·"
		echo "password" | sudo nohup wvdial T &
		ec20_step=2

		sleep 2
	#ç¬¬ä¸‰æ­¥ æŸ¥è¯¢è·¯ç”±æ˜¯å¦åŒ…å« ppp0 ç½‘å¡ï¼Œæ‹¨å·æˆåŠŸåˆ™ä¼šåŒ…å«æœ‰ ppp0 ç½‘å¡
	elif [ $ec20_step -eq 2 ]; then
		result=$(route -n | grep ppp0)

		echo "3. æ£€æŸ¥æ˜¯å¦å­˜åœ¨ ppp0 ç½‘å¡" $result

		if [[ $result =~ "ppp0" ]]; then
			echo "3.1 åŒ…å«ç½‘å¡ï¼Œæ·»åŠ é»˜è®¤è·¯ç”±"
			#è‹¥åŒ…å«ç½‘å¡ï¼Œåˆ™æ·»åŠ é»˜è®¤è·¯ç”±
			echo "password" | sudo route add default dev ppp0
			ec20_step=3
			over_time=0
		else
			echo "3.2 ä¸åŒ…å«ç½‘å¡, å†æ¬¡å¾ªç¯æŸ¥è¯¢, å¾ªç¯æ¬¡æ•°:" $over_time
			#è¶…æ—¶è®¡æ•°
			let over_time++
		fi
		#è‹¥ä¸€åˆ†é’Ÿéƒ½æ²¡æœ‰è·¯ç”±ç½‘å¡åˆ™è¯´æ˜æ²¡æœ‰æ‹¨å·æˆåŠŸ
		if [ $over_time -eq 12 ]; then
			echo "12 æ¬¡æ£€æŸ¥ä¸å­˜åœ¨è·¯ç”±ç½‘å¡, è¯´æ˜æ²¡æœ‰æ‹¨å·æˆåŠŸ, è¿›å…¥é‡å¯é€»è¾‘"
			over_time=0
			#è¶…æ—¶æ‹¨å·åˆ™è·³å…¥é‡å¯æ­¥éª¤
			ec20_step=4
		fi

		sleep 5
	#ç¬¬å››æ­¥ é€šè¿‡ ping å‘½ä»¤æ£€æŸ¥ç½‘ç»œçŠ¶æ€
	elif [ $ec20_step -eq 3 ]; then
		result=$(ping -I ppp0 -c 1 www.baidu.com)

		echo "4. é€šè¿‡ ping å‘½ä»¤æ£€æŸ¥ç½‘ç»œçŠ¶æ€" $result

		if [[ $result =~ "1 received" ]]; then
			echo "4.1 ping æˆåŠŸ"
			over_time=0
		else
			echo "4.2 ping å¤±è´¥, å†æ¬¡å¾ªç¯æŸ¥è¯¢"
			let over_time++

		fi
		#è¶…æ—¶åˆ™æ€æ‰æ‹¨å·çº¿ç¨‹ï¼Œå¹¶è¿›å…¥é‡å¯æ­¥éª¤
		if [ $over_time -eq 6 ]; then
			echo "6 æ¬¡ ping å¤±è´¥, è¿›å…¥é‡å¯é€»è¾‘"
			over_time=0
			ec20_step=4
			echo "password" | sudo pkill wvdial
		fi
		sleep 5

	#ç¬¬äº”æ­¥é‡å¯æ¨¡å—
	elif [ $ec20_step -eq 4 ]; then
		echo "é‡å¯ç½‘å¡"
		echo -e "AT+CFUN=1,1\r\n" > /dev/ttyUSB2
		ec20_step=0
		#é‡å¯å‘½ä»¤åå»¶æ—¶ç¨å¾®é•¿ä¸€ç‚¹
		sleep 15
	fi

done
exit 0
```

å¼€æœºè‡ªå¯åŠ¨

```bash
sudo vim /etc/rc.local
//åœ¨æ–‡ä»¶exit 0å‰åŠ å…¥æ­¤å¥ï¼Œ:wqä¿å­˜ï¼Œé‡å¯å³å¯ç”Ÿæ•ˆ
# ppp0 æ‹¨å·
bash /root/ppp0.start >> /root/ppp0.log 2>&1
```

å¦ä¸€ç§æ–¹å¼:

```bash
[Unit]
Description=ppp0 service
After=network.target

[Service]
Restart=on-failure
RestartSec=5
ExecStart=/bin/bash /root/ppp0.start
StandardOutput=/root/ppp0.log
StandardError=/root/ppp0.log

[Install]
WantedBy=multi-user.target
```

æŸ¥çœ‹æ—¥å¿—

```bash
journalctl -u ppp0.service -f
```

æŸ¥çœ‹æœåŠ¡ä¿¡æ¯

```bash
systemctl show ppp0
```

### å‘é€çŸ­ä¿¡

[è®©ä½ çš„æ ‘è“æ´¾å’Œæ‰‹æœºå¤‡å·ä¸å†åƒç°ï¼šçŸ­ä¿¡è½¬å‘\_ç”µè„‘æ•´æœº\_ä»€ä¹ˆå€¼å¾—ä¹°](https://post.smzdm.com/p/a4wme8zx/) çœ‹è¿™ä¸ª

[æ ‘è“æ´¾+4G æ¨¡å—æ¥æ”¶çŸ­ä¿¡å®æ—¶è½¬å‘åˆ°é‚®ç®±-CSDN åšå®¢](https://blog.csdn.net/tiaga/article/details/127975344)

[æ ‘è“æ´¾ EC20 æ¨¡å—è”ç½‘ | yan blog](https://yancoding.github.io/posts/3c0ad28a2fa4/)

**å¾—å…ˆæ‹¨å·å¹¶è®¾ç½® ppp0 ä¸ºé»˜è·¯ç”±**

```bash
sudo apt-get install gammu
sudo gammu-config
```

![20250212211654_FkHN4YkE.webp](https://cdn.dong4j.site/source/image/20250212211654_FkHN4YkE.webp)

```bash
# æŸ¥çœ‹è®¾å¤‡ä¿¡æ¯
sudo gammu --identify
```

```bash
sudo gammu sendsms TEXT æ‰‹æœºå· -text "è¿™æ˜¯ä¸€æ¡çŸ­ä¿¡ï¼Œfrom raspi" -unicode

echo "a test sms from ec20" | sudo gammu sendsms TEXT 18628362906
```

é…ç½®æ–‡ä»¶ä¿å­˜åœ¨ /root/.gammurc

```bash
# This is a generated gammurc file.
# It was generated by Gammu configurator 0.4

# In Unix/Linux  : copy it into your home directory and name it .gammurc
#                  or into /etc and name it gammurc
# In Win32       : copy it into directory with Gammu.exe and name gammurc

# Port           : in Windows/DOS: "com*:",
#                  (instead of "*" please put "1", "2", etc.)
#                  in other (Linux/Unix) "/dev/ttyS%"
#                                     or "/dev/ircomm%" ("irda" connection)
#                  (instead of "%" please put "0", "1", "2", etc.)
# Model          : use only, when Gammu doesn't recognize your phone model.
#                  Put it here. Example values: "6110", "6150", "6210", "8210"
# Connection     : type of connection. Use "fbus" or "mbus" or "dlr3" or
#                  "irda" (Infrared over sockets) or "infrared" (DirectIR)
#                  or "at19200" (AT commands on 19200, 8 bits, None parity,
#                  1 stop bit, no flow control) or "at115200" (AT commands on
#                  115200, 8 bits, None parity, 1 stop bit, no flow control)
#                  or "atblue" (AT over BlueTooth) or "dlr3blue" (FBUS
#                  over BlueTooth)
# SynchronizeTime: if you want to set time from computer to phone during
#                  starting connection. Do not rather use this option when want
#                  to reset phone during connection (in some phones need to
#                  set time again after restart)
# Logfile        : Use, when want to have logfile from communication.
# Logformat      : What debug info and format should be used:
#                  "nothing" - no debug level, "text" - transmission dump in
#                  text format, "textall" - all possible info in text format,
#                  "errors"  - errors in text format, "binary" - transmission
#                  dump in binary format
# Use_Locking    : under Unix/Linux use "yes", if want to lock used device
#                  to prevent using it by other applications
# GammuLoc       : name of localisation file

[gammu]

port = /dev/ttyUSB3
model =
connection = at19200
synchronizetime = yes
logfile =
logformat = nothing
use_locking =
gammuloc =
```

### æ‹¨æ‰“ç”µè¯

[ã€æ ‘è“æ´¾ã€‘4G æ¨¡å—æ‰“ç”µè¯\_æ ‘è“æ´¾æ‰“ç”µè¯-CSDN åšå®¢](https://blog.csdn.net/weixin_44566432/article/details/110095361)

### GPS

[19. ä½¿ç”¨ 4G æ¨¡å— â€” [é‡ç«]å¿«é€Ÿä½¿ç”¨æ‰‹å†Œâ€”â€”åŸºäº STM32MP157 å¼€å‘æ¿ æ–‡æ¡£](https://doc.embedfire.com/linux/stm32mp1/quick_start_guide/zh/latest/quick_start/4g_module/ec20_4g_module.html)

[blog.51cto.com/u_16213606/8883744](https://blog.51cto.com/u_16213606/8883744)

[æ ‘è“æ´¾+4G æ¨¡å—è·å– gps åæ ‡ - guwei4037 - åšå®¢å›­](https://www.cnblogs.com/guwei4037/p/14259371.html)

[EC20 æ¨¡å—åœ¨æ ‘è“æ´¾ä¸‹æŸ¥çœ‹ GPS æ•°æ®çš„æ¼”ç¤º\_ec20 æ˜¯å…¨ç³»åˆ—æ”¯æŒ gps ä¹ˆ-CSDN åšå®¢](https://blog.csdn.net/hzxiao1981/article/details/108295789)

```bash
sudo apt-get install minicom
sudo minicom -D /dev/ttyUSB2

# å¼€å¯ GPS
AT+QGPS=1

# æ–°å¼€ console
# æŸ¥çœ‹ GPS æ•°æ®
sudo minicom -D /dev/ttyUSB1
```

ä¸‰ã€é€šè¿‡ gpsd æŸ¥çœ‹ gps æ•° æ®

minicom æŸ¥çœ‹ gps æ•°æ®ä¸å¤ªå¥½çœ‹ï¼ˆæ•°æ®æ²¡æœ‰æ ¼å¼åŒ–æ˜¾ç¤ºï¼‰ï¼Œæœ‰ gpsd å·¥å…·å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„è§‚å¯Ÿæ•°æ®å˜åŒ–ã€‚

**1.å®‰è£… gpsd**

```bash
sudo apt-get install gpsd gpsd-clients python3-gps
```

**2.é…ç½® gpsd**

```bash
sudo gpsd /dev/ttyUSB1 -N -D 9 -F /var/run/gpsd.sock -S 3333
```

å…¶ä¸­ 3333 æ˜¯ç«¯å£å·ï¼Œå¯ä»¥è‡ªè¡Œå®šä¹‰

**3.ç›‘å¬ gpsd**
æ–°å¼€ä¸€ä¸ªç»ˆç«¯ï¼Œæ‰§è¡Œ `cgps -s localhost:3333`
å¯åŠ¨ä¹‹åï¼Œå¦‚æœå‡ºç°çŸ­æ—¶é—´æ”¶ä¸åˆ°æ•°æ®çš„æƒ…å†µï¼Œè¯·è€å¿ƒç­‰å¾…å‡ åˆ†é’Ÿã€‚ä¸€èˆ¬è¿‡ä¸ª 1 åˆ†é’Ÿå·¦åä¼šæ”¶åˆ° gps æ•°æ®çš„ã€‚
æœ€åï¼Œè¯»è€…å¯ä»¥è‡ªå·±å†™ç¨‹åºç›‘æ§ ttyUSB1 ä¸²å£è¾“å‡ºï¼Œè§£ææ•°æ®å°±å¯ä»¥å¾—åˆ° gps ä¿¡æ¯äº†ã€‚ç„¶åä¸Šä¼  gps åæ ‡ï¼Œå¯ä»¥é€šè¿‡ socket æˆ–å…¶å®ƒå½¢å¼ä¸æœåŠ¡å™¨é€šä¿¡ï¼ˆå‰æå·²é…ç½® 4G å¡æ— çº¿ä¸Šç½‘ï¼‰ï¼ŒæŠŠåæ ‡ä¿¡æ¯ä¿å­˜åˆ°æœåŠ¡å™¨æ•°æ®åº“ã€‚

### AT

[blog.51cto.com/u_13640625/3029461](https://blog.51cto.com/u_13640625/3029461)

```bash
sudo apt-get install minicom
sudo minicom -s
sudo minicom -b 9600 -o -D /dev/ttyUSB0

busybox microcom -s 115200 /dev/ttyUSB2
```

### å…¨é›†

[ä½¿ç”¨ EC20 æ¨¡å—é…åˆ asterisk åŠ freepbx å®ç°çŸ­ä¿¡è½¬å‘å’Œç½‘ç»œç”µè¯ | Sparktour's Blog](https://blog.sparktour.me/posts/2022/10/08/quectel-ec20-asterisk-freepbx-gsm-gateway/)

```bash
ttyUSB0
ttyUSB1 PCMè¯­éŸ³ï¼ŒGPSä¿¡å·
ttyUSB2 æ§åˆ¶å‘½ä»¤
ttyUSB3
```

![20250212211654_FMYNXrjX.webp](https://cdn.dong4j.site/source/image/20250212211654_FMYNXrjX.webp)

EC20 æŒ‚è½½ç³»ç»ŸæˆåŠŸåï¼Œåœ¨ Windows ç¯å¢ƒä¸‹ä¼šæœ‰ä¸‰ä¸ª com å£ï¼Œåˆ†åˆ«ä¸º AT Portã€DM Portã€NMEA Portã€‚å…¶ä¸­ AT Port ç”¨äº AT æŒ‡ä»¤çš„æ”¶å‘ï¼Œè€Œ NMEA Port ç”¨äº GPS NMEA æ•°æ®çš„æ¥æ”¶ã€‚
åœ¨ Linux ç³»ç»Ÿä¸‹ï¼ŒEC20 è¢«æˆåŠŸè¯†åˆ«å¹¶åŠ è½½åï¼Œä¼šæœ‰å››ä¸ª/dev/ttyUSBx è®¾å¤‡æ–‡ä»¶ï¼Œ
ttyUSB2 ç”¨äº AT æŒ‡ä»¤æ”¶å‘ï¼ŒttyUSB1 ç”¨äº GPS NMEA çš„æ¥æ”¶ã€‚

```bash
/dev/ttyUSB0ï¼šDM åŠŸèƒ½ï¼ˆDiagnostic and Monitoringï¼Œè¯Šæ–­å’Œç›‘æ§ï¼‰
/dev/ttyUSB1ï¼šGPS NMEA æ•°æ®æ¥æ”¶
/dev/ttyUSB2ï¼šAT æŒ‡ä»¤æ”¶å‘
/dev/ttyUSB3ï¼šPPP è¿æ¥æˆ–è€… AT æŒ‡ä»¤æ”¶å‘
```

## å‚è€ƒèµ„æ–™

### SIM7600CE

- [æ ‘è“æ´¾ç³»åˆ—æ•™ç¨‹ï¼šé€šè¿‡ SIM7600 4G æ¨¡å— NDIS æ‹¨å· - æ ‘è“æ´¾å…¥é—¨æ•™ç¨‹ å¾®é›ªè¯¾å ‚](https://www.waveshare.net/study/portal.php?mod=view&aid=962)
- [æ ‘è“æ´¾ç³»åˆ—æ•™ç¨‹ï¼šé€šè¿‡ SIM7600 4G æ¨¡å— NDIS æ‹¨å·](https://spotpear.cn/index/study/detail/id/268.html)

### EC20

- [æ ‘è“æ´¾ 4B 4G éšèº« wifi - Zok çš„åšå®¢](https://zhangkunzhi.com/2022/05/17/%E6%A0%91%E8%8E%93%E6%B4%BE4B-4G%E9%9A%8F%E8%BA%ABwifi/)
- [æ ‘è“æ´¾+4G æ¨¡å—æ¥æ”¶çŸ­ä¿¡å®æ—¶è½¬å‘åˆ°é‚®ç®±\_æ ‘è“æ´¾å¤–æ¥ sim å¡æ¨¡å—-CSDN åšå®¢](https://blog.csdn.net/tiaga/article/details/127975344)
- [4G æ¨¡å— ï¼šEC20 æ¨¡å—â€”â€”â€”AT æŒ‡ä»¤æ”¶å‘çŸ­ä¿¡-CSDN åšå®¢](https://blog.csdn.net/weixin_51600893/article/details/131969350)
- [æ ‘è“æ´¾ä½¿ç”¨ EC20 ä¸Šç½‘\_ec20 æ¨¡å—é€šè¿‡ç‰©ç†ä¸²å£è”ç½‘-CSDN åšå®¢](https://blog.csdn.net/LawSome/article/details/125743634)
- [æ ‘è“æ´¾ä¸“ç”¨å¤–å£³ç‰ˆ EC20 4GLTE æ¨¡å— è¯­éŸ³çŸ­ä¿¡ GPS Ubuntu SAM9X25â€”åŸºç¡€ç‰ˆ - æ ‘è“æ´¾ 4G æ¨¡å— Mcuzone å•†åŸ](http://www.mcuzone.com/SHOP/?product-468.html)
- [æ ‘è“æ´¾ EC20 æ¨¡å—è”ç½‘ | yan blog](https://yancoding.github.io/posts/3c0ad28a2fa4/)
- [ç¬¬ä¸‰èŠ‚ æ ‘è“æ´¾ EC20 ä¹‹ PPP æ‹¨å·ä¸Šç½‘\_æ ‘è“æ´¾æ‹¨å·ä¸Šç½‘-CSDN åšå®¢](https://blog.csdn.net/qq_30112663/article/details/124115912)
- [ç¬¬å››èŠ‚ æ ‘è“æ´¾ EC20 ä¹‹ QMI_WWAN æ‹¨å·\_quectel-cm-CSDN åšå®¢](https://blog.csdn.net/qq_30112663/article/details/124140466)
- [ç¬¬äº”èŠ‚ æ ‘è“æ´¾ EC20 è‡ªåŠ¨æ‹¨å·è„šæœ¬ç¼–å†™\_ec20 æ‹¨å·è„šæœ¬-CSDN åšå®¢](https://blog.csdn.net/qq_30112663/article/details/124228764)

## [ä½¿ç”¨ TTL è¿æ¥åˆ°æ ‘è“æ´¾ Zero 2W çš„è¯¦ç»†æŒ‡å—](https://blog.dong4j.site/posts/b13a9376.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ç®€ä»‹

ä»Šå¤©æŠ˜è…¾ä¸€ä¸‹ä½¿ç”¨ TTL è¿æ¥åˆ°æ ‘è“æ´¾ Zero 2W.

> ä¸²å£è¿æ¥æ˜¯ä¸€ç§å¸¸ç”¨çš„é€šä¿¡æ–¹å¼ï¼Œé€šå¸¸ç”¨äºè®¡ç®—æœºä¸å¤–éƒ¨è®¾å¤‡ä¹‹é—´çš„æ•°æ®ä¼ è¾“ã€‚å®ƒæ˜¯é€šè¿‡ä¸€æ ¹æˆ–å¤šæ ¹ç”µç¼†å°†è®¾å¤‡é€šè¿‡ä¸²è¡Œæ¥å£è¿æ¥èµ·æ¥ï¼Œæ•°æ®ä¸€ä½ä¸€ä½åœ°æŒ‰é¡ºåºä¼ è¾“ã€‚ä¸²å£é€šä¿¡å¯ä»¥åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šRS-232 å’Œ TTLï¼Œåˆ†åˆ«ä»£è¡¨ä¸åŒçš„ç”µæ°”æ ‡å‡†å’Œé€šä¿¡åè®®ã€‚

## å¼€å¯ä¸²å£

```bash
sudo raspi-config->Interfacing options-> Serial->Yes
```

## å®‰è£…é©±åŠ¨

macOS 14+ åè‡ªå¸¦ CH340X é©±åŠ¨, å› æ­¤ç›´æ¥ç”¨å°±å¯ä»¥äº†:

```bash
ls /dev/cu.*

è¾“å‡º:
cu.usbmodem57590428591
```

## screen

```bash
brew install screen
# è¿™é‡Œçš„ 11520 æ˜¯æ³¢ç‰¹ç‡ï¼Œåœ¨æ ‘è“æ´¾ä¸Šçš„ /boot/cmdline.txt è¿›è¡Œè®¾ç½®
screen /dev/cu.usbmodem57590428591 115200
```

## Notice

æ‰§è¡Œå®Œä¼šè¿›å…¥ä¸€ä¸ªç©ºç•Œé¢ï¼Œæ­¤æ—¶æŒ‰ Enter é”®ï¼Œå°±ä¼šå‡ºç° Raspberry Pi çš„ç™»å½•æç¤ºäº†ã€‚

å°†æ ‘è“æ´¾è¿›è¡Œ shutdown ä¹‹åï¼Œå¦‚æœæƒ³å†æ¬¡è¿æ¥ï¼Œéœ€è¦å°†æ•°æ®çº¿æ‹”æ‰ï¼Œç„¶åå†æ’ä¸Šã€‚æ­¤æ—¶å¯ä»¥å†æ¬¡è¿æ¥ï¼Œå¦åˆ™å¯èƒ½ä¼šå‡ºç° could not find PTY çš„é”™è¯¯æç¤ºã€‚
ç»ˆç«¯é€€å‡ºçš„æ—¶å€™ä¸ä¼šè‡ªåŠ¨æ–­å¼€ä¸æ ‘è“æ´¾çš„è¿æ¥ï¼š
è¿™æ—¶å¦‚æœç›´æ¥æ‹”æ‰ USB ä¸²å£æ¿ï¼Œä¼šé€ æˆç³»ç»Ÿé‡å¯ã€‚éœ€è¦æ‰§è¡Œï¼šps -x|grep ttyï¼Œå¾—åˆ°ä¸²å£è¿æ¥çš„è¿›ç¨‹å·ï¼Œç„¶åï¼škill è¿›ç¨‹å·ã€‚
å¦‚æœåªæ˜¯ä¸å°å¿ƒç»™å…³äº†ï¼Œéœ€è¦å†æ¬¡è¿æ¥ï¼ŒåŒæ ·éœ€è¦ kill ä¸€ä¸‹ï¼Œç„¶åå† screen è¿›è¡Œè¿æ¥ï¼Œå¦åˆ™ä¹Ÿå¯èƒ½ä¼šå‡ºç° could not find PTY çš„é”™è¯¯æç¤ºã€‚

```bash
ps -ef | grep -v grep | grep --color=auto /dev/cu.usbmodem57590428591
```

## screen

```bash
æŒ‰ ctrl + a ï¼Œctrlä¸æ”¾ï¼Œå†æŒ‰ d é”®æš‚æ—¶é€€å‡ºç»ˆç«¯

# æŸ¥çœ‹ä¼šè¯
screen -ls

There is a screen on:
	1995.ttys000.hepingdeMacBookPro1	(Detached)
1 Socket in /var/folders/gl/843qz1j92z5gh6j25h_r09vh0000gn/T/.screen.


screen -r 1995 #-rå°±æ˜¯æŒ‡å®šä¼šè¯id

æŒ‰ ctrl + a ï¼Œctrlä¸æ”¾ï¼Œå†æŒ‰ k é”®å¹²æ‰screenè¿›ç¨‹
æŒ‰kçš„æ—¶å€™ï¼Œä¼šè¯¢é—®è¦ä¸è¦å¹²æ‰è¿™ä¸ªä¼šè¯ï¼Œç›´æ¥æ‰“yå³å¯
```

![20250212192829_bhkQZP09.webp](https://cdn.dong4j.site/source/image/20250212192829_bhkQZP09.webp)

## USB ç«¯

![20250212192830_YllQTeNl.webp](https://cdn.dong4j.site/source/image/20250212192830_YllQTeNl.webp)

## è®¾å¤‡ç«¯

![20250212192830_Met2hLTd.webp](https://cdn.dong4j.site/source/image/20250212192830_Met2hLTd.webp)

## æ ‘è“æ´¾ 4B è¿æ¥ Zero 2W

- [æ ‘è“æ´¾ 4B å®‰è£… CH340 é©±åŠ¨](https://blog.csdn.net/qq_18677445/article/details/131191383)
- [æ ‘è“æ´¾å®‰è£… CH340 é©±åŠ¨ï¼ˆUSB è½¬ä¸²å£ï¼‰](https://blog.csdn.net/lwpo2008/article/details/103802483)
- [Linux ç¬”è®° | CH340/CH34x é©±åŠ¨å®‰è£…ç¬”è®°-ROS æŠ€æœ¯ç©ºé—´](http://keaa.net/linux-ch34x-driver.html)
- [ä½¿ç”¨ USB è½¬ UART ä¸²è¡Œçº¿ç™»å½•æ ‘è“æ´¾ 5 | æ ‘è“æ´¾å®éªŒå®¤](https://shumeipai.nxez.com/2024/05/07/login-to-your-raspberry-pi-5-using-a-usb-to-uart-cable.html)

## å‚è€ƒ

- [Mac ä¸Šä½¿ç”¨ä¸²å£ç™»é™†æ ‘è“æ´¾ 3](https://www.yanxurui.cc/posts/project/2017-08-28-login-raspberry3-via-uart-on-mac/)

## [Hexo éƒ¨ç½²åˆ©å™¨ï¼šGitHub Actions å®ç°è‡ªåŠ¨åŒ–å‘å¸ƒ](https://blog.dong4j.site/posts/a754e8c8.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ç®€ä»‹

ä¸€ç›´åœ¨ä½¿ç”¨ hexo-deploy-git æ’ä»¶éƒ¨ç½²æˆ‘çš„éƒ¨ç½²åˆ° Github Page, ä¸çŸ¥é“æœ€è¿‘æŠ½ä»€ä¹ˆé£, Github Pages éƒ¨ç½²ä¸€ç›´å¤±è´¥. 

ä»Šå¤©æœ‰ç©ºæŸ¥çœ‹äº†æ—¥å¿—æ‰å‘ç°ä¸€ç›´ä½¿ç”¨çš„æ˜¯ Jekyll æ¥ç¼–è¯‘æˆ‘çš„é™æ€æ–‡ä»¶, åº”è¯¥æ˜¯æˆ‘ä»¥å‰çš„åšå®¢éœ€è¦ä½¿ç”¨ Jekyll æ¥ç¼–è¯‘, ä¸è¿‡ç°åœ¨å·²ç»ä¸éœ€è¦äº†, å› ä¸ºæˆ‘ä¸Šä¼ çš„å·²ç»æ˜¯ Hexo ç¼–è¯‘åçš„é™æ€æ–‡ä»¶äº†, æœ€è¿‘åº”è¯¥æ˜¯ä¿®æ”¹äº†æŸäº›æ’ä»¶å¯¼è‡´ Jekyll è§£æ URL å‡ºç°äº†é—®é¢˜æ‰€ä»¥æ‰æš´éœ²äº†è¿™ä¸ªé—®é¢˜.

## è§£å†³æ–¹æ³•

å› ä¸ºæˆ‘ç›´æ¥ä¸Šä¼ çš„ Hexo ç¼–è¯‘åçš„ä»Šå¤©æ–‡ä»¶, æ‰€ä»¥åªéœ€è¦å°†é™æ€æ–‡ä»¶é€šè¿‡ Github Action æ‹·è´åˆ° Github Pages å³å¯, æ‰€ä»¥éƒ¨ç½²åº”è¯¥æ›´ç®€å•, ä¸‹é¢æ˜¯è¯¦ç»†è¿‡ç¨‹.

### ä¿®æ”¹ Pages é…ç½®

Github Pages é»˜è®¤ä½¿ç”¨ Jekyll æ¥éƒ¨ç½²:

![20250211200353_faujOtZF.webp](https://cdn.dong4j.site/source/image/20250211200353_faujOtZF.webp)

æ‰€ä»¥è¿™é‡Œéœ€è¦ä¿®æ”¹ä¸ºä½¿ç”¨è‡ªå®šä¹‰ action æ¥éƒ¨ç½²:

![20250211200508_J2LdVbxd.webp](https://cdn.dong4j.site/source/image/20250211200508_J2LdVbxd.webp)

### æ·»åŠ  action é…ç½®

```yaml
# Simple workflow for deploying static content to GitHub Pages
name: Deploy static content to Pages

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["deploy"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Single deploy job since we're just deploying
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Pages
        uses: actions/configure-pages@v5
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Upload entire repository
          path: '.'
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
```

æ„æ€æ˜¯ä¼šå°† `deploy` åˆ†æ”¯éƒ¨ç½²åˆ° GitHub Pages, æ“ä½œæ­¥éª¤ä¸€ç›®äº†ç„¶.

### éƒ¨ç½²å‘½ä»¤

è¿™é‡Œæ”¾å¼ƒäº†ä½¿ç”¨ `hexo-deploy-git` æ’ä»¶, ç›´æ¥ä½¿ç”¨è‡ªå®šä¹‰å‘½ä»¤æ¥æ‰§è¡Œéƒ¨ç½², å®šåˆ¶åŒ–æ›´å¼º.

éœ€è¦å®šåˆ¶çš„æ“ä½œæ˜¯ Github Action çš„é…ç½®å¦‚ä½•å¤„ç†.

å› ä¸ºæˆ‘ä»¬çŸ¥é“ `hexo-deploy-git` å…¶å®æ˜¯å°†ç¼–è¯‘åˆ° `public` ç›®å½•ä¸‹çš„æ–‡ä»¶å…¨éƒ¨æ‹·è´åˆ° `.deploy_git` ç›®å½•ä¸‹, ç„¶åæ‰§è¡Œå¼ºæ¨è¦†ç›–ä»“åº“çš„æ–‡ä»¶çš„,  æ‰€ä»¥æˆ‘ä»¬éœ€è¦æƒ³åŠæ³•å°† GitHub Action é…ç½®æ·»åŠ åˆ°ä»“åº“, ä¸‹é¢æ˜¯å…¨éƒ¨çš„éƒ¨ç½²å‘½ä»¤:

```bash
mkdir -p .deploy_git \
  && cd .deploy_git \
  && git init \
  && git remote add origin git@github.com:dong4j/dong4j.github.io.git \
  && git checkout -b deploy \
  && mkdir -p .github/workflows && cp ../.nojekyll ./ && cp ../.github/workflows/static.yml .github/workflows/ \
  && cp -r ../public/* ./ \
  && git add . \
  && git commit -m "auto deploy" > /dev/null 2>&1 \
  && git push origin deploy --force 
```

> å› ä¸ºæˆ‘ä½¿ç”¨ makefile æ¥ç®¡ç† hexo çš„æ•´ä¸ªç”Ÿå‘½å‘¨, è€Œä¸Šé¢çš„å‘½ä»¤åº”è¯¥æ˜¯ hexo g ä¹‹åæ‰èƒ½æ‰§è¡Œ.

å…³é”®çš„æ“ä½œä¸º:

- ä½¿ç”¨ deploy åˆ†æ”¯, è¿™ä¸ªéœ€è¦å’Œ Github Action é…ç½®ä¿æŒä¸€è‡´;
- æ‹·è´ `public` ç›®å½•ä¸‹ç¼–è¯‘åçš„æ–‡ä»¶åˆ° `.deploy_git` ç›®å½•ä¸­;
- æ·»åŠ  `.github/workflows` ä¸­çš„ Action é…ç½®æ–‡ä»¶, æ·»åŠ  `.nojekyll` æ–‡ä»¶ä»è€Œç¦ç”¨ Jekll(å¯é€‰);
- å¼ºåˆ¶æ¨é€åˆ°è¿œç«¯ä»“åº“;

### é—®é¢˜

ä¸€å¥—æµç¨‹ä¸‹æ¥, æ‰§è¡Œ GitHub Action æ˜¯å‡ºç°äº†é—®é¢˜:

![20250211205142_cMa0f4WG.webp](https://cdn.dong4j.site/source/image/20250211205142_cMa0f4WG.webp)

éœ€è¦ä¿®æ”¹ä¸€ä¸‹ rules, åˆ é™¤è¿™ä¸ª rule å³å¯:

![20250211205458_osSahphX.webp](https://cdn.dong4j.site/source/image/20250211205458_osSahphX.webp)



## æ€»ç»“

è¿™å¥—æµç¨‹æ“ä½œä¸‹æ¥, å‡å°‘äº†éƒ¨ç½²æ—¶é—´, ä¸»è¦æ˜¯æˆ‘æ²¿ç”¨äº†è€åšå®¢çš„ Github Pages é…ç½®, ä½†æ˜¯ä»Šå¤©æ‰çˆ†å‡ºé—®é¢˜æˆ‘ä¹Ÿéå¸¸è¯§å¼‚, æ²¡æƒ³åˆ° Jekll çš„å…¼å®¹æ€§è¿™ä¹ˆå¥½.

## [æ¡åƒåœ¾çš„å¿«ä¹ï¼šå› ä¸ºä¸€å¼ æ˜¾å¡ç»„è£…äº†ä¸€å°æœåŠ¡å™¨](https://blog.dong4j.site/posts/ded15d16.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ç®€ä»‹

> ä¸€å¹´å‰è´­ä¹°äº†ä¸€å¼  Tesla P40, èŠ±äº† 700+, ç°åœ¨å·²ç»æ¶¨ä»·åˆ° 1500+, æ˜¾å¡çœŸçš„æ˜¯ç†è´¢äº§å“.

å¹´å‰å°†è£…åœ¨å…¬å¸æœåŠ¡å™¨ä¸Šçš„çš„ Tesla P40 å¸¦å›äº†å®¶, æƒ³ç€å¦‚ä½•åœ¨å®¶å°†è¿™å¼ å¡å†æ¬¡åˆ©ç”¨èµ·æ¥, æ‰¾äº†ä¸€åœˆäº†æœ€ç»ˆé€‰æ‹©ä½¿ç”¨çŒ›å…½å³¡è°· 11 ä»£è®¡ç®—å¡ + å¤–ç½®æœºç®±æ¥é…åˆè¿™å¼ å¡.

## ç¡¬ä»¶é…ç½®

æˆ‘æ¯”è¾ƒå–œæ¬¢å¼€æ”¾å‹æœºç®±, ç›¸æ¯”æœ‰å¤§æ¯”ç¬¨é‡çš„ä¼ ç»Ÿæœºç®±, æˆ‘æ›´å–œæ¬¢çœ‹åˆ°å†…éƒ¨çš„å…ƒå™¨ä»¶, æ‰€ä»¥è¿™æ¬¡è¿˜æ˜¯æŒ‘é€‰çš„ä¸€ä¸ªå¼€æ”¾å‹å¹³å°:

1. 1200W CSPS ç”µæº + CSPS è½¬æ¥æ¿;
2. çŒ›å…½å³¡è°· 11 ä»£, i7 11700B è®¡ç®—å¡;
3. Tesla P40 æ˜¾å¡;
4. åä¸º SP310 åŒå…‰å£ä¸‡å…†ç½‘å¡;
5. æ¸©æ§ç‰ˆ;
6. å…¶ä»–å°é…ä»¶;

### CSPS ç”µæº

ç¬¬ä¸€æ¬¡ç©å„¿ CSPS ç”µæº, å°é»„é±¼æœ‰å¤§é‡æ”¹è£…é…ç½®, ç›¸æ¯”äºä¼ ç»Ÿçš„ SFX ç”µæºä¾¿å®œçš„å¤š:

> CSPS æ˜¯ Common Slot Power Supply çš„ç¼©å†™ï¼Œå¦‚ä»Šï¼Œéšç€ CPU å’Œæ˜¾å¡é¢‘ç‡çš„å¢åŠ ï¼Œå¯¹äºç”µæºçš„éœ€æ±‚ä¹Ÿè¶Šæ¥è¶Šå¤§ï¼Œè€Œç°åœ¨çš„å¥½çš„ç”µæºéå¸¸è´µï¼Œè€Œä»¥å¾€ 500 ç“¦èµ°å¤©ä¸‹çš„æ—¶ä»£å·²ç»ä¸€å»ä¸å¤è¿”äº†ï¼Œè¿™å¯¼è‡´ç©å®¶åªèƒ½ä¸€è¾¹éª‚ç”µæºå‚å•†ä¸€è¾¹å½“éŸ­èœï¼Œè€Œè¿™æ—¶ï¼ŒCSPS çš„ä¼˜ç‚¹å°±æ˜¾ç°å‡ºæ¥äº†ï¼Œç¬¬ä¸€ CSPS çš„ä½“ç§¯æ¯” SFX ç”µæºå°ï¼Œè€Œä¸”ï¼ŒåŠŸç‡è¦æ¯”éå¸¸è´µçš„ SFX ç”µæºå¤§å¾ˆå¤šï¼Œè¿™æ—¶å¯èƒ½æœ‰äººå°±è¯´æœåŠ¡å™¨ç”µæºå¤ªä¸‘äº†ï¼Œè€Œä¸”å™ªéŸ³å¾ˆå¤§ä¸è¿‡é‚£å·²ç»æ—¶å€™ 80plus é»„é‡‘æ—¶ä»£çš„è€é»„å†äº†ï¼Œéšç€é“‚é‡‘æ—¶ä»£çš„åˆ°æ¥å’Œæ¸©æ§é£æ‰‡çš„æ™®åŠï¼ŒCSPS åœ¨å™ªéŸ³ä¸Šä¹Ÿæœ‰äº†å’Œå»‰ä»·å¤§åŠŸç‡ ATX ç”µæºä¸€æˆ˜çš„èƒ½åŠ›ï¼Œæ¯•ç«Ÿä½ ä¸èƒ½è¦æ±‚è¿™ä¸ªæ¯” SFX ç”µæºçš„å°ä¸œè¥¿æ—¢èƒ½æœ‰å¤§åŠŸç‡è¾“å‡ºä¹Ÿèƒ½æ•åœ¨è€³è¾¹å…¥çœ ï¼Œä¸è¿‡å¯¹äºç”¨ N æ‰‹é£æ‰‡å’Œå‡ åå—é’±çš„æ˜¾å¡çš„åƒåœ¾ä½¬æ¥è¯´ï¼Œè¿™ä¸œè¥¿æ°¸è¿œä¸æ˜¯å™ªéŸ³çš„ä¸»è¦è´¡çŒ®è€…ï¼Œè€Œä¸”ä¸–ç•Œå¸‚åœºå‰äºŒçš„å æœ‰ç‡å³ä½¿é¢å¯¹çŸ¿æ½®ä¹Ÿæ¶¨å¹…ä¸å¤§ï¼Œè€Œä¸” 1200 ç“¦çš„åŠŸç‡ä¹Ÿè¶³ä»¥åº”å¯¹æ—©æ™šè¦å˜æˆçŸ¿æ¸£çš„ 3090,
>
> CSPS æ ‡å‡†çš„ 4.5mm è„šè·ä¹Ÿå¯ä»¥å…¼å®¹ä¾¿å®œçš„è¿æ¥å™¨ï¼Œè€Œä¸”è‹±ç‰¹å°”æœ€æ–°çš„ 12vo æ ‡å‡†æ˜¯å®Œå…¨ 12V åŒ–ï¼Œè¡¨é¢ä¸Šé«˜å…´çš„æ˜¯ç”µæºå‚å•†ï¼Œåˆå¯ä»¥æ¥ç€æ–°æ ‡å‡†å–ä¸€æ‰¹æ–°ç”µæºï¼Œè€Œæœ€å¤§çš„èµ¢å®¶å°±æ˜¯ CSPSï¼Œæ¯•ç«ŸæœåŠ¡å™¨ç”µæºæ—©å·²å®Œå…¨ 12v åŒ–ï¼Œè€Œå¯¹äºç›®å‰çš„ ATX æ ‡å‡†ï¼Œå¯ä»¥å»çœ‹ [@AlphaArea](https://space.bilibili.com/1292029/) è¿™ä¸ªè§†é¢‘ï¼š [https://www.bilibili.com/video/BV12A411N7AG](https://www.bilibili.com/video/BV12A411N7AG) é‡Œé¢è¯¦ç»†è®²è§£äº†æ”¹é€ çš„è¿‡ç¨‹

| ![20250214181102_C8y6T5RT.webp](https://cdn.dong4j.site/source/image/20250214181102_C8y6T5RT.webp) | ![20250214181103_GtjSOqGX.webp](https://cdn.dong4j.site/source/image/20250214181103_GtjSOqGX.webp) |
| :-------------------------------: | :-------------------------------: |
|              è½¬æ¥æ¿               |              æ ¸å¿ƒæ¿               |

### çŒ›å…½å³¡è°· 11 ä»£

![20250214181103_udVt3WAY.webp](https://cdn.dong4j.site/source/image/20250214181103_udVt3WAY.webp)

æˆ‘ä¹°çš„æ˜¯ IntelÂ® Coreâ„¢ i7-11700B + 16G å†…å­˜ + 500G ç¡¬ç›˜, è¿™å®¶ä¼™è‡ªå¸¦ 3 ä¸ª M.2 æ’æ§½, 11 ä»£åº•æ¿ä¸Šè¿˜æœ‰ä¸€ä¸ª, æ€»å…± 4 ä¸ª M.2 æ’æ§½, æ¯” M920x å¤šäº† 2 ä¸ª.

è¿™é‡Œæœ‰ä¸€ä»½ [è§„æ ¼ä¹¦](https://dlcdnets.asus.com/pub/ASUS/NUC/NUC_11_Extreme_Kit/NUC_11_Extreme_Kit_NUC11BT_DB_TPS.pdf):

{% pdf https://dlcdnets.asus.com/pub/ASUS/NUC/NUC_11_Extreme_Kit/NUC_11_Extreme_Kit_NUC11BT_DB_TPS.pdf %}

å¯ä»¥äº†è§£ä¸€ä¸‹è®¡ç®—å¡ä¸Šçš„æ¥å£, æ–¹ä¾¿åæœŸæ‰©å±•.

**11 ä»£åº•æ¿:**

![20250214181103_KhcGJEbM.webp](https://cdn.dong4j.site/source/image/20250214181103_KhcGJEbM.webp)

11 ä»£åº•æ¿æœ‰ 3 ä¸ª PCIe æ’æ§½, è®¡ç®—å¡å’Œæ˜¾å¡å„å ä¸€ä¸ª x16 æ’æ§½, å‰©ä¸‹çš„ä¸€ä¸ª x4 è¿˜èƒ½æ¥ç½‘å¡.

![20250214172317_uSAngBCa.webp](https://cdn.dong4j.site/source/image/20250214172317_uSAngBCa.webp)

**è®¡ç®—å¡çš„ IO æ¥å£:**

![20250214172359_AemEQ5Hi.webp](https://cdn.dong4j.site/source/image/20250214172359_AemEQ5Hi.webp)

### M.2 å›ºæ€ç¡¬ç›˜

è¿™å¼ è®¡ç®—å¡æ”¯æŒ 4 ä¸ª M.2 å›ºæ€, å…¶ä¸­ 3 ä¸ªåœ¨è®¡ç®—å¡ä¸Š, CPU å·¦è¾¹ 2 ä¸ªæ˜¯ PCIe 3 x4, å³è¾¹æ˜¯ PCIe 4 x4, å‰©ä¸‹çš„ä¸€ä¸ªåœ¨åº•æ¿ä¸Š, ä¸º PCIe 4 x4.

![20250215001939_i0v8s7dv.webp](https://cdn.dong4j.site/source/image/20250215001939_i0v8s7dv.webp)

M2 å›ºæ€å½“ç„¶è¦æ”¯æŒå›½äº§, æ‰€ä»¥ä¹°äº† 2 æ¡å…¨æ–°çš„ **è‡´æ€ Ti600 1TB** çš„ PCIe Gen4 x4 NVMe å›ºæ€ç¡¬ç›˜, ç„¶åå°é»„é±¼ä¸Šæ¡äº† 2 æ¡ **ä¸‰æ˜Ÿ PM981A 1TB** çš„ PCIe Gen3 x4 NVMe å›ºæ€ç¡¬ç›˜, æ‰“ç®—å°† 2 æ¡ **ä¸‰æ˜Ÿ PM981A**  ç»„ä¸ª RAID1, å¦å¤– 2 æ¡ PCIe Gen4 x4 NVMe ç‹¬ç«‹ä½¿ç”¨.



todo



> ä¸‰æ˜Ÿçš„ M.2 NVMe å›ºæ€ç¡¬ç›˜å‘½åä¸€ç›´åˆ†ä¸æ¸…, æŸ¥äº†ä¸‹èµ„æ–™:
>
> 9 å­—å¼€å¤´çš„éƒ½æ˜¯ M.2 æ”¯æŒ NVMe çš„ PCIe å›ºæ€ï¼Œå‰é¢å¸¦ PM çš„æ˜¯ OEM äº§å“ï¼ˆé€šä¿—ç‚¹è®²è¿™æ˜¯ä¸ªæ‰¹å‘è´§ï¼Œæ‰¹ç»™ç”µè„‘å‚å•†çš„ï¼‰æœ‰ PM981ã€PM961 ç­‰ï¼›9 åé¢ä¸¤ä¸ªæ•°å­—å¯ä»¥çœ‹æˆæ˜¯ä»£æ•°ï¼Œè¶Šå¤§è¶Šæ–°ï¼Œå‡ºçš„æ—¶é—´è¶Šæ™šã€‚é’ˆå¯¹æ°‘ç”¨é›¶å”®ç‰ˆæœ¬åé¢è¿˜æœ‰åç¼€å¦‚ 970 Proã€970 Evo ç”šè‡³è¿˜ä¼šæœ‰ Qvoï¼Œè¿™ä¸‰ä¸ªå­—æ¯ä»£è¡¨ç­‰çº§ï¼Œä¸»è¦æ˜¯é¢—ç²’ä¸Šçš„åŒºåˆ«ï¼šPro æ˜¯ MLC çš„é¢—ç²’ï¼ŒEvo æ˜¯ TLC é¢—ç²’ï¼ŒQvo æ˜¯ QLC çš„é¢—ç²’ï¼Œä»·æ ¼ä¸€èˆ¬æ˜¯è¿™ä¸ªæ’åºï¼Œæ€§èƒ½ä¹Ÿæ˜¯è¿™ä¸ªæ’åºã€‚

**éœ€è¦æ³¨æ„çš„æ˜¯**, å½“ä½¿ç”¨åº•æ¿ä¸Šçš„ M.2 æ’æ§½æ—¶, åº•æ¿ä¸Šçš„ PCIe x16 ä¼šè¢«æ‹†åˆ†æˆ **x8 + 2 x4**:

![20250215001717_0OnZmq7b.webp](https://cdn.dong4j.site/source/image/20250215001717_0OnZmq7b.webp)

### å†…å­˜

å†…å­˜åŸè£…ç»™äº† 2 å¼  8G çš„, ç°åœ¨éƒ½ 2025 å¹´äº†, 16G å¤Ÿè°ç”¨å•Š, æ‰€ä»¥å¦è´­äº† 2 å¼  32G DDR4 3200 çš„æµ·åŠ›å£«ç¬”è®°æœ¬å†…å­˜, ç»„æˆåŒé€šé“ 64G å†…å­˜:

todo

### SP310 åŒå…‰å£ä¸‡å…†ç½‘å¡

å°é»„é±¼æŒ‘äº†å¼ ä¾¿å®œçš„ä¸‡å…†ç½‘å¡:

![20250214181105_AJD5pEp6.webp](https://cdn.dong4j.site/source/image/20250214181105_AJD5pEp6.webp)

æœ¬æ‰“ç®—ä¹°å¼  Mellanox CX4121A çš„, ä¸è¿‡å…‰æ¨¡å—éƒ½å¿«èµ¶ä¸Š SP310 äº†, è€Œä¸”å®¶é‡Œä¸»è¦è¿˜æ˜¯ 10G çš„è®¾å¤‡å±…å¤š, æ‰€ä»¥è¿˜æ˜¯å…ˆä¹°å¼  10G çš„å…ˆç”¨ç€, ç­‰ 25G çš„ä»·æ ¼å†è…°æ–©çš„æ—¶å€™å†å‡çº§åˆ° 25G.

è¿™æ¬¡è´­ä¹°çš„æ˜¯åˆ†å¼€çš„ LC-LC å…‰çº¤, è¿æ¥çš„æ—¶å€™éœ€è¦æ³¨æ„çš„æ˜¯ 2 ä¸ªå…‰æ¨¡å—çš„å…‰çº¤çº¿è¦äº¤å‰, æ¯”å¦‚ä¸Šé¢æ¥çš„æ˜¯é»„è‰²çš„, é‚£ä¹ˆæ¥å…¥è·¯ç”±å™¨çš„é‚£ä¸€ç«¯ä¸Šé¢å°±è¦æ¥ç™½è‰²çš„.

![20250214181105_4eqE2nrz.webp](https://cdn.dong4j.site/source/image/20250214181105_4eqE2nrz.webp)

#### æ•£çƒ­

æˆ‘ä½ä¼°äº† SP310 çš„å‘çƒ­é‡, å› ä¸ºæ˜¯å¼€æ”¾å‹æœºç®±æ²¡æœ‰é£é“, ç§¯çƒ­ä¸¥é‡, æ‰€ä»¥ä¸å¾—ä¸åŠ ä¸Šä¸€ä¸ªæ•£çƒ­é£æ‰‡.

todo



### æ¸©æ§ç‰ˆ

![20250214181105_Z5US99QL.webp](https://cdn.dong4j.site/source/image/20250214181105_Z5US99QL.webp)

P40 çš„æ¶¡è½®é£æ‰‡å™ªéŸ³å¤ªå¤§, æ‰€ä»¥åŠ äº†ä¸ªæ¸©æ§ç‰ˆæ¥æ§åˆ¶å¯æ¶¡è½®é£æ‰‡çš„å¯åœ.

è¿™ä¸ªæ¸©æ§ç‰ˆéå¸¸å¥½ç”¨, æ‰€ä»¥ä¸€æ¬¡æ€§ä¹°äº† 5 ä¸ª, å®ƒå¯ä»¥è®¾ç½®å¼€å¯é£æ‰‡çš„æ¸©åº¦èŒƒå›´, è¿™æ · P40 çš„æ¶¡è½®é£æ‰‡å°±ä¸ç”¨ä¸€ç›´è½¬äº†, æ¯•ç«Ÿå™ªéŸ³è¿˜æ˜¯æŒºå¤§çš„.

![20250214181105_x9N79aS2.webp](https://cdn.dong4j.site/source/image/20250214181105_x9N79aS2.webp)

æˆ‘å°†æ¸©åº¦æ¢å¤´å®‰è£…åˆ°äº†æ˜¾å¡èƒŒæ¿ä¸Š, æ¸©æ§ç‰ˆè®¾ç½®ä¸º 35 åº¦å¼€,30 åº¦å…³, è¿™æ ·æ˜¾å¡æ¸©åº¦åŸºæœ¬ä¸Šèƒ½å¤Ÿå¾ˆå¥½æ§åˆ¶åœ¨ç†æƒ³èŒƒå›´å†….

### æœ€ç»ˆæ•ˆæœ

æ¥äº†ä¸ªåŸæ¥å‰©ä¸‹çš„ LCD, æ‹¿æ¥æ˜¾ç¤º CPU å’Œ RAM çš„ä½¿ç”¨æƒ…å†µ.

![20250214181106_qdjsM4Li.webp](https://cdn.dong4j.site/source/image/20250214181106_qdjsM4Li.webp)

å¤–æ¥äº†æ•£çƒ­é£æ‰‡, USB è½¬ 2.5G ç½‘å¡å’Œä¸€ä¸ª 4G æ¨¡å—.

![20250214181106_l9U422bW.webp](https://cdn.dong4j.site/source/image/20250214181106_l9U422bW.webp)

**ä¸Šç”µå¼€æœº**

æ­£é¢ç…§:

åŠ äº†ä¸ªç”µå‹æ˜¾ç¤ºæ¨¡å—, ä¸å¾—ä¸è¯´è¿™ä¸ª CSPS è½¬æ¥æ¿è¾“å‡ºçš„ç”µå‹çœŸç¨³å®š, ä¸€ç›´ 12.2V æ²¡æœ‰è·³åŠ¨è¿‡.

![20250214181106_Htk7JHbD.webp](https://cdn.dong4j.site/source/image/20250214181106_Htk7JHbD.webp)

ä¾§é¢ç…§:

ç½‘å¡åˆšå¥½èƒ½å¤Ÿå¡çš„ä¸‹, æ‰€ä»¥ä¸è¦ä¹°é‚£ç§æ•£çƒ­ç‰‡ä¸Šé¢å¸¦é£æ‰‡çš„ç½‘å¡, å®½åº¦ä¸å¤Ÿ.

![20250214181106_8JnrW2th.webp](https://cdn.dong4j.site/source/image/20250214181106_8JnrW2th.webp)

---

## å®‰è£…ç³»ç»Ÿ

æ­£å¥½æ‰‹ä¸Šæœ‰ä¸€ä¸ª Ubuntu Server 22.04 TLS çš„å¯åŠ¨ U ç›˜, æ‰€ä»¥è¿™é‡Œå…ˆå®‰è£… 22.04, ç„¶åå†å‡çº§åˆ° 24.04 TLS.

è¿™é‡Œå…ˆè¿› BIOS ä¿®æ”¹è§†é¢‘è¾“å‡º, **IGFX** æ˜¯é›†æ˜¾, **PEG Slot** æ˜¯ç‹¬æ˜¾, åŸæ¥æ˜¯ç‹¬æ˜¾è¾“å‡º, è¿™é‡Œä¿®æ”¹ä¸º **IGFX**:

![20250211194210_DKLLC8uq.webp](https://cdn.dong4j.site/source/image/20250211194210_DKLLC8uq.webp)

Ubuntu çš„å®‰è£…å°±ä¸èµ˜è¿°äº†, ç½‘ä¸Šä¸€å¤§å †æ•™ç¨‹.

### ç½‘å¡é—®é¢˜

ç³»ç»Ÿå®‰è£…å®Œæˆå, é‡å¯æ’ä¸Š Tesla P40, å‡†å¤‡å‡çº§ç³»ç»Ÿå¹¶å®‰è£…æ˜¾å¡é©±åŠ¨å’Œ CUDA.

é‡ç‚¹æ¥äº†, è¿›å…¥ç³»ç»Ÿåå‘ç°ç½‘å¡ç¯ç­äº†, æ— æ³•è·å–åˆ° IP, ä¹Ÿå°±æ— æ³•åœ¨çº¿å‡çº§äº†, æ‰€ä»¥éœ€è¦å…ˆè§£å†³è¿™ä¸ªé—®é¢˜.

å…ˆé—®äº†ä¸€ä¸‹ ChatGPT å¯èƒ½çš„åŸå› :

1. **PCIe èµ„æºå†²çª**

   çŒ›å…½å³¡è°·ï¼ˆIntel NUC 11 Extremeï¼‰å¯èƒ½åœ¨æ’ä¸Šç‹¬ç«‹æ˜¾å¡åï¼Œä¸»æ¿çš„ PCIe èµ„æºé‡æ–°åˆ†é…ï¼Œå¯¼è‡´æŸäº›è®¾å¤‡ï¼ˆå¦‚å†…ç½®ç½‘å¡ï¼‰å¤±æ•ˆã€‚

2. **BIOS è®¾ç½®é—®é¢˜**

   éƒ¨åˆ† BIOS å¯èƒ½ä¼šåœ¨æ’å…¥ç‹¬ç«‹æ˜¾å¡åï¼Œè°ƒæ•´ PCIe é€šé“åˆ†é…ï¼Œä»è€Œç¦ç”¨æŸäº›è®¾å¤‡ï¼ŒåŒ…æ‹¬ç½‘å¡ã€‚

3. **ä¾›ç”µæˆ–ç¡¬ä»¶å†²çª**

   éƒ¨åˆ†ä¸»æ¿åœ¨æ’å…¥ç‹¬ç«‹æ˜¾å¡åå¯èƒ½ä¼šä¼˜å…ˆä¸ºæ˜¾å¡ä¾›ç”µï¼Œè€Œå¯¼è‡´æŸäº›è®¾å¤‡ï¼ˆå¦‚ç½‘å¡ï¼‰æ— æ³•æ­£å¸¸å·¥ä½œã€‚

4. **Linux è®¾å¤‡é©±åŠ¨é—®é¢˜**

   Ubuntu å¯èƒ½æ²¡æœ‰æ­£ç¡®åŠ è½½ç½‘å¡é©±åŠ¨ï¼Œæˆ–è€…æ’å…¥æ˜¾å¡åï¼Œç½‘å¡çš„ PCIe ID å‘ç”Ÿå˜åŒ–ï¼Œå¯¼è‡´å†…æ ¸æ²¡æœ‰è¯†åˆ«åˆ°ç½‘å¡ã€‚

ç½‘å¡åœ¨è¿›å…¥ BIOS ä¸”åœ¨è¿›å…¥ç³»ç»Ÿå‰éƒ½æ˜¯æ²¡é—®é¢˜çš„, ä½†æ˜¯è¿›å…¥ç³»ç»Ÿåç½‘å¡å°±ç­äº†, å› ä¸ºæ˜¯åœ¨æ’å…¥æ˜¾å¡åå‡ºç°çš„é—®é¢˜, æ‰€ä»¥é¦–å…ˆæ€€ç–‘æ˜¯ PCIe èµ„æºå†²çªå¯¼è‡´çš„,

æ‰€ä»¥å…ˆæ£€æŸ¥äº†ä¸€ä¸‹ PCIe èµ„æº:

```bash
$ lspci
00:00.0 Host bridge: Intel Corporation 11th Gen Core Processor Host Bridge/DRAM Registers (rev 05)
00:01.0 PCI bridge: Intel Corporation 11th Gen Core Processor PCIe Controller #1 (rev 05)
00:02.0 VGA compatible controller: Intel Corporation TigerLake-H GT1 [UHD Graphics] (rev 01)
00:06.0 PCI bridge: Intel Corporation 11th Gen Core Processor PCIe Controller #0 (rev 05)
00:07.0 PCI bridge: Intel Corporation Tiger Lake-H Thunderbolt 4 PCI Express Root Port #1 (rev 05)
00:07.2 PCI bridge: Intel Corporation Tiger Lake-H Thunderbolt 4 PCI Express Root Port #2 (rev 05)
00:08.0 System peripheral: Intel Corporation GNA Scoring Accelerator module (rev 05)
00:0d.0 USB controller: Intel Corporation Tiger Lake-H Thunderbolt 4 USB Controller (rev 05)
00:0d.2 USB controller: Intel Corporation Tiger Lake-H Thunderbolt 4 NHI #0 (rev 05)
00:0d.3 USB controller: Intel Corporation Tiger Lake-H Thunderbolt 4 NHI #1 (rev 05)
00:14.0 USB controller: Intel Corporation Tiger Lake-H USB 3.2 Gen 2x1 xHCI Host Controller (rev 11)
00:14.2 RAM memory: Intel Corporation Tiger Lake-H Shared SRAM (rev 11)
00:16.0 Communication controller: Intel Corporation Tiger Lake-H Management Engine Interface (rev 11)
00:1b.0 PCI bridge: Intel Corporation Device 43c2 (rev 11)
00:1b.3 PCI bridge: Intel Corporation Device 43c3 (rev 11)
00:1f.0 ISA bridge: Intel Corporation WM590 LPC/eSPI Controller (rev 11)
00:1f.3 Audio device: Intel Corporation Tiger Lake-H HD Audio Controller (rev 11)
00:1f.4 SMBus: Intel Corporation Tiger Lake-H SMBus Controller (rev 11)
00:1f.5 Serial bus controller: Intel Corporation Tiger Lake-H SPI Controller (rev 11)
01:00.0 3D controller: NVIDIA Corporation GP102GL [Tesla P40] (rev a1)
02:00.0 Non-Volatile memory controller: Silicon Motion, Inc. SM2263EN/SM2263XT (DRAM-less) NVMe SSD Controllers (rev 03)
59:00.0 Network controller: Intel Corporation Wi-Fi 6E(802.11ax) AX210/AX1675* 2x2 [Typhoon Peak] (rev 1a)
5a:00.0 Ethernet controller: Intel Corporation Ethernet Controller I225-LM (rev 03)
```

çœ‹ç€æ²¡å•¥é—®é¢˜, ç½‘å¡å’Œæ˜¾å¡éƒ½è¯†åˆ«åˆ°äº†, æ‰€ä»¥ä¸æ˜¯ PCIe çš„é—®é¢˜.

åæ¥æ’ä»¶ç½‘å¡æ‰å‘ç°é—®é¢˜:

```bash
$ ip link show enp90s0

2: enp90s0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state DOWN mode DEFAULT group default qlen 1000
```

è¾“å‡ºä¸­ **state DOWN**ï¼Œè¯´æ˜ç½‘å¡æ˜¯è¢«ç¦ç”¨çš„, æ‰‹åŠ¨å¯åŠ¨å¹¶é‡æ–°è·å– IP å°±å¯ä»¥äº†:

```bash
$ sudo ip link set enp90s0 up
$ sudo dhclient enp90s0
```

å› ä¸º Ubuntu Server ç‰ˆæœ¬ï¼ˆç‰¹åˆ«æ˜¯ 22.04+ï¼‰é»˜è®¤ä½¿ç”¨ systemd-networkd è¿›è¡Œç½‘ç»œç®¡ç†ï¼Œè€Œä¸æ˜¯ NetworkManagerã€‚å¦‚æœ systemd-networkd æ²¡æœ‰æ­£ç¡®é…ç½®ï¼Œç½‘å¡å¯èƒ½ä¸ä¼šè‡ªåŠ¨å¯ç”¨ã€‚ä¸”åœ¨ `/etc/systemd/network/` ä¸‹æ²¡æœ‰å‘ç°ä»»ä½•ç½‘ç»œé…ç½®, å› æ­¤å¯ä»¥æ–­å®šæ˜¯è¿™ä¸ªåŸå› äº†.

é‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯é…ç½®ç½‘å¡:

```bash
sudo vim /etc/systemd/network/10-enp90s0.network

[Match]
Name=enp90s0

[Network]
DHCP=yes
IPv6AcceptRA=yes
```

```bash
# é‡å¯ systemd-networkd
sudo systemctl restart systemd-networkd
sudo systemctl enable systemd-networkd
```

### é…ç½® WiFi ç½‘å¡

å› ä¸ºä½¿ç”¨ `wpa_supplicant` é…ç½® WiFi ä¸€ç›´æŠ¥é”™, æ‰€ä»¥è¿™é‡Œæ‰“ç®—ä½¿ç”¨ `NetworkManager` ä»£æ›¿ `systemd-networkd` æ¥ç®¡ç†ç½‘ç»œ.

```bash
sudo apt update \
	&& sudo apt install network-manager \
	&& sudo systemctl enable NetworkManager \
	&& sudo systemctl start NetworkManager \
	&& sudo systemctl status NetworkManager
```

**æŸ¥çœ‹æ‰€æœ‰ç½‘ç»œæ¥å£ï¼š**:

```bash
$ nmcli device
DEVICE           TYPE      STATE         CONNECTION
enp91s0          ethernet  unmanaged     --							# è‡ªå¸¦ç½‘å¡
enx00e04c68bbcf  ethernet  unmanaged     --							# USB è½¬ 2.5G ç½‘å¡
wlp90s0          wifi      unmanaged     --							# è‡ªå¸¦ WiFi ç½‘å¡
enp2s0f0         ethernet  unmanaged     --							# 10G å…‰å£ 1
enp2s0f1         ethernet  unmanaged     --							# 10G å…‰å£ 2
lo               loopback  unmanaged     --
```

`enp90s0` å’Œæ–°å¢çš„ USB è½¬ 2.5G ç½‘å¡ `enx00e04c68bbcf` åˆå¾—é‡æ–°é…ç½®äº†. å› ä¸ºç°åœ¨ä½¿ç”¨ SSH é“¾æ¥çš„æœåŠ¡å™¨, ä¸ºäº†é¿å…é…ç½®æœ‰çº¿ç½‘å¡æ—¶æ–­å¼€è¿æ¥, è¿™é‡Œå…ˆé…ç½®å¥½ WiFi ç½‘å¡.

```bash
nmcli device wifi list  # æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨çš„ WiFi ç½‘ç»œ
sudo nmcli device wifi connect "WiFi_SSID" password "WiFi_Password"
```

é¡ºåˆ©çš„è¯åº”è¯¥å°±èƒ½ç›´æ¥è¿ä¸Šäº†:

```bash
Device 'wlp89s0' successfully activated with '83298781-7335-4b6e-b293-676411eaa1df'.
```

é…ç½®è‡ªåŠ¨è¿æ¥ WiFi:

```bash
sudo nmcli connection modify "WiFi_SSID" connection.autoconnect yes
nmcli connection show "WiFi_SSID"
```

> åœ¨è¾“å‡ºä¸­ï¼Œç¡®ä¿ connection.autoconnect è®¾ç½®ä¸º yes
>
> **æ–­å¼€å¹¶é‡æ–°è¿æ¥**
>
> å¦‚æœéœ€è¦ï¼Œä½ å¯ä»¥æ–­å¼€å½“å‰ Wi-Fi è¿æ¥å¹¶é€šè¿‡å‘½ä»¤é‡æ–°è¿æ¥ï¼š
>
> ```bash
> nmcli connection down "WiFi_SSID"
> nmcli connection up "WiFi_SSID"
> ```

---

æ¥ä¸‹æ¥æ˜¯é…ç½® 2 å¼ æœ‰çº¿ç½‘å¡å’Œä¸‡å…†ç½‘å¡, ç¦ç”¨ `systemd-networkd` å¹¶åˆ‡æ¢åˆ° `NetworkManager`. é¦–å…ˆé€šè¿‡ WiFi é“¾æ¥æœåŠ¡å™¨, ç„¶åå†è¿›è¡Œä¸‹é¢çš„æ“ä½œ.

```bash
# åˆ é™¤ `/etc/systemd/network/` ç›®å½•ä¸‹çš„ç½‘ç»œé…ç½®æ–‡ä»¶
sudo rm -rf /etc/systemd/network/*.network

sudo systemctl stop systemd-networkd
sudo systemctl disable systemd-networkd
```

### ä½¿ç”¨ NetworkManager

```bash
# æ£€æŸ¥ç½‘å¡
nmcli device

# é€šè¿‡ nmcli é…ç½®æœ‰çº¿ç½‘å¡
sudo nmcli connection add type ethernet ifname enp90s0 con-name "2.5G.T" autoconnect yes
sudo nmcli connection add type ethernet ifname enx00e04c68bbcf con-name "2.5G.U" autoconnect yes
sudo nmcli connection add type ethernet ifname enp2s0f0 con-name "10G.T" autoconnect yes
sudo nmcli connection add type ethernet ifname enp2s0f1 con-name "10G.U" autoconnect yes
# è¿™ä¸€æ­¥ä¼šæŠ¥é”™, æ‰€æœ‰æˆ‘è¿™é‡Œé‡å¯äº†æœåŠ¡å™¨, ç„¶åä½¿ç”¨ wifi é“¾æ¥
sudo nmcli connection up "2.5G.T"
sudo nmcli connection up "2.5G.U"
sudo nmcli connection up "10G.T"
sudo nmcli connection up "10G.U"

# æŸ¥çœ‹è¿æ¥ä¿¡æ¯
nmcli connection show
```

### è®¾ç½® MTU

ä¸‡å…†ç½‘å¡éœ€è¦å°† MTU è®¾ç½®ä¸º `9000`:

```bash
sudo nmcli connection modify "10G.T" 802-3-ethernet.mtu 9000
sudo nmcli connection modify "10G.U" 802-3-ethernet.mtu 9000

sudo nmcli connection up "10G.T"
sudo nmcli connection up "10G.U"
```

éªŒè¯:

```bash
$ ip link show enp2s0f0
3: enp2s0f0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9000 qdisc mq state UP mode DEFAULT group default qlen 1000
    link/ether 18:9b:a5:80:5a:05 brd ff:ff:ff:ff:ff:ff
```

## å‡çº§ç³»ç»Ÿ

å‡çº§ç³»ç»Ÿåˆ°æœ€æ–°çš„ 24.04 TLS

```bash
sudo apt upgrade -y
do-release-upgrade
```

### å®‰è£… docker

```bash
sudo apt update && sudo apt upgrade -y \
	&& sudo apt install -y ca-certificates curl gnupg \
	&& sudo install -m 0755 -d /etc/apt/keyrings \
  && curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo tee /etc/apt/keyrings/docker.asc > /dev/null \
	&& sudo chmod a+r /etc/apt/keyrings/docker.asc \
	&& echo "deb [signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu noble stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null \
	&& sudo apt update \
	&& sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

**éªŒè¯ Docker æ˜¯å¦å®‰è£…æˆåŠŸ**:

```bash
sudo systemctl enable --now docker \
	&& sudo docker version
```

**éªŒè¯ Docker Compose**:

```bash
docker compose version
```

**æ™®é€šç”¨æˆ·è¿è¡Œ Docker**:

```bash
sudo usermod -aG docker $USER \
	&& newgrp docker
```

### å®‰è£… Node å’Œ pm2

```bash
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash - \
	&& sudo apt install -y nodejs \
	&& sudo npm install -g pm2 \
	&& pm2 -v
```

## å®‰è£…æ˜¾å¡é©±åŠ¨

```bash
$ ubuntu-drivers devices

...
vendor   : NVIDIA Corporation
model    : GP102GL [Tesla P40]
driver   : nvidia-driver-550 - distro non-free recommended
driver   : nvidia-driver-535-server - distro non-free
driver   : nvidia-driver-470-server - distro non-free
driver   : nvidia-driver-535 - distro non-free
...
```

æ¨èçš„ç‰ˆæœ¬æ˜¯ `nvidia-driver-550`, å®‰è£…å®ƒ:

```bash
sudo apt install nvidia-driver-550
```

é‡å¯åå¯ä½¿ç”¨ `nvidia-smi` æŸ¥çœ‹æ˜¾å¡ä¿¡æ¯:

```bash
+-----------------------------------------------------------------------------------------+
| NVIDIA-SMI 550.120                Driver Version: 550.120        CUDA Version: 12.4     |
|-----------------------------------------+------------------------+----------------------+
| GPU  Name                 Persistence-M | Bus-Id          Disp.A | Volatile Uncorr. ECC |
| Fan  Temp   Perf          Pwr:Usage/Cap |           Memory-Usage | GPU-Util  Compute M. |
|                                         |                        |               MIG M. |
|=========================================+========================+======================|
|   0  Tesla P40                      Off |   00000000:01:00.0 Off |                  Off |
| N/A   37C    P8             11W /  250W |       0MiB /  24576MiB |      0%      Default |
|                                         |                        |                  N/A |
+-----------------------------------------+------------------------+----------------------+

+-----------------------------------------------------------------------------------------+
| Processes:                                                                              |
|  GPU   GI   CI        PID   Type   Process name                              GPU Memory |
|        ID   ID                                                               Usage      |
|=========================================================================================|
|  No running processes found                                                             |
+-----------------------------------------------------------------------------------------+
```

### å…³é—­ ECC

Tesla ç³»åˆ— GPU é»˜è®¤å¼€å¯äº† ECC(error correcting code, é”™è¯¯æ£€æŸ¥å’Œçº æ­£)åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½å¯ä»¥æé«˜æ•°æ®çš„æ­£ç¡®æ€§ï¼Œéšä¹‹è€Œæ¥çš„æ˜¯å¯ç”¨å†…å­˜çš„å‡å°‘å’Œæ€§èƒ½ä¸Šçš„æŸå¤±ã€‚

ECC å†…å­˜æ”¯æŒï¼šP4 æ”¯æŒ ECC æ ¡éªŒï¼Œå¼€å¯åä¼šæŸå¤±ä¸€éƒ¨åˆ†æ˜¾å­˜

å¼€å¯è¿‡åï¼Œæ˜¾å­˜å¯ç”¨ä¸º 7611MBï¼Œå…³é—­åå¯ç”¨ä¸º 8121MBã€‚

é€šè¿‡`nvidia-smi | grep Tesla`æŸ¥çœ‹å‰é¢ GPU ç¼–å·ï¼š0

```
$ nvidia-smi | grep Tesla
|   0  Tesla P40                      Off |   00000000:01:00.0 Off |                  Off |
-----------------------------------------------------------------------------------------

nvidia-smi -i n -e 0/1 å¯å…³é—­(0)/å¼€å¯(1) , næ˜¯GPUçš„ç¼–å·
```

æ‰§è¡Œå…³é—­ ECC `sudo nvidia-smi -i 0 -e 0`, é‡å¯åè¯¥è®¾ç½®ç”Ÿæ•ˆã€‚

> **å€¼å¾—æ³¨æ„çš„æ˜¯å¼€å¯ ECC å…³é—­ ECC è¿™ä¸ªæ“ä½œæ˜¯æœ‰å¯¿å‘½çš„ï¼Œå¼€å…³å‡ åƒæ¬¡å°±ä¸èƒ½å†ç»§ç»­å¼€å…³äº†ã€‚**

---

## å®‰è£… CUDA

> æ›´æ–°å®‰è£…æ–¹å¼: https://docs.nvidia.com/cuda/cuda-installation-guide-linux/#network-repo-installation-for-ubuntu

`nvidia-smi` ä¿¡æ¯ä¸­æœ‰ä¸ªéå¸¸é‡è¦çš„å¯èƒ½äº§ç”Ÿè¯¯å¯¼çš„é—®é¢˜ï¼Œåˆ—è¡¨ä¸­çš„ **CUDA Version: 12.4**ï¼Œåªæ˜¯ä»£è¡¨è¯¥æ˜¾å¡æ”¯æŒçš„ CUDA æœ€é«˜ç‰ˆæœ¬æ˜¯ 12.4ï¼Œå³è¯¥æ˜¾å¡åªèƒ½å®‰è£…**12.4** ä»¥ä¸‹ç‰ˆæœ¬çš„ CUDAã€‚å¹¶ä¸æ˜¯è¯´å·²ç»å®‰è£…äº†è¯¥ç‰ˆæœ¬ï¼Œä¸‹ä¸€æ­¥æ ¹æ®æœ¬æ­¥éª¤çš„ä¿¡æ¯ï¼Œå®‰è£… CUDA 12.4ã€‚ä¸ºäº†é¿å…å…¼å®¹æ€§ï¼Œè¿™é‡Œå®‰è£… 12.4.0ï¼Œæ²¡æœ‰å®‰è£… update çš„ç‰ˆæœ¬ã€‚

[è®¿é—® NVIDIA å¼€å‘è€…ç½‘ç«™ CUDA ä¸‹è½½é¡µé¢](https://developer.nvidia.com/cuda-downloads?target_os=Linux), é»˜è®¤æ˜¯æœ€æ–°ç‰ˆæœ¬, é€šè¿‡ `Archive of Previous CUDA Releases` é€‰æ‹©å…¶ä»–ç‰ˆæœ¬:

![20250210003613_tmki4llf.webp](https://cdn.dong4j.site/source/image/20250210003613_tmki4llf.webp)

[CUDA Toolkit 12.4.0 Downloads](https://developer.nvidia.com/cuda-12-4-0-download-archive?target_os=Linux&target_arch=x86_64&Distribution=Ubuntu&target_version=22.04&target_type=deb_local):

![20250211194215_YLSZBV30.webp](https://cdn.dong4j.site/source/image/20250211194215_YLSZBV30.webp)

ä¾æ¬¡é€‰æ‹©æ“ä½œç³»ç»ŸåŠå…¶ç‰ˆæœ¬, ç„¶åæŒ‰ç…§å®‰è£…æ­¥éª¤å¤åˆ¶ç²˜è´´å›è½¦å³å¯.

CUDA 12.4.0 æ”¯æŒçš„ Ubuntu æœ€é«˜ç‰ˆæœ¬ä¸º 22.04ï¼Œå¦‚æœç³»ç»Ÿä¸º 24.04ï¼Œåˆ™åœ¨å®‰è£…æ—¶å¯èƒ½ä¼šé‡åˆ°é—®é¢˜ã€‚

### é—®é¢˜

```
$ sudo apt-get -y install cuda-toolkit-12-4
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
Some packages could not be installed. This may mean that you have
requested an impossible situation or if you are using the unstable
distribution that some required packages have not yet been created
or been moved out of Incoming.
The following information may help to resolve the situation:

The following packages have unmet dependencies:
 nsight-systems-2023.4.4 : Depends: libtinfo5 but it is not installable
E: Unable to correct problems, you have held broken packages.
```

è¿™æ˜¯å› ä¸º Ubuntu 24.04 é»˜è®¤ä½¿ç”¨ `libtinfo6`ï¼Œè€ŒæŸäº›è½¯ä»¶åŒ…ä»ä¾èµ–äºæ—§ç‰ˆæœ¬çš„ `libtinfo5`ã€‚ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥æ‰‹åŠ¨å®‰è£… `libtinfo5`ã€‚ ä»¥ä¸‹æ˜¯å…·ä½“æ­¥éª¤ï¼š

1. **ä¸‹è½½ `libtinfo5` åŒ…**ï¼š æ‰“å¼€ç»ˆç«¯ï¼Œä½¿ç”¨ `wget` å‘½ä»¤ä¸‹è½½é€‚ç”¨äº Ubuntu 24.04 çš„ `libtinfo5` åŒ…ï¼š

   ```bash
   wget http://security.ubuntu.com/ubuntu/pool/universe/n/ncurses/libtinfo5_6.3-2ubuntu0.1_amd64.deb
   ```

   è¯·æ³¨æ„ï¼Œ`libtinfo5` åŒ…çš„ç‰ˆæœ¬å¯èƒ½ä¼šéšç€æ—¶é—´æ›´æ–°ï¼Œå»ºè®®è®¿é—® [Ubuntu å®˜æ–¹è½¯ä»¶åŒ…å­˜æ¡£](http://security.ubuntu.com/ubuntu/pool/universe/n/ncurses/) è·å–æœ€æ–°ç‰ˆæœ¬çš„ä¸‹è½½é“¾æ¥ã€‚

2. **å®‰è£… `libtinfo5` åŒ…**ï¼š ä¸‹è½½å®Œæˆåï¼Œä½¿ç”¨ `dpkg` å‘½ä»¤å®‰è£…è¯¥åŒ…ï¼š

   ```bash
   sudo dpkg -i libtinfo5_6.3-2ubuntu0.1_amd64.deb
   ```

   å¦‚æœåœ¨å®‰è£…è¿‡ç¨‹ä¸­é‡åˆ°ä¾èµ–é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®å¤ï¼š

   ```bash
   sudo apt --fix-broken install
   ```

3. **å®‰è£… CUDA Toolkit 12.4**ï¼š å®‰è£… `libtinfo5` åï¼Œæ‚¨å¯ä»¥ç»§ç»­å®‰è£… CUDA Toolkit 12.4ï¼š

   ```bash
   sudo apt-get -y install cuda-toolkit-12-4
   ```

### éªŒè¯

å®‰è£…å®Œæˆå, æ‰§è¡Œ `nvcc -V`:

```bash
Command 'nvcc' not found, but can be installed with:
sudo apt install nvidia-cuda-toolkit
```

è¿™æ˜¯å› ä¸º cuda çš„è·¯å¾„æ²¡æœ‰é…ç½®åˆ°ç¯å¢ƒå˜é‡ä¸­, æˆ‘ä»¬å¯ä»¥å…ˆé€šè¿‡ `dpkg -l | grep cuda` éªŒè¯ cuda æ˜¯å¦å®‰è£…æˆåŠŸ:

```bash
ii  cuda-cccl-12-4                       12.4.99-1                               amd64        CUDA CCCL
ii  cuda-command-line-tools-12-4         12.4.0-1                                amd64        CUDA command-line tools
ii  cuda-compiler-12-4                   12.4.0-1                                amd64        CUDA compiler
ii  cuda-crt-12-4                        12.4.99-1                               amd64        CUDA crt
ii  cuda-cudart-12-4                     12.4.99-1                               amd64        CUDA Runtime native Libraries
ii  cuda-cudart-dev-12-4                 12.4.99-1                               amd64        CUDA Runtime native dev links, headers
ii  cuda-cuobjdump-12-4                  12.4.99-1                               amd64        CUDA cuobjdump
ii  cuda-cupti-12-4                      12.4.99-1                               amd64        CUDA profiling tools runtime libs.
ii  cuda-cupti-dev-12-4                  12.4.99-1                               amd64        CUDA profiling tools interface.
ii  cuda-cuxxfilt-12-4                   12.4.99-1                               amd64        CUDA cuxxfilt
ii  cuda-documentation-12-4              12.4.99-1                               amd64        CUDA documentation
ii  cuda-driver-dev-12-4                 12.4.99-1                               amd64        CUDA Driver native dev stub library
ii  cuda-gdb-12-4                        12.4.99-1                               amd64        CUDA-GDB
ii  cuda-libraries-12-4                  12.4.0-1                                amd64        CUDA Libraries 12.4 meta-package
ii  cuda-libraries-dev-12-4              12.4.0-1                                amd64        CUDA Libraries 12.4 development meta-package
ii  cuda-nsight-12-4                     12.4.99-1                               amd64        CUDA nsight
ii  cuda-nsight-compute-12-4             12.4.0-1                                amd64        NVIDIA Nsight Compute
ii  cuda-nsight-systems-12-4             12.4.0-1                                amd64        NVIDIA Nsight Systems
ii  cuda-nvcc-12-4                       12.4.99-1                               amd64        CUDA nvcc
ii  cuda-nvdisasm-12-4                   12.4.99-1                               amd64        CUDA disassembler
ii  cuda-nvml-dev-12-4                   12.4.99-1                               amd64        NVML native dev links, headers
ii  cuda-nvprof-12-4                     12.4.99-1                               amd64        CUDA Profiler tools
ii  cuda-nvprune-12-4                    12.4.99-1                               amd64        CUDA nvprune
ii  cuda-nvrtc-12-4                      12.4.99-1                               amd64        NVRTC native runtime libraries
ii  cuda-nvrtc-dev-12-4                  12.4.99-1                               amd64        NVRTC native dev links, headers
ii  cuda-nvtx-12-4                       12.4.99-1                               amd64        NVIDIA Tools Extension
ii  cuda-nvvm-12-4                       12.4.99-1                               amd64        CUDA nvvm
ii  cuda-nvvp-12-4                       12.4.99-1                               amd64        CUDA Profiler tools
ii  cuda-opencl-12-4                     12.4.99-1                               amd64        CUDA OpenCL native Libraries
ii  cuda-opencl-dev-12-4                 12.4.99-1                               amd64        CUDA OpenCL native dev links, headers
ii  cuda-profiler-api-12-4               12.4.99-1                               amd64        CUDA Profiler API
ii  cuda-repo-ubuntu2204-12-4-local      12.4.0-550.54.14-1                      amd64        cuda repository configuration files
ii  cuda-sanitizer-12-4                  12.4.99-1                               amd64        CUDA Sanitizer
ii  cuda-toolkit-12-4                    12.4.0-1                                amd64        CUDA Toolkit 12.4 meta-package
ii  cuda-toolkit-12-4-config-common      12.4.99-1                               all          Common config package for CUDA Toolkit 12.4.
ii  cuda-toolkit-12-config-common        12.4.99-1                               all          Common config package for CUDA Toolkit 12.
ii  cuda-toolkit-config-common           12.4.99-1                               all          Common config package for CUDA Toolkit.
ii  cuda-tools-12-4                      12.4.0-1                                amd64        CUDA Tools meta-package
ii  cuda-visual-tools-12-4               12.4.0-1                                amd64        CUDA visual tools
```

çœ‹æ ·å­æ˜¯å®‰è£…æˆåŠŸäº†, æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸€ä¸‹ç¯å¢ƒå˜é‡:

```bash
$ vim ~/.bashrc

export PATH=/usr/local/cuda-12.4/bin:$PATH
export LD_LIBRARY_PATH=/usr/local/cuda-12.4/lib64:$LD_LIBRARY_PATH

$ source ~/.bashrc
```

ç°åœ¨æ‰§è¡Œ `nvcc -V` å°±æ²¡é—®é¢˜äº†:

```bash
$ nvcc -V
nvcc: NVIDIA (R) Cuda compiler driver
Copyright (c) 2005-2024 NVIDIA Corporation
Built on Tue_Feb_27_16:19:38_PST_2024
Cuda compilation tools, release 12.4, V12.4.99
Build cuda_12.4.r12.4/compiler.33961263_0
```

## å®‰è£… CuDNN

CuDNNï¼ˆCUDA Deep Neural Network libraryï¼‰æ˜¯ç”± NVIDIA æä¾›çš„é«˜æ€§èƒ½æ·±åº¦å­¦ä¹ åº“ï¼Œå®ƒä¸“é—¨ä¸ºæ·±åº¦å­¦ä¹ åº”ç”¨ç¨‹åºï¼ˆå¦‚å·ç§¯ç¥ç»ç½‘ç»œã€é€’å½’ç¥ç»ç½‘ç»œç­‰ï¼‰ä¼˜åŒ–äº† GPU åŠ é€Ÿçš„è®¡ç®—æ“ä½œã€‚CuDNN æ˜¯åŸºäº CUDAï¼ˆNVIDIA çš„å¹¶è¡Œè®¡ç®—å¹³å°ï¼‰æ„å»ºçš„ï¼Œæ—¨åœ¨åŠ é€Ÿæ·±åº¦å­¦ä¹ æ¡†æ¶ä¸­çš„ç¥ç»ç½‘ç»œè®¡ç®—ï¼Œæä¾›é«˜æ•ˆçš„è®¡ç®—æ€§èƒ½ã€‚

### CuDNN çš„ä¸»è¦åŠŸèƒ½

CuDNN ä¸»è¦æä¾›ä»¥ä¸‹å‡ ç§åŠŸèƒ½ï¼š

1. **å·ç§¯æ“ä½œï¼ˆConvolutional Operationsï¼‰**ï¼šCuDNN é’ˆå¯¹å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰çš„æ ¸å¿ƒæ“ä½œè¿›è¡Œäº†ä¼˜åŒ–ï¼Œæ”¯æŒå¸¸è§çš„å·ç§¯è®¡ç®—ã€åå·ç§¯ï¼ˆè½¬ç½®å·ç§¯ï¼‰ç­‰æ“ä½œã€‚å®ƒä¼˜åŒ–äº†åœ¨ GPU ä¸Šæ‰§è¡Œè¿™äº›æ“ä½œçš„é€Ÿåº¦ï¼Œé€‚åˆç”¨äºå›¾åƒå¤„ç†å’Œè®¡ç®—æœºè§†è§‰ç­‰ä»»åŠ¡ã€‚
2. **æ± åŒ–æ“ä½œï¼ˆPooling Operationsï¼‰**ï¼šCuDNN æä¾›äº†ä¼˜åŒ–çš„æ± åŒ–æ“ä½œï¼Œç‰¹åˆ«æ˜¯åœ¨ max-pooling å’Œ average-pooling è®¡ç®—æ–¹é¢ï¼Œæé«˜äº†æ‰§è¡Œæ•ˆç‡ã€‚
3. **å½’ä¸€åŒ–æ“ä½œï¼ˆNormalization Operationsï¼‰**ï¼šå¦‚æ‰¹å½’ä¸€åŒ–ï¼ˆBatch Normalizationï¼‰ç­‰ï¼ŒCuDNN æä¾›äº†é«˜æ•ˆçš„å®ç°ã€‚
4. **æ¿€æ´»å‡½æ•°ï¼ˆActivation Functionsï¼‰**ï¼šCuDNN æä¾›äº†å¤šç§æ¿€æ´»å‡½æ•°ï¼ˆå¦‚ ReLUã€Sigmoidã€Tanh ç­‰ï¼‰ä»¥åŠå®ƒä»¬çš„åå‘ä¼ æ’­è®¡ç®—ï¼Œæ‰€æœ‰è¿™äº›éƒ½è¿›è¡Œäº† GPU ä¼˜åŒ–ã€‚
5. **RNN æ“ä½œï¼ˆRecurrent Neural Network Operationsï¼‰**ï¼šCuDNN è¿˜æä¾›äº†å¯¹ RNNï¼ˆé€’å½’ç¥ç»ç½‘ç»œï¼‰æ“ä½œçš„æ”¯æŒï¼ŒåŒ…æ‹¬ LSTMï¼ˆé•¿çŸ­æœŸè®°å¿†ï¼‰å’Œ GRUï¼ˆé—¨æ§é€’å½’å•å…ƒï¼‰çš„é«˜æ•ˆå®ç°ã€‚
6. **å¼ é‡è®¡ç®—ï¼ˆTensor Operationsï¼‰**ï¼šCuDNN æä¾›å¯¹å¼ é‡è¿ç®—çš„é«˜æ•ˆæ”¯æŒï¼Œå¸®åŠ©æ·±åº¦å­¦ä¹ æ¡†æ¶åœ¨ GPU ä¸Šæ‰§è¡Œå¤æ‚çš„çŸ©é˜µè¿ç®—ã€‚

### ä¸ºä»€ä¹ˆä½¿ç”¨ CuDNNï¼Ÿ

1. **æ€§èƒ½ä¼˜åŒ–**ï¼šCuDNN å¯¹æ·±åº¦å­¦ä¹ æ¡†æ¶ä¸­çš„è®¸å¤šå¸¸è§æ“ä½œï¼ˆå¦‚å·ç§¯ã€æ± åŒ–ã€æ¿€æ´»ç­‰ï¼‰è¿›è¡Œäº†ä¸“é—¨ä¼˜åŒ–ï¼Œåˆ©ç”¨ GPU å¹¶è¡Œè®¡ç®—çš„ä¼˜åŠ¿æ˜¾è‘—æé«˜äº†è®¡ç®—é€Ÿåº¦ï¼Œå°¤å…¶åœ¨å¤§è§„æ¨¡è®­ç»ƒä¸­èƒ½å¤Ÿå¤§å¹…ç¼©çŸ­è®­ç»ƒæ—¶é—´ã€‚
2. **ä¸æ·±åº¦å­¦ä¹ æ¡†æ¶å…¼å®¹**ï¼šCuDNN ä¸å¤§å¤šæ•°ä¸»æµæ·±åº¦å­¦ä¹ æ¡†æ¶å…¼å®¹ï¼Œå¦‚ TensorFlowã€PyTorchã€Caffe ç­‰ã€‚è¿™äº›æ¡†æ¶éƒ½åˆ©ç”¨ CuDNN æ¥åŠ é€Ÿè®¡ç®—ï¼Œä»è€Œå¤§å¤§æé«˜äº†è®­ç»ƒå’Œæ¨ç†çš„æ•ˆç‡ã€‚
3. **GPU åŠ é€Ÿ**ï¼šç”±äº CuDNN åŸºäº NVIDIA çš„ CUDA æ„å»ºï¼Œå®ƒèƒ½å¤Ÿå……åˆ†å‘æŒ¥ NVIDIA GPU çš„è®¡ç®—èƒ½åŠ›ï¼Œæå¤§æå‡æ·±åº¦å­¦ä¹ åº”ç”¨çš„æ€§èƒ½ã€‚
4. **æ˜“äºé›†æˆ**ï¼šå¯¹äºå¼€å‘äººå‘˜æ¥è¯´ï¼ŒCuDNN æä¾›äº†ç®€å•çš„ APIï¼Œå¯ä»¥æ–¹ä¾¿åœ°é›†æˆåˆ°ç°æœ‰çš„æ·±åº¦å­¦ä¹ é¡¹ç›®ä¸­ï¼Œæå¤§å‡å°‘äº†ä¼˜åŒ–å’Œè°ƒè¯•çš„å·¥ä½œé‡ã€‚

### CuDNN ä¸ CUDA çš„å…³ç³»

CuDNN æ˜¯æ„å»ºåœ¨ CUDA ä¸Šçš„åº“ï¼Œå®ƒåˆ©ç”¨ CUDA æä¾›çš„å¹¶è¡Œè®¡ç®—èƒ½åŠ›æ¥åŠ é€Ÿæ·±åº¦å­¦ä¹ è®¡ç®—ã€‚CUDA æä¾›äº†åº•å±‚çš„ç¡¬ä»¶åŠ é€Ÿæ¥å£ï¼Œè€Œ CuDNN åˆ™åœ¨æ­¤åŸºç¡€ä¸Šå®ç°äº†é’ˆå¯¹æ·±åº¦å­¦ä¹ æ“ä½œçš„ä¼˜åŒ–ã€‚å› æ­¤ï¼ŒCuDNN éœ€è¦ä¸ CUDA ä¸€èµ·ä½¿ç”¨ã€‚

### å¦‚ä½•å®‰è£… CuDNN

> æ›´æ–°å®‰è£…æ–¹å¼: https://docs.nvidia.com/deeplearning/cudnn/installation/latest/linux.html#
>
> ```bash
> sudo apt-get install zlib1g
> sudo apt-get -y install cudnn9-cuda-12
> ```

è®¿é—® [CuDNN ç½‘ç«™](https://developer.nvidia.com/rdp/cudnn-archive)ã€‚éœ€è¦æ³¨å†Œä¸€ä¸ª NVIDIA å¼€å‘è€…è´¦å·æ‰å¯ä»¥ä¸‹è½½ã€‚

![20250210010433_BrMD7eJW.webp](https://cdn.dong4j.site/source/image/20250210010433_BrMD7eJW.webp)

> deb æ–‡ä»¶ä»…æä¾›æœ¬åœ°æºï¼Œå®‰è£…æ—¶ä»éœ€ä»ç½‘ç»œä¸‹è½½ç›¸åº”çš„åŒ…æ–‡ä»¶ã€‚éœ€è¦å…ˆå®‰è£…æœ¬åœ°æºï¼š `sudo dpkg -i cudnn-local-repo-ubuntu2204-8.9.7.29_1.0-1_amd64.deb`ï¼Œæ ¹æ®è¾“å‡ºä¸­çš„æç¤ºå®‰è£… GPG keyï¼Œå†ä½¿ç”¨ apt å·¥å…·æ›´æ–°å’Œå®‰è£…ä¾èµ–åŒ…ã€‚

Tar åŒ…æ˜¯å®Œæ•´çš„å®‰è£…æ–‡ä»¶, ä¸ºäº†é¿å…ç½‘ç»œå®‰è£…çš„ä¸ç¨³å®šæ€§, è¿™é‡Œé€‰æ‹©ä¸‹è½½å…¨éƒ¨æ–‡ä»¶åˆ°æœ¬åœ°å®‰è£….

```bash
tar -xvJf cudnn-linux-x86_64-8.9.7.29_cuda12-archive.tar.xz \
	&& sudo cp cudnn-linux-x86_64-8.9.7.29_cuda12-archive/include/cudnn.h /usr/local/cuda/include \
	&& sudo cp -P cudnn-linux-x86_64-8.9.7.29_cuda12-archive/lib/libcudnn* /usr/local/cuda-12.4/lib64 \
	&& sudo chmod a+r /usr/local/cuda/include/cudnn.h \
	&& sudo chmod a+r /usr/local/cuda/lib64/libcudnn* \
  && sudo dpkg -i cudnn-local-repo-ubuntu2204-8.9.7.29_1.0-1_amd64.deb \
	&& sudo apt-get install libcudnn8 \
	&& sudo apt-get install libcudnn8-dev \
	&& sudo apt-get install libcudnn8-samples
```

#### éªŒè¯

```bash
$ sudo ldconfig

$ sudo ldconfig -p | grep cudnn
	libcudnn_ops_train.so.8 (libc6,x86-64) => /usr/local/cuda/targets/x86_64-linux/lib/libcudnn_ops_train.so.8
	libcudnn_ops_train.so.8 (libc6,x86-64) => /lib/x86_64-linux-gnu/libcudnn_ops_train.so.8
	libcudnn_ops_train.so (libc6,x86-64) => /usr/local/cuda/targets/x86_64-linux/lib/libcudnn_ops_train.so
	libcudnn_ops_train.so (libc6,x86-64) => /lib/x86_64-linux-gnu/libcudnn_ops_train.so
	libcudnn_ops_infer.so.8 (libc6,x86-64) => /usr/local/cuda/targets/x86_64-linux/lib/libcudnn_ops_infer.so.8
	libcudnn_ops_infer.so.8 (libc6,x86-64) => /lib/x86_64-linux-gnu/libcudnn_ops_infer.so.8
	libcudnn_ops_infer.so (libc6,x86-64) => /usr/local/cuda/targets/x86_64-linux/lib/libcudnn_ops_infer.so
	libcudnn_ops_infer.so (libc6,x86-64) => /lib/x86_64-linux-gnu/libcudnn_ops_infer.so
	libcudnn_cnn_train.so.8 (libc6,x86-64) => /usr/local/cuda/targets/x86_64-linux/lib/libcudnn_cnn_train.so.8
	libcudnn_cnn_train.so.8 (libc6,x86-64) => /lib/x86_64-linux-gnu/libcudnn_cnn_train.so.8
	libcudnn_cnn_train.so (libc6,x86-64) => /usr/local/cuda/targets/x86_64-linux/lib/libcudnn_cnn_train.so
	libcudnn_cnn_train.so (libc6,x86-64) => /lib/x86_64-linux-gnu/libcudnn_cnn_train.so
	libcudnn_cnn_infer.so.8 (libc6,x86-64) => /usr/local/cuda/targets/x86_64-linux/lib/libcudnn_cnn_infer.so.8
	libcudnn_cnn_infer.so.8 (libc6,x86-64) => /lib/x86_64-linux-gnu/libcudnn_cnn_infer.so.8
	libcudnn_cnn_infer.so (libc6,x86-64) => /usr/local/cuda/targets/x86_64-linux/lib/libcudnn_cnn_infer.so
	libcudnn_cnn_infer.so (libc6,x86-64) => /lib/x86_64-linux-gnu/libcudnn_cnn_infer.so
	libcudnn_adv_train.so.8 (libc6,x86-64) => /usr/local/cuda/targets/x86_64-linux/lib/libcudnn_adv_train.so.8
	libcudnn_adv_train.so.8 (libc6,x86-64) => /lib/x86_64-linux-gnu/libcudnn_adv_train.so.8
	libcudnn_adv_train.so (libc6,x86-64) => /usr/local/cuda/targets/x86_64-linux/lib/libcudnn_adv_train.so
	libcudnn_adv_train.so (libc6,x86-64) => /lib/x86_64-linux-gnu/libcudnn_adv_train.so
	libcudnn_adv_infer.so.8 (libc6,x86-64) => /usr/local/cuda/targets/x86_64-linux/lib/libcudnn_adv_infer.so.8
	libcudnn_adv_infer.so.8 (libc6,x86-64) => /lib/x86_64-linux-gnu/libcudnn_adv_infer.so.8
	libcudnn_adv_infer.so (libc6,x86-64) => /usr/local/cuda/targets/x86_64-linux/lib/libcudnn_adv_infer.so
	libcudnn_adv_infer.so (libc6,x86-64) => /lib/x86_64-linux-gnu/libcudnn_adv_infer.so
	libcudnn.so.8 (libc6,x86-64) => /usr/local/cuda/targets/x86_64-linux/lib/libcudnn.so.8
	libcudnn.so.8 (libc6,x86-64) => /lib/x86_64-linux-gnu/libcudnn.so.8
	libcudnn.so (libc6,x86-64) => /usr/local/cuda/targets/x86_64-linux/lib/libcudnn.so
	libcudnn.so (libc6,x86-64) => /lib/x86_64-linux-gnu/libcudnn.so
```

## å®‰è£… Conda

```bash
mkdir -p ~/miniconda3 \
	&& wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda3/miniconda.sh \
	&& bash ~/miniconda3/miniconda.sh -b -u -p ~/miniconda3 \
	&& rm ~/miniconda3/miniconda.sh \
	&& source ~/miniconda3/bin/activate \
	&& conda init --all
```

### éªŒè¯

```bash
conda create -n ai_base python=3.12
conda activate ai_base
pip install torch torchvision
```

python è„šæœ¬:

```python
import torch
# ç”Ÿæˆä¸€ä¸ª5x3çš„éšæœºçŸ©é˜µ
print(torch.rand(5, 3))
# æ£€æŸ¥CUDAæ˜¯å¦å¯ç”¨
print(torch.cuda.is_available())
# å¦‚æœCUDAå¯ç”¨ï¼Œè·å–æ›´å¤šæ˜¾å¡ä¿¡æ¯
if torch.cuda.is_available():
    # è·å–CUDAè®¾å¤‡æ•°é‡
    print('CUDA device count:', torch.cuda.device_count())
    # è·å–å½“å‰è®¾å¤‡çš„åç§°
    print('Device name:', torch.cuda.get_device_name(0))
    # è·å–å½“å‰è®¾å¤‡çš„æ€»å†…å­˜
    print('Device total memory (GB):', torch.cuda.get_device_properties(0).total_memory / 1e9)
    # è·å–å½“å‰è®¾å¤‡çš„CUDAç‰ˆæœ¬
    print('CUDA version:', torch.version.cuda)
    # è·å–å½“å‰è®¾å¤‡çš„è®¡ç®—èƒ½åŠ›
    print('Compute capability:', torch.cuda.get_device_properties(0).major, '.', torch.cuda.get_device_properties(0).minor)
    # æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„GPU
    print('GPU available:', torch.cuda.is_available())
    # è·å–å½“å‰è®¾å¤‡çš„ç´¢å¼•
    print('Current device index:', torch.cuda.current_device())
```

```
$ python gpu.py
tensor([[0.7034, 0.4482, 0.1233],
        [0.2208, 0.0810, 0.9165],
        [0.9785, 0.3103, 0.5675],
        [0.1876, 0.9308, 0.2961],
        [0.6886, 0.5146, 0.2812]])
True
CUDA device count: 1
Device name: Tesla P40
Device total memory (GB): 25.62588672
CUDA version: 12.4
Compute capability: 6 . 1
GPU available: True
Current device index: 0
```

## æ·»åŠ åˆ°ç›‘æ§é¢æ¿

![20250211194220_zb6fDv7h.webp](https://cdn.dong4j.site/source/image/20250211194220_zb6fDv7h.webp)

1. å¼€å¯ GPU ç›‘æ§
2. å¼€å¯æ¸©åº¦ç›‘æ§

## é€šè¿‡é›·é›³æ¥å£äº macOS è¿æ¥

NUC11 è‡ªå¸¦2ä¸ªé›·é›³4æ¥å£, æ‰€ä»¥ç©ä¸€ä¸‹ Linux å¦‚ä½•é€šè¿‡é›·é›³æ¥å£äº macOS å»ºç«‹è¿æ¥.

### macOS é…ç½®

> åœ¨ [[homelab-upgrade-to-10g|HomeLab ç½‘ç»œç»­é›†ï¼šå‡çº§ 10G ç½‘ç»œ-å†æˆ˜ 10 å¹´]] ä¸­çš„ ã€Œå¤šå° Mac äº’è”ã€ä¸€èŠ‚ä¸­è¯¦ç»†è®²è§£äº†å¦‚ä½•é€šè¿‡é›·é›³æ¥å£è¿æ¥å¤šå° macOS.

é¦–å…ˆéœ€è¦ç¡®å®šè¿æ¥çš„å“ªä¸ªé›·é›³æ¥å£:

![20250216223015_r1hcUdNe.webp](https://cdn.dong4j.site/source/image/20250216223015_r1hcUdNe.webp)

macOS äº NUC è¿æ¥å, ç›´æ¥è¯†åˆ«åˆ°å¯¹ç«¯ä¸º **nuc(æˆ‘è®¾ç½®çš„ hostname)**, æ’å­”æ˜¾ç¤ºä¸º **1**.

ç„¶åéœ€è¦æ–°å»ºä¸€ä¸ªé›·é›³ç½‘æ¡¥, é€‰æ‹©é›·é›³ 1 æ¥å£:

![20250216223016_Jm6IfLe4.webp](https://cdn.dong4j.site/source/image/20250216223016_Jm6IfLe4.webp)

æœ€åå°±æ˜¯ **æ·»åŠ æœåŠ¡**:

![20250216223017_Yuhowi8h.webp](https://cdn.dong4j.site/source/image/20250216223017_Yuhowi8h.webp)

æ‰‹åŠ¨ä¿®æ”¹ IP:

![20250216223018_99XYwggY.webp](https://cdn.dong4j.site/source/image/20250216223018_99XYwggY.webp)

### NUC é…ç½®

```bash
sudo nmcli connection add type ethernet ifname thunderbolt0 con-name to.mbp ipv4.method manual ipv4.addresses 1.1.1.9/24
```

NUC çš„ IP è®¾ç½®ä¸º `1.1.1.9`, ç„¶åæ˜¯å–œé—»ä¹è§çš„æµ‹é€Ÿç¯èŠ‚:

```bash
$ iperf3 -c 1.1.1.9
Connecting to host 1.1.1.9, port 5201
[  5] local 1.1.1.8 port 61027 connected to 1.1.1.9 port 5201
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-1.00   sec  1.62 GBytes  13.8 Gbits/sec
[  5]   1.00-2.00   sec  1.72 GBytes  14.8 Gbits/sec
[  5]   2.00-3.00   sec  1.72 GBytes  14.8 Gbits/sec
[  5]   3.00-4.01   sec  1.73 GBytes  14.8 Gbits/sec
[  5]   4.01-5.00   sec  1.72 GBytes  14.8 Gbits/sec
[  5]   5.00-6.00   sec  1.73 GBytes  14.8 Gbits/sec
[  5]   6.00-7.01   sec  1.73 GBytes  14.8 Gbits/sec
[  5]   7.01-8.00   sec  1.72 GBytes  14.8 Gbits/sec
[  5]   8.00-9.00   sec  1.73 GBytes  14.8 Gbits/sec
[  5]   9.00-10.00  sec  1.73 GBytes  14.8 Gbits/sec
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-10.00  sec  17.1 GBytes  14.7 Gbits/sec                  sender
[  5]   0.00-10.01  sec  17.1 GBytes  14.7 Gbits/sec                  receiver

iperf Done.
```

ç†è®ºä¸Šåº”è¯¥æœ‰ 20Gbit/sec, æ²¡æœ‰æˆ‘ macOS äº macOS è¿æ¥å¿«:

```bash
$ iperf3 -c 1.0.0.4
Connecting to host 1.0.0.4, port 5201
[  5] local 1.0.0.5 port 65277 connected to 1.0.0.4 port 5201
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-1.00   sec  2.30 GBytes  19.8 Gbits/sec
[  5]   1.00-2.00   sec  2.17 GBytes  18.7 Gbits/sec
[  5]   2.00-3.00   sec  2.22 GBytes  19.1 Gbits/sec
[  5]   3.00-4.00   sec  2.17 GBytes  18.6 Gbits/sec
[  5]   4.00-5.00   sec  2.24 GBytes  19.2 Gbits/sec
[  5]   5.00-6.00   sec  2.20 GBytes  18.9 Gbits/sec
[  5]   6.00-7.00   sec  2.20 GBytes  18.9 Gbits/sec
[  5]   7.00-8.00   sec  2.23 GBytes  19.1 Gbits/sec
[  5]   8.00-9.00   sec  2.11 GBytes  18.1 Gbits/sec
[  5]   9.00-10.00  sec  2.21 GBytes  19.0 Gbits/sec
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-10.00  sec  22.0 GBytes  18.9 Gbits/sec                  sender
[  5]   0.00-10.00  sec  22.0 GBytes  18.9 Gbits/sec                  receiver

iperf Done.
```

#### å‚è€ƒ

- [Linuxç½‘ç»œç®¡ç†å·¥å…·-netplan](https://zoe.red/2024/254.html)
- [é›·ç”µå±€åŸŸç½‘æ­å»º](https://zoe.red/2024/169.html/comment-page-1)

## æµ‹è¯•

### CPU æµ‹è¯•

åœ¨ Ubuntu ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ apt-get å‘½ä»¤æ¥å®‰è£… Stress å·¥å…·ã€‚é¦–å…ˆï¼Œæ‰“å¼€ç»ˆç«¯å¹¶è¿è¡Œä»¥ä¸‹å‘½ä»¤æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨ï¼š

```
sudo apt-get update
sudo apt-get install stress
```

å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ç»ˆç«¯ä¸­ç›´æ¥è¿è¡Œ Stress å·¥å…·äº†ã€‚

1. æ¨¡æ‹Ÿ CPU å‹åŠ›

   ä½¿ç”¨ Stress å·¥å…·æ¨¡æ‹Ÿ CPU å‹åŠ›éå¸¸ç®€å•ã€‚ä»¥ä¸‹å‘½ä»¤å°†åœ¨ 8 ä¸ªå·¥ä½œçº¿ç¨‹ä¸Šæ¨¡æ‹Ÿ CPU å‹åŠ›ï¼š

   ```bash
   # è¿™å°†ä½¿CPUä¿æŒé«˜è´Ÿè½½çŠ¶æ€ï¼Œä»¥æµ‹è¯•ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œæ€§èƒ½ã€‚
   stress --cpu 8
   ```

2. æ¨¡æ‹Ÿå†…å­˜å‹åŠ›

   ä¸ºäº†æ¨¡æ‹Ÿå†…å­˜å‹åŠ›ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

   ```bash
   # è¿™å°†ä½¿ç³»ç»Ÿåˆ†é…128MBçš„å†…å­˜ï¼Œå¹¶æŒç»­è¿›è¡Œè¯»å†™æ“ä½œï¼Œä»¥æ¨¡æ‹Ÿå†…å­˜å‹åŠ›ã€‚
   stress --vm 1 --vm-bytes 128M
   ```

3. æ¨¡æ‹Ÿ I/O å‹åŠ›

   è¦æ¨¡æ‹Ÿ I/O å‹åŠ›ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

   ```bash
   # è¿™å°†ä½¿ç³»ç»ŸåŒæ—¶æ‰§è¡Œ4ä¸ªI/Oæ“ä½œï¼Œä»¥æ¨¡æ‹Ÿç£ç›˜è¯»å†™å‹åŠ›ã€‚
   stress --io 4
   ```

ä»¥ä¸Šä»…æ˜¯ Stress å·¥å…·çš„éƒ¨åˆ†ç¤ºä¾‹ï¼Œå®ƒè¿˜æ”¯æŒæ¨¡æ‹Ÿç£ç›˜ç©ºé—´å‹åŠ›ç­‰å¤šç§åœºæ™¯ã€‚å…·ä½“ç”¨æ³•å’Œå‚æ•°å¯ä»¥å‚è€ƒ Stress å·¥å…·çš„å®˜æ–¹[æ–‡æ¡£](https://cloud.baidu.com/product/doc.html)ã€‚

### GPU æµ‹è¯•

è¿™é‡Œä½¿ç”¨ **[gpu-burn](https://github.com/wilicc/gpu-burn)** æ¥æµ‹è¯•:

```bash
git clone https://github.com/wilicc/gpu-burn \
	&& cd gpu-burn \
	&& make && make clean
```

```bash
$ ./gpu_burn -h
GPU Burn
Usage: gpu-burn [OPTIONS] [TIME]

-m X	Use X MB of memory.
-m N%	Use N% of the available GPU memory.  Default is 90%
-d	Use doubles
-tc	Try to use Tensor cores
-l	Lists all GPUs in the system
-i N	Execute only on GPU N
-c FILE	Use FILE as compare kernel.  Default is compare.ptx
-stts T	Set timeout threshold to T seconds for using SIGTERM to abort child processes before using SIGKILL.  Default is 30
-h	Show this help message

Examples:
  gpu-burn -d 3600 # burns all GPUs with doubles for an hour
  gpu-burn -m 50% # burns using 50% of the available GPU memory
  gpu-burn -l # list GPUs
  gpu-burn -i 2 # burns only GPU of index 2
```

æˆ‘ä»¬ä½¿ç”¨ `gpu-burn -d 600` æ¥è·‘ 10 åˆ†é’Ÿæµ‹è¯•:

```bash
$ ./gpu_burn -d 600
Using compare file: compare.ptx
Burning for 600 seconds.
GPU 0: Tesla P40 (UUID: GPU-14413e65-6006-ecbe-19fb-de88575d8a3e)
Initialized device 0 with 24438 MB of memory (24278 MB available, using 21850 MB of it), using DOUBLES
Results are 536870912 bytes each, thus performing 40 iterations
```

å› ä¸ºæˆ‘çš„æ¶¡è½®é£æ‰‡ä½¿ç”¨æ¸©åº¦ä¼ æ„Ÿå™¨æ£€æµ‹æ˜¾å¡èƒŒæ¿æ¸©åº¦, å¦‚æœé«˜äº 30 åº¦å°±å¼€å§‹å·¥ä½œ, åˆšè·‘äº† 30 ç§’é’Ÿå°±å¼€å§‹å…¨åŠŸç‡è¿è¡Œäº†, ä½¿ç”¨ `watch nvidia-smi` è§‚å¯Ÿæ˜¾å¡çš„æ•°æ®å˜åŒ–:

```bash
+-----------------------------------------------------------------------------------------+
| NVIDIA-SMI 550.120                Driver Version: 550.120        CUDA Version: 12.4     |
|-----------------------------------------+------------------------+----------------------+
| GPU  Name                 Persistence-M | Bus-Id          Disp.A | Volatile Uncorr. ECC |
| Fan  Temp   Perf          Pwr:Usage/Cap |           Memory-Usage | GPU-Util  Compute M. |
|                                         |                        |               MIG M. |
|=========================================+========================+======================|
|   0  Tesla P40                      Off |   00000000:01:00.0 Off |                  Off |
| N/A   28C    P0             53W /  250W |   21665MiB /  24576MiB |    100%      Default |
|                                         |                        |                  N/A |
+-----------------------------------------+------------------------+----------------------+

+-----------------------------------------------------------------------------------------+
| Processes:                                                                              |
|  GPU   GI   CI        PID   Type   Process name                              GPU Memory |
|        ID   ID                                                               Usage      |
|=========================================================================================|
|    0   N/A  N/A     13338      C   ./gpu_burn                                  21662MiB |
+-----------------------------------------------------------------------------------------+
```

åŸºæœ¬ä¸Šæ²¡æœ‰è¶…è¿‡ 30 åº¦, è¿™å°±å°´å°¬äº†, ä¸æ™“å¾— GPU ä¼šä¸ä¼šæ„Ÿå†’ ğŸ™‰.

### AI æ¨ç†

è¿™é‡Œä½¿ç”¨æœ€ç®€å•çš„ Ollama è¿›è¡Œå¿«é€Ÿæµ‹è¯•:

```bash
curl https://ollama.ai/install.sh | sh
```

```bash
>>> Creating ollama user...
>>> Adding ollama user to render group...
>>> Adding ollama user to video group...
>>> Adding current user to ollama group...
>>> Creating ollama systemd service...
>>> Enabling and starting ollama service...
Created symlink /etc/systemd/system/default.target.wants/ollama.service â†’ /etc/systemd/system/ollama.service.
>>> NVIDIA GPU installed.
```

Ollama ç›´æ¥æ·»åŠ è‡ªå¯åŠ¨, ä½†æ˜¯æˆ‘ä¸éœ€è¦, æ‰€ä»¥ç¦ç”¨äº†:

```bash
sudo systemctl disable ollama
```

å¦‚ä½•éœ€è¦å¼€æ”¾å±€åŸŸç½‘è®¿é—®, éœ€è¦ä¿®æ”¹ `/etc/systemd/system/ollama.service`

```bash
...
Environment="OLLAMA_HOST=0.0.0.0:11434"
...
```

```bash
sudo systemctl daemon-reload \
	&& sudo systemctl restart ollama
```

ä½¿ç”¨ `llama3.2` æ¥æµ‹è¯•:

```bash
ollama run llama3.2
```

```bash
./llava-v1.5-7b-q4.llamafile --server --gpu NVIDIA --host 0.0.0.0
```

### Stable Diffusion WebUI

```basj
mkdir -p ~/miniconda3
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda3/miniconda.sh
bash ~/miniconda3/miniconda.sh -b -u -p ~/miniconda3
conda init --all
conda create -n sdwebui python=3.10
conda activate sdwebui
pip install torch torchvision torchaudio
```



```basj
git clone https://github.com/AUTOMATIC1111/stable-diffusion-webui.git
cd stable-diffusion-webui

vim webui.sh
```

```bash
#!/bin/bash
#########################################################
# Uncomment and change the variables below to your need:#
#########################################################

# Install directory without trailing slash
#install_dir="/home/$(whoami)"

# Name of the subdirectory
#clone_dir="stable-diffusion-webui"

# Commandline arguments for webui.py, for example: export COMMANDLINE_ARGS="--medvram --opt-split-attention"
export COMMANDLINE_ARGS="--api --listen --port 7860 --gradio-auth user:password --enable-insecure-extension-access"

# python3 executable
python_cmd="/home/dong4j/miniconda3/envs/sdwebui/bin/python3.10"

# git executable
#export GIT="git"

# python3 venv without trailing slash (defaults to ${install_dir}/${clone_dir}/venv)
venv_dir="-"

# script to launch to start the app
#export LAUNCH_SCRIPT="launch.py"

# install command for torch
#export TORCH_COMMAND="pip install torch==1.12.1+cu113 --extra-index-url https://download.pytorch.org/whl/cu113"

# Requirements file to use for stable-diffusion-webui
#export REQS_FILE="requirements_versions.txt"

# Fixed git repos
#export K_DIFFUSION_PACKAGE=""
#export GFPGAN_PACKAGE=""

# Fixed git commits
#export STABLE_DIFFUSION_COMMIT_HASH=""
#export CODEFORMER_COMMIT_HASH=""
#export BLIP_COMMIT_HASH=""

# Uncomment to enable accelerated launch
#export ACCELERATE="True"

# Uncomment to disable TCMalloc
#export NO_TCMALLOC="True"

###########################################
```

```bash
bash webui.sh
```

#### é—®é¢˜

```
  Ã— Building wheel for tokenizers (pyproject.toml) did not run successfully.
  â”‚ exit code: 1
  â•°â”€> [49 lines of output]
      running bdist_wheel
      running build
      running build_py
      creating build/lib.linux-x86_64-cpython-312/tokenizers
      copying py_src/tokenizers/__init__.py -> build/lib.linux-x86_64-cpython-312/tokenizers
      creating build/lib.linux-x86_64-cpython-312/tokenizers/models
      copying py_src/tokenizers/models/__init__.py -> build/lib.linux-x86_64-cpython-312/tokenizers/models
      creating build/lib.linux-x86_64-cpython-312/tokenizers/decoders
      copying py_src/tokenizers/decoders/__init__.py -> build/lib.linux-x86_64-cpython-312/tokenizers/decoders
      creating build/lib.linux-x86_64-cpython-312/tokenizers/normalizers
      copying py_src/tokenizers/normalizers/__init__.py -> build/lib.linux-x86_64-cpython-312/tokenizers/normalizers
      creating build/lib.linux-x86_64-cpython-312/tokenizers/pre_tokenizers
      copying py_src/tokenizers/pre_tokenizers/__init__.py -> build/lib.linux-x86_64-cpython-312/tokenizers/pre_tokenizers
      creating build/lib.linux-x86_64-cpython-312/tokenizers/processors
      copying py_src/tokenizers/processors/__init__.py -> build/lib.linux-x86_64-cpython-312/tokenizers/processors
      creating build/lib.linux-x86_64-cpython-312/tokenizers/trainers
      copying py_src/tokenizers/trainers/__init__.py -> build/lib.linux-x86_64-cpython-312/tokenizers/trainers
      creating build/lib.linux-x86_64-cpython-312/tokenizers/implementations
      copying py_src/tokenizers/implementations/sentencepiece_unigram.py -> build/lib.linux-x86_64-cpython-312/tokenizers/implementations
      copying py_src/tokenizers/implementations/sentencepiece_bpe.py -> build/lib.linux-x86_64-cpython-312/tokenizers/implementations
      copying py_src/tokenizers/implementations/base_tokenizer.py -> build/lib.linux-x86_64-cpython-312/tokenizers/implementations
      copying py_src/tokenizers/implementations/char_level_bpe.py -> build/lib.linux-x86_64-cpython-312/tokenizers/implementations
      copying py_src/tokenizers/implementations/byte_level_bpe.py -> build/lib.linux-x86_64-cpython-312/tokenizers/implementations
      copying py_src/tokenizers/implementations/bert_wordpiece.py -> build/lib.linux-x86_64-cpython-312/tokenizers/implementations
      copying py_src/tokenizers/implementations/__init__.py -> build/lib.linux-x86_64-cpython-312/tokenizers/implementations
      creating build/lib.linux-x86_64-cpython-312/tokenizers/tools
      copying py_src/tokenizers/tools/__init__.py -> build/lib.linux-x86_64-cpython-312/tokenizers/tools
      copying py_src/tokenizers/tools/visualizer.py -> build/lib.linux-x86_64-cpython-312/tokenizers/tools
      copying py_src/tokenizers/__init__.pyi -> build/lib.linux-x86_64-cpython-312/tokenizers
      copying py_src/tokenizers/models/__init__.pyi -> build/lib.linux-x86_64-cpython-312/tokenizers/models
      copying py_src/tokenizers/decoders/__init__.pyi -> build/lib.linux-x86_64-cpython-312/tokenizers/decoders
      copying py_src/tokenizers/normalizers/__init__.pyi -> build/lib.linux-x86_64-cpython-312/tokenizers/normalizers
      copying py_src/tokenizers/pre_tokenizers/__init__.pyi -> build/lib.linux-x86_64-cpython-312/tokenizers/pre_tokenizers
      copying py_src/tokenizers/processors/__init__.pyi -> build/lib.linux-x86_64-cpython-312/tokenizers/processors
      copying py_src/tokenizers/trainers/__init__.pyi -> build/lib.linux-x86_64-cpython-312/tokenizers/trainers
      copying py_src/tokenizers/tools/visualizer-styles.css -> build/lib.linux-x86_64-cpython-312/tokenizers/tools
      running build_ext
      running build_rust
      error: can't find Rust compiler
      
      If you are using an outdated pip version, it is possible a prebuilt wheel is available for this package but pip is not able to install from it. Installing from the wheel would avoid the need for a Rust compiler.
      
      To update pip, run:
      
          pip install --upgrade pip
      
      and then retry package installation.
      
      If you did intend to build this package from source, try installing a Rust compiler from your system package manager and ensure it is on the PATH during installation. Alternatively, rustup (available at https://rustup.rs) is the recommended way to download and update the Rust compiler toolchain.
      [end of output]
  
  note: This error originates from a subprocess, and is likely not a problem with pip.
  ERROR: Failed building wheel for tokenizers
ERROR: Failed to build installable wheels for some pyproject.toml based projects (Pillow, tokenizers)
```

**é—®é¢˜å¤„ç†**

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source $HOME/.cargo/env
pip install --no-cache-dir tokenizers
```



```
        Could not find openssl via pkg-config:
      
        pkg-config exited with status code 1
        > PKG_CONFIG_ALLOW_SYSTEM_CFLAGS=1 pkg-config --libs --cflags openssl
      
        The system library openssl required by crate openssl-sys was not found.
        The file openssl.pc needs to be installed and the PKG_CONFIG_PATH environment variable must contain its parent directory.
        The PKG_CONFIG_PATH environment variable is not set.
      
        HINT: if you have installed the library, try setting PKG_CONFIG_PATH to the directory containing openssl.pc.
      
      
        cargo:warning=Could not find directory of OpenSSL installation, and this -sys crate cannot proceed without this knowledge. If OpenSSL is installed and this crate had trouble finding it,  you can set the OPENSSL_DIR environment variable for the compilation process. See stderr section below for further information.
      
        --- stderr
      
      
        Could not find directory of OpenSSL installation, and this -sys crate cannot
        proceed without this knowledge. If OpenSSL is installed and this crate had
        trouble finding it,  you can set the OPENSSL_DIR environment variable for the
        compilation process.
      
        Make sure you also have the development packages of openssl installed.
        For example, libssl-dev on Ubuntu or openssl-devel on Fedora.
      
        If you're in a situation where you think the directory *should* be found
        automatically, please open a bug at https://github.com/sfackler/rust-openssl
        and include information about your system as well as this message.
      
        $HOST = x86_64-unknown-linux-gnu
        $TARGET = x86_64-unknown-linux-gnu
        openssl-sys = 0.9.106
      
      
      warning: build failed, waiting for other jobs to finish...
      error: cargo rustc --lib --message-format=json-render-diagnostics --manifest-path Cargo.toml --release -v --features pyo3/extension-module --crate-type cdylib -- failed with code 101
      [end of output]
  
  note: This error originates from a subprocess, and is likely not a problem with pip.
  ERROR: Failed building wheel for tokenizers
ERROR: Failed to build installable wheels for some pyproject.toml based projects (Pillow, tokenizers)
```

**é—®é¢˜å¤„ç†**

```bash
sudo apt install -y libssl-dev pkg-config
```



```
      error: could not compile tokenizers (lib) due to 1 previous error; 3 warnings emitted
      
      Caused by:
        process didn't exit successfully: /home/dong4j/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/bin/rustc --crate-name tokenizers --edition=2018 tokenizers-lib/src/lib.rs --error-format=json --json=diagnostic-rendered-ansi,artifacts,future-incompat --crate-type lib --emit=dep-info,metadata,link -C opt-level=3 -C embed-bitcode=no --cfg 'feature="cached-path"' --cfg 'feature="clap"' --cfg 'feature="cli"' --cfg 'feature="default"' --cfg 'feature="dirs"' --cfg 'feature="esaxx_fast"' --cfg 'feature="http"' --cfg 'feature="indicatif"' --cfg 'feature="onig"' --cfg 'feature="progressbar"' --cfg 'feature="reqwest"' --check-cfg 'cfg(docsrs,test)' --check-cfg 'cfg(feature, values("cached-path", "clap", "cli", "default", "dirs", "esaxx_fast", "fancy-regex", "http", "indicatif", "onig", "progressbar", "reqwest", "unstable_wasm"))' -C metadata=dcfeed9efd370df2 -C extra-filename=-6d0cff9823c410a3 --out-dir /tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps -C strip=debuginfo -L dependency=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps --extern aho_corasick=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libaho_corasick-806902cb00c4532e.rmeta --extern cached_path=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libcached_path-140c0420b639fee2.rmeta --extern clap=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libclap-f0a196de7c2c2d55.rmeta --extern derive_builder=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libderive_builder-2c35d20c5dcdd1b2.rmeta --extern dirs=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libdirs-2a450a96233c46e8.rmeta --extern esaxx_rs=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libesaxx_rs-14b460a83d36cffb.rmeta --extern getrandom=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libgetrandom-e4e984aab09fca54.rmeta --extern indicatif=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libindicatif-4bd79d992ed7623e.rmeta --extern itertools=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libitertools-d3748b68b90d39fc.rmeta --extern lazy_static=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/liblazy_static-293673978ef0d67b.rmeta --extern log=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/liblog-eeeeba1bbfa2ffb1.rmeta --extern macro_rules_attribute=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libmacro_rules_attribute-d837ae137eb1c6b5.rmeta --extern monostate=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libmonostate-ee413b2bc414638b.rmeta --extern onig=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libonig-fdcb261852f9dd25.rmeta --extern paste=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libpaste-e8c11b814c73abf8.so --extern rand=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/librand-1a565600c8701f83.rmeta --extern rayon=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/librayon-327814f00a0af0eb.rmeta --extern rayon_cond=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/librayon_cond-4c94b6c4149cf439.rmeta --extern regex=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libregex-b19fe03f86732b4c.rmeta --extern regex_syntax=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libregex_syntax-2d5a08e62adc8bc5.rmeta --extern reqwest=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libreqwest-2e0f1b3d46ba2d8c.rmeta --extern serde=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libserde-09bbdc6f8d206673.rmeta --extern serde_json=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libserde_json-f9dd1e99e29af66a.rmeta --extern spm_precompiled=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libspm_precompiled-b00102097bfa2810.rmeta --extern thiserror=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libthiserror-533f4e0aa82c3f92.rmeta --extern unicode_normalization_alignments=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libunicode_normalization_alignments-9913c65b13ec4f88.rmeta --extern unicode_segmentation=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libunicode_segmentation-175194bc41713dcf.rmeta --extern unicode_categories=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/deps/libunicode_categories-fb12b97a420ed313.rmeta -L native=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/build/bzip2-sys-1373a3f19d1e511d/out/lib -L native=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/build/zstd-sys-6d5eafba8c9430e7/out -L native=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/build/esaxx-rs-9028bfd7929bddde/out -L native=/tmp/pip-install-dnunfm0j/tokenizers_40edca6a2fef4b23bfab7d044c44a2a3/target/release/build/onig_sys-9ef1a52efbdf7afc/out (exit status: 1)
      warning: build failed, waiting for other jobs to finish...
      error: cargo rustc --lib --message-format=json-render-diagnostics --manifest-path Cargo.toml --release -v --features pyo3/extension-module --crate-type cdylib -- failed with code 101
      [end of output]
  
  note: This error originates from a subprocess, and is likely not a problem with pip.
  ERROR: Failed building wheel for tokenizers
ERROR: Failed to build installable wheels for some pyproject.toml based projects (Pillow, tokenizers)
```

**é—®é¢˜å¤„ç†**

```bash
sudo apt update && sudo apt install -y build-essential cmake
sudo apt install -y python3-dev
```

æœ€ç»ˆé—®é¢˜æ˜¯æˆ‘ä½¿ç”¨äº† python3.12, åˆ‡æ¢åˆ° 3.10 å³å¯.



```
OSError: Can't load tokenizer for 'openai/clip-vit-large-patch14'. If you were trying to load it from 'https://huggingface.co/models', make sure you don't have a local directory with the same name. Otherwise, make sure 'openai/clip-vit-large-patch14' is the correct path to a directory containing all relevant files for a CLIPTokenizer tokenizer.

```









**å‚è€ƒ**

- [ç©è½¬ AIGCï¼šUbuntu 24.04 LTS å®‰è£…é…ç½® Stable Diffusion WebUI](https://cloud.tencent.com/developer/article/2416536)



<!--

#### Mac mini M2

ç¡¬ä»¶é…ç½®:

#### AI.Station

ç¡¬ä»¶é…ç½®:

#### NUC11

ç¡¬ä»¶é…ç½®:

-->

## å‚è€ƒèµ„æ–™

- [Tesla P40 æŠ€æœ¯è§„æ ¼]([GeForce GTX 1080 Ti ä¸ P40 æ¯”è¾ƒï¼Ÿ](https://www.zhihu.com/question/267786456))
- [Tesla P40 å‘å¸ƒèµ„æ–™]([NVIDIA å‘å¸ƒ AI è®¡ç®—å¡ Tesla P40ï¼šå®Œæ•´ç‰ˆ GP102 å¤§æ ¸å¿ƒï¼Œ24GB æ˜¾å­˜](https://www.expreview.com/49499.html))
- [Tesla P40 ä¸ GTX 1080TI å¯¹æ¯”]([GeForce GTX 1080 Ti ä¸ P40 æ¯”è¾ƒï¼Ÿ](https://www.zhihu.com/question/267786456))
- [NVIDIA CUDA åˆ—è¡¨]([CUDA Toolkit Archive](https://link.zhihu.com/?target=https%3A//developer.nvidia.com/cuda-toolkit-archive))

## [æ¢ç´¢åœ¨çº¿å°é¢ç”Ÿæˆå·¥å…·ï¼šæ‰“é€ ä¸“å±åšå®¢å°é¢çš„æ·å¾„](https://blog.dong4j.site/posts/cd1cca40.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ç®€ä»‹

åœ¨æ•°å­—åŒ–æ—¶ä»£ï¼Œä¸€å¼ å¸å¼•äººçš„å°é¢å›¾ç‰‡å¯¹äºåšå®¢æ¥è¯´è‡³å…³é‡è¦ã€‚å®ƒä¸ä»…èƒ½å¤Ÿæå‡æ–‡ç« çš„è§†è§‰æ•ˆæœï¼Œè¿˜èƒ½åœ¨ç¬¬ä¸€æ—¶é—´å¸å¼•è¯»è€…çš„æ³¨æ„åŠ›ã€‚åˆ¶ä½œå°é¢çš„æ–¹æ³•å¤šç§å¤šæ ·ï¼Œä»è‡ªè¡Œè®¾è®¡åˆ°åŸºäºç°æœ‰æ¨¡æ¿è¿›è¡Œä¿®æ”¹ï¼Œæ¯ç§æ–¹å¼éƒ½æœ‰å…¶ç‹¬ç‰¹ä¹‹å¤„ã€‚ç„¶è€Œï¼Œå¦‚æœä½ å¸Œæœ›ä»¥æœ€å¿«æ·çš„æ–¹å¼è¾“å…¥æ ‡é¢˜æˆ–åŸºæœ¬ä¿¡æ¯ï¼Œç›´æ¥ç”Ÿæˆå°é¢ï¼Œé‚£ä¹ˆåœ¨çº¿å°é¢ç”Ÿæˆå™¨æ— ç–‘æ˜¯ä½ çš„æœ€ä½³é€‰æ‹©ã€‚ä»Šå¤©ï¼Œå°±è®©æˆ‘å¸¦ä½ ä¸€èµ·æ¢ç´¢å‡ æ¬¾ä¼˜ç§€çš„åœ¨çº¿å°é¢ç”Ÿæˆå·¥å…·ï¼Œä¸ºä½ çš„æŠ€æœ¯åšå®¢å¢æ·»ä¸€æŠ¹äº®è‰²ã€‚

## CoverViewï¼šå¼€å‘è€…çš„é¦–é€‰

![20250211194200_tjcJIPk6.webp](https://cdn.dong4j.site/source/image/20250211194200_tjcJIPk6.webp)

**é“¾æ¥ï¼š** [CoverView](https://coverview.vercel.app/) | [GitHub ä»“åº“](https://github.com/rutikwankhade/CoverView)

CoverView ä»¥å…¶ä¸°å¯Œçš„å†…ç½®æ¨¡æ¿å’Œå›¾æ ‡è€Œè‘—ç§°ï¼Œå°¤å…¶æ˜¯é’ˆå¯¹ç¼–ç¨‹è¯­è¨€çš„å›¾æ ‡ï¼Œè¿™ä½¿å¾—å®ƒæˆä¸ºå¼€å‘è€…åˆ¶ä½œæŠ€æœ¯åšå®¢å°é¢çš„ç†æƒ³å·¥å…·ã€‚æ— è®ºæ˜¯ Javaã€Python è¿˜æ˜¯ Reactï¼Œä½ éƒ½èƒ½åœ¨è¿™é‡Œæ‰¾åˆ°åˆé€‚çš„å›¾æ ‡å’Œæ¨¡æ¿ï¼Œå¿«é€Ÿæ‰“é€ å‡ºä¸“ä¸šä¸”ç¬¦åˆæŠ€æœ¯æ°›å›´çš„å°é¢ã€‚

## Cover-Image-Generatorï¼šçµæ´»è°ƒæ•´ï¼Œåˆ›æ„æ— é™

![20250211194200_aYfVrY87.webp](https://cdn.dong4j.site/source/image/20250211194200_aYfVrY87.webp)

**é“¾æ¥ï¼š** [Cover-Image-Generator](https://blogcover.vercel.app/) | [GitHub ä»“åº“](https://github.com/PJijin/Cover-Image-Generator)

è™½ç„¶æ²¡æœ‰å†…ç½®æ¨¡æ¿ï¼Œä½† Cover-Image-Generator çš„çµæ´»æ€§å´ä¸ºå…¶èµ¢å¾—äº†ä¼—å¤šç²‰ä¸ã€‚ä½ å¯ä»¥è‡ªç”±ç§»åŠ¨æ ‡é¢˜å’Œå‰¯æ ‡é¢˜çš„ä½ç½®ï¼Œè°ƒæ•´å­—ä½“ã€é¢œè‰²å’Œå¤§å°ï¼Œç›´è‡³è¾¾åˆ°æ»¡æ„çš„æ•ˆæœã€‚è¿™ç§è‡ªç”±åº¦è®©åˆ›æ„æ— é™å»¶ä¼¸ï¼Œä¸ºä½ çš„åšå®¢å°é¢å¢æ·»ä¸ªæ€§è‰²å½©ã€‚

## PicProseï¼šç®€æ´è€Œä¸ç®€å•

![20250211194200_RjSyhkBw.webp](https://cdn.dong4j.site/source/image/20250211194200_RjSyhkBw.webp)

**é“¾æ¥ï¼š** [PicProse](https://picprose.net/zh) | [GitHub ä»“åº“](https://github.com/jaaronkot/picprose)

PicProse ä»¥å…¶ç®€æ´çš„ç•Œé¢å’Œå®ç”¨çš„åŠŸèƒ½è‘—ç§°ã€‚å®ƒæä¾›äº†åŸºæœ¬çš„å°é¢è®¾è®¡å…ƒç´ ï¼Œè®©ä½ èƒ½å¤Ÿå¿«é€Ÿä¸Šæ‰‹ï¼ŒåŒæ—¶åˆä¸å¤±ä¸“ä¸šæ„Ÿã€‚æ— è®ºæ˜¯ç®€å•çš„æ–‡å­—å°é¢è¿˜æ˜¯éœ€è¦æ·»åŠ å›¾ç‰‡çš„å¤æ‚è®¾è®¡ï¼ŒPicProse éƒ½èƒ½è½»æ¾åº”å¯¹ã€‚

## imgsrcï¼šä¸ªæ€§åŒ–å®šåˆ¶ï¼Œå½°æ˜¾ç‰¹è‰²

![20250211141043_kt8UBSxC.webp](https://cdn.dong4j.site/source/image/20250211141043_kt8UBSxC.webp)

**é“¾æ¥ï¼š** [imgsrc](https://imgsrc.io/) | [GitHub ä»“åº“](https://github.com/FadyMak/imgsrc-app)

imgsrc å…è®¸ä½ ä¸Šä¼ è‡ªå®šä¹‰å›¾æ ‡å’Œå›¾ç‰‡ï¼Œä¸ºå°é¢å¢æ·»ä¸ªæ€§åŒ–å…ƒç´ ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜æä¾›äº†å¤šç§èƒŒæ™¯å’Œå¸ƒå±€é€‰æ‹©ï¼Œè®©ä½ èƒ½å¤Ÿæ ¹æ®åšå®¢å†…å®¹å®šåˆ¶ä¸“å±å°é¢ã€‚æ— è®ºæ˜¯å±•ç¤ºç½‘ç«™è¿˜æ˜¯æ¨ªå‘å›¾ç‰‡ï¼Œimgsrc éƒ½èƒ½å¸®ä½ å®ç°ã€‚

## Free Open Graph Generatorï¼šæ— æ°´å°ï¼Œæ›´ä¸“ä¸š

![20250211194201_FWOlacrG.webp](https://cdn.dong4j.site/source/image/20250211194201_FWOlacrG.webp)

**é“¾æ¥ï¼š** [Free Open Graph Generator](https://og.indiehub.best/)

åŸºäº imgsrc ä¿®æ”¹è€Œæ¥çš„ Free Open Graph Generator å»æ‰äº†æ°´å°åŠŸèƒ½ï¼Œè®©ä½ çš„å°é¢çœ‹èµ·æ¥æ›´åŠ ä¸“ä¸šã€‚å®ƒä¿ç•™äº† imgsrc çš„å®ç”¨åŠŸèƒ½ï¼ŒåŒæ—¶æå‡äº†å°é¢çš„æ•´ä½“ç¾æ„Ÿã€‚

## OG Image Makerï¼šæ¨¡æ¿ä¸°å¯Œï¼Œè‡ªå®šä¹‰åº¦é«˜

![20250211194201_NjJkKtqj.webp](https://cdn.dong4j.site/source/image/20250211194201_NjJkKtqj.webp)

**é“¾æ¥ï¼š** [OG Image Maker](https://ogimagemaker.com/)

OG Image Maker å†…ç½®äº†å¤šç§æ¨¡æ¿ä¾›ä½ é€‰æ‹©ï¼ŒåŒæ—¶æ”¯æŒä¿®æ”¹é¢œè‰²ã€èƒŒæ™¯å›¾ç‰‡å’Œåº•éƒ¨çš„æŒ‰é’®ç­‰å…ƒç´ ã€‚è¿™ç§é«˜åº¦çš„è‡ªå®šä¹‰æ€§è®©ä½ èƒ½å¤Ÿæ‰“é€ å‡ºç‹¬å…·ç‰¹è‰²çš„åšå®¢å°é¢ã€‚

## Open Graph Image Generatorï¼šä¸“æ³¨ç½‘ç«™å±•ç¤º

![20250211194201_SZgoX96u.webp](https://cdn.dong4j.site/source/image/20250211194201_SZgoX96u.webp)

**é“¾æ¥ï¼š** [Open Graph Image Generator](https://tailwind-generator.com/og-image-generator/generator)

è¿™æ¬¾ç”Ÿæˆå™¨ç‰¹åˆ«é€‚åˆç”¨æ¥å±•ç¤ºç½‘ç«™æˆ–æ¨ªå‘å›¾ç‰‡ã€‚è™½ç„¶ä¸Šä¼ çš„å›¾æ ‡å¤§å°å›ºå®šï¼Œä½†å…¶ä¸“ä¸šçš„è®¾è®¡æ„Ÿä½¿å¾—å®ƒæˆä¸ºå±•ç¤ºç½‘ç«™å†…å®¹çš„ç†æƒ³é€‰æ‹©ã€‚

## Free Open Graph Image Generator - Placid.appï¼šç®€æ´å®ç”¨

![20250211194201_0I9olZZk.webp](https://cdn.dong4j.site/source/image/20250211194201_0I9olZZk.webp)

**é“¾æ¥ï¼š** [Free Open Graph Image Generator - Placid.app](https://placid.app/tools/free-open-graph-image-generator)

Placid.app æä¾›çš„è¿™æ¬¾ç”Ÿæˆå™¨ç•Œé¢ç®€æ´æ˜äº†ï¼Œæ“ä½œç®€ä¾¿ã€‚ä½ åªéœ€è¾“å…¥æ ‡é¢˜å’Œå‰¯æ ‡é¢˜ï¼Œé€‰æ‹©åˆé€‚çš„å¸ƒå±€å³å¯ç”Ÿæˆæ»¡æ„çš„å°é¢å›¾ç‰‡ã€‚

## Open Graph Image Generator | BoilerplateHubï¼šå¿«é€Ÿç”Ÿæˆï¼Œç®€å•é«˜æ•ˆ

![20250211194201_uoI2Oz33.webp](https://cdn.dong4j.site/source/image/20250211194201_uoI2Oz33.webp)

**é“¾æ¥ï¼š** [Open Graph Image Generator | BoilerplateHub](https://boilerplatehub.com/free-tools/open-graph-image-generator)

BoilerplateHub çš„è¿™æ¬¾ç”Ÿæˆå™¨ä»¥å…¶å¿«é€Ÿå’Œç®€å•è‘—ç§°ã€‚å®ƒæä¾›äº†ä¸¤ç§å¸ƒå±€é€‰æ‹©ï¼Œè®©ä½ åªéœ€è¾“å…¥æ ‡é¢˜å’Œå‰¯æ ‡é¢˜å³å¯ç”Ÿæˆå°é¢ã€‚å¯¹äºè¿½æ±‚æ•ˆç‡çš„åšä¸»æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸å¯å¤šå¾—çš„å·¥å…·ã€‚

## Vercel OG Image Playgroundï¼šå®˜æ–¹å‡ºå“ï¼Œå“è´¨ä¿è¯

![20250211194201_ZJNWNN3S.webp](https://cdn.dong4j.site/source/image/20250211194201_ZJNWNN3S.webp)

**é“¾æ¥ï¼š** [Vercel OG Image Playground](https://og-playground.vercel.app/)

ä½œä¸º Vercel å®˜æ–¹æ¨å‡ºçš„ OG å›¾åƒç”Ÿæˆå™¨ï¼Œè¿™æ¬¾å·¥å…·æä¾›äº†é«˜è´¨é‡çš„è®¾è®¡ä½“éªŒã€‚ä½ å¯ä»¥åœ¨å³ä¸‹è§’å¯¼å‡º svg æ ¼å¼çš„å›¾ç‰‡ï¼Œå¦‚æœéœ€è¦ png æ ¼å¼ï¼Œåªéœ€åœ¨å³ä¸Šè§’çš„ tab æ ä¸­åˆ‡æ¢åˆ° pngï¼ˆsatori + resvg-jsï¼‰æ¨¡å¼ã€‚æ— è®ºæ˜¯è®¾è®¡æ„Ÿè¿˜æ˜¯å®ç”¨æ€§ï¼ŒVercel OG Image Playground éƒ½å ªç§°ä¸€æµã€‚

## cover-paintï¼šè‡ªéƒ¨ç½²ï¼Œçµæ´»ä½¿ç”¨

![20250211194201_fYCmHyXG.webp](https://cdn.dong4j.site/source/image/20250211194201_fYCmHyXG.webp)

**é“¾æ¥ï¼š** [cover-paint](https://coverpaint.xiaole.site/) | [GitHub ä»“åº“](https://github.com/youngle316/cover-paint)

è™½ç„¶ç›®å‰å®˜ç½‘å¯èƒ½æ— æ³•è®¿é—®ï¼Œä½†ä½ å¯ä»¥é€šè¿‡ GitHub ä»“åº“åœ¨ Vercel æˆ– Netlify ç­‰å¹³å°è‡ªè¡Œéƒ¨ç½²ä½¿ç”¨ã€‚cover-paint æä¾›äº†ä¸°å¯Œçš„è‡ªå®šä¹‰é€‰é¡¹ï¼Œè®©ä½ èƒ½å¤Ÿæ ¹æ®ä¸ªäººéœ€æ±‚æ‰“é€ ç‹¬ç‰¹çš„å°é¢è®¾è®¡ã€‚

## æ€»ç»“

ç›®å‰æ­£åœ¨ä½¿ç”¨ `CoverView` , ä¸è¿‡æ¯æ¬¡éƒ½éœ€è¦å»é…ç½® + ä¸‹è½½ + ç§»åŠ¨åˆ°åšå®¢ç›®å½•, æ„Ÿè§‰è¿˜æ˜¯æœ‰å¾ˆå¤šæ­¥éª¤è¦æ‰‹åŠ¨æ“ä½œ. è€Œ `Free Open Graph Generator` æä¾›äº†å›¾åƒç”Ÿæˆçš„ API, é‚£ä¹ˆå°±è‡ªåŠ¨åŒ–ç”Ÿæˆ cover æä¾›äº†å¯èƒ½.

ç›®å‰æ˜¯è¿™æ ·æ‰“ç®—çš„:

1. hexo ç¼–è¯‘æ—¶é€šè¿‡é’©å­è·å–åšå®¢æ–‡ç« çš„å…ƒæ•°æ®, ç„¶åæ„å»º API å‚æ•°è°ƒç”¨åç«¯è‡ªå»ºçš„éšæœº API æ¥å£;
2. æ–°å¢ä¸€ä¸ªéšæœº API æ¥å£, ç”¨äºå¤„ç† cover çš„ç”Ÿæˆ:
   1. æ ¹æ® `abbrlink` è·å– CDN å›¾ç‰‡,å¦‚æœå­˜åœ¨åˆ™ç›´æ¥è¿”å›;
   2. å¦‚æœä¸å­˜åœ¨åˆ™è°ƒç”¨ `Free Open Graph Generator` æ¥å£ç”Ÿæˆå¹¶è½¬æ¢ä¸º webp, ä¸Šä¼ åˆ°å›¾åºŠ, æœ€åè¿”å› CDN åœ°å€;

æ„Ÿè§‰è¿™ä¸€å¥—ç»„åˆæ‹³ä¸‹æ¥, åšå®¢ cover å›¾ç‰‡çš„é—®é¢˜å°±å½»åº•è§£å†³äº†.

å…¶å®è¿™ç±»å›¾ç‰‡å¯ä»¥ä½¿ç”¨ [Open Graph åè®®](https://ogp.me/) æ¥ç”Ÿæˆ, åƒè¿™ç±»çš„é¡¹ç›®éå¸¸å¤š, æ¯”å¦‚:

- https://github.com/sanwebinfo/og-image
- https://github.com/samholmes/node-open-graph?tab=readme-ov-file
- https://github.com/kvnang/workers-og
- https://github.com/kentaro-m/catchy-image
- https://github.com/svycal/og-image?tab=readme-ov-file

æœ€æ ¸å¿ƒçš„å›¾åƒç”Ÿæˆå·²ç»æœ‰äº†, é‚£ä¹ˆå‰©ä¸‹çš„å°±æ˜¯å°†æ•´ä¸ªæµç¨‹ä¸²è”èµ·æ¥, å®ç°è‡ªåŠ¨åŒ–ç”Ÿæˆåšå®¢æ–‡ç« çš„ cover å›¾åƒ. 

ç­‰å®ç°äº†å†æ¥æ°´ä¸€ç¯‡åšå®¢ ğŸ™‰.

## [ä»é›¶å¼€å§‹å¼€å‘ä¸€ä¸ª Hexo æ’ä»¶ï¼šä»¥ hexo-plugin-llmstxt ä¸ºä¾‹](https://blog.dong4j.site/posts/b902d8fd.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## å‰è¨€

åœ¨ AI æ—¶ä»£ï¼Œè¶Šæ¥è¶Šå¤šçš„å¼€å‘è€…å¼€å§‹ä½¿ç”¨ AI ç¼–ç¨‹åŠ©æ‰‹æ¥æå‡å¼€å‘æ•ˆç‡ã€‚ä¸ºäº†è®© AI æ›´å¥½åœ°ç†è§£å’Œå­¦ä¹ æˆ‘ä»¬çš„æŠ€æœ¯æ–‡æ¡£ï¼Œç¤¾åŒºæå‡ºäº† `llms.txt` è§„èŒƒã€‚æœ¬æ–‡å°†ä»¥å¼€å‘ä¸€ä¸ªç”Ÿæˆ `llms.txt` çš„ Hexo æ’ä»¶ä¸ºä¾‹ï¼Œä»‹ç» Hexo æ’ä»¶å¼€å‘çš„åŸºæœ¬æµç¨‹ã€‚

## ä»€ä¹ˆæ˜¯ llms.txtï¼Ÿ

### èƒŒæ™¯

éšç€ ChatGPTã€Claude ç­‰å¤§è¯­è¨€æ¨¡å‹çš„æ™®åŠï¼Œè¶Šæ¥è¶Šå¤šçš„å¼€å‘è€…å¼€å§‹ä½¿ç”¨ AI ç¼–ç¨‹åŠ©æ‰‹ã€‚ä½†æ˜¯è¿™äº› AI åŠ©æ‰‹åœ¨è®¿é—®ç½‘ç«™å†…å®¹æ—¶ï¼Œå¾€å¾€éœ€è¦å¤„ç†å¤æ‚çš„ HTML ç»“æ„ï¼Œè¿™ä¸ä»…å¢åŠ äº†å¤„ç†æˆæœ¬ï¼Œè¿˜å¯èƒ½å½±å“ç†è§£çš„å‡†ç¡®æ€§ã€‚

### llms.txt è§„èŒƒ

`llms.txt` ç±»ä¼¼äº `robots.txt`ï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸“é—¨ä¸º AI å‡†å¤‡çš„çº¯æ–‡æœ¬æ ¼å¼çš„ç«™ç‚¹å†…å®¹ç´¢å¼•ã€‚é€šè¿‡æä¾›ç»“æ„åŒ–çš„çº¯æ–‡æœ¬å†…å®¹ï¼Œå¯ä»¥å¸®åŠ© AI æ›´å¥½åœ°ç†è§£å’Œå­¦ä¹ ç½‘ç«™çš„å†…å®¹ã€‚

ä¸»è¦ç‰¹ç‚¹ï¼š
1. çº¯æ–‡æœ¬æ ¼å¼ï¼Œæ˜“äºè§£æ
2. åŒ…å«æ–‡ç« çš„æ ‡é¢˜ã€æè¿°å’Œé“¾æ¥
3. å¯é€‰åŒ…å«å®Œæ•´çš„æ–‡ç« å†…å®¹
4. æ”¯æŒ Markdown æ ¼å¼

æŸ¥çœ‹æœ¬ç«™çš„ [llmx.txt](https://blog.dong4j.site/llms.txt) å’Œ [llmx-full.txt](https://blog.dong4j.site/llms-full.txt)

## Hexo æ’ä»¶å¼€å‘åŸºç¡€

### æ’ä»¶ç±»å‹

Hexo æ”¯æŒå¤šç§ç±»å‹çš„æ’ä»¶ï¼š
- Generatorï¼šç”¨äºç”Ÿæˆé™æ€æ–‡ä»¶
- Rendererï¼šç”¨äºæ¸²æŸ“æ–‡ä»¶
- Helperï¼šç”¨äºè¾…åŠ©æ¨¡æ¿æ¸²æŸ“
- Deployerï¼šç”¨äºéƒ¨ç½²
- Processorï¼šç”¨äºå¤„ç†æºæ–‡ä»¶
- Tagï¼šç”¨äºåœ¨æ–‡ç« ä¸­æ’å…¥ç‰¹å®šå†…å®¹
- Consoleï¼šç”¨äºæ·»åŠ æ§åˆ¶å°å‘½ä»¤

æˆ‘ä»¬çš„ `llms.txt` ç”Ÿæˆæ’ä»¶å±äº Generator ç±»å‹ã€‚

### åŸºæœ¬ç»“æ„

ä¸€ä¸ªå…¸å‹çš„ Hexo æ’ä»¶ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

```
.
â”œâ”€â”€ index.js
â”œâ”€â”€ package.json
â”œâ”€â”€ README.md
â””â”€â”€ LICENSE
```

### æ’ä»¶å‘½åè§„èŒƒ

Hexo æ’ä»¶çš„å‘½åéœ€è¦éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š
- ä»¥ `hexo-` å¼€å¤´
- å…¨å°å†™
- ä½¿ç”¨è¿å­—ç¬¦ï¼ˆ-ï¼‰è¿æ¥å•è¯

## å®æˆ˜ï¼šå¼€å‘ hexo-plugin-llmstxt

### 1. åˆå§‹åŒ–é¡¹ç›®

é¦–å…ˆåˆ›å»ºé¡¹ç›®ç›®å½•å¹¶åˆå§‹åŒ–ï¼š

```bash
mkdir hexo-plugin-llmstxt
cd hexo-plugin-llmstxt
npm init
```

### 2. ç¼–å†™ package.json

```json
{
  "name": "hexo-plugin-llmstxt",
  "version": "1.0.0",
  "description": "Generate llms.txt for Hexo sites",
  "main": "index.js",
  "keywords": [
    "hexo",
    "llms",
    "ai"
  ],
  "dependencies": {}
}
```

### 3. å®ç°æ ¸å¿ƒåŠŸèƒ½

åœ¨ `index.js` ä¸­å®ç°æ’ä»¶çš„æ ¸å¿ƒåŠŸèƒ½ï¼š

```javascript
'use strict';

const fs = require('fs');
const path = require('path');

// æ³¨å†Œç”Ÿæˆå™¨
hexo.extend.generator.register('llms', function (locals) {
  // è·å–é…ç½®
  const config = Object.assign({
    generate_llms_full: false,
    debug: false,
    postsHeader: hexo.config.title,
    description: hexo.config.description,
    sort: 'desc'
  }, hexo.config.llmstxt);

  // ç”Ÿæˆæ–‡ä»¶å†…å®¹
  // ...
});
```

### 4. å¤„ç†æ–‡ç« å†…å®¹

```javascript
// å¤„ç†æ¯ç¯‡æ–‡ç« 
locals.posts.sort('date', sortOrder)
  .filter(post => post.published !== false)
  .forEach(post => {
    const {
      title,
      raw,
      description,
    } = post;

    // ç§»é™¤ Front-matter
    const content = raw.replace(/^---[\s\S]+?---\n/, '').trim();
    
    // ç”Ÿæˆé“¾æ¥å’Œå†…å®¹
    // ...
  });
```

### 5. æ–‡ä»¶ç”Ÿæˆ

```javascript
// å†™å…¥æ–‡ä»¶
try {
  fs.writeFileSync(llmsFilePath, llmsContent);
  if (config.debug) {
    console.log('ç”Ÿæˆ llms.txt æˆåŠŸ');
  }
} catch (err) {
  console.error('å†™å…¥æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯:', err);
}
```

## å¼€å‘è¿‡ç¨‹ä¸­çš„æ³¨æ„äº‹é¡¹

1. **é”™è¯¯å¤„ç†**
   - ç¡®ä¿ç›®å½•å­˜åœ¨
   - å¤„ç†æ–‡ä»¶å†™å…¥é”™è¯¯
   - æ·»åŠ è°ƒè¯•æ—¥å¿—

2. **é…ç½®å¤„ç†**
   - æä¾›é»˜è®¤å€¼
   - æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰
   - é…ç½®é¡¹æ–‡æ¡£åŒ–

3. **æ–‡ä»¶è·¯å¾„**
   - ä½¿ç”¨ `path.join` å¤„ç†è·¯å¾„
   - è€ƒè™‘è·¨å¹³å°å…¼å®¹æ€§

4. **æ€§èƒ½ä¼˜åŒ–**
   - é¿å…é‡å¤æ“ä½œ
   - åˆç†ä½¿ç”¨å†…å­˜

5. **ä»£ç é£æ ¼**
   - éµå¾ª JavaScript è§„èŒƒ
   - æ·»åŠ é€‚å½“çš„æ³¨é‡Š
   - ä¿æŒä»£ç æ•´æ´

## æµ‹è¯•å’Œå‘å¸ƒ

### æœ¬åœ°æµ‹è¯•

1. åœ¨æœ¬åœ° Hexo é¡¹ç›®ä¸­ä½¿ç”¨ npm linkï¼š
```bash
cd hexo-plugin-llmstxt
npm link
cd /path/to/hexo/project
npm link hexo-plugin-llmstxt
```

2. è¿è¡Œ Hexo å‘½ä»¤æµ‹è¯•ï¼š
```bash
hexo clean
hexo generate
```

### å‘å¸ƒåˆ° NPM

1. ç™»å½• NPMï¼š
```bash
npm login
```

2. å‘å¸ƒåŒ…ï¼š
```bash
npm publish
```

## æºç :

https://github.com/dong4j/hexo-plugin-llms

## å‚è€ƒèµ„æ–™

- [Hexo å®˜æ–¹æ–‡æ¡£](https://hexo.io/docs/)
- [LLMs.txt è§„èŒƒ](https://llmstxt.org)
- [å…·æœ‰ LLMs.txt çš„ç«™ç‚¹](https://llmstxt.site/)
- [AIæ—¶ä»£çš„ç«™ç‚¹åœ°å›¾](https://juejin.cn/post/7447083753187328050) 
- [SiliconCloud ä½¿ç”¨æ–‡æ¡£ä¸ Cursor](https://docs.siliconflow.cn/use-docs-with-cursor)
- [ä½¿ç”¨ Firecrawl ç”Ÿæˆ llmstxt](https://github.com/mendableai/llmstxt-generator)
- [ä½¿ç”¨ sitemap.xml ç”Ÿæˆ llmstxt](https://github.com/dotenvx/llmstxt)

## [Lazydockerï¼šç»ˆç«¯ä¸­çš„æ‡’äºº Docker ç®¡ç†ç¥å™¨](https://blog.dong4j.site/posts/edfbbdc9.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![20250211170022_5u6teeGg.webp](https://cdn.dong4j.site/source/image/20250211170022_5u6teeGg.webp)

## ç®€ä»‹

åœ¨ Docker ç”Ÿæ€ä¸­ï¼Œå‘½ä»¤è¡Œæ“ä½œè™½ç„¶å¼ºå¤§ï¼Œä½†ç¹ççš„å‘½ä»¤è®°å¿†å’Œè·¨ç»ˆç«¯çª—å£çš„å®¹å™¨ç®¡ç†å¾€å¾€è®©å¼€å‘è€…å¤´ç–¼ã€‚**Lazydocker** åº”è¿è€Œç”Ÿï¼Œè¿™æ˜¯ä¸€æ¬¾åŸºäºç»ˆç«¯çš„ Docker ç®¡ç†å·¥å…·ï¼Œå‡­å€Ÿç®€æ´çš„ UI è®¾è®¡å’Œä¸€é”®å¼æ“ä½œï¼Œæˆä¸ºä¼—å¤šå¼€å‘è€…æå‡æ•ˆç‡çš„åˆ©å™¨ã€‚æœ¬æ–‡å°†ä»åŠŸèƒ½ã€å®‰è£…åˆ°å®é™…ä½“éªŒï¼Œå…¨é¢è§£æè¿™ä¸€å·¥å…·ã€‚

---

## Lazydocker çš„æ ¸å¿ƒåŠŸèƒ½

1. **ä¸€ç«™å¼å®¹å™¨ç®¡ç†** 
   é€šè¿‡ç»ˆç«¯ UI ç•Œé¢ï¼ŒLazydocker æ”¯æŒå®æ—¶æŸ¥çœ‹ Docker å®¹å™¨ã€é•œåƒã€å·å’Œç½‘ç»œçš„è¿è¡ŒçŠ¶æ€ï¼Œæ— éœ€åœ¨å¤šä¸ªç»ˆç«¯çª—å£åˆ‡æ¢ã€‚
2. **å¿«æ·æ“ä½œä¸è°ƒè¯•**

   - **æ—¥å¿—æµåˆ†ç±»æŸ¥çœ‹**ï¼šæ”¯æŒæŒ‰æœåŠ¡æˆ–å®¹å™¨åˆ†ç±»æ˜¾ç¤ºæ—¥å¿—ï¼Œå¿«é€Ÿå®šä½é—®é¢˜ã€‚
   - **ä¸€é”®é‡å¯/é‡å»ºå®¹å™¨**ï¼šæŒ‰ä¸‹å¿«æ·é”®å³å¯é‡å¯ã€é‡å»ºæˆ–åˆ é™¤å®¹å™¨ï¼Œå°¤å…¶é€‚åˆè°ƒè¯•æœåŠ¡æ•…éšœã€‚
   - **é•œåƒä¸ç£ç›˜ç®¡ç†**ï¼šæŸ¥çœ‹é•œåƒå±‚çº§ç»“æ„ï¼Œæ¸…ç†æ— ç”¨é•œåƒæˆ–å·ä»¥é‡Šæ”¾ç£ç›˜ç©ºé—´ã€‚

3. **è‡ªå®šä¹‰ä¸æ‰©å±•æ€§** 
   ç”¨æˆ·å¯ç»‘å®šè‡ªå®šä¹‰å‘½ä»¤æˆ–å¿«æ·é”®ï¼Œç”šè‡³é€šè¿‡é…ç½®æ–‡ä»¶ä¿®æ”¹ç•Œé¢å¸ƒå±€ï¼Œæ»¡è¶³ä¸ªæ€§åŒ–éœ€æ±‚ã€‚

---

## å®‰è£…æŒ‡å—ï¼ˆæ”¯æŒå¤šå¹³å°ï¼‰

Lazydocker æ”¯æŒå¤šç§å®‰è£…æ–¹å¼ï¼Œä»¥ä¸‹æ˜¯ä¸»æµæ“ä½œç³»ç»Ÿçš„å¿«é€Ÿå®‰è£…æ–¹æ³•ï¼š

1. **Linux/macOS**

   - **ä¸€é”®è„šæœ¬å®‰è£…**ï¼ˆæ¨èï¼‰ï¼š
     ```bash
     curl https://raw.githubusercontent.com/jesseduffield/lazydocker/master/scripts/install_update_linux.sh | bash
     ```
   - **Homebrew**ï¼ˆmacOSï¼‰ï¼š
     ```bash
     brew install lazydocker
     ```
   - **æ‰‹åŠ¨å®‰è£…**ï¼š 
     ä» [GitHub Release é¡µé¢](https://github.com/jesseduffield/lazydocker/releases) ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶åŒ…ï¼Œè§£å‹åæ·»åŠ åˆ°ç³»ç»Ÿè·¯å¾„å³å¯ã€‚

2. **Windows** 
   ä½¿ç”¨ Scoop åŒ…ç®¡ç†å™¨å®‰è£…ï¼š

   ```powershell
   scoop install lazydocker
   ```

3. **Docker å®¹å™¨è¿è¡Œ** 
   è‹¥ä¸æƒ³æœ¬åœ°å®‰è£…ï¼Œå¯ç›´æ¥é€šè¿‡ Docker è¿è¡Œï¼š
   
   ```bash
   docker run --rm -it -v /var/run/docker.sock:/var/run/docker.sock lazyteam/lazydocker
   ```
   æ­¤æ–¹å¼é€‚åˆä¸´æ—¶ä½¿ç”¨æˆ–éš”ç¦»ç¯å¢ƒè°ƒè¯•ã€‚

---

## ä½¿ç”¨åœºæ™¯ä¸å®æˆ˜æŠ€å·§

1. **å®æ—¶ç›‘æ§å®¹å™¨çŠ¶æ€** 
   è¾“å…¥ `lazydocker` å¯åŠ¨åï¼Œç•Œé¢ä¼šåˆ†æ æ˜¾ç¤ºå®¹å™¨åˆ—è¡¨ã€æ—¥å¿—ã€çŠ¶æ€ç»Ÿè®¡ç­‰ä¿¡æ¯ï¼ˆå¦‚å›¾ï¼‰ã€‚é€šè¿‡æ–¹å‘é”®æˆ–é¼ æ ‡ç‚¹å‡»åˆ‡æ¢ç„¦ç‚¹ï¼ŒæŒ‰ `R` é”®é‡å¯å®¹å™¨ï¼ŒæŒ‰ `L` æŸ¥çœ‹å®æ—¶æ—¥å¿—æµã€‚

2. **å¿«é€Ÿè°ƒè¯•æœåŠ¡å¼‚å¸¸** 
   ä¾‹å¦‚ï¼Œå½“æŸä¸ªå®¹å™¨å´©æºƒæ—¶ï¼Œå¯åœ¨ Lazydocker ä¸­ç›´æ¥æŸ¥çœ‹å…¶æ—¥å¿—æµï¼ŒæŒ‰ `r` é‡å¯æœåŠ¡ï¼Œæˆ–æŒ‰ `b` è¿›å…¥å®¹å™¨ Shell æ‰‹åŠ¨è°ƒè¯•ã€‚

3. **æ‰¹é‡ç®¡ç†èµ„æº** 
   æ”¯æŒæ‰¹é‡é€‰æ‹©å®¹å™¨è¿›è¡Œé‡å¯æˆ–åˆ é™¤æ“ä½œï¼ŒåŒæ—¶å¯æŸ¥çœ‹é•œåƒçš„ç£ç›˜å ç”¨ï¼Œæ¸…ç†æ— ç”¨æ•°æ®ã€‚

---

## ä¼˜ç¼ºç‚¹åˆ†æ

**ä¼˜ç‚¹**ï¼š

- **é›¶å­¦ä¹ æˆæœ¬**ï¼šç•Œé¢ç›´è§‚ï¼Œå¿«æ·é”®æç¤ºæ¸…æ™°ï¼Œé€‚åˆ Docker åˆå­¦è€…ã€‚
- **è½»é‡é«˜æ•ˆ**ï¼šåŸºäº Go è¯­è¨€å¼€å‘ï¼Œèµ„æºå ç”¨ä½ï¼Œå“åº”é€Ÿåº¦å¿«ã€‚
- **è·¨å¹³å°æ”¯æŒ**ï¼šè¦†ç›– Linuxã€macOSã€Windows å’Œ Docker å®¹å™¨ç¯å¢ƒã€‚

**ç¼ºç‚¹**ï¼š

- **åŠŸèƒ½å±€é™**ï¼šå¤æ‚åœºæ™¯ä»éœ€ä¾èµ– Portainer ç­‰ Web ç®¡ç†å·¥å…·ã€‚
- **å¶å‘ Bug**ï¼šéƒ¨åˆ†ç”¨æˆ·åé¦ˆå®¹å™¨çŠ¶æ€æ˜¾ç¤ºå¼‚å¸¸ï¼ˆå¦‚è¿è¡ŒçŠ¶æ€æœªæ›´æ–°ï¼‰ã€‚

---

## æ€»ç»“ä¸æ¨è

Lazydocker å®Œç¾å¥‘åˆâ€œæ‡’äººå¼€å‘è€…â€çš„éœ€æ±‚ï¼Œå°† Docker ç®¡ç†çš„å¤æ‚æ€§ç®€åŒ–ä¸ºç»ˆç«¯å†…çš„å¯è§†åŒ–æ“ä½œã€‚å°½ç®¡å­˜åœ¨å°èŒƒå›´åŠŸèƒ½é™åˆ¶ï¼Œä½†å…¶è½»é‡åŒ–å’Œé«˜æ•ˆç‡çš„ç‰¹ç‚¹ï¼Œä½¿å…¶æˆä¸ºæ—¥å¸¸å¼€å‘å’Œè°ƒè¯•çš„å¿…å¤‡å·¥å…·ã€‚å¯¹äºåå¥½å‘½ä»¤è¡Œæ“ä½œçš„ç”¨æˆ·ï¼ŒLazydocker æ˜¯ Portainer çš„ç»ä½³è¡¥å……ã€‚

**é¡¹ç›®åœ°å€**ï¼š[GitHub - jesseduffield/lazydocker](https://github.com/jesseduffield/lazydocker) 
**æ‰©å±•é˜…è¯»**ï¼š

- å®˜æ–¹æ–‡æ¡£æä¾›äº†å®Œæ•´çš„å¿«æ·é”®åˆ—è¡¨å’Œé…ç½®ç¤ºä¾‹ã€‚
- B ç«™æœ‰å¼€å‘è€…åˆ†äº«äº† Lazydocker çš„å®é™…æ“ä½œæ¼”ç¤ºï¼ˆ[è§†é¢‘é“¾æ¥](https://m.bilibili.com/video/BV1AA4m137XJ/)ï¼‰

å°è¯• Lazydockerï¼Œè®©ä½ çš„ Docker ç®¡ç†ä»æ­¤â€œæ‡’â€å¾—é«˜æ•ˆï¼

## [å“ªå’é¢æ¿é…ç½®æŒ‡å—ï¼šè‡ªæ‰˜ç®¡ä¸å®‰å…¨é˜²æ§è¯¦è§£](https://blog.dong4j.site/posts/adc3ac9e.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![20250211170256_jLzrA4QP.webp](https://cdn.dong4j.site/source/image/20250211170256_jLzrA4QP.webp)

## ç®€ä»‹

å“ªå’é¢æ¿æ˜¯ä¸€ä¸ªå¼€æºçš„ç›‘æ§è§£å†³æ–¹æ¡ˆï¼Œæ—¨åœ¨å¸®åŠ©ç”¨æˆ·è½»æ¾å®ç°æœåŠ¡å™¨å’Œåº”ç”¨çš„å®æ—¶ç›‘æ§ã€‚é€šè¿‡ Dashboardã€Agent ä»¥åŠå‰åå°å‰ç«¯èµ„æºçš„é…åˆï¼Œç”¨æˆ·å¯ä»¥å…¨é¢æŒæ¡ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ã€‚

v1.x ç‰ˆæœ¬ç›¸è¾ƒäºè€ç‰ˆæœ¬ç®€åŒ–äº†éƒ¨ç½²æ–¹å¼, æˆ‘ä¸»è¦ç”¨äºç›‘æ§å®¶ä¸­çš„è®¾å¤‡, å¹¶å¼€æ”¾åˆ°äº†å…¬ç½‘, ä¸ºäº†å®‰å…¨èµ·è§åšäº†å“åº”çš„é˜²æŠ¤, æ¥ä¸‹æ¥å°†ç®€å•ä»‹ç»ä¸€ä¸‹è‡ªæ‰˜ç®¡ä¸å®‰å…¨é˜²æ§.

## éƒ¨ç½²

å¯å‚è€ƒ [å®˜æ–¹æ–‡æ¡£](https://nezha.wiki/guide/dashboard.html) éƒ¨ç½², å› ä¸ºæˆ‘éœ€è¦å¯¹å‰ç«¯é¡µé¢åšç›¸åº”çš„ä¿®æ”¹, æ‰€ä»¥è¿™é‡Œé€‰æ‹©ä½¿ç”¨æºç çš„æ–¹å¼éƒ¨ç½².

### èµ„æºä¸‹è½½

- **Dashboard**: [nezha/releases](https://github.com/nezhahq/nezha/releases)
- **Agent**: [agent/releases](https://github.com/nezhahq/agent/releases)
- **åå°å‰ç«¯èµ„æº**: [admin-frontend/releases](https://github.com/nezhahq/admin-frontend/releases)
- **å‰å°å‰ç«¯èµ„æº**: [nezha-dash-v1/releases](https://github.com/hamster1963/nezha-dash-v1/releases)

æœ¬äººä½¿ç”¨ pm2 åœ¨å®¶ä¸­çš„æœåŠ¡å™¨ä¸Šéƒ¨ç½², ä¸ºäº†ç®€åŒ–éƒ¨ç½²å°±å†™äº†ä¸€é”®éƒ¨ç½²è„šæœ¬, æ‰€ä»¥è¿™é‡Œéœ€è¦è®²ä¸€ä¸‹éƒ¨ç½²åŒ…çš„ç›®å½•ç»“æ„:

```
.
â”œâ”€â”€ agent														# ä»£ç†æœåŠ¡ç›®å½•, åŒ…å«ä»£ç†é…ç½®å’ŒäºŒè¿›åˆ¶æ–‡ä»¶
â”‚   â”œâ”€â”€ config.yml
â”‚   â””â”€â”€ nezha-agent
â”œâ”€â”€ dashboard												# dashboard æœåŠ¡ç›®å½•
â”‚   â”œâ”€â”€ admin-dist									# åå°å‰ç«¯é™æ€èµ„æºç›®å½•
â”‚   â”œâ”€â”€ nezha-dash-v1								# å‰å°å‰ç«¯é¡¹ç›®
â”‚   â”œâ”€â”€ user-dist										# å‰ç«¯å‰ç«¯é™æ€èµ„æºç›®å½•(nezha-dash-v1 é¡¹ç›®ç¼–è¯‘åä¼šè‡ªåŠ¨å°†é™æ€èµ„æºæ‹·è´åˆ°æ­¤ç›®å½•)
â”‚   â”œâ”€â”€ dashboard-linux-amd64				# dashboard äºŒè¿›åˆ¶æ–‡ä»¶
â”‚   â”œâ”€â”€ config.yaml									# dashboard é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ sqlite.db										# dashboard æ•°æ®åº“
â”œâ”€â”€ deploy-dashboard.sh							# è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ ecosystem.config.js							# pm2 éƒ¨ç½²é…ç½®
â””â”€â”€ download.sh											# ä»æœåŠ¡å™¨åŒæ­¥æœ€æ–°çš„æ•°æ®åº“æ–‡ä»¶ç­‰å…³é”®æ•°æ®
```

å°†ä¸Šè¿°çš„èµ„æºæ–‡ä»¶ä¸‹è½½åå­˜æ”¾åˆ°å¯¹åº”çš„ç›®å½•, ç„¶åä¸ºäºŒè¿›åˆ¶æ–‡ä»¶èµ‹äºˆæ‰§è¡Œæƒé™:

```bash
chmod +x agent/nezha-agent
chmod +x dashboard/dashboard-linux-amd64
```

å¦‚æœä¸éœ€è¦å¯¹å‰å°å‰ç«¯é¡µé¢åšä»»ä½•æ”¹åŠ¨, ç›´æ¥ä¸‹è½½ releases çš„ dist éƒ¨ç½²å³å¯, å› ä¸ºæˆ‘éœ€è¦ä¿®æ”¹å‰å°é¡µé¢, æ‰€ä»¥è¿™é‡Œä¸‹è½½ nezha-dash-v1 æºç , æœ¬åœ°ä¿®æ”¹å®Œæˆåè‡ªè¡Œç¼–è¯‘éƒ¨ç½².

### nezha-dash-v1 ä¿®æ”¹

ä¸ªäººå¯¹å‰ç«¯é¡µé¢åšäº†å¦‚ä¸‹ä¿®æ”¹:

#### æ·»åŠ  umami ç»Ÿè®¡

åœ¨ index.html ä¸­æ·»åŠ è‡ªå»ºçš„ umami ç»Ÿè®¡æœåŠ¡:

![20250211180300_vA7FAiiR.webp](https://cdn.dong4j.site/source/image/20250211180300_vA7FAiiR.webp)

#### éšè—å…¬ç½‘çš„ç™»å½•å…¥å£

ä¸ºæš´éœ²åˆ°å…¬ç½‘çš„ç›‘æ§é¢æ¿åšäº†ç‚¹å®‰å…¨é˜²æ§, é¿å…è¢«äººçˆ†ç ´, ä¿®æ”¹æ–‡ä»¶: `src/components/Header.tsx`:

```javascript
	...

  const [showDashboardLink, setShowDashboardLink] = useState(false);

  useEffect(() => {
    // æ£€æŸ¥å½“å‰é¡µé¢çš„ä¸»æœºåå’Œç«¯å£å·æ˜¯å¦ä¸ºæœ¬åœ°éƒ¨ç½²çš„ dashboard åœ°å€, æ¯”å¦‚: 192.168.1.2:8888
    if (window.location.host === '192.168.1.2:8888') {
      setShowDashboardLink(true);
    }
  }, []);

  ...
```

ç„¶åå°†æ­¤æ–‡ä»¶ä¸­çš„ `<DashboardLink />` ä¿®æ”¹ä¸º:

```
{showDashboardLink && <DashboardLink />}
```

è¿™æ ·åªæœ‰åœ¨å†…ç½‘è®¿é—®æ—¶æ‰ä¼šæ˜¾ç¤ºç™»å½•æŒ‰é’®.

å½“ç„¶è¿™æ˜¯å‰ç«¯å…¥å£çš„ç®€å•é˜²æ§, å¤–éƒ¨ç”¨æˆ·ä»ç„¶å¯ä»¥ç»•è¿‡, æ¯”å¦‚åœ¨æœ¬åœ°é€šè¿‡ Nginx ä»£ç†åˆ°æˆ‘çš„å…¬ç½‘åŸŸå, è¿™æ · `window.location.host` è·å–åˆ°çš„ä¹Ÿæ˜¯ `192.168.1.2:8888`, æ‰€ä»¥è¿™é‡Œæˆ‘å¹¶æ²¡æœ‰å°†çœŸå®çš„å±€åŸŸç½‘æš´éœ²å‡ºæ¥.

ä¸ºäº†è¿›ä¸€æ­¥åŠ è½½, æ¥ä¸‹æ¥æ˜¯ä»æ¥å£ä¸Šè¿›è¡Œé™åˆ¶.

å› ä¸ºä½¿ç”¨ Nginx å°†å†…ç½‘çš„ç›‘æ§é¢æ¿æš´éœ²åˆ°äº†å…¬ç½‘, æ‰€ä»¥é€šè¿‡å¯¹ Nginx é…ç½®å¯ä»¥é™åˆ¶æ¥å£è®¿é—®:

```
# ç¦æ­¢è®¿é—® /dashboard ä»¥åŠ /dashboard åé¢çš„è·¯å¾„
location ^~ /dashboard {
    deny all;  # æ‹’ç»æ‰€æœ‰è®¿é—®
    return 403;  # è¿”å› 403 Forbidden é”™è¯¯
}
```

è¿™æ ·å¤–ç½‘ä¹Ÿæ— æ³•é€šè¿‡ API è¿›è¡Œçˆ†ç ´.

> å¦å¤–å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯æ£€æŸ¥è¯·æ±‚çš„æ¥æº IP åœ°å€ï¼Œç¡®ä¿åªæœ‰æ¥è‡ªå†…ç½‘ IP åœ°å€çš„è¯·æ±‚æ‰èƒ½è®¿é—®ç™»å½•é¡µé¢ã€‚ä½†å­—æ®µä»ç„¶å¯ä»¥ä¼ªé€ .
>
> å¦‚æœä¸éœ€è¦æš´éœ²åˆ°å¤–ç½‘, æœ€å¥½ä½¿ç”¨ VPN è¿™ç§æ–¹å¼è®¿é—®å®¶ä¸­çš„æœåŠ¡.

---

#### é¡µé¢æ•´ä½“æ”¾å¤§

ç›®å‰çš„å‰ç«¯é¡µé¢çœ‹ç€å¤ªå°äº†, æ‰€ä»¥å°†é¡µé¢æ•´ä½“æ”¾å¤§åˆ°åŸæ¥çš„ 1.25 å€, åœ¨ `index.css` ä¸­æ·»åŠ :

```css
@media (min-width: 1920px) and (min-height: 1080px) {
  html {
    transform: scale(1.25);
    transform-origin: top;
    width: 100vw;
    height: 100vh;
  }
}
```

### ä¸€é”®éƒ¨ç½²

#### å®‰è£…ä¾èµ–

é¦–å…ˆéœ€è¦åœ¨æœåŠ¡å™¨ä¸Šå®‰è£… Node.js å’Œ pm2(å› ä¸ºå“ªå’é¢æ¿ä½¿ç”¨ root è¿è¡Œ, æ‰€ä»¥æˆ‘ä¹Ÿä½¿ç”¨ root ç”¨æˆ·å®‰è£…äº† Node.js å’Œ pm2):

```bash
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash - \
	&& sudo apt install -y nodejs \
	&& sudo npm install -g pm2 \
	&& pm2 -v
```

#### ä¸€é”®æ›´æ–°è„šæœ¬

ä¸ºäº†é¿å…æ•°æ®åº“è¢«æœ¬åœ°è¦†ç›–, æ‰€ä»¥åœ¨éƒ¨ç½²å‰ä½¿ç”¨æ›´æ–°è„šæœ¬æ‹‰å–æœåŠ¡å™¨ä¸Šæœ€æ–°çš„æ•°æ®:

```bash
#!/bin/zsh

# è·å–å½“å‰è„šæœ¬çš„æ‰€åœ¨ç›®å½•
SCRIPT_DIR=$(dirname "$(realpath "$0")")
cd "$SCRIPT_DIR" || exit 1

# é…ç½®é¡¹
REMOTE_SSH_ALIAS="m920x"  # æœåŠ¡å™¨çš„ SSH åˆ«å
REMOTE_DIRECTORY="/opt/nezha"  # è¿œç¨‹ç›®å½•
LOCAL_DIRECTORY="$SCRIPT_DIR"    # æœ¬åœ°ç›®å½•

# æ—¶é—´æˆ³
TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")

# æ‰§è¡Œ rsync åŒæ­¥
echo "[$TIMESTAMP] å¼€å§‹åŒæ­¥..."
rsync -avz --verbose \
  --exclude '.DS_Store' \
  --exclude '._*' \
  --exclude '__MACOSX' \
  --exclude 'logs/' \
  --exclude 'dashboard-linux-amd64' \
  --exclude 'nezha-agent' \
  --exclude 'admin-dist/' \
  --exclude 'user-dist/' \
  "$REMOTE_SSH_ALIAS:$REMOTE_DIRECTORY/" "$LOCAL_DIRECTORY/"

# æ£€æŸ¥åŒæ­¥æ˜¯å¦æˆåŠŸ
if [ "${PIPESTATUS[0]}" -eq 0 ]; then
    echo "[$TIMESTAMP] åŒæ­¥å®Œæˆï¼"
else
    echo "[$TIMESTAMP] åŒæ­¥å¤±è´¥ï¼è¯·æ£€æŸ¥æ—¥å¿—ã€‚"
fi
```

> è¿™é‡Œçš„ `m920x` æ˜¯æˆ‘é…ç½®åˆ° ssh åˆ«å, éœ€è¦è¿›è¡Œå…å¯†ç™»å½•é…ç½®

#### pm2 éƒ¨ç½²é…ç½®

`ecosystem.config.js` é…ç½®å†…å®¹:

```javascript
module.exports = {
  apps: [
    {
      name: "nezha-dashboard", // åº”ç”¨åç§°
      namespace: "nezha", // æŒ‡å®šå‘½åç©ºé—´
      version: "1.0.0", // åº”ç”¨ç‰ˆæœ¬
      cwd: "/opt/nezha/dashboard", // å½“å‰å·¥ä½œç›®å½•
      script: "./dashboard-linux-amd64", // ä¸»è„šæœ¬è·¯å¾„ï¼Œç›¸å¯¹äº cwd
      args: " -c ./config.yaml -db ./sqlite.db", // ä¼ é€’ç»™è„šæœ¬çš„å‚æ•°
      watch: false, // æ˜¯å¦å¯ç”¨æ–‡ä»¶ç›‘æ§
      ignore_watch: [], // å¿½ç•¥ç›‘æ§çš„æ–‡ä»¶æˆ–ç›®å½•
      exec_mode: "fork",
      instances: 1, // åº”ç”¨å®ä¾‹æ•°é‡
      autorestart: true, // æ˜¯å¦è‡ªåŠ¨é‡å¯
      env: {},
      log_date_format: "YYYY-MM-DD HH:mm:ss", // æ—¥å¿—æ—¶é—´æ ¼å¼
      error_file: "./logs/error.log", // é”™è¯¯æ—¥å¿—æ–‡ä»¶
      out_file: "./logs/out.log", // è¾“å‡ºæ—¥å¿—æ–‡ä»¶
      merge_logs: true, // æ˜¯å¦åˆå¹¶æ—¥å¿—
    },
  ],
};
```

> `cwd` éœ€è¦ä¿®æ”¹ä¸ºå®é™…çš„éƒ¨ç½²ç›®å½•, é»˜è®¤æ˜¯ `/opt/nezha`.

#### éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash

# è·å–å½“å‰è„šæœ¬çš„æ‰€åœ¨ç›®å½•
SCRIPT_DIR=$(dirname "$(realpath "$0")")
cd "$SCRIPT_DIR" || exit 1

# é…ç½®é¡¹
REMOTE_SSH_ALIAS="m920x"             # è¿œç¨‹æœåŠ¡å™¨çš„ SSH åˆ«å
LOCAL_PATH="$SCRIPT_DIR"         # æœ¬åœ°æ–‡ä»¶è·¯å¾„
REMOTE_PATH="/opt/nezha"       # è¿œç¨‹æ–‡ä»¶è·¯å¾„ï¼ˆå®Œæ•´è·¯å¾„ï¼ŒåŒ…æ‹¬æ–‡ä»¶åï¼‰

# æç¤ºç”¨æˆ·ç‚¹å‡»å›è½¦ç»§ç»­
echo "Press Enter to continue with the deployment..."
read -r

# éƒ¨ç½²å‰ç«¯
cd "$SCRIPT_DIR/dashboard/nezha-dash-v1" || exit 1
bun install
rm -rf dist
bun run build

cd "$SCRIPT_DIR" || exit 1
# æ‹·è´ dist åˆ° user-dist
rsync -avz --delete \
  --exclude '.DS_Store' \
  --exclude '._*' \
  --exclude '__MACOSX' \
  "$LOCAL_PATH/dashboard/nezha-dash-v1/dist/" "$LOCAL_PATH/dashboard/user-dist/"

# å…ˆåŒæ­¥æ•°æ®åº“æ–‡ä»¶åˆ°æœ¬åœ°, é¿å…è¦†ç›–
# rsync -avz --verbose \
#   "$REMOTE_SSH_ALIAS:$REMOTE_PATH/dashboard/data/sqlite.db" "$LOCAL_PATH/dashboard/data/sqlite.db"

# ä¸Šä¼ æ–‡ä»¶åˆ°è¿œç¨‹æœåŠ¡å™¨
rsync -avz --delete \
  --exclude '.DS_Store' \
  --exclude '._*' \
  --exclude '__MACOSX' \
  --exclude "deploy-dashboard.sh" \
  --exclude "download.sh" \
  --exclude "agent/" \
  --exclude "nezha-dash-v1/" \
  "$LOCAL_PATH/" "$REMOTE_SSH_ALIAS:$REMOTE_PATH/"

# ä¸Šä¼ å®Œæˆ
echo "Upload complete."

ssh "$REMOTE_SSH_ALIAS" "source /root/.nvm/nvm.sh && pm2 stop nezha-dashboard"
ssh "$REMOTE_SSH_ALIAS" "source /root/.nvm/nvm.sh && pm2 delete nezha-dashboard"
ssh "$REMOTE_SSH_ALIAS" "source /root/.nvm/nvm.sh && pm2 start $REMOTE_PATH/ecosystem.config.js"
if [ $? -ne 0 ]; then
  echo "Error: Failed to reload nezha-dashboard on server '$REMOTE_SSH_ALIAS'."
  exit 1
fi

echo "Server configuration successfully updated and reloaded on '$REMOTE_SSH_ALIAS'."
```

1. ç¼–è¯‘ `nezha-dash-v1` å¹¶å°† dist ä¸­çš„é™æ€æ–‡ä»¶æ‹·è´åˆ° `user-dist`;
2. ä¸Šä¼ æŒ‡å®šæ–‡ä»¶åˆ°è¿œç¨‹æœåŠ¡å™¨;
3. ä½¿ç”¨ pm2 å¯åŠ¨æœåŠ¡, (è¿™é‡Œæ˜¯å…ˆåˆ é™¤ç„¶åé‡æ–°å¯åŠ¨, å› ä¸ºæˆ‘è¿™é‡Œä½¿ç”¨ `restart` ä¼šæœ‰ç‚¹é—®é¢˜);

> è®°å¾—ä½¿ç”¨ `source /root/.nvm/nvm.sh`, ç›´æ¥ä½¿ç”¨ pm2 ä¼šæ‰¾ä¸åˆ°æ–‡ä»¶.

å…¶å®æœ€ç»ˆè°ƒç”¨çš„å¯åŠ¨å‘½ä»¤ä¸º:

```bash
/path/to/dashboard -c /path/to/config.config.yaml -db /path/to/sqlite.db
```

- **é¦–æ¬¡è¿è¡Œ**: å»ºè®®ç§»é™¤ `-db` å‚æ•°ï¼Œè®©ç¨‹åºè‡ªåŠ¨ç”Ÿæˆé…ç½®æ–‡ä»¶å’Œæ•°æ®åº“ã€‚
- **é…ç½®æ–‡ä»¶è¯´æ˜**:
  - `listenport`: è®¾å®š Dashboard å’Œ Agent çš„ç›‘å¬ç«¯å£ï¼Œéœ€åšå¥½åå‘ä»£ç†é…ç½®ã€‚
  - `agentsecretkey`: ç”¨äº Agent è¿æ¥ Dashboard çš„å¯†é’¥ã€‚

#### è¿è¡Œ Agent

ä¸Šè¿°è„šæœ¬åªæ˜¯ä¸ºäº†éƒ¨ç½² dashboard, Agent å› ä¸ºä¸€èˆ¬ä¸ä¼šé¢‘ç¹ä¿®æ”¹, æ‰€æœ‰è¿™é‡Œä½¿ç”¨å‘½ä»¤è¡Œçš„æ–¹å¼ç›´æ¥å¯åŠ¨å³å¯:

```bash
/path/to/agent -c /path/to/config.yaml
```

- **é¦–æ¬¡è¿è¡Œ**: ä½¿ç”¨ `./nezha-agent edit` å‘½ä»¤ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼ŒæŒ‰ç…§æç¤ºå®Œæˆè®¾ç½®ã€‚
- **é…ç½®æ–‡ä»¶è¯´æ˜**:
  - `client_secret`: è¾“å…¥ Dashboard é…ç½®ä¸­çš„ `agentsecretkey`ã€‚
  - `server`: æŒ‡å®š Dashboard çš„æœåŠ¡å™¨åœ°å€å’Œç«¯å£ã€‚

> å¦‚æœä½¿ç”¨ `agent.sh` è„šæœ¬å®‰è£…çš„, å¯ä»¥ç›´æ¥ä½¿ç”¨ `systemctl restart nezha-agent` é‡å¯ä»£ç†æœåŠ¡.

---

## å‘½ä»¤è¡Œæ“ä½œ

```bash
$ sudo ./nezha-agent -h
NAME:
   nezha-agent - å“ªå’ç›‘æ§ Agent

USAGE:
   nezha-agent [global options] command [command options]

VERSION:
   1.6.1

COMMANDS:
   edit     ç¼–è¾‘é…ç½®æ–‡ä»¶
   service  æœåŠ¡æ“ä½œ
   help, h  æ˜¾ç¤ºå‘½ä»¤åˆ—è¡¨æˆ–å¸®åŠ©ä¿¡æ¯

GLOBAL OPTIONS:
   --config value, -c value  é…ç½®æ–‡ä»¶è·¯å¾„
   --help, -h                æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
   --version, -v             æ˜¾ç¤ºç‰ˆæœ¬å·
```

macOS é‡å¯ agent:

```bash
$ sudo ./nezha-agent service restart
```

Linux é‡å¯ agent:

```bash
$ sudo systemctl restart nezha-agent
```

**æœåŠ¡æ“ä½œç¤ºä¾‹:**

```bash
$ sudo ./nezha-agent service -h
NAME:
   nezha-agent service - æœåŠ¡ç®¡ç†

USAGE:
   <install/uninstall/start/stop/restart>

OPTIONS:
   --config value, -c value  é…ç½®æ–‡ä»¶è·¯å¾„
   --help, -h                æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
```

## å‚è€ƒèµ„æ–™

- [è®¾ç½® OAuth 2.0 ç»‘å®š](https://nezha.wiki/guide/q14.html)
- [Nezha Dashboard V1 å‰ç«¯æºç ](https://github.com/hamster1963/nezha-dash-v1?tab=readme-ov-file)
- [è‡ªå®šä¹‰ä»£ç ](https://nezhadash-docs.buycoffee.top/custom-code)
- [æœåŠ¡å™¨å…¬å¼€å¤‡æ³¨ç”Ÿæˆå™¨](https://nezhainfojson.pages.dev/)
- [ç¾åŒ– 1](https://blog.zmyos.com/nezha-theme.html)
- [ç¾åŒ– 2](https://misaka.es/archives/33.html)

### å®‰å…¨é…ç½®

- [è‡ªå®šä¹‰ Agent ç›‘æ§é¡¹ç›®](https://nezha.wiki/guide/q7.html)
- [å“ªå’æ¢é’ˆå…³é—­ç½‘é¡µ ssh](https://blog.weedsstars.com/index.php/archives/26/)
- [å“ªå’ v1 å…³é—­ ssh è„šæœ¬](https://www.nodeseek.com/post-232313-1)

> Dashboard å¼€å¯ Debug æ¨¡å¼åå¯ä»¥è®¿é—®è·¯å¾„ /swagger/index.html æŸ¥çœ‹è¯¦æƒ…

## [è‡ªå»ºæœåŠ¡ï¼šä½¿ç”¨ AI ç”Ÿæˆæ–‡ç« æ‘˜è¦å¹¶ä½¿ç”¨ Kokoro TTS ç”Ÿæˆè¯­éŸ³æ’­æŠ¥](https://blog.dong4j.site/posts/66ccb3f1.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ç®€ä»‹

ä¸€ç›´åœ¨ä½¿ç”¨ [TianliGPT](https://docs_s.tianli0.top/) ä½œä¸ºåšå®¢çš„æ‘˜è¦ç”ŸæˆæœåŠ¡, ä¾¿å®œå¥½ç”¨. å¹´å‰çˆ†ç«çš„ DeepSeek-R1 ç®—æ˜¯æŠŠ LLM API çš„ä»·æ ¼æ‰“ä¸‹æ¥äº†, ä¾¿æœ‰äº†æ›¿æ¢ AI æ–‡ç« æ‘˜è¦çš„æƒ³æ³•.

å…¶å®åœ¨ [[npx-card-dev|ä½¿ç”¨ Node.js å¼€å‘æ•°å­—åç‰‡å¹¶é›†æˆ Chat æœåŠ¡]] è¿™ç¯‡æ–‡ç« å·²ç»å°†æœ¬åœ°çš„ LLM API æœåŠ¡æ­å»ºå¥½äº†, å› ä¸º TianliGPT çš„è¯­éŸ³æ’­æŠ¥æœåŠ¡æ— æ³•ä½¿ç”¨, æ‰€ä»¥ä¸€ç›´åœ¨ç­‰ [Kokoro TTS](https://huggingface.co/hexgrad/Kokoro-82M) çš„ä¸­æ–‡æ¨¡å‹, æ­£å¥½ä»Šå¤©å¼€æºäº†, æ‰€ä»¥åˆå¯ä»¥å¼€å§‹æŠ˜è…¾äº†.

## éœ€æ±‚æ•´ç†

- ä½¿ç”¨è‡ªå»º AI API ä»£æ›¿ TianliGPT API æ¥ç”Ÿæˆæ–‡ç« æ‘˜è¦;
- ä½¿ç”¨ Kokoro TTS å°†æ–‡ç« æ‘˜è¦ç”Ÿæˆè¯­éŸ³å¹¶æ’­æ”¾;

éœ€æ±‚å…¶å®æŒºç®€å•, å°±æ˜¯æ›¿æ¢æˆéƒ¨ç½²åˆ° HomeLab çš„ API, So easy ğŸ™‰.

---

## æ¶æ„å›¾

![20250208223047_6SH1UonG.webp](https://cdn.dong4j.site/source/image/20250208223047_6SH1UonG.webp)

## ä¸€ã€ç¯å¢ƒå‡†å¤‡

### 1. æŠ€æœ¯æ ˆæ¦‚è¿°

- åšå®¢æ¡†æ¶ï¼šHexo
- AI æœåŠ¡ï¼šæœ¬åœ°éƒ¨ç½²çš„ LLM ä»¥åŠåœ¨çº¿å…è´¹çš„ LLM æœåŠ¡ API, é€šè¿‡ one-api ä»£ç†ï¼ˆæ›¿ä»£ TianliGPTï¼‰
- è¯­éŸ³åˆæˆï¼šKokoro TTS

### 2. ç¡¬ä»¶ä¸è½¯ä»¶è¦æ±‚

- æœåŠ¡å™¨ç¯å¢ƒ:
  - Mac mini M2(16G å†…å­˜), ç”¨äºéƒ¨ç½² Kokoro TTS;
  - M920x: ç”¨äºéƒ¨ç½²æ‘˜è¦æœåŠ¡å’Œè¯­éŸ³ç”Ÿæˆå®¢æˆ·ç«¯æœåŠ¡;
- å¼€å‘å·¥å…·:
  - Node.js: æ‘˜è¦æœåŠ¡;
  - Python: è¯­éŸ³ç”Ÿæˆå®¢æˆ·ç«¯æœåŠ¡;
  - pm2: æœåŠ¡å™¨éƒ¨ç½²ä½¿ç”¨;

---

## äºŒã€å®ç°ç»†èŠ‚

### 1. Hexo ä»£ç ä¿®æ”¹

é€šè¿‡ç›´æ¥ä¿®æ”¹ TianliGPT ä»£ç å®ç°, å®‰çŸ¥é±¼ä¸»é¢˜ä¸­çš„ `themes/anzhiyu/source/js/anzhiyu/ai_abstract.js` æ˜¯æ–‡ç« æ‘˜è¦æœåŠ¡çš„ä¸»è¦é€»è¾‘, æˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªæ–‡ä»¶æ‹·è´å‡ºæ¥è¿›è¡Œç›¸åº”çš„ä¿®æ”¹:

```javascript
(function () {
  const {
    randomNum,
    basicWordCount,
    btnLink,
    apiUrl,
    audioUrl,
    key: AIKey,
    Referer: AIReferer,
    gptName,
    switchBtn,
    mode: initialMode,
  } = GLOBAL_CONFIG.postHeadAiDescription;

  const { title, postAI, pageFillDescription } = GLOBAL_CONFIG_SITE;

  let lastAiRandomIndex = -1;
  let animationRunning = true;
  let mode = initialMode;
  let refreshNum = 0;
  let prevParam;
  let audio = null;
  let isPaused = false;
  let summaryID = null;

  const post_ai = document.querySelector(".post-ai-description");
  const aiTitleRefreshIcon = post_ai.querySelector(
    ".ai-title .anzhiyufont.anzhiyu-icon-arrow-rotate-right"
  );
  let aiReadAloudIcon = post_ai.querySelector(".anzhiyu-icon-circle-dot");
  const explanation = post_ai.querySelector(".ai-explanation");

  let aiStr = "";
  let aiStrLength = "";
  let delayInit = 600;
  let indexI = 0;
  let indexJ = 0;
  let timeouts = [];
  let elapsed = 0;

  const observer = createIntersectionObserver();
  const aiFunctions = [
    introduce,
    aiTitleRefreshIconClick,
    aiRecommend,
    aiGoHome,
    subscribe,
  ];

  const aiBtnList = post_ai.querySelectorAll(".ai-btn-item");
  const filteredHeadings = Array.from(aiBtnList)
    .filter((heading) => heading.id !== "go-tianli-blog")
    .filter((heading) => heading.id !== "read-audio")
    .filter((heading) => heading.id !== "go-comment");
  filteredHeadings.forEach((item, index) => {
    item.addEventListener("click", () => {
      aiFunctions[index]();
    });
  });

  document.getElementById("ai-tag").addEventListener("click", onAiTagClick);
  aiTitleRefreshIcon.addEventListener("click", onAiTitleRefreshIconClick);
  document.getElementById("go-tianli-blog").addEventListener("click", () => {
    window.open(btnLink, "_blank");
  });
  document.getElementById("go-comment").addEventListener("click", () => {
    anzhiyu.scrollToDest(document.body.scrollHeight, 500);
  });
  document.getElementById("read-audio").addEventListener("click", readAloud);
  aiReadAloudIcon.addEventListener("click", readAloud);

  async function readAloud() {
    if (!summaryID) {
      anzhiyu.snackbarShow("æ‘˜è¦è¿˜æ²¡åŠ è½½å®Œå‘¢ï¼Œè¯·ç¨åã€‚ã€‚ã€‚");
      return;
    }
    aiReadAloudIcon = post_ai.querySelector(".anzhiyu-icon-circle-dot");
    aiReadAloudIcon.style.opacity = "0.2";
    if (audio && !isPaused) {
      audio.pause();
      isPaused = true;
      aiReadAloudIcon.style.opacity = "1";
      aiReadAloudIcon.style.animation = "";
      aiReadAloudIcon.style.cssText =
        "animation: ''; opacity: 1;cursor: pointer;";
      return;
    }

    if (audio && isPaused) {
      audio.play();
      isPaused = false;
      aiReadAloudIcon.style.cssText =
        "animation: breathe .5s linear infinite; opacity: 0.2;cursor: pointer";
      return;
    }

    const options = {
      key: AIKey,
      Referer: AIReferer,
    };
    const requestParams = new URLSearchParams({
      key: options.key,
      id: summaryID,
    });

    const requestOptions = {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        Referer: options.Referer,
      },
    };

    try {
      const response = await fetch(
        `${audioUrl}?${requestParams}`,
        requestOptions
      );
      if (response.status === 403) {
        console.error("403 referä¸keyä¸åŒ¹é…ã€‚");
      } else if (response.status === 500) {
        console.error("500 ç³»ç»Ÿå†…éƒ¨é”™è¯¯");
      } else {
        const audioBlob = await response.blob();
        const audioURL = URL.createObjectURL(audioBlob);
        audio = new Audio(audioURL);
        audio.play();
        aiReadAloudIcon.style.cssText =
          "animation: breathe .5s linear infinite; opacity: 0.2;cursor: pointer";
        audio.addEventListener("ended", () => {
          audio = null;
          aiReadAloudIcon.style.opacity = "1";
          aiReadAloudIcon.style.animation = "";
        });
      }
    } catch (error) {
      console.error("è¯·æ±‚å‘ç”Ÿé”™è¯¯â");
    }
  }
  if (switchBtn) {
    document
      .getElementById("ai-Toggle")
      .addEventListener("click", changeShowMode);
  }

  aiAbstract();
  showAiBtn();

  function createIntersectionObserver() {
    return new IntersectionObserver(
      (entries) => {
        let isVisible = entries[0].isIntersecting;
        animationRunning = isVisible;
        if (animationRunning) {
          delayInit = indexI === 0 ? 200 : 20;
          timeouts[1] = setTimeout(() => {
            if (indexJ) {
              indexI = 0;
              indexJ = 0;
            }
            if (indexI === 0) {
              explanation.innerHTML = aiStr.charAt(0);
            }
            requestAnimationFrame(animate);
          }, delayInit);
        }
      },
      { threshold: 0 }
    );
  }

  function animate(timestamp) {
    if (!animationRunning) {
      return;
    }
    if (!animate.start) animate.start = timestamp;
    elapsed = timestamp - animate.start;
    if (elapsed >= 20) {
      animate.start = timestamp;
      if (indexI < aiStrLength - 1) {
        let char = aiStr.charAt(indexI + 1);
        let delay = /[,.ï¼Œã€‚!?ï¼ï¼Ÿ]/.test(char) ? 150 : 20;
        if (explanation.firstElementChild) {
          explanation.removeChild(explanation.firstElementChild);
        }
        explanation.innerHTML += char;
        let div = document.createElement("div");
        div.className = "ai-cursor";
        explanation.appendChild(div);
        indexI++;
        if (delay === 150) {
          post_ai.querySelector(".ai-explanation .ai-cursor").style.opacity =
            "0.2";
        }
        if (indexI === aiStrLength - 1) {
          observer.disconnect();
          explanation.removeChild(explanation.firstElementChild);
        }
        timeouts[0] = setTimeout(() => {
          requestAnimationFrame(animate);
        }, delay);
      }
    } else {
      requestAnimationFrame(animate);
    }
  }

  function clearTimeouts() {
    if (timeouts.length) {
      timeouts.forEach((item) => {
        if (item) {
          clearTimeout(item);
        }
      });
    }
  }

  function startAI(str, df = true) {
    indexI = 0;
    indexJ = 1;
    clearTimeouts();
    animationRunning = false;
    elapsed = 0;
    observer.disconnect();
    explanation.innerHTML = df ? "ç”Ÿæˆä¸­. . ." : "è¯·ç­‰å¾…. . .";
    aiStr = str;
    aiStrLength = aiStr.length;
    observer.observe(post_ai);
  }

  async function aiAbstract(num = basicWordCount) {
    if (mode === "online") {
      await aiAbstractTianli(num);
    } else {
      aiAbstractLocal();
    }
  }

  async function aiAbstractTianli(num) {
    indexI = 0;
    indexJ = 1;
    clearTimeouts();
    animationRunning = false;
    elapsed = 0;
    observer.disconnect();

    num = Math.max(10, Math.min(2000, num));
    const options = {
      key: AIKey,
      Referer: AIReferer,
    };
    const truncateDescription = (title + pageFillDescription)
      .trim()
      .substring(0, num);

    const url = new URL(location.href);
    const pathSegments = url.pathname.split("/").filter(Boolean); // è¿‡æ»¤æ‰ç©ºå­—ç¬¦ä¸²
    const id = pathSegments[pathSegments.length - 1]; // è·å–æœ€åä¸€ä¸ªéƒ¨åˆ†

    const requestBody = {
      key: options.key,
      content: truncateDescription,
      url: id,
    };

    const requestOptions = {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Referer: options.Referer,
      },
      body: JSON.stringify(requestBody),
    };
    try {
      let animationInterval = null;
      let summary;
      if (animationInterval) clearInterval(animationInterval);
      animationInterval = setInterval(() => {
        const animationText = "ç”Ÿæˆä¸­" + ".".repeat(indexJ);
        explanation.innerHTML = animationText;
        indexJ = (indexJ % 3) + 1;
      }, 500);
      const response = await fetch(apiUrl, requestOptions);
      let result;
      if (response.status === 403) {
        result = {
          summary: "403 referä¸keyä¸åŒ¹é…ã€‚",
        };
      } else if (response.status === 500) {
        result = {
          summary: "500 ç³»ç»Ÿå†…éƒ¨é”™è¯¯",
        };
      } else {
        result = await response.json();
      }

      summary = result.summary.trim();
      summaryID = result.id;

      setTimeout(() => {
        aiTitleRefreshIcon.style.opacity = "1";
      }, 300);
      if (summary) {
        startAI(summary);
      } else {
        startAI("æ‘˜è¦è·å–å¤±è´¥!!!è¯·æ£€æŸ¥ AI æ‘˜è¦æœåŠ¡æ˜¯å¦æ­£å¸¸!!!");
      }
      clearInterval(animationInterval);
    } catch (error) {
      console.error(error);
      explanation.innerHTML = "å‘ç”Ÿå¼‚å¸¸" + error;
    }
  }

  function aiAbstractLocal() {
    const strArr = postAI.split(",").map((item) => item.trim());
    if (strArr.length !== 1) {
      let randomIndex = Math.floor(Math.random() * strArr.length);
      while (randomIndex === lastAiRandomIndex) {
        randomIndex = Math.floor(Math.random() * strArr.length);
      }
      lastAiRandomIndex = randomIndex;
      startAI(strArr[randomIndex]);
    } else {
      startAI(strArr[0]);
    }
    setTimeout(() => {
      aiTitleRefreshIcon.style.opacity = "1";
    }, 600);
  }

  function aiRecommend() {
    indexI = 0;
    indexJ = 1;
    clearTimeouts();
    animationRunning = false;
    elapsed = 0;
    explanation.innerHTML = "ç”Ÿæˆä¸­. . .";
    aiStr = "";
    aiStrLength = "";
    observer.disconnect();
    timeouts[2] = setTimeout(() => {
      explanation.innerHTML = recommendList();
    }, 600);
  }

  function recommendList() {
    let thumbnail = document.querySelectorAll(".relatedPosts-list a");
    if (!thumbnail.length) {
      const cardRecentPost = document.querySelector(
        ".card-widget.card-recent-post"
      );
      if (!cardRecentPost) return "";

      thumbnail = cardRecentPost.querySelectorAll(".aside-list-item a");

      let list = "";
      for (let i = 0; i < thumbnail.length; i++) {
        const item = thumbnail[i];
        list += `<div class="ai-recommend-item"><span class="index">${
          i + 1
        }ï¼š</span><a href="javascript:;" onclick="pjax.loadUrl('${
          item.href
        }')" title="${item.title}" data-pjax-state="">${item.title}</a></div>`;
      }

      return `å¾ˆæŠ±æ­‰ï¼Œæ— æ³•æ‰¾åˆ°ç±»ä¼¼çš„æ–‡ç« ï¼Œä½ ä¹Ÿå¯ä»¥çœ‹çœ‹æœ¬ç«™æœ€æ–°å‘å¸ƒçš„æ–‡ç« ï¼š<br /><div class="ai-recommend">${list}</div>`;
    }

    let list = "";
    for (let i = 0; i < thumbnail.length; i++) {
      const item = thumbnail[i];
      list += `<div class="ai-recommend-item"><span>æ¨è${
        i + 1
      }ï¼š</span><a href="javascript:;" onclick="pjax.loadUrl('${
        item.href
      }')" title="${item.title}" data-pjax-state="">${item.title}</a></div>`;
    }

    return `æ¨èæ–‡ç« ï¼š<br /><div class="ai-recommend">${list}</div>`;
  }

  function aiGoHome() {
    startAI("æ­£åœ¨å‰å¾€åšå®¢ä¸»é¡µ...", false);
    timeouts[2] = setTimeout(() => {
      if (window.pjax) {
        pjax.loadUrl("/");
      } else {
        location.href = location.origin;
      }
    }, 1000);
  }

  function subscribe() {
    startAI("æ­£åœ¨å‰å¾€è®¢é˜…é¡µé¢...", false);
    timeouts[2] = setTimeout(() => {
      if (window.pjax) {
        pjax.loadUrl("/subscribe/");
      } else {
        location.href = location.origin;
      }
    }, 1000);
  }

  function introduce() {
    if (mode == "online") {
      startAI(
        "æˆ‘æ˜¯æ–‡ç« è¾…åŠ©AI: SummaryGPTï¼Œç‚¹å‡»ä¸‹æ–¹çš„æŒ‰é’®ï¼Œè®©æˆ‘ç”Ÿæˆæœ¬æ–‡ç®€ä»‹ã€æ¨èç›¸å…³æ–‡ç« ç­‰ã€‚"
      );
    } else {
      startAI(
        `æˆ‘æ˜¯æ–‡ç« è¾…åŠ©AI: ${gptName}GPTï¼Œç‚¹å‡»ä¸‹æ–¹çš„æŒ‰é’®ï¼Œè®©æˆ‘ç”Ÿæˆæœ¬æ–‡ç®€ä»‹ã€æ¨èç›¸å…³æ–‡ç« ç­‰ã€‚`
      );
    }
  }

  function aiTitleRefreshIconClick() {
    aiTitleRefreshIcon.click();
  }

  function onAiTagClick() {
    if (mode === "online") {
      post_ai
        .querySelectorAll(".ai-btn-item")
        .forEach((item) => (item.style.display = "none"));
      document.getElementById("go-tianli-blog").style.display = "block";
      startAI(
        "ä½ å¥½ ğŸ‰ï¼æˆ‘æ˜¯ dong4j åšå®¢çš„ AI æ–‡ç« æ‘˜è¦ç”ŸæˆåŠ©ç† SummaryGPTï¼Œä¸€æ¬¾åŸºäºæœ¬åœ°éƒ¨ç½²çš„å¤§å‹è¯­è¨€æ¨¡å‹æä¾›çš„ç”Ÿæˆå¼ AI æœåŠ¡ã€‚æˆ‘çš„ä¸»è¦èŒè´£æ˜¯é¢„ç”Ÿæˆå’Œå±•ç¤ºæ–‡ç« æ‘˜è¦ã€‚è¯·æ³¨æ„ï¼Œä½ æ— æ³•ç›´æ¥ä¸æˆ‘äº¤æµã€‚å¦‚æœä½ ä¹Ÿæƒ³æ‹¥æœ‰ä¸€ä¸ªè¿™æ ·çš„æ–‡ç« æ‘˜è¦åŠ©æ‰‹ï¼Œè¯·æŸ¥é˜…ä¸‹æ–¹çš„è¯¦ç»†éƒ¨ç½²æŒ‡å—ã€‚"
      );
    } else {
      post_ai
        .querySelectorAll(".ai-btn-item")
        .forEach((item) => (item.style.display = "block"));
      document.getElementById("go-tianli-blog").style.display = "none";
      startAI(
        `ä½ å¥½ ğŸ‰ï¼Œæˆ‘æ˜¯æœ¬ç«™æ–‡ç« æ‘˜è¦ç”ŸæˆåŠ©ç† ${gptName}GPTï¼Œä½¿ç”¨äº†é¢„å…ˆç”Ÿæˆçš„æ–‡ç« æ‘˜è¦ã€‚æˆ‘åœ¨è¿™é‡Œåªè´Ÿè´£æ‘˜è¦çš„æ˜¾ç¤ºï¼Œä½ æ— æ³•ä¸æˆ‘ç›´æ¥æ²Ÿé€šã€‚`
      );
    }
  }

  function onAiTitleRefreshIconClick() {
    const truncateDescription = (title + pageFillDescription)
      .trim()
      .substring(0, basicWordCount);

    aiTitleRefreshIcon.style.opacity = "0.2";
    aiTitleRefreshIcon.style.transitionDuration = "0.3s";
    aiTitleRefreshIcon.style.transform = "rotate(" + 360 * refreshNum + "deg)";
    if (truncateDescription.length <= basicWordCount) {
      let param =
        truncateDescription.length - Math.floor(Math.random() * randomNum);
      while (
        param === prevParam ||
        truncateDescription.length - param === prevParam
      ) {
        param =
          truncateDescription.length - Math.floor(Math.random() * randomNum);
      }
      prevParam = param;
      aiAbstract(param);
    } else {
      let value = Math.floor(Math.random() * randomNum) + basicWordCount;
      while (
        value === prevParam ||
        truncateDescription.length - value === prevParam
      ) {
        value = Math.floor(Math.random() * randomNum) + basicWordCount;
      }
      aiAbstract(value);
    }
    refreshNum++;
  }

  function changeShowMode() {
    mode = mode === "online" ? "local" : "online";
    if (mode === "online") {
      document.getElementById("ai-tag").innerHTML = "SummaryGPT";

      aiReadAloudIcon.style.opacity = "1";
      aiReadAloudIcon.style.cursor = "pointer";
    } else {
      aiReadAloudIcon.style.opacity = "0";
      aiReadAloudIcon.style.cursor = "auto";
      if ((document.getElementById("go-tianli-blog").style.display = "block")) {
        document
          .querySelectorAll(".ai-btn-item")
          .forEach((item) => (item.style.display = "block"));
        document.getElementById("go-tianli-blog").style.display = "none";
      }
      document.getElementById("ai-tag").innerHTML = gptName + " GPT";
    }
    aiAbstract();
  }

  function showAiBtn() {
    if (mode === "online") {
      document.getElementById("ai-tag").innerHTML = "SummaryGPT";
    } else {
      document.getElementById("ai-tag").innerHTML = gptName + " GPT";
    }
  }
})();
```

å½“ç„¶è¿˜éœ€è¦ä¿®æ”¹å¯¹åº”çš„ pug æ¨¡ç‰ˆæ–‡ä»¶(`themes/anzhiyu/layout/includes/anzhiyu/ai-info.pug`):

```javascript
- let pageFillDescription = get_page_fill_description()
- let gptName = theme.post_head_ai_description.gptName
- let mode = theme.post_head_ai_description.mode
- let switchBtn = theme.post_head_ai_description.switchBtn
if (pageFillDescription && page.ai)
  .post-ai-description
    .ai-title
      i.fa-regular.fa-robot.fa-fade
      .ai-title-text æ‘˜è¦åŠ©æ‰‹
      if (switchBtn)
        #ai-Toggle åˆ‡æ¢
      i.anzhiyufont.anzhiyu-icon-arrow-rotate-right
      i.anzhiyufont.anzhiyu-icon-circle-dot(title="æœ—è¯»æ‘˜è¦")
      #ai-tag
        if mode == "online"
          = "SummaryGPT"
        else
          = gptName + "GPT"
    .ai-explanation AI åˆå§‹åŒ–ä¸­...
    .ai-btn-box
      .ai-btn-item ä»‹ç»è‡ªå·± ğŸ™ˆ
      .ai-btn-item ç”Ÿæˆæ‘˜è¦ ğŸ‘‹
      .ai-btn-item æ¨èæ–‡ç«  ğŸ“–
      .ai-btn-item å‰å¾€ä¸»é¡µ ğŸ 
      .ai-btn-item å‰å¾€è®¢é˜… ğŸ’¥
      .ai-btn-item#go-comment å‰å¾€è¯„è®º ğŸ’¬
      .ai-btn-item#read-audio Kokoro TTS ğŸ™ï¸
      .ai-btn-item#go-tianli-blog ğŸ‘€ éƒ¨ç½²æ•™ç¨‹
    script(data-pjax src=url_for(theme.asset.ai_abstract_js))
```

æœ€åå°±æ˜¯é…ç½®:

```yaml
post_head_ai_description:
  enable: true
  gptName: Local
  mode: online # é»˜è®¤æ¨¡å¼ å¯é€‰å€¼: online/local
  switchBtn: true # å¯ä»¥é…ç½®æ˜¯å¦æ˜¾ç¤ºåˆ‡æ¢æŒ‰é’® ä»¥åˆ‡æ¢ online/local
  btnLink: https://github.com/dong4j/blog-summary-assistant-server
  randomNum: 3 # æŒ‰é’®æœ€å¤§çš„éšæœºæ¬¡æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸€ç¯‡æ–‡ç« æœ€å¤§éšæœºå‡ºæ¥å‡ ç§
  basicWordCount: 1999 # æœ€ä½è·å–å­—ç¬¦æ•°, æœ€å°1000, æœ€å¤§1999
  apiUrl: # æ–‡ç« æ‘˜è¦ç”ŸæˆæœåŠ¡ api
  audioUrl: # è¯­éŸ³ç”ŸæˆæœåŠ¡ api
  key: # æ ¹æ®è‡ªå·±éœ€è¦çœ‹æ˜¯å¦è¦éªŒè¯ key
  Referer: # æ ¹æ®è‡ªå·±éœ€è¦çœ‹æ˜¯å¦è¦éªŒè¯ Referer, æˆ‘è¿™é‡Œæ²¡æœ‰éªŒè¯
```

> Hexo ä¿®æ”¹æ²¡æœ‰å¤šå¤§éš¾åº¦, ä¸»è¦æ˜¯ç›´æ¥åˆ©ç”¨ anzhiyu ä¸»é¢˜é›†æˆçš„ TianliGPT æ¥å®ŒæˆæœåŠ¡è°ƒç”¨ä¸æ•°æ®å±•ç¤º, æ‰€ä»¥è¿™éƒ¨åˆ†å°±è§ä»è§æ™ºäº†, ä¸ªäººå¯éšæ„ä¿®æ”¹.

---

### 2. æ‘˜è¦æœåŠ¡éƒ¨ç½²ä¸é›†æˆ

LLM API ç›´æ¥ä½¿ç”¨ [[npx-card-dev|ä½¿ç”¨ Node.js å¼€å‘æ•°å­—åç‰‡å¹¶é›†æˆ Chat æœåŠ¡]] è¿™ç¯‡æ–‡ç« ä¸­å·²éƒ¨ç½²å¥½çš„ one-api, å¥½å¤„æ˜¯ä¸éœ€è¦å°†å‚å•† Key æ”¾åœ¨å‰ç«¯ä»£ç ä¸­, å¯ä»¥é¿å…ä¸€ç‚¹çš„å®‰å…¨é—®é¢˜, å¦å¤–åœ¨ one-api æˆ‘å¯ä»¥éšæ—¶æ·»åŠ  LLM å‚å•†æœåŠ¡, ä¸”å¯æ§åˆ¶æŒ‡å®š Key çš„ Token æ€»é‡ä¸æœ‰æ•ˆæœŸ, æ‰€ä»¥å¹¶ä¸æ˜¯å¤ªæ‹…å¿ƒè‡ªå·±çš„ Token è¢«æ¶æ„ä½¿ç”¨, å³ä½¿ç¬¬ä¸‰æ–¹çš„ Token è¢«æ¶æ„æ¶ˆè€—å®Œ, æˆ‘è¿˜å¯ä»¥ä½¿ç”¨æœ¬åœ°éƒ¨ç½² LLM æœåŠ¡, å¾—ç›Šäº one-api çš„ä»£ç†åŠŸèƒ½, ç®€å•çš„ä¿®æ”¹ one-api é…ç½®å³å¯ä½¿ç”¨, ä¸éœ€è¦é‡æ–°éƒ¨ç½²åšå®¢.

#### 2.1 åŠŸèƒ½

- æä¾›ä¸€ä¸ª `/api/summary` æ¥å£ç»™ Hexo åšå®¢è°ƒç”¨, å¹¶å°†ä¼ å…¥çš„åšå®¢å†…å®¹é€šè¿‡ one-api api ä¼ ç»™ LLM, å¹¶å¤„ç†è¿”å›çš„ç»“æœ;
- ç”Ÿæˆçš„æ–‡ç« æ‘˜è¦ä¼šè¢«ç¼“å­˜åˆ° Redis ä¸­, é¿å…é‡å¤ç”Ÿæˆ;
- é€šè¿‡ pm2 å¯åŠ¨æœåŠ¡;
- æä¾›è‡ªåŠ¨éƒ¨ç½²è„šæœ¬ä¸€é”®éƒ¨ç½²;

#### 2.2 ä½¿ç”¨æ–¹æ³•

```bash
git clone git@github.com:dong4j/blog-summary-assistant-server.git
cd summary-server
cp .env.template .env
```

ä¿®æ”¹ .env é…ç½®:

```bash
SERVER_PORT=3000
# ç¼“å­˜é…ç½®
REDIS_HOST=192.168.1.2
REDIS_PORT=6379
REDIS_PASSWORD=password
REDIS_DB=0
# æ‘˜è¦è¿‡æœŸæ—¶é—´
KEY_EXPIRATION=31536000

# LLM æœåŠ¡
OPENAI_API_KEY=sk-*****
# é…ç½®ä¸ºå‚å•†çš„ OpenAI API åœ°å€
OPENAI_API_BASE=https://api.openai.com/v1
# æ¨¡å‹åç§°
OPENAI_MODEL=xxx
```

#### 2.3 å¯åŠ¨æœåŠ¡

```bash
npm install
npm run server
```

æµ‹è¯•:

```bash
curl --request POST \
  --url http://192.168.1.3:3000/api/summary \
  --header 'Accept: */*' \
  --header 'Accept-Encoding: gzip, deflate, br' \
  --header 'Connection: keep-alive' \
  --header 'Content-Type: application/json' \
  --header 'User-Agent: PostmanRuntime-ApipostRuntime/1.1.0' \
  --data '{
    "key": "xxxx",
    "content": "HomeLab å…ˆå¯¼ç¯‡ï¼šå…¥é—¨æŒ‡å—-å¼€å¯ä½ çš„ä¸ªäººäº‘ç«¯å®éªŒå®¤ä¹‹æ—…å‰æè¯´æ˜, ä»€ä¹ˆæ˜¯ HomeLab, ä¸ºä»€ä¹ˆé€‰æ‹©è‡ªå»º HomeLab, HomeLab çš„åŸåˆ™, ç¡¬ä»¶æˆæœ¬, è½¯ä»¶æˆæœ¬, HomeLab çš„ç¡¬ä»¶, ç½‘ç»œæ¶æ„, è‡ªæ‰˜ç®¡æœåŠ¡, æ•°æ®å­˜å‚¨ä¸å¤‡ä»½, æ€»ç»“ä¸­å¹´ç”·äººçš„ä¸‰å¤§çˆ±å¥½å……ç”µå¤´è½¯è·¯ç”±è¿™ä¸‰å¤§çˆ±å¥½ä¸ä»…ä¸ºæˆ‘ä»¬çš„ç”Ÿæ´»å¸¦æ¥äº†ä¾¿åˆ©ä¹Ÿæˆä¸ºäº†æˆ‘ä»¬ç”Ÿæ´»çš„ä¸€éƒ¨åˆ†ä½œä¸ºä¸€ä¸ªè½¯ä»¶å¼€å‘è€…æˆ‘ä¸€ç›´æ¢¦æƒ³ç€æ‹¥æœ‰è‡ªå·±çš„æœåŠ¡å™¨è€Œå’Œè½¯è·¯ç”±åˆ™æ˜¯æˆ‘é€šå¾€è¿™ä¸ªæ¢¦æƒ³çš„æ¡¥æ¢è‡ªä»è´­ä¹°äº†æˆ‘çš„ç¬¬ä¸€å°ä»¥æ¥ä¾¿æ‰“å¼€äº†ä¸€æ‰‡æ–°ä¸–ç•Œçš„å¤§é—¨å³ç½‘ç»œé™„åŠ å­˜å‚¨å®ƒä¸ä»…æä¾›äº†ä¸€ä¸ªå®‰å…¨çš„æ•°æ®å­˜å‚¨è§£å†³æ–¹æ¡ˆè¿˜è®©æˆ‘èƒ½å¤Ÿå®ç°æ•°æ®çš„å¤‡ä»½å’Œå…±äº«éšç€æ—¶é—´çš„æ¨ç§»æˆ‘é™†ç»­è´­ä¹°äº†å…¶ä»–ç¡¬ä»¶äº§å“å¦‚è½¯è·¯ç”±å™¨æœåŠ¡å™¨ç­‰é€æ­¥æ­å»ºèµ·äº†å±äºæˆ‘çš„ä»Šå¤©æˆ‘æƒ³å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹æˆ‘æ­å»ºçš„è¿‡ç¨‹å¸Œæœ›èƒ½å¤Ÿå¸®åŠ©åˆ°é‚£äº›åŒæ ·æœ‰å¿—äºæ­å»ºçš„æœ‹å‹åœ¨æ¥ä¸‹æ¥çš„åšå®¢æ–‡ç« ä¸­æˆ‘å°†è¯¦ç»†ä»‹ç»å¦‚ä½•é€‰è´­åˆé€‚çš„è®¾å¤‡è½¯è·¯ç”±å™¨ä»¥åŠæœåŠ¡å™¨å¹¶åˆ†äº«æˆ‘åœ¨æ­å»ºè¿‡ç¨‹ä¸­é‡åˆ°çš„æŒ‘æˆ˜å’Œè§£å†³æ–¹æ¡ˆå¹¶éé¥ä¸å¯åŠåªè¦æˆ‘ä»¬ç”¨å¿ƒå»æ¢ç´¢å’Œå®è·µå°±èƒ½å¼€å¯å±äºè‡ªå·±çš„ä¸ªäººäº‘ç«¯å®éªŒå®¤ä¹‹æ—…è®©æˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº¤æµå’Œæˆé•¿å…±åŒæ‰“é€ ä¸€ä¸ªå±äºæˆ‘ä»¬çš„æ•°å­—ç‹å›½å‰æè¯´æ˜è™½ç„¶å…³äºçš„æ–‡ç« å·²ç»å¾ˆå¤šäº†ä½†æˆ‘è¿˜æ˜¯æƒ³è®°å½•ä¸‹è‡ªå·±æ­å»ºçš„ç»å†å’Œé‡åˆ°çš„é—®é¢˜ä»¥åŠå¦‚ä½•è§£å†³è¿™äº›é—®é¢˜ä¸»è¦ä¼šæ¶‰åŠåˆ°ä»¥ä¸‹å‡ ä¸ªæ–¹é¢å…ˆå¯¼ç¯‡æˆ‘çš„æ¦‚è¦ç¡¬ä»¶ç¯‡ä»‹ç»æˆ‘æ‰€æ‹¥æœ‰çš„ç¡¬ä»¶è®¾å¤‡ç½‘ç»œç¯‡åŒ…æ‹¬ç½‘ç»œç¯å¢ƒå¼‚åœ°ç»„ç½‘ä¸ç½‘ç»œå®‰å…¨æœåŠ¡ç¯‡ä½¿ç”¨æ­å»ºçš„å„ç±»æœåŠ¡æ•°æ®ç¯‡åŒ…æ‹¬æ•°æ®å­˜å‚¨æ–¹æ¡ˆå¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆæ•°æ®åŒæ­¥æ„å»ºé«˜æ•ˆçš„æ•°æ®åŒæ­¥ç½‘ç»œæ•°æ®å¤‡ä»½æ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿ç½‘ç»œç»­é›†å‡çº§ç½‘ç»œå†æˆ˜å¹´å†…ç½‘ç©¿é€è¯¦è§£æ­ç§˜ç½‘ç»œè¿æ¥èƒŒåçš„å¥¥ç§˜ä»€ä¹ˆæ˜¯é¡¾åæ€ä¹‰å°±æ˜¯å®¶åº­å®éªŒå®¤å®ƒå¯ä»¥ç†è§£ä¸ºå®¶åº­ç‰ˆçš„äº‘æœåŠ¡å™¨ç”¨æ¥æ­å»ºå„ç§æœåŠ¡æ¯”å¦‚ä¸ªäººç½‘ç›˜åª’ä½“æœåŠ¡å™¨ç­‰ç­‰çš„ç¡¬ä»¶è®¾å¤‡é€šå¸¸åŒ…æ‹¬æœåŠ¡å™¨å¯ä»¥æ˜¯ç‰©ç†æœåŠ¡å™¨æˆ–è™šæ‹Ÿæœºç”¨äºæ­å»ºå„ç±»æœåŠ¡å­˜å‚¨è®¾å¤‡å¦‚å’Œç¡¬ç›˜ç”¨äºå­˜å‚¨æ•°æ®ç½‘ç»œè®¾å¤‡å¦‚è½¯è·¯ç”±å’Œç¡¬è·¯ç”±ç”¨äºç®¡ç†ç½‘ç»œå…¶ä»–è®¾å¤‡å¦‚æ‘„åƒå¤´ä¼ æ„Ÿå™¨ç­‰ç”¨äºæ”¶é›†æ•°æ®ä¸ºä»€ä¹ˆé€‰æ‹©è‡ªå»ºå¯¹äºæˆ‘æ¥è¯´æ­å»ºæ˜¯ä¸€ç§æµªæ¼«çš„æŠ˜è…¾æˆ‘çš„ç›®æ ‡æ˜¯æ­å»ºå„ç§æ„Ÿå…´è¶£çš„æœåŠ¡çš„å®éªŒå®¤ä½œä¸ºä¸€ä¸ªå–œæ¬¢å°è¯•æ–°æŠ€æœ¯çš„äººæ¥è¯´æ­å»ºå„ç±»æœåŠ¡éå¸¸æœ‰è¶£æˆ‘å¯ä»¥å¿«é€Ÿå°è¯•å’ŒéªŒè¯æ–°çš„æŠ€æœ¯å’Œæ–¹æ¡ˆæ‹¥æœ‰ä¸€å¥—è‡ªå·±çš„å®éªŒå®¤å¯ä»¥è®©æˆ‘æ›´åŠ è‡ªç”±åœ°æ¢ç´¢ä¿è¯æ•°æ®å®‰å…¨æˆ‘å¯¹æ•°æ®å®‰å…¨éå¸¸é‡è§†æ‰€ä»¥æˆ‘ä¼šæŠŠæ‰€æœ‰çš„æ•°æ®éƒ½å­˜å‚¨åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šè€Œä¸æ˜¯ä½¿ç”¨äº‘å­˜å‚¨æœåŠ¡è¿™æ ·å¯ä»¥ä¿è¯æˆ‘çš„æ•°æ®ä¸ä¼šè¢«ç¬¬ä¸‰æ–¹æ§åˆ¶æˆ‘å·²ç»å—å¤Ÿäº†ä¸ƒç‰›äº‘çš„åŸŸåå˜æ›´å¯¼è‡´æˆ‘å¤§é‡å›¾ç‰‡æ— æ³•è®¿é—®æ›´å¥½çš„éšç§ä¿æŠ¤å®¶äººçš„ç…§ç‰‡å„¿å­çš„æˆ",
    "url": "abbrlink.html"
}'
```

å“åº”ç»“æœ:

```json
{
  "summary": "ğŸ¤– è¿™ç¯‡æ–‡ç« ä»‹ç»äº†: HomeLabçš„æ¦‚å¿µã€è‡ªå»ºHomeLabçš„åŸå› ã€åŸåˆ™ã€ç¡¬ä»¶å’Œè½¯ä»¶æˆæœ¬ã€ç¡¬ä»¶è®¾å¤‡ã€ç½‘ç»œæ¶æ„ã€è‡ªæ‰˜ç®¡æœåŠ¡ã€æ•°æ®å­˜å‚¨ä¸å¤‡ä»½ç­‰ã€‚ä½œè€…åˆ†äº«äº†è‡ªå·±æ­å»ºHomeLabçš„è¿‡ç¨‹ï¼ŒåŒ…æ‹¬é€‰è´­è®¾å¤‡ã€æ­å»ºè¿‡ç¨‹ä¸­é‡åˆ°çš„æŒ‘æˆ˜å’Œè§£å†³æ–¹æ¡ˆï¼Œæ—¨åœ¨å¸®åŠ©æœ‰å¿—äºæ­å»ºHomeLabçš„æœ‹å‹ã€‚æ–‡ç« è¿˜æ¶‰åŠäº†ç½‘ç»œç¯å¢ƒã€å¼‚åœ°ç»„ç½‘ã€ç½‘ç»œå®‰å…¨ã€æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆç­‰å†…å®¹ï¼Œå¼ºè°ƒäº†æ•°æ®å®‰å…¨å’Œéšç§ä¿æŠ¤çš„é‡è¦æ€§ã€‚",
  "id": "abbrlink",
  "fromCache": false
}
```

ç¬¬ä¸€æ¬¡ä¼šè°ƒç”¨ one-api api ç”Ÿæˆæ‘˜è¦ï¼Œç¬¬äºŒæ¬¡ä¼šä»ç¼“å­˜ä¸­è·å–æ‘˜è¦ã€‚

#### 2.4 éƒ¨ç½²

ä¿®æ”¹ `ecosystem.config.js` ç›¸å…³é…ç½®:

```javascript
module.exports = {
  apps: [
    {
      name: "summary-server", // åº”ç”¨åç§°
      namespace: "blog", // æŒ‡å®šå‘½åç©ºé—´(å¯é€‰)
      version: "1.0.0", // åº”ç”¨ç‰ˆæœ¬(å¯é€‰)
      cwd: "/path/to/deploy", // éƒ¨ç½²åˆ°æœåŠ¡å™¨çš„å·¥ä½œç›®å½•
      script: "./summaryServer.js", // ä¸»è„šæœ¬è·¯å¾„ï¼Œç›¸å¯¹äº cwd
      watch: true, // æ˜¯å¦å¯ç”¨æ–‡ä»¶ç›‘æ§
      ignore_watch: ["node_modules", "logs"], // å¿½ç•¥ç›‘æ§çš„æ–‡ä»¶æˆ–ç›®å½•
      exec_mode: "fork",
      instances: 1, // åº”ç”¨å®ä¾‹æ•°é‡
      autorestart: true, // æ˜¯å¦è‡ªåŠ¨é‡å¯
      env: {
        VERSION: "1.0.0", // è®¾ç½®ç‰ˆæœ¬å·ç¯å¢ƒå˜é‡
      },
      log_date_format: "YYYY-MM-DD HH:mm:ss", // æ—¥å¿—æ—¶é—´æ ¼å¼
      error_file: "./logs/error.log", // é”™è¯¯æ—¥å¿—æ–‡ä»¶
      out_file: "./logs/out.log", // è¾“å‡ºæ—¥å¿—æ–‡ä»¶
      merge_logs: true, // æ˜¯å¦åˆå¹¶æ—¥å¿—
    },
  ],
};
```

ä¿®æ”¹ `deploy.sh` è„šæœ¬ä¸­çš„ `DEFAULT_SSH_ALIAS` å’Œ `DEFAULT_REMOTE_DIR`:

- DEFAULT_SSH_ALIAS: .ssh ä¸­çš„ config é…ç½®åˆ«å, è¿™é‡Œåšäº†å…å¯†ç™»å½•å¤„ç†;
- DEFAULT_REMOTE_DIR: éƒ¨ç½²åˆ°æœåŠ¡å™¨çš„å·¥ä½œç›®å½•;

æœ€åæ‰§è¡Œéƒ¨ç½²è„šæœ¬:

```bash
./deploy.sh
```

ç¬¬ä¸€æ¬¡éƒ¨ç½²éœ€è¦åœ¨æœåŠ¡å™¨çš„éƒ¨ç½²ç›®å½•å®‰è£…ä¾èµ–:

```bash
npm install
```

#### 2.5 å¤–ç½‘é…ç½®

å®¶é‡Œçš„å®½å¸¦æœ‰å…¬ç½‘ IP, æ‰€ä»¥æˆ‘æ˜¯ç›´æ¥éƒ¨ç½²åˆ° HomeLab çš„æœåŠ¡å™¨ä¸Š, ç„¶åç»‘å®šç»‘å®šè‡ªå®šä¹‰åŸŸåå³å¯, å‡è®¾ç»‘å®šçš„åŸŸåä¸º: `https://summary.dong4j.tele:3000`,

é‚£ä¹ˆ Hexo çš„ AI æ‘˜è¦é…ç½®å°±è¦ä¿®æ”¹ä¸º:

```yaml
post_head_ai_description:
	...
  apiUrl: https://summary.dong4j.tele:3000/api/summary
	...
```

æ•ˆæœå¦‚ä¸‹:

![20250208212138_yyglInIu.webp](https://cdn.dong4j.site/source/image/20250208212138_yyglInIu.webp)

### 3. Kokoro TTS éƒ¨ç½²

#### 3.1 éƒ¨ç½²

æˆ‘ä½¿ç”¨çš„æ˜¯ [Kokoro-FastAPI](https://github.com/remsky/Kokoro-FastAPI), ä½¿ç”¨ CPU æ¨¡å¼éƒ¨ç½²åˆ° Mac mini M2 ä¸Š:

```bash
git clone https://github.com/remsky/Kokoro-FastAPI.git
cd Kokoro-FastAPI

cd docker/cpu
docker compose up -d --build
```

ä¸è¿‡æœ€æ–°çš„ **0.2.0** ç‰ˆæœ¬ä½¿ç”¨ docker éƒ¨ç½²è¿˜æœ‰ä¸€ç‚¹ [é—®é¢˜](https://github.com/remsky/Kokoro-FastAPI/issues/127), è§£å†³æ–¹æ³•å¦‚ä¸‹:

ä¿®æ”¹æ–‡ä»¶ `docker/cpu/Dockerfile`:

```dockerfile
# Install dependencies and check espeak location
RUN mkdir -p /usr/share/espeak-ng-data \
    && apt-get update && apt-get install -y \
        espeak-ng \
        espeak-ng-data \
        git \
        libsndfile1 \
        curl \
        ffmpeg \
        g++ \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && ln -s /usr/lib/*/espeak-ng-data/* /usr/share/espeak-ng-data/
```

**åº”è¯¥å…ˆæ‰§è¡Œ `mkdir -p /usr/share/espeak-ng-data`**.

> å¦‚æœä½ éœ€è¦ web-ui æœåŠ¡, éœ€è¦ä¿®æ”¹ docker-compose.yml, åˆ é™¤ web-ui æœåŠ¡çš„æ³¨é‡Š.

éƒ¨ç½²æ²¡é—®é¢˜çš„è¯, åº”è¯¥èƒ½çœ‹åˆ°ç›¸å…³çš„å®¹å™¨:

![20250208223048_VDtpJCBF.webp](https://cdn.dong4j.site/source/image/20250208223048_VDtpJCBF.webp)

#### 3.2 åˆ‡æ¢è¯­è¨€

Kokoro-FastAPI é»˜è®¤ä½¿ç”¨è‹±è¯­ç”Ÿæˆè¯­éŸ³, æ‰€ä»¥æˆ‘ä»¬è¦ä¿®æ”¹ä¸€ä¸‹ä»£ç æ¥æ”¯æŒä¸­æ–‡:

ä¿®æ”¹ `api/src/services/tts_service.py` ç¬¬ 297 è¡Œ:

```python
# å°† lang_code ä¿®æ”¹ä¸º 'z'
quiet_pipeline = KPipeline(lang_code='z', model=False)
```

ç„¶åé‡æ–°ä½¿ç”¨ docker-compose éƒ¨ç½²å³å¯.

**Gradio WebUI**:

![20250208214224_0h3tBPgJ.webp](https://cdn.dong4j.site/source/image/20250208214224_0h3tBPgJ.webp)

**è‡ªå¸¦ WebUI**:

![20250208220534_NqhGwId3.webp](https://cdn.dong4j.site/source/image/20250208220534_NqhGwId3.webp)

#### 3.3 åœé¡¿é—®é¢˜

å¦‚æœä½¿ç”¨ä¸­æ–‡æ ‡ç‚¹æœåŠ¡ä¼šå‡ºç°åœé¡¿æ—¶é—´è¾ƒçŸ­çš„é—®é¢˜, è§£å†³æ–¹æ³•å°±æ˜¯å°†ä¸­æ–‡æ ‡ç‚¹æœåŠ¡ä¿®æ”¹ä¸ºè‹±æ–‡æ ‡ç‚¹æœåŠ¡.

[ç›¸å…³è®¨è®º](https://huggingface.co/hexgrad/Kokoro-82M/discussions/89)

> è¿™ä¸ªå·²åœ¨ `audio-server` å¤„ç†è¿‡äº†.

#### 3.4 ä¸­è‹±æ–‡æ··åˆå¯¼è‡´è‹±è¯­å‘éŸ³ä¸æ­£å¸¸

è¿™ä¸ªé—®é¢˜è¿˜æ²¡æœ‰è§£å†³.

---

### 4. è¯­éŸ³æœåŠ¡ API éƒ¨ç½²ä¸é›†æˆ

#### 4.1 åŠŸèƒ½

- æä¾›ä¸€ä¸ª `/audio` æ¥å£ç»™ Hexo åšå®¢è°ƒç”¨, é€šè¿‡ id è·å– Redis ä¸­çš„æ‘˜è¦æ–‡æœ¬, ç„¶åè°ƒç”¨ Kokoro TTS FastAPI ç”Ÿæˆè¯­éŸ³;
- ç”Ÿæˆçš„ mp3 ä¼šä¿å­˜åˆ° `audios ç›®å½•`, é¿å…é‡å¤ç”Ÿæˆ;
- é€šè¿‡ pm2 å¯åŠ¨æœåŠ¡;
- æä¾›è‡ªåŠ¨éƒ¨ç½²è„šæœ¬ä¸€é”®éƒ¨ç½²;

#### 4.2 ä½¿ç”¨

```bash
git clone git@github.com:dong4j/blog-summary-assistant-server.git
cd audio-server
cp config.ini.template config.ini
# åˆå§‹åŒ– python ç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

ä¿®æ”¹ `config.ini` ä¸­çš„é…ç½®ä¿¡æ¯:

```ini
[redis]
host=192.168.1.2
port=6379
password=password
db=0

[kokoro]
base_url=http://192.168.31.5:8880/v1
```

æµ‹è¯•:

```python
python kokorotts_with_request.py
```

æˆåŠŸåä¼šåœ¨ `audios` ç›®å½•ä¸‹ç”Ÿæˆ mp3 æ–‡ä»¶, å¦‚æœéŸ³è‰²ä¸æ»¡æ„å¯ä»¥ä¿®æ”¹ç›¸å…³ä»£ç .

#### 4.3 éƒ¨ç½²

ä¿®æ”¹ `ecosystem.config.js` ç›¸å…³é…ç½®:

```javascript
module.exports = {
  apps: [
    {
      name: "audio-server", // åº”ç”¨åç§°
      namespace: "blog", // æŒ‡å®šå‘½åç©ºé—´
      version: "1.0.0", // åº”ç”¨ç‰ˆæœ¬
      cwd: "/path/to/deploy", // éƒ¨ç½²åˆ°æœåŠ¡å™¨çš„å·¥ä½œç›®å½•
      script: "./audioServer.py", // ä¸»è„šæœ¬è·¯å¾„ï¼Œç›¸å¯¹äº cwd
      interpreter: "/mnt/4.860.ssd/audio-server/venv/bin/python3",
      watch: true, // æ˜¯å¦å¯ç”¨æ–‡ä»¶ç›‘æ§
      ignore_watch: ["__pycache__", "venv", "audios", "logs"], // å¿½ç•¥ç›‘æ§çš„æ–‡ä»¶æˆ–ç›®å½•
      exec_mode: "fork",
      instances: 1, // åº”ç”¨å®ä¾‹æ•°é‡
      autorestart: true, // æ˜¯å¦è‡ªåŠ¨é‡å¯
      env: {},
      log_date_format: "YYYY-MM-DD HH:mm:ss", // æ—¥å¿—æ—¶é—´æ ¼å¼
      error_file: "./logs/error.log", // é”™è¯¯æ—¥å¿—æ–‡ä»¶
      out_file: "./logs/out.log", // è¾“å‡ºæ—¥å¿—æ–‡ä»¶
      merge_logs: true, // æ˜¯å¦åˆå¹¶æ—¥å¿—
    },
  ],
};
```

ä¿®æ”¹ `deploy.sh` è„šæœ¬ä¸­çš„ `DEFAULT_SSH_ALIAS` å’Œ `DEFAULT_REMOTE_DIR`:

- DEFAULT_SSH_ALIAS: .ssh ä¸­çš„ config é…ç½®åˆ«å, è¿™é‡Œåšäº†å…å¯†ç™»å½•å¤„ç†;
- DEFAULT_REMOTE_DIR: éƒ¨ç½²åˆ°æœåŠ¡å™¨çš„å·¥ä½œç›®å½•;

æœ€åæ‰§è¡Œéƒ¨ç½²è„šæœ¬:

```bash
./deploy.sh
```

ç¬¬ä¸€æ¬¡éƒ¨ç½²éœ€è¦åœ¨æœåŠ¡å™¨çš„éƒ¨ç½²ç›®å½•å®‰è£…ä¾èµ–:

```python
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

#### 4.4 å¤–ç½‘é…ç½®

å‡è®¾ç»‘å®šçš„åŸŸåä¸º: `https://audio.dong4j.tele:6668`, é‚£ä¹ˆ Hexo çš„ AI æ‘˜è¦é…ç½®å°±è¦ä¿®æ”¹ä¸º:

```yaml
post_head_ai_description:
  ...
  audioUrl: https://audio.dong4j.tele:6668/audio
  ...
```

æ•ˆæœå¦‚ä¸‹:

![20250209003039_KL0AlEW7.webp](https://cdn.dong4j.site/source/image/20250209003039_KL0AlEW7.webp)

{% audio https://cdn.dong4j.site/source/image/66ccb3f1.mp3 %}

## ä¸‰ã€æ³¨é‡Šäº‹é¡¹

- å¦‚æœæ˜¯éƒ¨ç½²åˆ°è‡ªå·±çš„æœåŠ¡å™¨ä¸Š, éœ€è¦åœ¨ Nginx å¤„ç†ä¸€ä¸‹è·¨åŸŸçš„é—®é¢˜;

---

## å››ã€é™„å½•

- å¼€æºä»£ç ä»“åº“åœ°å€: [https://github.com/dong4j/blog-summary-assistant-server](https://github.com/dong4j/blog-summary-assistant-server)
- ç›¸å…³å·¥å…·ä¸èµ„æºé“¾æ¥:
  - [Kokoro TTS éŸ³è‰²å¯¹æ¯”](https://huggingface.co/hexgrad/Kokoro-82M/blob/main/SAMPLES.md)
  - [Kokoro TTS åœ¨çº¿ä½“éªŒ](https://huggingface.co/spaces/hexgrad/Kokoro-TTS)

## [ä½¿ç”¨ PM2 å®ˆæŠ¤ Flask åº”ç”¨ï¼šä»å®‰è£…åˆ°é…ç½®è¯¦è§£](https://blog.dong4j.site/posts/ba2a34a5.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ç®€ä»‹

PM2 æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ Node.js è¿›ç¨‹ç®¡ç†å·¥å…·ï¼Œä¸ä»…é€‚ç”¨äº JavaScript é¡¹ç›®ï¼Œä¹Ÿèƒ½å¾ˆå¥½åœ°å®ˆæŠ¤ Python åº”ç”¨ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨æœåŠ¡å™¨ä¸Šä½¿ç”¨ PM2 æ¥å®ˆæŠ¤ä¸€ä¸ªåŸºäº Flask çš„ Python åº”ç”¨ã€‚

---

### **1. å®‰è£…ç¯å¢ƒ**

#### **å®‰è£… Node.js**

PM2 æ˜¯åŸºäº Node.js çš„å·¥å…·ï¼Œå› æ­¤éœ€è¦å…ˆå®‰è£… Node.js ç¯å¢ƒï¼š

```bash
sudo apt update && sudo apt install curl -y

curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
sudo apt install nodejs -y
```

#### **å®‰è£… PM2**

ä½¿ç”¨ npm å…¨å±€å®‰è£… PM2ï¼š

```bash
npm install pm2 -g
```

éªŒè¯å®‰è£…æ˜¯å¦æˆåŠŸï¼š

```bash
pm2 -v  # æŸ¥çœ‹ç‰ˆæœ¬
pm2 list  # åˆ—å‡ºå½“å‰ç®¡ç†çš„æ‰€æœ‰è¿›ç¨‹
```

---

### **2. å‡†å¤‡ Flask åº”ç”¨**

#### **ç”Ÿæˆä¾èµ–æ–‡ä»¶**

åœ¨ Python é¡¹ç›®ä¸­ï¼Œé€šå¸¸ä¼šä½¿ç”¨ `requirements.txt` æ¥ç®¡ç†ä¾èµ–åŒ…ã€‚å¦‚æœå°šæœªç”Ÿæˆè¯¥æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤åˆ›å»ºï¼š

```bash
pip freeze > requirements.txt
```

#### **é…ç½®è™šæ‹Ÿç¯å¢ƒï¼ˆå¯é€‰ä½†æ¨èï¼‰**

ä¸ºäº†ä¿æŒé¡¹ç›®çš„ç‹¬ç«‹æ€§ï¼Œå»ºè®®ä¸º Flask åº”ç”¨åˆ›å»ºä¸€ä¸ª Python è™šæ‹Ÿç¯å¢ƒã€‚

```bash
python3 -m venv my_flask_env  # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
source my_flask_env/bin/activate  # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
```

æ¿€æ´»åï¼Œåœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…é¡¹ç›®ä¾èµ–ï¼š

```bash
pip install -r requirements.txt
```

#### **ç¼–å†™å¯åŠ¨è„šæœ¬**

Flask åº”ç”¨é€šå¸¸éœ€è¦é€šè¿‡ `gunicorn` æˆ– `uwsgi` æ¥è¿è¡Œï¼Œä»¥æé«˜æ€§èƒ½å’Œå¹¶å‘å¤„ç†èƒ½åŠ›ã€‚

å‡è®¾ä½ çš„ Flask åº”ç”¨æ–‡ä»¶ä¸º `app.py`ï¼Œä»¥ä¸‹æ˜¯ä½¿ç”¨ `gunicorn` å¯åŠ¨çš„é…ç½®ç¤ºä¾‹ï¼š

```bash
# å®‰è£… gunicorn
pip install gunicorn

# ä½¿ç”¨ gunicorn å¯åŠ¨ Flask åº”ç”¨
gunicorn -b "0.0.0.0:8000" --workers 4 app:app
```

ä½ ä¹Ÿå¯ä»¥ä¸º `gunicorn` é…ç½®ä¸€ä¸ªå‚æ•°æ–‡ä»¶ï¼ˆå¦‚ `gunicorn_config.py`ï¼‰ï¼Œä»¥è¿›ä¸€æ­¥ä¼˜åŒ–æ€§èƒ½ï¼š

```python
# gunicorn_config.py

bind = '0.0.0.0:8000'           # ç»‘å®šåœ°å€å’Œç«¯å£
workers = 4                     # å·¥ä½œè¿›ç¨‹æ•°ï¼Œæ ¹æ® CPU æ ¸å¿ƒè°ƒæ•´
worker_class = 'gevent'         # ä½¿ç”¨å¼‚æ­¥å·¥ä½œè€…æ¨¡å¼
timeout = 60                   # è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
accesslog = '-'                # è¾“å‡ºè®¿é—®æ—¥å¿—åˆ°æ ‡å‡†è¾“å‡º
errorlog = '-'                 # è¾“å‡ºé”™è¯¯æ—¥å¿—åˆ°æ ‡å‡†è¾“å‡º
```

---

### **3. ä½¿ç”¨ PM2 å®ˆæŠ¤ Flask åº”ç”¨**

#### **ç›´æ¥å¯åŠ¨**

ä½ å¯ä»¥å°† `gunicorn` å‘½ä»¤é€šè¿‡ PM2 ç®¡ç†ï¼š

```bash
pm2 start gunicorn -c gunicorn_config.py wsgi:app --name=flask_app
```

#### **ä½¿ç”¨è‡ªå®šä¹‰è„šæœ¬**

ä¸ºäº†æ›´å¥½åœ°ç®¡ç†ï¼Œå¯ä»¥ç¼–å†™ä¸€ä¸ªå¯åŠ¨è„šæœ¬ï¼ˆå¦‚ `start.sh`ï¼‰ï¼š

```bash
#!/bin/bash

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼ˆå¦‚æœéœ€è¦ï¼‰
source /path/to/my_flask_env/bin/activate

# ä½¿ç”¨ gunicorn å¯åŠ¨ Flask åº”ç”¨
gunicorn -c gunicorn_config.py wsgi:app
```

ç„¶åé€šè¿‡ PM2 ç®¡ç†è¯¥è„šæœ¬ï¼š

```bash
pm2 start start.sh --name=flask_app
```

#### **é…ç½®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰**

ä½ ä¹Ÿå¯ä»¥ä¸º PM2 ç¼–å†™ä¸€ä¸ª JSON é…ç½®æ–‡ä»¶ï¼ˆå¦‚ `ecosystem.config.js`ï¼‰ï¼Œä»¥ä¾¿ç®¡ç†å’Œéƒ¨ç½²å¤šä¸ªåº”ç”¨ã€‚

```javascript
module.exports = {
  apps: [
    {
      name: "Flask App",
      script: "./start.sh", // å¯åŠ¨è„šæœ¬è·¯å¾„
      cwd: "/path/to/your/project", // å·¥ä½œç›®å½•
      env: {
        NODE_ENV: "production",
      },
      watch: false, // æ˜¯å¦ç›‘å¬æ–‡ä»¶å˜åŒ–ï¼ˆé»˜è®¤ falseï¼‰
      max_memory_restart: "100M", // å†…å­˜é™åˆ¶ï¼Œè¶…è¿‡åè‡ªåŠ¨é‡å¯
    },
  ],
};
```

ç„¶åè¿è¡Œï¼š

```bash
pm2 start ecosystem.config.js
```

### 4. PM2 å‘½ä»¤åˆ—è¡¨

| å‘½ä»¤                                            | æè¿°                        |
| ----------------------------------------------- | --------------------------- |
| `pm2 start <app.js> [--name=<name>]`            | å¯åŠ¨åº”ç”¨                    |
| `pm2 stop <app_name/id>`                        | åœæ­¢åº”ç”¨                    |
| `pm2 restart <app_name/id>`                     | é‡å¯åº”ç”¨                    |
| `pm2 delete <app_name/id>`                      | åˆ é™¤åº”ç”¨                    |
| `pm2 list`                                      | åˆ—å‡ºæ‰€æœ‰åº”ç”¨                |
| `pm2 show <app_name/id>`                        | æ˜¾ç¤ºåº”ç”¨è¯¦ç»†ä¿¡æ¯            |
| `pm2 info <app_name/id>`                        | æ˜¾ç¤ºåº”ç”¨ä¿¡æ¯ï¼ˆç­‰åŒäº showï¼‰ |
| `pm2 status`                                    | æ˜¾ç¤º PM2 çŠ¶æ€               |
| `pm2 logs`                                      | æ˜¾ç¤ºæ‰€æœ‰åº”ç”¨æ—¥å¿—            |
| `pm2 logs <app_name/id>`                        | æ˜¾ç¤ºæŒ‡å®šåº”ç”¨æ—¥å¿—            |
| `pm2 flush`                                     | æ¸…ç©ºæ‰€æœ‰æ—¥å¿—æ–‡ä»¶            |
| `pm2 reloadLogs`                                | é‡æ–°åŠ è½½æ—¥å¿—                |
| `pm2 deploy`                                    | éƒ¨ç½²åº”ç”¨                    |
| `pm2 deploy <configuration_file> <environment>` | ä½¿ç”¨é…ç½®æ–‡ä»¶éƒ¨ç½²åˆ°æŒ‡å®šç¯å¢ƒ  |
| `pm2 monit`                                     | ç›‘æ§æ‰€æœ‰åº”ç”¨                |
| `pm2 cpu <app_name/id>`                         | æ˜¾ç¤ºåº”ç”¨ CPU ä½¿ç”¨æƒ…å†µ       |
| `pm2 memory <app_name/id>`                      | æ˜¾ç¤ºåº”ç”¨å†…å­˜ä½¿ç”¨æƒ…å†µ        |
| `pm2 startup`                                   | ç”Ÿæˆå¯åŠ¨è„šæœ¬                |
| `pm2 save`                                      | ä¿å­˜å½“å‰åº”ç”¨åˆ—è¡¨            |
| `pm2 resurrect`                                 | æ¢å¤ä¹‹å‰ä¿å­˜çš„åº”ç”¨åˆ—è¡¨      |
| `pm2 update`                                    | æ›´æ–° PM2 åˆ°æœ€æ–°ç‰ˆæœ¬         |
| `pm2 scale <app_name/id> <number_of_instances>` | æ‰©å±•åº”ç”¨å®ä¾‹æ•°é‡            |
| `pm2 gracefulReload <app_name/id>`              | ä¼˜é›…é‡å¯åº”ç”¨                |
| `pm2 trigger <app_name/id> <action_name>`       | è§¦å‘è‡ªå®šä¹‰åŠ¨ä½œ              |
| `pm2 set <key> <value>`                         | è®¾ç½® PM2 é…ç½®é¡¹             |
| `pm2 unset <key>`                               | å–æ¶ˆè®¾ç½® PM2 é…ç½®é¡¹         |
| `pm2 help`                                      | æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯                |
| `pm2 home`                                      | æ‰“å¼€ PM2 å®˜ç½‘               |
| `pm2 plus`                                      | æ‰“å¼€ PM2 Plus æœåŠ¡é¡µé¢      |
| `pm2 module:list`                               | åˆ—å‡ºæ‰€æœ‰ PM2 æ¨¡å—           |
| `pm2 module:install <module_name>`              | å®‰è£… PM2 æ¨¡å—               |
| `pm2 module:uninstall <module_name>`            | å¸è½½ PM2 æ¨¡å—               |

| å‚æ•°                   | æè¿°                                 |
| ---------------------- | ------------------------------------ |
| `--name`               | è®¾ç½®åº”ç”¨çš„åç§°                       |
| `--cwd`                | æŒ‡å®šå¯åŠ¨åº”ç”¨æ—¶çš„å·¥ä½œç›®å½•             |
| `--watch`              | ç›‘å¬æ–‡ä»¶å˜åŒ–ï¼Œè‡ªåŠ¨é‡å¯åº”ç”¨           |
| `--ignore-watch`       | å¿½ç•¥ç›‘å¬çš„æ–‡ä»¶æˆ–ç›®å½•                 |
| `--max-memory-restart` | è®¾ç½®åº”ç”¨å†…å­˜ä½¿ç”¨ä¸Šé™ï¼Œè¶…è¿‡åè‡ªåŠ¨é‡å¯ |
| `--exec-path`          | æŒ‡å®š Node.js çš„æ‰§è¡Œè·¯å¾„              |
| `--instances`          | è®¾ç½®åº”ç”¨å®ä¾‹çš„æ•°é‡                   |
| `--instance`           | æŒ‡å®šå¯åŠ¨çš„å®ä¾‹ç¼–å·                   |
| `--env`                | è®¾ç½®ç¯å¢ƒå˜é‡                         |
| `--port`               | æŒ‡å®šåº”ç”¨çš„ç«¯å£å·                     |
| `--cron`               | è®¾ç½®å®šæ—¶é‡å¯ä»»åŠ¡                     |
| `--interpreter`        | æŒ‡å®šè§£é‡Šå™¨è·¯å¾„                       |
| `--interpreter-args`   | ä¼ é€’ç»™è§£é‡Šå™¨çš„å‚æ•°                   |
| `--output`             | æŒ‡å®šè¾“å‡ºæ—¥å¿—æ–‡ä»¶è·¯å¾„                 |
| `--error`              | æŒ‡å®šé”™è¯¯æ—¥å¿—æ–‡ä»¶è·¯å¾„                 |
| `--pid`                | æŒ‡å®š PID æ–‡ä»¶è·¯å¾„                    |
| `--log-date-format`    | è®¾ç½®æ—¥å¿—æ—¥æœŸæ ¼å¼                     |
| `--merge-logs`         | åˆå¹¶æ—¥å¿—æ–‡ä»¶                         |
| `--no-daemon`          | ä¸ä»¥å®ˆæŠ¤è¿›ç¨‹æ–¹å¼è¿è¡Œ                 |
| `--no-vizion`          | ç¦ç”¨ vizion ç‰ˆæœ¬æ§åˆ¶                 |
| `--no-autorestart`     | ç¦ç”¨è‡ªåŠ¨é‡å¯                         |
| `--restart-delay`      | è®¾ç½®é‡å¯å»¶è¿Ÿæ—¶é—´                     |
| `--force`              | å¼ºåˆ¶é‡å¯æˆ–åœæ­¢åº”ç”¨                   |
| `--update-env`         | æ›´æ–°ç¯å¢ƒå˜é‡                         |
| `--only`               | åªå¯åŠ¨æŒ‡å®šçš„åº”ç”¨                     |
| `--kill-timeout`       | è®¾ç½®å¼ºåˆ¶æ€æ­»è¿›ç¨‹çš„è¶…æ—¶æ—¶é—´           |
| `--wait-ready`         | ç­‰å¾…åº”ç”¨å‡†å¤‡å¥½åå†ç»§ç»­               |
| `--ready-delay`        | è®¾ç½®ç­‰å¾…å‡†å¤‡å¥½çš„å»¶è¿Ÿæ—¶é—´             |
| `--attach`             | attaching to application output      |
| `--no-attach`          | do not attach to application output  |

## å¸¸è§é—®é¢˜

ç›®å‰ä½¿ç”¨ PM2 æ¥ç®¡ç†äº†å¤šç§ç±»å‹çš„æœåŠ¡, æ¯”å¦‚ python, js, golan ç­‰, æœŸé—´ä¹Ÿé‡åˆ°äº†ä¸€äº›é—®é¢˜, è¿™é‡Œåšä¸€ä¸‹æ€»ç»“.

### pm2 æ‰¾ä¸åˆ°

æˆ‘ä¸€èˆ¬éƒ½æ˜¯åœ¨å®¢æˆ·ç«¯ä¸Šä½¿ç”¨ shell è„šæœ¬é€šè¿‡ pm2 æ¥ç®¡ç†æœåŠ¡, æ‰€ä»¥ä¼šæœ‰ä¸‹é¢è¿™æ ·çš„å¯åŠ¨å‘½ä»¤:

```bash
ssh "$SSH_ALIAS" "pm2 list"
```

ä¸Šé¢çš„è„šæœ¬æ‰§è¡Œä¼šæŠ¥ä¸‹é¢çš„é”™è¯¯:

```bash
zsh:1: command not found: pm2
```

å½“é€šè¿‡ SSH è¿œç¨‹æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œç³»ç»Ÿä¼šå¯åŠ¨ä¸€ä¸ªéäº¤äº’å¼çš„ shellã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼ŒæŸäº›å¯åŠ¨æ–‡ä»¶ï¼ˆå¦‚ .bashrc æˆ– .zshrcï¼‰å¯èƒ½ä¸ä¼šè¢«è‡ªåŠ¨åŠ è½½ï¼Œå¯¼è‡´ç¯å¢ƒå˜é‡ï¼ˆå¦‚ PATHï¼‰æœªè¢«æ­£ç¡®è®¾ç½®ã€‚å› æ­¤ï¼Œç³»ç»Ÿæ— æ³•æ‰¾åˆ° pm2 å‘½ä»¤ã€‚

æ‰€ä»¥æ­£ç¡®çš„æ–¹å¼åº”è¯¥æ˜¯:

```bash
ssh "$SSH_ALIAS" "source ~/.nvm/nvm.sh && pm2 list"
```

### watch é—®é¢˜

PM2 æä¾›ä¸€ä¸ª watch å‚æ•°, ä½†æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶ä¼šé‡å¯æœåŠ¡, ä½†æ˜¯åœ¨æœåŠ¡è¿è¡Œè¿‡ç¨‹ä¸­å¯èƒ½ä¼šç”Ÿæˆä¸€äº›ä¸´æ—¶æ–‡ä»¶æˆ–æ”¹åŠ¨æ–‡ä»¶, è¿™ä¼šå¯¼è‡´æœåŠ¡é‡å¯, è¿™é‡Œæˆ‘ä»¬å¯ä»¥è®¾ç½® `ignore_watch` å‚æ•°æ¥é¿å…è¿™ç§é—®é¢˜, æ¯”å¦‚:

```javascript
module.exports = {
  apps: [
    {
      name: "summary-server", // åº”ç”¨åç§°
      namespace: "blog", // æŒ‡å®šå‘½åç©ºé—´
      version: "1.0.0", // åº”ç”¨ç‰ˆæœ¬
      cwd: "/mnt/4.860.ssd/summary-server", // å½“å‰å·¥ä½œç›®å½•
      script: "./summaryServer.js", // ä¸»è„šæœ¬è·¯å¾„ï¼Œç›¸å¯¹äº cwd
      watch: true, // æ˜¯å¦å¯ç”¨æ–‡ä»¶ç›‘æ§
      ignore_watch: ["node_modules", "logs"], // å¿½ç•¥ç›‘æ§çš„æ–‡ä»¶æˆ–ç›®å½•
      exec_mode: "fork",
      instances: 1, // åº”ç”¨å®ä¾‹æ•°é‡
      autorestart: true, // æ˜¯å¦è‡ªåŠ¨é‡å¯
      env: {
        VERSION: "1.0.0", // è®¾ç½®ç‰ˆæœ¬å·ç¯å¢ƒå˜é‡
      },
      log_date_format: "YYYY-MM-DD HH:mm:ss", // æ—¥å¿—æ—¶é—´æ ¼å¼
      error_file: "./logs/error.log", // é”™è¯¯æ—¥å¿—æ–‡ä»¶
      out_file: "./logs/out.log", // è¾“å‡ºæ—¥å¿—æ–‡ä»¶
      merge_logs: true, // æ˜¯å¦åˆå¹¶æ—¥å¿—
    },
  ],
};
```

è¿™é‡Œæ’é™¤äº† `node_modules` å’Œ `logs` ç›®å½•çš„ç›‘æ§.

### ç”¨æˆ·æƒé™é—®é¢˜

æˆ‘æœåŠ¡å™¨ä¸Šä½¿ç”¨äº†æ™®é€šç”¨æˆ·å®‰è£…çš„ Node.js å’Œ pm2, ä½†æ˜¯æŸäº›æœåŠ¡éœ€è¦ä½¿ç”¨ root ç”¨æˆ·è¿è¡Œæ—¶, éœ€è¦ä¿®æ”¹å¯åŠ¨å‘½ä»¤:

```bash
ssh "$REMOTE_SSH_ALIAS" "source /home/{username}/.nvm/nvm.sh && pm2 start $REMOTE_PATH/ecosystem.config.js"
```

![20250211193332_ydJdiJxp.webp](https://cdn.dong4j.site/source/image/20250211193332_ydJdiJxp.webp)

æ¯”å¦‚ä¸Šé¢çš„æœåŠ¡ä½¿ç”¨ root ç”¨æˆ·è¿è¡Œ. è¿™æ ·ä¹Ÿä¼šå¸¦æ¥é—®é¢˜, å³åœ¨æœåŠ¡å™¨ä¸Š root ç”¨æˆ·ä½¿ç”¨ pm2 ç®¡ç†æœåŠ¡éœ€è¦ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤:

```bash
/home/{username}/.nvm/versions/node/{version}/bin/pm2 list
```

è€Œæ™®é€šç”¨æˆ·ä¹Ÿæ— æ³•é€šè¿‡ `sudo pm2 xxx` ç®¡ç†æœåŠ¡, æ‰€ä»¥æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨ root ç”¨æˆ·å†å®‰è£…ä¸€ä¸ª pm2, ç®€å•ç²—æš´å¾€å¾€æ˜¯æœ€å¥½çš„æ–¹å¼ ğŸ¤£.

## [ä½¿ç”¨ Node.js å¼€å‘æ•°å­—åç‰‡å¹¶é›†æˆ Chat æœåŠ¡](https://blog.dong4j.site/posts/bb4018e9.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![/images/cover/20250115192416_nhXEcB8o.webp](https://cdn.dong4j.site/source/image/20250115192416_nhXEcB8o.webp)

## ç®€ä»‹

æœ€è¿‘åœ¨ä½¿ç”¨ Node.js å†™ä¸€ä¸ªæ•°å­—åç‰‡çš„å°é¡¹ç›®, ç›´æ¥ä½¿ç”¨ `npx dong4j` å°±å¯ä»¥ä½¿ç”¨, å¤§æ¦‚æ˜¯è¿™æ ·çš„:

<script src="https://asciinema.org/a/yQWrglbOqUM44vi4MQ2ThpIp0.js?spm={{spm}}" id="asciicast-yQWrglbOqUM44vi4MQ2ThpIp0" async="false"></script>

![20250115122542_gj3ZW9Jq.webp](https://cdn.dong4j.site/source/image/20250115122542_gj3ZW9Jq.webp)

å…¶ä¸­æœ‰ä¸€ä¸ª `Chat with AI Assistant ğŸ¤–` çš„å°åŠŸèƒ½:

![20250115122637_6LJLDOkA.webp](https://cdn.dong4j.site/source/image/20250115122637_6LJLDOkA.webp)

è¿™ä¸ªåŠŸèƒ½ä½¿ç”¨ one-api å¯¹æ¥å„å®¶ LLM æ¥å£æ¥æä¾› Chat æœåŠ¡:

![npx-card-a-chat.drawio.svg](https://cdn.dong4j.site/source/image/npx-card-a-chat.drawio.svg)

æˆ‘çš„éœ€æ±‚å¾ˆç®€å•:

- ç”¨æˆ·èƒ½å¤Ÿå…è´¹ä½¿ç”¨;
- æˆ‘ä¹Ÿä¸éœ€è¦ä»˜è´¹è´­ä¹° token;

åœ¨ Github æ‰¾äº†ä¸€åœˆå, [LLM Red Team](https://github.com/LLM-Red-Team) æœ€ç¬¦åˆéœ€æ±‚, æ‰€ä»¥è¿™é‡Œè®°å½•ä¸€ä¸‹è¿™ä¸ª Chat æœåŠ¡çš„æ­å»ºè¿‡ç¨‹.

## one-api

[one-api](https://github.com/songquanpeng/one-api) æ˜¯ä¸€ä¸ª OpenAI API æ¥å£ç®¡ç†å·¥å…·, ç›¸å½“äºä¸€ä¸ªä»£ç†, æä¾›äº†å¤šä¸ªæ¸ é“ä»¥åŠ key ç®¡ç†åŠŸèƒ½, å®ƒçš„è¡ç”Ÿé¡¹ç›®ä¹Ÿéå¸¸å¤š, æ„Ÿå…´è¶£çš„å¯ä»¥äº†è§£ä¸€ä¸‹.

ä¸è¿‡æœ€è¿‘çˆ†å‡ºæ¥ one-api é•œåƒè¢« [æŠ•æ¯’](https://github.com/songquanpeng/one-api/issues/2000)äº†, è¿˜å¥½æˆ‘ä½¿ç”¨çš„æ˜¯è€ç‰ˆæœ¬:

> 2024 å¹´ 12 æœˆ 27 æ—¥,One API é¡¹ç›®çš„ Docker Hub é•œåƒè¢«å‘ç°å­˜åœ¨å®‰å…¨é—®é¢˜ã€‚æ”»å‡»è€…è·å–äº†é¡¹ç›®ç»´æŠ¤è€…çš„ Docker Hub å‡­è¯,å¹¶é‡æ–°æ¨é€äº†åŒ…å«æŒ–çŸ¿ç¨‹åºçš„æ¶æ„é•œåƒç‰ˆæœ¬(v0.6.5 è‡³ v0.6.9)ã€‚è¿™äº›è¢«æ±¡æŸ“çš„é•œåƒä¼šå¯¼è‡´æœåŠ¡å™¨ CPU ä½¿ç”¨ç‡å¼‚å¸¸å‡é«˜,å½±å“ç³»ç»Ÿæ­£å¸¸è¿è¡Œã€‚

![20250115122020_OIPp6GEm.webp](https://cdn.dong4j.site/source/image/20250115122020_OIPp6GEm.webp)

æˆ‘ä¸Šé¢æ¥å…¥äº† [LLM Red Team](https://github.com/LLM-Red-Team) æä¾›çš„ free-api, å› ä¸ºå„å¤§å‚å•†æ³¨å†Œå°±é€ token çš„æ´»åŠ¨, é‡æ–°ä½¿ç”¨å°å·æ³¨å†Œäº†å‡ ä¸ª, ä¸€èµ·é…ç½®åˆ° one-api, åº”è¯¥ä¼šæ¯” free-api ç¨³å®šä¸€äº›.

## æ¥å…¥ LLM

- è¯¦ç»†æ–‡æ¡£: [https://llm-red-team.github.io/free-api/](https://llm-red-team.github.io/free-api/)

æˆ‘è¿™é‡Œåªè®°å½•ä¸€ä¸‹è·å– token çš„å…³é”®æ­¥éª¤.

### Kimi

ä» [kimi.moonshot.cn](https://kimi.moonshot.cn/) è·å– refresh_token

è¿›å…¥ kimi éšä¾¿å‘èµ·ä¸€ä¸ªå¯¹è¯ï¼Œç„¶å F12 æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œä» Application > Local Storage ä¸­æ‰¾åˆ°`refresh_token`çš„å€¼ï¼Œè¿™å°†ä½œä¸º Authorization çš„ Bearer Token å€¼ï¼š`Authorization: Bearer TOKEN`

![20250115192421_NQUVlhaJ.webp](https://cdn.dong4j.site/source/image/20250115192421_NQUVlhaJ.webp)

å¦‚æœä½ çœ‹åˆ°çš„`refresh_token`æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè¯·ä½¿ç”¨`.`æ‹¼æ¥èµ·æ¥å†ä½¿ç”¨ã€‚

### è·ƒé—®

ä» [stepchat.cn](https://stepchat.cn/) è·å– Oasis-Token

è¿›å…¥ StepChat éšä¾¿å‘èµ·ä¸€ä¸ªå¯¹è¯ï¼Œç„¶å F12 æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œä» Application > Cookies ä¸­æ‰¾åˆ°`Oasis-Token`çš„å€¼ï¼Œè¿™å°†ä½œä¸º Authorization çš„ Bearer Token å€¼ï¼š`Authorization: Bearer TOKEN`

![20250115192421_IEUX061W.webp](https://cdn.dong4j.site/source/image/20250115192421_IEUX061W.webp)

**å¤šè´¦å·æ¥å…¥**

ä½ å¯ä»¥é€šè¿‡æä¾›å¤šä¸ªè´¦å·çš„ refresh_token å¹¶ä½¿ç”¨`,`æ‹¼æ¥æä¾›ï¼š

```
Authorization: Bearer TOKEN1,TOKEN2,TOKEN3
```

æ¯æ¬¡è¯·æ±‚æœåŠ¡ä¼šä»ä¸­æŒ‘é€‰ä¸€ä¸ªã€‚

### é€šä¹‰åƒé—®

ä» [é€šä¹‰åƒé—®](https://tongyi.aliyun.com/qianwen) ç™»å½•

è¿›å…¥é€šä¹‰åƒé—®éšä¾¿å‘èµ·ä¸€ä¸ªå¯¹è¯ï¼Œç„¶å F12 æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œä» Application > Cookies ä¸­æ‰¾åˆ°`login_tongyi_ticket`çš„å€¼ï¼Œè¿™å°†ä½œä¸º Authorization çš„ Bearer Token å€¼ï¼š`Authorization: Bearer TOKEN`

![20250115192421_Y8xlFKKA.webp](https://cdn.dong4j.site/source/image/20250115192421_Y8xlFKKA.webp)

### æ™ºè°±æ¸…è¨€

ä» [æ™ºè°±æ¸…è¨€](https://chatglm.cn/) è·å– refresh_token

è¿›å…¥æ™ºè°±æ¸…è¨€éšä¾¿å‘èµ·ä¸€ä¸ªå¯¹è¯ï¼Œç„¶å F12 æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œä» Application > Cookies ä¸­æ‰¾åˆ°`chatglm_refresh_token`çš„å€¼ï¼Œè¿™å°†ä½œä¸º Authorization çš„ Bearer Token å€¼ï¼š`Authorization: Bearer TOKEN`

![20250115192421_Hl97Cr17.webp](https://cdn.dong4j.site/source/image/20250115192421_Hl97Cr17.webp)

### ç§˜å¡” AI

ä» [ç§˜å¡” AI æœç´¢](https://metaso.cn/) è·å–`uid`å’Œ`sid`å¹¶ä½¿ç”¨`-`æ‹¼æ¥ï¼š

è¿›å…¥ç§˜å¡” AI æœç´¢ï¼Œç™»å½•è´¦å·ï¼ˆ**å»ºè®®ç™»å½•è´¦å·ï¼Œå¦åˆ™å¯èƒ½é­é‡å¥‡æ€ªçš„é™åˆ¶**ï¼‰ï¼Œç„¶å F12 æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œä» Application > Cookies ä¸­æ‰¾åˆ°`uid`å’Œ`sid`çš„å€¼ã€‚

å°† uid å’Œ sid æ‹¼æ¥ï¼š`uid-sid`ï¼Œå¦‚ `65e91a6b2bac5b600dd8526a-5e7acc465b114236a8d9de26c9f41846`ã€‚

è¿™å°†ä½œä¸º Authorization çš„ Bearer Token å€¼ï¼š`Authorization: Bearer uid-sid`

![20250115192421_tbxPNjKH.webp](https://cdn.dong4j.site/source/image/20250115192421_tbxPNjKH.webp)

### è®¯é£æ˜Ÿç«

ä» [xinghuo.xfyun.cn](https://xinghuo.xfyun.cn/) è·å– ssoSessionId

è¿›å…¥ Spark ç™»å½•å¹¶å‘èµ·ä¸€ä¸ªå¯¹è¯ï¼Œä» Cookie è·å– `ssoSessionId` å€¼ï¼Œç”±äºæ˜Ÿç«å¹³å°ç¦ç”¨ F12 å¼€å‘è€…å·¥å…·ï¼Œè¯·å®‰è£… `Cookie-Editor` æµè§ˆå™¨æ’ä»¶æŸ¥çœ‹ä½ çš„ Cookieã€‚

![20250115192421_IsjurZ27.webp](https://cdn.dong4j.site/source/image/20250115192421_IsjurZ27.webp)

è¿™ä¸ªå€¼å°†ä½œä¸º Authorization çš„ Bearer Token å€¼ï¼š`Authorization: Bearer TOKEN`

**æ³¨æ„ï¼šå¦‚æœé€€å‡ºç™»å½•æˆ–é‡æ–°ç™»å½•å°†å¯èƒ½å¯¼è‡´ ssoSessionId å¤±æ•ˆï¼**

### æµ·èº AI

ä» [æµ·èº AI](https://hailuoai.com/) è·å– token

è¿›å…¥æµ·èº AI éšä¾¿å‘èµ·ä¸€ä¸ªå¯¹è¯ï¼Œç„¶å F12 æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œä» Application > LocalStorage ä¸­æ‰¾åˆ°`_token`çš„å€¼ï¼Œè¿™å°†ä½œä¸º Authorization çš„ Bearer Token å€¼ï¼š`Authorization: Bearer TOKEN`

![20250115192421_Wpt7QPzS.webp](https://cdn.dong4j.site/source/image/20250115192421_Wpt7QPzS.webp)

### DeepSeek

ä» [DeepSeek](https://chat.deepseek.com/) è·å– userToken value

è¿›å…¥ DeepSeek éšä¾¿å‘èµ·ä¸€ä¸ªå¯¹è¯ï¼Œç„¶å F12 æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œä» Application > LocalStorage ä¸­æ‰¾åˆ°`userToken`ä¸­çš„ value å€¼ï¼Œè¿™å°†ä½œä¸º Authorization çš„ Bearer Token å€¼ï¼š`Authorization: Bearer TOKEN`

![20250115192421_dT5Lqsnd.webp](https://cdn.dong4j.site/source/image/20250115192421_dT5Lqsnd.webp)

### docker éƒ¨ç½²:

```yaml
services:
  kimi-free-api:
    container_name: kimi-free-api
    image: vinlic/kimi-free-api:latest
    restart: always
    ports:
      - "10001:8000"
    environment:
      - TZ=Asia/Shanghai
  step-free-api:
    container_name: step-free-api
    image: vinlic/step-free-api:latest
    restart: always
    ports:
      - "10002:8000"
    environment:
      - TZ=Asia/Shanghai
  qwen-free-api:
    container_name: qwen-free-api
    image: vinlic/qwen-free-api:latest
    restart: always
    ports:
      - "10003:8000"
    environment:
      - TZ=Asia/Shanghai
  glm-free-api:
    container_name: glm-free-api
    image: vinlic/glm-free-api:latest
    restart: always
    ports:
      - "10004:8000"
    environment:
      - TZ=Asia/Shanghai
  metaso-free-api:
    container_name: metaso-free-api
    image: vinlic/metaso-free-api:latest
    restart: always
    ports:
      - "10005:8000"
    environment:
      - TZ=Asia/Shanghai
  spark-free-api:
    container_name: spark-free-api
    image: vinlic/spark-free-api:latest
    restart: always
    ports:
      - "10006:8000"
    environment:
      - TZ=Asia/Shanghai
  hailuo-free-api:
    container_name: hailuo-free-api
    image: vinlic/hailuo-free-api:latest
    restart: always
    ports:
      - "10007:8000"
    environment:
      - TZ=Asia/Shanghai
  deepseek-free-api:
    container_name: deepseek-free-api
    image: vinlic/deepseek-free-api:latest
    restart: always
    ports:
      - "10008:8000"
    environment:
      - TZ=Asia/Shanghai
```

## æ¥å…¥ one-api

### free-api æ¥å…¥

ä»¥æ™ºè°±æ¸…è¨€ä¸ºä¾‹, è¯´æ˜ä¸€ä¸‹å¦‚ä½•å°†ä¸Šé¢çš„ free-api æ¥å…¥åˆ° one-api ä¸­. å‡è®¾ docker éƒ¨ç½²åœ¨ 192.168.1.2 æœåŠ¡å™¨ä¸Š, æ™ºè°±æ¸…è¨€çš„ free-api ç«¯å£æ˜¯: `10004`.

åœ¨ one-api çš„æ¸ é“ç®¡ç†é¡µé¢æ·»åŠ æ–°çš„æ¸ é“:

![20250115130424_oOpkxMA4.webp](https://cdn.dong4j.site/source/image/20250115130424_oOpkxMA4.webp)

- ç±»å‹: è‡ªå®šä¹‰æ¸ é“
- Base URL: docker éƒ¨ç½²æ™ºè°±æ¸…è¨€çš„åœ°å€
- åç§°: éšä¾¿
- åˆ†ç»„: é»˜è®¤å³å¯
- æ¨¡å‹: æˆ‘è¿™é‡Œå†™çš„è‡ªå®šä¹‰çš„æ¨¡å‹åç§°, è¿™ä¸ªéœ€è¦å’Œ OpenAI client ä¸­çš„ `model` å¯¹åº”;
- å¯†é’¥: å‰é¢è·å–çš„ `chatglm_refresh_token`

æ·»åŠ å®Œæˆåå¯åœ¨æ¸ é“ç®¡ç†é¡µé¢è¿›è¡Œæµ‹è¯•.

### æ­£å¸¸æ¸ é“æ¥å…¥

ç°åœ¨å„å¤§å‚å•†ä¸ºäº†æ¨å¹¿è‡ªå·±çš„ AI API, æ³¨å†Œéƒ½ä¼šèµ é€ä¸€å®šé¢åº¦çš„ Token, è¿˜æ˜¯ä»¥æ™ºè°±æ¸…è¨€ä¸ºä¾‹, è®²è®²å¦‚ä½•æ¥å…¥åˆ° one-api.

æ³¨å†Œå¹¶ç™»å½• [æ™ºè°±æ¸…è¨€å¼€æ”¾å¹³å°](https://bigmodel.cn/), æ³¨å†Œå°±é€å¤§ç¤¼åŒ…, ä¸è¿‡åªæœ‰ 1 ä¸ªæœˆæœ‰æ•ˆæœŸ:

![20250115131737_uC7IYg8j.webp](https://cdn.dong4j.site/source/image/20250115131737_uC7IYg8j.webp)

[æ™ºè°±æ¸…è¨€å¼€æ”¾å¹³å°-ä¸ªäººä¸­å¿ƒ-é¡¹ç›®ç®¡ç†-API keys](https://bigmodel.cn/usercenter/proj-mgmt/apikeys) è·å– API key.

ç„¶åå† one-api æ·»åŠ æ–°çš„æ¸ é“:
![20250115131948_PEUucxaL.webp](https://cdn.dong4j.site/source/image/20250115131948_PEUucxaL.webp)

**å¯†é’¥** ä¸ºæ™ºè°±æ¸…è¨€å¼€æ”¾å¹³å°æä¾›çš„ API key. éœ€è¦æ³¨æ„çš„æ˜¯ **æ¨¡å‹** å’Œ **æ¨¡å‹é‡å®šå‘**:

- **æ¨¡å‹**: OpenAI API æ¥å£ä¸­çš„ `model` åç§°ä¼šåŒ¹é… one-api çš„æ¨¡å‹åç§°, åªæœ‰åŒ¹é…ä¸Šäº†æ‰èƒ½æ­£å¸¸è°ƒç”¨, npx-card å…¶å®åªä¼šä½¿ç”¨åˆ° `hybrid-model`, æˆ‘æ˜¯ä¸ºäº†æ–¹ä¾¿åœ¨ one-api ä¸Šæµ‹è¯•, æ‰€ä»¥æ·»åŠ äº†å‰é¢ 2 ä¸ª;
- **æ¨¡å‹é‡å®šå‘**: one-api ä¼šæ ¹æ®è¿™é‡Œçš„é…ç½®ä¿®æ”¹æœ€ç»ˆçš„ `model` åç§°, è¿™é‡Œçš„æ„æ€æ˜¯å°† client ä¼ å…¥çš„ `hybrid-model` ä¿®æ”¹ä¸º `glm-4-plus`, æœ€åè°ƒç”¨æ™ºè°±æ¸…è¨€çš„æ¥å£.

æœ€åå°±æ˜¯åœ¨ npx ä¸­ä½¿ç”¨äº†:

```javascript
// åˆå§‹åŒ– OpenAI å®¢æˆ·ç«¯
this.openai = new OpenAI({
  apiKey: config.apiKey,
  baseURL: config.baseUrl,
});
this.model = config.model;

const stream = await this.openai.chat.completions.create({
  model: this.model,
  messages: [...this.context, { role: "user", content: message }],
  stream: true,
});

for await (const chunk of stream) {
  const content = chunk.choices[0]?.delta?.content || "";
  if (content) {
    process.stdout.write(content);
  }
}
```

---

## å®‰å…¨é˜²æ§

å› ä¸ºæˆ‘å°† one-api æš´éœ²åˆ°å…¬ç½‘ä¸ºåé¢çš„ LLM æä¾›ä»£ç†æœåŠ¡, ä¸ºä¿è¯æœåŠ¡å™¨çš„å®‰å…¨, éœ€è¦åšä¸€å®šçš„å®‰å…¨è®¾ç½®.

æˆ‘çš„æœåŠ¡é€šè¿‡ é›·æ±  Safeline è¿›è¡Œä»£ç†, è€Œ Safeline ä¸å…è®¸ç›´æ¥ä¿®æ”¹ Nginx é…ç½®(ä¼šå®šæ—¶è¦†ç›–), æ‰€ä»¥éœ€è¦ä¸ºé…ç½®æ–‡ä»¶æ·»åŠ åªè¯»æƒé™:

```bash
chattr +i é…ç½®å
```

ä¸‹é¢æ˜¯å…·ä½“çš„å®‰å…¨è®¾ç½®.

### ç¦ç”¨æ³¨å†Œ

å†…ç½‘ç™»å½• one-api æ§åˆ¶å°, ç¦ç”¨æ³¨å†ŒåŠŸèƒ½:

![20250115121052_DbPKMk9f.webp](https://cdn.dong4j.site/source/image/20250115121052_DbPKMk9f.webp)

ä¿®æ”¹å¯†ç å¼ºåº¦, è¿™ä¸ªå°±ä¸è´´å›¾äº†.

### ç¦ç”¨ä¸»è·¯å¾„

å› ä¸º OpenAI API åªä¼šè®¿é—® `/v1` çš„æ¥å£, æ‰€ä»¥ç¦ç”¨é™¤ `/v1/**` ä¹‹å¤–çš„å…¶ä»–æ‰€æœ‰è·¯å¾„:

```bash
server {
    listen 443 ssl;
    server_name oneapi.dong4j.ink;

    # SSL è¯ä¹¦é…ç½®
    ssl_certificate /path/to/certificate.crt;
    ssl_certificate_key /path/to/private.key;

    # ä»…å…è®¸è®¿é—® /v1 å’Œ /v1/** è·¯å¾„
    location ^~ /v1 {
        proxy_pass http://backend_39;  # è½¬å‘åˆ°åç«¯
        proxy_set_header Host $http_host;
        include proxy_params;
    }

    # ç¦æ­¢è®¿é—®å…¶ä»–è·¯å¾„
    location / {
        return 403;  # è¿”å› 403 Forbidden
    }
}
```

### åªå…è®¸ POST

OpenAI API åªä¼šä½¿ç”¨ POST, æ‰€ä»¥ç¦ç”¨å…¶ä»–è¯·æ±‚æ–¹å¼:

```bash
location ^~ /v1 {
    limit_except POST {
        deny all; # é POST è¯·æ±‚è¿”å› 405 Method Not Allowed
    }
}
```

## æ€§èƒ½è°ƒä¼˜

```
# å…è®¸è®¿é—® /v1 å’Œ /v1/** è·¯å¾„
location ^~ /v1 {
    limit_except POST {
        deny all; # é POST è¯·æ±‚è¿”å› 405 Method Not Allowed
    }
    proxy_pass http://backend_39;

    # ä»£ç†ä¼˜åŒ–é…ç½®
    proxy_buffering off;
    chunked_transfer_encoding on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 120;

		...
}

# ç¦æ­¢è®¿é—®å…¶ä»–è·¯å¾„ï¼ŒåŒ…æ‹¬ /
location / {
    return 403; # ç¦æ­¢è®¿é—®
}
```

**è§£é‡Šå¦‚ä¸‹:**

```
# å…³é—­ä»£ç†ç¼“å†²ã€‚å½“è®¾ç½®ä¸ºoffæ—¶ï¼ŒNginxä¼šç«‹å³å°†å®¢æˆ·ç«¯è¯·æ±‚å‘é€åˆ°åç«¯æœåŠ¡å™¨ï¼Œå¹¶ç«‹å³å°†ä»åç«¯æœåŠ¡å™¨æ¥æ”¶åˆ°çš„å“åº”å‘é€å›å®¢æˆ·ç«¯ã€‚
proxy_buffering off;
# å¯ç”¨åˆ†å—ä¼ è¾“ç¼–ç ã€‚åˆ†å—ä¼ è¾“ç¼–ç å…è®¸æœåŠ¡å™¨ä¸ºåŠ¨æ€ç”Ÿæˆçš„å†…å®¹åˆ†å—å‘é€æ•°æ®ï¼Œè€Œä¸éœ€è¦é¢„å…ˆçŸ¥é“å†…å®¹çš„å¤§å°ã€‚
chunked_transfer_encoding on;
# å¼€å¯TCP_NOPUSHï¼Œè¿™å‘Šè¯‰Nginxåœ¨æ•°æ®åŒ…å‘é€åˆ°å®¢æˆ·ç«¯ä¹‹å‰ï¼Œå°½å¯èƒ½åœ°å‘é€æ•°æ®ã€‚è¿™é€šå¸¸åœ¨sendfileä½¿ç”¨æ—¶é…åˆä½¿ç”¨ï¼Œå¯ä»¥æé«˜ç½‘ç»œæ•ˆç‡ã€‚
tcp_nopush on;
# å¼€å¯TCP_NODELAYï¼Œè¿™å‘Šè¯‰Nginxä¸å»¶è¿Ÿå‘é€æ•°æ®ï¼Œç«‹å³å‘é€å°æ•°æ®åŒ…ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿™å¯ä»¥å‡å°‘ç½‘ç»œçš„å»¶è¿Ÿã€‚
tcp_nodelay on;
# è®¾ç½®ä¿æŒè¿æ¥çš„è¶…æ—¶æ—¶é—´ï¼Œè¿™é‡Œè®¾ç½®ä¸º120ç§’ã€‚å¦‚æœåœ¨è¿™æ®µæ—¶é—´å†…ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´æ²¡æœ‰è¿›ä¸€æ­¥çš„é€šä¿¡ï¼Œè¿æ¥å°†è¢«å…³é—­ã€‚
keepalive_timeout 120;
```

## [ä»é›¶å¼€å§‹å¼€å‘ VSCode æ’ä»¶ï¼šä» Hello World åˆ°å›¾ç‰‡å¤„ç†å·¥å…·](https://blog.dong4j.site/posts/621bb677.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![/images/cover/20250114004440_j6VHuwA4.webp](https://cdn.dong4j.site/source/image/20250114004440_j6VHuwA4.webp)

## å¼•è¨€

VSCode æ’ä»¶å¼€å‘å¯èƒ½å¯¹åˆå­¦è€…æ¥è¯´æœ‰äº›é™Œç”Ÿã€‚æœ¬æ–‡å°†ä»æœ€ç®€å•çš„ Hello World æ’ä»¶å¼€å§‹ï¼Œä¸€æ­¥æ­¥å¸¦ä½ å®ç°ä¸€ä¸ªå®ç”¨çš„å›¾ç‰‡å¤„ç†å·¥å…·ã€‚æˆ‘ä»¬ä¼šå…ˆå¼€å‘ä¸€ä¸ªæœ€åŸºç¡€çš„æ’ä»¶ï¼Œç„¶åé€æ­¥æ·»åŠ åŠŸèƒ½ï¼Œæœ€ç»ˆå®ç°ä¸€ä¸ªå¯ä»¥å¸®åŠ©åšä¸»å¿«é€Ÿå¤„ç†å›¾ç‰‡çš„å·¥å…·ã€‚

## ç¬¬ä¸€éƒ¨åˆ†ï¼šHello World æ’ä»¶

### 1. ç¯å¢ƒå‡†å¤‡

é¦–å…ˆï¼Œç¡®ä¿ä½ çš„ç”µè„‘ä¸Šå·²å®‰è£…ï¼š

- Node.jsï¼ˆå»ºè®® 14.x æˆ–æ›´é«˜ç‰ˆæœ¬ï¼‰
- Visual Studio Code
- Gitï¼ˆå¯é€‰ï¼‰

### 2. åˆ›å»ºç¬¬ä¸€ä¸ªæ’ä»¶

1. å®‰è£… VSCode æ’ä»¶ç”Ÿæˆå™¨ï¼š

```bash
npm install -g yo generator-code
```

2. åˆ›å»ºæ’ä»¶é¡¹ç›®ï¼š

```bash
yo code
```

3. æŒ‰ç…§æç¤ºå¡«å†™åŸºæœ¬ä¿¡æ¯ï¼š

```
? What type of extension do you want to create? New Extension (TypeScript)
? What's the name of your extension? hello-world
? What's the identifier of your extension? hello-world
? What's the description of your extension? My first extension
? Initialize a git repository? Yes
? Which package manager to use? npm
```

### 3. ç†è§£åŸºç¡€é¡¹ç›®ç»“æ„

ç”Ÿæˆçš„é¡¹ç›®åŒ…å«ä»¥ä¸‹ä¸»è¦æ–‡ä»¶ï¼š

```
hello-world/
  â”œâ”€â”€ .vscode/                # VSCode é…ç½®
  â”œâ”€â”€ src/
  â”‚   â””â”€â”€ extension.ts        # æ’ä»¶ä¸»è¦ä»£ç 
  â”œâ”€â”€ package.json           # æ’ä»¶é…ç½®æ–‡ä»¶
  â””â”€â”€ README.md              # è¯´æ˜æ–‡æ¡£
```

### 4. å®ç° Hello World

1. ä¿®æ”¹ `package.json` æ·»åŠ å‘½ä»¤ï¼š

```json
{
  "contributes": {
    "commands": [
      {
        "command": "hello-world.helloWorld",
        "title": "Hello World"
      }
    ]
  }
}
```

2. åœ¨ `src/extension.ts` ä¸­å®ç°å‘½ä»¤ï¼š

```typescript
import * as vscode from "vscode";

export function activate(context: vscode.ExtensionContext) {
  let disposable = vscode.commands.registerCommand(
    "hello-world.helloWorld",
    () => {
      vscode.window.showInformationMessage("Hello World!");
    }
  );

  context.subscriptions.push(disposable);
}
```

3. æŒ‰ F5 è¿è¡Œæ’ä»¶ï¼Œåœ¨å‘½ä»¤é¢æ¿ï¼ˆCmd/Ctrl + Shift + Pï¼‰è¾“å…¥ "Hello World" æµ‹è¯•ã€‚

## ç¬¬äºŒéƒ¨åˆ†ï¼šå›¾ç‰‡å¤„ç†æ’ä»¶

åœ¨æŒæ¡äº†åŸºç¡€çŸ¥è¯†åï¼Œè®©æˆ‘ä»¬æ¥å¼€å‘ä¸€ä¸ªå®ç”¨çš„å›¾ç‰‡å¤„ç†æ’ä»¶ã€‚

### 1. éœ€æ±‚åˆ†æ

- åœ¨æ–‡ä»¶èµ„æºç®¡ç†å™¨ä¸­å³é”®å›¾ç‰‡æ–‡ä»¶
- æ‰§è¡Œè‡ªå®šä¹‰çš„å›¾ç‰‡å¤„ç†è„šæœ¬
- æ”¯æŒé…ç½®ä¸åŒçš„å¤„ç†æ–¹å¼

### 2. åŸºç¡€ç‰ˆæœ¬å®ç°

1. ä¿®æ”¹ `package.json` æ·»åŠ å³é”®èœå•ï¼š

```json
{
  "contributes": {
    "commands": [
      {
        "command": "script-runner.run",
        "title": "å¤„ç†å›¾ç‰‡"
      }
    ],
    "menus": {
      "explorer/context": [
        {
          "command": "script-runner.run",
          "when": "resourceExtname =~ /\\.(png|jpg|jpeg)$/"
        }
      ]
    }
  }
}
```

2. å®ç°åŸºç¡€åŠŸèƒ½ï¼š

```typescript
import * as vscode from "vscode";
import * as cp from "child_process";

export function activate(context: vscode.ExtensionContext) {
  let disposable = vscode.commands.registerCommand(
    "script-runner.run",
    (uri: vscode.Uri) => {
      // è·å–æ–‡ä»¶è·¯å¾„
      const filePath = uri.fsPath;

      // æ‰§è¡Œç®€å•çš„å‹ç¼©å‘½ä»¤
      const command = `convert '${filePath}' -quality 85 '${filePath}'`;

      cp.exec(command, (error) => {
        if (error) {
          vscode.window.showErrorMessage("å›¾ç‰‡å¤„ç†å¤±è´¥");
          return;
        }
        vscode.window.showInformationMessage("å›¾ç‰‡å¤„ç†æˆåŠŸ");
      });
    }
  );

  context.subscriptions.push(disposable);
}
```

### 3. æ·»åŠ é…ç½®æ”¯æŒ

1. åœ¨ `package.json` ä¸­æ·»åŠ é…ç½®é¡¹ï¼š

```json
{
  "contributes": {
    "configuration": {
      "title": "Script Runner",
      "properties": {
        "scriptRunner.imageQuality": {
          "type": "number",
          "default": 85,
          "description": "å›¾ç‰‡å‹ç¼©è´¨é‡"
        }
      }
    }
  }
}
```

2. è¯»å–é…ç½®ï¼š

```typescript
const config = vscode.workspace.getConfiguration("scriptRunner");
const quality = config.get("imageQuality") || 85;
```

### 4. è¿›é˜¶åŠŸèƒ½

é€æ­¥æ·»åŠ æ›´å¤šåŠŸèƒ½ï¼š

1. æ”¯æŒå¤šç§å›¾ç‰‡å¤„ç†å‘½ä»¤
2. æ·»åŠ è¿›åº¦æç¤º
3. æ”¯æŒå–æ¶ˆæ“ä½œ
4. é”™è¯¯å¤„ç†

[å®Œæ•´ä»£ç å®ç°è§ä¸Šæ–‡]

## å¼€å‘æŠ€å·§å’Œæ³¨æ„äº‹é¡¹

1. **è°ƒè¯•æŠ€å·§**

   - ä½¿ç”¨ `console.log` è¾“å‡ºè°ƒè¯•ä¿¡æ¯
   - F5 å¯åŠ¨è°ƒè¯•ç¯å¢ƒ
   - ä½¿ç”¨ VSCode çš„è°ƒè¯•æ§åˆ¶å°æŸ¥çœ‹è¾“å‡º

2. **å¸¸è§é—®é¢˜**

   - å‘½ä»¤ä¸æ˜¾ç¤ºï¼šæ£€æŸ¥ `package.json` çš„ `contributes` é…ç½®
   - è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼šæ£€æŸ¥å‘½ä»¤è·¯å¾„å’Œæƒé™
   - é…ç½®ä¸ç”Ÿæ•ˆï¼šæ£€æŸ¥é…ç½®é¡¹åç§°æ˜¯å¦æ­£ç¡®

3. **æœ€ä½³å®è·µ**
   - ä½¿ç”¨ TypeScript ç±»å‹æ£€æŸ¥
   - åŠæ—¶é‡Šæ”¾èµ„æº
   - æä¾›æ¸…æ™°çš„é”™è¯¯æç¤º

## æ€»ç»“

é€šè¿‡è¿™ä¸ªæ•™ç¨‹ï¼Œæˆ‘ä»¬ä»æœ€ç®€å•çš„ Hello World å¼€å§‹ï¼Œé€æ­¥å®ç°äº†ä¸€ä¸ªå®ç”¨çš„å›¾ç‰‡å¤„ç†æ’ä»¶ã€‚è¿™ä¸ªè¿‡ç¨‹å±•ç¤ºäº† VSCode æ’ä»¶å¼€å‘çš„åŸºæœ¬æµç¨‹å’Œå…³é”®æ¦‚å¿µã€‚å»ºè®®åˆå­¦è€…ï¼š

1. å…ˆä»ç®€å•çš„ Hello World å¼€å§‹
2. ç†è§£æ’ä»¶çš„åŸºæœ¬ç»“æ„
3. æŒæ¡å‘½ä»¤å’Œèœå•çš„é…ç½®
4. é€æ­¥æ·»åŠ æ›´å¤æ‚çš„åŠŸèƒ½

## å‚è€ƒèµ„æº

- [VSCode æ’ä»¶å¼€å‘æ–‡æ¡£](https://code.visualstudio.com/api)
- [VSCode æ’ä»¶ç¤ºä¾‹](https://github.com/microsoft/vscode-extension-samples)
- [Publishing Extensions](https://code.visualstudio.com/api/working-with-extensions/publishing-extension)

## å®æˆ˜æ¡ˆä¾‹ï¼šå¼€å‘ä¸€ä¸ªé€šç”¨è„šæœ¬æ‰§è¡ŒåŠ©æ‰‹

### å¼€å‘èƒŒæ™¯

åœ¨æ—¥å¸¸åšå®¢å†™ä½œè¿‡ç¨‹ä¸­ï¼Œæˆ‘é‡åˆ°äº†ä»¥ä¸‹é—®é¢˜ï¼š

1. ä½¿ç”¨ CleanShot X æˆªå›¾åï¼Œå›¾ç‰‡ä½“ç§¯è¾ƒå¤§ï¼Œéœ€è¦å‹ç¼©å¤„ç†
2. ä¸ºäº†ä¼˜åŒ–åšå®¢åŠ è½½é€Ÿåº¦ï¼Œéœ€è¦å°†å›¾ç‰‡è½¬æ¢ä¸º WebP æ ¼å¼
3. è™½ç„¶æœ‰ç°æˆçš„è„šæœ¬å¯ä»¥å¤„ç†è¿™äº›ä»»åŠ¡ï¼Œä½†æ¯æ¬¡éƒ½éœ€è¦ï¼š
   - æ‰“å¼€ç»ˆç«¯
   - åˆ‡æ¢åˆ°æ­£ç¡®çš„ç›®å½•
   - æ‰§è¡Œè„šæœ¬å‘½ä»¤
4. è¿™ä¸ªæµç¨‹å¾ˆç¹çï¼Œå½±å“å†™ä½œæ•ˆç‡

### è§£å†³æ–¹æ¡ˆ

å¼€å‘ä¸€ä¸ª VSCode æ’ä»¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. é€šè¿‡å³é”®èœå•ç›´æ¥å¤„ç†æ–‡ä»¶
2. æ”¯æŒè‡ªå®šä¹‰è„šæœ¬é…ç½®
3. ä¸é™äºå›¾ç‰‡å¤„ç†ï¼Œå¯ä»¥å¤„ç†ä»»ä½•æ–‡ä»¶ç±»å‹

### å…·ä½“å®ç°

1. é…ç½®æ–‡ä»¶è®¾è®¡ï¼š

```json
{
  "scriptRunner.scripts": {
    "compressImage": {
      "name": "å‹ç¼©å›¾ç‰‡",
      "command": "convert '${file}' -quality 85 -resize '1920x1080>' '${file}'",
      "fileTypes": [".png", ".jpg", ".jpeg"],
      "showInContextMenu": true
    },
    "convertToWebp": {
      "name": "è½¬æ¢ä¸ºWebP",
      "command": "cwebp -q 85 '${file}' -o '${file}.webp'",
      "fileTypes": [".png", ".jpg", ".jpeg"]
    },
    "formatMarkdown": {
      "name": "æ ¼å¼åŒ–Markdown",
      "command": "prettier --write '${file}'",
      "fileTypes": [".md"]
    }
  }
}
```

2. åŠ¨æ€æ³¨å†Œå‘½ä»¤ï¼š

```typescript
function registerScriptCommands(context: vscode.ExtensionContext) {
  const config = vscode.workspace.getConfiguration("scriptRunner");
  const scripts = config.get("scripts") as { [key: string]: ScriptConfig };

  Object.entries(scripts).forEach(([id, script]) => {
    const command = vscode.commands.registerCommand(
      `script-runner.${id}`,
      async (uri: vscode.Uri) => {
        await executeScript(uri, script);
      }
    );
    context.subscriptions.push(command);
  });
}
```

3. è„šæœ¬æ‰§è¡Œé€»è¾‘ï¼š

```typescript
async function executeScript(uri: vscode.Uri, script: ScriptConfig) {
  const filePath = uri.fsPath;
  const fileDir = path.dirname(filePath);

  // æ›¿æ¢å‘½ä»¤ä¸­çš„å˜é‡
  const command = script.command
    .replace(/\${file}/g, filePath)
    .replace(/\${fileDir}/g, fileDir);

  try {
    await vscode.window.withProgress(
      {
        location: vscode.ProgressLocation.Notification,
        title: `æ‰§è¡Œè„šæœ¬: ${script.name}`,
        cancellable: true,
      },
      async (progress, token) => {
        return new Promise((resolve, reject) => {
          const process = cp.exec(command, { cwd: fileDir }, (error) => {
            if (error) {
              reject(error);
              return;
            }
            resolve(null);
          });

          token.onCancellationRequested(() => {
            process.kill();
          });
        });
      }
    );

    vscode.window.showInformationMessage(`${script.name} æ‰§è¡ŒæˆåŠŸ`);
  } catch (error) {
    vscode.window.showErrorMessage(`${script.name} æ‰§è¡Œå¤±è´¥: ${error.message}`);
  }
}
```

### ä½¿ç”¨æ•ˆæœ

![20250114002138_4Zbq9P9q.webp](https://cdn.dong4j.site/source/image/20250114002138_4Zbq9P9q.webp)

1. åœ¨æ–‡ä»¶èµ„æºç®¡ç†å™¨ä¸­å³é”®å›¾ç‰‡æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°é…ç½®çš„è„šæœ¬å‘½ä»¤
2. ç‚¹å‡»å‘½ä»¤åï¼Œæ’ä»¶ä¼šï¼š
   - æ˜¾ç¤ºè¿›åº¦æç¤º
   - æ‰§è¡Œç›¸åº”çš„è„šæœ¬
   - æ˜¾ç¤ºæ‰§è¡Œç»“æœ

**é…ç½®**:

![20250114002252_E9ETIJxR.webp](https://cdn.dong4j.site/source/image/20250114002252_E9ETIJxR.webp)

### å¼€å‘å¿ƒå¾—

1. **é…ç½®é©±åŠ¨å¼€å‘**

   - é€šè¿‡é…ç½®æ–‡ä»¶å®šä¹‰è„šæœ¬ï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç 
   - ç”¨æˆ·å¯ä»¥æ ¹æ®éœ€æ±‚è‡ªå®šä¹‰è„šæœ¬
   - æ”¯æŒå¤šç§æ–‡ä»¶ç±»å‹å’Œå¤„ç†æ–¹å¼

2. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**

   - æ·»åŠ è¿›åº¦æç¤º
   - æ”¯æŒå–æ¶ˆæ“ä½œ
   - æ¸…æ™°çš„æˆåŠŸ/å¤±è´¥æç¤º

3. **æ‰©å±•æ€§è€ƒè™‘**

   - æ”¯æŒå˜é‡æ›¿æ¢
   - å¯é…ç½®å·¥ä½œç›®å½•
   - çµæ´»çš„æ–‡ä»¶ç±»å‹åŒ¹é…

4. **å®é™…æ”¶ç›Š**
   - å¤§å¤§æé«˜äº†å›¾ç‰‡å¤„ç†æ•ˆç‡
   - å‡å°‘äº†é‡å¤æ“ä½œ
   - æå‡äº†å†™ä½œä½“éªŒ

é€šè¿‡è¿™ä¸ªæ’ä»¶çš„å¼€å‘ï¼Œä¸ä»…è§£å†³äº†å®é™…é—®é¢˜ï¼Œä¹Ÿç§¯ç´¯äº† VSCode æ’ä»¶å¼€å‘çš„ç»éªŒã€‚å¸Œæœ›è¿™ä¸ªæ¡ˆä¾‹èƒ½ç»™æƒ³è¦å¼€å‘ VSCode æ’ä»¶çš„åŒå­¦ä¸€äº›å‚è€ƒã€‚

## [Chrome æ’ä»¶å¼€å‘å®æˆ˜ï¼šä»é›¶å¼€å§‹å¼€å‘ä¸€ä¸ªå›¾ç‰‡ä¸Šä¼ å·¥å…·](https://blog.dong4j.site/posts/af11d9f5.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![/images/cover/20250113235017_acCTt6s4.webp](https://cdn.dong4j.site/source/image/20250113235017_acCTt6s4.webp)

## ç®€ä»‹

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†ä»¥ä¸€ä¸ªå®é™…é¡¹ç›®ä¸ºä¾‹ï¼Œå¸¦ä½ ä»é›¶å¼€å§‹å­¦ä¹  Chrome æ’ä»¶å¼€å‘ã€‚æˆ‘ä»¬å°†å¼€å‘ä¸€ä¸ªå›¾ç‰‡ä¸Šä¼ å·¥å…·ï¼Œå®ƒèƒ½å¸®åŠ©åšä¸»å¿«é€Ÿå¤„ç†å’Œä¸Šä¼ å›¾ç‰‡ã€‚é€šè¿‡è¿™ä¸ªé¡¹ç›®ï¼Œä½ å°†å­¦ä¹ åˆ° Chrome æ’ä»¶å¼€å‘çš„åŸºç¡€çŸ¥è¯†å’Œå®æˆ˜æŠ€å·§ã€‚

## ä¸ºä»€ä¹ˆè¦å¼€å‘è¿™ä¸ªæ’ä»¶ï¼Ÿ

ä½œä¸ºä¸€åæŠ€æœ¯åšä¸»ï¼Œæˆ‘ç»å¸¸éœ€è¦åœ¨æ–‡ç« ä¸­æ’å…¥å›¾ç‰‡ã€‚æ¯æ¬¡å¤„ç†å›¾ç‰‡éƒ½éœ€è¦ç»è¿‡ä»¥ä¸‹æ­¥éª¤ï¼š

1. åœ¨ç½‘ä¸Šæ‰¾åˆ°åˆé€‚çš„å›¾ç‰‡
2. ä¸‹è½½åˆ°æœ¬åœ°
3. å‹ç¼©å›¾ç‰‡
4. è½¬æ¢æ ¼å¼
5. ä¸Šä¼ åˆ°å›¾åºŠ
6. å¤åˆ¶é“¾æ¥
7. æ’å…¥ Markdown æ ‡ç­¾

è¿™ä¸ªè¿‡ç¨‹ä¸ä»…è€—æ—¶ï¼Œè€Œä¸”æ¯æ·»åŠ ä¸€å¼ å›¾ç‰‡éƒ½è¦é‡å¤ä¸€éã€‚ä½œä¸ºä¸€ä¸ªç¨‹åºå‘˜ï¼Œæˆ‘è§‰å¾—è¿™ç§é‡å¤æ€§çš„å·¥ä½œåº”è¯¥è¢«è‡ªåŠ¨åŒ–ã€‚è¿™å°±æ˜¯æˆ‘å¼€å‘è¿™ä¸ª Chrome æ’ä»¶çš„åˆè¡·ã€‚

## è§£å†³æ–¹æ¡ˆï¼šChrome æ‰©å±•

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘å¼€å‘äº†ä¸€ä¸ª Chrome æ‰©å±•ï¼šImage Uploaderã€‚å®ƒèƒ½è®©ä½ é€šè¿‡ç®€å•çš„å³é”®ç‚¹å‡»å°±å®Œæˆä¸Šè¿°æ‰€æœ‰æ­¥éª¤ã€‚

### ä¸»è¦åŠŸèƒ½

![20250114002704_iki2zCGF.webp](https://cdn.dong4j.site/source/image/20250114002704_iki2zCGF.webp)

1. **ä¸€é”®ä¸Šä¼ **ï¼šå³é”®ç‚¹å‡»ç½‘é¡µä¸Šçš„ä»»ä½•å›¾ç‰‡ï¼Œé€‰æ‹©"ä¸Šä¼ å›¾ç‰‡"å³å¯
2. **è‡ªåŠ¨å‹ç¼©**ï¼šå¯é…ç½®çš„å›¾ç‰‡å‹ç¼©åŠŸèƒ½ï¼Œå¹³è¡¡å›¾ç‰‡è´¨é‡å’Œæ–‡ä»¶å¤§å°
3. **æ ¼å¼è½¬æ¢**ï¼šæ”¯æŒå°†å›¾ç‰‡è½¬æ¢ä¸º WebP æ ¼å¼ï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–åŠ è½½æ€§èƒ½
4. **å¤šè¯­è¨€æ”¯æŒ**ï¼šæ”¯æŒä¸­æ–‡å’Œè‹±æ–‡ç•Œé¢
5. **è‡ªå®šä¹‰é…ç½®**ï¼šå¯è®¾ç½®è‡ªå·±çš„å›¾åºŠ API åœ°å€
6. **å³æ—¶åé¦ˆ**ï¼šä¸Šä¼ å®Œæˆåä¼šæ˜¾ç¤ºé€šçŸ¥ï¼Œå¹¶è‡ªåŠ¨å¤åˆ¶ Markdown æ ¼å¼çš„å›¾ç‰‡é“¾æ¥

### æŠ€æœ¯å®ç°

ç›®å‰æˆ‘ä½¿ç”¨çš„ PicList çš„ API æ¥ä¸Šä¼ å›¾ç‰‡, æ‰€ä»¥æˆ‘çš„æ–¹æ³•å°±æ˜¯åœ¨æ’ä»¶ä¸­è®¾ç½®ä¸Šä¼  API, è¿™æ ·èƒ½å¤Ÿå…¼å®¹å¤§å¤šæ•°çš„å›¾åºŠ, æ¯”å¦‚ SM.MSã€Imgurã€é˜¿é‡Œäº‘ OSSã€è…¾è®¯äº‘ COS ç­‰, è¿™æ ·æˆ‘ä¹Ÿä¸éœ€è¦å†ä¸ºæ¯ä¸ªå›¾åºŠå†™ä¸€ä¸ªä¸Šä¼ æ–¹æ³•äº†,

æœ€é‡è¦çš„æ˜¯ä¸éœ€è¦ä¸ºæ¯ä¸ªå›¾åºŠæ·»åŠ ä¸åŒçš„è®¾ç½®, åªéœ€è¦è®¾ç½®ä¸€ä¸ªå›¾åºŠçš„ API å°±å¯ä»¥äº†, å›¾åºŠçš„é…ç½®æœ‰æœ¬åœ°çš„ä¸Šä¼ å·¥å…·è´Ÿè´£, æˆ‘åªéœ€è¦ä¼ ä¸€ä¸ªéœ€è¦ä¸Šä¼ çš„æ–‡ä»¶å’Œé…ç½®åå³å¯.

è¿™ä¸ªæ‰©å±•çš„æ ¸å¿ƒåŠŸèƒ½ä¸»è¦åŒ…æ‹¬ï¼š

1. **å›¾ç‰‡å¤„ç†**ï¼š

   - ä½¿ç”¨ Canvas API è¿›è¡Œå›¾ç‰‡å‹ç¼©
   - æ”¯æŒ WebP æ ¼å¼è½¬æ¢
   - ä¿æŒå›¾ç‰‡è´¨é‡çš„åŒæ—¶å‡å°æ–‡ä»¶ä½“ç§¯

2. **ç”¨æˆ·ç•Œé¢**ï¼š

   - ç®€æ´çš„è®¾ç½®é¡µé¢
   - ç°ä»£åŒ–çš„ UI è®¾è®¡
   - æ”¯æŒæ·±è‰²/æµ…è‰²ä¸»é¢˜

3. **åå°åŠŸèƒ½**ï¼š
   - å¼‚æ­¥ä¸Šä¼ å¤„ç†
   - è‡ªåŠ¨é‡è¯•æœºåˆ¶
   - é”™è¯¯å¤„ç†å’Œç”¨æˆ·æé†’

### ä½¿ç”¨æ•ˆæœ

ä½¿ç”¨è¿™ä¸ªæ‰©å±•åï¼Œä¹‹å‰ç¹ççš„å›¾ç‰‡å¤„ç†æµç¨‹ç®€åŒ–ä¸ºï¼š

1. åœ¨ç½‘é¡µä¸Šæ‰¾åˆ°åˆé€‚çš„å›¾ç‰‡
2. å³é”®ç‚¹å‡» -> é€‰æ‹©"ä¸Šä¼ å›¾ç‰‡"
3. è‡ªåŠ¨å®Œæˆå‹ç¼©ã€è½¬æ¢ã€ä¸Šä¼ 
4. å›¾ç‰‡é“¾æ¥è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿

æ•´ä¸ªè¿‡ç¨‹ä»åŸæ¥çš„å‡ åˆ†é’Ÿç¼©çŸ­åˆ°å‡ ç§’é’Ÿï¼Œæå¤§æé«˜äº†å†™ä½œæ•ˆç‡ã€‚

## Chrome æ’ä»¶å¼€å‘åŸºç¡€

### ä»€ä¹ˆæ˜¯ Chrome æ’ä»¶ï¼Ÿ

Chrome æ’ä»¶ï¼ˆChrome Extensionï¼‰æ˜¯ä¸€ä¸ªç”¨ Web æŠ€æœ¯ï¼ˆå¦‚ HTMLã€CSS å’Œ JavaScriptï¼‰æ„å»ºçš„è½¯ä»¶ç¨‹åºï¼Œå¯ä»¥å®šåˆ¶æµè§ˆå™¨åŠŸèƒ½å’Œè¡Œä¸ºã€‚å®ƒå°±åƒæ˜¯æµè§ˆå™¨çš„"å°åŠ©æ‰‹"ï¼Œèƒ½å¤Ÿå¢å¼ºæˆ‘ä»¬çš„æµè§ˆä½“éªŒã€‚

### æ’ä»¶çš„æ ¸å¿ƒç»„ä»¶

1. **manifest.json**ï¼šæ’ä»¶çš„é…ç½®æ–‡ä»¶ï¼Œå®šä¹‰äº†æ’ä»¶çš„å„ç§å±æ€§å’Œæƒé™

```json
{
  "manifest_version": 3,
  "name": "Image Uploader",
  "version": "1.0",
  "description": "Quick image upload tool for bloggers",
  "permissions": ["contextMenus", "storage", "notifications"],
  "action": {
    "default_popup": "popup.html"
  },
  "background": {
    "service_worker": "background.js"
  },
  "icons": {
    "16": "icons/icon16.png",
    "48": "icons/icon48.png",
    "128": "icons/icon128.png"
  }
}
```

2. **Background Script**ï¼šæ’ä»¶çš„åå°è„šæœ¬ï¼Œå¸¸é©»è¿è¡Œ

```javascript
// background.js
chrome.runtime.onInstalled.addListener(() => {
  // åˆ›å»ºå³é”®èœå•
  chrome.contextMenus.create({
    id: "uploadImage",
    title: "Upload Image",
    contexts: ["image"],
  });
});

// å¤„ç†å³é”®èœå•ç‚¹å‡»
chrome.contextMenus.onClicked.addListener((info, tab) => {
  if (info.menuItemId === "uploadImage") {
    // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
  }
});
```

3. **Popup**ï¼šç‚¹å‡»æ’ä»¶å›¾æ ‡æ—¶æ˜¾ç¤ºçš„å¼¹å‡ºçª—å£

```html
<!-- popup.html -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="popup.css" />
  </head>
  <body>
    <div class="popup-content">
      <h2>Image Uploader</h2>
      <button id="settings">Settings</button>
    </div>
    <script src="popup.js"></script>
  </body>
</html>
```

4. **Options Page**ï¼šæ’ä»¶çš„è®¾ç½®é¡µé¢

```html
<!-- options.html -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="options.css" />
  </head>
  <body>
    <div class="settings-form">
      <label>API Endpoint:</label>
      <input type="text" id="apiUrl" />
      <!-- å…¶ä»–è®¾ç½®é¡¹ -->
    </div>
    <script src="options.js"></script>
  </body>
</html>
```

### é‡è¦çš„ Chrome API

1. **chrome.contextMenus**ï¼šåˆ›å»ºå³é”®èœå•
2. **chrome.storage**ï¼šæ•°æ®å­˜å‚¨
3. **chrome.notifications**ï¼šæ˜¾ç¤ºé€šçŸ¥
4. **chrome.runtime**ï¼šå¤„ç†æ’ä»¶ç”Ÿå‘½å‘¨æœŸ

## å®æˆ˜ï¼šå¼€å‘å›¾ç‰‡ä¸Šä¼ æ’ä»¶

### 1. é¡¹ç›®ç»“æ„

```
image-uploader-extension/
â”œâ”€â”€ manifest.json      # é…ç½®æ–‡ä»¶
â”œâ”€â”€ background.js      # åå°è„šæœ¬
â”œâ”€â”€ popup.html         # å¼¹å‡ºçª—å£
â”œâ”€â”€ popup.js
â”œâ”€â”€ options.html      # è®¾ç½®é¡µé¢
â”œâ”€â”€ options.js
â”œâ”€â”€ i18n.js           # å›½é™…åŒ–
â”œâ”€â”€ icons/            # å›¾æ ‡
â””â”€â”€ _locales/         # è¯­è¨€æ–‡ä»¶
```

### 2. æ ¸å¿ƒåŠŸèƒ½å®ç°

#### 2.1 å›¾ç‰‡å‹ç¼©

```javascript
async function compressImage(imageUrl, quality) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      canvas.width = img.width;
      canvas.height = img.height;

      ctx.drawImage(img, 0, 0);

      canvas.toBlob((blob) => resolve(blob), "image/jpeg", quality / 100);
    };
    img.src = imageUrl;
  });
}
```

#### 2.2 WebP è½¬æ¢

```javascript
async function convertToWebP(blob) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      canvas.width = img.width;
      canvas.height = img.height;

      ctx.drawImage(img, 0, 0);

      canvas.toBlob((webpBlob) => resolve(webpBlob), "image/webp");
    };
    img.src = URL.createObjectURL(blob);
  });
}
```

#### 2.3 ä¸Šä¼ åŠŸèƒ½

```javascript
async function uploadImage(blob) {
  const formData = new FormData();
  formData.append("image", blob);

  const response = await fetch(apiUrl, {
    method: "POST",
    body: formData,
  });

  return await response.json();
}
```

### 3. ç”¨æˆ·ç•Œé¢è®¾è®¡

#### 3.1 è®¾ç½®é¡µé¢

æˆ‘ä»¬ä½¿ç”¨ç°ä»£çš„ UI æ¡†æ¶ï¼ˆTailwind CSSï¼‰æ¥æ„å»ºè®¾ç½®é¡µé¢ï¼š

```html
<div class="container mx-auto p-8">
  <div class="bg-white rounded-lg shadow-lg p-6">
    <h2 class="text-2xl font-bold mb-6">Settings</h2>

    <div class="space-y-6">
      <!-- API è®¾ç½® -->
      <div class="form-group">
        <label class="block text-gray-700 mb-2">API Endpoint</label>
        <input
          type="text"
          id="apiUrl"
          class="w-full px-4 py-2 border rounded-lg"
        />
      </div>

      <!-- å‹ç¼©è®¾ç½® -->
      <div class="form-group">
        <label class="block text-gray-700 mb-2"> Compression Quality </label>
        <input type="range" id="quality" min="1" max="100" value="80" />
        <span id="qualityValue">80%</span>
      </div>
    </div>
  </div>
</div>
```

#### 3.2 çŠ¶æ€é€šçŸ¥

ä½¿ç”¨ Chrome çš„é€šçŸ¥ API æä¾›å³æ—¶åé¦ˆï¼š

```javascript
function showNotification(title, message) {
  chrome.notifications.create({
    type: "basic",
    iconUrl: "icons/icon128.png",
    title: title,
    message: message,
  });
}
```

### 4. å›½é™…åŒ–æ”¯æŒ

#### 4.1 è¯­è¨€æ–‡ä»¶

```json
// _locales/en/messages.json
{
  "upload_success": {
    "message": "Image uploaded successfully!"
  },
  "upload_error": {
    "message": "Failed to upload image: $ERROR$",
    "placeholders": {
      "error": {
        "content": "$1"
      }
    }
  }
}
```

#### 4.2 ä½¿ç”¨ç¿»è¯‘

```javascript
function getMessage(key, substitutions) {
  return chrome.i18n.getMessage(key, substitutions);
}
```

## å¼€å‘æŠ€å·§å’Œæœ€ä½³å®è·µ

1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šå°†åŠŸèƒ½åˆ†æ•£åˆ°ä¸åŒæ–‡ä»¶ä¸­ï¼Œä¾¿äºç»´æŠ¤
2. **é”™è¯¯å¤„ç†**ï¼šæ·»åŠ é€‚å½“çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º
3. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨å¼‚æ­¥æ“ä½œå¤„ç†å›¾ç‰‡
   - åˆç†è®¾ç½®å‹ç¼©å‚æ•°
   - ç¼“å­˜å¸¸ç”¨æ•°æ®
4. **å®‰å…¨è€ƒè™‘**ï¼š
   - éªŒè¯ API å“åº”
   - é™åˆ¶æ–‡ä»¶å¤§å°
   - ä½¿ç”¨ HTTPS

## è°ƒè¯•æŠ€å·§

1. **ä½¿ç”¨ Chrome å¼€å‘è€…å·¥å…·**ï¼š

   - èƒŒæ™¯é¡µé¢è°ƒè¯•ï¼šchrome://extensions
   - æ§åˆ¶å°æ—¥å¿—
   - ç½‘ç»œè¯·æ±‚ç›‘æ§

2. **å¸¸è§é—®é¢˜è§£å†³**ï¼š
   - æƒé™é—®é¢˜ï¼šæ£€æŸ¥ manifest.json
   - è·¨åŸŸé—®é¢˜ï¼šæ·»åŠ é€‚å½“çš„æƒé™
   - èµ„æºåŠ è½½ï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„

## å‘å¸ƒæµç¨‹

1. **æ‰“åŒ…æ’ä»¶**ï¼š

   - å‹ç¼©ä»£ç 
   - ç”Ÿæˆ zip æ–‡ä»¶

2. **ä¸Šä¼ åˆ° Chrome Web Store**ï¼š
   - å‡†å¤‡æè¿°ææ–™
   - è®¾ç½®ä»·æ ¼ï¼ˆå…è´¹/ä»˜è´¹ï¼‰
   - ç­‰å¾…å®¡æ ¸

## é¡¹ç›®å®ä¾‹

å®Œæ•´çš„é¡¹ç›®ä»£ç å·²å¼€æºåœ¨ GitHubï¼š[image-uploader-extension](https://github.com/dong4j/image-uploader-extension)

å¦‚æœä½ ä¹Ÿç»å¸¸å†™åšå®¢ï¼Œæ¬¢è¿è¯•ç”¨è¿™ä¸ªæ‰©å±•ã€‚åŒæ—¶ï¼Œæˆ‘ä¹Ÿæ¬¢è¿å„ä½å¼€å‘è€…ï¼š

- æå‡ºå»ºè®®å’Œæ„è§
- è´¡çŒ®ä»£ç 
- æŠ¥å‘Šé—®é¢˜
- åˆ†äº«ä½¿ç”¨ä½“éªŒ

## æœªæ¥è®¡åˆ’

è¿™ä¸ªæ‰©å±•è¿˜æœ‰å¾ˆå¤šå¯ä»¥æ”¹è¿›çš„åœ°æ–¹ï¼Œæ¯”å¦‚ï¼š

1. ~~æ”¯æŒæ‰¹é‡ä¸Šä¼ ~~
2. æ·»åŠ æ›´å¤šå›¾ç‰‡å¤„ç†é€‰é¡¹
3. æ”¯æŒæ›´å¤šå›¾åºŠæœåŠ¡: å…¼å®¹æ›´å¤š API
4. ä¼˜åŒ–å‹ç¼©ç®—æ³•
5. æ·»åŠ ä¸Šä¼ å†å²è®°å½•

## æ‰©å±•é˜…è¯»

1. [Chrome æ–‡æ¡£](https://developer.chrome.com/docs?hl=zh-cn)
2. [Chrome æ‰©å±•å¼€å‘æ–‡æ¡£](https://developer.chrome.com/docs/extensions/)
3. [Manifest V3 è¿ç§»æŒ‡å—](https://developer.chrome.com/docs/extensions/mv3/intro/)

## ç»“è¯­

å¼€å‘ Chrome æ’ä»¶æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å­¦ä¹  Web æŠ€æœ¯çš„æœºä¼šã€‚é€šè¿‡è¿™ä¸ªé¡¹ç›®ï¼Œä½ ä¸ä»…èƒ½è§£å†³å®é™…é—®é¢˜ï¼Œè¿˜èƒ½æŒæ¡å¾ˆå¤šå®ç”¨çš„å¼€å‘æŠ€èƒ½ã€‚

å¸Œæœ›è¿™ç¯‡æ•™ç¨‹èƒ½å¸®åŠ©ä½ å¼€å§‹ Chrome æ’ä»¶å¼€å‘ä¹‹æ—…ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ GitHub ä¸Šæå‡º issue æˆ– PRã€‚

## [åˆ©ç”¨ AI å¯¹åšå®¢æ–‡ç« è¿›è¡Œæ™ºèƒ½åˆ†ç±»](https://blog.dong4j.site/posts/f5478013.md)

![/images/cover/20250103004028_E1ep6rty.webp](https://cdn.dong4j.site/source/image/20250103004028_E1ep6rty.webp)

åœ¨ä¸Šä¸€ç¯‡ [[generate-blog-tags-using-ai|AIåŠ©åŠ›åšå®¢åˆ›ä½œï¼šè‡ªåŠ¨ç”Ÿæˆæ‘˜è¦ä¸æ ‡ç­¾çš„å®æˆ˜æŒ‡å—]] ä¸­ä½¿ç”¨ AI è‡ªåŠ¨ç”Ÿæˆæ–‡ç« æ‘˜è¦å’Œ Tags, è¿™æ¬¡æˆ‘ä»¬ä¾æ—§åˆ©ç”¨ AI æ¥å¸®æˆ‘ä»¬ä¸ºæ–‡ç« è¿›è¡Œæ™ºèƒ½åˆ†ç±».

## ç†è§£åˆ†ç±»å’Œæ ‡ç­¾

### åˆ†ç±» (Categories)

åœ¨å›¾ä¹¦é¦†ä¸­ï¼Œæ¯æœ¬ä¹¦éƒ½ä¼šè¢«å½’å…¥ä¸€ä¸ªç‰¹å®šçš„åˆ†ç±»ã€‚æˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„å›¾ä¹¦é¦†åˆ†ç±»ç³»ç»Ÿï¼Œä¾‹å¦‚æœå¨åè¿›åˆ¶åˆ†ç±»æ³•ï¼Œä¾¿æ˜¯ä¾æ®ä¸»é¢˜å°†ä¹¦ç±è¿›è¡Œç³»ç»Ÿåˆ’åˆ†çš„å·¥å…·ã€‚æœå¨åˆ†ç±»æ³•å°†ä¹¦ç±åˆ’åˆ†ä¸ºåä¸ªä¸»è¦ç±»åˆ«ï¼ˆå¦‚å“²å­¦ã€ç¤¾ä¼šç§‘å­¦ã€è¯­è¨€å­¦ã€è‡ªç„¶ç§‘å­¦ç­‰ï¼‰ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šæ ¹æ®ä¸»é¢˜è¿›ä¸€æ­¥ç»†åˆ†ä¸ºå­ç±»ã€‚

å°†è¿™ä¸€æ¦‚å¿µç±»æ¯”è‡³åšå®¢åˆ†ç±»ï¼Œå¯ä»¥è§†ä½œä¸€ç§ç±»ä¼¼å›¾ä¹¦é¦†çš„åˆ†ç±»ä½“ç³»ï¼Œæ—¨åœ¨å°†æ–‡ç« æŒ‰ç…§ä¸»é¢˜è¿›è¡Œæœ‰åºç»„ç»‡ã€‚ä¾‹å¦‚ï¼Œâ€œç¼–ç¨‹æŠ€æœ¯â€ä½œä¸ºä¸€ä¸ªä¸»è¦ç±»åˆ«ï¼Œç±»ä¼¼äºå›¾ä¹¦é¦†ä¸­çš„â€œæŠ€æœ¯ç§‘å­¦ç±»â€ï¼Œåœ¨æ­¤ä¸»ç±»åˆ«ä¸‹ï¼Œåˆå¯ç»†åˆ†ä¸ºâ€œå‰ç«¯å¼€å‘â€ã€â€œåç«¯å¼€å‘â€ã€â€œæ•°æ®åº“â€ç­‰å­åˆ†ç±»ï¼Œè¿™ä¸å›¾ä¹¦é¦†çš„å­ç±»ç³»ç»Ÿé¢‡ä¸ºç›¸ä¼¼ã€‚

**ä¸»è¦ç‰¹ç‚¹**ï¼š

- **å±‚æ¬¡æ„Ÿå¼º**ï¼šä¸€ä¸ªå¤§ç±»ä¸‹å¯ä»¥æœ‰å¤šä¸ªå­åˆ†ç±»ï¼Œæ¯”å¦‚ â€œç¼–ç¨‹â€ ä¸‹é¢å¯ä»¥å†åˆ†æˆ â€œJavaâ€ã€â€œPythonâ€ ç­‰ã€‚
- **ä¸€ä¸ªåˆ†ç±»ä¸ºä¸»**ï¼šæ¯ç¯‡æ–‡ç« é€šå¸¸ä¼šå½’å…¥ä¸€ä¸ªä¸»è¦çš„åˆ†ç±»ï¼Œå¸®åŠ©è¯»è€…æ˜ç¡®æ–‡ç« çš„æ ¸å¿ƒä¸»é¢˜ã€‚

**ä½œç”¨**ï¼š

- **å¸®åŠ©è¯»è€…å¯¼èˆª**ï¼šè®©äººä¸€è¿›æ¥å°±çŸ¥é“æ–‡ç« è®²çš„æ˜¯å“ªä¸ªå¤§æ–¹å‘ã€‚
- **SEO åŠ åˆ†**ï¼šæœç´¢å¼•æ“æ›´å®¹æ˜“ææ¸…æ¥šä½ çš„ç½‘ç«™æ¶æ„ï¼Œåˆ©äºæå‡æ’åã€‚

**ç¤ºä¾‹**ï¼š

- **[é˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿—](http://www.ruanyifeng.com/blog/)**ï¼šé˜®ä¸€å³°çš„åšå®¢åˆ†ç±»æ¸…æ™°ï¼Œæ¯”å¦‚ â€œç§‘æŠ€â€ã€â€œç¿»è¯‘â€ã€â€œç¼–ç¨‹â€ ç­‰ï¼Œå¸®åŠ©è¯»è€…å¿«é€Ÿæ‰¾åˆ°æ„Ÿå…´è¶£çš„å†…å®¹ã€‚

  ![20250102230848_dVi8wHDq.webp](https://cdn.dong4j.site/source/image/20250102230848_dVi8wHDq.webp)

- **[å»–é›ªå³°çš„å®˜æ–¹ç½‘ç«™](https://www.liaoxuefeng.com/)**ï¼šå»–é›ªå³°çš„ç«™ç‚¹åˆ†ç±»ä»¥ â€œPythonâ€ã€â€œGitâ€ ç­‰æŠ€æœ¯å†…å®¹ä¸ºä¸»ï¼Œæ¯ä¸ªå¤§ç±»ä¸‹éƒ½æœ‰ä¸°å¯Œçš„æ•™ç¨‹ã€‚

  ![20250102230848_FMBK4Gkd.webp](https://cdn.dong4j.site/source/image/20250102230848_FMBK4Gkd.webp)

---

### æ ‡ç­¾ (Tags)

é™¤äº†æŒ‰ç±»åˆ«åˆ†ç±»ï¼Œå›¾ä¹¦é¦†è¿˜ä¼šç»™æ¯æœ¬ä¹¦æ‰“ä¸Šå…³é”®è¯ï¼Œç”¨æ¥æè¿°ä¹¦çš„å†…å®¹å’Œç‰¹ç‚¹ã€‚è¿™äº›å…³é”®è¯å¯ä»¥å¸®åŠ©è¯»è€…ä»å¤šä¸ªè§’åº¦å»æœç´¢å’ŒæŸ¥æ‰¾ä¹¦ç±ï¼Œ**ä¸»é¢˜è¯è¡¨**ï¼ˆä¹Ÿç§°ä¸º â€œæ ‡å¼•â€ï¼‰å°±æ˜¯èµ·åˆ°è¿™æ ·çš„ä½œç”¨ã€‚æ¯”å¦‚ä¸€æœ¬ä¹¦å¯èƒ½æ—¢å’Œâ€œäººå·¥æ™ºèƒ½â€ æœ‰å…³ï¼Œåˆå’Œ â€œæ·±åº¦å­¦ä¹ â€ æœ‰å…³ï¼Œé‚£ä¹ˆå›¾ä¹¦é¦†ä¼šç»™å®ƒåŒæ—¶æ‰“ä¸Š â€œäººå·¥æ™ºèƒ½â€ã€â€œæ·±åº¦å­¦ä¹ â€ è¿™ä¸¤ä¸ªä¸»é¢˜è¯ã€‚

**ç±»æ¯”åˆ°åšå®¢æ ‡ç­¾**å°±åƒå›¾ä¹¦é¦†ç»™ä¹¦ç±æ‰“çš„å…³é”®è¯ï¼Œå®ƒä»¬æ²¡æœ‰å±‚æ¬¡å…³ç³»ï¼Œä½†èƒ½ä»ä¸åŒç»´åº¦æè¿°æ–‡ç« çš„å†…å®¹ã€‚æ¯”å¦‚ä¸€ç¯‡å…³äº â€œPython çˆ¬è™«â€ çš„æ–‡ç« ï¼Œå¯èƒ½æ‰“ä¸Š â€œPythonâ€ã€â€œçˆ¬è™«â€ã€â€œæ•°æ®æŠ“å–â€ ç­‰å¤šä¸ªæ ‡ç­¾ï¼Œè¿™æ ·è¯»è€…å¯ä»¥é€šè¿‡ä»»æ„ä¸€ä¸ªæ ‡ç­¾æ‰¾åˆ°æ–‡ç« ã€‚

**ç‰¹ç‚¹**ï¼š

- **å¹³é¢åŒ–ï¼Œæ²¡æœ‰å±‚æ¬¡**ï¼šæ ‡ç­¾ä¸åƒåˆ†ç±»é‚£æ ·æœ‰çˆ¶å­ç»“æ„ï¼Œæ‰€æœ‰æ ‡ç­¾æ˜¯å¹³ç­‰çš„ã€‚
- **ä¸€ç¯‡æ–‡ç« å¯ä»¥æœ‰å¤šä¸ªæ ‡ç­¾**ï¼šæ ‡ç­¾æ›´å¤šæ˜¯å¸®ä½œè€…ä»å¤šä¸ªè§’åº¦æ¥æè¿°æ–‡ç« çš„å†…å®¹ã€‚

**ä½œç”¨ï¼š**

- **æ–¹ä¾¿ç”¨æˆ·æŸ¥æ‰¾**ï¼šè¯»è€…é€šè¿‡æ ‡ç­¾ï¼Œå¯ä»¥æ‰¾åˆ°æ›´å¤šç›¸ä¼¼ä¸»é¢˜çš„æ–‡ç« ï¼Œä½“éªŒä¼šå¥½å¾ˆå¤šã€‚
- **æå‡æœç´¢ä¼˜åŒ–**ï¼šå¤šæ‰“ä¸€äº›æ ‡ç­¾ï¼Œä¹Ÿèƒ½è®©æœç´¢å¼•æ“æ›´å®¹æ˜“æŠ“å–åˆ°ä½ çš„æ–‡ç« å†…å®¹ã€‚

## åˆ†ç±»å’Œæ ‡ç­¾çš„åŒºåˆ«

**åˆ†ç±»å’Œæ ‡ç­¾çš„å…³ç³»**æœ‰ç‚¹åƒä¸»èœå’Œé…èœã€‚åˆ†ç±»æ˜¯ä¸»çº¿ï¼Œæ˜ç¡®è¯´æ˜è¿™ç¯‡æ–‡ç« å±äºå“ªä¸ª â€œèœç³»â€ï¼Œæ¯”å¦‚â€œç¼–ç¨‹â€ã€â€œäº§å“ç®¡ç†â€ï¼›è€Œæ ‡ç­¾åˆ™æ˜¯é™„åŠ çš„è°ƒå‘³æ–™ï¼Œè¯´æ˜è¿™é“â€œèœâ€ æœ‰å“ªäº›ç‰¹ç‚¹ï¼Œæ¯”å¦‚â€œPythonâ€ã€â€œæ•ˆç‡å·¥å…·â€ã€‚

- **åˆ†ç±»**æ˜¯ç»“æ„åŒ–çš„ã€å±‚æ¬¡æ„Ÿå¼ºçš„ï¼Œç”¨æ¥åˆ’åˆ†å¤§çš„å†…å®¹æ¨¡å—ã€‚
- **æ ‡ç­¾**æ˜¯çµæ´»çš„ï¼Œç”¨æ¥æè¿°æ–‡ç« çš„ç»†èŠ‚å’Œå…·ä½“å†…å®¹ï¼Œé€šå¸¸ç”¨æ¥è¡¥å……åˆ†ç±»æ— æ³•è¦†ç›–åˆ°çš„å¤šç»´åº¦ä¿¡æ¯ã€‚

**ä¸¾ä¸ªä¾‹å­**ï¼šä¸€ç¯‡ä»‹ç»ç”¨ Python å†™çˆ¬è™«çš„æ–‡ç« ï¼Œåˆ†ç±»å¯èƒ½æ˜¯ â€œç¼–ç¨‹æŠ€æœ¯ - Pythonâ€ï¼Œè€Œæ ‡ç­¾å¯ä»¥æ˜¯â€œPythonâ€ã€â€œçˆ¬è™«â€ã€â€œæ•°æ®æŠ“å–â€ ç­‰ï¼Œè¿™æ ·è¯»è€…æ—¢èƒ½é€šè¿‡åˆ†ç±»æ‰¾åˆ°è¿™ç¯‡æ–‡ç« ï¼Œä¹Ÿèƒ½é€šè¿‡æ ‡ç­¾æ‰¾åˆ°ç›¸å…³çš„æ–‡ç« ã€‚

## å¦‚ä½•è®¾è®¡è‡ªå·±çš„åˆ†ç±»å’Œæ ‡ç­¾

æœ€å¼€å§‹ä¹Ÿæ²¡æœ‰å¤ªå¤šçš„æ€è·¯ï¼Œæ‰€ä»¥å°±å»çœ‹çœ‹å¥½çš„åšå®¢ç½‘ç«™æ€ä¹ˆåšçš„ï¼›

è¿™é‡Œæ¨èä¸€ä¸ªå¼€æºé¡¹ç›®ï¼š[ä¸­æ–‡ç‹¬ç«‹åšå®¢åˆ—è¡¨](https://github.com/timqian/chinese-independent-blogs)ï¼Œè¿™é‡Œé¢è®°å½•äº†å¤§é‡çš„ä¸­æ–‡ç‹¬ç«‹åšå®¢ç½‘ç«™ï¼›

ç®€å•æ€»ç»“ä¸€ä¸‹ï¼š

**åˆ†ç±»è¦ç®€æ´æ¸…æ™°**ï¼šåˆ†ç±»ä¸å®œè¿‡å¤šï¼Œä¹Ÿä¸è¦å¤ªä¹±ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œ**10 ä¸ªå·¦å³çš„å¤§åˆ†ç±»**æ¯”è¾ƒåˆé€‚ï¼Œæœ€å¥½ä¸€çœ¼å°±èƒ½çœ‹æ‡‚ã€‚æ¯ä¸ªå¤§åˆ†ç±»å¯ä»¥æœ‰å‡ å±‚å­åˆ†ç±»ï¼Œè¿™æ ·ä¹Ÿæ›´æœ‰æ¡ç†ã€‚

**æ ‡ç­¾è¦çµæ´»ä¸°å¯Œ**ï¼šæ ‡ç­¾æ²¡æœ‰æ•°é‡é™åˆ¶ï¼Œå¯ä»¥æ ¹æ®æ¯ç¯‡æ–‡ç« çš„å†…å®¹çµæ´»æ·»åŠ ã€‚æƒ³æƒ³è¯»è€…å¯èƒ½ä¼šç”¨å“ªäº›å…³é”®è¯æ¥æŸ¥æ‰¾è¿™ç¯‡æ–‡ç« ï¼Œç„¶åç”¨è¿™äº›è¯ä½œä¸ºæ ‡ç­¾ã€‚

**åˆ†ç±»å’Œæ ‡ç­¾çš„ç»“åˆ**æ˜¯æœ€æœ‰æ•ˆçš„ç»„ç»‡æ–¹å¼ï¼šåˆ†ç±»å¸®åŠ©æ¢³ç†å¤§çš„ç»“æ„ï¼Œæ ‡ç­¾åˆ™å¸®åŠ©è¦†ç›–åˆ°æ›´å¤šå†…å®¹ç»†èŠ‚ã€‚

**ä¸¾ä¸ªä¾‹å­**ï¼š

- **ç¼–ç¨‹æŠ€æœ¯**
- **ç”Ÿæ´»æ„Ÿæ‚Ÿ**
- **äº§å“ç»ç†**
- **åšå®¢å»ºç«™**
- **æ•°æ®ç§‘å­¦**

åœ¨**ç¼–ç¨‹æŠ€æœ¯**ä¸‹ï¼Œå¯ä»¥ç»†åˆ†æˆ**å‰ç«¯å¼€å‘**ã€**åç«¯å¼€å‘**ã€**ç§»åŠ¨å¼€å‘**ï¼Œç„¶åæ¯ç¯‡æ–‡ç« å†æ‰“ä¸Šå…·ä½“çš„æ ‡ç­¾ã€‚æ¯”å¦‚ä¸€ç¯‡æ–‡ç« å…³äºç”¨ Vue.js å†™å‰ç«¯é¡¹ç›®ï¼Œåˆ†ç±»æ˜¯**ç¼–ç¨‹æŠ€æœ¯ - å‰ç«¯å¼€å‘**ï¼Œæ ‡ç­¾å¯ä»¥æ˜¯ **Vue.js**ã€**JavaScript**ã€**å‰ç«¯ä¼˜åŒ–**ã€‚

```
ä»¥ä¸Šæ˜¯æ¥è‡ªä¸‹é¢çš„ä½œè€…çš„åšå®¢å†…å®¹
====================================
æ–‡ç« ä½œè€…ï¼š MinChess
æ–‡ç« æ¥æºï¼š ä¹é™Œæ–‹â€”MinChess's Blog
æ–‡ç« é“¾æ¥ï¼š https://blog.jiumoz.com/archives/bo-ke-wen-zhang-zen-me-she-ji-fen-lei-yu-biao-qian
ç‰ˆæƒå£°æ˜ï¼š å†…å®¹éµå¾ª CC 4.0 BY-SA ç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚
```

---

## æˆ‘çš„åˆ†ç±»è®¾è®¡

å¤§æ¦‚å‚è€ƒäº†ä¸€ä¸‹åˆ«äººçš„åˆ†ç±»å·²ç»å¯¹è‡ªå·±ä»Šåéœ€è¦ä¸»æ”»çš„æ–¹å‘å, å°†ç°åœ¨çš„åšæ–‡æš‚æ—¶åˆ†ä¸ºä¸€ä¸‹å‡ ç±»:

| åˆ†ç±»åç§°                   | å†…å®¹æè¿°                                                                                |
| -------------------------- | --------------------------------------------------------------------------------------- |
| æ–°æ—¶ä»£ç å†œ                 | åªè¦æ˜¯æ¶‰åŠåˆ°å¼€å‘ç›¸å…³çš„åšå®¢, éƒ½åˆ’åˆ†åˆ°æ­¤åˆ†ç±»ä¸‹, ä¸å†åˆ’åˆ†å¦‚ Java, ä¸­é—´ä»¶, æ•°æ®åº“ç­‰ç»†åˆ†åˆ†ç±» |
| HomeLab:ä¸­å¹´ç”·äººçš„å¿«ä¹æºæ³‰ | HomeLab ç›¸å…³çš„æ–‡ç«                                                                       |
| AI:äººå·¥æ™ºèƒ½                | AI, LLM, RAG, AIGC ç­‰ç›¸å…³çš„æ–‡ç«                                                          |
| ç”Ÿæ´»:ç”Ÿä¸‹æ¥æ´»ä¸‹å»          | ä¸ªäººç”Ÿæ´»è®°å½•                                                                            |
| è½¬è½½å†…å®¹                   | è½¬è½½çš„ä¼˜ç§€åšæ–‡                                                                          |
| ç»éªŒåˆ†äº«                   | åˆ†äº«è‡ªå·±çš„ç»éªŒæ€»ç»“                                                                      |
| æˆ‘çš„é¡¹ç›®                   | è®°å½•è‡ªå·±çš„å¼€æºé¡¹ç›®                                                                      |
| é—²èŠæ‚è°ˆ                   | æƒ³åˆ°ä»€ä¹ˆå†™ä»€ä¹ˆ                                                                          |
| è½¯ä»¶æ¨è                   | æ¨èç”¨ç€é¡ºæ‰‹çš„è½¯ä»¶                                                                      |
| å¥½ç‰©æ¨è                   | æ¨èç”¨ç€é¡ºæ‰‹çš„å·¥å…·                                                                      |
| ç¿»è¯‘å†…å®¹                   | å­¦ä¹ ä¸€ä¸‹è‹±è¯­, ç¿»è¯‘ä¸€ä¸‹å¤–ç½‘ä¼˜ç§€çš„åšæ–‡                                                    |

## ä½¿ç”¨ AI å¯¹æ–‡ç« è¿›è¡Œåˆ†ç±»

åœ¨ä¸Šä¸€ç¯‡ [[generate-blog-tags-using-ai|AIåŠ©åŠ›åšå®¢åˆ›ä½œï¼šè‡ªåŠ¨ç”Ÿæˆæ‘˜è¦ä¸æ ‡ç­¾çš„å®æˆ˜æŒ‡å—]] ä½¿ç”¨çš„æ˜¯ Ollama, ä½†æ˜¯å› ä¸ºæ¨¡å‹çš„åŸå› ç”Ÿæˆçš„ç»“æœä¸æ˜¯ç‰¹åˆ«æ»¡æ„, æ‰€ä»¥è¿™æ¬¡ä½¿ç”¨ [LM Studio](https://lmstudio.ai/) ä½œä¸ºæœåŠ¡ç«¯ä¸ºè„šæœ¬æä¾› AI æœåŠ¡, æ¨¡å‹é€‰æ‹©çš„æ˜¯ [glm-4-9b-chat-1m](https://huggingface.co/bartowski/glm-4-9b-chat-1m-GGUF), ä½¿ç”¨çš„æ˜¯ **F16** çš„ç‰ˆæœ¬. æ¨¡å‹æœ‰ **18.97GB**, åœ¨ 64G å†…å­˜çš„ Macbook Pro Apple M1 Max è·‘èµ·æ¥è¿˜ç®—æµç•…, ä¸å¾—ä¸ç§°èµä¸€ä¸‹ Apple M ç³»åˆ—çš„èŠ¯ç‰‡, åªæœ‰åœ¨è·‘æ¨¡å‹çš„æ—¶å€™æ‰ä¼šçƒ«æ‰‹, å…¶ä»–æ—¶å€™éƒ½éå¸¸å®‰é™.

åœ¨ä½¿ç”¨æ¨¡å‹æ—¶, GPU åŸºæœ¬ä¸Šéƒ½æ˜¯ 100%:

![20250102025931_CKM98ncG.webp](https://cdn.dong4j.site/source/image/20250102025931_CKM98ncG.webp)

macOS æœ¬åœ°è·‘æ¨¡å‹çš„è¯æ¯”è¾ƒæ¨èä½¿ç”¨ LM Studio, æ¨¡å‹ä¸‹è½½, æœ¬åœ°æœåŠ¡, OpenAI API å…¼å®¹æ¥å£ç­‰ç­‰å¸¸è§„åŠŸèƒ½ä¸€åº”ä¿±å…¨:

![20250102190449_IrQ3oZvd.webp](https://cdn.dong4j.site/source/image/20250102190449_IrQ3oZvd.webp)

### éœ€æ±‚æ•´ç†

1. æä¾›è‡ªåŠ¨å’Œæ‰‹åŠ¨ 2 ç§æ–¹å¼, è‡ªåŠ¨åˆ™è°ƒç”¨ AI ç›´æ¥ä½¿ç”¨æ¨èçš„åˆ†ç±»æ›¿ä»£å½“å‰çš„åˆ†ç±», æ‰‹åŠ¨çš„è¯åˆ™é€šè¿‡äº¤äº’æ–¹å¼é€‰æ‹©åˆ†ç±»;
2. å› ä¸º AI ç”Ÿæˆæ¨èçš„åˆ†ç±»éœ€è¦ä¸€å®šæ—¶é—´, äº¤äº’å¼ä¹Ÿéœ€è¦æ—¶é—´å»åˆ¤æ–­é€‰æ‹©, æ‰€ä»¥éœ€è¦ä½¿ç”¨ 2 ä¸ªçº¿ç¨‹æ‰§è¡Œè¿™ 2 ä¸ªæ“ä½œ, é¿å…ç­‰å¾…æ—¶é—´è¿‡é•¿;
3. æä¾›ä¸€ä¸ªé¢å¤–çš„æ–‡æœ¬è®°å½•å·²è¢«å¤„ç†è¿‡çš„æ–‡ä»¶, é¿å…é‡å¤å¤„ç†;

### å®ç°

#### generate_category.py

åŸºäºä¸Šè¿°éœ€æ±‚, ä½¿ç”¨ python å†™ä¸€ä¸ªç®€å•çš„è„šæœ¬:

```python
from pydantic import BaseModel
from openaiapi.client import generate as client_openaiapi
from ollama.client import generate as client_ollama
import unittest
import json
from utils import clean_md_whitespace

class Document(BaseModel):
    recommend: str
    options: list[str]

def generate(content, type="openaiapi", auto_replace=True):
    categories ={
        "options": [
            "æ–°æ—¶ä»£ç å†œ",
            "HomeLab:ä¸­å¹´ç”·äººçš„å¿«ä¹æºæ³‰",
            "AI:äººå·¥æ™ºèƒ½",
            "ç”Ÿæ´»:ç”Ÿä¸‹æ¥æ´»ä¸‹å»",
            "è½¬è½½å†…å®¹",
            "ç»éªŒåˆ†äº«",
            "æˆ‘çš„é¡¹ç›®",
            "é—²èŠæ‚è°ˆ",
            "è½¯ä»¶æ¨è",
            "å¥½ç‰©æ¨è",
            "ç¿»è¯‘å†…å®¹"
        ]
    }
    if not auto_replace:
        return json.dumps(categories)

    # æ„é€  prompt
    prompt = f"""
    è¯·æ ¹æ®æˆ‘æä¾›ç»™ä½ çš„åšå®¢å†…å®¹çš„æ ¸å¿ƒä¸»é¢˜ä¸ºå…¶é€‰æ‹©ä¸€ä¸ªæœ€åˆé€‚çš„æ–‡ç« åˆ†ç±»ã€‚
    é™„åŠ è¯´æ˜ï¼š
    1. ç”Ÿæˆçš„åˆ†ç±»å¿…é¡»æ˜¯æˆ‘ç»™å®šçš„ä»¥ä¸‹å‡ ä¸ªé€‰é¡¹ä¹‹ä¸€:
        {categories['options']}
    2. å¦‚æœæ¶‰åŠåˆ°ç¼–ç¨‹ä¸å¼€å‘ç›¸å…³çš„å…³é”®å­—, æ¯”å¦‚ Java, Spring, Redis, Rabbitmq, SQL, MySQL, JVMç­‰, å…¨éƒ¨åˆ’åˆ†åˆ° 'æ–°æ—¶ä»£ç å†œ' è¿™ä¸ªåˆ†ç±»ã€‚
    3. ä½ å¿…é¡»ä»¥JSONæ ¼å¼å“åº”ï¼Œé”®ä¸º'recommend'ï¼Œå€¼æ˜¯å­—ç¬¦ä¸²æ ¼å¼çš„åˆ†ç±»åç§°, é”®ä¸º'options'ï¼Œå€¼æ˜¯æˆ‘ç»™å®šçš„åˆ†ç±»åˆ—è¡¨ã€‚
    """

    if type == "openaiapi":
        return client_openaiapi(prompt, content, response_format=Document)
    elif type == "ollama":
        prompt = prompt + f"""
        è¯·åˆ†æ'CONTENT START HERE'å’Œ'CONTENT END HERE'ä¹‹é—´çš„æ–‡æœ¬

        CONTENT START HERE

        {content}

        CONTENT END HERE
        """
        return client_ollama(prompt)
```

å¾—ç›Šäº [OpenAI API çš„ç»“æ„åŒ–è¾“å‡º](https://platform.openai.com/docs/guides/structured-outputs), æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰æœ€ç»ˆè¿”å›çš„ç»“æ„:

```python
class Document(BaseModel):
    recommend: str
    options: list[str]
```

- `recommend`: AI ç”Ÿæˆçš„æ¨èåˆ†ç±»;
- `options`: æˆ‘çš„æ–‡ç« åˆ†ç±»;

ä¸Šè¿°ä»£ç ä¼šæŒ‰ç…§æˆ‘ç»™å®šçš„ç»“æ„è¿”å›æœ€ç»ˆç»“æœ, æˆ‘ä»¬åªéœ€è¦æ ¹æ®è§„åˆ™æå–æŒ‡å®šå­—æ®µå³å¯.

è¿™é‡Œè¿˜ç®€å•çš„åˆ†è£…äº†ä¸€ä¸‹ `Ollama` å’Œ `OpenAPI API`, ä¸€ä¸ªæ˜¯ä¸ºäº†å…¼å®¹å…¶ä»–è„šæœ¬, äºŒæ˜¯æƒ³æµ‹è¯•ä¸€ä¸‹ä¸åŒçš„æœåŠ¡æä¾›è€…å¯¹æç¤ºè¯çš„å“åº”åŒºåˆ«:

#### LLM API

##### Ollama Client

```python
import requests

def generate(prompt, model="qwen2"):
    # è®¾ç½® Ollama API çš„ URL
    url = f"http://localhost:11434/api/generate"
    data = {
        "model": model,
        "prompt": prompt,
        "format": "json",
        "stream": False
    }

    # å‘é€ POST è¯·æ±‚åˆ° Ollama API
    try:
        response = requests.post(url, json=data, stream=False)
        response.raise_for_status()  # æ£€æŸ¥è¯·æ±‚æ˜¯å¦æˆåŠŸ
        data = response.json()

        # æå–ç”Ÿæˆçš„æ‘˜è¦
        if "response" in data:
            return data["response"]
        else:
            print("æ²¡æœ‰ä»å“åº”ä¸­è·å–åˆ°æ‘˜è¦å†…å®¹ï¼")
            return None
    except requests.exceptions.RequestException as e:
        print(f"è¯·æ±‚å¤±è´¥: {e}")
        return None
```

##### OpenAI API

```python
from openai import OpenAI

def generate(prompt, content, usemodel="glm-4-9b-chat-1m", response_format=None):
    client = OpenAI(base_url="http://localhost:1234/v1", api_key="lm-studio")

    completion = client.beta.chat.completions.parse(
        model=usemodel,
        messages=[
            {"role": "system", "content": prompt},
            {"role": "user", "content": content}
        ],
        temperature=0.7,  # æ ¹æ®éœ€è¦è°ƒæ•´è¿™ä¸ªå‚æ•°
        response_format=response_format,  # åŠ¨æ€ä¼ å…¥çš„æ ¼å¼
    )
    return completion.choices[0].message.content
```

#### replace_category.py

æœ€åæ˜¯æ›¿æ¢åˆ†ç±»çš„è„šæœ¬:

```python
import os
import sys
import time
import json
import threading
import queue
from utils import log, get_process_md_files, split_md, dump_md_yaml, clean_md_whitespace, get_md_category, save_processed_file, load_processed_files
from generate_category import generate as generate_category_from_ai

# é…ç½®è·¯å¾„
PROCESSED_FILE = "./processed_category_files.txt"  # å·²å¤„ç†çš„æ–‡ä»¶è®°å½•

# å…¨å±€é˜Ÿåˆ—
task_queue = queue.Queue()
result_queue = queue.Queue()

def fetch_category_from_ai(md_file, auto_replace111):
    """
    è°ƒç”¨ ai æ¥å£ç”Ÿæˆåˆ†ç±»ã€‚
    è¿™æ˜¯å ä½å‡½æ•°ï¼Œå…·ä½“é€»è¾‘è¯·å®ç°åæ›¿æ¢ã€‚
    """
    content = clean_md_whitespace(md_file)
    # print(blog_content)
    category = generate_category_from_ai(content, auto_replace=auto_replace111)
    if category:
        return json.loads(category)
    return None

def replace_md_category(md_file, original_categorie, new_category):
    # è°ƒç”¨å‡½æ•°å¹¶è·å– body å’Œ data
    result = split_md(md_file)
    if not result:
        return

    data = result['data']
    body = result['body']

    # æ›¿æ¢ categories
    data['categories'] = [new_category]
    dump_md_yaml(md_file, data, body)  # ä¿å­˜æ›´æ–°åçš„ YAML å’Œ body

    log(f"ä¿®æ”¹åˆ†ç±»: {md_file}")
    log(f"{original_categorie} -> {new_category}")


def ai_worker(auto_replace):
    """
    è´Ÿè´£è°ƒç”¨ ai çš„çº¿ç¨‹ã€‚
    """
    while True:
        md_file = task_queue.get()
        if md_file is None:  # æ£€æŸ¥æ˜¯å¦ç»“æŸ
            break
        data = fetch_category_from_ai(md_file, auto_replace)
        result_queue.put((md_file, data))
        task_queue.task_done()

def interactive_worker(auto_replace):
    """
    è´Ÿè´£äº¤äº’å¼å¤„ç†çš„çº¿ç¨‹ã€‚
    """
    processed_files = load_processed_files(PROCESSED_FILE)

    while True:
        md_file, data = result_queue.get()

        if data is None:  # æ ‡è¯†å½“å‰ä»»åŠ¡è¿˜æœªå®Œæˆï¼Œé˜»å¡ç­‰å¾…
            log(f"æ­£åœ¨ç­‰å¾…ä¸º {md_file} ç”Ÿæˆåˆ†ç±»...")
            result_queue.put((md_file, None))  # é‡æ–°å°†ä»»åŠ¡æ”¾å›é˜Ÿåˆ—ä»¥ç­‰å¾…ç”Ÿæˆå®Œæˆ
            time.sleep(1)  # ç­‰å¾…ç‰‡åˆ»å†æ£€æŸ¥
            continue

        if not data:  # å¦‚æœæ˜ç¡®è¿”å›ç©ºåˆ—è¡¨ï¼Œè¯´æ˜åˆ†ç±»ç”Ÿæˆå¤±è´¥
            log(f"æœªç”Ÿæˆåˆ†ç±»ï¼Œè·³è¿‡ {md_file}")
            continue

        original_category = get_md_category(md_file)

        if auto_replace:
            # æå–åˆ†ç±»åˆ—è¡¨
            new_category = data.get("recommend", '')
            replace_md_category(md_file, original_category, new_category)
        else:
            # æå–åˆ†ç±»åˆ—è¡¨
            options = data.get("options", [])
            # å¤„ç†åˆ†ç±»é€»è¾‘
            print(f"\nä¸ºæ–‡ä»¶ {md_file} ç”Ÿæˆçš„åˆ†ç±»å¦‚ä¸‹ï¼š")
            for i, option in enumerate(options):
                print(f"{i + 1}: {option}")

            choice = input("è¯·é€‰æ‹©åˆ†ç±»ç¼–å·: ").strip()
            if choice.isdigit():
                choice = int(choice)
                if choice > 0 and choice <= len(options):
                    new_category = options[choice - 1]
                    replace_md_category(md_file, original_category, new_category)
                else:
                    log(f"æœªæ›¿æ¢ {md_file} çš„åˆ†ç±»ã€‚")

        save_processed_file(md_file, PROCESSED_FILE)
        processed_files.add(md_file)
        result_queue.task_done()

def main():
    # True ä½¿ç”¨ AI è‡ªåŠ¨æ›¿æ¢, False ä½¿ç”¨äº¤äº’å¼æ›¿æ¢
    auto_replace = True

    dicts = get_process_md_files(sys.argv[1:])
    # ç¡®ä¿å‘å¸ƒç›®å½•å­˜åœ¨
    os.makedirs(dicts.get('publish_dir'), exist_ok=True)

    md_files_to_process = dicts.get('files')

    # åŠ è½½å·²å¤„ç†æ–‡ä»¶
    processed_files = load_processed_files(PROCESSED_FILE)

    # è·å–æ‰€æœ‰ Markdown æ–‡ä»¶
    md_files_to_process = [f for f in md_files_to_process if f not in processed_files]

    # æ£€æŸ¥æ˜¯å¦æœ‰æœªå¤„ç†çš„æ–‡ä»¶
    if not md_files_to_process:
        log("æ²¡æœ‰éœ€è¦å¤„ç†çš„ Markdown æ–‡ä»¶ã€‚")
        return

    # å¯åŠ¨ Ollama è°ƒç”¨çº¿ç¨‹
    threading.Thread(target=ai_worker, args=(auto_replace,), daemon=True).start()

    # å°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—
    for md_file in md_files_to_process:
        task_queue.put(md_file)

    # å¯åŠ¨äº¤äº’çº¿ç¨‹
    threading.Thread(target=interactive_worker, args=(auto_replace,), daemon=True).start()

    # ç­‰å¾…ä»»åŠ¡å®Œæˆ
    task_queue.join()
    result_queue.join()
    log("==================category å¤„ç†å®Œæˆ==================")

if __name__ == "__main__":
    main()
```

**åŠŸèƒ½æ¦‚è¿°**:

1. **è¯»å– Markdown æ–‡ä»¶**ï¼šä»æŒ‡å®šç›®å½•è¯»å– Markdown æ–‡ä»¶ã€‚
2. **è°ƒç”¨ AI æ¥å£ç”Ÿæˆåˆ†ç±»**ï¼šé€šè¿‡ AI æ¥å£ç”Ÿæˆæ–°çš„åˆ†ç±»ã€‚
3. **æ›¿æ¢åˆ†ç±»**ï¼šå°†ç”Ÿæˆçš„åˆ†ç±»æ›¿æ¢åˆ° Markdown æ–‡ä»¶çš„ Front-matter ä¸­ã€‚
4. **è®°å½•å·²å¤„ç†æ–‡ä»¶**ï¼šå°†å·²å¤„ç†çš„æ–‡ä»¶è®°å½•ä¿å­˜åˆ°æ–‡æœ¬æ–‡ä»¶ä¸­ï¼Œä»¥ä¾¿ä¸‹æ¬¡è¿è¡Œæ—¶è·³è¿‡è¿™äº›æ–‡ä»¶ã€‚

**å·¥ä½œæµç¨‹**

1. **åˆå§‹åŒ–**ï¼š
   - è¯»å–é…ç½®æ–‡ä»¶å’Œå·²å¤„ç†æ–‡ä»¶åˆ—è¡¨ã€‚
   - è·å–å¾…å¤„ç†çš„ Markdown æ–‡ä»¶åˆ—è¡¨ã€‚
2. **å¯åŠ¨å·¥ä½œçº¿ç¨‹**ï¼š
   - å¯åŠ¨ AI å·¥ä½œçº¿ç¨‹ï¼Œä»`task_queue`ä¸­è·å–ä»»åŠ¡å¹¶è°ƒç”¨ AI æ¥å£ã€‚
   - å¯åŠ¨äº¤äº’å¼å·¥ä½œçº¿ç¨‹ï¼Œä»`result_queue`ä¸­è·å– AI ç”Ÿæˆçš„åˆ†ç±»å¹¶å¤„ç†ç”¨æˆ·è¾“å…¥ã€‚
3. **å¤„ç†ä»»åŠ¡**ï¼š
   - AI å·¥ä½œçº¿ç¨‹è°ƒç”¨ AI æ¥å£ç”Ÿæˆåˆ†ç±»ï¼Œå¹¶å°†ç»“æœæ”¾å…¥`result_queue`ã€‚
   - äº¤äº’å¼å·¥ä½œçº¿ç¨‹ä»`result_queue`ä¸­è·å–ç»“æœï¼Œæ ¹æ®ç”¨æˆ·è¾“å…¥æ›¿æ¢åˆ†ç±»ï¼Œå¹¶ä¿å­˜å·²å¤„ç†æ–‡ä»¶ã€‚
4. **ç»“æŸ**ï¼š
   - æ‰€æœ‰ä»»åŠ¡å®Œæˆåï¼Œæ‰“å°å¤„ç†å®Œæˆçš„æ¶ˆæ¯ã€‚

æ‰‹åŠ¨å’Œè‡ªåŠ¨éœ€è¦å»è„šæœ¬ä¸­ä¿®æ”¹ä¸€ä¸‹

```python
# True ä½¿ç”¨ AI è‡ªåŠ¨æ›¿æ¢, False ä½¿ç”¨äº¤äº’å¼æ›¿æ¢
auto_replace = True
```

---

## æ€»ç»“

ç›®å‰å·²ç»ä½¿ç”¨ AI æ›¿æ¢äº†åšæ–‡çš„æ ‡é¢˜, Tags, åˆ†ç±»ä»¥åŠç”Ÿæˆæ‘˜è¦, åç»­ç»§ç»­ç ”ç©¶ä¸€ä¸‹å°†æ‰€æœ‰åšæ–‡ä½¿ç”¨ AI åˆ›å»ºä¸€ä¸ªçŸ¥è¯†åº“, åœ¨ç«™ç‚¹ä¸Šæä¾›ä¸€ä¸ª AI å¯¹è¯åŠŸèƒ½, ç°åœ¨è°ƒç ”çš„æœ‰ [Dify](https://dify.ai/zh), [æ‰£å­](https://www.coze.cn/), [MaxKB](https://maxkb.cn/), [FastGPT](https://tryfastgpt.ai/) ä»¥åŠ [PostChat](https://postchat.zhheo.com/), è¿™ç±»éƒ½æ”¯æŒ WebSDK é›†æˆ, ç­‰æœ‰æˆæœçš„æ—¶å€™å†æ€»ç»“ä¸€ä¸‹.

ä¸Šè¿°ä»£ç å·²ç»ä¸Šä¼ åˆ° [ä»“åº“](https://github.com/dong4j/hexo-deploy-workflow).

## å‚è€ƒ

- [åšå®¢æ–‡ç« æ€ä¹ˆè®¾è®¡åˆ†ç±»ä¸æ ‡ç­¾](https://blog.jiumoz.com/archives/bo-ke-wen-zhang-zen-me-she-ji-fen-lei-yu-biao-qian)
- [å¦‚ä½•è§„åˆ’ blog çš„æ ‡ç­¾ï¼ˆtagï¼‰å’Œåˆ†ç±»](https://www.cnblogs.com/Leo_wl/archive/2012/11/05/2755677.html)

## [AIåŠ©åŠ›åšå®¢åˆ›ä½œï¼šè‡ªåŠ¨ç”Ÿæˆæ‘˜è¦ä¸æ ‡ç­¾çš„å®æˆ˜æŒ‡å—](https://blog.dong4j.site/posts/87c223f.md)

![/images/cover/20241231185358_E3E6CGOm.webp](https://cdn.dong4j.site/source/image/20241231185358_E3E6CGOm.webp)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

åœ¨ä¿¡æ¯çˆ†ç‚¸çš„æ—¶ä»£ï¼Œå¦‚ä½•è®©æ‚¨çš„åšå®¢å†…å®¹åœ¨æµ©å¦‚çƒŸæµ·çš„èµ„è®¯ä¸­è„±é¢–è€Œå‡ºï¼Œæˆä¸ºå¸å¼•è¯»è€…çœ¼çƒçš„å…³é”®ã€‚è€Œæ ‡ç­¾å’Œæ‘˜è¦åœ¨è¿™ä¸€è¿‡ç¨‹ä¸­æ‰®æ¼”ç€è‡³å…³é‡è¦çš„è§’è‰²ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°†æ¢è®¨å¦‚ä½•åˆ©ç”¨ AI æŠ€æœ¯ä¸ºåšå®¢è‡ªåŠ¨ç”Ÿæˆæ ‡ç­¾å’Œæ‘˜è¦ï¼Œä»è€Œæå‡å†…å®¹çš„å¯å‘ç°æ€§å’Œé˜…è¯»ä½“éªŒã€‚

## æ ‡ç­¾ä¸æ‘˜è¦çš„é‡è¦æ€§

æ ‡ç­¾æ˜¯åšå®¢å†…å®¹çš„â€œå…³é”®è¯â€ï¼Œå®ƒä»¬èƒ½å¤Ÿç®€æ´ã€ç›´è§‚åœ°åæ˜ æ–‡ç« çš„ä¸»é¢˜å’Œæ ¸å¿ƒå†…å®¹ã€‚å¥½çš„æ ‡ç­¾ä¸ä»…æœ‰åŠ©äºæœç´¢å¼•æ“ä¼˜åŒ–ï¼ˆSEOï¼‰ï¼Œè¿˜èƒ½å¼•å¯¼è¯»è€…å¿«é€Ÿæ‰¾åˆ°æ„Ÿå…´è¶£çš„å†…å®¹ã€‚
æ‘˜åˆ™æ˜¯åšå®¢çš„â€œé—¨é¢â€ï¼Œå®ƒä»¥ç®€çŸ­çš„æ–‡å­—æ¦‚æ‹¬æ–‡ç« çš„ä¸»è¦å†…å®¹ï¼Œæ¿€å‘è¯»è€…çš„é˜…è¯»å…´è¶£ã€‚ä¸€ä¸ªå¸å¼•äººçš„æ‘˜è¦èƒ½å¤Ÿæœ‰æ•ˆåœ°æé«˜æ–‡ç« çš„ç‚¹å‡»ç‡ã€‚

## AI åœ¨æ ‡ç­¾å’Œæ‘˜è¦ç”Ÿæˆä¸­çš„ä¼˜åŠ¿

ä¼ ç»Ÿä¸Šï¼Œæ ‡ç­¾å’Œæ‘˜è¦çš„ç”Ÿæˆä¾èµ–äºäººå·¥æ’°å†™ï¼Œè¿™ä¸ä»…è€—æ—¶è€—åŠ›ï¼Œè€Œä¸”éš¾ä»¥ä¿è¯ä¸€è‡´æ€§å’Œå‡†ç¡®æ€§ã€‚è€Œ AI æŠ€æœ¯çš„å¼•å…¥ï¼Œä¸ºè¿™ä¸€é¢†åŸŸå¸¦æ¥äº†é©å‘½æ€§çš„å˜åŒ–ï¼š

1. **é«˜æ•ˆæ€§**ï¼šAI èƒ½å¤Ÿå¿«é€Ÿå¤„ç†å¤§é‡æ–‡æœ¬ï¼Œç”Ÿæˆæ ‡ç­¾å’Œæ‘˜è¦åœ¨çŸ­æ—¶é—´å†…å®Œæˆï¼Œå¤§å¤§æé«˜äº†å†…å®¹å‘å¸ƒçš„æ•ˆç‡ã€‚
2. **å‡†ç¡®æ€§**ï¼šé€šè¿‡æœºå™¨å­¦ä¹ ç®—æ³•ï¼ŒAI èƒ½å¤Ÿå‡†ç¡®è¯†åˆ«æ–‡ç« çš„ä¸»é¢˜å’Œå…³é”®ä¿¡æ¯ï¼Œç”Ÿæˆç›¸å…³åº¦é«˜çš„æ ‡ç­¾å’Œæ‘˜è¦ã€‚
3. **ä¸ªæ€§åŒ–**ï¼šAI å¯ä»¥æ ¹æ®ä¸åŒçš„å†…å®¹å’Œé£æ ¼éœ€æ±‚ï¼Œå®šåˆ¶åŒ–çš„ç”Ÿæˆæ ‡ç­¾å’Œæ‘˜è¦ï¼Œæ»¡è¶³å¤šæ ·åŒ–çš„å†…å®¹åˆ›ä½œéœ€æ±‚ã€‚

## AI ç”Ÿæˆæ ‡ç­¾å’Œæ‘˜è¦çš„å®ç°è¿‡ç¨‹

ç›®å‰æ­£åœ¨ä½¿ç”¨ [TianliGPT](https://docs_s.tianli0.top/), å®ƒæ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡å­—æ‘˜è¦ç”Ÿæˆå·¥å…·ï¼Œä½ å¯ä»¥å°†éœ€è¦æå–æ‘˜è¦çš„æ–‡æœ¬å†…å®¹å‘é€ç»™TianliGPTï¼Œç¨ç­‰ä¸€ä¼šä»–å°±å¯ä»¥ç»™ä½ å‘é€ä¸€ä¸ªåŸºäºè¿™æ®µæ–‡æœ¬å†…å®¹çš„æ‘˜è¦ã€‚

![20241231185358_1atLeTR9.webp](https://cdn.dong4j.site/source/image/20241231185358_1atLeTR9.webp)

- å®æ—¶ç”Ÿæˆçš„æ‘˜è¦
- è‡ªåŠ¨ç”Ÿæˆï¼Œæ— éœ€äººå·¥å¹²é¢„
- ä¸€æ¬¡ç”Ÿæˆï¼Œå†æ¬¡ç”Ÿæˆæ— éœ€æ¶ˆè€—key
- åŒ…å«æ–‡å­—å®¡æ ¸è¿‡æ»¤ï¼Œé€‚ç”¨äºä¸­å›½å¤§é™†
- æ”¯æŒä¸­å›½å¤§é™†è®¿é—®

åˆ° [çˆ±å‘ç”µ](https://afdian.net/item/f18c2e08db4411eda2f25254001e7c00)ä¸­è´­ä¹°ï¼ŒåŸä»·10å…ƒ5ä¸‡å­—ç¬¦ï¼ˆHeoé™é‡é™æ—¶æŠ˜æ‰£9å…ƒï¼‰ã€‚è¯·æ±‚è¿‡çš„å†…å®¹å†æ¬¡è¯·æ±‚ä¸ä¼šæ¶ˆè€—keyï¼Œå¯ä»¥æ— é™æœŸä½¿ç”¨ã€‚

ä½œè€…åŒæ—¶æä¾›å¤šç§åšå®¢çš„æ’ä»¶, æ¥å…¥æ–¹å¼ä¹Ÿéå¸¸ç®€å•. 

ä½†æ˜¯ä»Šå¤© **TianliGPT** ä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹, é‡ç‚¹æ˜¯åˆ©ç”¨æœ¬åœ°è‡ªå»ºçš„ LLM æœåŠ¡æ¥ç”Ÿæˆæ‘˜è¦å’Œæ ‡ç­¾.

å®ç°æ–¹å¼ä¹Ÿéå¸¸ç®€å•, æˆ‘æ‰€ä½¿ç”¨çš„ [å®‰çŸ¥é±¼ä¸»é¢˜](https://docs.anheyu.com/) ä¸­é›†æˆäº† **TianliGPT**, åªéœ€è¦é…ç½® key å’Œ Referer å³å¯, å…¶ä¸­è¿˜æœ‰ä¸€ä¸ªå¯é€‰é¡¹:

```yaml
post_head_ai_description:
  enable: true
  gptName: xxx
  mode: local # é»˜è®¤æ¨¡å¼ å¯é€‰å€¼: tianli/local
  switchBtn: true # å¯ä»¥é…ç½®æ˜¯å¦æ˜¾ç¤ºåˆ‡æ¢æŒ‰é’® ä»¥åˆ‡æ¢tianli/local
	...
```

åœ¨é¡µé¢ä¸Šå¯ä»¥é€‰æ‹©ä½¿ç”¨ **local** è¿˜æ˜¯ **tianli** æ¥ç”Ÿæˆæ‘˜è¦:

![20241230155911_MvGDK7JW.webp](https://cdn.dong4j.site/source/image/20241230155911_MvGDK7JW.webp)

å¦‚æœåˆ‡æ¢åˆ°æœ¬åœ°, åˆ™ä¼šæ˜¾ç¤ºè‡ªå®šä¹‰çš„ GPT åç§°ä¸è‡ªå®šä¹‰æ‘˜è¦å†…å®¹:

![20241230160007_8ZRZXs8g.webp](https://cdn.dong4j.site/source/image/20241230160007_8ZRZXs8g.webp)

åœ¨æ–‡ç« çš„ `Front-matter `é…ç½® `ai: true` ä½¿ç”¨ `tianli gpt`  éœ€å°† mode æ”¹ä¸º `tianli` ç„¶ååœ¨éœ€è¦ ai æ‘˜è¦çš„æ–‡ç« çš„ `Front-matter é…ç½® ai: true`

å¦‚æœä½¿ç”¨ `local`,éœ€è¦æŒ‰ç…§ä»¥ä¸‹æ–¹å¼é…ç½®

```
---
title: AnZhiYuä¸»é¢˜å¿«é€Ÿå¼€å§‹
ai:
  - æœ¬æ•™ç¨‹ä»‹ç»äº†å¦‚ä½•åœ¨åšå®¢ä¸­å®‰è£…åŸºäºHexoä¸»é¢˜çš„å®‰çŸ¥é±¼ä¸»é¢˜ï¼Œå¹¶æä¾›äº†å®‰è£…ã€åº”ç”¨ä¸»é¢˜ã€ä¿®æ”¹é…ç½®æ–‡ä»¶ã€æœ¬åœ°å¯åŠ¨ç­‰è¯¦ç»†æ­¥éª¤åŠæŠ€æœ¯æ”¯æŒæ–¹å¼ã€‚æ•™ç¨‹çš„å†…å®¹é’ˆå¯¹æœ€æ–°çš„ä¸»é¢˜ç‰ˆæœ¬è¿›è¡Œæ›´æ–°ï¼Œå¦‚æœä½ æ˜¯æ—§ç‰ˆæœ¬æ•™ç¨‹ä¼šæœ‰å‡ºå…¥ã€‚
  - æœ¬æ–‡çœŸä¸é”™
---
```

æ„æ€æ˜¯åªè¦åœ¨ `Front-matter` ä¸­é…ç½® **ai** æ ‡ç­¾å³å¯åœ¨åšå®¢ä¸­æ˜¾ç¤ºæ‘˜è¦, é‚£ä¹ˆæˆ‘ä»¬çš„ç›®æ ‡å°±å¾ˆæ˜ç¡®äº†:

1. ä½¿ç”¨ LLM ç”Ÿæˆæ–‡ç« æ‘˜è¦;
2. å¡«å†™åˆ°æ–‡ç« çš„ `ai` æ ‡ç­¾ä¸­;
3. å°† `mode` è®¾ç½®ä¸º `local`, é»˜è®¤ä½¿ç”¨æœ¬åœ°çš„æ‘˜è¦;
4. å€ŸåŠ© **TianliGPT** åœ¨é¡µé¢æ˜¾ç¤ºè‡ªå®šä¹‰æ‘˜è¦;

### æ›´å¤šæ”¯æŒTianliGPTçš„é¡¹ç›®

[Post-Summary-AI](https://github.com/qxchuckle/Post-Summary-AI) - è½»ç¬‘å¼€å‘çš„åšå®¢æ‘˜è¦ç”Ÿæˆå·¥å…·

[hexo-ai-excerpt](https://github.com/rootlexblog/hexo-ai-excerpt) - åœ¨æœ¬åœ°éƒ¨ç½²æ—¶æ·»åŠ AIæ‘˜è¦

---

### æ­å»º LLM æœåŠ¡

è¿™ä¸ªæˆ‘ç›¸ä¿¡è€é“ä»¬éƒ½å¾ˆç†Ÿæ‚‰äº†. ä¸ºäº†å·äº†æ‡’æˆ‘ç›´æ¥åœ¨ Mac mini M2 ä¸Šè¿è¡Œäº†ä¸€ä¸ª Ollama æœåŠ¡, ä½¿ç”¨ **glm4** æ¨¡å‹æ¥ä¸ºæ–‡ç« ç”Ÿæˆæ‘˜è¦. æˆ‘ç›¸ä¿¡åœ¨ macOS ä¸Šéƒ¨ç½² Ollama  åº”è¯¥æ˜¯ä¸€ç§æœ€ç®€å•å¿«é€Ÿéƒ¨ç½² LLM çš„æ–¹å¼äº†, ç›¸å…³æ•™ç¨‹ä¹Ÿéå¸¸å¤š, è¿™é‡Œå°±ä¸å†èµ˜è¿°äº†.

éœ€è¦è¯´æ˜çš„æ˜¯ä¸ºäº†è®©å…¶ä»–ä¸»æœºèƒ½å¤Ÿä½¿ç”¨ LLM æœåŠ¡, éœ€è¦ç‰¹æ®Šé…ç½®ä¸€ä¸‹:

```bash
# å…è®¸è·¨åŸŸ
launchctl setenv OLLAMA_ORIGINS "*"
# ä¿®æ”¹ bind
launchctl setenv OLLAMA_HOST "0.0.0.0"
```

### è‡ªåŠ¨åŒ–

#### è„šæœ¬

å…ˆæ¥ä¸€ä¸ªç®€å•çš„è„šæœ¬, é€šè¿‡è°ƒç”¨ Ollama çš„ API æ¥è·å–æ–‡ç« æ‘˜è¦:

```python
import requests
import json
import re

def generate_summary(content, model="default"):
    """
    è°ƒç”¨ Ollama API ç”Ÿæˆåšå®¢æ‘˜è¦ã€‚
    
    :param content: åšå®¢å†…å®¹ (å­—ç¬¦ä¸²)
    :param model: ä½¿ç”¨çš„ Ollama æ¨¡å‹ (é»˜è®¤æ˜¯ 'default')
    :return: ç”Ÿæˆçš„æ‘˜è¦ (JSON å­—ç¬¦ä¸²)
    """

    # æ„é€  prompt
    prompt = f"""
    ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å†…å®¹æ€»ç»“ç”ŸæˆåŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯ä¸ºç»™å®šçš„åšå®¢å†…å®¹è¿›è¡Œæ€»ç»“, å­—æ•°åœ¨ 100 å­—å†…ã€‚
    è¯·åˆ†æ'CONTENT START HERE'å’Œ'CONTENT END HERE'ä¹‹é—´çš„æ–‡æœ¬ï¼Œä»¥ä¸‹æ˜¯è§„åˆ™ï¼š
    1. ä»…è¿”å›ä¸€ä¸ªå®Œæ•´çš„æ€»ç»“ï¼Œä¸è¦æ·»åŠ é¢å¤–çš„ä¿¡æ¯ã€‚
    2. å¦‚æœå†…å®¹ä¸­åŒ…å« HTML æ ‡ç­¾ï¼Œè¯·å¿½ç•¥è¿™äº›æ ‡ç­¾ï¼Œä»…æå–æ–‡æœ¬å†…å®¹è¿›è¡Œåˆ†æã€‚

    ä»¥ä¸‹æ˜¯éœ€è¦å¤„ç†çš„åšå®¢å†…å®¹ï¼š

    CONTENT START HERE

    {content}

    CONTENT END HERE

    ä½ å¿…é¡»ä»¥JSONæ ¼å¼å“åº”ï¼Œé”®ä¸º'summary'ï¼Œå€¼æ˜¯å­—ç¬¦ä¸²æ ¼å¼çš„æ€»ç»“å†…å®¹ã€‚
    """

    # print(blog_content)
    
    # è®¾ç½® Ollama API çš„ URL
    url = f"http://localhost:11434/api/generate"
    data = {
        "model": model,
        "prompt": prompt,
        "format": "json",
        "stream": False
    }
    
    # å‘é€ POST è¯·æ±‚åˆ° Ollama API
    try:
        response = requests.post(url, json=data, stream=False)
        response.raise_for_status()  # æ£€æŸ¥è¯·æ±‚æ˜¯å¦æˆåŠŸ
        data = response.json()
        # æå–ç”Ÿæˆçš„æ‘˜è¦
        if "response" in data:
            return data["response"]
        else:
            print("æ²¡æœ‰ä»å“åº”ä¸­è·å–åˆ°æ‘˜è¦å†…å®¹ï¼")
            return None
    except requests.exceptions.RequestException as e:
        print(f"è¯·æ±‚å¤±è´¥: {e}")
        return None

if __name__ == "__main__":
    # è¾“å…¥åšå®¢å†…å®¹
    # blog_content = """
    # æ ‡é¢˜ï¼šOllama æ¨¡å‹çš„ä½¿ç”¨æ–¹æ³•
    # å†…å®¹ï¼šOllama æ˜¯ä¸€ä¸ªå¼ºå¤§çš„è¯­è¨€æ¨¡å‹æ¡†æ¶ï¼Œå¯ä»¥ç”¨äºç”Ÿæˆå†…å®¹ã€æ€»ç»“æ–‡æ¡£ç­‰ã€‚å®ƒæ”¯æŒå¤šç§æ¨¡å‹ç±»å‹ï¼Œ
    # å¹¶ä¸”å¯ä»¥é€šè¿‡ç®€å•çš„ API è°ƒç”¨æ¥å®ç°å¤æ‚çš„æ–‡æœ¬ç”Ÿæˆä»»åŠ¡ã€‚
    # åœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Ollamaï¼Œä»¥åŠå¦‚ä½•é€šè¿‡ Python è°ƒç”¨å…¶ API æ¥ç”Ÿæˆå†…å®¹ã€‚
    # """
    
    with open("md æ–‡æ¡£è·¯å¾„", "r", encoding="utf-8") as file:
        blog_content = file.read()

    # åˆ é™¤å¤šä½™ç©ºè¡Œï¼Œä½†ä¿ç•™æ®µè½é—´çš„åˆ†éš”
    blog_content = re.sub(r'\n\s*\n', '\n', blog_content)
    # åˆ é™¤æ¯è¡Œè¡Œé¦–å’Œè¡Œå°¾çš„å¤šä½™ç©ºç™½ç¬¦
    blog_content = "\n".join(line.strip() for line in blog_content.splitlines())
    # ç”Ÿæˆæ‘˜è¦
    summary = generate_summary(blog_content, model="glm4")
    
    # è¾“å‡ºæ‘˜è¦
    if summary:
        print(summary)
```

ä¿å­˜ä¸º `generate_summary.py` , ç„¶åè¿è¡Œ: `python generate_summary.py`, è¾“å‡ºç»“æœ:

```json
{
    "summary": "æ–‡ç« è®²è¿°äº†ä»ä¹¦æˆ¿è®¾å¤‡å‡çº§åˆ°ä¸‡å…†ç½‘ç»œçš„è¿‡ç¨‹å’Œç»éªŒã€‚ä¸»è¦æ¶‰åŠåˆ°ç¡¬ä»¶å‡çº§ã€ç½‘ç»œç¯å¢ƒæ­å»ºã€é—®é¢˜è§£å†³ä»¥åŠæ€§èƒ½ä¼˜åŒ–ç­‰æ–¹é¢ã€‚é€šè¿‡ä¸€å‘¨æ—¶é—´çš„åŠªåŠ›ï¼Œå®ç°äº†ä¸Šä¼ å’Œä¸‹è½½é€Ÿåº¦æ¥è¿‘æˆ–è¾¾åˆ°ç†è®ºå€¼çš„æ•ˆæœã€‚æ–‡ä¸­è¿˜æåˆ°äº†å°†ä¹¦æˆ¿ä¸»è¦è®¾å¤‡å‡çº§ä¸ºæ”¯æŒæ›´å¤§å¸¦å®½çš„å¯èƒ½æ–¹æ¡ˆï¼Œå¹¶é“¾æ¥äº†å¤šä¸ªä¸HomeLabç›¸å…³ä¸»é¢˜çš„æ–‡ç« ï¼Œå¦‚ç¡¬ä»¶ã€æœåŠ¡ã€æ•°æ®ç®¡ç†ç­‰ã€‚"
}
```

ç®€ç›´æ˜¯ä¸€æ°”å‘µæˆ.

æˆ‘çš„ç›®æ ‡æ˜¯å°†åšå®¢éƒ¨ç½²åˆ°äº‘å¹³å°ä¹‹å‰, è‡ªåŠ¨ä¸ºåšå®¢ç”Ÿæˆæ‘˜è¦å’Œ tags, æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªè„šæœ¬å»ä¿®æ”¹  `Front-matter` ä¸­ `ai` å’Œ `tags` è¿™ 2 ä¸ªæ ‡ç­¾çš„å†…å®¹, æˆ‘ä»¬å…ˆæ¥çœ‹è‡ªåŠ¨åŒ–è„šæœ¬:

```python
import os
import sys
import requests
import re
from io import StringIO
from ruamel.yaml import YAML
import json
import re
from datetime import datetime

"""
ç”Ÿæˆæ ‡ç­¾å’Œæ€»ç»“å¹¶æ›¿æ¢åŸæ–‡æœ¬çš„å†…å®¹
"""

def log(message):
    """
    æ‰“å°æ—¥å¿—ä¿¡æ¯ï¼ŒåŒ…å«æ—¶é—´æˆ³ã€‚
    """
    print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] {message}")

# è‡ªå®šä¹‰ YAML Dump å‡½æ•°ï¼Œä¿æŒç¼©è¿›å’Œæ ¼å¼
def dump_yaml(data):
    yaml = YAML()
    yaml = YAML()
    yaml.preserve_quotes = True
    yaml.indent(mapping=2, sequence=4, offset=2)
    # ä½¿ç”¨ StringIO æ¥æ•è·è¾“å‡º
    stream = StringIO()
    yaml.dump(data, stream)
    
    # è·å–å­—ç¬¦ä¸²å€¼å¹¶è¿”å›
    return stream.getvalue()

def get_all_md_files(directory, exclude_dir=None):
    """
    éå†æŒ‡å®šç›®å½•ï¼Œè·å–æ‰€æœ‰ Markdown æ–‡ä»¶ï¼ˆæ’é™¤æŒ‡å®šç›®å½•ï¼‰ã€‚
    """
    md_files = []
    for root, dirs, files in os.walk(directory):
        # æ’é™¤æŒ‡å®šçš„ç›®å½•s
        if exclude_dir and os.path.abspath(exclude_dir) in os.path.abspath(root):
            continue
        for file in files:
            if file.endswith('.md'):
                md_files.append(os.path.join(root, file))
    return md_files

def find_md_file(base_dir, filename, exclude_dir=None):
    """
    åœ¨æŒ‡å®šç›®å½•ä¸­æŸ¥æ‰¾ç‰¹å®šçš„ Markdown æ–‡ä»¶ï¼ˆæ’é™¤æŒ‡å®šç›®å½•ï¼‰ã€‚
    """
    for root, dirs, files in os.walk(base_dir):
        # æ’é™¤æŒ‡å®šçš„ç›®å½•
        if exclude_dir and os.path.abspath(exclude_dir) in os.path.abspath(root):
            continue
        for file in files:
            if file == filename:
                return os.path.join(root, file)
    return None

def replace_ai_tags_in_md(md_file, base_dir, publish_dir):
    """
    æ›¿æ¢ Markdown æ–‡ä»¶ä¸­çš„ `ai` æ ‡ç­¾ï¼Œå¹¶ä¿å­˜åˆ°å‘å¸ƒç›®å½•ã€‚
    """
    log(f"å¼€å§‹å¤„ç†æ–‡ä»¶: {md_file}")
    with open(md_file, 'r', encoding='utf-8') as file:
        content = file.read()

    # æå– Front-matter éƒ¨åˆ†
    front_matter_pattern = r"---\n(.*?)\n---\n"
    match = re.match(front_matter_pattern, content, re.DOTALL)
    
    if not match:
        log(f"æ–‡ä»¶ {md_file} ä¸åŒ…å«æœ‰æ•ˆçš„ Front-matterï¼Œè·³è¿‡å¤„ç†ã€‚")
        return

    front_matter = match.group(1)
    body = content[match.end():]  # Markdown æ­£æ–‡å†…å®¹

    # ä½¿ç”¨ YAML è§£æ Front-matter
    data = YAML().load(front_matter)

    # æ£€æŸ¥ ai æ ‡ç­¾
    md_ai_tag = data.get('ai')
    description_tag = data.get('description')
    # åˆ¤æ–­æ˜¯å¦éœ€è¦ç”Ÿæˆæ‘˜è¦
    need_generate_summary = not isinstance(md_ai_tag, list) or not description_tag

    need_update =False
    if need_generate_summary:
        # æ›¿æ¢ `ai` æ ‡ç­¾å†…å®¹
        ai_data = generate_summary_and_tags(body)  # è°ƒç”¨æ‘˜è¦ç”Ÿæˆå‡½æ•°
        summary = ai_data.get("summary", "").strip()
        if summary:
            if not isinstance(md_ai_tag, list):
                data['ai'] = [summary]  # è®¾ç½®æˆ–æ›¿æ¢ ai æ ‡ç­¾
                log(f"æ–‡ä»¶ {md_file} ç”Ÿæˆ ai æ‘˜è¦")
            if not description_tag:
                data['description'] = summary  # è®¾ç½®æˆ–æ›¿æ¢ description æ ‡ç­¾
                log(f"æ–‡ä»¶ {md_file} ç”Ÿæˆ description æ ‡ç­¾")
            need_update = True
        else:
            log(f"æœªè·å–æ‘˜è¦ï¼Œè·³è¿‡æ–‡ä»¶")

    md_tags = data.get('tags')
    if not isinstance(md_tags, list):
        # æ›¿æ¢ `tags` æ ‡ç­¾å†…å®¹
        ai_data = generate_summary_and_tags(body)  # è°ƒç”¨æ‘˜è¦ç”Ÿæˆå‡½æ•°
        tags = ai_data.get("tags", "")
        if tags:
            data['tags'] = tags
            log(f"æ–‡ä»¶ {md_file} ç”Ÿæˆ tags")
            need_update = True
        else:
            log(f"æœªè·å– tagsï¼Œè·³è¿‡æ–‡ä»¶")

    if need_update:
        # å°†æ›´æ–°åçš„ Front-matter è½¬æ¢å› YAML æ ¼å¼
        updated_front_matter = dump_yaml(data)
        updated_content = f"---\n{updated_front_matter}---\n{body}"

        # ä¿å­˜æ›´æ–°åçš„å†…å®¹åˆ°åŸæ–‡ä»¶
        with open(md_file, 'w', encoding='utf-8') as file:
            file.write(updated_content)
        log(f"å·²æ›´æ–°æ–‡ä»¶: {md_file}")
    else:
        log(f"ä¸éœ€è¦æ›´æ–°æ–‡ä»¶")

def generate_summary_and_tags(content):
    # åˆ é™¤å¤šä½™ç©ºè¡Œï¼Œä½†ä¿ç•™æ®µè½é—´çš„åˆ†éš”
    content = re.sub(r'\n\s*\n', '\n', content)
    # åˆ é™¤æ¯è¡Œè¡Œé¦–å’Œè¡Œå°¾çš„å¤šä½™ç©ºç™½ç¬¦
    content = "\n".join(line.strip() for line in content.splitlines())
    # ç”Ÿæˆæ‘˜è¦
    summary = generate_summary_from_ai(content, model="qwen2")
    # è§£æ JSON æ ¼å¼å­—ç¬¦ä¸²ï¼Œæå– summary çš„å€¼
    try:
        return json.loads(summary)
    except json.JSONDecodeError as e:
        log(f"è§£æ JSON æ•°æ®å¤±è´¥: {e}")
        return ''

def generate_summary_from_ai(content, model="default"):
    """
    è°ƒç”¨ Ollama API ç”Ÿæˆåšå®¢æ‘˜è¦ã€‚
    
    :param content: åšå®¢å†…å®¹ (å­—ç¬¦ä¸²)
    :param model: ä½¿ç”¨çš„ Ollama æ¨¡å‹ (é»˜è®¤æ˜¯ 'default')
    :return: ç”Ÿæˆçš„æ‘˜è¦ (å­—ç¬¦ä¸²)
    """

    # æ„é€  prompt
    prompt = f"""
    ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å†…å®¹æ€»ç»“ç”ŸæˆåŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯ä¸ºç»™å®šçš„åšå®¢å†…å®¹è¿›è¡Œæ€»ç»“ä»¥åŠå¸®åŠ©è¿›è¡Œè‡ªåŠ¨ç”Ÿæˆæ ‡ç­¾ã€‚
    è¯·åˆ†æ'CONTENT START HERE'å’Œ'CONTENT END HERE'ä¹‹é—´çš„æ–‡æœ¬ï¼Œä»¥ä¸‹æ˜¯æ€»ç»“è§„åˆ™ï¼š
    1. ç”Ÿæˆçš„æ€»ç»“å†…å®¹ï¼Œé•¿åº¦åœ¨ 100 åˆ° 300 å­—ç¬¦ä¹‹é—´ã€‚
    2. ä»…è¿”å›ä¸€ä¸ªå®Œæ•´çš„æ€»ç»“ï¼Œä¸è¦æ·»åŠ é¢å¤–çš„ä¿¡æ¯ã€‚
    3. å¦‚æœå†…å®¹ä¸­åŒ…å« HTML æ ‡ç­¾ï¼Œè¯·å¿½ç•¥è¿™äº›æ ‡ç­¾ï¼Œä»…æå–æ–‡æœ¬å†…å®¹è¿›è¡Œåˆ†æã€‚
    ä¸‹é¢æ˜¯æ ‡ç­¾ç”Ÿæˆè§„åˆ™:
    - ç›®æ ‡æ˜¯å¤šç§å¤šæ ·çš„æ ‡ç­¾ï¼ŒåŒ…æ‹¬å¹¿æ³›ç±»åˆ«ã€ç‰¹å®šå…³é”®è¯å’Œæ½œåœ¨çš„å­ç±»åˆ«ã€‚
    - æ ‡ç­¾è¯­è¨€å¿…é¡»ä¸ºä¸­æ–‡ã€‚
    - æ ‡ç­¾æœ€å¥½æ˜¯æ–‡æ¡ˆä¸­çš„è¯, æ¯”å¦‚ HomeLab, Java ç­‰, è¿™äº›åº”è¯¥æŒ‰ç…§åŸæ–‡ä¸­å‡ºç°çš„è¯æ¥ç”Ÿæˆã€‚
    - å¦‚æœæ˜¯è‘—åç½‘ç«™ï¼Œä½ ä¹Ÿå¯ä»¥ä¸ºè¯¥ç½‘ç«™æ·»åŠ ä¸€ä¸ªæ ‡ç­¾ã€‚å¦‚æœæ ‡ç­¾ä¸å¤Ÿé€šç”¨ï¼Œä¸è¦åŒ…å«å®ƒã€‚
    - å†…å®¹å¯èƒ½åŒ…æ‹¬cookieåŒæ„å’Œéšç§æ”¿ç­–çš„æ–‡æœ¬ï¼Œåœ¨æ ‡ç­¾æ—¶è¯·å¿½ç•¥è¿™äº›ã€‚
    - ç›®æ ‡æ˜¯3-5ä¸ªæ ‡ç­¾ã€‚
    - å¦‚æœæ²¡æœ‰å¥½çš„æ ‡ç­¾ï¼Œè¯·ç•™ç©ºæ•°ç»„ã€‚

    ä»¥ä¸‹æ˜¯éœ€è¦å¤„ç†çš„åšå®¢å†…å®¹ï¼š

    CONTENT START HERE

    {content}

    CONTENT END HERE

    ä½ å¿…é¡»ä»¥JSONæ ¼å¼å“åº”ï¼Œé”®ä¸º'summary'ï¼Œå€¼æ˜¯å­—ç¬¦ä¸²æ ¼å¼çš„æ€»ç»“å†…å®¹, é”®ä¸º'tags'ï¼Œå€¼æ˜¯å­—ç¬¦ä¸²æ ‡ç­¾çš„æ•°ç»„ã€‚
    """

    # print(blog_content)
    
    # è®¾ç½® Ollama API çš„ URL
    url = f"http://localhost:11434/api/generate"
    data = {
        "model": model,
        "prompt": prompt,
        "format": "json",
        "stream": False
    }
    
    # å‘é€ POST è¯·æ±‚åˆ° Ollama API
    try:
        response = requests.post(url, json=data, stream=False)
        response.raise_for_status()  # æ£€æŸ¥è¯·æ±‚æ˜¯å¦æˆåŠŸ
        data = response.json()
        # æå–ç”Ÿæˆçš„æ‘˜è¦
        if "response" in data:
            return data["response"]
        else:
            print("æ²¡æœ‰ä»å“åº”ä¸­è·å–åˆ°æ‘˜è¦å†…å®¹ï¼")
            return None
    except requests.exceptions.RequestException as e:
        print(f"è¯·æ±‚å¤±è´¥: {e}")
        return None

def main():
    args = sys.argv[1:]
    script_dir = os.path.dirname(os.path.abspath(__file__))
    base_dir = os.path.join(script_dir, '..', 'source/_posts')
    publish_dir = os.path.join(base_dir, 'publish')

    # åˆå§‹åŒ–è¦å¤„ç†çš„ Markdown æ–‡ä»¶åˆ—è¡¨
    md_files_to_process = []
		
    """
    1. ä¸ä¼ ä»»ä½•å‚æ•°, åˆ™å¤„ç† source/_posts ä¸‹æ‰€æœ‰çš„æ–‡æ¡£(ä¸åŒ…æ‹¬ publish ç›®å½•);
    2. ä¼ å…¥å¹´ä»½å‚æ•°ï¼Œåˆ™å¤„ç†æŒ‡å®šå¹´ä»½çš„ Markdown æ–‡ä»¶(ä¸åŒ…æ‹¬ publish ç›®å½•);
    3. ä¼ å…¥ Markdown æ–‡ä»¶åï¼Œåˆ™å¤„ç†æŒ‡å®šçš„ Markdown (æ–‡ä»¶ä¸åŒ…æ‹¬ publish ç›®å½•);
    """
    if not args:
        # å¤„ç†æ‰€æœ‰ Markdown æ–‡ä»¶
        md_files_to_process = get_all_md_files(base_dir, exclude_dir=publish_dir)
    elif len(args) == 1 and args[0].isdigit():
        # å¤„ç†æŒ‡å®šå¹´ä»½çš„ Markdown æ–‡ä»¶
        year_dir = os.path.join(base_dir, args[0])
        if os.path.isdir(year_dir):
            md_files_to_process = get_all_md_files(year_dir, exclude_dir=publish_dir)
        else:
            log(f"å¹´ä»½ç›®å½• {args[0]} ä¸å­˜åœ¨ã€‚")
            return
    elif len(args) == 1 and args[0].endswith('.md'):
        # å¤„ç†æŒ‡å®šçš„ Markdown æ–‡ä»¶
        md_filename = args[0]
        md_file = find_md_file(base_dir, md_filename, exclude_dir=publish_dir)
        if md_file:
            md_files_to_process.append(md_file)
        else:
            log(f"æœªæ‰¾åˆ° Markdown æ–‡ä»¶ {md_filename}ã€‚")
            return
    else:
        log("å‚æ•°æ•°é‡é”™è¯¯ã€‚")
        return

    # å¾ªç¯å¤„ç†æ‰€æœ‰ç¡®å®šçš„ Markdown æ–‡ä»¶
    for md_file in md_files_to_process:
        replace_ai_tags_in_md(md_file, base_dir, publish_dir)

if __name__ == "__main__":
    main()
```

é€»è¾‘ä¹Ÿéå¸¸ç®€å•äº†:

1. è‡ªåŠ¨è·å– md æ–‡ä»¶å†…å®¹, ç®€å•çš„å¤„ç†ä¸€ä¸‹åç»™ LLM ç”Ÿæˆæ‘˜è¦å’Œæ ‡ç­¾;
2. è‡ªåŠ¨æ›¿æ¢  `Front-matter` ä¸­çš„ `ai` å’Œ `tags` æ ‡ç­¾;

è¿™é‡Œéœ€è¦å…ˆè¯´ä¸€ä¸‹æˆ‘çš„ Hexo åšå®¢çš„ç›®å½•ç»“æ„:

```
.
â”œâ”€â”€ script
â”‚   â”œâ”€â”€ å…¶ä»–å„ç§è„šæœ¬
â”‚   â””â”€â”€ generate_summary_and_tags_and_replace.py  # å°±æ˜¯ä¸Šé¢çš„è„šæœ¬
â”œâ”€â”€ source
â”‚   â”œâ”€â”€ _posts
â”‚   â”‚   â”œâ”€â”€ 2012
â”‚   â”‚   â”œâ”€â”€ 2013
â”‚   â”‚   â”œâ”€â”€ 2014
â”‚   â”‚   â”œâ”€â”€ 2015
â”‚   â”‚   â”œâ”€â”€ 2016
â”‚   â”‚   â”œâ”€â”€ 2017
â”‚   â”‚   â”œâ”€â”€ 2018
â”‚   â”‚   â”œâ”€â”€ 2019
â”‚   â”‚   â”œâ”€â”€ 2020
â”‚   â”‚   â”œâ”€â”€ 2021
â”‚   â”‚   â”œâ”€â”€ 2022
â”‚   â”‚   â”œâ”€â”€ 2023
â”‚   â”‚   â”œâ”€â”€ 2024
â”‚   â”‚   â””â”€â”€ publish
â”‚   â””â”€â”€ å…¶ä»–ç›®å½•
â”œâ”€â”€ makefile
â””â”€â”€ themes

```

1. æˆ‘çš„æ‰€æœ‰è„šæœ¬éƒ½æ˜¯åœ¨ `script` ç›®å½•ä¸‹;
2. `_posts` ä¸‹æŒ‰ç…§å¹´ä»½åˆ’åˆ†ä¸åŒçš„ç›®å½•;
3. `makefile` ç”¨äºéƒ¨ç½²å·¥ä½œæµé…ç½®;

---

#### hexo-deploy-workflow

è¿™ä¸ªä¸æ˜¯ Hexo çš„æ’ä»¶, æ˜¯æˆ‘é€šè¿‡ **markfile** å®ç°çš„ä¸€ä¸ªéƒ¨ç½²å·¥ä½œæµç¨‹:

```
# å®šä¹‰ä¼ªç›®æ ‡ï¼Œé¿å…ä¸æ–‡ä»¶åå†²çª
.PHONY: clean_images convert_and_rename upload_images generate_summary_tags push deploy-m920x deploy-github clean

########## éœ€è¦ç»ˆç«¯åœ¨ hexo é¡¶å±‚ç›®å½•æ‰èƒ½æ­£å¸¸æ‰§è¡Œ

# é»˜è®¤ç›®æ ‡
all: clean_images convert_and_rename upload_images generate_summary_tags push deploy-m920x deploy-github clean

# åˆ é™¤æœªè¢«å¼•ç”¨çš„å›¾ç‰‡, ä¸ä¼ ä»»ä½•å‚æ•°åˆ™å…¨éƒ¨å¤„ç†, ä¼  2023 åˆ™åªå¤„ç† 2023 ç›®å½•ä¸‹çš„æ–‡ä»¶, ä¼  md æ–‡ä»¶å, åˆ™åªå¤„ç†è¿™ä¸€ä¸ªæ–‡ä»¶
clean_images:
	@echo "==================Step 1: Cleaning images=================="
	python script/clean_images.py

# å°†å›¾ç‰‡è½¬æ¢ä¸º webp ä¸”é‡å‘½å(å¹´æœˆæ—¥æ—¶åˆ†ç§’_8ä½éšæœºå­—ç¬¦ä¸².webp)
convert_and_rename: 
	@echo "==================Step 2: Cleaning images=================="
	python script/convert_and_rename.py

# ä¸Šä¼ å›¾ç‰‡
upload_images: 
	@echo "==================Step 3: Cleaning images=================="
	python script/upload_images.py

generate_summary_tags: 
	@echo "==================Step 3: Cleaning images=================="
	python script/generate_summary_and_tags_and_replace.py 

# æ‰§è¡Œ git-push.sh
push: generate_summary_tags
	@echo "==================Step 4: Pushing changes to Git=================="
	script/git-push.sh "åˆ é™¤é‡å¤çš„æ–‡ç« "

# æ‰§è¡Œ deploy.sh
deploy-m920x: push
	@echo "==================Step 5: Deploying application=================="
	script/deploy.sh

deploy-github: push
	@echo "==================Step 6: Deploying Github=================="
	hexo deploy

clean:
	@echo "==================Step 7: Cleaning up=================="
	hexo clean && rm -rf .deploy_git
```

å…¶ä¸­æ¶‰åŠåˆ°æ‘˜è¦ç”Ÿæˆå¹¶å‘å¸ƒçš„æ­¥éª¤ä¸º:

```
generate_summary_tags: 
	@echo "==================Step 3: Cleaning images=================="
	python script/generate_summary_and_tags_and_replace.py 

# æ‰§è¡Œ git-push.sh
push: generate_summary_tags
	@echo "==================Step 4: Pushing changes to Git=================="
	script/git-push.sh "åˆ é™¤é‡å¤çš„æ–‡ç« "
```

æ„æ€æ˜¯åªè¦æˆ‘æ‰§è¡Œ `make push`, å³ä¼šåœ¨æ‰§è¡Œ `push` ä¹‹å‰å…ˆæ‰§è¡Œ `generate_summary_tags`, é€šè¿‡ makefile çš„ç¼–æ’å®ç°äº†ä¸€ä¸ªç®€å•çš„å·¥ä½œæµ.

---

### æ•ˆæœ

è„šæœ¬å¤„ç†åçš„ md æ–‡ä»¶:

```yml
---
title: HomeLabæ•°æ®å¤‡ä»½ï¼šæ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿
ai:
  - è¿™ç¯‡åšæ–‡è¯¦ç»†é˜è¿°äº†ä½œè€…æ„å»ºçš„å®¶åº­å®éªŒå®¤ï¼ˆHomelabï¼‰çš„æ•°æ®å¤‡ä»½ç­–ç•¥å’Œä½“ç³»ã€‚ä½œè€…ä½¿ç”¨å¤šç§å·¥å…·å’ŒæŠ€æœ¯å¦‚Time Machineã€Apple Boot Camp
    (ABB)ã€Synology Drive Clientã€Abbackupã€Syphonä»¥åŠHyper Backupç­‰è¿›è¡Œä¸åŒè®¾å¤‡çš„å¤‡ä»½ï¼Œç¡®ä¿æ•°æ®å®‰å…¨æ€§å’Œå¯ç”¨æ€§ã€‚æ–‡ä¸­è¿˜æåˆ°äº†æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½è®¡åˆ’ã€æ•°æ®å†—ä½™ä»¥åŠè¿œç¨‹è®¿é—®ç­‰æ–¹é¢çš„å†…å®¹ï¼Œå¹¶åˆ†æäº†å„è®¾å¤‡åœ¨æ•°æ®å¤‡ä»½ä¸­çš„è§’è‰²å’Œè´£ä»»ã€‚æ­¤å¤–ï¼Œæ–‡ç« æŒ‡å‡ºæ‰€æœ‰å¤‡ä»½æ“ä½œéƒ½æ˜¯ä¸ºäº†åº”å¯¹æ½œåœ¨çš„æ•°æ®ä¸¢å¤±é£é™©å¹¶ç¡®ä¿å¿«é€Ÿæ¢å¤ï¼ŒåŒæ—¶ä¹Ÿè¯„ä¼°äº†æ•´ä½“å¤‡ä»½ä½“ç³»çš„ç¨³å®šæ€§ä¸å¯é æ€§ã€‚
swiper_index: 7
top_group_index: 7
tags:
  - Homelab
  - Data Backup
  - MacOS
  - Linux
  - Synology
  - Time Machine
  - ABB
  - Docker
  - WebDAV
  - Aliyun Pan
categories:
  - HomeLab
cover: /images/cover/20241229154732_oUxZug2L.webp
date: 2020-04-25 00:00:00
main_color:
description: è¿™ç¯‡åšæ–‡è¯¦ç»†é˜è¿°äº†ä½œè€…æ„å»ºçš„å®¶åº­å®éªŒå®¤ï¼ˆHomelabï¼‰çš„æ•°æ®å¤‡ä»½ç­–ç•¥å’Œä½“ç³»ã€‚ä½œè€…ä½¿ç”¨å¤šç§å·¥å…·å’ŒæŠ€æœ¯å¦‚Time Machineã€Apple
  Boot Camp (ABB)ã€Synology Drive Clientã€Abbackupã€Syphonä»¥åŠHyper Backupç­‰è¿›è¡Œä¸åŒè®¾å¤‡çš„å¤‡ä»½ï¼Œç¡®ä¿æ•°æ®å®‰å…¨æ€§å’Œå¯ç”¨æ€§ã€‚æ–‡ä¸­è¿˜æåˆ°äº†æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½è®¡åˆ’ã€æ•°æ®å†—ä½™ä»¥åŠè¿œç¨‹è®¿é—®ç­‰æ–¹é¢çš„å†…å®¹ï¼Œå¹¶åˆ†æäº†å„è®¾å¤‡åœ¨æ•°æ®å¤‡ä»½ä¸­çš„è§’è‰²å’Œè´£ä»»ã€‚æ­¤å¤–ï¼Œæ–‡ç« æŒ‡å‡ºæ‰€æœ‰å¤‡ä»½æ“ä½œéƒ½æ˜¯ä¸ºäº†åº”å¯¹æ½œåœ¨çš„æ•°æ®ä¸¢å¤±é£é™©å¹¶ç¡®ä¿å¿«é€Ÿæ¢å¤ï¼ŒåŒæ—¶ä¹Ÿè¯„ä¼°äº†æ•´ä½“å¤‡ä»½ä½“ç³»çš„ç¨³å®šæ€§ä¸å¯é æ€§ã€‚
---
```

![20241230164842_v4Y7Y4m8.webp](https://cdn.dong4j.site/source/image/20241230164842_v4Y7Y4m8.webp)




## æ€»ç»“

ä¸æ˜¯è¯´ **TianliGPT** è¿™ç±»åœ¨çº¿æœåŠ¡ä¸å¥½ç”¨æˆ–è€…å¤ªè´µç”¨ä¸èµ·, åªæ˜¯è§‰å¾—æœ¬åœ°è¿™ä¹ˆæŠ˜è…¾ä¸‹æ¥æ›´æœ‰æ„æ€.

æœªæ¥æˆ‘ç›¸ä¿¡éšç€ä¸ªäººè®¾å¤‡çš„æ€§èƒ½è¶³å¤Ÿå¼ºåŠ²æˆ–è€…æŠ€æœ¯å‘å±•åˆ° AI æ¨¡å‹ä¹Ÿèƒ½å¤Ÿåœ¨å»‰ä»·è®¾å¤‡ä¸Šè¿è¡Œæ—¶, åœ¨äººä»¬æ›´åŠ å…³æ³¨éšç§ä¸å®‰å…¨æ€§çš„æ—¶å€™, æœ¬åœ°æ¨¡å‹æ‰æ˜¯æœ€ç»ˆçš„å½’å±.

## [Hexoåšå®¢éƒ¨ç½²ä¸å›¾ç‰‡å¤„ç†å…¨æ”»ç•¥ï¼šè‡ªåŠ¨åŒ–æµç¨‹å¤§æ­ç§˜](https://blog.dong4j.site/posts/461c6733.md)

![/images/cover/20241231185353_hbs1dqDw.webp](https://cdn.dong4j.site/source/image/20241231185353_hbs1dqDw.webp)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

## ç®€ä»‹

éšç€åšå®¢æ–‡ç« çš„æ•°é‡ä¸æ–­å¢åŠ ï¼Œå°¤å…¶æ˜¯é•¿ç¯‡æ–‡ç« ä¸­éœ€è¦æ’å…¥å¤§é‡å›¾ç‰‡ï¼Œå‘å¸ƒä¸€ç¯‡åšå®¢å˜å¾—æ›´åŠ å¤æ‚ã€‚è¿™åŒ…æ‹¬å›¾ç‰‡çš„å‰ªåˆ‡ã€æ ¼å¼è½¬æ¢ã€æ¸…ç†å¤šä½™å›¾ç‰‡ã€ä¸Šä¼ å›¾åºŠã€æ›¿æ¢ Markdown ä¸­çš„å›¾ç‰‡æ ‡ç­¾ï¼Œä»¥åŠæœ€ç»ˆå‘å¸ƒåˆ°ç«™ç‚¹ã€‚å¦‚æœå…¨ç¨‹æ‰‹åŠ¨æ“ä½œï¼Œæ— ç–‘ä¼šéå¸¸ç¹çã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘å°†è¿™äº›æ­¥éª¤å…¨éƒ¨å®ç°ä¸ºç‹¬ç«‹çš„è„šæœ¬ï¼Œæœ€åé€šè¿‡ Makefile å°†å®ƒä»¬ä¸²è”èµ·æ¥ï¼Œæ‰“é€ äº†ä¸€å¥—å®Œæ•´çš„ Hexo éƒ¨ç½²å·¥ä½œæµã€‚

é‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯è®²æ€ä¹ˆå®ç°è¿™ä¸ªæµç¨‹äº†, è¿™é‡Œå°±ä»¥ Hexo ä¸ºä¾‹, åªè¦äº†è§£æ•´ä¸ªæ€è·¯, æˆ‘è§‰å¾—å…¶ä»–çš„ä»»ä½•åšå®¢éƒ½å¯ä»¥å®ç°è¿™å¥—æµç¨‹.

## å›¾ç‰‡å¤„ç†

ä¸€å›¾èƒœåƒè¨€ï¼Œå› æ­¤æˆ‘éå¸¸å–œæ¬¢åœ¨åšå®¢ä¸­æ’å…¥å¤§é‡å›¾ç‰‡ã€‚æ— è®ºæ˜¯æˆªå›¾ã€ç½‘ç»œå›¾ç‰‡ï¼Œè¿˜æ˜¯ç”¨ Drawio ç»˜åˆ¶çš„ SVGï¼Œç²¾å¿ƒæŒ‘é€‰çš„é…å›¾ä¸ä»…èƒ½å¤Ÿæå‡åšå®¢çš„è§†è§‰æ•ˆæœï¼Œè¿˜èƒ½ç›´è§‚åœ°å¢å¼ºå†…å®¹çš„è¡¨è¾¾åŠ›å’Œå¸å¼•åŠ›ã€‚

ä»¥å‰æˆ‘å¯¹å›¾ç‰‡çš„å¤„ç†æ­¥éª¤å¤§è‡´ä¸º:

1. ç¬¬ä¸€æ­¥æ˜¯ä½¿ç”¨æˆªå›¾å·¥å…·ç®€å•çš„å¤„ç†ä¸€ä¸‹å›¾ç‰‡, æ¯”å¦‚æˆªå›¾, è°ƒæ•´å°ºå¯¸, æ‰“é©¬èµ›å…‹, æ·»åŠ åœ†è§’, æ·»åŠ é˜´å½±ç­‰ç­‰;
2. ç¬¬äºŒæ­¥æ˜¯å°†å›¾ç‰‡è½¬æ¢æˆ webp, å°½é‡åœ¨ä¿è¯å›¾ç‰‡è´¨é‡çš„å‰æä¸‹å‡å°å›¾ç‰‡å°ºå¯¸;
3. ç¬¬ä¸‰æ­¥å°±æ˜¯ä¸Šä¼ åˆ°å›¾åºŠ, ç„¶åæ›¿æ¢åŸæ¥çš„å›¾ç‰‡æ ‡ç­¾;

ä¸Šé¢çš„æ­¥éª¤æ˜¯ä¸€ä¸ªæ­£å‘æµç¨‹, ä½†æ˜¯å¯èƒ½ä¼šé‡åˆ°è¿™æ ·çš„é—®é¢˜:

1. å›¾ç‰‡å¿˜äº†å¤„ç†æ•æ„Ÿä¿¡æ¯;
2. æˆªå–çš„å›¾ç‰‡æ²¡æœ‰è¾¾åˆ°é¢„æœŸ;
3. æŸä¸ªåœ°æ–¹çš„é…å›¾éœ€è¦æ›´æ¢ä¸ºæ–°å›¾ç‰‡;

å¯èƒ½è¿˜æœ‰ä¸€äº›å…¶ä»–åŸå› éœ€è¦é‡æ–°å¤„ç†æˆ–æ›´æ¢å›¾ç‰‡çš„è¯, ä¸Šé¢çš„å›¾ç‰‡å¤„ç†æµç¨‹è¦é‡æ–°æ¥ä¸€é, è¿˜å¾—æ‰‹åŠ¨åˆ é™¤ä¸å†ä½¿ç”¨çš„å›¾ç‰‡.

ä¸€ç¯‡åšå®¢çš„å‘å¸ƒ, å¯èƒ½å¤§é‡æ—¶é—´éƒ½åœ¨å¤„ç†å›¾ç‰‡. æ‰€ä»¥ä¸ºäº†è§„é¿è¿™ä¸ªé—®é¢˜, æœ¬ç€èƒ½å·æ‡’å°±å·æ‡’çš„åŸåˆ™, æˆ‘å¼€å§‹å°è¯•ä½¿ç”¨è„šæœ¬å¤„ç†å›¾ç‰‡, æ‰€ä»¥æ¥ä¸‹æ¥å°±æ˜¯ä»‹ç»å›¾ç‰‡çš„å¤„ç†æµç¨‹.

### æ’å…¥å›¾ç‰‡

> æˆ‘å†™åšå®¢çš„ä¸»åŠ›å·¥å…·æ˜¯ Typora, è¿˜ä¼šç»“åˆ VSCode æ¥ç®¡ç†æ•´ä¸ªåšå®¢çš„æ–‡ä»¶, æˆªå›¾å·¥å…·ä½¿ç”¨äº† [CleanShot X](https://cleanshot.com/).

[Typora](https://typoraio.cn/) æœ‰ä¸€ä¸ªå¾ˆæ£’çš„åŠŸèƒ½: **æ’å…¥å›¾ç‰‡æ—¶** æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œ. æ¯”å¦‚æˆ‘è¿™é‡Œå°±æ˜¯ç›´æ¥å¤åˆ¶åˆ° **æŒ‡å®šç›®å½•** (è¿™ä¸ªæ“ä½œåŒæ ·é€‚ç”¨äºç½‘ç»œå›¾ç‰‡, Typora ä¼šç›´æ¥å°†åŸå§‹å›¾ç‰‡ä¸‹è½½åˆ°æŒ‡å®šç›®å½•).

![20241231190525_BwyfBnUw.webp](https://cdn.dong4j.site/source/image/20241231190525_BwyfBnUw.webp)

æŒ‰ç…§ä¸Šé¢çš„é…ç½®ä¹‹å, Typora æ’å…¥çš„å›¾ç‰‡æ ‡ç­¾æ ¼å¼ä¸º:

```
![20241231103443_bT7yAiud](./hexo-deploy-workflow/20241231103443_bT7yAiud.png)
```

ä½¿ç”¨ Hexo ä½œä¸ºåšå®¢ç³»ç»Ÿçš„æœ‹å‹éƒ½çŸ¥é“, Hexo å¯ä»¥å°†ä¸ Markdown æ–‡ä»¶åŒåçš„ç›®å½•ä½œä¸ºèµ„æºç›®å½•, æ‰€ä»¥æˆ‘åœ¨ Typora ä¸­é…ç½®çš„å°±æ˜¯ `./${filename}`.
ä¸è¿‡ Hexo éœ€è¦é…ç½®ä¸€ä¸‹(`_config.yml`) :

```yaml
post_asset_folder: true
relative_link: false
marked:
  prependRoot: true
  postAsset: true
```

**è®¾ç½®è¯¦è§£ï¼š**

- `post_asset_folder: true`: æ‰§è¡Œ `hexo new post xxx `æ—¶ï¼Œä¼šåŒæ—¶ç”Ÿæˆ `./source/_posts/xxx.md`æ–‡ä»¶å’Œ `./source/_posts/xxx` ç›®å½•ï¼Œå¯ä»¥å°†è¯¥æ–‡ç« ç›¸å…³è”çš„èµ„æºæ”¾ç½®åœ¨è¯¥èµ„æºç›®å½•ä¸­ã€‚
- `relative_link: false`: ä¸è¦å°†é“¾æ¥æ”¹ä¸ºä¸æ ¹ç›®å½•çš„ç›¸å¯¹åœ°å€ã€‚æ­¤ä¸ºé»˜è®¤é…ç½®ã€‚
- `prependRoot: true`: å°†æ–‡ç« æ ¹è·¯å¾„æ·»åŠ åˆ°æ–‡ç« å†…çš„é“¾æ¥ä¹‹å‰ã€‚æ­¤ä¸ºé»˜è®¤é…ç½®ã€‚
- `postAsset: true`: åœ¨ `post_asset_folder` è®¾ç½®ä¸º `true` çš„æƒ…å†µä¸‹ï¼Œåœ¨æ ¹æ® `prependRoot` çš„è®¾ç½®åœ¨æ‰€æœ‰é“¾æ¥å¼€å¤´æ·»åŠ æ–‡ç« æ ¹è·¯å¾„ä¹‹å‰ï¼Œå…ˆå°†æ–‡ç« å†…èµ„æºçš„è·¯å¾„è§£æä¸ºç›¸å¯¹äºèµ„æºç›®å½•çš„è·¯å¾„ã€‚

**ä¸¾ä¾‹è¯´æ˜ï¼š**

æ‰§è¡Œ `hexo new post demo` åï¼Œåœ¨ `demo` æ–‡ç« çš„èµ„æºè·¯å¾„ä¸‹å­˜æ”¾äº† `a.jpg`ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

```
./source/_posts
â”œâ”€â”€ demo.md
â””â”€â”€ demo
    â””â”€â”€ a.jpg
```

Hexo æ­£ç¡®æ˜¾ç¤ºå›¾ç‰‡çš„å†™æ³•åº”è¯¥æ˜¯:

```
![](./hexo-deploy-workflow/a.jpg)
```

æ‰€ä»¥å°±ä¼šå­˜åœ¨è¿™æ ·çš„é—®é¢˜: **åœ¨ Typora ä¸­å¯ä»¥æ­£å¸¸æ˜¾ç¤ºå›¾ç‰‡, è€Œ Hexo ç½‘é¡µä¸­åˆ™æ— æ³•æ˜¾ç¤º**. è¿™ä¸ªé—®é¢˜æœ‰ 2 ç§è§£å†³æ–¹æ¡ˆ:

1. åœ¨ Typora ä¸­å†™å®Œåšå®¢å, å…¨å±€æ‰‹åŠ¨å°† `./demo/` æ›¿æ¢æˆç©ºå­—ç¬¦ä¸²;
2. ä¿®æ”¹ `hexo-renderer-marked` æ’ä»¶ä»£ç ;

è¿™é‡Œæˆ‘ä»¬ä»‹ç»ç¬¬äºŒç§æ–¹å¼(å…¶å®æˆ‘ä½¿ç”¨çš„æ˜¯ç¬¬ä¸€ç§æ–¹å¼, å› ä¸ºæˆ‘ä¸æƒ³è½»æ˜“ä¿®æ”¹ Hexo çš„åŸå§‹ä»£ç , ä¼šä¸ºåç»­å‡çº§å¸¦æ¥ä¸€äº›é—®é¢˜).

å› ä¸º `hexo-renderer-marked` æ¸²æŸ“æ’ä»¶é»˜è®¤çš„å›¾ç‰‡ç›¸å¯¹è·¯å¾„æ ¹ç›®å½•æ˜¯ `./source/_posts/demo/`ï¼Œæˆ‘ä»¬éœ€è¦è®©è¿™ä¸ªè·¯å¾„å‘ä¸Šå›é€€ä¸€å±‚ï¼Œå˜æˆ `demo.md` æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ï¼Œä¸æœ¬åœ°ç¼–è¾‘å™¨é¢„è§ˆæ—¶é»˜è®¤çš„æ ¹ç›®å½•ä¸€è‡´ï¼Œè¿™æ ·æ—¢æ»¡è¶³äº†æœ¬åœ°ç¼–è¾‘å™¨çš„æ¸²æŸ“éœ€æ±‚ï¼Œåˆèƒ½ è®© Hexo æ­£ç¡®åŠ è½½ç½‘é¡µä¸­çš„å›¾ç‰‡ã€‚

æ‰“å¼€ `./node_modules/hexo-renderer-marked/lib/renderer.js`ï¼Œæœç´¢ `image(href, title, text)` å®šä½åˆ°ä¿®æ”¹å›¾ç‰‡ç›¸å¯¹è·¯å¾„çš„ä»£ç :

```javascript
// Prepend root to image path
image(href, title, text) {
	...

  if (!/^(#|\/\/|http(s)?:)/.test(href) && !relative_link && prependRoot) {
    if (!href.startsWith('/') && !href.startsWith('\\') && postPath) {
      const PostAsset = hexo.model('PostAsset');
      // findById requires forward slash
      const asset = PostAsset.findById(join(postPath, href.replace(/\\/g, '/')));
      // asset.path is backward slash in Windows
      if (asset) href = asset.path.replace(/\\/g, '/');
    }
    href = url_for.call(hexo, href);
  }

  ...
}
```

ä¿®æ”¹ä¸º:

```javascript
// Prepend root to image path
image(href, title, text) {
	...

  if (!/^(#|\/\/|http(s)?:)/.test(href) && !relative_link && prependRoot) {
    if (!href.startsWith('/') && !href.startsWith('\\') && postPath) {
      const PostAsset = hexo.model('PostAsset');
      // findById requires forward slash
      const fixPostPath = join(postPath, '../');
      const asset = PostAsset.findById(join(fixPostPath, href.replace(/\\/g, '/')));
      // asset.path is backward slash in Windows
      if (asset) href = asset.path.replace(/\\/g, '/');
    }
    href = url_for.call(hexo, href);
  }

  ...
}
```

ç®€å•åœ°è¯´ï¼Œè¿™é‡Œçš„ä¿®æ”¹å°±æ˜¯å°†æ–‡ç« è·¯å¾„ `postPath` æ¢æˆäº†å®ƒçš„ä¸Šä¸€çº§è·¯å¾„ `fixPostPath`ï¼Œæ›´æ¢çš„æ–¹æ³•å°±æ˜¯åœ¨ `postPath` åé¢åŠ ä¸Š`../`ã€‚

ç°åœ¨ï¼Œåˆ‡æ¢åˆ° `demo.md`ï¼Œä¿ç•™ FrontMatte ä¸­ `cover` çš„å›¾ç‰‡è·¯å¾„ï¼Œå°†æ–‡ç« ä¸­çš„å›¾ç‰‡è·¯å¾„å˜æ›´ä¸º `demo/a.jpg`ï¼š

éœ€è¦æ³¨æ„çš„æ˜¯ `./node_modules` ä¸€èˆ¬æ¥è¯´ä¸è¢« Git è¿½è¸ªï¼Œè€Œä¸”ç›¸å…³æ’ä»¶åœ¨æ›´æ–°åä¼šè¦†ç›–æ‰äººä¸ºä¿®æ”¹ï¼Œæ‰€ä»¥è¿™ä¸ªæ”¹åŠ¨ä¸€èˆ¬éš¾ä»¥è·¨è®¾å¤‡åŒæ­¥ã€‚ç°é˜¶æ®µå¯ä»¥é‡‡ç”¨çš„åŠæ³•ä¹‹ä¸€ä¾¿æ˜¯åœ¨ä»“åº“é‡Œå¦å¤–ä¿å­˜ `renderer.js`ï¼Œå¹¶åœ¨éƒ¨ç½²æ—¶ã€å®‰è£…æ’ä»¶åï¼Œä½¿ç”¨è‡ªåŠ¨æŒ‡ä»¤è¦†ç›–æ’ä»¶ä¸­çš„æ–‡ä»¶ã€‚

**å‚è€ƒèµ„æ–™**

- Github ä»“åº“ä¸­æœ‰å…³æ­¤é—®é¢˜çš„ issue åŠè§£å†³æ–¹æ¡ˆï¼š[#216](https://github.com/hexojs/hexo-renderer-marked/issues/216#issuecomment-1214703941)

---

### å›¾ç‰‡æ¸…ç†

åœ¨æŸäº›æƒ…å†µä¸‹æˆ‘ä»¬å¯èƒ½éœ€è¦æ›¿æ¢å›¾ç‰‡, ä½¿ç”¨ Typora æ˜¯é‡æ–°åˆ›å»ºäº†ä¸€ä¸ªå›¾ç‰‡, åŸå§‹å›¾ç‰‡è¦ä¹ˆé€šè¿‡ Typora åˆ é™¤, é‚£ä¹ˆè‡ªå·±å»å›¾ç‰‡ç›®å½•æ‰‹åŠ¨åˆ é™¤, ä¸ºäº†è§£å†³è¿™ä¸ªæ‰‹åŠ¨æ“ä½œçš„é—®é¢˜, æˆ‘ä»¬ä½¿ç”¨è„šæœ¬æ¥ä¸€æ¬¡æ€§æ¸…ç†æœªè¢«å¼•ç”¨çš„å›¾ç‰‡èµ„æº:

```python
"""
æ¸…ç† source/_posts ç›®å½•ä¸‹æœªè¢«å¼•ç”¨çš„å›¾ç‰‡.
"""

import os
import sys
from utils import extract_image_urls_from_md

def log(message):
    """
    æ‰“å°ä¸­æ–‡æ—¥å¿—ä¿¡æ¯ã€‚
    """
    print(f"æ—¥å¿—ï¼š{message}")

def get_all_md_files(directory):
    """
    è·å–æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰Markdownæ–‡ä»¶ã€‚
    """
    md_files = []
    for root, _, files in os.walk(directory):
        for file in files:
            if file.endswith('.md'):
                md_files.append(os.path.join(root, file))
    return md_files

def find_md_file(directory, filename):
    """
    åœ¨æŒ‡å®šç›®å½•åŠå…¶å­ç›®å½•ä¸­æŸ¥æ‰¾æŒ‡å®šçš„Markdownæ–‡ä»¶ã€‚
    """
    for root, _, files in os.walk(directory):
        if filename in files:
            return os.path.join(root, filename)
    return None

def get_referenced_images(md_file):
    """
    è·å–Markdownæ–‡ä»¶ä¸­å¼•ç”¨çš„æ‰€æœ‰å›¾ç‰‡ã€‚
    """
    with open(md_file, 'r', encoding='utf-8') as file:
        content = file.read()
    return extract_image_urls_from_md(content)

def clean_unreferenced_images(md_file, exclude_extensions=None):
    """
    æ¸…ç†æœªå¼•ç”¨çš„å›¾ç‰‡ï¼Œæ”¯æŒæ’é™¤ç‰¹å®šæ ¼å¼çš„æ–‡ä»¶ã€‚

    :param md_file: Markdown æ–‡ä»¶è·¯å¾„
    :param exclude_extensions: è¦æ’é™¤çš„æ–‡ä»¶æ‰©å±•ååˆ—è¡¨ï¼ˆå¦‚ ['.keep', '.txt']ï¼‰ï¼Œé»˜è®¤ None
    """
    if exclude_extensions is None:
        exclude_extensions = []

    image_dir = os.path.splitext(md_file)[0]
    if not os.path.isdir(image_dir):
        return

    referenced_images = get_referenced_images(md_file)

    for root, _, files in os.walk(image_dir):
        for file in files:
            file_path = os.path.join(root, file)
            _, ext = os.path.splitext(file)

            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¢«å¼•ç”¨æˆ–æ˜¯å¦åœ¨æ’é™¤åˆ—è¡¨ä¸­
            if file not in referenced_images and ext not in exclude_extensions:
                os.remove(file_path)
                log(f"å·²åˆ é™¤æœªå¼•ç”¨çš„å›¾ç‰‡ï¼š{file_path}")

def main():
    args = sys.argv[1:]
    script_dir = os.path.dirname(os.path.abspath(__file__))
    base_dir = os.path.join(script_dir, '..', 'source/_posts')
    log(f"åšå®¢æ–‡ç« çš„åŸºå‡†ç›®å½•ï¼š{base_dir}")

    if not args:
        # å¤„ç†æ‰€æœ‰æ–‡æ¡£å’Œå›¾ç‰‡
        md_files = get_all_md_files(base_dir)
        log("æ­£åœ¨å¤„ç†æ‰€æœ‰Markdownæ–‡ä»¶å’Œå›¾ç‰‡ã€‚")
    elif len(args) == 1 and args[0].isdigit():
        # å¤„ç†æŒ‡å®šå¹´ä»½çš„æ–‡æ¡£å’Œå›¾ç‰‡
        year_dir = os.path.join(base_dir, args[0])
        md_files = get_all_md_files(year_dir)
        log(f"æ­£åœ¨å¤„ç†å¹´ä»½ {args[0]} çš„Markdownæ–‡ä»¶å’Œå›¾ç‰‡ã€‚")
    elif len(args) == 1 and args[0].endswith('.md'):
        # å¤„ç†æŒ‡å®šçš„Markdownæ–‡æ¡£å’Œå…¶èµ„æºæ–‡ä»¶
        md_filename = args[0]
        md_file = find_md_file(base_dir, md_filename)
        if md_file:
            md_files = [md_file]
            log(f"æ­£åœ¨å¤„ç†Markdownæ–‡ä»¶ï¼š{md_file}")
        else:
            log(f"æœªæ‰¾åˆ°Markdownæ–‡ä»¶ {md_filename}ã€‚")
            return
    else:
        log("å‚æ•°æ— æ•ˆã€‚")
        return

    for md_file in md_files:
        clean_unreferenced_images(md_file, exclude_extensions=['.svg'])

    log("==================å›¾ç‰‡æ¸…ç†å®Œæˆ==================")

if __name__ == '__main__':
    main()

```



> **é‡è¦æé†’**: 
>
> æœ€å¥½ä¿®æ”¹ä¸€ä¸‹è„šæœ¬, ä¸è¦ç›´æ¥åˆ é™¤å›¾ç‰‡, æ¯”å¦‚ç§»åŠ¨åˆ°å¦å¤–çš„ç›®å½•, è¿™æ ·åœ¨è¯¯åˆ å›¾ç‰‡çš„æƒ…å†µä¸‹è¿˜èƒ½æ¢å¤.



### å›¾ç‰‡è½¬æ¢

ä½¿ç”¨ [CleanShot X](https://cleanshot.com/) æˆªå–çš„å›¾ç‰‡é»˜è®¤æ˜¯ png æ ¼å¼, ä¸”å›¾ç‰‡æ ¼å¼éå¸¸å¤§, åŸºæœ¬ä¸Šéƒ½åœ¨ 1M ä»¥ä¸Š, å…‰å†™ HomeLab ç›¸å…³çš„æ–‡ç« çš„å›¾ç‰‡åŠ èµ·æ¥éƒ½è¶…è¿‡ 1G, æ‰€ä»¥è§‰å¾—å¯¹ç°æœ‰çš„å›¾ç‰‡è¿›è¡Œå…¨å±€å‹ç¼©, ä¸”åæœŸå…¶ä»–å›¾ç‰‡å…¨éƒ¨ä½¿ç”¨ WebP ä»£æ›¿.

> **WebP** æ˜¯ä¸€ç§ç°ä»£å›¾ç‰‡æ ¼å¼ï¼Œæ—¨åœ¨ä¸ºç½‘ç»œä¸Šçš„å›¾ç‰‡æä¾›å‡ºè‰²çš„æ— æŸå’Œæœ‰æŸå‹ç¼©ã€‚WebP æ ¼å¼ç”± Google å¼€å‘ï¼Œæ´¾ç”Ÿè‡ª VP8 å›¾åƒç¼–ç æ ¼å¼ï¼Œæ”¯æŒæœ‰æŸå’Œæ— æŸå‹ç¼©ã€‚
>
> WebP æ ¼å¼å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š
>
> - **å‹ç¼©æ•ˆç‡é«˜**ï¼šWebP æ ¼å¼å¯ä»¥åœ¨ä¿æŒç›¸åŒå›¾åƒè´¨é‡çš„æƒ…å†µä¸‹ï¼Œå°†æ–‡ä»¶å¤§å°æ˜¾è‘—å‡å°ã€‚ä¾‹å¦‚ï¼ŒWebP æ ¼å¼çš„æ–‡ä»¶é€šå¸¸æ¯” JPEG æ–‡ä»¶å°çº¦ 30%ã€‚
> - **æ”¯æŒæ— æŸå’Œæœ‰æŸå‹ç¼©**ï¼šWebP æ”¯æŒä¸¤ç§å‹ç¼©æ–¹å¼ï¼Œæ— æŸå‹ç¼©é€‚ç”¨äºéœ€è¦å®Œå…¨ä¿ç•™åŸå§‹å›¾åƒç»†èŠ‚çš„åœºæ™¯ï¼Œè€Œæœ‰æŸå‹ç¼©åˆ™é€‚ç”¨äºå¯ä»¥æ¥å—ä¸€å®šå›¾åƒè´¨é‡æŸå¤±ä»¥æ¢å–æ›´å°æ–‡ä»¶å¤§å°çš„åœºæ™¯ã€‚
> - **ç¡¬ä»¶åŠ é€Ÿ**ï¼šWebP æ ¼å¼æ”¯æŒç¡¬ä»¶åŠ é€Ÿè§£ç ï¼Œå¯ä»¥æé«˜å›¾ç‰‡åŠ è½½é€Ÿåº¦ã€‚
> - **å¼€æº**ï¼šWebP æ ¼å¼æ˜¯å¼€æºçš„ï¼Œè¿™æ„å‘³ç€å®ƒå¯ä»¥è¢«å¹¿æ³›åº”ç”¨äºä¸åŒçš„å¹³å°å’Œè®¾å¤‡ä¸Šã€‚
>
> WebP æ ¼å¼çš„ä¼˜åŠ¿åŒ…æ‹¬ï¼š
>
> - **æé«˜ç½‘é¡µåŠ è½½é€Ÿåº¦**ï¼šç”±äºæ–‡ä»¶å¤§å°æ˜¾è‘—å‡å°ï¼Œä½¿ç”¨ WebP æ ¼å¼çš„å›¾ç‰‡å¯ä»¥æ˜¾è‘—æé«˜ç½‘é¡µçš„åŠ è½½é€Ÿåº¦ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚
> - **èŠ‚çœå¸¦å®½**ï¼šè¾ƒå°çš„æ–‡ä»¶å¤§å°æ„å‘³ç€å¯ä»¥å‡å°‘æ•°æ®ä¼ è¾“é‡ï¼Œä»è€ŒèŠ‚çœå¸¦å®½èµ„æºã€‚
> - **å…¼å®¹æ€§å¥½**ï¼šç°ä»£æµè§ˆå™¨å¦‚ Chromeã€Firefoxã€egedã€safair ç­‰éƒ½å·²ç»æ”¯æŒ WebP æ ¼å¼ï¼Œä½¿å¾—è¿™ç§æ ¼å¼åœ¨å®é™…åº”ç”¨ä¸­å…·æœ‰å¾ˆå¥½çš„å…¼å®¹æ€§ã€‚

å› ä¸ºæˆ‘çš„å›¾åºŠå›¾ç‰‡æ˜¯é€šè¿‡å›¾ç‰‡åç§°ç¡®å®šå”¯ä¸€æ€§çš„, ç›¸åŒçš„å›¾ç‰‡åç§°ä¸Šä¼ ä¼šæ›¿æ¢åŸæœ‰å›¾ç‰‡, è¿™æ ·å°±èƒ½å‡å°‘åƒåœ¾å›¾ç‰‡çš„äº§ç”Ÿ.

æ‰€ä»¥åœ¨å›¾ç‰‡è½¬æ¢è¿‡ç¨‹ä¸­å°±ç´¢æ€§å°†å›¾ç‰‡é‡å‘½åä»¥ç¡®ä¿å”¯ä¸€æ€§, è§„åˆ™ä¸º: `{å¹´æœˆæ—¥æ—¶åˆ†ç§’}_{8 ä½éšæœºå­—ç¬¦ä¸²}.webp`.

ä¸‹é¢æ˜¯å¤„ç†è„šæœ¬:

```python
import os
import re
import sys
import subprocess
import random
import string
from datetime import datetime
from utils import find_all_image_tags, extract_image_url_from_tag, extract_image_urls_from_md, get_all_md_files, find_md_file, is_url

SUPPORTED_IMAGE_FORMATS = {'.png', '.jpg', '.jpeg', '.bmp'}  # æ·»åŠ æ›´å¤šæ”¯æŒçš„æ ¼å¼

def log(message):
    """
    æ‰“å°ä¸­æ–‡æ—¥å¿—ä¿¡æ¯ã€‚
    """
    print(f"æ—¥å¿—ï¼š{message}")

def is_valid_filename(filename):
    """
    æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦å·²æ»¡è¶³ç‰¹å®šçš„å‘½åè§„åˆ™ã€‚
    """
    naming_pattern = re.compile(r'^\d{14}_[a-zA-Z0-9]{8}\.webp$')
    return naming_pattern.match(filename) is not None

def generate_random_string(length=8):
    """
    ç”ŸæˆæŒ‡å®šé•¿åº¦çš„éšæœºå­—ç¬¦ä¸²ã€‚
    """
    return ''.join(random.choices(string.ascii_letters + string.digits, k=length))

def convert_image_to_webp(image_path, quality=75):
    """
    ä½¿ç”¨ffmpegå°†æ”¯æŒçš„å›¾ç‰‡æ ¼å¼è½¬æ¢ä¸ºwebpæ ¼å¼ï¼Œå¦‚æœå›¾ç‰‡å·²ç»æ˜¯webpæˆ–ä¸æ˜¯æ”¯æŒçš„æ ¼å¼åˆ™è·³è¿‡ã€‚
    """
    # log(f"å°è¯•è½¬æ¢å›¾ç‰‡ {image_path} åˆ°webpæ ¼å¼")

    # æ£€æŸ¥æ˜¯å¦ä¸ºURLæˆ–ä¸æ˜¯æ”¯æŒçš„å›¾ç‰‡æ ¼å¼
    if (is_url(image_path) or not os.path.splitext(image_path)[1].lower() in SUPPORTED_IMAGE_FORMATS):
        # log(f"è·¯å¾„ {image_path} æ˜¯ä¸€ä¸ª URL æˆ–ä¸æ˜¯æ”¯æŒçš„å›¾ç‰‡æ ¼å¼ï¼Œè·³è¿‡è½¬æ¢ã€‚")
        return image_path

    # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåçš„webpæ–‡ä»¶
    webp_path = os.path.splitext(image_path)[0] + '.webp'
    if os.path.exists(webp_path):
        # log(f"åŒå webp æ–‡ä»¶å·²å­˜åœ¨ï¼š{webp_path}ï¼Œè·³è¿‡è½¬æ¢ã€‚")
        return webp_path

    # ç”Ÿæˆè¾“å‡ºè·¯å¾„
    output_path = os.path.splitext(image_path)[0] + '.webp'

    # æ„å»ºå¹¶æ‰§è¡Œffmpegå‘½ä»¤
    command = f"ffmpeg -i '{image_path}' -q:v {quality} '{output_path}' -loglevel quiet"
    subprocess.run(command, shell=True, check=True)  # æ·»åŠ check=Trueä»¥æ•è·é”™è¯¯

    log(f"å›¾ç‰‡ {image_path} å·²è½¬æ¢ä¸º {output_path}")
    return output_path

def rename_webp_file(webp_path, starts_with_images=False):
    """
    æ ¹æ®è§„åˆ™é‡å‘½åwebpæ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶å·²å­˜åœ¨åˆ™è·³è¿‡ã€‚
    """
    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºwebpæ–‡ä»¶
    if not webp_path.lower().endswith('.webp'):
        # log(f"æ–‡ä»¶ {webp_path} ä¸æ˜¯webpæ–‡ä»¶ï¼Œè·³è¿‡é‡å‘½åã€‚")
        return os.path.basename(webp_path)


    # æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦å·²æ»¡è¶³è§„åˆ™
    if is_valid_filename(os.path.basename(webp_path)):
        # log(f"æ–‡ä»¶ {webp_path} åç§°å·²æ»¡è¶³è§„åˆ™")
        if starts_with_images:
            return "/images/cover/" + os.path.basename(webp_path)
        else:
            return os.path.basename(webp_path)

    timestamp = datetime.now().strftime('%Y%m%d%H%M%S')
    random_string = generate_random_string()
    new_name = f"{timestamp}_{random_string}.webp"
    new_path = os.path.join(os.path.dirname(webp_path), new_name)
    if os.path.exists(new_path):
        log(f"æ–‡ä»¶ {new_path} å·²å­˜åœ¨ï¼Œè·³è¿‡é‡å‘½åã€‚")
        return os.path.basename(webp_path)
    os.rename(webp_path, new_path)
    if starts_with_images:
        # å›¾ç‰‡è·¯å¾„ä»¥ /images å¼€å¤´
        new_name = "/images/cover/" + new_name
    log(f"æ–‡ä»¶ {webp_path} é‡å‘½åä¸º {new_path}")
    return new_name

def update_md_image_tags(md_file, image_tag_map):
    """
    æ›´æ–°Markdownæ–‡ä»¶ä¸­çš„å›¾ç‰‡æ ‡ç­¾ã€‚
    """
    with open(md_file, 'r+', encoding='utf-8') as file:
        content = file.read()

        # è·³è¿‡ä¸å¿…è¦çš„æ›¿æ¢
        updated = False

        for old_tag, new_tag in image_tag_map.items():
            # log(f"æ­£åœ¨å¤„ç†å›¾ç‰‡æ ‡ç­¾ï¼š{old_tag} -> {new_tag}")
            if old_tag != new_tag and old_tag in content:
                content = content.replace(old_tag, new_tag)
                updated = True
                if '/images/cover/' in old_tag:
                    log(f"æ›¿æ¢ cover æ ‡ç­¾")
                    content = content.replace('cover: ' + extract_image_url_from_tag(old_tag), 'cover: ' + extract_image_url_from_tag(new_tag))

        # åªæœ‰åœ¨æœ‰æ›´æ–°æ—¶æ‰å†™å›æ–‡ä»¶
        if updated:
            file.seek(0)
            file.write(content)
            file.truncate()
        else:
            log(f"æ–‡ä»¶ {md_file} ä¸­æ²¡æœ‰éœ€è¦æ›´æ–°çš„å›¾ç‰‡æ ‡ç­¾ã€‚")

def get_referenced_images(md_file):
    """
    è·å–Markdownæ–‡ä»¶ä¸­å¼•ç”¨çš„æ‰€æœ‰å›¾ç‰‡ã€‚
    """
    with open(md_file, 'r', encoding='utf-8') as file:
        content = file.read()
    return extract_image_urls_from_md(content)


def process_md_file(md_file):
    """
    å¤„ç†å•ä¸ªMarkdownæ–‡ä»¶åŠå…¶å›¾ç‰‡ï¼Œé¿å…é‡å¤å¤„ç†ã€‚
    """
    log(f"æ­£åœ¨å¤„ç† Markdown æ–‡ä»¶ï¼š{md_file}")

    image_dir = os.path.splitext(md_file)[0]
    if not os.path.isdir(image_dir):
        return

    image_tag_map = {}

    all_image_tags = find_all_image_tags(md_file)
    print(all_image_tags)

    for image_tag in all_image_tags:
        image_path = extract_image_url_from_tag(image_tag)
        if image_path.startswith('http'):
            log(f"å·²ç»æ˜¯å›¾åºŠå›¾ç‰‡, ä¸éœ€è¦è½¬æ¢ {image_path} ")
            continue  # Skip external images

        if image_path.startswith('/images'):
            # å›¾ç‰‡è·¯å¾„ä»¥ /images å¼€å¤´ï¼Œéœ€è¦åœ¨ source/images ç›®å½•ä¸‹æŸ¥æ‰¾
            source_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), '..', 'source')
            full_image_path = os.path.join(source_dir, 'images', image_path[len('/images'):].lstrip('/'))
        else:
            # å›¾ç‰‡è·¯å¾„ä¸æ˜¯ä»¥ /images å¼€å¤´ï¼Œç›´æ¥åœ¨æ–‡ç« ç›®å½•ä¸‹æŸ¥æ‰¾
            full_image_path = os.path.join(image_dir, image_path)

        if os.path.isfile(full_image_path):
            webp_path = convert_image_to_webp(full_image_path)
            # æ£€æŸ¥ webp_path æ˜¯å¦ä¸ºç½‘ç»œå›¾ç‰‡
            if not is_url(webp_path):
                new_name = rename_webp_file(webp_path, starts_with_images=True if image_path.startswith('/images') else False)
                new_tag = f"![{new_name}](./hexo-deploy-workflow/{new_name})"
                image_tag_map[image_tag] = new_tag
            else:
                log(f"è·¯å¾„ {webp_path} æ˜¯ä¸€ä¸ªURLï¼Œè·³è¿‡é‡å‘½åå’Œæ ‡ç­¾æ›¿æ¢ã€‚")

    if image_tag_map:
        update_md_image_tags(md_file, image_tag_map)

def main():
    args = sys.argv[1:]
    script_dir = os.path.dirname(os.path.abspath(__file__))
    base_dir = os.path.join(script_dir, '..', 'source/_posts')
    log(f"åšå®¢æ–‡ç« çš„åŸºå‡†ç›®å½•ï¼š{base_dir}")

    # åˆå§‹åŒ–è¦å¤„ç†çš„Markdownæ–‡ä»¶åˆ—è¡¨
    md_files_to_process = []

    if not args:
        # å¤„ç†æ‰€æœ‰Markdownæ–‡ä»¶
        md_files_to_process = get_all_md_files(base_dir)
    elif len(args) == 1 and args[0].isdigit():
         # å¤„ç†æŒ‡å®šå¹´ä»½çš„Markdownæ–‡ä»¶
        year_dir = os.path.join(base_dir, args[0])
        if os.path.isdir(year_dir):
            md_files_to_process = get_all_md_files(year_dir)
        else:
            log(f"å¹´ä»½ç›®å½• {args[0]} ä¸å­˜åœ¨ã€‚")
    elif len(args) == 1 and args[0].endswith('.md'):
        # å¤„ç†æŒ‡å®šçš„Markdownæ–‡ä»¶
        md_filename = args[0]
        md_file = find_md_file(base_dir, md_filename)
        if md_file:
            md_files_to_process.append(md_file)
        else:
            log(f"æœªæ‰¾åˆ°Markdownæ–‡ä»¶ {md_filename}ã€‚")
            return
    else:
        log("å‚æ•°æ•°é‡é”™è¯¯ã€‚")
        return

    # å¾ªç¯å¤„ç†æ‰€æœ‰ç¡®å®šçš„Markdownæ–‡ä»¶
    for md_file in md_files_to_process:
        process_md_file(md_file)

    log("==================å›¾ç‰‡è½¬æ¢å®Œæˆ==================")
if __name__ == "__main__":
    main()
```

ä¸Šé¢çš„è„šæœ¬æ ¸å¿ƒæ˜¯ä½¿ç”¨ `ffmpeg` å°†å›¾ç‰‡è½¬æ¢ä¸º WebP, ä½¿ç”¨ä¸Šè¿°è„šæœ¬å°†æ‰€æœ‰å›¾ç‰‡è½¬æ¢æˆ WebP å, æ‰€æœ‰å›¾ç‰‡ä»åŸæ¥çš„ 1G å‡å°‘åˆ°ç°åœ¨çš„ 100M+, æ•ˆæœéå¸¸æ˜ç¡®.

---

### å›¾ç‰‡ä¸Šä¼ 

macOS å¯é€‰çš„å›¾ç‰‡ä¸Šä¼ æ–¹æ¡ˆéå¸¸å¤š, æ¯”è¾ƒå¸¸è§çš„æœ‰:

1. [iPic](https://apps.apple.com/us/app/ipic-image-file-upload-tool/id1101244278?mt=12) (macOS, Freemium)
2. [uPic](https://github.com/gee1k/uPic) (macOS, OpenSource)
3. [PicGo-Core](https://github.com/PicGo/PicGo-Core)
4. [PicGo.app](https://picgo.github.io/PicGo-Doc/zh/)
5. [Upgit](https://github.com/pluveto/upgit)

è¿™é‡Œæˆ‘é€‰æ‹©äº† [PicGo-Core](https://github.com/PicGo/PicGo-Core), é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼ä¸Šä¼ å›¾ç‰‡.

æˆ‘çš„é€»è¾‘å¦‚ä¸‹:

1. æ‹·è´ md æ–‡ä»¶åˆ° `source/_posts/publish` ç›®å½•ä¸‹, æ­¤ç›®å½•ä½œä¸ºæœ€ç»ˆéœ€è¦å‘å¸ƒçš„åšå®¢æ–‡ç« ç›®å½•;
2. è§£ææ ‡ç­¾å¹¶é€šè¿‡ `picgo upload` æ‰¹é‡ä¸Šä¼ å›¾ç‰‡åˆ°å›¾åºŠ;

å…³äºç¬¬ä¸€ç‚¹è¿™é‡Œéœ€è¦è§£é‡Šä¸€ä¸‹ **ä¸ºä»€ä¹ˆè¿˜è¦ä¸“é—¨æä¸€ä¸ªç›®å½•æ¥å­˜æ”¾æœ€ç»ˆå‘å¸ƒæ–‡ç« ç›®å½•**.

ä»¥å‰å°†å›¾ç‰‡ä¸Šä¼ åˆ°å›¾åºŠ, ä½†æ˜¯è·‘è·¯äº†, æœ¬åœ°çš„åšå®¢ä¸­çš„å›¾ç‰‡å…¨éƒ½æ˜¯ä¸Šä¼ å›¾åºŠåçš„åœ¨çº¿åœ°å€, ä¸”æœ¬åœ°çš„å›¾ç‰‡ä¹Ÿæ²¡æœ‰å¤‡ä»½, æ‰€ä»¥å›¾ç‰‡å…¨éƒ¨ä¸¢å¤±.

ç—›å®šæ€ç—›åæƒ³å‡ºäº†ç°åœ¨è¿™ä¸ªæ–¹æ³•: **æœ¬åœ°å­˜æ”¾åŸå§‹çš„å›¾ç‰‡å’Œåšå®¢æ–‡ç« **, éœ€è¦å‘å¸ƒåˆ°çº¿ä¸Šæ—¶, æ‹·è´ä¸€ä»½åŸå§‹åšå®¢å‡ºæ¥, ç„¶åæ›¿æ¢å…¶ä¸­çš„å›¾ç‰‡åœ°å€, å°†è¿™ä¸ªæ–‡æ¡£ä½œä¸ºç¼–è¯‘çš„ç‰ˆæœ¬å¹¶å‘å¸ƒåˆ°çº¿ä¸Š.

è¿™æ ·æˆ‘æœ¬åœ°ç•™æœ‰åŸå§‹çš„åšå®¢å’Œå›¾ç‰‡, å†ä¹Ÿä¸æ€•å›¾åºŠè·‘è·¯äº†, å¤§ä¸äº†æˆ‘æ¢ä¸€å®¶å›¾åºŠé‡æ–°ä¸Šä¼ å¹¶å‘å¸ƒä¸€æ¬¡.

è¿™é‡Œå…ˆè¯´å›¾ç‰‡ä¸Šä¼ çš„æ“ä½œ, **åœ¨ä¸Šä¼ ä¹‹å‰æ‹·è´åŸå§‹åšå®¢ä»¥åŠæœ¬åœ°å’Œå‘å¸ƒçº¿ä¸Šç‰ˆæœ¬çš„ Hexo é…ç½®** å¯ä»¥åœ¨ [æ–‡ç« å¤„ç†](#æ–‡ç« å¤„ç†) ä¸€èŠ‚ä¸­æŸ¥çœ‹.

```python
import re
import os
import sys
import shutil
import subprocess
from utils import find_all_image_tags, extract_image_url_from_tag, extract_image_urls_from_md, get_all_md_files, find_md_file, is_url

def log(message):
    """
    æ‰“å°ä¸­æ–‡æ—¥å¿—ä¿¡æ¯ã€‚
    """
    print(f"æ—¥å¿—ï¼š{message}")

def upload_image(image_path):
    # ä½¿ç”¨picgoå‘½ä»¤ä¸Šä¼ å›¾ç‰‡ï¼Œå¹¶è·å–è¾“å‡º
    result = subprocess.run(['picgo', 'upload', image_path], capture_output=True, text=True)
    # æå–å›¾åºŠåœ°å€ï¼ŒåªåŒ¹é…ä»¥httpså¼€å¤´çš„å­—ç¬¦ä¸²
    url_match = re.search(r'https://[^ ]+', result.stdout)
    if url_match:
        return url_match.group().strip()
    else:
        raise Exception(f"æ— æ³•ä»è¾“å‡ºä¸­æå–å›¾åºŠåœ°å€: {result.stdout}")

def replace_image_tags_in_md(md_file, base_dir, publish_dir):
    print(f"æ­£åœ¨å¤„ç†Markdownæ–‡ä»¶ï¼š{md_file}")
    # è®¡ç®—Markdownæ–‡ä»¶ç›¸å¯¹äºbase_dirçš„è·¯å¾„
    relative_path = os.path.relpath(md_file, start=base_dir)
    # æ„å»ºå‘å¸ƒç›®å½•ä¸‹çš„Markdownæ–‡ä»¶è·¯å¾„
    publish_md_file = os.path.join(publish_dir, relative_path)
    # ç¡®ä¿å‘å¸ƒç›®å½•ä¸‹çš„å­ç›®å½•å­˜åœ¨
    os.makedirs(os.path.dirname(publish_md_file), exist_ok=True)

    # æ£€æŸ¥å‘å¸ƒç›®å½•ä¸‹çš„Markdownæ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
    if os.path.exists(publish_md_file):
        print(f"æ–‡ä»¶å·²å­˜åœ¨ï¼š{publish_md_file}")
        return  # æ–‡ä»¶å­˜åœ¨ï¼Œé€€å‡ºå‡½æ•°

    # å¤åˆ¶åŸå§‹Markdownæ–‡ä»¶åˆ°å‘å¸ƒç›®å½•
    shutil.copyfile(md_file, publish_md_file)

    # è¯»å–å‘å¸ƒç›®å½•ä¸‹çš„Markdownæ–‡ä»¶å†…å®¹
    with open(publish_md_file, 'r', encoding='utf-8') as file:
        content = file.read()

    # æå–æ‰€æœ‰å›¾ç‰‡æ ‡ç­¾
    image_tags = find_all_image_tags(md_file)

    for tag in image_tags:
        # ä»æ ‡ç­¾ä¸­æå–å›¾ç‰‡æ–‡ä»¶å
        image_name = extract_image_url_from_tag(tag)
        # å¦‚æœ image_name ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œè·³è¿‡å½“å‰å¾ªç¯
        if not image_name or is_url(image_name):
            print(f"æ ‡ç­¾ {tag} ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„å›¾ç‰‡è·¯å¾„æˆ–è€…å·²ç»æ˜¯å›¾åºŠåœ°å€ï¼Œè·³è¿‡ã€‚")
            continue

        if image_name.startswith('/images'):
            # å›¾ç‰‡è·¯å¾„ä»¥ /images å¼€å¤´ï¼Œéœ€è¦åœ¨ source/images ç›®å½•ä¸‹æŸ¥æ‰¾
            source_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), '..', 'source')
            image_path = os.path.join(source_dir, 'images', image_name[len('/images'):].lstrip('/'))
        else:
            # å›¾ç‰‡è·¯å¾„ä¸æ˜¯ä»¥ /images å¼€å¤´ï¼Œç›´æ¥åœ¨æ–‡ç« ç›®å½•ä¸‹æŸ¥æ‰¾
            image_path = os.path.join(os.path.splitext(md_file)[0] , image_name)

        # æ£€æŸ¥å›¾ç‰‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if os.path.isfile(image_path):
            # ä¸Šä¼ å›¾ç‰‡å¹¶è·å–å›¾åºŠåœ°å€
            image_url = upload_image(image_path)
            # åªæ›¿æ¢æ‹¬å·()å†…çš„å†…å®¹
            new_tag = re.sub(r'\(.*?\)', f'({image_url})', tag)
            content = content.replace(tag, new_tag)
            if image_name.startswith('/images'):
                log(f"æ›¿æ¢ cover å›¾ç‰‡åœ°å€")
                content = content.replace('cover: ' + image_name, 'cover: ' + image_url)
            log(f"æ›¿æ¢æ ‡ç­¾ {tag} ä¸º {new_tag}")
        else:
            print(f"å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨: {image_path}")

    # ä¿å­˜ä¿®æ”¹åçš„Markdownæ–‡ä»¶åˆ°å‘å¸ƒç›®å½•
    with open(publish_md_file, 'w', encoding='utf-8') as file:
        file.write(content)

def main():
    args = sys.argv[1:]
    script_dir = os.path.dirname(os.path.abspath(__file__))
    base_dir = os.path.join(script_dir, '..', 'source/_posts')
    # æ„å»ºå‘å¸ƒç›®å½•è·¯å¾„ï¼Œç¡®ä¿å®ƒåœ¨source/_postsä¸‹
    publish_dir = os.path.join(base_dir, 'publish')
    # ç¡®ä¿å‘å¸ƒç›®å½•å­˜åœ¨
    os.makedirs(publish_dir, exist_ok=True)
    log(f"åšå®¢æ–‡ç« çš„åŸºå‡†ç›®å½•ï¼š{base_dir}")

    # åˆå§‹åŒ–è¦å¤„ç†çš„Markdownæ–‡ä»¶åˆ—è¡¨
    md_files_to_process = []

    if not args:
        # å¤„ç†æ‰€æœ‰Markdownæ–‡ä»¶
        md_files_to_process = get_all_md_files(base_dir, exclude_dir='publish')
    elif len(args) == 1 and args[0].isdigit():
        # å¤„ç†æŒ‡å®šå¹´ä»½çš„Markdownæ–‡ä»¶
        year_dir = os.path.join(base_dir, args[0])
        if os.path.isdir(year_dir):
            md_files_to_process = get_all_md_files(base_dir, exclude_dir='publish')
        else:
            log(f"å¹´ä»½ç›®å½• {args[0]} ä¸å­˜åœ¨ã€‚")
            return
    elif len(args) == 1 and args[0].endswith('.md'):
        # å¤„ç†æŒ‡å®šçš„Markdownæ–‡ä»¶
        md_filename = args[0]
        md_file = find_md_file(base_dir, md_filename, exclude_dir='publish')
        if md_file:
            md_files_to_process.append(md_file)
        else:
            log(f"æœªæ‰¾åˆ°Markdownæ–‡ä»¶ {md_filename}ã€‚")
            return
    else:
        log("å‚æ•°æ•°é‡é”™è¯¯ã€‚")
        return

    # å¾ªç¯å¤„ç†æ‰€æœ‰ç¡®å®šçš„Markdownæ–‡ä»¶
    for md_file in md_files_to_process:
        replace_image_tags_in_md(md_file, base_dir, publish_dir)

    log("==================å›¾ç‰‡ä¸Šä¼ å®Œæˆ==================")

if __name__ == "__main__":
    main()

```

## æ–‡ç« å¤„ç†

### æ·»åŠ æ ‡ç­¾å’Œæ‘˜è¦

è‡ªåŠ¨ä¸ºåšå®¢æ·»åŠ  tags å’Œ AI æ‘˜è¦, è¿™ä¸ªå¯ä»¥çœ‹ [[generate-blog-tags-using-ai|å¦ä¸€ç¯‡åšå®¢]].

### åˆ›å»ºå‘å¸ƒæ–‡ä»¶

æˆ‘çš„éœ€æ±‚æ˜¯æ‹·è´ä¸€ä»½ md æ–‡æ¡£, åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­è¿›è¡Œå›¾ç‰‡æ ‡ç­¾æ›¿æ¢, é‚£ä¹ˆç°åœ¨çš„é—®é¢˜æ˜¯æˆ‘å¦‚ä½•å¤„ç†æœ¬åœ°å¼€å‘ä¸çº¿ä¸Šç¯å¢ƒçš„åˆ‡æ¢:

1. åœ¨ Typora å†™å®Œå, æˆ‘ä½¿ç”¨ VSCode(æˆ–è€…å‘½ä»¤è¡Œ) å¯åŠ¨ Hexo çš„æœåŠ¡ç«¯, åœ¨ Web ç«¯æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦æœ‰é—®é¢˜, è¿™é‡Œä½¿ç”¨çš„æ˜¯æœ¬åœ°çš„å›¾ç‰‡;
2. å‘å¸ƒåˆ°çº¿ä¸Šçš„æ—¶å€™, éœ€è¦æ‹·è´ä¸€ä»½åŸå§‹çš„ md æ–‡ä»¶, ä¸Šä¼ å®Œæ–‡ä»¶åæ›¿æ¢è¿™ä»½æ–‡ä»¶ä¸­çš„å›¾ç‰‡æ ‡ç­¾, æœ€åå‘å¸ƒåˆ°çº¿ä¸Š.

æˆ‘çš„ç›®å½•ç»“æ„å¦‚ä¸‹:

```
.
â”œâ”€â”€ script
â”‚   â”œâ”€â”€ å…¶ä»–å„ç§è„šæœ¬
â”‚   â””â”€â”€ generate_summary_and_tags_and_replace.py  # å°±æ˜¯ä¸Šé¢çš„è„šæœ¬
â”œâ”€â”€ source
â”‚   â”œâ”€â”€ _posts
â”‚   â”‚   â”œâ”€â”€ 2012
â”‚   â”‚   â”‚		 â”œâ”€â”€ demo1
â”‚   â”‚   â”‚    â”œâ”€â”€ demo1.md
â”‚   â”‚   â”‚		 â”œâ”€â”€ demo2
â”‚   â”‚   â”‚    â””â”€â”€ demo2.md
â”‚   â”‚   â”œâ”€â”€ 2013
â”‚   â”‚   â”œâ”€â”€ 2014
â”‚   â”‚   â”œâ”€â”€ 2015
â”‚   â”‚   â”œâ”€â”€ 2016
â”‚   â”‚   â”œâ”€â”€ 2017
â”‚   â”‚   â”œâ”€â”€ 2018
â”‚   â”‚   â”œâ”€â”€ 2019
â”‚   â”‚   â”œâ”€â”€ 2020
â”‚   â”‚   â”œâ”€â”€ 2021
â”‚   â”‚   â”œâ”€â”€ 2022
â”‚   â”‚   â”œâ”€â”€ 2023
â”‚   â”‚   â”œâ”€â”€ 2024
â”‚   â”‚   â””â”€â”€ publish
â”‚   â”‚       â”œâ”€â”€ demo1.md
â”‚   â”‚       â””â”€â”€ demo2.md
â”‚   â”‚
â”‚   â””â”€â”€ å…¶ä»–ç›®å½•
â”œâ”€â”€ makefile
â””â”€â”€ themes
```

`source/_posts` ç›®å½•ä¸‹æŒ‰ç…§å¹´åˆ’åˆ†å­ç›®å½•, æœ€åä¸€ä¸ª `publish` ç›®å½•ä¸ºæœ€ç»ˆå‘å¸ƒåˆ°ç°åœ¨çš„ç‰ˆæœ¬, æ­¤ç›®å½•ä¸‹åªæœ‰å¤„ç†å®Œæˆåçš„ md æ–‡ä»¶.

æ‰€ä»¥ç°åœ¨éœ€è¦è§£å†³çš„é—®é¢˜æ˜¯åœ¨æœ¬åœ°é¢„è§ˆæ—¶éœ€è¦ç¼–è¯‘ `_posts` ç›®å½•ä¸‹é™¤ `publish` ä¹‹å¤–çš„æ‰€æœ‰ç›®å½•ä¸­çš„ md æ–‡ä»¶, è€Œå‘å¸ƒæ—¶åªéœ€è¦ç¼–è¯‘ `publish` ç›®å½•ä¸‹çš„ md æ–‡ä»¶.

Hexo æœ‰å‡ ä¸ªé…ç½®è·Ÿæˆ‘çš„éœ€æ±‚ç›¸å…³:

1. `skip_render`: è·³è¿‡æŒ‡å®šæ–‡ä»¶çš„æ¸²æŸ“, åŒ¹é…åˆ°çš„æ–‡ä»¶å°†ä¼šè¢«ä¸åšæ”¹åŠ¨åœ°å¤åˆ¶åˆ° public ç›®å½•ä¸­. ä½†å¦‚æœæ˜¯ `_posts` ç›®å½•ä¸‹çš„æ–‡ä»¶, åˆ™æ˜¯ç›´æ¥å¿½ç•¥ç¼–è¯‘, ä¹Ÿä¸ä¼šå¤åˆ¶åˆ° public ç›®å½•;
2. `include` , `ignore` å’Œ `exclude`: _include å’Œ exclude é€‰é¡¹åªä¼šåº”ç”¨åˆ° `source/` ï¼Œè€Œ ignore é€‰é¡¹ä¼šåº”ç”¨åˆ°æ‰€æœ‰æ–‡ä»¶å¤¹._

**ä¸èƒ½ä½¿ç”¨ `exclude` æ¥å¿½ç•¥ `source/_posts/` ä¸­çš„æ–‡ä»¶**, åªèƒ½ä½¿ç”¨ `skip_render` æ‰èƒ½å¤„ç† `_posts` çš„æ–‡ä»¶.

å¦å¤–åœ¨æ–‡ä»¶åä¹‹å‰åŠ ä¸€ä¸ªä¸‹åˆ’çº¿ `_` ä¹Ÿä¼šè¢« Hexo å¿½ç•¥.

æ˜ç™½äº† Hexo çš„å¿½ç•¥æ–‡ä»¶çš„è§„åˆ™å, åªæœ‰ `skip_render` èƒ½æ»¡è¶³æˆ‘çš„éœ€æ±‚, æ‰€ä»¥æ¥ä¸‹æ¥å°±æ˜¯æ ¹æ®ä¸åŒçš„ç¯å¢ƒä½¿ç”¨ä¸åŒçš„é…ç½®äº†.

ä½œä¸º Spring Boot çš„è€æ‰‹, Hexo å’Œ Spring Boot çš„é…ç½®æ–‡ä»¶æƒ…å†µå·®ä¸å¤š: éƒ½æ˜¯é€šè¿‡ yaml åŠ è½½é…ç½®ä¸”å…è®¸å­˜åœ¨å¤šä¸ªé…ç½®(`_config.yml` å’Œ `_config.[theme].yml`) ç±»ä¼¼äº `application.yml` å’Œ `application-prod.yml`, é‚£ä¹ˆè‚¯å®šä¼šå­˜åœ¨ä¸€ä¸ªé…ç½®ä¼˜å…ˆçº§ä»¥åŠé…ç½®åˆå¹¶çš„æ“ä½œ, é‚£ä¹ˆæˆ‘ä»¬å¯ä¸å¯ä»¥é€šè¿‡ä¸åŒçš„é…ç½®æ¥å®ç°æ ¹æ® **æ ¹æ®ç¯å¢ƒæ¥é€‰æ‹©ä¸åŒçš„é…ç½®ä»è€Œå®ç°å‘å¸ƒä¸åŒçš„åšæ–‡**?

#### Hexo é…ç½®

åœ¨ç¿»çœ‹äº† Hexo çš„å®˜æ–¹æ–‡æ¡£å, è·Ÿæˆ‘ä¸Šé¢çš„çŒœæƒ³ä¸€æ ·, æ‰€ä»¥æˆ‘ä»¬é¦–å…ˆè¦äº†è§£ä¸€ä¸‹ Hexo å¦‚ä½•åŠ è½½é…ç½®ä»¥åŠé…ç½®çš„ä¼˜å…ˆçº§.

#### æŒ‡å®šé…ç½®æ–‡ä»¶

<!--
https://hexo.io/zh-cn/docs/configuration#%E4%BD%BF%E7%94%A8%E4%BB%A3%E6%9B%BF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6
-->

Hexo å¯ä»¥åœ¨ `hexo-cli` ä¸­ä½¿ç”¨ `--config` å‚æ•°æ¥æŒ‡å®šè‡ªå®šä¹‰é…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚ ä½¿ç”¨ä¸€ä¸ª YAML æˆ– JSON æ–‡ä»¶çš„è·¯å¾„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é€—å·åˆ†éš”ï¼ˆæ— ç©ºæ ¼ï¼‰çš„å¤šä¸ª YAML æˆ– JSON æ–‡ä»¶çš„è·¯å¾„ã€‚

```
# use 'custom.yml' in place of '_config.yml'
$ hexo server --config custom.yml

# use 'custom.yml' & 'custom2.json', prioritizing 'custom2.json'
$ hexo server --config custom.yml,custom2.json
```

å½“ä½ æŒ‡å®šäº†å¤šä¸ªé…ç½®æ–‡ä»¶ä»¥åï¼ŒHexo ä¼šæŒ‰é¡ºåºå°†è¿™éƒ¨åˆ†é…ç½®æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ª `_multiconfig.yml`ã€‚ åé¢çš„å€¼ä¼˜å…ˆã€‚ è¿™ä¸ªåŸåˆ™é€‚ç”¨äºä»»æ„æ•°é‡ã€ä»»æ„æ·±åº¦çš„ YAML å’Œ JSON æ–‡ä»¶ã€‚ è¯·æ³¨æ„: **åˆ—è¡¨ä¸­ä¸å…è®¸æœ‰ç©ºæ ¼**ã€‚

å¦‚æœ `custom.yml` ä¸­æŒ‡å®šäº† `foo: bar`ï¼Œåœ¨ custom2.json ä¸­æŒ‡å®šäº† `"foo": "dinosaur"`ï¼Œé‚£ä¹ˆåœ¨ `_multiconfig.yml` ä¸­ä½ ä¼šå¾—åˆ° `foo: dinosaur`ã€‚

ä¸€å¥è¯æ€»ç»“: `--config` ä¸­çš„é…ç½®æ–‡ä»¶çš„ä¼˜å…ˆçº§è¶Šæ¥è¶Šé«˜. æ‰€ä»¥æˆ‘åªéœ€è¦æŠŠéœ€è¦æ›¿æ¢çš„é…ç½®æ”¾åœ¨æœ€åå³å¯.

æœ€åä¸€ä¸ªé—®é¢˜æ˜¯ `_config.yml` å’Œ `_config.[theme].yml` çš„ä¼˜å…ˆçº§:

**Hexo åœ¨åˆå¹¶ä¸»é¢˜é…ç½®æ—¶ï¼ŒHexo é…ç½®æ–‡ä»¶ä¸­çš„ `theme_config` çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œå…¶æ¬¡æ˜¯ `_config.[theme].yml` æ–‡ä»¶ã€‚ æœ€åæ˜¯ä½äºä¸»é¢˜ç›®å½•ä¸‹çš„ `_config.yml` æ–‡ä»¶ã€‚**

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿˜åŸå‡º `hexo server` åŠ è½½é…ç½®çš„å®Œæ•´å‘½ä»¤:

```
hexo server --config _config.yml,_config.[theme].yml
```

æ‰€ä»¥æˆ‘åªéœ€è¦åœ¨æœ¬åœ°é¢„è§ˆå’Œå‘å¸ƒæ—¶åŠ è½½ä¸€ä¸ªè‡ªå®šä¹‰é…ç½®å³å¯.

**é¢„è§ˆå‘½ä»¤**:

```bash
hexo clean && hexo generate --config _config.yml,_config.anzhiyu.yml,_config.local.yml && hexo server --config _config.yml,_config.anzhiyu.yml,_config.local.yml
```

**å‘å¸ƒå‘½ä»¤**:

```bash
hexo clean && hexo recommend --config _config.yml,_config.anzhiyu.yml,_config.publish.yml && hexo generate --config _config.yml,_config.anzhiyu.yml,_config.publish.yml
```

åŒºåˆ«æ˜¯ `_config.local.yml` å’Œ `_config.publish.yml`:

**\_config.local.yml**

```yaml
skip_render:
	# å¿½ç•¥ _posts/publish/** ä¸­æ‰€æœ‰æ–‡ä»¶
  - _posts/publish/**
```

**\_config.publish.yml**

```yaml
skip_render: 
  # åªå¤„ç† _posts/publish/** æ–‡ä»¶, å…¶ä»–å…¨éƒ¨å¿½ç•¥
  - _posts/[0-9][0-9][0-9][0-9]/**
  # - _posts/publish/**
```

> å¦‚æœåšå®¢æ–‡ç« è¾ƒå¤š, å¯ä»¥é€‰æ‹©åªé¢„è§ˆæŒ‡å®šçš„ç›®å½•, æ¯”å¦‚æˆ‘ç°åœ¨æ–°çš„åšå®¢åœ¨ 2024 è¿™ä¸ªç›®å½•ä¸‹, æ„æ€æ˜¯æœ¬åœ°é¢„è§ˆæ—¶åªéœ€è¦é¢„è§ˆè¿™ä¸ªç›®å½•ä¸‹æ–°å†™çš„æ–‡ç« , æ‰€ä»¥åœ¨ `_config.local.yml` å¯ä»¥è¿™æ ·é…ç½®:
>
> ```yaml
> skip_render: 
>     # æ³¨é‡Šå³ä»£è¡¨æœ¬æ¬¡éœ€è¦å¤„ç†çš„ç›®å½•, å…¶ä»–çš„å…¨éƒ¨å¿½ç•¥
>   - _posts/[0-9][0-9][0-9][0-9]/**
>   - _posts/publish/**
> ```
> 
> è¿™æ ·å°±åªä¼šç¼–è¯‘ 2024 è¿™ä¸ªç›®å½•ä¸‹çš„ md æ–‡ä»¶, å¤§å¤§åŠ å¿« Hexo å¯åŠ¨é€Ÿåº¦.

**è¿™èŠ‚æè¿°çš„æ–‡ç« å¤„ç†éœ€è¦åœ¨ä¸Šä¼ æ—¶æ‹·è´ md æ–‡ä»¶åˆ° publish ç›®å½•, é€»è¾‘åœ¨** [å›¾ç‰‡ä¸Šä¼ ](#å›¾ç‰‡ä¸Šä¼ ) çš„è„šæœ¬ä¸­.

---

## éƒ¨ç½²åˆ°æœ¬åœ°æœåŠ¡å™¨

åšå®¢æ–‡ç« ä¼šåŒæ­¥éƒ¨ç½²åˆ°æˆ‘æœ¬åœ°çš„ M920x æœåŠ¡å™¨å’Œ GitHub ä¸Š.

M920x æœåŠ¡å™¨é€šè¿‡ Nginx æä¾›äº†é™æ€ç«™ç‚¹, æˆ‘åªéœ€è¦å°†ç¼–è¯‘åçš„æ–‡ä»¶ä¸Šä¼ åˆ°æŒ‡å®šç›®å½•å³å¯, ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„è„šæœ¬, é€šè¿‡ `rsync` å¢é‡ä¸Šä¼ æ–‡ä»¶:

```bash
#!/bin/bash

# è·å–å½“å‰è„šæœ¬çš„æ‰€åœ¨ç›®å½•
SCRIPT_DIR=$(dirname "$(realpath "$0")")
# åˆ‡æ¢åˆ° Makefile æ‰€åœ¨çš„å·¥ä½œç›®å½• (å³è„šæœ¬æ‰€åœ¨ç›®å½•çš„çˆ¶ç›®å½•)
cd "$SCRIPT_DIR/.." || exit 1

# å®šä¹‰å˜é‡
REMOTE_HOST="m920x"
# m920x Nginx
REMOTE_DIR="/opt/1panel/apps/openresty/openresty/www/sites/blog/index"
LOCAL_DIR="public" # ä¸Šä¼  public ä¸­æ‰€æœ‰çš„æ–‡ä»¶

# ç”Ÿæˆæœ€æ–°çš„æ–‡ä»¶
echo "æ­£åœ¨æ‰§è¡Œ hexo clean && hexo g ä»¥ç”Ÿæˆæœ€æ–°çš„æ–‡ä»¶..."
hexo clean && hexo recommend --config _config.yml,_config.anzhiyu.yml,_config.publish.yml && hexo generate --config _config.yml,_config.anzhiyu.yml,_config.publish.yml

# æ£€æŸ¥ public ç›®å½•æ˜¯å¦ç”ŸæˆæˆåŠŸ
if [ ! -d "$LOCAL_DIR" ]; then
  echo "public ç›®å½•ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ Hexo é…ç½®ï¼"
  exit 1
fi

# ä¸Šä¼ æ–‡ä»¶åˆ°è¿œç¨‹å¹¶è¦†ç›–
echo "æ­£åœ¨ä¸Šä¼  public ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åˆ° $REMOTE_HOST:$REMOTE_DIR..."
rsync -azqhP --delete \
  --exclude '.DS_Store' \
  --exclude '._*' \
  --exclude '__MACOSX' \
  "$LOCAL_DIR/" "$REMOTE_HOST:$REMOTE_DIR" | tee /dev/null

# æ£€æŸ¥ä¸Šä¼ æ˜¯å¦æˆåŠŸ
if [ $? -eq 0 ]; then
  echo "æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼"
else
  echo "æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿æ¥æˆ–æƒé™é…ç½®ã€‚"
  exit 1
fi
```

> å¦‚æœä½¿ç”¨ Hexo çš„ [hexo-deployer-rsync](https://github.com/hexojs/hexo-deployer-rsync) æ’ä»¶(`npm install hexo-deployer-rsync --save`) æ›¿æ¢ä¸Šé¢çš„è„šæœ¬éƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Š, éœ€è¦ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤:
>
> ```bash
> hexo clean && hexo deploy --config _config.yml,_config.anzhiyu.yml,_config.publish.yml
> ```
>
> è¿™é‡Œå†è¡¥å……ä¸€ä¸‹æ’ä»¶çš„å®Œæ•´é…ç½®:
>
> ```yaml
> deploy:
>   - type: rsync
>     host: m920x
>     user: root
>     root: /opt/1panel/apps/openresty/openresty/www/sites/blog/index # å®é™…çš„ hexo éƒ¨ç½²ç›®å½•
>     port: 22 # é»˜è®¤ç«¯å£ 22
>     delete: true # åŒæ­¥åˆ é™¤äº‘æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶
>     progress: true # æ˜¾ç¤ºåŒæ­¥è¿›åº¦
>     args: --exclude='.DS_Store' --exclude='._*' --exclude='__MACOSX' # æ·»åŠ è¦å¿½ç•¥çš„æ–‡ä»¶
>     rsh: # å¯é€‰ï¼ŒæŒ‡å®šè¦ä½¿ç”¨çš„è¿œç¨‹ shell
>     key: # å¯é€‰ï¼Œè‡ªå®šä¹‰ SSH ç§é’¥è·¯å¾„
>     verbose: true # æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
>     ignore_errors: false # ä¸å¿½ç•¥é”™è¯¯
>     create_before_update: false # é¦–å…ˆåˆ›å»ºä¸å­˜åœ¨çš„æ–‡ä»¶ï¼Œç„¶åæ›´æ–°ç°æœ‰æ–‡ä»¶
> ```

è¿™é‡Œè¡¥å……ä¸€ä¸‹ `hexo deploy` çš„æ‰§è¡Œé€»è¾‘:

> `hexo deploy` æ‰§è¡Œæ—¶ä¼šå…ˆç¼–è¯‘æ–‡ä»¶, ç„¶åå°† `public` ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶æ‹·è´åˆ°åŒçº§ç›®å½•ä¸‹çš„ `.deploy_git` ä¸­, ç„¶åå†æ¨é€åˆ°æŒ‡å®šçš„åœ°æ–¹, æ¯”å¦‚é…ç½®çš„æœåŠ¡å™¨ç›®å½•æˆ– GitHub ä»“åº“.

---

## éƒ¨ç½²åˆ° GitHub

è¿™é‡Œç›´æ¥ä½¿ç”¨æ’ä»¶æ¥å®Œæˆ GitHub çš„éƒ¨ç½²:

```bash
npm install hexo-deployer-git --save
```

**é…ç½®å¦‚ä¸‹:**

```bash
## Docs: https://hexo.io/docs/one-command-deployment
deploy:
  - type: git
    repo: https://github.com/{username}/{username}.github.io
    branch: master
```

**éƒ¨ç½²å‘½ä»¤**:

```bash
hexo clean && hexo deploy --config _config.yml,_config.anzhiyu.yml,_config.publish.yml
```

å¦‚ä½•ä½¿ç”¨ GitHub Pages éƒ¨ç½² Hexo å¯ä»¥å‚è€ƒå…¶ä»–æ–‡ç« , è¿™é‡Œä¸å†èµ˜è¿°:

- [åœ¨ GitHub Pages ä¸Šéƒ¨ç½² Hexo](https://hexo.io/zh-cn/docs/github-pages)

- [ä½¿ç”¨ Github Action è‡ªåŠ¨éƒ¨ç½²](https://blog.anheyu.com/posts/asdx.html)

---

## å¤‡ä»½

åœ¨ [[home-data|HomeLabå­˜å‚¨ä¸å¤‡ä»½ï¼šæ•°æ®å ¡å’-ä¿éšœæ•°æ®å’Œéšç§çš„å­˜å‚¨è§£å†³æ–¹æ¡ˆ]] ä¸­æœ‰è®²åˆ°å¦‚ä½•ä½¿ç”¨ **3-2-1 å¤‡ä»½åŸåˆ™** æ¥æŒ‡å¯¼å¦‚ä½•å¤‡ä»½é‡è¦æ–‡ä»¶.

è¿™é‡Œçš„åŸå§‹æ–‡ä»¶æ–‡ä»¶æˆ‘å·²ç»ä½¿ç”¨ **Synology Drive Client** çš„å¤‡ä»½åŠŸèƒ½å¤‡ä»½åˆ°äº† NAS ä¸Š, é‚£å‰©ä¸‹çš„å°±æ˜¯äº‘ç«¯å¤‡ä»½äº†, è¿™é‡Œå½“ç„¶æ˜¯ç™½å«– GitHub å’Œ Gitee äº†.

åŒæ—¶æ¨é€åˆ° GitHub å’Œ Gitee:

```bash
#!/bin/bash

# è·å–å½“å‰è„šæœ¬çš„æ‰€åœ¨ç›®å½•
SCRIPT_DIR=$(dirname "$(realpath "$0")")

# åˆ‡æ¢åˆ° Makefile æ‰€åœ¨çš„å·¥ä½œç›®å½• (å³è„šæœ¬æ‰€åœ¨ç›®å½•çš„çˆ¶ç›®å½•)
cd "$SCRIPT_DIR/.." || exit 1

# ä½¿ç”¨ç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸ºæäº¤ä¿¡æ¯ï¼Œå¦‚æœæœªæä¾›å‚æ•°ï¼Œåˆ™ä½¿ç”¨é»˜è®¤ä¿¡æ¯
COMMIT_MESSAGE=${1:-"æ‘˜è¦ç”Ÿæˆ"}

# æ‰§è¡Œ Git æ“ä½œ
git add .
git commit -m "$COMMIT_MESSAGE"
git push -u github main
git push -u gitee main
#!/bin/bash

# è·å–å½“å‰è„šæœ¬çš„æ‰€åœ¨ç›®å½•
SCRIPT_DIR=$(dirname "$(realpath "$0")")

# åˆ‡æ¢åˆ° Makefile æ‰€åœ¨çš„å·¥ä½œç›®å½• (å³è„šæœ¬æ‰€åœ¨ç›®å½•çš„çˆ¶ç›®å½•)
cd "$SCRIPT_DIR/.." || exit 1

# ä½¿ç”¨ç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸ºæäº¤ä¿¡æ¯ï¼Œå¦‚æœæœªæä¾›å‚æ•°ï¼Œåˆ™ä½¿ç”¨é»˜è®¤ä¿¡æ¯
COMMIT_MESSAGE=${1:-"æ‘˜è¦ç”Ÿæˆ"}

# æ‰§è¡Œ Git æ“ä½œ
git add .
git commit -m "$COMMIT_MESSAGE"
git push -u github main
git push -u gitee main
```

å› ä¸ºä¸€å¼€å§‹æäº¤äº†å¤§é‡å›¾ç‰‡, å¯¼è‡´è§¦å‘äº† Gitee çš„ä»“åº“å®¹é‡é™åˆ¶é˜ˆå€¼, è§£å†³åŠæ³•å¯ä»¥çœ‹ [[git-clean|è§£å†³ git ä»“åº“ä½“ç§¯è¿‡å¤§å¯¼è‡´ push å¤±è´¥çš„é—®é¢˜]].

---

## éƒ¨ç½²æµç¨‹åŒ–

å‰é¢çš„æ­¥éª¤éƒ½æ˜¯ç‹¬ç«‹è¿è¡Œçš„, ä¸ºäº†å°†æ•´ä¸ªæµç¨‹ä¸²èµ·æ¥, æˆ‘ä½¿ç”¨äº† **makefile**, åœ¨ VSCode ä¸­éœ€è¦å®‰è£… ~~[Makefile buttons](https://marketplace.visualstudio.com/items?itemName=hablof.makefile-buttons)~~ (æ¨èä½¿ç”¨[vscode-makefile-term](https://github.com/lfmunoz/vscode-makefile-term) æ¥è¿è¡Œ)æ’ä»¶æ¥æ”¯æŒè¿è¡Œæµç¨‹:

![20241231185714_Kvn3dfgp.webp](https://cdn.dong4j.site/source/image/20241231185714_Kvn3dfgp.webp)

**makefile** é…ç½®å¦‚ä¸‹:

```bash
# å®šä¹‰ä¼ªç›®æ ‡ï¼Œé¿å…ä¸æ–‡ä»¶åå†²çª
.PHONY: clean_images convert_and_rename upload_images generate_summary_tags push deploy-m920x deploy-github clean

########## éœ€è¦ç»ˆç«¯åœ¨ hexo é¡¶å±‚ç›®å½•æ‰èƒ½æ­£å¸¸æ‰§è¡Œ

# é»˜è®¤ç›®æ ‡
all: clean_images convert_and_rename upload_images generate_summary_tags push deploy-m920x deploy-github clean

# æœ¬åœ°è¿è¡Œ
dev:
	@echo "==================Step 5: Deploying application=================="
	hexo clean && hexo generate --config _config.yml,_config.anzhiyu.yml,_config.local.yml && hexo server --config _config.yml,_config.anzhiyu.yml,_config.local.yml

# åˆ é™¤æœªè¢«å¼•ç”¨çš„å›¾ç‰‡, ä¸ä¼ ä»»ä½•å‚æ•°åˆ™å…¨éƒ¨å¤„ç†, ä¼  2023 åˆ™åªå¤„ç† 2023 ç›®å½•ä¸‹çš„æ–‡ä»¶, ä¼  md æ–‡ä»¶å, åˆ™åªå¤„ç†è¿™ä¸€ä¸ªæ–‡ä»¶
clean_images:
	@echo "==================Step 1: Cleaning images=================="
	python script/clean_images.py

# å°†å›¾ç‰‡è½¬æ¢ä¸º webp ä¸”é‡å‘½å(å¹´æœˆæ—¥æ—¶åˆ†ç§’_8ä½éšæœºå­—ç¬¦ä¸².webp)
convert_and_rename:
	@echo "==================Step 2: Cleaning images=================="
	python script/convert_and_rename.py

# ä¸Šä¼ å›¾ç‰‡
upload_images:
	@echo "==================Step 3: Cleaning images=================="
	python script/upload_images.py

# ç”Ÿæˆæ‘˜è¦å’Œæ ‡ç­¾
generate_summary_tags:
	@echo "==================Step 3: Cleaning images=================="
	python script/generate_summary_and_tags_and_replace.py

# æ‰§è¡Œ git-push.sh
push:
	@echo "==================Step 4: Pushing changes to Git=================="
	script/git-push.sh "æ¢å¤è¢«åˆ é™¤çš„ svg"

# æ‰§è¡Œ deploy.sh
deploy-m920x: push
	@echo "==================Step 5: Deploying application=================="
	script/deploy.sh

# å‘å¸ƒåˆ° github
deploy-github: push
	@echo "==================Step 6: Deploying Github=================="
	hexo deploy

clean:
	@echo "==================Step 7: Cleaning up=================="
	hexo clean && rm -rf .deploy_git
```

å¯ä»¥ç›´æ¥åœ¨ **makefile** ç‚¹å‡» **all** æ‰§è¡Œæ‰€æœ‰æµç¨‹, ä¹Ÿå¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ:

```bash
make all
```

å½“ç„¶æ¯ä¸ªæµç¨‹ä¹Ÿæ”¯æŒç‹¬ç«‹æ‰§è¡Œ, è¿™æ ·å°±ä¸ç”¨å†å»è®°å¿†å¤§é‡çš„å‘½ä»¤.

## æ€»ç»“

![20250102025932_4SCvYvPO.webp](https://cdn.dong4j.site/source/image/20250102025932_4SCvYvPO.webp)

![20250102025932_NrFdBkVf.webp](https://cdn.dong4j.site/source/image/20250102025932_NrFdBkVf.webp)

ä»¥ä¸Šå°±æ˜¯æˆ‘çš„åšå®¢çš„æ•´ä¸ªå·¥ä½œæµç¨‹, ä»¥åè¿˜ä¼šå¢åŠ æ›´å¤šçš„å¤„ç†æ­¥éª¤, æ¯”å¦‚ä½¿ç”¨ AI è‡ªåŠ¨ç”Ÿæˆåˆ†ç±», ä½¿ç”¨ AI ä¿®æ”¹é”™åˆ«å­—ç­‰ç­‰æ“ä½œ, æˆ‘åªéœ€è¦åœ¨ `script` ä¸­æ–°å¢è„šæœ¬, ç„¶åæ·»åŠ åˆ° **makefile** çš„æµç¨‹ä¸­å³å¯.

ä»¥ä¸Šè„šæœ¬è¿˜å€¼å¾—ä¼˜åŒ–, æ¯”å¦‚æå‡ºå…¬å…±æ–¹æ³•åˆ° `utils.py` ä¸­, è¿™ä¸ªåç»­ä¼šæ…¢æ…¢è¿­ä»£

åšå®¢ä¸­æ¶‰åŠåˆ°çš„æ‰€æœ‰è„šæœ¬å·²ä¸Šä¼ åˆ° [ä»“åº“](https://github.com/dong4j/hexo-deploy-workflow), å¯æ ¹æ®è‡ªå·±çš„æƒ…å†µè‡ªè¡Œä¿®æ”¹.

## [ç¾¤æ™– NAS Docker ç½‘ç»œä¼˜åŒ–ï¼šé…ç½® HTTP/SOCKS5 ä»£ç†çš„ç»ˆææŒ‡å—](https://blog.dong4j.site/posts/13a784a6.md)

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ç¾¤æ™– NAS ï¼ˆæœ¬æ–‡åœ¨ DSM 7.2 ç‰ˆæœ¬æµ‹è¯•é€šè¿‡ï¼‰ï¼Œå¯èƒ½ä¼šé‡åˆ°æ— æ³•ä¸‹è½½ Docker é•œåƒçš„æƒ…å†µã€‚é€šè¿‡é…ç½®ä»£ç†ï¼Œä½ å¯ä»¥è½»æ¾ç»•è¿‡è¿™äº›é™åˆ¶ï¼Œé¡ºåˆ©ä¸‹è½½å’Œæ›´æ–°é•œåƒã€‚æœ¬æ•™ç¨‹æ•™ä½ å¦‚ä½•ä¸º Docker è®¾ç½®ä»£ç†ï¼Œè®© Docker æœ¬èº«çš„ç½‘ç»œè¯·æ±‚èµ°ä½ æŒ‡å®šçš„ HTTP æˆ– SOCKS5 ä»£ç†æœåŠ¡å™¨ã€‚

#### ä¸ºä»€ä¹ˆéœ€è¦ä»£ç†ï¼Ÿ

å›½å†…ç›®å‰ç½‘ç»œç¯å¢ƒå¯èƒ½ä¼šé™åˆ¶ä½ è®¿é—® Docker é•œåƒåº“ï¼ˆä¾‹å¦‚ `docker pull` ç­‰æ“ä½œï¼‰ï¼Œå°¤å…¶æ˜¯å®˜æ–¹çš„å›½å¤–é•œåƒåº“ã€‚é…ç½® HTTP æˆ– SOCKS5 ä»£ç†å¯ä»¥è®©ä½ ç»•è¿‡è¿™äº›é™åˆ¶ï¼Œé¡ºç•…åœ°æ‹‰å–é•œåƒã€‚

### æ“ä½œæ­¥éª¤

#### 1. ç™»å½•åˆ°ç¾¤æ™– NAS

é¦–å…ˆï¼Œä½ éœ€è¦é€šè¿‡ SSH è¿æ¥åˆ°ä½ çš„ç¾¤æ™– NASã€‚åœ¨ DSM ä¸­ï¼Œè¿›å…¥ **æ§åˆ¶é¢æ¿ > ç»ˆç«¯æœºä¸ SNMP**ï¼Œå¯ç”¨ SSH æœåŠ¡ã€‚ç„¶åæ‰“å¼€å‘½ä»¤è¡Œå·¥å…·ï¼ˆWindows ç”¨ PuTTYï¼ŒMac æˆ– Linux ç”¨ Terminalï¼‰ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼šï¼ˆå‘½ä»¤å›è½¦æ‰§è¡Œï¼‰

> [[CMD] Windows SSH è¿æ¥æœåŠ¡å™¨æ•™ç¨‹ (ç³»ç»Ÿè‡ªå¸¦æ–¹å¼)](https://www.itblogcn.com/article/2266.html)

æ›¿æ¢ `<ç”¨æˆ·å>` ä¸ºä½ çš„ç¾¤æ™–ç®¡ç†å‘˜ç”¨æˆ·åï¼Œ`<NAS_IP>` ä¸º NAS çš„ IP åœ°å€ã€‚æ¥ç€åˆ‡æ¢åˆ° root æƒé™ï¼ˆéœ€è¦è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼‰ï¼š

#### 2. ä¸º Docker åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶å¤¹

åœ¨ SSH ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
ssh <ç”¨æˆ·å>@<NAS_IP>
```

#### 3. åˆ›å»ºå¹¶ç¼–è¾‘ä»£ç†é…ç½®æ–‡ä»¶

åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶æ¥å­˜æ”¾ä»£ç†ä¿¡æ¯ï¼š

```bash
sudo -i
```

ç”¨ vi æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€å®ƒï¼š

```bash
mkdir -p /etc/systemd/system/pkg-ContainerManager-dockerd.service.d
```

è¿›å…¥æ’å…¥æ¨¡å¼ï¼šæŒ‰ä¸‹ i é”®ï¼Œè¿™æ—¶ä½ ä¼šçœ‹åˆ°åº•éƒ¨å‡ºç° â€” INSERT â€” çš„æç¤ºï¼Œè¡¨ç¤ºå¯ä»¥å¼€å§‹ç¼–è¾‘æ–‡æœ¬ã€‚

è¾“å…¥æˆ–ç²˜è´´å†…å®¹ï¼š åœ¨æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼Œè®¾ç½® HTTP å’Œ HTTPS ä»£ç†ï¼šï¼ˆ`shift+insert`å¯ç²˜è´´ï¼‰

```bash
touch /etc/systemd/system/pkg-ContainerManager-dockerd.service.d/http-proxy.conf
```

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Socks5 ä»£ç†ï¼Œæ”¹ä¸ºï¼š

```bash
vi /etc/systemd/system/pkg-ContainerManager-dockerd.service.d/http-proxy.conf
```

å¦‚æœéœ€è¦è®¤è¯ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```bash
[Service]
Environment="HTTP_PROXY=http://192.168.1.3:10808"
Environment="HTTPS_PROXY=http://192.168.1.3:10808"
Environment="NO_PROXY=localhost,127.0.0.1"
```

æ³¨æ„ï¼šæ›¿æ¢ 192.168.1.3:10808 å’Œ ç”¨æˆ·å: å¯†ç  ä¸ºä½ è‡ªå·±çš„ä¿¡æ¯ã€‚

ä¿å­˜å¹¶é€€å‡ºï¼š

- æŒ‰ Esc é”®ï¼Œé€€å‡ºæ’å…¥æ¨¡å¼ã€‚
- è¾“å…¥ :wq ç„¶åæŒ‰ Enter é”®ï¼Œè¡¨ç¤ºä¿å­˜å¹¶é€€å‡ºã€‚

å¦‚æœåœ¨ vi ä¸­ä¸å°å¿ƒè¿›å…¥äº†é”™è¯¯æ¨¡å¼ï¼Œä½ å¯ä»¥æŒ‰ Esc é”®ï¼Œç„¶åè¾“å…¥ :q! å†æŒ‰ Enter é€€å‡ºè€Œä¸ä¿å­˜ä»»ä½•æ›´æ”¹ã€‚

#### 4. é‡æ–°åŠ è½½å¹¶é‡å¯ Docker æœåŠ¡

å®Œæˆé…ç½®åï¼Œéœ€è¦é‡æ–°åŠ è½½ä¸€ä¸‹é…ç½®æ–‡ä»¶ï¼Œå¹¶é‡å¯ Docker æœåŠ¡ï¼š

```bash
[Service]
Environment="HTTP_PROXY=socks5://192.168.1.3:10808"
Environment="HTTPS_PROXY=socks5://192.168.1.3:10808"
Environment="NO_PROXY=localhost,127.0.0.1"
```

#### 5. éªŒè¯ä»£ç†æ˜¯å¦è®¾ç½®æˆåŠŸ

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éªŒè¯ä¸€ä¸‹ä»£ç†è®¾ç½®æ˜¯å¦ç”Ÿæ•ˆã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ Docker çš„ç¯å¢ƒå˜é‡ï¼š

```bash
[Service]
Environment="HTTP_PROXY=socks5://ç”¨æˆ·å:å¯†ç @192.168.1.3:10808"
Environment="HTTPS_PROXY=socks5://ç”¨æˆ·å:å¯†ç @192.168.1.3:10808"
Environment="NO_PROXY=localhost,127.0.0.1"
```

å¦‚æœæ˜¾ç¤ºçš„å†…å®¹ä¸­æœ‰ä½ åˆšåˆšè®¾ç½®çš„ä»£ç†ä¿¡æ¯ï¼Œè¯´æ˜é…ç½®æˆåŠŸï¼š

```bash
systemctl daemon-reload
systemctl restart pkg-ContainerManager-dockerd.service
```

#### 6. æµ‹è¯• Docker ä»£ç†

æœ€åï¼Œæˆ‘ä»¬é€šè¿‡æ‹‰å–é•œåƒæµ‹è¯•ä»£ç†æ˜¯å¦ç”Ÿæ•ˆã€‚è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

å¦‚æœé•œåƒèƒ½æ­£å¸¸ä¸‹è½½ï¼Œè¯´æ˜ Docker å·²ç»é€šè¿‡ä»£ç†æˆåŠŸè¿æ¥ç½‘ç»œã€‚

å¦å¤–å¦‚æœè¦åœ¨ Docker å®¹å™¨å†…é€šè¿‡ä»£ç†è®¿é—®ç½‘ç»œï¼Œä½ å¯ä»¥åœ¨è¿è¡Œ Docker å®¹å™¨æ—¶ï¼Œè®¾ç½®ç¯å¢ƒå˜é‡æ¥æŒ‡å®šä»£ç†ï¼Œä¾‹å¦‚ï¼š

```bash
systemctl show --property=Environment pkg-ContainerManager-dockerd.service
```

### æ€»ç»“

æ­å–œï¼ä½ å·²ç»æˆåŠŸä¸º Docker è®¾ç½®äº†ä»£ç†ã€‚åœ¨å—é™ç½‘ç»œç¯å¢ƒä¸­ï¼Œä»£ç†æ˜¯éå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œå¸®åŠ©ä½ é¡ºåˆ©æ‹‰å–é•œåƒã€‚æŒ‰ç…§æœ¬æ•™ç¨‹ï¼Œä½ åªéœ€ç™»å½• NASï¼Œåˆ›å»ºå¹¶ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œç„¶åé‡å¯ Docker æœåŠ¡ï¼Œå°±èƒ½è®© Docker ä½¿ç”¨ä»£ç†äº†ã€‚

å¸Œæœ›è¿™ä¸ªç®€å•çš„æŒ‡å—å¯¹ä½ æœ‰å¸®åŠ©ï¼èµ¶å¿«è¯•è¯•å§ï½

### å‚è€ƒ

- [ä¸ºç¾¤æ™– Container Manager é…ç½®ä»£ç†](https://blog.chai.ac.cn/posts/docker-proxy)
- [æ€æ ·æ‰èƒ½è®©æˆ‘çš„ docker èµ°ä»£ç†](https://v2ex.com/t/874777)

## [å›¾ç‰‡è¿‡å¤šå¯¼è‡´GitHub/Giteeä»“åº“çˆ†ä»“ï¼Ÿè¿™é‡Œæœ‰è§£å†³æ–¹æ¡ˆï¼](https://blog.dong4j.site/posts/d4c941b5.md)

![/images/cover/20241229170536_bsenV6FP.webp](https://cdn.dong4j.site/source/image/20241229170536_bsenV6FP.webp)

## èƒŒæ™¯

æœ€è¿‘åœ¨è¿›è¡Œåšå®¢è¿ç§», ä»¥å‰åƒè¿‡å›¾åºŠçš„äº, æ‰€ä»¥è¿™æ¬¡å°†å›¾ç‰‡å…¨éƒ¨ä¿ç•™åœ¨æœ¬åœ°, å¹¶ä½¿ç”¨ GitHub å’Œ Gitee æ¥ä½œå¤‡ä»½, ä½†æ˜¯å› ä¸ºå¤§é‡çš„å›¾ç‰‡æäº¤å¯¼è‡´å‡ºå‘äº† Gitee çš„ä»“åº“ä½“ç§¯é™åˆ¶, åœ¨æœ€è¿‘å‡ æ¬¡æäº¤æ—¶, å‡ºç°äº†å¦‚ä¸‹é”™è¯¯:

```bash
remote: Powered by GITEE.COM [1.1.5]
remote: Set trace flag 784c0784
remote: Repo size: 1077.199MB, exceeds quota 1024MB
remote: Push rejected for repository [size exceeds limit]
remote: HelpLink:           https://gitee.com/help/articles/4232
remote: Repository GC:      https://gitee.com/xxx/hexo-site/settings#git-gc
remote: Enterprise Edition: https://gitee.com/enterprises#commerces
To gitee.com:dong4j/hexo-site.git
 ! [remote rejected] main -> main (pre-receive hook declined)
error: failed to push some refs to 'gitee.com:xxx/hexo-site.git'
```

## è§£å†³

æ ¹æ® Gitee çš„å®˜æ–¹æ–‡æ¡£ä»‹ç», Gitee å¹³å°ç›®å‰å¯¹ä»“åº“çš„é…é¢å¦‚ä¸‹ï¼š

| å¥—é¤   | å…è´¹ç‰ˆ      | åŸºç¡€ç‰ˆ      | æ ‡å‡†ç‰ˆ      | é«˜çº§ç‰ˆ      | å°Šäº«ç‰ˆ      |
| ------ | ----------- | ----------- | ----------- | ----------- | ----------- |
| å•ä»“åº“ | æœ€å¤§ 500 MB | æœ€å¤§ 1 GB   | æœ€å¤§ 1 GB   | æœ€å¤§ 2 GB   | æœ€å¤§ 3 GB   |
| å•æ–‡ä»¶ | æœ€å¤§ 50 MB  | æœ€å¤§ 100 MB | æœ€å¤§ 100 MB | æœ€å¤§ 200 MB | æœ€å¤§ 300 MB |

### 1. æ¸…ç†ä¸å¿…è¦çš„å¯¹è±¡

é¦–å…ˆå¯ä»¥å°è¯•æ¸…ç†ä¸€äº›ä¸å¿…è¦çš„ Git å¯¹è±¡:

```bash
git gc --prune=now
```

è¿™ä¸ªå‘½ä»¤ä¼šå‹ç¼© Git ä»“åº“ä¸­çš„å†å²ï¼Œæ¸…ç†æ¾æ•£å¯¹è±¡ï¼Œå¹¶åˆ é™¤æ— æ³•è®¿é—®çš„å¯¹è±¡ã€‚

> å­˜å‚¨åº“ GC å¯ä»¥æ£€æŸ¥ä»“åº“ä¸­æœªä½¿ç”¨çš„å¯¹è±¡å’Œèµ„æºï¼Œå°†å…¶åˆ é™¤æˆ–å‹ç¼©æˆæ›´å°çš„å¯¹è±¡ï¼Œä»è€Œä¼˜åŒ– Git åœ¨å­˜å‚¨åº“æ€§èƒ½ï¼Œå‡å°‘å­˜å‚¨åº“ç£ç›˜å ç”¨ã€‚
>
> å½“ä»“åº“ä½“ç§¯è†¨èƒ€å¯¼è‡´è®¿é—®é€Ÿåº¦ä¸‹é™æ—¶ï¼Œé€šè¿‡ Git GC å°†å¯èƒ½æé«˜ä»“åº“çš„è®¿é—®é€Ÿåº¦ã€‚
>
> é˜¶æ®µæ—¶é—´å†…ä½¿ç”¨å¤šæ¬¡å¼ºæ¨ä»ä»“åº“ä¸­åˆ é™¤äº†å¤§é‡æ•°æ®ï¼Œä½¿ç”¨ Git GC å¯ä»¥åˆ é™¤æœªä½¿ç”¨çš„å¯¹è±¡ï¼Œé‡Šæ”¾å­˜å‚¨ç©ºé—´ã€‚

![20241228154907_R1PsKEVu.webp](https://cdn.dong4j.site/source/image/20241228154907_R1PsKEVu.webp)

æ‰§è¡Œåå¹¶æ²¡æœ‰å‡å°‘ä»“åº“ä½“ç§¯, æ‰€ä»¥è¿˜è¦ç»§ç»­.

### 2. åˆ é™¤å¤§æ–‡ä»¶çš„å†å²è®°å½•

å‰é¢è¯´äº†æˆ‘çš„ä»“åº“æäº¤äº†å¾ˆå¤šå›¾ç‰‡å’Œå°‘é‡ mp4 ç­‰å¤§ä½“ç§¯æ–‡ä»¶, æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `git-filter-repo` å·¥å…·æ¥åˆ é™¤å®ƒä»¬çš„å†å²è®°å½•ã€‚

åœ¨ macOS ä¸‹å®‰è£… `git-filter-repo`:

```bash
brew install git-filter-repo
```

ç„¶åå¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥åˆ é™¤ç‰¹å®šæ–‡ä»¶ç±»å‹çš„å†å²è®°å½•ï¼š

```bash
git filter-repo --invert-paths --path-regex '\.(jpg|jpeg|png|gif|mp4|webp|svg)$' --force
```

æ‰§è¡Œä¹‹åçš„æ•ˆæœ:

![20241228155218_2lI2gpOj.webp](https://cdn.dong4j.site/source/image/20241228155218_2lI2gpOj.webp)

æ¸…ç†æ•ˆæœéå¸¸å¥½, **ä½†æ˜¯** æŠŠæˆ‘ä»“åº“é‡Œé¢çš„æ‰€æœ‰å›¾ç‰‡å…¨éƒ¨æ¸…ç©ºäº†, æˆ‘è¦çš„æ˜¯åªåˆ é™¤å†å²è®°å½•ä¸­æäº¤çš„å›¾ç‰‡.....

è¿˜æœ‰æˆ‘æœ‰å¤‡ä»½, ä»æ¥å§..

### 3. bfg-repo-cleaner

è¿™æ¬¡ä½¿ç”¨ä¸€ä¸ªå¼€æºé¡¹ç›® [bfg-repo-cleaner](https://github.com/rtyley/bfg-repo-cleaner?tab=readme-ov-file),

ä¸‹è½½ jar æ–‡ä»¶ç„¶åé‡å‘½åä¸º **bfg.jar**, æ¯”å¦‚æˆ‘è¦åˆ é™¤å¤§äº 1M çš„æ‰€æœ‰å†å²è®°å½•:

```bash
$ java -jar bfg.jar --strip-blobs-bigger-than 100M some-big-repo.git

$ cd some-big-repo.git
$ git reflog expire --expire=now --all && git gc --prune=now --aggressive
```

æ•ˆæœè¿˜ä¸é”™:

![20241229144920_hpRQYnln.webp](https://cdn.dong4j.site/source/image/20241229144920_hpRQYnln.webp)

[å…¶ä»–ç¤ºä¾‹](https://rtyley.github.io/bfg-repo-cleaner/)

<!-- markdownlint-disable-next-line MD033 -->

<meta name="referrer" content="no-referrer"/>

## [ComfyUI Desktop å®‰è£…æ”»ç•¥ï¼šè‡ªåŠ¨åŒ–å®‰è£…å¤±è´¥é—®é¢˜è§£å†³](https://blog.dong4j.site/posts/85d50e5.md)

![/images/cover/20241229132734_VH9upmpx.webp](https://cdn.dong4j.site/source/image/20241229132734_VH9upmpx.webp)

## ç®€ä»‹

æœ€è¿‘ [ComfyUI Desktop](https://github.com/Comfy-Org/desktop) å‘å¸ƒäº† Bate ç‰ˆæœ¬ï¼Œä½†æ˜¯å®‰è£…çš„æ—¶å€™é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œè®°å½•ä¸€ä¸‹ã€‚

## é—®é¢˜

è¿™æ¬¡æˆ‘å°è¯•ç¬¬äºŒæ¬¡å®‰è£… ComfyUI-Desktopï¼Œç‰ˆæœ¬ 0.3.33(241212)ã€‚è‡ªåŠ¨å®‰è£…æ²¡æœ‰æˆåŠŸã€‚åœ¨æŸ¥çœ‹æ—¥å¿—å¹¶æ‰‹åŠ¨è¿è¡Œç¼ºå¤±çš„å‘½ä»¤åï¼Œå®‰è£…æˆåŠŸã€‚æƒ³ç»™é‡åˆ°åŒæ ·é—®é¢˜çš„æœ‹å‹ä¸€ä¸ªè§£å†³æ–¹æ³•ã€‚æˆ‘ä¸çŸ¥é“è¿™æ˜¯å¦æ˜¯ä¸€ä¸ª bugï¼Œä½†å®ƒåœ¨æˆ‘çš„æœºå™¨ä¸Šæ²¡æœ‰æ­£ç¡®éƒ¨ç½²ã€‚

## è§£å†³

[è¿™æ˜¯æˆ‘ç¬¬ä¸€æ¬¡å®‰è£…æ—¶é‡åˆ°çš„é—®é¢˜](https://github.com/Comfy-Org/desktop/issues/398)ï¼Œä¼¼ä¹ 0.3.33 ç‰ˆæœ¬å·²ç»ä¿®å¤äº†å®ƒï¼Œä½†æˆ‘åœ¨ zsh ä¸‹ä»ç„¶é‡åˆ°é—®é¢˜, æ‰€ä»¥è¿™æ¬¡æˆ‘å°†ä»…ä½¿ç”¨åˆå§‹ `.zshrc` æ–‡ä»¶ï¼š

```bash
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="robbyrussell"
plugins=(git)
source $ZSH/oh-my-zsh.sh
```

ç„¶åå°è¯•é¦–æ¬¡å¯åŠ¨ï¼š

![20241229144920_LQXrM6d9.webp](https://cdn.dong4j.site/source/image/20241229144920_LQXrM6d9.webp)

æ—¥å¿—å¦‚ä¸‹ï¼š

```
[2024-12-14 22:01:21.481] [info]  Running command: /Users/dong4j/comfy/ComfyUI/.venv/bin/python -m ensurepip --upgrade in /Users/dong4j/comfy/ComfyUI
[2024-12-14 22:01:23.353] [info]  Successfully created virtual environment at /Users/dong4j/comfy/ComfyUI/.venv
[2024-12-14 22:01:23.354] [info]  Installing PyTorch Nightly for macOS.
[2024-12-14 22:01:23.354] [info]  Running uv command: /Applications/ComfyUI.app/Contents/Resources/uv/macos/uv pip install -U --prerelease allow torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/nightly/cpu
...
[2024-12-14 22:01:23.367] [info]  ï¿½]2;clear; /Applications/ComfyUI.app/Contents/Resources/uv/macos/uv "pip"  "-U"  ï¿½ï¿½]1;clear;ï¿½
[2024-12-14 22:01:23.369] [info]
[2024-12-14 22:01:23.375] [info]  error: unexpected argument '--end-1734184883354:0' found

  tip: to pass '--end-1734184883354:0' as a value, use '-- --end-1734184883354:0'

Usage: uv pip install --upgrade --prerelease <PRERELEASE> <PACKAGE|--requirements <REQUIREMENTS>|--editable <EDITABLE>> <--index <INDEX>|--default-index <DEFAULT_INDEX>|--index-url <INDEX_URL>|--extra-index-url <EXTRA_INDEX_URL>|--find-links <FIND_LINKS>|--no-index>

For more information, try '--help'.
```

**å…³é”®ç‚¹æ˜¯**:

```bash
/Applications/ComfyUI.app/Contents/Resources/uv/macos/uv pip install -U --pre torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/nightly/cpu
```

åº”è¯¥æ˜¯ä¹‹å‰å°è¯•å®‰è£…è¿‡ [PyTorch](https://developer.apple.com/metal/pytorch/)ï¼Œä½†æ˜¯ä¸çŸ¥é“ä»€ä¹ˆåŸå› å¤±è´¥äº†ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨äº†è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…çš„ pythonï¼ˆå¯åŠ¨ ComfyUI-Desktop æ—¶è®¾ç½®çš„ç›®å½•ï¼šUsers/dong4j/comfyï¼‰ï¼š

```bash
/Users/dong4j/comfy/ComfyUI/.venv/bin/pip3 install -U --pre torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/nightly/cpu
```

æ‰§è¡Œå®Œæˆåå¯ä»¥è¿›è¡Œå¦‚ä¸‹æµ‹è¯•ï¼š

```python
import torch
if torch.backends.mps.is_available():
    mps_device = torch.device("mps")
    x = torch.ones(1, device=mps_device)
    print (x)
else:
    print ("MPS device not found.")
```

æµ‹è¯•ç»“æœï¼š

```bash
/Users/dong4j/comfy/ComfyUI/.venv/bin/python torch_test.py
tensor([1.], device='mps:0')
```

å®‰è£…åçš„è½¯ä»¶åŒ…åˆ—è¡¨ï¼š

```
âœ  ComfyUI /Users/dong4j/comfy/ComfyUI/.venv/bin/pip3 list
Package           Version
----------------- ------------------
filelock          3.16.1
fsspec            2024.10.0
Jinja2            3.1.4
MarkupSafe        3.0.2
mpmath            1.3.0
networkx          3.4.2
numpy             2.2.0
pillow            11.0.0
pip               24.0
setuptools        75.6.0
sympy             1.13.1
torch             2.6.0.dev20241214
torchaudio        2.6.0.dev20241214
torchvision       0.22.0.dev20241214
typing_extensions 4.12.2
```

ç„¶åå†æ¬¡é‡å¯ ComfyUI-Desktopï¼šç„¶åå†æ¬¡é‡å¯ ComfyUI-Desktopï¼š

![20241229144920_DtK80vkZ.webp](https://cdn.dong4j.site/source/image/20241229144920_DtK80vkZ.webp)

ç»§ç»­è¿›è¡Œåç»­å®‰è£…æ­¥éª¤åº”è¯¥å°±æ­£å¸¸äº†ï¼Œä½†æ˜¯è¿˜ç¼ºå°‘ä¸€äº›è½¯ä»¶åŒ…ï¼Œæ­¤æ—¶çš„è½¯ä»¶åŒ…åˆ—è¡¨å¦‚ä¸‹ï¼š

```
âœ  ComfyUI /Users/dong4j/comfy/ComfyUI/.venv/bin/pip3 list
Package            Version
------------------ ------------------
certifi            2024.12.14
cffi               1.17.1
charset-normalizer 3.4.0
click              8.1.7
cryptography       44.0.0
Deprecated         1.2.15
filelock           3.16.1
fsspec             2024.10.0
gitdb              4.0.11
GitPython          3.1.43
huggingface-hub    0.26.5
idna               3.10
Jinja2             3.1.4
markdown-it-py     3.0.0
MarkupSafe         3.0.2
matrix-client      0.4.0
mdurl              0.1.2
mpmath             1.3.0
networkx           3.4.2
numpy              1.26.4
packaging          24.2
pillow             11.0.0
pip                24.0
pycparser          2.22
PyGithub           2.5.0
Pygments           2.18.0
PyJWT              2.10.1
PyNaCl             1.5.0
PyYAML             6.0.2
regex              2024.11.6
requests           2.32.3
rich               13.9.4
safetensors        0.4.5
setuptools         75.6.0
shellingham        1.5.4
smmap              5.0.1
sympy              1.13.1
tokenizers         0.21.0
torch              2.6.0.dev20241214
torchaudio         2.6.0.dev20241214
torchvision        0.22.0.dev20241214
tqdm               4.67.1
transformers       4.47.0
typer              0.15.1
typing_extensions  4.12.2
urllib3            1.26.20
wrapt              1.17.0
```

è¿™æ¬¡æˆ‘å°è¯•ç›´æ¥ä½¿ç”¨ ComfyUI çš„ `requirements.txt` å®‰è£…ä¾èµ–é¡¹ï¼ˆä¹‹å‰æˆ‘å·²ç»å°è¯•è¿‡ä¸€æ­¥ä¸€æ­¥æ‰‹åŠ¨å®‰è£…ä¾èµ–é¡¹å¹¶æˆåŠŸå¯åŠ¨ï¼ŒæŒ‰ç…§æç¤ºå®‰è£…ï¼špsutilã€einopsã€scipyã€torchsdeã€aiohttpã€spandrelã€kornia [ä½¿ç”¨`~/comfy/ComfyUI/.venv/bin/pip3 install xxx`]ï¼‰ï¼š

```bash
~/comfy/ComfyUI/.venv/bin/pip3 install -r /Applications/ComfyUI.app/Contents/Resources/ComfyUI/requirements.txt
```

æ¥ä¸‹æ¥æ˜¯ç¬¬ä¸‰æ¬¡å‘å°„ï¼š

![20241229144920_8l1KQne1.webp](https://cdn.dong4j.site/source/image/20241229144920_8l1KQne1.webp)

![20241229144920_0WkEqAyt.webp](https://cdn.dong4j.site/source/image/20241229144920_0WkEqAyt.webp)

## æ€»ç»“

1. PyTorch å®‰è£…å¤±è´¥ï¼Œå¯¼è‡´åç»­æ­¥éª¤æ— æ³•æ‰§è¡Œï¼›
2. æ— æ³•è‡ªåŠ¨å®‰è£…å…¶ä»–ä¾èµ–é¡¹ã€‚

## [æ™ºèƒ½åŒ–çš„å†…å®¹ç®¡ç†å·¥å…·ï¼šHoarderçš„AIä¹¦ç­¾é©å‘½](https://blog.dong4j.site/posts/90130153.md)

![/images/cover/20241231185355_QB2Byvhq.webp](https://cdn.dong4j.site/source/image/20241231185355_QB2Byvhq.webp)

## ç®€ä»‹

åœ¨è¿™ä¸ªä¿¡æ¯æ³›æ»¥çš„æ—¶ä»£ï¼Œæˆ‘ä»¬æ¯å¤©éƒ½åœ¨äº’è”ç½‘ä¸Šæ¥æ”¶åˆ°å¤§é‡çš„å†…å®¹ï¼ŒåŒ…æ‹¬å¸å¼•äººçš„æ–‡ç« ã€å®ç”¨çš„å·¥å…·å’Œè½¬ç¬å³é€çš„çµæ„Ÿã€‚æˆ‘ä»¬éƒ½å¸Œæœ›èƒ½å¤Ÿéšæ—¶è®¿é—®è¿™äº›å†…å®¹ã€‚

ç„¶è€Œï¼Œæˆ‘è¿‡å»ä¹ æƒ¯ä½¿ç”¨ Thingsã€Memos æˆ– Reeder æ¥æ”¶é›†è¿™äº›å†…å®¹ï¼Œä½†éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæ”¶è—çš„æ–‡ç« æ•°é‡è¶Šæ¥è¶Šå¤šï¼ŒæŸ¥æ‰¾èµ·æ¥å˜å¾—éå¸¸éº»çƒ¦ã€‚è€Œä¸”ï¼Œå¦ä¸€ä¸ªè®©æˆ‘ä¸æ»¡æ„çš„åœ°æ–¹æ˜¯ï¼Œè¿™äº›å·¥å…·åªèƒ½å±•ç¤ºé“¾æ¥ï¼Œè€Œæ— æ³•æ˜¾ç¤ºæ ‡é¢˜å’Œç®€è¦å†…å®¹ï¼Œè¿™ç»™åæ¥çš„æ•´ç†å·¥ä½œå¸¦æ¥äº†ä¸€äº›å›°æ‰°ã€‚

æ›´å¤šçš„æ—¶å€™ï¼Œæˆ‘ä»¬åªæ˜¯åœ¨æ”¶è—è¿™äº›ä¿¡æ¯ï¼Œå´ä»æœªå†æ¬¡æ‰“å¼€è¿‡å®ƒä»¬ï¼Œè¿™å¹¶æ²¡æœ‰è§£å†³æˆ‘ä»¬å¯¹ä¿¡æ¯ç®¡ç†çš„æ ¹æœ¬é—®é¢˜ã€‚

å› æ­¤ï¼Œä»Šå¤©æˆ‘è¦ä»‹ç»çš„æ˜¯ Hoarderâ€”â€”ä¸€æ¬¾ä¸“ä¸ºæ•°æ®æ”¶é›†è€…é‡èº«å®šåšçš„è‡ªæ‰˜ç®¡ä¹¦ç­¾åº”ç”¨ã€‚å®ƒé›†æˆäº† AI æ™ºèƒ½æ ‡ç­¾å’Œå¼ºå¤§çš„å…¨æ–‡æœç´¢åŠŸèƒ½ï¼Œå½»åº•æ”¹å˜äº†æˆ‘ä»¬çš„ä¿¡æ¯å¤„ç†å’Œä¿å­˜æ–¹å¼ã€‚

æƒ³è±¡ä¸€ä¸‹ï¼Œæ— è®ºæ˜¯æ·±å¤œé˜…è¯»åˆ°çš„æ·±åº¦æ–‡ç« è¿˜æ˜¯æ¸…æ™¨çµæ„Ÿè¿¸å‘çš„å›¾ç‰‡ï¼Œéƒ½å¯ä»¥è½»æ¾ä¸€é”®ä¿å­˜ï¼Œéšæ—¶éšåœ°è¿›è¡Œè‡ªç”±è®¿é—®ã€‚å³ä½¿åœ¨æ— æ³•ä¸€é”®ä¿å­˜çš„æƒ…å†µä¸‹ï¼Œå°†é“¾æ¥å¤åˆ¶åˆ° Hoarder ä¸­ä¹Ÿèƒ½æ˜¾ç¤ºæ ‡é¢˜ã€å›¾ç‰‡ç­‰å…³é”®ä¿¡æ¯ï¼Œè¿™ä½¿å¾—å®ƒæ¯” Thingsã€Memos è¿™ç±»å·¥å…·æ›´åŠ å¥½ç”¨ã€‚

## Hoarder æ˜¯ä»€ä¹ˆ

[Hoarder](https://github.com/hoarder-app/hoarder) æ˜¯ä¸€ä¸ªå¼€æºçš„ â€œBookmark Everythingâ€ åº”ç”¨ç¨‹åºï¼Œä¸“é—¨ä¸ºéœ€è¦æ”¶é›†å’Œæ•´ç†ä¹¦ç­¾ä¿¡æ¯çš„äººè€Œè®¾è®¡çš„ã€‚å®ƒé™¤äº†æ‰‹åŠ¨è‡ªå®šä¹‰åˆ†ç±»æ ‡ç­¾ï¼Œè¿˜æ”¯æŒåˆ©ç”¨äººå·¥æ™ºèƒ½ AI æŠ€æœ¯ï¼Œå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿä¿å­˜å’Œç®¡ç†é“¾æ¥ã€ç¬”è®°æˆ–è€…å›¾ç‰‡ã€‚åŒæ—¶å®ƒè¿˜å¯ä»¥åœ¨å¤šä¸ªå¹³å°ä¸Šä½¿ç”¨ï¼ŒåŒ…æ‹¬æµè§ˆå™¨æ‰©å±•å’Œæ‰‹æœºåº”ç”¨ã€‚

å®ƒå…·æœ‰ä»¥ä¸‹äº®ç‚¹ç‰¹å¾ï¼š

- ğŸ”— ä¸ºé“¾æ¥æ·»åŠ ä¹¦ç­¾ã€åšç®€å•çš„ç¬”è®°å¹¶å­˜å‚¨å›¾åƒå’Œ pdfã€‚
- â¬‡ï¸ è‡ªåŠ¨è·å–é“¾æ¥æ ‡é¢˜ã€æè¿°å’Œå›¾åƒã€‚
- ğŸ“‹ å°†ä¹¦ç­¾æ’åºåˆ°åˆ—è¡¨ä¸­ã€‚
- ğŸ” å¯¹å­˜å‚¨çš„æ‰€æœ‰å†…å®¹è¿›è¡Œå…¨æ–‡æœç´¢ã€‚
- âœ¨ åŸºäº AIï¼ˆåˆå chatgptï¼‰çš„è‡ªåŠ¨æ ‡è®°ã€‚æ”¯æŒä½¿ç”¨ ollama çš„æœ¬åœ°æ¨¡å‹ï¼
- ğŸ† OCR ç”¨äºä»å›¾åƒä¸­æå–æ–‡æœ¬ã€‚
- ğŸ”– ç”¨äºå¿«é€Ÿä¹¦ç­¾çš„ [Chrome æ’ä»¶](https://chromewebstore.google.com/detail/hoarder/kgcjekpmcjjogibpjebkhaanilehneje)å’Œ [Firefox æ’ä»¶](https://addons.mozilla.org/en-US/firefox/addon/hoarder/)ã€‚
- ğŸ“± ä¸€ä¸ª [iOS åº”ç”¨ç¨‹åºå’Œ](https://apps.apple.com/us/app/hoarder-app/id6479258022)ä¸€ä¸ª [Android åº”ç”¨ç¨‹åº](https://play.google.com/store/apps/details?id=app.hoarder.hoardermobile&pcampaignid=web_share)ã€‚
- ğŸ“° æ¥è‡ª RSS æºçš„è‡ªåŠ¨å›¤ç§¯ã€‚
- ğŸŒ REST API çš„ API ä¸­ã€‚
- ğŸ—„ï¸ æ•´é¡µå­˜æ¡£ï¼ˆä½¿ç”¨[å•ä½“](https://github.com/Y2Z/monolith)ï¼‰ä»¥é˜²æ­¢é“¾æ¥è…çƒ‚ã€‚ä½¿ç”¨ [youtube-dl](https://github.com/marado/youtube-dl) è‡ªåŠ¨å­˜æ¡£è§†é¢‘ã€‚
- â˜‘ï¸ æ‰¹é‡æ“ä½œæ”¯æŒã€‚
- ğŸ” SSO æ”¯æŒã€‚
- ğŸŒ™ æ·±è‰²æ¨¡å¼æ”¯æŒã€‚
- ğŸ’¾ é¦–å…ˆæ˜¯è‡ªæ‰˜ç®¡ã€‚
- [è®¡åˆ’]ä¸‹è½½å†…å®¹ä»¥ä¾›ç¦»çº¿é˜…è¯»ã€‚

å®ƒè¿˜æä¾›äº†æ¼”ç¤º Demoï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥å…ˆä½“éªŒï¼Œå†éƒ¨ç½²ï¼š[https://try.hoarder.app/signin](https://try.hoarder.app/signin)

![20250103120629_U3v2klcD.webp](https://cdn.dong4j.site/source/image/20250103120629_U3v2klcD.webp)

---

## å¦‚ä½•ä½¿ç”¨ Hoarder

æŒ‰ç…§å®˜æ–¹æ–‡æ¡£ä½¿ç”¨ docker-compose å¿«é€Ÿçš„å®ç°æœåŠ¡éƒ¨ç½².

### æœ¬åœ°éƒ¨ç½²

```yml
version: "3.8"
services:
  web:
    image: ghcr.io/hoarder-app/hoarder:${HOARDER_VERSION:-release}
    restart: unless-stopped
    volumes:
      - ./data:/data
    ports:
      - 3333:3000
    env_file:
      - .env
    environment:
      MEILI_ADDR: http://meilisearch:7700
      BROWSER_WEB_URL: http://chrome:9222
      DATA_DIR: /data
  chrome:
    image: gcr.io/zenika-hub/alpine-chrome:123
    restart: unless-stopped
    command:
      - --no-sandbox
      - --disable-gpu
      - --disable-dev-shm-usage
      - --remote-debugging-address=0.0.0.0
      - --remote-debugging-port=9222
      - --hide-scrollbars
  meilisearch:
    image: getmeili/meilisearch:v1.11.1
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # ç¦ç”¨åŒ¿åæ•°æ®æ”¶é›†
      MEILI_NO_ANALYTICS: "true"
    volumes:
      - ./meili:/meili_data

volumes:
  meilisearch:
  data:
```

**.env**

```
HOARDER_VERSION=release
NEXTAUTH_SECRET=[36 ä½éšæœºå­—ç¬¦ä¸²]
MEILI_MASTER_KEY=[36 ä½éšæœºå­—ç¬¦ä¸²]
NEXTAUTH_URL=http://localhost:3000
```

åœ¨ä½ æ³¨å†Œå®Œè´¦å·åï¼Œåœ¨ç¯å¢ƒå˜é‡é‡Œ `ç¦ç”¨è´¦å·æ³¨å†Œ` åŠŸèƒ½ã€‚å‰é¢ `.env` éƒ¨åˆ†åŠ å…¥è¿™å¥è¯ï¼š

```
DISABLE_SIGNUPS=true
```

---

### AI åŠ æŒ

Hoarder ä¸€å¤§äº®ç‚¹æ˜¯é€šè¿‡ AI ä¸ºæ”¶è—çš„é“¾æ¥ç”Ÿæˆæ ‡ç­¾, è¦ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½, éœ€è¦è®¾ç½® AI æœåŠ¡:

```yaml
environment:
  # ä½¿ç”¨ Ollama æä¾› AI æœåŠ¡
  OLLAMA_BASE_URL: http://192.168.31.5:11434
  INFERENCE_TEXT_MODEL: glm4
  INFERENCE_LANG: chinese
```

æˆ‘è¿™é‡Œä½¿ç”¨äº† Ollama æ¥æä¾› AI æœåŠ¡, ä½¿ç”¨ **glm4** è¿™ä¸ªæ¨¡å‹..

åœ¨ Mac mini M2 ä¸Šéƒ¨ç½² Ollama, å¦‚æœéœ€è¦ç»™å…¶ä»–ä¸»æœºæä¾›æœåŠ¡, è¿˜éœ€è¦è¿›è¡Œä¸€äº›ç‰¹æ®Šè®¾ç½®:

```bash
# å…è®¸è·¨åŸŸ
launchctl setenv OLLAMA_ORIGINS "*"
# ä¿®æ”¹ bind
launchctl setenv OLLAMA_HOST "0.0.0.0"
```

å› ä¸ºæˆ‘çš„ Mac mini M2 SSD åªæœ‰ 256G, ç›®å‰å·²ç»æ²¡æœ‰å¤šå°‘å‰©ä½™ç©ºé—´å¯ä½¿ç”¨, æ‰€ä»¥æˆ‘å°† LLM æ¨¡å‹ä¸Šä¼ åˆ° DS923+, ç„¶åé€šè¿‡ SMB æŒ‚è½½åˆ°æœ¬åœ°, æ‰€ä»¥è¿˜éœ€è¦ä¿®æ”¹ Ollama çš„æ¨¡å‹åœ°å€:

```bash
# æ›´æ”¹æ¨¡å‹ä½ç½®
launchctl setenv OLLAMA_MODELS "/Volumes/AI/models/ollama"
```

å¦‚æœä½¿ç”¨ Docker éƒ¨ç½² Ollama, å¯èƒ½ä¼šé‡åˆ°ä»¥ä¸‹é”™è¯¯:

```
httpconnectionpool(host=127.0.0.1, port=11434): max retries exceeded with url:/cpi/chat (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7f8562812c20>: fail to establish a new connection:[Errno 111] Connection refused'))

httpconnectionpool(host=localhost, port=11434): max retries exceeded with url:/cpi/chat (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7f8562812c20>: fail to establish a new connection:[Errno 111] Connection refused'))
```

è¿™ä¸ªé”™è¯¯æ˜¯å› ä¸º Docker å®¹å™¨æ— æ³•è®¿é—® Ollama æœåŠ¡ã€‚localhost é€šå¸¸æŒ‡çš„æ˜¯å®¹å™¨æœ¬èº«ï¼Œè€Œä¸æ˜¯ä¸»æœºæˆ–å…¶ä»–å®¹å™¨ã€‚è¦è§£å†³æ­¤é—®é¢˜ï¼Œä½ éœ€è¦å°† Ollama æœåŠ¡æš´éœ²ç»™ç½‘ç»œã€‚

**åœ¨ Mac ä¸Šè®¾ç½®ç¯å¢ƒå˜é‡**:

å¦‚æœ `Ollama` ä½œä¸º `macOS` åº”ç”¨ç¨‹åºè¿è¡Œï¼Œåˆ™åº”ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è®¾ç½®ç¯å¢ƒå˜é‡`launchctl`ï¼š

1. é€šè¿‡è°ƒç”¨`launchctl setenv`è®¾ç½®ç¯å¢ƒå˜é‡ï¼š

   ```
   launchctl setenv OLLAMA_HOST "0.0.0.0"
   ```

2. é‡å¯ Ollama åº”ç”¨ç¨‹åºã€‚

3. å¦‚æœä»¥ä¸Šæ­¥éª¤æ— æ•ˆï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š

   é—®é¢˜æ˜¯åœ¨ docker å†…éƒ¨ï¼Œä½ åº”è¯¥è¿æ¥åˆ°`host.docker.internal`ï¼Œæ‰èƒ½è®¿é—® docker çš„ä¸»æœºï¼Œæ‰€ä»¥å°†`localhost`æ›¿æ¢ä¸º`host.docker.internal`æœåŠ¡å°±å¯ä»¥ç”Ÿæ•ˆäº†ï¼š

   ```
   http://host.docker.internal:11434
   ```

**åœ¨ Linux ä¸Šè®¾ç½®ç¯å¢ƒå˜é‡**:

å¦‚æœ Ollama ä½œä¸º systemd æœåŠ¡è¿è¡Œï¼Œåº”è¯¥ä½¿ç”¨`systemctl`è®¾ç½®ç¯å¢ƒå˜é‡ï¼š

1. é€šè¿‡è°ƒç”¨`systemctl edit ollama.service`ç¼–è¾‘ systemd æœåŠ¡ã€‚è¿™å°†æ‰“å¼€ä¸€ä¸ªç¼–è¾‘å™¨ã€‚

2. å¯¹äºæ¯ä¸ªç¯å¢ƒå˜é‡ï¼Œåœ¨`[Service]`éƒ¨åˆ†ä¸‹æ·»åŠ ä¸€è¡Œ`Environment`ï¼š

   ```
   [Service]
   Environment="OLLAMA_HOST=0.0.0.0"
   ```

3. ä¿å­˜å¹¶é€€å‡ºã€‚

4. é‡è½½`systemd`å¹¶é‡å¯ Ollamaï¼š

   ```
   systemctl daemon-reload
   systemctl restart ollama
   ```

> #### Ollama çš„å¯ç”¨ç¯å¢ƒå˜é‡
>
> ```
> HTTPS_PROXY
> HTTP_PROXY
> NO_PROXY
> OLLAMA_DEBUG:false
> OLLAMA_FLASH_ATTENTION:false
> OLLAMA_GPU_OVERHEAD:0
> OLLAMA_HOST:http://0.0.0.0:11434
> OLLAMA_KEEP_ALIVE:5m0s
> OLLAMA_KV_CACHE_TYPE:
> OLLAMA_LLM_LIBRARY:
> OLLAMA_LOAD_TIMEOUT:5m0s
> OLLAMA_MAX_LOADED_MODELS:0
> OLLAMA_MAX_QUEUE:512
> OLLAMA_MODELS:/Volumes/AI/models/ollama
> OLLAMA_MULTIUSER_CACHE:false
> OLLAMA_NOHISTORY:false
> OLLAMA_NOPRUNE:false
> OLLAMA_NUM_PARALLEL:0
> OLLAMA_ORIGINS:[http://localhost https://localhost http://localhost:* https://localhost:* http://127.0.0.1 https://127.0.0.1 http://127.0.0.1:* https://127.0.0.1:* http://0.0.0.0 https://0.0.0.0 http://0.0.0.0:* https://0.0.0.0:* app://* file://* tauri://* vscode-webview://*]
> OLLAMA_SCHED_SPREAD:false
> http_proxy:
> https_proxy:
> no_proxy:
> ```
>
> - **OLLAMA_HOSTï¼š**è®¾ç½®ç½‘ç»œç›‘å¬ç«¯å£ã€‚å½“æˆ‘ä»¬è®¾ç½® OLLAMA_HOST ä¸º 0.0.0.0 æ—¶ï¼Œå°±ç›¸å½“äºå¼€æ”¾ç«¯å£ï¼Œå¯ä»¥è®©äººæ„å¤–éƒ¨ç½‘ç»œè®¿é—®ã€‚
> - **OLLAMA_MODELSï¼š**è®¾ç½®æ¨¡å‹çš„å­˜å‚¨è·¯å¾„ã€‚å½“æˆ‘ä»¬è®¾ç½® OLLAMA_MODELS=F:\OllamaCacheï¼Œå°±ç›¸å½“äºç»™æ¨¡å‹ä»¬åœ¨ F ç›˜å»ºäº†ä¸€ä¸ªä»“åº“ï¼Œè®©å®ƒä»¬è¿œç¦» C ç›˜ã€‚
> - **OLLAMA_KEEP_ALIVEï¼š** å®ƒå†³å®šäº†æˆ‘ä»¬çš„æ¨¡å‹ä»¬å¯ä»¥åœ¨å†…å­˜é‡Œçš„å­˜æ´»æ—¶é—´ã€‚è®¾ç½® OLLAMA_KEEP_ALIVE=24hï¼Œå°±å¥½æ¯”ç»™æ¨¡å‹ä»¬è£…ä¸Šäº†ä¸€å—è¶…å¤§å®¹é‡ç”µæ± ï¼Œè®©å®ƒä»¬å¯ä»¥è¿ç»­å·¥ä½œ 24 å°æ—¶ï¼Œæ—¶åˆ»å¾…å‘½ã€‚
> - **OLLAMA_PORTï¼š**ç”¨æ¥ä¿®æ”¹ ollama çš„é»˜è®¤ç«¯å£ï¼Œé»˜è®¤æ˜¯ 11434ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ”¹ä¸ºä½ æƒ³è¦çš„ç«¯å£ã€‚
> - **OLLAMA_NUM_PARALLELï¼š**é™åˆ¶äº† Ollama å¯ä»¥åŒæ—¶åŠ è½½çš„æ¨¡å‹æ•°é‡
> - **OLLAMA_MAX_LOADED_MODELSï¼š**å¯ä»¥ç¡®ä¿ç³»ç»Ÿèµ„æºå¾—åˆ°åˆç†åˆ†é…ã€‚

#### AI è®¾ç½®

åœ¨ Web ç«¯å¯ä»¥è®¾ç½® AI æç¤ºè¯:

![20250103152259_NHFYurFM.webp](https://cdn.dong4j.site/source/image/20250103152259_NHFYurFM.webp)

### RSS è®¢é˜…

Hoarder åŒæ—¶æ”¯æŒ RSS è®¢é˜…, ä½†æ˜¯æˆ‘å¹¶ä¸æ‰“ç®—ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½, Hoarder æ›´å¤šçš„è¿˜æ˜¯å®šä½ä¸ºé“¾æ¥ç®¡ç†, RSS è®¢é˜…æˆ‘ä¼šä½¿ç”¨ Reeder å’Œ Follow.

![20250103152306_QlbeRrH4.webp](https://cdn.dong4j.site/source/image/20250103152306_QlbeRrH4.webp)

### API å¯†é’¥ç®¡ç†

Hoarder ä¼šè‡ªåŠ¨ä¸ºä½¿ç”¨è´¦å·ç™»å½•çš„å®¢æˆ·ç«¯ç”Ÿæˆå¯†é’¥, å¦‚æœä½¿ç”¨ Alfred ç­‰ç¬¬ä¸‰æ–¹ç¤¾åŒºåº”ç”¨, éœ€è¦æ‰‹åŠ¨æ·»åŠ  API å¯†é’¥:

![20250103150455_KhpEUxay.webp](https://cdn.dong4j.site/source/image/20250103150455_KhpEUxay.webp)

### ç¼–è¾‘é“¾æ¥

![20250103152319_Ln4wOeCn.webp](https://cdn.dong4j.site/source/image/20250103152319_Ln4wOeCn.webp)

AI æ ¹æ®æ–‡ç« å†…å®¹åšå‡ºçš„åˆ†ç±»æ ‡ç­¾ï¼Œä¹Ÿå¯ä»¥è‡ªè¡Œæ·»åŠ `è‡ªå®šä¹‰çš„æ ‡ç­¾`ï¼Œä»¥åŠ`å¤‡æ³¨ä¿¡æ¯`

åŒæ—¶è¿˜å¯ä»¥ä¿®æ”¹æ ‡é¢˜, Banner å’Œ æˆªå›¾:

![20250103152326_SIUDVF1X.webp](https://cdn.dong4j.site/source/image/20250103152326_SIUDVF1X.webp)

### æ ‡ç­¾ç®¡ç†

ä½ èƒ½å¤Ÿåœ¨ **æ ‡ç­¾** é¡µé¢ç®¡ç†æ‰€æœ‰çš„æ ‡ç­¾:

![20250103152333_ksDGtMGS.webp](https://cdn.dong4j.site/source/image/20250103152333_ksDGtMGS.webp)

### æœç´¢

æ­¤åŠŸèƒ½ä½¿ç”¨ [Meilisearch](https://www.meilisearch.com/?utm_campaign=oss&utm_source=github&utm_medium=meilisearch&utm_content=intro) å®ç°, å› ä¸ºç›®å‰çš„æ”¶è—è¿˜æ¯”è¾ƒå°‘, è¿˜æ²¡æœ‰å‡¸æ˜¾å‡º Meilisearch çš„ä¼˜åŠ¿:

![20250103151317_6VJmmmyj.webp](https://cdn.dong4j.site/source/image/20250103151317_6VJmmmyj.webp)

## Hoarder ç”Ÿæ€

### æµè§ˆå™¨æ’ä»¶

![20250103141301_utK0Ks22.webp](https://cdn.dong4j.site/source/image/20250103141301_utK0Ks22.webp)

é…ç½®ä½ è‡ªå·±çš„æœåŠ¡å™¨åœ°å€:

![20250103141401_stmVk7Uk.webp](https://cdn.dong4j.site/source/image/20250103141401_stmVk7Uk.webp)

### APP

- [iOS åº”ç”¨ç¨‹åº](https://apps.apple.com/us/app/hoarder-app/id6479258022)

- [Android åº”ç”¨ç¨‹åº](https://play.google.com/store/apps/details?id=app.hoarder.hoardermobile&pcampaignid=web_share)

### ç¤¾åŒºé¡¹ç›®

1. Raycast [æ‰©å±•](https://www.raycast.com/luolei/hoarder)

   ä¸€æ¬¾ç”¨æˆ·å‹å¥½çš„ Raycast æ‰©å±•ç¨‹åºï¼Œå¯ä¸ Hoarder æ— ç¼é›†æˆï¼Œè®©æ‚¨è½»æ¾å®ç°å¼ºå¤§çš„ä¹¦ç­¾ç®¡ç†åŠŸèƒ½ã€‚é€šè¿‡ Raycast ç›´è§‚çš„ç•Œé¢ï¼Œå¿«é€Ÿä¿å­˜ã€æœç´¢å’Œæ•´ç†æ‚¨çš„ä¹¦ç­¾ã€æ–‡æœ¬å’Œå›¾åƒã€‚

2. Alfred

   [Alfred å·¥ä½œæµç¨‹](https://www.alfredforum.com/topic/22528-hoarder-workflow-for-self-hosted-bookmark-management/)å¯å¿«é€Ÿå‚¨å­˜ä¸œè¥¿æˆ–è®¿é—®æ‚¨å‚¨å­˜çš„ä¹¦ç­¾ï¼

3. ç”µæŠ¥ [æœºå™¨äºº](https://github.com/Madh93/hoarderbot)

   ä¸€ä¸ª Telegram Botï¼Œç”¨äºç›´æ¥é€šè¿‡ Telegram å°†ä¹¦ç­¾ä¿å­˜åˆ° Hoarderã€‚

## å‚è€ƒ

- [ä½“éªŒé«˜æ•ˆçš„é˜…è¯»å’Œæ”¶è—ï¼ŒNAS éƒ¨ç½²åŸºäº AI çš„ä¹¦ç­¾å’Œä¸ªäººçŸ¥è¯†åº“ç®¡ç†å·¥å…·ã€Hoarderã€](https://post.smzdm.com/p/adm85p5d/)

## [ZSH å¯åŠ¨æ…¢ï¼ŒåŸæ¥æ˜¯è¿™ä¸ªé—®é¢˜ï¼](https://blog.dong4j.site/posts/5eb89a7b.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## èƒŒæ™¯

äº‹æƒ…çš„èµ·å› æ˜¯ ComfyUI å®˜ç½‘å‡ºæ¡Œé¢ç‰ˆäº†, è™½ç„¶æ˜¯ Bete ç‰ˆæœ¬, å½“è¿˜æ˜¯å‡†å¤‡è¯•ç”¨ä¸€ä¸‹, ç»“æœç¬¬ä¸€æ­¥å®‰è£…ç¯å¢ƒå°±å¡ä½äº†:

![20241229144917_jrgVhQ2O.webp](https://cdn.dong4j.site/source/image/20241229144917_jrgVhQ2O.webp)

`The default interactive shell is now zsh. To update your account to use zsh, please run 'chsh -s bin/zsh'.`

è¿™ä¸ªå†ç†Ÿæ‚‰ä¸è¿‡äº†, æç¤ºæˆ‘ä»¬æ›´æ–° shell ä¸º zsh, ä½†æ˜¯æˆ‘å¹¶ä¸æƒ³æ›´æ–°, æˆ‘å¹¶ä¸æƒ³æŠŠ zsh ç”¨ä½œæˆ‘çš„é»˜è®¤ shell, å› ä¸º zhs çš„å¯åŠ¨æ—¶é—´å¤ªé•¿.

è¿™ä¸ªé—®é¢˜æ˜¯åœ¨å°†è€ç³»ç»Ÿè¿ç§»åˆ°æ–°ä¹°çš„ MBP æ—¶å‡ºç°çš„, ç°è±¡æ˜¯å°† zsh ä½œä¸ºé»˜è®¤ shell å, æ¯æ¬¡æ‰“å¼€ç»ˆç«¯éƒ½éœ€è¦ç­‰å¾… 1-2 åˆ†é’Ÿ, æ‰å‡ºç°æç¤ºç¬¦. è¿™æ˜¾ç„¶æ˜¯ä¸èƒ½æ¥å—çš„.

åæ¥ä½¿ç”¨ `Command` ç›´æ¥æŒ‡å®š `/bin/zsh` å°±å¯ä»¥äº†, ä¹Ÿå°±æ²¡åœ¨æ·±ç©¶è¿™ä¸ªé—®é¢˜.

![20241229144917_9dgdO327.webp](https://cdn.dong4j.site/source/image/20241229144917_9dgdO327.webp)

ä½†ä»Šå¤©è¿™ä¸ªé—®é¢˜é€ƒä¸è¿‡å»äº†, å°±å¼€å§‹ç ”ç©¶ä¸€ä¸‹, å½»åº•è§£å†³è¿™ä¸ªé—®é¢˜.

## shell é…ç½®åŠ è½½é¡ºåº

å› ä¸ºç°è±¡æ˜¯ä½¿ç”¨é»˜è®¤çš„ `/bin/bash` , ç„¶åç›´æ¥æ˜¯ç”¨ `/bin/zsh` åˆ‡æ¢åˆ° zsh æ‰“å¼€é€Ÿåº¦å¾ˆå¿«.

ä½†æ˜¯å°† zsh è®¾ç½®ä¸ºç³»ç»Ÿé»˜è®¤ shell æ—¶å°±ä¼šå¡ä½, ä¸” Title å¤„ä¼šæœ‰å¤šä¸ª job å¾ªç¯æ˜¾ç¤º, æ‰€ä»¥æˆ‘çŒœæµ‹æ˜¯ zsh çš„é…ç½®æ–‡ä»¶åŠ è½½é¡ºåºæœ‰é—®é¢˜.

åœ¨ Unix å’Œç±» Unix æ“ä½œç³»ç»Ÿä¸­ï¼Œshell æœ‰ä¸¤ç§ç±»å‹çš„ä¼šè¯ï¼š

- `interactive login shell`ï¼šè¿™ç§ç±»å‹çš„ shell åœ¨ **ç”¨æˆ·ç™»å½•æ—¶è¢«å¯åŠ¨**ï¼Œé€šå¸¸æ˜¯ç”¨æˆ·é¦–æ¬¡æ‰“å¼€ç»ˆç«¯æˆ–è¿æ¥åˆ°æœåŠ¡å™¨æ—¶æ‰€è§çš„ shellã€‚login shell è´Ÿè´£åŠ è½½ä¸ç³»ç»Ÿé…ç½®ç›¸å…³çš„æ–‡ä»¶ï¼Œä¾‹å¦‚/etc/profileã€~/.profile ç­‰ã€‚è¿™äº›æ–‡ä»¶ç”¨äºè®¾ç½®ç¯å¢ƒå˜é‡ã€é…ç½®åˆ«åå’Œå‡½æ•°ã€åŠ è½½ç³»ç»Ÿçº§åˆ«çš„ bash æ’ä»¶ç­‰ã€‚

- `interactive non-login shell`ï¼šè¿™ç§ç±»å‹çš„ shell åœ¨ **ç”¨æˆ·å·²ç»ç™»å½•å¹¶ä¸”ä¸æ¶‰åŠæ–°ä¼šè¯çš„æƒ…å†µä¸‹å¯åŠ¨**ï¼Œä¾‹å¦‚é€šè¿‡ bash -i æˆ–é€šè¿‡æŸäº›å›¾å½¢ç•Œé¢å·¥å…·æ‰“å¼€çš„ç»ˆç«¯çª—å£ã€‚non-login shell é€šå¸¸ä¸ä¼šåŠ è½½ä¸ç™»å½•ç›¸å…³çš„æ–‡ä»¶ï¼Œè€Œæ˜¯ä»å½“å‰ç”¨æˆ·çš„.bashrc æˆ–.zshrcï¼ˆå¦‚æœæ˜¯ä½¿ç”¨ zshï¼‰ç­‰ä¸ªäººé…ç½®æ–‡ä»¶ä¸­è¯»å–è®¾ç½®ã€‚

### bash é…ç½®åŠ è½½é¡ºåº

å¯¹äº Bashï¼Œå®ƒä»¬çš„å·¥ä½œåŸç†å¦‚ä¸‹ã€‚é˜…è¯»ç›¸åº”çš„åˆ—ã€‚æ‰§è¡Œ Aï¼Œç„¶åæ‰§è¡Œ Bï¼Œç„¶åæ‰§è¡Œ C ç­‰ç­‰ã€‚B1ã€B2ã€B3 è¡¨ç¤ºå®ƒåªæ‰§è¡Œæ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ã€‚

| config             | interactive login shell | interactive non-login shell | script |
| ------------------ | ----------------------- | --------------------------- | ------ |
| `/etc/profile`     | A                       |                             |        |
| `/etc/bash.bashrc` |                         | A                           |        |
| `~/.bashrc`        |                         | B                           |        |
| `~/.bash_profile`  | B1                      |                             |        |
| `~/.bash_login`    | B2                      |                             |        |
| `~/.profile`       | B3                      |                             |        |
| `BASH_ENV`         |                         |                             | A      |
|                    |                         |                             |        |
| `~/.bash_logout`   | C                       |                             |        |

ä»¥ `interactive login shell` ä¸ºä¾‹:

1. é¦–å…ˆè¯»å– `/etc/profile`
2. ç„¶ååŠ è½½ `~/.bash_profile`, `~/.bash_login`, `~/.profile` ä¸‰è€…ä¸­èƒ½æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªé…ç½®;
3. ç”¨æˆ·æ³¨é”€æ—¶æ‰§è¡Œ `~/.bash_logout`(å¦‚æœå­˜åœ¨çš„è¯);

æ‰§è¡Œé¡ºåºå›¾:

![bash_load_config_order.drawio.svg](https://cdn.dong4j.site/source/image/bash_load_config_order.drawio.svg)

**1. æ˜¯å¦ä¸ºäº¤äº’å¼ Shell (Interactive?)**

- **Yes**ï¼šè¿›å…¥äº¤äº’å¼æ¨¡å¼ï¼Œå³ç”¨æˆ·å¯ä»¥åœ¨ç»ˆç«¯è¾“å…¥å‘½ä»¤ã€‚
- **No**ï¼šéäº¤äº’å¼æ¨¡å¼ï¼Œé€šå¸¸ç”¨äºè„šæœ¬æ‰§è¡Œã€‚

**2. äº¤äº’å¼æ¨¡å¼ä¸‹**

**æ˜¯å¦ä¸ºç™»å½• Shell (Login shell?)**

- **Yes**ï¼ˆç™»å½• Shellï¼‰ï¼š

  - å¦‚æœ `--noprofile` å‚æ•°è¢«æŒ‡å®šï¼Œåˆ™ **ä¸åŠ è½½ä»»ä½•é…ç½®æ–‡ä»¶**ã€‚
  - å¦‚æœæ²¡æœ‰ `--noprofile`ï¼š
    - **åŠ è½½** `/etc/profile`ã€‚
    - ç„¶åä¾æ¬¡æŸ¥æ‰¾ä»¥ä¸‹æ–‡ä»¶ä¸­çš„ç¬¬ä¸€ä¸ªå­˜åœ¨çš„æ–‡ä»¶ï¼š
      - `~/.bash_profile`
      - `~/.bash_login`
      - `~/.profile`
    - è¿™äº›æ–‡ä»¶å¯èƒ½åŒ…å«å¯¹ ~/.bashrc çš„å¼•ç”¨ã€‚

- **No**ï¼ˆéç™»å½• Shellï¼‰ï¼š
  - å¦‚æœæŒ‡å®š `--rcfile <file>`ï¼Œåˆ™åŠ è½½æŒ‡å®šçš„é…ç½®æ–‡ä»¶ã€‚
  - å¦‚æœæ²¡æœ‰æŒ‡å®š --rcfileï¼š
    - **æ²¡æœ‰** `--norc` **å‚æ•°**ï¼šåŠ è½½ `/etc/bash.bashrc` å’Œ `~/.bashrc`ã€‚
    - **æœ‰** `--norc` **å‚æ•°**ï¼šä¸åŠ è½½ä»»ä½•æ–‡ä»¶ã€‚

**3. éäº¤äº’å¼æ¨¡å¼ä¸‹**

- å¦‚æœæŒ‡å®š `--login` å‚æ•°ï¼Œåˆ™åŠ è½½ `/etc/profile` åŠç™»å½• Shell é…ç½®æ–‡ä»¶ã€‚
- å¦‚æœæ²¡æœ‰ `--login`ï¼Œä½†è®¾ç½®äº† `$BASH_ENV` å˜é‡ï¼Œåˆ™åŠ è½½è¯¥å˜é‡æŒ‡å®šçš„æ–‡ä»¶ã€‚

#### æ€»ç»“

- **ç™»å½• Shell** é€šå¸¸åœ¨ç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶å¯åŠ¨ï¼Œä¼šåŠ è½½ `/etc/profile` å’Œç”¨æˆ·ç‰¹å®šçš„ç™»å½•é…ç½®æ–‡ä»¶ï¼ˆå¦‚ `~/.bash_profile`ï¼‰ã€‚
- **éç™»å½• Shell** å¸¸ç”¨äºç»ˆç«¯å†…å¯åŠ¨çš„å­ Shellï¼Œä¸»è¦åŠ è½½ `~/.bashrc`ã€‚
- **éäº¤äº’å¼ Shell** ä¸»è¦ç”¨äºè„šæœ¬æ‰§è¡Œï¼ŒåŠ è½½ `$BASH_ENV` æŒ‡å®šçš„ç¯å¢ƒã€‚

---

### zsh é…ç½®åŠ è½½é¡ºåº

å¯¹äº zshï¼šå¦‚æœ`~/.zshrc`ä¸å­˜åœ¨ï¼Œ zsh ä¼¼ä¹ä¹Ÿä¼šè¯»å–`~/.profile`)

| config          | interactive login shell | interactive non-login shell | script |
| --------------- | ----------------------- | --------------------------- | ------ |
| `/etc/zshenv`   | A                       | A                           | A      |
| `~/.zshenv`     | B                       | B                           | B      |
| `/etc/zprofile` | C                       |                             |        |
| `~/.zprofile`   | D                       |                             |        |
| `/etc/zshrc`    | E                       | C                           |        |
| `~/.zshrc`      | F                       | D                           |        |
| `/etc/zlogin`   | G                       |                             |        |
| `~/.zlogin`     | H                       |                             |        |
|                 |                         |                             |        |
| `~/.zlogout`    | I                       |                             |        |
| `/etc/zlogout`  | J                       |                             |        |

#### æ€»ç»“

- å¯¹äº `bash`ï¼Œè¯·å°†å†…å®¹æ”¾å…¥ `~/.bashrc` ä¸­ï¼Œç„¶åä½¿ç”¨ `~/.bash_profile` æ¥è·å–å®ƒ;
- å¯¹äº `zsh`ï¼Œå°†å†…å®¹æ”¾å…¥ `~/.zshrc` ä¸­ï¼Œè¯¥æ“ä½œå§‹ç»ˆæ‰§è¡Œ;

## é—®é¢˜æ’æŸ¥

åœ¨æ¸…æ¥š bash å’Œ zsh çš„é…ç½®åŠ è½½é¡ºåºä¹‹å, é€æ¸ç¼©ä¸‹äº†æ’æŸ¥é—®é¢˜çš„èŒƒå›´, ç°è±¡æ˜¯ zsh ä½œä¸ºé»˜è®¤ç»ˆç«¯åŠ è½½æ…¢(`interactive non-login shell`), è€Œåœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ `/bin/zsh` åˆ‡æ¢åˆ° zsh å°±å¾ˆå¿«, æ‰€ä»¥åº”è¯¥æ˜¯ `/etc/zprofile` å’Œ `~/.zprofile` é…ç½®çš„é—®é¢˜.

è¿™æ˜¯ `/etc/zprofile` çš„é…ç½®:

```bash
# System-wide profile for interactive zsh(1) login shells.

# Setup user specific overrides for this in ~/.zprofile. See zshbuiltins(1)
# and zshoptions(1) for more details.

if [ -x /usr/libexec/path_helper ]; then
	eval `/usr/libexec/path_helper -s`
fi
```

åº”è¯¥æ²¡æœ‰ä»€ä¹ˆé—®é¢˜, æ³¨é‡Šè¯´çš„æ˜¯ **`~/.zprofile` ä¸­çš„é…ç½®ä¼šè¦†ç›–è¿™é‡Œçš„é…ç½®**.

é‚£ä¹ˆè§è¯å¥‡è¿¹çš„æ—¶åˆ»å‡ºç°äº†, å½“æˆ‘æ‰“å¼€ `~/.zprofile` å, æ„Ÿè§‰ä¸å¾—ä¸å†™ä¸€ç¯‡åšå®¢æ¥è®°å½•ä¸€ä¸‹:

![20241229144917_3xJ4AaVs.webp](https://cdn.dong4j.site/source/image/20241229144917_3xJ4AaVs.webp)

è¿™ä¸ªæ–‡ä»¶ä¸­æœ‰ 4000+ è¡Œç›¸åŒçš„ `eval "$(/opt/homebrew/bin/brew shellenv)"` é…ç½®.......

è€Œåœ¨ `.zshrc` å­˜åœ¨å¦‚ä¸‹é…ç½®:

```bash
...
echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> /Users/dong4j/.zprofile
eval "$(/opt/homebrew/bin/brew shellenv)"
...
```

é‚£é—®é¢˜ç°åœ¨å°±æ˜äº†äº†: **å› ä¸ºæ¯æ¬¡å¯åŠ¨ zsh æœ€ç»ˆéƒ½ä¼šè¯»å– `.zshrc` æ–‡ä»¶, ç„¶å `.zshrc` åˆä¼šå‘ `.zprofile` æ·»åŠ ä¸€è¡Œ `eval "$(/opt/homebrew/bin/brew shellenv)"` , è€Œç¬¬ä¸€æ¬¡å¯åŠ¨ zsh çš„æ—¶å€™åˆè¦æ‰§è¡Œ `.zprofile` é‡Œé¢å‡ åƒè¡ŒåŒæ ·çš„å‘½ä»¤**...... ğŸ˜‚ğŸ˜‚ğŸ˜‚

`eval "$(/opt/homebrew/bin/brew shellenv)"` çš„ä½œç”¨æ˜¯å°† **Homebrew** çš„ç¯å¢ƒå˜é‡é…ç½®åˆ°å½“å‰çš„ Shell ä¸­ï¼Œä½¿å¾— Homebrew çš„å‘½ä»¤å’Œè½¯ä»¶å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚å…·ä½“æ¥è¯´ï¼š

`/opt/homebrew/bin/brew shellenv` ä¼šè¾“å‡ºä¸€ç³»åˆ—ç¯å¢ƒå˜é‡è®¾ç½®å‘½ä»¤:

```bash
export HOMEBREW_PREFIX="/opt/homebrew";
export HOMEBREW_CELLAR="/opt/homebrew/Cellar";
export HOMEBREW_REPOSITORY="/opt/homebrew";
fpath[1,0]="/opt/homebrew/share/zsh/site-functions";
PATH="/opt/homebrew/bin:/opt/homebrew/sbin:..........; export PATH;
[ -z "${MANPATH-}" ] || export MANPATH=":${MANPATH#:}";
export INFOPATH="/opt/homebrew/share/info:${INFOPATH:-}";
```

è€Œ `eval` ä¼šæ‰§è¡Œå­—ç¬¦ä¸²å½¢å¼çš„å‘½ä»¤ï¼Œå°† brew shellenv è¾“å‡ºçš„ç¯å¢ƒå˜é‡ç«‹å³åŠ è½½åˆ°å½“å‰ Shell ç¯å¢ƒä¸­ã€‚

**æ€»ç»“èµ·æ¥**:

- **Homebrew** åœ¨ macOS ä¸Šé»˜è®¤å®‰è£…åœ¨ `/opt/homebrew`ï¼ˆApple Silicon æˆ– Homebrew è‡ªè¡Œç¼–è¯‘çš„ç¯å¢ƒï¼‰ï¼Œä¸ºäº†è®©ç»ˆç«¯èƒ½å¤Ÿæ‰¾åˆ° brew å‘½ä»¤åŠå…¶å®‰è£…çš„è½¯ä»¶ï¼Œéœ€è¦å°†å…¶è·¯å¾„åŠ å…¥åˆ° PATH å’Œå…¶ä»–ç¯å¢ƒå˜é‡ä¸­ã€‚

- ç›´æ¥æ‰§è¡Œ eval å‘½ä»¤å¯ä»¥ç«‹å³ç”Ÿæ•ˆï¼Œè€Œæ— éœ€é‡å¯ç»ˆç«¯æˆ–æ‰‹åŠ¨ä¿®æ”¹é…ç½®æ–‡ä»¶ã€‚

è€Œåœ¨ç¿»çœ‹ **Homebrew** çš„ **Discussions** æ­£å¥½çœ‹åˆ°ä¸€ä¸ª [ç›¸å…³çš„è®¨è®º](https://github.com/orgs/Homebrew/discussions/446):

![20241229144917_npHEw9tq.webp](https://cdn.dong4j.site/source/image/20241229144917_npHEw9tq.webp)

æ‰€ä»¥è§£å†³çš„åŠæ³•å°±æ˜¯åˆ é™¤ `.zshrc` ä¸­çš„ç›¸å…³é…ç½®, ç„¶åæ¸…ç† `.zprofile`.

## macOS è®¾ç½® zsh ä¸ºé»˜è®¤ shell

ä» macOS Catalina å¼€å§‹ï¼ŒmacOS ä½¿ç”¨ zsh ä½œä¸ºé»˜è®¤ç™»å½• shell å’Œäº¤äº’å¼ shell.

### ä»å‘½ä»¤è¡Œ

åœ¨ç»ˆç«¯ä¸­ï¼Œè¾“å…¥`$ chsh -s path`ï¼Œå…¶ä¸­*è·¯å¾„*æ˜¯ /etc/shells ä¸­åˆ—å‡ºçš„ shell è·¯å¾„ä¹‹ä¸€ï¼Œä¾‹å¦‚ /bin/zshã€/bin/bashã€/bin/cshã€/bin/dashã€/bin/kshã€/bin/sh æˆ– /bin/tcshã€‚

### ä»ç”¨æˆ·å’Œç¾¤ç»„è®¾ç½®

åœ¨ macOS Ventura æˆ–æ›´é«˜ç‰ˆæœ¬ä¸­ï¼š

1. é€‰æ‹©è‹¹æœèœå• ï£¿ >â€œç³»ç»Ÿè®¾ç½®â€ï¼Œç„¶åå•å‡»è¾¹æ ä¸­çš„â€œç”¨æˆ·ä¸ç¾¤ç»„â€ã€‚
2. æŒ‰ä½ Control é”®å¹¶ç‚¹æŒ‰å³ä¾§ç”¨æˆ·åˆ—è¡¨ä¸­çš„ç”¨æˆ·åæˆ–ç”¨æˆ·å›¾ç‰‡ï¼Œç„¶åé€‰æ‹©â€œé«˜çº§é€‰é¡¹â€ã€‚
3. å‡ºç°æç¤ºæ—¶è¾“å…¥æ‚¨çš„ç”¨æˆ·åå’Œå¯†ç ã€‚
4. ä»â€œç™»å½• shellâ€èœå•ä¸­é€‰æ‹©ä¸€ä¸ª shellï¼Œç„¶åå•å‡»â€œç¡®å®šâ€ä¿å­˜æ›´æ”¹ã€‚

åœ¨æ—©æœŸç‰ˆæœ¬çš„ macOS ä¸­ï¼š

1. é€‰æ‹©è‹¹æœèœå• ï£¿ >â€œç³»ç»Ÿåå¥½è®¾ç½®â€ï¼Œç„¶åå•å‡»â€œç”¨æˆ·ä¸ç¾¤ç»„â€ã€‚
2. å•å‡»é”![20241229144917_kSBIoKG7.webp](https://cdn.dong4j.site/source/image/20241229144917_kSBIoKG7.webp)ï¼Œç„¶åè¾“å…¥æ‚¨çš„ç”¨æˆ·åå’Œå¯†ç ã€‚
3. æŒ‰ä½ Control é”®å¹¶ç‚¹æŒ‰å·¦ä¾§ç”¨æˆ·åˆ—è¡¨ä¸­çš„ç”¨æˆ·åï¼Œç„¶åé€‰æ‹©â€œé«˜çº§é€‰é¡¹â€ã€‚
4. ä»â€œç™»å½• shellâ€èœå•ä¸­é€‰æ‹©ä¸€ä¸ª shellï¼Œç„¶åå•å‡»â€œç¡®å®šâ€ä¿å­˜æ›´æ”¹ã€‚

**å‚è€ƒ:**

- [Use zsh as the default shell on your Mac](https://support.apple.com/en-ca/102360)

---

## zsh å¯åŠ¨æ—¶é—´ä¼˜åŒ–

ç›¸å…³æ•™ç¨‹:

- [zsh å’Œ oh my zsh å†·å¯åŠ¨é€Ÿåº¦ä¼˜åŒ–](https://blog.skk.moe/post/make-oh-my-zsh-fly/)
- [ä¼˜åŒ– zsh çš„å¯åŠ¨é€Ÿåº¦](https://zhuanlan.zhihu.com/p/464117825)
- [è§£å†³ zsh å¯åŠ¨é€Ÿåº¦æ…¢çš„ä¼˜åŒ–æ–¹æ³•](https://zhuanlan.zhihu.com/p/68303393)

## [HomeLab ç½‘ç»œç»­é›†ï¼šå‡çº§ 10G ç½‘ç»œ-å†æˆ˜ 10 å¹´](https://blog.dong4j.site/posts/7e09e56.md)

![/images/cover/20241229154732_0ssj32bq.webp](https://cdn.dong4j.site/source/image/20241229154732_0ssj32bq.webp)

## ç®€ä»‹

> æ­¥å…¥ä¸­å¹´çš„äººç”Ÿé“è·¯ï¼Œ10GB ä»¥å¤ªç½‘å£ä¸åªæ˜¯æ€§èƒ½çš„ç®€å•æå‡ï¼Œå®ƒæ›´åƒæ˜¯ä¸€æ‰‡é€šå¾€æ–°ç”Ÿæ´»çš„å¤§é—¨ã€‚è¿™æ‰‡é—¨ä¹‹åï¼Œæ˜¯ä¸°ç›ˆçš„è·¯ç”±å™¨ã€äº¤æ¢æœºå’Œ NAS çš„ä¸–ç•Œï¼Œèƒ½å¤Ÿè®©ä½ çš„ä¸­å¹´æ—¶å…‰æ›´åŠ å……å®ã€æ›´åŠ å¿«ä¹ï¼

åœ¨æˆ‘å®¶ 2.5G ç½‘ç»œçš„é™ªä¼´ä¸‹, å·²ç»åº¦è¿‡äº†ä¸‰ä¸ªå……æ»¡æ´»åŠ›çš„å¹´å¤´. è¿™æ®µæ—¶å…‰é‡Œ, æˆ‘çš„ç½‘ç»œç¨³å®šå¯é , æˆä¸ºäº†å®¶ä¸­ä¿¡æ¯é«˜é€Ÿå…¬è·¯çš„åšå®åŸºçŸ³. ç„¶è€Œ, éšç€ç§‘æŠ€çš„å¿«é€Ÿå‘å±•å’Œç”Ÿæ´»éœ€æ±‚çš„å˜åŒ–, æˆ‘å‘ç°åŸæœ¬å¼ºå¤§çš„ 2.5G ç½‘ç»œå·²ç»æ— æ³•æ»¡è¶³æœªæ¥å‡ å¹´æ—¥ç›Šå¢é•¿çš„éœ€æ±‚.

æœŸé—´ä¸€ç›´åœ¨çŠ¹è±«æ˜¯å¦å‡çº§åˆ°ä¸‡å…†, å› ä¸º MBP M1 ä½œä¸ºæˆ‘çš„ä¸»åŠ›æœº, æ‹…å¿ƒä¸‡å…†ç½‘å¡å…¼å®¹æ€§å’Œç¨³å®šæ€§é—®é¢˜, å½“ç„¶ä¹Ÿæœ‰æˆç†Ÿçš„é›·é›³ç½‘å¡å¯ä¾›é€‰æ‹©, ä½†æ˜¯ä»·æ ¼é«˜çš„ç¦»è°±.

æœ€è¿‘, å„ç§å‡çº§æ–¹æ¡ˆé™†ç»­å‡ºç°, ä»·æ ¼ä¹Ÿé€æ¸ç¬¦åˆæˆ‘çš„é¢„ç®—. åŒæ—¶, å®¶ä¸­ä½¿ç”¨çš„ä¸‡å…†è®¾å¤‡ä¹Ÿè¶Šæ¥è¶Šå¤š. è¿™ä¸€åˆ‡è®©æˆ‘æ„è¯†åˆ°å‡çº§åˆ°ä¸‡å…†ç½‘ç»œçš„æ—¶æœºå·²ç»åˆ°äº†.

åœ¨è¿™ç¯‡åšå®¢ä¸­, æˆ‘å°†åˆ†äº«ä»çŠ¹è±«ä¸å†³åˆ°å†³å®šå‡çº§ 10G ç½‘ç»œçš„å†³ç­–è¿‡ç¨‹. è¯¦ç»†ä»‹ç»ç¬¬ä¸€æ¬¡æ¥è§¦çš„å…‰çº¤å’Œå…‰æ¨¡å—çš„ç›¸å…³çŸ¥è¯†, ä¸€æ­¥æ­¥åœ°è®²è§£è®¾å¤‡è´­ä¹°ã€ç½‘ç»œæ‹“æ‰‘è®¾è®¡ã€ç½‘ç»œç¯å¢ƒé…ç½®å’Œç½‘ç»œæµ‹è¯•ç­‰æ–¹é¢çš„ç»†èŠ‚.

<!--

https://post.smzdm.com/p/a8x0z2d7/

-->

---

**ç›¸å…³æ–‡ç« :**

1. [[homelab-guide|å…ˆå¯¼ç¯‡]]ï¼šæˆ‘çš„ HomeLab æ¦‚è¦;
2. [[homelab-hardware|ç¡¬ä»¶ç¯‡]]ï¼šä»‹ç»æˆ‘æ‰€æ‹¥æœ‰çš„ç¡¬ä»¶è®¾å¤‡;
3. [[homelab-network|ç½‘ç»œç¯‡]]ï¼šåŒ…æ‹¬ç½‘ç»œç¯å¢ƒã€å¼‚åœ°ç»„ç½‘ä¸ç½‘ç»œå®‰å…¨;
4. [[homelab-service|æœåŠ¡ç¯‡]]ï¼šä½¿ç”¨ Docker æ­å»ºçš„å„ç±»æœåŠ¡;
5. [[homelab-data|æ•°æ®ç¯‡]]ï¼šåŒ…æ‹¬æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆ;
6. [[homelab-data-sync|HomeLabæ•°æ®åŒæ­¥ï¼šæ„å»ºé«˜æ•ˆçš„æ•°æ®åŒæ­¥ç½‘ç»œ]]
7. [[homelab-data-backup|HomeLabæ•°æ®å¤‡ä»½ï¼šæ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿]]
8. [[homelab-upgrade-to-10g|HomeLab ç½‘ç»œç»­é›†ï¼šå‡çº§ 10G ç½‘ç»œ-å†æˆ˜ 10 å¹´]]
9. [[homelab-guide|NAT å†…ç½‘ç©¿é€è¯¦è§£ï¼šæ­ç§˜ç½‘ç»œè¿æ¥èƒŒåçš„å¥¥ç§˜]]

## MBP ä¸‡å…†å‚è€ƒæ–¹æ¡ˆ

ç›®å‰å¸‚é¢ä¸Šæœ‰è®¸å¤šæˆå“é›·é›³è½¬ä¸‡å…†ç½‘å¡å¯ä¾›é€‰æ‹©. è¿™äº›ç½‘å¡é€šå¸¸æ”¯æŒ RJ45 æˆ– SFP+ æ¥å£, å¯ä»¥ç›´æ¥æ’å…¥ MBP çš„é›·é›³ 3 æˆ–é›·é›³ 4 ç«¯å£, æ— éœ€é¢å¤–çš„ç¡¬ä»¶è½¬æ¢. åªéœ€è¿æ¥ä¸€æ ¹å…‰ç¼†å³å¯å®ç°é«˜é€Ÿç½‘ç»œä¼ è¾“.

å¦ä¸€ç§æ–¹å¼æ˜¯ DIY, å¯ä»¥æ›´ä½æˆæœ¬å®ç°ä¸‡å…†ç½‘ç»œ. DIY æ–¹æ¡ˆä¸»è¦åˆ†ä¸ºä¸¤ç§ï¼šé›·é›³è½¬ PCIE å’Œ USB4 ç¡¬ç›˜ç›’çš„ M2 è½¬ PCIE.

### æˆå“ç½‘å¡

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹æ”¯æŒ MBP çš„ä¸‡å…†æˆå“ç½‘å¡(åæ­£ä¸ä¹°, çœ‹çœ‹æ€»å¯ä»¥å§).

é¦–å…ˆæ˜¯å¨è”é€šçš„ [QNA-T310G1T](https://www.qnap.com.cn/zh-cn/product/qna-t310g1t) ä¸ [QNA-T310G1S](https://www.qnap.com.cn/zh-cn/product/qna-t310g1s), ç°åœ¨äºŒæ‰‹æˆæœ¬ 1000+.

![20241229154732_nw3jFcPi.webp](https://cdn.dong4j.site/source/image/20241229154732_nw3jFcPi.webp)

**QNAP T310G1T å’Œ T310G1S** æ˜¯ä¸¤æ¬¾é«˜æ€§èƒ½çš„ä¸‡å…†ç½‘å¡, åˆ†åˆ«é‡‡ç”¨ NBASE-T å’Œ SFP+ æ¥å£, æ”¯æŒ 10G è¿ç½‘èƒ½åŠ›. å®ƒä»¬ä½“ç§¯å°å·§, æ˜“äºæºå¸¦, èƒ½å¤Ÿæ˜¾è‘—æå‡æ•°æ®ä¼ è¾“é€Ÿåº¦.

**ç‰¹ç‚¹:**

- **é«˜é€Ÿä¼ è¾“**ï¼šæ”¯æŒ 10G è¿ç½‘èƒ½åŠ›, å°†æ•°æ®ä¼ è¾“é€Ÿåº¦æå‡è‡³ 10 å€ä»¥ä¸Š.
- **å°å·§è½»ä¾¿**ï¼šä½“ç§¯å°å·§, æ˜“äºæºå¸¦, æ–¹ä¾¿ç”¨æˆ·éšæ—¶éšåœ°ä½¿ç”¨.
- **å¤šç§æ¥å£**ï¼šT310G1T é‡‡ç”¨ NBASE-T æ¥å£, æ”¯æŒå¤šç§è¿æ¥æ¨¡å¼ï¼›T310G1S é‡‡ç”¨ SFP+ æ¥å£, é€‚ç”¨äºå¤šç§åœºæ™¯.
- **é«˜æ•ˆæ•£çƒ­**ï¼šé“åˆé‡‘å¤–å£³å…·æœ‰è‰¯å¥½çš„æ•£çƒ­æ€§èƒ½, ç¡®ä¿é•¿æ—¶é—´è¿è¡Œ.
- **æ˜“äºå®‰è£…**ï¼šæ— éœ€é¢å¤–ä¾›ç”µ, ç›´æ¥è¿æ¥è®¾å¤‡å³å¯ä½¿ç”¨, Windows ç³»ç»Ÿéœ€è¦å®‰è£…é©±åŠ¨ç¨‹åº.

---

[AKiTiO Thunder3 Dock Pro](https://www.akitio.com.tw/accessories/thunder3-dock-pro)

![20241229154732_DWd9MJMt.webp](https://cdn.dong4j.site/source/image/20241229154732_DWd9MJMt.webp)

å¸‚é¢ä¸Šä¸ºæ•°ä¸å¤šçš„æ‹“å±•åå’Œä¸‡å…†å£ç»“åˆäº§å“, ä»·æ ¼æ„Ÿäºº.

**ç‰¹ç‚¹:**

- **Thunderbolt 3 æŠ€æœ¯**ï¼šæä¾›é«˜è¾¾ 40Gbps çš„ä¼ è¾“é€Ÿåº¦, æ”¯æŒ 10GbE ç½‘ç»œã€å¤šç§å­˜å‚¨å¡è¯»å–ã€å¤šç§æ¥å£è¿æ¥ç­‰.
- **å¤šåŠŸèƒ½æ‰©å±•**ï¼šå†…ç½® DisplayPortã€USB .1ã€eSATA ç­‰æ¥å£, å¯æ‰©å±•ç”µè„‘çš„å¤šç§åŠŸèƒ½.
- **å……ç”µåŠŸèƒ½**ï¼šæ”¯æŒ 60W å……ç”µ, å¯ä¸ºç¬”è®°æœ¬ç­‰è®¾å¤‡å……ç”µ.
- **å…¼å®¹æ€§**ï¼šæ”¯æŒ Windows å’Œ macOS æ“ä½œç³»ç»Ÿ

å¦ä¸€æ¬¾æ”¯æŒä¸‡å…†çš„æ‰©å±•å -- [OWC Thunderbolt Pro Dock](https://www.owcasia.com.tw/docks/owc-thunderbolt-pro-dock) å…·æœ‰é«˜é€Ÿ Thunderbolt 3 è¿æ¥ã€10GbE ä¹™å¤ªç½‘ã€å¤šç§è¯»å¡å™¨æ¥å£å’Œä¸°å¯Œçš„ USB è¿æ¥, å¯æ»¡è¶³å„ç§è¿æ¥éœ€æ±‚, æå‡å·¥ä½œæ•ˆç‡.

![20241229154732_wskVm3ki.webp](https://cdn.dong4j.site/source/image/20241229154732_wskVm3ki.webp)

**ç‰¹ç‚¹**:

- **é«˜é€Ÿè¿æ¥**ï¼šThunderbolt 3 å’Œ 10GbE ä¹™å¤ªç½‘, å®ç°é«˜é€Ÿæ•°æ®ä¼ è¾“å’Œè¿æ¥.
- **å¤šåŠŸèƒ½è¯»å¡å™¨**ï¼šCFexpress Type B å’Œ SD 4.0 è¯»å¡å™¨, æ–¹ä¾¿å¿«é€Ÿè¯»å†™å¡.
- **ä¸°å¯Œæ¥å£**ï¼šå¤šä¸ª USB-Aã€USB-C å’Œ DisplayPort æ¥å£, æ»¡è¶³å„ç§å¤–è®¾è¿æ¥éœ€æ±‚.
- **å°å·§ä¾¿æº**ï¼šç´§å‡‘è®¾è®¡, ä¾¿äºæºå¸¦å’Œå®‰è£….

---

[CalDigit çš„ Thunderbolt 3 10Gb ä»¥å¤ªç½‘è½¬æ¥å™¨](https://www.caldigit.com/zh/connect-10-g-zh/)

![20241229154732_yf5cSCWA.webp](https://cdn.dong4j.site/source/image/20241229154732_yf5cSCWA.webp)

è¯¥è½¬æ¥å™¨å¯å°† Thunderbolt 3 è®¡ç®—æœºè¿æ¥åˆ° 10GbE ä»¥å¤ªç½‘ç»œ, æä¾›é«˜è¾¾ 10Gbps çš„ä¼ è¾“é€Ÿåº¦, é€‚ç”¨äºä¼ä¸šã€å·¥ä½œå®¤ã€ç”µç«å’Œå®¶åº­ç½‘ç»œç­‰åœºæ™¯.

**ç‰¹ç‚¹:**

- 10Gbps ä»¥å¤ªç½‘é€Ÿåº¦, æ¯”ä¼ ç»Ÿ 1Gbps ä»¥å¤ªç½‘å¿« 10
- æ”¯æŒæœ€é•¿ 100 ç±³çš„è¿æ¥è·ç¦»
- æ”¯æŒéŸ³é¢‘è§†é¢‘æ¡¥æ¥ (AVB) åŠŸèƒ½
- å¯æ›¿æ¢å¼ Thunderbolt 3 ä¼ è¾“çº¿
- æ€»çº¿ä¾›ç”µ, æ— éœ€å¤–æ¥ç”µæº
- å…¼å®¹å¤šç§ç½‘ç»œçº¿ç¼†, åŒ…æ‹¬ Cat 5eã€Cat 6 å’Œ Cat 6a
- æ”¯æŒç½‘ç»œå”¤é†’åŠŸèƒ½
- é“åˆ¶å¤–å£³è®¾è®¡, æ•£çƒ­è‰¯å¥½
- æ”¯æŒ macOS å’Œ Windows ç³»ç»Ÿ

---

[Sonnet çš„ Solo10G SFP+ ](https://www.sonnettech.com/product/solo10g-sfp-tb3/overview.html)

![20241229154732_cYfOal47.webp](https://cdn.dong4j.site/source/image/20241229154732_cYfOal47.webp)

è¿™æ˜¯ä¸€æ¬¾å°† 10GbE ç½‘ç»œè¿æ¥åˆ° Macã€Windows å’Œ Linux è®¡ç®—æœºçš„è®¾å¤‡. è¯¥é€‚é…å™¨é€šè¿‡ Thunderbolt è¿æ¥, æä¾›é«˜é€Ÿçš„ç½‘ç»œè¿æ¥, å¹¶æ”¯æŒå¤šç§æ“ä½œç³»ç»Ÿ.

**ç‰¹ç‚¹:**

- æ”¯æŒé«˜è¾¾ 10GbE çš„ç½‘ç»œé€Ÿåº¦
- é€šè¿‡ Thunderbolt è¿æ¥, æä¾›é«˜é€Ÿæ•°æ®ä¼ è¾“
- æ”¯æŒå¤šç§æ“ä½œç³»ç»Ÿï¼šMacã€Windows å’Œ Linux
- åŒ…å« SFP+ å…‰çº¤æ¨¡å—, å¯è¿æ¥åˆ° 10GbE åŸºç¡€è®¾æ–½
- è½»å·§ä¾¿æº, æ— éœ€å¤–éƒ¨ç”µæº

**å…¶ä»–å“ç‰Œ:**

- [å…®å…‹é›·é›³è½¬ä¸‡å…†ç½‘å¡ä¸‡å…†ç”µå£å…¼å®¹é›·é›³ 3 é›·é›³ 4 è½¬ä¸‡å…†ç½‘å¡ SKN-T310GT](https://item.jd.com/10121176306316.html)
- [ä¹æ‰© USB4 ä¸‡å…†ç½‘å¡å…¼å®¹ é›·é›³ 3/4 ç”µå£ RJ45 ç½‘ç»œè½¬æ¢å™¨ 10G ç½‘å¡](https://item.jd.com/10102887511740.html)
- [å¥¥ç¿ç§‘é›·é›³ 3 è½¬ 10GbE ä¸‡å…†ç½‘ç»œè½¬æ¢å™¨](https://item.jd.com/10126348888148.html)

---

ç‹ç‚¸ç½‘å¡--[ATTO ThunderLink TLNS-3252](https://www.atto.com/products/thunderlink-adapters/)

åŒç«¯å£ Thunderboltâ„¢ 3/4 è‡³åŒç«¯å£ 25Gb ä»¥å¤ªç½‘é€‚é…å™¨, é™„å¸¦ SFP28 æ¨¡å—. æ”¯æŒ macOS å’Œ Windows æ“ä½œç³»ç»Ÿ. éå¸¸é€‚åˆå¸¦å®½å¯†é›†å‹åº”ç”¨, ä¾‹å¦‚æ•°æ®å¤‡ä»½å’Œæ¢å¤ã€é›†ç¾¤è®¡ç®—ã€IP å†…å®¹äº¤ä»˜ã€åŒ»å­¦æˆåƒå’Œè§†é¢‘æ¸²æŸ“.

![20241229154732_j10NgGDz.webp](https://cdn.dong4j.site/source/image/20241229154732_j10NgGDz.webp)

- åŒç«¯å£ 25Gb/s Thunderbolt 3, å¸¦ DisplayPort å’Œè®¾å¤‡èŠèŠ±é“¾æ”¯æŒ (å…¼å®¹ Thunderbolt 4)
- æ¯ä¸ªç«¯å£ååé‡é«˜è¾¾ 25Gb/s
- åŒ…å« SFP28 æ¨¡å—
- æ”¯æŒ macOSÂ® å’Œ WindowsÂ®
- æ”¯æŒ[ATTO 360](https://www.atto.com/landing/atto360)
- TCPã€UDP å’Œ IPv4 æ ¡éªŒå’Œå¸è½½ã€IPsec å¸è½½ä»¥åŠ Tx/TCP åˆ†æ®µå¸è½½
- ç‹¬å®¶[å…ˆè¿›æ•°æ®æµ (ADSâ„¢) æŠ€æœ¯](https://www.atto.com/wp-content/uploads/WebCollateral/tech-brief/TechBrief-ATTOAdvancedDataStreamingTechnology.pdf)
- Kensington å®‰å…¨æ’æ§½å¯é€šè¿‡[Kensington é”æä¾›é¢å¤–çš„å®‰å…¨ä¿æŠ¤](https://www.atto.com/redir/www.kensington.com/us/us/v/4482/1866/microsaver-ds-ultrathin-keyed-laptop-locks)

---

### DIY

<!--

https://uuzi.net/thunderbolt-usb4-ssd-enclosure-buying-guide/

-->

ç›¸å¯¹äºä»·æ ¼é«˜æ˜‚ä½†ç¨³å®šçš„æˆå“ç½‘å¡æ¥è¯´, DIY æ–¹å¼æ‰åº”è¯¥æ˜¯æˆ‘çš„æœ€ç»ˆé€‰æ‹©, å› ä¸º MBP å‡çº§åˆ°ä¸‡å…†å¹¶ä¸æ˜¯å¿…é¡», æ€§ä»·æ¯”æ˜¾ç„¶æ¯”ç¨³å®šæ€§æ›´é‡è¦.

ç°åœ¨ä¸»æµçš„ 2 ç§ DIY ä¸‡å…†ç½‘å¡æ–¹æ¡ˆä¸º:

- Thunderbolt è½¬ PCIe, ä¸»æ§èŠ¯ç‰‡ä¸€èˆ¬ Intel çš„ **JHL6X40** æˆ–**JHL7X40**;
- USB4.0 è½¬ PCIe, ä¸»æ§èŠ¯ç‰‡ä¸€èˆ¬ ASMedia çš„ **ASM2464PD**;

ä¸ºäº†ææ¸…æ¥š Intel å’Œ ASMedia ä¸»æ§èŠ¯ç‰‡å¯¹é€Ÿåº¦çš„å½±å“, å†³å®šå…ˆå­¦ä¹ ä¸€ä¸‹ 2 ç§ä¸»æ§èŠ¯ç‰‡çš„å·®å¼‚, ä¼ è¾“é€Ÿåº¦çš„åŒºåˆ«.

### é›·é›³ 4/3 å’Œ USB4.0

é¦–å…ˆç®€å•ä»‹ç»ä¸€ä¸‹å…³äºé›·é›³ 4/3 å’Œ USB4.0, å®ƒä»¬éƒ½æ˜¯ç›®å‰å¸¸è§çš„ã€ç”¨äºé«˜é€Ÿæ•°æ®ä¼ è¾“å’Œè§†é¢‘è¾“å‡ºçš„æ¥å£æ ‡å‡†. å…±äº«ç›¸åŒçš„ USB-C æ¥å£, ä½†å„è‡ªæœ‰ä¸åŒçš„ç‰¹ç‚¹å’Œä¼˜åŠ¿.

#### é›·é›³ 4/3

- **æ ¸å¿ƒæŠ€æœ¯**: ç”± Intel ä¸»å¯¼å¼€å‘, åŸºäº PCIe åè®®, æä¾›é«˜é€Ÿæ•°æ®ä¼ è¾“ã€è§†é¢‘è¾“å‡ºå’Œä¾›ç”µåŠŸèƒ½.
- ä¸»è¦ç‰¹ç‚¹ï¼š
  - **é«˜é€Ÿä¼ è¾“**: æœ€é«˜å¯è¾¾ 40Gbps çš„ä¼ è¾“é€Ÿåº¦, é€‚ç”¨äºå¤§æ–‡ä»¶ä¼ è¾“å’Œé«˜åˆ†è¾¨ç‡è§†é¢‘ä¼ è¾“.
  - **è§†é¢‘è¾“å‡º**: æ”¯æŒå¤šä¸ª 4K æ˜¾ç¤ºå™¨æˆ– 1 ä¸ª 8K æ˜¾ç¤ºå™¨, æ»¡è¶³é«˜å“è´¨è§†é¢‘éœ€æ±‚.
  - **ä¾›ç”µèƒ½åŠ›**: æœ€é«˜å¯æä¾› 100W çš„ä¾›ç”µ, å¯ä¸ºç¬”è®°æœ¬ç”µè„‘ç­‰è®¾å¤‡å……ç”µ.
- **ä¼˜åŠ¿**: æ€§èƒ½å¼ºåŠ², åŠŸèƒ½ä¸°å¯Œ, é€‚ç”¨äºå¯¹æ€§èƒ½è¦æ±‚è¾ƒé«˜çš„ç”¨æˆ·, å¦‚è§†é¢‘ç¼–è¾‘ã€æ¸¸æˆç©å®¶ç­‰.

#### USB4.0

- **æ ¸å¿ƒæŠ€æœ¯**: ç”± USB-IF ç»„ç»‡åˆ¶å®š, æ•´åˆäº†é›·é›³ 3 çš„å…ˆè¿›æŠ€æœ¯, å‘ä¸‹å…¼å®¹ USB 3.2 ç­‰åè®®.
- ä¸»è¦ç‰¹ç‚¹ï¼š
  - **é«˜é€Ÿä¼ è¾“**: æœ€é«˜å¯è¾¾ 40Gbps çš„ä¼ è¾“é€Ÿåº¦, ä¸é›·é›³ 4 ç›¸åŒ.
  - **è§†é¢‘è¾“å‡º**: æ”¯æŒå’Œé›·é›³ 3 åŒç­‰çš„è§†é¢‘æ‹“å±•èƒ½åŠ›.
  - **ä¾›ç”µèƒ½åŠ›**: å…·å¤‡å¤§åŠŸç‡ PD ç”µåŠ›ä¼ è¾“åŠŸèƒ½.
- **ä¼˜åŠ¿**: å…¼å®¹æ€§å¼º, å‘ä¸‹å…¼å®¹ USB 3.2 ç­‰åè®®, ä»·æ ¼ç›¸å¯¹è¾ƒä¾¿å®œ.

**é›·é›³ 4/3 å’Œ USB4.0 çš„åŒºåˆ«**:

| ç‰¹ç‚¹   | é›·é›³ 4/3         | USB4.0                  |
| ------ | ---------------- | ----------------------- |
| å¼€å‘è€… | Intel            | USB-IF ç»„ç»‡             |
| åè®®   | PCIe             | `USB`                   |
| å…¼å®¹æ€§ | å‘ä¸‹å…¼å®¹ USB 3.2 | å‘ä¸‹å…¼å®¹ USB 3.2 ç­‰åè®® |
| ä»·æ ¼   | è¾ƒé«˜             | ç›¸å¯¹è¾ƒä½                |
| åŠŸèƒ½   | æ›´ä¸°å¯Œ, æ€§èƒ½æ›´å¼º | å…¼å®¹æ€§æ›´å¹¿              |

æ€»ç»“æ¥è¯´é›·é›³ 4/3 æ›´é€‚åˆå¯¹æ€§èƒ½æœ‰è¾ƒé«˜è¦æ±‚çš„ç”¨æˆ·, å¦‚ä¸“ä¸šåˆ›ä½œè€…ã€æ¸¸æˆç©å®¶ç­‰. **USB4.0** å…·æœ‰æ›´å¥½çš„å…¼å®¹æ€§, é€‚ç”¨äºæ™®é€šç”¨æˆ·, æ€§ä»·æ¯”æ›´é«˜.

---

### ä¸»æ§èŠ¯ç‰‡

#### JHL7440

**JHL7440** æ˜¯æ¥è‡ªè‹±ç‰¹å°”ç”Ÿäº§çš„æ§åˆ¶èŠ¯ç‰‡, å¾—ç›Šäºè‡ªå®¶æ˜¯é›·é›³æ¥å£çš„ä¸»è¦å¼€å‘è€…, åœ¨æ€§èƒ½å’Œä¼ å…¼å®¹æ€§ä¸Šæœ‰å¾ˆå¥½çš„è¡¨ç°.

å…¶å®ä½ ä¼šå‘ç°å¤§å¤šæ•°çš„ç¡¬ç›˜ç›’å“ç‰Œåœ¨ä»‹ç»çš„æ—¶å€™å®£ç§° **JHL7440** ä¸ Thunderbolt 3/4 å…¼å®¹, äº‹å®ä¸Šè¿™æ ·è¯´å¥½åƒä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜. ä½†å…¶å®è¯¥èŠ¯ç‰‡åªæ˜¯å…¼å®¹ Thunderbolt 4, ä½†å®é™…ä¸Šåªæ˜¯ Thunderbolt 3 æ—¶æœŸçš„äº§ç‰©.

**JHL7440** èŠ¯ç‰‡ç»„, è¯¥èŠ¯ç‰‡ç»„æä¾›é«˜è¾¾ **24Gbps** çš„ä¼ è¾“é€Ÿåº¦, å®é™…é€Ÿåº¦æœ€é«˜çº¦ä¸º **2800 MB/s**. å¾ˆå¤šæœ‹å‹å¯èƒ½å¥½å¥‡, é›·é›³ 4/3ã€USB4.0 æ¥å£ä¸æ˜¯æœ€é«˜æ”¯æŒ **40Gbps** çš„ä¼ è¾“é€Ÿåº¦å—, æ€ä¹ˆåˆ°è¿™é‡Œæœ€é«˜ä»…æä¾› **24Gbps (2800MB/s)** çš„é€Ÿåº¦.

ç¡®å®, Thunderbolt 3/4 å’Œ USB4.0 æ¥å£ç†è®ºä¸Šæ”¯æŒé«˜è¾¾ **40Gbps** çš„ä¼ è¾“é€Ÿåº¦. ç„¶è€Œ, åœ¨å®é™…åº”ç”¨ä¸­, ç”±äºç¡¬ä»¶è®¾è®¡å’ŒæŠ€æœ¯é™åˆ¶, æŸäº›æ§åˆ¶èŠ¯ç‰‡ (å¦‚ **Intel JHL7440**) å¹¶ä¸èƒ½å®Œå…¨è¾¾åˆ°è¿™ä¸ªé€Ÿç‡. ä¸‹é¢æ˜¯é€ æˆè¿™ç§å·®å¼‚çš„å‡ ä¸ªåŸå› ï¼š

**1. å¸¦å®½åˆ†é…é™åˆ¶**

- **JHL7440** èŠ¯ç‰‡è®¾è®¡ä¹‹åˆ, å®šä½ä¸»è¦æ˜¯ **Thunderbolt 3** è§„èŒƒ, å¹¶ä¸»è¦ç”¨äºæ¥å£æ‰©å±•. è™½ç„¶å®ƒå…¼å®¹ Thunderbolt 3 çš„é«˜è¾¾ 40Gbps çš„å¸¦å®½, ä½†åœ¨å…·ä½“è®¾è®¡ä¸Š, å¾€å¾€åªèƒ½åˆ†é…å…¶ä¸­çš„ **24Gbps** ç”¨äºæ•°æ®ä¼ è¾“.
- Thunderbolt æ¥å£çš„ 40Gbps æ˜¯æ€»å¸¦å®½, å®é™…åº”ç”¨ä¸­éœ€è¦åˆ†é…ç»™ **æ•°æ®ä¼ è¾“ã€æ˜¾ç¤ºè¾“å‡º** ç­‰ç”¨é€”. è€Œ **JHL7440** ä¸»è¦ä¸ºæ•°æ®ä¼ è¾“è®¾è®¡, å› æ­¤ä»…åˆ†é… **24Gbps**.

**2. PCIe é€šé“é™åˆ¶**

- **JHL7440** è¿æ¥åˆ°ä¸»æ¿æ—¶, é€šå¸¸ä»…é€šè¿‡ **PCIe 3.0 x2 é€šé“**ä¸ç³»ç»Ÿé€šä¿¡, è€Œéå…¨é€Ÿçš„ PCIe x4. å› æ­¤, è¿™ä¸€è®¾è®¡åœ¨æ¥å£å±‚é¢ä¸Šå°±é™åˆ¶äº†æœ€å¤§æ•°æ®ä¼ è¾“é€Ÿåº¦, çº¦ä¸º **24Gbps**, ä¹Ÿå°±æ˜¯å®é™…çš„ **2800MB/s** å·¦å³.

**3. å…¼å®¹æ€§å’Œæˆæœ¬è€ƒé‡**

- **JHL7440** çš„è®¾è®¡ä¸»è¦é¢å‘æ€§ä»·æ¯”å¸‚åœº, æ„åœ¨é™ä½è®¾å¤‡æˆæœ¬å¹¶æä¾›å¯é çš„ Thunderbolt 3 æ€§èƒ½, å› æ­¤å¯¹æé™æ€§èƒ½çš„æ”¯æŒç›¸å¯¹è¾ƒä½.
- å¯¹äºæ—¥å¸¸æ•°æ®ä¼ è¾“éœ€æ±‚, 2800MB/s å·²ç»èƒ½æ»¡è¶³å¤§å¤šæ•°åœºæ™¯ (å¦‚é«˜æ¸…è§†é¢‘å‰ªè¾‘ã€æ•°æ®å¤‡ä»½ç­‰) , å› æ­¤å¯¹äºå¤šæ•°å‚å•†è€Œè¨€, **JHL7440** æ˜¯ä¸€ä¸ªæ€§èƒ½å’Œæˆæœ¬çš„å¹³è¡¡ä¹‹é€‰.

**4. å®é™…åº”ç”¨ä¸­çš„é€Ÿç‡æŸè€—**

- å®é™…ä¸­, ä¼ è¾“é€Ÿç‡ä¼šå—å¤šç§å› ç´ å½±å“, å¦‚ **ç¡¬ç›˜ç±»å‹ã€æ•£çƒ­æƒ…å†µã€æ•°æ®ä¼ è¾“åè®®** ç­‰. å³ä¾¿ç¡¬ä»¶æ¥å£æ”¯æŒæ›´é«˜é€Ÿåº¦, ä½† SSD æœ¬èº«çš„å†™å…¥/è¯»å–é€Ÿåº¦ä¹Ÿä¼šæˆä¸ºç“¶é¢ˆ.

---

##### å„å‹å·åŒºåˆ«

`JHL6340`ã€`JHL6540`ã€`JHL7440`å’Œ `JHL7540`å‡ ä¸ªå‹å·ï¼š

1. **JHL6340 å’Œ JHL6540**ï¼š
   - è¿™ä¸¤æ¬¾èŠ¯ç‰‡éƒ½æ˜¯ Intel æ¨å‡ºçš„ Thunderbolt 3 (é›·é›³ 3) ä¸»æ§èŠ¯ç‰‡. æ ¹æ®å®˜æ–¹å‚æ•°, JHL6340 å’Œ JHL6540 ä¸æ—§æ¬¾çš„ DSL6340 å’Œ DSL6540 åœ¨å•åŒå£çš„åŠŸè€—ã€å°è£…é¢ç§¯ã€DP è¾“å‡ºæ ‡å‡†ç­‰æ–¹é¢æ²¡æœ‰åŒºåˆ«.
   - JHL6540 çš„åŠŸè€—ä¸º 2.2w, ç›¸æ¯”ä¹‹ä¸‹, JHL6340 çš„åŠŸè€—ä¸º 1.7w.
2. **JHL7440**ï¼š
   - JHL7440 ä¹Ÿæ˜¯ä¸€æ¬¾é›·é›³ 3 ä¸»æ§èŠ¯ç‰‡, ä½†å®ƒè¢«è®¾è®¡ä¸ºåŒæ—¶æ”¯æŒ USB-C çš„ Function, æé«˜äº†è®¾å¤‡çš„è¿ç”¨å¼¹æ€§. è¿™ä½¿å¾—æ–°ä¸€ä»£çš„ Dock/Hub/æ˜¾ç¤ºå™¨å¯ä»¥â€œé™çº§â€åˆ° USB-C æ¨¡å¼ä¸‹ä½¿ç”¨.
3. **JHL7540**ï¼š
   - ä¸ JHL6540 ç›¸æ¯”, JHL7540 åœ¨æ˜¾å­˜è¯»å–å¸¦å®½ä¸Šæå‡äº† 10%, å…¶è¯»å–å¸¦å®½å¯è¾¾åˆ° 3017MB/s, è€Œ 6540 çš„è¯»å–å¸¦å®½æœ€å¤šä¸º 2750MB/s. åœ¨æ€§èƒ½æµ‹è¯•ä¸­, ä½¿ç”¨ JHL7540 çš„æ˜¾å¡ååœ¨å¸§æ•°ä¸Šæ¯”ä½¿ç”¨ JHL6540 çš„æ˜¾å¡åé«˜å‡ºçº¦ 6.5%.

è¿™äº›å‹å·ä¹‹é—´çš„ä¸»è¦åŒºåˆ«åœ¨äºæ€§èƒ½å’Œå…¼å®¹æ€§. JHL6340 å’Œ JHL6540 æ˜¯è¾ƒæ—©çš„å‹å·, è€Œ JHL7440 å’Œ JHL7540 æä¾›äº†æ›´é«˜çš„æ€§èƒ½å’Œæ›´å¥½çš„å…¼å®¹æ€§.

---

#### ASM2464PD

**ASM2464PD** æ˜¯ ASMedia å…¬å¸ (åç¡•å­å…¬å¸) æ¨å‡ºçš„ä¸€æ¬¾ **USB4 / Thunderbolt æ§åˆ¶èŠ¯ç‰‡**, å…¶å®è¯¥èŠ¯ç‰‡æ˜¯ USB4.0 çš„äº§ç‰©, ä¸è¿‡ä¹ŸåŒæ ·å…¼å®¹é›·é›³ 4/3 æ¥å£. ä¸è‹±ç‰¹å°”çš„ JHL7440 ç›¸æ¯”, ASM2464PD æ›´å…·æ€§ä»·æ¯”.

ä»å®ä½“ä½“éªŒä¸Šæ¥è¯´, **ASM2464PD** èŠ¯ç‰‡çš„ç¡¬ç›˜ç›’ä¼¼ä¹èƒ½æä¾›æ›´é«˜çš„ä¼ è¾“é€Ÿåº¦. å› ä¸ºä¸ Thunderbolt 3 è®¾è®¡ä¸åŒ, æ²¡æœ‰ä¸º DisplayPort æˆ–ä¼ ç»Ÿ USB 3.x è§„èŒƒä¿ç•™å¸¦å®½. æ‰€ä»¥, ä½ å¯ä»¥ä»ç½‘ç»œä¸Šçœ‹åˆ°é‡‡ç”¨ **ASM2464PD** èŠ¯ç‰‡çš„ç¡¬ç›˜ç›’çš„ä¼ è¾“é€Ÿåº¦èƒ½æ¥åˆ° 3000MB/s å‡ºå¤´çš„æˆç»©.

è™½ç„¶é€Ÿåº¦ä¸Šæ›´èƒœ **JHL7440**, ä¸”ä»·æ ¼ç›¸å¯¹ä½å»‰, ä½†å…¶å® **ASM2464PD** ä¹Ÿæœ‰ç¼ºç‚¹, åœ¨å…¼å®¹æ€§ä¸å‘çƒ­ä¸Š, **ASM2464PD** ä¼¼ä¹æ¯” **JHL7440** æ›´ä¸¥é‡.

**ä¸åŒä¸»æ§èŠ¯ç‰‡çš„ç¡¬ç›˜ç›’é€Ÿåº¦å¯¹æ¯”:**

| ä¾›åº”å•†  | ä¸»æ§èŠ¯ç‰‡                                                                                                                         | ä¸Šæ¸¸æ¥å£                  | ä¸‹æ¸¸æ¥å£        | ç†è®ºé€Ÿåº¦ | çœŸå®é€Ÿåº¦      |
| ------- | -------------------------------------------------------------------------------------------------------------------------------- | ------------------------- | --------------- | -------- | ------------- |
| ASMedia | [ASM2464PD](https://www.asmedia.com.tw/search?keyword=ASM2464PD)                                                                 | **USB4** with PCIe Gen4x4 | PCIe Gen**4Ã—4** | 40Gb/s   | 3200-3800MB/s |
| Intel   | [JHL7440](https://www.intel.com/content/www/us/en/products/sku/97401/intel-jhl7440-thunderbolt-3-controller/specifications.html) | **TB3** with PCIe Gen3x4  | PCIe Gen3x4     | 24Gb/s   | 2600-2800MB/s |
| Intel   | [JHL6X40](https://ark.intel.com/content/www/us/en/ark/products/codename/56890/products-formerly-alpine-ridge.html)               | **TB3** with PCIe Gen3x4  | PCIe Gen3x4     | 22Gb/s   | 2500-2600MB/s |

### å‚è€ƒæ–¹æ¡ˆ

#### ç¡¬ç›˜ç›’è½¬ PCIe

ç¡¬ç›˜ç›’æœ‰ 2 ç±»èƒ½æ»¡è¶³è¦æ±‚:

- åŸºäº **JHL6X40** æˆ– **JHL7X40** ä¸»æ§èŠ¯ç‰‡çš„é›·é›³ç¡¬ç›˜ç›’;
- åŸºäº **ASM2464PD** ä¸»æ§èŠ¯ç‰‡çš„ USB4.0 ç¡¬ç›˜ç›’;

##### æ–¹æ¡ˆä¸€(300+)

å¶ç„¶åˆ·åˆ° [300 å—æå®šè‹¹æœé›·é›³ä¸‡å…†ç½‘å¡](https://www.bilibili.com/video/BV1a4421Z7Rz/) è¿™ä¸ªè§†é¢‘, Up ä¸»ä½¿ç”¨ 200+ çš„ USB4.0 ç¡¬ç›˜ç›’å®ç°äº† MBP ä¸‡å…†:

![20241229154732_8HFJIg0I.webp](https://cdn.dong4j.site/source/image/20241229154732_8HFJIg0I.webp)

å®ç°æ–¹å¼ä¸º:

1. USB4.0 ç¡¬ç›˜ç›’(å…³é”®è¯[USB4.0 ç¡¬ç›˜ç›’ m2 é›·é›³ 4 ç¡¬ç›˜ç›’ 40G-nvme USB2.0 æ‰©å±•åéŸ³é¢‘æ”¹è£…ä¸‡ç½‘å¡]-æŸå¤šå¤š): ä¸»æ§èŠ¯ç‰‡æ˜¯ **ASM2464PD**, ç°åœ¨æ¶¨ä»·åˆ° **240+** äº†;
2. m.2 è½¬ PCIe å°æ¿: 10+
3. å…é©±ä¸‡å…†ç½‘å¡: æ›™å…‰å•å£ä¸‡å…†ç½‘å¡(Intel X520-DA1) ;

> é¡¾è™‘:
>
> - ä¸æ˜¯ M ç³»åˆ—èŠ¯ç‰‡ä¸”ä¸æ˜¯æœ€æ–°çš„ç³»ç»Ÿ;
> - ä¸æ˜¯åŒå…‰å£ç½‘å¡

è¿™ç§æ–¹æ¡ˆå› ä¸ºæ²¡æœ‰å¤–æ¥ä¾›ç”µ, ä¼šå‡ºç°æ‰å¡çš„æƒ…å†µ, æ‰€ä»¥è¯„è®ºä¸­å°±æœ‰å¤–æ¥ä¾›ç”µçš„æ–¹æ¡ˆ.

---

##### æ–¹æ¡ˆäºŒ(600+)

- ITGZ åŒ M.2 ç¡¬ç›˜ç›’, ä¸»æ§ï¼š**JHL7440**;
- m.2 è½¬ PCIe å°æ¿;
- 12V DC è½¬ SATA ä¾›ç”µ;
- ç½‘å¡: Intel Intel X520-DA2;

![20241229154732_KjNxXAf0.webp](https://cdn.dong4j.site/source/image/20241229154732_KjNxXAf0.webp)

ä½¿ç”¨çš„æ˜¯: [ITGZ é›·é›³ 3 åŒç›˜ M.2 NVMe ç¡¬ç›˜ç›’æ‰©å±•å](https://item.jd.com/10121657056426.html), ä»·æ ¼ 500+.

![20241229154732_ibKckMOB.webp](https://cdn.dong4j.site/source/image/20241229154732_ibKckMOB.webp)

> é¡¾è™‘:
>
> - ä¸çŸ¥é“ä½œè€…çš„ MBP å…·ä½“é…ç½®æ˜¯ä»€ä¹ˆ, ä¸”æ•´å¥—è®¾å¤‡ä»·æ ¼è¶…é¢„ç®—.

---

##### æ–¹æ¡ˆä¸‰(300+)

å¦ä¸€ä¸ª UP ä¸»æ–¹æ¡ˆ: [é›·é›³ä¸‡å…†ç½‘å¡å»‰ä»·æ–¹æ¡ˆ](https://www.bilibili.com/video/BV1kNDaY4Eix):

- ITGZ USB4.0 ç¡¬ç›˜ç›’, ä¸»æ§ï¼š**ASM2464PD**;
- m.2 è½¬ PCIe å°æ¿;
- 12V DC è½¬ SATA ä¾›ç”µ;
- ç½‘å¡: Intel X520-DA1;

![20241229154732_KeqhmYPF.webp](https://cdn.dong4j.site/source/image/20241229154732_KeqhmYPF.webp)

[ITGZ USB4.0 ç§»åŠ¨é›·é›³ 4 ç¡¬ç›˜ç›’](https://item.jd.com/10113618108196.html):

![20241229154732_3eAjrAuK.webp](https://cdn.dong4j.site/source/image/20241229154732_3eAjrAuK.webp)

å¦ä¸€æ¬¾ä¸»æ§èŠ¯ç‰‡ä¸º [JHL7440](https://item.jd.com/10115097578948.html) çš„åŒç±»äº§å“, ä»·æ ¼è´µäº† 100+.

> é¡¾è™‘:
>
> - ä¸æ˜¯ M ç³»åˆ—èŠ¯ç‰‡ä¸”ä¸æ˜¯æœ€æ–°çš„ç³»ç»Ÿ;
> - ä¸æ˜¯åŒå…‰å£ç½‘å¡

---

#### é›·é›³æ‰©å±•å

è¿™ç±»æ–¹æ¡ˆå°±æ¯”è¾ƒå¤šäº†, ä¸»è¦æ˜¯é€šè¿‡ä¸€ä¸ªé›·é›³ 4/3 æ ¸å¿ƒæ¿å¤–æ¥å…¶ä»–å…ƒå™¨ä»¶ç„Šæ¥æˆä¸€ä¸ªå…·å¤‡ PCIe æ’æ§½çš„ç”µè·¯æ¿, æ–¹ä¾¿çš„åœ°æ–¹æ˜¯ä¸éœ€è¦ m.2 è½¬ PCIe å°æ¿.

##### é›·é›³æ ¸å¿ƒæ¿

åŠ¨æ‰‹èƒ½åŠ›å¼ºçš„è¿˜å¯ç›´æ¥è´­ä¹°é›·é›³æ ¸å¿ƒæ¿æ¥ç»„è£…, ä»·æ ¼ 200+:

![20241229154732_4771BvgX.webp](https://cdn.dong4j.site/source/image/20241229154732_4771BvgX.webp)

ä¸€äº›é›·é›³æ‹“å±•åå°±æ˜¯æ˜¯ç”¨ä¸Šé¢çš„æ ¸å¿ƒæ¿æ¥æä¾›é›·é›³åŠŸèƒ½, æ¯”å¦‚ [UGREEN ç»¿è”é›·ç”µ 3 å¤šåŠŸèƒ½ 10 æ¥å£æ‰©å±•å CM355](https://www.chongdiantou.com/archives/102735.html).

##### æ–¹æ¡ˆä¸€(500+)

[é›·é›³ 4 ä¸‡å…† 40G ç½‘å¡ DIY](https://www.bilibili.com/video/BV1tA411Z7op) :

- ä¸»æ§èŠ¯ç‰‡: **JHL7440**;
- ç½‘å¡: Intel X520-DA1;

![20241229154732_Yk8s2vBw.webp](https://cdn.dong4j.site/source/image/20241229154732_Yk8s2vBw.webp)

è¿™ä¸ªæ–¹æ¡ˆä¹Ÿæ˜¯ä½¿ç”¨äº†ä¸Šè¿°çš„é›·é›³æ ¸å¿ƒæ¿:

![20241229154732_Navykfrx.webp](https://cdn.dong4j.site/source/image/20241229154732_Navykfrx.webp)

> é¡¾è™‘:
>
> - ä¸æ˜¯ M ç³»åˆ—èŠ¯ç‰‡ä¸”ä¸æ˜¯æœ€æ–°çš„ç³»ç»Ÿ;
> - ä¸æ˜¯åŒå…‰å£ç½‘å¡

##### æ–¹æ¡ˆäºŒ(600+)

[æœ€å»‰ä»·çš„ Mac ç”µè„‘ M1 M2 èŠ¯ç‰‡ é›·é›³è½¬ä¸‡å…†ç½‘å¡æ–¹æ¡ˆæµ‹è¯•](https://www.bilibili.com/video/BV1Zk4y1E7dR):

- é›·é›³æ‹“å±•å(ä¸»æ§èŠ¯ç‰‡: **JHL7440**);
- ç½‘å¡: Intel X520-DA1;

![20241229154732_HG50zg8Q.webp](https://cdn.dong4j.site/source/image/20241229154732_HG50zg8Q.webp)

> é¡¾è™‘:
>
> - ä¸æ˜¯æœ€æ–°çš„ç³»ç»Ÿ;
> - ä¸æ˜¯åŒå…‰å£ç½‘å¡;

---

åœ¨äº†è§£äº† MBP ä¸‡å…†çš„å¯è¡Œæ–¹æ¡ˆå, æ¥ä¸‹å°±æ˜¯å…¶ä»–çš„å‡†å¤‡å·¥ä½œ.

## å‡†å¤‡å·¥ä½œ

<!--

https://blog.kmo.ink/2022/04/25/606/

-->

### ç”µå£ Or å…‰å£

ä¸‡å…†ç½‘ç»œæ¶‰åŠåˆ°ä¸€ä¸ªäº¤æ¢æœºç½‘å£é€‰æ‹©é—®é¢˜--**ä½¿ç”¨å…‰å£è¿˜æ˜¯ç”µå£**?

æˆ‘ç›®å‰çš„ç½‘ç»œæƒ…å†µæ˜¯ åƒå…†å’Œ 2.5G è®¾å¤‡å…¨éƒ¨ä½¿ç”¨çš„ç”µå£, **M920x** 2 ä¸ªä¸‡å…†å…‰å£åˆ™ä½¿ç”¨ 10G DAC çº¿è¿æ¥äº¤æ¢æœºçš„ 10G å…‰å£.

æˆ‘çš„éœ€æ±‚æ˜¯è‡³å°‘éœ€è¦ 7 ä¸ª 10G ç½‘å£, æ‰èƒ½å°†ä¸»è¦è®¾å¤‡é€šè¿‡äº¤æ¢æœºç»„æˆä¸‡å…†å±€åŸŸç½‘. é¦–å…ˆå°±æ’é™¤äº†å…¨ç”µå£æ–¹æ¡ˆ, ä¸€æ˜¯ **æˆæœ¬è€ƒè™‘**, äºŒæ˜¯ **å™ªéŸ³**.

8 å£å…¨ç”µå£äº¤æ¢æœºä¼˜ç‚¹æ˜¯å¯ä»¥å…¼å®¹æˆ‘ç°åœ¨æ‰€æœ‰çš„è®¾å¤‡è€Œä¸éœ€è¦æ¢çº¿. ç¼ºç‚¹å°±æ˜¯æ¯”å…¨å…‰å£çš„äº¤æ¢æœºè´µä¸Šä¸å°‘, å¦å¤–å› ä¸º **å‘çƒ­é‡å¤§**, å¿…é¡»å¾—åŠ æ•£çƒ­é£æ‰‡, é‚£ä¹ˆå™ªéŸ³åˆæ˜¯ä¸€ä¸ªéœ€è¦è€ƒè™‘çš„é—®é¢˜.

é€‰æ‹©å…¨å…‰å£çš„è¯, ç¼ºç‚¹å°±æ˜¯éœ€è¦é‡æ–°å¸ƒçº¿, ä»¥åŠä¸ºä»…æ”¯æŒç”µå£çš„è®¾å¤‡æ·»åŠ  **ä¸‡å…†å…‰è½¬ç”µæ¨¡å—**(100+).

#### ä¸‡å…†å…‰è½¬ç”µæ¨¡å—

å®ƒçš„ä½œç”¨æ˜¯å¯ä»¥å°†äº¤æ¢æœºä¸Šçš„å…‰å£è½¬æ¢ä¸ºç”µå£, ä»¥æ»¡è¶³äº¤æ¢æœºä¸Š RJ45 ç«¯å£ä¸è¶³çš„éœ€æ±‚. å¦‚å›¾æ‰€ç¤º, ä¸‡å…†ç”µå£æ¨¡å—ä¸€ç«¯æ˜¯ SFP+ç«¯å£, å¦ä¸€ç«¯ä¸º RJ45 æ¥å£

![20241229154732_pkGrR7Y0.webp](https://cdn.dong4j.site/source/image/20241229154732_pkGrR7Y0.webp)

##### ä¼˜åŠ¿

- æ›´çµæ´»çš„è¿æ¥æ–¹å¼ï¼šSFP+è½¬ RJ45 ç«¯å£æä¾›äº†ä¸€ç§çµæ´»çš„è§£å†³æ–¹æ¡ˆ, å°† SFP+ç«¯å£è½¬æ¢ä¸º RJ45, ä½¿å…¶æ›´é€‚åˆæ•°æ®ä¸­å¿ƒå’Œä¼ä¸šç½‘ç»œçš„éœ€è¦.
- æˆæœ¬æ•ˆç›Šï¼šé‡‡ç”¨æ™®é€š RJ45 è¿æ¥å™¨, æ”¯æŒå‘ä¸‹å…¼å®¹, ä½¿ç½‘ç»œå‡çº§æˆæœ¬æ›´ä½. ç›¸æ¯”é¢å¤–è´­ä¹° 10GBASE-T ç”µå£äº¤æ¢æœº, æ›´ç»æµé«˜æ•ˆ.
- ä¼ è¾“è·ç¦»ï¼šSFP+è½¬ RJ45 ç«¯å£æ¨¡å—å¯ä»¥åœ¨ 100 ç±³çš„è·ç¦»å†…æä¾› 10Gb/s çš„æ•°æ®ä¼ è¾“, è§£å†³äº† SFP+ DAC é«˜é€Ÿçº¿ç¼†åªèƒ½ä¼ è¾“æœ‰é™è·ç¦»çš„é—®é¢˜.
- èŠ‚çœèƒ½æºï¼šä¸åµŒå…¥å¼ 10GBASE-T RJ45 ç«¯å£ç›¸æ¯”, ä½¿ç”¨ SFP+è½¬ RJ45 ç«¯å£æ¨¡å—æ¯ä¸ªç«¯å£è‡³å°‘èŠ‚çœ 0.5W çš„åŠŸè€—, é™ä½äº†èƒ½æºæ¶ˆè€—.
- å¤šé€Ÿç‡æ”¯æŒï¼šæ”¯æŒå¤šç§ä¼ è¾“é€Ÿç‡ (10/100/1000Mbps åŠ 10Gbps) , ä½¿å…¶æ˜“äºæ“ä½œå’Œç®¡ç†.

##### ç¼ºç‚¹

- åŠŸè€—å’Œçƒ­é‡ï¼šè¿æ¥å¤šä¸ªç«¯å£æ—¶, ç›¸æ¯”å…‰çº¤å¸ƒçº¿, SFP+è½¬ RJ45 ç«¯å£è§£å†³æ–¹æ¡ˆçš„åŠŸè€—å’Œçƒ­é‡å¯èƒ½ä¼šè¾ƒé«˜.
- ç½‘ç»œå»¶è¿Ÿï¼šåœ¨è¿æ¥å¤šä¸ªèŠ‚ç‚¹æ—¶, å¯èƒ½ä¼šå¢åŠ ç½‘ç»œå»¶è¿Ÿ.

**ä¸‡å…†å…‰è½¬ç”µæ¨¡å—å…³é”®æ•°æ®**

| **è§„æ ¼**       | **æè¿°**                                             |
| -------------- | ---------------------------------------------------- |
| **ä¼ è¾“é€Ÿç‡**   | 10Gbps (å‘ä¸‹å…¼å®¹ 1Gbps å’Œ 100Mbps)                   |
| **å…‰çº¤ç«¯å£**   | SFP+ æ’æ§½, æ”¯æŒå¤šæ¨¡å’Œå•æ¨¡å…‰æ¨¡å— (å¦‚ 850nm, 1310nm)   |
| **ç”µå£**       | RJ45 æ¥å£, æ”¯æŒ Cat6a æˆ– Cat7 ç”µç¼†                   |
| **å…‰æ¨¡å—æ ‡å‡†** | 10GBASE-SR (æœ€å¤§ 300 ç±³) / 10GBASE-LR (æœ€å¤§ 10 å…¬é‡Œ) |
| **ä¾›ç”µæ–¹å¼**   | 5V æˆ– 12V å¤–æ¥ç”µæº, éƒ¨åˆ†æ”¯æŒ PoE                     |
| **åè®®æ”¯æŒ**   | IEEE 802.3 æ ‡å‡†, æ”¯æŒå…¨åŒå·¥å’ŒåŠåŒå·¥æ¨¡å¼              |
| **å·¥ä½œæ¸©åº¦**   | -20â„ƒ åˆ° 70â„ƒ                                          |
| **åŠŸè€—**       | 2W è‡³ 10W                                            |
| **ç‰©ç†å°ºå¯¸**   | æ¡Œé¢å‹æˆ–æ’å¡å¼ (æœºæ¶å®‰è£…)                            |

---

è€Œå…¶ä»–è®¾å¤‡åˆ™å…¨éƒ¨ä½¿ç”¨å…‰æ¨¡å—è¿æ¥. è¯´åˆ°è¿™é‡Œ, ä¹Ÿä¼šæœ‰ 3 ç§é€‰æ‹©--æ— ç¼˜é“œç¼†(**DAC**), æœ‰æºå…‰ç¼†(**AOC**)å’Œç‹¬ç«‹çš„å…‰çº¤+å…‰æ¨¡å—.

#### DAC çº¿ç¼†

Direct Attach Cable, ç®€ç§° DAC, ä¸€èˆ¬è¯‘ä¸ºç›´æ¥è¿æ¥ç”µç¼†æˆ–ç›´è¿é“œç¼†, æ˜¯æŒ‡ç›´æ¥è¿æ¥æœåŠ¡å™¨å’Œç½‘ç»œè®¾å¤‡çš„é«˜é€Ÿé“œç¼†, å®ƒé‡‡ç”¨å·®åˆ†ä¿¡å·ä¼ è¾“æŠ€æœ¯, èƒ½å¤Ÿæä¾›é«˜é€Ÿç‡ã€ä½æŸè€—çš„æ•°æ®ä¼ è¾“.

DAC é«˜é€Ÿçº¿ç¼†é€šå¸¸ç”¨äºçŸ­è·ç¦»çš„è®¾å¤‡äº’è”, å¦‚æœåŠ¡å™¨é›†ç¾¤ã€å­˜å‚¨åŒºåŸŸç½‘ç»œ (SAN) ç­‰.

Direct Attach Cable åˆ†ä¸¤ç§ï¼š

1. 10G SFP+DAC
2. 40G QSFP+ è½¬ 4 ä¸ª SFP+

è¿™ç§çº¿ç¼†éƒ½ä¸å¯æ›´æ¢ç«¯å£, æ¨¡å—å¤´å’Œé“œç¼†ä¸èƒ½åˆ†ç¦».

![20241229154732_MSl5eF3O.webp](https://cdn.dong4j.site/source/image/20241229154732_MSl5eF3O.webp)

#### AOC çº¿ç¼†

Active Optical Cable,ç®€ç§° AOC, è¯‘ä¸ºæœ‰æºå…‰ç¼†, æ˜¯ç”±é›†æˆå…‰ç”µå™¨ä»¶ç»„æˆçš„, ç”¨äºæ•°æ®ä¸­å¿ƒã€é«˜æ€§èƒ½è®¡ç®—æœºã€å¤§å®¹é‡å­˜å‚¨å™¨ç­‰è®¾å¤‡é—´è¿›è¡Œé«˜é€Ÿç‡ã€é«˜å¯é æ€§äº’è¿çš„ä¼ è¾“è®¾å¤‡, å®ƒé€šå¸¸æ»¡è¶³å·¥ä¸šæ ‡å‡†çš„ç‚¹æ¥å£, é€šè¿‡å†…éƒ¨çš„ç”µ-å…‰-ç”µè½¬æ¢, ä½¿ç”¨å…‰ç¼†çš„ä¼˜è¶Šæ€§è¿›è¡Œæ•°æ®çš„ä¼ è¾“.

è¿™ç§çº¿ç¼†åŒæ ·ä¸å¯æ›´æ¢ç«¯å£.

![20241229154732_cW6WdzyU.webp](https://cdn.dong4j.site/source/image/20241229154732_cW6WdzyU.webp)

**DAC ä¸ AOC çš„åŒºåˆ«**:

| **å±æ€§**         | **DAC (Direct Attach Copper)**                         | **AOC (Active Optical Cable)**               |
| ---------------- | ------------------------------------------------------ | -------------------------------------------- |
| **ä¼ è¾“ä»‹è´¨**     | é“œçº¿                                                   | å…‰çº¤                                         |
| **ç±»å‹**         | è¢«åŠ¨ DAC (æ— ä¿¡å·æ”¾å¤§å™¨) æˆ–ä¸»åŠ¨ DAC (å¸¦ä¿¡å·æ”¾å¤§å™¨)      | ä¸»åŠ¨å‹, å†…ç½®å…‰ç”µè½¬æ¢æ¨¡å—                     |
| **ä¼ è¾“è·ç¦»**     | é€šå¸¸æ”¯æŒ 1-7 ç±³, æœ€è¿œçº¦ 15 ç±³                          | é€šå¸¸æ”¯æŒ 10 ç±³åˆ° 100 ç±³, éƒ¨åˆ†å‹å·å¯è¾¾æ•°ç™¾ç±³  |
| **åŠŸè€—**         | è¾ƒä½ (ç‰¹åˆ«æ˜¯è¢«åŠ¨ DAC, å‡ ä¹ä¸è€—ç”µ)                      | è¾ƒé«˜ (éœ€è¦å…‰ç”µè½¬æ¢æ¨¡å—å·¥ä½œ)                  |
| **ä»·æ ¼**         | ç›¸å¯¹ä¾¿å®œ, é€‚åˆçŸ­è·ç¦»è¿æ¥                               | ç›¸å¯¹æ˜‚è´µ, é€‚åˆé•¿è·ç¦»è¿æ¥                     |
| **æŸ”éŸ§æ€§**       | è¾ƒå·®, é“œçº¿è¾ƒç¡¬, ä¸é€‚åˆç‹­å°ç©ºé—´æˆ–éœ€è¦å¤šæ¬¡å¼¯æŠ˜çš„ç¯å¢ƒ     | æ›´çµæ´», å…‰çº¤æè´¨å¯ä»¥å¼¯æ›², é€‚åˆå¤æ‚å¸ƒçº¿       |
| **ä¿¡å·å®Œæ•´æ€§**   | çŸ­è·ç¦»å†…ä¿¡å·å®Œæ•´æ€§è¾ƒå¥½, ä½†è·ç¦»å¢åŠ ä¼šå—é™äºé“œçº¿ç”µç£å¹²æ‰° | ä¼˜ç§€, å…‰çº¤æŠ—ç”µç£å¹²æ‰°èƒ½åŠ›å¼º, é€‚åˆé•¿è·ç¦»ä¼ è¾“   |
| **æ¥å£å…¼å®¹æ€§**   | æ”¯æŒ SFP/SFP+ã€QSFP/QSFP+ ç­‰æ ‡å‡†æ¥å£                   | åŒæ ·æ”¯æŒ SFP/SFP+ã€QSFP/QSFP+ ç­‰æ ‡å‡†æ¥å£     |
| **å…¸å‹åº”ç”¨åœºæ™¯** | æœåŠ¡å™¨æœºæŸœå†…çŸ­è·ç¦»è¿æ¥, äº¤æ¢æœºåˆ°æœåŠ¡å™¨                 | æœºæŸœé—´ã€æ¥¼å±‚é—´ã€æ•°æ®ä¸­å¿ƒä¹‹é—´çš„é•¿è·ç¦»é«˜é€Ÿè¿æ¥ |

#### å…‰çº¤+å…‰æ¨¡å—

| **å±æ€§**         | **å…‰çº¤ + å…‰æ¨¡å—**                                         | **æˆå“çº¿ç¼† (DAC/AOC)**                                 |
| ---------------- | --------------------------------------------------------- | ------------------------------------------------------ |
| **ç»“æ„**         | å…‰çº¤çº¿ç¼†ä¸å¯æ›´æ¢å…‰æ¨¡å—çš„ç»„åˆ                              | ä¸€ä½“åŒ–è®¾è®¡, çº¿ç¼†ä¸æ¨¡å—å›ºå®šä¸ºä¸€ä½“                       |
| **ä¼ è¾“è·ç¦»**     | æ”¯æŒè¾ƒé•¿è·ç¦»ä¼ è¾“ (å‡ ç™¾ç±³åˆ°æ•°å…¬é‡Œ, å–å†³äºå…‰æ¨¡å—å’Œå…‰çº¤ç±»å‹) | é€šå¸¸é€‚ç”¨äºçŸ­è·ç¦»è¿æ¥                                   |
| **çµæ´»æ€§**       | å…‰æ¨¡å—å’Œå…‰çº¤å¯æ ¹æ®éœ€æ±‚è‡ªç”±æ›´æ¢                            | å—é™äºå›ºå®šé•¿åº¦å’Œè§„æ ¼                                   |
| **ä»·æ ¼**         | å…‰æ¨¡å—å’Œå…‰çº¤åˆ†å¼€è´­ä¹°, æ•´ä½“æˆæœ¬è¾ƒé«˜                        | ç›¸å¯¹ä¾¿å®œ, å°¤å…¶æ˜¯åœ¨çŸ­è·ç¦»åº”ç”¨ä¸­                         |
| **åŠŸè€—**         | å…‰æ¨¡å—éœ€è¦ä¾›ç”µ, åŠŸè€—ç›¸å¯¹è¾ƒé«˜                              | DAC æ— éœ€ä¾›ç”µ, åŠŸè€—æœ€ä½ï¼›AOC æœ‰æºè®¾è®¡, åŠŸè€—è¾ƒå…‰æ¨¡å—ç•¥ä½ |
| **ç»´æŠ¤ä¸æ‰©å±•**   | æ›´æ¢å•ä¸ªå…‰æ¨¡å—æˆ–å…‰çº¤å³å¯çµæ´»å‡çº§æˆ–ç»´ä¿®                    | æ•´æ ¹çº¿ç¼†æŸåéœ€æ•´ä½“æ›´æ¢                                 |
| **æ¥å£ç±»å‹æ”¯æŒ** | æ”¯æŒå¤šç§æ¥å£æ ‡å‡†, å¦‚ SFPã€QSFP ç­‰                         | é€šå¸¸ä¸ç½‘å¡æˆ–è®¾å¤‡å›ºå®šæ¥å£åŒ¹é…                           |
| **é€‚ç”¨åœºæ™¯**     | æ•°æ®ä¸­å¿ƒæ ¸å¿ƒç½‘ç»œã€é•¿è·ç¦»äº’è”                              | æ•°æ®ä¸­å¿ƒæœºæ¶å†…æˆ–æœºæ¶é—´çŸ­è·ç¦»è¿æ¥                       |

äºŒæ‰‹çš„ DAC å’Œ AOC çº¿ç¼†å¤§æ¦‚ 10+ ä¸€æ ¹, ä¸è¿‡ä¸Šæ¬¡ç»™ M920x é€‰è´­ AOC çº¿ç¼†æ—¶å‡ºç°äº†ä¸å…¼å®¹çš„é—®é¢˜, åæ¥å°±æ¢æˆäº† DAC çº¿ç¼†, è¿™æ¬¡å‡†å¤‡ä½¿ç”¨å…‰çº¤+å…‰æ¨¡å—çš„æ–¹æ¡ˆ, å¯ä»¥æ›´æ¢å…‰æ¨¡å—çš„æ–¹å¼åº”è¯¥æ›´çµæ´»ä¸€äº›, äºŒæ‰‹çš„ä»·æ ¼ä¹Ÿè´µä¸äº†å¤šå°‘.

æ¥ä¸‹æ¥å°±æ˜¯ä»‹ç»ä¸€ä¸‹å…‰çº¤å’Œå…‰æ¨¡å—äº†, å› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦å…‰çº¤, æ‰€ä»¥éœ€è¦å…ˆå­¦ä¹ äº†è§£ä¸€ä¸‹åŸºç¡€çŸ¥è¯†.

---

### å…‰çº¤æŠ€æœ¯

åœ¨ç°ä»£ç½‘ç»œé€šä¿¡ä¸­, å…‰çº¤ä¼ è¾“æŠ€æœ¯æ˜¯é«˜é€Ÿå’Œè¿œè·ç¦»æ•°æ®ä¼ è¾“çš„å…³é”®. å®ƒé€šè¿‡å…‰ä¿¡å·åœ¨å…‰çº¤ä¸­ä¼ è¾“æ•°æ®, ä»¥å®ç°æ›´é«˜çš„å¸¦å®½ã€æ›´ä½çš„å»¶è¿Ÿå’Œæ›´è¿œçš„ä¼ è¾“è·ç¦». ä¸ä¼ ç»Ÿçš„é“œç¼†ç›¸æ¯”, å…‰çº¤åœ¨æ•°æ®ä¸­å¿ƒã€ä¼ä¸šç½‘ç»œå’Œå¹¿åŸŸç½‘ä¸­å·²æˆä¸ºä¸»æµé€‰æ‹©.

å› ä¸ºç›®å‰æ­å»ºä¸‡å…†å…‰çº¤ç½‘ç»œç¦»ä¸å¼€å¯¹ **å…‰çº¤ç±»å‹**, **å…‰çº¤æ¥å£ç±»å‹** å’Œ **å…‰æ¨¡å—ç±»å‹** çš„åŸºæœ¬äº†è§£, æ‰€ä»¥å°±ä»è¿™ä¸‰ä¸ªæ–¹é¢ä»‹ç»ä¸€ä¸‹åŸºç¡€çŸ¥è¯†.

<!--

https://community.fs.com/cn/article/single-mode-cabling-cost-vs-multimode-cabling-cost.html

-->

#### å…‰çº¤ç±»å‹

å…‰çº¤æ˜¯ç”±ç»ç’ƒæˆ–å¡‘æ–™åˆ¶æˆçš„ä¸€ç§ä¼ è¾“ä»‹è´¨, èƒ½å¤Ÿé€šè¿‡å…‰ä¿¡å·ä¼ é€’æ•°æ®. æ ¹æ®ç”¨é€”å’Œä¼ è¾“è·ç¦», å…‰çº¤åˆ†ä¸ºä¸¤ç§ä¸»è¦ç±»å‹ï¼š

- å•æ¨¡å…‰çº¤ (Single-mode Fiber) : åªå…è®¸å•ä¸€æ¨¡å¼çš„å…‰é€šè¿‡, é€‚ç”¨äºé•¿è·ç¦»é€šä¿¡ (å¯è¾¾å‡ åå…¬é‡Œç”šè‡³ä¸Šç™¾å…¬é‡Œ) , é€‚ç”¨äºè·¨æ¥¼å±‚æˆ–è·¨å»ºç­‘ç‰©çš„é€šä¿¡.
- å¤šæ¨¡å…‰çº¤ (Multimode Fiber) : å…è®¸å¤šç§æ¨¡å¼çš„å…‰é€šè¿‡, é€‚åˆçŸ­è·ç¦»ä¼ è¾“ (é€šå¸¸åœ¨ 300 ç±³ä»¥å†…) , æˆæœ¬è¾ƒä½, å¤šç”¨äºæœºæˆ¿æˆ–å±€åŸŸç½‘å†…è®¾å¤‡çš„è¿æ¥.

##### é¢œè‰²åŒºåˆ†

é€šè¿‡å…‰çº¤çš„å¤–æŠ¤å¥—é¢œè‰²å¯å¿«é€ŸåŒºåˆ†å•æ¨¡å…‰çº¤å’Œå¤šæ¨¡å…‰çº¤. æ ¹æ® [TIA-598C æ ‡å‡†](https://en.wikipedia.org/wiki/TIA-598-C) å®šä¹‰, **OS1/OS2** å•æ¨¡å…‰çº¤çš„å¤–æŠ¤å¥—é¢œè‰²ä¸ºé»„è‰², è€Œå¤šæ¨¡å…‰çº¤çš„å¤–æŠ¤å¥—é¢œè‰²ä¸ºæ©™è‰²æˆ–æ°´ç»¿è‰², å…¶ä¸­ **OM1/OM2** å¤šæ¨¡å…‰çº¤é‡‡ç”¨æ©™è‰²å¤–æŠ¤å¥—, **OM3/OM4** å¤šæ¨¡å…‰çº¤é‡‡ç”¨æ°´ç»¿è‰²å¤–æŠ¤å¥—, **OM5** å¤šæ¨¡å…‰çº¤åˆ™é‡‡ç”¨ç»¿è‰²å¤–æŠ¤å¥—.

![20241229154732_mHKYfwQe.webp](https://cdn.dong4j.site/source/image/20241229154732_mHKYfwQe.webp)

##### ä¼ è¾“è·ç¦»

å•æ¨¡å…‰çº¤å¸¸ç”¨äºé•¿è·ç¦»ä¼ è¾“, å¤šæ¨¡å…‰çº¤ä¸€èˆ¬ç”¨äºçŸ­è·ç¦»ä¼ è¾“. è€Œä¸åŒç±»å‹çš„å•æ¨¡å’Œå¤šæ¨¡å…‰çº¤åº”ç”¨åœ¨ä¸åŒé€Ÿç‡ä»¥å¤ªç½‘ä¸­ä¼ è¾“è·ç¦»å„ä¸ç›¸åŒ, å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š

| å…‰çº¤ç±»å‹                  | 1000Base/1Gb (SX) ä»¥å¤ªç½‘ | 1000Base/1Gb (LX) ä»¥å¤ªç½‘ | 10Gb ä»¥å¤ªç½‘ | 40Gb ä»¥å¤ªç½‘ | 100Gb ä»¥å¤ªç½‘ |
| ------------------------- | ------------------------ | ------------------------ | ----------- | ----------- | ------------ |
| OS1/OS2 å•æ¨¡å…‰çº¤ (1310nm) | 5Km                      | 20Km                     | 40Km        | 40Km        | 80Km         |
| OM1 å¤šæ¨¡å…‰çº¤ (850nm)      | 275m                     | 550m                     | 33m         | /           | /            |
| OM2 å¤šæ¨¡å…‰çº¤ (850nm)      | 550m                     | 550m                     | 82m         | /           | /            |
| OM3 å¤šæ¨¡å…‰çº¤ (850nm)      | 550m                     | 550m                     | 300m        | 100m        | 100m         |
| OM4 å¤šæ¨¡å…‰çº¤ (850nm)      | 550m                     | 550m                     | 550m        | 150m        | 150m         |
| OM5 å¤šæ¨¡å…‰çº¤ (850nm)      | /                        | /                        | 550m        | 440m        | 150m         |

---

- [é€šä¿¡ç”¨å¤šæ¨¡å…‰çº¤ä¸»è¦æœ‰å“ªäº›ç±»å‹ï¼ŸOM1 ï½ OM5 æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ](https://www.china-cic.cn/Detail/15/208/4526)

![20241229154732_3G5tddUR.webp](https://cdn.dong4j.site/source/image/20241229154732_3G5tddUR.webp)

**å‚è€ƒ**:

- [â€œå•æ¨¡å…‰çº¤â€ä¸â€œå¤šæ¨¡å…‰çº¤â€æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿå“ªä¸ªå¥½ï¼Ÿæ€ä¹ˆç”¨ï¼Ÿ](https://post.smzdm.com/p/a0qvx75z/)

---

##### çº¤èŠ¯çš„ç›´å¾„å·®å¼‚

å•æ¨¡å…‰çº¤ (SMF) çš„çº¤èŠ¯ç›´å¾„ä¸€èˆ¬ä¸º **9Î¼m**, ç”±äºçº¤èŠ¯çª„, å®ƒåªèƒ½åœ¨ 1310nmã€1550nm ä»¥åŠ WDM æ³¢é•¿ä¸Šä¼ è¾“ä¸€ç§æ¨¡å¼çš„å…‰, ä¹Ÿæ­£å› å¦‚æ­¤, å•æ¨¡å…‰çº¤è‰²æ•£è¾ƒå°, å¸¦å®½é«˜, è€Œå¤šæ¨¡å…‰çº¤ (MMF) çš„çº¤èŠ¯ç›´å¾„ä¸€èˆ¬ä¸º 50/62.5Î¼m, çº¤èŠ¯å®½, å®ƒèƒ½åœ¨ç»™å®šçš„å·¥ä½œæ³¢é•¿ (850nm æˆ– 1310nm æ³¢é•¿) ä¸Šä¼ è¾“å¤šç§æ¨¡å¼çš„å…‰, ä½†å› ä¸ºå¤šæ¨¡å…‰çº¤ä¸­ä¼ è¾“çš„æ¨¡å¼å¤šè¾¾æ•°ç™¾ä¸ª, å„ä¸ªæ¨¡å¼çš„ä¼ è¾“å¸¸æ•°å’Œç¾¤é€Ÿç‡ä¸åŒ, å¯¼è‡´å¤šæ¨¡å…‰çº¤çš„å¸¦å®½çª„ã€è‰²æ•£å¤§, æŸè€—ä¹Ÿå¤§.

![20241229154732_RaV3SBot.webp](https://cdn.dong4j.site/source/image/20241229154732_RaV3SBot.webp)

##### å…‰æºå·®å¼‚

å•æ¨¡å…‰çº¤å’Œå¤šæ¨¡å…‰çº¤é‡‡ç”¨çš„å…‰æºä¸åŒ, å•æ¨¡å…‰çº¤ä¸€èˆ¬é‡‡ç”¨ **æ¿€å…‰å…‰æº**, è€Œå¤šæ¨¡å…‰çº¤ä¸€èˆ¬é‡‡ç”¨ **LED å…‰æº**.

![20241229154732_vMmVt1Mz.webp](https://cdn.dong4j.site/source/image/20241229154732_vMmVt1Mz.webp)

---

##### å•æ¨¡å•èŠ¯/å•æ¨¡åŒèŠ¯/å¤šæ¨¡åŒèŠ¯

åœ¨å…‰çº¤é€šä¿¡ä¸­, **å•æ¨¡å•èŠ¯**ã€**å•æ¨¡åŒèŠ¯** å’Œ **å¤šæ¨¡åŒèŠ¯** æ˜¯å¸¸è§çš„å…‰çº¤ç±»å‹. å®ƒä»¬çš„åŒºåˆ«ä¸»è¦ä½“ç°åœ¨å…‰çº¤æ¨¡å¼ã€èŠ¯æ•°ã€ä¼ è¾“æ€§èƒ½ä»¥åŠé€‚ç”¨åœºæ™¯ä¸Š.

![20241229154732_N53zmwR4.webp](https://cdn.dong4j.site/source/image/20241229154732_N53zmwR4.webp)

ä»¥ä¸‹æ˜¯è¯¦ç»†å¯¹æ¯”:

**1. å®šä¹‰ä¸ç‰¹æ€§**

| **ç±»å‹**     | **å®šä¹‰**                                            | **ç‰¹ç‚¹**                                                    |
| ------------ | --------------------------------------------------- | ----------------------------------------------------------- |
| **å•æ¨¡å•èŠ¯** | å•æ ¹å•æ¨¡å…‰çº¤, å…‰ä»¥å•ä¸€æ¨¡å¼ä¼ æ’­, é€‚ç”¨äºé•¿è·ç¦»é€šä¿¡.   | æ”¯æŒè¿œè·ç¦»å’Œé«˜å¸¦å®½ä¼ è¾“, å¸¸ä¸æ³¢åˆ†å¤ç”¨ (WDM) æŠ€æœ¯ç»“åˆä½¿ç”¨.    |
| **å•æ¨¡åŒèŠ¯** | ä¸¤æ ¹å•æ¨¡å…‰çº¤, åˆ†åˆ«ç”¨äºå‘é€ (TX) å’Œæ¥æ”¶ (RX) .       | é€‚åˆä¸­çŸ­è·ç¦»é€šä¿¡, å¹¿æ³›ç”¨äºæ•°æ®ä¸­å¿ƒå’Œä¼ä¸šç½‘ç»œçš„è®¾å¤‡äº’è”.     |
| **å¤šæ¨¡åŒèŠ¯** | ä¸¤æ ¹å¤šæ¨¡å…‰çº¤, å…‰ä»¥å¤šç§æ¨¡å¼ä¼ æ’­, åˆ†åˆ«ç”¨äºå‘é€å’Œæ¥æ”¶. | é€‚åˆçŸ­è·ç¦»é«˜å¸¦å®½ä¼ è¾“, ä¸»è¦ç”¨äºæ•°æ®ä¸­å¿ƒå†…éƒ¨è®¾å¤‡é—´çš„é«˜é€Ÿäº’è”. |

**2. å…‰çº¤æ¨¡å¼ä¸ä¼ è¾“æ€§èƒ½**

| **ç‰¹æ€§**       | **å•æ¨¡å•èŠ¯**              | **å•æ¨¡åŒèŠ¯**            | **å¤šæ¨¡åŒèŠ¯**                          |
| -------------- | ------------------------- | ----------------------- | ------------------------------------- |
| **å…‰çº¤æ¨¡å¼**   | å•æ¨¡                      | å•æ¨¡                    | å¤šæ¨¡                                  |
| **ä¼ è¾“è·ç¦»**   | æœ€é•¿ (å‡ åå…¬é‡Œåˆ°ä¸Šç™¾å…¬é‡Œ) | è¾ƒé•¿ (å‡ å…¬é‡Œåˆ°å‡ åå…¬é‡Œ) | æœ€çŸ­ (ä¸€èˆ¬åœ¨ 300 ç±³ä»¥å†…)              |
| **ä¼ è¾“å¸¦å®½**   | é«˜ (æ”¯æŒ 10Gbps~400Gbps)  | é«˜                      | è¾ƒä½ (æ”¯æŒ 10Gbps æˆ–æ›´é«˜, ä½†è·ç¦»å—é™) |
| **æŠ—å¹²æ‰°èƒ½åŠ›** | æå¼º                      | æå¼º                    | è¾ƒå¼± (å¤šæ¨¡å…‰çº¤æ¨¡å¼å¹²æ‰°è¾ƒå¤š)           |

**3. ä½¿ç”¨åœºæ™¯**

| **ç±»å‹**     | **å…¸å‹åº”ç”¨åœºæ™¯**                                                                |
| ------------ | ------------------------------------------------------------------------------- |
| **å•æ¨¡å•èŠ¯** | é•¿è·ç¦»é€šä¿¡, å¦‚éª¨å¹²ç½‘ã€è·¨æœºæˆ¿è¿æ¥ã€ç”µä¿¡çº§åº”ç”¨.                                   |
| **å•æ¨¡åŒèŠ¯** | æ•°æ®ä¸­å¿ƒã€ä¼ä¸šå›­åŒºç½‘ç»œä¸­çŸ­è·ç¦»äº’è”, å¦‚äº¤æ¢æœºåˆ°æœåŠ¡å™¨çš„è¿æ¥.                     |
| **å¤šæ¨¡åŒèŠ¯** | æ•°æ®ä¸­å¿ƒå†…éƒ¨çŸ­è·ç¦»é«˜é€Ÿäº’è”, å¦‚ 10Gbps åˆ° 100Gbps çš„è®¾å¤‡äº’è”, é€šå¸¸ä¸º 300 ç±³ä»¥å†…. |

**4. è¿æ¥æ–¹å¼ä¸æˆæœ¬å¯¹æ¯”**

| **å±æ€§**         | **å•æ¨¡å•èŠ¯**           | **å•æ¨¡åŒèŠ¯**      | **å¤šæ¨¡åŒèŠ¯**                |
| ---------------- | ---------------------- | ----------------- | --------------------------- |
| **å…‰çº¤èŠ¯æ•°**     | å•æ ¹å…‰çº¤               | åŒæ ¹å…‰çº¤          | åŒæ ¹å…‰çº¤                    |
| **å¸ƒçº¿å¤æ‚åº¦**   | æœ€ä½                   | è¾ƒé«˜ (éœ€ä¸¤æ ¹å…‰çº¤) | è¾ƒé«˜                        |
| **è®¾å¤‡æˆæœ¬**     | è¾ƒé«˜ (éœ€ WDM æŠ€æœ¯æ”¯æŒ) | è¾ƒä½              | æœ€ä½                        |
| **å…‰çº¤æˆæœ¬**     | æœ€ä½ (åªéœ€ä¸€æ ¹å…‰çº¤)    | è¾ƒé«˜ (åŒæ ¹å…‰çº¤)   | è¾ƒä½ (å¤šæ¨¡å…‰çº¤é€šå¸¸æˆæœ¬æ›´ä½) |
| **å¸¸ç”¨æ¥å£ç±»å‹** | LCã€SC                 | LCã€SC            | LCã€SC                      |

**5. é€‚é…å…‰æ¨¡å—**

| **ç±»å‹**     | **æ¨èå…‰æ¨¡å—ç±»å‹**                                              |
| ------------ | --------------------------------------------------------------- |
| **å•æ¨¡å•èŠ¯** | å•çº¤åŒå‘å…‰æ¨¡å— (BiDi æ¨¡å—) , æ”¯æŒ WDM æŠ€æœ¯.                     |
| **å•æ¨¡åŒèŠ¯** | åŒçº¤å…‰æ¨¡å— (å¦‚ SFPã€SFP+ æ¨¡å—) .                                |
| **å¤šæ¨¡åŒèŠ¯** | å¤šæ¨¡å…‰æ¨¡å— (å¦‚ OM3/OM4 æ”¯æŒçš„ SFP æ¨¡å—) , å¸¸ç”¨äºçŸ­è·ç¦»é«˜é€Ÿé€šä¿¡. |

**æ€»ç»“**

| **ç‰¹æ€§**     | **å•æ¨¡å•èŠ¯**                | **å•æ¨¡åŒèŠ¯**                | **å¤šæ¨¡åŒèŠ¯**               |
| ------------ | --------------------------- | --------------------------- | -------------------------- |
| **ä¼ è¾“è·ç¦»** | é•¿è·ç¦» (å‡ åå…¬é‡Œåˆ°ä¸Šç™¾å…¬é‡Œ) | ä¸­çŸ­è·ç¦» (å‡ å…¬é‡Œåˆ°å‡ åå…¬é‡Œ) | çŸ­è·ç¦» (ä¸€èˆ¬åœ¨ 300 ç±³ä»¥å†…) |
| **åº”ç”¨åœºæ™¯** | é•¿è·ç¦»éª¨å¹²ç½‘ã€è·¨åŒºåŸŸé€šä¿¡    | æ•°æ®ä¸­å¿ƒã€ä¼ä¸šå›­åŒºç½‘ç»œ      | æ•°æ®ä¸­å¿ƒå†…éƒ¨è®¾å¤‡äº’è”       |
| **æˆæœ¬**     | å…‰æ¨¡å—å’Œè®¾å¤‡æˆæœ¬é«˜          | æˆæœ¬é€‚ä¸­                    | å…‰çº¤å’Œæ¨¡å—æˆæœ¬æœ€ä½         |

- **å•æ¨¡å•èŠ¯**: é€‚åˆé•¿è·ç¦»ã€é«˜å¸¦å®½ä¼ è¾“, è®¾å¤‡æˆæœ¬é«˜, é€‚åˆç”µä¿¡çº§åº”ç”¨.
- **å•æ¨¡åŒèŠ¯**: ä¸­çŸ­è·ç¦»çš„å…¨åŒå·¥é€šä¿¡ä¼˜é€‰æ–¹æ¡ˆ, å…¼é¡¾æ€§èƒ½å’Œæˆæœ¬.
- **å¤šæ¨¡åŒèŠ¯**: ç»æµé«˜æ•ˆçš„çŸ­è·ç¦»æ–¹æ¡ˆ, é€‚åˆæ•°æ®ä¸­å¿ƒå†…è®¾å¤‡é—´çš„é«˜é€Ÿè¿æ¥.

---

#### å…‰çº¤æ¥å£ç±»å‹

**1. FC å‹å…‰çº¤æ¥å£**

å…¨åä¸º Ferrule Connector, æ˜¯ä¸€ç§å¸¸è§çš„å…‰çº¤æ¥å£ç±»å‹. å®ƒçš„å¤–éƒ¨åŠ å¼ºæ–¹å¼æ˜¯é‡‡ç”¨é‡‘å±å¥—, ç´§å›ºæ–¹å¼ä¸ºèºä¸æ‰£. FC æ¥å£åœ¨ç”µä¿¡ç½‘ç»œä¸­è¢«å¹¿æ³›é‡‡ç”¨, å…·æœ‰ç‰¢é ã€é˜²ç°å°˜çš„ä¼˜ç‚¹. ä¸è¿‡, å®‰è£…æ—¶é—´ç›¸å¯¹è¾ƒé•¿, é€šå¸¸åœ¨ ODF (å…‰çº¤é…çº¿æ¶) ä¾§ä½¿ç”¨è¾ƒå¤š.

**2. SC å‹å…‰çº¤æ¥å£**

å³ Square Connector, æ˜¯ä¸€ç§å¡æ¥å¼æ¥å£. å®ƒçš„å¤–å£³å‘ˆçŸ©å½¢, ç´§å›ºæ–¹å¼æ˜¯é‡‡ç”¨æ’æ‹”é”€é—©å¼, ä¸éœ€è¦æ—‹è½¬. SC æ¥å£çš„ä½¿ç”¨éå¸¸æ–¹ä¾¿, ä½†å®¹æ˜“æ‰å‡ºæ¥, å› æ­¤åœ¨è·¯ç”±å™¨å’Œäº¤æ¢æœºä¸Šä½¿ç”¨è¾ƒå¤š.

**3. ST å‹å…‰çº¤æ¥å£**

å…¨ç§°ä¸º Straight Tip, æ˜¯ä¸€ç§åœ†å½¢çš„æ¥å£. å®ƒçš„ç´§å›ºæ–¹å¼ä¸ºèºä¸æ‰£, æ’å…¥åéœ€è¦æ—‹è½¬åŠå‘¨ä»¥å›ºå®š. ST æ¥å£çš„ç¼ºç‚¹æ˜¯å®¹æ˜“æŠ˜æ–­, ä½†åœ¨å…‰çº¤é…çº¿æ¶ä¸­ä½¿ç”¨è¾ƒå¤š, å°¤å…¶æ˜¯å¯¹äº 10Base-F è¿æ¥æ¥è¯´.

**4. LC å‹å…‰çº¤æ¥å£**

å³ Lucent Connector, æ˜¯ä¸€ç§å°å‹åŒ–çš„å…‰çº¤æ¥å£. å®ƒçš„å¤–å£³å‘ˆçŸ©å½¢, ç´§å›ºæ–¹å¼ä¸ºæ’æ‹”é”€é—©å¼. LC æ¥å£é€‚ç”¨äº SFP æ¨¡å—, é‡‡ç”¨æ¨¡å—åŒ–æ’å­” (RJ) é—©é”æœºç†åˆ¶æˆ, ä¾¿äºæ“ä½œå’Œç»´æŠ¤.

![20241229154732_aHeUAwZY.webp](https://cdn.dong4j.site/source/image/20241229154732_aHeUAwZY.webp)

> è¿è¥å•†è¿›æˆ·å…‰çº¤éƒ½æ˜¯å•èŠ¯å•æ¨¡çš®çº¿å…‰çº¤, åˆ°å…‰çŒ«è¿™é‡Œéƒ½å¿…é¡»æ˜¯å•æ¨¡å…‰çº¤æ‰èƒ½æ­£å¸¸ä½¿ç”¨, æ²¡æœ‰å…¶ä»–é€‰æ‹©, å•æ¨¡å…‰çº¤é€šå¸¸éƒ½æ˜¯ SC æ¥å£. åˆ°å…‰çŒ«è¿™æ®µè·ç¦»é€šå¸¸ä¹Ÿæ˜¯è¿è¥å•†è´Ÿè´£ç»´æŠ¤. å±äºæ¥å…¥ç½‘ PON (Passive Optical Network, æ— æºå…‰ç½‘ç»œ) . æ˜¯ç›®å‰æœ‰çº¿æ¥å…¥ç½‘çš„ä¸»æµæŠ€æœ¯, FTTH (Fiber to the Home, å…‰çº¤åˆ°æˆ·) è®©å¤§å®¶äº«å—åˆ°äº†è¶…é«˜ç½‘é€Ÿå¸¦æ¥çš„ä¾¿åˆ©æ€§.

---

#### å…‰æ¨¡å—ç±»å‹

##### å°è£…ç±»å‹åˆ†ç±»

å…‰æ¨¡å—æŒ‰ç…§å°è£…å½¢å¼æ¥åˆ†æœ‰ä»¥ä¸‹å‡ ç§å¸¸è§ç±»å‹:

- **SFP**: GBIC çš„å‡çº§ç‰ˆ, æœ€é«˜é€Ÿç‡å¯è¾¾ 4.25Gbps, ä¸»è¦ç”±æ¿€å…‰å™¨æ„æˆ, ç‰¹ç‚¹æ˜¯å°å‹ã€å¯çƒ­æ’æ‹”.
- **SFP+**: SFP çš„åŠ å¼ºç‰ˆ, ä¼ è¾“é€Ÿç‡ä¸º 10Gbps, å¯ä»¥æ»¡è¶³ 8.5G å…‰çº¤é€šé“å’Œ 10G ä»¥å¤ªç½‘çš„åº”ç”¨.
- **SFP28**: ä¼ è¾“é€Ÿç‡ä¸º 25Gbps, å®ƒçš„ä¼˜ç‚¹æ˜¯åŠŸè€—è¾ƒä½ã€ç«¯å£å¯†åº¦è¾ƒé«˜, ä¸”æ”¯æŒçƒ­æ’æ‹”.
- **QSFP+**: ä¼ è¾“é€Ÿç‡ä¸º 40Gbps, æ”¯æŒ MPO å…‰çº¤è¿æ¥å™¨å’Œ LC å…‰çº¤è¿æ¥å™¨, ç‰¹ç‚¹æ˜¯å°å‹ã€å¯çƒ­æ’æ‹”.
- **QSFP28**: é‡‡ç”¨ 4 ä¸ª 25Gbit/s é€šé“å¹¶è¡Œä¼ è¾“, ä¼ è¾“é€Ÿç‡ä¸º 100Gbps, æ»¡è¶³ 100G ä»¥å¤ªç½‘çš„åº”ç”¨.

![20241229154732_g7eB1kRM.webp](https://cdn.dong4j.site/source/image/20241229154732_g7eB1kRM.webp)

æ›´é«˜è§„æ ¼çš„æ¨¡å—æœ‰:

**QSFP-DD**: é‡‡ç”¨ 8 é€šé“ç”µæ¥å£, å•é€šé“é€Ÿç‡ 25Gbps/50Gbps/100Gbps, æä¾›é«˜è¾¾ 200Gb/s åˆ° 800Gb/s æ€»æœ€å¤§æ•°æ®é€Ÿç‡.

**OSFP**: æ˜¯ä¸€ç§æ–°å‹å…‰æ¨¡å—, æ¯” QSFP-DD ç•¥å¤§, åŒæ ·å…·æœ‰ 8 ä¸ªé«˜é€Ÿç”µé€šé“, æ”¯æŒé«˜è¾¾ 800G çš„æ€»ååé‡.

![20241229154732_doKCLVnA.webp](https://cdn.dong4j.site/source/image/20241229154732_doKCLVnA.webp)

##### å…‰çº¤ç±»å‹åˆ†ç±»

å…‰æ¨¡å—æ ¹æ®é€‚ç”¨çš„å…‰çº¤ç±»å‹çš„ä¸åŒå¯è¢«åˆ†ä¸º **å•æ¨¡å…‰æ¨¡å—** å’Œ **å¤šæ¨¡å…‰æ¨¡å—**, å…¶ä¸­å•æ¨¡å’Œå¤šæ¨¡æŒ‡çš„æ˜¯å…‰çº¤åœ¨å…‰æ¨¡å—ä¸­çš„ä¼ è¾“æ–¹å¼. å•æ¨¡å…‰æ¨¡å—å¤šç”¨åœ¨è¿œè·ç¦»ä¼ è¾“ä¸­, è€Œå¤šæ¨¡å…‰æ¨¡å—å¤šç”¨åœ¨çŸ­è·ç¦»ä¼ è¾“ä¸­.

å¤šæ¨¡å…‰æ¨¡å—çš„å·¥ä½œæ³¢é•¿ä¸º **850nm**ï¼›å•æ¨¡å…‰æ¨¡å—çš„å·¥ä½œæ³¢é•¿ä¸º **1310nm**ã€**1550nm**ï¼›å•æ¨¡å…‰æ¨¡å—ä¸­ä½¿ç”¨çš„å™¨ä»¶æ˜¯å¤šæ¨¡å…‰æ¨¡å—çš„ä¸¤å€, æ‰€ä»¥å•æ¨¡å…‰æ¨¡å—çš„æ€»ä½“æˆæœ¬è¦è¿œè¿œé«˜äºå¤šæ¨¡å…‰æ¨¡å—ï¼›å•æ¨¡å…‰æ¨¡å—çš„ä¼ è¾“è·ç¦»å¯è¾¾ 150 è‡³ 200kmï¼›å¤šæ¨¡å…‰æ¨¡å—çš„ä¼ è¾“è·ç¦»å¯è¾¾ 5km.

##### å…‰æ¨¡å—çš„å‘½å

<!--

https://community.fs.com/hk/blog/sfp-10g-sr-vs-sfp-10g-lrm-vs-sfp-10g-lr-which-to-choose.html

https://www.sopto.com.cn/cn/sp_news/show-415.html

-->

æ¯”å¦‚ **SPF-10G-XX**: SFP æ˜¯ **Small Form Pluggable** çš„ç¼©å†™, æ„ä¸ºå¯çƒ­æ’æ‹”çš„å°å‹æ¨¡å—, å¯ä»¥ç®€å•ç†è§£ä¸º GBIC(Gigabit Interface Converter çš„ç¼©å†™) å‡çº§ç‰ˆæœ¬. 10G ä»£è¡¨å…¶æœ€å¤§ä¼ è¾“é€Ÿç‡ä¸º 10.3 Gbps, é€‚ç”¨äº 10G ä»¥å¤ªç½‘. XX ä»£è¡¨ SR, LR, LRM ç­‰, è¡¨ç¤ºå…‰æ¨¡å—çš„ä¼ è¾“è·ç¦».

![20241229154732_SSBxbLhS.webp](https://cdn.dong4j.site/source/image/20241229154732_SSBxbLhS.webp)

> SR, LR, LRM, ER å’Œ ZR æ˜¯ [10GIEEE æ ‡å‡†](https://zh.wikipedia.org/wiki/10%E5%90%89%E6%AF%94%E7%89%B9%E4%B9%99%E5%A4%AA%E7%B6%B2%E8%B7%AF) ä¸­æ¯”è¾ƒå¸¸è§çš„æ¨¡å—ç±»å‹,. åœ¨å…‰çº¤é€šä¿¡ä¸­, SR, LR, LRM, ER å’Œ ZR æ˜¯ 10G å…‰æ¨¡å—ä¼ è¾“ä¸­çš„ä¸€ç§è·ç¦»æœ¯è¯­. SR è¡¨ç¤ºçŸ­è·ç¦»,LR è¡¨ç¤ºé•¿è·ç¦», LRM è¡¨ç¤ºé•¿åº¦å»¶ä¼¸å¤šç‚¹æ¨¡å¼, ER è¡¨ç¤ºè¶…é•¿è·ç¦», ZR åˆ™è¡¨ç¤ºæœ€é•¿è·ç¦».

ç›®å‰å¸‚é¢ä¸Šä¸‡å…†å…‰æ¨¡ç»„å‹å·ç¹å¤š, å¦‚ç”¨äºå¤šæ¨¡ä¼ è¾“çš„ **SFP-10G-SR** ä¸‡å…†å…‰æ¨¡ç»„ã€ç”¨äºå•æ¨¡ä¼ è¾“çš„ **SFP-10G-LR** ä¸‡å…†å…‰æ¨¡ç»„ã€ä»¥åŠæ—¢èƒ½ç”¨äºå•æ¨¡ä¼ è¾“åˆèƒ½ç”¨äºå¤šæ¨¡ä¼ è¾“çš„ **SFP-10G-LRM** ä¸‡å…†å…‰æ¨¡ç»„, ä¸‹é¢æ˜¯éƒ¨åˆ†ä¸‡å…†å…‰æ¨¡ç»„çš„åŒºåˆ«:

| å‹å·         | æ³¢é•¿    | å…‰çº¤ç±»å‹ | ä¼ è¾“è·ç¦» | æ¥å£    | æ ‡å‡†        |
| ------------ | ------- | -------- | -------- | ------- | ----------- |
| SFP-10G-SR   | 850 nm  | å¤šæ¨¡     | 300 m    | LC åŒå·¥ | 10GBASE-SR  |
| SFP-10G-LR   | 1310 nm | å•æ¨¡     | 10 km    | LC åŒå·¥ | 10GBASE-LR  |
| SFP-10G-LRM  | 1310 nm | å¤šæ¨¡     | 220 m    | LC åŒå·¥ | 10GBASE-LRM |
| SFP-10G-LRM  | 1310 nm | å•æ¨¡     | 300 m    | LC åŒå·¥ | 10GBASE-LRM |
| SFP-10G-LRM2 | 1310 nm | å•æ¨¡     | 2 km     | LC åŒå·¥ | 10GBASE-LRM |

- SFP-10G-SR (çŸ­è·ç¦») æ˜¯ä¸€ç§å¸¸è§çš„ SFP æ¨¡å—, å®ƒå¯ä»¥åœ¨ **å¤šæ¨¡å…‰çº¤** ä¸­è¿æ¥é«˜è¾¾ 300 ç±³çš„å…‰çº¤. ä¸€èˆ¬æƒ…å†µä¸‹ SR æ¨¡å—å¤šä¸ºå¤šæ¨¡, å·¥ä½œæ³¢é•¿ä¸º 850nm. è¿™äº›æ¨¡å—æ˜¯å¯çƒ­æ’æ‹”çš„, ç›¸äº’ä¹‹é—´å¯ä»¥è½»æ¾å®ç°åˆ‡æ¢.
- SFP-10G-LR(é•¿è·ç¦») ç”¨äºè¿œç¨‹æ•°æ®ä¼ è¾“, å¦‚å¤§å‹ç»„åˆæˆ–åœ°é“åŒºåŸŸç½‘ç»œ. å…·æœ‰æˆæœ¬ä½ã€åŠŸè€—ä½ã€ä½“ç§¯å°ã€å¯†åº¦é«˜çš„ä¼˜ç‚¹.
- SFP-10G-LRM(é•¿åº¦å»¶ä¼¸å¤šç‚¹æ¨¡å¼) ç¬¦åˆ 10GBASE-LRM ä»¥å¤ªç½‘çš„æ ‡å‡†, é€‚ç”¨äºä¼ ç»Ÿå…‰çº¤å’Œæ–°å‹å¤šæ¨¡å…‰çº¤. å®ƒåœ¨å¤šæ¨¡å…‰çº¤ä¸Šçš„æœ€å°æ”¯æŒè·ç¦»ä¸º 220 ç±³, åœ¨å•æ¨¡å…‰çº¤ä¸Šçš„æœ€å°æ”¯æŒè·ç¦»ä¸º 300 ç±³.

è¿˜æœ‰è¶…è¿œè·ç¦»ä¼ è¾“çš„æ¨¡å—:

- SFP-10G-ER(è¶…é•¿è·ç¦»)åœ¨æ ‡å‡† **å•æ¨¡å…‰çº¤** ä¸Šæ”¯æŒé•¿è¾¾ **40 å…¬**é‡Œ çš„ä¼ è¾“è·ç¦». å¹¿æ³›åº”ç”¨äºæ•°æ®ä¸­å¿ƒå’Œä¼ä¸šå·¥ä¸šå›­åŒº .
- SFP-10G-ZR (æœ€é•¿è·ç¦»), åœ¨æ ‡å‡† **å•æ¨¡å…‰çº¤** ä¸Šæ”¯æŒé«˜è¾¾ **80 å…¬é‡Œ** çš„ä¼ è¾“è·ç¦», å…¶æ³¢é•¿ä¸º 1550nm. ç¬¦åˆ SF-8431ã€SF-8432 å’Œ IEE802.11 ae æ ‡å‡†. å®ƒå¯åº”ç”¨äºæ•°æ®ç½‘ç»œ/å…‰ç½‘ç»œ.

å‚è€ƒ:

- [å•æ¨¡å¤šæ¨¡è¿˜å‚»å‚»åˆ†ä¸æ¸…æ¥šï¼Ÿå…³äºå…‰æ¨¡å—ä»‹ç», çœ‹è¿™ä¸€ç¯‡å°±å¤Ÿå•¦ï¼](https://gitcode.csdn.net/66c590b213e4054e7e7c5bd3.html)

---

#### å…‰çº¤å’Œå…‰æ¨¡å—ç»„åˆ

| å…‰æ¨¡å—ç±»å‹ | å…‰çº¤ç±»å‹ | æ˜¯å¦èƒ½æ­£å¸¸å·¥ä½œ                                                       |
| ---------- | -------- | -------------------------------------------------------------------- |
| å•æ¨¡å…‰æ¨¡å— | å¤šæ¨¡å…‰çº¤ | çŸ­è·ç¦»å¯ä»¥å·¥ä½œ, ä½†æ— æ³•ä¿éšœæ•ˆæœ(éœ€è¦ä½¿ç”¨ **å…‰çº¤æ”¶å‘å™¨** è½¬æ¢å…‰çº¤ç±»å‹) |
| å•æ¨¡å…‰æ¨¡å— | å•æ¨¡å…‰çº¤ | æ­£å¸¸å·¥ä½œ                                                             |
| å¤šæ¨¡å…‰æ¨¡å— | å•æ¨¡å…‰çº¤ | æ— æ³•å·¥ä½œ                                                             |
| å¤šæ¨¡å…‰æ¨¡å— | å¤šæ¨¡å…‰çº¤ | æ­£å¸¸å·¥ä½œ                                                             |

- å•æ¨¡å…‰æ¨¡å—ä¸å•æ¨¡å…‰çº¤é…å¥—ä½¿ç”¨. å•æ¨¡å…‰çº¤ä¼ è¾“é¢‘å¸¦å®½, ä¼ è¾“å®¹é‡å¤§, é€‚ç”¨äºé•¿è·ä¼ è¾“.
- å¤šæ¨¡å…‰æ¨¡å—ä¸å¤šæ¨¡å…‰çº¤é…å¥—ä½¿ç”¨. å¤šæ¨¡å…‰çº¤æœ‰æ¨¡å¼è‰²æ•£ç¼ºé™·, å…¶ä¼ è¾“æ€§èƒ½æ¯”å•æ¨¡å…‰çº¤å·®, ä½†æˆæœ¬ä½, é€‚ç”¨äºè¾ƒå°å®¹é‡ã€çŸ­è·ä¼ è¾“.

> åœ¨äº†è§£ç›¸å…³åŸºç¡€çŸ¥è¯†å, æ»¡è¶³æœ€ä½ 10G é€Ÿåº¦éœ€æ±‚çš„å‰æä¸‹, è€ƒè™‘æ€§ä»·æ¯”å, ç›®å‰å¤šæ¨¡å…‰çº¤æ›´åˆé€‚, å› ä¸ºæ­é…çš„å¤šæ¨¡å…‰æ¨¡å—æ›´ä¾¿å®œ, æ‰€ä»¥æˆ‘æˆ‘é€‰æ‹©ä½¿ç”¨ **å¤šæ¨¡åŒèŠ¯å…‰çº¤(OM3)** + **LC-LC æ¥å£** + **å¤šæ¨¡å…‰æ¨¡å—(SFP-10G-SR)** æ¥ç»„å»ºæˆ‘çš„ä¸‡å…†å…‰çº¤ç½‘ç»œ, è¿™åº”è¯¥æ˜¯å®¶åº­ä¸‡å…†å…‰çº¤ç½‘ç»œæ¯”è¾ƒå¸¸è§çš„é…ç½®äº†.

---

### ç½‘å¡

#### MBP ç½‘å¡é©±åŠ¨

é¦–å…ˆéœ€è¦ç¡®å®š **Macbook Pro M1 Max** ç³»ç»Ÿä¸º **macOS Sequoia** (ç‰ˆæœ¬ **15.1.1**) èƒ½å¤Ÿå…é©±å“ªäº›ä¸‡å…†ç½‘å¡.

Apple åŸç”Ÿé©±åŠ¨æœ‰(`ls -d /System/Library/DriverExtensions/*AppleEthernet`):

- com.apple.DriverKit-AppleEthernetE1000.dext: **Intel** é©±åŠ¨
- **com.apple.DriverKit-AppleEthernetIXGBE.dext**: **Intel** é©±åŠ¨
- com.apple.DriverKit-AppleEthernetIXL.dext: **Intel** é©±åŠ¨
- com.apple.DriverKit-AppleEthernetMLX5.dext: **Mellanox** é©±åŠ¨

**å„é©±åŠ¨åŒºåˆ«**:

| **é©±åŠ¨åç§°**           | **æ”¯æŒçš„ç¡¬ä»¶/èŠ¯ç‰‡ç»„**                                | **ç”¨é€”æè¿°**                        |
| ---------------------- | ---------------------------------------------------- | ----------------------------------- |
| **AppleEthernetE1000** | Intel E1000 ç³»åˆ—ç½‘å¡ (åƒå…†ä»¥å¤ªç½‘)                    | æ”¯æŒ Intel çš„åƒå…†ç½‘å¡               |
| **AppleEthernetIXGBE** | Intel IXGBE ç³»åˆ—ç½‘å¡ (ä¸‡å…†ä»¥å¤ªç½‘)                    | æ”¯æŒ Intel çš„ä¸‡å…†ç½‘å¡               |
| **AppleEthernetIXL**   | Intel IXL ç³»åˆ—ç½‘å¡ (25G/40G/100G Ethernet)           | æ”¯æŒ Intel çš„ 25G/40G/100G é«˜é€Ÿç½‘å¡ |
| **AppleEthernetMLX5**  | Mellanox ConnectX-5 ç³»åˆ—ç½‘å¡ (25G/50G/100G Ethernet) | æ”¯æŒ Mellanox é«˜æ€§èƒ½ç½‘å¡ (_Nvidia_) |

æˆ‘ä»¬å…³æ³¨çš„æ˜¯ 10G ç½‘å¡é©±åŠ¨, æ‰€ä»¥å¯¹åº”çš„æ˜¯: **com.apple.DriverKit-AppleEthernetIXGBE.dext**.

ä¸‹é¢æ˜¯é©±åŠ¨ä¿¡æ¯:

`cat /System/Library/DriverExtensions/com.apple.DriverKit-AppleEthernetIXGBE.dext/Info.plist`

```xml
<dict>
		<key>DriverKit_AppleEthernetIXGBE</key>
		<dict>
		  <!-- é©±åŠ¨å”¯ä¸€æ ‡è¯† -->
			<key>CFBundleIdentifier</key>
			<string>com.apple.DriverKit-AppleEthernetIXGBE</string>
      <!-- é©±åŠ¨ç¨‹åºä¾èµ–çš„å†…æ ¸æ‰©å±•ä¸º Apple çš„ Skywalk ç½‘ç»œæ ˆæ¡†æ¶ç³»åˆ— -->
			<key>CFBundleIdentifierKernel</key>
			<string>com.apple.iokit.IOSkywalkFamily</string>
			<!-- è¯¥é©±åŠ¨ç¨‹åºå®ç°çš„ç±» -->
			<key>IOClass</key>
			<string>IOUserNetworkEthernet</string>
			<!-- é€šè¿‡ PCI ç±»ä»£ç è¿›è¡Œè®¾å¤‡åŒ¹é… -->
			<key>IOPCIClassMatch</key>
			<!-- è¡¨ç¤ºåŒ¹é…æ‰€æœ‰ç½‘ç»œæ§åˆ¶å™¨ç±»è®¾å¤‡ (PCI Class Code: 0x02) , å±è”½äº†å­ç±»ä»£ç çš„å½±å“ -->
			<string>0x02000000&amp;0xffffff00</string>
			<!-- é€šè¿‡è®¾å¤‡ ID å’Œä¾›åº”å•† ID åŒ¹é… -->
			<key>IOPCIMatch</key>
			<!-- è¡¨ç¤ºåŒ¹é… Intel (ä¾›åº”å•† ID: 0x8086) ç”Ÿäº§çš„è®¾å¤‡, ä¸”å¿½ç•¥è®¾å¤‡ ID çš„å…·ä½“ç»†èŠ‚ -->
			<string>0x00008086&amp;0x0000ffff</string>
			<!-- è¡¨æ˜æ­¤é©±åŠ¨æ”¯æŒ PCIe éš§é“æŠ€æœ¯ (å¦‚ Thunderbolt éš§é“)  <true/> è¡¨ç¤ºè¯¥é©±åŠ¨å…¼å®¹æ­¤åŠŸèƒ½ -->
			<key>IOPCITunnelCompatible</key>
			<true/>
			<!-- æŒ‡å®šè®¾å¤‡æä¾›è€…çš„ç±»å. åœ¨è¿™é‡Œæ˜¯ IOPCIDevice, è¡¨ç¤ºè¯¥é©±åŠ¨çš„æœåŠ¡æä¾›è€…æ˜¯ PCI è®¾å¤‡ -->
			<key>IOProviderClass</key>
			<string>IOPCIDevice</string>
			<!-- æŒ‡å®šé©±åŠ¨ç¨‹åºçš„å®ç°ç±»å -->
			<key>IOUserClass</key>
			<string>DriverKit_AppleEthernetIXGBE</string>
			<!-- æŒ‡å®šä¸æ­¤é©±åŠ¨ç¨‹åºå…³è”çš„ DriverKit ç”¨æˆ·ç©ºé—´æœåŠ¡å -->
			<key>IOUserServerName</key>
			<string>com.apple.DriverKit-AppleEthernetIXGBE</string>
		</dict>
	</dict>
```

å¦‚ä¸Šæ‰€ç¤º, æ¯”è¾ƒå…³é”®çš„æ˜¯ `0x00008086&amp;0x0000ffff`, è¡¨ç¤º PCI ID ä¸º 8086 ä¸”å¿½ç•¥è®¾å¤‡ ID.

> PCI ä¾›åº”å•† ID 8086 å°†è‹±ç‰¹å°”æ ‡è¯†ä¸ºè®¾å¤‡åˆ¶é€ å•†.
>
> [PCI ä¾›åº”å•† ID å¯ä»¥åœ¨è¿™é‡ŒæŸ¥è¯¢](https://devicehunt.com/all-pci-vendors).

##### Intel ç½‘å¡

[Intel ç½‘å¡](http://www.intel-china.com/product.html) ä¸é©±åŠ¨ä¿¡æ¯:

| å‹å·                                                           | ä¸»èŠ¯ç‰‡å‹å·      | åè®®æ ‡å‡†  | æ¥å£ç±»å‹     | é©±åŠ¨                                       |
| -------------------------------------------------------------- | --------------- | --------- | ------------ | ------------------------------------------ |
| [X520](http://www.intel-china.com/product.html?keyword=x520)   | **Intel 82599** | **10GbE** | **SFP+**     | **com.apple.DriverKit-AppleEthernetIXGBE** |
| [X540](http://www.intel-china.com/info84.html)                 | Intel X540      | 10GbE     | BASE-T       | com.apple.DriverKit-AppleEthernetIXGBE     |
| [X550](http://www.intel-china.com/info126.html)                | Intel X550      | 10GbE     | BASE-T       | com.apple.DriverKit-AppleEthernetIXGBE     |
| [X710](http://www.intel-china.com/product.html?keyword=x710)   | Intel X710      | 10GbE     | BASE-T/SFP+  | com.apple.DriverKit-AppleEthernetIXL       |
| [XXV710](http://www.intel-china.com/info135.html)              | Intel XXV710    | 25GbE     | SFP28        | com.apple.DriverKit-AppleEthernetIXL       |
| [XL710](http://www.intel-china.com/product.html?keyword=xl710) | Intel XL710     | 40GbE     | BASE-T/QSFP+ | com.apple.DriverKit-AppleEthernetIXL       |

ç½‘å¡é‰´èµç¯èŠ‚:

**Intel XXV710-DA2 Network Card** :

![20241229154732_6FVVlYgt.webp](https://cdn.dong4j.site/source/image/20241229154732_6FVVlYgt.webp)

**Intel XL710-DA2 Network Card**:

![20241229154732_QinMzQmp.webp](https://cdn.dong4j.site/source/image/20241229154732_QinMzQmp.webp)

##### Mellanox

| å‹å·                    | åè®®æ ‡å‡† | æ¥å£ç±»å‹ | é©±åŠ¨                                  |
| ----------------------- | -------- | -------- | ------------------------------------- |
| CX4121A-ACAT ConnectX-4 | 25GbE    | SFP28    | com.apple.DriverKit-AppleEthernetMLX5 |

![20241229154732_caeYgzvf.webp](https://cdn.dong4j.site/source/image/20241229154732_caeYgzvf.webp)

> [æœ€é€‚åˆ MAC çš„é›·ç”µ 25G ç½‘å¡](https://www.bilibili.com/video/BV1fh4y1B7po), è¿™ä½ Up ä¸»ä½¿ç”¨ `CX4121A-ACAT ConnectX-4` ç½‘å¡å®ç°äº†åœ¨ Mac ä¸‹ 25Gb å†…ç½‘.
>
> ç³Ÿäº†, å¿ƒåŠ¨çš„æ„Ÿè§‰.....
>
> è¿™ä¸ 25Gb å’Œ 40Gb çš„æ–¹æ¡ˆä¸å°±æœ‰äº† ğŸ¤£ğŸ¤£ğŸ¤£

---

##### ç½‘å¡é€‰æ‹©

æ»¡è¶³éœ€æ±‚çš„ä¼¼ä¹å°±åªæœ‰ **X520** å’Œ **X710** è¿™ 2 ä¸ªäº§å“ç±»åˆ«, ä½†ä»·æ ¼ä¸Š **X520** è‚¯å®šæ›´ä¾¿å®œ, è€Œä¸”ç½‘ä¸Šçš„æˆåŠŸæ¡ˆä¾‹ç»å¤§éƒ¨åˆ†éƒ½æ˜¯ **X520**, å› æ­¤å†³å®šè´­ä¹° **X520** çš„åŒç½‘å£ç‰ˆæœ¬.

ç¡®è®¤äº†ç½‘å¡ç±»åˆ«å, å°±éœ€è¦é€‰æ‹©ç½‘å£æ•°é‡äº†, æˆ‘çš„éœ€æ±‚æ˜¯åŒå…‰å£, è€Œ **Intel X520** åŒå…‰å£ç‰ˆæœ¬æœ‰å¤šä¸ª, åˆ†åˆ«æ˜¯ **Intel X520-DA2** & **Intel X520-SR2** & **Intel X520-LR2**:

![20241229154732_dka4ET6j.webp](https://cdn.dong4j.site/source/image/20241229154732_dka4ET6j.webp)

å…¶ä¸­ SR å’Œ DA çš„åŒºåˆ«ä»…åœ¨äºè´­ä¹°æ—¶ **å¸¦ä¸å¸¦å…‰æ¨¡å—**(**SR å¸¦, DA ä¸å¸¦**). è€Œ **Intel X520-LR2** åˆ™éœ€è¦ **å•æ¨¡** çš„å…‰æ¨¡å—, å®ƒçš„ä»·æ ¼æ›´è´µ.

X520 ç³»åˆ—ç½‘å¡çš„ Intel 82599 ä¸»èŠ¯ç‰‡ç°åœ¨ä¸»è¦æœ‰ 3 ä¸ªå‹å·ï¼š **82599EN** **82599ES** **82599EB** , ä»–ä»¬ä¸‰è€…çš„åŒºåˆ«:

| **èŠ¯ç‰‡å‹å·** | **åŠŸè€— (å…¸å‹)** | **ç‰¹ç‚¹**                                           | **åº”ç”¨åœºæ™¯**                   |
| ------------ | --------------- | -------------------------------------------------- | ------------------------------ |
| **82599EB**  | 5.2W            | æ”¯æŒ SR-IOV, ä¼ä¸šçº§åŠŸèƒ½, è™šæ‹ŸåŒ–æ”¯æŒ, æ€§èƒ½æœ€å¼º      | é«˜æ€§èƒ½ä¼ä¸šæ•°æ®ä¸­å¿ƒ, è™šæ‹ŸåŒ–ç¯å¢ƒ |
| **82599ES**  | 4.8W            | ç±»ä¼¼äº EB, å»é™¤ SR-IOV, è¾ƒä½åŠŸè€—, é€‚åˆé«˜ååé‡åº”ç”¨ | æ•°æ®ä¸­å¿ƒ, é«˜å¸¦å®½éœ€æ±‚çš„ç½‘ç»œè®¾å¤‡ |
| **82599EN**  | 4.2W            | ä½åŠŸè€—å’Œä½æˆæœ¬, å»é™¤é«˜çº§åŠŸèƒ½, é€‚ç”¨äºæˆæœ¬æ•æ„Ÿåº”ç”¨   | åµŒå…¥å¼ç³»ç»Ÿ, ä½åŠŸè€—å’Œä½æˆæœ¬åº”ç”¨ |

> **SR-IOV** æ˜¯ä¸€ç§ I/O è™šæ‹ŸåŒ–æŠ€æœ¯, å…è®¸å•ä¸€çš„ç‰©ç†è®¾å¤‡ (å¦‚ç½‘å¡) è¢«è™šæ‹ŸåŒ–å¹¶åˆ†é…ç»™å¤šä¸ªè™šæ‹Ÿæœº, ä½¿å¾—å¤šä¸ªè™šæ‹Ÿæœºèƒ½å¤Ÿç›´æ¥è®¿é—®ç¡¬ä»¶èµ„æº, è€Œæ— éœ€ç»è¿‡ä¼ ç»Ÿçš„è™šæ‹ŸåŒ–ä¸­é—´å±‚ (å¦‚ hypervisor æˆ–è™šæ‹ŸåŒ–é©±åŠ¨) . SR-IOV çš„æ ¸å¿ƒç‰¹ç‚¹åŒ…æ‹¬ï¼š
>
> - **è™šæ‹ŸåŠŸèƒ½ (Virtual Functions, VFs)**ï¼šæ¯ä¸ªè™šæ‹Ÿæœºè¢«åˆ†é…ä¸€ä¸ªè™šæ‹ŸåŠŸèƒ½, è¿™äº›è™šæ‹ŸåŠŸèƒ½å¯ä»¥ç›´æ¥è®¿é—®ç‰©ç†ç½‘å¡çš„ä¸€éƒ¨åˆ†èµ„æº.
> - **ç‰©ç†åŠŸèƒ½ (Physical Function, PF)**ï¼šç‰©ç†è®¾å¤‡çš„ä¸»è¦åŠŸèƒ½, å®ƒè´Ÿè´£ç®¡ç†å’Œåˆ†é…è™šæ‹ŸåŠŸèƒ½, å¹¶ä¸è™šæ‹Ÿæœºè¿›è¡Œé€šä¿¡.
> - **ç¡¬ä»¶ç›´æ¥è®¿é—®**ï¼šé€šè¿‡ SR-IOV, è™šæ‹Ÿæœºå¯ä»¥ç»•è¿‡æ“ä½œç³»ç»Ÿå’Œ hypervisor çš„ç½‘ç»œå †æ ˆ, ç›´æ¥ä¸ç‰©ç†ç¡¬ä»¶äº¤äº’, æé«˜æ€§èƒ½, å‡å°‘å»¶è¿Ÿå’Œ CPU ä½¿ç”¨ç‡.
>
> æ€»ç»“èµ·æ¥å°±æ˜¯å¦‚æœéœ€è¦ç© ESXi å’Œ PVE çš„è¯, æœ€å¥½è¿˜æ˜¯ä¸Š **82599EB** èŠ¯ç‰‡çš„ X520.

è¿™ä¸‰ä¸ªå‹å·ä¸­, **82599EN** åªèƒ½æ”¯æŒ**å•å£ä¸‡å…†**, **82599EB** å’Œ **82599ES** åˆ™éƒ½èƒ½æ”¯æŒ**åŒå£ä¸‡å…†**, è¿™æ˜¯å®ƒä»¬ä¸‰è€…ä¹‹é—´æœ€æ˜¾è‘—çš„å·®å¼‚.
**82599ES** ç›¸æ¯” **82599EB** åˆ™å¤šäº†å¯¹ SFI(æ¥ SFP+å…‰æ¨¡å—) å’Œ 10GBASE-KR(è®¾å¤‡å†…éƒ¨èƒŒæ¿å†…æ¥) ç±»å‹çš„æ”¯æŒ, å¯¹ SFI æ¥å£çš„æ”¯æŒåˆ™è¡¨ç¤º **82599ES** èŠ¯ç‰‡å¯ä»¥é…åˆ SFP+ æ¨¡å—ä½¿ç”¨, ä¹Ÿå°±æ˜¯è¯´ **82599ES ç›¸æ¯” 82599EB å¤šäº†å¯¹å…‰å£çš„æ”¯æŒ**, æœ€å¸¸ç”¨çš„ X520 **åŒå£å…‰çº¤ä¸‡å…†ç½‘å¡å°±æ˜¯é‡‡ç”¨çš„ 82599ES èŠ¯ç‰‡**.

---

å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ **X520** çš„æ€»çº¿ç±»å‹æ˜¯ **PCIe 2.0 x8**, éœ€è¦ä½¿ç”¨ **PCIEx8** æˆ– **PCIEx16** çš„æ’æ§½, å¦‚æœä½¿ç”¨ **PCIEx4**, éœ€è¦ 3.0 ç‰ˆæœ¬, å¦åˆ™æ— æ³•è¾¾åˆ°çº¿é€Ÿ, ä¸‹é¢è´´ä¸€ä¸ª PCIe å„ç‰ˆæœ¬çš„çš„ç†è®ºé€Ÿåº¦è¡¨:

| **PCIe ç‰ˆæœ¬** | **x1 ç†è®ºå¸¦å®½** | **x2 ç†è®ºå¸¦å®½** | **x4 ç†è®ºå¸¦å®½** | **x8 ç†è®ºå¸¦å®½** | **x16 ç†è®ºå¸¦å®½** | ä¼ è¾“é€Ÿç‡  |
| ------------- | --------------- | --------------- | --------------- | --------------- | ---------------- | --------- |
| PCIe 2.0      | 0.5 GB/s        | 1.0 GB/s        | 2.0 GB/s        | 4.0 GB/s        | 8.0 GB/s         | 5.0 GT/s  |
| PCIe 3.0      | 0.985 GB/s      | 1.969 GB/s      | **3.938 GB/s**  | 7.877 GB/s      | 15.754 GB/s      | 8.0 GT/s  |
| PCIe 4.0      | 1.969 GB/s      | 3.938 GB/s      | 7.877 GB/s      | 15.754 GB/s     | 31.508 GB/s      | 16.0 GT/s |
| PCIe 5.0      | 3.938 GB/s      | 7.877 GB/s      | 15.754 GB/s     | 31.508 GB/s     | 63.015 GB/s      | 32.0 GT/s |
| PCIe 6.0      | 7.563 GB/s      | 15.125 GB/s     | 30.25 GB/s      | 60.5 GB/s       | 121.0 GB/s       | 64.0 GT/s |

ä¸€è·¯ä» Apple åŸç”Ÿé©±åŠ¨åˆ°å¯¹ç½‘å¡çš„å…³çŸ¥è¯†çš„åŸºç¡€äº†è§£, æœ€ç»ˆç¡®å®šé€‰è´­çš„ç½‘å¡ä¸º: [E10G42BTDA/X520-DA2](http://www.intel-china.com/info72.html), ç›®å‰äºŒæ‰‹ä»·æ ¼ä¹Ÿéå¸¸ä¾¿å®œ, åº”è¯¥ç®—æ˜¯æœ€å…·æ€§ä»·æ¯”çš„ä¸‡å…†ç½‘å¡.

å‚è€ƒ:

- [äº†è§£ä»¥å¤ªç½‘æœ¯è¯­ â€“ æ•°æ®é€Ÿç‡ã€äº’è¿ä»‹è´¨å’Œç‰©ç†å±‚](https://www.synopsys.com/zh-cn/china/resources/dwtb/dwtb-cn-ethernet-2017q2.html)
- [10Gb ä¹™å¤ªç½‘è·¯è¿æ¥è§„æ ¼æ¦‚è§ˆï¼šå½¢å½¢è‰²è‰²çš„ 10GbE è¿æ¥æ–¹å¼](https://www.ithome.com.tw/tech/90786)

#### Station ç½‘å¡

Station ä¸»æœºåŸæ¥æœ‰ä¸€å¼ æµªæ½®çš„ X540 ä¸‡å…†åŒç”µå£ç½‘å¡:

![20241229154732_QcCVPt6A.webp](https://cdn.dong4j.site/source/image/20241229154732_QcCVPt6A.webp)

è¿™å¼ å¡å¯ä»¥ç§°å¾—ä¸Šæ˜¯ **å¹´è½»äººçš„ç¬¬ä¸€å¼ ä¸‡å…†ç½‘å¡**, ä»·æ ¼ä½çš„ç¦»è°±, å› ä¸ºè¿™ä¸ªå¡æ˜¯éæ ‡å‡†çš„ x8+x1, ä¹°å›æ¥ä¸èƒ½ç›´æ¥ç”¨, éœ€è¦é­”æ”¹ä¸€ä¸‹(å°é»„é±¼æœ‰æˆå“), å‚è€ƒ [åŒå£ä¸‡å…†ç½‘å¡ä½åˆ° 40 å…ƒ, è¿™ä¸ªä¸‡å…†ç½‘å¡æ€§ä»·æ¯”å¤©èŠ±æ¿](https://post.smzdm.com/p/arqvl82x/) å°±è¡Œ.

ç°åœ¨çš„é—®é¢˜æ˜¯å¤§çƒ­é‡å¤§, æ‰€ä»¥ç´¢æ€§å°±ä¸€æ¬¡æ€§å…¨éƒ¨æ¢æˆ [E10G42BTDA/X520-DA2](http://www.intel-china.com/info72.html), è¿˜èƒ½å°‘ä¹° 2 ä¸ªå…‰è½¬ç”µæ¨¡å—.

---

#### M920x ç½‘å¡

ç½‘å¡ä¹Ÿæ˜¯ **Intel X520-DA2**, ä½†æ˜¯ä¸Šæ¬¡æ‹†æœºæ—¶å‘ç° PCB å·²ç»å¼¯æ›²å˜å½¢äº†(ä¸è¿‡å¹¶ä¸å½±å“ä½¿ç”¨), ç­‰å½»åº•æŠ¥åºŸçš„æ—¶å€™å†è€ƒè™‘æ›´æ¢(æˆ–è€…ä¸‹æ¬¡å‡çº§åˆ° 40Gb? ğŸ˜)

**ç½‘å¡ä¿¡æ¯(82599ES èŠ¯ç‰‡):**

```bash
$ inxi -n

...
Device-2: Intel 82599ES 10-Gigabit SFI/SFP+ Network driver: ixgbe
IF: enp1s0f0 state: up speed: 10000 Mbps duplex: full mac: xxx
Device-3: Intel 82599ES 10-Gigabit SFI/SFP+ Network driver: ixgbe
IF: enp1s0f1 state: up speed: 10000 Mbps duplex: full mac: yyy
...
```

<!--

```bash
$ dmesg |grep -i pcie
...
[1.274212] ixgbe 0000:01:00.0: 32.000 Gb/s available PCIe bandwidth (5.0 GT/s PCIe x8 link)
[1.429789] ixgbe 0000:01:00.1: 32.000 Gb/s available PCIe bandwidth (5.0 GT/s PCIe x8 link)
...
```

-->

---

### åŸºç¡€çŸ¥è¯†

#### GbE Gbps GBps

| æœ¯è¯­     | å«ä¹‰                                         | å•ä½        | ç”¨é€”                                       | æ¢ç®—å…³ç³»          |
| -------- | -------------------------------------------- | ----------- | ------------------------------------------ | ----------------- |
| **GbE**  | Gigabit Ethernet, æŒ‡ 1 å‰æ¯”ç‰¹ **ä»¥å¤ªç½‘åè®®** | 1 Gbps      | ç”¨äºæè¿°ä»¥å¤ªç½‘åè®®çš„é€Ÿç‡, é€šå¸¸ç”¨äºç½‘ç»œè¿æ¥ | 1 GbE = 1 Gbps    |
| **Gbps** | Gigabits per second, æ¯ç§’ä¼ è¾“çš„ **æ¯”ç‰¹æ•°**   | æ¯”ç‰¹ (bit)  | ç”¨äºæè¿°æ•°æ®ä¼ è¾“é€Ÿç‡, å¸¸ç”¨äºç½‘ç»œå¸¦å®½       | 1 Gbps = 1/8 GBps |
| **GBps** | Gigabytes per second, æ¯ç§’ä¼ è¾“çš„ **å­—èŠ‚æ•°**  | å­—èŠ‚ (Byte) | ç”¨äºå­˜å‚¨è®¾å¤‡ã€ç¡¬ç›˜ã€SSD ç­‰çš„æ€§èƒ½æµ‹é‡       | 1 GBps = 8 Gbps   |

- **GbE** (Gigabit Ethernet) é€šå¸¸ç”¨äºæè¿°ç½‘ç»œè¿æ¥çš„åè®®å’Œå¸¦å®½ (1Gbps) , å¹¶è¡¨ç¤ºè¯¥ç½‘ç»œä½¿ç”¨ **1 Gbps** çš„é€Ÿç‡.
- **Gbps** ç”¨äºæè¿°æ•°æ®ä¼ è¾“é€Ÿç‡, ç‰¹åˆ«æ˜¯ç½‘ç»œå¸¦å®½, æ¯ç§’ä¼ è¾“çš„æ¯”ç‰¹æ•°, ä¹Ÿå¯ä»¥ç”¨ **Gb/s** è¡¨ç¤º

- **GBps** è¡¨ç¤ºæ¯ç§’ä¼ è¾“çš„å­—èŠ‚æ•°, é€šå¸¸ç”¨äºæè¿°å­˜å‚¨è®¾å¤‡çš„é€Ÿåº¦, 1 GB/s ç­‰äº 8 Gbps, ä¹Ÿå¯ä»¥ç”¨ **GB/s** è¡¨ç¤º.

#### å¸¦å®½ä¸ä¸‹è½½é€Ÿåº¦

| **æ¦‚å¿µ**     | **å®šä¹‰**                     | **å•ä½**                                | **å¤‡æ³¨**               |
| ------------ | ---------------------------- | --------------------------------------- | ---------------------- |
| **å¸¦å®½**     | ç½‘ç»œè¿æ¥å¯ä»¥å¤„ç†çš„æ•°æ®ä¼ è¾“é‡ | å…†æ¯”ç‰¹æ¯ç§’ (Mbps) ã€åƒå…†æ¯”ç‰¹æ¯ç§’ (Gbps) | åæ˜ ç½‘ç»œçš„æœ€å¤§ä¼ è¾“èƒ½åŠ› |
| **ä¸‹è½½é€Ÿåº¦** | ä»ç½‘ç»œä¸­ä¸‹è½½æ•°æ®åˆ°è®¾å¤‡çš„é€Ÿç‡ | å­—èŠ‚æ¯ç§’ (B/s) ã€å…†å­—èŠ‚æ¯ç§’ (MB/s)      | å®é™…çš„æ•°æ®ä¼ è¾“é€Ÿåº¦     |
| **å•ä½æ¢ç®—** | 1 å­—èŠ‚ = 8 æ¯”ç‰¹              |                                         | ä¸‹è½½é€Ÿåº¦ = å¸¦å®½ Ã· 8    |

- **åƒå…†å¸¦å®½** (1 Gbps) å¯¹åº”çš„ç†è®ºä¸‹è½½é€Ÿåº¦ä¸º **125 MB/s**.

---

#### ç½‘å¡æ¥å£ç±»å‹

| **æœ¯è¯­**   | **ç‰¹ç‚¹**                                                                            |
| ---------- | ----------------------------------------------------------------------------------- |
| **BASE-T** | ä½¿ç”¨ RJ-45 æ¥å£; æ”¯æŒ Cat5e/Cat6/Cat6a åŒç»çº¿; æ”¯æŒ 1Gbpsã€2.5Gbpsã€5Gbps å’Œ 10Gbps |
| **SFP+**   | çƒ­æ’æ‹”è®¾è®¡; æ”¯æŒå…‰çº¤æˆ–é“œç¼†; å¸¸ç”¨äºä¸‡å…†ç½‘ç»œä¼ è¾“                                      |
| **SFP28**  | ä¸ SFP+ å¤–å½¢å…¼å®¹; æä¾›æ›´é«˜çš„é€Ÿç‡ (25Gbps); æ”¯æŒå…‰çº¤æˆ–é“œç¼†                           |
| **QSFP+**  | æ”¯æŒ 4x10Gbps æˆ– 1x40Gbps; å…‰çº¤æ¥å£ä¸ºä¸»; çƒ­æ’æ‹”è®¾è®¡                                 |

### MTU

<!--

https://www.cnblogs.com/milton/p/14501016.html

-->

æœ€å¤§ä¼ è¾“å•å…ƒ MTU (Maximum Transmission Unit) , æ˜¯æŒ‡ç½‘ç»œèƒ½å¤Ÿä¼ è¾“çš„æœ€å¤§æ•°æ®åŒ…å¤§å°, ä»¥å­—èŠ‚ä¸ºå•ä½. MTU çš„å¤§å°å†³å®šäº†å‘é€ç«¯ä¸€æ¬¡èƒ½å¤Ÿå‘é€æŠ¥æ–‡çš„æœ€å¤§å­—èŠ‚æ•°. å¦‚æœ MTU è¶…è¿‡äº†æ¥æ”¶ç«¯æ‰€èƒ½å¤Ÿæ‰¿å—çš„æœ€å¤§å€¼, æˆ–è€…æ˜¯è¶…è¿‡äº†å‘é€è·¯å¾„ä¸Šé€”ç»çš„æŸå°è®¾å¤‡æ‰€èƒ½å¤Ÿæ‰¿å—çš„æœ€å¤§å€¼, å°±ä¼šé€ æˆæŠ¥æ–‡åˆ†ç‰‡ç”šè‡³ä¸¢å¼ƒ, åŠ é‡ç½‘ç»œä¼ è¾“çš„è´Ÿæ‹…. å¦‚æœå¤ªå°, é‚£å®é™…ä¼ é€çš„æ•°æ®é‡å°±ä¼šè¿‡å°, å½±å“ä¼ è¾“æ•ˆç‡.

å‡è®¾å¾…å‘é€çš„æ•°æ®æ€»å…± _4000_ å­—èŠ‚, å‡è®¾ä»¥å¤ªç½‘è®¾å¤‡ä¸€å¸§æœ€å¤šåªèƒ½æ‰¿è½½ _1500_ å­—èŠ‚. å¾ˆæ˜æ˜¾, æ•°æ®éœ€è¦åˆ’åˆ†æˆ _3_ ç‰‡, å†é€šè¿‡ _3_ ä¸ªå¸§è¿›è¡Œå‘é€ï¼š

![20241229154732_pNd2my0R.webp](https://cdn.dong4j.site/source/image/20241229154732_pNd2my0R.webp)

**MTU çš„ç‰¹ç‚¹**

| ç‰¹ç‚¹     | æè¿°                                                                                               |
| -------- | -------------------------------------------------------------------------------------------------- |
| é»˜è®¤å€¼   | ä»¥å¤ªç½‘è®¾å¤‡çš„ MTU é»˜è®¤ä¸º **1500 å­—èŠ‚**.                                                             |
| å½±å“     | **è¿‡å°**ï¼šæ›´å¤šæ•°æ®åŒ…, å¢åŠ  CPU å’Œç½‘ç»œè®¾å¤‡çš„å¼€é”€. **è¿‡å¤§**ï¼šå¯èƒ½å¯¼è‡´è®¾å¤‡é—´ä¸å…¼å®¹, æ•°æ®åŒ…ä¸¢å¼ƒæˆ–åˆ†ç‰‡. |
| åˆ†ç‰‡é—®é¢˜ | å½“æ•°æ®åŒ…å¤§å°è¶…è¿‡ MTU æ—¶, ç½‘ç»œéœ€è¦å¯¹æ•°æ®åŒ…è¿›è¡Œ **åˆ†ç‰‡**, å¯èƒ½å¢åŠ å»¶è¿Ÿå¹¶å¸¦æ¥ä¸¢åŒ…é£é™©.                |
| é€‚é…åœºæ™¯ | ä¸åŒåœºæ™¯ä¸‹åº”æ ¹æ®éœ€è¦è°ƒæ•´ MTU, ä»¥å¹³è¡¡æ€§èƒ½å’Œå…¼å®¹æ€§.                                                  |

#### å·¨å‹å¸§

| ç‰¹ç‚¹     | æè¿°                                                                   |
| -------- | ---------------------------------------------------------------------- |
| å®šä¹‰     | å°† MTU è®¾ç½®ä¸º **9000 å­—èŠ‚** æˆ–æ›´å¤§, é€šå¸¸ç”¨äºé«˜æ€§èƒ½ä¼ è¾“åœºæ™¯.            |
| ä¼˜åŠ¿     | é™ä½åŒ…å¤´å¼€é”€; å‡å°‘æ‹†åˆ†ä¸é‡ç»„æ“ä½œ; æé«˜å¤§æ–‡ä»¶ä¼ è¾“æ•ˆç‡ (çº¦æå‡ 10%-20%)  |
| åŠ£åŠ¿     | æ—  IEEE æ ‡å‡†, å¯èƒ½å­˜åœ¨å…¼å®¹æ€§é—®é¢˜; **éœ€è¦ç½‘å¡å’Œäº¤æ¢æœºéƒ½æ”¯æŒå·¨å‹å¸§æ¨¡å¼** |
| é€‚ç”¨åœºæ™¯ | å¤§å‹æ–‡ä»¶ä¼ è¾“ã€NAS æ•°æ®åŒæ­¥ç­‰é«˜å¸¦å®½éœ€æ±‚åœºæ™¯.                            |

![20241229154732_sqsm5wVC.webp](https://cdn.dong4j.site/source/image/20241229154732_sqsm5wVC.webp)

å½“ä½ åœ¨ç‰¹å®šçš„ç½‘ç»œä»»åŠ¡ä¸‹å°† MTU ä» 1500 è®¾ç½®ä¸º 9000, ä¼šå‘ç°ç½‘ç»œæ–‡ä»¶ä¼ è¾“é€Ÿåº¦ä¼šæœ‰ 10-20%çš„æå‡. è¿™æ˜¯å› ä¸ºåœ¨å·¨å‹å¸§æ¨¡å¼ä¸‹, ç½‘ç»œä¼ è¾“è®¾å¤‡ç›¸åº”åœ°å‡å°‘äº†æ‹†å¼€ã€ç»„åˆæ•°æ®åŒ…çš„æ¬¡æ•°, ä¸€ä¸ªå·¨å‹å¸§çš„æ•°æ®åŒ…å¯ä»¥æºå¸¦ä¹‹å‰å¤šä¸ªæ•°æ®åŒ…æ‰€æºå¸¦çš„æ•°æ®é‡, åœ¨å¤§å‹æ–‡ä»¶ä¼ è¾“çš„æ—¶å€™æ•ˆç‡ä¹Ÿå°±è‡ªç„¶æé«˜äº†.

#### ä½¿ç”¨å»ºè®®

**åŒç½‘å¡åŒç½‘ç»œ**ï¼š

- ä¸€ä¸ªç½‘ç»œä½¿ç”¨é»˜è®¤çš„ MTU (1500), ç”¨äºæ—¥å¸¸ä¸Šç½‘.
- å¦ä¸€ä¸ªç½‘ç»œä½¿ç”¨å·¨å‹å¸§ (9000), ç”¨äºé«˜æ€§èƒ½å­˜å‚¨æ•°æ®ä¼ è¾“.

è¿™æ­£å¥½ç¬¦åˆæˆ‘ç°åœ¨çš„ç½‘ç»œç¯å¢ƒ(ä¸€ç”µä¿¡å®½å¸¦, ä¸€è”é€šå®½å¸¦).

**å‚è€ƒ**:

- [ä»€ä¹ˆæ˜¯ MTU](https://info.support.huawei.com/info-finder/encyclopedia/zh/MTU.html)
- [å…¥å‘ä¸‡å…†ç½‘å¡, å¿…é¡»çŸ¥é“å·¨å‹å¸§ä¸ MTU çš„å‘](https://www.bilibili.com/video/BV1Gz421z7CH/)
- [å®¶é‡Œç½‘ç»œå¤æ‚åº¦æé«˜, å¦‚ä½•æœ€å¤§é™åº¦å‘æŒ¥ç½‘ç»œçš„æ•ˆç‡](https://post.smzdm.com/p/alln7olp/)
- [Jumbo Frames on vSphere 5](http://longwhiteclouds.com/2012/02/20/jumbo-frames-on-vsphere-5/)

---

### äº¤æ¢æœº

æˆ‘å¯¹äº¤æ¢æœºçš„è¦æ±‚ä¸º:

- èƒ½å¤Ÿè®¾ç½® MTU;
- è‡³å°‘ 8 ä¸ªç½‘å£, å¯ä»¥æ˜¯ 4 ç”µå£+ 4 å…‰å£, ä¹Ÿå¯ä»¥æ˜¯ 8 å…‰å£;
- ä½“ç§¯ä¸èƒ½è¿‡å¤§, æœ€å¥½æ²¡æœ‰å†…ç½®æ•£çƒ­, éœ€è¦æ—¶æˆ‘å¯æ‰§è¡Œæ·»åŠ å¤–ç½®æ•£çƒ­é£æ‰‡éšæ—¶å¯åœ;

äº¤æ¢æœºå¤§è‡´åˆ†ä¸º **éç®¡ç†å‹äº¤æ¢æœº(å‚»ç“œäº¤æ¢æœº)**, **äºŒå±‚ç®¡ç†äº¤æ¢æœº** å’Œ **ä¸‰å±‚ç®¡ç†äº¤æ¢æœº**.

å‚»ç“œäº¤æ¢æœºçš„å·¥ä½œåŸç†æ˜¯é€šè¿‡å­¦ä¹ æ¯ä¸ªè®¾å¤‡çš„ MAC åœ°å€, å°†è®¾å¤‡çš„ MAC åœ°å€å’Œè¿æ¥çš„ç«¯å£æ˜ å°„åˆ°ä¸€ä¸ªå†…éƒ¨è¡¨ (ç§°ä¸º**MAC åœ°å€è¡¨**) , å½“æ•°æ®åŒ…è¿›å…¥äº¤æ¢æœºæ—¶, äº¤æ¢æœºä¼šæŸ¥çœ‹æ•°æ®åŒ…çš„ç›®æ ‡ MAC åœ°å€, å¹¶æŸ¥æ‰¾å¯¹åº”çš„ç«¯å£:

- å¦‚æœ MAC åœ°å€åœ¨è¡¨ä¸­, æ•°æ®åŒ…ç›´æ¥è½¬å‘åˆ°ç›®æ ‡ç«¯å£;
- å¦‚æœ MAC åœ°å€ä¸åœ¨è¡¨ä¸­, äº¤æ¢æœºä¼šå°†æ•°æ®åŒ…å¹¿æ’­åˆ°æ‰€æœ‰ç«¯å£ (é™¤æºç«¯å£å¤–) ;

å‚»ç“œäº¤æ¢æœºçš„ä¼˜åŠ¿æ˜¯ç®€å•, ä¸éœ€è¦ä»»ä½•é…ç½®å³å¯å·¥ä½œã€ä¾¿å®œã€ç¨³å®š, éå¸¸é€‚åˆæ²¡æœ‰ç½‘ç»œç®¡ç†éœ€æ±‚çš„åœºæ™¯.

è¦æ»¡è¶³ **MTU å¯è®¾ç½®çš„éœ€æ±‚**, åˆ™å¿…é¡»ä¸ŠäºŒå±‚æˆ–ä¸‰å±‚äº¤æ¢æœº, é‚£ä¸‹é¢å¯¹ä¸¤ç±»äº¤æ¢æœºåšä¸ªç®€å•çš„å¯¹æ¯”.

#### äºŒå±‚ Or ä¸‰å±‚

---

| ç‰¹æ€§          | äºŒå±‚äº¤æ¢æœº                                                        | ä¸‰å±‚äº¤æ¢æœº                                                            |
| ------------- | ----------------------------------------------------------------- | --------------------------------------------------------------------- |
| **å·¥ä½œå±‚çº§**  | æ•°æ®é“¾è·¯å±‚ (OSI æ¨¡å‹çš„ç¬¬ 2 å±‚)                                    | ç½‘ç»œå±‚ (OSI æ¨¡å‹çš„ç¬¬ 3 å±‚)                                            |
| **ä¸»è¦åŠŸèƒ½**  | 1. æ ¹æ® MAC åœ°å€è½¬å‘æ•°æ®<br>2. æä¾› VLAN æ”¯æŒ                     | 1. åŸºäº IP åœ°å€è½¬å‘æ•°æ®<br>2. æä¾›è·¯ç”±åŠŸèƒ½                            |
| **åº”ç”¨åœºæ™¯**  | 1. å±€åŸŸç½‘å†…éƒ¨è®¾å¤‡äº’è”<br>2. é€‚ç”¨äºå°å‹ç½‘ç»œ                        | 1. è·¨å­ç½‘é€šä¿¡<br>2. é€‚ç”¨äºå¤§å‹ç½‘ç»œä¸å¤šå­ç½‘                            |
| **ç¡¬ä»¶æ€§èƒ½**  | 1. é€šå¸¸è½¬å‘é€Ÿåº¦æ›´å¿«<br>2. æˆæœ¬è¾ƒä½                                | åŒ…å«è·¯ç”±åŠŸèƒ½, æˆæœ¬è¾ƒé«˜                                                |
| **VLAN æ”¯æŒ** | æ”¯æŒ VLAN çš„åˆ’åˆ†, ä½†éœ€é€šè¿‡ä¸‰å±‚è®¾å¤‡è¿›è¡Œè·¨ VLAN é€šä¿¡                | æ”¯æŒè·¨ VLAN è·¯ç”±, ç›´æ¥å®ç°ä¸åŒ VLAN é—´é€šä¿¡                            |
| **è·¯ç”±åŠŸèƒ½**  | ä¸æ”¯æŒè·¯ç”±åŠŸèƒ½, ä¾èµ–å¤–éƒ¨è·¯ç”±å™¨                                    | å†…ç½®è·¯ç”±åŠŸèƒ½, å¯ç›´æ¥å®ç°ç½‘ç»œäº’è”                                      |
| **å¹¿æ’­èŒƒå›´**  | å¹¿æ’­åŸŸå— VLAN é™åˆ¶                                                | å¯éš”ç¦»å¹¿æ’­åŸŸ, å‡å°‘å¹¿æ’­å¯¹ç½‘ç»œçš„å½±å“                                    |
| **MTU æ”¯æŒ**  | 1. ä»…è´Ÿè´£åœ¨äºŒå±‚è½¬å‘, ä¸è§£æ IP æŠ¥å¤´<br>2. ä¸æ”¯æŒå¯¹ MTU çš„åŠ¨æ€è°ƒæ•´ | 1. å¯åŸºäºä¸‰å±‚åè®®å¯¹ MTU è¿›è¡ŒåŠ¨æ€è°ƒæ•´<br>2. æ”¯æŒæœ€å¤§ä¼ è¾“å•å…ƒçš„ä¼˜åŒ–é…ç½® |

**MTU çš„å¯¹æ¯”**

1. **äºŒå±‚äº¤æ¢æœºä¸­çš„ MTU**

   - ä»…åœ¨æ•°æ®é“¾è·¯å±‚è½¬å‘å¸§, å¯¹ IP åˆ†ç‰‡å’Œ MTU è¶…è¿‡æ—¶çš„å¤„ç†ä¸æ•æ„Ÿ.
   - ä¸æ”¯æŒåŠ¨æ€è°ƒæ•´, é»˜è®¤ MTU é€šå¸¸ä¸º 1500 å­—èŠ‚, é€‚ç”¨äºä¸€èˆ¬ä»¥å¤ªç½‘ä¼ è¾“.

2. **ä¸‰å±‚äº¤æ¢æœºä¸­çš„ MTU**
   - åœ¨ç½‘ç»œå±‚å¤„ç† MTU æ—¶, æ”¯æŒåŠ¨æ€è°ƒæ•´æˆ–å‘Šè­¦ (å¦‚ ICMP "Fragmentation Needed" æ¶ˆæ¯) .
   - æ”¯æŒæ›´é«˜ MTU (å¦‚ Jumbo Frame, é€šå¸¸ä¸º 9000 å­—èŠ‚) , å¯å‡å°‘åˆ†ç‰‡å¼€é”€, æå‡ç½‘ç»œä¼ è¾“æ•ˆç‡.
   - æ›´é€‚åˆé«˜æ€§èƒ½ç½‘ç»œç¯å¢ƒ, å¦‚æ•°æ®ä¸­å¿ƒæˆ–å­˜å‚¨ä¼ è¾“.

**é€‚ç”¨åœºæ™¯**

1. **äºŒå±‚äº¤æ¢æœº**:

   - å°å‹ç½‘ç»œä¸­è®¾å¤‡äº’è”.
   - åªéœ€è¦åœ¨å•ä¸€ VLAN å†…é€šä¿¡æ—¶.
   - é€‚ç”¨äºé¢„ç®—æœ‰é™çš„ç®€å•ç½‘ç»œéœ€æ±‚.

2. **ä¸‰å±‚äº¤æ¢æœº**:
   - éœ€è¦è·¨å­ç½‘é€šä¿¡æˆ–è·¨ VLAN æ•°æ®è½¬å‘æ—¶.
   - ä¸­å¤§å‹ç½‘ç»œä¸­, å‡å°‘è·¯ç”±å™¨çš„ä½¿ç”¨, ä¼˜åŒ–æ€§èƒ½.
   - éœ€è¦éš”ç¦»å¹¿æ’­åŸŸä»¥é™ä½ç½‘ç»œè´Ÿè½½æ—¶.

æ‰€ä»¥å®¶ç”¨ä¸‡å…†çš„è¯, äºŒå±‚ç®¡ç†å‹äº¤æ¢æœºæ˜¯æœ€åŸºæœ¬çš„ç¡¬ä»¶é…ç½®.

#### äº§å“é€‰æ‹©

| å‚å•†     | å‹å·                                                                     | ç½‘å£                                            | ç®¡ç†ç±»å‹ | å…¨æ–°ä»·æ ¼ | äºŒæ‰‹ä»·æ ¼ |
| -------- | ------------------------------------------------------------------------ | ----------------------------------------------- | -------- | -------- | -------- |
| TP-LINK  | [**TL-ST5008F**](https://item.jd.com/10024251834106.html)                | 8 ä¸ª 10G å…‰å£ + Management + RJ45 Console å£    | L3       | 1723     | 500+     |
| TP-LINK  | [**TL-ST2408PB**](https://item.jd.com/10126311926070.html)               | 4 ä¸ª 10G ç”µå£(PoE) + 4 ä¸ª 10G å…‰å£              | äº‘ç®¡ç†   | 1999     | æ—        |
| å…®å…‹     | [**SKS7300-4X4T**](https://item.jd.com/10099747620725.html)              | 4 ä¸ª 10G ç”µå£ + 4 ä¸ª 10G å…‰å£ + RJ45 Console å£ | L2       | 1379     | 1000+    |
| å…®å…‹     | [**SKS8310-8X**](https://item.jd.com/10083994814588.html)                | 8 ä¸ª 10G å…‰å£ + RJ45 Console å£                 | L3       | 749      | æ—        |
| å…®å…‹     | [**SKS8300-8X**](https://item.jd.com/10083994814588.html)                | 8 ä¸ª 10G å…‰å£ + RJ45 Console å£                 | L3       | 899      | 600+     |
| å¸ŒåŠ›å¨è§† | [**SR-ST1808F**](https://item.jd.com/10125095659788.html#crumb-wrap)     | 8 ä¸ª 10G å…‰å£                                   | L3       | 599      | æ—        |
| å¸ŒåŠ›å¨è§† | [**SR-ST3408F**](https://item.jd.com/10128375525835.html)                | 4 ä¸ª 10G ç”µå£ + 4 ä¸ª 10G å…‰å£ + RJ45 Console å£ | L3       | 1139     | 800+     |
| å¸ŒåŠ›å¨è§† | [**SR-ST3808F**](https://item.jd.com/10090059711123.html#product-detail) | 8 ä¸ª 10G å…‰å£ + RJ45 Console å£                 | L3       | 699      | 400+     |
| æµ·æ€è§†è®¯ | [**F1100W-4SX-4XGT**](https://item.jd.com/10111892530726.html)           | 4 ä¸ª 10G ç”µå£ + 4 ä¸ª 10G å…‰å£                   | è½»ç®¡ç†å‹ | 1159     | æ—        |
| æµ·æ€è§†è®¯ | [**F1100W-8SX-SE**](https://item.jd.com/10095788058472.html)             | 8 ä¸ª 10G å…‰å£ + RJ45 Console å£                 | è½»ç®¡ç†å‹ | 499      | æ—        |

ä¸Šé¢è¿™äº›æ˜¯æ¯”è¾ƒå¸¸è§ä¸”ç¬¦åˆéœ€æ±‚çš„ä¸‡å…†äº¤æ¢æœº, å…¶ä»–çš„å“ç‰Œæ²¡æœ‰ä½¿ç”¨è¿‡ä¸æ˜¯å¾ˆäº†è§£.

4 å…‰ + 4 ç”µ çš„æ–¹æ¡ˆåº”è¯¥æ˜¯æœ€åˆé€‚çš„, ä½†æ˜¯äºŒæ‰‹ä»·æ ¼è¿˜æ˜¯å±…é«˜ä¸ä¸‹, æ‰€ä»¥åœ¨å¯¹æ¯”åæœ€ç»ˆé€‰æ‹©äº† TP-LINK çš„ [**TL-ST5008F**](https://www.tp-link.com.cn/product_1649.html), äºŒæ‰‹ä»·æ ¼è¿˜èƒ½æ¥å—, ä¸”æ˜¯ä¸‰å±‚ç®¡ç†å‹äº¤æ¢æœº, å¯ç©æ€§æ›´é«˜.

---

## MBP ä¸‡å…†æœ€ç»ˆæ–¹æ¡ˆ

### é¦–é€‰æ–¹æ¡ˆ

å‰é¢ [MBP ä¸‡å…†å‚è€ƒæ–¹æ¡ˆ](#MBP-ä¸‡å…†å‚è€ƒæ–¹æ¡ˆ) ä¸­ä¸€ç›´å­˜åœ¨äº›è®¸é¡¾è™‘: ä¸€æ˜¯ MBP èŠ¯ç‰‡å’Œç³»ç»Ÿè·Ÿæˆ‘ä¸ä¸€æ ·, äºŒæ˜¯æˆ‘éœ€è¦åŒå…‰å£ä¸‡å…†ç½‘å¡, ä¸Šè¿°æ–¹æ¡ˆæ²¡æœ‰ç»™åˆ°æˆ‘æ˜¯å¦å…¼å®¹.

å¦‚æœæ— æ³•é©±åŠ¨è¯¥ç½‘å¡, å¯èƒ½éœ€è¦å€ŸåŠ© [SmallTree](https://small-tree.com/) çš„é©±åŠ¨æ¥è§£å†³. ç„¶è€Œ, è¿™æ„å‘³ç€æˆ‘å¯èƒ½éœ€è¦ä¿®æ”¹é©±åŠ¨çš„ PID å’Œ VID æ‰èƒ½æ­£å¸¸å·¥ä½œ, è¿™æ„Ÿè§‰æœ‰ç‚¹å¤æ‚. æ­¤å¤–, å¦‚æœç³»ç»Ÿå‡çº§å¯¼è‡´æ— æ³•è¯†åˆ«ç½‘å¡, æˆ‘å°†ä¸å¾—ä¸å†æ¬¡è¿›è¡Œä¿®æ”¹.

æ‰€ä»¥æˆ‘æ›´å€¾å‘äºåœ¨ M1 ç³»åˆ—çš„ MBP ä¸Šèƒ½å¤Ÿå…é©±çš„ç½‘å¡.

å¥½åœ¨äº†è§£äº†å¤§è‡´çš„æ–¹æ¡ˆä»¥åŠå¯¹ [MBP åŸç”Ÿç½‘å¡é©±åŠ¨çš„äº†è§£](#MBP-ç½‘å¡é©±åŠ¨) åç»“åˆä»–äººæˆåŠŸçš„æ¡ˆä¾‹, æœ€ç»ˆæ•²å®šäº†é¦–é€‰æ–¹æ¡ˆ:

- ä½¿ç”¨é›·ç”µæ‰©å±•å (**JHL7540**) æ–¹æ¡ˆ(ä»·æ ¼ 345);
- ä½¿ç”¨ Intel X520-DA2 åŒå…‰å£ä¸‡å…†ç½‘å¡(82599 èŠ¯ç‰‡, ä»·æ ¼ 80);

12V DC ç”µæºå’Œé›·é›³ 3 çº¿ç¼†å®¶é‡Œéƒ½ç”¨, å°±ä¸ç®—åˆ°æˆæœ¬é‡Œé¢äº†.

> ä¸è¦å»æœ ç™½è‹¹æœ+X520, ä»·æ ¼ä¼šé«˜å‡ºå¾ˆå¤š.

![20241229154732_B04TcIao.webp](https://cdn.dong4j.site/source/image/20241229154732_B04TcIao.webp)

çœ‹ä¸­çš„æ˜¯å…·å¤‡ä¸‹è¡Œé›·é›³æ¥å£, å¯ä»¥ç»„èŠèŠ±é“¾ç©ç©.

### å¤‡é€‰æ–¹æ¡ˆ

- [ITGZ USB4.0 ç§»åŠ¨é›·é›³ 4 ç¡¬ç›˜ç›’](https://item.jd.com/10113618108196.html)(239);
- M2 NVME è½¬ PCIe è½¬æ¥æ¿(15);
- 12V DC è½¬ SATA ä¾›ç”µçº¿(16);
- Intel X520-DA2 ä¸‡å…†ç½‘å¡ (80);

![20241229154732_dogEZEPL.webp](https://cdn.dong4j.site/source/image/20241229154732_dogEZEPL.webp)

æƒ³å¯¹ 2 ç§æ–¹æ¡ˆåšä¸ªå¯¹æ¯”, å³ä½¿å¤‡é€‰æ–¹æ¡ˆå¤±è´¥æˆ–è¾¾ä¸åˆ°è¦æ±‚, ä¹Ÿèƒ½å°†ç¡¬ç›˜ç›’ç»™ Mac mini M2 ä½¿ç”¨.

## ç½‘ç»œæ‹“æ‰‘

### ç°çŠ¶

æˆ‘å…ˆæ¢³ç†ä¸€ä¸‹äº¤æ¢æœºå’Œè®¾å¤‡çš„æ€»ä½“æƒ…å†µ:

![network-status-info-now.drawio.svg](https://cdn.dong4j.site/source/image/network-status-info-now.drawio.svg)

- Mac mini 2018 å’Œ Mac mini M2 è‡ªå¸¦ 10G ç”µå£;
- DS923+ å’Œ Mac mini 2018 ç»„äº†ä¸‡å…†ç½‘ç»œ, å…¶ä»–è®¾å¤‡å…¨éƒ¨ä½¿ç”¨ 2.5G ç½‘å£è¿æ¥(10G å£ä¸å¤Ÿ);
- Station çš„ 10G ç”µå£è·‘æ­¥æ»¡ä¸‡å…†, å› ä¸ºä¸‡å…†ç½‘å£ä¸å¤Ÿ, åªèƒ½è·‘åœ¨ 2.5G å¸¦å®½ä¸‹;
- M920x çš„ 2 ä¸ª 10G å…‰å£é€šè¿‡ DAC åˆ†åˆ«è¿æ¥åˆ°ç”µä¿¡å’Œè”é€šç½‘ç»œ, ä½†ä¹Ÿåªæ˜¯ 2.5G;

ç›®å‰çš„ç°çŠ¶æ€»ç»“ä¸€ä¸‹å°±æ˜¯: å…·å¤‡ä¸‡å…†å¸¦å®½èƒ½åŠ›çš„è®¾å¤‡å› ä¸ºäº¤æ¢æœºçš„é—®é¢˜, æœ€é«˜åªèƒ½ä½¿ç”¨ 2.5G å¸¦å®½, ä¸‡å…†ç½‘ç»œä»…é™äº NAS å’Œ Mac mini 2018, æ— æ³•æ»¡è¶³å…¶ä»–è®¾å¤‡çš„ä¸‡å…†éœ€æ±‚.

### è§„åˆ’

![network-status-info.drawio.svg](https://cdn.dong4j.site/source/image/network-status-info.drawio.svg)

- æ·»åŠ ä¸€å°ä¸‡å…†äº¤æ¢æœº, å°†ä¹¦æˆ¿æ‰€æœ‰æ”¯æŒä¸‡å…†çš„è®¾å¤‡äº’è”(ä¸‡å…†äº¤æ¢æœºå·²ç¡®è®¤ä¸º TP-LINK çš„ [**TL-ST5008F**](https://www.tp-link.com.cn/product_1649.html));
- ç”µä¿¡ç½‘ç»œä½œä¸º **ä¸‡å…†ä¸»å¹²ç½‘**, ç”µä¿¡åé¢ 2.5G äº¤æ¢æœºçš„ 10G å…‰å£éœ€è¦è¿æ¥åˆ°ä¸‡å…†äº¤æ¢æœº, å› ä¸ºè·ç¦»è¾ƒçŸ­, ç›´æ¥ä½¿ç”¨ M920x ä¸Šçš„ DAC çº¿ç¼†è¿æ¥;
- DS923+ å’Œ Mac mini 2018 é€šè¿‡åŸæ¥çš„å…‰æ¨¡å—è¿æ¥åˆ°ä¸‡å…†äº¤æ¢æœº, æ–°å¢ 1 ä¸ªå…‰è½¬ç”µæ¨¡å—ç»™ Mac mini M2 è¿æ¥åˆ°ä¸‡å…†äº¤æ¢æœº, 3 å°è®¾å¤‡å…¶ä»–ç½‘å£è¿æ¥åˆ°è”é€šçš„ 2.5G ç½‘ç»œ;
- MBP å’Œ Station é…ç½® [Intel X520-DA2](http://www.intel-china.com/info72.html) ç½‘å¡ , åˆ†åˆ«è¿æ¥åˆ°ç”µä¿¡å’Œè”é€šä¸‡å…†ç½‘ç»œ, ç”µä¿¡ç½‘ç»œå…¨è®¾å¤‡ä¸‡å…†, è”é€šç½‘ç»œåªæœ‰ MBP å’Œ Station èƒ½å¤Ÿä¸‡å…†ç›´è¿;
- M920x åŸæ¥å‰©ä¸‹çš„ä¸€æ ¹ DAC çº¿ç¼†è¿æ¥è¿æ¥ä¸‡å…†äº¤æ¢æœº, ä¸å…¶ä»–è®¾å¤‡ç»„æˆä¸‡å…†å±€åŸŸç½‘, å¦ä¸€ä¸ªä¸‡å…†å…‰å£é€šè¿‡å…‰çº¤+å…‰æ¨¡å—è¿æ¥è”é€šåé¢ 2.5G äº¤æ¢æœºä¸Šçš„ 10G å…‰å£ä»¥æ¥å…¥è”é€šç½‘ç»œ;

å°†ç”µä¿¡ä½œä¸ºä¸‡å…†ä¸»å¹²ç½‘, **å¹¶å°†å„è®¾å¤‡çš„ç”µä¿¡ç½‘å¡ä½œä¸ºç¬¬ä¸€ä¼˜å…ˆçº§**, å¹³æ—¶åœ¨å„è®¾å¤‡å…±äº«æ–‡ä»¶æ—¶å°±èƒ½ç”¨ä¸Šä¸‡å…†ç½‘ç»œ. è”é€šä½œä¸ºå¤‡ç”¨ç½‘ç»œ, å…¨è®¾å¤‡æœ€ä½ä¹Ÿæ˜¯ 2.5G é€Ÿåº¦.

### è®¾å¤‡è´­ä¹°

æ¢³ç†ä¹‹åæ‰€éœ€è¦çš„è®¾å¤‡æ¸…å•ä¸º:

| è®¾å¤‡åç§°                                                            | è§„æ ¼                        | æ•°é‡ | å•ä»· | å¤‡æ³¨                                     |
| ------------------------------------------------------------------- | --------------------------- | ---- | ---- | ---------------------------------------- |
| [**TL-ST5008F V2.0**](https://www.tp-link.com.cn/product_1649.html) | 8 ä¸ª 10G å…‰å£               | 1    | 580  | å…·å¤‡ä¸‰å±‚ç½‘ç»œç®¡ç†åŠŸèƒ½(éœ€è¦ä¿®æ”¹ MTU ç”¨)    |
| å…‰è½¬ç”µæ¨¡å—                                                          | ä¸‡å…†                        | 1    | 120  | Mac mini M2 ä½¿ç”¨                         |
| ä¸‡å…†ç½‘å¡                                                            | Intel X520-DA2              | 2    | 80   | MBP, Station å„ä¸€å¼                       |
| å…‰çº¤                                                                | å¤šæ¨¡åŒèŠ¯ OM3, LC å‹å…‰çº¤æ¥å£ | 5    | 5    | `2 * 1 ç±³, 1 * 2 ç±³, 2 * 5 ç±³` å…±è®¡ 5 æ¡ |
| å…‰æ¨¡å—                                                              | SFP-10G-SR                  | 10   | 9    | ä¸€æ¡å…‰çº¤ 2 ä¸ªå…‰æ¨¡å—                      |
| é›·ç”µæ‰©å±•å                                                          | JHL7540 ä¸»æ§                | 1    | 345  | [MBP ä¸‡å…†é¦–é€‰æ–¹æ¡ˆ](#é¦–é€‰æ–¹æ¡ˆ) æ ¸å¿ƒè®¾å¤‡   |
| ITGZ USB4.0 ç§»åŠ¨é›·é›³ 4 ç¡¬ç›˜ç›’                                       | ASM2464PD ä¸»æ§              | 1    | 239  | [MBP ä¸‡å…†å¤‡é€‰æ–¹æ¡ˆ](#å¤‡é€‰æ–¹æ¡ˆ) æ ¸å¿ƒè®¾å¤‡   |
| M2 NVME è½¬ PCIe è½¬æ¥æ¿                                              | -                           | 1    | 15   | [MBP ä¸‡å…†å¤‡é€‰æ–¹æ¡ˆ](#å¤‡é€‰æ–¹æ¡ˆ) é…ä»¶       |
| 12V DC è½¬ SATA ä¾›ç”µçº¿                                               | -                           | 1    | 16   | [MBP ä¸‡å…†å¤‡é€‰æ–¹æ¡ˆ](#å¤‡é€‰æ–¹æ¡ˆ) é…ä»¶       |

è¿™æ¬¡å‡çº§çš„æ€»æˆæœ¬ä¸º **1590**, æ¯”ç›´æ¥ä¹°ä¸€ä¸ªé«˜ç«¯æˆå“ä¸‡å…†ç½‘å¡ä¾¿å®œ, è€Œä¸”è¿˜èƒ½å°†ä¸»è¦è®¾å¤‡å…¨éƒ¨å‡çº§æˆä¸‡å…†, æ„Ÿè§‰è¿˜æ˜¯æŒºåˆ’ç®—çš„.

**ä¸ºä»€ä¹ˆä¸å…¨éƒ¨ä½¿ç”¨ DAC/AOC çº¿ç¼†**

æˆ‘çš„ä¸‡å…†è®¾å¤‡éƒ½åœ¨ä¹¦æˆ¿, æœ€ä¼˜è§£è¿˜æ˜¯ DAC çº¿ç¼†, è·ç¦»è‚¯å®šæ²¡æœ‰é—®é¢˜(æœ€é•¿æ”¯æŒ 10 ç±³), é—®é¢˜æ˜¯ DAC çš„çº¿ç¼†ç›¸å¯¹äºå…‰çº¤å¤ªç²—å¤ªç¡¬, å¯¹äºæˆ‘ç°åœ¨çš„å¸ƒçº¿ç¯å¢ƒä¸æ˜¯ç‰¹åˆ«å¥½å¤„ç†, è€Œ AOC çº¿ç¼†åœ¨ M920x è¿æ¥ä¸‡å…†å…‰å£æ—¶å·²ç»å°è¯•è¿‡ä¸€æ¬¡, è¿˜æ˜¯å­˜åœ¨å…¼å®¹æ€§é—®é¢˜, æ‰€ä»¥æ”¾å¼ƒäº†.

æœ€ä¸»è¦çš„åŸå› æ˜¯æƒ³å°è¯•ä¸€ä¸‹å…‰çº¤+å…‰æ¨¡å—çš„æ–¹æ¡ˆ, é¡ºå¸¦è¿˜å¯ä»¥å­¦ä¹ äº†è§£ä¸‹å…‰çº¤ç›¸å…³çš„æŠ€æœ¯.

## æ–½å·¥ç¯èŠ‚

### ç¡¬ä»¶

#### åŠ è£…æ•£çƒ­

ç»™ MBP å’Œ Station ä½¿ç”¨çš„ Intel X520-DA2 ç½‘å¡è¿˜æ˜¯æœ‰å¿…è¦åŠ ä¸Šæ•£çƒ­é£æ‰‡çš„, Station æ˜¯å¼€æ”¾å‹æœºç®±, æ²¡æœ‰å¯é çš„é£é“å¯ä»¥æ•£çƒ­, MBP å°±æ›´ä¸ç”¨è¯´äº†, åªèƒ½å¤–ç½®.

è¿˜å¥½æœ‰å‡ ä¸ªå‰©ä½™çš„ 4x4 CM é£æ‰‡, æ€¼ä¸Šå»å°±å¯ä»¥äº†, ç›´æ¥ç”¨ USB ä¾›ç”µ:

![20241229154732_5d1B0sxN.webp](https://cdn.dong4j.site/source/image/20241229154732_5d1B0sxN.webp)

ç»™ Station ç”¨çš„ç½‘å¡å°±éº»çƒ¦ç‚¹, ç”¨çš„æ˜¯åŸæ¥ç»™æµªæ½® X540 é…ç½®çš„é£æ‰‡, ä½†æ˜¯ä¾›ç”µçº¿å¤ªçŸ­äº†, éœ€è¦å¤–æ¥.

![20241229154732_AbELRDHT.webp](https://cdn.dong4j.site/source/image/20241229154732_AbELRDHT.webp)

ç”¨ç©æ ‘è“æ´¾æ—¶è´­ä¹°çš„ 2PIN 2.54 æœé‚¦çº¿æ¥å»¶é•¿ä¸€ä¸‹ä¾›ç”µçº¿, å¥—ä¸Šçƒ­ç¼©ç®¡åšç»ç¼˜:

![20241229154732_DBPlTyiV.webp](https://cdn.dong4j.site/source/image/20241229154732_DBPlTyiV.webp)

ç»™ç‚¹ç”µå°±è½¬, å®Œç¾:

![20241229154732_QDMi9akU.webp](https://cdn.dong4j.site/source/image/20241229154732_QDMi9akU.webp)

ä¸Šæœºæ•ˆæœ:

![20241229154732_ogS0vWp9.webp](https://cdn.dong4j.site/source/image/20241229154732_ogS0vWp9.webp)

é¡ºä¾¿ç»™äº¤æ¢æœºåŠ ä¸ª `80x80cm` çš„æ•£çƒ­é£æ‰‡, åæ­£ç©ºä½™çš„æ•£çƒ­é£æ‰‡è¿˜æœ‰å¾ˆå¤š:

![20241229154732_xH9BEfD5.webp](https://cdn.dong4j.site/source/image/20241229154732_xH9BEfD5.webp)

#### MBP ç½‘å¡éƒ¨ç½²

å°å·§çš„**é›·é›³æ‹“å±•å**, è‡ªå¸¦ä¸€ä¸ªæ•£çƒ­ç‰‡, æ¡Œé¢ä¸‹æ­£å¥½ç•™æœ‰ä¸€ä¸ª 12V DC ä¾›ç”µçº¿, çœå»äº†ä¾›ç”µçº¿.

![20241229154732_tnUUaqSL.webp](https://cdn.dong4j.site/source/image/20241229154732_tnUUaqSL.webp)

ç»„åˆåçš„æ ·å­, åŠ äº† 2 æ ¹æ‰å¸¦å›ºå®šä¸€ä¸‹, çœå»äº†ä¸€ä¸ª 3D æ‰“å°æ”¯æ¶:

![20241229154732_jxzfqHSe.webp](https://cdn.dong4j.site/source/image/20241229154732_jxzfqHSe.webp)

æœ€åå®‰è£…å¥½çš„æ ·å­, å¹³æ—¶åŸºæœ¬ä¸Šä¸ç”¨åŠ¨å®ƒ. ç”¨ä¸€æ ¹é›·é›³ 3 çš„çº¿è¿æ¥åˆ° MBP, å‰©ä¸‹çš„ä¸‹è¡Œé›·é›³æ¥å£è¿˜æœªä½¿ç”¨, åæ­£ä¸èƒ½ç”¨è¿™ä¸ªé›·é›³æ¥å£è¿æ¥åˆ° Mac mini M2 ä¸Šç»„èŠèŠ±é“¾, ä¼šå­˜åœ¨äº‰æŠ¢ç½‘å¡çš„æƒ…å†µ:

![20241229154732_kz1hANjj.webp](https://cdn.dong4j.site/source/image/20241229154732_kz1hANjj.webp)

---

**ä¸‹é¢æ˜¯ä½¿ç”¨ USB4.0 ç§»åŠ¨ç¡¬ç›˜ç›’:**

![20241229154732_C5gKdVBT.webp](https://cdn.dong4j.site/source/image/20241229154732_C5gKdVBT.webp)

![20241229154732_161F7l0y.webp](https://cdn.dong4j.site/source/image/20241229154732_161F7l0y.webp)

è¯´å®è¯, é“è´¨çš„ç§»åŠ¨ç¡¬ç›˜ç›’åŠ ä¸Šç½‘å¡ç¡®å®æ¯”ç¬¬ä¸€ç§æ–¹æ¡ˆè¦å¥½çœ‹é‚£ä¹ˆä¸€ç‚¹.

#### éƒ¨ç½²äº¤æ¢æœº

ä½¿ç”¨æ‰å¸¦å®‰è£…åˆ°æ¡Œåº•çš„å¯¼çº¿æ§½ä¸‹é¢, Micro USB Console ç«¯å£è¿æ¥åˆ° MBP æ‹“å±•åä¸Šé¢.

è¿™æ˜¯éƒ¨ç½²å®Œæˆåçš„æ ·å­, å…‰è½¬ç”µæ¨¡å—åŠ è£…äº†æ•£çƒ­é³ç‰‡, ä¸‹é¢çš„é£æ‰‡ç¨å¾®æœ‰ç‚¹é£å°±èƒ½å¸¦èµ°çƒ­é‡(å™ªéŸ³å®Œå…¨å¯ä»¥å¿½ç•¥, å› ä¸ºé£æ‰‡æ”¯æŒå¯å˜ç”µå‹, ç°åœ¨ç»™çš„ç”µå‹ä¿è¯èƒ½è½¬å°±è¡Œ, å¤å¤©çš„è¯å™ªéŸ³åº”è¯¥ä¼šå¤§ä¸€ç‚¹).

![20241229154732_GBqY52mh.webp](https://cdn.dong4j.site/source/image/20241229154732_GBqY52mh.webp)

#### å…‰çº¤å¸ƒçº¿

äº†è§£å…‰çº¤å’Œå…‰æ¨¡å—çš„ç±»å‹å, ç›´æ¥ä¹°çš„å¤šæ¨¡åŒèŠ¯çš„ OM3 å…‰çº¤, LC-LC æ¥å£:

![20241229154732_71Q9MNM4.webp](https://cdn.dong4j.site/source/image/20241229154732_71Q9MNM4.webp)

äºŒæ‰‹çš„ Intel å¤šæ¨¡å…‰æ¨¡å—, ä»·æ ¼ä¾¿å®œ:

![20241229154732_JnVZWyq7.webp](https://cdn.dong4j.site/source/image/20241229154732_JnVZWyq7.webp)

å…‰çº¤ä¸å…‰æ¨¡å—è¿æ¥, è¿˜é—¹äº†ä¸ªç¬‘è¯, ä¸çŸ¥é“ LC æ¥å£è¿˜æœ‰ä¸€ä¸ªä¿æŠ¤å£³, ä¸€ç›´çº³é—·ä¸ºå•¥æ’ä¸ç¨³. æ— æ„ä¸­æ°äº†ä¸‹ LC æ¥å£çš„å¤´å­, å‘ç°å±…ç„¶æ˜¯ä¸ªä¿æŠ¤å£³ ğŸ¥².

![20241229154732_ZNIlNeEH.webp](https://cdn.dong4j.site/source/image/20241229154732_ZNIlNeEH.webp)

### è½¯ä»¶

#### ä¸‡å…†äº¤æ¢æœº

[TL-ST5008F V2.0å®‰è£…æ‰‹å†Œ1.1.2](https://service.tp-link.com.cn/download/202110/TL-ST5008F V2.0å®‰è£…æ‰‹å†Œ 1.1.2.pdf)

{% pdf https://service.tp-link.com.cn/download/202110/TL-ST5008F%20V2.0%E5%AE%89%E8%A3%85%E6%89%8B%E5%86%8C%201.1.2.pdf %}

##### ç½‘å£è¿æ¥

**TL-ST5008F** çš„ ä¸šåŠ¡ç«¯å£é»˜è®¤ IP ä¸º `192.168.0.1`, æ‰€ä»¥ä¿®æ”¹ä¸ºåŒç½‘æ®µçš„ IP å³å¯è®¿é—® Web ç®¡ç†ç«¯.

è¿æ¥ä»»æ„ç½‘å£, ç„¶åè®¾ç½® IP åœ°å€:

![20241229154732_S3nJ9Svk.webp](https://cdn.dong4j.site/source/image/20241229154732_S3nJ9Svk.webp)

ä½¿ç”¨ `http://192.168.0.1/` è®¿é—® Web ç®¡ç†ç«¯:

![20241229154732_7Aai7tAn.webp](https://cdn.dong4j.site/source/image/20241229154732_7Aai7tAn.webp)

##### Management ç«¯å£è¿æ¥

**TL-ST5008F** è¿˜æä¾›ä¸€ä¸ª Management ç®¡ç†å£, é»˜è®¤ IP åœ°å€ï¼š `10.20.30.40`. å½“ç”µè„‘è¿æ¥äº¤æ¢æœºç®¡ç†å£æ—¶, éœ€è®¾ç½®ç”µè„‘ IP åœ°å€ä¸ºï¼š`10.20.30.x`(`x` ä¸º 1-254 é—´ä»»æ„å€¼, ä¸èƒ½ä¸º 40), å­ç½‘æ©ç è®¾ç½®ä¸º 255.255.255.0.

##### Console ç«¯å£è¿æ¥

Console ç«¯å£ç”¨äºå’Œè®¡ç®—æœºæˆ–å…¶ä»–ç»ˆç«¯çš„ä¸²å£ç›¸è¿ä»¥ç®¡ç†æˆ–é…ç½®äº¤æ¢æœº. **TL-ST5008F** æä¾› 1 ä¸ª Micro USB Console ç«¯å£å’Œ 1 ä¸ª RJ45 Console ç«¯å£, ä¸¤ä¸ªç«¯å£ ä¸èƒ½åŒæ—¶ä½¿ç”¨, åŒæ—¶è¿æ¥æ—¶åªæœ‰ Micro USB Console ç«¯å£ç”Ÿæ•ˆ.

ä½¿ç”¨ä¸²å£è¿æ¥, å‚æ•°å¦‚ä¸‹:

- æ³¢ç‰¹ç‡ï¼š TL-ST5012/TL-ST5008 æ³¢ç‰¹ç‡ä¸º 38400bpsï¼›
- TL-ST5016F æ³¢ç‰¹ç‡ä¸º 115200bps æ•°æ®ä½ï¼š
- 8 ä½ å¥‡å¶æ ¡éªŒï¼šæ— 
- åœæ­¢ä½ï¼š1 ä½
- æ•°æ®æµæ§åˆ¶ï¼šæ— 

ä¸çŸ¥é“æ˜¯ä¸æ˜¯æ²¡æœ‰ç›´æ¥è¿æ¥åˆ° MBP(ä¸­é—´é€šè¿‡æ‹“å±•åé“¾æ¥), `ls /dev/cu.*` å¹¶æ²¡æœ‰äº¤æ¢æœºçš„è®¾å¤‡æ–‡ä»¶, åé¢å†å°è¯•ç›´è¿.

<!-- todo: æš‚æœªè¿æ¥æˆåŠŸ -->

##### tenlet è¿æ¥

![20241229154732_EcylLGlc.webp](https://cdn.dong4j.site/source/image/20241229154732_EcylLGlc.webp)

ç»“æŸè¿œç¨‹ä¼šè¯:

```bash
TL-ST5008F>exit
```

é€€å‡º telnet:

```
# åœ¨ Telnet ä¼šè¯ä¸­, æŒ‰ä¸‹ Ctrl + ] é”®, è¿™å°†å¸¦æ‚¨å›åˆ° Telnet çš„å‘½ä»¤æç¤ºç¬¦.
# åœ¨ Telnet å‘½ä»¤æç¤ºç¬¦ä¸‹, è¾“å…¥ quit å‘½ä»¤, ç„¶åæŒ‰å›è½¦é”®, å³å¯é€€å‡º Telnet ä¼šè¯.
telnet> quit
# æˆ–è€…
telnet> close
```

##### è¿œç¨‹ç®¡ç†

ä¹Ÿæ²¡æœ‰è¿æ¥æˆåŠŸ, ä¸€ç›´æç¤º **è®¾å¤‡æœªåœ¨çº¿**, åé¢å†å¤„ç†.

<!-- todo: æç¤ºæœªåœ¨çº¿ -->

##### MTU è®¾ç½®

**æŒ‰ç†è¯´è¿™ä¸ªæ˜¯å®æ—¶ç”Ÿæ•ˆçš„, ç»“æœå´æ˜¯éœ€è¦é‡å¯ä¸€ä¸‹äº¤æ¢æœºæ‰èƒ½ç”Ÿæ•ˆ**.

![20241229154732_gIa5QUb9.webp](https://cdn.dong4j.site/source/image/20241229154732_gIa5QUb9.webp)

**2025-02-16 æ›´æ–°**

å› ä¸ºå¿˜äº¤ç”µè´¹å¯¼è‡´å®¶é‡Œåœç”µ, æ¥ç”µä¹‹åå‘ç° DS923+ äºäº¤æ¢æœºåªèƒ½åå•†åˆ° 5G é€Ÿåº¦, åæ¥æŸ¥é˜…èµ„æ–™åå°†å…‰è½¬ç”µæ¨¡å—çš„ç½‘å£å…¨éƒ¨å¼ºåˆ¶è®¾ç½®ä¸º 10G é€Ÿåº¦, è¿™æ ·å°±å¯ä»¥äº†.

> [åœŸå‘³çš„å®¶ç”¨ä¸‡å…†ç½‘ç»œTP-LINKå‚TL-ST5008Få…‰å£å…¨ä¸‡å…†äº¤æ¢æœºå¼€ç®±](https://www.chiphell.com/forum.php?mobile=0&mod=viewthread&ordertype=1&tid=2244916)
>
> äº¤æ¢æœºçš„é»˜è®¤è®¾ç½®æ˜¯å…¨10Gåå•†ï¼Œä½ å¯ä»¥æ”¹æˆAutoå’Œ10Gã€1000Mã€100Mã€10Mä¾æ¬¡ã€‚æ³¨æ„å¦‚æœç”¨å…‰è½¬ç”µå£æ¨¡å—æ¥è·¯ç”±å™¨çš„è¯å—ï¼Œä¸€å®šè¦æŠŠç«¯å£åå•†é€Ÿåº¦è®¾ç½®æˆ1000Mï¼Œä¸èƒ½ç”¨Autoï¼ï¼ï¼

ç¬¬äºŒä¸ªé—®é¢˜æ˜¯äº¤æ¢æœºæœ¬èº«è”ç½‘çš„é—®é¢˜, æˆ‘å°† **TL-ST5008F** çš„ç³»ç»Ÿæ—¶é—´è·å–æ–¹å¼ä¿®æ”¹ä¸º **ä»NTPæœåŠ¡å™¨è·å–**, ä½†æ˜¯å´æ— æ³•è”ç½‘, å¦å¤–äº‘ç®¡ç†åŠŸèƒ½ä¹Ÿæ— æ³•ä½¿ç”¨, åº”è¯¥æ˜¯è®¾å¤‡æœ¬èº«æ²¡æœ‰è¿æ¥åˆ°äº’è”ç½‘.

æˆ‘è¿›è¡Œäº†å¦‚ä¸‹é…ç½®:

**ä¿®æ”¹ç®¡ç†å£ IP**

![20250216223021_OKPNk3PA.webp](https://cdn.dong4j.site/source/image/20250216223021_OKPNk3PA.webp)

**æ·»åŠ é™æ€**

![20250216173610_Zy1N0rWT.webp](https://cdn.dong4j.site/source/image/20250216173610_Zy1N0rWT.webp)

ç„¶åå°†ç®¡ç†å£é€šè¿‡ RJ45 è¿æ¥åˆ°è·¯ç”±å™¨, è¿™æ ·å°±å¯ä»¥é€šè¿‡ `192.168.31.58` ç™»å½•äº¤æ¢æœº Web æ§åˆ¶å°äº†.

#### MBP

**ç³»ç»Ÿè¯†åˆ«åˆ° PCI è®¾å¤‡**:

![20241229154732_G3LckVis.webp](https://cdn.dong4j.site/source/image/20241229154732_G3LckVis.webp)

**X520** çš„æ€»çº¿ç±»å‹æ˜¯ **PCIe 2.0 X8**, PCle 2.0 åè®®çš„æ¯ä¸€æ¡ Lane æ”¯æŒ `5 * 8 / 10 = 4 Gbps = 500 MB/s` çš„é€Ÿç‡, x4 ä¸€å…±å°±æ˜¯ 16Gbps, å®Œå…¨æ»¡è¶³ 10Gbps çš„å¸¦å®½.

> [PCIE2.0/PCIE3.0/PCIE4.0/PCIE5.0 æ¥å£çš„å¸¦å®½ã€é€Ÿç‡è®¡ç®—](https://blog.51cto.com/u_3619476/5145033)

---

ç½‘å¡çš„é›·é›³æ€»çº¿ä¿¡æ¯, æœ€é«˜æœ‰ 20Gb/s çš„é€Ÿåº¦(æŒ‰ç†è¯´ **JHL7540** æœ€é«˜åº”è¯¥æœ‰ 24 Gb/s):

![20241229154732_qqWePtcX.webp](https://cdn.dong4j.site/source/image/20241229154732_qqWePtcX.webp)

ä»¥å¤ªç½‘è®¾å¤‡ä¿¡æ¯:

![20241229154732_aSBYnbPI.webp](https://cdn.dong4j.site/source/image/20241229154732_aSBYnbPI.webp)

- `I225 LMVP` æ˜¯ CalDigit T4 çš„ 2.5G ç½‘å¡;
- ç„¶åæ˜¯ X520-DA2 2 ä¸ªå…‰å£ç½‘å¡;
- ç¬¬å››ä¸ªæ˜¯ USB è½¬ 2.5G ç½‘å¡;
- æœ€åä¸€ä¸ªæ˜¯å¦ä¸€ä¸ªæ‰©å±•åä¸Šé¢çš„ 1G ç½‘å¡;

---

æœ€åæ˜¯ç½‘ç»œè®¾ç½®ä¸­çš„ç¡¬ä»¶ä¿¡æ¯:

ç½‘å¡é€Ÿåº¦æ”¯æŒ **1000base-SX**(1 Gbps) å’Œ **10Gbase-SR**(10 Gbps), ä¸æ”¯æŒ 2.5G, è€Œä¸” MTU æœ€é«˜åªèƒ½è®¾ç½®åˆ° `2034`:

![20241229154732_OjgPuJcA.webp](https://cdn.dong4j.site/source/image/20241229154732_OjgPuJcA.webp)

---

**ä¸‹é¢æ˜¯ä½¿ç”¨ USB4.0 çš„ç¡¬ç›˜ç›’çš„ç¡¬ä»¶ä¿¡æ¯:**

åœ¨ MBP è¯†åˆ«å‡ºçš„é€Ÿåº¦æ˜¯ 20 Gb/s(å®‰è£…çš„ä¸‡å…†ç½‘å¡), è€Œåœ¨ Mac mini M2 ä¸Šåˆ™æ˜¯ 40Gb/s(å®‰è£…çš„ m.2 å›ºæ€):

![20241229154732_4l82CmVy.webp](https://cdn.dong4j.site/source/image/20241229154732_4l82CmVy.webp)

`Intel X520-DA2` ç½‘å¡æˆåŠŸè¯†åˆ«:

![20241229154732_RN2xdpyR.webp](https://cdn.dong4j.site/source/image/20241229154732_RN2xdpyR.webp)

#### Mac mini

Mac mini 2018 å’Œ Mac mini M2 çš„ç½‘å£éƒ½æ˜¯ä¸‡å…†ç”µå£, èƒ½å¤Ÿé¡ºåˆ©å¼€å¯ 9000 å·¨å¸§, ä¸”æ”¯æŒ `100M/1000M/2.5G/5G/10G` é€Ÿåº¦:

![20241229154732_BbX76D1A.webp](https://cdn.dong4j.site/source/image/20241229154732_BbX76D1A.webp)

#### Ubuntu

**ä¸‡å…†è®¾å¤‡å…¨éƒ¨æ¥å…¥åˆ°ç”µä¿¡ç½‘ç»œ, é¦–å…ˆéœ€è¦è°ƒæ•´ä¸€ä¸‹ç½‘å¡çš„ä¼˜å…ˆçº§.**

M920x(`192.168.31.77`) å’Œ Station(`192.168.31.66`) æ˜¯ Ubuntu ç³»ç»Ÿ, ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸‹è°ƒæ•´ç½‘å¡ä¼˜å…ˆçº§:

```bash
# é¦–å…ˆæŸ¥çœ‹ä¸€ä¸‹è·¯ç”±è¡¨
ip route

# å‡è®¾æˆ‘éœ€è¦è°ƒæ•´ç½‘å¡çš„ä¼˜å…ˆçº§ä¸º: 10G.T > 1G.T > 10G.U > 1G.U (2 ä¸ªæ–°å¢çš„ 10G ç½‘å¡, ç³»ç»Ÿè‡ªå¸¦çš„ 2 ä¸ª 1G ç½‘å¡)
sudo nmcli connection modify 10G.T ipv4.route-metric 100
sudo nmcli connection modify 1G.T ipv4.route-metric 200
sudo nmcli connection modify 10G.U ipv4.route-metric 300
sudo nmcli connection modify 1G.U ipv4.route-metric 400

# é‡å¯ NetworkManager
sudo systemctl restart NetworkManager
```

è®¾ç½® **MTU ä¸º 9000** å, æµ‹è¯•ä¸€ä¸‹åœ¨ä¸åˆ†åŒ…çš„æƒ…å†µä¸‹æ•´ä¸ªé“¾è·¯æ˜¯å¦èƒ½å¤„ç† 9000 å­—èŠ‚çš„æ•°æ®åŒ…:

```bash
$ ping -M do -s 8972 -c 2 192.168.31.66
PING 192.168.31.66 (192.168.31.66) 8972(9000) bytes of data.
8980 bytes from 192.168.31.66: icmp_seq=1 ttl=64 time=0.069 ms
8980 bytes from 192.168.31.66: icmp_seq=2 ttl=64 time=0.048 ms

--- 192.168.31.66 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 3048ms
rtt min/avg/max/mdev = 0.033/0.049/0.069/0.012 ms
```

> ä½¿ç”¨ `-M do` å‚æ•°æ—¶, ping ä¼šè®¾ç½® `Donâ€™t Fragment` (DF) æ ‡å¿—, è¦æ±‚æ•´ä¸ªæ•°æ®åŒ…ä¸èƒ½è¢«åˆ†æ®µ. å¦‚æœæ•°æ®åŒ…å¤§äºç½‘ç»œè·¯å¾„ä¸­çš„ä»»ä½•è®¾å¤‡çš„ MTU, ä¼ è¾“å°±ä¼šå¤±è´¥å¹¶è¿”å›é”™è¯¯.

æ¯”å¦‚:

```bash
$ ping -M do -s 8973 -c 2 192.168.31.77
PING 192.168.31.77 (192.168.31.77) 8973(9001) bytes of data.
ping: local error: message too long, mtu=9000
ping: local error: message too long, mtu=9000

--- 192.168.31.77 ping statistics ---
2 packets transmitted, 0 received, +2 errors, 100% packet loss, time 3077ms
```

> macOS ä¸Š `ping` æ²¡æœ‰ `-M do` å‚æ•°, æ­£ç¡®çš„æ–¹å¼åº”è¯¥æ˜¯: `ping -D -s 8972 192.168.31.66`

è¶…è¿‡äº† 9000 ç›´æ¥æŠ¥é”™.

è¿˜å¯ä»¥ä½¿ç”¨ `tracepath` æ¥è·å–æ•´ä¸ªé“¾è·¯çš„ MTU:

```bash
$ tracepath 192.168.31.77
 1?: [LOCALHOST]                      pmtu 9000
 1:  eab2b0924b06                                          0.400ms reached
 1:  eab2b0924b06                                          0.363ms reached
     Resume: pmtu 9000 hops 1 back 1
```

#### DS923+

å› ä¸ºåœ¨ä½¿ç”¨ [Synology Virtual Machine Manager ](https://www.synology.cn/zh-cn/dsm/feature/virtual_machine_manager), å®‰è£…äº† **Open vSwitch**, åœ¨ Web ç«¯ä¿®æ”¹ MTU 9000 åªæ˜¯ä¿®æ”¹ç‰©ç†ç½‘å¡, å¯¹åº”çš„è™šæ‹Ÿç½‘å¡è¿˜æ˜¯ 1500, æ‰€ä»¥éœ€è¦åœ¨å‘½ä»¤è¡Œä¸‹å»ä¿®æ”¹:

```bash
# æ˜¾ç¤º Open vSwitch çš„æ¥å£:
root@DS923:~# ovs-vsctl show
ac42c09b-b421-4802-9883-0b2b9bb93cc9
    Bridge "ovs_bond0"
        Port "ovs_bond0"
            Interface "ovs_bond0"
                type: internal
        Port "bond0"
            Interface "eth1"
            Interface "eth0"
    Bridge "ovs_eth2"
        Port "ovs_eth2"
            Interface "ovs_eth2"
                type: internal
        Port "eth2"
            Interface "eth2"
```

ä¸‡å…†ç½‘å¡å¯¹åº”çš„è™šæ‹Ÿç½‘å¡æ˜¯ `ovs_eth2`, ç‰©ç†ç½‘å¡ `eth2` MTU å·²ç»ä¿®æ”¹åˆ° 9000, åªéœ€è¦åŒæ­¥åˆ°è™šæ‹Ÿç½‘å¡å³å¯:

```bash
ip link set ovs_eth2 mtu 9000
```

æŸ¥çœ‹ç»“æœ:

```bash
ip addr show ovs_eth2
8: ovs_eth2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9000 qdisc noqueue state UP group default qlen 1
...
```

æœ€åæ˜¯æµ‹è¯•å…¨é“¾è·¯æ˜¯å¦éƒ½æ˜¯ 9000:

```bash
$ tracepath 192.168.31.2
 1?: [LOCALHOST]                      pmtu 9000
 1:  192.168.31.2                                         0.690ms reached
 1:  192.168.31.2                                         0.320ms reached
     Resume: pmtu 9000 hops 1 back 1
```

---

## æ•ˆæœæµ‹è¯•

### iperf3

#### é MBP è®¾å¤‡

é™¤äº† MBP, å…¶ä»–è®¾å¤‡ä¸ç®¡æ˜¯ä¸Šä¼ è¿˜æ˜¯ä¸‹è½½, ä½¿ç”¨ iperf3 éƒ½èƒ½è·‘å®Œ 10G å¸¦å®½:

![20241229154732_DPk3ENs3.webp](https://cdn.dong4j.site/source/image/20241229154732_DPk3ENs3.webp)

#### MBP

MBP ä½¿ç”¨[ä¸‡å…†é¦–é€‰æ–¹æ¡ˆ](#é¦–é€‰æ–¹æ¡ˆ), å› ä¸º MTU çš„åŸå› , ä¸Šä¼ èƒ½è·‘åˆ°æ¥è¿‘ 7G:

![20241229154732_PbfBPmmd.webp](https://cdn.dong4j.site/source/image/20241229154732_PbfBPmmd.webp)

ä¸‹è½½èƒ½è·‘åˆ° 8G+:

![20241229154732_LGqe9sab.webp](https://cdn.dong4j.site/source/image/20241229154732_LGqe9sab.webp)

ä½¿ç”¨[ä¸‡å…†å¤‡é€‰æ–¹æ¡ˆ](#å¤‡é€‰æ–¹æ¡ˆ), ä¸Šä¼ èƒ½è·‘åˆ° 5.5G, ä¸‹è½½èƒ½è·‘åˆ° 6G:

![20241229154732_9hK4Hp57.webp](https://cdn.dong4j.site/source/image/20241229154732_9hK4Hp57.webp)

æ‰€ä»¥è¿˜æ˜¯é€‰æ‹©äº†ç¬¬ä¸€ç§æ–¹æ¡ˆ, è¿™ä¸ªç¡¬ç›˜ç›’å°±ç•™ç»™ Mac mini M2 ä½¿ç”¨äº†. ç®€å•çš„æµ‹è¯•äº†ä¸€ä¸‹, è¯»å–é€Ÿåº¦æ¯” M2 è‡ªå¸¦çš„ 256G è¦é«˜å‡º 500MB/s å·¦å³, å†™å…¥é€Ÿåº¦åè€Œä½äº† 500MB/s ğŸ˜…, å¯èƒ½è·Ÿæˆ‘çš„å›ºæ€æœ‰å…³, è¿™ä¸ªé—®é¢˜å°±ä¸å»æ·±ç©¶äº†, Mac mini M2 ç¼ºçš„æ˜¯ç£ç›˜ç©ºé—´, è¿™æ¬¡ç®—æ˜¯è¡¥è¶³äº†.

![20241229154732_7vOQitgd.webp](https://cdn.dong4j.site/source/image/20241229154732_7vOQitgd.webp)

### æ–‡ä»¶æ‹·è´

æµ‹è¯•ä½¿ç”¨ SMB åè®®æŒ‚è½½ DS923+ çš„æœºæ¢°ç¡¬ç›˜åˆ°æœ¬åœ°, ç„¶åç›´æ¥æ‹·è´åˆ°æœ¬æœº.

#### Mac mini 2018

![20241229154732_YcHRYBAK.webp](https://cdn.dong4j.site/source/image/20241229154732_YcHRYBAK.webp)

#### MBP

![20241229154732_dtrseCUV.webp](https://cdn.dong4j.site/source/image/20241229154732_dtrseCUV.webp)

ä½¿ç”¨ `Disk Speed Test` æµ‹è¯•ç»“æœ:

![20241229154732_Xc9tf9Vi.webp](https://cdn.dong4j.site/source/image/20241229154732_Xc9tf9Vi.webp)

### scp

åœ¨ MBP ä¸‹æµ‹è¯•, é€Ÿåº¦ç¨³å®šåœ¨ `150MB/s` +

![20241229154732_Ntmpoc0j.webp](https://cdn.dong4j.site/source/image/20241229154732_Ntmpoc0j.webp)

### rsync

åœ¨ MBP ä¸‹æµ‹è¯•, ç¨³å®šåœ¨ `120MB/s` +

![20241229154732_ZAUBh8ng.webp](https://cdn.dong4j.site/source/image/20241229154732_ZAUBh8ng.webp)

## é—ç•™é—®é¢˜

### MBP MTU

å› ä¸ºç½‘å¡é©±åŠ¨çš„é—®é¢˜, MTU æ— æ³•ä¿®æ”¹åˆ° 9000, å› ä¸º Intel å®˜æ–¹å¹¶æ²¡æœ‰ä¸ºå…¶ä¸‡å…†ç½‘å¡æä¾›å®˜æ–¹çš„é©±åŠ¨æ”¯æŒ, å¥½åœ¨ [Small Tree](https://small-tree.com/) è¿™å®¶å…¬å¸ä¸º 8259x èŠ¯ç‰‡çš„ç½‘å¡ç¼–å†™äº† macOS é©±åŠ¨, è¯¥é©±åŠ¨åŒæ ·å¯ä»¥é€‚é…åˆ°ä»»ä½•ä½¿ç”¨ 8259x èŠ¯ç‰‡çš„ç½‘å¡ä¸Š, åŒ…æ‹¬æˆ‘æ‰‹å¤´è¿™å¼  X520.

ä½†æ˜¯æ ¹æ® [Small Tree æä¾›çš„é©±åŠ¨](https://small-tree.com/support/downloads/10-gigabit-ethernet-driver-download-page/) , å®ƒçš„æ–‡æ¡£æ˜ç¡®è¯´æ˜äº†è¯¥é©±åŠ¨åªä¼šåœ¨ Subsystem ID ä¸º `000A` çš„ç½‘å¡ä¸Šè¿è¡Œ, å› æ­¤å¦‚æœä½¿ç”¨ Subsystem ID ä¸æ»¡è¶³è¦æ±‚çš„è¯, æ˜¯æ— æ³•é©±åŠ¨çš„.

æ‰€ä»¥éœ€è¦é€šè¿‡ä¸€äº›åŠæ³•å¼ºè¡Œä¿®æ”¹ä¸º `000A`, ç„¶åå†å®‰è£… Small Tree çš„é©±åŠ¨å³å¯.

> è¿˜æ²¡æœ‰å®é™…æ“ä½œ, ç­‰æœ‰æ—¶é—´å†å°è¯•ä¸€ä¸‹.

ä¿®æ”¹æ–¹å¼å‚è€ƒ:

- [Intel X520 ç½‘å¡çš„ Windows / macOS é©±åŠ¨æ–¹æ³•](https://malash.me/202207/intel-x520-drivers-on-windows-and-macos/)
- [ç»™ MacOS ä¸»æœºå‡çº§ä¸‡å…†ç½‘å¡è®°å½•](https://post.smzdm.com/p/akl5we7r/)

### æ‹“å±•åå¸¦å®½

å› ä¸ºç»™ä¸‡å…†ç½‘å¡ä½¿ç”¨çš„é›·é›³æ‹“å±•åæœ‰ 2 ä¸ªé›·é›³æ¥å£, åŸæƒ³è®© MBP é€šè¿‡ä¸€æ ¹é›·é›³ 4 æ¥å£å°±å¯ä»¥æŠŠæ‰€æœ‰çš„è®¾å¤‡å…¨éƒ¨å¸¦èµ·æ¥, è¿™äº›è®¾å¤‡åŒ…æ‹¬:

- 2 å° 4K æ˜¾ç¤ºå™¨;
- æ–°å¢çš„ä¸‡å…†ç½‘å¡;
- è‹¥å¹² USB è®¾å¤‡;

ä½†æ˜¯å› ä¸ºé›·é›³ 4 å¸¦å®½å—é™, å¯¼è‡´éƒ¨åˆ† USB è®¾å¤‡æ— æ³•æ­£å¸¸ä½¿ç”¨, åªèƒ½å†ä½¿ç”¨ä¸€ä¸ªé›·é›³æ¥å£å•ç‹¬è¿æ¥ç½‘å¡çš„é›·é›³æ‹“å±•åäº†, æ‰€ä»¥è¿™æ¬¡å‡çº§ç•¥å¸¦é—æ†¾çš„æ˜¯æ²¡æœ‰è€ƒè™‘åˆ°å¸¦å®½çš„é—®é¢˜.

2023 å¹´ 9 æœˆ 12 æ—¥, è‹±ç‰¹å°”å‘å¸ƒäº†é›·é›³ 5 (Thunderbolt 5) è§„èŒƒ, å…¼å®¹æœ€æ–°çš„ USB4 V2 è§„æ ¼. åœ¨å¯¹ç§°æ¨¡å¼ä¸‹, å®ƒæä¾› 80Gbps çš„ä¸Šä¸‹è¡Œä¼ è¾“å¸¦å®½, æ˜¯é›·é›³ 4 çš„ä¸¤å€ï¼›è€Œåœ¨éå¯¹ç§°æ¨¡å¼ä¸‹å•å‘å¸¦å®½æœ€é«˜å¯è¾¾ 120Gbps, æ˜¯é›·é›³ 4 çš„ä¸‰å€.

è€Œ Mac mini M4 æä¾› 3 ä¸ªé›·é›³ 5 æ¥å£, ç§‘æŠ€å‘å±•çš„çœŸçš„å¤ªå¿«äº†, é’±åŒ…å·²ç»è·Ÿä¸ä¸Šäº† ğŸ˜‚.

## å¤šå° Mac äº’è”

### é›·é›³æŠ€æœ¯

![20241229154732_rHxPCdFF.webp](https://cdn.dong4j.site/source/image/20241229154732_rHxPCdFF.webp)

é›·é›³æŠ€æœ¯, ç”±è‹±ç‰¹å°”å¼€å‘, æ˜¯ä¸€ç§å…ˆè¿›çš„è¿æ¥æ ‡å‡†, å®ƒé€šè¿‡å•ä¸€è¿æ¥ç‚¹æä¾›ç”µæºã€æ•°æ®å’Œè§†é¢‘ä¿¡å·. é›·é›³æŠ€æœ¯çš„è®¤è¯ç¡®ä¿äº†ç”µç¼†ã€ç”µè„‘å’Œé…ä»¶æ»¡è¶³å¼ºåˆ¶æ€§çš„æœ€ä½è¦æ±‚, ä»¥æ­¤ä¿éšœä¸åŒè®¾å¤‡å’Œä¾›åº”å•†ä¹‹é—´çš„å…¼å®¹æ€§å’Œäº’æ“ä½œæ€§. å¯¹äºç»ˆç«¯ç”¨æˆ·æ¥è¯´, åŸºäºé›·é›³æŠ€æœ¯çš„äº§å“åœ¨è¿æ¥å„ç§é…ä»¶æ—¶, èƒ½å¤Ÿæä¾›å“è¶Šçš„ä½“éªŒ.
åœ¨ Apple Mac ç³»åˆ—äº§å“ä¸­, é›·é›³ 3 å’Œé›·é›³ 4 ç«¯å£å®é™…ä¸Šä¸ Intel çš„é›·é›³ 3 å’Œé›·é›³ 4 æŠ€æœ¯æ˜¯ç›¸åŒçš„. Apple å¸¸å¸¸ä¸ºå…¶è½¯ç¡¬ä»¶äº§å“èµ‹äºˆæ–°çš„åç§°, ä¾‹å¦‚å½“ Mac ä» Intel èŠ¯ç‰‡è½¬å‘ Apple èŠ¯ç‰‡æ—¶, é›·é›³ 3 çš„åç§°å˜æ›´ä¸ºâ€œé›·é›³/USB4â€, å°½ç®¡æŠ€æœ¯ä¸Šä»ç„¶æ˜¯é›·é›³ 3. è€Œé›·é›³ 4 (USB-C) ç«¯å£åˆ™æ˜¯ Mac ä¸ŠçœŸæ­£çš„é›·é›³ 4 ç«¯å£.
USB4 å’Œé›·é›³ 4 çš„ä¸»è¦å·®å¼‚åœ¨äº, å°½ç®¡å®ƒä»¬çš„æœ€é«˜å¸¦å®½æ ‡å‡†ç›¸åŒ, ä½†é›·é›³ 4 çš„æœ€ä½æ€§èƒ½æ ‡å‡†è¦é«˜äº USB4. ä¾‹å¦‚, USB4 çš„å¸¦å®½å¯ä»¥ä½è‡³ 20Gbps, å……ç”µåŠŸç‡å¯ä»¥ä½äº 100W, ä¸”è¿æ¥æ˜¾ç¤ºå™¨æ—¶ä¸å¿…æ»¡è¶³é›·é›³ 4 çš„æ ‡å‡†.
é›·é›³ 4 æŠ€æœ¯æä¾›ä»¥ä¸‹ç‰¹æ€§ï¼š

- **é«˜å¸¦å®½**ï¼š40 Gbps çš„å¸¦å®½å¯ç”¨äºæ•°æ®å’Œè§†é¢‘ä¼ è¾“, èƒ½å¤ŸåŠ¨æ€åˆ†é…, é€‚åˆå¤„ç†ç¹é‡çš„å·¥ä½œè´Ÿè½½å’Œå¿«é€Ÿæ–‡ä»¶ä¼ è¾“.
- **å¿«å……**ï¼šæ”¯æŒé«˜è¾¾ 100W çš„ç”µæºè¾“å‡º, ç”¨äºä¸ºç¬”è®°æœ¬ç”µè„‘å……ç”µ, ä»¥åŠé«˜è¾¾ 15W çš„ç”µæºè¾“å‡º, ç”¨äºä¸ºé…ä»¶ä¾›ç”µ.
- **ä¸°å¯Œçš„æ˜¾ç¤ºé€‰é¡¹**ï¼šå•ä¸ªè¿æ¥å¯ä»¥æ”¯æŒä¸¤å° 4K 60 Hz çš„æ˜¾ç¤ºå™¨æˆ–ä¸€å° 8K 60 Hz çš„æ˜¾ç¤ºå™¨.

USB-C æ˜¯ä¸€ç§è¿æ¥å™¨ç±»å‹, å®ƒä¸åŒäºä¹‹å‰å¹¿æ³›ä½¿ç”¨çš„ USB-A è¿æ¥å™¨å’Œ Apple çš„ Lightning è¿æ¥å™¨. é›·é›³ 3ã€é›·é›³ 4ã€USB4ã€USB3.2ã€USB2.0 ç­‰å¤šç§åè®®éƒ½å¯ä»¥ä½¿ç”¨ USB-C è¿æ¥å™¨. é€šå¸¸æƒ…å†µä¸‹, é›·é›³ 3 å’Œé›·é›³ 4 ä»…æä¾› USB-C æ¥å£, è€Œ USB4 å’Œ USB3.2 åˆ™å¯èƒ½åŒæ—¶æä¾› USB-C å’Œ USB-A æ¥å£åŠçº¿ç¼†, æˆ–è€…æä¾› USB-C æ¥å£æ­é… USB-A è½¬æ¥å¤´. è¦åŒºåˆ† USB-C çš„æ¥å£æˆ–çº¿ç¼†, éœ€è¦æŸ¥çœ‹äº§å“çš„å°åˆ·æ ‡å¿—æˆ–è¯¦ç»†å‚æ•°è¯´æ˜.

ä»¥ Apple çš„ Lightning æ¥å£ä¸ºä¾‹, æœ€æ–°çš„ iPhone 15 ç³»åˆ—éšæœºé™„é€çš„ USB-C æ¥å£çº¿ç¼†å®é™…ä¸Šéµå¾ªçš„æ˜¯ USB 2.0 æ ‡å‡†, å…¶ä¼ è¾“é€Ÿç‡ä»…ä¸º 480Mbps. è‹¥è¦æå‡é€Ÿåº¦, ç”¨æˆ·éœ€é¢å¤–è´­ä¹° USB 3.2 çº¿ç¼†æˆ–é›·é›³ 3ã€é›·é›³ 4 çº¿ç¼†. å€¼å¾—æ³¨æ„çš„æ˜¯, åªæœ‰ iPhone 15 Pro å’Œ iPhone 15 Pro Max æ”¯æŒ USB 3.2 ç¬¬ 2 ä»£, èƒ½å¤Ÿå®ç°æœ€é«˜ 10Gbit/s çš„å¿«é€Ÿæ•°æ®ä¼ è¾“.

å…³äº USB ç‰ˆæœ¬åè®®çš„å‘½å, ç¡®å®æœ‰äº›å¤æ‚. ä½†åªéœ€è®°ä½, USB3.2 çš„ 10Gbit/s æ˜¯ USB3 ç³»åˆ—çš„é«˜æ ‡å‡†é€Ÿåº¦ (è€Œ USB3.2 Gen2x2 çš„ 20Gbit/s ç”±äºå…¼å®¹æ€§é—®é¢˜, é€šå¸¸ä¸ä½œä¸ºä¸»æµæ ‡å‡†) . è¿™ä¸€é€Ÿåº¦å¸¸ç”¨äºå¸‚é¢ä¸Šå¸¸è§çš„ SSD å›ºæ€ç§»åŠ¨ç¡¬ç›˜ä¼ è¾“. USB4 æœ‰ 20Gbit/s å’Œ 40 Gbit/s ä¸¤ä¸ªç‰ˆæœ¬, è€Œé›·é›³ 3 å’Œé›·é›³ 4 å‡æä¾› 40Gbit/s çš„å¸¦å®½. ä¸€æ ¹é›·é›³ 3 çº¿ç¼†é€šå¸¸èƒ½å¤Ÿæ»¡è¶³å¤§å¤šæ•°å•ä¸€è®¾å¤‡çš„è¿æ¥éœ€æ±‚.

é›·é›³ 3 å’Œé›·é›³ 4 å‡æ ‡æ¦œä¸€ä¸ªæ¥å£å¤šç§ç”¨é€”, å› æ­¤, å½“ä¸€æ ¹çº¿ç¼†é€šè¿‡æ‰©å±•åè¿æ¥å¤šä¸ªè®¾å¤‡æ—¶, å…¶å¸¦å®½æ˜¯åŠ¨æ€åˆ†é…çš„. é›·é›³ 4 ç›¸è¾ƒäºé›·é›³ 3, åœ¨æ•°æ®ä¼ è¾“å¸¦å®½ä¸Šæä¾›äº†æ›´é«˜çš„åˆ†é…, å¹¶ä¸”åœ¨è¿æ¥æ˜¾ç¤ºå™¨çš„æ ‡å‡†ä¸Šä¹Ÿæ›´ä¸ºä¸¥æ ¼. å› æ­¤, å¦‚æœä½ è¿½æ±‚æœ€é«˜çš„æ•°æ®ä¼ è¾“é€Ÿåº¦æˆ–è€…éœ€è¦è¿æ¥å¤šä¸ªé«˜æ ‡å‡†è®¾å¤‡, é‚£ä¹ˆé€‰æ‹©é›·é›³ 4 çº¿ç¼†å°†æ˜¯æ›´ä½³çš„é€‰æ‹©. å½“ç„¶, é™¤äº†çº¿ç¼†æœ¬èº«, è®¾å¤‡é—´çš„ä¼ è¾“æ¥å£å’Œè®¾å¤‡æœ¬èº«çš„æ€§èƒ½ä¹Ÿä¼šå¯¹æ•´ä½“ä¼ è¾“æ•ˆæœäº§ç”Ÿå½±å“.

> å¦‚æœä½ æƒ³å°è¯•ä¸€ä¸‹ **é›·é›³ 5 80Gbps** çš„æé™é€Ÿåº¦, æœ€æ–°çš„ [Mac mini M4](https://www.apple.com.cn/shop/buy-mac/mac-mini/m4) æˆ–è®¸æ˜¯æœ€å¥½çš„é€‰æ‹©.

---

### é›·é›³ç»„ç½‘

ç›®å‰æœ‰ 3 å° macOS è®¾å¤‡, ä¸”éƒ½æœ‰ç©ºä½™çš„é›·é›³æ¥å£, æ‰€ä»¥æƒ³ç€ç»„ä¸ª 20G ç½‘ç»œç©ç©.

é™¤äº† Mac mini 2018 æ˜¯é›·é›³ 3 æ¥å£å¤–, å…¶ä»– 2 å°å…¨æ˜¯é›·é›³ 4 æ¥å£. é›·é›³ 3 ç†è®ºä¹Ÿåªæœ‰ 22Gb/s çš„å¸¦å®½ç”¨äºæ•°æ®ä¼ è¾“, ä½¿ç”¨é›·é›³ 4 ç«¯å£+é›·é›³ 4 æ•°æ®çº¿å¯ä»¥åˆ°è¾¾ 32Gb/s çš„ç†è®ºä¼ è¾“é€Ÿåº¦.

ä¸‹é¢æ˜¯è¿æ¥æ‹“æ‰‘å›¾:

![mac-thunderbolt.drawio.svg](https://cdn.dong4j.site/source/image/mac-thunderbolt.drawio.svg)

æœ€å¼€å§‹æ˜¯å°† M2 ä½œä¸º MBP å’Œ Mac mini 2018 çš„ä¸­ç»§èŠ‚ç‚¹æ¥è¿æ¥çš„, è¿™æ ·è‡³å°‘èƒ½ä¿è¯ MBP åˆ° M2 èƒ½è¾¾åˆ°é›·é›³ 4 çš„é€Ÿåº¦, ä½†æ˜¯å®è·µåå‘ç° M2 å’Œ MBP çš„é›·é›³è¿æ¥ç»å¸¸æ–­å¼€, è¿æ¥æ–¹å¼æ˜¯ MBP é€šè¿‡é›·é›³ 4 è¿æ¥ CalDigit TS4 åå†è¿æ¥åˆ° M2, å¯èƒ½å› ä¸º CalDigit TS4 (2 å° 4K æ˜¾ç¤ºå™¨, å…¶ä»–æ¥å£åŸºæœ¬ä¸Šæ’æ»¡äº†) æŒ‚çš„è®¾å¤‡å¤ªå¤šä¸ç¨³å®šå¯¼è‡´çš„.

æ‰€æœ‰æ‰ä½¿ç”¨äº†ä¸Šè¿°è¿æ¥æ–¹æ¡ˆ, ä¸” Mac mini 2018 æ­£å¥½æœ‰ 2 ä¸ªç©ºé—²çš„é›·é›³æ¥å£, M2 è¿˜èƒ½ç©ºå‡ºä¸€ä¸ªé›·é›³ 4 æ¥å£ä»¥ä¾¿åç»­è¿æ¥å­˜å‚¨è®¾å¤‡.

è¿™æ ·è¿æ¥å, åªæœ‰é›·é›³ 3 çš„ 22Gb/s ç†è®ºé€Ÿåº¦äº†, ä¸è¿‡ç¨³å®šæœ€é‡è¦, é€Ÿåº¦è‡³å°‘æ¯” 10G ç½‘çº¿å¿«.

ä¸‹é¢æ˜¯å…·ä½“çš„è¿æ¥æ–¹å¼.

### é›·é›³ç½‘æ¡¥

> éœ€è¦äº†è§£çš„ä¸€ä¸ªå‰ææ˜¯, é›·é›³ 4 å®£ç§°çš„ 40Gbit/s å¸¦å®½æ˜¯åŸºäºæ¯”ç‰¹ (bit) è¿™ä¸€å•ä½çš„. ç„¶è€Œ, åœ¨è½¯ä»¶å’Œç³»ç»Ÿæ˜¾ç¤ºçš„é€Ÿåº¦å•ä½é€šå¸¸æ˜¯å­—èŠ‚ (Byte) , å…¶ä¸­ 1 å­—èŠ‚ç­‰äº 8 æ¯”ç‰¹. å› æ­¤, å½“ç§»åŠ¨ç¡¬ç›˜æ ‡æ¦œå…¶ä¼ è¾“é€Ÿåº¦ä¸º 1000MB/s æ—¶, è¿™å®é™…ä¸Šç›¸å½“äº 8000Mbit/s, æˆ–è€…å¤§çº¦ç­‰åŒäº 7.8Gbit/s.

3 å° Mac ä½¿ç”¨é›·é›³ 3 è¿æ¥å, ä¼šè‡ªåŠ¨åœ¨ **ç½‘ç»œ** ä¸­åˆ›å»ºä¸€ä¸ªåä¸º **é›·é›³ç½‘æ¡¥** çš„æ¥å£, ç„¶ååªéœ€è¦è®¾ç½® IP å’Œå­ç½‘æ©ç å³å¯ç»„ç½‘:

![20241229154732_ByFZlxZp.webp](https://cdn.dong4j.site/source/image/20241229154732_ByFZlxZp.webp)

### æµ‹è¯•

#### iperf3

ä½¿ç”¨ `iperf3` è¿›è¡Œå†…ç½‘æµ‹è¯•:

```bash
iperf3 -f MB --omit 5 --time 20 -Ñ 1.0.0.4
```

![20241229154732_o9BLJ9Cd.webp](https://cdn.dong4j.site/source/image/20241229154732_o9BLJ9Cd.webp)

**22 Gb/s ç­‰äº 2750 MBytes/s**, é‚£ä¹ˆå¤§æ¦‚åªè·‘åˆ°äº†ç†è®ºé€Ÿåº¦çš„ **90%**, å¯¹äºè¿™ä¸ªç»“æœè¿˜æ˜¯æ¯”è¾ƒæ»¡æ„çš„.

#### SMB æµ‹è¯•

æ‰“å¼€ Mac mini ä¸Šçš„æ–‡ä»¶å…±äº«æ¥ä¼ è¾“æ–‡ä»¶, è¿æ¥ä½¿ç”¨ Mac mini ä¸Šé›·é›³ç½‘æ¡¥åˆ†é…çš„ IP, æ‰“å¼€ MBP ä¸Šçš„è®¿è¾¾, æŒ‰ âŒ˜ + K å¥ (æˆ–ç‚¹é€‰èœå•â€œå‰å¾€ > è¿æ¥æœåŠ¡å™¨â€œ) , è¾“å…¥ smb://1.0.0.4 , ä»¥åŠå¯¹åº”çš„ç”¨æˆ·åå¯†ç å°±å¯ä»¥è¿›è¡Œè¿æ¥.

**MBP ==> Mac mini 2018**

![20241229154732_UFoXi4OP.webp](https://cdn.dong4j.site/source/image/20241229154732_UFoXi4OP.webp)

**Mac mini 2018 ==> MBP**

MBP çš„ SMB å±…ç„¶è¿˜æ²¡æœ‰è¢«é™é€Ÿçš„ 256GB Mac mini å¿«, æˆ‘æƒ³å¯èƒ½çš„åŸå› æ˜¯ `CalDigit TS4` çš„å¸¦å®½è¢«å ç”¨å¤ªå¤šäº†, æœ‰æ—¶é—´ç”¨é›·é›³æ¥å£ç›´è¿å†è¯•è¯•.

![20241229154732_TlkoYPuV.webp](https://cdn.dong4j.site/source/image/20241229154732_TlkoYPuV.webp)

è¿™å°±æœ‰ç‚¹å°´å°¬äº†, 4T çš„ MBP æœ¬åœ°æµ‹è¯•å¯ä»¥è·‘åˆ° 6000MB/s +:

![20241229154732_eCAhuv1U.webp](https://cdn.dong4j.site/source/image/20241229154732_eCAhuv1U.webp)

æ‹–åŠ¨ä¸€ä¸ªå¤§äº 5GB çš„æ–‡ä»¶ (é¡ºåºè¯»å–) , åœ¨èœå•æ  iStat Menus çš„ç½‘ç»œç›‘æ§ä¸­å¯ä»¥çœ‹åˆ°, ä¼ è¾“é€Ÿåº¦å¯ä»¥åˆ°è¾¾ 800MB/s, ç­‰äº 6.4 Gb/s. å›ä¼ æ–‡ä»¶ (é¡ºåºå†™å…¥) åˆ™æ˜¯åˆ°äº† 600MB/s å·¦å³. ç›´æ¥è¿æ¥ USB3.2 åè®®çš„ç§»åŠ¨ç¡¬ç›˜, è·Ÿè¿™ä¸ªé€Ÿåº¦ç›¸å·®ä¸å¤§, ä½†æ˜¯ç›´æ¥è¿æ¥é›·é›³ 4 åè®®çš„ç§»åŠ¨ç¡¬ç›˜, æ˜¯å¯ä»¥è½»æ¾è¶…è¿‡ 2000MB/s çš„ä¼ è¾“é€Ÿåº¦.

![20241229154732_C9YLZacD.webp](https://cdn.dong4j.site/source/image/20241229154732_C9YLZacD.webp)

### scp

å·®ä¸€ç‚¹çªç ´ `200MB/s`:

![20241229154732_j5uObYLq.webp](https://cdn.dong4j.site/source/image/20241229154732_j5uObYLq.webp)

### æœªçŸ¥çŠ¶æ€

å¦‚æœä½¿ç”¨è‡ªåŠ¨æ·»åŠ çš„é›·é›³ç½‘æ¡¥çš„è¯, è™½ç„¶è¿æ¥æ²¡æœ‰é—®é¢˜, ä½†æ˜¯ä¼šå‡ºç° **æœªçŸ¥çŠ¶æ€** çš„è­¦å‘Š, å¯¹äºå¼ºè¿«ç—‡çš„äººè‚¯å®šä¸èƒ½å¿, æ‰€ä»¥ç¿»çœ‹äº†ä¸€äº› [æ•™ç¨‹](https://forums.macrumors.com/threads/problem-solved-help-configuring-thunderbolt-sharing-for-internet-between-two-m1-macs.2388249/) æ¥è§£å†³è¿™ä¸ªé—®é¢˜.

å¦‚æœæœ‰å¤šä¸ªé›·é›³æ¥å£, è¿æ¥å…¶ä¸­ä¸€ä¸ªé›·é›³æ¥å£çš„æ—¶å€™, ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª **é›·é›³ç½‘æ¡¥** çš„æ¥å£, è¿™ä¸ªæ¥å£é‡Œé¢åŒ…å«äº†æ‰€æœ‰çš„é›·é›³æ¥å£, å¦‚ä¸‹å›¾æ‰€ç¤º, M2 çš„ 2 ä¸ªé›·é›³æ¥å£å…¨éƒ¨è¢«è‡ªåŠ¨æ·»åŠ åˆ°äº†è¿™ä¸ª **é›·é›³ç½‘æ¡¥** ä¸­, ä½†æ˜¯åªæœ‰ **é›·é›³ 2** æ¥å£åœ¨ä½¿ç”¨.

![20241229154732_JD1hRYBF.webp](https://cdn.dong4j.site/source/image/20241229154732_JD1hRYBF.webp)

æ‰€ä»¥è§£å†³çš„åŠæ³•å°±æ˜¯åˆ é™¤è¿™ä¸ª **é›·é›³ç½‘æ¡¥**, ç„¶åè‡ªå·±åˆ›å»ºä¸€ä¸ªé›·é›³æ¥å£:

ç‚¹å‡» **è®¾ç½®->ç½‘ç»œ** é¡µé¢å³ä¸‹è§’çš„ **...**, ç„¶åç‚¹å‡» **ç®¡ç†è™šæ‹Ÿæ¥å£**:

![20241229154732_5Tpmknjm.webp](https://cdn.dong4j.site/source/image/20241229154732_5Tpmknjm.webp)

å…ˆåˆ é™¤è¿™ä¸ªæ¥å£, ç„¶åæ–°å»ºä¸€ä¸ªé›·é›³æ¥å£:

![20241229154732_Zp9WYM2X.webp](https://cdn.dong4j.site/source/image/20241229154732_Zp9WYM2X.webp)

è¿™é‡Œéœ€è¦ç¡®è®¤æ˜¯ç¬¬å‡ ä¸ªé›·é›³æ¥å£, å¯ä»¥æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯:

![20241229154732_Ihsgz8mi.webp](https://cdn.dong4j.site/source/image/20241229154732_Ihsgz8mi.webp)

æ‰€ä»¥ä¸Šé¢å°±åº”è¯¥é€‰æ‹© **é›·é›³ 2**, åˆ›å»ºä¹‹åç¨ç­‰ä¸€ä¼š, å°±ä¼šå‡ºç°ä¸€ä¸ªå·²è‡ªåŠ¨åˆ†é… IP çš„é›·é›³æ¥å£, è®¾ç½® IP åå³å¯æ˜¾ç¤ºæ­£å¸¸:

![20241229154732_pVR4FkMO.webp](https://cdn.dong4j.site/source/image/20241229154732_pVR4FkMO.webp)

å› ä¸º Mac mini 2018 éœ€è¦åŒæ—¶è¿æ¥ Mac mini M2 å’Œ MBP, æ‰€ä»¥éœ€è¦ä½¿ç”¨åˆ°é›·é›³ç½‘æ¡¥, åªéœ€è¦å°†è¿™ä¸ªè‡ªåŠ¨åˆ›å»ºé›·é›³ç½‘æ¡¥ä¸­ä¸éœ€è¦çš„é›·é›³æ¥å£åˆ é™¤å³å¯.

é¦–å…ˆç¡®è®¤æ¥å£:

![20241229154732_LeVg4NCM.webp](https://cdn.dong4j.site/source/image/20241229154732_LeVg4NCM.webp)

ä¿®æ”¹ **é›·é›³ç½‘æ¡¥**, ç§»å‡ºå¤šä½™çš„æ¥å£å³å¯:

![20241229154732_enZ0kMhQ.webp](https://cdn.dong4j.site/source/image/20241229154732_enZ0kMhQ.webp)

---

## æ€»ç»“

è¿™æ¬¡å°†ä¹¦æˆ¿çš„ä¸»è¦è®¾å¤‡å…¨éƒ¨å‡çº§åˆ°ä¸‡å…†, ä»å­¦ä¹  MBP ä¸‡å…†æ–¹æ¡ˆ, åˆ°å‡†å¤‡å·¥ä½œä¸­å¯¹ä¸€äº›åŸºç¡€çŸ¥è¯†çš„äº†è§£, æœ€åçš„å®‰è£…éƒ¨ç½²è°ƒè¯•, å†åˆ°è¿™ç¯‡åšå®¢, è€—æ—¶ä¸€å‘¨æ—¶é—´.

å‡çº§åçš„æ•ˆæœéå¸¸æ˜¾è‘—. é™¤äº† MBP ç”±äºé©±åŠ¨é—®é¢˜ MTU æ— æ³•ä¿®æ”¹åˆ° 9000 ä»¥å¤–, å…¶ä»–è®¾å¤‡çš„ä¸Šä¼ å’Œä¸‹è½½é€Ÿåº¦éƒ½æ¥è¿‘æˆ–è¾¾åˆ°äº†ç†è®ºå€¼.

å°½ç®¡åœ¨å‡çº§è¿‡ç¨‹ä¸­ä¹Ÿé‡åˆ°äº†ä¸€äº›é—®é¢˜, ä½†è¿™äº›é—®é¢˜çš„è§£å†³æ–¹æ³•å’Œæœªæ¥çš„æ”¹è¿›æ–¹å‘éƒ½å·²ç»æ˜ç¡®. ç­‰åˆ°æ¢æˆé›·é›³ 5 çš„è®¾å¤‡æ—¶, åˆå¯ä»¥è€ƒè™‘ 25G ç”šè‡³æ—¶ 40G çš„å‡çº§æ–¹æ¡ˆäº†.

**ç›¸å…³æ–‡ç« :**

1. [[homelab-guide|å…ˆå¯¼ç¯‡]]ï¼šæˆ‘çš„ HomeLab æ¦‚è¦;
2. [[homelab-hardware|ç¡¬ä»¶ç¯‡]]ï¼šä»‹ç»æˆ‘æ‰€æ‹¥æœ‰çš„ç¡¬ä»¶è®¾å¤‡;
3. [[homelab-network|ç½‘ç»œç¯‡]]ï¼šåŒ…æ‹¬ç½‘ç»œç¯å¢ƒã€å¼‚åœ°ç»„ç½‘ä¸ç½‘ç»œå®‰å…¨;
4. [[homelab-service|æœåŠ¡ç¯‡]]ï¼šä½¿ç”¨ Docker æ­å»ºçš„å„ç±»æœåŠ¡;
5. [[homelab-data|æ•°æ®ç¯‡]]ï¼šåŒ…æ‹¬æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆ;
6. [[homelab-data-sync|HomeLabæ•°æ®åŒæ­¥ï¼šæ„å»ºé«˜æ•ˆçš„æ•°æ®åŒæ­¥ç½‘ç»œ]]
7. [[homelab-data-backup|HomeLabæ•°æ®å¤‡ä»½ï¼šæ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿]]
8. [[homelab-upgrade-to-10g|HomeLab ç½‘ç»œç»­é›†ï¼šå‡çº§ 10G ç½‘ç»œ-å†æˆ˜ 10 å¹´]]
9. [[homelab-guide|NAT å†…ç½‘ç©¿é€è¯¦è§£ï¼šæ­ç§˜ç½‘ç»œè¿æ¥èƒŒåçš„å¥¥ç§˜]]

## [ä¸º Hexo åšå®¢å¼•å…¥æ™ºèƒ½å¯¹è¯ï¼šé›†æˆ AI èŠå¤©æœºå™¨äººå…¨æ”»ç•¥](https://blog.dong4j.site/posts/385a05d5.md)

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ç®€ä»‹

æœ€è¿‘åœ¨ç©å„¿ [æ£€ç´¢å¢å¼ºç”Ÿæˆ](https://aws.amazon.com/cn/what-is/retrieval-augmented-generation/)ï¼ˆRAGï¼ŒRetrieval Augmented Generationï¼‰, æœ¬åœ°éƒ¨ç½²äº†ä¸€å¥— dify, åº”è¯¥ç®—æ˜¯ RAG åŠŸèƒ½æœ€å…¨çš„å¼€æºé¡¹ç›®äº†, å¯ä»¥é›†æˆå·¥å¤§å‚å•†çš„ AI API ä»¥åŠè‡ªå»ºçš„ LLM æœåŠ¡.

æ‰€ä»¥å°±ç”¨ dify åšäº†ä¸€ä¸ªä¸ªäººçŸ¥è¯†åº“, æ•°æ®æ¥æºä¸åšå®¢å†…å®¹.

dify çš„éƒ¨ç½²ä»¥åŠä½¿ç”¨å¯æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£, å†™çš„éå¸¸è¯¦ç»†, è¿™é‡Œåªæ˜¯ä»‹ç»ä¸€ä¸‹å¦‚ä½•å°† dify é›†æˆåˆ° hexo çš„åšå®¢ä¸­.

æ ¹æ® [å®˜æ–¹æ–‡æ¡£](https://docs.dify.ai/zh-hans/guides/application-publishing/embedding-in-websites) çš„è¯´æ˜, æˆ‘é€‰æ‹©ä½¿ç”¨ `script æ ‡ç­¾æ–¹å¼` é›†æˆ dify åˆ°åšå®¢ä¸­, è¿™ç§æ–¹å¼ä¼šæœ‰ä¸€ä¸ªèŠå¤©æœºå™¨äººæŒ‰é’®, ä¸ä¼šå½±å“åšå®¢çš„æ•´ä½“ä½“éªŒ:

![20250211194203_i5qTaCtZ.webp](https://cdn.dong4j.site/source/image/20250211194203_i5qTaCtZ.webp)

---

## é›†æˆ

é¦–å…ˆä» dify è·å–åµŒå…¥åˆ°ç½‘ç«™ä¸­çš„ä»£ç , æ¯”å¦‚ä¸‹é¢è¿™æ ·:

```javascript
<script>
 window.difyChatbotConfig = {
  token: 'xxxxxxxxxxxx',
  baseUrl: 'http://192.168.1.2'
 }
</script>
<script
 src="http://192.168.1.2/embed.min.js"
 id="xxxxxxxxxxxx"
 defer>
</script>
<style>
  #dify-chatbot-bubble-button {
    background-color: #1C64F2 !important;
  }
  #dify-chatbot-bubble-window {
    width: 24rem !important;
    height: 40rem !important;
  }
</style>
```

`embed.min.js` æ–‡ä»¶æˆ‘ä¸‹è½½åˆ°æœ¬åœ°å¹¶ä¸Šä¼ åˆ°äº† CDN, ç„¶åå¯¹ä¸Šè¿°ä»£ç è¿›è¡Œäº†æ‹†åˆ†.

>  æ ¹æ®ä¸ªäºº hexo é…ç½®çš„ä¸åŒéƒ¨åˆ†æ­¥éª¤æˆ–ä»£ç ä¸ä¸€å®šé€‚ç”¨, ä½†æ˜¯æ€è·¯éƒ½æ˜¯ä¸€æ ·.

åœ¨ `source/js/dify` ç›®å½•ä¸‹æ–°å»ºä¸‹é¢ 2 ä¸ª js æ–‡ä»¶(`/js/dify` æ²¡æœ‰å°±æ–°å»º, å½“ç„¶ä½ å¯ä»¥åœ¨å…¶ä»–åœ°æ–¹åˆ›å»º, åªè¦èƒ½è¢« hexo å¼•ç”¨)

`dify-chat.embed.min.js` ç”¨äºä¿å­˜ä¸Šè¿° `embed.min.js` ä¸­çš„ä»£ç .

å¦ä¸€ä¸ªæ˜¯ `dify-chat.js`:

```javascript
window.difyChatbotConfig = {
  // å¿…å¡«é¡¹ï¼Œç”± Dify è‡ªåŠ¨ç”Ÿæˆ
  token: "xxxxxxxxxxxx",
  // å¯é€‰é¡¹ï¼Œé»˜è®¤ä¸º false
  isDev: false,
  // å¯é€‰é¡¹ï¼Œå½“ isDev ä¸º true æ—¶ï¼Œé»˜è®¤ä¸º '[https://dev.udify.app](https://dev.udify.app)'ï¼Œå¦åˆ™é»˜è®¤ä¸º '[https://udify.app](https://udify.app)'
  baseUrl: "https://dify.dong4j.ink:1024",
  // å¯é€‰é¡¹ï¼Œå¯ä»¥æ¥å—é™¤ `id` ä»¥å¤–çš„ä»»ä½•æœ‰æ•ˆçš„ HTMLElement å±æ€§ï¼Œä¾‹å¦‚ `style`ã€`className` ç­‰
  containerProps: {},
  // å¯é€‰é¡¹ï¼Œæ˜¯å¦å…è®¸æ‹–åŠ¨æŒ‰é’®ï¼Œé»˜è®¤ä¸º `false`
  draggable: false,
  // å¯é€‰é¡¹ï¼Œå…è®¸æ‹–åŠ¨æŒ‰é’®çš„è½´ï¼Œé»˜è®¤ä¸º `both`ï¼Œå¯ä»¥æ˜¯ `x`ã€`y`ã€`both`
  dragAxis: "both",
  // å¯é€‰é¡¹ï¼Œåœ¨ dify èŠå¤©æœºå™¨äººä¸­è®¾ç½®çš„è¾“å…¥å¯¹è±¡
  inputs: {
    // é”®æ˜¯å˜é‡å
    // ä¾‹å¦‚ï¼š
    // name: "NAME"
  },
};
```

ç„¶åå¯¹ css æ ·å¼è¿›è¡Œè‡ªå®šä¹‰ä¿®æ”¹, å¯ä»¥æ–°å»º `dify-chat.css` æ–‡ä»¶, ä¹Ÿå¯ä»¥æ ¹æ®å®˜æ–¹æ–‡æ¡£, åœ¨ `difu-chat.js` è¿›è¡Œæ·»åŠ , æˆ‘è¿™é‡Œé€‰æ‹©æ–°å»º css æ–‡ä»¶:

```css

:root {
    /* æŒ‰é’®è·ç¦»åº•éƒ¨çš„è·ç¦»ï¼Œé»˜è®¤ä¸º `1rem` */
    --dify-chatbot-bubble-button-bottom: 4.5rem;
    /* æŒ‰é’®è·ç¦»å³ä¾§çš„è·ç¦»ï¼Œé»˜è®¤ä¸º `1rem` */
    --dify-chatbot-bubble-button-right: unset;
    /* æŒ‰é’®è·ç¦»å·¦ä¾§çš„è·ç¦»ï¼Œé»˜è®¤ä¸º `unset` */
    --dify-chatbot-bubble-button-left: 1.5rem;
    /* æŒ‰é’®è·ç¦»é¡¶éƒ¨çš„è·ç¦»ï¼Œé»˜è®¤ä¸º `unset` */
    --dify-chatbot-bubble-button-top: unset;
    /* æŒ‰é’®èƒŒæ™¯é¢œè‰²ï¼Œé»˜è®¤ä¸º `#155EEF` */
    --dify-chatbot-bubble-button-bg-color: #155EEF;
    /* æŒ‰é’®å®½åº¦ï¼Œé»˜è®¤ä¸º `50px` */
    --dify-chatbot-bubble-button-width: 35px;
    /* æŒ‰é’®é«˜åº¦ï¼Œé»˜è®¤ä¸º `50px` */
    --dify-chatbot-bubble-button-height: 35px;
    /* æŒ‰é’®è¾¹æ¡†åŠå¾„ï¼Œé»˜è®¤ä¸º `25px` */
    --dify-chatbot-bubble-button-border-radius: 30px;
    /* æŒ‰é’®ç›’é˜´å½±ï¼Œé»˜è®¤ä¸º `rgba(0, 0, 0, 0.2) 0px 4px 8px 0px)` */
    --dify-chatbot-bubble-button-box-shadow: rgba(0, 0, 0, 0.2) 0px 4px 8px 0px;
    /* æŒ‰é’®æ‚¬åœå˜æ¢ï¼Œé»˜è®¤ä¸º `scale(1.1)` */
    --dify-chatbot-bubble-button-hover-transform: scale(1.1);
  }       
```

æˆ‘å°†æŒ‰é’®å›ºå®šåˆ°äº†å·¦ä¸‹è§’, è¿™æ ·ä¸ä¼šå½±å“å³ä¸‹è§’çš„ hexo æŒ‰é’®.

### hexo åŠ è½½

dify å¯¹äºç§»åŠ¨è®¾å¤‡ä¸æ˜¯å¾ˆå‹å¥½, æ‰€ä»¥æˆ‘åªåœ¨éç§»åŠ¨è®¾å¤‡ä¸Šå¼€å¯äº† dify èŠå¤©åŠŸèƒ½:

```javascript
function loadStylesheet(href) {
  const link = document.createElement('link');
  link.rel = 'stylesheet';
  link.href = href;
  document.head.appendChild(link);
}

function loadScript(src, async = true) {
  const script = document.createElement('script');
  script.src = src;
  script.async = async;
  document.body.appendChild(script);
}

function isMobileDevice() {
  const userAgent = navigator.userAgent || navigator.vendor || window.opera;
  return /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent.toLowerCase());
}

if (!isMobileDevice()) {
  // å¦‚æœä¸æ˜¯ç§»åŠ¨è®¾å¤‡ï¼ŒåŠ¨æ€åŠ è½½CSSå’ŒJSæ–‡ä»¶
  loadStylesheet('https://cdn.dong4j.site/source/static/dify-chat.css');
  loadScript('https://cdn.dong4j.site/source/static/dify-chat.embed.min.js');
  loadScript('https://cdn.dong4j.site/source/static/dify-chat.js');
}
```



æ•´ä½“æ•ˆæœ:

![20250211191000_YbycCSgV.webp](https://cdn.dong4j.site/source/image/20250211191000_YbycCSgV.webp)

## æ€»ç»“

ç›®å‰çŸ¥è¯†åº“è¿˜åœ¨æŒç»­å»ºè®¾, å› ä¸ºç°åœ¨ DS çš„æ¥å£è¿˜ä¸å¤ªç¨³å®š, ç°åœ¨è¿˜ä½¿ç”¨çš„ GLM4 æ¥æä¾› AI å¯¹è¯æœåŠ¡, åæœŸä¼šå°† LLM æœåŠ¡æ›´æ¢ä¸º DeepSeek-R1.

## [æ ‘è“æ´¾é›†æˆ PCA9685 èˆµæœºæ§åˆ¶ä¸æµåª’ä½“æœåŠ¡å™¨è§†é¢‘æ¨æµçš„ç»¼åˆåº”ç”¨](https://blog.dong4j.site/posts/a21c0fd1.md)

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ç®€ä»‹

åœ¨ [[raspberry-pi-stream|åŸºäºæ ‘è“æ´¾çš„è§†é¢‘æ¨æµæ–¹æ¡ˆ]] æˆ‘ä»¬å°è¯•äº†é€šè¿‡æ ‘è“æ´¾æ¨æµåˆ°æµåª’ä½“æœåŠ¡å™¨, ç„¶åé€šè¿‡ Web æŸ¥çœ‹è§†é¢‘, è¿™æ¬¡æˆ‘ä»¬æ¥å°è¯•ä¸€ä¸‹é€šè¿‡æ ‘è“æ´¾æ§åˆ¶èˆµæœº.

æƒ³æ³•è¿™è¿™æ ·çš„, ä½¿ç”¨ä¸€ä¸ª Web é¡µé¢å®æ—¶å±•ç¤º 2 ä¸ªæ‘„åƒå¤´çš„ç”»é¢, ç„¶åé€šè¿‡ PCA9685 èˆµæœºæ¥æ§åˆ¶æ‘„åƒå¤´è§’åº¦.è¿™æ ·å°±å¯ä»¥å®ç°ä¸€ä¸ªç®€å•çš„ç›‘æ§äº†.

## PCA9685

PCA9685 æ˜¯ NXP ç”Ÿäº§çš„ä¸€æ¬¾ 16 é€šé“ PWMï¼ˆè„‰å®½è°ƒåˆ¶ï¼‰æ§åˆ¶å™¨ï¼Œä¸»è¦ç”¨äºé©±åŠ¨ LED æˆ–èˆµæœºï¼Œå¹¿æ³›åº”ç”¨äºæœºå™¨äººã€ç¯å…‰æ§åˆ¶å’Œ DIY ç”µå­é¡¹ç›®ã€‚

ä¸»è¦ç‰¹ç‚¹

- 16 è·¯ç‹¬ç«‹ PWM è¾“å‡ºï¼ˆæ¯ä¸ªé€šé“ 12 ä½åˆ†è¾¨ç‡ï¼Œ0~4096 å¯è°ƒï¼‰ã€‚
- IÂ²C æ¥å£é€šä¿¡ï¼Œåœ°å€å¯è°ƒï¼ˆ0x40~0x7Fï¼‰ã€‚
- é¢‘ç‡å¯è°ƒï¼Œæ”¯æŒ 24Hz~1526Hz çš„ PWM é¢‘ç‡ã€‚
- æ”¯æŒå¤–éƒ¨æ—¶é’Ÿï¼ˆé€‚ç”¨äºéœ€è¦æ›´é«˜ç²¾åº¦çš„åœºæ™¯ï¼‰ã€‚
- å¯ç¼–ç¨‹ LED äº®åº¦æ§åˆ¶ï¼Œæ”¯æŒå•ç‹¬å’Œåˆ†ç»„æ§åˆ¶ã€‚
- å·¥ä½œç”µå‹ï¼š2.3V~5.5Vï¼ˆå…¼å®¹ 3.3V å’Œ 5V é€»è¾‘ç”µå¹³ï¼‰ã€‚
- æœ€å¤§è¾“å‡ºç”µæµï¼šæ¯ä¸ªé€šé“ 25mAï¼ˆé»˜è®¤ï¼‰ï¼Œæœ€å¤§ 400mAï¼ˆæ‰€æœ‰é€šé“æ€»ç”µæµï¼‰ã€‚

![20250212192831_nZXdtUU9.webp](https://cdn.dong4j.site/source/image/20250212192831_nZXdtUU9.webp)

**æ¥çº¿æ–¹å¼:**

![20250212211654_e9WCc1VN.webp](https://cdn.dong4j.site/source/image/20250212211654_e9WCc1VN.webp)

**å¤–æ¥ä¾›ç”µ:**

![20250212211654_iXBUaeEi.webp](https://cdn.dong4j.site/source/image/20250212211654_iXBUaeEi.webp)

é©±åŠ¨æ¿å³ä¾§çš„é»‘é»„è“çº¢ 4 æ¡çº¿çš„æ¥æ³•æ¯«æ— äº‰è®®ã€‚å…³é”®æ˜¯æœ€åº•ä¸‹æˆ‘è‡ªå·±åŠ ä¸Šçš„ä¸€æ ¹ç´«è‰²çš„ v+ çº¿ï¼Œè¿™æ ¹çº¿è¦è¿æ¥è‡³ç”µæºæ‰èƒ½é©±åŠ¨èˆµæœºï¼Œè‡³äºæ˜¯ 3v ç”µæºè¿˜æ˜¯ 5v ç”µæºï¼Œæ˜¯æ ‘è“æ´¾ GPIO å£æä¾›çš„è¿˜æ˜¯å¤–æ¥ç”µæºéƒ½æ— æ‰€è°“ï¼Œåªè¦æ¥ä¸Šç”µæºå³å¯ã€‚

ä¸€èˆ¬æ¥ 3v çš„å°±å¤Ÿç”¨äº†ï¼Œå¦‚æœæœ‰æ‰©å±•æ¿çš„è¯ï¼Œå°±æ¥åˆ°æ ‘è“æ´¾çš„ 1 å· 3v ä¾›ç”µå£ã€‚å¦‚æœæ²¡æœ‰æ‹“å±•æ¿çš„è¯ï¼Œ3v ä¾›ç”µå£å·²ç»è¢«é©±åŠ¨æ¿çš„ vcc ä¾›ç”µå£å äº†ï¼Œé‚£æ¥æ ‘è“æ´¾ 2 å· 5v ä¾›ç”µå£ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè¿™æ˜¯æ¯”è¾ƒç®€æ´çš„æ¥çº¿æ–¹å¼ã€‚åæ­£èˆµæœºå¦‚æœæ²¡åŠ¨é™ï¼Œå¤šåŠæ˜¯ç”µæºçº¿çš„é—®é¢˜ã€‚

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œconfig.txt æ–‡ä»¶é…ç½®å®Œæˆåï¼Œç”µæºå¦‚æœæ¥é€šçš„è¯ï¼Œæ— éœ€ä»»ä½•ä»£ç èˆµæœºå°±ä¼šå¼€å§‹æ—‹è½¬è‡³æœ€å¤§è§’åº¦ã€‚

æ ‘è“æ´¾å’Œèˆµæœºé©±åŠ¨æ¿æŒ‰ç…§æ•™ç¨‹åˆ†åˆ«è¿æ¥å¯¹åº” GND,SDA.0,SCL0,VCC,V+ å³å¯.

æ³¨æ„æ˜¯ SDA.0,SCL.0,ä¸è¦è¿æˆäº† SDA.1,SCL.1

## èˆµæœº

è´­ä¹°çš„ SG90 MG90S 9g èˆµæœº:

![20250212192831_8GLVKcak.webp](https://cdn.dong4j.site/source/image/20250212192831_8GLVKcak.webp)

## æ ‘è“æ´¾é…ç½®

1. æ ‘è“æ´¾å¼€å¯ I2C

```
sudo raspi-config -> 5.Interfacing Options -> P5 I2Cã€€è®¾ç½®enableï¼Œç„¶åé‡å¯æ ‘è“æ´¾
```

2. i2c-tools æµ‹è¯•èˆµæœºè¿æ¥çŠ¶æ€

```
sudo apt-get install i2c-tools
sudo i2cdetect -y 1
```

3. ä½¿ç”¨ PCA9685 python åº“æ§åˆ¶èˆµæœº

   ä¾‹å­æºç  [åœ¨è¿™é‡Œ](https://github.com/adafruit/Adafruit_Python_PCA9685.git)(example ç›®å½•ä¸‹)

   ```python
   sudo pip3 install adafruit-pca9685
   python3 ./simpletest.py
   ```

## é›†æˆ

### å¯åŠ¨æµåª’ä½“æœåŠ¡å™¨

ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘å·²ç»å†™äº†ä¸€ä¸ªå¯åŠ¨è„šæœ¬:

```bash
#!/bin/bash

# æ£€æŸ¥æ˜¯å¦æœ‰ -h å‚æ•°
if [[ "$1" == "-h" ]]; then
    echo "ä½¿ç”¨æ–¹æ³•: $0 [åè®®] [æ‘„åƒå¤´ç¼–å·] [å®½åº¦] [é«˜åº¦] [URLåœ°å€]"
    echo "ç¤ºä¾‹: $0 rtmp 0 1920 1080 192.168.21.7/pi5b, æœ€ç»ˆURL: rtmp://192.168.21.7/pi5b/0"
    echo
    echo "å‚æ•°è¯´æ˜:"
    echo "  åè®®    : rtmp æˆ– rtsp (ç”¨äºé€‰æ‹©æµåª’ä½“ä¼ è¾“åè®®)"
    echo "  æ‘„åƒå¤´ç¼–å· : æ‘„åƒå¤´ç¼–å· (ä¾‹å¦‚ 0 æˆ– 1)"
    echo "  å®½åº¦    : åˆ†è¾¨ç‡å®½åº¦ (ä¾‹å¦‚ 1920)"
    echo "  é«˜åº¦    : åˆ†è¾¨ç‡é«˜åº¦ (ä¾‹å¦‚ 1080)"
    echo "  URLåœ°å€  : åŸºç¡€çš„ URL åœ°å€ (ä¾‹å¦‚ 192.168.21.7/pi5b)"
    echo
    echo "RTMP æ¨æµè¯´æ˜:"
    echo "  192.168.21.7:1935/pi5b --> rtmp://192.168.21.7:1935/pi5b/0 æ¨æµè‡³ m920x çš„ zlm æœåŠ¡, é»˜è®¤ç«¯å£ 1935, ä¼šå‡ºç°åœ¨ WVP çš„æ¨æµåˆ—è¡¨ä¸­"
    echo "  192.168.21.7:41935/pi5b --> rtmp://192.168.21.7:41935/pi5b/0 æ¨æµè‡³ m920x çš„ mediamtx æœåŠ¡, ä½¿ç”¨ mediamtx æœåŠ¡çš„ WebRTC è®¿é—®: http://192.168.21.7:48889/pi5b/{CAMERA}"
    echo "  127.0.0.1:1935/pi5b --> æœ¬åœ°æ¨æµè‡³ mediamtx æœåŠ¡, ä½¿ç”¨ WebRTC è®¿é—®: http://ip:8889/pi5b/{CAMERA}"
    echo "  ===================================================="
    echo "  ./stream.sh rtmp 0 1920 1080 192.168.21.7/pi5a"
    echo "  ./stream.sh rtmp 0 2560 1440 192.168.21.7:41935/pi5a"
    echo "  ./stream.sh rtmp 0 3840 2160 192.168.21.7/pi5a"
    echo "  ./stream.sh rtmp 0 3840 2160 127.0.0.1/pi5a"
    echo
    echo "RTSP æ¨æµè¯´æ˜:"
    echo "  192.168.21.7:554/pi5b --> rtsp://192.168.21.7:554/pi5a/0 æ¨æµè‡³ m920x çš„ zlm æœåŠ¡, é»˜è®¤ç«¯å£ 554, ä¼šå‡ºç°åœ¨ WVP çš„æ¨æµåˆ—è¡¨ä¸­"
    echo "  192.168.21.7:48554/pi5b --> rtsp://192.168.21.7:48554/pi5b/0 æ¨æµè‡³ m920x çš„ mediamtx æœåŠ¡, ä½¿ç”¨ WebRTC è®¿é—®: http://192.168.21.7:48889/pi5b/{CAMERA}"
    echo "  127.0.0.1:8554/pi5b --> æœ¬åœ°æ¨æµè‡³ mediamtx æœåŠ¡, ä½¿ç”¨ WebRTC è®¿é—®: http://ip:8889/pi5b/{CAMERA}"
    echo "  ===================================================="
    echo "  ./stream.sh rtsp 1 1920 1080 192.168.21.7/pi5b"
    echo "  ./stream.sh rtsp 1 2560 1440 192.168.21.7:48554/pi5a"
    echo "  ./stream.sh rtsp 1 3840 2160 192.168.21.7:8554/pi5a"
    echo "  ./stream.sh rtsp 1 3840 2160 127.0.0.1:8554/pi5a"
    exit 0
fi

# å‚æ•°èµ‹å€¼
PROTOCOL=$1        # ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºåè®® (rtmp æˆ– rtsp)
CAMERA=$2          # ç¬¬äºŒä¸ªå‚æ•°ä¸ºæ‘„åƒå¤´ç¼–å·
WIDTH=$3           # ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºå®½åº¦ 1920x1080 2560x1440 3840x2160
HEIGHT=$4          # ç¬¬å››ä¸ªå‚æ•°ä¸ºé«˜åº¦
URL=$5             # ç¬¬äº”ä¸ªå‚æ•°ä¸ºåŸºç¡€çš„ URL åœ°å€

# æ ¹æ®åè®®åŠ¨æ€è®¾ç½®è¾“å‡ºæµåœ°å€å’Œæ ¼å¼
if [ "$PROTOCOL" == "rtmp" ]; then
    OUTPUT_URL="rtmp://${URL}/${CAMERA}"
    FFMPEG_FORMAT="flv"
elif [ "$PROTOCOL" == "rtsp" ]; then
    OUTPUT_URL="rtsp://${URL}/${CAMERA}"
    FFMPEG_FORMAT="rtsp"
else
    echo "ä¸æ”¯æŒçš„åè®®: $PROTOCOL"
    exit 1
fi

# è¿è¡Œå‘½ä»¤
nohup bash -c "rpicam-vid --hflip --vflip -t 0 --camera $CAMERA --nopreview --codec yuv420 --width $WIDTH --height $HEIGHT --inline --listen -o - | ffmpeg -f rawvideo -pix_fmt yuv420p -s:v ${WIDTH}x${HEIGHT} -i /dev/stdin -c:v libx264 -preset ultrafast -tune zerolatency -f $FFMPEG_FORMAT $OUTPUT_URL" > ${PROTOCOL}-cam${CAMERA}.log 2>&1 &
```

å› ä¸º Web ç«¯å¤„ç† WebRTC è¿˜æœ‰ç‚¹éº»çƒ¦, æ‰€ä»¥è¿™é‡Œå…ˆä½¿ç”¨ ZLM å°†è§†é¢‘æµè½¬æˆ mp4, ç„¶åç›´æ¥ä½¿ç”¨ `video` æ ‡ç­¾æ’­æ”¾è§†é¢‘.

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†è§†é¢‘æµæ¨é€åˆ° WVP:

```bash
# RTMP æ¨æµ
./stream.sh rtmp 0 1920 1080 192.168.21.7/pi5a
# RTSP æ¨æµ
./stream.sh rtsp 1 1920 1080 192.168.21.7/pi5a
```

ç„¶ååœ¨ WVP æ§åˆ¶å°åº”è¯¥èƒ½çœ‹åˆ°è§†é¢‘æµäº†:

![20250212185748_TCP4MjUl.webp](https://cdn.dong4j.site/source/image/20250212185748_TCP4MjUl.webp)

### åµŒå…¥åˆ° Web UI

å¹¶æ’æ˜¾ç¤º 2 ä¸ªæ‘„åƒå¤´çš„ç”»é¢:

![20250212185909_ILxW2kgL.webp](https://cdn.dong4j.site/source/image/20250212185909_ILxW2kgL.webp)

### èˆµæœºæ§åˆ¶

æˆ‘å°†èˆµæœºè¿æ¥åˆ°äº† Zero 2W ä¸Š, ç„¶åæ‘„åƒå¤´ä¸æ ‘è“æ´¾ 5 è¿æ¥, æ‰€ä»¥èˆµæœºçš„æ§åˆ¶æˆ‘éœ€è¦åœ¨ Zero 2W ä¸Šå¤„ç†.

![20250212192838_Js0nHyfm.webp](https://cdn.dong4j.site/source/image/20250212192838_Js0nHyfm.webp)

```python
from flask import Flask, render_template, request, jsonify
from flask_cors import CORS
import Adafruit_PCA9685
import time
import threading
import math
from concurrent.futures import ThreadPoolExecutor
import re

app = Flask(__name__)
CORS(app, resources={r"/*": {"origins": "*"}})  # å…è®¸æ‰€æœ‰æ¥æºçš„è·¨åŸŸè¯·æ±‚

# åˆå§‹åŒ– PCA9685
pwm = Adafruit_PCA9685.PCA9685()

# é…ç½®èˆµæœºçš„æœ€å°å’Œæœ€å¤§è„‰å†²é•¿åº¦
servo_min = 150
servo_max = 600
step_size = 5  # å¢åŠ æ­¥é•¿ï¼Œä½†ä¿æŒç›¸å¯¹å°çš„å€¼
update_frequency = 100  # Hzï¼Œè¿›ä¸€æ­¥å¢åŠ æ›´æ–°é¢‘ç‡
move_duration = 0.05  # ç§’ï¼Œå‡å°‘å•æ¬¡ç§»åŠ¨çš„æŒç»­æ—¶é—´

# è®¾ç½®é¢‘ç‡ä¸º 60Hz
pwm.set_pwm_freq(60)

# åˆå§‹åŒ–èˆµæœºä½ç½®
servo0_position = 375
servo1_position = 445

# åˆ›å»ºä¸€ä¸ªé”æ¥ä¿æŠ¤å…±äº«èµ„æº
lock = threading.Lock()

# åˆ›å»ºä¸€ä¸ªäº‹ä»¶æ¥æ§åˆ¶è¿ç»­è°ƒæ•´
continuous_event = threading.Event()

# æ›´æ–°èˆµæœºä½ç½®çš„å‡½æ•°
def update_servo(channel, position):
    pwm.set_pwm(channel, 0, position)

# åˆå§‹åŒ–èˆµæœºçš„å‡½æ•°
def initialize_servos():
    global servo0_position, servo1_position
    with lock:
        update_servo(0, servo0_position)
        update_servo(1, servo1_position)
    print("èˆµæœºå·²åˆå§‹åŒ–åˆ°ä¸­é—´ä½ç½®")

# å¹³æ»‘ç§»åŠ¨å‡½æ•°
def smooth_move(channel, start, end, duration):
    steps = int(duration * update_frequency)
    for i in range(steps):
        t = i / steps
        # ä½¿ç”¨å¹³æ–¹å‡½æ•°æ¥åˆ›å»ºæ›´å¿«ä½†ä»ç„¶å¹³æ»‘çš„åŠ é€Ÿå’Œå‡é€Ÿæ•ˆæœ
        smooth_t = t * t * (3 - 2 * t)
        position = int(start + (end - start) * smooth_t)
        update_servo(channel, position)
        time.sleep(1 / update_frequency)

# è°ƒæ•´èˆµæœºçš„å‡½æ•°
def adjust_servo(direction):
    global servo0_position, servo1_position
    with lock:
        if direction == 'left':
            target = max(servo_min, servo0_position + step_size)
            smooth_move(0, servo0_position, target, move_duration)
            servo0_position = target
        elif direction == 'right':
            target = min(servo_max, servo0_position - step_size)
            smooth_move(0, servo0_position, target, move_duration)
            servo0_position = target
        elif direction == 'up':
            target = max(servo_min, servo1_position - step_size)
            smooth_move(1, servo1_position, target, move_duration)
            servo1_position = target
        elif direction == 'down':
            target = min(servo_max, servo1_position + step_size)
            smooth_move(1, servo1_position, target, move_duration)
            servo1_position = target
    return servo0_position, servo1_position

def continuous_adjust(direction):
    while not continuous_event.is_set():
        adjust_servo(direction)

def reset_servos():
    with lock:
        update_servo(0, 375)
        update_servo(1, 445)
    print("èˆµæœºå·²é‡ç½®åˆ°ä¸­é—´ä½ç½®")
    return 375, 445

# æ–°å¢ï¼šå¤„ç†æ‘‡æ†è¾“å…¥çš„å‡½æ•°
def handle_joystick(horizontal, vertical, last_servo0, last_servo1):
    global servo0_position, servo1_position

    # ä½¿ç”¨ä¸Šæ¬¡è®°å½•çš„ä½ç½®ä½œä¸ºèµ·å§‹ç‚¹
    servo0_position = last_servo0
    servo1_position = last_servo1

    # è®¡ç®—ç§»åŠ¨è·ç¦»
    distance = math.sqrt(horizontal**2 + vertical**2)

    # å¦‚æœç§»åŠ¨è·ç¦»å¤ªå°ï¼Œä¿æŒå½“å‰ä½ç½®
    if distance < 0.1:
        return servo0_position, servo1_position

    # è®¡ç®—æ°´å¹³å’Œå‚ç›´æ–¹å‘çš„ç§»åŠ¨é‡
    horizontal_move = int(horizontal * step_size * 2)
    vertical_move = int(vertical * step_size * 2)

    with lock:
        # æ›´æ–°æ°´å¹³èˆµæœºä½ç½®
        new_servo0 = max(servo_min, min(servo_max, servo0_position + horizontal_move))
        smooth_move(0, servo0_position, new_servo0, move_duration)
        servo0_position = new_servo0

        # æ›´æ–°å‚ç›´èˆµæœºä½ç½®
        new_servo1 = max(servo_min, min(servo_max, servo1_position - vertical_move))
        smooth_move(1, servo1_position, new_servo1, move_duration)
        servo1_position = new_servo1

    return servo0_position, servo1_position

def get_video_type(url):
    """
    æ ¹æ® URL ç¡®å®šè§†é¢‘ç±»å‹
    """
    if re.search(r'\.flv($|\?)', url):
        return 'flv'
    elif re.search(r'\.m3u8($|\?)', url):
        return 'm3u8'
    elif re.search(r'\.mp4($|\?)', url):
        return 'mp4'
    else:
        # å¦‚æœæ— æ³•ç¡®å®šï¼Œå¯ä»¥è¿”å›ä¸€ä¸ªé»˜è®¤å€¼æˆ–è€… None
        return None

@app.route('/')
def index():
    video_url = "http://192.168.21.7:9090/pi5a/0.live.mp4"  # ä»é…ç½®æˆ–æ•°æ®åº“è·å–
    video_type = get_video_type(video_url)

    if video_type is None:
        # æˆ–è€…è¿”å›é”™è¯¯
        return "æ— æ³•ç¡®å®šè§†é¢‘ç±»å‹", 400

    return render_template('index.html', video_url=video_url, video_type=video_type)

@app.route('/control', methods=['POST'])
def control():
    direction = request.json['direction']
    action = request.json['action']  # 'single', 'start', æˆ– 'stop'

    if action == 'single':
        servo0, servo1 = adjust_servo(direction)
    elif action == 'start':
        continuous_event.clear()
        threading.Thread(target=continuous_adjust, args=(direction,), daemon=True).start()
        servo0, servo1 = servo0_position, servo1_position
    else:  # 'stop'
        continuous_event.set()
        servo0, servo1 = servo0_position, servo1_position

    return jsonify({
        'servo0': servo0,
        'servo1': servo1
    })

@app.route('/reset', methods=['POST'])
def reset():
    servo0, servo1 = reset_servos()
    return jsonify({
        'servo0': servo0,
        'servo1': servo1
    })

@app.route('/joystick-control', methods=['POST'])
def joystick_control():
    data = request.json
    horizontal = data['horizontal']
    vertical = data['vertical']
    last_servo0 = data['lastServo0']
    last_servo1 = data['lastServo1']

    servo0, servo1 = handle_joystick(horizontal, vertical, last_servo0, last_servo1)

    return jsonify({
        'servo0': servo0,
        'servo1': servo1
    })

@app.after_request
def add_security_headers(response):
    # å®Œå…¨ç¦ç”¨ CSP
    response.headers['Content-Security-Policy'] = "default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;"

    # CORS headers
    response.headers['Access-Control-Allow-Origin'] = '*'
    response.headers['Access-Control-Allow-Methods'] = 'GET, POST, PUT, DELETE, OPTIONS'
    response.headers['Access-Control-Allow-Headers'] = 'Content-Type, Authorization'

    return response

if __name__ == '__main__':
    # åœ¨å¯åŠ¨æœåŠ¡å™¨ä¹‹å‰åˆå§‹åŒ–èˆµæœº
    initialize_servos()
    app.run(host='0.0.0.0', port=5000, debug=False, threaded=True)
```

**å®Œæ•´çš„ HTML ä»£ç :**

```html
<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ‘„åƒå¤´æ§åˆ¶ç³»ç»Ÿ</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background-color: #f0f0f0;
      }
      .container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        padding: 10px;
        box-sizing: border-box;
      }
      .video-container {
        display: flex;
        flex: 1;
        gap: 10px;
        margin-bottom: 10px;
        min-height: 0; /* é˜²æ­¢æº¢å‡º */
      }
      .video-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #000;
        border-radius: 8px;
        overflow: hidden;
      }
      .video-wrapper video {
        width: 100%;
        height: 100%;
        object-fit: contain; /* æ”¹å› contain ä»¥æ˜¾ç¤ºå®Œæ•´è§†é¢‘ */
      }
      .control-panel {
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #fff;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        max-width: 800px;
        margin: 0 auto;
      }
      .control-row {
        display: flex;
        justify-content: space-between;
        align-items: center; /* æ·»åŠ è¿™è¡Œä»¥å‚ç›´å±…ä¸­å¯¹é½ */
        width: 100%;
        margin-bottom: 10px;
      }
      .control-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .control-grid {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
      }
      .control-btn {
        width: 60px;
        height: 60px;
        font-size: 20px;
        margin: 2px;
        border: none;
        background-color: #007bff;
        color: white;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .control-btn:hover {
        background-color: #0056b3;
      }
      .control-btn:active {
        background-color: #004085;
      }
      .servo-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center; /* å‚ç›´å±…ä¸­ */
        align-items: center; /* æ°´å¹³å±…ä¸­ */
        text-align: center;
        margin: 0 20px;
      }
      #reset {
        width: calc(100% - 20px);
        height: 40px;
        font-size: 16px;
        margin-top: 10px;
        border: none;
        background-color: #28a745;
        color: white;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #reset:hover {
        background-color: #218838;
      }
      #reset:active {
        background-color: #1e7e34;
      }
      #joystick-container {
        width: 150px;
        height: 150px;
        position: relative;
      }
      #joystick {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background-color: #f0f0f0;
        position: relative;
        overflow: visible; /* æ”¹ä¸º visible */
      }
      #joystick-knob {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #007bff;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        cursor: pointer;
        transition: transform 0.1s ease-out; /* æ·»åŠ å¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
      }
      @media (max-height: 600px) {
        .control-btn {
          width: 40px;
          height: 40px;
          font-size: 16px;
        }
        #reset {
          width: calc(120px + 10px);
          height: 30px;
          font-size: 14px;
        }
      }
    </style>
    <link
      href="https://vjs.zencdn.net/7.20.3/video-js.min.css"
      rel="stylesheet"
    />
    <script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-contrib-hls/5.15.0/videojs-contrib-hls.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flv.js/1.6.2/flv.min.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="video-container">
        <div class="video-wrapper">
          <video
            id="my-video"
            class="video-js"
            controls
            preload="auto"
            width="640"
            height="360"
          >
            <p class="vjs-no-js">
              To view this video please enable JavaScript, and consider
              upgrading to a web browser that
              <a href="https://videojs.com/html5-video-support/" target="_blank"
                >supports HTML5 video</a
              >
            </p>
          </video>
        </div>
        <div class="video-wrapper">
          <video
            src="http://192.168.21.7:9090/pi5a/1.live.mp4"
            onerror="handleVideoError(this)"
            autoplay
            muted
            loop
          ></video>
        </div>
      </div>
      <div class="control-panel">
        <div class="control-row">
          <div class="control-section">
            <div class="control-grid">
              <div class="control-row">
                <button class="control-btn" style="visibility: hidden;">
                  â†
                </button>
                <button
                  class="control-btn"
                  onclick="singleControl('up')"
                  onmousedown="startControl('up')"
                  onmouseup="stopControl()"
                  onmouseleave="stopControl()"
                >
                  â†‘
                </button>
                <button class="control-btn" style="visibility: hidden;">
                  â†’
                </button>
              </div>
              <div class="control-row">
                <button
                  class="control-btn"
                  onclick="singleControl('left')"
                  onmousedown="startControl('left')"
                  onmouseup="stopControl()"
                  onmouseleave="stopControl()"
                >
                  â†
                </button>
                <button
                  class="control-btn"
                  onclick="singleControl('down')"
                  onmousedown="startControl('down')"
                  onmouseup="stopControl()"
                  onmouseleave="stopControl()"
                >
                  â†“
                </button>
                <button
                  class="control-btn"
                  onclick="singleControl('right')"
                  onmousedown="startControl('right')"
                  onmouseup="stopControl()"
                  onmouseleave="stopControl()"
                >
                  â†’
                </button>
              </div>
            </div>
          </div>
          <div class="servo-info">
            <p>æ°´å¹³èˆµæœºä½ç½®: <span id="servo0">375</span></p>
            <p>å‚ç›´èˆµæœºä½ç½®: <span id="servo1">445</span></p>
          </div>
          <div class="control-section">
            <div id="joystick-container">
              <div id="joystick">
                <div id="joystick-knob"></div>
              </div>
            </div>
          </div>
        </div>
        <button id="reset">å›æ­£</button>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      let pressTimer;

      function singleControl(direction) {
        clearTimeout(pressTimer);
        fetch("/control", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ direction: direction, action: "single" }),
        })
          .then((response) => response.json())
          .then(updateServoInfo)
          .catch(handleError);
      }

      function startControl(direction) {
        pressTimer = setTimeout(() => {
          fetch("/control", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ direction: direction, action: "start" }),
          })
            .then((response) => response.json())
            .then(updateServoInfo)
            .catch(handleError);
        }, 200); // 200ms å»¶è¿Ÿï¼ŒåŒºåˆ†å•å‡»å’Œé•¿æŒ‰
      }

      function stopControl() {
        clearTimeout(pressTimer);
        fetch("/control", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ direction: "stop", action: "stop" }),
        })
          .then((response) => response.json())
          .then(updateServoInfo)
          .catch(handleError);
      }

      function updateServoInfo(data) {
        document.getElementById("servo0").textContent = data.servo0;
        document.getElementById("servo1").textContent = data.servo1;
      }

      function handleError(error) {
        console.error("å‘ç”Ÿé”™è¯¯:", error);
        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç”¨æˆ·æç¤º
      }

      function handleVideoError(video) {
        console.error("è§†é¢‘åŠ è½½å¤±è´¥:", video.src);
        video.style.display = "none";
        video.parentElement.textContent = "è§†é¢‘åŠ è½½å¤±è´¥";
      }

      $(".control-btn")
        .on("mousedown touchstart", function (e) {
          e.preventDefault();
          var direction = $(this).attr("id");
          $.ajax({
            url: "/control",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ direction: direction, action: "start" }),
            success: function (response) {
              console.log(response);
            },
          });
        })
        .on("mouseup mouseleave touchend", function () {
          $.ajax({
            url: "/control",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ direction: "", action: "stop" }),
            success: function (response) {
              console.log(response);
            },
          });
        });

      $("#reset").on("click", function () {
        $.ajax({
          url: "/reset",
          method: "POST",
          success: function (response) {
            console.log("èˆµæœºå·²é‡ç½®", response);
            // ä½¿ç”¨è¿”å›çš„æ•°æ®æ›´æ–°èˆµæœºä½ç½®æ˜¾ç¤º
            updateServoInfo(response);
          },
          error: function (xhr, status, error) {
            console.error("é‡ç½®å¤±è´¥:", error);
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é”™è¯¯æç¤º
          },
        });
      });

      document.addEventListener(
        "touchmove",
        function (e) {
          e.preventDefault();
        },
        { passive: false }
      );

      // æ·»åŠ æ‘‡æ†æ§åˆ¶ä»£ç 
      const joystick = document.getElementById("joystick");
      const knob = document.getElementById("joystick-knob");
      let isDragging = false;
      let centerX, centerY, knobRadius, joystickRadius;

      let lastServo0Position = 375; // åˆå§‹æ°´å¹³èˆµæœºç½®
      let lastServo1Position = 445; // åˆå§‹å‚ç›´èˆµæœºä½ç½®

      function initJoystick() {
        const joystickRect = joystick.getBoundingClientRect();
        centerX = joystickRect.width / 2;
        centerY = joystickRect.height / 2;
        joystickRadius = joystickRect.width / 2;
        knobRadius = knob.offsetWidth / 2;
      }

      function handleJoystickMove(e) {
        if (!isDragging) return;

        const joystickRect = joystick.getBoundingClientRect();
        let mouseX = e.clientX - joystickRect.left;
        let mouseY = e.clientY - joystickRect.top;

        // è®¡ç®—ä¸ä¸­å¿ƒçš„è·ç¦»
        let deltaX = mouseX - centerX;
        let deltaY = mouseY - centerY;
        let distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

        // å¦‚æœè¶…å‡ºè¾¹ç•Œï¼Œè¿›è¡Œé™åˆ¶
        if (distance > joystickRadius - knobRadius) {
          let angle = Math.atan2(deltaY, deltaX);
          deltaX = Math.cos(angle) * (joystickRadius - knobRadius);
          deltaY = Math.sin(angle) * (joystickRadius - knobRadius);
        }

        // æ›´æ–°æ‘‡æ†ä½ç½®
        knob.style.transform = `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY}px))`;

        // è®¡ç®—è§’åº¦å’Œå¼ºåº¦
        let angle = (Math.atan2(deltaY, deltaX) * 180) / Math.PI;
        let strength = Math.min(distance / (joystickRadius - knobRadius), 1);

        // å‘é€æ§åˆ¶å‘½ä»¤
        sendJoystickControl(angle, strength);
      }

      function sendJoystickControl(angle, strength) {
        let horizontalMove = Math.cos((angle * Math.PI) / 180) * strength;
        let verticalMove = -Math.sin((angle * Math.PI) / 180) * strength;

        fetch("/joystick-control", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            horizontal: horizontalMove,
            vertical: verticalMove,
            lastServo0: lastServo0Position,
            lastServo1: lastServo1Position,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            updateServoInfo(data);
            lastServo0Position = data.servo0;
            lastServo1Position = data.servo1;
          })
          .catch((error) => console.error("Error:", error));
      }

      function resetJoystick() {
        isDragging = false;
        knob.style.transform = "translate(-50%, -50%)";
        sendJoystickControl(0, 0); // å‘é€ä¸­å¿ƒä½ç½®ä¿¡å·
      }

      joystick.addEventListener("mousedown", (e) => {
        isDragging = true;
        handleJoystickMove(e);
      });

      document.addEventListener("mousemove", handleJoystickMove);
      document.addEventListener("mouseup", resetJoystick);

      // æ·»åŠ è§¦æ‘¸äº‹ä»¶æ”¯æŒ
      joystick.addEventListener("touchstart", (e) => {
        isDragging = true;
        handleJoystickMove(e.touches[0]);
      });
      joystick.addEventListener("touchmove", (e) => {
        e.preventDefault(); // é˜²æ­¢é¡µé¢æ»šåŠ¨
        handleJoystickMove(e.touches[0]);
      });
      joystick.addEventListener("touchend", resetJoystick);

      window.addEventListener("resize", initJoystick);
      initJoystick();

      // åœ¨ <script> æ ‡ç­¾å†…æ·»åŠ ä»¥ä¸‹ä»£ç 

      let player;

      function initializePlayer(videoUrl, videoType) {
        if (player) {
          player.dispose();
        }

        let options = {
          fluid: true,
          controls: true,
          preload: "auto",
        };

        switch (videoType) {
          case "flv":
            options.techOrder = ["html5", "flvjs"];
            options.sources = [
              {
                type: "video/x-flv",
                src: videoUrl,
              },
            ];
            break;
          case "m3u8":
            options.techOrder = ["html5", "hlsjs"];
            options.sources = [
              {
                type: "application/x-mpegURL",
                src: videoUrl,
              },
            ];
            break;
          case "mp4":
            options.sources = [
              {
                type: "video/mp4",
                src: videoUrl,
              },
            ];
            break;
          default:
            console.error("Unsupported video type");
            return;
        }

        player = videojs("my-video", options, function onPlayerReady() {
          console.log("Player is ready");
          this.play();
        });
      }

      // ä½¿ç”¨ç¤ºä¾‹
      // initializePlayer('http://example.com/video.mp4', 'mp4');

      // åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ’­æ”¾å™¨
      window.addEventListener("load", function () {
        // ä»æœåŠ¡å™¨è·å–è§†é¢‘ URL å’Œç±»å‹ï¼Œæˆ–è€…ç›´æ¥åœ¨è¿™é‡Œè®¾ç½®
        let videoUrl = "{{ video_url }}"; // å‡è®¾è¿™æ˜¯ä»æœåŠ¡å™¨ä¼ é€’çš„å˜é‡
        let videoType = "{{ video_type }}"; // å¯ä»¥æ˜¯ 'flv', 'm3u8', æˆ– 'mp4'
        initializePlayer(videoUrl, videoType);
      });
    </script>
  </body>
</html>
```

å³è¾¹çš„è§†é¢‘æ˜¯ç›´æ¥ä½¿ç”¨ `video` æ ‡ç­¾å†™æ­»çš„: `http://192.168.21.7:9090/pi5a/1.live.mp4`, å¦ä¸€ä¸ªä½¿ç”¨ `videojs` å¹¶ä»åç«¯è·å–è§†é¢‘åœ°å€: `http://192.168.21.7:9090/pi5a/0.live.mp4`

> è¿™é‡Œè§£é‡Šä¸€ä¸‹, å› ä¸ºæˆ‘ä»¬å‰é¢åˆ†åˆ«ä½¿ç”¨ rtsp å’Œ rtmp å°†è§†é¢‘æµæ¨é€åˆ°äº† WVP, è¿™é‡Œçš„ 9090 å°± ZLM æœåŠ¡çš„ç«¯å£, æˆ‘ä»¬ç›´æ¥æŒ‰ç…§è§„åˆ™å‡­å€Ÿ ZLM å³å¯, å¦‚æœä½¿ç”¨è¿‡ ZLM åº”è¯¥ä¸éš¾ç†è§£, æˆ–è€…å¯ä»¥ç›´æ¥åœ¨ WVP é¡µé¢å›å»æ’­æ”¾åœ°å€:
>
> ![20250212191120_4V6TuXsz.webp](https://cdn.dong4j.site/source/image/20250212191120_4V6TuXsz.webp)

## æ•ˆæœå±•ç¤º

![20250212191238_CRx4L2ui.webp](https://cdn.dong4j.site/source/image/20250212191238_CRx4L2ui.webp)

{% video https://cdn.dong4j.site/source/image/PCA9685.mp4 %}

ä»£ç å¼€æºåœ¨ https://github.com/dong4j/pi-pca9685-controller

## å‚è€ƒèµ„æ–™

- [æ ‘è“æ´¾æ­å»ºç®€æ˜“è¿œç¨‹ç›‘æ§,åˆ©ç”¨èˆµæœºåˆ¶ä½œå¯æ—‹è½¬çš„æ‘„åƒå¤´](https://zhuanlan.zhihu.com/p/22805173)
- [æ ‘è“æ´¾ 3B+ PCA9685 èˆµæœºé©±åŠ¨æ¿æ§åˆ¶èˆµæœº](https://blog.csdn.net/zz531987464/article/details/100391715)
- [æ ‘è“æ´¾æ­å»ºç®€æ˜“è¿œç¨‹ç›‘æ§,åˆ©ç”¨èˆµæœºåˆ¶ä½œå¯æ—‹è½¬çš„æ‘„åƒå¤´](https://zhuanlan.zhihu.com/p/22805173)
- [æ€»çº¿èˆµæœºé©±åŠ¨æ¿ é›†æˆ ESP32 å’Œæ§åˆ¶ç”µè·¯ é€‚ç”¨äº ST/RSBL ç³»åˆ—æ€»çº¿èˆµæœº](https://www.waveshare.net/shop/Bus-Servo-Driver-HAT-A.htm)
- [ã€æ ‘è“æ´¾ C è¯­è¨€å¼€å‘ã€‘å®éªŒ 14ï¼šPS2 æ¸¸æˆæ‰‹æŸ„æ¨¡å—ï¼ˆå…³è” PCF8591ï¼‰\_æ ‘è“æ´¾ ps2 æ“çºµæ†å®éªŒ-CSDN åšå®¢](https://blog.csdn.net/muxuen/article/details/124753903)
- [æ ‘è“æ´¾åŸºç¡€å®éªŒ 14ï¼šPS2 æ“çºµæ†å®éªŒ\_ps2 æ“çºµæ†å’Œæ¶²æ™¶æ˜¾ç¤ºå™¨ å°†æ“çºµæ†çš„å˜åŒ–æ˜¾ç¤ºåœ¨æ¶²æ™¶æ˜¾ç¤ºå™¨ä¸Š-CSDN åšå®¢](https://blog.csdn.net/chinacqzgp/article/details/107137875)
- [åœ¨æ ‘è“æ´¾ Pico ä¸Šä½¿ç”¨æ‘‡æ† â€“ æ ‘è“æ´¾ Pico å®éªŒå®¤ï¼ˆRP2040ï¼‰](https://pico.nxez.com/2023/11/25/how-to-use-the-joystick-on-raspberry-pi-pico.html)
- [ç”¨æœ¬åœ°ç½‘ç»œæ§åˆ¶çš„æ ‘è“æ´¾æ‘„å½±äº‘å° | æ ‘è“æ´¾å®éªŒå®¤](https://shumeipai.nxez.com/2018/07/17/raspberry-pi-cam-pan-tilt-control-over-local-inter.html)
- [åŸºäºæ ‘è“æ´¾çš„å¤šèˆµæœºæ§åˆ¶çš„å®šä½æ‹ç…§äº‘å° | æ ‘è“æ´¾å®éªŒå®¤](https://shumeipai.nxez.com/2018/06/21/pan-tilt-multi-servo-control.html)
- [æ ‘è“æ´¾ 4B-Python-ä½¿ç”¨ PCA9685 æ§åˆ¶èˆµæœºäº‘å°+è·Ÿéšäººè„¸è½¬åŠ¨\_Python èµ„æ–™\_Python æ•™ç¨‹å¼€å‘æ–‡æ¡£èµ„æ–™-Python èµ„æ–™ç½‘](https://pythonziliao.com/post/821.html)
- [æ ‘è“æ´¾ï¼Œmediapipeï¼ŒPicamera2 åˆ©ç”¨èˆµæœºäº‘å°è¿½è¸ªäººæ‰‹(PID æ§åˆ¶ï¼‰\_æ ‘è“æ´¾äº‘å°è¿½è¸ªå°è£…å¥½çš„å‡½æ•°-CSDN åšå®¢](https://blog.csdn.net/idfengming/article/details/135210978)
- [ä½¿ç”¨æ ‘è“æ´¾ gpio è¿æ¥ ps2 æ‰‹æŸ„æ¨¡å—ï¼ˆé™„ç¨‹åºï¼‰ã€Œå»ºè®®æ”¶è—ã€-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘](https://cloud.tencent.com/developer/article/2094624)
- [å’¸é±¼ ZTMR å®ä¾‹â€”PS2 æ‰‹æŸ„-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘](https://cloud.tencent.com/developer/article/2072262)
- [ps2 æ‘‡æ†ä¼ æ„Ÿå™¨æ§åˆ¶èˆµæœºå®éªŒ â€“ æ ‘è“é…±](https://www.shumeijiang.com/2022/10/30/ps2%E6%91%87%E6%9D%86%E4%BC%A0%E6%84%9F%E5%99%A8%E6%8E%A7%E5%88%B6%E8%88%B5%E6%9C%BA%E5%AE%9E%E9%AA%8C.html)
- [æ ‘è“æ´¾é€šè¿‡ 16 è·¯ PCA9685 æ¨¡å—é©±åŠ¨èˆµæœº | My-Blog](https://apidocs.cn/blog/backend/raspberrypi/%E6%A0%91%E8%8E%93%E6%B4%BE%E9%80%9A%E8%BF%8716%E8%B7%AFPCA9685%E6%A8%A1%E5%9D%97%E9%A9%B1%E5%8A%A8%E8%88%B5%E6%9C%BA.html)

## [æ™ºèƒ½ç›‘æ§ç‡ƒæ°”ç«™ï¼šæ— äººå€¼å®ˆè¿ç»´æ–°æ—¶ä»£](https://blog.dong4j.site/posts/20ab66ff.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

ä¸ºäº†æ»¡è¶³ç‡ƒæ°”ç«™è®¾å¤‡çš„å®‰å…¨ã€ç»´æŠ¤ã€æ•ˆç‡ã€åˆè§„å’ŒæŠ€æœ¯å‘å±•ç­‰å¤šæ–¹é¢çš„éœ€æ±‚ã€‚é€šè¿‡å®æ–½è¯¥è§£å†³æ–¹æ¡ˆï¼Œå®ç°å®ç°æ— äººå€¼å®ˆçš„ç›®çš„, æé«˜ç‡ƒæ°”ç«™è®¾å¤‡çš„å®‰å…¨æ€§å’Œè¿è¡Œæ•ˆç‡ï¼Œé™ä½è¿è¥æˆæœ¬ã€‚

## éœ€æ±‚

1. é€šè¿‡è¿æ¥æœ¬åœ° **IPC å’Œ NVR** å®ç°è§†é¢‘å±•ç¤ºåŠŸèƒ½, å·²è¾¾åˆ°å®‰å…¨å·¡æ£€çš„ç›®çš„;
2. è¿æ¥ç‡ƒæ°”ç«™å†…éƒ¨ **é—¨ç¦** ç³»ç»Ÿ, é€šè¿‡å±€åŸŸç½‘å®šæ—¶æ¢æ´»çš„æ–¹å¼ç›‘æµ‹é—¨ç¦è®¾å¤‡è¿è¡Œæƒ…å†µ;
3. ä½¿ç”¨ SNMP åè®®ç›‘æµ‹ **ç½‘ç»œäº¤æ¢æœº** çš„å®æ—¶è¿è¡Œæƒ…å†µ, åŒ…æ‹¬ä»¥ä¸‹å†…å®¹:
   1. ç«¯å£å ç”¨æƒ…å†µ
   2. ä¸Šä¸‹è¡Œçš„æ•°æ®æµé‡
   3. å…¶ä»–å…³é”®å‚æ•°ä¿¡æ¯
   4. è·å–è¿è¡Œæ—¥å¿—å¹¶ä¸Šä¼ 
   5. æ¸©åº¦ã€è´Ÿè·
4. ç›‘æµ‹ **UPS** è®¾å¤‡, æ”¶é›†ç”µæ± , å½“å‰åŠŸç‡ç­‰ç›¸å…³çš„æ•°æ®;
5. **ç©ºè°ƒ** æ§åˆ¶, åŒ…æ‹¬æ¸©åº¦è°ƒèŠ‚, å¯åœç­‰æ“ä½œ;
6. ç¯å¢ƒç›‘æµ‹, åŒ…æ‹¬æ¸©åº¦, æ¹¿åº¦, å™ªéŸ³ç­‰æ•°æ®;
7. **æŸ´æ²¹å‘ç”µæœº**æ£€æµ‹, éœ€è¦åšåˆ°å¸‚ç”µåœè‡ªåŠ¨å¯åŠ¨æŸ´å‘, å¸‚ç”µæ¥åªæœ‰åœæ­¢æŸ´å‘;
8. IPC, ç½‘ç»œäº¤æ¢æœºç­‰å…³é”®è®¾å¤‡èƒ½å¤Ÿå®ç° **è¿œç¨‹é‡å¯**;
9. æ”¶é›†æ‰€æœ‰è®¾å¤‡åˆ°çš„ **çŠ¶æ€(åœ¨çº¿/ç¦»çº¿)** æ•°æ®;
10. ç«™å†…æ•°æ®å¯ä»¥é›†ä¸­å±•ç¤ºåœ¨åœºç«™å†…éƒ¨çš„ **æ˜¾ç¤ºå±** ä¸Š, å¹¶èƒ½å¤Ÿå®æ—¶**ä¸ŠæŠ¥åˆ°äº‘å¹³å°**;
11. å½“å¸‚ç”µæ–­ç”µä¸” UPS ç”µé‡è€—å°½åè¿˜èƒ½å¤Ÿé€šè¿‡ **4G** çš„æ–¹å¼æŒç»­ä¸ŠæŠ¥è®¾å¤‡æ•°æ®åˆ°äº‘å¹³å°;
12. æä¾›æ‰©å±•æ¨¡å—ç”¨äºåç»­æ–°è®¾å¤‡çš„æ¥å…¥;

## æ–¹æ¡ˆç®€ä»‹

æ­¤æ–¹æ¡ˆä¸­, æˆ‘ä»¬å°†æŒ‰ç…§è®¾å¤‡åŠŸèƒ½åˆ†ä¸ºä¸‰ç±»:

1. åŠ¨åŠ›è®¾å¤‡;
2. ç¯å¢ƒè®¾å¤‡;
3. å®‰é˜²è®¾å¤‡;

![è®¾å¤‡åˆ†ç±».svg](https://cdn.dong4j.site/source/image/%E8%AE%BE%E5%A4%87%E5%88%86%E7%B1%BB.svg)

åŸºæœ¬åŸåˆ™:

1. å¦‚æœè®¾å¤‡å­˜åœ¨ç‰©è”åè®®, æ¯”å¦‚ RS485, åˆ™å¯ç›´æ¥é‡‡é›†;
2. å¦‚æœæ˜¯æ™®é€šçš„ç¡¬ä»¶è®¾å¤‡, åˆ™éœ€è¦æ·»åŠ ç›¸åº”çš„ç¡¬ä»¶é€šè®¯æ¨¡å—, å°†æ™®é€šç¡¬ä»¶è½¬æ¢ä¸ºæ™ºèƒ½ç¡¬ä»¶ä¸ŠæŠ¥çš„ç›‘æµ‹ä¸»æœº;
3. å¦‚æœæ˜¯ç›‘æµ‹ä¸»æœºä¸æ”¯æŒçš„ç‰©è”åè®®, åˆ™éœ€è¦åè®®è½¬æ¢æ¨¡å—, å°†ä¸æ”¯æŒçš„åè®®è½¬æ¢ä¸º RS485 åè®®;

![åŸºæœ¬åŸåˆ™.drawio.svg](https://cdn.dong4j.site/source/image/%E5%9F%BA%E6%9C%AC%E5%8E%9F%E5%88%99.drawio.svg)

## æ–¹æ¡ˆè®¾è®¡

è®¾è®¡åŸåˆ™æ˜¯ï¼š**ç®€å•é€‚ç”¨+ç¨³å®šå®‰å…¨+å¯æ‰©å±•æ˜“ç»´æŠ¤**ã€‚

ç”±äºç‡ƒæ°”ç«™çš„é¢„ç®—é™åˆ¶ï¼Œç›‘æµ‹ç³»ç»Ÿçš„ç›‘æ§å¯¹è±¡åªè¦†ç›–æ ¸å¿ƒè®¾å¤‡ï¼Œå¦‚ï¼šUPSã€ç½‘ç»œè®¾å¤‡ã€è§†é¢‘ç­‰ï¼›

åŒæ—¶ç‡ƒæ°”ç«™æ²¡æœ‰é…å¤‡ä¸“é—¨çš„æœºæˆ¿ç®¡ç†äººå‘˜ï¼Œæ‰€ä»¥ç›‘æ§ç³»ç»Ÿå¿…é¡»è€ƒè™‘å…¶æ“ä½œæ€§å¿…é¡»ç®€å•ï¼›

è€Œå¯¹äºç›‘æ§ç³»ç»Ÿè€Œè¨€ï¼Œæœ€é‡è¦çš„ä¸€ä¸ªæŒ‡æ ‡å°±æ˜¯å…¶ç³»ç»Ÿç¨³å®šæ€§ï¼Œç›‘æ§ç³»ç»Ÿé€šè¿‡ä¸€ç³»åˆ—è½¯ä»¶å’Œç¡¬ä»¶ç›¸ç»“åˆçš„æ–¹å¼ä¿è¯ç³»ç»Ÿçš„å®‰å…¨ç¨³å®šæ— è¯¯æŠ¥ï¼›

åŒæ—¶å¯¹äºæ–°å¢çš„è®¾å¤‡éœ€è¦æ¥å…¥ç›‘æ§ç³»ç»Ÿè¿›è¡Œç»Ÿä¸€ç®¡ç†ä¹Ÿæ˜¯å¸¸è§çš„éœ€æ±‚ï¼Œå› æ­¤ç›‘æµ‹ç³»ç»Ÿå¿…é¡»å…·å¤‡è‰¯å¥½çš„ç³»ç»Ÿæ‰©å±•æ€§ï¼Œè®©æ–°è®¾å¤‡åŠ å…¥ç›‘æµ‹ç³»ç»Ÿæ“ä½œç®€å•ï¼Œå¯ç»´æŠ¤æ€§è‰¯å¥½ã€‚

**è®¾è®¡æ–¹æ¡ˆç³»ç»Ÿå›¾å¦‚ä¸‹ï¼š**

![æ•´ä½“æ–¹æ¡ˆ.drawio.svg](https://cdn.dong4j.site/source/image/%E6%95%B4%E4%BD%93%E6%96%B9%E6%A1%88.drawio.svg)

### åŸºç¡€åŠŸèƒ½

1. **åŠ¨åŠ›è®¾å¤‡ç›‘æ§**ï¼šç›‘æ§ç³»ç»Ÿèƒ½å¤Ÿå®æ—¶ç›‘æ§ UPS ç”µæºã€å¼€å…³æŸœã€å‘ç”µæœº ç­‰åŠ¨åŠ›è®¾å¤‡çš„è¿è¡ŒçŠ¶æ€å’Œå‚æ•°ã€‚ä¸€æ—¦æ£€æµ‹åˆ°å¼‚å¸¸ï¼Œç³»ç»Ÿä¼šç«‹å³å‘å‡ºæŠ¥è­¦ï¼Œç¡®ä¿è®¾å¤‡æ•…éšœå¾—åˆ°åŠæ—¶å¤„ç†ã€‚
2. **ç¯å¢ƒå‚æ•°ç›‘æ§**ï¼šé€šè¿‡æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨ã€çƒŸé›¾æ¢æµ‹å™¨ç­‰è®¾å¤‡ï¼Œç³»ç»Ÿå¯ä»¥å®æ—¶ç›‘æµ‹æœºæˆ¿å†…çš„ç¯å¢ƒå‚æ•°ã€‚å½“ç¯å¢ƒå‚æ•°è¶…å‡ºé¢„è®¾èŒƒå›´æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒèŠ‚ç©ºè°ƒè®¾å¤‡æˆ–å¯åŠ¨é€šé£ç³»ç»Ÿï¼Œç¡®ä¿æœºæˆ¿å†…ç¯å¢ƒç¨³å®šã€‚
3. **æ¼æ°´æ£€æµ‹ä¸æŠ¥è­¦**ï¼šæœºæˆ¿å†…è®¾æœ‰æ¼æ°´æ£€æµ‹è£…ç½®ï¼Œä¸€æ—¦æ£€æµ‹åˆ°æ¼æ°´æƒ…å†µï¼Œç³»ç»Ÿä¼šç«‹å³å‘å‡ºæŠ¥è­¦å¹¶å…³é—­ç›¸å…³æ°´æºï¼Œé˜²æ­¢è®¾å¤‡å—æŸã€‚
4. **é—¨ç¦ä¸è§†é¢‘ç›‘æ§**ï¼šç›‘æ§ç³»ç»Ÿé›†æˆäº†é—¨ç¦ç³»ç»Ÿå’Œè§†é¢‘ç›‘æ§ç³»ç»Ÿï¼Œå®ç°å¯¹æœºæˆ¿å‡ºå…¥äººå‘˜çš„ä¸¥æ ¼ç®¡ç†å’Œå¯¹æœºæˆ¿å†…è®¾å¤‡çš„å®æ—¶ç›‘æ§ã€‚
5. **è¿œç¨‹ç®¡ç†å·¥å…·é›†æˆ**ï¼šç›‘æ§ç³»ç»Ÿæ”¯æŒé€šè¿‡ Web ç•Œé¢è°ƒç”¨ç®¡ç†å£ï¼Œå†…ç½®è¿œç¨‹å·¥å…·å¦‚ SSHã€Telnet ç­‰ï¼Œæ–¹ä¾¿ç®¡ç†å‘˜éšæ—¶éšåœ°è¿›è¡Œè¿œç¨‹ç®¡ç†ã€‚è¿™äº›å·¥å…·ä¸ä»…æä¾›äº†å¼ºå¤§çš„å‘½ä»¤è¡Œæ“ä½œåŠŸèƒ½ï¼Œè¿˜æ”¯æŒå›¾å½¢åŒ–ç•Œé¢æ“ä½œï¼Œç®€åŒ–äº†ç®¡ç†æµç¨‹ã€‚
6. **æŠ¥è­¦ä¸æ—¥å¿—ç®¡ç†**ï¼šç³»ç»Ÿèƒ½å¤Ÿè®°å½•æ‰€æœ‰çš„ç›‘æ§æ•°æ®å’Œæ“ä½œæ—¥å¿—ï¼Œå¹¶æä¾›çµæ´»çš„æŠ¥è­¦æœºåˆ¶ã€‚ç®¡ç†å‘˜å¯ä»¥æ ¹æ®éœ€è¦è®¾ç½®ä¸åŒçº§åˆ«çš„æŠ¥è­¦é˜ˆå€¼å’ŒæŠ¥è­¦æ–¹å¼ï¼ˆå¦‚å£°å…‰æŠ¥è­¦ã€çŸ­ä¿¡é€šçŸ¥ç­‰ï¼‰ï¼Œç¡®ä¿åŠæ—¶å“åº”å’Œå¤„ç†å„ç§å¼‚å¸¸æƒ…å†µã€‚
7. **å¯æ‰©å±•æ€§ä¸å¼€æ”¾æ€§**ï¼šç›‘æ§ç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œå…·æœ‰è‰¯å¥½çš„å¯æ‰©å±•æ€§å’Œå¼€æ”¾æ€§ã€‚ç®¡ç†å‘˜å¯ä»¥æ ¹æ®æœºæˆ¿çš„å®é™…éœ€æ±‚æ·»åŠ æˆ–åˆ é™¤ç›‘æ§æ¨¡å—ï¼ŒåŒæ—¶ç³»ç»Ÿæ”¯æŒå¤šç§é€šä¿¡åè®®å’Œæ¥å£æ ‡å‡†ï¼Œæ–¹ä¾¿ä¸å…¶ä»–ç³»ç»Ÿè¿›è¡Œé›†æˆå’Œè”åŠ¨ã€‚

---

### è¿æ¥æ–¹å¼

ç›‘æ§ç³»ç»Ÿä¸å…¶ä»–è®¾å¤‡çš„è¿æ¥æ–¹å¼ä¸»è¦å–å†³äºè®¾å¤‡çš„ç±»å‹å’Œæ¥å£æ ‡å‡†ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç›‘æ§ç³»ç»Ÿæ”¯æŒå¤šç§ç±»å‹çš„æ¥å£ï¼Œå¦‚ RS232ã€RS485ã€ä»¥å¤ªç½‘æ¥å£ç­‰ï¼Œä»¥ä¾¿ä¸ä¸åŒç±»å‹çš„è®¾å¤‡è¿›è¡Œè¿æ¥ã€‚

1. å¯¹äºå…·æœ‰æ ‡å‡†æ¥å£çš„è®¾å¤‡ï¼Œå¦‚ UPS ç”µæºã€ç©ºè°ƒè®¾å¤‡ç­‰ï¼Œç›‘æ§ç³»ç»Ÿå¯ä»¥ç›´æ¥é€šè¿‡ç›¸åº”çš„æ¥å£ä¸ä¹‹è¿æ¥ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡ RS232 æˆ– RS485 æ¥å£ï¼Œç³»ç»Ÿå¯ä»¥è¯»å–è®¾å¤‡çš„è¿è¡ŒçŠ¶æ€å’Œå‚æ•°ï¼Œå¹¶è¿›è¡Œå®æ—¶ç›‘æ§å’Œç®¡ç†ã€‚
2. å¯¹äºä¸å…·æœ‰æ ‡å‡†æ¥å£çš„è®¾å¤‡ï¼Œæœºæˆ¿åŠ¨ç¯ç›‘æ§ç³»ç»Ÿå¯èƒ½éœ€è¦é‡‡ç”¨å…¶ä»–æ–¹å¼è¿›è¡Œè¿æ¥ã€‚ä¾‹å¦‚ï¼Œå¯¹äºæ¨¡æ‹Ÿé‡è¾“å‡ºçš„ä¼ æ„Ÿå™¨ï¼Œç³»ç»Ÿå¯ä»¥é€šè¿‡æ¨¡æ‹Ÿé‡è¾“å…¥æ¥å£è¿›è¡Œè¿æ¥ï¼Œå°†ä¼ æ„Ÿå™¨è¾“å‡ºçš„æ¨¡æ‹Ÿä¿¡å·è½¬æ¢ä¸ºæ•°å­—ä¿¡å·è¿›è¡Œå¤„ç†ã€‚å¯¹äºå¼€å…³é‡è¾“å…¥çš„è®¾å¤‡ï¼Œå¦‚é—¨ç¦ç³»ç»Ÿã€çƒŸé›¾æ¢æµ‹å™¨ç­‰ï¼Œç³»ç»Ÿå¯ä»¥é€šè¿‡å¼€å…³é‡è¾“å…¥æ¥å£ï¼ˆDIï¼‰è¿›è¡Œè¿æ¥ï¼Œè¯»å–è®¾å¤‡çš„å¼€å…³çŠ¶æ€ã€‚
3. æ­¤å¤–ï¼Œç›‘æ§ç³»ç»Ÿè¿˜æ”¯æŒé€šè¿‡ç½‘ç»œæ¥å£ä¸è¿œç¨‹ç®¡ç†å·¥å…·è¿›è¡Œè¿æ¥ã€‚ç®¡ç†å‘˜å¯ä»¥é€šè¿‡ Web ç•Œé¢è°ƒç”¨ç®¡ç†å£ï¼Œä½¿ç”¨å†…ç½®çš„è¿œç¨‹å·¥å…·å¦‚ SSHã€Telnet ç­‰è¿›è¡Œè¿œç¨‹ç®¡ç†ã€‚è¿™ç§æ–¹å¼ä¸ä»…æ–¹ä¾¿çµæ´»ï¼Œè¿˜å¯ä»¥å®ç°è·¨åœ°åŸŸçš„è¿œç¨‹ç›‘æ§å’Œç®¡ç†ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç›‘æ§ç³»ç»Ÿä¸å…¶ä»–è®¾å¤‡çš„è¿æ¥åº”éµå¾ªç›¸åº”çš„æ¥å£æ ‡å‡†å’Œé€šä¿¡åè®®ï¼Œç¡®ä¿æ•°æ®çš„å‡†ç¡®æ€§å’Œå¯é æ€§ã€‚åŒæ—¶ï¼Œåœ¨è¿æ¥è¿‡ç¨‹ä¸­è¿˜åº”æ³¨æ„è®¾å¤‡çš„ç”µæ°”å®‰å…¨å’Œé˜²é›·ä¿æŠ¤ç­‰æªæ–½ï¼Œä»¥ä¿éšœç³»ç»Ÿçš„ç¨³å®šè¿è¡Œå’Œè®¾å¤‡çš„å®‰å…¨ã€‚

---

### **ç›‘æ§å­ç³»ç»Ÿ**

#### åŠ¨åŠ›ç›‘æ§ ï¼ˆUPS ç›‘æµ‹ï¼‰

é€šè¿‡ UPS è®¾å¤‡æä¾›çš„ RS485 ï¼ˆæˆ– RS232ï¼‰ æ™ºèƒ½æ¥å£åŠé€šè®¯åè®®ï¼Œé‡‡ç”¨æ€»çº¿çš„æ–¹å¼å°† UPS çš„ç›‘æ§ä¿¡å·ç›´æ¥ ï¼ˆæˆ–ç»é€šè®¯è½¬æ¢æ¨¡å—å°† RS232 è½¬æ¢æˆ RS485 ä¿¡å·åï¼‰ æ¥å…¥ç›‘æ§æœåŠ¡å™¨çš„ä¸²å£ï¼Œç”±ç›‘æ§å¹³å°è½¯ä»¶è¿›è¡Œ UPS çš„å®æ—¶ç›‘æµ‹ã€‚

#### æœºæˆ¿è¿è¡Œç¯å¢ƒç›‘æµ‹

é€šè¿‡ç³»ç»Ÿå®‰è£…éƒ¨ç½²åœ¨æœºæˆ¿å„ä¸ªå…³é”®è§’è½çš„æ¸©æ¹¿åº¦æ„Ÿåº”æ¢å¤´ã€å™ªéŸ³ä¼ æ„Ÿå™¨åŠæ¼æ°´ç›‘æµ‹å™¨ï¼Œå¯å¯¹æœºæˆ¿å†…çš„æ¸©åº¦ã€æ¹¿åº¦ã€å™ªéŸ³è¿›è¡Œå®æ—¶ç›‘æ§æ£€æµ‹, ä¸€æ—¦æœºæˆ¿å†…çš„æ¸©åº¦ã€æ¹¿åº¦ã€å™ªéŸ³è¾¾åˆ°æˆ–è¶…è¿‡æ„Ÿåº”è®¾å¤‡é¢„å…ˆè®¾å®šçš„é˜€å€¼æ—¶ï¼Œè®¾å¤‡å°±ä¼šå¯åŠ¨å‘Šè­¦æµç¨‹ï¼Œå¹¶åœ¨å®æ—¶ç›‘æ§å¹³å°å‘Šè­¦ç•Œé¢ä¸Šè¿›è¡Œæ˜¾ç¤ºçš„ç™»è®°ï¼Œå¹¶é€šè¿‡ä¸é€šä¿¡é¢„è­¦æ¨¡å—è¿›è¡Œè”åŠ¨ï¼Œåœ¨ç¬¬ä¸€æ—¶é—´é€šçŸ¥æœºæˆ¿å€¼ç­äººå‘˜å¯¹æ•…éšœç‚¹è¿›è¡ŒåŠæ—¶å“åº”åŠå¤„ç†ã€‚

#### è“„ç”µæ± ç›‘æµ‹

é€šè¿‡åŠ è£…è“„ç”µæ± æ£€æµ‹ä»ªä¸æ¯èŠ‚ç”µæ± è¿›è¡Œè¿çº¿ç›‘æµ‹ï¼Œå¤šå°è“„ç”µæ± æ£€æµ‹ä»ªé€šè¿‡ RS485 æ™ºèƒ½æ¥å£åŠé€šè®¯åè®®é‡‡ç”¨æ€»çº¿æ–¹å¼å°†ä¿¡å·æ¥å…¥ç›‘æ§æœåŠ¡å™¨çš„ä¸²å£ï¼Œç”±ç›‘æ§å¹³å°è½¯ä»¶è¿›è¡Œè“„ç”µæ± çš„å®æ—¶ç›‘æµ‹ã€‚

#### å¸‚ç”µç›‘æµ‹

é€šè¿‡åœ¨é…ç”µæŸœä¸­å®‰è£…å¸¦æ¶²æ™¶æ˜¾ç¤ºçš„ç”µé‡ä»ªå¯¹è¿›çº¿å®ç°ç›‘æµ‹ï¼Œæ—¢å¯åœ¨é…ç”µæŸœè¡¨é¢å®æ—¶çœ‹åˆ°ç”µé‡ä»ªé‡‡é›†åˆ°çš„å‚æ•°ï¼Œäº¦å¯é€šè¿‡ç”µé‡ä»ªçš„ RS485 æ™ºèƒ½æ¥å£å’Œé€šè®¯åè®®é‡‡ç”¨æ€»çº¿çš„æ–¹å¼å°†ä¿¡å·æ¥å…¥ç›‘æ§æœåŠ¡å™¨çš„ä¸²å£ï¼Œç”±ç›‘æ§å¹³å°è½¯ä»¶è¿›è¡Œå¸‚ç”µçš„å®æ—¶ç›‘æµ‹ã€‚

#### é…ç”µå¼€å…³ç›‘æµ‹

é€šè¿‡é«˜å‹äº¤æµéš”ç¦»è½¬æ¢æ¨¡å—å°†é…ç”µå¼€å…³ä¸‹å‡ºçº¿çš„å¼ºç”µä¿¡å·è½¬æ¢æˆä½å‹ç›´æµä¿¡å·åæ¥å…¥ 8 è·¯éš”ç¦»æ•°å­—é‡è¾“å…¥æ¨¡å—ä¸­è¿›è¡Œå®æ—¶çŠ¶æ€é‡‡é›†ï¼Œå†é€šè¿‡ 8 è·¯éš”ç¦»æ•°å­—é‡è¾“å…¥æ¨¡å—çš„ RS485 æ™ºèƒ½æ¥å£åŠé€šè®¯åè®®é‡‡ç”¨æ€»çº¿çš„æ–¹å¼å°†ä¿¡å·æ¥å…¥ç›‘æ§æœåŠ¡å™¨çš„ä¸²å£ï¼Œç”±ç›‘æ§å¹³å°è½¯ä»¶è¿›è¡Œå¼€å…³çŠ¶æ€çš„å®æ—¶ç›‘æµ‹ã€‚

#### ç½‘ç»œäº¤æ¢æœºç›‘æµ‹

ç›‘æµ‹ä¸»æœºé€šè¿‡ RJ45 æ¥å£ä¸ç½‘ç»œäº¤æ¢æœºè¿æ¥, é€šè¿‡ Web ç«¯è®¾ç½® IP ä¸è®¾å¤‡çš„ç»‘å®šå…³ç³»å, é€šè¿‡ PING æŒ‡ä»¤å¯¹å±€åŸŸç½‘å†…çš„æ‰€æœ‰è®¾å¤‡è¿›è¡Œæ¢æ´»ç›‘æµ‹, ä¸”é€šè¿‡ SNMP åè®®è·å–ç½‘ç»œäº¤æ¢æœºçš„è¿è¡Œæ•°æ®ã€‚

#### è§†é¢‘ç›‘æµ‹

å¦‚æœç‡ƒæ°”ç«™å­˜åœ¨ NVR è®¾å¤‡, å¯ç›´æ¥é€šè¿‡ RTSP åè®®ä» NVR ä¸Šæ‹‰å– IPC çš„å®æ—¶è§†é¢‘æµ, ä¹Ÿå¯æŸ¥çœ‹å†å²è§†é¢‘è®°å½•, å¦‚æœéœ€è¦è¿œç¨‹æŸ¥çœ‹è§†é¢‘ç›‘æ§ç”»é¢, éœ€è¦é€šè¿‡ VPN çš„æ–¹å¼ç»„å»ºä¸€ä¸ªå¤§å‹å±€åŸŸç½‘ç»œã€‚

### ç³»ç»ŸåŠŸèƒ½

1. å±•ç¤ºå½“å‰æ•°æ®ä¸­å¿ƒæ€»èƒ½è€—ï¼ŒIT èƒ½è€—ï¼Œç©ºè°ƒèƒ½è€—ï¼ŒåŠå…¶ä»–èƒ½è€—å¹¶ä¸”è®¡ç®—å‡ºå½“å‰æ•°æ®ä¸­å¿ƒå®æ—¶ PUE å€¼ï¼Œé€šè¿‡ä»ªè¡¨ç›˜å½¢å¼ç›´è§‚å±•ç¤ºã€‚
2. é€‰æ‹©æŸ¥çœ‹æ•°æ®ä¸­å¿ƒçš„ä¸­ä½å‹é…ç”µç³»ç»Ÿä¸»æ¥çº¿å›¾ï¼Œå¹¶åœ¨ä¸€æ¬¡å›¾æ˜¾ç¤ºé…ç”µç³»ç»Ÿå½“å‰é¥æµ‹ã€é¥ä¿¡æ•°æ®å’ŒçŠ¶æ€ã€‚å®æ—¶ç›‘æµ‹å„é…ç”µæŸœçš„ç”µå‹ã€ç”µæµç­‰ç”µåŠ›å‚æ•°ï¼Œå˜ç”µç«™çš„æ¸©æ¹¿åº¦ã€çƒŸæ„Ÿã€æ°´æµ¸ã€é—¨ç¦ç­‰ç¯å¢ƒæƒ…å†µã€‚
3. ç”µæ°”æ¥ç‚¹æ¸©åº¦å®æ—¶ç›‘æµ‹ï¼Œæ–­è·¯å™¨è§¦å¤´ã€è§¦è‡‚ã€æ¯æ’å’Œçº¿ç¼†è¿æ¥ç­‰ä½ç½®å®‰è£…æ— çº¿æµ‹æ¸©ä¼ æ„Ÿå™¨ç›‘æµ‹æ¥ç‚¹æ¸©åº¦ï¼Œä¾¿äºæå‰å‘ç°æ¸©åº¦å¼‚å¸¸å¯¼è‡´çš„äº‹æ•…ã€‚
4. ç›‘æµ‹å„å˜å‹å™¨å„é¡¹å‚æ•°ï¼ŒåŒ…æ‹¬è´Ÿè½½ç‡ã€é¢‘ç‡ã€åŠŸç‡å› æ•°ã€ä¸‰ç›¸ä¸å¹³è¡¡åº¦ç­‰ï¼Œå¹¶ä¸”æ˜¾ç¤ºå†æ—¶æ›²çº¿å›¾ï¼Œæ•°æ®å®æ—¶å˜åŒ–ã€‚å¸®åŠ©ç”¨æˆ·ç›´
5. ç”µèƒ½è´¨é‡åœ¨çº¿ç›‘æµ‹ï¼Œå¯ä»¥ç›‘æµ‹ç”µæµå’Œç”µå‹è°æ³¢ç•¸å˜ç‡ã€ç”µå‹æš‚å‡æš‚é™æš‚ä¸­æ–­ç­‰æš‚æ€äº‹ä»¶è®°å½•ã€ITIC å®¹å¿æ›²çº¿ç­‰
6. ç³»ç»Ÿé‡‡é›† UPS è¾“å…¥ã€è¾“å‡ºç«¯å’Œæ—è·¯ä¸‰ç›¸ç”µå‹ã€ç”µæµã€æœ‰åŠŸåŠŸç‡ã€åŠŸç‡å› æ•°é¢‘ç‡ï¼ŒåŒæ—¶ç›‘æµ‹ UPS æ¸©åº¦ã€è“„ç”µæ± ç”µå‹ã€å½“å‰è´Ÿè½½ä¸‹çš„å‰©ä½™æ—¶é—´ç­‰æ•°æ®ã€‚
7. å±•ç¤ºå•ä½“ç”µæ± ç”µå‹ã€å†…é˜»å’Œæ¸©åº¦ï¼Œé¢„æµ‹ç”µæ± å¸¦è½½æ—¶å‰©ä½™æ—¶é—´ï¼Œæ¯èŠ‚ç”µæ± æ•°æ®å‡å¯ä»¥è®¾ç½®å¼‚å¸¸æŠ¥è­¦ï¼ŒåŠæ—¶å‘ç°è“„ç”µæ± å¼‚å¸¸ã€‚
8. å±•ç¤ºç²¾å¯†é…ç”µæŸœå†…è¿›çº¿å’Œé¦ˆçº¿å›è·¯ç”µæ°”å‚æ•°ï¼ŒåŒ…æ‹¬ç”µæµç”µå‹åŠŸç‡ç”µèƒ½ä»¥åŠå¼€å…³çŠ¶æ€ï¼Œå¹¶å¯ä»¥å¯¹æ•°æ®è¿›è¡ŒæŠ¥è­¦è®¾ç½®å’Œåˆ†çº§ï¼Œæ•°æ®å–è‡ªç²¾å¯†é…ç”µæŸœæµ‹é‡æ¨¡å—ã€‚
9. å±•ç¤ºæ™ºèƒ½å°æ¯çº¿çš„å§‹ç«¯ç®±å’Œæ’æ¥ç®±ç”µæ°”å‚æ•°ï¼ŒåŒ…æ‹¬ç”µæµç”µå‹ã€å¼€å…³çŠ¶æ€ã€æ’æ¥ç‚¹æ¸©åº¦ï¼Œå¹¶å¯¹æ•°æ®è¿›è¡ŒæŠ¥è­¦è®¾ç½®å’Œåˆ†çº§ã€‚
10. é€šè¿‡å¹³é¢å›¾æ˜¾ç¤ºæ•°æ®ä¸­å¿ƒèƒ½æºåˆ†å¸ƒï¼Œè®¾å¤‡åˆ†å¸ƒæƒ…å†µï¼Œå¹¶æ˜¾ç¤ºè®¾å¤‡èƒ½è€—æ•°æ®ï¼Œç‚¹å‡»å¹³é¢å›¾ä¸Šè®¾å¤‡å¯ä»¥è¿›å…¥å…·ä½“è®¾å¤‡ç›‘æ§ç•Œé¢ã€‚
11. å®æ—¶æ˜¾ç¤ºå½“å‰æ•°æ®ä¸­å¿ƒ PUE å€¼ä»¥åŠå†å² PUE æ›²çº¿ã€‚å¹¶ä¸”æ˜¾ç¤ºå„åˆ†é¡¹ç”¨èƒ½çš„ç”¨èƒ½æƒ…å†µåŠç”¨èƒ½æ’è¡Œã€‚ç›‘æµ‹å„å˜å‹å™¨è¿è¡ŒåŠè´Ÿè½½æƒ…å†µï¼Œç»™å‡ºæœ¬æœˆå˜å‹å™¨è¾“å‡ºç”µèƒ½æ’è¡Œã€‚
12. æ˜¾ç¤ºç”µèƒ½æ¶ˆè€—æ—¥/æœˆ/å¹´æŠ¥è¡¨ï¼Œå¹¶å¯å¯¹å…·ä½“å›è·¯é€‰æ‹©æ›²çº¿å›¾ã€é¥¼å›¾è¿›è¡Œå±•ç¤ºã€‚å¯¹æ•°æ®ä¸­å¿ƒç”¨ç”µæ•°æ®è¿›è¡ŒåŒæ¯”ã€ç¯æ¯”åˆ†ææ¯”è¾ƒï¼ŒæŸ¥çœ‹ç”¨ç”µè¶‹åŠ¿ã€‚
13. ç›‘æµ‹ç²¾å¯†ç©ºè°ƒçš„å›é£æ¸©æ¹¿åº¦ï¼Œå‡ºå›æ°´æ¸©åº¦ï¼Œå¹¶å¯ä»¥è®¾å®šç²¾å¯†ç©ºè°ƒçš„æ¸©æ¹¿åº¦ï¼Œè¾¾åˆ°æ›´å¥½çš„æ§åˆ¶æ•ˆæœã€‚
14. ç›‘æµ‹æ•°æ®ä¸­å¿ƒæ¸©æ¹¿åº¦ã€å¼€å…³é—¨ã€æ°´æµ¸ã€çƒŸé›¾ã€å™ªå£°ã€æ°”ä½“æµ“åº¦çŠ¶æ€ç­‰å‚æ•°ã€‚æ›²çº¿å›¾ç›´è§‚æ˜äº†ï¼ŒåŒæ—¶æ”¯æŒå†å²æ•°æ®æŸ¥è¯¢
15. é€šè¿‡åˆ—è¡¨æ˜¾ç¤ºå„ç±»æŠ¥è­¦äº‹ä»¶æ•°é‡ï¼Œé€šè¿‡æŸ±çŠ¶å›¾æ˜¾ç¤ºé€æ—¥æŠ¥è­¦æ•°é‡ï¼Œæä¾›æŠ¥è­¦æ€»æ•°ä»¥åŠå¢é•¿è¶‹åŠ¿ã€‚

ç›‘æ§è§£å†³æ–¹æ¡ˆé€šè¿‡æ–°å¢ä¼ æ„Ÿå™¨(å¦‚ï¼šæ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨ã€æ¼æ°´æ¢æµ‹å™¨ã€çƒŸé›¾æ¢æµ‹å™¨ç­‰)æˆ–ç›´æ¥ä½¿ç”¨æœºæˆ¿è®¾å¤‡ä¸­çš„æ™ºèƒ½é€šè®¯æ¥å£ï¼Œé€šè¿‡ç›‘æ§ä¸»æœºä¸æœºæˆ¿å†…è¢«ç›‘æ§è®¾å¤‡å»ºç«‹é€šä¿¡ï¼Œæ­å»ºä¸€å¥—å®Œå–„çš„å®æ—¶æœºæˆ¿ç›‘æ§ç³»ç»Ÿï¼Œå¯¹å®¢æˆ·å…·æœ‰ä»¥ä¸‹å®ç”¨ä»·å€¼ï¼š

1. **æœºæˆ¿æ— äººå€¼å®ˆ**ï¼šæœºæˆ¿ç›‘æ§ç³»ç»Ÿ 24 å°æ—¶å…¨æ–¹ä½è‡ªåŠ¨ç›‘æ§æœºæˆ¿ä¸­çš„è®¾å¤‡è¿è¡Œï¼Œå‡ºç°å¼‚å¸¸ç³»ç»Ÿè‡ªåŠ¨å‘Šè­¦ï¼Œæ— éœ€æœºæˆ¿ç®¡ç†äººå‘˜äººå·¥å·¡æŸ¥æœºæˆ¿è®¾å¤‡ï¼Œæ— äººå€¼å®ˆå¤§å¤§å‡å°‘é™ä½ç»´æŠ¤äººæœºæˆ¿ç®¡ç†å·¥ä½œé‡ã€‚
2. **å®‰å…¨å®æ—¶ç›‘æµ‹**ï¼šç›‘æ§ç³»ç»Ÿä»¥æ¯«ç§’çº§é€Ÿç‡å®æ—¶é‡‡é›†æ‰€æœ‰ç›‘æ§è®¾å¤‡æ•°æ®ï¼ŒåŒæ—¶å°†æ‰€æœ‰é‡‡é›†æ•°æ®ä»¥å›¾å½¢åŒ–ç•Œé¢å±•ç°æ–¹å¼åœ¨ç³»ç»Ÿä¸­å®æ—¶å±•ç°ã€‚
3. **æœºæˆ¿å¼‚å¸¸é¢„è­¦å‘Šè­¦**ï¼šç›‘æ§ç³»ç»Ÿå®ç›‘æµ‹æœºæˆ¿å†…æ‰€æœ‰è®¾å¤‡çš„è¿è¡Œæƒ…å†µä»¥åŠæœºæˆ¿ç¯å¢ƒå‚æ•°ï¼Œè‹¥æ¢æµ‹åˆ°å¼‚å¸¸ï¼Œç³»ç»ŸåŠæ—¶å‘å‡ºå‘Šè­¦(æ”¯æŒå£°å…‰ã€ç”µè¯ã€çŸ­ä¿¡ã€å¾®ä¿¡ App ç­‰å¤šç§æ–¹å¼å‘Šè­¦ï¼Œç¡®ä¿é€šçŸ¥åˆ°ä½)ï¼Œç®¡ç†äººå‘˜å¯åŠæ—¶æ’æŸ¥å¤„ç†ç›¸å…³é—®é¢˜ï¼Œè¿›è€Œä¿è¯æœºæˆ¿å®‰å…¨ç¨³å®šè¿è¡Œã€‚
4. **æœºæˆ¿å¯è§†åŒ–ç›‘æ§**ï¼šé€šè¿‡ SCADA æˆ– 3D å»ºæ¨¡çš„æ–¹å¼ï¼Œè®©ç®¡ç†äººå‘˜éšæ—¶éšåœ°å¯è¿›è¡Œå¯è§†åŒ–åœ°å·¡æŸ¥æœºæˆ¿ã€‚
5. **æœºæˆ¿ç›‘æ§æ•°æ®å®Œæ•´ä¿å­˜æ— ä¸¢å¤±**ï¼šç›‘æµ‹ä¸»æœºæ”¯æŒæ•°æ®è‡ªåŠ¨ç¼“å­˜åŠè”ç½‘ä¸»åŠ¨æ¨é€æœºåˆ¶(è®¾å¤‡ç‰¹æœ‰åŠŸèƒ½)ï¼Œè‹¥å‡ºç°ä¼ è¾“å¼‚å¸¸æƒ…å†µï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç¼“å­˜æ•°æ®ï¼Œå¾…æ¢å¤æ­£å¸¸åè‡ªåŠ¨ä¸Šä¼ ç¼“å­˜æ•°æ®ï¼Œä¿è¯ç³»ç»Ÿæ‰€æœ‰é‡‡é›†æ•°æ®ä¸ä¸¢å¤±ã€‚

## æ–¹æ¡ˆä»·å€¼

â€¢ å¯è§†åŒ–ç®¡ç†ï¼Œä½¿å¾—æ•°æ®ä¸­å¿ƒåŸºç¡€è®¾æ–½ç®¡ç†å˜å¾—å¯è§ã€ç›´è§‚ã€æ˜“ç”¨å’Œé«˜æ•ˆï¼›
â€¢ æé«˜ä¿¡æ¯æŸ¥è¯¢ã€å¤„ç†å’Œäº¤äº’çš„åŠæ—¶æ€§å’Œæœ‰æ•ˆæ€§ï¼Œæå‡æ•°æ®ä¸­å¿ƒç®¡ç†æ•ˆç‡ï¼›
â€¢ æ•°æ®å±•ç°å’Œä¿¡æ¯äº’åŠ¨ï¼Œæä¾›æ›´å‹å¥½å’Œé«˜æ•ˆçš„ç”¨æˆ·ç•Œé¢ï¼Œå…¨å±€æŠŠæ§ï¼›

## [æ­ç§˜åŸºç¡€æ¡†æ¶ï¼šå¦‚ä½•ç®€åŒ–è½¯ä»¶å¼€å‘ï¼Ÿ](https://blog.dong4j.site/posts/7774f295.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

é¦–å…ˆæˆ‘ä»¬éœ€è¦æ˜ç¡®ä»€ä¹ˆæ˜¯ **åŸºç¡€æ¡†æ¶** ä»¥åŠ **åŸºç¡€æ¡†æ¶** èƒ½ç»™æˆ‘ä»¬å¸¦æ¥æ€æ ·çš„ä¾¿åˆ©ä»è€Œæ–¹ä¾¿å¼€å‘è€…å¿«é€Ÿæ ¹æ®ä¸šåŠ¡éœ€æ±‚æ„å»ºå¯å®æ–½çš„ä¸šåŠ¡é¡¹ç›®.

### 1.1 ä»€ä¹ˆæ˜¯åŸºç¡€æ¡†æ¶

#### 1.1.1 å®šä¹‰

> æ¡†æ¶ï¼ˆframeworkï¼‰æ˜¯æ•´ä¸ªæˆ–éƒ¨åˆ†ç³»ç»Ÿçš„ **å¯é‡ç”¨** è®¾è®¡ï¼Œè¡¨ç°ä¸ºä¸€ç»„æŠ½è±¡æ„ä»¶åŠæ„ä»¶å®ä¾‹é—´ **äº¤äº’** çš„æ–¹æ³•ï¼Œå¦ä¸€ç§å®šä¹‰ä¸ºï¼Œæ¡†æ¶æ˜¯å¯è¢«åº”ç”¨å¼€å‘è€…å®šåˆ¶çš„åº”ç”¨ **éª¨æ¶**ã€‚
>
> æ¡†æ¶æ˜¯ä¸€ä¸ª **å¯å¤ç”¨** çš„è®¾è®¡æ„ä»¶ï¼Œé€šå¸¸ä»¥ **æ„ä»¶åº“** çš„å½¢å¼å‡ºç°ï¼Œä½†æ„æ¶åº“åªæ˜¯æ¡†æ¶çš„ä¸€ä¸ªé‡è¦éƒ¨åˆ†ï¼Œæ¡†æ¶çš„å…³é”®åœ¨äºæ¡†æ¶å†…å¯¹è±¡é—´çš„çš„äº¤äº’æ¨¡å¼å’Œæ§åˆ¶æµæ¨¡å¼ã€‚

ä»å®šä¹‰å¯ä»¥å¾—å‡º, æ¡†æ¶æ˜¯ä¸€ç§ **å¯å¤ç”¨** æ„ä»¶, ä»¥ **æ„ä»¶åº“** çš„æ–¹å¼åŠ å…¥åˆ°ä¸šåŠ¡ä»£ç ä¸­, ä»è€Œé¿å…é‡å¤å¼€å‘è¾¾åˆ°å¤ç”¨çš„ç›®çš„. æ¯ä¸ªå…¬å¸éƒ½ä¼šæˆ–å¤šæˆ–å°‘æ ¹æ®è‡ªå·±å…¬å¸ä¸šåŠ¡å°è£…å†…éƒ¨çš„å¼€å‘åŸºç¡€æ¡†æ¶. æ¯”å¦‚èš‚èšé‡‘æœåŸºäº Spring Boot è‡ªç ”çš„ [SOFA](https://github.com/sofa), å±äºé‡‘èçº§åˆ«çš„å¾®æœåŠ¡æ¡†æ¶; [Vert.x](https://github.com/vert-x3) åŸºäº Netty å°è£…çš„åŸºäºäº‹ä»¶çš„å¼‚æ­¥æ¡†æ¶; [Dubbo](https://github.com/apache/dubbo) æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ã€åŸºäº Java çš„å¼€æº RPC æ¡†æ¶ç­‰.

è€ƒè™‘åˆ°é¢å‘çš„é¢†åŸŸï¼Œä»¥åŠå®ç°ç¼–ç å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥å°†å°†æ¡†æ¶è‡³å°‘åˆ†ä¸ºä¸‰ç±»:

1. åŸºç¡€ç±»åº“: åŒ…å«å¤šæ•°é¡¹ç›®æ‰€éœ€è¦çš„ç±»åº“, å¼€å‘äººå‘˜å°†å…¶ä½œä¸ºä¸€ä¸ªç±»åº“ä½¿ç”¨ï¼Œå¯ä»¥ç®€åŒ–ä¸€äº›å¸¸ç”¨çš„ç®—æ³•é€»è¾‘;
2. åŸºç¡€æ¡†æ¶: è¯¥æ¡†æ¶åº”è¯¥æ•´åˆæˆ–è€…å®ç° J2EE å¼€å‘æ‰€éœ€è¦çš„å¸¸ç”¨åŠŸèƒ½, ä¸ºå„ç±»é¡¹ç›®å¼€å‘æä¾›åŸºç¡€æ”¯æŒ;
3. å¹³å°æ¡†æ¶: é’ˆå¯¹äºæŸç§ç‰¹å®šé¢†åŸŸï¼Œå®ç°ç‰¹å®šé¢†åŸŸæ‰€éœ€è¦çš„å¸¸ç”¨åŠŸèƒ½;

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦åŸºç¡€æ¡†æ¶

è½¯ä»¶ç³»ç»Ÿéšç€ä¸šåŠ¡çš„å‘å±•ï¼Œå˜å¾—è¶Šæ¥è¶Šå¤æ‚ï¼Œä¸åŒé¢†åŸŸçš„ä¸šåŠ¡æ‰€æ¶‰åŠåˆ°çš„çŸ¥è¯†ã€å†…å®¹ã€é—®é¢˜éå¸¸éå¸¸å¤šã€‚å¦‚æœæ¯æ¬¡éƒ½ä»å¤´å¼€å‘ï¼Œé‚£éƒ½æ˜¯ä¸€ä¸ªå¾ˆæ¼«é•¿çš„äº‹æƒ…ï¼Œä¸”å¹¶ä¸ä¸€å®šèƒ½å°†å®ƒåšå¥½ã€‚å›¢é˜Ÿåä½œå¼€å‘æ—¶ï¼Œæ²¡æœ‰äº†ç»Ÿä¸€æ ‡å‡†ï¼Œå¤§å®¶å„å†™å„çš„ï¼ŒåŒæ ·çš„é‡å¤çš„åŠŸèƒ½åˆ°å¤„éƒ½æ˜¯ã€‚ç”±äºæ²¡æœ‰ç»Ÿä¸€è°ƒç”¨è§„èŒƒï¼Œå¾ˆéš¾çœ‹æ‡‚åˆ«äººå†™çš„ä»£ç ï¼Œå‡ºç° Bug æˆ–äºŒæ¬¡å¼€å‘ç»´æŠ¤æ—¶ï¼Œæ ¹æœ¬æ— ä»ä¸‹æ‰‹ã€‚

è€Œä¸€ä¸ªæˆç†Ÿçš„åŸºç¡€æ¡†æ¶ï¼Œå®ƒæ˜¯æ¨¡æ¿åŒ–çš„ä»£ç ï¼Œå®ƒä¼šå¸®æˆ‘ä»¬å®ç°å¾ˆå¤šåŸºç¡€æ€§çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸“å¿ƒçš„å®ç°æ‰€éœ€è¦çš„ **ä¸šåŠ¡é€»è¾‘** å°±å¯ä»¥äº†ã€‚è€Œå¾ˆå¤šåº•å±‚åŠŸèƒ½æ“ä½œï¼Œå°±å¯ä»¥å®Œå®Œå…¨å…¨ä¸ç”¨åšå¤ªå¤šçš„è€ƒè™‘ï¼Œæ¡†æ¶å·²å¸®æˆ‘ä»¬å®ç°äº†ã€‚è¿™æ ·çš„è¯ï¼Œæ•´ä¸ªå›¢é˜Ÿçš„å¼€å‘æ•ˆç‡å¯æƒ³è€ŒçŸ¥ã€‚å¦å¤–å¯¹äºå›¢é˜Ÿæˆå‘˜çš„å˜åŠ¨ï¼Œä¹Ÿä¸ç”¨å¤ªè¿‡æ‹…å¿ƒï¼Œæ¡†æ¶çš„ä»£ç è§„èŒƒè®©æˆ‘ä»¬èƒ½è½»æ¾çš„çœ‹æ‡‚å…¶ä»–å¼€å‘äººå‘˜æ‰€å†™çš„ä»£ç ã€‚

#### 1.2.1 ä»£ç æ¨¡æ¿åŒ–

åŸºç¡€æ¡†æ¶èƒ½å¤Ÿç¡®ä¿ **ä»£ç é£æ ¼** çš„ä¸€è‡´æ€§ï¼ŒåŒä¸€åˆ†å±‚çš„ä¸åŒç±»ä»£ç ï¼Œéƒ½æ˜¯å¤§åŒå°å¼‚çš„æ¨¡æ¿åŒ–ç»“æ„ï¼Œæ–¹ä¾¿ä½¿ç”¨æ¨¡æ¿å·¥å…·ç»Ÿä¸€ç”Ÿæˆï¼Œå‡å°‘å¤§é‡é‡å¤ä»£ç çš„ç¼–å†™ã€‚åœ¨å­¦ä¹ æ—¶é€šå¸¸åªè¦ç†è§£æŸä¸€å±‚æœ‰ä»£è¡¨æ€§çš„ä¸€ä¸ªç±»ï¼Œå°±ç­‰äºäº†è§£äº†åŒä¸€å±‚çš„å…¶ä»–å¤§éƒ¨åˆ†ç±»ç»“æ„å’ŒåŠŸèƒ½ï¼Œå®¹æ˜“ä¸Šæ‰‹ã€‚å›¢é˜Ÿä¸­ä¸åŒçš„äººå‘˜é‡‡ç”¨ç±»åŒçš„è°ƒç”¨é£æ ¼è¿›è¡Œç¼–ç ï¼Œå¾ˆå¤§ç¨‹åº¦æé«˜äº†ä»£ç çš„å¯è¯»æ€§ï¼Œæ–¹ä¾¿ç»´æŠ¤ä¸ç®¡ç†ã€‚

#### 1.2.2 å¯å¤ç”¨

åŸºç¡€æ¡†æ¶èƒ½å¤Ÿç¡®ä¿å±‚æ¬¡æ¸…æ™°ï¼Œä¸åŒå¼€å‘äººå‘˜å¼€å‘æ—¶éƒ½ä¼šæ ¹æ®å…·ä½“åŠŸèƒ½æ”¾åˆ°ç›¸åŒçš„ä½ç½®ï¼ŒåŠ ä¸Šé…åˆç›¸åº”çš„å¼€å‘æ–‡æ¡£ï¼Œä»£ç é‡ç”¨ä¼šéå¸¸é«˜ï¼Œæƒ³è¦è°ƒç”¨ä»€ä¹ˆåŠŸèƒ½ç›´æ¥è¿›å¯¹åº”çš„ä½ç½®å»æŸ¥æ‰¾ç›¸å…³å‡½æ•°ï¼Œè€Œä¸æ˜¯æ¯ä¸ªå¼€å‘äººå‘˜å„è‡ªç¼–å†™ä¸€å¥—ç›¸åŒçš„æ–¹æ³•ã€‚

#### 1.2.3 é«˜å†…èšï¼ˆå°è£…ï¼‰

åŸºç¡€æ¡†æ¶ä¸­çš„åŠŸèƒ½ä¼šå®ç°é«˜å†…èšï¼Œå¼€å‘äººå‘˜å°†å„ç§éœ€è¦çš„åŠŸèƒ½å°è£…åœ¨ä¸åŒçš„å±‚ä¸­ï¼Œç»™å¤§å®¶è°ƒç”¨ï¼Œè€Œå¤§å®¶åœ¨è°ƒç”¨æ—¶ä¸éœ€è¦æ¸…æ¥šè¿™äº›æ–¹æ³•é‡Œé¢æ˜¯å¦‚æœå®ç°çš„ï¼Œåªéœ€è¦å…³æ³¨è¾“å‡ºçš„ç»“æœæ˜¯å¦æ˜¯è‡ªå·±æƒ³è¦çš„å°±å¯ä»¥äº†ã€‚

#### 1.2.4 è§„èŒƒ

åŸºç¡€æ¡†æ¶ä¸¥æ ¼æ‰§è¡Œä»£ç å¼€å‘è§„èŒƒè¦æ±‚ï¼Œåšå¥½å‘½åã€æ³¨é‡Šã€æ¶æ„åˆ†å±‚ã€ç¼–ç ã€æ–‡æ¡£ç¼–å†™ç­‰è§„èŒƒè¦æ±‚ã€‚å› ä¸ºåŸºç¡€æ¡†æ¶æ˜¯æ‰€æœ‰ä¸šåŠ¡é¡¹ç›®çš„åŸºç¡€, è¦è®©å¼€å‘è€…æ›´åŠ å®¹æ˜“ç†è§£ä¸æŒæ¡ã€‚

#### 1.2.5 å¯æ‰©å±•

åŸºç¡€æ¡†æ¶å…·å¤‡å¯æ‰©å±•æ€§ï¼Œå½“ä¸šåŠ¡é€»è¾‘æ›´åŠ å¤æ‚ã€æ•°é‡è®°å½•é‡çˆ†å¢ã€å¹¶å‘é‡å¢å¤§æ—¶ï¼Œå¯èƒ½åªéœ€è¦è°ƒæ•´åŸºç¡€æ¡†æ¶å³å¯æ»¡è¶³å¤§éƒ¨åˆ†ä¸šåŠ¡éœ€æ±‚, é¿å…åœ¨å¤šä¸ªé¡¹ç›®ä¸­å»è°ƒæ•´.

#### 1.2.6 å¯ç»´æŠ¤

åŸºç¡€æ¡†æ¶é€šè¿‡å¿…è¦çš„æŠ€æœ¯æ‰‹æ®µ, ä¿è¯ä¸šåŠ¡ä»£ç çš„å¯ç»´æŠ¤æ€§, æ¯”å¦‚é€šè¿‡å¼ºåˆ¶çš„ä»£ç æ£€æŸ¥ä¿è¯ä»£ç æ ¼å¼ç»Ÿä¸€, æé«˜å¯ç»´æŠ¤æ€§; ç»Ÿä¸€çš„å¸¸ç”¨åŠŸèƒ½æˆ–ç‰¹æ€§ä¿è¯å¼€å‘è€…ä½¿ç”¨ç»Ÿä¸€çš„æ–¹å¼å¤„ç†é€šç”¨é€»è¾‘, åŒæ ·æé«˜äº†ä»£ç æˆ–é¡¹ç›®çš„å¯ç»´æŠ¤æ€§.

#### 1.2.7 åä½œå¼€å‘

æœ‰äº†åŸºç¡€æ¡†æ¶ï¼Œæˆ‘ä»¬æ‰èƒ½ç»„ç»‡å¤§å¤§å°å°çš„å›¢é˜Ÿæ›´å¥½çš„è¿›è¡Œåä½œå¼€å‘ï¼Œæˆç†Ÿçš„æ¡†æ¶å°†å¤§å¤§å‡è½»é¡¹ç›®å¼€å‘çš„éš¾åº¦ï¼ŒåŠ å¿«å¼€å‘é€Ÿåº¦ï¼Œé™ä½å¼€å‘è´¹ç”¨ï¼Œå‡è½»ç»´æŠ¤éš¾åº¦ã€‚

#### 1.2.8 é€šç”¨æ€§

åŒä¸€è¡Œä¸šæˆ–é¢†åŸŸçš„æ¡†æ¶ï¼ŒåŠŸèƒ½éƒ½æ˜¯å¤§åŒå°å¼‚çš„ï¼Œä¸ç”¨åšå¤ªå¤§çš„æ”¹åŠ¨å°±å¯ä»¥åº”ç”¨åˆ°ç±»ä¼¼çš„é¡¹ç›®ä¸­ã€‚åœ¨æ¡†æ¶ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šå®ç°ä¸€äº›åŒè´¨åŒ–çš„åŸºç¡€åŠŸèƒ½ï¼Œæ¯”å¦‚æƒé™ç®¡ç†ã€è§’è‰²ç®¡ç†ã€èœå•ç®¡ç†ã€æ—¥å¿—ç®¡ç†ã€å¼‚å¸¸å¤„ç†...... æˆ–è¯¥è¡Œä¸šä¸­æ‰€è¦ä½¿ç”¨åˆ°çš„é€šç”¨åŠŸèƒ½.

#### 1.2.9 æ€»ç»“

æ€»ç»“èµ·æ¥, ä½¿ç”¨åŸºç¡€æ¡†æ¶çš„ä¼˜ç‚¹å¦‚ä¸‹:

1. é‡ç”¨ä»£ç å¤§å¤§å¢åŠ ï¼Œè½¯ä»¶ç”Ÿäº§æ•ˆç‡å’Œè´¨é‡ä¹Ÿå¾—åˆ°äº†æé«˜ï¼›
2. ä»£ç ç»“æ„çš„è§„èŒƒåŒ–ï¼Œé™ä½ç¨‹åºå‘˜ä¹‹é—´æ²Ÿé€šä»¥åŠæ—¥åç»´æŠ¤çš„æˆæœ¬ï¼›
3. çŸ¥è¯†çš„ç§¯ç´¯ï¼Œå¯ä»¥è®©é‚£äº›ç»éªŒä¸°å¯Œçš„äººå‘˜å»è®¾è®¡æ¡†æ¶å’Œé¢†åŸŸæ„ä»¶ï¼Œè€Œä¸å¿…é™äºä½å±‚ç¼–ç¨‹ï¼›
4. è½¯ä»¶è®¾è®¡äººå‘˜è¦ä¸“æ³¨äºå¯¹é¢†åŸŸçš„äº†è§£ï¼Œä½¿éœ€æ±‚åˆ†ææ›´å……åˆ†ï¼›
5. å…è®¸é‡‡ç”¨å¿«é€ŸåŸå‹æŠ€æœ¯ï¼› æœ‰åˆ©äºåœ¨ä¸€ä¸ªé¡¹ç›®å†…å¤šäººååŒå·¥ä½œï¼›
6. å¤§ç²’åº¦çš„é‡ç”¨ä½¿å¾—å¹³å‡å¼€å‘è´¹ç”¨é™ä½ï¼Œå¼€å‘é€Ÿåº¦åŠ å¿«ï¼Œå¼€å‘äººå‘˜å‡å°‘ï¼Œç»´æŠ¤è´¹ç”¨é™ä½ï¼Œè€Œå‚æ•°åŒ–æ¡†æ¶ä½¿å¾—é€‚åº”æ€§ã€çµæ´»æ€§å¢å¼ºã€‚

### 1.3 ä¸åŸºç¡€å¼€å‘å¹³å°çš„åŒºåˆ«

åŸºç¡€æ¡†æ¶æ˜¯åŸºç¡€å¼€å‘å¹³å°çš„ **å­é›†**, æ˜¯å±äºåŸºç¡€å¼€å‘å¹³å°çš„ä¸­å±‚çš„é€šç”¨ç ”å‘æ¡†æ¶, åŸºç¡€æ¡†æ¶ä¸åŸºç¡€å¼€å‘å¹³å°çš„å…³ç³»å¦‚ä¸‹:

![difference.drawio.svg](https://cdn.dong4j.site/source/image/difference.drawio.svg)

å¸¸è§çš„åŸºç¡€å¼€å‘å¹³å°ä¸ä»…ä»…åªæä¾›äº† **åŸºç¡€å¼€å‘æ¡†æ¶**, è€Œæ˜¯åœ¨æ­¤åŸºç¡€ä¸Šæä¾›äº†æ›´å¤šçš„æœåŠ¡æ²»ç†, æœåŠ¡ç›‘æ§ç­‰åŠŸèƒ½, æ›´å…·å¤‡å®Œå–„çš„åŸºç¡€è®¾æ–½å»ºè®¾, åŒ…æ‹¬æŒç»­é›†æˆä¸éƒ¨ç½², K8S ç­‰. è¿™ä¸€å¥—é€šå¸¸éœ€è¦ç™¾äººå›¢é˜ŸèŠ±è´¹å‡ å¹´æ—¶é—´é€æ­¥å®Œå–„, ä¸”ä½¿ç”¨åœºæ™¯ä¸€èˆ¬åœ¨ **åˆ†å¸ƒå¼å¾®æœåŠ¡** çš„ä¸šåŠ¡åœºæ™¯ä¸­.

ç»¼ä¸Šæ•°æ®, ç›®å‰æ­å»ºä¸€ä¸ª **åŸºç¡€å¼€å‘å¹³å°** å¯¹æˆ‘ä»¬æ¥è¯´æš‚æ—¶è¿˜æ²¡æœ‰å¿…è¦, å½“å‰é˜¶æ®µæä¾›ä¸€ä¸ª **åŸºç¡€æ¡†æ¶** æ„ä¹‰æ›´å¤§.

## 2. åŸºç¡€æ¡†æ¶æ¶æ„

![framework_1.0.0.svg](https://cdn.dong4j.site/source/image/framework_1.0.0.svg)

### 2.1 æŠ€æœ¯é€‰å‹

æŠ€æœ¯é€‰å‹ä¸€èˆ¬æŒ‰ç…§ä»¥ä¸‹å‡ ä¸ªåŸåˆ™:

1. éœ€è¦çœ‹è½¯ä»¶ç‰¹æ€§æ˜¯å¦æ»¡è¶³éœ€æ±‚, åŒ…æ‹¬å…¼å®¹æ€§, æ‰©å±•æ€§å’Œä½¿ç”¨åˆ°çš„æŠ€æœ¯æ ˆ;
2. æ ¹æ®ç›®å‰è‡ªå·±æˆ–è€…å›¢é˜Ÿçš„æŠ€æœ¯æ ˆå’ŒæŠ€æœ¯èƒ½åŠ›ï¼Œèƒ½å¦å¯ä»¥å¹³æ»‘çš„ä½¿ç”¨;
3. æŠ€æœ¯ç¤¾åŒºçš„æ´»è·ƒåº¦, åŒ…æ‹¬:
   1. æ˜¯å¦æœ‰ä¸“äººç»´æŠ¤;
   2. æ˜¯å¦æœ‰å®Œå–„çš„æ–‡æ¡£;
   3. é‡åˆ°çš„é—®é¢˜æ˜¯å¦èƒ½å¤Ÿå¿«é€Ÿå¾—åˆ°å¸®åŠ©å¹¶è§£å†³;
   4. æ˜¯å¦åœ¨ä¸šå†…éƒ¨è¢«å¹¿æ³›ä½¿ç”¨;

æŒ‰ç…§ä¸Šé¢çš„åŸåˆ™, æ‰€é€‰ä¸»è¦æŠ€æœ¯æ ˆæ•´ç†å¦‚ä¸‹:

![20241229154732_SgCYXo9I.webp](https://cdn.dong4j.site/source/image/20241229154732_SgCYXo9I.webp)

| æ¡†æ¶                                                                                             | è¯´æ˜                  |
| ------------------------------------------------------------------------------------------------ | --------------------- |
| JDK 8                                                                                            | å¼€å‘è€…å·¥å…·            |
| [Spring Boot](https://spring.io/projects/spring-boot) 2.3.12                                     | åº•å±‚æ¡†æ¶              |
| [Spring Cloud Alibaba](https://github.com/alibaba/spring-cloud-alibaba/tree/2.2.9.RELEASE) 2.2.9 | Spring Cloud æ¡†æ¶     |
| Nacos 2.x                                                                                        | é…ç½®ä¸­å¿ƒ              |
| [xxl-job](https://github.com/xuxueli/xxl-job)                                                    | åˆ†å¸ƒå¼ä»»åŠ¡è°ƒé…        |
| [Hutool](https://hutool.cn/docs/#/)                                                              | å¸¸ç”¨å·¥å…·åŒ…            |
| [Kafka](https://kafka.apache.org/)                                                               | ä¸šåŠ¡æ¶ˆæ¯é˜Ÿåˆ—          |
| [EMQ](https://www.emqx.com/zh)                                                                   | ç‰©è”è®¾å¤‡æ¶ˆæ¯é˜Ÿåˆ—      |
| [MySQL](https://www.mysql.com/cn/) 8.x                                                           | æ•°æ®åº“                |
| [Druid](https://github.com/alibaba/druid) 1.2.15                                                 | JDBC è¿æ¥æ± ã€ç›‘æ§ç»„ä»¶ |
| [MyBatis Plus](https://mp.baomidou.com/) 3.5.x                                                   | MyBatis å¢å¼ºå·¥å…·åŒ…    |
| [Redis](https://redis.io/) 6.x                                                                   | key-value æ•°æ®åº“      |
| [Knife4j](https://gitee.com/xiaoym/knife4j) 3.0.3                                                | Swagger å¢å¼º UI å®ç°  |
| [MapStruct](https://mapstruct.org/) 1.5.3.Final                                                  | Java Bean è½¬æ¢        |
| [Lombok](https://projectlombok.org/) 1.18.24                                                     | æ¶ˆé™¤å†—é•¿çš„ Java ä»£ç   |
| [JUnit](https://junit.org/junit5/) 5.8.2                                                         | Java å•å…ƒæµ‹è¯•æ¡†æ¶     |

### 2.2 ä¸»è¦ç‰¹æ€§

- ä½¿ç”¨ Maven å¯¹é¡¹ç›®ä¾èµ–ç®¡ç†åšäº†å¤§é‡ä¼˜åŒ–ï¼ŒæŠ½è±¡å‡ºå…¬å¸é¡¶çº§ Maven çˆ¶æ¨¡å—ï¼Œç»Ÿä¸€ç®¡ç†å…¬å¸æ‰€æœ‰å­é¡¹ç›®ï¼›
- é¡¹ç›®æ¨¡å—åˆ†å·¥æ˜ç¡®ï¼Œéµå¾ªå•ä¸€èŒè´£ï¼Œæ¨¡å—ä¹‹é—´ä½¿ç”¨æœ€å°ä¾èµ–åŸåˆ™ï¼Œå®Œå…¨ä¸å­˜åœ¨å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œç²¾ç¡®æ§åˆ¶ Maven ä¾èµ–ä¼ é€’ï¼Œå°½é‡é¿å…ä¾èµ–å†²çª (å¦‚æœå­˜åœ¨ä¾èµ–å†²çªï¼Œæˆ‘ä»¬ä¹Ÿä¼šåœ¨ç¼–è¯‘æ—¶ç»™å‡ºå‘Šè­¦);
- ä½¿ç”¨ä¸åŒçš„çˆ¶é¡¹ç›®å°†ä¸šåŠ¡é¡¹ç›®å’Œæ¡†æ¶é¡¹ç›®è¿›è¡Œéš”ç¦»ï¼Œå¹¶ä¸”æä¾› starter çš„å¼€å‘æ¨¡æ¿ï¼Œç®€åŒ–å’Œè§„èŒƒ starter ç»„ä»¶å¼€å‘ï¼›
- ä½¿ç”¨ `Java Annotation Processor` è‡ªåŠ¨ç”Ÿæˆ starter ç»„ä»¶çš„å…ƒæ•°æ®æ–‡ä»¶ï¼Œå‡å°‘é‡å¤é…ç½®ï¼Œé™ä½å‡ºé”™çš„æ¦‚ç‡ï¼›
- ä½¿ç”¨ `Maven Plugin` è‡ªåŠ¨ç”Ÿæˆæ‰“åŒ…é…ç½®ï¼Œé€šç”¨å¯åŠ¨è„šæœ¬ï¼Œå‡å°‘é‡å¤æ€§å·¥ä½œï¼Œå¿½ç•¥ä¸éœ€è¦çš„é…ç½®ä»¥æé«˜ç¼–è¯‘é€Ÿåº¦ï¼›
- å°† BOM ç®¡ç†é¡¹ç›®ä¾èµ–ä»¥ç»Ÿä¸€å…¨éƒ¨é¡¹ç›®çš„ä¾èµ–ï¼Œå‡å°‘ä¾èµ–å†²çªï¼Œä¸”åˆ†ä¸º 3 å±‚è¿›è¡Œå•ç‹¬ç®¡ç†ï¼›
- ä½¿ç”¨ `ThinJar` ä»£æ›¿ `FatJar`, æ–¹ä¾¿ä¿®æ”¹é…ç½®ä¸ Jar æ›¿æ¢ä¸”å…·å¤‡æ›´é«˜çš„å¯å®šåˆ¶åŒ–ï¼›
- ä¸¥æ ¼éµå¾ªé˜¿é‡Œå·´å·´å¼€å‘è§„èŒƒï¼Œä¸”å¯¹ä»£ç è¿›è¡Œäº†å¼ºåˆ¶æ£€æŸ¥ï¼›
- åœ¨ Spring åŸºç¡€ä¸Šå°è£…å¤šä¸ªå·¥å…·ç±»ï¼Œå‡å°‘ç¬¬ä¸‰æ–¹ä¾èµ–è¿›è€Œå‡å°‘éƒ¨ç½²åŒ…ä½“ç§¯ï¼›
- åŸºäº `Spring Boot Starter` å°è£…å¤šä¸ªåŸºç¡€ç»„ä»¶ä¸”ç»„ä»¶ä¹‹é—´å®Œå…¨éš”ç¦»ï¼ŒåŸºäº SPI è‡ªåŠ¨è®¾ç½®é»˜è®¤é…ç½®ï¼Œå‡å°‘é‡å¤çš„å¼€å‘å·¥ä½œï¼›
- å°è£…äº† `Spring` çš„äº‹ä»¶å¤„ç†å™¨ï¼Œå½»åº•è§£å†³åœ¨ `Spring Cloud` ç¯å¢ƒä¸‹äº‹ä»¶ç›‘å¬å™¨è¢«å¤šæ¬¡æ‰§è¡Œçš„é—®é¢˜ï¼›
- å°è£…äº†é€šç”¨å¯åŠ¨å™¨ï¼Œä¸”åœ¨åº”ç”¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸæä¾›å„ç§æ‰©å±•ç‚¹ä»¥æ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘ï¼›
- å°è£…äº†ç»Ÿä¸€çš„æ—¥å¿—ç»„ä»¶ï¼Œå‡å°‘ä¸šåŠ¡é¡¹ç›®çš„æ—¥å¿—é…ç½®ï¼Œä¸”å…è®¸è‡ªå®šä¹‰æ—¥å¿—é…ç½®ä»¥æ»¡è¶³ä¸šåŠ¡ä¸Šçš„æ—¥å¿—éœ€æ±‚ï¼›
- å°è£…äº† `REST` ç»„ä»¶ä¸”æä¾›äº†å…¨å±€å¼‚å¸¸å¤„ç†ï¼Œç»Ÿä¸€çš„è¿”å›ç»“æœï¼Œæ¥å£å‚æ•°éªŒè¯ï¼Œé”™è¯¯ä¿¡æ¯å›½é™…åŒ–ï¼Œå¤šç§å…¥å‚æ³¨å…¥æ–¹å¼ç­‰ï¼›
- é›†æˆäº† `Nacos` ä½œä¸ºé…ç½®ä¸­å¿ƒï¼Œä¸”å¯¹ `Nacos` è¿›è¡ŒäºŒæ¬¡å¼€å‘å’Œä¼˜åŒ–ï¼Œä»¥æ»¡è¶³ç°æœ‰ä¸šåŠ¡éœ€æ±‚ï¼›
- é›†æˆäº†åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ï¼Œä»¥å¯è§†åŒ–çš„æ–¹å¼æ›´åŠ æ–¹ä¾¿çš„ç®¡ç†å®šæ—¶ä»»åŠ¡ï¼Œä¸”æä¾› API æ¥å£ç›´æ¥æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼›
- é›†æˆäº†æ¯” Swagger æ›´åŠ ä¼˜åŒ–çš„ API æ–‡æ¡£å·¥å…·ï¼›
- é›†æˆäº†å¤šçº§ç¼“å­˜æ¡†æ¶ï¼Œå°è£…äº†æ›´åŠ å‹å¥½çš„åˆ†å¸ƒå¼é”å®ç°ï¼›
- å°è£…äº† MapStruct ç®€åŒ–å®ä½“é—´äº’ç›¸è½¬æ¢ï¼›
- é›†æˆäº† `Mybatis-Plus` ç®€åŒ–å•è¡¨æ“ä½œï¼Œå°è£…äº†é€šç”¨çš„åˆ†é¡µæŸ¥è¯¢ï¼Œæšä¸¾è‡ªåŠ¨è½¬æ¢ç­‰ï¼›
- å°è£…äº† `Mybatis-Plus` ä»£ç è‡ªåŠ¨ç”Ÿæˆï¼›
- å°è£…äº†å•å…ƒæµ‹è¯•ç»„ä»¶ï¼Œä½¿ç”¨ `Junit 5` ä½œä¸ºåº•å±‚æ¡†æ¶ï¼Œä¸”å°è£…äº†å¹¶å‘æµ‹è¯•å·¥å…·ï¼Œæ”¯æŒ `Mock` ç­‰ï¼›

### 2.3 ä¸»è¦ç»„ä»¶

#### 2.3.1 é¡¹ç›®ä¾èµ–ç®¡ç†

ä»»ä½•ä¸šåŠ¡é¡¹ç›®å­˜åœ¨ä¸€ä¸ªè¾ƒå¤§çš„é—®é¢˜å°±æ˜¯ **é¡¹ç›®ä¾èµ–ç®¡ç†**ï¼Œ å¦‚æœç¨ä¸æ³¨æ„å°±ä¼šå‘ç”Ÿä¾èµ–å†²çªï¼Œ å¯¼è‡´é¡¹ç›®å¯åŠ¨å¤±è´¥ã€‚ å¦‚æœè¦ä¿®æ”¹ä¾èµ–ç‰ˆæœ¬éœ€è¦è€ƒè™‘åˆ°å¤šä¸ªé¡¹ç›®çš„ä¾èµ–å…³ç³»ï¼Œ ä¸ºäº†å½»åº•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ å…¬å¸çº§çš„é¡¹ç›®ä¾èµ–ç®¡ç†æ–¹æ¡ˆ: æ‰€æœ‰ä¸šåŠ¡é¡¹ç›®éƒ½éœ€è¦ä»¥ `atom-business-parent` ä¸ºé¡¹ç›®çˆ¶ä¾èµ–ï¼Œ ç»Ÿä¸€æä¾› **ç‰ˆæœ¬å·ç®¡ç†**ï¼Œ **Maven æ’ä»¶é›†æˆ** å’Œ **å…¬å…±é…ç½®**:

1. é¡¹ç›®ä¾èµ–ç®¡ç†:

   åˆ›å»ºäº†ä¸€ä¸ªé¡¶å±‚ Maven é¡¹ç›®ï¼Œ ç”¨äºè§„èŒƒæ‰€æœ‰ä¸šåŠ¡é¡¹ç›®çš„å®šä¹‰ï¼Œ ç°åœ¨åªéœ€è¦ç®€å•ä¾èµ–ä¸€ä¸ªçˆ¶é¡¹ç›®ï¼Œ å°±å¯ä»¥å®Œå…¨ç»§æ‰¿æ‰€æœ‰ä¾èµ–çš„ç‰ˆæœ¬å·ï¼Œ Maven æ’ä»¶ï¼Œ é¡¹ç›®ä¾èµ–ä¸Šä¼ åœ°å€ç­‰ã€‚ ä¸€æ˜¯èƒ½å¤Ÿç»Ÿä¸€å…¬å¸æ‰€æœ‰é¡¹ç›®ä¾èµ–çš„ç‰ˆæœ¬å·ï¼Œ ä»¥**å‡å°‘ä¾èµ–å†²çª** ; äºŒæ˜¯å‡å°‘ä¸šåŠ¡å¼€å‘æ—¶ç¹çä¸”é‡å¤çš„é¡¹ç›®é…ç½®ä»£ç ï¼Œ ä»¥**å°†é‡å¿ƒæ–¹æ³•éœ€æ±‚å¼€å‘ä¸Š**ã€‚

   ä¸ºæ–¹ä¾¿ç®¡ç†ä¸æ ¹æ®ä¸åŒçš„é¡¹ç›®ç‰¹ç‚¹ç»†åŒ–åŠŸèƒ½ï¼Œ å¹¶æŠ½ç¦»é€šç”¨é…ç½®ï¼Œ å°†çˆ¶çº§é¡¹ç›®ç»†åˆ†ä¸ºäº†**ä¸šåŠ¡çˆ¶é¡¹ç›®**ï¼Œ **æŠ€æœ¯ç»„ä»¶çˆ¶é¡¹ç›®** ï¼Œ **ä¾èµ–ç®¡ç†çˆ¶é¡¹ç›®** å’Œ **ä¸€é”®éƒ¨ç½²çˆ¶é¡¹ç›®**ï¼Œ ä¸šåŠ¡æ–¹åªéœ€è¦å…³å¿ƒ **ä¸šåŠ¡çˆ¶é¡¹ç›®**ï¼Œ åœ¨æ¡†æ¶å‡çº§æ—¶ï¼Œ åªéœ€è¦ä¿®æ”¹ç‰ˆæœ¬å·å³å¯ã€‚

2. Maven æ’ä»¶:

   æä¾›äº†ä»£ç è§„èŒƒæ£€æŸ¥ï¼Œ ä¾èµ–å†²çªæ£€æŸ¥ï¼Œ å¯åŠ¨è„šæœ¬è‡ªåŠ¨ç”Ÿæˆï¼Œ é¡¹ç›®ä¸€é”®éƒ¨ç½²ç­‰åŠŸèƒ½ã€‚

   ä¸€æ˜¯è®©æ‰€æœ‰é¡¹ç›®çš„ä»£ç é£æ ¼ä¿æŒä¸€è‡´ï¼Œ **æœ‰æ•ˆå‡å°å› ä¸ºæ ¼å¼ä¸ç»Ÿä¸€å¯¼è‡´çš„ä»£ç å†²çª** ;

   äºŒæ˜¯é€šè¿‡ä¸€äº›è‡ªåŠ¨åŒ–çš„æ–¹å¼**ç”Ÿæˆä¸å¯æˆ–ç¼ºçš„æ–‡ä»¶ï¼Œ é¿å…æ‰‹åŠ¨åˆ›å»º** ;

   é¡¹ç›®ä¸€é”®éƒ¨ç½²å¯**æé«˜æœåŠ¡éƒ¨ç½²æ•ˆç‡ï¼Œ å‡å°‘äººå·¥éƒ¨ç½²çš„æ—¶é—´**ï¼Œ å¯ä»åŸæ¥çš„ **30 åˆ†å‡å°‘åˆ° 1 åˆ†é’Ÿä¹‹å†…**ï¼Œ å¦‚æœæ˜¯å¤šæœåŠ¡éƒ¨ç½²ï¼Œ æ•ˆæœæ›´åŠ æ˜æ˜¾ï¼›

   ä¸ºäº†æ–¹ä¾¿å…¶ä»–ä¸šåŠ¡ç»„å¼€å‘ä¸šåŠ¡ç›¸å…³çš„ Maven æ’ä»¶ï¼Œ æˆ‘ä»¬è¿˜**æä¾›æ’ä»¶æ¨¡æ¿ï¼Œ èƒ½å¤Ÿå¿«é€Ÿå¼€å‘ä¸€ä¸ªé¡¹ç›®çº§ Maven æ’ä»¶.**

3. SPI ä¸ Spring Boot æ–‡ä»¶ç”Ÿæˆ

   é€šè¿‡ç®€å•çš„æ³¨è§£ä¸ºä¸šåŠ¡å¼€å‘ä¸­ä½¿ç”¨åˆ°çš„ SPI æŠ€æœ¯å’Œ Spring Boot è‡ªåŠ¨ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œ æ— éœ€æ‰‹åŠ¨åˆ›å»ºï¼Œ ä¸”å¯¹å¼€å‘é€æ˜æ— æ„ŸçŸ¥ã€‚

##### 2.3.2.1 åŒ…å«æ¨¡å—

| æ¨¡å—                          | ä»‹ç»                                                                                |
| ----------------------------- | ----------------------------------------------------------------------------------- |
| **atom-supreme**              | å…¬å¸é¡¶å±‚é¡¹ç›®ï¼Œ ç”¨äºè§„èŒƒæ‰€æœ‰åç«¯æœåŠ¡çš„ä¾èµ–ï¼Œ æä¾›å¸¸ç”¨çš„ Maven æ’ä»¶                   |
| **atom-builder**              | æ¡†æ¶é¡¶å±‚ä¾èµ–ï¼Œ ç”¨äºç®¡ç†é€šç”¨é…ç½®ï¼Œ ä¾èµ–ç‰ˆæœ¬ä¸é¡¹ç›®ä¾èµ–å…³ç³»                            |
| â†’ atom-project-builder        | atom-business-parent ä¸ atom-component-parent çˆ¶ä¾èµ–ï¼Œ æŠ½ç¦»å…¬å…±é…ç½®                 |
| â†’ atom-project-denpendencies  | ç»´æŠ¤ä¸šåŠ¡å¼€å‘ä¸­å¸¸ç”¨çš„ç¬¬ä¸‰æ–¹ä¾èµ–ç‰ˆæœ¬ï¼Œ é¿å…ä¾èµ–å†²çª                                   |
| â†’ atom-dependencies-parent    | å…¬å¸çº§çš„ä¾èµ–çˆ¶é¡¹ç›®ï¼Œ ç®¡ç†æ‰€æœ‰ä¾èµ–å‹é¡¹ç›®                                             |
| â†’ atom-business-parent        | ä¸šåŠ¡é¡¹ç›®çˆ¶çº§ä¾èµ–ï¼Œ é›†æˆè‡ªæœ‰æ’ä»¶ä¸ç¬¬ä¸‰æ–¹æ’ä»¶ï¼Œ å¹¶æä¾›é€šç”¨çš„æ’ä»¶é…ç½®                  |
| â†’ atom-distribution-parent    | ä¸€é”®éƒ¨ç½²å‹é¡¹ç›®çˆ¶çº§ä¾èµ–ï¼Œ å¯ç®€åŒ–å­é¡¹ç›®çš„é…ç½®                                         |
| â†’ atom-component-parent       | æŠ€æœ¯ç»„ä»¶çˆ¶çº§ä¾èµ–ï¼Œ å¯å°†æºç ä¸Šä¼ åˆ° Maven ç§æœï¼Œ æ–¹ä¾¿æœ¬åœ°è°ƒè¯•                         |
| **atom-plugin**               | Maven æ’ä»¶é¡¹ç›®                                                                      |
| â†’ atom-assist-maven-plugin    | æ¡†æ¶å¼€å‘è¾…åŠ©æ’ä»¶ï¼Œ å¯æ ¹æ®é¡¹ç›®ç±»å‹ç¦ç”¨ / å¯ç”¨æ’ä»¶ï¼Œ ç”Ÿæˆé¡¹ç›®é…ç½®ç­‰åŠŸèƒ½               |
| â†’ atom-checkstyle-plugin-rule | ä»£ç æ ¼å¼æ£€æŸ¥æ’ä»¶                                                                    |
| â†’ atom-enforcer-plugin-rule   | é¡¹ç›®ä¾èµ–æ£€æŸ¥æ’ä»¶                                                                    |
| â†’ atom-makeself-maven-plugin  | é¡¹ç›®å¯åŠ¨è„šæœ¬ä¼˜åŒ–æ’ä»¶ï¼Œ å¯åœ¨ atom-script-maven-plugin çš„åŸºç¡€ä¸Šç”Ÿæˆå¯ç›´æ¥è¿è¡Œçš„éƒ¨ç½²åŒ… |
| â†’ atom-plugin-common          | æ’ä»¶é¡¹ç›®åŸºç¡€æ¨¡å—ï¼Œ æä¾›å¼€å‘æ’ä»¶çš„å·¥å…·åŒ…                                             |
| â†’ atom-pmd-plugin-rule        | ä»£ç è´¨é‡æ£€æŸ¥æ’ä»¶                                                                    |
| â†’ atom-publish-maven-plugin   | ä¸€é”®éƒ¨ç½²æ’ä»¶                                                                        |
| â†’ atom-script-maven-plugin    | å¯åŠ¨è„šæœ¬ç”Ÿæˆæ’ä»¶ï¼Œ å¯æ ¹æ®å‚æ•°ç”Ÿæˆé¡¹ç›®ç‰¹å®šçš„å¯åŠ¨è„šæœ¬                                 |
| **atom-starter-processor**    | SPI ä¸ Spring Boot é¡¹ç›®ç›¸å…³çš„é…ç½®ç”Ÿæˆç»„ä»¶                                           |

#### 2.3.3 å¼€å‘å·¥å…·åŒ…

æˆ‘ä»¬å°è£…äº†å¤§é‡çš„å¸¸ç”¨å·¥å…·åŒ…ï¼Œ ç›®æ ‡æ˜¯ä½¿ç”¨ä¸€ä¸ªå·¥å…·æ–¹æ³•ä»£æ›¿ä¸€æ®µå¤æ‚ä»£ç ï¼Œä»è€Œæœ€å¤§é™åº¦çš„é¿å… â€œå¤åˆ¶ç²˜è´´â€ ä»£ç çš„é—®é¢˜ï¼Œ å½»åº•æ”¹å˜æˆ‘ä»¬å†™ä»£ç çš„æ–¹å¼ï¼Œ ç›®çš„æ˜¯ä¸ºäº†å‡å°‘ä»£ç æœç´¢æˆæœ¬ï¼Œ é¿å…ç½‘ç»œä¸Šå‚å·®ä¸é½çš„ä»£ç å‡ºç°å¯¼è‡´çš„ BUG ã€‚

##### 2.3.3.1 åŒ…å«æ¨¡å—

| æ¨¡å—                      | ä»‹ç»                                                              |
| ------------------------- | ----------------------------------------------------------------- |
| atom-center-autoconfigure | è‡ªåŠ¨è£…é…åŸºç¡€ä¾èµ–                                                  |
| atom-center-common        | ä¸»è¦æä¾›ç¯å¢ƒï¼Œ äº‹ä»¶ï¼Œ é¡¹ç›®å¯åŠ¨ï¼Œ æ•°æ®è½¬æ¢ç­‰åŠŸèƒ½                   |
| atom-center-core          | æä¾›åå°„ï¼Œ åŸºç¡€å®ä½“ï¼Œ JSON å¤„ç†ï¼Œ æšä¸¾ï¼Œ Bean æ“ä½œç­‰              |
| atom-center-dependencies  | ç®¡ç†æ­¤é¡¹ç›®çš„ä¾èµ–ï¼Œ ä¸šåŠ¡ç«¯ä½¿ç”¨æ­¤æ¨¡å—å³å¯ï¼Œ æ— éœ€å…³å¿ƒç‰ˆæœ¬å·          |
| atom-center-devtools      | ä»£ç è‡ªåŠ¨ç”Ÿæˆ                                                      |
| atom-center-notify        | é€šçŸ¥ç›¸å…³åŸºç¡€æ¥å£ç›¸å…³å®ä½“                                          |
| atom-center-test          | æä¾› Mock ä¸é¡¹ç›®å•å…ƒæµ‹è¯•ç›¸å…³å·¥å…·ç±»ï¼Œ é€šè¿‡ä¸€ä¸ªæ³¨è§£å³å¯å®ç°é›†æˆæµ‹è¯• |
| atom-center-validation    | æ­£åˆ™ï¼Œ å‚æ•°éªŒè¯ï¼Œ åˆ†ç»„éªŒè¯ç­‰                                      |
| atom-center-structure     | å¸¸ç”¨è®¾è®¡æ¨¡å¼çš„å°è£…                                                |
| atom-center-spi           | java SPI çš„å°è£…                                                   |

#### 2.3.4 IDE æ’ä»¶

ä¸ºæä¾›å¼€å‘æ•ˆç‡ï¼Œ æˆ‘ä»¬å°†ä¸€äº›å¸¸ç”¨æ“ä½œé€šè¿‡ IDE æ’ä»¶çš„æ–¹å¼è¿›è¡Œç®€åŒ–ï¼Œ å°†ä»¥å‰å¤æ‚çš„æ“ä½œä»¥è‡ªåŠ¨åŒ–æˆ–å°‘é‡æ­¥éª¤æ¥ä»£æ›¿ï¼Œ è¿›ä¸€æ­¥èŠ‚çº¦å¼€å‘æ—¶é—´ã€‚

##### 2.3.4.1 åŒ…å«æ¨¡å—

| æ’ä»¶              | ä»‹ç»                                  |
| ----------------- | ------------------------------------- |
| atom-idea-commit  | git commit æäº¤è§„èŒƒæ£€æŸ¥               |
| atom-idea-common  | IDE æ’ä»¶åŸºç¡€æ¨¡å—                      |
| atom-idea-format  | ç»Ÿä¸€ä»£ç æ ·å¼æ’ä»¶                      |
| atom-idea-javadoc | Javadoc å¿«é€Ÿç”Ÿæˆ                      |
| atom-idea-patch   | å°†éƒ¨åˆ†ä»£ç æ‰“åŒ…æˆ jarï¼Œ ä»¥ä¾¿äºå¢é‡éƒ¨ç½² |
| atom-idea-root    | IDE æ’ä»¶çˆ¶é¡¹ç›®                        |

#### 2.3.5 æŠ€æœ¯ç»„ä»¶

åœ¨ä¸šåŠ¡å¼€å‘ä¸­ï¼Œ ç»å¸¸ä½¿ç”¨åˆ°ä¸€äº›é€šç”¨çš„åŠŸèƒ½ï¼Œ æ²¡æœ‰åŸºç¡€æ¡†æ¶ä¹‹å‰å¦‚æœéœ€è¦å¤ç”¨åŠŸèƒ½ï¼Œ éœ€è¦å°†ä»£ç ç¡¬æ‹·è´åˆ°å¦ä¸€ä¸ªå·¥ç¨‹ï¼Œç„¶åé‡æ–°é›†æˆä¸€éã€‚ ä¸ºäº†æä¾›ä»£ç å¤ç”¨æ€§ï¼Œ å¢å¼ºä»£ç å¯ç»´æŠ¤æ€§ï¼Œ æˆ‘ä»¬å°è£…å¤§é‡å¸¸ç”¨çš„æŠ€æœ¯ç»„ä»¶ï¼Œ ä¸šåŠ¡ç«¯åªéœ€è¦å¼•å…¥ä¸€ä¸ªç®€å•çš„ä¾èµ–å³å¯ä½¿ç”¨ï¼Œ è¿˜æ ¹æ®å…¬å¸ç¯å¢ƒæ›¿æ¢äº†é»˜è®¤é…ç½®ï¼Œ è¿™æ ·ä¸šåŠ¡ç«¯å¼•å…¥å°±å¯ä»¥ä½¿ç”¨ï¼Œ å¤§å¤§å‡å°‘äº†é‡å¤é…ç½®çš„æ—¶é—´ã€‚

å¦ä¸€æ–¹é¢ï¼Œ å¯¹äºå¤æ‚ä¾èµ–å…³ç³»ï¼Œæ‰‹åŠ¨ç®¡ç†æ‰€æœ‰é¡¹ç›®ä¾èµ–å¹¶ä¸ç†æƒ³ï¼Œå®¹æ˜“å‡ºç°è®¸å¤šé—®é¢˜ï¼Œ å¯èƒ½éœ€è¦èŠ±è´¹å¤§é‡çš„æ—¶é—´å»æ’æŸ¥ä¾èµ–é—®é¢˜ï¼Œ è€ŒæŠ€æœ¯ç»„ä»¶èƒ½å¤Ÿå¼•å…¥å…³è”çš„é—´æ¥ä¾èµ–ï¼Œ å‡å°‘ä¸šåŠ¡ç«¯çš„ä¾èµ–é…ç½®ã€‚

æŠ€æœ¯ç»„ä»¶èƒ½å¤Ÿä»¥ä¸€ç§å¼€ç®±å³ç”¨çš„æ–¹å¼æ”¯æ’‘ä¸šåŠ¡å¼€å‘ï¼Œ å‡å°‘é‡å¤çš„é›†æˆå·¥ä½œï¼Œ ç›®å‰å·²æœ‰ç»„ä»¶å¦‚ä¸‹:

##### 2.3.5.1 åŒ…å«ç»„ä»¶

| ç»„ä»¶                         | ä»‹ç»                                                                                                                                              |
| ---------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------- |
| atom-starter-auth            | è®¤è¯ç»„ä»¶ï¼Œ ä¾èµ–åè‡ªåŠ¨æä¾›ç™»å½•ç­‰ç›¸å…³æ¥å£ï¼Œ å‡å°‘ä¸šåŠ¡ç«¯é‡å¤çš„ç™»å½•æ¥å£é€»è¾‘ç¼–å†™                                                                        |
| atom-starter-dependencies    | æŠ€æœ¯ç»„ä»¶ä¾èµ–ç®¡ç†æ¨¡å—ï¼Œ é…ç½®äº†å¤§é‡å¸¸ç”¨çš„ä¾èµ–ç‰ˆæœ¬ï¼Œ é›†ä¸­è§£å†³ä¾èµ–ç‰ˆæœ¬å†²çªçš„é—®é¢˜                                                                      |
| atom-starter-cache           | ç¼“å­˜ç»„ä»¶ï¼Œ æä¾›åˆ†å¸ƒå¼é”ï¼Œ åˆ†å¸ƒå¼ç¼“å­˜ï¼Œ Redis è®¢é˜… / å‘å¸ƒæ¨¡å‹ï¼Œ äºŒçº§ç¼“å­˜ç­‰åŠŸèƒ½                                                                     |
| atom-starter-captcha         | éªŒè¯ç ç»„ä»¶ï¼Œ æä¾›æ™®é€šéªŒè¯ç ï¼Œ åŠ¨æ€éªŒè¯ç ï¼Œ å¹¶é…å¥—æä¾›éªŒè¯ç æ£€æŸ¥ç­‰æ¥å£                                                                             |
| atom-starter-doc             | æ–‡æ¡£ç”Ÿæˆç»„ä»¶ï¼Œ ä¸ºæ¥å£å±‚æœåŠ¡ï¼Œ ä¸­å°æœåŠ¡ï¼Œ RPC æœåŠ¡æä¾›æ¥å£æ–‡æ¡£ä¸€é”®ç”Ÿæˆï¼Œ å‡å°‘æ‰‹åŠ¨ç¼–å†™æ¥å£æ—¶é—´                                                      |
| atom-starter-email           | é‚®ä»¶ç»„ä»¶ï¼Œ æ”¯æŒå‘é€æ™®é€šé‚®ä»¶ï¼Œ å¯Œæ–‡æœ¬é‚®ä»¶ï¼Œ é™„ä»¶é‚®ä»¶                                                                                               |
| atom-starter-enhance-starter | å¢åŠ ç»„ä»¶ï¼Œ å°†ç›¸å…³çš„æŠ€æœ¯ç»„ä»¶åˆå¹¶ä¸ºä¸€ä¸ªå•ç‹¬çš„ä¾èµ–ï¼Œ å‡å°‘ä¸šåŠ¡ç«¯å¼•å…¥ä¾èµ–çš„æ•°é‡                                                                        |
| atom-starter-id              | åˆ†éƒ¨ç½² ID ç”Ÿæˆç»„ä»¶ï¼Œ èƒ½å¤Ÿé«˜æ•ˆçš„ç”Ÿæˆåˆ†å¸ƒå¼ IDï¼Œ æä¾›å¤šç§ ID ç”Ÿæˆç®—æ³•ï¼Œ æ»¡è¶³å¤šç§ä¸šåŠ¡åœºæ™¯                                                            |
| atom-starter-idempotent      | å¹‚ç­‰ç»„ä»¶ï¼Œ è§£å†³ä¸šåŠ¡ä¸Šå¸¸è§çš„æ¥å£è¯·æ±‚å¹‚ç­‰æ€§åˆ¤æ–­                                                                                                     |
| atom-starter-ip2region       | IP è½¬åœ°ç†ä½ç½®ç»„ä»¶ï¼Œ èƒ½åŠ›å¿«é€Ÿçš„é€šè¿‡ IP æŸ¥è¯¢å¯¹åº”çš„åœ°ç†é—®é¢˜ï¼Œ ä¸»è¦ç”¨äºå®‰å…¨æ£€æŸ¥                                                                       |
| atom-starter-launcher        | å¯åŠ¨ç»„ä»¶ï¼Œ ç®€åŒ–äº† Spring Boot çš„å¯åŠ¨ç±»å†™æ³•ï¼Œ å¹¶æä¾›é»˜è®¤é…ç½®çš„æ³¨å…¥ï¼Œ æ˜¯æ‰€æœ‰é¡¹ç›®çš„åŸºç¡€ä¾èµ–                                                          |
| atom-starter-logsystem       | æ—¥å¿—ç»„ä»¶ï¼Œ æä¾›å…¨å±€çš„æ—¥å¿—é…ç½®ï¼Œ å‡å°‘ä¸šåŠ¡ç«¯çš„é…ç½®æ–‡ä»¶æ•°é‡ï¼Œ å¹¶æä¾›å®¡è®¡æ—¥å¿—æ¥å£ï¼Œ å‡å°‘ä¸šåŠ¡ç«¯é‡å¤çš„å®¡è®¡æ—¥å¿—éœ€æ±‚å¼€å‘                                  |
| atom-starter-metrics         | æŒ‡æ ‡åº¦é‡ç»„ä»¶ï¼Œ ç”¨äºç›‘æ§æœåŠ¡çš„å„ç§æŒ‡æ ‡æ˜¯å¦æ­£å¸¸ï¼Œ ä¹Ÿå¯æ·»åŠ ä¸šåŠ¡æŒ‡æ ‡ï¼Œ ç”¨äºç»Ÿè®¡                                                                       |
| atom-starter-mq              | æ¶ˆæ¯ç»„ä»¶ï¼Œ æä¾› Kafkaï¼Œ RocketMQ çš„é›†æˆå¹¶æš´éœ²ç»Ÿä¸€çš„æ¥å£ï¼Œ ä¸šåŠ¡ç«¯å¯æ— æ„ŸçŸ¥ä½¿ç”¨                                                                      |
| atom-starter-mybatis-dynamic | æ•°æ®åº“æ“ä½œç»„ä»¶ï¼Œ å¯åœ¨ä¸é‡å¯æœåŠ¡çš„æƒ…å†µä¸‹åŠ¨æ€åˆ›å»ºæ•°æ®æº                                                                                             |
| atom-starter-mybatis-mutli   | æ•°æ®åº“æ“ä½œç»„ä»¶ï¼Œ æä¾›å¤šæ•°æ®æºæ”¯æŒ                                                                                                                 |
| atom-starter-mybatis         | æ•°æ®åº“æ“ä½œç»„ä»¶ï¼Œ å°è£…å¸¸ç”¨çš„ listï¼Œ pageï¼Œ æµå¼æŸ¥è¯¢ï¼Œ SQL æ…¢æŸ¥è¯¢ï¼Œ éæ³• SQL æ‹¦æˆªï¼Œ åˆ†é¡µç­‰å¸¸ç”¨åŠŸèƒ½                                                  |
| atom-starter-qrcode          | äºŒç»´ç ç»„ä»¶ï¼Œ æä¾›äºŒç»´ç ç”Ÿæˆæ¥å£ï¼Œ æ¯”å¯è‡ªå®šä¹‰äºŒç»´ç ç”Ÿæˆæ ·å¼                                                                                        |
| atom-starter-rest            | API å±‚æ¥å£ç»„ä»¶ï¼Œ æä¾›å¼‚å¸¸å…¨å±€å¤„ç†ï¼Œ ç»Ÿä¸€å“åº”çš„æ•°æ®ç»“æ„ï¼Œ å‚æ•°æ ¡éªŒï¼Œ å‚æ•°è½¬æ¢ï¼Œ XSS å®‰å…¨è¿‡æ»¤ç­‰å¸¸ç”¨åŠŸèƒ½                                             |
| atom-starter-retry           | é‡è¯•ç»„ä»¶ï¼Œ å¯é€šè¿‡é…ç½®åœ¨å‘ç”ŸæœåŠ¡è°ƒç”¨å¼‚å¸¸æ—¶è‡ªåŠ¨é‡è¯•åŠŸèƒ½                                                                                             |
| atom-starter-schedule        | åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç»„ä»¶ï¼Œ å¯é€šçŸ¥ä¸€ä¸ªç®€å•çš„ç»„ä»¶å£°æ˜ä»»åŠ¡ï¼Œ ç„¶åé€šè¿‡é…ç½®çš„æ–¹å¼è§¦å‘ä»»åŠ¡æ‰§è¡Œæ—¶é—´ï¼Œ å¹¶æä¾› web ç«¯ç®¡ç†æ‰€æœ‰çš„å®šæ—¶ä»»åŠ¡ï¼Œ å¯å®æ—¶ç›‘æ§ä»»åŠ¡æ‰§è¡Œæƒ…å†µ |
| atom-starter-security        | å®‰å…¨ç»„ä»¶ï¼Œ æä¾›æ¥å£æƒé™æ£€éªŒï¼Œ æ•°æ®æƒé™æ ¡éªŒï¼Œ åŠ¨æ€åŠ è½½å®‰å…¨æ ¡éªŒè§„åˆ™ç­‰åŠŸèƒ½                                                                           |
| atom-starter-sms             | çŸ­ä¿¡ç»„ä»¶ï¼Œ é›†æˆäº†é˜¿é‡Œäº‘ï¼Œ è…¾è®¯äº‘å’Œäº¿ç¾ç­‰çŸ­ä¿¡æœåŠ¡å•†æ¥å£ï¼Œ å‡å°‘ä¸šåŠ¡ç«¯é›†æˆé€»è¾‘ï¼Œ ä¸€é”®å‘é€çŸ­ä¿¡                                                        |
| atom-starter-template        | starter æŠ€æœ¯ç»„ä»¶æ¨¡æ¿ï¼Œ è§„èŒƒä¸ç®€åŒ–æŠ€æœ¯ç»„ä»¶çš„ç¼–ç æ–¹å¼ï¼Œ ä¸šåŠ¡ç«¯å¯ä½¿ç”¨æ­¤æ¨¡æ¿ç¼–å†™ä¸šåŠ¡ä¸Šçš„ç»„ä»¶å¹¶å®ç°å¤ç”¨                                                |

## 3. å¼€å‘è®¡åˆ’

æ•´ä½“çš„å¼€å‘è®¡åˆ’åˆ†ä¸º 4 ä¸ªå­£åº¦, Q1 ä¸»è¦ç›®æ ‡æ˜¯æ ¹æ® **é…ç”µç›‘æµ‹** éœ€è¦ä½¿ç”¨çš„æŠ€æœ¯æ ˆè¿›è¡Œå¼€å‘, ä¸»è¦æ¶‰åŠåˆ° Launcher, Logsystem, REST, Mybatis 4 ä¸ª starter ç»„ä»¶.

ä¸ºäº†ä¿è¯ä»¥ä¸Š 4 ä¸ªç»„ä»¶çš„æ­£å¸¸ä½¿ç”¨, è¿˜å¿…é¡»å®Œæˆ builder å’Œ center å±‚çš„å¼€å‘.

![20241229154732_e9dOoXni.webp](https://cdn.dong4j.site/source/image/20241229154732_e9dOoXni.webp)

## 4. ä»£ç è§„èŒƒ

ä»£ç è§„èŒƒçš„æ„ä¹‰åœ¨äºæé«˜ä»£ç çš„ä¸¥è°¨æ€§ï¼Œå‡å°‘ bug çš„äº§ç”Ÿ; ä¿ƒè¿›å›¢é˜Ÿä¹‹é—´çš„åˆä½œï¼Œäº¤æµæ–¹ä¾¿; é™ä½ç»´æŠ¤æˆæœ¬; æœ‰åŠ©äºä»£ç å®¡æŸ¥; æé«˜ä»£ç çš„è§„èŒƒæ€§ï¼Œæœ‰åˆ©äºæé«˜ç¨‹åºå‘˜çš„è‡ªæˆ‘æˆé•¿.

å› æ­¤åˆ¶å®šä¸€ä¸ªç¬¦åˆè‡ªå·±å…¬å¸æƒ…å†µçš„å¼€å‘è§„èŒƒï¼Œè®¤è¯†åˆ°ä»£ç è§„èŒƒçš„é‡è¦æ€§ï¼ŒåšæŒè§„èŒƒçš„å¼€å‘ä¹ æƒ¯ã€‚

è¿™éƒ¨åˆ†ä¼šåœ¨ Q2 å¯åŠ¨.

## 5. å…¶ä»–

### 5.1 æŠ€æœ¯æ–‡æ¡£

åŸºç¡€æ¡†æ¶ä¸ä»…ä»…åªæ˜¯äº¤ä»˜å¯ç”¨çš„ä»£ç , å¿…é¡»é…å¥—äº¤ä»˜ç»“æ„æ¸…æ™°, è¯­ä¹‰æ˜ç¡®çš„æŠ€æœ¯æ–‡æ¡£, ä¸€æ–¹é¢æ˜¯è®©å›¢é˜Ÿå¿«é€Ÿä¸Šæ‰‹å¼€å‘, å¦ä¸€æ–¹é¢æ˜¯ä½œä¸ºå›¢é˜Ÿçš„æŠ€æœ¯æ²‰æ·€, å› æ­¤ä¼šä½¿ç”¨ [å¼€æºå·¥å…·](https://vuepress-theme-hope.github.io/v2/zh/) æ„å»ºå›¢é˜Ÿçš„ wiki çŸ¥è¯†åº“, æä¾›æå‡å›¢é˜Ÿçš„æŠ€æœ¯å®åŠ›.

## [ä»é€šç”¨åˆ°å‚ç›´ï¼šä¼ä¸šçŸ¥è¯†åº“çš„AIèµ‹èƒ½](https://blog.dong4j.site/posts/f3b0024e.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

![AI-åº”ç”¨.drawio.svg](https://cdn.dong4j.site/source/image/AI-%E5%BA%94%E7%94%A8.drawio.svg)

![dify.drawio.svg](https://cdn.dong4j.site/source/image/dify.drawio.svg)

è¶Šæ¥è¶Šå¤šçš„ä¼ä¸šå’Œä¸ªäººå¸Œæœ›èƒ½å¤Ÿåˆ©ç”¨ LLM å’Œç”Ÿæˆå¼äººå·¥æ™ºèƒ½æ¥æ„å»ºä¸“æ³¨äºå…¶ç‰¹å®šé¢†åŸŸçš„å…·å¤‡ AI èƒ½åŠ›çš„äº§å“ã€‚ç›®å‰ï¼Œå¤§è¯­è¨€æ¨¡å‹åœ¨å¤„ç†é€šç”¨é—®é¢˜æ–¹é¢è¡¨ç°è¾ƒå¥½ï¼Œä½†ç”±äºè®­ç»ƒè¯­æ–™å’Œå¤§æ¨¡å‹çš„ç”Ÿæˆé™åˆ¶ï¼Œå¯¹äºå‚ç›´ä¸“ä¸šé¢†åŸŸï¼Œåˆ™ä¼šå­˜åœ¨çŸ¥è¯†æ·±åº¦å’Œæ—¶æ•ˆæ€§ä¸è¶³çš„é—®é¢˜ã€‚åœ¨ä¿¡æ¯æ—¶ä»£ï¼Œç”±äºä¼ä¸šçš„çŸ¥è¯†åº“æ›´æ–°é¢‘ç‡è¶Šæ¥è¶Šé«˜ï¼Œå¹¶ä¸”ä¼ä¸šæ‰€æ‹¥æœ‰çš„å‚ç›´é¢†åŸŸçŸ¥è¯†åº“ï¼ˆä¾‹å¦‚æ–‡æ¡£ã€å›¾åƒã€éŸ³è§†é¢‘ç­‰ï¼‰å¾€å¾€æ˜¯æœªå…¬å¼€æˆ–ä¸å¯å…¬å¼€çš„ã€‚å› æ­¤ï¼Œå¯¹äºä¼ä¸šè€Œè¨€ï¼Œå¦‚æœæƒ³åœ¨å¤§è¯­è¨€æ¨¡å‹çš„åŸºç¡€ä¸Šæ„å»ºå±äºç‰¹å®šå‚ç›´é¢†åŸŸçš„ AI äº§å“ï¼Œå°±éœ€è¦ä¸æ–­å°†è‡ªèº«çš„çŸ¥è¯†åº“è¾“å…¥åˆ°å¤§è¯­è¨€æ¨¡å‹ä¸­è¿›è¡Œè®­ç»ƒã€‚

ç›®å‰æœ‰ä¸¤ç§å¸¸è§çš„æ–¹æ³•å®ç°ï¼š

- å¾®è°ƒï¼ˆFine-tuningï¼‰ï¼šé€šè¿‡æä¾›æ–°çš„æ•°æ®é›†å¯¹å·²æœ‰æ¨¡å‹çš„æƒé‡è¿›è¡Œå¾®è°ƒï¼Œä¸æ–­æ›´æ–°è¾“å…¥ä»¥è°ƒæ•´è¾“å‡ºï¼Œä»¥è¾¾åˆ°æ‰€éœ€çš„ç»“æœã€‚è¿™é€‚ç”¨äºæ•°æ®é›†è§„æ¨¡ä¸å¤§æˆ–é’ˆå¯¹ç‰¹å®šç±»å‹ä»»åŠ¡æˆ–é£æ ¼è¿›è¡Œè®­ç»ƒï¼Œä½†è®­ç»ƒæˆæœ¬å’Œä»·æ ¼è¾ƒé«˜ã€‚
- æç¤ºè°ƒæ•´ï¼ˆPrompt-tuningï¼‰ï¼šé€šè¿‡è°ƒæ•´è¾“å…¥æç¤ºè€Œéä¿®æ”¹æ¨¡å‹æƒé‡ï¼Œä»è€Œå®ç°è°ƒæ•´è¾“å‡ºçš„ç›®çš„ã€‚ç›¸è¾ƒäºå¾®è°ƒï¼Œæç¤ºè°ƒæ•´å…·æœ‰è¾ƒä½çš„è®¡ç®—æˆæœ¬ï¼Œéœ€è¦çš„èµ„æºå’Œè®­ç»ƒæ—¶é—´ä¹Ÿè¾ƒå°‘ï¼ŒåŒæ—¶æ›´åŠ çµæ´»ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œå¾®è°ƒçš„æ–¹æ¡ˆæŠ•å…¥æˆæœ¬è¾ƒé«˜ï¼Œæ›´æ–°é¢‘ç‡è¾ƒä½ï¼Œå¹¶ä¸é€‚åˆæ‰€æœ‰ä¼ä¸šã€‚æç¤ºè°ƒæ•´çš„æ–¹æ¡ˆæ˜¯åœ¨å‘é‡åº“ä¸­æ„å»ºä¼ä¸šçš„çŸ¥è¯†èµ„äº§ï¼Œé€šè¿‡ LLM+ å‘é‡åº“æ„å»ºå‚ç›´é¢†åŸŸçš„æ·±åº¦æœåŠ¡ã€‚æœ¬è´¨æ˜¯åˆ©ç”¨æ•°æ®åº“è¿›è¡Œæç¤ºå·¥ç¨‹ï¼ˆPrompt Engineeringï¼‰å°†ä¼ä¸šçŸ¥è¯†åº“æ–‡æ¡£å’Œå®æ—¶ä¿¡æ¯é€šè¿‡å‘é‡ç‰¹å¾æå–ç„¶åå­˜å‚¨åˆ°å‘é‡æ•°æ®åº“ï¼Œç»“åˆ LLM å¯ä»¥è®© Chatbot çš„å›ç­”æ›´å…·ä¸“ä¸šæ€§å’Œæ—¶æ•ˆæ€§ï¼Œä¹Ÿæ›´é€‚åˆä¸­å°å‹ä¼ä¸šæ„å»ºä¼ä¸šä¸“å± Chatbotã€‚

åœ¨æœºå™¨å­¦ä¹ é¢†åŸŸï¼Œä¸ºäº†èƒ½å¤Ÿå¤„ç†å¤§é‡çš„éç»“æ„åŒ–çš„æ•°æ®ï¼Œé€šå¸¸ä¼šä½¿ç”¨äººå·¥æ™ºèƒ½æŠ€æœ¯æå–è¿™äº›éç»“æ„åŒ–æ•°æ®çš„ç‰¹å¾ï¼Œå¹¶å°†å…¶è½¬åŒ–ä¸ºç‰¹å¾å‘é‡ï¼Œå†å¯¹è¿™äº›ç‰¹å¾å‘é‡è¿›è¡Œåˆ†æå’Œæ£€ç´¢ä»¥å®ç°å¯¹éç»“æ„åŒ–æ•°æ®çš„å¤„ç†ã€‚å°†è¿™ç§èƒ½å­˜å‚¨ã€åˆ†æå’Œæ£€ç´¢ç‰¹å¾å‘é‡çš„æ•°æ®åº“ç§°ä¹‹ä¸ºå‘é‡æ•°æ®åº“ã€‚

## æŠ€æœ¯é€‰å‹

### éœ€æ±‚æè¿°

æ‰“é€  **ç‰¹å®šé¢†åŸŸçŸ¥è¯† (Domain-specific Knowledge)** **é—®ç­”** ç³»ç»Ÿï¼Œå…·ä½“éœ€æ±‚æœ‰ï¼š

- é€šè¿‡è‡ªç„¶è¯­è¨€é—®ç­”çš„å½¢å¼ï¼Œå’Œç”¨æˆ·äº¤äº’ï¼ŒåŒæ—¶æ”¯æŒä¸­æ–‡å’Œè‹±æ–‡ã€‚
- ç†è§£ç”¨æˆ·ä¸åŒå½¢å¼çš„é—®é¢˜ï¼Œæ‰¾åˆ°ä¸ä¹‹åŒ¹é…çš„ç­”æ¡ˆã€‚å¯ä»¥å¯¹ç­”æ¡ˆè¿›è¡ŒäºŒæ¬¡å¤„ç†ï¼Œæ¯”å¦‚å°†å…³è”çš„å¤šä¸ªçŸ¥è¯†ç‚¹è¿›è¡Œå»é‡ã€æ±‡æ€»ç­‰ã€‚
- æ”¯æŒä¸Šä¸‹æ–‡ã€‚æœ‰äº›é—®é¢˜å¯èƒ½æ¯”è¾ƒå¤æ‚ï¼Œæˆ–è€…åŸå§‹çŸ¥è¯†ä¸èƒ½è¦†ç›–ï¼Œéœ€è¦ä»å†å²ä¼šè¯ä¸­æå–ä¿¡æ¯ã€‚
- å‡†ç¡®ã€‚ä¸è¦å‡ºç°ä¼¼æ˜¯è€Œéæˆ–æ— æ„ä¹‰çš„å›ç­”ã€‚

---

### æ•´ä½“æ–¹æ¡ˆ

ä½¿ç”¨ LLM ä½œä¸ºç”¨æˆ·å’Œæœç´¢ç³»ç»Ÿä»¶æ²Ÿé€šçš„ä»‹è´¨ï¼Œå‘æŒ¥å…¶å¼ºå¤§çš„ [è‡ªç„¶è¯­è¨€å¤„ç†](https://cloud.tencent.com/product/nlp?from_column=20065&from=20065) èƒ½åŠ›ï¼šå¯¹ç”¨æˆ·è¯·æ±‚è¿›è¡Œçº é”™ã€æå–å…³é”®ç‚¹ç­‰é¢„å¤„ç†å®ç° â€œç†è§£â€ï¼›å¯¹è¾“å‡ºç»“æœåœ¨ä¿è¯æ­£ç¡®æ€§çš„åŸºç¡€ä¸ŠäºŒæ¬¡åŠ å·¥ï¼Œæ¯”å¦‚â€”â€”æ¦‚æ‹¬ã€åˆ†æã€æ¨ç†ç­‰ã€‚

æ•´ä¸ªæ–¹æ¡ˆè®¾è®¡å¦‚ä¸‹å›¾æ‰€ç¤ºç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š

![20241229144920_ZXCsfntf.webp](https://cdn.dong4j.site/source/image/20241229144920_ZXCsfntf.webp)

è¯´æ˜å¦‚ä¸‹ï¼š

1. ä½¿ç”¨ OpenAI çš„ Embedding æ¥å£å°†ä¸“ä¸šé¢†åŸŸçŸ¥è¯†è½¬åŒ–ä¸ºå‘é‡ï¼Œè¿åŒåŸå§‹ææ–™ä¸€å¹¶ä¿å­˜åœ¨ Redis ä¸­ã€‚
2. ç”¨æˆ·æé—®çš„æœç´¢å¤„ç†ï¼š
3. ä½¿ç”¨ OpenAI API å¯¹ç”¨æˆ·çš„é—®é¢˜è¿›è¡Œ Embeddingï¼Œè·å¾—å‘é‡ã€‚
4. ä½¿ç”¨é—®é¢˜å‘é‡åœ¨ Redis ä¸­æœç´¢ï¼Œæ‰¾åˆ°ä¸ä¹‹æœ€åŒ¹é…çš„è‹¥å¹²è®°å½•ã€‚å°†è¿™äº›è®°å½•çš„åŸå§‹ææ–™è¿”å›ã€‚
5. ä½¿ç”¨ **OpenAI** çš„ Completion API å¯¹è¿™äº›åŸå§‹ææ–™è¿›è¡ŒåŠ å·¥å®Œå–„ï¼Œå¹¶å°†æœ€ç»ˆç»“æœè¿”å›ã€‚

å…·ä½“çš„åšæ³•æ˜¯å°†çŸ¥è¯†åº“çš„å†…å®¹é€šè¿‡æŸäº›æ ¼å¼ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œç„¶åæ¯æ¬¡æé—®çš„æ—¶å€™ï¼Œå…ˆå–æ•°æ®åº“æ£€ç´¢ç›¸å…³çš„å†…å®¹ï¼Œç„¶åå°†å†…å®¹å’Œé—®é¢˜æŒ‰ç…§ç±»ä¼¼ä¸Šé¢çš„ prompt æäº¤ç»™ ChatGPTï¼Œç»è¿‡ ChatGPT æ¥ç”Ÿæˆé«˜è´¨é‡çš„å›ç­”ã€‚è€Œè¿™ä¸ªä¿å­˜äº†ä¹¦å†…å®¹çš„æ•°æ®åº“å°±æ˜¯**å¤–æŒ‚çŸ¥è¯†åº“**ã€‚

å…¶ä¸­ä¿å­˜åˆ°æ•°æ®åº“çš„è¿‡ç¨‹æ˜¯å¯¹åŸæ–‡æœ¬è¿›è¡Œ Tokenizerï¼ˆåˆ†è¯ï¼‰ + Embeddingï¼ˆå‘é‡åŒ–ï¼‰ï¼Œæ•°æ®åº“åˆ™ç§°ä¸º Vector Store ï¼ˆå‘é‡æ•°æ®åº“ï¼‰

**æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹ï¼š**

![20241229144920_SnCXbO1D.webp](https://cdn.dong4j.site/source/image/20241229144920_SnCXbO1D.webp)

åè¯è§£é‡Šï¼š

- åˆ†è¯ï¼ˆTokenizerï¼‰ï¼š å°†æ–‡æœ¬æ‹†åˆ†æˆå•ä¸ªå•è¯æˆ–è¯è¯­ï¼Œç»“æ„åŒ–ä¸ºè®¡ç®—æœºå¯ä»¥å¤„ç†çš„ç»“æ„åŒ–å½¢å¼ï¼Œï¼Œæ¯”å¦‚ æˆ‘æ¯å¤©å…­ç‚¹ä¸‹ç­ å¯ä»¥æ‹†åˆ†ä¸º â€œæˆ‘â€ï¼Œâ€œæ¯å¤©â€ï¼Œâ€œå…­ç‚¹ä¸‹ç­â€ï¼Œå¸¸è§çš„åˆ†è¯å™¨æœ‰ markdown åˆ†è¯å™¨ [MarkdownTextSplitter](https://www.langchain.com.cn/modules/indexes/text_splitters/examples/markdown)
- å‘é‡åŒ–ï¼ˆEmbeddingï¼‰ï¼šå°†æ–‡æœ¬æ•°æ®è½¬æ¢ä¸ºå‘é‡çš„è¿‡ç¨‹ã€‚è®¡ç®—æœºæ— æ³•ç›´æ¥å¤„ç†æ–‡æœ¬ï¼Œå› æ­¤éœ€è¦å°†æ–‡æœ¬è½¬æ¢ä¸ºæ•°å­¦å‘é‡å½¢å¼ï¼Œä»¥ä¾¿ç®—æ³•èƒ½å¤Ÿç†è§£å’Œå¤„ç†ã€‚æ–‡æœ¬å’Œæ•°å­¦å‘é‡ä¹‹é—´äº’ç›¸æ˜ å°„ï¼Œä½†æ•°å­¦å‘é‡æ›´ä¾¿äºè®¡ç®—æœºè¿ç®—ã€‚å¯¹ä¸­æ–‡æ¯”è¾ƒå‹å¥½çš„å‘é‡æ¨¡å‹åº“æœ‰ [shibing624/text2vec-base-chinese](https://github.com/shibing624/text2vec)
- å‘é‡æ•°æ®åº“ï¼ˆVector Storeï¼‰: å­˜å‚¨å’Œç®¡ç†å‘é‡åŒ–åçš„æ–‡æœ¬æ•°æ®çš„æ•°æ®åº“ï¼Œèƒ½å¿«é€Ÿæ£€ç´¢ç›¸ä¼¼æ–‡æœ¬æˆ–è¿›è¡Œæ–‡æœ¬ç›¸ä¼¼æ€§æ¯”è¾ƒã€‚ æ¯”å¦‚ [FAISS](https://github.com/facebookresearch/faiss) è¿™ä¸ªåº“

---

### LLM

[Awesome Chinese LLM](https://github.com/HqWu-HITCS/Awesome-Chinese-LLM)

åœ¨ä¸Šè¿°æ–¹æ¡ˆä¸­, æ¨èé€‰æ‹©å…·æœ‰ OpenAI API çš„ LLM, åæœŸå¯ä»¥æ— æ„ŸçŸ¥çš„å‡çº§åº•å±‚çš„ LLM. å¸¸è§çš„å¼€æºçš„ LLM æœ‰ä»¥ä¸‹å‡ ç§:

#### ChatGLM3

<https://github.com/THUDM/ChatGLM3>

ChatGLM3-6B æ˜¯ ChatGLM3 ç³»åˆ—ä¸­çš„å¼€æºæ¨¡å‹ï¼Œåœ¨ä¿ç•™äº†å‰ä¸¤ä»£æ¨¡å‹å¯¹è¯æµç•…ã€éƒ¨ç½²é—¨æ§›ä½ç­‰ä¼—å¤šä¼˜ç§€ç‰¹æ€§çš„åŸºç¡€ä¸Šï¼ŒChatGLM3-6B å¼•å…¥äº†å¦‚ä¸‹ç‰¹æ€§ï¼šæ›´å¼ºå¤§çš„åŸºç¡€æ¨¡å‹ï¼š ChatGLM3-6B çš„åŸºç¡€æ¨¡å‹ ChatGLM3-6B-Base é‡‡ç”¨äº†æ›´å¤šæ ·çš„è®­ç»ƒæ•°æ®ã€æ›´å……åˆ†çš„è®­ç»ƒæ­¥æ•°å’Œæ›´åˆç†çš„è®­ç»ƒç­–ç•¥ï¼›æ›´å®Œæ•´çš„åŠŸèƒ½æ”¯æŒï¼š ChatGLM3-6B é‡‡ç”¨äº†å…¨æ–°è®¾è®¡çš„ Prompt æ ¼å¼ï¼Œé™¤æ­£å¸¸çš„å¤šè½®å¯¹è¯å¤–ã€‚åŒæ—¶åŸç”Ÿæ”¯æŒå·¥å…·è°ƒç”¨ï¼ˆFunction Callï¼‰ã€ä»£ç æ‰§è¡Œï¼ˆCode Interpreterï¼‰å’Œ Agent ä»»åŠ¡ç­‰å¤æ‚åœºæ™¯ï¼›æ›´å…¨é¢çš„å¼€æºåºåˆ—ï¼š é™¤äº†å¯¹è¯æ¨¡å‹ ChatGLM3-6B å¤–ï¼Œè¿˜å¼€æºäº†åŸºç¡€æ¨¡å‹ ChatGLM3-6B-Baseã€é•¿æ–‡æœ¬å¯¹è¯æ¨¡å‹ ChatGLM3-6B-32Kã€‚ä»¥ä¸Šæ‰€æœ‰æƒé‡å¯¹å­¦æœ¯ç ”ç©¶å®Œå…¨å¼€æ”¾ï¼Œåœ¨å¡«å†™é—®å·è¿›è¡Œç™»è®°åäº¦å…è®¸å…è´¹å•†ä¸šä½¿ç”¨ã€‚

#### LLaMA2

<https://github.com/michael-wzhu/Chinese-LlaMA2>

è¯¥é¡¹ç›®åŸºäºå¯å•†ç”¨çš„ LLaMA-2 è¿›è¡ŒäºŒæ¬¡å¼€å‘å†³å®šåœ¨æ¬¡å¼€å±• Llama 2 çš„ä¸­æ–‡æ±‰åŒ–å·¥ä½œï¼ŒåŒ…æ‹¬ Chinese-LlaMA2: å¯¹ Llama 2 è¿›è¡Œä¸­æ–‡é¢„è®­ç»ƒï¼›ç¬¬ä¸€æ­¥ï¼šå…ˆåœ¨ 42G ä¸­æ–‡é¢„æ–™ä¸Šè¿›è¡Œè®­ç»ƒï¼›åç»­å°†ä¼šåŠ å¤§è®­ç»ƒè§„æ¨¡ï¼›Chinese-LlaMA2-chat: å¯¹ Chinese-LlaMA2 è¿›è¡ŒæŒ‡ä»¤å¾®è°ƒå’Œå¤šè½®å¯¹è¯å¾®è°ƒï¼Œä»¥é€‚åº”å„ç§åº”ç”¨åœºæ™¯å’Œå¤šè½®å¯¹è¯äº¤äº’ã€‚åŒæ—¶æˆ‘ä»¬ä¹Ÿè€ƒè™‘æ›´ä¸ºå¿«é€Ÿçš„ä¸­æ–‡é€‚é…æ–¹æ¡ˆï¼šChinese-LlaMA2-sft-v0: é‡‡ç”¨ç°æœ‰çš„å¼€æºä¸­æ–‡æŒ‡ä»¤å¾®è°ƒæˆ–è€…æ˜¯å¯¹è¯æ•°æ®ï¼Œå¯¹ LlaMA-2 è¿›è¡Œç›´æ¥å¾®è°ƒ (å°†äºè¿‘æœŸå¼€æº)ã€‚

#### Baichuan

<https://github.com/baichuan-inc/Baichuan2>

ç”±ç™¾å·æ™ºèƒ½å¼€å‘çš„ä¸€ä¸ªå¼€æºå¯å•†ç”¨çš„å¤§è§„æ¨¡é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹ã€‚åŸºäº Transformer ç»“æ„ï¼Œåœ¨å¤§çº¦ 1.2 ä¸‡äº¿ tokens ä¸Šè®­ç»ƒçš„ 70 äº¿å‚æ•°æ¨¡å‹ï¼Œæ”¯æŒä¸­è‹±åŒè¯­ï¼Œä¸Šä¸‹æ–‡çª—å£é•¿åº¦ä¸º 4096ã€‚åœ¨æ ‡å‡†çš„ä¸­æ–‡å’Œè‹±æ–‡æƒå¨ benchmarkï¼ˆC-EVAL/MMLUï¼‰ä¸Šå‡å–å¾—åŒå°ºå¯¸æœ€å¥½çš„æ•ˆæœã€‚

#### Qwen

<https://github.com/QwenLM/Qwen>

é€šä¹‰åƒé—® æ˜¯é˜¿é‡Œäº‘ç ”å‘çš„é€šä¹‰åƒé—®å¤§æ¨¡å‹ç³»åˆ—æ¨¡å‹ï¼ŒåŒ…æ‹¬å‚æ•°è§„æ¨¡ä¸º 18 äº¿ï¼ˆ1.8Bï¼‰ã€70 äº¿ï¼ˆ7Bï¼‰ã€140 äº¿ï¼ˆ14Bï¼‰å’Œ 720 äº¿ï¼ˆ72Bï¼‰ã€‚å„ä¸ªè§„æ¨¡çš„æ¨¡å‹åŒ…æ‹¬åŸºç¡€æ¨¡å‹ Qwenï¼Œå³ Qwen-1.8Bã€Qwen-7Bã€Qwen-14Bã€Qwen-72Bï¼Œä»¥åŠå¯¹è¯æ¨¡å‹ Qwen-Chatï¼Œå³ Qwen-1.8B-Chatã€Qwen-7B-Chatã€Qwen-14B-Chat å’Œ Qwen-72B-Chatã€‚æ•°æ®é›†åŒ…æ‹¬æ–‡æœ¬å’Œä»£ç ç­‰å¤šç§æ•°æ®ç±»å‹ï¼Œè¦†ç›–é€šç”¨é¢†åŸŸå’Œä¸“ä¸šé¢†åŸŸï¼Œèƒ½æ”¯æŒ 8K çš„ä¸Šä¸‹æ–‡é•¿åº¦ï¼Œé’ˆå¯¹æ’ä»¶è°ƒç”¨ç›¸å…³çš„å¯¹é½æ•°æ®åšäº†ç‰¹å®šä¼˜åŒ–ï¼Œå½“å‰æ¨¡å‹èƒ½æœ‰æ•ˆè°ƒç”¨æ’ä»¶ä»¥åŠå‡çº§ä¸º Agentã€‚

#### Mixtral

<https://github.com/HIT-SCIR/Chinese-Mixtral-8x7B>

è¯¥é¡¹ç›®åŸºäº Mixtral-8x7B ç¨€ç–æ··åˆä¸“å®¶æ¨¡å‹è¿›è¡Œäº†ä¸­æ–‡æ‰©è¯è¡¨å¢é‡é¢„è®­ç»ƒï¼Œå¼€æºäº† Chinese-Mixtral-8x7B æ‰©è¯è¡¨æ¨¡å‹ä»¥åŠè®­ç»ƒä»£ç ã€‚è¯¥æ¨¡å‹çš„çš„ä¸­æ–‡ç¼–è§£ç æ•ˆç‡è¾ƒåŸæ¨¡å‹æ˜¾è‘—æé«˜ã€‚åŒæ—¶é€šè¿‡åœ¨å¤§è§„æ¨¡å¼€æºè¯­æ–™ä¸Šè¿›è¡Œçš„å¢é‡é¢„è®­ç»ƒï¼Œè¯¥æ¨¡å‹å…·å¤‡äº†å¼ºå¤§çš„ä¸­æ–‡ç”Ÿæˆå’Œç†è§£èƒ½åŠ›

---

### å‘é‡æ¨¡å‹

å‘é‡æ¨¡å‹å¯ä»¥å°†ä»»æ„æ–‡æœ¬æ˜ å°„ä¸ºä½ç»´ç¨ å¯†å‘é‡ï¼Œä»¥ç”¨äºæ£€ç´¢ã€åˆ†ç±»ã€èšç±»æˆ–è¯­ä¹‰åŒ¹é…ç­‰ä»»åŠ¡ï¼Œå¹¶å¯æ”¯æŒä¸ºå¤§æ¨¡å‹è°ƒç”¨å¤–éƒ¨çŸ¥è¯†ã€‚

ç®€å•è€Œè¨€å°±ç›¸å½“äºä¸€ä¸ªâ€œæ¡¥æ¢â€ â€”â€” ç¿»è¯‘ï¼šæŠŠå›¾ç‰‡ï¼Œæ–‡å­—ï¼Œè§†é¢‘ä»¥åŠéŸ³é¢‘å…¨éƒ¨è½¬æ¢ä¸ºæ•°å­—ï¼Œå¹¶ä¸”åŒ…å«äº†æ•°æ®çš„ä¿¡æ¯ï¼Œä½¿å¾—å¤§æ¨¡å‹éƒ½èƒ½â€æ‡‚â€œï¼Œèƒ½åˆ©ç”¨è¿™äº›æ•°å­—å»åšè®­ç»ƒå’Œæ¨ç†.

embedding æ¨¡å‹çš„åº”ç”¨ä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ç‚¹:

- embedding æ¨¡å‹å¯ä»¥å°†å„ç§æ•°æ®ï¼ˆè¯­è¨€ã€å›¾ç‰‡ç­‰ï¼‰è½¬åŒ–ä¸ºå‘é‡ï¼Œå¹¶ä½¿ç”¨å‘é‡ä¹‹é—´çš„è·ç¦»æ¥è¡¡é‡æ•°æ®çš„ç›¸å…³æ€§ã€‚
- åœ¨å¤§æ¨¡å‹æ—¶ä»£ï¼Œè¿™ç§æŠ€æœ¯æœ‰åŠ©äºè§£å†³å¤§æ¨¡å‹åœ¨å›ç­”é—®é¢˜æ—¶å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼Œå¯ä»¥å¸®åŠ©å¤§æ¨¡å‹è·å–æœ€æ–°çš„çŸ¥è¯†ã€‚
- OpenAIã€Googleã€Meta ç­‰å¤§å‚ä¹Ÿéƒ½æ¨å‡ºäº†è‡ªå·±çš„è¯­ä¹‰å‘é‡æ¨¡å‹å’Œ API æœåŠ¡ï¼Œå‚¬ç”Ÿäº†å¤§é‡çš„åº”ç”¨å’Œå·¥å…·ï¼Œå¦‚ LangChainã€Pinecone ç­‰

å„æ¨¡å‹å¯¹åº”çš„åœ°å€å¦‚ä¸‹:

text2vec-base-chinese: [https://huggingface.co/shibing624/text2vec-base-chinese](https://link.zhihu.com/?target=https%3A//huggingface.co/shibing624/text2vec-base-chinese)

text2vec-bge-large-chinese: [https://huggingface.co/shibing624/text2vec-bge-large-chinese](https://link.zhihu.com/?target=https%3A//huggingface.co/shibing624/text2vec-bge-large-chinese)

M3E: <https://github.com/wangyuxinwhy/uniem>

BGE: <https://github.com/FlagOpen/FlagEmbedding/blob/master/README_zh.md>

OpenAi: [https://platform.openai.com/docs/api-reference/embeddings](https://link.zhihu.com/?target=https%3A//platform.openai.com/docs/api-reference/embeddings)

åƒå¸†å¤§æ¨¡å‹: [https://cloud.baidu.com/doc/WEN](https://link.zhihu.com/?target=https%3A//cloud.baidu.com/doc/WENXINWORKSHOP/s/alj562vvu)

---

### å‘é‡æ•°æ®åº“

å› ä¸ºå–‚ç»™ Transformer çš„çŸ¥è¯†é¦–å…ˆéœ€è¦åš embeddingï¼Œæ‰€ä»¥ç”¨äºå­˜å‚¨ embedding ä¹‹åæ•°æ®çš„æ•°æ®åº“å³å¯ç§°ä¸ºå‘é‡æ•°æ®åº“ã€‚

å› ä¸ºå‘é‡æ•°æ®åº“æ˜¯åŸºäº embedding ä¹‹åçš„å‘é‡çš„å­˜å‚¨ä¸æ£€ç´¢ã€‚æ‰€ä»¥é¦–å…ˆéœ€è¦æä¾›å­˜å‚¨èƒ½åŠ›ï¼Œå…¶æ¬¡æ›´é‡è¦çš„æ˜¯æ£€ç´¢ã€‚ å³å¦‚ä½•æ ¹æ®ä¸€ä¸ª query å¿«é€Ÿæ‰¾åˆ°ç›¸å…³çš„ embedding å†…å®¹ã€‚ å…³äºæ£€ç´¢ï¼Œä¸»è¦æ˜¯è®¡ç®—ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„ç›¸ä¼¼åº¦ã€‚

[å‘é‡æ•°æ®åº“ï½œä¸€æ–‡å…¨é¢äº†è§£å‘é‡æ•°æ®åº“çš„åŸºæœ¬æ¦‚å¿µã€åŸç†ã€ç®—æ³•ã€é€‰å‹](https://cloud.tencent.com/developer/article/2312534)

[ä¸»æµå‘é‡æ•°æ®åº“ä¸€è§ˆ](https://zhuanlan.zhihu.com/p/628148081)

#### Weaviate

Weaviate æ˜¯ä¸€ä¸ªå¼€æºçŸ¢é‡æ•°æ®åº“ï¼Œå®ƒåŒæ—¶å­˜å‚¨å¯¹è±¡å’ŒçŸ¢é‡ï¼Œå…è®¸å°†çŸ¢é‡æœç´¢ä¸ç»“æ„åŒ–è¿‡æ»¤ä¸äº‘åŸç”Ÿæ•°æ®åº“çš„å®¹é”™å’Œå¯æ‰©å±•æ€§ç›¸ç»“åˆï¼Œæ‰€æœ‰è¿™äº›éƒ½å¯ä»¥é€šè¿‡ GraphQLã€REST å’Œå„ç§è¯­è¨€å®¢æˆ·ç«¯è®¿é—®ã€‚

#### Milvus

<https://www.milvus-io.com/overview>

#### Pinecone

<https://www.pinecone-io.com/>

#### pgvector

<https://github.com/pgvector/pgvector>

pgvector æ˜¯ PostgreSQL çš„ä¸€ä¸ª**å‘é‡æœç´¢æ‰©å±•**,å®ƒå¯ä»¥åœ¨ PostgreSQL æ•°æ®åº“ä¸­è¿›è¡Œé«˜æ•ˆçš„å‘é‡ç›¸ä¼¼åº¦æœç´¢ã€‚è¿™ç§æ¶æ„èƒ½å¤Ÿå®ç°**åŠŸèƒ½å¼ºå¤§ä¸”æ™ºèƒ½**çš„çŸ¥è¯†åº“é—®ç­”æœåŠ¡,å¹¶ä¸”å…·æœ‰è¾ƒé«˜çš„æ€§èƒ½ã€å¯é æ€§å’Œå¯æ‰©å±•æ€§,æ˜¯æ„å»ºçŸ¥è¯†åº“å‹ AI ç³»ç»Ÿçš„ä¸€ä¸ªéå¸¸å¥½çš„é€‰æ‹©ã€‚

---

### æ–¹æ¡ˆé€‰æ‹©

ç›®å‰å·²ç»æœ‰è®¸å¤šå¼€æºçš„æ–¹æ¡ˆï¼Œä¹Ÿæœ‰è®¸å¤šå•†ä¸šåŒ–çš„æ–¹æ¡ˆï¼ŒåŸºæœ¬ä¸Šå¯ä»¥åˆ†ä¸ºï¼š

1. ChatGPT + Fine-tuneï¼š å¾®è°ƒå‡ºä¸€ä¸ªè‡ªå·±çš„æ¨¡å‹ï¼Œä»ä¸€äº›å¤§ä½¬çš„åé¦ˆæ¥çœ‹ï¼Œè¿™ç§æ–¹å¼æˆæœ¬é«˜ï¼Œéœ€è¦èŠ±è´¹å¾ˆå¤šç²¾åŠ›å»è®­ç»ƒï¼Œæ•ˆæœä¸ä¸€å®šèƒ½å¤Ÿå¾ˆå¥½ã€‚å¯ä»¥çœ‹çœ‹ [å¦‚ä½•ä½¿ç”¨ OpenAI fine-tuning(å¾®è°ƒ)è®­ç»ƒå±äºè‡ªå·±çš„ä¸“æœ‰æ¨¡å‹ï¼Ÿ - çŸ¥ä¹](https://www.zhihu.com/question/591066880) å’Œ [å¤§æ¨¡å‹å¤–æŒ‚(å‘é‡)çŸ¥è¯†åº“ - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/633671394)
2. ChatGPT + å¤–æŒ‚çŸ¥è¯†åº“: è¿™ä¸ªæœ‰ä¸¤ä¸ªæ–¹æ¡ˆï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯å®˜æ–¹æä¾›çš„æ’ä»¶ [chatgpt-retrieval-plugin](https://github.com/openai/chatgpt-retrieval-plugin) æ¥å¤„ç†æ–‡æ¡£å‘é‡ï¼Œç¼ºç‚¹å°±æ˜¯åªèƒ½åœ¨ ChatGPT æºç«™ç‚¹ä½¿ç”¨ï¼Œå¹¶ä¸”è¦æœ‰æ’ä»¶å¼€å‘è€…æƒé™ã€‚å¦ä¸€ä¸ªæ˜¯åˆ©ç”¨ LangChain å¤„ç†ç”Ÿæˆå‘é‡åº“ï¼Œç„¶åè°ƒç”¨ ChatGPT openapi ï¼Œ å¸¦ä¸Šæ£€ç´¢å‡ºæ¥çš„ç›¸å…³æ•°æ®å’Œé—®é¢˜å»ä½¿ç”¨ã€‚
3. å¼€æº LLM + å¾®è°ƒ: å°±æ˜¯åˆ©ç”¨å¼€æºçš„ LLM å¾®è°ƒè®­ç»ƒç›®æ ‡çš„çŸ¥è¯†åº“ï¼Œæ¯”å¦‚ [ChatGLM3](https://github.com/THUDM/ChatGLM3)ï¼Œå½“ç„¶è®­ç»ƒæˆæœ¬ä¹Ÿæ˜¯åœ¨çš„ï¼Œä½†å¯ä»¥åšåˆ°æ•°æ®ä¸æ³„éœ²ï¼Œå‰é¢ 2 ç§å§‹ç»ˆéœ€è¦é€šè¿‡ ChatGPTï¼Œéš¾å…å‡ºç°ä¸€äº›æ•°æ®æ³„éœ²ã€‚
4. LangChain + å¼€æº LLM: å¦‚æœä¸æƒ³è‡ªå·±è®­ç»ƒï¼Œåˆæƒ³ä¿è¯æ•°æ®å®‰å…¨ï¼Œé‚£ä¹ˆç»“åˆ 2ï¼Œ3 ç‚¹çš„æ–¹æ¡ˆåˆ™æ˜¯å®‰å…¨å¯é çš„ï¼Œç”¨ LangChain å¯¹æ–‡æ¡£è¿›è¡Œå‘é‡åŒ–ï¼Œç„¶åæ£€ç´¢å†…å®¹ï¼Œåœ¨è°ƒç”¨ LLM å¯¹å¾—åˆ°çš„å†…å®¹è¿›è¡Œæ€»ç»“è¾“å‡ºã€‚
5. æˆç†Ÿçš„å¼€æºé¡¹ç›®: ä¸»è¦æœ‰ [FastGPT](https://fastgpt.run/) å’Œ [Dify](https://dify.ai/zh)
6. ä½¿ç”¨ [TianliGPT](https://docs_s.tianli0.top/) ä½œä¸ºæŠ€æœ¯æ–‡æ¡£çš„æ‘˜è¦.

ä¸Šé¢å‡ ç§æ–¹æ¡ˆï¼Œ2ï¼Œ4 éƒ½æ˜¯æ¯”è¾ƒç®€å•çš„æ–¹æ¡ˆï¼ŒåŒºåˆ«å°±æ˜¯æ¨¡å‹çš„é—®é¢˜å’Œæ•°æ®æ˜¯å¦ç§æœ‰åŒ–ï¼Œè¿™é‡Œé€‰æ‹©æ–¹æ¡ˆ 4ï¼Œä¸ä¾èµ– Openaiï¼Œå¯ä»¥å°‘å¤„ç†ç‚¹å‘ã€‚æœ€ç»ˆé€‰æ‹©çš„æ–¹æ¡ˆå°±æ˜¯ [Langchain-Chatchat](https://github.com/chatchat-space/Langchain-Chatchat) + [chatglm3-6b](https://huggingface.co/THUDM/chatglm3-6b)

## [ç»©æ•ˆè€ƒæ ¸æ–°ç¯‡ç« ï¼šæŠ€æœ¯ä¸­å¿ƒçš„ç»©æ•ˆç®¡ç†ä¸è¯„ä¼°æ–¹æ³•](https://blog.dong4j.site/posts/3a683908.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## 2. æŠ€æœ¯ä¸­å¿ƒç»„ç»‡æ¶æ„

### 2.1 æ•´ä½“æ¶æ„

![ç»„ç»‡æ¶æ„.drawio.svg](https://cdn.dong4j.site/source/image/%E7%BB%84%E7%BB%87%E6%9E%B6%E6%9E%84.drawio.svg)

---

1. æŠ€æœ¯ä¸­å¿ƒç”± 2 ä¸ªä¸šåŠ¡çº¿å’Œ 5 ä¸ªèŒèƒ½å›¢é˜Ÿæ„æˆã€‚å…¶ä¸­äº‹ä¸šçº¿åˆ†ä¸ºä¸ºï¼š ä¸šåŠ¡éƒ¨é—¨ä¸€ã€ä¸šåŠ¡éƒ¨é—¨äºŒ
2. èŒèƒ½å›¢é˜Ÿä¸ºï¼šå¼€å‘å›¢é˜Ÿã€ æµ‹è¯•å›¢é˜Ÿã€äº§å“å›¢é˜Ÿã€UI è®¾è®¡å›¢é˜Ÿã€è¿ç»´å›¢é˜Ÿå’Œå®æ–½å›¢é˜Ÿ;
3. æŠ€æœ¯ä¸­å¿ƒé¢†å¯¼å›¢é˜Ÿæ„æˆç”± æŠ€æœ¯ä¸­å¿ƒæ€»è´Ÿè´£äººã€æŠ€æœ¯è´Ÿè´£äººã€äº§å“è´Ÿè´£äººå’Œå„äº‹ä¸šçº¿é¡¹ç›®ç»ç†ä»¥åŠå„å›¢é˜Ÿ Leader æ„æˆï¼Œå®è¡ŒåŒçº¿ç®¡ç†ï¼ŒåŒå²—åŒè´£æœºåˆ¶;

---

### 2.2 å·¥ä½œæ±‡æŠ¥æœºåˆ¶

1. å„äº‹ä¸šçº¿äººå‘˜å‘é¡¹ç›®ç»ç†æ±‡æŠ¥ï¼›
2. äº§å“å›¢é˜Ÿã€å¼€å‘å›¢é˜Ÿã€æµ‹è¯•å›¢é˜Ÿã€è¿ç»´å›¢é˜Ÿå‘å„å›¢é˜Ÿ Leader æ±‡ æŠ¥ï¼Œå„å›¢é˜Ÿ Leader æŠ€æœ¯è´Ÿè´£äººå’Œäº§å“è´Ÿè´£äººæ±‡æŠ¥;
3. é¡¹ç›®ç»ç†ã€å®æ–½ Leaderã€ æŠ€æœ¯è´Ÿè´£äººå’Œäº§å“è´Ÿè´£äººå‘æ€»è´Ÿè´£äººæ±‡æŠ¥;

---

### 2.3 éƒ¨é—¨åˆ’åˆ†ä¸èŒèƒ½

#### 2.3.1 éƒ¨é—¨ä¸€

ç•Œå®šå„éƒ¨é—¨çš„èŒè´£èŒƒå›´

#### 2.3.2 éƒ¨é—¨äºŒ

ç•Œå®šå„éƒ¨é—¨çš„èŒè´£èŒƒå›´

---

### 2.4 å›¢é˜Ÿåˆ’åˆ†ä¸èŒèƒ½

![20241229144917_Puj2WMCy.webp](https://cdn.dong4j.site/source/image/20241229144917_Puj2WMCy.webp)

---

#### 2.4.1 äº§å“å¼€å‘å›¢é˜Ÿ

**äº§å“å¼€å‘å›¢é˜ŸèŒè´£**

1. æŠ€æœ¯å¼•é¢†ä¸æ”¯æŒï¼šå…³æ³¨å›½å†…å¤–è¡Œä¸šå‰æ²¿å‘å±•åŠ¨æ€åŠä¿¡æ¯ï¼Œç ”ç©¶å¹¶åº”ç”¨å…ˆè¿›æŠ€æœ¯ï¼Œç®¡ç†å…¬å¸æ•´ä½“æ ¸å¿ƒæŠ€æœ¯ï¼Œè§„åˆ’å’Œå¼•é¢†å…¬å¸å¼€å‘æŠ€æœ¯å‘å±•ï¼Œæ»¡è¶³å…¬å¸æˆ˜ç•¥å¯¹æŠ€æœ¯æå‡ºçš„è¦æ±‚ï¼Œä»¥åŠç³»ç»Ÿæ›´æ–°äº§å“å‡çº§çš„æŠ€æœ¯éœ€æ±‚ï¼Œå‘ä¸šåŠ¡éƒ¨é—¨æä¾›æŠ€æœ¯æ”¯æŒã€‚
2. æ ‡å‡†ä¸è´¨é‡æŠŠæ§ï¼šç»„ç»‡åˆ¶å®šå…¬å¸æŠ€æœ¯æ ‡å‡†ï¼Œç¼–å†™å®Œå–„å¼€å‘æµç¨‹ï¼Œ æ˜ç¡®å¹¶è½å®æ–‡æ¡£ç¼–å†™ç§ç±»ã€æ ¼å¼ç­‰æ–¹é¢çš„è¦æ±‚ã€‚è¯„å®¡é‡è¦éœ€æ±‚ï¼Œç»„ç»‡åˆ¶å®šå’Œå®æ–½é‡å¤§æŠ€æœ¯å†³ç­–å’ŒæŠ€æœ¯æ–¹æ¡ˆï¼Œæ•´ä½“æŠŠæ§é¡¹ç›®å¼€å‘è¿› åº¦ä¸è´¨é‡ã€‚
3. æŠ€æœ¯åŸ¹è®­ä¸èµ‹èƒ½ï¼šå¼€å±•æŠ€æœ¯åŸ¹è®­ã€äº¤æµä¸åˆ†äº«ï¼Œæå‡å‘˜å·¥å¼€å‘æŠ€æœ¯èƒ½åŠ›ã€‚ä»æŠ€æœ¯è§’åº¦è¯„ä»·å‘˜å·¥èƒ½åŠ›ä¸ç»©æ•ˆã€‚
4. å®Œæˆå…¬å¸é¢†å¯¼äº¤åŠçš„å…¶ä»–å·¥ä½œã€‚

**å›¢é˜Ÿäººå‘˜æ„æˆ**

äº§å“å¼€å‘å›¢é˜Ÿç”±å¼€å‘ç»„ã€æµ‹è¯•ç»„å’Œå®æ–½ç»„æ„æˆã€‚å…¶ä¸­ï¼šå¼€å‘ç»„åŒ…æ‹¬ï¼šæ¶æ„å¸ˆã€å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆã€Java å¼€å‘å·¥ç¨‹å¸ˆã€ Android å¼€å‘å·¥ç¨‹å¸ˆç­‰èŒä½, åæœŸå¯æ ¹æ®æƒ…å†µå¢è®¾æ•°æ®æŒ–æ˜ä¸åˆ†æå¸ˆã€å¤§æ•°æ®ç ”å‘å·¥ç¨‹å¸ˆç­‰æ•°æ®ç±»å²—ä½.

---

#### 2.4.2 äº§å“è®¾è®¡å›¢é˜Ÿ

**äº§å“è®¾è®¡å›¢é˜ŸèŒè´£**

1. æ”¶é›†æ•´ç†ä¸åˆ†æè¡Œä¸šåŠ¨æ€,ä¸ºå…¬å¸å†³ç­–å±‚åŠäº§å“ç­–ç•¥æä¾›ä¾æ®ã€‚æ ¹æ®å¸‚åœºå˜åŒ–ã€æŠ€æœ¯æ¼”è¿›ã€ç«äº‰å¯¹æ‰‹ã€ä¾›åº”å•†ã€å®¢æˆ·éœ€æ±‚ï¼Œåˆ¶å®šäº§å“ç­–ç•¥ (åŒ…æ‹¬å¸‚åœºè°ƒç ”ã€äº§å“åŠŸèƒ½ä¸ç”¨æˆ·ä½“éªŒè®¾è®¡,äº§å“ç‰ˆæœ¬è®¡åˆ’ ç­‰)ï¼Œå¯¹æ—¢æœ‰äº§å“æ”¹è‰¯å’Œæ–°äº§å“å¼€å‘è¿›è¡Œè§„åˆ’ã€è®¾è®¡ã€è¯„å®¡åŠæˆæœ¬æ•ˆç›Šè¯„ä¼°ã€‚
2. åˆ¶å®šå¹¶å®Œå–„å›¢é˜Ÿå·¥ä½œç›¸å…³ä½œä¸šçš„è§„èŒƒä¸æµç¨‹ã€‚å¯¹ç»æ ¸å®šé¡¹ç›®è¿›è¡Œå·¥ä½œåˆ†é…ï¼ˆåŒ…æ‹¬å®¢æˆ·éœ€æ±‚åŠä¸ªæ€§åŒ–å®šåˆ¶æ–¹æ¡ˆç­‰ï¼‰ã€åˆä½œåè°ƒã€èµ„æºæˆäºˆï¼Œå¹¶å»ºç«‹åé¦ˆæœºåˆ¶è¿›è¡Œäº§å“è®¾è®¡è¿›åº¦ç®¡æ§ï¼›
3. å»ºç«‹å®Œå–„çŸ¥è¯†ä½“ç³»ï¼Œå¹¶å¼€å±•çŸ¥è¯†ã€æŠ€èƒ½ã€è¡Œä¸šä¿¡æ¯ç­‰æ–¹é¢çš„åŸ¹è®­ã€ äº¤æµä¸åˆ†äº«ï¼Œæå‡å‘˜å·¥èƒ½åŠ›ã€‚ä»äº§å“è®¾è®¡èƒ½åŠ›è§’åº¦è¯„ä»·ä¸æŒ‡å¯¼å‘˜å·¥ã€‚
4. å®Œæˆå…¬å¸é¢†å¯¼äº¤åŠçš„å…¶ä»–å·¥ä½œã€‚

**å›¢é˜Ÿäººå‘˜æ„æˆ**

äº§å“è®¾è®¡å›¢é˜Ÿäººå‘˜ä¸»è¦ç”±äº§å“ç»ç†å’Œ UI è®¾è®¡å¸ˆæ„æˆã€‚

äº§å“ç»ç†: è´Ÿè´£äº§å“éœ€æ±‚è°ƒç ”ã€æ”¶é›†ã€åˆ†æã€è§„åˆ’ã€å®šä¹‰ã€è®¾è®¡ã€ è¿½è¸ªå®¢æˆ·é—®é¢˜ã€ä¸Šçº¿è¿è¥ç›‘æµ‹ç­‰äº§å“å·¥ä½œï¼Œç»„ç»‡å¼€å‘ã€æµ‹è¯•ã€éªŒæ”¶ã€ ä¸Šçº¿é¡¹ç›®ç®¡ç†å·¥ä½œ;

UI è®¾è®¡å¸ˆ: è´Ÿè´£äº§å“ UI ã€å¹³é¢è®¾è®¡ï¼Œè®¾è®¡éªŒæ”¶ç­‰;

---

#### 2.4.3 æŠ€æœ¯ä¸­å¿ƒæ€»è´Ÿè´£äºº

1. æŒ‰ç…§å…¬å¸çš„å‘å±•æˆ˜ç•¥ï¼Œåˆ¶å®šäº§å“æˆ˜ç•¥è§„åˆ’ã€å¹´åº¦ç»è¥è®¡åˆ’å’Œé¢„ç®—æ–¹æ¡ˆã€‚
2. å…¨é¢ç®¡ç†å…¬å¸ç ”å‘å’ŒæŠ€æœ¯æ”¯æŒå·¥ä½œï¼Œå…¨é¢è´Ÿè´£æŠ€æœ¯å±‚é¢çš„æ•´ä½“è¿è¥ï¼ŒåŒ…æ‹¬è½¯ä»¶ç ”å‘ã€é¡¹ç›®å®æ–½ã€é”€å”®æ”¯æŒåŠæŠ€æœ¯ç®¡ç†ã€‚
3. è§„åˆ’å…¬å¸çš„æŠ€æœ¯å‘å±•è·¯çº¿ä¸æ–°äº§å“å¼€å‘ï¼Œå®ç°å…¬å¸çš„æŠ€æœ¯åˆ›æ–°ç›®æ ‡ï¼ŒåŠæ—¶äº†è§£å’Œç›‘ç£æŠ€æœ¯å‘å±•æˆ˜ç•¥è§„åˆ’çš„æ‰§è¡Œæƒ…å†µã€‚
4. æ´å¯Ÿå®¢æˆ·éœ€æ±‚ï¼Œæ•æ‰å•†ä¸šæœºä¼šï¼Œè§„åˆ’æŠ€æœ¯äº§å“ï¼Œç¡®å®šäº§å“çš„æŠ€æœ¯æ–¹å‘ã€æŠ€æœ¯æ€è·¯ã€è§£å†³æŠ€æœ¯éš¾é¢˜ï¼Œå¸¦é¢†å›¢é˜Ÿå®ç°ç»„ç»‡ç›®æ ‡ã€‚
5. ä¿è¯å…¬å¸æŠ€æœ¯ã€äº§å“åŠè§£å†³æ–¹æ¡ˆçš„å¸‚åœºé¢†å…ˆæ€§ï¼Œé¢†å¯¼å…¬å¸æŠ€æœ¯å‘å±•æ–¹å‘åŠæŠ€æœ¯è¿›æ­¥ã€‚
6. å‚ä¸é‡å¤§æŠ€æœ¯é¡¹ç›®çš„å†³ç­–ï¼Œç¼–å†™é¡¹ç›®æ€»ä½“æŠ€æœ¯æ–¹æ¡ˆï¼Œå¯¹å„é¡¹ç›®è¿›è¡Œè´¨é‡è¯„ä¼°ã€‚
7. è´Ÿè´£ç›¸å…³çš„æŠ€æœ¯å‚¨å¤‡ï¼Œç§¯ææ¨åŠ¨æŠ€æœ¯åˆ›æ–°å·¥ä½œçš„å¼€å±•ï¼Œæ¢ç´¢æé«˜ äº§å“è´¨é‡çš„æœ‰æ•ˆé€”ç»ã€‚
8. è´Ÿè´£è¡Œä¸šå†…æ–°æŠ€æœ¯çš„æ”¶é›†ã€è®¨è®ºå’Œåº”ç”¨ï¼Œç»„ç»‡å¹¶å‚ä¸è¡Œä¸šå†…äº§å“ çš„è®¨è®ºã€ç ”ç©¶ã€è¯„å®¡ã€æ±‡æŠ¥ã€ä¼šè®®ã€‚
9. ç»„ç»‡å…¬å¸æ–°äº§å“çš„ç ”ç©¶è¯•åˆ¶å·¥ä½œåŠç°æœ‰äº§å“çš„æ”¹è¿›å·¥ä½œï¼›è´Ÿè´£è½¯ç¡¬ä»¶äº§å“çš„é¢„ç ”ã€è¯•æ ·ã€è®¾è®¡åŠå¼€å‘ã€‚
10. ç»„ç»‡ç ”å‘æˆæœçš„é‰´å®šå’Œè¯„å®¡ï¼Œæ±‡æ€»æ¯ä¸ªé¡¹ç›®çš„å¯é‡ç”¨æˆæœï¼Œå½¢æˆå†…éƒ¨æŠ€æœ¯å’ŒçŸ¥è¯†æ–¹é¢çš„çš„èµ„æºåº“ã€‚
11. åšå¥½å…¬å¸æ ‡å‡†å’Œè½¯è‘—ã€ä¸“åˆ© (çŸ¥è¯†äº§æƒ) è§„åˆ’ï¼Œå®æ–½ç›¸å…³æ ‡å‡†åŠç”³è¯·ä¸“åˆ©ã€‚
12. åŸ¹å…»å…¬å¸æŠ€æœ¯å›¢é˜Ÿï¼Œç›‘ç£ã€æŒ‡å¯¼åŠæ¿€åŠ±æŠ€æœ¯éƒ¨é—¨çš„å·¥ä½œã€‚
13. å‚ä¸é‡å¤§å•†åŠ¡è°ˆåˆ¤å’Œå•†åŠ¡æ´»åŠ¨ã€‚
14. å…¬å¸é¢†å¯¼å®‰æ’çš„å…¶ä»–å·¥ä½œã€‚

---

#### 2.4.4 æŠ€æœ¯è´Ÿè´£äººèŒè´£

å¼•é¢†å…¬å¸æŠ€æœ¯å‘å±•ï¼Œè§£å†³æŠ€æœ¯éš¾é¢˜ï¼Œåˆ¶å®šå’Œè½å®æŠ€æœ¯è§„èŒƒï¼Œå¯¹æŠ€æœ¯å›¢é˜Ÿå…¨å‘˜èµ‹èƒ½ã€‚

1. ä»æŠ€æœ¯è§’åº¦å‡ºå‘ï¼Œå‚ä¸å…¬å¸æˆ˜ç•¥è§„åˆ’ï¼›å®Œæˆå„é¡¹æŠ€æœ¯æ•°æ®ç»Ÿè®¡åˆ†ææŠ¥å‘Šï¼Œä¸ºä¼ä¸šæå‡ºåˆç†åŒ–å»ºè®®ã€‚
2. æŠŠæ§å…¬å¸æ ¸å¿ƒæŠ€æœ¯å’Œæ–¹å‘ï¼Œè§£å†³æŠ€æœ¯éš¾é¢˜ã€‚å¸¦é¢†æŠ€æœ¯å›¢é˜Ÿå®Œæˆå…¬å¸é‡å¤§äº§å“æŠ€æœ¯çš„å¼€å‘ã€‚
3. æŒ‡å¯¼å„éƒ¨é—¨è¿›è¡ŒæŠ€æœ¯å¼€å‘ï¼Œæ•´ä½“æŠŠæ§å¼€ å‘è¿›åº¦ï¼Œå®¡æ ¸ä¸æ§åˆ¶äº§å“çš„è´¨é‡ã€‚
4. è´Ÿè´£å…¬å¸äº§å“æŠ€æœ¯çš„é€‰å‹ä¸æ¡†æ¶æ­å»ºï¼Œç³»ç»Ÿæ¶æ„è®¾è®¡å’Œç ”è®¨ï¼Œä»¥ åŠé€šç”¨æ ¸å¿ƒéƒ¨ä»¶çš„è®¾è®¡åŠå¼€å‘ã€‚
5. å®Œå–„æŠ€æœ¯ä½“ç³»çš„è§„èŒƒå’Œæ ‡å‡†ï¼Œåˆ¶å®šç›¸å…³çš„æµç¨‹å’Œåˆ¶åº¦ï¼Œä¿ƒä½¿å›¢é˜Ÿ å·¥ä½œæµç¨‹è§„èŒƒåŒ–ã€æ ‡å‡†åŒ–ã€ç¨‹åºåŒ–ã€æé«˜å›¢é˜Ÿå·¥ä½œæ•ˆç‡ã€‚
6. æŒ‡å¯¼ä¸å»ºè®®æ­å»ºå…¬å¸æŠ€æœ¯å›¢é˜Ÿï¼Œè´Ÿè´£æŠ€èƒ½åŸ¹è®­å·¥ä½œï¼Œæå‡å›¢é˜ŸæŠ€æœ¯èƒ½åŠ›ã€‚
7. å®Œæˆå…¬å¸é¢†å¯¼äº¤åŠçš„å…¶ä»–å·¥ä½œã€‚

---

#### 2.4.5 äº§å“è´Ÿè´£äººèŒè´£

æ ¹æ®å…¬å¸çš„å‘å±•æˆ˜ç•¥å’Œæ–¹å‘ï¼Œè´Ÿè´£å…¬å¸äº§å“è§„åˆ’ä¸ç­–ç•¥çš„å®šåˆ¶å’Œ å®æ–½ï¼Œç ”ç©¶å’Œåˆ¶å®šäº§å“è®¾è®¡å›¢é˜ŸåŠäº§å“ç®¡ç†çš„è§„ç« åˆ¶åº¦å¹¶ç›‘ç£æ‰§è¡Œï¼Œå»ºç«‹å’Œå®Œå–„äº§å“ç®¡ç†ä½“ç³»ï¼ŒæŒ‡å¯¼å’Œç›‘ç£éƒ¨é—¨çš„äº§å“ç®¡ç†å·¥ä½œï¼Œç¡®ä¿äº§å“æ»¡è¶³å…¬å¸ç°çŠ¶å’Œæœªæ¥å‘å±•éœ€è¦ã€‚

1. å…³æ³¨è¡Œä¸šåŠ¨æ€ï¼Œæ´å¯Ÿè¡Œä¸šå’Œå®¢æˆ·éœ€æ±‚ï¼ŒæŒæ¡å¸‚åœºæƒ…å†µï¼ŒåŒ…æ‹¬ç«äº‰å¯¹æ‰‹çš„äº§å“ç­–ç•¥ï¼Œåˆ¶å®šå…¬å¸äº§å“è§„åˆ’ã€‚
2. å»ºç«‹ä¸è½å®äº§å“è®¾è®¡åˆ¶åº¦æ ‡å‡†ã€å·¥ä½œæµç¨‹ä¸è§„èŒƒã€‚æŒ‡å¯¼å„éƒ¨é—¨è¿› è¡Œäº§å“è§„åˆ’ä¸è®¾è®¡,æ•´ä½“æŠŠæ§äº§å“è®¾è®¡è¿›åº¦ï¼ŒæŒ‡å¯¼ä¸è¯„å®¡äº§å“è®¾è®¡ è´¨é‡ã€‚
3. ç‰µå¤´å…¬å¸é‡å¤§é¡¹ç›®ï¼ŒåŒ…æ‹¬ç»Ÿä¸€åè°ƒå…¬å¸ç›¸å…³éƒ¨é—¨ä¸äº§å“è®¾è®¡å›¢é˜Ÿ ä¹‹é—´çš„è”ç»œå·¥ä½œï¼Œç¡®ä¿ä¿¡æ¯çš„æ­£å¸¸æµè½¬ï¼›å¼€å±•å¤–è”æ´»åŠ¨ï¼Œè¿›è¡Œå¤§å®¢æˆ·æ‹œè®¿ï¼ŒååŒå¤–éƒ¨èµ„æºä¸ä¿¡æ¯ã€‚
4. äº§å“å›¢é˜Ÿç®¡ç†ï¼šæŒ‡å¯¼ä¸å»ºè®®å„éƒ¨é—¨å†…éƒ¨çš„äº§å“è®¾è®¡äººå‘˜é…ç½®ï¼ŒæŒ‡ å¯¼å‘˜å·¥çš„å‘å±•ï¼Œè¿›è¡Œç›¸å…³è¡Œä¸šçŸ¥è¯†ä¸æŠ€èƒ½åŸ¹è®­ï¼Œæå‡å‘˜å·¥çš„èƒ½åŠ›ç´ è´¨ã€‚
5. å®Œæˆå…¬å¸é¢†å¯¼äº¤åŠçš„å…¶ä»–å·¥ä½œã€‚

---

#### 2.4.6 é¡¹ç›®ç»ç†èŒè´£

ä¸é¡¹ç›®ç›¸å…³äººå‘˜è¿›è¡ŒååŒé…åˆï¼Œç»„ç»‡å¹¶ç›‘ç£å…¨ä½“äººå‘˜å…¨é¢å®Œæˆæœ¬éƒ¨èŒè´£èŒƒå›´å†…çš„å„é¡¹å·¥ ä½œä»»åŠ¡ã€‚

1. å…³æ³¨ã€åˆ†äº«ä¸äº¤æµè¡Œä¸šæŠ€æœ¯åŠ¨æ€ã€å¸‚åœºå®¢æˆ·ä¿¡æ¯ç­‰ï¼Œç»„ç»‡å¼€å±•çŸ¥ è¯†ã€æŠ€èƒ½åŸ¹è®­ï¼Œæå‡å›¢é˜Ÿèƒ½åŠ›ã€‚
2. æ ¹æ®å¸‚åœºå®¢æˆ·éœ€æ±‚ã€å…¬å¸æˆ˜ç•¥ï¼Œè¿›è¡Œéƒ¨é—¨äº§å“è§„åˆ’ã€äº§å“å¼€å‘ã€æµ‹è¯•ä¸å‘ç‰ˆï¼Œè´Ÿè´£é¡¹ç›®ä»å¯åŠ¨ã€å¼€å‘ã€å®æ–½åˆ°ç»“æŸçš„å…¨è¿‡ç¨‹ã€å…¨é¢çš„éƒ¨ç½²ã€æŒ‡å¯¼å’Œç®¡æ§ã€‚
3. æŒ‡å¯¼ä¸æ¿€åŠ±å‘˜å·¥å¼€å±•å·¥ä½œï¼Œè´Ÿè´£å›¢é˜Ÿå»ºè®¾ï¼Œä¼ é€’ä¸å¼•å¯¼å‘˜å·¥è·µè¡Œå…¬å¸æ–‡åŒ–ï¼Œè¥é€ ç§¯æå‘ä¸Šçš„å›¢é˜Ÿæ°›å›´ã€‚
4. å¯¹æ¥åˆ°æœ¬éƒ¨é—¨çš„å¤§å®¢æˆ·ç»„å»ºä¸šåŠ¡ç®¡ç†æ¡£æ¡ˆï¼Œå»ºç«‹å®æ–½å¤§å®¢æˆ·è°ƒç ”å’Œè·Ÿè¸ªæœåŠ¡æœºåˆ¶ã€‚
5. è´Ÿè´£å¯¹ç»„å‘˜ä¸‹è¾¾ä»»åŠ¡ï¼Œç»„ç»‡è¿›è¡Œå¼€å‘ã€å®æ–½ã€éªŒæ”¶ã€å½’æ¡£ã€‚
6. è´Ÿè´£é¡¹ç›®åè°ƒã€æŠ€æœ¯æ”¯æŒä¸å”®åæœåŠ¡å·¥ä½œã€‚
7. å®Œæˆå…¬å¸é¢†å¯¼äº¤åŠçš„å…¶ä»–å·¥ä½œã€‚

---

## 3. å®Œæ•´çš„å¼€å‘æµç¨‹

![20241229144917_9qZ2zrs5.webp](https://cdn.dong4j.site/source/image/20241229144917_9qZ2zrs5.webp)

---

### 3.1 ç«‹é¡¹æµç¨‹

![20241229144917_OXJV3jUs.webp](https://cdn.dong4j.site/source/image/20241229144917_OXJV3jUs.webp)

1. æ ¹æ®å¸‚åœºéœ€æ±‚ç­‰è¾“å…¥æ–°äº§å“æˆ–è€…ç‰¹å®šäº§å“çš„è®¾è®¡å’Œå¼€å‘æ¥æºï¼›
2. å¯¹äº§å“å¯è¡Œæ€§è¿›è¡Œåˆ†æã€è¯„ä¼°ï¼›
3. å½¢æˆäº§å“ç«‹é¡¹æŠ¥å‘Šï¼›
4. æˆç«‹é¡¹ç›®å¼€å‘å°ç»„ã€‚

ç«‹é¡¹åç”±äº§å“ç»ç†ç»„ç»‡éœ€æ±‚è¯„å®¡ï¼Œè¯„å®¡å®Œæˆåç”±é¡¹ç›®ç»ç†ç¼–åˆ¶ç»´æ ¼è¡¨æ ¼ï¼Œè¿›è¡Œç”Ÿäº§æ’æœŸã€‚

---

### 3.2 éœ€æ±‚æ”¶é›†ä¸è¯„å®¡

1. äº§å“ç»ç†åœ¨æ¯æ¬¡ç‰ˆæœ¬å¼€å§‹ä¹‹å‰å®šæœŸæ”¶é›†å„æ–¹éœ€æ±‚ï¼ˆéœ€æ±‚æ± ç»´æŠ¤ï¼‰ï¼Œ åŒ…æ‹¬å®¢æˆ·åé¦ˆã€ä¸šåŠ¡éƒ¨é—¨åé¦ˆã€é¢†å¯¼æ„è§ã€å¸‚åœºè°ƒç ”åŠæŠ€æœ¯å›¢é˜Ÿéœ€æ±‚ç­‰æ¥æºï¼Œè¾“å‡ºéœ€æ±‚åˆ—è¡¨;
2. åœ¨ç‰ˆæœ¬å¼€å§‹ä¹‹å‰å¬å¼€ç‰ˆæœ¬è®¡åˆ’ä¼šè®®ï¼Œå‚ä¸è€…åŒ…æ‹¬é¡¹ç›®ç»ç†ã€äº§å“ç»ç†åŠé¡¹ç›®æ ¸å¿ƒæˆå‘˜ï¼ŒæŒ‰ä¼˜å…ˆçº§æ¢³ç†éœ€æ±‚åˆ—è¡¨ï¼Œè¾“å‡ºä¸‹æ¬¡ç‰ˆæœ¬çš„åˆæ­¥ä»»åŠ¡åˆ—è¡¨ï¼ˆæ ¹æ®è¯„å®¡æƒ…å†µå¯èƒ½ä¼šè¿›è¡Œè°ƒæ•´ï¼‰;
3. äº§å“ç»ç†åŸºäºåˆæ­¥ä»»åŠ¡åˆ—è¡¨å®Œæˆéœ€æ±‚åˆ†æè¯´æ˜ä¹¦ï¼Œç»„ç»‡å›¢é˜Ÿæˆå‘˜â€”â€”åŒ…æ‹¬ UIã€å¼€å‘ã€æµ‹è¯•ï¼Œå¬å¼€éœ€æ±‚è¯„å®¡ä¼šè®®ï¼Œè¾“å‡º **è¯„å®¡æ„è§** åŠ **ä¿®æ­£å®Œæˆæ—¶é—´**;
4. äº§å“ç»ç†é’ˆå¯¹éœ€æ±‚è¯„å®¡ä¼šè®®ä¸­å›¢é˜Ÿæå‡ºçš„æ„è§å»ºè®®ï¼Œåœ¨ä¿®æ­£å®Œæˆæ—¶é—´å†…åŠæ—¶ä¿®æ­£éœ€æ±‚æ–‡æ¡£ï¼Œå¹¶åŠæ—¶é€šçŸ¥å›¢é˜Ÿç›¸å…³æˆå‘˜ï¼Œè¾“å‡ºç¡®å®šçš„éœ€æ±‚æ–‡æ¡£ã€‚
5. éœ€æ±‚è¯„å®¡ä¼šè®®åï¼Œç”±é¡¹ç›®ç»ç†å¯¹äº§å“éœ€æ±‚è¿›è¡Œç»¼åˆè¯„ä¼°ï¼Œå¦‚æŠ€æœ¯å¯è¡Œæ€§åˆ†æã€æŠ€æœ¯é‡ç‚¹éš¾ç‚¹è§£å†³æ–¹æ¡ˆã€å·¥æ—¶è¯„ä¼°ç­‰ï¼Œå¹¶ä¸äº§å“ç»ç†åå•†åˆæ­¥ç¡®å®šè½¬æµ‹ã€ä¸Šçº¿æ—¶é—´èŠ‚ç‚¹å„ä¸ªèŠ‚ç‚¹
6. äº§å“è®¾è®¡å›¢é˜Ÿå¼€å§‹ç€æ‰‹äº§å“åŸå‹è®¾è®¡ï¼Œç•Œé¢äº¤äº’è®¾è®¡ï¼›æµ‹è¯•å›¢é˜Ÿå¯ä»¥åŒæ­¥ç¼–å†™æµ‹è¯•è®¡åˆ’ã€æµ‹è¯•ç”¨ä¾‹ç­‰æ–‡æ¡£ï¼›UI è®¾è®¡å¸ˆç­¹å¤‡äº§å“ç•Œé¢è®¾è®¡æ–¹æ¡ˆ;

---

### 3.3 è®¡åˆ’ä¸æ’æœŸ

äº§å“çš„å¼€å‘è®¡åˆ’ç”±é¡¹ç›®ç»ç†åœ¨äº§å“ä¿®è®¢å®Œæˆå¹¶è¾“å‡ºéœ€æ±‚æ–‡æ¡£ä¹‹åè¿›è¡Œã€‚äº§å“ç»ç†è´Ÿè´£ç¼–åˆ¶ã€Šäº§å“å‘å¸ƒè®¡åˆ’ã€‹ï¼š

1. æ˜ç¡®äº§å“èŒƒå›´ç›®æ ‡ï¼Œè¯†åˆ«é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­å„ç±»æ´»åŠ¨å’Œä»»åŠ¡ï¼Œæ ‡è¯†å‡ºå…³é”®è·¯å¾„ï¼›
2. å®šä¹‰é¡¹ç›®é˜¶æ®µåŠé‡Œç¨‹ç¢‘èŠ‚ç‚¹ , åœ¨ç»´æ ¼è¡¨ä¸­ç¼–å†™æœ€ç»ˆçš„éœ€æ±‚ç‚¹;
3. è¯†åˆ«å„é˜¶æ®µéœ€è¦è¾“å‡ºçš„å·¥ä½œäº§å“ã€è¯†åˆ«å¹¶åˆ†é…è®¡åˆ’ä¸­å„é¡¹ä»»åŠ¡æ‰€éœ€çš„èµ„æºå¹¶å®‰æ’æ—¶é—´è¿›åº¦ï¼›

**æœ¬é˜¶æ®µäº§å‡ºç‰©ä¸»è¦åŒ…å«ï¼š**

| åºå· | äº§å‡ºç‰©           | è´Ÿè´£äººæˆ–å›¢é˜Ÿ | å¤‡æ³¨                                                                     |
| ---- | ---------------- | ------------ | ------------------------------------------------------------------------ |
| 1    | éœ€æ±‚è¯„å®¡çºªè¦     | äº§å“ç»ç†     | éœ€æ±‚è¯„å®¡ä¼šåäº§å‡º                                                         |
| 2    | éœ€æ±‚åˆ†æè¯´æ˜ä¹¦   | äº§å“ç»ç†     | äº§å“ç«‹é¡¹åäº§å‡ºï¼Œè¯„å®¡ä¼šè¯„ å®¡ä¸»è¦ä¾æ®                                      |
| 3    | ç³»ç»Ÿç»¼åˆè¯„ä¼°æŠ¥å‘Š | é¡¹ç›®ç»ç†     | å¯¹è¯¥ç³»ç»Ÿçš„æŠ€æœ¯å¯è¡Œæ€§ã€æŠ€ æœ¯éš¾ç‚¹ç­‰è¿›è¡Œåˆ†æå’Œè¯„ä¼°ï¼Œ å¯¹å¼€å‘å·¥æ—¶è¿›è¡Œåˆæ­¥è¯„ä¼° |
| 4    | äº§å“å¼€å‘è®¡åˆ’     | é¡¹ç›®ç»ç†     | æ˜ç¡®éœ€æ±‚ä»»åŠ¡æ¸…å•åï¼Œåˆ¶å®šå¼€å‘è®¡åˆ’å¹¶è®°å½•åˆ°ç»´æ ¼è¡¨                           |
| 5    | äº§å“å‘å¸ƒè®¡åˆ’     | äº§å“ç»ç†     | è®°å½•åˆ°ç»´æ ¼è¡¨                                                             |

---

### 3.4 äº§å“è®¾è®¡ä¸å¼€å‘

1. äº§å“ç»ç†åœ¨ç»´æ ¼è¡¨ä¸­æ•´ç†å¯¹åº”çš„è®¡åˆ’å’Œéœ€æ±‚;
2. é¡¹ç›®ç»ç†åœ¨ç»´æ ¼è¡¨ä¸­å»ºç«‹å¯¹åº”çš„é¡¹ç›®ï¼Œå…³è”å¯¹åº”çš„äº§å“å’Œéœ€æ±‚ï¼Œå°†éœ€æ±‚åˆ†è§£ä¸ºä»»åŠ¡æ¸…å•ï¼Œå¹¶åˆ†é…ç»™ç›¸åº”çš„å¼€å‘äººå‘˜;
3. å¼€å‘äººå‘˜æ ¹æ®è‡ªèº«ä»»åŠ¡çš„æœŸé™ï¼ŒåŠæ—¶ä¸ä¾èµ–æ–¹æ²Ÿé€šï¼Œç¡®å®šä¾èµ–ä»» åŠ¡çš„å®Œæˆæ—¶é—´ï¼Œä»¥å…å½±å“è‡ªèº«ä»»åŠ¡è¿›åº¦ï¼Œå­˜åœ¨é—®é¢˜åŠæ—¶å‘é¡¹ç›®ç»ç†åé¦ˆ;
4. äº§å“ç»ç†å®Œæˆç³»ç»ŸåŸå‹è®¾è®¡å’Œäº¤äº’è®¾è®¡ä¹‹åï¼Œå¯ç»„ç»‡é¡¹ç›®å›¢é˜Ÿè¿›è¡Œéœ€æ±‚è¯„å®¡;
5. UI è®¾è®¡å®Œæˆåï¼Œç›¸å…³å¼€å‘äººå‘˜ä¸äº§å“ç»ç†éœ€å¯¹ UI è®¾è®¡è¿›è¡Œç¡®è®¤ï¼Œ å¦‚æœæ¶‰åŠå†…å®¹è¾ƒå¤šï¼Œå¯ç»„ç»‡ UI è¯„å®¡ä¼šè®®ï¼ˆå‚ä¼šäººå‘˜ç”±äº§å“ç»ç†æˆ–é¡¹ ç›®ç»ç†æƒè¡¡ç»„ç»‡ï¼‰;
6. æ¶‰åŠæµç¨‹çš„å¼€å‘ä»»åŠ¡å¿…é¡»æœ‰å¯¹åº”çš„è¯¦ç»†è®¾è®¡ï¼ŒæŠ€æœ¯ç›¸å…³è´Ÿè´£äººè´Ÿè´£å¯¹è®¾è®¡è¿›è¡Œè¯„å®¡ï¼Œæ²¡æœ‰å®¡æŸ¥è¿‡çš„è®¾è®¡ä¸èƒ½æŠ•å…¥å¼€å‘ã€‚
7. ä»»åŠ¡å¼€å‘å®Œæˆéœ€è¦è¿›è¡Œä»£ç å®¡æŸ¥ï¼ˆcode reviewï¼‰ã€‚å¼€å‘äººå‘˜å®Œæˆç›¸åº”çš„å¼€å‘ä»»åŠ¡åï¼ŒåŒæ­¥åœ¨ç»´æ ¼è¡¨ä¸­å…³é—­ä»»åŠ¡ï¼Œä»¥ä¾¿äºç®¡ç†äº§å“å¼€å‘å®æ—¶çŠ¶æ€;
8. æµ‹è¯•å›¢é˜Ÿç¼–å†™å®Œæˆæµ‹è¯•ç”¨ä¾‹åï¼Œéœ€å¬å¼€ç”¨ä¾‹è¯„å®¡ä¼šè®®ï¼Œç”±é¡¹ç›®ç»ç†æƒè¡¡ç»„ç»‡å‚ä¼šäººå‘˜ã€‚è¯„å®¡ç›®çš„ä¸»è¦ç¡®ä¿æµ‹è¯•èŒƒå›´ã€è¾¹ç•Œå’Œè¦†ç›–ç‡ï¼Œ æœ€å¤§å¯èƒ½çš„ä¿éšœäº§å“è´¨é‡;
9. äº§å“ç»ç†æˆ–é¡¹ç›®ç»ç†æ¯å‘¨åº”å¬å¼€å‘¨ä¾‹ä¼šï¼Œæ€»ç»“å›¢é˜Ÿä¸Šå‘¨çš„é—®é¢˜è§£å†³è¿›åº¦, æœ¬å‘¨çš„å·¥ä½œå®Œæˆæƒ…å†µå’Œä¸‹å‘¨çš„å·¥ä½œè®¡åˆ’, æŒç»­è·Ÿè¿›ä»»åŠ¡è¿›åº¦ä¸é—®é¢˜ï¼Œå¹¶åŠæ—¶åè°ƒå¤„ç†ï¼Œ ä»¥ä¿éšœè¿›åº¦é¢„æœŸï¼Œä¼šåå½¢æˆã€Šé¡¹ç›®å‘¨ä¾‹ä¼šä¼šè®®çºªè¦ã€‹;
10. é¡¹ç›®ç»ç†åº”å½“å®šæœŸï¼ˆæ¯å‘¨ä¸€æ¬¡ï¼‰æ’°å†™ã€Šé¡¹ç›®è¿›å±•æŠ¥å‘Šã€‹ï¼Œé€šæŠ¥ç»™ä¸Šçº§é¢†å¯¼å’Œæ‰€æœ‰é¡¹ç›®æˆå‘˜;
11. åœ¨é¢„å®šææµ‹æ—¶é—´èŠ‚ç‚¹å‰ä¸€å¤©ï¼Œå¼€å‘äººå‘˜ç¼–å†™ææµ‹æ–‡æ¡£ï¼Œæè¿°æœ¬æ¬¡ç‰ˆæœ¬è°ƒæ•´å†…å®¹ï¼ˆé™„ä¸Šä»»åŠ¡åˆ—è¡¨ï¼‰åŠæ³¨æ„äº‹é¡¹ï¼Œå¹¶é€šçŸ¥é¡¹ç›®ç›¸å…³äººå‘˜ï¼ˆé‚®ä»¶ï¼‰;

**æœ¬é˜¶æ®µäº§å‡ºç‰©ä¸»è¦åŒ…å«:**

| åºå· | äº§å‡ºç‰©                    | è´Ÿè´£äººæˆ–å›¢é˜Ÿ | å¤‡æ³¨         |
| ---- | ------------------------- | ------------ | ------------ |
| 1    | äº§å“åŸå‹åŠäº¤äº’è®¾è®¡        | äº§å“ç»ç†     | äº§å“åŸå‹è¯„ä¼° |
| 2    | äº§å“ UI è®¾è®¡              | UI è®¾è®¡å¸ˆ    | UI è®¾è®¡è¯„ä¼°  |
| 3    | æµ‹è¯•è®¡åˆ’                  | æµ‹è¯•å›¢é˜Ÿ     |              |
| 4    | æµ‹è¯•ç”¨ä¾‹                  | æµ‹è¯•å›¢é˜Ÿ     | æµ‹è¯•ç”¨ä¾‹è¯„ä¼° |
| 5    | é¡¹ç›®å‘¨ä¾‹ä¼šä¼šè®®çºªè¦        | é¡¹ç›®ç»ç†     | å‘¨ä¾‹ä¼šåæ›´æ–° |
| 6    | é¡¹ç›®è¿›åº¦ç®¡ç† é¡¹ç›®è¿›å±•æŠ¥å‘Š | é¡¹ç›®ç»ç†     | å‘¨ä¾‹ä¼šåæ›´æ–° |

---

### 3.5 é—®é¢˜ä¸é£é™©ç®¡ç†

é¡¹ç›®ç»ç†å’Œäº§å“ç»ç†åŠæ—¶è¯†åˆ«å¹¶è§£å†³äº§å“å¼€å‘è¿‡ç¨‹çš„é—®é¢˜å’Œé£é™©ï¼Œæ¯å‘¨è¿›è¡Œä¸€æ¬¡ï¼Œå®Œæˆã€Šé—®é¢˜è·Ÿè¸ªã€‹ã€ã€Šé£é™©è·Ÿè¸ªã€‹è¡¨æ ¼çš„è®°å½•å’Œæ›´æ–°ï¼Œ é™„åœ¨é¡¹ç›®è¿›å±•æŠ¥å‘Šåã€‚

**é—®é¢˜è·Ÿè¸ªè¡¨:**

| ç¼–å· | é—®é¢˜æè¿° | è§£å†³æ–¹æ¡ˆ | è´£ä»»äºº | é—®é¢˜æ å‡ºæ—¶é—´ | è®¡åˆ’è§£ å†³æ—¶é—´ | å®é™…å®Œ æˆæ—¶é—´ |
| ---- | -------- | -------- | ------ | ------------- | ------------- | ------------- |
|      |          |          |        |               |               |               |

**é£é™©è·Ÿè¸ªè¡¨:**

| ç¼–å· | é£é™© æè¿° | é£é™© æ¥æº | åˆ†ç±» | åº”å¯¹ ç­–ç•¥ | ä¸¥é‡ æ€§ (1-3) | å¯èƒ½ æ€§ (1-3) | é£é™© ç³»æ•° | ä¼˜å…ˆ çº§ | ç¼“è§£ æ–¹æ¡ˆ | åº”æ€¥ æ–¹æ¡ˆ | æå‡º æ—¶é—´ |
| ---- | --------- | --------- | ---- | --------- | ------------- | ------------- | --------- | ------- | --------- | --------- | --------- |
|      |           |           |      |           |               |               |           |         |           |           |           |

---

### 3.6 æµ‹è¯•ä¸éªŒæ”¶

1. éœ€æ±‚è¯„å®¡ä¼šè®®åï¼Œæµ‹è¯•å›¢é˜Ÿéœ€å¯¹å„åŠŸèƒ½æ¨¡å—ç¼–å†™æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£ï¼Œ å¹¶åœ¨ææµ‹å‰ç»„ç»‡æµ‹è¯•è¯„å®¡ä¼šè®®ï¼Œå¯¹å„åŠŸèƒ½å„ç¯èŠ‚è¿›è¡Œå¤æ ¸ä¸æŸ¥æ¼è¡¥ç¼º;
2. ä¸€æ¬¡ç‰ˆæœ¬ä»»åŠ¡å¯æ ¹æ®æƒ…å†µåˆ†å¤šæ¬¡è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œå¹¶ç¡®å®šæ¯è½®ææµ‹çš„å†…å®¹ä¸æ—¶é—´èŠ‚ç‚¹ï¼›
3. å•å…ƒæµ‹è¯•å®Œæˆåï¼Œéœ€åœ¨ä¸Šçº¿å‰è¿›è¡Œé›†æˆæµ‹è¯•ã€ç³»ç»Ÿæµ‹è¯•å’ŒéªŒæ”¶æµ‹è¯•;
4. æ¯è½®æµ‹è¯•å®Œæˆï¼Œéœ€å°†æµ‹è¯•ç»“è®ºé€šæŠ¥é¡¹ç›®ç›¸å…³äººå‘˜ï¼ˆé‚®ä»¶ï¼‰ï¼ŒåŒ…æ‹¬é—ç•™é—®é¢˜ä¸æ˜¯å¦è¾¾åˆ°ä¸Šçº¿è¦æ±‚ç»“è®º;

**æ³¨ï¼šäº§å“ç»ç†å¯åœ¨ææµ‹åå¯¹å¼€å‘å®ç°è¿›è¡ŒéªŒæ”¶ï¼Œä»¥ç¡®å®šå¼€å‘æ˜¯å¦ç¬¦åˆéœ€æ±‚å®é™…ï¼Œä»¥ä¾¿åŠæ—¶è¿›è¡Œè°ƒæ•´;**

**æœ¬é˜¶æ®µäº§å‡ºç‰©ä¸»è¦åŒ…å«:**

| åºå· | äº§å‡ºç‰©   | è´Ÿè´£äººæˆ–å›¢é˜Ÿ | å¤‡æ³¨ |
| ---- | -------- | ------------ | ---- |
| 1    | æµ‹è¯•æŠ¥å‘Š | æµ‹è¯•å›¢é˜Ÿ     |      |
| 2    | éªŒæ”¶æŠ¥å‘Š | æµ‹è¯•å›¢é˜Ÿ     |      |

---

### 3.7 äº§å“å‘å¸ƒ

1. äº§å“ç»ç†éœ€åœ¨ä¸Šçº¿å‰ç¼–å†™ã€Šäº§å“ä¸Šçº¿åŠŸèƒ½ã€èµ„æºåŠéªŒæ”¶æ¸…å•ã€‹ï¼Œ è®°å½•æ­¤æ¬¡ä¸Šçº¿å†…å®¹ã€èµ„æºéœ€æ±‚å’ŒéªŒæ”¶æ ‡å‡†ã€‚
2. é¡¹ç›®ç»ç†ç»„ç»‡ç›¸å…³äººå‘˜å¯¹æ­¤æ¬¡ä¸Šçº¿æ“ä½œè¿›è¡Œæ¨æ¼”ï¼Œå¯¹æ‰€æ¶‰åŠçš„æ‰€æœ‰æ“ä½œæŒ‰æ­¥éª¤è¿›è¡Œè®°å½•ï¼Œå¦‚æ•°æ®åº“æ“ä½œã€ä»£ç åˆå¹¶ã€æœåŠ¡å™¨èµ„æºåŠé…ç½®ç­‰ï¼Œå¯¹å¯èƒ½å­˜åœ¨çš„é—®é¢˜è¿›è¡Œå¤‡æ³¨åŠå¯¹åº”çš„å¤„ç†æ–¹æ¡ˆï¼Œå¹¶æäº¤æŠ€æœ¯ç›¸å…³è´Ÿè´£äººå®¡æŸ¥;
3. æŠ€æœ¯è´Ÿè´£äººç»“åˆæµ‹è¯•ç»“è®ºåŠå…¶å®ƒå„æ–¹é¢æƒ…å†µï¼Œå†³ç­–æ˜¯å¦ä¸Šçº¿ï¼Œå¹¶å°†æ„è§é€šçŸ¥åˆ°é¡¹ç›®ç›¸å…³äººå‘˜ï¼ˆé‚®ä»¶ï¼‰;
4. é¡¹ç›®ç»ç†ä¸äº§å“ç»ç†æŒ‰ç…§ä¸Šçº¿æ–¹æ¡ˆæ–‡æ¡£è®°å½•çš„æ­¥éª¤ï¼Œä¾æ¬¡å®Œæˆä¸Š çº¿æ“ä½œï¼ˆä¸Šçº¿æ“ä½œæœ€å¥½è‡³å°‘ç”±ä¸¤äººå®Œæˆï¼Œä¸€äººæ“ä½œï¼Œä¸€äººæ£€è§†ï¼Œé¿å…å‡ºé”™ï¼‰;
5. **ä¸Šçº¿å®Œæˆåï¼Œæµ‹è¯•äººå‘˜ä¸äº§å“ç»ç†å¯¹æ­¤æ¬¡ä¸Šçº¿è¿›è¡Œçº¿ä¸ŠéªŒè¯ï¼Œ ä¿çº¿ä¸ŠåŠŸèƒ½æµç¨‹æ— é—®é¢˜;**
6. éªŒè¯æ— è¯¯åï¼Œç”±äº§å“ç»ç†å°†ä¸Šçº¿é€šçŸ¥å‘å¸ƒè‡³åˆ©ç›Šç›¸å…³è€…ï¼ŒåŒ…æ‹¬é¡¹ç›®å›¢é˜Ÿæ‰€æœ‰æˆå‘˜åŠç›¸å…³åˆä½œæ–¹ï¼Œè¯´æ˜ä¸Šçº¿æ—¶é—´ã€ä¸Šçº¿å†…å®¹ã€å½±å“å› ç´ ã€ æ³¨æ„äº‹é¡¹ç­‰ (å¯¹å¤–æœ‰æ¡ä»¶å°±ä½¿ç”¨é‚®ä»¶, æ²¡æœ‰æ¡ä»¶ä½¿ç”¨é€šè®¯ç¾¤, å¯¹å†…ä½¿ç”¨é‚®ä»¶é€šçŸ¥ï¼‰;

**æ³¨ï¼šäº§å“ä¸Šçº¿å‰ä¸€å‘¨éœ€å†æ¬¡é€šè¿‡å„é€”å¾„æå‰å‘ŠçŸ¥ä¸šåŠ¡éƒ¨é—¨ã€å®¢æˆ· ç­‰ã€‚**

**æœ¬é˜¶æ®µäº§å‡ºç‰©ä¸»è¦åŒ…å«ï¼š**

| åºå· | äº§å‡ºç‰©                       | è´Ÿè´£äººæˆ–å›¢é˜Ÿ | å¤‡æ³¨ |
| ---- | ---------------------------- | ------------ | ---- |
| 1    | äº§å“ä¸Šçº¿åŠŸèƒ½ã€èµ„æºåŠéªŒæ”¶æ¸…å• | äº§å“ç»ç†     |      |
| 2    | äº§å“å‘å¸ƒé€šçŸ¥                 |              |      |

---

### 3.8 äº§å“åŸ¹è®­

äº§å“å‘å¸ƒä¸Šçº¿å‰åå‡éœ€è¦å¯¹å¹²ç³»äººè¿›è¡ŒåŸ¹è®­ï¼ŒåŸ¹è®­æ¬¡æ•°ä¸å°‘äº 2 æ¬¡ï¼Œåšåˆ°ï¼š

1. åŸ¹è®­çš„èŠ‚ç‚¹ï¼šäº§å“éœ€æ±‚è¯„å®¡ç»“æŸåå¼€å±•ç¬¬ä¸€è½®è®²è§£ï¼Œé˜è¿°è¯´æ˜æœ¬æ¬¡æ›´æ–°çš„è¦ç‚¹å’ŒåŠŸèƒ½è°ƒæ•´èŒƒå›´ã€å½±å“èŒƒå›´ä»¥åŠå‘å¸ƒæ—¶é—´ï¼Œå¹¶æ ¹æ®ä¸šåŠ¡äººå‘˜æˆ–å®¢æˆ·çš„åé¦ˆæ„è§è¿›è¡Œç›¸å…³è°ƒæ•´; ç‰ˆæœ¬å‘å¸ƒå‰ 3 å¤©ï¼Œå†æ¬¡é€šè¿‡é’‰é’‰ç›´æ’­æ–¹å¼å¯¹ ä¸šåŠ¡äººå‘˜ã€å®¢æˆ·ä¸šåŠ¡äººå‘˜ç­‰è¿›è¡ŒåŸ¹è®­è®²è§£ï¼ŒåŠŸèƒ½æ“ä½œæµç¨‹å’Œæ­¥éª¤ï¼Œå†æ¬¡å¼ºè°ƒåŠŸèƒ½è°ƒæ•´èŒƒå›´å’Œå½±å“èŒƒå›´;
2. å¯¹é‡è¦å®¢æˆ·å‘å¸ƒå‰å’Œå‘å¸ƒåè¿˜éœ€è¦å•ç‹¬è¿›è¡ŒåŸ¹è®­ä¸è®²è§£ï¼Œ ç¡®ä¿å®¢æˆ·å¯¹ç³»ç»Ÿçš„è°ƒæ•´äº†è§£å’Œèƒ½ç†Ÿç»ƒæŒæ¡ç³»ç»Ÿçš„ä½¿ç”¨ ï¼ˆæ­¤é¡¹ç”±äº§å“ç»ç†å’ŒæŠ€æœ¯å®æ–½å›¢é˜Ÿè´Ÿè´£ï¼‰;
3. åŸ¹è®­å‰ï¼Œå‡éœ€è¦åšå¥½åŸ¹è®­ææ–™çš„å‡†å¤‡å·¥ä½œï¼ˆå¦‚æœ¬æ¬¡ç‰ˆæœ¬å‡çº§çš„ ç›®æ ‡ã€åŠŸèƒ½è°ƒæ•´çš„å†…å®¹ã€å½±å“èŒƒå›´ã€å…·ä½“çš„ä¸šåŠ¡æµç¨‹å’Œæ“ä½œæ­¥ éª¤è¯´æ˜å’Œå‘å¸ƒæ—¶é—´ç­‰ï¼‰ï¼ŒåŸ¹è®­åå‡éœ€è¦è®°å½•åŸ¹è®­äººã€åŸ¹è®­å¯¹è±¡ã€ åŸ¹è®­å†…å®¹åŠåŸ¹è®­æ—¶é—´ç­‰å…³é”®ä¿¡æ¯ã€‚

**æœ¬é˜¶æ®µäº§å‡ºç‰©ä¸»è¦åŒ…å«ï¼š**

| åºå· | äº§å‡ºç‰©           | è´Ÿè´£äººæˆ–å›¢é˜Ÿ | å¤‡æ³¨ |
| ---- | ---------------- | ------------ | ---- |
| 1    | äº§å“åŸ¹è®­æ‰‹å†Œ     | äº§å“ç»ç†     |      |
| 2    | äº§å“åŸ¹è®­è®°å½•è¡¨æ ¼ | äº§å“ç»ç†     |      |

### 3.9 å¤ç›˜ä¸æŒç»­æ”¹å–„

ç‰ˆæœ¬ç»“æŸåï¼Œé¡¹ç›®ç»ç†æ ¹æ®æƒ…å†µå¯¹ä¸Šä¸ªå‘¨æœŸç»„ç»‡å¤ç›˜æ€»ç»“ä¼šï¼Œæ€»ç»“å­˜åœ¨çš„é—®é¢˜ä¸åŸå› ï¼ŒåŠåç»­è§„é¿çš„åŠæ³•ï¼Œæ€»ç»“ç§¯ç´¯çš„ç»éªŒç­‰ã€‚

**æœ¬é˜¶æ®µäº§å‡ºç‰©ä¸»è¦åŒ…å«ï¼š**

| åºå· | äº§å‡ºç‰©           | è´Ÿè´£äººæˆ–å›¢é˜Ÿ | å¤‡æ³¨           |
| ---- | ---------------- | ------------ | -------------- |
| 1    | å¤ç›˜æ€»ç»“ä¼šè®®çºªè¦ | é¡¹ç›®ç»ç†     | æ€»ç»“ä¼šè®®åäº§å‡º |
| 2    |                  |              |                |

ä»¥ä¸Šå„é˜¶æ®µå¹¶ä¸æ˜¯å®Œå…¨ä¸²è¡Œæ¨è¿›çš„ï¼Œç›¸äº’ä¹‹é—´å­˜åœ¨ä¸€äº›ç©¿æ’ï¼Œæ¯”å¦‚ä¸‹ä¸€ç‰ˆæœ¬éœ€æ±‚çš„æ”¶é›†æ•´ç†ä¸å½“å‰ç‰ˆæœ¬çš„å¼€å‘æ˜¯å¹¶è¡Œæ¨è¿›çš„ï¼Œå¼€å‘ä¸æµ‹è¯•ä¹Ÿå¯ä»¥ä»¥åˆ†é˜¶æ®µè½¬æµ‹çš„å½¢å¼å¹¶è¡Œæ¨è¿›ã€‚

---

### 3.10 å¼€å‘æµç¨‹ä¸­å„å²—ä½èŒè´£è¯´æ˜

|            | å¯åŠ¨ç«‹é¡¹                                                               | éœ€æ±‚è¯„å®¡/è®¡åˆ’æ’æœŸ                                             | è®¾è®¡ä¸å¼€å‘                                                                                                | æµ‹è¯•éªŒæ”¶                            | å‘å¸ƒä¸Šçº¿                                                                        | è€ƒæ ¸ä¸åŸ¹è®­                                               |
| ---------- | ---------------------------------------------------------------------- | ------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------- | ----------------------------------- | ------------------------------------------------------------------------------- | -------------------------------------------------------- |
| å†³ç­–å±‚     | å‚ä¼šå†³ç­– å¯è¡Œæ€§åˆ†æ ç»æµæ•ˆç›Šåˆ†æ ä¸‹è¾¾äº§å“å¼€å‘ä»»åŠ¡                      | å‚ä¼šå†³ç­–                                                      | å‚ä¼šå†³ç­– èµ„æºåè°ƒ è§„èŒƒç®¡æ§                                                                                | å‚ä¼šå†³ç­– è§„èŒƒç®¡æ§                   | å‚ä¼šå†³ç­– è§„èŒƒç®¡æ§                                                               | èµ„æºåè°ƒ                                                 |
| ä¸šåŠ¡éƒ¨é—¨   | æ”¶é›†å¹¶éªŒè¯å¸‚åœºéœ€æ±‚ æ•´ç†ä¸šåŠ¡/å®¢æˆ·éœ€æ±‚ å‚åŠ ä¼šè®®                          | ç¡®è®¤éœ€æ±‚è®¾è®¡æ–¹æ¡ˆ                                              | -                                                                                                         |                                     |                                                                                 | å‚åŠ åŸ¹è®­                                                 |
| æŠ€æœ¯è´Ÿè´£äºº | æŠ€æœ¯è·¯çº¿åˆ†æ äº§å“æ–¹æ¡ˆå»ºè®® ç»„ç»‡å¯è¡Œæ€§åˆ†æä¼šè®® æˆç«‹é¡¹ç›®å°ç»„ ä»»å‘½é¡¹ç›®ç»ç† | å‚åŠ ä¼šè®® åˆ¶å®šäº§å“è´¨é‡ç›®æ ‡ä¸è®¡åˆ’                               | èµ„æºåè°ƒ æ–¹æ¡ˆæŠŠæ§ è¿›åº¦ç®¡ç†                                                                                | å¯¹äº¤ä»˜ç»“æœè¿›è¡Œåˆ† æã€æ”¹è¿›           | äº¤ä»˜æ ¸æŸ¥                                                                        | ç»„ç»‡å›¢é˜Ÿé¡¹ç›®æ€» ç»“ä¼šè®®                                    |
| é¡¹ç›®ç»ç†   | ç¼–åˆ¶ç«‹é¡¹æŠ¥å‘Š å¬å¼€é¡¹ç›®å°ç»„å‘¨ä¾‹ä¼š                                        | å‚åŠ éœ€æ±‚è¯„å®¡ä¼š æŠ€æœ¯å¯è¡Œæ€§ç»¼åˆè¯„ä¼° ç¼–åˆ¶ã€Šé¡¹ç›® WBS åŠè¿›åº¦ç®¡ç†ã€‹ | ç¼–åˆ¶ã€Šè¯¦ç»†è®¾è®¡ã€‹ ç»„ç»‡è®¾è®¡è¯„å®¡ ç«™ç«‹ä¼š/å‘¨ä¾‹ä¼š é¡¹ç›® WBS åŠè¿›åº¦ ç®¡ç† é¡¹ç›®è¿›å±•æŠ¥å‘Š Code review, é—®é¢˜ä¸é£é™©ç®¡æ§ | åŠŸèƒ½æ ¸éªŒ                            | ä¸Šçº¿æ¨æ¼” é¢„ä¸Šçº¿å‘å¸ƒ                                                             | å›¢é˜Ÿç»©æ•ˆè€ƒæ ¸ äº§å“å¤ç›˜æ€»ç»“ æŒç»­ä¼˜åŒ–è®¡åˆ’                   |
| äº§å“ç»ç†   | éœ€æ±‚æ”¶é›†ä¸æ•´ç† äº§å“è®¾è®¡è§£å†³æ–¹æ¡ˆ                                        | ç»„ç»‡éœ€æ±‚è¯„å®¡ä¼šè®® è¾“å‡ºéœ€æ±‚è®¾è®¡æ–‡æ¡£                             | äº§å“åŸå‹ã€PRD åŠäº¤äº’ è®¾è®¡ é˜¶æ®µæ€§åŠŸèƒ½æ ¸éªŒ                                                                  | åŠŸèƒ½æ ¸éªŒ                            | ä¸Šçº¿æ¨æ¼” æ ¹æ®ã€Šäº§å“ä¸Šçº¿åŠŸ èƒ½ã€èµ„æºåŠéªŒæ”¶æ¸… å•ã€‹æ ¸éªŒ ç¼–åˆ¶ã€Šäº§å“å‘å¸ƒé€š çŸ¥ã€‹å¹¶å‘å¸ƒ | ç¼–å†™åŸ¹è®­æ‰‹å†Œ ç»„ç»‡äº§å“åŸ¹è®­ ç¼–å†™ç”¨æˆ·æ‰‹å†Œ æŒç»­ä¼˜åŒ–éœ€æ±‚æ•´ ç† |
| UI è®¾è®¡    | -                                                                      | å‚åŠ ä¼šè®®                                                      | äº§å“ UI è®¾è®¡                                                                                              | UI ç•Œé¢æ ¸éªŒ                         | UI ç•Œé¢éªŒæ”¶                                                                     | -                                                        |
| å¼€å‘å›¢é˜Ÿ   | -                                                                      | å‚åŠ ä¼šè®®                                                      | ç¼–åˆ¶ã€Šè¯¦ç»†è®¾è®¡ã€‹ ç³»ç»Ÿå¼€å‘ å•å…ƒæµ‹è¯•                                                                        | ä¿®å¤ bugs ä»£ç ä¼˜åŒ–æ”¹è¿›              | æŒç»­ä¿®å¤ã€æ”¹è¿›                                                                  | -                                                        |
| æµ‹è¯•å›¢é˜Ÿ   | -                                                                      | å‚åŠ ä¼šè®®                                                      | ç¼–åˆ¶ã€Šæµ‹è¯•è®¡åˆ’ã€‹ ç¼–åˆ¶ã€Šæµ‹è¯•ç”¨ä¾‹ã€‹                                                                         | å•å…ƒæµ‹è¯• é›†æˆæµ‹è¯• ç³»ç»Ÿæµ‹è¯• éªŒæ”¶æµ‹è¯• | æµ‹è¯•æŠ¥å‘Š éªŒæ”¶æŠ¥å‘Š                                                               | -                                                        |

---

## 4.é¡¹ç›®ç®¡ç†å·¥å…·

ä¸ºäº†æé«˜é¡¹ç›®ç®¡ç†æ•ˆç‡, é‡åŒ–æ¯ä¸€ä¸ªé˜¶æ®µå„å²—ä½äººå‘˜çš„å·¥ä½œ, éœ€è¦è®°å½•å¼€å‘è¿‡ç¨‹ä¸­è¾“å‡ºäº§ç‰©ä¸è®¡åˆ’å®‰æ’, ç°è§„å®šä½¿ç”¨ **ç»´æ ¼è¡¨ + NAS åä½œ** çš„æ–¹å¼è¿›è¡Œå¼€å‘è¿‡ç¨‹ç®¡ç†.

### 4.1 ç»´æ ¼è¡¨

#### 4.1.1 é¡¹ç›®åˆ†ç±»

##### 4.1.1.1 ä¸šåŠ¡çº¿

##### 4.1.1.2 ä¸šåŠ¡ä¸­å°

##### 4.1.1.3 å…¶ä»–

#### 4.1.2 é¡¹ç›®ç»“æ„

| æ¨¡å—         | è´Ÿè´£äºº      | æ·»åŠ æ—¶é—´                               | å¤‡æ³¨                                |
| ------------ | ----------- | -------------------------------------- | ----------------------------------- |
| é¡¹ç›®æ€»é‡Œç¨‹ç¢‘ | äº§å“ç»ç†    | é¡¹ç›®ç«‹é¡¹                               | é¡¹ç›®ç«‹é¡¹ä¹‹åæ·»åŠ                     |
| äº§å“ç‰ˆæœ¬ç®¡ç† | äº§å“ç»ç†    | éœ€æ±‚ç¡®è®¤å                             |                                     |
| è¿­ä»£ç‰ˆæœ¬ç®¡ç† | äº§å“ç»ç†    | éœ€æ±‚ç¡®è®¤å                             |                                     |
| äº§å“éœ€æ±‚ç®¡ç† | äº§å“ç»ç†    | å®¢æˆ·åé¦ˆ/ä¼˜åŒ–                          |                                     |
| å¼€å‘ä»»åŠ¡ç®¡ç† | å¼€å‘ Leader | éœ€æ±‚è¯„å®¡å®Œæˆå 1 å‘¨å†… (è¿‡ç¨‹ä¸­å®æ—¶æ›´æ–°) | æŒ‰ç‰ˆæœ¬æ·»åŠ ä¸éœ€æ±‚å…³è”çš„å¼€å‘ä»»åŠ¡      |
| æµ‹è¯•ç”¨ä¾‹ç®¡ç† | æµ‹è¯• Leader | éœ€æ±‚è¯„å®¡å®Œæˆå 1 å‘¨å†…                  | æŒ‰ç‰ˆæœ¬æ·»åŠ ä¸éœ€æ±‚å…³è”çš„æµ‹è¯•ç”¨ä¾‹      |
| BUG ç¼ºé™·ç®¡ç† | æµ‹è¯• Leader | æµ‹è¯•ç»“æœä¸ç¬¦åˆé¢„æœŸ                     | æŒ‰ç‰ˆæœ¬æ·»åŠ ä¸æµ‹è¯•ç”¨ä¾‹å…³è”çš„ BUG è®°å½• |
|              |             |                                        |                                     |
| é¡¹ç›®         | é¡¹ç›®ç»ç†    |                                        | å¯¹æ•´ä¸ªé¡¹ç›®è¿‡ç¨‹ç®¡æ§å’Œè´¨é‡ç®¡æ§è´Ÿè´£    |

---

### 4.2 NAS åä½œ

NAS ä½œä¸ºåä½œç¼–è¾‘ä¸æ–‡æ¡£å½’æ¡£å¤‡ä»½çš„å·¥å…·, å¯ä¸ä»–äººå¯¹åŒä¸€ä»½æ–‡æ¡£è¿›è¡Œå†™ä½œç¼–è¾‘, æœ‰æ•ˆè§£å†³ä½¿ç”¨é€šè®¯å·¥å…·å‘é€æ–‡æ¡£å‰¯æœ¬å¸¦æ¥çš„å·¥ä½œè´Ÿæ‹…, ç›®å‰ä»¥ä¸ºæŠ€æœ¯ä¸­å¿ƒæ‰€æœ‰äººå¼€é€šäº†è´¦å·, ç°å°†å¼€å§‹åœ¨æŠ€æœ¯ä¸­å¿ƒæ¨è¡Œ NAS çš„ä½¿ç”¨.

ä»¥åŸæœäº‹ä¸šéƒ¨ä¸ºä¾‹, è¯´æ˜ç›®å½•ç»“æ„

#### 4.2.1 ç›®å½•ç»“æ„

```
.
â”œâ”€â”€ 01 é¡¹ç›®ä¸€
â”œâ”€â”€ 02 é¡¹ç›®äºŒ
â”‚Â Â  â”œâ”€â”€ 00 ç«å“åˆ†æ
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 1 æœˆ
â”‚Â Â  â”‚Â Â  â””â”€â”€ ç«å“åˆ†æç»“æ„æ¢³ç†.xmind
â”‚Â Â  â”œâ”€â”€ 01 è®¡åˆ’é˜¶æ®µ
â”‚Â Â  â”‚Â Â  â””â”€â”€ 01 é¡¹ç›®ä¿¡æ¯è¡¨
â”‚Â Â  â”œâ”€â”€ 02 éœ€æ±‚é˜¶æ®µ
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 01 éœ€æ±‚æ”¶é›†
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 02 éœ€æ±‚æ–‡æ¡£
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ v1.0.0
â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ éœ€æ±‚è§„æ ¼è¯´æ˜ä¹¦.docx
â”‚Â Â  â”‚Â Â  â””â”€â”€ 03 éœ€æ±‚è¯„å®¡
â”‚Â Â  â”‚Â Â      â”œâ”€â”€ v1.0.0
â”‚Â Â  â”‚Â Â      â”œâ”€â”€ v1.0.1
â”‚Â Â  â”‚Â Â      â”œâ”€â”€ v1.1.0
â”‚Â Â  â”‚Â Â      â””â”€â”€ v2.0.0
â”‚Â Â  â”œâ”€â”€ 03 è®¾è®¡é˜¶æ®µ
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 00 UI è®¾è®¡
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ v1.0.0
â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ è¯„å®¡ä¼šè®®çºªè¦
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 01 åŠŸèƒ½è®¾è®¡
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ v1.0.0
â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ åŠŸèƒ½è®¾è®¡è¯´æ˜ä¹¦.docx
â”‚Â Â  â”‚Â Â  â””â”€â”€ 02 æŠ€æœ¯è¯„å®¡
â”‚Â Â  â”‚Â Â      â””â”€â”€ v1.0.0
â”‚Â Â  â”‚Â Â   Â Â      â””â”€â”€ è¯„å®¡ä¼šè®®çºªè¦
â”‚Â Â  â”œâ”€â”€ 04 å¼€å‘é˜¶æ®µ
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 01 ä»£ç è¯„å®¡
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ v1.0.0
â”‚Â Â  â”‚Â Â  â”‚ Â Â     â””â”€â”€ è¯„å®¡ä¼šè®®çºªè¦
â”‚Â Â  â”‚Â Â  â””â”€â”€ 02 ææµ‹æŠ¥å‘Š
â”‚Â Â  â”‚Â Â      â””â”€â”€ v1.0.0
â”‚Â Â  â”‚Â Â          â””â”€â”€ ç³»ç»Ÿææµ‹ç”³è¯·å•.xlsx
â”‚Â Â  â”œâ”€â”€ 05 æµ‹è¯•é˜¶æ®µ
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 01 æµ‹è¯•ç”¨ä¾‹
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ v1.0.0
â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ è¯„å®¡ä¼šè®®çºªè¦
â”‚Â Â  â”‚Â Â  â””â”€â”€ 02 æµ‹è¯•æŠ¥å‘Š
â”‚Â Â  â”‚Â Â      â””â”€â”€ v1.0.0
â”‚Â Â  â”‚Â Â          â””â”€â”€ 2024-03-04
â”‚Â Â  â”‚Â Â          Â Â   â””â”€â”€ ç³»ç»Ÿæµ‹è¯•æŠ¥å‘Š.docx
â”‚Â Â  â”œâ”€â”€ 06 ä¸Šçº¿é˜¶æ®µ
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 01 éƒ¨ç½²è¯´æ˜
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ v1.0.0
â”‚Â Â  â”‚Â Â  â””â”€â”€ 02 è¿ç»´æ‰‹å†Œ
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ v1.0.0
â”‚Â Â  â”œâ”€â”€ 07 éªŒæ”¶é˜¶æ®µ
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 01 ä½¿ç”¨æ‰‹å†Œ
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ v1.0.0
â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ ç³»ç»Ÿä½¿ç”¨æ‰‹å†Œ.docx
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 02 åŸ¹è®­æ–‡æ¡£
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ v1.0.0
â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ åŸ¹è®­æ–‡æ¡£.pptx
â”‚Â Â  â”‚Â Â  â””â”€â”€ 03 éªŒæ”¶æŠ¥å‘Š
â”‚Â Â  â”‚Â Â      â””â”€â”€ v1.0.0
â”‚Â Â  â”‚Â Â          â””â”€â”€ ç³»ç»Ÿç«£å·¥æŠ¥å‘Š.docx
â”‚Â Â  â”œâ”€â”€ 08 é¡¹ç›®å¤ç›˜
â”‚Â Â  â”‚Â Â  â””â”€â”€ v1.0.0
â”‚Â Â  â”‚Â Â   Â Â      â””â”€â”€ ä¼šè®®çºªè¦
â”‚Â Â  â”œâ”€â”€ 09 é¡¹ç›®ç®¡ç†
â”‚Â Â  â”‚Â Â  â””â”€â”€ v1.0.0
â”‚Â Â  â”‚Â Â      â”œâ”€â”€ ä¼šè®®çºªè¦.docx
â”‚Â Â  â”‚Â Â      â”œâ”€â”€ é¡¹ç›®å‘¨æŠ¥.xlsx
â”‚Â Â  â”‚Â Â      â”œâ”€â”€ é¡¹ç›®æœˆæŠ¥.xlsx
â”‚Â Â  â”‚Â Â      â””â”€â”€ é¡¹ç›®è¿›åº¦ç®€æŠ¥.docx
â”‚Â Â  â”œâ”€â”€ 10 æ‹›æŠ•æ ‡
â”‚Â Â  â””â”€â”€ 11 å®æ–½
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 01 é¡¹ç›®å®æ–½æ–¹æ¡ˆ
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 02 é¡¹ç›®å®æ–½è¿›åº¦è®¡åˆ’
â”‚Â Â  â”‚Â Â  â””â”€â”€ 03 é¡¹ç›®å®æ–½è¿›åº¦ç®€è¡¨
â”‚Â Â  â””â”€â”€ 12 å…¶ä»–èµ„æ–™
â””â”€â”€ 03 é¡¹ç›®ä¸‰
```

#### 4.2.2 ç›®å½•å†…å®¹

| ç›®å½•        | å†…å®¹                                         | è´Ÿè´£äºº            | è¾“å‡ºæ—¶é—´                   | å¤‡æ³¨           |
| ----------- | -------------------------------------------- | ----------------- | -------------------------- | -------------- |
| 00 ç«å“åˆ†æ | åˆ†æåŒç±»äº§å“, äº†è§£è¡Œä¸šåŠ¨æ€                   | äº§å“ç»ç†          | æ¯æœˆè¾“å‡ºè‡³å°‘ 1 ç¯‡          | ç»„ç»‡åˆ†äº«       |
| 01 è®¡åˆ’é˜¶æ®µ | é¡¹ç›®ä¿¡æ¯è¡¨ (é¡¹ç›®ä¿¡æ¯,ç›¸å…³å¹²ç³»äººç­‰)           | é¡¹ç›®ç»ç†          | é¡¹ç›®ç«‹é¡¹å, æ¯å‘¨æ›´æ–°       | -              |
| 02 éœ€æ±‚é˜¶æ®µ | éœ€æ±‚è§„æ ¼è¯´æ˜ä¹¦, éœ€æ±‚è¯„å®¡ä¼šè®®çºªè¦             | äº§å“ç»ç†          | éœ€æ±‚æ•´ç†å®Œæˆåè¾“å‡º         | æŒ‰ç‰ˆæœ¬åˆ†å­ç›®å½• |
| 03 è®¾è®¡é˜¶æ®µ | è½¯ä»¶åŠŸèƒ½è¯¦ç»†è®¾è®¡ æŠ€æœ¯æ–¹æ¡ˆè¯„å®¡ä¼šè®®è®°å½•        | å¼€å‘ Leader       | å¼€å‘æ ¹æ®éœ€æ±‚å¤§å°ç¡®è®¤æ—¶é—´   | æŒ‰ç‰ˆæœ¬åˆ†å­ç›®å½• |
| 04 å¼€å‘é˜¶æ®µ | ææµ‹æŠ¥å‘Š ä»£ç è¯„å®¡                            | å¼€å‘ Leader       | ææµ‹é‚®ä»¶å‘å‡ºå‰ ä¸Šçº¿å‰ 2 å¤© | æŒ‰ç‰ˆæœ¬åˆ†å­ç›®å½• |
| 05 æµ‹è¯•é˜¶æ®µ | æµ‹è¯•æŠ¥å‘Š                                     | æµ‹è¯• Leader       | æ¯å‘¨æ€»ç»“æ€§è¾“å‡º             | ç‰ˆæœ¬ + å‘¨      |
| 06 ä¸Šçº¿é˜¶æ®µ | éƒ¨ç½²æ‰‹å†Œ è¿ç»´æ‰‹å†Œ                            | é¡¹ç›®ç»ç†          | ä¸Šçº¿å‰ 1 å¤©                | æŒ‰ç‰ˆæœ¬åˆ†å­ç›®å½• |
| 07 éªŒæ”¶é˜¶æ®µ | ä½¿ç”¨æ‰‹å†Œ åŸ¹è®­æ–‡æ¡£ éªŒæ”¶æŠ¥å‘Š                   | é¡¹ç›®ç»ç† äº§å“ç»ç† | ä¸Šçº¿å 2 å¤©å†…              | æŒ‰ç‰ˆæœ¬åˆ†å­ç›®å½• |
| 08 é¡¹ç›®å¤ç›˜ | é¡¹ç›®å¤ç›˜è®°å½•                                 | é¡¹ç›®ç»ç†          | ä¸Šçº¿å 2 å¤©å†…              | æŒ‰ç‰ˆæœ¬åˆ†å­ç›®å½• |
| 09 é¡¹ç›®ç®¡ç† | é¡¹ç›®è¿‡ç¨‹ç®¡ç†æ–‡æ¡£                             | é¡¹ç›®ç»ç†          | æ¯å‘¨æ›´æ–°                   | æŒ‰ç‰ˆæœ¬åˆ†å­ç›®å½• |
| 10 æ‹›æŠ•æ ‡   | é¡¹ç›®æ‹›æŠ•æ ‡æ–‡ä»¶ (æŠ¹é™¤æ•æ„Ÿä¿¡æ¯)                | é¡¹ç›®ç»ç†          | -                          | -              |
| 11 å®æ–½     | å®æ–½æ–¹æ¡ˆ å®æ–½è¿›åº¦è®¡åˆ’ å®æ–½è¿›åº¦ç®€æŠ¥           | é¡¹ç›®ç»ç†          | æ¯å‘¨æ›´æ–°                   | -              |
| 12 å…¶ä»–èµ„æ–™ | é¡¹ç›®ç›¸å…³çš„å…¶ä»–èµ„æ–™, æ¯”å¦‚ä¸šå†…è§„èŒƒ, å‚è€ƒèµ„æ–™ç­‰ | é¡¹ç›®ç»ç†          | -                          | -              |

---

## 5. ç»©æ•ˆè€ƒæ ¸ä½“ç³»è®¾è®¡

### 5.1 ç»©æ•ˆè¯„ä»·æŒ‡æ ‡

æ ¹æ®å„ä¸ªå²—ä½è®¾ç½®ä¸åŒçš„è€ƒæ ¸æŒ‡æ ‡, å…·ä½“åˆ†ä¸ºç®¡ç†å²—, äº§å“å²—, å¼€å‘å²—, æµ‹è¯•å²—, è¿ç»´å²—å’Œå®æ–½å²—ä½.

### 5.2 ç»©æ•ˆè¯„ä»·å‘¨æœŸ

æœˆåˆ

### 5.3 ç»©æ•ˆè¯„ä»·æ–¹æ³•

è‡ªè¯„ + ä¸Šçº§è€ƒè¯„

### 5.4 ç»©æ•ˆè€ƒæ ¸æµç¨‹

1. è®¾å®šç»©æ•ˆç›®æ ‡
2. æ”¶é›†æ•°æ®å’Œä¿¡æ¯
3. ç»©æ•ˆè¯„ä»·
4. åé¦ˆä¸æ”¹è¿›

---

## 6. ç»©æ•ˆè€ƒæ ¸æ ‡å‡†

### 6.1 æŒ‡æ ‡åˆ†ç±»

é™¤ **ç®¡ç†å›¢é˜Ÿ** å¤–, å…¶ä»–å²—ä½ä½¿ç”¨ä»¥ä¸‹æŒ‡æ ‡:

| æŒ‡æ ‡         | æƒé‡ | å¤‡æ³¨                   |
| ------------ | ---- | ---------------------- |
| å·¥ä½œä¸šç»©     | 70%  | æŒ‰å²—ä½ç»†åˆ†             |
| å²—ä½èƒœä»»èƒ½åŠ› | 15%  | å²—ä½é€šç”¨               |
| å·¥ä½œæ€ åº¦    | 15%  | å²—ä½é€šç”¨               |
| é»‘çº¢äº‹ä»¶     | -    | é¢å¤–åŠ å‡åˆ†é¡¹, å²—ä½é€šç”¨ |

**æ€»åˆ† = è‡ªè¯„æ€»åˆ† (å·¥ä½œä¸šç»©æ€»åˆ† + å²—ä½èƒœä»»èƒ½åŠ›æ€»åˆ† + å·¥ä½œæ€åº¦æ€»åˆ†) _ 30% + ä¸Šçº§è¯„åˆ† (å·¥ä½œä¸šç»©æ€»åˆ† + å²—ä½èƒœä»»èƒ½åŠ›æ€»åˆ† + å·¥ä½œæ€åº¦æ€»åˆ†) _ 70% + é»‘çº¢äº‹ä»¶æ€»åˆ†**

---

#### 6.1.1 å²—ä½èƒœä»»èƒ½åŠ›

##### 1. è§£å†³é—®é¢˜èƒ½åŠ›

- **5 åˆ†**ï¼Œå…·å¤‡å¾ˆå¼ºçš„ä¸“ä¸šæŠ€æœ¯çŸ¥è¯†ï¼Œèƒ½å¤Ÿå¿«é€Ÿã€å‡†ç¡®çš„å®šä½é—®é¢˜ã€æä¾›è‰¯å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œæ€»èƒ½ä»¥è¶…å‡ºæœŸæœ›çš„æ—¶é—´å’ŒåŠæ³•è§£å†³é‡åˆ°çš„é—®é¢˜ï¼Œå¹¶èƒ½åœ¨å·¥ä½œä¸­æå‡ºå»ºè®¾æ€§å»ºè®®ï¼›
- **4 åˆ†**ï¼Œå¯¹ä¸å·¥ä½œç›¸å…³çš„ä¸“ä¸šçŸ¥è¯†å……åˆ†äº†è§£ï¼Œå¯¹äºæŠ€æœ¯æˆ–äº§å“æˆ–ä¸šåŠ¡ç­‰æ–¹é¢çš„é—®é¢˜ï¼Œèƒ½å¿«é€Ÿçš„å®šä½å¹¶æä¾›è‰¯å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œèƒ½åŠæ—¶ã€æœ‰æ•ˆåœ°è§£å†³é‡åˆ°çš„é—®é¢˜ï¼›
- **3 åˆ†**ï¼ŒåŸºæœ¬å…·å¤‡ä¸å·¥ä½œç›¸å…³çš„ä¸“ä¸šçŸ¥è¯†ï¼Œæœ‰æ—¶ä¸èƒ½åŠæ—¶ã€æœ‰æ•ˆåœ°è§£å†³é‡åˆ°çš„é—®é¢˜ï¼Œä½†ä¸å½±å“åä½œè¿›ç¨‹ï¼›
- **2 åˆ†**ï¼Œä¸å·¥ä½œç›¸å…³çš„ä¸“ä¸šçŸ¥è¯†æœ‰ä¸€å®šæŒæ¡ï¼Œéœ€åœ¨é¢†å¯¼æˆ–åŒäº‹çš„é…åˆååŠ©ä¸‹ï¼Œå®šä½å¹¶å¤„ç†é—®é¢˜ï¼Œå¤„ç†ç»“æœè´¨é‡ä¸€èˆ¬ï¼›
- **1 åˆ†**ï¼Œä¸å·¥ä½œç›¸å…³çš„ä¸“ä¸šçŸ¥è¯†ä¸å¤Ÿäº†è§£ï¼Œåœ¨å„æ–¹ååŠ©ä¸‹ï¼Œèƒ½å¤„ç†è§£å†³é—®é¢˜ï¼Œä½†æ˜¯ç»“æœä¸ç†æƒ³ï¼›
- **0 åˆ†**ï¼Œä¸“ä¸šçŸ¥è¯†ä¸ç†Ÿã€å¯¹äº§å“ã€ä¸šåŠ¡ä¸äº†è§£ï¼Œè§£å†³é—®é¢˜èƒ½åŠ›è¾ƒå·®ï¼Œæ— æ³•å¤„ç†æˆ–è§£å†³é—®é¢˜ï¼›

---

##### 2. åè°ƒèƒ½åŠ›

- **5 åˆ†**ï¼Œå–„äºåè°ƒå„ç§å…³ç³»ï¼Œä¸ºé¡ºåˆ©å®Œæˆå·¥ä½œå°½å¿ƒå°½åŠ›ï¼›ä¹äºå…³å¿ƒå¸®åŠ©ä»–äººï¼Œä¸äººåˆä½œèæ´½ï¼Œæœ‰å¾ˆå¼ºçš„å›¢é˜Ÿç²¾ç¥ï¼Œèƒ½å¤Ÿä¸»åŠ¨åˆ†äº«æŠ€æœ¯ã€ä¸šåŠ¡ç»éªŒï¼›èƒ½ä¸»åŠ¨ä¸é…åˆéƒ¨é—¨åè°ƒå·¥ä½œï¼ŒåŠæ—¶è°ƒåŠ¨éƒ¨é—¨èµ„æºï¼Œæ— æ‹–å»¶ä¸æŠµè§¦ï¼Œä¸éœ€å‚¬åŠå³å¯åä½œå·¥ä½œå®Œæˆä»»åŠ¡ï¼›èƒ½ç‰µå¤´å®ŒæˆæŸäº›éœ€è¦ä»–äººé…åˆçš„å·¥ä½œï¼Œä¸”å·¥ä½œç»“æœä¼˜å¼‚ï¼›
- **4 åˆ†**ï¼Œçˆ±æŠ¤å›¢ä½“ï¼Œç»å¸¸ååŠ©åŒäº‹ï¼Œä¹æ„ä¸ºç¾¤ä½“åšè´¡çŒ®ï¼›èƒ½å¤Ÿå…³å¿ƒä»–äººï¼Œå¹¶å»ºç«‹è‰¯å¥½å…³ç³»ï¼Œæ³¨é‡é›†ä½“åˆ©ç›Šï¼ŒåŸºæœ¬èƒ½å¤Ÿåœ¨å„æ–¹é¢åšåˆ°å–é•¿è¡¥çŸ­ï¼Œèƒ½ä¸»åŠ¨ä¸é…åˆéƒ¨é—¨åè°ƒå·¥ä½œï¼Œä¸æ‹–å»¶ä¸æŠµè§¦çš„åä½œå®Œæˆå·¥ä½œä»»åŠ¡ï¼›
- **3 åˆ†**ï¼Œèƒ½ä¸éƒ¨é—¨å†…åŒäº‹å»ºç«‹è‰¯å¥½å…³ç³»ï¼Œèƒ½ä¸éƒ¨é—¨å†…åŒäº‹åè°ƒå¤„ç†å®Œæˆç›¸åº”çš„å·¥ä½œï¼Œå°šæœ‰é…åˆæ„è¯†ï¼Œè™½å¶æœ‰æ„è§å¼‚è®®ä½†åŸºæœ¬èƒ½åä½œå·¥ä½œã€å®Œæˆä»»åŠ¡ï¼›
- **2 åˆ†**ï¼Œåè°ƒèƒ½åŠ›ä¸€èˆ¬ï¼Œä¸è‚¯ä¸»åŠ¨ä¸äººåˆä½œï¼Œé…åˆæ„è¯†ä¸å¼ºï¼Œéœ€æœ‰äººç£ä¿ƒï¼Œæ–¹èƒ½åä½œå·¥ä½œã€å®Œæˆä»»åŠ¡ï¼›
- **1 åˆ†**ï¼Œä»…åœ¨å¿…é¡»åè°ƒèƒ½åŠ›çš„å·¥ä½œä¸Šä¸äººåˆä½œï¼›
- **0 åˆ†**ï¼Œåè°ƒèƒ½åŠ›æå·®ï¼Œä¸¥é‡å½±å“åˆ°å·¥ä½œã€‚

---

##### 3. æ²Ÿé€šèƒ½åŠ›

- **5 åˆ†**ï¼Œå–„äºä¸äººæ²Ÿé€šä¸”äº²å’ŒåŠ›å¼ºï¼Œæ€åº¦è¯šæ³éå¸¸æ˜“è¢«äººæ¥å—ï¼Œèƒ½ç§¯ææœ‰æ•ˆçš„æ¨åŠ¨ä¸šåŠ¡æˆ–é—®é¢˜è§£å†³ï¼Œèƒ½å¿«é€Ÿä¸ä»–äººè¾¾æˆç†è§£ï¼Œå¹¶å»ºç«‹è‰¯å¥½çš„åˆä½œå…³ç³»ï¼›å¯¹ä¸åŒçš„äººï¼Œèƒ½ç”¨ä¸åŒçš„æ–¹å¼å’Œæªè¾è®©ä»–äººå¿«é€Ÿç†è§£è‡ªå·±çš„è§‚ç‚¹æˆ–è§£é‡Šï¼›
- **4 åˆ†**ï¼Œä¸äººæ²Ÿé€šèƒ½åŠ›è‰¯å¥½ï¼Œè¯´æœåŠ›è‰¯å¥½ï¼Œæ€åº¦è¯šæ³æ˜“è¢«äººæ¥å—ï¼Œä¸€èˆ¬æƒ…å†µä¸‹èƒ½é€šè¿‡äº¤æµæ²Ÿé€šä¸ä»–äººè¾¾æˆä¸€è‡´ï¼Œèƒ½æ¨åŠ¨äº‹æƒ…é¡ºåˆ©è§£å†³ï¼›èƒ½å¿«é€Ÿå‡†ç¡®æ•æ‰å¹¶ç†è§£ä»–äººè®²è¯å†…å®¹ä¸­çš„é‡ç‚¹ï¼›
- **3 åˆ†**ï¼Œä¸äººæ²Ÿé€šè¯´æœåŠ›å°šå¯ï¼Œæ€åº¦è¯šæ³æ˜“è¢«äººæ¥å—ï¼ŒåŸºæœ¬èƒ½ä¸ä»–äººè¿›è¡Œæ²Ÿé€šå®Œæˆå·¥ä½œä»»åŠ¡ï¼›
- **2 åˆ†**ï¼Œä¸äººæ²Ÿé€šè¯´æœåŠ›ä¸€èˆ¬ï¼Œæœ‰ä¸€å®šæŠ€å·§ï¼ŒåŸºæœ¬èƒ½å¤Ÿæ¥å—ï¼Œå¯¹äº‹æƒ…èµ·ä¸åˆ°å®è´¨æ€§çš„æ¨åŠ¨ä½œç”¨ï¼›
- **1 åˆ†**ï¼Œä¸äººæ²Ÿé€šè¯´æœåŠ›è¾ƒå·®ï¼Œä¸å–„äºå¼•å¯¼ï¼Œæœ‰æ—¶ä¸æ˜“è¢«äººæ¥å—ï¼›
- **0 åˆ†**ï¼Œä¸äººæ²Ÿé€šæ€åº¦ç”Ÿç¡¬ï¼Œç¼ºä¹æ²Ÿé€šæŠ€å·§ï¼Œéš¾ä»¥è¢«äººæ¥å—

---

#### 6.1.2 å·¥ä½œæ€åº¦

##### 1. å“åº”é€Ÿåº¦

- **5 åˆ†**ï¼Œå¯¹äºå¸‚åœºã€å®¢æˆ·æˆ–åŒäº‹æå‡ºçš„é—®é¢˜ï¼Œæ¯æ¬¡è¯·æ±‚å‡å¾—åˆ°åŠæ—¶å“åº”ï¼Œä¸éœ€ç£ä¿ƒä¾¿èƒ½é«˜è´¨ã€é«˜é‡å®Œæˆåˆ†å†…å·¥ä½œï¼Œèƒ½å¤ŸåŠæ—¶çš„ã€ç§¯æçš„å“åº”ã€åé¦ˆå’Œè·Ÿè¿›ï¼Œå¦‚é‚®ä»¶ã€ç”µè¯ä»¥åŠå„ç±»ç¾¤é‡Œ@çš„å“åº”é€Ÿåº¦ã€å›å¤é€Ÿåº¦å’Œé—®é¢˜è§£å†³é€Ÿåº¦ï¼Œä»»åŠ¡å®Œæˆåä¸»åŠ¨æ±‡æŠ¥é—®é¢˜è§£å†³æƒ…å†µç­‰ï¼Œå¹¶èƒ½å¯¹é—®é¢˜æ€»ç»“æ•´ç†å½’æ¡£çš„ï¼›
- **4 åˆ†**ï¼Œå¯¹äºå¸‚åœºã€å®¢æˆ·æˆ–åŒäº‹æå‡ºçš„é—®é¢˜ï¼Œèƒ½å¤ŸåŠæ—¶çš„å“åº”ã€å›å¤å¹¶å¿«é€Ÿçš„è§£å†³é—®é¢˜ï¼Œè´¨é‡è¾ƒé«˜ï¼›
- **3 åˆ†**ï¼Œå¯¹äºå¸‚åœºã€å®¢æˆ·æˆ–åŒäº‹æå‡ºçš„é—®é¢˜ï¼Œè™½æœ‰å¼‚è®®ä½†èƒ½æ»¡è¶³åŸºæœ¬çš„å“åº”éœ€æ±‚ï¼Œå®Œæˆåˆ†å†…å·¥ä½œï¼› 2 åˆ†ï¼Œå¯¹äºå¸‚åœºã€å®¢æˆ·æˆ–åŒäº‹æå‡ºçš„é—®é¢˜ï¼Œéœ€åœ¨é¢†å¯¼çš„æé†’å’Œç£ä¿ƒä¸‹æ‰å“åº”å’Œå¤„ç†ï¼Œå“åº”é€Ÿåº¦ï¼ˆ3 ä¸ªå°æ—¶å†…ï¼‰ã€å›å¤å’Œé—®é¢˜å¤„ç†é€Ÿåº¦è¾ƒæ…¢ï¼›
- **1 åˆ†**ï¼Œå¯¹äºå¸‚åœºã€å®¢æˆ·æˆ–åŒäº‹æå‡ºçš„é—®é¢˜ï¼Œå“åº”é€Ÿåº¦è¿Ÿç¼“ï¼ˆåŠå¤©å†…ï¼‰ï¼Œéœ€é¢†å¯¼ç£ä¿ƒå’ŒååŠ©æ‰èƒ½å¤„ç†ã€è§£å†³ï¼Œé—®é¢˜å¤„ç†ç»“æœä¸ç†æƒ³ï¼›
- **0 åˆ†**ï¼Œå¯¹äºå¸‚åœºã€å®¢æˆ·æˆ–åŒäº‹æå‡ºçš„é—®é¢˜ï¼Œå“åº”é€Ÿåº¦æ…¢ï¼ˆåŠå¤©ä»¥ä¸Šï¼‰ï¼Œéœ€å€ŸåŠ©é¢†å¯¼æˆ–å…¶ä»–åŒäº‹æ‰èƒ½è§£å†³é—®é¢˜ï¼›
- **-3 åˆ†**ï¼Œå“åº”é€Ÿåº¦å—åˆ°å¸‚åœºæˆ–å®¢æˆ·æŠ•è¯‰ä¸€æ¬¡æ‰£ 3 åˆ†ï¼›

---

##### 2. å‘¨æŠ¥æœˆæŠ¥

- **5 åˆ†**ï¼Œèƒ½æŒ‰æ—¶æäº¤å‘¨æŠ¥/æœˆæŠ¥ï¼Œè®¤çœŸç»†è‡´å¡«å†™å‘¨/æœˆæŠ¥å„é¡¹å·¥ä½œç»†èŠ‚ä»¥åŠå¾ˆå¥½çš„æ‰§è¡Œå‘¨/æœˆæ€»ç»“ã€ä¸‹å‘¨/æœˆè®¡åˆ’çš„ï¼Œå¯¹å·¥ä½œé‡åˆ°çš„é—®é¢˜èƒ½å¾ˆå¥½çš„æ€»ç»“å¹¶æå‡ºå»ºè®¾æ€§çš„æ„è§ï¼›
- **4 åˆ†**ï¼Œèƒ½æŒ‰æ—¶æäº¤å‘¨æŠ¥æœˆæŠ¥ï¼Œè®¤çœŸå¡«å†™å‘¨/æœˆæŠ¥çš„å„å·¥ä½œç»†èŠ‚ï¼Œèƒ½å¯¹ä¸‹å‘¨/æœˆå·¥ä½œåšç®€å•è®¡åˆ’ï¼Œç¼ºå¤±å·¥ä½œæ€»ç»“æˆ–ç¼ºä¹å¯¹å·¥ä½œé‡åˆ°é—®é¢˜æ€»ç»“å’Œæ¢³ç†ï¼›
- **3 åˆ†**ï¼Œèƒ½æäº¤å‘¨/æœˆæŠ¥ï¼ˆéƒ¨åˆ†å‘¨ç¼ºå¤±ï¼‰å¹¶æŒ‰æ ¼å¼å¡«å†™ç›¸åº”å†…å®¹ï¼ŒåŸºæœ¬ç¬¦åˆè¦æ±‚ï¼Œå‘¨/æœˆå·¥ä½œæ€»ç»“ç¼ºå¤±ã€å·¥ä½œè®¡åˆ’ç¼ºå¤±ï¼Œç¼ºä¹å¯¹å·¥ä½œé‡åˆ°é—®é¢˜æ€»ç»“å’Œæ¢³ç†ï¼›
- **2 åˆ†**ï¼Œèƒ½æäº¤å‘¨/æœˆæŠ¥ï¼ˆéƒ¨åˆ†å‘¨ç¼ºå¤±ï¼‰ï¼Œå‘¨æŠ¥å†…å®¹å®Œæ•´ä½†è´¨é‡ä¸é«˜ï¼Œæ— æ€»ç»“ã€è®¡åˆ’ï¼Œæ— é—®é¢˜æ¢³ç†ï¼›
- **1 åˆ†**ï¼Œèƒ½æäº¤å‘¨/æœˆæŠ¥ï¼ˆéƒ¨åˆ†å‘¨ç¼ºå¤±ï¼‰ï¼Œå‘¨æŠ¥å†…å®¹å®Œå…¨åº”ä»˜äº†äº‹çš„ï¼›
- **0 åˆ†**ï¼Œä¸æäº¤å‘¨/æœˆæŠ¥ï¼Œå³ä½¿æäº¤ï¼Œå‘¨/æœˆæŠ¥å†…å®¹æ•·è¡äº†äº‹ï¼›æˆ–è€…é—æ¼ä¸”ä¸è¡¥äº¤è€…ï¼› -
- **3 åˆ†**ï¼Œä¸æäº¤å‘¨/æœˆæŠ¥ï¼Œåç»­æé†’ç£ä¿ƒä»æ•·è¡äº†äº‹ï¼›

---

##### 3. è´£ä»»å¿ƒ

- **5 åˆ†**ï¼Œç§¯æä¸»åŠ¨æ‰¿æ‹…å·¥ä½œä¸­çš„è´£ä»»ï¼›åœ¨å›¢é˜Ÿä¸­ä¼ é€’æ­£èƒ½é‡é¼“èˆå£«æ°”ï¼Œæ— éœ€ç£ä¿ƒï¼Œä¸»åŠ¨å®Œæˆå·¥ä½œå¹¶ç§¯æååŠ©åŒäº‹å¹¶åˆ†æ‹…å·¥ä½œæˆ–æå‰å¯¹å·¥ä½œè¿›è¡Œè®¡åˆ’ã€ç­¹å¤‡ã€å®æ–½ï¼›èƒ½å°†æŸé¡¹å·¥ä½œè·Ÿè¸ªåˆ°åº•ï¼Œä¸åŠé€”è€ŒåºŸï¼Œæˆ–èµ°å½¢å¼ä¸»æ„ï¼›æ•¢äºæå‡ºå‘ç°çš„æ½œåœ¨é—®é¢˜ï¼Œå¹¶èƒ½æå‡ºç›¸å¯¹åˆé€‚çš„å¤„ç†æ–¹æ¡ˆï¼›
- **4 åˆ†**ï¼Œå¯¹ç‹¬ç«‹æ‰¿æ‹…å·¥ä½œä¸­çš„è´£ä»»ï¼Œæ€åº¦å¥½ï¼Œèƒ½å¶å°”ä¼ é€’æ­£èƒ½é‡é¼“èˆå£«æ°”ï¼Œèƒ½ä¸»åŠ¨å®Œæˆå·¥ä½œå¹¶ååŠ©åŒäº‹å®Œæˆå·¥ä½œï¼›
- **3 åˆ†**ï¼Œå·¥ä½œä¸­èƒ½æŒ‰è¦æ±‚å®ŒæˆèŒè´£å†…ä»»åŠ¡ï¼Œç§¯ææ€§ä¸€èˆ¬ï¼Œä¸»åŠ¨æ€§ä¸€èˆ¬ï¼Œåä½œèƒ½åŠ›ä¸€èˆ¬ï¼Œåœ¨ä¸€èˆ¬æƒ…å†µä¸‹èƒ½å¤Ÿå¯¹è‡ªå·±çš„è¡Œä¸ºè´Ÿè´£ï¼›
- **2 åˆ†**ï¼Œå¯¹é¢†å¯¼åˆ†é…æˆ–å®‰æ’çš„ä»»åŠ¡æ‹–å»¶æ‰§è¡Œï¼Œä¸»åŠ¨æ€§å·®ï¼Œåä½œèƒ½åŠ›å·®ï¼Œè™½å¯ä»¥å®Œæˆç›¸åº”ä»»åŠ¡ï¼Œä½†éœ€è¦ç£ä¿ƒæ‰æ‰§è¡Œæˆ–å®Œæˆä»»åŠ¡ï¼Œæœ‰æ—¶è¿˜æœ‰æŠµè§¦æƒ…ç»ªï¼›å¤§å¤šæ•°æ—¶å€™è¢«åŠ¨æ¥å—å·¥ä½œï¼Œéœ€è¦ä¸Šçº§åè°ƒèµ„æºï¼› 1 åˆ†ï¼Œä¸¥é‡æ‹–å»¶é¢†å¯¼åˆ†é…æˆ–å®‰æ’çš„ä»»åŠ¡ï¼Œå¤šæ¬¡ç£ä¿ƒæ‰æ‰§è¡Œä»»åŠ¡ï¼ŒæŠµè§¦æƒ…ç»ªä¸¥é‡ï¼›åœ¨ä¸€èˆ¬æƒ…å†µä¸‹èƒ½å¤Ÿå¯¹è‡ªå·±çš„è¡Œä¸ºè´Ÿè´£ï¼Œå¯¹å·¥ä½œä¸­çš„å¤±è¯¯æœ‰æ—¶è¿›è¡Œé€ƒé¿æˆ–æ¨å¸è´£ä»»ï¼›
- **0 åˆ†**ï¼Œä¸æ‰§è¡Œé¢†å¯¼åˆ†é…æˆ–å®‰æ’çš„ä»»åŠ¡ï¼Œåœ¨å›¢é˜Ÿä¸­æœ‰å‘è¡¨è´Ÿèƒ½é‡çš„è¨€è®ºï¼Œå½±å“å›¢é˜Ÿå£«æ°”ï¼Œå·¥ä½œæ€åº¦å·®ï¼›å¯¹å·¥ä½œä¸­çš„å¤±è¯¯ç»å¸¸æ‰¾å€Ÿå£ï¼Œæ¨å¸è´£ä»»ã€‚
- **-5 åˆ†**ï¼Œåœ¨å›¢é˜Ÿä¸­å¤šæ¬¡ï¼ˆ2 æ¬¡ä»¥ä¸Šï¼‰å‘è¡¨è´Ÿèƒ½é‡çš„è¨€è®ºï¼Œä¸¥é‡å½±å“å›¢é˜Ÿå£«æ°”å’Œå›¢é˜Ÿåä½œï¼Œå½±å“å›¢é˜Ÿå·¥ä½œæ°›å›´ã€‚

è¯„ä¼°å…³é”®ç‚¹ï¼šä¸»åŠ¨ç§¯æã€å·¥ä½œæ€åº¦ã€è´£ä»»å¿ƒã€æ­£èƒ½é‡ã€åä½œèƒ½åŠ›

---

#### 6.1.3 çº¢é»‘äº‹ä»¶

1. è€ƒæ ¸æœŸå†…å—éƒ¨é—¨ã€å…¬å¸ã€å®¢æˆ·å˜‰å¥–ï¼›éƒ¨é—¨æˆ–å…¬å¸å†…åˆ†äº«æœ‰ä»·å€¼çš„æŠ€æœ¯æˆ–è®¾è®¡èƒ½ç»™å›¢é˜Ÿå¸¦æ¥å®è´¨æ€§çš„æ”¶ç›Šçš„ï¼ˆå„å›¢é˜Ÿå†…éƒ¨å·¥ä½œæˆ–æŠ€æœ¯åˆ†äº«é™¤å¤–ï¼‰
2. é‡éš¾ç‚¹å·¥ä½œ/æŠ€æœ¯ç­‰æœ‰çªç ´æˆ–å¯¹å…¬å¸ã€å›¢é˜Ÿæœ‰ç‰¹æ®Šä¸šç»©è´¡çŒ®
3. è€ƒæ ¸æœŸå†…æ¸èŒã€å¤±èŒã€ä¹±ç”¨èŒæƒï¼Œé€ æˆé‡å¤§å¤±è¯¯ï¼Œç»©æ•ˆä¸º 0ï¼›å…¶ä»–é‡å¤§é—®é¢˜æˆ–ç”Ÿäº§äº‹æ•…ï¼Œè§†ä¸¥é‡æƒ…å†µï¼Œæ‰£é™¤ 5 è‡³ 10 åˆ†/æ¬¡
4. æœ‰è¿‡æ¿€è¡¨ç°ï¼Œç»™éƒ¨é—¨ã€å…¬å¸å¸¦æ¥è´Ÿé¢å½±å“æˆ–ç»æµæŸå¤±ï¼Œç»©æ•ˆä¸º O

---

#### 6.1.4 å·¥ä½œä¸šç»©

##### 6.1.4.1 äº§å“

###### 1. äº§å“è§„åˆ’ä¸è®¾è®¡

- **20 åˆ†**: äº§å“è§„åˆ’è·¯çº¿å›¾éå¸¸æ¸…æ™°æ˜ç¡®ï¼Œè§„åˆ’å†…å®¹å…¼é¡¾ç°æœ‰å¸‚åœºå˜åŒ–åŠå…¬å¸æˆ˜ç•¥ï¼Œå‰ç»æ€§å¼ºã€å¯æ‰§è¡Œåº¦é«˜ã€‚é…å¥—çš„äº§å“è§„åˆ’æ–¹æ¡ˆã€è®¾è®¡æ–¹æ¡ˆã€åŸå‹è®¾è®¡åŠäº¤äº’è¯´æ˜å†…å®¹å……å®å®Œå–„ï¼Œæµç¨‹å®Œæ•´ï¼Œé€»è¾‘æ˜ç¡®æ¸…æ™°ï¼Œä¸¥æ ¼éµå¾ªè®¾è®¡è§„èŒƒï¼Œè¿‡ç¨‹æ— æ”¹åŠ¨ï¼ŒPRD æ–‡æ¡£è´¨é‡é«˜ï¼Œå¯¹ç°æœ‰äº§å“å’Œæ–°äº§å“çš„è®¾è®¡èƒ½å¤Ÿæå‡ºå»ºè®¾æ€§æ„è§æˆ–åˆ›æ–°æ€§æ„è§ï¼›
- **16-19 åˆ†**: äº§å“è§„åˆ’è·¯çº¿å›¾æ¸…æ™°ï¼Œè§„åˆ’å†…å®¹åŸºæœ¬å…¼é¡¾ç°æœ‰å¸‚åœºå˜åŒ–åŠå…¬å¸æˆ˜ç•¥ï¼Œå¯æ‰§è¡Œåº¦é«˜ã€‚é…å¥—çš„äº§å“è®¾è®¡æ–¹æ¡ˆã€åŸå‹è®¾è®¡åŠ PRD æ–‡æ¡£å†…å®¹æ¡†æ¶å®Œå–„ï¼Œè¿‡ç¨‹æ”¹åŠ¨å¾ˆå°‘ï¼ˆ3 æ¬¡ä»¥å†…ï¼Œä»¥ PRD å’ŒåŸå‹å®šç¨¿ä¸ºå‡†ï¼‰ï¼Œæ–‡æ¡£è´¨é‡é«˜ï¼Œçº¿å‰æ— é€»è¾‘æ€§é—®é¢˜å¯¼è‡´éœ€æ±‚å˜æ›´æˆ–ä¸´æ—¶å¢åŠ éœ€æ±‚ã€æ— å› è®¾è®¡é—®é¢˜å˜æ›´æˆ–å¢åŠ éœ€æ±‚åŠåŠŸèƒ½æ–¹æ¡ˆï¼Œå¯¹ç°æœ‰äº§å“å’Œæ–°äº§å“çš„è®¾è®¡èƒ½å¤Ÿæå‡ºæ¯”è¾ƒå®ç”¨çš„æ„è§ä¸”ç»å¤§éƒ¨åˆ†è¢«æ¥å—é‡‡çº³;
- **10-15 åˆ†**: äº§å“è§„åˆ’è·¯çº¿åŸºæœ¬æ¸…æ™°ï¼Œè§„åˆ’å†…å®¹åŸºæœ¬æ»¡è¶³ç°çŠ¶éœ€æ±‚ï¼ˆæ”¹åŠ¨åœ¨ 5 æ¬¡ä»¥å†…ï¼Œä»¥ PRD å’ŒåŸå‹å®šç¨¿ä¸ºå‡†ï¼‰ï¼Œæœ‰ä¸€å®šçš„å¯æ‰§è¡Œåº¦ï¼ˆéœ€è¿›ä¸€æ­¥ä¿®æ”¹ã€å®Œå–„ï¼‰ã€‚é…ç½®æœ‰åŸºæœ¬çš„äº§å“åŸå‹è®¾è®¡åŠ PRD æ–‡æ¡£ï¼Œæ–‡æ¡£è´¨é‡ä¸€èˆ¬ï¼›
- **5-9 åˆ†**: äº§å“è§„åˆ’è·¯çº¿å›¾æ¨¡ç³Šï¼Œè§„åˆ’å†…å®¹ä¸ç°æœ‰å¸‚åœºå­˜åœ¨è„±èŠ‚ï¼Œå¯æ‰§è¡Œè¡Œè¾ƒä½ã€‚é…å¥—äº§å“åŸå‹è®¾è®¡åŠ PRD æ–‡æ¡£å†…å®¹å­˜åœ¨ä¸€å®šé—®é¢˜ï¼Œæ–‡æ¡£è´¨é‡å·®ï¼›
- **1-4 åˆ†**: æ— äº§å“è§„åˆ’ï¼Œé…å¥—äº§å“åŸå‹è®¾è®¡åŠ PRD æ–‡æ¡£å†…å®¹å­˜åœ¨å¾ˆå¤šé—®é¢˜ï¼Œæ–‡æ¡£è´¨é‡å·®ï¼›
- **0 åˆ†**: æ— äº§å“è§„åˆ’ï¼Œé…å¥—äº§å“åŸå‹è®¾è®¡è´¨é‡è¾ƒå·®ï¼Œæ—  PRD æ–‡æ¡£ã€‚

è¯„ä¼°å…³é”®ç‚¹ï¼šè§„åˆ’çº¿è·¯è®¾è®¡ã€è§„åˆ’æ–¹æ¡ˆ|è®¾è®¡æ–¹æ¡ˆã€åŸå‹è®¾è®¡è´¨é‡ï¼ˆåŸå‹è®¾è®¡æ¸…æ™°ã€åŸå‹è®¾è®¡å­—æ®µè¯´æ˜æ¸…æ¥šã€ä¸šåŠ¡æµç¨‹ç»†è‡´å‘¨å…¨ã€è¾“å…¥è¾“å‡ºè¯´æ˜æ¸…æ™°æ˜äº†ã€å¼‚å¸¸é€»è¾‘è€ƒè™‘å‘¨å…¨ã€æ–‡æ¡ˆå®šä¹‰å‡†ç¡®åˆç†ã€é¡µé¢æµæ¸…æ™°ï¼‰ã€PRD è´¨é‡ï¼Œä¸»è¦æ˜¯æ ¼å¼ã€å†…å®¹ç»†èŠ‚ã€å‡†ç¡®åº¦å’Œç²¾ç»†åº¦ã€æˆ˜ç•¥æ€§|å‰ç»æ€§|å¯æ‰§è¡Œæ€§ã€‚

ä¸Šçº¿å‰ï¼Œå­˜åœ¨é€»è¾‘æ€§é—®é¢˜å¯¼è‡´éœ€æ±‚å˜æ›´ã€è°ƒæ•´æˆ–ä¸´æ—¶å¢åŠ éœ€æ±‚ï¼ˆä¸€é¡¹æ‰£ 1 åˆ†ï¼‰(ä¸Šçº¿å‰ä¸€å¤©å‡ºç°ç±»ä¼¼æƒ…å†µï¼Œç¿»å€æ‰£é™¤)ã€å­˜åœ¨é—æ¼éœ€æ±‚ï¼Œè§†é‡è¦ç¨‹åº¦è€Œå®šï¼ˆä¸€é¡¹æ‰£ 1-2 åˆ†ï¼‰ï¼›å­˜åœ¨å› è®¾è®¡é—®é¢˜å˜æ›´ã€è°ƒæ•´æˆ–ä¸´æ—¶å¢åŠ éœ€æ±‚åŠåŠŸèƒ½æ–¹æ¡ˆï¼ˆä¸€é¡¹æ‰£ 1 åˆ†ï¼‰ï¼Œä»¥å˜æ›´æˆ–å¢åŠ çš„éœ€æ±‚ç‚¹ä¸ºè€ƒæ ¸ç‚¹ã€‚

---

###### 2. éœ€æ±‚ç®¡ç†

- **10 åˆ†**ï¼Œç§¯æä¸»åŠ¨ä¸å®¢æˆ·æˆ–ç›¸å…³éƒ¨é—¨åŒäº‹é‡‡é›†ã€æ²Ÿé€šéœ€æ±‚ï¼Œèƒ½ç»è¿‡åŠ å·¥ã€æ¢³ç†å’Œç”„åˆ«çœŸä¼ªéœ€æ±‚å¹¶å½¢æˆè¯¦ç»†çš„æœ‰ä»·å€¼çš„éœ€æ±‚æ¦‚è¦ï¼›æ ¹æ®è°ƒç ”æˆ–è®¨è®ºç»“æœï¼Œåˆ—å…¥éœ€æ±‚æ± ï¼Œå¹¶è·Ÿæ®éœ€æ±‚æœ¬èº«çš„å˜åŠ¨ï¼Œè°ƒæ•´éœ€æ±‚æ± ä¸­çš„ç›¸å…³çŠ¶æ€ï¼Œæ ‡æ³¨ç›¸å…³çš„è®°å½•ï¼Œæ‰¹æ³¨ï¼Œèƒ½å¯¹éœ€æ±‚æ± åšå¥½ç»´æŠ¤ï¼›
- **8-9 åˆ†**ï¼Œç§¯æä¸»åŠ¨ä¸å®¢æˆ·æˆ–ç›¸å…³éƒ¨é—¨åŒäº‹é‡‡é›†ã€æ²Ÿé€šéœ€æ±‚ï¼Œèƒ½ç»è¿‡åŠ å·¥ã€æ¢³ç†å¹¶å½¢æˆè¯¦ç»†çš„éœ€æ±‚æ¦‚è¦ï¼›åˆ—å…¥éœ€æ±‚æ± ï¼Œå¹¶è·Ÿæ®éœ€æ±‚æœ¬èº«çš„å˜åŠ¨ï¼Œè°ƒæ•´éœ€æ±‚æ± ä¸­çš„ç›¸å…³çŠ¶æ€ï¼Œæ ‡æ³¨ç›¸å…³çš„è®°å½•ï¼Œæ‰¹æ³¨ï¼Œèƒ½å¯¹éœ€æ±‚æ± åšç»´æŠ¤ï¼›
- **6-7 åˆ†**ï¼Œèƒ½ä¸å®¢æˆ·æˆ–ç›¸å…³éƒ¨é—¨åŒäº‹é‡‡é›†ã€æ²Ÿé€šéœ€æ±‚ï¼Œèƒ½æä¾›åŸºæœ¬çš„éœ€æ±‚æ¦‚è¦ï¼›ç†å¹¶å½¢æˆéœ€æ±‚æ¦‚è¦ï¼›åˆ—å…¥éœ€æ±‚æ± ï¼Œå¹¶è·Ÿæ®éœ€æ±‚æœ¬èº«çš„å˜åŠ¨ï¼Œè°ƒæ•´éœ€æ±‚æ± ä¸­çš„ç›¸å…³çŠ¶æ€ï¼Œæ ‡æ³¨ç›¸å…³çš„è®°å½•ï¼Œæ‰¹æ³¨ï¼›
- **4-5 åˆ†**ï¼Œä»…èƒ½ä¸å®¢æˆ·æˆ–ç›¸å…³éƒ¨é—¨åŒäº‹äº¤æµã€é‡‡é›†éœ€æ±‚ï¼Œæ— éœ€æ±‚æ¦‚è¦ï¼Œèƒ½å°†éœ€æ±‚è®°å½•å…¥éœ€æ±‚æ± ï¼›
- **1-3 åˆ†**ï¼Œæ ¹æ®è°ƒç ”æˆ–è®¨è®ºç»“æœï¼Œé‡‡é›†è®°å½•éœ€æ±‚åˆ—å…¥éœ€æ±‚æ± ä¸­ï¼›
- **0 åˆ†**ï¼Œéœ€æ±‚è®°å½•æ¨¡ç³Šä¸æ¸…ï¼Œæ— éœ€æ±‚æ± ç®¡ç†ã€‚

è¯„ä¼°å…³é”®ç‚¹ï¼šéœ€æ±‚é‡‡é›†ã€éœ€æ±‚ç”„åˆ«ã€æ¢³ç†ã€åˆ†æã€ä¼˜å…ˆçº§æ’åˆ—ã€éœ€æ±‚æ± å»ºç«‹åŠç»´æŠ¤ã€è·Ÿè¿›éœ€æ±‚çŠ¶æ€å¹¶åŠæ—¶å˜æ›´ã€å¯¹å®¢æˆ·éœ€æ±‚åŠæ—¶åé¦ˆã€‚

---

###### 3. æ—¥å¸¸é¡¹ç›®è·Ÿè¿›

- **10 åˆ†**ï¼Œä¸é¡¹ç›®ç»ç†å’Œé¡¹ç›®ç»„æˆå‘˜ä¿æŒå¯†åˆ‡æ²Ÿé€šï¼Œæ¯æ—¥èƒ½è·Ÿè¸ªé¡¹ç›®ç ”å‘è¿›åº¦ã€åŠŸèƒ½éªŒæ”¶ã€ç¦…é“ä¸ŠæŒ‡æ´¾ç»™è‡ªå·±çš„ bugs è·Ÿè¸ªã€å¹¶æ›´æ–°å·¥ä½œè®¡åˆ’è¡¨ï¼ˆå¦‚ WBS/è¿›åº¦è¡¨ã€çœ‹æ¿ã€ç‡ƒå°½å›¾ç­‰ï¼‰ï¼Œèƒ½åŠæ—¶å‘ä¸»ç®¡é¢†å¯¼ã€é¡¹ç›®ç»ç†åŠæˆå‘˜åé¦ˆé¡¹ç›®è¿›åº¦çº§å­˜åœ¨é—®é¢˜ï¼Œå¹¶èƒ½åœ¨ WBS è¡¨æ ¼ã€å‘¨æŠ¥ã€é¡¹ç›®ç®¡ç†è§„èŒƒè¡¨æ ¼ä¸­æ›´æ–°ã€è¯´æ˜ï¼›å¯¹é¡¹ç›®ä¸­å‡ºç°çš„å„ç±»çªå‘çŠ¶å†µèƒ½åŠæ—¶å“åº”å¹¶åè°ƒå„éƒ¨é—¨ï¼ˆæˆ–å„ç»„ï¼‰ç§¯æè§£å†³ï¼Œè§£å†³ç»“æœèƒ½å³æ—¶é€šçŸ¥ç»™ä¸»ç®¡é¢†å¯¼ã€é¡¹ç›®ç»ç†ã€æµ‹è¯•ä»¥åŠå®æ–½ç­‰ç›¸å…³äººå‘˜ï¼›
- **8-9 åˆ†**ï¼Œä¸é¡¹ç›®ç»ç†å’Œé¡¹ç›®ç»„æˆå‘˜ä¿æŒæ²Ÿé€šï¼Œå®šæœŸï¼ˆæ¯å‘¨ï¼‰è·Ÿè¸ªé¡¹ç›®ç ”å‘è¿›å±•æƒ…å†µã€åŠŸèƒ½éªŒæ”¶ç¦…é“ä¸ŠæŒ‡æ´¾ç»™è‡ªå·±çš„ bugs è·Ÿè¸ªã€åŠå·¥ä½œè®¡åˆ’è¡¨ï¼ˆå¦‚/è¿›åº¦è¡¨ã€çœ‹æ¿ç­‰ï¼‰ï¼Œå¯¹é¡¹ç›®ä¸­å‡ºç°çš„å„ç±»çªå‘çŠ¶å†µèƒ½åŠæ—¶å“åº”å¹¶åè°ƒå„éƒ¨é—¨ï¼ˆæˆ–å„ç»„ï¼‰ç§¯æè§£å†³ï¼Œè§£å†³ç»“æœèƒ½åŸºæœ¬æŒ‰æ—¶åé¦ˆï¼›
- **5-7 åˆ†**ï¼Œä¸é¡¹ç›®ç»ç†å’Œé¡¹ç›®ç»„æˆå‘˜å®šæœŸæ²Ÿé€šï¼Œå®šæœŸè·Ÿè¸ªé¡¹ç›®ç ”å‘è¿›å±•æƒ…å†µã€åŠŸèƒ½éªŒæ”¶ç¦…é“ä¸ŠæŒ‡æ´¾ç»™è‡ªå·±çš„ bugs è·Ÿè¸ªï¼Œå¯¹é¡¹ç›®ä¸­å‡ºç°çš„å„ç±»çªå‘çŠ¶å†µèƒ½å¤Ÿå“åº”å¹¶åè°ƒå„éƒ¨é—¨ï¼ˆæˆ–å„ç»„ï¼‰è§£å†³ï¼Œä¸å¸‚åœºé”€å”®ã€æµ‹è¯•ã€å®æ–½ç­‰ç›¸å…³äººå‘˜å­˜åœ¨ä¸€å®šçš„å»¶è¿Ÿã€æ•ˆæœä¸€èˆ¬æˆ–å­˜åœ¨æ²Ÿé€šä¸ç•…çš„æƒ…å†µå¯¼è‡´é¡¹ç›®è¿›å±•ä¸é¡ºï¼›
- **1-4 åˆ†**ï¼Œä¸é¡¹ç›®ç»ç†å’Œé¡¹ç›®ç»„æˆå‘˜æ²Ÿé€šé¢‘ç‡è¾ƒä½ï¼Œé¡¹ç›®ç ”å‘è¿›å±•æƒ…å†µä¸å¤Ÿäº†è§£ï¼Œå¯¹é¡¹ç›®ä¸­å‡ºç°çš„å„ç±»çªå‘çŠ¶å†µå“åº”é€Ÿåº¦è¾ƒæ…¢ï¼Œä¸èƒ½ä¸»åŠ¨åè°ƒå„éƒ¨é—¨ï¼ˆæˆ–å„ç»„ï¼‰æ¨è¿›è§£å†³ï¼Œä¸å¸‚åœºé”€å”®ã€æµ‹è¯•ã€å®æ–½ç­‰ç›¸å…³äººå‘˜æ²¡æœ‰å»ºç«‹èµ·è‰¯å¥½çš„æ²Ÿé€šæœºåˆ¶ï¼Œå¯¼è‡´å„æ–¹çš„æ»¡æ„åº¦è¾ƒä½ï¼›
- **0 åˆ†**ï¼Œè¢«åŠ¨ä¸é¡¹ç›®ç»ç†å’Œé¡¹ç›®æˆå‘˜æ²Ÿé€šï¼Œå¯¹é¡¹ç›®ç ”å‘è¿›å±•ä¸äº†è§£ï¼Œä¸èƒ½è§£å†³å„ç±»çªå‘äº‹ä»¶ï¼Œä¸èƒ½åè°ƒå„éƒ¨é—¨ï¼ˆæˆ–å„ç»„ï¼‰æ¨è¿›è§£å†³é—®é¢˜ã€‚

è¯„ä¼°å…³é”®ç‚¹ï¼šæ²Ÿé€šã€è¿›åº¦è¿½è¸ªé¢‘æ¬¡å’Œè´¨é‡ã€å·¥ä½œè®¡åˆ’è¡¨ã€åŠŸèƒ½éªŒæ”¶ã€é—®é¢˜å‘ç°|çªå‘çŠ¶å†µåŠå¤„ç†èƒ½åŠ›|èµ„æºåè°ƒèƒ½åŠ›|å·¥ä½œåé¦ˆ

---

###### 4. è¯„å®¡ç®¡ç†

- **10 åˆ†**ï¼Œè¯„å®¡å‰ç§¯æä¸»åŠ¨ä¸å®¢æˆ·æˆ–ç›¸å…³éƒ¨é—¨åŒäº‹åè°ƒçº¦å®šè¯„å®¡æ—¶é—´ï¼Œè®²è¯„å®¡æ–‡ä»¶å‘ç»™ç›¸å…³å¹²ç³»äººï¼›è¯„å®¡ä¸­å°†éœ€æ±‚ä»æ•´ä½“åˆ°ç»†èŠ‚ï¼Œæ¨¡å—é—´å…³ç³»ã€ä¸šåŠ¡å’Œç³»ç»Ÿé€»è¾‘æ¸…æ™°ã€æœ‰æ¡ç†åœ°è®²è§£å®Œå–„ï¼Œé¡µé¢å®Œæ•´ï¼Œå¹¶å°†ç»“è®ºå’Œäº‰è®®ç‚¹å®Œæ•´åœ°è®°å½•ä¸‹æ¥ï¼›åœ¨è¯„å®¡ç»“æŸåï¼Œæ ¹æ®è¯„å®¡ç»“æœè¾“å‡ºè¯„å®¡æŠ¥å‘Šï¼Œå¹¶åšå¥½å¯¹åº”åœ°è§£å†³æ–¹æ¡ˆï¼Œæ‰¾ä¸ä¼šäººå‘˜ç­¾å­—ç¡®è®¤ï¼Œåœ¨äº§å“éƒ¨åšå¥½å½’æ¡£ï¼›æ¯å‘¨åœ¨æŒ‡å®šæ—¶é—´å†…æäº¤è¯„å®¡è®¡åˆ’å’Œè¯„å®¡å½’é›¶æŠ¥å‘Šï¼›
- **8-9 åˆ†**ï¼Œè¯„å®¡å‰ç§¯æä¸»åŠ¨ä¸å®¢æˆ·æˆ–ç›¸å…³éƒ¨é—¨åŒäº‹åè°ƒçº¦å®šè¯„å®¡æ—¶é—´ï¼Œè®²è¯„å®¡æ–‡ä»¶å‘ç»™ç›¸å…³å¹²ç³»äººï¼›è¯„å®¡ä¸­å°†éœ€æ±‚èƒ½å¤Ÿä»æ•´ä½“åˆ°ç»†èŠ‚ï¼Œæ¨¡å—é—´å…³ç³»ã€ä¸šåŠ¡å’Œç³»ç»Ÿé€»è¾‘åŸºæœ¬è®²è§£å®Œå–„ï¼Œé¡µé¢å®Œæ•´ï¼Œå¹¶å°†ç»“è®ºå’Œäº‰è®®ç‚¹å®Œæ•´åœ°è®°å½•ä¸‹æ¥ï¼›åœ¨è¯„å®¡ç»“æŸåï¼Œæ ¹æ®è¯„å®¡ç»“æœè¾“å‡ºè¯„å®¡æŠ¥å‘Šï¼Œå¹¶åšå¥½å¯¹åº”çš„è§£å†³æ–¹æ¡ˆï¼Œæ‰¾ä¸ä¼šäººå‘˜ç­¾å­—ç¡®è®¤ï¼Œåœ¨äº§å“éƒ¨åšå¥½å½’æ¡£ï¼›æ¯å‘¨åœ¨æŒ‡å®šæ—¶é—´å†…æäº¤è¯„å®¡è®¡åˆ’å’Œè¯„å®¡å½’é›¶æŠ¥å‘Šï¼›
- **5-7 åˆ†**ï¼Œè¯„å®¡å‰èƒ½å®¢æˆ·æˆ–ç›¸å…³éƒ¨é—¨åŒäº‹åè°ƒçº¦å®šè¯„å®¡æ—¶é—´ï¼Œè®²è¯„å®¡æ–‡ä»¶å‘ç»™ç›¸å…³å¹²ç³»äººï¼›è¯„å®¡ä¸­å°†éœ€æ±‚åŸºæœ¬å‡†ç¡®åœ°è®²è§£å‡ºæ¥ï¼Œæ— è¿‡å¤šçš„æµç¨‹ã€é€»è¾‘é—®é¢˜ï¼Œé¡µé¢åŸºæœ¬å®Œæ•´ï¼Œå¹¶å°†ç»“è®ºå’Œäº‰è®®ç‚¹è®°å½•ä¸‹æ¥ï¼›åœ¨è¯„å®¡ç»“æŸåï¼Œæ ¹æ®è¯„å®¡ç»“æœè¾ƒå®Œæ•´åœ°è¾“å‡ºè¯„å®¡æŠ¥å‘Šï¼Œæ‰¾ä¸ä¼šäººå‘˜ç­¾å­—ç¡®è®¤ï¼Œåœ¨äº§å“éƒ¨åšå¥½å½’æ¡£ï¼›æ¯å‘¨åœ¨æŒ‡å®šæ—¶é—´å†…æäº¤è¯„å®¡è®¡åˆ’å’Œè¯„å®¡å½’é›¶æŠ¥å‘Šï¼›
- **1-4 åˆ†**ï¼Œä¸´æ—¶é€šçŸ¥ç»„ç»‡è¯„å®¡ï¼Œæ²¡èƒ½æŠŠè¯„å®¡æ–‡ä»¶æå‰ä¸å®¢æˆ·æˆ–ç›¸å…³éƒ¨é—¨åŒäº‹æ²Ÿé€šä¼ é€’ï¼Œè¯„å®¡è¿‡ç¨‹ä¸­è®²è§£ä¸æ¸…æ¥šï¼Œå­˜åœ¨è¿‡å¤šé€»è¾‘é—®é¢˜ï¼Œé¡µé¢ä¸å®Œæ•´ã€‚è¯„å®¡æŠ¥å‘Šæäº¤å»¶è¿Ÿï¼Œæ‰€äº§å‡ºçš„äº§å“è¯„å®¡æŠ¥å‘Šä¸­è§£å†³æ–¹æ¡ˆå·®ï¼Œè´¨é‡å·®ï¼Œå­˜åœ¨æ¼é¡¹ï¼›åœ¨ç£ä¿ƒä¸‹æ‰èƒ½æäº¤è¯„å®¡è®¡åˆ’å’Œè¯„å®¡å½’é›¶æŠ¥å‘Šï¼›
- **0 åˆ†**ï¼Œæ•´ä¸ªè¯„å®¡æµç¨‹å·®ï¼Œæ— è¯„å®¡æŠ¥å‘Šï¼Œä¸æäº¤è¯„å®¡è®¡åˆ’å’Œå½’é›¶æŠ¥å‘Šã€‚

è¯„ä¼°å…³é”®ç‚¹ï¼šè¯„å®¡å‡†å¤‡ã€è¯„å®¡è¿‡ç¨‹è®²è§£é€»è¾‘å®Œå–„æœ‰æ¡ç†ã€è¯„å®¡æŠ¥å‘Šè´¨é‡é«˜ã€è¯„å®¡è®¡åˆ’ã€è¯„å®¡å½’é›¶æŠ¥å‘Šã€‚ è¯„å®¡æ–‡ä»¶å‡†å¤‡ä¸å……åˆ†ï¼Œæ²¡é€šçŸ¥å…³é”®å…³ç³»äººï¼ˆä¸€é¡¹æ‰£ 1 åˆ†ï¼‰ã€è®²è§£æ··ä¹±ï¼Œè¯„å®¡ç°åœºæå‡ºè¿‡å¤šé€»è¾‘é”™è¯¯ï¼Œç¼ºé¡µé¢ç­‰é—®é¢˜ï¼Œè§†é‡è¦ç¨‹åº¦è€Œå®šï¼ˆä¸€é¡¹æ‰£ 1-2 åˆ†ï¼‰ï¼›è¯„å®¡æŠ¥å‘Šè´¨é‡å·®ï¼Œä¸åŠæ—¶æäº¤è¯„å®¡è®¡åˆ’å’Œè¯„å®¡å½’é›¶æŠ¥å‘Šï¼ˆä¸€é¡¹æ‰£ 1 åˆ†ï¼‰ï¼Œä»¥è¯„å®¡è¿‡ç¨‹è®²è§£ä¸ºå…³é”®è€ƒæ ¸ç‚¹ã€‚

---

###### 5. ç‰ˆæœ¬äº¤ä»˜

- **10 åˆ†**ï¼Œæ¯ä¸€ä¸ªé‡Œç¨‹ç¢‘äº‹ä»¶æˆ–å¼€å‘ã€æµ‹è¯•æˆ–æ­£å¼ç‰ˆæœ¬å‡èƒ½å¦‚æœŸæˆ–æå‰äº¤ä»˜ï¼›
- **1-9 åˆ†**ï¼Œåœ¨æ¯ä¸€ä¸ªé‡Œç¨‹ç¢‘äº‹ä»¶æˆ–å¼€å‘ã€æµ‹è¯•æˆ–æ­£å¼ç‰ˆæœ¬ä¸­ï¼Œå› ä»»åŠ¡æœªå®Œæˆï¼Œå¯¼è‡´æ— æ³•å‘ç‰ˆï¼Œé€ æˆæµ‹è¯•å·¥ä½œå»¶æœŸï¼Œæ¯å»¶æœŸ 0.5 å¤©ï¼ˆä¸è¶³æŒ‰ 0.5 å¤©è®¡ï¼‰æ‰£ 2 åˆ†ï¼›ç¦…é“ä»»åŠ¡å»¶æœŸä¸€é¡¹æ‰£ 1 åˆ†ï¼Œæœ‰ä¸å…¶ä»–äººå‘˜åä½œä»»åŠ¡ï¼ˆä¾èµ–å…³ç³»ï¼‰ï¼Œå»¶æœŸä¸€é¡¹æ‰£ 2 åˆ†ï¼›
- **0 åˆ†**ï¼Œè¶…è¿‡ 2 å¤©ä¸èƒ½äº¤ä»˜ï¼Œè¯¥é¡¹ç»©æ•ˆä¸º 0ã€‚ å…¶ä»–ï¼šå¦‚å› å…¶ä»–å›¢é˜Ÿå¯¼è‡´æ— æ³•æŒ‰æ—¶å‘ç‰ˆï¼ŒæŒ‰è´£ä»»çº§åˆ«æ‰£é™¤ç›¸åº”åˆ†å€¼ï¼Œè´£ä»»åˆ†çº§å¦‚ä¸‹ï¼š
  - è´Ÿä¸»è¦è´£ä»»çš„æ‰£ï¼š90%-100%ï¼›
  - è´Ÿæ¬¡è¦è´£ä»»çš„æ‰£ï¼š50%ï¼›
  - å…¶ä»–å›¢é˜Ÿæ¥å—è¿å¸¦è´£ä»»ï¼Œæ‰£ï¼š30%ã€‚ å¦‚å› ä»»åŠ¡ç©¿æ’ï¼Œäººå‘˜è°ƒé…å¯¼è‡´äººåŠ›èµ„æºä¸è¶³ç­‰ç‰¹æ®Šæƒ…å†µé€ æˆçš„å»¶æœŸï¼Œç”±æŠ€æœ¯ä¸­å¿ƒç®¡ç†å°ç»„ç»¼åˆè¯„ä¼°å¦åšè€ƒæ ¸ã€‚

---

###### 6. äº§å“è°ƒç ”&ç«å“åˆ†æ

- **10 åˆ†**ï¼ŒåŠæ—¶æ”¶é›†å¹¶ç ”ç©¶è¡Œä¸šã€ç”¨æˆ·ã€ç«äº‰å¯¹æ‰‹ã€æ¸ é“ã€äº§å“ç­‰æ–¹é¢çš„å¸‚åœºä¿¡æ¯ï¼Œåˆ†ææŠ¥å‘Šçš„å†…å®¹å……å®ã€åˆç†ã€é’ˆå¯¹æ€§å¼ºï¼Œåˆ†æç»“æœå¯¹å…¬å¸äº§å“è§„åˆ’å†³ç­–å…·æœ‰å¼ºæœ‰åŠ›æ”¯æŒï¼›
- **9 åˆ†**ï¼Œèƒ½å¤Ÿæ”¶é›†å¹¶ç ”ç©¶è¡Œä¸šã€ç”¨æˆ·ã€ç«äº‰å¯¹æ‰‹ã€æ¸ é“ã€äº§å“ç­‰æ–¹é¢çš„å¸‚åœºä¿¡æ¯ï¼Œåˆ†ææŠ¥å‘Šçš„å†…å®¹æœ‰é’ˆå¯¹æ€§ï¼Œåˆ†æç»“æœèƒ½å¤Ÿå¯¹å…¬å¸äº§å“è§„åˆ’å†³ç­–æä¾›æ”¯æŒï¼›
- **8 åˆ†**ï¼Œèƒ½å¤Ÿæ”¶é›†å¹¶ç ”ç©¶è¡Œä¸šã€ç”¨æˆ·ã€ç«äº‰å¯¹æ‰‹ã€æ¸ é“ã€äº§å“ç­‰æ–¹é¢çš„å¸‚åœºä¿¡æ¯ï¼Œåˆ†ææŠ¥å‘Šèƒ½å¤Ÿå¯¹å®¢æˆ·å’Œå¸‚åœºéœ€æ±‚æå‡ºåˆ†æï¼Œåˆ†æç»“æœèƒ½å¤Ÿå¯¹å…¬å¸äº§å“è§„åˆ’å†³ç­–æä¾›æ”¯æŒï¼›
- **7 åˆ†**ï¼Œèƒ½å¤Ÿæ”¶é›†å¹¶ç ”ç©¶è¡Œä¸šã€ç”¨æˆ·ã€ç«äº‰å¯¹æ‰‹ã€æ¸ é“ã€äº§å“ç­‰æ–¹é¢çš„å¸‚åœºä¿¡æ¯ï¼Œåˆ†ææŠ¥å‘Šèƒ½å¤Ÿå¯¹å®¢æˆ·å’Œå¸‚åœºéœ€æ±‚æå‡ºåˆ†æï¼Œåˆ†æç»“æœå¯å¯¹å…¬å¸äº§å“è§„åˆ’å†³ç­–æä¾›ä¸€èˆ¬æ€§çš„æ”¯æŒï¼›
- **6 åˆ†**ï¼Œèƒ½å¤Ÿæ”¶é›†å¹¶ç ”ç©¶è¡Œä¸šã€ç”¨æˆ·ã€ç«äº‰å¯¹æ‰‹ã€æ¸ é“ã€äº§å“ç­‰æ–¹é¢çš„å¸‚åœºä¿¡æ¯ï¼Œåˆ†ææŠ¥å‘Šå†…å®¹ç¼ºä¹é’ˆå¯¹æ€§ï¼Œåˆ†æç»“æœä¸èƒ½å¤Ÿå¯¹å…¬å¸äº§å“è§„åˆ’å†³ç­–æä¾›åº”æœ‰çš„æ”¯æŒï¼›
- **5 åˆ†**ï¼Œèƒ½å¤Ÿæ”¶é›†å¹¶ç ”ç©¶è¡Œä¸šã€ç”¨æˆ·ã€ç«äº‰å¯¹æ‰‹ã€æ¸ é“ã€äº§å“ç­‰æ–¹é¢çš„å¸‚åœºä¿¡æ¯ï¼Œåˆ†ææŠ¥å‘Šçš„å†…å®¹ç¼ºä¹æ¡ç†æ€§å’Œé’ˆå¯¹æ€§ï¼Œåˆ†æç»“æœæ•°æ®ä¸è¶³å¤Ÿå¯¹äº§å“å†³ç­–æä¾›æ”¯æŒï¼›
- **1-4 åˆ†**ï¼Œèƒ½å¤Ÿç®€å•æ”¶é›†å¹¶ç ”ç©¶è¡Œä¸šã€ç”¨æˆ·ã€ç«äº‰å¯¹æ‰‹ã€æ¸ é“ã€äº§å“ç­‰æ–¹é¢çš„å¸‚åœºä¿¡æ¯æˆ–ä»…åœç•™åœ¨æ— è®¡åˆ’ã€æ— è§„åˆ’çš„æŸ¥è¯¢ã€æµè§ˆå±‚é¢ï¼Œæœ‰æŠ¥å‘Šä½†åˆ†ææŠ¥å‘Šå†…å®¹ç©ºæ³›ï¼Œåˆ†æç»“æœä¸èƒ½å¤Ÿå¯¹å…¬å¸äº§å“è§„åˆ’å†³ç­–æä¾›æ”¯æŒï¼›
- **0 åˆ†**ï¼Œä¸èƒ½å¤Ÿä¹Ÿä¸ä¼šæ”¶é›†å¹¶ç ”ç©¶è¡Œä¸šã€ç”¨æˆ·ã€ç«äº‰å¯¹æ‰‹ã€æ¸ é“ã€äº§å“ç­‰æ–¹é¢çš„å¸‚åœºä¿¡æ¯ï¼›æ— åˆ†ææŠ¥å‘Šã€‚

è¯„ä¼°å…³é”®ç‚¹ï¼šæœ‰åˆ†ææŠ¥å‘Šã€é‡‡é›†ä¿¡æ¯æˆ–èµ„æ–™ï¼‰ã€åˆ†ææŠ¥å‘Šè´¨é‡ã€ç»“æœå½±å“åŠ›ã€‚å¦‚è‹¥æ— åˆ†ææŠ¥å‘Šï¼Œæ­¤é¡¹ä¸º 0 åˆ†ã€‚

---

##### 6.1.4.2 UI

###### 1. äº§å“è®¾è®¡å“è´¨

- **15 åˆ†**ï¼Œèƒ½å‡†ç¡®ç†è§£äº§å“å—ä¼—ç”¨æˆ·å’Œè¡Œä¸šç‰¹ç‚¹ï¼Œè®¾è®¡é£æ ¼ç¬¦åˆå¤§ä¼—å®¡ç¾éœ€æ±‚ï¼Œå¹¶èƒ½æœåŠ¡äºå•†ä¸šç›®æ ‡çš„è¾¾æˆï¼›UI è®¾è®¡å¸ƒå±€åˆç†ã€ä¸»æ¬¡åˆ†æ˜ï¼Œä¿¡æ¯å†…å®¹æœ‰è¾ƒå¥½çš„å±‚æ¬¡æ„Ÿï¼ŒåŸºæœ¬æ— è¿”å·¥ï¼›UI è®¾è®¡èå…¥ä¸ªäººåˆ›æ„ï¼Œå¹¶ä¸”è·å¾—å®¢æˆ·èµèµæˆ–è€…ç”¨æˆ·å¥½è¯„ï¼›èƒ½å¤šæ¬¡å¯¹äº¤äº’è®¾è®¡ï¼ˆUEï¼‰æå‡ºåˆç†çš„ä¼˜åŒ–å»ºè®®å¹¶è¢«é‡‡çº³ï¼›èƒ½åŠæ—¶é…åˆå¼€å‘å®Œæˆç›¸å…³åˆ‡å›¾å·¥ä½œï¼Œä¿è¯ä¸å¼€å‘é¡ºç•…è¡”æ¥ï¼›äº§å“ç•Œé¢å®¡æ ¸è®¤çœŸã€ç»†è‡´ã€ä¸¥è°¨ï¼Œç¡®ä¿ä¸Šçº¿äº§å“é«˜è´¨é‡çš„ç•Œé¢æ•ˆæœã€‚
- **12-14 åˆ†**ï¼Œèƒ½å‡†ç¡®ç†è§£äº§å“å—ä¼—ç”¨æˆ·å’Œè¡Œä¸šç‰¹ç‚¹ï¼Œè®¾è®¡é£æ ¼åŸºæœ¬ç¬¦åˆå¤§ä¼—å®¡ç¾éœ€æ±‚ï¼›UI è®¾è®¡èå…¥ä¸ªäººåˆ›æ„ï¼Œç•Œé¢è®¾è®¡å¸ƒå±€åˆç†ã€ä¸»æ¬¡åˆ†æ˜ï¼Œä¿¡æ¯å†…å®¹æœ‰è¾ƒå¥½çš„å±‚æ¬¡æ„Ÿï¼Œæœ‰è¾ƒå°‘è¿”å·¥ï¼›èƒ½åŠæ—¶é…åˆå¼€å‘å®Œæˆç›¸å…³åˆ‡å›¾å·¥ä½œï¼Œä¿è¯ä¸å¼€å‘é¡ºç•…è¡”æ¥ï¼›äº§å“ç•Œé¢å®¡æ ¸è®¤çœŸã€ä¸¥è°¨ï¼Œèƒ½ä¿è¯ä¸Šçº¿äº§å“çš„ç•Œé¢æ•ˆæœã€‚
- **9-11 åˆ†**ï¼Œèƒ½å¤ŸæŒ‰ç…§åŸå‹å’Œå€Ÿé‰´å…¶ä»–äº§å“é£æ ¼ï¼Œå®Œæˆäº§å“çš„ UI è®¾è®¡ï¼›UI è®¾è®¡æˆæœåŸºæœ¬æ»¡è¶³è¦æ±‚ï¼Œæ— æ˜æ˜¾äº®ç‚¹ï¼Œæœ‰éƒ¨åˆ†è¿”å·¥ï¼›èƒ½åŠæ—¶é…åˆå¼€å‘å®Œæˆç›¸å…³åˆ‡å›¾å·¥ä½œï¼Œä¿è¯ä¸å¼€å‘é¡ºç•…è¡”æ¥ï¼›äº§å“ç•Œé¢å®¡æ ¸è®¤çœŸï¼ŒåŸºæœ¬èƒ½å¤Ÿç¡®ä¿ä¸Šçº¿äº§å“ç•Œé¢ä¸ UI è®¾è®¡æ•ˆæœä¸€è‡´ã€‚
- **5-8 åˆ†**ï¼Œèƒ½å¤ŸæŒ‰ç…§ä½ä¿çœŸåŸå‹å’Œå€Ÿé‰´å…¶ä»–äº§å“é£æ ¼ï¼Œå®Œæˆäº§å“çš„ UI è®¾è®¡ï¼›UI è®¾è®¡æˆæœåœ¨å¤šæ¬¡è¿”å·¥ååŸºæœ¬æ»¡è¶³è¦æ±‚ï¼Œæ— æ˜æ˜¾äº®ç‚¹ï¼›èƒ½åŠæ—¶é…åˆå¼€å‘å®Œæˆç›¸å…³åˆ‡å›¾å·¥ä½œï¼Œä¿è¯ä¸å¼€å‘é¡ºç•…è¡”æ¥ï¼›äº§å“ç•Œé¢å®¡æ ¸å­˜åœ¨ç–æ¼ï¼Œè¾ƒå¤šç•Œé¢ä¸ UI è®¾è®¡æ•ˆæœå·®å¼‚è¾ƒå¤§ã€‚
- **1-4 åˆ†**ï¼ŒUI è®¾è®¡æˆæœå­˜åœ¨å¤§é‡ç²—ç³™æˆ–è€…é…è‰²ä¸åˆç†çš„æƒ…å†µï¼Œç¦»äº§å“é«˜ä¿è¯ UI è®¾è®¡è¦æ±‚å·®è·è¾ƒå¤§ï¼›UI è®¾è®¡æˆæœåœ¨å¤šæ¬¡è¿”å·¥åä»æœªè¾¾åˆ°å¯ç”¨è¦æ±‚ï¼›èƒ½åŠæ—¶é…åˆå¼€å‘å®Œæˆç›¸å…³åˆ‡å›¾å·¥ä½œï¼Œä¿è¯ä¸å¼€å‘é¡ºç•…è¡”æ¥ã€‚
- **0 åˆ†**ï¼ŒUI è®¾è®¡ä¸¥é‡å»¶æœŸï¼Œæ— æ³•äº¤ä»˜æˆ–è®¾è®¡ç»“æœè´¨é‡æ— æ³•è¾¾åˆ°å¯ç”¨æ ‡å‡†ï¼Œéœ€è¿”å·¥é‡æ–°è®¾è®¡ã€‚

è¯„ä¼°å…³é”®ç‚¹ï¼šè®¾è®¡é£æ ¼ã€è®¾è®¡å“è´¨ã€è®¾è®¡åˆ›æ„ã€è¿”å·¥ç‡ã€UE è®¾è®¡ã€ç»“æœä¸€è‡´æ€§

---

###### 2. å·¥ä½œå®Œæˆæ•ˆç‡

- **15 åˆ†**ï¼Œå·¥ä½œæ•ˆç‡å¾ˆé«˜ï¼Œèƒ½é«˜æ•ˆã€é«˜å“è´¨çš„å¦‚æœŸæˆ–æå‰å®Œæˆäº§å“ UI è®¾è®¡çš„å·¥ä½œæˆ–ä»»åŠ¡ï¼Œæ‰¿æ‹…å·¥ä½œé‡å¤§ä½†èƒ½æœ‰è®¡åˆ’æœ‰æ¡ç†çš„å¼€å±•å¹¶æŒ‰æ—¶å®Œæˆï¼Œèƒ½æŒ‘æˆ˜æœ‰éš¾åº¦çš„å·¥ä½œï¼Œèƒ½ä¸ºå¼€å‘ã€æµ‹è¯•å›¢é˜Ÿæä¾›å‡†ç¡®çš„ã€å¼ºæœ‰åŠ›çš„æ”¯æŒï¼Œä¸”åé¦ˆåŠæ—¶ï¼›
- **12-14 åˆ†**ï¼Œå·¥ä½œæ•ˆç‡é«˜ï¼Œèƒ½ä¿è´¨ä¿é‡çš„æŒ‰æ—¶å®Œæˆå²—ä½èŒè´£å·¥ä½œï¼ŒUI è®¾è®¡æœ‰ç‰¹è‰²ä¸”è´¨é‡è¾ƒå¥½ï¼Œèƒ½ä¸ºå¼€å‘ã€æµ‹è¯•å›¢é˜Ÿæä¾›å¾ˆå¥½çš„æ”¯æŒï¼Œä¿è¯æ­£å¸¸çš„åä½œè¿›ç¨‹ï¼›
- **9-11 åˆ†**ï¼Œå·¥ä½œæ•ˆç‡é«˜ï¼Œèƒ½å®Œæˆå²—ä½èŒè´£å†…çš„å·¥ä½œï¼Œåˆ†å†…å·¥ä½œå‡èƒ½æŒ‰æ—¶æŒ‰è¦æ±‚å®Œæˆï¼ŒUI è®¾è®¡è´¨é‡ä¸€èˆ¬ï¼Œèƒ½ä¸ºå¼€å‘ã€æµ‹è¯•å›¢é˜Ÿæä¾›å¸¸è§„æ€§æ”¯æŒï¼Œå¶å°”è¿”å·¥ï¼Œä½†ä¸å½±å“åä½œè¿›ç¨‹ï¼›
- **5-8 åˆ†**ï¼Œå·¥ä½œæ•ˆç‡ä¸€èˆ¬ï¼ŒåŸºæœ¬èƒ½æŒ‰æ—¶å®ŒæˆèŒè´£å·¥ä½œï¼›èƒ½ç‹¬ç«‹æŒ‰è¦æ±‚å®Œæˆ UI è®¾è®¡çš„å·¥ä½œä½†éœ€è¦é¢†å¯¼æˆ–åŒäº‹çš„ä¸€å®šæŒ‡å¯¼æˆ–ä¿®è®¢æ‰èƒ½å®Œæˆä»»åŠ¡ï¼Œå¤šæ¬¡è¿”å·¥ï¼Œä½†ä¸å½±å“åä½œè¿›ç¨‹ï¼›
- **1-4 åˆ†**ï¼Œå·¥ä½œæ•ˆç‡ä½ï¼Œéœ€è¦åˆ«å¸®åŠ©æ‰èƒ½å®Œæˆå²—ä½èŒè´£å·¥ä½œï¼›éœ€åœ¨ä¸Šçº§é¢†å¯¼çš„å¤šæ¬¡æŒ‡å¯¼ä¸‹æ‰èƒ½å®Œæˆäº§å“åŸå‹è®¾è®¡æˆ– UI è®¾è®¡ï¼Œç»å¸¸ä¸èƒ½æŒ‰æ—¶æŒ‰è¦æ±‚å®Œæˆåˆ†å†…å·¥ä½œå¹¶ç»å¸¸è¿”å·¥ï¼Œå½±å“åä½œè¿›ç¨‹ï¼›
- **0 åˆ†**ï¼Œå·¥ä½œæ•ˆç‡æä½ï¼Œä¸èƒ½æŒ‰ç…§å²—ä½èŒè´£å®Œæˆå·¥ä½œï¼›èƒ½åŠ›ä¸è¶³ï¼Œåœ¨å¤šæ¬¡æŒ‡å¯¼ä¸‹ä»æ— æ³•å®Œæˆå·¥ä½œä»»åŠ¡ï¼›

è¯„ä¼°å…³é”®ç‚¹ï¼šå·¥ä½œæ•ˆç‡ã€æå‰|æŒ‰æ—¶|å»¶æœŸå®Œæˆã€å·¥ä½œé‡ã€å·¥ä½œéš¾åº¦ï¼ˆæ–°é¢†åŸŸï¼Œæ²¡æœ‰æŒ‡å¯¼ï¼›æ–°é¢†åŸŸï¼Œæœ‰å¯å‚ç…§åŸå‹ï¼›éƒ¨åˆ†è¦ç‚¹éœ€åˆ›æ–°ï¼›å¸¸è§„æ€§å·¥ä½œï¼›é‡å¤æ€§å·¥ä½œï¼‰ã€å½±å“åä½œè¿›ç¨‹çŠ¶å†µã€‚

###### 3. äº§å“è®¾è®¡äº¤ä»˜

- **10 åˆ†**ï¼Œèƒ½é«˜æ•ˆã€é«˜å“è´¨çš„å¦‚æœŸæˆ–æå‰å®Œæˆ UI è®¾è®¡ä»»åŠ¡ï¼Œå¹¶èƒ½ä¸»åŠ¨æ£€æŸ¥éªŒæ”¶é‡Œç¨‹ç¢‘äº‹ä»¶ç‰ˆæœ¬ï¼›
- **8-9 åˆ†**ï¼Œèƒ½é«˜è´¨é‡çš„æŒ‰æ—¶å®Œæˆäº§å“ UI è®¾è®¡ä»»åŠ¡ï¼ŒåŸºæœ¬æ— è¿”å·¥ï¼› 6-7 åˆ†ï¼Œèƒ½ç‹¬ç«‹æŒ‰èŒè´£å†…å®Œæˆäº§å“ UI è®¾è®¡ä»»åŠ¡ï¼Œè´¨é‡ä¸€èˆ¬ï¼Œå¶å°”è¿”å·¥ï¼Œä½†å¯¹é¡¹ç›®è¿›åº¦æœªé€ æˆå½±å“ï¼›
- **4-5 åˆ†**ï¼Œèƒ½æŒ‰è¦æ±‚å®Œæˆäº§å“ UI è®¾è®¡ä»»åŠ¡ï¼Œæœ‰æ—¶éœ€è¦é¢†å¯¼åšä¸€å®šæŒ‡å¯¼æ‰èƒ½è¾¾åˆ°äº¤ä»˜æ ‡å‡†ï¼Œå¤šæ¬¡è¿”å·¥ï¼Œå¯¹é¡¹ç›®è¿›åº¦é€ æˆä¸€å®šå½±å“ï¼›
- **1-3 åˆ†**ï¼Œéœ€è¦åœ¨ä¸Šçº§é¢†å¯¼çš„å¤šæ¬¡æŒ‡å¯¼ä¸‹æ‰èƒ½å®Œæˆäº§å“ UI è®¾è®¡ï¼Œå¹¶ç»å¸¸è¿”å·¥ï¼Œå¹¶é€ æˆé¡¹ç›®è¿›åº¦å»¶æœŸï¼›
- **0 åˆ†**ï¼Œèƒ½åŠ›ä¸è¶³ï¼Œåœ¨å¤šæ¬¡æŒ‡å¯¼ä¸‹ä»æ— æ³•å®Œæˆå·¥ä½œä»»åŠ¡ï¼Œæ— æ³•äº¤ä»˜è®¾è®¡ç»“æœã€‚

è€ƒè¯„å…³é”®ç‚¹ï¼šäº¤ä»˜ç‰©å»¶æœŸæ‰£åˆ†ï¼šåœ¨æ¯ä¸€é¡¹è®¾è®¡å·¥ä½œä¸­ï¼Œå› è®¾è®¡ä»»åŠ¡æœªå®Œæˆï¼Œå¯¼è‡´æ— æ³•æ­£å¸¸è¿›å…¥å¼€å‘çŠ¶æ€ï¼Œé€ æˆå·¥ä½œå»¶æœŸï¼Œæ¯å»¶æœŸ 0.5 å¤©ï¼ˆä¸è¶³æŒ‰ 0.5 å¤©è®¡ï¼‰æ‰£ 2 åˆ†ï¼›ç¦…é“å…³è”ä»»åŠ¡å»¶æœŸä¸€é¡¹æ‰£ 1 åˆ†ã€‚

---

###### 4. å®¡å›¾

- **10 åˆ†**ï¼Œå„ç±»è®¾è®¡å›¾å‘½åè§„èŒƒã€æ ‡æ³¨æ¸…æ™°ã€æè¿°è¯¦ç»†å‡†ç¡®ï¼Œæ— æ–‡å­—æˆ–æ•°æ®é”™è¯¯ï¼Œèƒ½å¸®åŠ©å¼€å‘æˆ–æµ‹è¯•æ¸…æ™°çš„äº†è§£è®¾è®¡æ€æƒ³ï¼Œä¸å›¢é˜Ÿå…¶ä»–æˆå‘˜é¡ºç•…è¡”æ¥ï¼Œéµä»å…¬å¸è¿‡ç¨‹ç®¡ç†è§„èŒƒï¼Œæˆæœç‰©èƒ½åŠæ—¶ã€æ­£ç¡®æäº¤ï¼›
- **8-9 åˆ†**ï¼Œå„ç±»è®¾è®¡å›¾å‘½åè¾ƒè§„èŒƒã€æ ‡æ³¨æ¸…æ™°ï¼Œæè¿°æ— æ­§ä¹‰ï¼Œå¶å°”æœ‰æ–‡æ¡ˆæ–¹é¢ç»†å¾®é”™è¯¯ï¼Œèƒ½å¸®åŠ©å¼€å‘æˆ–æµ‹è¯•äº†è§£è®¾è®¡æ€æƒ³ï¼›éµä»å…¬å¸è¿‡ç¨‹ç®¡ç†è§„èŒƒï¼Œæˆæœç‰©èƒ½æ­£ç¡®æäº¤ï¼›
- **5-8 åˆ†**ï¼Œå„ç±»è®¾è®¡å›¾å‘½ååŸºæœ¬è§„èŒƒã€æ ‡æ³¨æ¸…æ¥šï¼Œæè¿°ä¸å¤Ÿè¯¦ç»†ã€å‡†ç¡®ï¼Œé¡»è¿”å·¥æˆ–æ²Ÿé€šã€ç¡®è®¤æ‰èƒ½ç†è§£è®¾è®¡æ„å›¾ï¼Œéµä»å…¬å¸è¿‡ç¨‹ç®¡ç†è§„èŒƒï¼Œæˆæœç‰©èƒ½æ­£ç¡®æäº¤ï¼›
- **1-4 åˆ†**ï¼Œå„ç±»è®¾è®¡å›¾å‘½åä¸è§„èŒƒï¼Œæ ‡æ³¨éƒ¨åˆ†æ··ä¹±ã€æè¿°ä¸æ˜ç¡®æˆ–æœ‰æ­§ä¹‰ï¼Œé¡»è¿”å·¥æˆ–ç»è¿‡å¤šæ¬¡äº¤æµæ‰èƒ½è®©äººç†è§£è®¾è®¡æ„å›¾ï¼Œéµä»å…¬å¸è¿‡ç¨‹ç®¡ç†è§„èŒƒï¼Œæˆæœç‰©èƒ½æ­£ç¡®æäº¤ï¼›
- **0 åˆ†**ï¼Œæ— è®¾è®¡è§„èŒƒæˆ–è®¾è®¡å›¾æ— æ ‡æ³¨ï¼Œæè¿°å«ç³Šä¸æ¸…ï¼Œä¸èƒ½è®©å¼€å‘æˆ–æµ‹è¯•ç†è§£è®¾è®¡æ€æƒ³ï¼Œæ— æ³•è¾¾åˆ°äº¤ä»˜æ ‡å‡†ã€‚

è¯„ä¼°å…³é”®ç‚¹ï¼šè®¾è®¡è§„èŒƒï¼‰ã€æ ‡æ³¨ä¸æè¿°ã€é¡ºç•…åä½œã€è¿”å·¥ä¸äº¤æµæˆæœ¬ã€æˆæœç‰©äº¤ä»˜ã€‚

---

###### 5. è®¾è®¡åˆ›æ–°

- **15 åˆ†**ï¼Œèƒ½æŒç»­å­¦ä¹ ï¼Œä¸æ–­åˆ›æ–°ï¼Œèƒ½ç»“åˆå—ä¼—ç”¨æˆ·å’Œè¡Œä¸šç‰¹ç‚¹ï¼Œå¾ˆå¥½çš„å°†å½“å‰ä¼˜ç§€çš„è®¾è®¡æ€æƒ³å’Œç†å¿µèåˆåˆ°å…¬å¸äº§å“ï¼Œå¾ˆå¥½çš„èåˆ UE è®¾è®¡ç†å¿µï¼Œå¸®åŠ©å…¬å¸æé«˜äº§å“è®¾è®¡æ°´å¹³ã€äº§å“ç”¨æˆ·ä½“éªŒï¼Œå¹¶ä¸”è·å¾—å®¢æˆ·èµèµæˆ–è€…ç”¨æˆ·å¥½è¯„ï¼›
- **12-14 åˆ†**ï¼Œèƒ½é€šè¿‡å­¦ä¹ å®ç°åˆ›æ–°ï¼Œå¯¹å…¬å¸è½¯ä»¶æˆ–äº§å“è®¾è®¡æå‡ºæœ‰åˆ›æ–°çš„æƒ³æ³•åŠè§è§£ï¼Œèƒ½ä¸»åŠ¨å¯¹äº§å“ UE æå‡ºåˆç†çš„ä¼˜åŒ–å»ºè®®å¹¶è¿ç”¨åˆ°è®¾è®¡ä¸­ï¼Œèƒ½å¸®åŠ©å…¬å¸æé«˜äº§å“è®¾è®¡æ°´å¹³å’Œç°æœ‰äº§å“ç”¨æˆ·ä½“éªŒï¼›
- **9-11 åˆ†**ï¼Œèƒ½é€šè¿‡å­¦ä¹ å®ç°åˆ›æ–°ï¼Œåœ¨é¢†å¯¼çš„æŒ‡å¯¼ä¸‹æˆ–æœ‰å¯å‚è€ƒçš„è®¾è®¡åŸå‹ä¸‹ï¼Œè¿›è¡ŒäºŒæ¬¡åˆ›æ–°å’Œæ”¹è¿›ï¼Œå¸®åŠ©å…¬å¸æé«˜äº§å“çš„å“è´¨å’Œç”¨æˆ·ä½“éªŒï¼›
- **5-8 åˆ†**ï¼Œèƒ½é€šè¿‡å­¦ä¹ è§£å†³å·¥ä½œä¸­é‡åˆ°ä¸€èˆ¬é—®é¢˜ï¼Œå…·æœ‰ä¸€å®šçš„å­¦ä¹ ã€åˆ›æ–°èƒ½åŠ›ï¼Œèƒ½åœ¨é¢†å¯¼çš„æŒ‡å¯¼ä¸‹å¸®åŠ©å…¬å¸æ”¹è¿›æˆ–ä¼˜åŒ–äº§å“è®¾è®¡ã€åˆ›æ–°æˆ–åˆ›æ„è®¾è®¡ï¼›
- **1-4 åˆ†**ï¼Œèƒ½å®Œæˆç›¸åº”è®¾è®¡å·¥ä½œåŠä»»åŠ¡ï¼Œæ— æ˜æ˜¾åˆ›æ–°èƒ½åŠ›æˆ–åˆ›æ–°æ„è¯†ï¼›
- **0 åˆ†**ï¼Œå­¦ä¹ å°‘ï¼Œåˆ›æ–°èƒ½åŠ›å·®ï¼Œæ— æ³•æ›´æ–°ç°æœ‰è®¾è®¡èƒ½åŠ›æˆ–æ°´å¹³ã€‚

è¯„ä¼°å…³é”®ç‚¹ï¼šæŒç»­å­¦ä¹ å’Œåˆ›æ–°æ€ç»´ã€å—ä¼—åˆ†æä¸è®¾è®¡ç†å¿µèåˆåº¦ã€äº§å“å“è´¨ä¸ç”¨æˆ·ä½“éªŒæå‡åº¦ã€å¥½è¯„ç‡ã€‚

---

##### 6.1.4.3 å¼€å‘

###### 1. å·¥ä½œå“è´¨

- **15 åˆ†**ï¼Œæ€»æ˜¯å¦‚æœŸæˆ–æå‰å®Œæˆå·¥ä½œï¼Œå·¥ä½œä¸­æ— ä»»ä½•ç‘•ç–µï¼›
- **1-14 åˆ†**ï¼ŒBugs æƒ…å†µï¼ˆæ•°é‡ã€Bugs é‡å¤æ¿€æ´»æ•°ã€è¿å¸¦ bugsï¼‰ï¼ˆ8 åˆ†ï¼‰ï¼›å·¥ä½œç»“æœç»¼è¯„ï¼ˆ6 åˆ†ï¼‰ï¼›
  - Bugs æ•°é‡æ‰£åˆ†æ ‡å‡†ï¼šä¸€ç±»çš„ 1 åˆ†ã€äºŒç±» 0.5 åˆ†ï¼›
  - å½“æœˆä¸€ç±» bugs ä¸èƒ½è¶…è¿‡ 7 ä¸ªï¼ŒäºŒç±»ä¸èƒ½è¶…è¿‡ 14 ä¸ªï¼Œè¶…å‡ºæŒ‰ â‘  è§„åˆ™æ‰£é™¤ï¼›
  - Bugs é‡å¤æ¿€æ´»æ•°è¶…è¿‡ 3 æ¬¡åï¼Œæ¯å‡ºç°ä¸€æ¬¡æ‰£ 1 åˆ†ï¼›
  - è¿å¸¦ bugs æƒ…å†µç”±é¡¹ç›®ç»ç†ç»¼åˆè¯„ä¼°è§†å…·ä½“æƒ…å†µæ‰£é™¤ç›¸åº”åˆ†å€¼ï¼›
  - å½“æœˆæ— äº¤ä»˜æµ‹è¯•ç‰ˆæœ¬çš„ï¼Œè¯¥é¡¹æŒ‰å·¥ä½œç»“æœç”±é¡¹ç›®ç»ç†ç»¼åˆè¯„ä¼°ï¼›
- **0 åˆ†**ï¼Œå·¥ä½œå“è´¨è¾ƒä½ï¼Œå‡ºç°é‡å¤§ç‘•ç–µå¯¼è‡´é¡¹ç›®ä¸¥é‡å»¶æœŸï¼ˆ3 å¤©ä»¥ä¸Šï¼‰æ— æ³•äº¤ä»˜ç‰ˆæœ¬ï¼›

è€ƒæ ¸ç‚¹ï¼šå·¥ä½œç»“æœæ€»è¯„ï¼ˆä¸‰ç±»ã€å››ç±» bugs æ•°é‡ï¼›è¿å¸¦ bugs æ•°é‡ï¼›æ— äº¤ä»˜æµ‹è¯•ç‰ˆæœ¬æƒ…å†µï¼›å…¶ä»–æƒ…å†µï¼‰

---

###### 2. å·¥ä½œå®Œæˆæ•ˆç‡

- **15 åˆ†**ï¼Œå·¥ä½œæ•ˆç‡éå¸¸é«˜ï¼Œèƒ½ä¿è´¨ä¿é‡å®Œæˆä»»åŠ¡ï¼Œç»å¤§éƒ¨åˆ†åˆ†å†…å·¥ä½œå‡æå‰å®Œæˆï¼Œå·¥ä½œè´¨é‡å’Œæ•ˆæœè¶…å‡ºé¢„æœŸï¼ŒåŠ å¿«äº†åä½œè¿›ç¨‹ï¼Œä¸”åé¦ˆåŠæ—¶è¿›åº¦å’Œç»“æœï¼›èƒ½å¯¹ç–‘éš¾ç‚¹ã€åŠŸèƒ½ç‚¹è¿›è¡Œæ€è€ƒå¹¶å¯¹è®¾è®¡å’Œå¼€å‘æå‡ºåˆ›æ–°æˆ–å®Œå–„çš„å»ºè®®æˆ–æ„è§ï¼›
- **13-14 åˆ†**ï¼Œå·¥ä½œæ•ˆç‡å¾ˆé«˜ï¼Œèƒ½æŒ‰æ—¶å®Œæˆå²—ä½èŒè´£å·¥ä½œï¼Œåˆ†å†…å·¥ä½œå‡èƒ½æŒ‰æ—¶æŒ‰è¦æ±‚å®Œæˆï¼Œè¿˜å¯ååŠ©å…¶ä»–åŒäº‹å®Œæˆé¢å¤–å·¥ä½œä»»åŠ¡ï¼Œä¿è¯æ­£å¸¸çš„åä½œè¿›ç¨‹ï¼Œèƒ½å¯¹ç–‘éš¾ç‚¹ã€åŠŸèƒ½ç‚¹è¿›è¡Œæå‰çš„æ•´ç†å’Œæå‡ºå®ç”¨çš„å»ºè®®æˆ–æ„è§ã€‚è¯„ä¼°å…³é”®ç‚¹ï¼ˆ10 åˆ†ä¸ºåŸºç¡€ï¼‰ï¼šæŒ‰æ—¶ï¼ˆ+0ï¼‰ã€é«˜æ•ˆï¼ˆ+1ï¼‰ã€ååŠ©ï¼ˆ+1ï¼‰ã€ç–‘éš¾é—®é¢˜å»ºè®¾æ€§çš„å»ºè®®ï¼ˆ+1-2ï¼‰ã€‚
- **10-12 åˆ†**ï¼Œå·¥ä½œæ•ˆç‡é«˜ï¼ŒåŸºæœ¬èƒ½æŒ‰æ—¶å®Œæˆå²—ä½èŒè´£å·¥ä½œï¼Œåˆ†å†…å·¥ä½œèƒ½æŒ‰åŸºæœ¬è¦æ±‚å®Œæˆï¼Œå¶å°”èƒ½å¯¹ç–‘éš¾ç‚¹ã€åŠŸèƒ½ç‚¹è¿›è¡Œæå‰çš„æ•´ç†å’Œæå‡ºå®ç”¨çš„å»ºè®®æˆ–æ„è§ã€‚è¯„ä¼°å…³é”®ç‚¹ï¼ˆ10 åˆ†ä¸ºåŸºç¡€ï¼‰ï¼šæŒ‰æ—¶ï¼ˆ+0ï¼‰ã€åˆ†å†…å·¥ä½œä»…æŒ‰åŸºæœ¬è¦æ±‚å®Œæˆï¼ˆ+0ï¼‰ã€ä½¿ç”¨çš„å»ºè®®ï¼ˆ+1-2ï¼‰ã€‚
- **5-9 åˆ†**ï¼Œå·¥ä½œæ•ˆç‡ä¸€èˆ¬ï¼Œä»…èƒ½æŒ‰æ—¶å®ŒæˆèŒè´£å·¥ä½œï¼Œå¶å°”ä¸èƒ½æŒ‰æ—¶æŒ‰è¦æ±‚å®Œæˆåˆ†å†…å·¥ä½œï¼Œä½†ä¸å½±å“åä½œè¿›ç¨‹ã€‚è¯„ä¼°å…³é”®ç‚¹ï¼šä¸èƒ½æŒ‰æ—¶å®Œæˆå·¥ä½œéƒ¨åˆ†ï¼Œæ ¹æ®ç¦…é“ä»»åŠ¡æ¯å»¶æœŸä¸€é¡¹æ‰£ä¸€åˆ†ã€‚
- **1-4 åˆ†**ï¼Œå·¥ä½œæ•ˆç‡ä½ï¼Œéœ€è¦åˆ«äººå¸®åŠ©æ‰èƒ½å®Œæˆå²—ä½èŒè´£å·¥ä½œï¼Œç»å¸¸ä¸èƒ½æŒ‰æ—¶æŒ‰è¦æ±‚å®Œæˆåˆ†å†…å·¥ä½œï¼Œé€ æˆä¸€å®šå½±å“åä½œè¿›ç¨‹ï¼ˆè§†å½±å“æƒ…å†µæ‰£å‡è¯„åˆ†ï¼‰ï¼›è¯„ä¼°å…³é”®ç‚¹ï¼šä¸èƒ½æŒ‰æ—¶å®Œæˆå·¥ä½œéƒ¨åˆ†ï¼Œæ ¹æ®ç¦…é“ä»»åŠ¡æ¯å»¶æœŸä¸€é¡¹æ‰£ä¸€åˆ†ã€‚
- 0 åˆ†ï¼Œå·¥ä½œæ•ˆç‡æä½ï¼Œä¸èƒ½æŒ‰ç…§å²—ä½èŒè´£å®Œæˆå·¥ä½œï¼Œä¸¥é‡é˜»å¡åä½œè¿›ç¨‹ã€‚å¦‚ä»»åŠ¡å®Œæˆæƒ…å†µä¸å®é™…è¯„ä¼°å·¥æ—¶ä¸åŒ¹é…ï¼Œä¸¥é‡è¶…æ—¶ï¼ˆè¶…å‡ºé¢„è®¡å·¥æ—¶ 1/3 åŠä»¥ä¸Šè€…ï¼‰ï¼Œåˆ™è¯¥é¡¹ç»©æ•ˆä¸º 0ã€‚ åŠ åˆ†é¡¹ï¼šä¿è´¨ä¿é‡å¹¶æå‰å®Œæˆå·¥ä½œï¼Œå¯æ ¹æ®å®é™…é…Œæƒ…åŠ  1-5 åˆ†ã€‚

---

###### 3. ç‰ˆæœ¬äº¤ä»˜

- **15 åˆ†**ï¼Œæ¯ä¸€ä¸ªé‡Œç¨‹ç¢‘äº‹ä»¶æˆ–å¼€å‘ã€æµ‹è¯•æˆ–æ­£å¼ç‰ˆæœ¬å‡èƒ½å¦‚æœŸæˆ–æå‰äº¤ä»˜ï¼›
- **1-14 åˆ†**ï¼Œåœ¨æ¯ä¸€ä¸ªé‡Œç¨‹ç¢‘äº‹ä»¶æˆ–å¼€å‘ã€æµ‹è¯•æˆ–æ­£å¼ç‰ˆæœ¬ä¸­ï¼Œå› ä»»åŠ¡æœªå®Œæˆï¼Œå¯¼è‡´æ— æ³•å‘ç‰ˆï¼Œé€ æˆæµ‹è¯•å·¥ä½œå»¶æœŸï¼Œæ¯å»¶æœŸ 0.5 å¤©ï¼ˆä¸è¶³æŒ‰ 0.5 å¤©è®¡ï¼‰æ‰£ 2 åˆ†ï¼›ç¦…é“ä»»åŠ¡å»¶æœŸä¸€é¡¹æ‰£ 1 åˆ†ï¼Œæœ‰ä¸å…¶ä»–äººå‘˜åä½œä»»åŠ¡ï¼ˆä¾èµ–å…³ç³»ï¼‰ï¼Œå»¶æœŸä¸€é¡¹æ‰£ 2 åˆ†ï¼›
- **0 åˆ†**ï¼Œè¶…è¿‡ 2 å¤©ä¸èƒ½äº¤ä»˜ï¼ŒæŒ‰è¯¥é¡¹ç»©æ•ˆä¸º 0ã€‚

å…¶ä»–ï¼šå¦‚å› å…¶ä»–å›¢é˜Ÿå¯¼è‡´æ— æ³•æŒ‰æ—¶å‘ç‰ˆï¼ŒæŒ‰è´£ä»»çº§åˆ«æ‰£é™¤ç›¸åº”åˆ†å€¼ï¼Œè´£ä»»åˆ†çº§å¦‚ä¸‹ï¼š1ã€è´Ÿä¸»è¦è´£ä»»çš„æ‰£ï¼š90%-100%ï¼›2ã€è´Ÿæ¬¡è¦è´£ä»»çš„æ‰£ï¼š50%ï¼›3ã€å…¶ä»–å›¢é˜Ÿæ¥å—è¿åè´£ä»»ï¼Œæ‰£ï¼š30%ã€‚ å¦‚å› ä»»åŠ¡ç©¿æ’ï¼Œäººå‘˜è°ƒé…å¯¼è‡´äººåŠ›èµ„æºä¸è¶³ç­‰ç‰¹æ®Šæƒ…å†µé€ æˆçš„å»¶æœŸï¼Œç”±æŠ€æœ¯ä¸­å¿ƒç®¡ç†å°ç»„ç»¼åˆè¯„ä¼°å¦åšè€ƒæ ¸ã€‚

---

###### 4. ä»£ç è´¨é‡

- **5 åˆ†**ï¼Œä¸¥æ ¼éµå¾ªç¼–ç è§„èŒƒï¼Œå¯è¯»æ€§å¼ºã€å¯æ‰©å±•æ€§å¥½ï¼Œå¯ç»´æŠ¤æ€§å¼ºï¼Œä»£ç æ³¨é‡Šè¯¦ç»†ä¸”æœ‰ä¿®æ”¹è®°å½•å¤‡æ³¨ï¼›
- **4 åˆ†**ï¼Œéµå¾ªç¼–ç è§„èŒƒï¼Œå¯è¯»æ€§è¾ƒå¼ºã€å¯æ‰©å±•æ€§è¾ƒå¥½ã€å¯ç»´æŠ¤æ€§è¾ƒå¼ºï¼Œä»£ç æ³¨é‡Šè¾ƒå…¨ï¼›
- **3 åˆ†**ï¼Œä»£ç è§„èŒƒåŒ–ä¸€èˆ¬ï¼Œå¯è¯»æ€§ä¸€èˆ¬ã€å¯æ‰©å±•æ€§ä¸€èˆ¬ã€å¯ç»´æŠ¤æ€§ä¸€èˆ¬ï¼Œä»…æœ‰å…³é”®éƒ¨åˆ†ä»£ç æ³¨é‡Šï¼›
- **2 åˆ†**ï¼Œç¼–ç ä¸è§„èŒƒï¼Œå¯è¯»æ€§å·®ã€å¯æ‰©å±•æ€§å·®ã€å¯ç»´æŠ¤æ€§å·®ï¼Œä»…æœ‰ç®€å•çš„ä»£ç æ³¨é‡Šï¼›
- **1 åˆ†**ï¼Œç¼–ç æ¯«æ— è§„èŒƒå¯è¨€ï¼Œå¯è¯»æ€§ã€å¯æ‰©å±•æ€§ã€å¯ç»´æŠ¤æ€§è¾ƒå·®ï¼Œä»£ç æ— æ³¨é‡Šï¼›
- **0 åˆ†**ï¼Œä»£ç æ— è§„èŒƒï¼Œæ¯«æ— å¯è¯»æ€§ã€å¯æ‰©å±•æ€§ã€å¯ç»´æŠ¤æ€§å¯è¨€ï¼Œä»£ç æ— æ³¨é‡Šï¼›

---

###### 5. å·¥ä½œé‡

- **10 åˆ†**ï¼Œå·¥ä½œé¥±å’Œåº¦ 100%ï¼›
- **1-9 åˆ†**ï¼Œå¯¹åº”é¥±å’Œåº¦ 50%-90%ã€‚æ ¹æ® WBS æœ‰æ•ˆå·¥æ—¶è¯„ä¼°ï¼Œæ¯æœˆæœ‰æ•ˆå·¥æ—¶æŒ‰ 144 æ—¶ï¼ˆ18 ä¸ªå·¥ä½œæ—¥ï¼‰è®¡ã€‚
- 0 åˆ†ï¼Œå·¥ä½œé‡ä½äº 50% ä¸”ä¸ä¸»åŠ¨å¼€å±•å…¶ä»–å°ç»„æˆ–éƒ¨é—¨å…¶ä»–ä»»åŠ¡è€…ï¼Œæˆ–æ— ä»»ä½•å·¥ä½œä»»åŠ¡ï¼Œä¸”ä¸æ„¿æˆ–ä¸ä¸»åŠ¨åˆ†æ‹…å…¶ä»–è·ŸåŒäº‹å·¥ä½œä»»åŠ¡çš„æƒ…å†µã€‚

è¯´æ˜ï¼šå¦‚åœ¨å½“æœŸå·¥ä½œ 100% çš„é¥±å’Œåº¦æƒ…å†µä¸‹ï¼Œä»èƒ½ä¸»åŠ¨åˆ†æ‹…å…¶ä»–åŒäº‹ä»»åŠ¡ï¼Œå¹¶ä¿è´¨ä¿é‡å®Œæˆï¼Œå¯è§†å®é™…æƒ…å†µé…Œæƒ…è€ƒè™‘åŠ  1-5 åˆ†ã€‚

---

###### 6. æ–‡æ¡£è§„èŒƒæ€§ã€åŠæ—¶æ€§

åŒ…å«ï¼š é‡è¦çš„åŠŸèƒ½æµç¨‹è¯´æ˜æ–‡æ¡£ ç³»ç»Ÿæ¡†æ¶æˆ–é‡è¦ç±»åº“è¯´æ˜æ–‡æ¡£ é‡è¦çš„æ•°æ®æµè¯´æ˜æ–‡æ¡£ æŠ€æœ¯è¯¦ç»†è®¾è®¡æ–‡æ¡£ å…¶ä»–é‡è¦çš„æŠ€æœ¯æ–‡æ¡£

- **5 åˆ†**ï¼Œéå¸¸è§„èŒƒéå¸¸åŠæ—¶ï¼Œéšæ—¶éƒ½å¯ä»¥æŸ¥é˜…ä»»æ„ç›¸å…³æ–‡æ¡£ï¼›é‡è¦çš„åŠŸèƒ½æ¨¡å—ã€æ ¸å¿ƒæµç¨‹ã€é‡è¦çš„ç±»åº“ç­‰æœ‰å®Œæ•´ã€è¯¦ç»†çš„æŠ€æœ¯è®¾è®¡æ–‡æ¡£ï¼Œé‡è¦çš„è½¯ä»¶äº§å“æˆ–ç³»ç»ŸæœåŠ¡çš„å®‰è£…ã€é…ç½®æˆ–éƒ¨ç½²æ“ä½œæ‰‹å†Œï¼› 4 åˆ†ï¼Œéå¸¸è§„èŒƒï¼Œè¾ƒåŠæ—¶ï¼Œæ–‡æ¡£ç¼–å†™æ»å 2 å¤©ä»¥å†…ï¼›æœ‰ç›¸å…³çš„æŠ€æœ¯è®¾è®¡æ–‡æ¡£ï¼›
- **3 åˆ†**ï¼Œè§„èŒƒåŒ–ä¸€èˆ¬ï¼Œæ–‡æ¡£æ»å 3-5 å¤©ï¼›æœ‰ç›¸å…³çš„ã€ç®€è¦çš„æŠ€æœ¯è®¾è®¡æ–‡æ¡£æˆ–æ‰‹å†Œï¼›
- **2 åˆ†**ï¼ŒåŸºæœ¬èƒ½æŒ‰è§„èŒƒè¦æ±‚ä¹¦å†™ï¼Œå¸¸å¸¸éš¾ä»¥æŸ¥é˜…ï¼Œæ–‡æ¡£æ»å 6 å¤©ä»¥ä¸Šï¼›ç¼ºå¤±é‡è¦æ–‡æ¡£ 2-3 é¡¹ï¼›
- 1 åˆ†ï¼Œéœ€è¦ä¸Šçº§é¢†å¯¼æŒ‡å¯¼æ‰èƒ½å®Œæˆä¹¦å†™ï¼Œéš¾ä»¥æŸ¥é˜…ï¼Œæ–‡æ¡£ä¸¥é‡æ»åæˆ–ç¼ºå¤±ï¼›
- **0 åˆ†**ï¼Œä¸è§„èŒƒã€ä¸åŠæ—¶ï¼Œå¸¸å¸¸éš¾ä»¥æŸ¥é˜…ï¼Œç”šè‡³æ²¡æœ‰ç¼–å†™ç›¸å…³æ–‡æ¡£ï¼›æˆ–è€…ä¸‰æ— ï¼šæ— æŠ€æœ¯è®¾è®¡æ–‡æ¡£ã€æ“ä½œæ‰‹å†Œï¼›

---

##### 6.1.4.4 æµ‹è¯•

###### 1. éœ€æ±‚ç†Ÿæ‚‰ç¨‹åº¦

- **10 åˆ†**ï¼Œéœ€æ±‚ç†è§£æ— è¯¯ï¼Œå¹¶èƒ½æå‡ºéœ€æ±‚ç–‘ç‚¹ç”šè‡³æå‡ºå»ºè®®æˆ–æ„è§ï¼›
- **8-9 åˆ†**ï¼Œå®Œæ•´ç†è§£éœ€æ±‚ï¼Œèƒ½æ ¹æ®éœ€æ±‚å‡†ç¡®å®šä¹‰ç”¨ä¾‹ï¼›
- **5-7 åˆ†**ï¼Œç†è§£éœ€æ±‚ï¼ŒåŸºæœ¬èƒ½æ ¹æ®éœ€æ±‚å®šä¹‰å‡ºå®Œæ•´çš„ç”¨ä¾‹ï¼›
- **1-4 åˆ†**ï¼Œåœ¨æŒ‡å¯¼æˆ–å¤šæ¬¡è®²è§£ä¸‹èƒ½ç†è§£éœ€æ±‚åŠæµç¨‹ï¼Œä¹¦å†™ç”¨ä¾‹ï¼›
- **0 åˆ†**ï¼Œåœ¨æŒ‡å¯¼ä¸‹æˆ–å¤šæ¬¡è®²è§£åä»ä¸èƒ½å‡†ç¡®ç†è§£éœ€æ±‚ï¼Œå®šä¹‰ç”¨ä¾‹å®Œæ•´åº¦è¾ƒä½ã€‚

---

###### 2. æµ‹è¯•ç”¨ä¾‹å®Œæˆè´¨é‡

- **10 åˆ†**ï¼Œæµ‹è¯•ç”¨ä¾‹å†…å®¹åŠæ­¥éª¤çš„è¯¦ç»†åº¦é«˜ã€ç»“æ„æ¸…æ™°ï¼Œå¯æ‰§è¡Œæ€§é«˜ï¼Œæè¿°ç®€æ´æ˜äº†ï¼Œèƒ½å‡†ç¡®æè¿°æµ‹è¯•é¢„æœŸç»“æœï¼Œç”¨ä¾‹èƒ½å¾ˆå¥½å½’ç±»å®šçº§ï¼Œç”¨ä¾‹è¦†ç›–é¢å…¨ï¼›
- **8-9 åˆ†**ï¼Œæµ‹è¯•ç”¨ä¾‹å®Œæ•´ï¼Œå†…å®¹åŠæ­¥éª¤æè¿°æ¸…æ™°ï¼Œå¯æ‰§è¡Œæ€§é«˜ï¼Œæœ‰å½’ç±»ï¼Œé‡è¦é€»è¾‘åŸºæœ¬è¦†ç›–ï¼›
- **5-7 åˆ†**ï¼Œæµ‹è¯•ç”¨ä¾‹å†…å®¹åŠæ­¥éª¤æè¿°ç®€å•ï¼Œå¯æ‰§è¡Œæ€§ä¸€èˆ¬ï¼Œç”¨ä¾‹è¦†ç›–é¢ä¸å‘¨å…¨ï¼›
- 1-4ï¼Œæµ‹è¯•ç”¨ä¾‹ä¸å®Œå–„ï¼Œå¯æ‰§è¡Œæ€§å·®ï¼›
- **0 åˆ†**ï¼Œæµ‹è¯•ç”¨ä¾‹ä¸è§„èŒƒã€ä¸å®Œå–„ï¼Œæ— å¯æ‰§è¡Œæ€§ã€‚

è€ƒæ ¸è¦ç‚¹ï¼šå†…å®¹åŠæ­¥éª¤çš„è¯¦ç»†åº¦ã€å¯æ‰§è¡Œåº¦ã€æ˜¯å¦èƒ½å‡†ç¡®æè¿°æµ‹è¯•é¢„æœŸç»“æœã€å½’ç±»ä¸å®šçº§æ˜¯å¦æ¸…æ™°ã€è¦†ç›–ç‡ã€‚

---

###### 3. BUG æè¿°è´¨é‡

- **10 åˆ†**ï¼ŒBUG æè¿°è§„èŒƒæ¸…æ™°ã€ç®€æ´æ˜äº†ã€å›¾æ–‡å¹¶èŒ‚ã€æ³¨é‡Šæ¸…æ™°ï¼Œèƒ½æœ‰æ•ˆã€å‡†ç¡®çš„æŒ‰æ­¥éª¤é‡ç°ï¼›
- **8-9 åˆ†**ï¼ŒBUG æè¿°è§„èŒƒæ¸…æ™°ã€ç®€æ´æ˜äº†ã€å›¾æ–‡å¹¶èŒ‚ï¼Œä½†æˆªå›¾æˆ–æ³¨é‡Š/æè¿°è¯´æ˜ä¸å¤Ÿæ¸…æ™°ï¼Œèƒ½æœ‰æ•ˆçš„æŒ‰æ­¥éª¤é‡ç°ï¼›
- **5-7 åˆ†**ï¼šBUG æè¿°ä¸€èˆ¬ï¼Œå‹‰å¼ºèƒ½æœ‰æ•ˆæŒ‰æ­¥éª¤é‡ç°ï¼›
- **1-4 åˆ†**ï¼šBUG æè¿°ä¸å®é™…æœ‰å‡ºå…¥ï¼Œé€šè¿‡æ²Ÿé€šèƒ½é‡ç°ï¼›
- **0**ï¼šBUG æè¿°æ··ä¹±ï¼Œä¸èƒ½ç†è§£ã€‚

---

###### 4. æµ‹è¯•å·¥ä½œå“è´¨&ç‰ˆæœ¬äº¤ä»˜

- **10 åˆ†**ï¼Œæ€»æ˜¯å¦‚æœŸæˆ–æå‰å®Œæˆå·¥ä½œï¼Œå·¥ä½œä¸­æ— ä»»ä½•ç‘•ç–µï¼›æ¯ä¸€ä¸ªé‡Œç¨‹ç¢‘äº‹ä»¶æˆ–å¼€å‘ã€æµ‹è¯•æˆ–æ­£å¼ç‰ˆæœ¬å‡èƒ½å¦‚æœŸæˆ–æå‰äº¤ä»˜ï¼› 8-9 åˆ†ï¼Œèƒ½è¿‘æœŸå®Œæˆå·¥ä½œï¼Œå·¥ä½œå“è´¨é«˜ï¼ŒåŸºæœ¬æ— ç‘•ç–µæˆ–å­˜åœ¨æœ‰ä¸å½±å“æ­£å¸¸ä½¿ç”¨çš„ bugï¼ˆ4 ç±»ï¼‰ï¼›
- **5-7 åˆ†**ï¼ŒåŸºæœ¬èƒ½å®Œæˆå·¥ä½œï¼Œå¶å°”æœ‰å°ç‘•ç–µï¼ˆ4 ç±»ï¼‰ï¼›
- **1-4 åˆ†**ï¼Œå·¥ä½œå“è´¨ä¸€èˆ¬ï¼Œå¶å°”æœ‰è¾ƒå¤§ç‘•ç–µï¼ˆ3 ç±»ï¼‰ï¼›
- **0 åˆ†**ï¼Œå·¥ä½œå“è´¨è¾ƒä½ï¼Œå¶å°”å‡ºç°é‡å¤§ç‘•ç–µï¼ˆ2 ç±»ï¼‰ï¼›
- **-10 åˆ†**ï¼Œå‡ºç°ä¸¥é‡æˆ–è‡´å‘½çš„ bug å¯¼è‡´æŸä¸ªéæ ¸å¿ƒåŠŸèƒ½æ¨¡å—æ— æ³•æ­£å¸¸è¿è¡Œï¼ˆ1 ç±»æˆ– 2 ç±»ï¼‰ï¼› ç»©æ•ˆä¸º 0ï¼Œå‡ºç°ä¸¥é‡æˆ–è‡´å‘½çš„ bug å¯¼è‡´æŸä¸ªæˆ–æŸå‡ ä¸ªæ ¸å¿ƒåŠŸèƒ½æ— æ³•æ­£å¸¸è¿è¡Œã€‚

ç‰ˆæœ¬äº¤ä»˜è€ƒæ ¸ç‚¹ï¼šåœ¨æ¯ä¸€ä¸ªé‡Œç¨‹ç¢‘äº‹ä»¶æˆ–å¼€å‘ã€æµ‹è¯•æˆ–æ­£å¼ç‰ˆæœ¬ä¸­ï¼Œå› ä»»åŠ¡æœªå®Œæˆï¼Œå¯¼è‡´æ— æ³•å‘ç‰ˆï¼Œé€ æˆæµ‹è¯•å·¥ä½œå»¶æœŸï¼Œæ¯å»¶æœŸ 0.5 å¤©ï¼ˆä¸è¶³æŒ‰ 0.5 å¤©è®¡ï¼‰æ‰£ 2 åˆ†ï¼›ç¦…é“ä»»åŠ¡å»¶æœŸä¸€é¡¹æ‰£ 1 åˆ†ï¼Œæœ‰ä¸å…¶ä»–äººå‘˜åä½œä»»åŠ¡ï¼Œå»¶æœŸä¸€é¡¹æ‰£ 2 åˆ†ï¼›

å…¶ä»–ï¼šå¦‚å› å…¶ä»–å›¢é˜Ÿå¯¼è‡´æ— æ³•æŒ‰æ—¶å‘ç‰ˆï¼ŒæŒ‰è´£ä»»çº§åˆ«æ‰£é™¤ç›¸åº”åˆ†å€¼ï¼Œè´£ä»»åˆ†çº§å¦‚ä¸‹ï¼š1ã€è´Ÿä¸»è¦è´£ä»»çš„æ‰£ï¼š90%-100%ï¼›2ã€è´Ÿæ¬¡è¦è´£ä»»çš„æ‰£ï¼š50%ï¼›3ã€å…¶ä»–å›¢é˜Ÿæ¥å—è¿å¸¦è´£ä»»ï¼Œæ‰£ï¼š30%ã€‚ å¦‚å› ä»»åŠ¡ç©¿æ’ï¼Œäººå‘˜è°ƒé…å¯¼è‡´äººåŠ›èµ„æºä¸è¶³ç­‰ç‰¹æ®Šæƒ…å†µé€ æˆçš„å»¶æœŸï¼Œç”±æŠ€æœ¯ä¸­å¿ƒç®¡ç†å°ç»„ç»¼åˆè¯„ä¼°å¦åšè€ƒæ ¸ã€‚

---

###### 5. å·¥ä½œå®Œæˆæ•ˆç‡

- **10 åˆ†**ï¼Œå·¥ä½œæ•ˆç‡å¾ˆé«˜ï¼Œèƒ½ä¿è´¨ä¿é‡å®Œæˆä»»åŠ¡ï¼Œç»å¤§éƒ¨åˆ†åˆ†å†…å·¥ä½œå‡æå‰å®Œæˆï¼Œå·¥ä½œè´¨é‡å’Œæ•ˆæœè¶…å‡ºé¢„æœŸï¼ŒåŠ å¿«äº†åä½œè¿›ç¨‹ï¼Œä¸”åé¦ˆåŠæ—¶ï¼›
- **8-9 åˆ†**ï¼Œå·¥ä½œæ•ˆç‡é«˜ï¼Œèƒ½æŒ‰æ—¶å®Œæˆå²—ä½èŒè´£å·¥ä½œï¼Œåˆ†å†…å·¥ä½œå‡èƒ½æŒ‰æ—¶æŒ‰è¦æ±‚å®Œæˆï¼Œä¿è¯æ­£å¸¸çš„åä½œè¿›ç¨‹ï¼›
- **5-7 åˆ†**ï¼Œå·¥ä½œæ•ˆç‡ä¸€èˆ¬ï¼ŒåŸºæœ¬èƒ½æŒ‰æ—¶å®ŒæˆèŒè´£å·¥ä½œï¼Œå¶å°”ä¸èƒ½æŒ‰æ—¶æŒ‰è¦æ±‚å®Œæˆåˆ†å†…å·¥ä½œï¼Œä½†ä¸å½±å“åä½œè¿›ç¨‹ï¼›
- **1-4 åˆ†**ï¼Œå·¥ä½œæ•ˆç‡ä½ï¼Œéœ€è¦åˆ«å¸®åŠ©æ‰èƒ½å®Œæˆå²—ä½èŒè´£å·¥ä½œï¼Œç»å¸¸ä¸èƒ½æŒ‰æ—¶æŒ‰è¦æ±‚å®Œæˆåˆ†å†…å·¥ä½œï¼Œå½±å“åä½œè¿›ç¨‹ï¼›
- **0 åˆ†**ï¼Œå·¥ä½œæ•ˆç‡æä½ï¼Œä¸èƒ½æŒ‰ç…§å²—ä½èŒè´£å®Œæˆå·¥ä½œã€‚

---

###### 6. è¿›åº¦æ›´æ–°ï¼ŒBUG è·Ÿè¸ª

- **5 åˆ†**ï¼ŒåŠæ—¶å…³æ³¨ç ”å‘è¿›åº¦åŠ BUG çŠ¶æ€ï¼Œæœ‰é—®é¢˜æ—¶èƒ½åŠæ—¶åæ˜ å¹¶èƒ½æå‡ºæœ‰æ•ˆæˆ–å»ºè®¾æ€§æ„è§ï¼Œæ¨åŠ¨æµ‹è¯•è¿›è¡Œï¼›å‡†æ—¶åŠæå‰å®Œæˆæµ‹è¯•ä»»åŠ¡ï¼›
- **4 åˆ†**ï¼Œèƒ½ä¸»åŠ¨å…³æ³¨ç ”å‘è¿›åº¦åŠæ›´æ–° BUG çŠ¶æ€ï¼Œèƒ½åŠæ—¶å‘ç°å¹¶åæ˜ é—®é¢˜ï¼Œä¿ƒè¿›æµ‹è¯•è¿›è¡Œï¼Œèƒ½å‡†æ—¶å®Œæˆæµ‹è¯•ä»»åŠ¡ï¼›ï¼›
- **3 åˆ†**ï¼Œç»æé†’åï¼Œèƒ½æ›´æ–°æµ‹è¯•è¿›åº¦åŠ BUG çŠ¶æ€ï¼ŒåŸºæœ¬å¦‚æœŸå®Œæˆæµ‹è¯•ä»»åŠ¡ä¸Šï¼›
- **1-2 åˆ†**ï¼Œæµ‹è¯•è¿›åº¦æ²¡æœ‰æ›´æ–°ï¼Œå‘ç°å·²ä¸Šçº¿é¡¹ç›®çš„ BUG çŠ¶æ€æ²¡æœ‰æ›´æ–°ï¼›
- **0 åˆ†**ï¼Œæ²¡æœ‰å…³æ³¨é¡¹ç›®è¿›åº¦åŠ BUG çŠ¶æ€ã€‚

---

###### 7. å·¥ä½œé‡

- **10 åˆ†**ï¼Œå·¥ä½œé¥±å’Œåº¦ 100%ï¼›
- **1-9 åˆ†**ï¼Œå¯¹åº”é¥±å’Œåº¦ 50%-90%ã€‚æ ¹æ® WBS æœ‰æ•ˆå·¥æ—¶è¯„ä¼°ï¼Œæ¯æœˆæœ‰æ•ˆå·¥æ—¶æŒ‰ 144 æ—¶ï¼ˆ18 ä¸ªå·¥ä½œæ—¥ï¼‰è®¡ã€‚
- **0 åˆ†**ï¼Œå·¥ä½œé‡ä½äº 50% ä¸”ä¸ä¸»åŠ¨å¼€å±•å…¶ä»–å°ç»„æˆ–éƒ¨é—¨å…¶ä»–ä»»åŠ¡è€…ï¼Œæˆ–æ— ä»»ä½•å·¥ä½œä»»åŠ¡ï¼Œä¸”ä¸æ„¿æˆ–ä¸ä¸»åŠ¨åˆ†æ‹…å…¶ä»–è·ŸåŒäº‹å·¥ä½œä»»åŠ¡çš„æƒ…å†µã€‚

è¯´æ˜ï¼šå¦‚åœ¨å½“æœŸå·¥ä½œ 100% çš„é¥±å’Œåº¦æƒ…å†µä¸‹ï¼Œä»èƒ½ä¸»åŠ¨åˆ†æ‹…å…¶ä»–åŒäº‹ä»»åŠ¡ï¼Œå¹¶ä¿è´¨ä¿é‡å®Œæˆï¼Œå¯è§†å®é™…æƒ…å†µé…Œæƒ…è€ƒè™‘åŠ  1-5 åˆ†ã€‚

---

###### 8. æµ‹è¯•ç”¨ä¾‹è¯„å®¡æŠ¥å‘Šã€æµ‹è¯•ç»“è®ºåŠæŠ¥å‘Šè´¨é‡

- **5 åˆ†**ï¼Œæµ‹è¯•ç”¨ä¾‹è¯„å®¡æŠ¥å‘Šã€æµ‹è¯•æŠ¥å‘Šæ¸…æ™°æ˜ç¡®å¹¶èƒ½åŠæ—¶å‘å‡ºï¼Œæµ‹è¯•ç»“æœã€è¦†ç›–ç‡ã€é€šè¿‡ç‡ã€é‡ç‚¹é—®é¢˜ç­‰èƒ½å‡†ç¡®ã€ç®€å•æ˜äº†çš„è¡¨è¿°å¹¶èƒ½åœ¨æŠ¥å‘Šä¸­é‡‡ç”¨åˆé€‚çš„å›¾è¡¨å±•ç°ã€ä½“ç°ï¼›
- **4 åˆ†**ï¼Œæµ‹è¯•ç”¨ä¾‹è¯„å®¡æŠ¥å‘Šã€æµ‹è¯•æŠ¥å‘Šæ¸…æ™°æ˜äº†å¹¶èƒ½åŠæ—¶å‘å‡ºï¼Œæµ‹è¯•ç»“æœã€è¦†ç›–ç‡ã€é€šè¿‡ç‡ã€é‡ç‚¹é—®é¢˜ç­‰èƒ½åœ¨æŠ¥å‘Šä¸­é‡‡ç”¨åˆé€‚çš„å›¾è¡¨å±•ç°ã€ä½“ç°ï¼›
- **3 åˆ†**ï¼Œæµ‹è¯•ç”¨ä¾‹è¯„å®¡æŠ¥å‘Šã€æµ‹è¯•æŠ¥å‘Šç›¸å¯¹è§„èŒƒèƒ½åŠæ—¶å‘å‡ºï¼ŒåŒ…å«åŸºæœ¬æµ‹è¯•ç»“è®ºç›¸å…³å†…å®¹ï¼›
- **1-2 åˆ†**ï¼Œæœ‰æµ‹è¯•ç”¨ä¾‹è¯„å®¡æŠ¥å‘Šã€æµ‹è¯•æŠ¥å‘Šï¼Œä½†ä¸è§„èŒƒï¼›
- **0 åˆ†**ï¼Œæ— æµ‹è¯•ç”¨ä¾‹è¯„å®¡æŠ¥å‘Šã€æµ‹è¯•æŠ¥å‘Š

---

##### 6.1.4.5 è¿ç»´

###### 1. ç³»ç»Ÿç¨³å®šæ€§ (0-10 åˆ†)

ç¡®ä¿ç³»ç»Ÿæ­£å¸¸è¿è¡Œæ—¶é—´è¾¾åˆ°é¢„å®šç›®æ ‡ï¼Œå¦‚ 99.9% æˆ–æ›´é«˜ã€‚å¯ä»¥é€šè¿‡ç³»ç»Ÿæ•…éšœçš„é¢‘ç‡å’ŒæŒç»­æ—¶é—´æ¥è¡¡é‡ã€‚

###### 2. æ•…éšœå“åº”å’Œå¤„ç† (0-10 åˆ†)

å¯¹ç³»ç»Ÿæ•…éšœçš„å“åº”æ—¶é—´ï¼Œä»¥åŠè§£å†³é—®é¢˜çš„é€Ÿåº¦å’Œæ•ˆç‡ã€‚

###### 3. æœåŠ¡äº¤ä»˜ (0-10 åˆ†)

æŒ‰æ—¶å®Œæˆè¿ç»´ç›¸å…³çš„ä»»åŠ¡å’ŒæœåŠ¡è¯·æ±‚ï¼Œå¦‚æœåŠ¡å™¨éƒ¨ç½²ã€é…ç½®å˜æ›´ç­‰ã€‚

###### 4. å˜æ›´ç®¡ç† (0-10 åˆ†)

è¯„ä¼°å’Œå®æ–½ç³»ç»Ÿå˜æ›´ï¼ŒåŒæ—¶ç¡®ä¿å˜æ›´ä¸ä¼šå¯¹ç°æœ‰æœåŠ¡é€ æˆè´Ÿé¢å½±å“ã€‚

###### 5. å¤‡ä»½å’Œæ¢å¤ (0-10 åˆ†)

å®šæœŸæ‰§è¡Œæ•°æ®å¤‡ä»½ï¼Œå¹¶èƒ½å¤Ÿåœ¨å‡ºç°é—®é¢˜æ—¶å¿«é€Ÿæ¢å¤æ•°æ®ã€‚

###### 6. å®‰å…¨æ€§èƒ½ (0-10 åˆ†)

ç»´æŠ¤ç³»ç»Ÿçš„å®‰å…¨æ€§ï¼Œé˜²æ­¢æ•°æ®æ³„éœ²å’Œæœªæˆæƒè®¿é—®ã€‚å¯ä»¥é€šè¿‡å®‰å…¨äº‹ä»¶çš„æ¬¡æ•°å’Œå®‰å…¨æ¼æ´çš„ä¿®å¤é€Ÿåº¦æ¥è¡¡é‡ã€‚

###### 7. æ€§èƒ½ä¼˜åŒ– (0-10 åˆ†)

ç›‘æ§ç³»ç»Ÿæ€§èƒ½ï¼ŒåŠæ—¶è¯†åˆ«å’Œè§£å†³æ€§èƒ½ç“¶é¢ˆï¼Œæé«˜ç³»ç»Ÿæ•ˆç‡ã€‚

---

##### 6.1.4.6 å®æ–½

###### 1. é¡¹ç›®å®æ–½ (0-30 åˆ†)

æŒ‰æ—¶å®Œæˆé¡¹ç›®ä»»åŠ¡å’Œé‡Œç¨‹ç¢‘ã€‚ ç¡®ä¿é¡¹ç›®å®æ–½ç¬¦åˆé¢„å®šçš„æŠ€æœ¯è§„èŒƒå’Œè´¨é‡æ ‡å‡†ã€‚ åœ¨é¢„ç®—å’Œæ—¶é—´èŒƒå›´å†…å®Œæˆé¡¹ç›®å®æ–½å·¥ä½œã€‚

###### 2. å®¢æˆ·å…³ç³»ç®¡ç† (0-10 åˆ†)

å»ºç«‹å’Œç»´æŠ¤è‰¯å¥½çš„å®¢æˆ·å…³ç³»ã€‚ ç¡®ä¿å®¢æˆ·æ»¡æ„åº¦å’Œå¿ è¯šåº¦ã€‚ åŠæ—¶å“åº”å®¢æˆ·éœ€æ±‚å’Œåé¦ˆï¼Œæä¾›ä¼˜è´¨çš„å®¢æˆ·æœåŠ¡ã€‚

###### 3. é¡¹ç›®æ–‡æ¡£å’ŒæŠ¥å‘Šï¼š(0-10 åˆ†)

å‡†å¤‡å’Œç»´æŠ¤å‡†ç¡®çš„é¡¹ç›®æ–‡æ¡£å’ŒæŠ¥å‘Šã€‚ æä¾›è¯¦ç»†çš„é¡¹ç›®çŠ¶æ€æŠ¥å‘Šå’Œè¿›å±•æ›´æ–°ã€‚

###### 4. é£é™©ç®¡ç†ï¼š(0-10 åˆ†)

è¯†åˆ«é¡¹ç›®é£é™©å¹¶åˆ¶å®šåº”å¯¹ç­–ç•¥ã€‚ ç›‘æ§é£é™©ï¼Œé‡‡å–æªæ–½å‡å°‘é£é™©å½±å“ã€‚

###### 5. åˆè§„æ€§å’Œå®‰å…¨æ€§ï¼š(0-10 åˆ†)

ç¡®ä¿é¡¹ç›®å®æ–½ç¬¦åˆç›¸å…³çš„æ³•è§„å’Œæ ‡å‡†ã€‚ å…³æ³¨å¹¶ç»´æŠ¤ä¿¡æ¯å®‰å…¨å’Œæ•°æ®ä¿æŠ¤ã€‚

---

### 6.2 ç®¡ç†å›¢é˜Ÿç»©æ•ˆè€ƒæ ¸

| æŒ‡æ ‡           | æƒé‡ | å¤‡æ³¨                                                                                                                                                                  |
| -------------- | ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| å·¥ä½œä¸šç»©       | -    | 1ã€å¦‚è‹¥ç®¡ç†äººå‘˜è¿˜å…¼ä»»ï¼ˆå…¶ä»–ï¼‰éƒ¨é—¨æˆ–æ¨ªå‘å›¢é˜Ÿçš„å¼€å‘ã€æµ‹è¯•æˆ–äº§å“è®¾è®¡ç­‰å·¥ä½œï¼Œé‚£ä¹ˆå·¥ä½œä¸šç»©éƒ¨åˆ†å æ¯”åˆ†æ•°ä¸º 30%ï¼Œç®¡ç†åˆ†å€¼å æ¯” 70%ï¼› 2ã€å¦‚è‹¥æ— å…¼ä»»å·¥ä½œï¼Œåˆ™æ— å·¥ä½œä¸šç»©éƒ¨åˆ†è€ƒæ ¸ã€‚ |
| ç›®æ ‡ä¸å·¥ä½œç®¡ç† | 50%  | ç®¡ç†å›¢é˜Ÿç‰¹æœ‰                                                                                                                                                          |
| å›¢é˜Ÿç®¡ç†       | 30%  | ç®¡ç†å›¢é˜Ÿç‰¹æœ‰                                                                                                                                                          |
| å·¥ä½œæ€åº¦       | 20%  | å²—ä½é€šç”¨                                                                                                                                                              |
| é»‘çº¢äº‹ä»¶       | -    | é¢å¤–åŠ å‡åˆ†é¡¹, å²—ä½é€šç”¨                                                                                                                                                |

1. ç®¡ç†äººå‘˜å…¼ä»»æ¨ªå‘å›¢é˜Ÿç ”å‘æˆ–è®¾è®¡ä»»åŠ¡:

   **æ€»åˆ† = `è‡ªè¯„æ€»åˆ† [(å·¥ä½œä¸šç»©) * 30% + (ç›®æ ‡ä¸å·¥ä½œç®¡ç†æ€»åˆ† + å›¢é˜Ÿç®¡ç†æ€»åˆ† + å·¥ä½œæ€åº¦æ€»åˆ†) * 70%] + ä¸Šçº§è¯„åˆ† [(å·¥ä½œä¸šç»©) * 30% + (ç›®æ ‡ä¸å·¥ä½œç®¡ç†æ€»åˆ† + å›¢é˜Ÿç®¡ç†æ€»åˆ† + å·¥ä½œæ€åº¦æ€»åˆ†) * 70%] * 70%` + é»‘çº¢äº‹ä»¶æ€»åˆ†**

2. çº¯ç®¡ç†:

   **æ€»åˆ† = `è‡ªè¯„æ€»åˆ† (ç›®æ ‡ä¸å·¥ä½œç®¡ç†æ€»åˆ† + å›¢é˜Ÿç®¡ç†æ€»åˆ† + å·¥ä½œæ€åº¦æ€»åˆ†) * 30% + ä¸Šçº§è¯„åˆ† (ç›®æ ‡ä¸å·¥ä½œç®¡ç†æ€»åˆ† + å›¢é˜Ÿç®¡ç†æ€»åˆ† + å·¥ä½œæ€åº¦æ€»åˆ†) * 70% + é»‘çº¢äº‹ä»¶æ€»åˆ†`**

---

#### 6.2.1 ç›®æ ‡ä¸å·¥ä½œç®¡ç†

##### 1. è®¡åˆ’ã€å·¥ä½œä»»åŠ¡ç®¡ç† (0-10 åˆ†)

èƒ½å¦å¯¹æ‰€åˆ†ç®¡æˆ–ç›´ç®¡çš„éƒ¨é—¨å·¥ä½œæœ‰æ•ˆçš„ã€åˆç†çš„åˆ¶å®šå·¥ä½œè®¡åˆ’ã€åˆ†è§£åˆ†é…å·¥ä½œä»»åŠ¡ï¼Œè½å®åˆ°æ¯ä¸ªäººã€ï¼ˆæ¯æœˆ 6 æ—¥ 23:00 å‰æäº¤ï¼‰ è¯„ä¼°å…³é”®äº§å‡ºç‰©ï¼šWBS & è¿›åº¦ç®¡ç†ã€å‘¨ã€æœˆå·¥ä½œè®¡åˆ’ PPT å’Œè¡¨æ ¼

##### 2. å·¥ä½œè¿›åº¦ç®¡ç† (0-10 åˆ†)

èƒ½å¦å¯¹æ‰€åˆ†ç®¡æˆ–ç›´ç®¡çš„éƒ¨é—¨å·¥ä½œåŠæ—¶ã€æœ‰æ•ˆçš„è·Ÿè¿›å·¥ä½œè¿›åº¦ï¼Œèƒ½åŠæ—¶çš„æ›´æ–°è¿›åº¦è¡¨ï¼Œå¹¶å‘ç°å’Œå¤„ç†å·¥ä½œè¿›åº¦é—®é¢˜ï¼ŒåŠæ—¶æœ‰æ•ˆçš„è§£å†³é—®é¢˜ã€‚ è¯„ä»·å…³é”®ç‚¹ï¼šè¿›åº¦ç®¡ç†è¡¨æ ¼ä¸­ï¼Œè®¡åˆ’ä¸ç»“æœåŒ¹é…æƒ…å†µ

##### 3. æ‰€åˆ†ç®¡æˆ–ç›´ç®¡çš„éƒ¨é—¨å·¥ä½œç›®æ ‡å®Œæˆæƒ…å†µ (0-30 åˆ†)

- èƒ½å¦å¯¹æ‰€åˆ†ç®¡æˆ–ç›´ç®¡çš„éƒ¨é—¨å·¥ä½œè¿›è¡Œç›‘ç£ä¸æ‰§è¡Œï¼Œå®šæœŸå·¡æ£€å¹¶ç£ä¿ƒå„é¡¹å·¥ä½œçš„æ­£å¸¸å¼€å±•ï¼›
- æ˜¯å¦å¦‚æœŸäº¤ä»˜ï¼Œä¸æ‰“æŠ˜æ‰£ã€ä¿è´¨ä¿é‡æŒ‰æ—¶å®Œæˆå½“æœˆå·¥ä½œæˆ–ä»»åŠ¡ï¼›
- èƒ½å¦ä¿è¯æ‰€è´Ÿè´£æˆ–æ‰¿æ‹…çš„å·¥ä½œï¼Œç¬¦åˆã€è¾¾åˆ°æˆ–è¶…å‡ºå…¬å¸æœŸæœ›ç»“æœã€‚ æœˆåº¦ç›®æ ‡å®Œæˆæƒ…å†µè¯„åˆ†èŒƒå›´ï¼š
  - ä½äº 50%ï¼Œåˆ™è¯¥é¡¹æŒ‡æ ‡è¯„åˆ†ä¸º 1-5 åˆ†ï¼›
  - ï¼ 50% & â‰¤60%ï¼ŒæŒ‡æ ‡è¯„åˆ†ä¸º 5-10 åˆ†ï¼›
  - ï¼ 60% & â‰¤70%ï¼ŒæŒ‡æ ‡è¯„åˆ†ä¸º 10-15 åˆ†ï¼›
  - ï¼ 70% & â‰¤80%ï¼ŒæŒ‡æ ‡è¯„åˆ†ä¸º 15-20 åˆ†ï¼›
  - ï¼ 80% & â‰¤90%ï¼ŒæŒ‡æ ‡è¯„åˆ†ä¸º 20-25 åˆ†ï¼›
  - â‰¥95%ï¼ŒæŒ‡æ ‡è¯„åˆ†ä¸º 25-30 åˆ†ã€‚

å¦‚è‹¥å› å…¬å¸é€šè¿‡è¯„å®¡ä¼šæˆ–å…¬å¸é¢†å¯¼æ ¹æ®å½“å‰å½¢åŠ¿å¯¹éƒ¨é—¨å·¥ä½œä¸´æ—¶åšæŒ‡ç¤ºæˆ–è°ƒæ•´ï¼Œå¯¼è‡´éƒ¨é—¨æ— æ³•æŒ‰è®¡åˆ’å®Œæˆç›¸å…³å·¥ä½œçš„ï¼Œåˆ™æ ¹æ®å…·ä½“äº‹é¡¹åŠå·¥ä½œä»»åŠ¡è¯„ä¼°å’Œè€ƒæ ¸ã€‚

#### 6.2.2 å›¢é˜Ÿç®¡ç†

##### 1. è¿è¡Œè§„èŒƒç®¡ç† (0-5 åˆ†)

äº§å“çš„è®¾è®¡ã€å¼€å‘åŠæµ‹è¯•ç­‰å…³é”®ç¯èŠ‚æˆ–èŠ‚ç‚¹çš„è§„èŒƒåŒ–ç®¡ç†ä¸æ‰§è¡Œï¼Œä»£ç å®¡æŸ¥æœºåˆ¶æ‰§è¡Œç­‰

##### 2. æ‰§è¡ŒåŠ›ä¸å·¥ä½œæ€åº¦ã€ä½œé£ (0-10 åˆ†)

- æ˜¯å¦å¼ºæ‰§è¡ŒåŠ›ï¼Œç§¯æä¸»åŠ¨ã€æ€åº¦ç«¯æ­£ã€ä¸»åŠ¨æ‰¿æ‹…å·¥ä½œå’Œè´£ä»»ï¼Œä½œé£ç¡¬æœ—ï¼Œä¸å®˜åƒšï¼›
- æ˜¯å¦è´¯å½»è½å®å…¬å¸ç®¡ç†æ”¿ç­–åŠäº‹é¡¹ï¼Œæ˜¯å¦è¿…é€Ÿæ‰§è¡Œå…¬å¸é¢†å¯¼åŠåˆ†ç®¡é¢†å¯¼å®‰æ’çš„å„é¡¹ä»»åŠ¡ï¼ŒåŠæ—¶å“åº”ã€ä¸æ‹–æ²“ã€ä¸æ‡ˆæ€ ï¼›
- å·¥ä½œæ‰§è¡Œä¸åŠ›æˆ–å› ä¸ªäººæ€åº¦ã€ä½œé£ç­‰è¾¾ä¸åˆ°é¢„æœŸç»“æœè€…ï¼ˆå¦‚å»¶æœŸã€æ•·è¡äº†äº‹ã€æ— æ³•å®Œæˆç­‰ï¼‰ï¼Œè¯¥é¡¹åˆ†å€¼å°†ä½äº 5 åˆ†ã€‚

##### 3. å·¥ä½œæŠ¥å‘Šç®¡ç† (0-5 åˆ†)

èƒ½å¦æŒ‰æ—¶çš„æ”¶é›†ã€æ•´ç†å¹¶ç¼–å†™å½“å‘¨æˆ–å½“æœˆçš„å·¥ä½œè®¡åˆ’ä¸å·¥ä½œå®Œæˆæƒ…å†µã€‚ ä»¥ç»¼åˆç®¡ç†éƒ¨ç»Ÿè®¡ä¸ºå‡†ã€‚

##### 4. å›¢é˜Ÿåˆä½œåŠ› (0-5 åˆ†)

èƒ½å›¢ç»“å›¢é˜Ÿæˆå‘˜ï¼Œå‘æ˜å›¢é˜Ÿæˆå‘˜æ½œåŠ›ä¸ä¼˜åŠ¿èƒ½åŠ›ï¼Œå¸®åŠ©å›¢é˜Ÿæˆé•¿ï¼Œå‘æŒ¥å›¢é˜Ÿç²¾ç¥ã€äº’è¡¥äº’åŠ©ä»¥è¾¾åˆ°å›¢é˜Ÿæœ€å¤§å·¥ä½œæ•ˆç‡çš„èƒ½åŠ›ã€‚

##### 5. éƒ¨é—¨å†…æˆ–éƒ¨é—¨é—´å·¥ä½œæ²Ÿé€šã€åè°ƒ (0-5 åˆ†)

èƒ½å¦åŠæ—¶ã€å¿«é€Ÿçš„å“åº”éƒ¨é—¨å†…éƒ¨æˆ–å…¶ä»–éƒ¨é—¨çš„ä¸šåŠ¡éœ€æ±‚æˆ–é—®é¢˜ï¼Œèƒ½å¿«é€Ÿã€é«˜æ•ˆé«˜è´¨çš„å¤„ç†æˆ–è§£å†³é—®é¢˜

## [åŸºäºæ ‘è“æ´¾çš„è§†é¢‘æ¨æµæ–¹æ¡ˆ](https://blog.dong4j.site/posts/530746b7.md)

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ç®€ä»‹

å› ä¸ºé¡¹ç›®ä¸Šæœ‰å¾ˆå¤šè®¾è®¡åˆ°ç›‘æ§è§†é¢‘çš„å·¥ä½œ, æ‰€ä»¥æƒ³é€šè¿‡æ ‘è“æ´¾æ¥ç ”ç©¶ä¸€ä¸‹æµåª’ä½“ç›¸å…³çš„æŠ€æœ¯, æ‰€ä»¥æ€»ç»“äº†ä¸€äº›åœ¨æ ‘è“æ´¾ä¸Šå®ç°è§†é¢‘æ¨æµçš„æ–¹æ¡ˆ.

ç¡¬ä»¶:

- æ ‘è“æ´¾ 5B: 8G å†…å­˜
- [RPi Camera V2](https://www.raspberrypi.com/products/camera-module-v2/): 800 ä¸‡åƒç´ 
- [IMX519](https://www.waveshare.net/shop/IMX519-78-16MP-AF-Camera.htm): 1600 ä¸‡åƒç´ , è‡ªåŠ¨å¯¹ç„¦

![20250212192842_OAFqjO2i.webp](https://cdn.dong4j.site/source/image/20250212192842_OAFqjO2i.webp)

## æ‘„åƒå¤´

ä¸€ä¸ªæ‘„åƒå¤´ä½¿ç”¨äº†å®˜æ–¹çš„ RPi Camera V2, ä½¿ç”¨äº†ç´¢å°¼ IMX219 800 ä¸‡åƒç´ ä¼ æ„Ÿå™¨, å¦ä¸€ä¸ªä½¿ç”¨äº† [IMX519](https://www.waveshare.net/shop/IMX519-78-16MP-AF-Camera.htm), å…·å¤‡ 1600W åƒç´ .

RPi Camera V2 æ’ä¸Šå°±èƒ½è¯†åˆ«, ä½†æ˜¯ IMX519 è´¹äº†ç‚¹åŠŸå¤«, æ‰¾åˆ°äº†å‡ ç¯‡ç›¸å…³çš„è®¨è®º:

- [Arducam 16MP AF camera on a Pi5 ? - Raspberry Pi Forums](https://forums.raspberrypi.com/viewtopic.php?t=360329)
- [Arducam IMX519 not detected by Raspberry Pi 5](https://forums.raspberrypi.com/viewtopic.php?t=372176&sid=ad75eafdcf89f9fb413848edfa301c91)
- [Setup IMX519 with any Raspberry Pi OS - Raspberry Pi Cameras - Arducam Camera Support Forum](https://forum.arducam.com/t/setup-imx519-with-any-raspberry-pi-os/2702/7)
- [æ¨¡æ¿:IMX519 Driver Installation - Waveshare Wiki](https://www.waveshare.net/wiki/%E6%A8%A1%E6%9D%BF:IMX519_Driver_Installation)

> ### å…³äºå‹å·
>
> |          æ„Ÿå…‰èŠ¯ç‰‡å‹å·           | æ”¯æŒçš„æ ‘è“æ´¾ä¸»æ¿å‹å· |    æ”¯æŒçš„é©±åŠ¨ç±»å‹     |
> | :-----------------------------: | :------------------: | :-------------------: |
> |             OV5647              |    æ‰€æœ‰æ ‘è“æ´¾ä¸»æ¿    | libcamera / Raspicam  |
> |             OV9281              |    æ‰€æœ‰æ ‘è“æ´¾ä¸»æ¿    |       libcamera       |
> |      IMX219 (æ ‘è“æ´¾å®˜æ–¹ï¼‰       |    æ‰€æœ‰æ ‘è“æ´¾ä¸»æ¿    | libcamera / Raspicam  |
> |         IMX219 (ç¬¬ä¸‰æ–¹)         |    æ ‘è“æ´¾è®¡ç®—æ¨¡å—    |       libcamera       |
> |         IMX290/ IMX327          |    æ‰€æœ‰æ ‘è“æ´¾ä¸»æ¿    |       libcamera       |
> |             IMX378              |    æ‰€æœ‰æ ‘è“æ´¾ä¸»æ¿    |       libcamera       |
> |       IMX477 (æ ‘è“æ´¾å®˜æ–¹)       |    æ‰€æœ‰æ ‘è“æ´¾ä¸»æ¿    | libcamera / Raspicam  |
> |         IMX477 (ç¬¬ä¸‰æ–¹)         |    æ ‘è“æ´¾è®¡ç®—æ¨¡å—    |       libcamera       |
> |             IMX519              |      æ ‘è“æ´¾ä¸»æ¿      | libcameraï¼ˆå¦è£…é©±åŠ¨ï¼‰ |
> | IMX708 (æ ‘è“æ´¾ Camera Module 3) |    æ‰€æœ‰æ ‘è“æ´¾ä¸»æ¿    |       libcamera       |
> |  IMX296(æ ‘è“æ´¾ Global Camera)   |    æ‰€æœ‰æ ‘è“æ´¾ä¸»æ¿    |       libcamera       |
> |    IMX500(æ ‘è“æ´¾ AI Camera)     |    æ‰€æœ‰æ ‘è“æ´¾ä¸»æ¿    |       libcamera       |

ä¸‹é¢æ˜¯å…·ä½“çš„å®æ–½æ­¥éª¤.

### ä¿®æ”¹å›ºä»¶é…ç½®

```bash
sudo nano /boot/config.txt
# å¦‚æœæ˜¯ bookwormç³»ç»Ÿ
sudo nano /boot/firmware/config.txt

# æ·»åŠ ä¸‹é¢è¿™æ®µé…ç½®
camera_auto_detect=0
dtoverlay=imx219,cam0
dtoverlay=imx519,cam1
```

### ä¿®æ”¹æ‘„åƒå¤´é…ç½®

ä» [libcamera/src/ipa/rpi/pisp/data at arducam Â· ArduCAM/libcamera Â· GitHub](https://github.com/ArduCAM/libcamera/tree/arducam/src/ipa/rpi/pisp/data) ä¸‹è½½æœ€æ–°çš„ `imx519.json` æ–‡ä»¶, æ›¿æ¢æ‰åŸæ¥çš„é…ç½®: `/usr/share/libcamera/ipa/rpi/pisp/imx519.json`, ç„¶åé‡å¯å³å¯.

### é©±åŠ¨æ£€æŸ¥

```bash
dmesg | grep imx

[    0.532486] platform 1f00110000.csi: Fixed dependency cycle(s) with /axi/pcie@120000/rp1/i2c@88000/imx219@10
[    0.532607] platform 1f00128000.csi: Fixed dependency cycle(s) with /axi/pcie@120000/rp1/i2c@80000/imx519@1a
[    3.298575] imx519 4-001a: Device found is imx519
[    3.311363] rp1-cfe 1f00110000.csi: found subdevice /axi/pcie@120000/rp1/i2c@88000/imx219@10
[    3.312865] rp1-cfe 1f00128000.csi: found subdevice /axi/pcie@120000/rp1/i2c@80000/imx519@1a
[    3.312891] rp1-cfe 1f00128000.csi: Using sensor imx519 4-001a for capture
[    3.598311] rp1-cfe 1f00110000.csi: Using sensor imx219 6-0010 for capture
```

å¯ä»¥çœ‹åˆ° imx519 çš„é©±åŠ¨æˆåŠŸåŠ è½½äº†.

### æ£€æŸ¥æ‘„åƒå¤´

```bash
v4l2-ctl --list-devices

pispbe (platform:1000880000.pisp_be):
	/dev/video20
	/dev/video21
	/dev/video22
	/dev/video23
	/dev/video24
	/dev/video25
	/dev/video26
	/dev/video27
	/dev/video28
	/dev/video29
	/dev/video30
	/dev/video31
	/dev/video32
	/dev/video33
	/dev/video34
	/dev/video35
	/dev/video36
	/dev/video37
	/dev/media2
	/dev/media3

rp1-cfe (platform:1f00110000.csi):
	/dev/video8
	/dev/video9
	/dev/video10
	/dev/video11
	/dev/video12
	/dev/video13
	/dev/video14
	/dev/video15
	/dev/media0

rp1-cfe (platform:1f00128000.csi):
	/dev/video0
	/dev/video1
	/dev/video2
	/dev/video3
	/dev/video4
	/dev/video5
	/dev/video6
	/dev/video7
	/dev/media1

rpivid (platform:rpivid):
	/dev/video19
	/dev/media4
```

ä¸»è¦å…³æ³¨ **rp1-cfe** ä¿¡æ¯, è¿™ä¸ªè®¾å¤‡é€šå¸¸æŒ‡çš„æ˜¯è¿æ¥åˆ° Raspberry Pi çš„ CSI (Camera Serial Interface) è®¾å¤‡, å¯æŸ¥çœ‹å…·ä½“è®¾å¤‡çš„è¯¦ç»†ä¿¡æ¯:

```bash
âœ  ~ v4l2-ctl -d /dev/video0 --all
Driver Info:
	Driver name      : rp1-cfe
	Card type        : rp1-cfe
	Bus info         : platform:1f00128000.csi
	Driver version   : 6.6.31
	Capabilities     : 0xaca00001
		Video Capture
		Metadata Capture
		Metadata Output
		Streaming
		Extended Pix Format
		Device Capabilities
	Device Caps      : 0x24a00001
		Video Capture
		Metadata Capture
		Streaming
		Extended Pix Format
Media Driver Info:
	Driver name      : rp1-cfe
	Model            : rp1-cfe
	Serial           :
	Bus info         : platform:1f00128000.csi
	Media version    : 6.6.31
	Hardware revision: 0x00114666 (1132134)
	Driver version   : 6.6.31
Interface Info:
	ID               : 0x03000017
	Type             : V4L Video
Entity Info:
	ID               : 0x00000015 (21)
	Name             : rp1-cfe-csi2_ch0
	Function         : V4L2 I/O
	Pad 0x01000016   : 0: Sink, Must Connect
	  Link 0x02000037: from remote pad 0x1000006 of entity 'csi2' (Video Interface Bridge): Data
Priority: 2
Video input : 0 (rp1-cfe-csi2_ch0: ok)
Format Video Capture:
	Width/Height      : 640/480
	Pixel Format      : 'pRAA' (10-bit Bayer RGRG/GBGB Packed)
	Field             : None
	Bytes per Line    : 800
	Size Image        : 384000
	Colorspace        : Raw
	Transfer Function : None
	YCbCr/HSV Encoding: ITU-R 601
	Quantization      : Full Range
	Flags             :
Format Metadata Capture:
	Sample Format   : 'SENS' (Sensor Ancillary Metadata)
	Buffer Size     : 16384
```

### æµ‹è¯•æ‘„åƒå¤´

è‡ªåŠ¨å¯¹ç„¦å¹¶æ‹æ‘„ç…§ç‰‡

```bash
libcamera-still -t 10000 -n --autofocus-mode auto -o test1.jpg --camera 1
```

![20250212130816_rj2SNreE.webp](https://cdn.dong4j.site/source/image/20250212130816_rj2SNreE.webp)

[Raspberry Pi Camera Autofocus: Complete Guide (V1, V2 & HQ)](https://www.arducam.com/raspberry-pi-camera/autofocus/)

IMX219 ç›´æ¥ä½¿ç”¨ `rpicam-jpeg` æ¥æ‹æ‘„ä¸€å¼ å›¾ç‰‡:

```bash
rpicam-jpeg -o test.jpg --camera 0
```

![20250212130730_Jods28xH.webp](https://cdn.dong4j.site/source/image/20250212130730_Jods28xH.webp)

## é€šè¿‡ WebUI æ§åˆ¶æ‘„åƒå¤´

**[picamera2-WebUI](https://github.com/monkeymademe/picamera2-WebUI)** æ˜¯ Raspberry Pi ç›¸æœºæ¨¡å—çš„è½»é‡çº§ Web ç•Œé¢ï¼ŒåŸºäº Picamera2 Python åº“å¹¶ä½¿ç”¨ Flask æ„å»ºã€‚æ­¤é¡¹ç›®æä¾›äº†ä¸€ä¸ªç”¨æˆ·ç•Œé¢ï¼Œç”¨äºé…ç½®ç›¸æœºè®¾ç½®ã€æ‹æ‘„ç…§ç‰‡ä»¥åŠåœ¨åŸºæœ¬å›¾åº“ä¸­ç®¡ç†å›¾åƒã€‚

### éƒ¨ç½²

```bash
git clone git@github.com:monkeymademe/picamera2-WebUI.git
cd picamera2-WebUI
python app.py
```

ä¸€åˆ‡æ­£å¸¸çš„è¯, ä¼šåœ¨ 8080 ç«¯å£å¼€å¯ä¸€ä¸ª Web æœåŠ¡:

![20250212131525_cfMOZfTX.webp](https://cdn.dong4j.site/source/image/20250212131525_cfMOZfTX.webp)

2 ä¸ªæ‘„åƒå¤´éƒ½æˆåŠŸè¯†åˆ«åˆ°äº†.

è¿˜èƒ½å¤Ÿæ§åˆ¶æ‘„åƒå¤´çš„åˆ†è¾¨ç‡:

![20250212131652_SJ6e76J2.webp](https://cdn.dong4j.site/source/image/20250212131652_SJ6e76J2.webp)

### æ‘„åƒå¤´æ§åˆ¶

![20250212192857_K2bz1Poh.webp](https://cdn.dong4j.site/source/image/20250212192857_K2bz1Poh.webp)

### æŸ¥çœ‹è§†é¢‘æµ
 
{% videos, 2 %}
{% video https://cdn.dong4j.site/source/image/stream1.mp4 %}
{% video https://cdn.dong4j.site/source/image/stream2.mp4 %}
{% endvideos %}

å·¦è¾¹:**IMX219: 1080P**
å³è¾¹: **IMX519 4K**

## æµåª’ä½“æœåŠ¡å™¨

åŸºäºæ ‘è“æ´¾çš„æµåª’ä½“æœåŠ¡å™¨éå¸¸å¤š, ä¸‹é¢ shi ä¸€äº›å¸¸è§çš„æ–¹æ¡ˆ

### è°ƒç ”ç»“æœ

1. mjpg-stream - web å¯ä»¥ç›´æ¥è®¿é—®ï¼Œä½†æ˜¯å¸§ç‡å¤ªä½ï¼Œ[å‚è€ƒ](https://blog.csdn.net/m0_38106923/article/details/86562451)

2. vlc - å»¶è¿Ÿé«˜ï¼Œå¤§çº¦ 2s-5s

3. raspivid - å»¶è¿Ÿ 170ms å·¦å³ï¼Œå¹¶æ”¯æŒ h264 ç¡¬ä»¶ç¼–ç ï¼Œå¥½åƒå¯ä»¥ [å‚è€ƒè¿™é‡Œ](https://blog.csdn.net/qq_39492932/article/details/84585152)

   è¯¥å·¥å…·å·²ç»é»˜è®¤é›†æˆåˆ°äº†æ ‘è“æ´¾ä¹‹ä¸­

   ```
   raspivid -t 0 -w 1280 -h 720 -fps 20 -o - | nc -k -l 8090
   ```

   -t è¡¨ç¤ºå»¶æ—¶ï¼›-o è¡¨ç¤ºè¼¸å‡ºï¼›-fps è¡¨ç¤ºå¸§ç‡ï¼›ç«¯å£å·ä¸º 8090

   -w è¡¨ç¤ºå›¾åƒå®½åº¦;ï¼Œ-h è¡¨ç¤ºå›¾åƒé«˜åº¦ï¼Œæ­¤å¤„è®¾ç½®çš„åˆ†è¾¨ç‡ä¸º 1280*720ï¼›æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ -w 1920 -h 1080 å°†åˆ†è¾¨ç‡è®¾ç½®ä¸º 1920*1080

   è¯¥å‘½ä»¤æ‰§è¡Œç©åä¸ä¼šå‡ºç°ä»»ä½•æ‰“å°ä¿¡æ¯å³å¯

   åœ¨å±€åŸŸç½‘å†…çš„ linux ä¸»æœºä¸Šå®‰è£… mplayer å·¥å…·(sudo apt-get install mplayer)ï¼Œç„¶åæ‰§è¡Œå‘½ä»¤

   ```
   mplayer -fps 200 -demuxer h264es ffmpeg://tcp://192.168.31.166:8090
   ```

   å³ä¼šå¼¹å‡ºä¸€ä¸ªæ˜¾ç¤ºæ ‘è“æ´¾å®æ—¶è§†é¢‘æµçš„çª—å£ï¼Œè€Œä¸”å»¶è¿Ÿå°šå¯ï¼Œå¤§æ¦‚åœ¨ 200ms å·¦å³ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥æ»¡è¶³å®æ—¶æ€§çš„è¦æ±‚äº†ã€‚

4. [pistreaming](https://github.com/waveform80/pistreaming) - æ€§èƒ½ä¸é”™ï¼Œå»¶è¿Ÿä½

   1. å®‰è£…ä¾èµ–

      ```
      # å®‰è£…python3-picamera
      sudo apt-get install python3-picamera
      # å®‰è£…pip3
      sudo apt-get install python3-pip
      # å®‰è£…ws4py
      sudo pip3 install ws4py
      # å®‰è£…ffmpeg
      sudo apt-get install ffmpeg
      ```

   2. ä¸‹è½½æºç 

      ```
      git clone https://github.com/waveform80/pistreaming.git
      ```

   3. æµ‹è¯•æ•ˆæœ

      ```
      # è¿›å…¥æºç ç›®å½•
      cd pistreaming
      # è¿è¡Œç¨‹åº
      python3 server.py
      ```

      æµè§ˆå™¨è®¿é—®æŸ¥çœ‹æ•ˆæœ

      ```
      http://pi_ip:8082/index.html
      ```

5. [motion](https://motion-project.github.io/) - å¡é¡¿å¾ˆä¸¥é‡ï¼Œå»¶è¿Ÿåœ¨ 30s+

6. [fswebcam](https://github.com/fsphil/fswebcam) - é‡‡é›†æ‘„åƒå¤´æ•°æ®ä¿å­˜ä¸ºå›¾ç‰‡ï¼Œç”¨æ¥åšè§†é¢‘ç›‘æ§çš„è¯ï¼Œæ€§èƒ½å’Œå»¶è¿Ÿéƒ½è¾¾ä¸åˆ°è¦æ±‚

7. [Camkit](https://gitee.com/andyspider/Camkit) - æ”¯æŒç¡¬ä»¶ç¼–è§£ç ï¼Œæ¯”è¾ƒå°ä¼—ï¼Œç¼ºå°‘ç»´æŠ¤

8. ffmpeg ç¡¬è§£ç æ¨æµ - æ”¯æŒç¡¬ä»¶ç¼–è§£ç ï¼Œä½†æ˜¯å»¶è¿Ÿå¾ˆé«˜ï¼ˆä¸çŸ¥é“æ˜¯æ¨æµåŸå› è¿˜æ˜¯æ’­æ”¾åŸå› ï¼‰ï¼Œç”»è´¨å¾ˆå·®

   æµç¨‹æ¯”è¾ƒå¤æ‚ï¼Œæ•´ç†æˆè„šæœ¬ä¿å­˜åœ¨ ffmpeg ç›®å½•ä¸­

   1. å®‰è£… x264 ç¡¬ä»¶ç¼–ç  install_x264.sh

   2. å®‰è£… ffmpeg install_ffmpeg.sh

   3. å®‰è£…è¿è¡Œ nginx install_nginx.sh

   4. å¯åŠ¨æ¨æµï¼ˆæ³¨æ„ 192.168.0.111 æ›¿æ¢ä¸ºä½ çš„ ip åœ°å€ï¼‰

      ```
      /usr/local/bin/ffmpeg -ss 0 -pix_fmt yuv420p -i /dev/video0 -c:v h264_omx -f flv rtmp://192.168.0.111:1935/live/camera
      ```

   5. potplayer æ’­æ”¾ url rtmp://192.168.0.111:1935/live/camera

9. [webrtc](https://github.com/kclyu/rpi-webrtc-streamer) - çœ‹è§†é¢‘è²Œä¼¼æ•ˆæœå¾ˆå¥½ï¼Œå·¥ä½œé‡å¤ªå¤§ï¼ŒåæœŸéªŒè¯

   - [ç¼–è¯‘ webrtc for raspberry](https://antmedia.io/building-and-cross-compiling-webrtc-for-raspberry/)

   - [ç¼–è¯‘ webrtc for raspberry 2](<https://ipop-project.org/wiki/Build-WebRTC-Libraries-for-Raspberry-Pi-3-(Cross-compile-on-Ubuntu)>)

### æœ€ç»ˆæ–¹æ¡ˆ

æ²¹ç®¡ä¸Šæ‰¾åˆ°ä¸€ä¸ª [æµ‹è¯•æ ‘è“æ´¾ 5 æœ€ä½³ç›´æ’­æ–¹å¼çš„è§†é¢‘](https://youtu.be/rxtcyxV32nc), å¯¹æ¯”äº† WebRTC, TCP, UDP å’Œ RTSP çš„å»¶è¿Ÿ:

![20250212192857_p7dMvHQp.webp](https://cdn.dong4j.site/source/image/20250212192857_p7dMvHQp.webp)

çœ‹ç€ [MediaMTX](https://github.com/bluenviron/mediamtx) å»¶è¿Ÿè¡¨ç°éå¸¸å¥½, å†³å®šç›´æ¥ä½¿ç”¨å®ƒæ¥ä½œä¸ºåª’ä½“æœåŠ¡å™¨ä½¿ç”¨, å¦å¤–ä¸€ç‚¹æ˜¯å®ƒå†…ç½®äº†æ ‘è“æ´¾æ”¯æŒ.

### éƒ¨ç½² MediaMTX

```bash
wget https://github.com/bluenviron/mediamtx/releases/download/v1.9.3/mediamtx_v1.9.3_linux_arm64v8.tar.gz
tar -zxvf mediamtx_v1.9.3_linux_arm64v8.tar.gz -C mediamtx_v1.9.3_linux_arm64v8
cd mediamtx_v1.9.3_linux_arm64v8
# ä½¿ç”¨é»˜è®¤é…ç½®å¯åŠ¨
./mediamtx
```

### é…ç½® MediaMTX

#### å†…ç½®æ”¯æŒ

MediaMTX è‡ªå¸¦äº†æ ‘è“æ´¾æ‘„åƒå¤´æ”¯æŒ, é…ç½®å¦‚ä¸‹ (mediamtx-rpiCamera.yml):

```yaml

... # å‰é¢çš„é…ç½®æœªåšä»»ä½•ä¿®æ”¹
paths:
  cam0:
    # http://192.168.21.21:8889/cam0/
    source: rpiCamera
    rpiCameraCamID: 0
    rpiCameraWidth: 1920
    rpiCameraHeight: 1080
    rpiCameraHFlip: True
    rpiCameraVFlip: True
  cam1:
    # http://192.168.21.21:8889/cam1/
    source: rpiCamera
    rpiCameraCamID: 1
    rpiCameraWidth: 2560
    rpiCameraHeight: 1440
    rpiCameraHFlip: True
    rpiCameraVFlip: True
    rpiCameraBrightness: 0.0
    rpiCameraContrast: 1
    rpiCameraSaturation: 1
    rpiCameraSharpness: 0
    rpiCameraExposure: normal
    rpiCameraAWB: auto
    rpiCameraDenoise: "cdn_off"
    rpiCameraShutter: 0
    rpiCameraMetering: centre
    rpiCameraGain: 0
    rpiCameraEV: 0
    rpiCameraHDR: false
    rpiCameraFPS: 30
    rpiCameraIDRPeriod: 60
    rpiCameraBitrate: 2000000
    rpiCameraProfile: main
    rpiCameraLevel: "4.1"
    rpiCameraAfMode: continuous
    rpiCameraAfRange: normal
    rpiCameraAfSpeed: normal
    rpiCameraLensPosition: 0
```

**å¯åŠ¨æ–¹å¼:**

```bash
# å¯¼å…¥ ldconfig, å®ƒåœ¨ /usr/sbin ç›®å½•ä¸‹, ä¸çŸ¥é“ä¸ºå•¥æ‰¾ä¸åˆ°
export PATH=$PATH:/usr/sbin && nohup ./mediamtx mediamtx-rpiCamera.yml &
```

![20250212135804_gljWVL4z.webp](https://cdn.dong4j.site/source/image/20250212135804_gljWVL4z.webp)

#### RTMP æ–¹å¼

**é…ç½®(mediamtx-rtmp.yml)**

```yaml
paths:
  cam0:
    runOnInit: bash -c 'rpicam-vid --hflip --vflip -t 0 --camera 0 --nopreview --codec yuv420 --width 1920 --height 1080 --inline --listen -o - | ffmpeg -f rawvideo -pix_fmt yuv420p -s:v 1920x1080 -i /dev/stdin -c:v libx264 -preset ultrafast -tune zerolatency -f flv rtmp://192.168.21.7/live/pi5a-camera0'
    runOnInitRestart: yes
  cam1:
    runOnInit: bash -c 'rpicam-vid --hflip --vflip -t 0 --autofocus-mode auto --camera 1 --nopreview --codec yuv420 --width 2540 --height 1440 --inline --listen -o - | ffmpeg -f rawvideo -pix_fmt yuv420p -s:v 2560x1440 -i /dev/stdin -c:v libx264 -preset ultrafast -tune zerolatency -f flv rtmp://192.168.21.7/live/pi5a-camera1'
    runOnInitRestart: yes
```

å°†è§†é¢‘æµæ¨é€åˆ° `192.168.21.7` æœåŠ¡å™¨, è¿™ä¸ªæ˜¯ä½¿ç”¨ WVP æ­å»ºçš„å¦ä¸€ä¸ªæµåª’ä½“æœåŠ¡å™¨:

**å¯åŠ¨**

```bash
nohup ./mediamtx mediamtx-rtmp.yml &
```

```bash
...
Output #0, rtsp, to 'rtsp://localhost:8554/cam0':
  Metadata:
    encoder         : Lavf59.27.100
  Stream #0:0: Video: h264, yuv420p, 1920x1080, q=2-31, 25 fps, 90k tbn
    Metadata:
      encoder         : Lavc59.37.100 libx264
    Side data:
      cpb: bitrate max/min/avg: 0/0/0 buffer size: 0 vbv_delay: N/A
frame=    0 fps=0.0 q=0.0 Lsize=N/A time=00:00:00.00 bitrate=N/A speed=   0x
video:0kB audio:0kB subtitle:0kB other streams:0kB global headers:0kB muxing overhead: unknown
frame= 1863 fps= 18 q=18.0 size=N/A time=00:01:14.48 bitrate=N/A speed=0.721x
```

![20250212142052_f8wpDOW9.webp](https://cdn.dong4j.site/source/image/20250212142052_f8wpDOW9.webp)

RTMP æ˜æ˜¾è¦æ¯” WebRTC å»¶è¿Ÿé«˜, åŸºæœ¬ä¸Šåœ¨ 4 ç§’ä»¥ä¸Š.

#### RTSP æ–¹å¼

**é…ç½®(mediamtx-rtsp.yml)**

```yaml
paths:
  cam0:
    runOnInit: bash -c 'rpicam-vid --hflip --vflip -t 0 --camera 0 --nopreview --codec yuv420 --width 1920 --height 1080 --inline --listen -o - | ffmpeg -f rawvideo -pix_fmt yuv420p -s:v 1920x1080 -i /dev/stdin -c:v libx264 -preset ultrafast -tune zerolatency -f rtsp rtsp://localhost:$RTSP_PORT/$MTX_PATH'
    runOnInitRestart: yes
  cam1:
    runOnInit: bash -c 'rpicam-vid --hflip --vflip -t 0 --camera 1 --nopreview --codec yuv420 --width 2560 --height 1440 --inline --listen -o - | ffmpeg -f rawvideo -pix_fmt yuv420p -s:v 2560x1440 -i /dev/stdin -c:v libx264 -preset ultrafast -tune zerolatency -f rtsp rtsp://localhost:$RTSP_PORT/$MTX_PATH'
    runOnInitRestart: yes
```

**å¯åŠ¨**

```bash
nohup ./mediamtx mediamtx-rtsp.yml &
```

```bash
Output #0, rtsp, to 'rtsp://localhost:8554/cam1':
  Metadata:
    encoder         : Lavf59.27.100
  Stream #0:0: Video: h264, yuv420p(progressive), 2560x1440, q=2-31, 25 fps, 90k tbn
    Metadata:
      encoder         : Lavc59.37.100 libx264
    Side data:
      cpb: bitrate max/min/avg: 0/0/0 buffer size: 0 vbv_delay: N/A
frame= 1245 fps= 18 q=19.0 size=N/A time=00:00:49.76 bitrate=N/A speed=0.72x
```

ä½¿ç”¨ WVP çš„æ‹‰æµä»£ç†:

![20250212142815_ndsfrSEN.webp](https://cdn.dong4j.site/source/image/20250212142815_ndsfrSEN.webp)

å»¶è¿Ÿæœ‰é«˜å‡ºä¸€å¤§æˆª, æ¯•ç«Ÿæ˜¯ç»è¿‡ 2 ä¸ªæµåª’ä½“æœåŠ¡å™¨å¤šæ¬¡è½¬ç çš„:

![20250212142639_WjSecgaP.webp](https://cdn.dong4j.site/source/image/20250212142639_WjSecgaP.webp)

### å»¶è¿Ÿå¯¹æ¯”

![20250212192910_CbVi4Iol.webp](https://cdn.dong4j.site/source/image/20250212192910_CbVi4Iol.webp)

### å¯åŠ¨è„šæœ¬

ä¸ºäº†æ–¹ä¾¿æµ‹è¯•, å†™äº†ä¸€ä¸ªå¯åŠ¨è„šæœ¬, æ”¯æŒå¤šç§åè®®ä»¥åŠåˆ†è¾¨ç‡:

```bash
#!/bin/bash

# æ£€æŸ¥æ˜¯å¦æœ‰ -h å‚æ•°
if [[ "$1" == "-h" ]]; then
    echo "ä½¿ç”¨æ–¹æ³•: $0 [åè®®] [æ‘„åƒå¤´ç¼–å·] [å®½åº¦] [é«˜åº¦] [URLåœ°å€]"
    echo "ç¤ºä¾‹: $0 rtmp 0 1920 1080 192.168.21.7/pi5b, æœ€ç»ˆURL: rtmp://192.168.21.7/pi5b/0"
    echo
    echo "å‚æ•°è¯´æ˜:"
    echo "  åè®®    : rtmp æˆ– rtsp (ç”¨äºé€‰æ‹©æµåª’ä½“ä¼ è¾“åè®®)"
    echo "  æ‘„åƒå¤´ç¼–å· : æ‘„åƒå¤´ç¼–å· (ä¾‹å¦‚ 0 æˆ– 1)"
    echo "  å®½åº¦    : åˆ†è¾¨ç‡å®½åº¦ (ä¾‹å¦‚ 1920)"
    echo "  é«˜åº¦    : åˆ†è¾¨ç‡é«˜åº¦ (ä¾‹å¦‚ 1080)"
    echo "  URLåœ°å€  : åŸºç¡€çš„ URL åœ°å€ (ä¾‹å¦‚ 192.168.21.7/pi5b)"
    echo
    echo "RTMP æ¨æµè¯´æ˜:"
    echo "  192.168.21.7:1935/pi5b --> rtmp://192.168.21.7:1935/pi5b/0 æ¨æµè‡³ m920x çš„ zlm æœåŠ¡, é»˜è®¤ç«¯å£ 1935, ä¼šå‡ºç°åœ¨ WVP çš„æ¨æµåˆ—è¡¨ä¸­"
    echo "  192.168.21.7:41935/pi5b --> rtmp://192.168.21.7:41935/pi5b/0 æ¨æµè‡³ m920x çš„ mediamtx æœåŠ¡, ä½¿ç”¨ mediamtx æœåŠ¡çš„ WebRTC è®¿é—®: http://192.168.21.7:48889/pi5b/{CAMERA}"
    echo "  127.0.0.1:1935/pi5b --> æœ¬åœ°æ¨æµè‡³ mediamtx æœåŠ¡, ä½¿ç”¨ WebRTC è®¿é—®: http://ip:8889/pi5b/{CAMERA}"
    echo "  ===================================================="
    echo "  ./stream.sh rtmp 0 1920 1080 192.168.21.7/pi5a"
    echo "  ./stream.sh rtmp 0 2560 1440 192.168.21.7:41935/pi5a"
    echo "  ./stream.sh rtmp 0 3840 2160 192.168.21.7/pi5a"
    echo "  ./stream.sh rtmp 0 3840 2160 127.0.0.1/pi5a"
    echo
    echo "RTSP æ¨æµè¯´æ˜:"
    echo "  192.168.21.7:554/pi5b --> rtsp://192.168.21.7:554/pi5a/0 æ¨æµè‡³ m920x çš„ zlm æœåŠ¡, é»˜è®¤ç«¯å£ 554, ä¼šå‡ºç°åœ¨ WVP çš„æ¨æµåˆ—è¡¨ä¸­"
    echo "  192.168.21.7:48554/pi5b --> rtsp://192.168.21.7:48554/pi5b/0 æ¨æµè‡³ m920x çš„ mediamtx æœåŠ¡, ä½¿ç”¨ WebRTC è®¿é—®: http://192.168.21.7:48889/pi5b/{CAMERA}"
    echo "  127.0.0.1:8554/pi5b --> æœ¬åœ°æ¨æµè‡³ mediamtx æœåŠ¡, ä½¿ç”¨ WebRTC è®¿é—®: http://ip:8889/pi5b/{CAMERA}"
    echo "  ===================================================="
    echo "  ./stream.sh rtsp 1 1920 1080 192.168.21.7/pi5b"
    echo "  ./stream.sh rtsp 1 2560 1440 192.168.21.7:48554/pi5a"
    echo "  ./stream.sh rtsp 1 3840 2160 192.168.21.7:8554/pi5a"
    echo "  ./stream.sh rtsp 1 3840 2160 127.0.0.1:8554/pi5a"
    exit 0
fi

# å‚æ•°èµ‹å€¼
PROTOCOL=$1        # ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºåè®® (rtmp æˆ– rtsp)
CAMERA=$2          # ç¬¬äºŒä¸ªå‚æ•°ä¸ºæ‘„åƒå¤´ç¼–å·
WIDTH=$3           # ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºå®½åº¦ 1920x1080 2560x1440 3840x2160
HEIGHT=$4          # ç¬¬å››ä¸ªå‚æ•°ä¸ºé«˜åº¦
URL=$5             # ç¬¬äº”ä¸ªå‚æ•°ä¸ºåŸºç¡€çš„ URL åœ°å€

# æ ¹æ®åè®®åŠ¨æ€è®¾ç½®è¾“å‡ºæµåœ°å€å’Œæ ¼å¼
if [ "$PROTOCOL" == "rtmp" ]; then
    OUTPUT_URL="rtmp://${URL}/${CAMERA}"
    FFMPEG_FORMAT="flv"
elif [ "$PROTOCOL" == "rtsp" ]; then
    OUTPUT_URL="rtsp://${URL}/${CAMERA}"
    FFMPEG_FORMAT="rtsp"
else
    echo "ä¸æ”¯æŒçš„åè®®: $PROTOCOL"
    exit 1
fi

# è¿è¡Œå‘½ä»¤
nohup bash -c "rpicam-vid --hflip --vflip -t 0 --camera $CAMERA --nopreview --codec yuv420 --width $WIDTH --height $HEIGHT --inline --listen -o - | ffmpeg -f rawvideo -pix_fmt yuv420p -s:v ${WIDTH}x${HEIGHT} -i /dev/stdin -c:v libx264 -preset ultrafast -tune zerolatency -f $FFMPEG_FORMAT $OUTPUT_URL" > ${PROTOCOL}-cam${CAMERA}.log 2>&1 &
```

---

## ç›¸å…³èµ„æº

- [Raspberry Pi æ ‘è“æ´¾ä¸­æ–‡æ–‡æ¡£](https://github.com/raspberrypi/documentation)
- [How to Control your Raspberry Pi Camera using a web UI | Tom's Hardware](https://www.tomshardware.com/raspberry-pi/how-to-control-your-raspberry-pi-camera-using-a-web-ui)
- [MediaMTX](https://github.com/bluenviron/mediamtx)
- [Raspberry Pi 5 Video Capture: Camera Module V3 Video Stream Latencies. Comparing UDP, TCP, RTSP, and WebRTC : 8 Steps - Instructables](https://www.instructables.com/Comparing-Raspberry-Pi-5-Camera-Module-V3-Video-St/)
- [æ‘„åƒå¤´è½¯ä»¶](https://rpicn.bsdcn.org/shu-mei-pai/she-xiang-tou-ruan-jian)
- [RPi Camera V2 - Waveshare Wiki](https://www.waveshare.net/wiki/RPi_Camera_V2)
- [RPi Camera (G) - Waveshare Wiki](<https://www.waveshare.net/wiki/RPi_Camera_(G)>)
- [RPi Camera (F) - Waveshare Wiki](<https://www.waveshare.net/wiki/RPi_Camera_(F)#Picamera2.E7.9A.84.E9.AB.98.E7.BA.A7API>)
- [Pi5-IMX219 - Waveshare Wiki](https://www.waveshare.net/wiki/Pi5-IMX219)
- [æ ‘è“æ´¾ 4B å®‰è£…æ‘„åƒå¤´æ•™ç¨‹-æ ‘è“æ´¾ 4B é…ç½® CSI æ‘„åƒå¤´](https://wangliguang.cn/?p=630)
- [æ ‘è“æ´¾è‡ªåŠ¨åŒ–æ¨æµæ‘„åƒå¤´åˆ° Bilibili ç›´æ’­ - å¤¸å…‹ä¹‹ä¹¦](https://www.quarkbook.com/?p=733)
- [åˆ©ç”¨æ ‘è“æ´¾å°†è§†é¢‘æµæ¨é€åˆ°æœåŠ¡å™¨ - ThingsPanel è®¨è®ºåŒº](https://forum.thingspanel.cn/d/37)
- [æœºå™¨ä¹‹çœ¼ï¼šæ ‘è“æ´¾æ‘„åƒå¤´ | Yam](https://yam.gift/2021/07/03/Raspberrypi/2021-07-03-RaspberryPi-Camera/)
- [èŠèŠæ ‘è“æ´¾ RaspiCamï¼Œlibcameraï¼Œrpicam å¥—ä»¶åŒºåˆ«ï¼ŒåŠ CSI/USB Camera æ¨æµ-CSDN åšå®¢](https://blog.csdn.net/techfuture/article/details/136909088)
- [åŸºäº Raspberry çš„ libcamera ä½¿ç”¨ - å°æ·¼åšå®¢ - åšå®¢å›­](https://www.cnblogs.com/uestc-mm/p/17442508.html)
- [Incompatibility with libcamera 0.1.0 and Raspberry Pi 5 Â· Issue #2581 Â· bluenviron/mediamtx Â· GitHub](https://github.com/bluenviron/mediamtx/issues/2581)
- [Raspberry Pi 5 Video Stream Latencies: Comparing UDP, TCP, RTSP, and WebRTC | by Ievgenii Tkachenko | Medium](https://gektor650.medium.com/comparing-video-stream-latencies-raspberry-pi-5-camera-v3-a8d5dad2f67b)
- [æ ‘è“æ´¾-æ˜¾ç¤ºå±å’Œæ‘„åƒå¤´é©±åŠ¨æœ¬æ–‡æ˜¯å…³äº raspberry pi çš„æ˜¾ç¤ºå±å’Œæ‘„åƒå¤´é©±åŠ¨è®°å½•ï¼Œä¸»è¦è®°å½•æ•´ä½“æµç¨‹å’Œè¿‡ç¨‹ä¸­çš„ä¸€äº›å‘ - æ˜é‡‘](https://juejin.cn/post/7110540919065018404)
- [ArduCam B0389 Mini 16MP IMX519 æ‘„åƒå¤´æ¨¡å—ç”¨æˆ·æŒ‡å—](https://manuals.plus/zh-CN/arducam/b0389-mini-16mp-imx519-camera-module-manual)
- [GitHub - jacksonliam/mjpg-streamer: Fork of http://sourceforge.net/projects/mjpg-streamer/](https://github.com/jacksonliam/mjpg-streamer)
- [GitHub - meinside/rpi-mjpg-streamer: Instructions and helper scripts for running mjpg-streamer on Raspberry Pi](https://github.com/meinside/rpi-mjpg-streamer)

## é«˜é˜¶ç©æ³•

- [ç»™å±±å¯¨ IMX290 æ‘„åƒå¤´æ¨¡ç»„åˆ·å…¥ OpenIPC å¹¶æ¥å…¥ HomeKit](https://akbwe.com/posts/openipc-and-homekit/)
- [OpenIPC æ ‘è“æ´¾ 4B åœ°é¢ç«™æ­å»ºæŒ‡å— - å“”å“©å“”å“©](https://www.bilibili.com/read/cv28142010/)
- [æ¨æµè®°å½• - LX2020 - åšå®¢å›­](https://www.cnblogs.com/lx2035/p/17871406.html)
- [Openipc fpv å¼€æºé«˜æ¸…å›¾ä¼  å¤ç”¨ç›‘æ§æˆå“ç¡¬ä»¶æ¸…å• - å“”å“©å“”å“©](https://www.bilibili.com/read/cv27762124/?jump_opus=1)
- [å¼€æº PHFC æ ‘è“æ´¾ 4G å›¾ä¼  usb4G ç½‘å¡æ¨æµ ç§»è¿œ EC20 rtsp rtmp æ¨æµ\_å“”å“©å“”å“©\_bilibili](https://www.bilibili.com/video/BV1GL4y1M7WG/?vd_source=285e3ed2bb5db5afb00b4aab045d1b4b)
- [Introduction - OpenIPC](https://openipc.org/)
- [Fetching Title#r20r](https://arduino.me/a/2966)

## V4L2

```
$ sudo apt-get install v4l-utils
$ v4l2-ctl --list-devices
bcm2835-codec-decode (platform:bcm2835-codec):
        /dev/video10
        /dev/video11
        /dev/video12
        /dev/media1
bcm2835-isp (platform:bcm2835-isp):
        /dev/video13
        /dev/video14
        /dev/video15
        /dev/video16
        /dev/media0
mmal service 16.1 (platform:bcm2835-v4l2):
        /dev/video0
```

### é©±åŠ¨ç¨‹åº

V4L2 é©±åŠ¨ç¨‹åºæä¾›ç”¨äºè®¿é—®æ‘„åƒå¤´å’Œç¼–è§£ç å™¨åŠŸèƒ½çš„æ ‡å‡† Linux æ¥å£ã€‚é€šå¸¸ï¼ŒLinux ä¼šåœ¨å¯åŠ¨æœŸé—´è‡ªåŠ¨åŠ è½½é©±åŠ¨ç¨‹åºã€‚ä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦ [æ˜ç¡®åŠ è½½æ‘„åƒå¤´é©±åŠ¨ç¨‹åº](https://github.com/raspberrypi/documentation/blob/develop/documentation/asciidoc/computers/camera/camera_software.adoc#configuration)ã€‚

### ä½¿ç”¨æ—¶çš„è®¾å¤‡èŠ‚ç‚¹ `libcamera`

| /dev/videoX | é»˜è®¤æ“ä½œ                                                                                |
| ----------- | --------------------------------------------------------------------------------------- |
| `video0`    | ç¬¬ä¸€ä¸ª CSI-2 æ¥æ”¶å™¨çš„ Unicam é©±åŠ¨ç¨‹åº                                                   |
| `video1`    | ç”¨äºç¬¬äºŒä¸ª CSI-2 æ¥æ”¶å™¨çš„ Unicam é©±åŠ¨ç¨‹åº                                               |
| `video10`   | è§†é¢‘è§£ç                                                                                 |
| `video11`   | è§†é¢‘ç¼–ç                                                                                 |
| `video12`   | ç®€å•çš„ ISPï¼Œé™¤äº† Bayer åˆ° RGB/YUV çš„è½¬æ¢å¤–ï¼Œè¿˜å¯ä»¥æ‰§è¡Œ RGB/YUV æ ¼å¼ä¹‹é—´çš„è½¬æ¢å’Œè°ƒæ•´å¤§å° |
| `video13`   | è¾“å…¥è‡³å®Œå…¨å¯ç¼–ç¨‹ ISP                                                                    |
| `video14`   | å®Œå…¨å¯ç¼–ç¨‹ ISP çš„é«˜åˆ†è¾¨ç‡è¾“å‡º                                                           |
| `video15`   | å®Œå…¨å¯ç¼–ç¨‹ ISP çš„ç»“æœè¾“å‡ºè¾ƒä½                                                           |
| `video16`   | æ¥è‡ªå®Œå…¨å¯ç¼–ç¨‹ ISP çš„å›¾åƒç»Ÿè®¡æ•°æ®                                                       |
| `video19`   | HEVC è§£ç                                                                                |

### ä½¿ç”¨ V4L2 é©±åŠ¨ç¨‹åº

å‚é˜… [V4L2 æ–‡æ¡£](https://www.kernel.org/doc/html/latest/userspace-api/media/v4l/v4l2.html)ã€‚

## [æ ‘è“æ´¾ç›´æ’­æ–°é€‰æ‹©ï¼šæ‰“é€ ä½ çš„ä¸ªäººæµåª’ä½“æœåŠ¡å™¨](https://blog.dong4j.site/posts/5e9872c3.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## 1. èƒŒæ™¯

åœ¨ [[pi-dafang-monitor|æ ‘è“æ´¾ + å¤§æ–¹æ‘„åƒå¤´ æ‰“é€ å©´å„¿ç›‘æ§]] ä¸­ç®€å•ä»‹ç»äº†é€šè¿‡åˆ·å¤§æ–¹æ‘„åƒå¤´ç¬¬ä¸‰æ–¹å›ºä»¶æ¥è§£é”æ›´å¤šåŠŸèƒ½, æ¯”å¦‚ RTSP, MQTT ç­‰, è¿™é‡Œæˆ‘ä»¬å°±ä½¿ç”¨ RTSP ç»“åˆæ ‘è“æ´¾æ¥æ‰“é€ ä¸€ä¸ªç›´æ’­é—´.

## 2. ç›´æ’­æ¶æ„

å¤æ‚çš„æ¶æ„å›¾:

![20241229154732_uyt57iIf.webp](https://cdn.dong4j.site/source/image/20241229154732_uyt57iIf.webp)

ç®€å•çš„æ¶æ„å›¾:

![zhibo.drawio.svg](https://cdn.dong4j.site/source/image/zhibo.drawio.svg)

### 2.1 æ¨æµå·¥å…·

- ffmpegï¼šhttps://www.ffmpeg.org/download.html
- OBS studioï¼šhttps://obsproject.com/download

### 2.2 æ‹‰æµå·¥å…·

- ffplay æ’­æ”¾å™¨: https://www.ffmpeg.org/download.html ã€‚
- cutv www.cutv.com/demo/live_test.swf flash æ’­æ”¾å™¨ã€‚
- vlc æ’­æ”¾å™¨ã€‚
- ijkplayer (åŸºäº ffplay): ä¸€ä¸ªåŸºäº FFmpeg çš„å¼€æº Android/iOS è§†é¢‘æ’­æ”¾å™¨ã€‚å¼€æºï¼ŒAPI æ˜“äºé›†æˆï¼›ç¼–è¯‘é…ç½®å¯è£å‰ªï¼Œæ–¹ä¾¿æ§åˆ¶å®‰è£…åŒ…å¤§å°ï¼›æ”¯æŒç¡¬ä»¶åŠ é€Ÿè§£ç ï¼Œæ›´åŠ çœç”µç®€å•æ˜“ç”¨ï¼ŒæŒ‡å®šæ‹‰æµ URLï¼Œè‡ªåŠ¨è§£ç æ’­æ”¾.ã€‚

### 2.3 æµåª’ä½“æœåŠ¡å™¨

- SRS ï¼šä¸€æ¬¾å›½äººå¼€å‘çš„ä¼˜ç§€å¼€æºæµåª’ä½“æœåŠ¡å™¨ç³»ç»Ÿã€‚æ™®é€š C++ è¯­æ³•ï¼Œåº•å±‚ä½¿ç”¨åç¨‹ç¼–å†™ã€‚
- BMS ï¼šä¹Ÿæ˜¯ä¸€æ¬¾æµåª’ä½“æœåŠ¡å™¨ç³»ç»Ÿï¼Œä½†ä¸å¼€æºï¼Œæ˜¯ SRS çš„å•†ä¸šç‰ˆï¼Œæ¯” SRS åŠŸèƒ½æ›´å¤šã€‚ä½œè€…ä¹Ÿæ˜¯ç›®å‰ SRS çš„ä½œè€…ï¼Œè¿™ä¸ªæ˜¯ç›®å‰ SRS ä½œè€…åœ¨ä¸Šä¸€å®¶å…¬å¸ (guanzhiyun) çš„äº§ç‰©ã€‚
- nginx ï¼šå…è´¹å¼€æº web æœåŠ¡å™¨ï¼Œä¹Ÿå¸¸ç”¨æ¥é…ç½®æµåª’ä½“æœåŠ¡å™¨ï¼Œé›†æˆ Rtmp_module å³å¯ã€‚C è¯­è¨€ç¼–å†™ã€‚
- zlmediakitï¼šå¼€æºï¼Œå›½äººå¼€å‘çš„ä¼˜ç§€æµåª’ä½“æœåŠ¡å™¨ï¼Œä½¿ç”¨ C++11 å¤šçº¿ç¨‹ç¼–å†™ã€‚
- Red5ï¼šæ˜¯ java å†™çš„ä¸€æ¬¾ç¨³å®šçš„å¼€æºçš„ rtmp æœåŠ¡å™¨ã€‚

## 3. ç¯å¢ƒæ­å»º

![aaa.drawio.svg](https://cdn.dong4j.site/source/image/aaa.drawio.svg)

### 3.1 æ¨æµå·¥å…·

ç›´æ¥ä½¿ç”¨ å¤§æ–¹æ‘„åƒå¤´çš„ RTSP åè®®æ¨æµ, åœ°å€ä¸º: `rtsp://192.168.31.128:8554/unicast`

ä½¿ç”¨ VLC éªŒè¯ä¸€ä¸‹:

![20241229154732_jh1kKfzc.webp](https://cdn.dong4j.site/source/image/20241229154732_jh1kKfzc.webp)

å®Œå…¨æ²¡é—®é¢˜, å†…ç½‘æ’­æ”¾éå¸¸æµç•….

### 3.2 æµåª’ä½“æœåŠ¡å™¨

#### 3.2.1 ZLMediaKit

https://docs.zlmediakit.com/zh/

![20241229154732_3iL0oAds.webp](https://cdn.dong4j.site/source/image/20241229154732_3iL0oAds.webp)

**ZLMediaKit** æ˜¯ä¸€å¥—é«˜æ€§èƒ½çš„æµåª’ä½“æœåŠ¡æ¡†æ¶ï¼Œç›®å‰æ”¯æŒ rtmpã€rtspã€hlsã€http-flv ç­‰æµåª’ä½“åè®®ï¼Œæ”¯æŒ linuxã€macosã€windows ä¸‰å¤§ PC å¹³å°å’Œ iosã€android ä¸¤å¤§ç§»åŠ¨ç«¯å¹³å°ã€‚

**ä¸»è¦åŠŸèƒ½:**

1. åŸºäº C++11 å¼€å‘ï¼Œé¿å…ä½¿ç”¨è£¸æŒ‡é’ˆï¼Œä»£ç ç¨³å®šå¯é ï¼Œæ€§èƒ½ä¼˜è¶Šã€‚
2. æ”¯æŒå¤šç§åè®®(RTSP/RTMP/HLS/HTTP-FLV/WebSocket-FLV/GB28181/HTTP-TS/WebSocket-TS/HTTP-fMP4/WebSocket-fMP4/MP4),æ”¯æŒåè®®äº’è½¬ã€‚
3. ä½¿ç”¨å¤šè·¯å¤ç”¨/å¤šçº¿ç¨‹/å¼‚æ­¥ç½‘ç»œ IO æ¨¡å¼å¼€å‘ï¼Œå¹¶å‘æ€§èƒ½ä¼˜è¶Šï¼Œæ”¯æŒæµ·é‡å®¢æˆ·ç«¯è¿æ¥ã€‚
4. ä»£ç ç»è¿‡é•¿æœŸå¤§é‡çš„ç¨³å®šæ€§ã€æ€§èƒ½æµ‹è¯•ï¼Œå·²ç»åœ¨çº¿ä¸Šå•†ç”¨éªŒè¯å·²ä¹…ã€‚
5. æ”¯æŒ linuxã€macosã€iosã€androidã€windows å…¨å¹³å°ã€‚
6. æ”¯æŒç”»é¢ç§’å¼€ã€æä½å»¶æ—¶(500 æ¯«ç§’å†…ï¼Œæœ€ä½å¯è¾¾ 100 æ¯«ç§’)ã€‚
7. æä¾›å®Œå–„çš„æ ‡å‡† C API,å¯ä»¥ä½œ SDK ç”¨ï¼Œæˆ–ä¾›å…¶ä»–è¯­è¨€è°ƒç”¨ã€‚
8. æä¾›å®Œæ•´çš„ MediaServer æœåŠ¡å™¨ï¼Œå¯ä»¥å…å¼€å‘ç›´æ¥éƒ¨ç½²ä¸ºå•†ç”¨æœåŠ¡å™¨ã€‚
9. æä¾›å®Œå–„çš„ restful api ä»¥åŠ web hookï¼Œæ”¯æŒä¸°å¯Œçš„ä¸šåŠ¡é€»è¾‘ã€‚
10. æ‰“é€šäº†è§†é¢‘ç›‘æ§åè®®æ ˆä¸ç›´æ’­åè®®æ ˆï¼Œå¯¹ RTSP/RTMP æ”¯æŒéƒ½å¾ˆå®Œå–„ã€‚
11. å…¨é¢æ”¯æŒ H265/H264/AAC/G711/OPUSã€‚

> æ€»ç»“: åŒæ—¶æ”¯æŒ rtsp/rtmp æ¨æ‹‰æµï¼Œè€Œä¸”æ”¯æŒ h265 çš„æ¨æ‹‰æµï¼ˆæ¨æµç«¯è¦æ”¯æŒ 265 çš„ ffmpeg/æ‹‰æµæ’­æ”¾ç«¯ä¹Ÿè¦æ”¯æŒ 265 çš„æ’­æ”¾å™¨ï¼‰ï¼Œæ”¯æŒå„ç§æ ¼å¼æ‹‰æµï¼Œä½¿ç”¨è€…ä¼—å¤š

#### 3.2.2 Monibuca

https://m7s.live/#ui

![20241229154732_x3jiipX8.webp](https://cdn.dong4j.site/source/image/20241229154732_x3jiipX8.webp)

Monibuca æ˜¯ä¸€ä¸ªå¼€æºçš„æµåª’ä½“æœåŠ¡å™¨å¼€å‘æ¡†æ¶ï¼Œé€‚ç”¨äºå¿«é€Ÿå®šåˆ¶åŒ–å¼€å‘æµåª’ä½“æœåŠ¡å™¨ï¼Œå¯ä»¥å¯¹æ¥ CDN å‚å•†ï¼Œä½œä¸ºå›æºæœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥è‡ªå·±æ­å»ºé›†ç¾¤éƒ¨ç½²ç¯å¢ƒã€‚ ä¸°å¯Œçš„å†…ç½®æ’ä»¶æä¾›äº†æµåª’ä½“æœåŠ¡å™¨çš„å¸¸è§åŠŸèƒ½ï¼Œä¾‹å¦‚ rtmp serverã€http-flvã€è§†é¢‘å½•åˆ¶ã€QoS ç­‰ã€‚é™¤æ­¤ä»¥å¤–è¿˜å†…ç½®äº†åå° web ç•Œé¢ï¼Œæ–¹ä¾¿è§‚å¯ŸæœåŠ¡å™¨è¿è¡Œçš„çŠ¶æ€ã€‚ ä¹Ÿå¯ä»¥è‡ªå·±å¼€å‘åå°ç®¡ç†ç•Œé¢ï¼Œé€šè¿‡ api æ–¹å¼è·å–æœåŠ¡å™¨çš„è¿è¡Œä¿¡æ¯ã€‚ Monibuca æä¾›äº†å¯ä¾›å®šåˆ¶åŒ–å¼€å‘çš„æ’ä»¶æœºåˆ¶ï¼Œå¯ä»¥ä»»æ„æ‰©å±•å…¶åŠŸèƒ½ã€‚

![20241229154732_uYMVXrO1.webp](https://cdn.dong4j.site/source/image/20241229154732_uYMVXrO1.webp)

**ä¸»è¦åŠŸèƒ½:**

1. é’ˆå¯¹æµåª’ä½“æœåŠ¡å™¨ç‹¬ç‰¹çš„æ€§è´¨è¿›è¡Œçš„ä¼˜åŒ–ï¼Œå……åˆ†åˆ©ç”¨ Golang çš„ goroutine çš„æ€§è´¨å¯¹å¤§é‡çš„è¿æ¥çš„è¯»å†™è¿›è¡Œåˆç†çš„åˆ†é…è®¡ç®—èµ„æºï¼Œä»¥åŠå°½å¯èƒ½çš„å‡å°‘å†…å­˜ Copy æ“ä½œã€‚ä½¿ç”¨å¯¹è±¡æ± å‡å°‘ Golang çš„ GC æ—¶é—´ã€‚
2. ä¸“ä¸ºäºŒæ¬¡å¼€å‘è€Œè®¾è®¡ï¼ŒåŸºäº Golang è¯­è¨€ï¼Œå¼€å‘æ•ˆç‡æ›´é«˜ï¼›ç‹¬åˆ›çš„æ’ä»¶æœºåˆ¶ï¼Œå¯ä»¥æ–¹ä¾¿ç”¨æˆ·å®šåˆ¶ä¸ªæ€§åŒ–çš„åŠŸèƒ½ç»„åˆï¼Œæ›´é«˜æ•ˆç‡çš„åˆ©ç”¨æœåŠ¡å™¨èµ„æºã€‚
3. åŠŸèƒ½å¼ºå¤§çš„ä»ªè¡¨ç›˜å¯ä»¥ç›´è§‚çš„çœ‹åˆ°æœåŠ¡å™¨è¿è¡Œçš„çŠ¶æ€ã€æ¶ˆè€—çš„èµ„æºã€ä»¥åŠå…¶ä»–ç»Ÿè®¡ä¿¡æ¯ã€‚ç”¨æˆ·å¯ä»¥åˆ©ç”¨æ§åˆ¶å°å¯¹æœåŠ¡å™¨è¿›è¡Œé…ç½®å’Œæ§åˆ¶ã€‚ç‚¹å‡»å³ä¸Šè§’èœå•æ é‡Œé¢çš„æ¼”ç¤ºï¼Œå¯ä»¥çœ‹åˆ°æ¼”ç¤ºæ§åˆ¶å°ç•Œé¢ã€‚
4. çº¯ Go ç¼–å†™ï¼Œä¸ä¾èµ– cgoï¼Œä¸ä¾èµ– FFMpeg æˆ–è€…å…¶ä»–è¿è¡Œæ—¶ï¼Œéƒ¨ç½²æå…¶æ–¹ä¾¿ï¼Œå¯¹æœåŠ¡å™¨çš„è¦æ±‚æä¸ºå®½æ¾ã€‚

> æ€»ç»“: æ”¯æŒè‡ªå®šä¹‰æ’ä»¶, æ‰©å±•æ–°åŠŸèƒ½éå¸¸æ–¹ä¾¿, ç¼ºç‚¹å°±æ˜¯éƒ¨åˆ†æ’ä»¶æ”¶è´¹.

#### 3.2.3 SRS

https://ossrs.net/lts/zh-cn/

![20241229154732_Ihggdcre.webp](https://cdn.dong4j.site/source/image/20241229154732_Ihggdcre.webp)

SRS(Simple Realtime Server)æ˜¯ä¸€ä¸ªç®€å•é«˜æ•ˆçš„å®æ—¶è§†é¢‘æœåŠ¡å™¨ï¼Œæ”¯æŒ RTMPã€WebRTCã€HLSã€HTTP-FLVã€SRT ç­‰å¤šç§å®æ—¶æµåª’ä½“åè®®ã€‚

SRS ä½œä¸ºå½“å‰éå¸¸æ™®éçš„è¿è¥çº§è§£å†³æ–¹æ¡ˆï¼Œå…·å¤‡éå¸¸å…¨é¢çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬é›†ç¾¤ã€åè®®ç½‘å…³ã€CDN åŠŸèƒ½ç­‰ï¼Œä¸»è¦åŠŸèƒ½å¦‚ä¸‹ï¼š

1. SRS å®šä½æ˜¯è¿è¥çº§çš„äº’è”ç½‘ç›´æ’­æœåŠ¡å™¨é›†ç¾¤ï¼Œè¿½æ±‚æ›´å¥½çš„æ¦‚å¿µå®Œæ•´æ€§å’Œæœ€ç®€å•å®ç°çš„ä»£ç ã€‚
2. SRS æä¾›äº†ä¸°å¯Œçš„æ¥å…¥æ–¹æ¡ˆå°† RTMP æµæ¥å…¥ SRSï¼Œ åŒ…æ‹¬æ¨é€ RTMP åˆ° SRSã€æ¨é€ RTSP/UDP/FLV åˆ° SRSã€æ‹‰å–æµåˆ° SRSã€‚ SRS è¿˜æ”¯æŒå°†æ¥å…¥çš„ RTMP æµè¿›è¡Œå„ç§å˜æ¢ï¼Œè­¬å¦‚å°† RTMP æµè½¬ç ã€æµæˆªå›¾ã€ è½¬å‘ç»™å…¶ä»–æœåŠ¡å™¨ã€è½¬å°è£…æˆ HTTP-FLV æµã€è½¬å°è£…æˆ HLSã€ è½¬å°è£…æˆ HDSã€è½¬å°è£…æˆ DASHã€å½•åˆ¶æˆ FLV/MP4ã€‚
3. SRS åŒ…å«æ”¯å¤§è§„æ¨¡é›†ç¾¤å¦‚ CDN ä¸šåŠ¡çš„å…³é”®ç‰¹æ€§ï¼Œ è­¬å¦‚ RTMP å¤šçº§é›†ç¾¤ã€æºç«™é›†ç¾¤ã€VHOST è™šæ‹ŸæœåŠ¡å™¨ ã€ æ— ä¸­æ–­æœåŠ¡ Reloadã€HTTP-FLV é›†ç¾¤ã€‚
4. SRS è¿˜æä¾›ä¸°å¯Œçš„åº”ç”¨æ¥å£ï¼Œ åŒ…æ‹¬ HTTP å›è°ƒã€å®‰å…¨ç­–ç•¥ Securityã€HTTP API æ¥å£ã€ RTMP æµ‹é€Ÿã€‚
5. SRS åœ¨æºç«™å’Œ CDN é›†ç¾¤ä¸­éƒ½å¾—åˆ°äº†å¹¿æ³›çš„åº”ç”¨ Applicationsã€‚

> æ€»ç»“: æ”¯æŒ rtmp æ¨æµï¼Œæ—©æœŸç‰ˆæœ¬æ”¯æŒ rtsp æ¨æµï¼Œä¸çŸ¥é“ä¸ºä½•ç§»é™¤äº†ã€‚æ”¯æŒéƒ¨åˆ†æ ¼å¼æ‹‰æµï¼Œä¸æ”¯æŒ ws-flv æ‹‰æµï¼Œä½¿ç”¨è€…ä¼—å¤š

#### 3.2.4 EasyDarwin

https://www.easydarwin.org/

![20241229154732_Gu71mfT9.webp](https://cdn.dong4j.site/source/image/20241229154732_Gu71mfT9.webp)

**EasyDarwin** æ˜¯ç”±å›½å†…å¼€æºæµåª’ä½“å›¢é˜Ÿç»´æŠ¤å’Œè¿­ä»£çš„ä¸€æ•´å¥—å¼€æºæµåª’ä½“è§†é¢‘å¹³å°æ¡†æ¶ï¼ŒGolang å¼€å‘ï¼Œä» 2012 å¹´ 12 æœˆåˆ›å»ºå¹¶å‘å±•è‡³ä»Šï¼ŒåŒ…å«æœ‰å•ç‚¹æœåŠ¡çš„å¼€æºæµåª’ä½“æœåŠ¡å™¨ï¼Œå’Œæ‰©å±•åçš„æµåª’ä½“äº‘å¹³å°æ¶æ„çš„å¼€æºæ¡†æ¶ï¼Œå¼€è¾Ÿäº†è¯¸å¤šçš„ä¼˜è´¨å¼€æºé¡¹ç›®ï¼Œèƒ½æ›´å¥½åœ°å¸®åŠ©å¹¿å¤§æµåª’ä½“å¼€å‘è€…å’Œåˆ›ä¸šå‹ä¼ä¸šå¿«é€Ÿæ„å»ºæµåª’ä½“æœåŠ¡å¹³å°ï¼Œæ›´å¿«ã€æ›´ç®€å•åœ°å®ç°æœ€æ–°çš„ç§»åŠ¨äº’è”ç½‘(å®‰å“ã€iOSã€H5ã€å¾®ä¿¡)æµåª’ä½“ç›´æ’­ä¸ç‚¹æ’­çš„éœ€æ±‚ï¼Œå°¤å…¶æ˜¯å®‰é˜²è¡Œä¸šä¸äº’è”ç½‘è¡Œä¸šçš„è¡”æ¥ã€‚

**ä¸»è¦åŠŸèƒ½:**

1. åŸºäº Golang è¯­è¨€å¼€å‘ç»´æŠ¤ã€‚
2. æ”¯æŒ Windowsã€Linuxã€macOS ä¸‰å¤§ç³»ç»Ÿå¹³å°éƒ¨ç½²ã€‚
3. æ”¯æŒ RTSP æ¨æµåˆ†å‘ï¼ˆæ¨æ¨¡å¼è½¬å‘ï¼‰ã€‚
4. æ”¯æŒ RTSP æ‹‰æµåˆ†å‘ï¼ˆæ‹‰æ¨¡å¼è½¬å‘ï¼‰ã€‚
5. æœåŠ¡ç«¯å½•åƒã€æ£€ç´¢ã€å›æ”¾ã€‚
6. æ”¯æŒå…³é”®å¸§ç¼“å­˜ã€ç§’å¼€ç”»é¢ã€‚
7. Web åå°ç®¡ç†ã€‚
8. åˆ†å¸ƒå¼è´Ÿè½½å‡è¡¡ã€‚

> æ€»ç»“: åªæ”¯æŒ rtsp æ¨æ‹‰æµï¼Œé»˜è®¤ç«¯å£ 5541ï¼Œä¸æ”¯æŒå…¶ä»–æ ¼å¼æ‹‰æµï¼Œå¦‚æœä»…ä»…æ˜¯ç›‘æ§æ‘„åƒå¤´ä½¿ç”¨ï¼Œéå¸¸æ–¹ä¾¿ï¼Œæœ‰ä¸ªç½‘é¡µç®¡ç†åå°ï¼Œä¸ä¼šè¿‡æœŸå¯ä»¥ä¸€ç›´ç”¨ï¼Œç¼ºç‚¹æ˜¯åŠŸèƒ½å•ä¸€ï¼Œåªèƒ½åœ¨ä»–çš„åå°æŸ¥çœ‹è§†é¢‘æµï¼Œæˆ–è€…ç”¨æ’­æ”¾å™¨æ’­æ”¾.

**ä¸Šè¿° 4 ç§æµåª’ä½“æœåŠ¡å¯¹æ¯”:**

![20241229154732_kgiruT3T.webp](https://cdn.dong4j.site/source/image/20241229154732_kgiruT3T.webp)

#### 3.2.5 MediaMTX

https://github.com/bluenviron/mediamtx

_MediaMTX_ï¼ˆä»¥å‰ç§°ä¸º*rtsp-simple-server*ï¼‰æ˜¯ä¸€ä¸ªå³ç”¨å‹ã€é›¶ä¾èµ–çš„å®æ—¶åª’ä½“æœåŠ¡å™¨å’Œåª’ä½“ä»£ç†ï¼Œå…è®¸å‘å¸ƒã€è¯»å–ã€ä»£ç†å’Œè®°å½•è§†é¢‘å’ŒéŸ³é¢‘æµã€‚å®ƒè¢«è®¾æƒ³ä¸ºä¸€ç§â€œåª’ä½“è·¯ç”±å™¨â€ï¼Œå°†åª’ä½“æµä»ä¸€ç«¯è·¯ç”±åˆ°å¦ä¸€ç«¯ã€‚

**ä¸»è¦åŠŸèƒ½:**

- å°†ç›´æ’­æµå‘å¸ƒåˆ°æœåŠ¡å™¨
- ä»æœåŠ¡å™¨è¯»å–ç›´æ’­æµ
- æµè‡ªåŠ¨ä»ä¸€ç§åè®®è½¬æ¢ä¸ºå¦ä¸€ç§åè®®
- åœ¨ä¸åŒçš„è·¯å¾„ä¸­åŒæ—¶æä¾›å¤šä¸ªæµ
- å°†æµè®°å½•åˆ°ç£ç›˜
- éªŒè¯ç”¨æˆ·èº«ä»½ï¼›ä½¿ç”¨å†…éƒ¨æˆ–å¤–éƒ¨èº«ä»½éªŒè¯
- å°†è¯»å–å™¨é‡å®šå‘åˆ°å…¶ä»– RTSP æœåŠ¡å™¨ï¼ˆè´Ÿè½½å¹³è¡¡ï¼‰
- é€šè¿‡ API æŸ¥è¯¢å’Œæ§åˆ¶æœåŠ¡å™¨
- åœ¨ä¸æ–­å¼€ç°æœ‰å®¢æˆ·ç«¯è¿æ¥çš„æƒ…å†µä¸‹é‡æ–°åŠ è½½é…ç½®ï¼ˆçƒ­é‡è½½ï¼‰
- è¯»å– Prometheus å…¼å®¹çš„æŒ‡æ ‡
- å½“å®¢æˆ·ç«¯è¿æ¥ã€æ–­å¼€è¿æ¥ã€è¯»å–æˆ–å‘å¸ƒæµæ—¶è¿è¡ŒæŒ‚é’©ï¼ˆå¤–éƒ¨å‘½ä»¤ï¼‰
- ä¸ Linuxã€Windows å’Œ macOS å…¼å®¹ï¼Œä¸éœ€è¦ä»»ä½•ä¾èµ–é¡¹æˆ–è§£é‡Šå™¨ï¼Œå®ƒæ˜¯å•ä¸ªå¯æ‰§è¡Œæ–‡ä»¶

> æ€»ç»“: åŒæ—¶æ”¯æŒ rtsp/rtmp æ¨æ‹‰æµï¼Œæ‹‰æµè¿˜æ”¯æŒ hls/webrtc ä¸¤ç§æ–¹å¼ï¼Œæœ€æ–°ç‰ˆæœ¬è¿˜æ”¯æŒäº† srt æ–¹å¼ã€‚æ¨å‡ºæ¥çš„ hls/webrtc å¯ä»¥ç›´æ¥åµŒå…¥ä¸ª iframe ç½‘é¡µæ’­æ”¾ï¼Œæ²¡æœ‰ä»»ä½•ä¾èµ–ï¼Œå¦‚æœå¸Œæœ›ç›´æ¥åœ¨ç½‘é¡µä¸­æ’­æ”¾æ— ä¾èµ–ï¼Œå¼ºçƒˆæ¨èç”¨ mediamtx

#### 3.2.6 Nginx-rtmp-module

https://github.com/arut/nginx-rtmp-module

Nginx æœ¬èº«æ˜¯ä¸€ä¸ªéå¸¸å‡ºè‰²çš„ HTTP æœåŠ¡å™¨,FFMPEG æ˜¯éå¸¸å¥½çš„éŸ³è§†é¢‘è§£å†³æ–¹æ¡ˆ.è¿™ä¸¤ä¸ªä¸œè¥¿é€šè¿‡ä¸€ä¸ª nginx çš„æ¨¡å— nginx-rtmp-module,ç»„åˆåœ¨ä¸€èµ·å³å¯ä»¥æ­å»ºä¸€ä¸ªåŠŸèƒ½ç›¸å¯¹æ¯”è¾ƒå®Œå–„çš„æµåª’ä½“æœåŠ¡å™¨. è¿™ä¸ªæµåª’ä½“æœåŠ¡å™¨å¯ä»¥æ”¯æŒ RTMP å’Œ HLS(Live Http Stream)ã€‚

**ä¸»è¦ç‰¹æ€§:**

1. æ”¯æŒ RTMPã€HLSã€MPEG-DASH
2. æ”¯æŒ RTMPã€HLS ç‚¹æ’­
3. å¯å°†ç›´æ’­è§†é¢‘åˆ†æ®µå­˜å‚¨
4. æ”¯æŒ H.264 è§†é¢‘ç¼–è§£ç ã€AAC éŸ³é¢‘ç¼–è§£ç 
5. æ”¯æŒ FFmpeg å‘½ä»¤å†…åµŒ
6. æ”¯æŒå›è°ƒ HTTP
7. å¯ä½¿ç”¨ HTTP å¯¹ç›´æ’­è¿›è¡Œåˆ é™¤ã€å½•æ’­ç­‰æ§åˆ¶
8. å…·æœ‰å¼ºå¤§çš„ç¼“å†²åŠŸèƒ½ï¼Œå¯ç¡®ä¿åœ¨æ•ˆç‡ä¸ç ç‡é—´è¾¾åˆ°å¹³è¡¡
9. æ”¯æŒå¤šç§æ“ä½œç³»ç»Ÿï¼ˆLinuxã€MacOSã€Windowsï¼‰

> æ€»ç»“: åªæ”¯æŒ rtmp æ¨æ‹‰æµï¼Œé»˜è®¤ç«¯å£ 1935ï¼Œä¸æ”¯æŒå…¶ä»–æ ¼å¼æ‹‰æµï¼ŒåŠŸèƒ½æå…¶å•ä¸€ï¼Œä¸æ¨èã€‚

æµåª’ä½“æœåŠ¡å™¨ç›´æ¥é€‰æ‹©äº†ç›¸å¯¹æ¯”è¾ƒç†Ÿæ‚‰çš„ **ZLMediaKit**, èƒ½å¤Ÿæ¯”è¾ƒæ–¹ä¾¿çš„å°† RTSP åè®®è½¬æ¢æˆå…¶ä»–å„ç§åè®®.

### 3.3 ZLMediaKit éƒ¨ç½²

ä½¿ç”¨ docker ä¸€é”®å®‰è£…éƒ¨ç½²:

```yaml
version: "3.3"
services:
  app:
    image: "zlmediakit/zlmediakit:master"
    container_name: zlmediakit
    restart: unless-stopped
    environment:
      - MODE=standalone
      - TZ=Asia/Shanghai
    ports:
      - "1935:1935"
      - "8080:80"
      - "7443:443"
      - "8554:554"
      - "10000:10000"
      - "10000:10000/udp"
      - "8000:8000/udp"
      - "9000:9000/udp"
    volumes:
      - ./data/media/bin:/opt/media/bin
      - ./data/media/conf:/opt/media/conf
```

![20241229154732_WXm0i7BP.webp](https://cdn.dong4j.site/source/image/20241229154732_WXm0i7BP.webp)

æœ‰ä¸Šé¢çš„ WEB ç®¡ç†ç«¯æ˜¯ä½¿ç”¨äº† [æ­¤é¡¹ç›®](https://github.com/1002victor/zlm_webassist), ç›´æ¥æ”¾åœ¨ zlm çš„ www æ ¹ç›®å½•ä¸‹å³å¯.

#### 3.3.1 æŒ‰éœ€æ‹‰æµ

ä½¿ç”¨ API å°† RTSP æµæ³¨å†Œåˆ° ZLM:

```bash
curl 'http://192.168.31.11:8080/index/api/addStreamProxy?vhost=192.168.31.11&secret=AmcwaLke5ELUbJCgO46M47MR4qPiefqt&app=live1&stream=test1&url=rtsp://192.168.31.128:8554/unicast'

{
	"code" : 0,
	"data" :
	{
		"key" : "192.168.31.11/live1/test1"
	}
}
```

ç„¶åæ ¹æ® ZLM çš„ [URL æ’­æ”¾åœ°å€è¯´æ˜](https://github.com/ZLMediaKit/ZLMediaKit/wiki/%E6%92%AD%E6%94%BEurl%E8%A7%84%E5%88%99), æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ mp4 åœ¨æµè§ˆå™¨è¿›è¡Œæ’­æ”¾:

`http://192.168.31.11:8080/live1/test1.live.mp4`

## [å®å®åŠ¨ä¸€ä¸‹å°±çŸ¥é“ï¼šå¦‚ä½•ç”¨æ ‘è“æ´¾å’Œå°ç±³å¤§æ–¹æ‘„åƒå¤´æ„å»ºæ™ºèƒ½ç›‘æ§](https://blog.dong4j.site/posts/8dc39439.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## 1. èƒŒæ™¯

6 æœˆå„¿å­è¯ç”Ÿ, åˆæœ‰æŠ˜è…¾çš„æ¥å£äº†.

å„¿å­ç¡ç€åä¼šæ”¾åˆ°ä¸»å§, è€å©†åœ¨å®¢å…, æˆ‘åœ¨ä¹¦æˆ¿, ä¸ºäº†ç›‘æ§å„¿å­çš„ç¡çœ çŠ¶æ€, å¼€å§‹æŠ˜è…¾å®¶é‡Œçš„é—²ç½®è®¾å¤‡.

## 2. ç›®æ ‡

1. ä½¿ç”¨å°ç±³çš„å¤§æ–¹æ‘„åƒå¤´æ•è·å„¿å­çš„å®æ—¶è§†é¢‘, å¦‚æœå„¿å­åŠ¨äº†å°±æŠ¥è­¦;
2. ä½¿ç”¨æ ‘è“æ´¾æ­å»º MQ æœåŠ¡å™¨, å°†å¤§æ–¹çš„å‘Šè­¦æ¨é€åˆ°æ‰‹æœºä¸Š;

## 3. æ•´ä½“æ¶æ„

![111.drawio.svg](https://cdn.dong4j.site/source/image/111.drawio.svg)

1. å¤§æ–¹æ‘„åƒå¤´ç›‘æ§å„¿å­, å¦‚æœç›‘æµ‹åˆ°åŠ¨ä½œ, è¿™é€šè¿‡è‡ªå¸¦çš„ MQ client å‘é€åŠ¨ä½œå‘Šè­¦;
2. æ ‘è“æ´¾ç›‘å¬ç‰¹å®š topic, å¦‚æœç¬¦åˆé¢„è®¾å€¼åˆ™é€šè¿‡ bark å‘é€åŠ¨ä½œå‘Šè­¦;
3. å¦ˆå¦ˆæ”¶åˆ° bark æ¶ˆæ¯, å‰å»æŸ¥çœ‹å„¿å­æ˜¯å¦éœ€è¦å®å®;

**å®Œç¾çš„é—­ç¯**

## 4. å®æ–½æ­¥éª¤

### 4.1 å¤§æ–¹æ‘„åƒå¤´åˆ·å›ºä»¶

å°ç±³çš„å¤§æ–¹æ‘„åƒå¤´å®˜æ–¹å›ºä»¶ä¸æ”¯æŒè‡ªå®šä¹‰ MQ, æ„Ÿè°¢å¤§ä½¬å¼€æºäº†ç¬¬ä¸‰æ–¹å›ºä»¶, æ„Ÿè°¢å¼€æº.

[å¤§æ–¹è‰²æ‘„åƒå¤´ç¬¬ä¸‰æ–¹å›ºä»¶](https://github.com/EliasKotlyar/Xiaomi-Dafang-Hacks) æ”¯æŒå¤§æ–¹æ‘„åƒå¤´, å°æ–¹æ‘„åƒå¤´ç­‰å¤šæ¬¾æ‘„åƒå¤´, æä¾›äº† RTSP, MQ, Telegram ç­‰é›†æˆæœåŠ¡. æœ‰äº† RTSP æœåŠ¡å, å¯ä»¥æ¥å…¥ HomeKit å’Œ Home Assistant.

åˆ·å›ºä»¶çš„æ•™ç¨‹å®˜æ–¹å†™çš„éå¸¸è¯¦ç»†, è¿™é‡Œæé†’ä¸€ç‚¹:

> 10.ä½ åº”è¯¥çœ‹åˆ°è“è‰² LED é—ªè€€ 5 ç§’é’Ÿï¼ˆä¸é—ªçƒï¼‰å¹¶å¼€å§‹ç§»åŠ¨ï¼ˆDaFang / Wyzecam Panï¼‰ã€‚å¦‚æœæ²¡æœ‰ï¼Œå‡ºäº†ç‚¹é—®é¢˜ã€‚æ‚¨åº”è¯¥å°è¯•ä½¿ç”¨å¦ä¸€å¼  microSD å¡ï¼Œç„¶åæŸ¥çœ‹é¡µé¢åº•éƒ¨çš„ç¤¾åŒºæç¤ºã€‚ä»ç¬¬ 1 æ­¥å¼€å§‹ã€‚

å›ºä»¶åˆ·å®Œé‡å¯å, ä¸ä¸€å®šèƒ½çœ‹åˆ°è“ç¯, è¿™æ—¶å¯ä»¥ä¸ç®¡å®˜æ–¹çš„ç¬¬ 10 æ­¥, ç›´æ¥æŒ‰ç…§åç»­æ­¥éª¤æ“ä½œå³å¯, å¦‚æœè¿˜æ˜¯ä¸è¡Œ, çœ‹çœ‹è‡ªå·±çš„å®˜æ–¹å›ºä»¶ç‰ˆæœ¬æ˜¯å¦å¤ªä½, æœ€å¥½æ›´æ–°å®˜æ–¹å›ºä»¶åå†åˆ·.

å›ºä»¶åˆ·æ–°æˆåŠŸå, ä½¿ç”¨ `https://ip` ç™»å½• WEB ç®¡ç†ç«¯, **IP** å¯ä»¥é€šè¿‡è·¯ç”±å™¨è·å–:

![20241229154732_gaUq7p9v.webp](https://cdn.dong4j.site/source/image/20241229154732_gaUq7p9v.webp)

### 4.2 è®¾ç½® MQ Client

![20241229154732_9qu31MxZ.webp](https://cdn.dong4j.site/source/image/20241229154732_9qu31MxZ.webp)

æˆ‘çš„ MQ Server å°†ä¼šå®‰è£…åˆ° **192.168.31.11** è¿™å°æœåŠ¡å™¨ä¸Š(æ ‘è“æ´¾), ç«¯å£ä¸ºé»˜è®¤çš„ **1883**, å±€åŸŸç½‘å°±ä¸è¿›è¡Œé‰´æƒäº†.

å¤§æ–¹æ‘„åƒå¤´ä¸Šçš„ MQ é…ç½®æ–‡ä»¶è·¯å¾„ä¸º: `/system/sdcard/config/mqtt.conf`

```
export LD_LIBRARY_PATH='/thirdlib:/system/lib:/system/sdcard/lib'

# Options for mosquitto_sub & mosquitto_pub
USER=
PASS=
HOST=192.168.31.11
PORT=1883

# Define a location
LOCATION="ihome"

# Define device name
DEVICE_NAME="dafang"

# Define the base topic used by the camera
# send a message to myhome/dafang/set with the payload help for help.
# Results will be placed in myhome/dafang/${command} or topic/dafang/error - so please subscribe topic/dafang/# for testing purposes
# ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çŸ¥é“æœ€ç»ˆçš„ topic æ˜¯ ihome/dafang
TOPIC="$LOCATION/$DEVICE_NAME"

# Define an autodiscovery prefix, if autodiscovery is desired:
# AUTODISCOVERY_PREFIX="homeassistant"

# Define additional options for Mosquitto here.
# For example --cafile /system/sdcard/config/DST_Root_CA_X3.pem --tls-version tlsv1
# or use a special id to connect to brokers like azure
MOSQUITTOOPTS=""

# Add options for mosquitto_pub like -r for retaining messages
MOSQUITTOPUBOPTS=""

# Send a mqtt statusupdate every n seconds
STATUSINTERVAL=30

# Define whether you would like to have light level exposed (by hardware sensor og virtual calcuations).
# If the device doesn't come with a hardware sensor, your only option is to use 'virtual'.
#
#  Options:
#	hw = Use 'hw' if the device has build in hardware light sensor. For more details, see . See issue eg. #1120 for more details...
#	virtual = Use 'virtual' calculations, based on the lightlevel on the image, also known as ISP exposure (from /proc/jz/isp/isp_info)
#	false = Use 'false' (default) to DISABLE the topic (It will not publishing details about light level)
LIGHT_SENSOR="false"
AUTODISCOVERY_PREFIX="dafang"
```

#### 4.2.1 è®¾ç½®åŠ¨ä½œæ£€æµ‹

![20241229154732_5lj7Yby3.webp](https://cdn.dong4j.site/source/image/20241229154732_5lj7Yby3.webp)

#### 4.2.2 è®¾ç½®åŠ¨ä½œæ¨é€

![20241229154732_JT8hisM3.webp](https://cdn.dong4j.site/source/image/20241229154732_JT8hisM3.webp)

#### 4.2.3 æµ‹è¯•

è¿™é‡Œä½¿ç”¨ MQTTX è¿›è¡Œæµ‹è¯•:

![20241229154732_g6k1QbKW.webp](https://cdn.dong4j.site/source/image/20241229154732_g6k1QbKW.webp)

![20241229154732_d8u7WoLg.webp](https://cdn.dong4j.site/source/image/20241229154732_d8u7WoLg.webp)

è®¢é˜…çš„ topic: `ihome/dafang/#`

å¯ä»¥çœ‹åˆ°æœ‰å¤šä¸ª topic å¯ä½¿ç”¨:

```
ihome/dafang
ihome/dafang/leds/blue
ihome/dafang/leds/yellow
ihome/dafang/leds/ir
ihome/dafang/ir_cut
ihome/dafang/rtsp_server
ihome/dafang/night_mode
ihome/dafang/night_mode/auto
ihome/dafang/recording
ihome/dafang/timelapse
ihome/dafang/motion
ihome/dafang/motion/detection
ihome/dafang/motion/led
ihome/dafang/motion/snapshot
ihome/dafang/motion/video
ihome/dafang/motion/mqtt_publish
ihome/dafang/motion/mqtt_snapshot
ihome/dafang/motion/send_mail
ihome/dafang/motion/send_telegram
ihome/dafang/motion/tracking
ihome/dafang/motion
```

æˆ‘ä»¬åªéœ€è¦ `ihome/dafang/motion` è¿™ä¸ª topic, å½“ç›‘æµ‹åˆ°åŠ¨ä½œæ—¶, å¤§æ–¹æ‘„åƒå¤´å°†å‘ `ihome/dafang/motion` å‘é€ `ON`, åŠ¨ä½œç»“æŸåå‘é€ `OFF`.

å¤§æ–¹æ‘„åƒå¤´çš„ç›‘æµ‹é…ç½®åŒæ ·å¯ä»¥ä½¿ç”¨é…ç½®æ–‡ä»¶é…ç½®, è·¯å¾„ä¸º `/system/sdcard/config/motion.conf`, ä¿®æ”¹å®Œæˆåä½¿ç”¨ WEB ç®¡ç†ç«¯é‡å¯ MQTT æœåŠ¡å³å¯.

### 4.3 æ ‘è“æ´¾å®‰è£… MQ æœåŠ¡

MQTT æœåŠ¡ç«¯é€‰æ‹©ä½¿ç”¨è½»é‡çº§çš„ **mosquitto**, å®‰è£…å‘½ä»¤:

```shell
sudo apt update
sudo apt upgrade
sudo apt install mosquitto mosquitto-clients
```

å®‰è£…å®ŒæˆåéªŒè¯æ˜¯å¦æˆåŠŸ

```
sudo systemctl status mosquitto
```

æ­¤å‘½ä»¤å°†è¿”å› `mosquitto` æœåŠ¡çš„çŠ¶æ€ã€‚

å¦‚æœæœåŠ¡å·²æ­£å¸¸å¯åŠ¨ï¼Œåº”è¯¥ä¼šçœ‹åˆ°æ–‡æœ¬ `active (running)`.

#### 4.3.1 æµ‹è¯•

`mosquitto` è‡ªå¸¦äº† `mosquitto_pub` å’Œ `mosquitto_sub` å‘½ä»¤, å› æ­¤æˆ‘ä»¬ä½¿ç”¨è¿™ä¸¤ä¸ªå‘½ä»¤è¿›è¡Œç®€å•çš„æµ‹è¯•:

åœ¨ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œ:

```
mosquitto_sub -h localhost -t "mqtt/test"
```

æ–°å¼€ä¸€ä¸ªç»ˆç«¯å‘ `mqtt/test` å‘é€æ¶ˆæ¯:

```
mosquitto_pub -h localhost -t "mqtt/test" -m "hello baby"
```

![20241229154732_TVrWlkGc.webp](https://cdn.dong4j.site/source/image/20241229154732_TVrWlkGc.webp)

### 4. å®‰è£… bark æœåŠ¡

#### 4.1 æœåŠ¡ç«¯

åœ¨ `192.168.31.33`æœåŠ¡å™¨ä¸Š ä½¿ç”¨ docker å®‰è£… [bark](https://github.com/adams549659584/bark-server):

```
version: '3.8'
services:
  bark-server:
  	# è¿™ä¸ªé•œåƒæ¯”å®˜æ–¹çš„åŠŸèƒ½å¤šä¸€äº›, æ¯”å¦‚æ”¯æŒ markdown
    image: adams549659584/bark-server
    container_name: barkd-server
    restart: unless-stopped
    volumes:
      - ./data:/data
      - ./web:/web
    ports:
      - "8082:8080"
```

#### 4.2 å®¢æˆ·ç«¯

- [iOS](https://github.com/Finb/Bark)
- [Android](https://github.com/xlvecle/PushLite)
- [Chrome æ’ä»¶](https://github.com/xlvecle/Bark-Chrome-Extension)
- [åœ¨çº¿å®šæ—¶å‘é€](https://api.ihint.me/bark.html)
- [Windows æ¨é€å®¢æˆ·ç«¯](https://github.com/HsuDan/BarkHelper)
- [è·¨å¹³å°çš„å‘½ä»¤è¡Œåº”ç”¨](https://github.com/JasonkayZK/bark-cli)
- [GitHub Actions](https://github.com/harryzcy/action-bark)
- [Quicker åŠ¨ä½œ](https://getquicker.net/Sharedaction?code=e927d844-d212-4428-758d-08d69de12a3b)
- [Bark for Wox](https://github.com/Zeroto521/Wox.Plugin.Bark)
- [bark-jssdk](https://github.com/afeiship/bark-jssdk)
- [java-bark-server](https://gitee.com/hotlcc/java-bark-server)
- [Python for Bark](https://github.com/funny-cat-happy/barknotificator)

### 5.4 æ¨é€å‘Šè­¦åˆ°æ‰‹æœº

æ¥åˆ°æœ€åä¸€æ­¥äº†, è¿™é‡Œè®²ä½¿ç”¨ python æ¥å†™ä¸€ä¸ª mosquitto client å¹¶ç›‘å¬ `ihome/dafang/motion`, å¦‚æœå€¼ä¸º `ON` åˆ™ä½¿ç”¨ `bark` å‘é€æ¶ˆæ¯.

#### 5.4.1 å®‰è£…ä¾èµ–

```
pip install paho-mqtt
```

#### 5.4.2 ç¼–å†™è„šæœ¬ (sub.py)

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
A small example subscriber
"""
import paho.mqtt.client as paho
import requests

# å®šä¹‰è¿æ¥æˆåŠŸåçš„å›è°ƒå‡½æ•°
def on_connect(client, userdata, flags, rc):
    print("Connected with result code "+str(rc))

def on_message(mosq, obj, msg):
    print("%-20s %d %s" % (msg.topic, msg.qos, msg.payload.decode()))
    mosq.publish('pong', 'ack', 0)
    if msg.payload.decode() == 'ON':
      	# å‘ bark å‘é€æ¶ˆæ¯
        requests.get('http://192.168.31.33:8082/nmfxNpbf37LZC654nA2HVF/å¨ƒå„¿åŠ¨äº†/å¿«å»çœ‹ä¸€ä¸‹?icon=https://s2.loli.net/2023/10/28/Xoft5KR2xZm3aCd.jpg')

if __name__ == '__main__':
    client = paho.Client()
    client.on_connect = on_connect
    client.on_message = on_message

    #client.tls_set('root.ca', certfile='c1.crt', keyfile='c1.key')
    client.connect("192.168.31.11", 1883, 60)

    client.subscribe("ihome/dafang/motion", 0)

    while client.loop() == 0:
        pass%
```

#### 5.4.3 æ‰§è¡Œè„šæœ¬

```
python sub.py
```

åœ¨å¤§æ–¹æ‘„åƒå¤´å‰é¢åŠ¨ä¸€ä¸‹åº”è¯¥å°±å¯ä»¥æ”¶åˆ°æ¶ˆæ¯äº†:

![20241229154732_2pUUMdil.webp](https://cdn.dong4j.site/source/image/20241229154732_2pUUMdil.webp)

#### 5.4.4 è®¾ç½®è‡ªåŠ¨å¯åŠ¨

ä¸º sub.py è®¾ç½®å¯æ‰§è¡Œæƒé™:

```shell
chmod +x sub.py
```

##### åˆ›å»º Systemd æœåŠ¡é…ç½®

å»ºç«‹ä¸€ä¸ªæ–°çš„ Systemd æœåŠ¡å•å…ƒé…ç½®æ–‡ä»¶ï¼Œå‚¨å­˜äº`/etc/systemd/system/motion.service`ï¼š

```
[Unit]
Description=dafang MQTT Motion

[Service]
Type=simple
ExecStart=/home/dong4j/sub.py
Restart=always
[Install]
WantedBy=multi-user.target
```

ç›¸å…³å‘½ä»¤

```
# å¼€æœºå¯åŠ¨
systemctl enable motion
# å…³é—­å¼€æœºå¯åŠ¨
systemctl disable motion
# å¯åŠ¨æœåŠ¡
systemctl start motion
# åœæ­¢æœåŠ¡
systemctl stop motion
# é‡å¯æœåŠ¡
systemctl restart motion
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
systemctl status motion
systemctl is-active motion.service
# ç»“æŸæœåŠ¡è¿›ç¨‹(æœåŠ¡æ— æ³•åœæ­¢æ—¶)
systemctl kill motion
```

## 6. å‚è€ƒ

1. [Linux æ·»åŠ å¼€æœºè‡ªå¯åŠ¨](https://www.cnblogs.com/jhxxb/p/10654554.html)
2. [linux Ubuntu é€šè¿‡ systemd æ·»åŠ å¼€æœºè‡ªåŠ¨å¯åŠ¨ç¨‹åºæ–¹æ³•](https://blog.p2hp.com/archives/8690)

## [æ„å»ºè‡ªå·±çš„å…¬ç½‘IPæœåŠ¡ï¼šNginx Proxy Managerå®æˆ˜](https://blog.dong4j.site/posts/1fd7702b.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## 1. èƒŒæ™¯

å› ä¸º DDNS-GO æ¥å…¥äº†é˜¿é‡Œäº‘çš„ DDNS æœåŠ¡, ä¼šå‡ºç°é¢‘ç¹çš„è°ƒç”¨é…ç½®çš„ URL å»è·å–å…¬ç½‘ IP å¹¶æ›´æ–°åˆ°é˜¿é‡Œäº‘, å¦‚æœéƒ¨åˆ† IP æŸ¥è¯¢ç½‘ç«™è®¾ç½®äº†è¯·æ±‚é™åˆ¶, å°†å¯¼è‡´æˆ‘çš„åŸŸåå¤±æ•ˆ.

å› æ­¤è€ƒè™‘ä½¿ç”¨ Nginx æ¥æ­å»ºä¸€ä¸ªè·å–å…¬ç½‘ IP çš„æœåŠ¡, ç”¨æ¥ç»™ DDNS-GO ä½¿ç”¨.

## 2. ä½¿ç”¨ Nginx

åœ¨ç½‘ä¸ŠæŸ¥è¯¢èµ„æ–™å, åªéœ€è¦å¯¹ Nginx è¿›è¡Œç®€å•çš„é…ç½®å³å¯:

```
server {
    listen 8000;
    listen [::]:8000;
    server_name ip.xxx ip.yyy;
    server_tokens off;

    location = /ip {
        add_header Content-Type text/plain;
        access_log off;
        return 200 "$remote_addr\n";
    }
}
```

ç„¶åä½¿ç”¨ `curl http://ip.xxx:8000/ip` æˆ–è€… `curl http://ip.yyy:8000/ip` å³å¯è¿”å›å…¬ç½‘ IP.

## 3. ä½¿ç”¨ Nginx Proxy Manager

å› ä¸ºç½‘ç»œç¯å¢ƒçš„åŸå› , ä½¿ç”¨ç°æˆçš„ Nginx Proxy Manager æ¥ä»£æ›¿ Nginx, è¿™é‡Œè¯´ä¸€ä¸‹æˆ‘çš„ç½‘ç»œç¯å¢ƒ:

![20241229154732_BK2F4R7y.webp](https://cdn.dong4j.site/source/image/20241229154732_BK2F4R7y.webp)

1. ç”µä¿¡å®½å¸¦ä½¿ç”¨ AX9000 ä½œä¸ºè·¯ç”±å™¨, åœ¨è·¯ç”±å™¨å°† **3200** ç«¯å£è½¬å‘åˆ° **192.168.10.10**(NPM æœåŠ¡) çš„ **32433** HTTPS ç«¯å£, è¿™æ ·å°±å¯ä»¥ä½¿ç”¨ `https://ip.xxx.info:3200` æ¥è®¿é—® NPM çš„ä»£ç†;
2. è”é€šå®½å¸¦ä½¿ç”¨ HD ä½œä¸ºè·¯ç”±å™¨, åŒæ ·å°† **3200** ç«¯å£è½¬å‘åˆ° **192.168.20.10**(NPM æœåŠ¡) çš„ 32433 HTTPS ç«¯å£, è¿™æ ·å°±å¯ä»¥ä½¿ç”¨ `https://ip.xxx.cc:3200` æ¥è®¿é—® NPM çš„ä»£ç†;

å›¾ä¸Šé¢çš„æ¯”å¦‚åŸŸåçš„èŒƒè§£æ, è·¯ç”±å™¨çš„ç«¯å£è½¬å‘, NPM çš„åå‘ä»£ç†é…ç½®ç­‰é…ç½®å°±ä¸å†è¿™é‡Œè¯¦ç»†è¯´æ˜äº†, å¦‚æœéœ€è¦çš„è¯å¯ä»¥å‚è€ƒç½‘ä¸Šå…³äº NPM çš„ä½¿ç”¨æ–¹å¼.

### 3.1 åŸŸåæ³›è§£æ

å®¶é‡Œæœ‰ 1000M ç”µä¿¡å®½å¸¦å’Œ 1000M è”é€šå®½å¸¦, åˆ†åˆ«åœ¨é˜¿é‡Œäº‘å’Œè…¾è®¯äº‘è´­ä¹°äº† 2 ä¸ªåŸŸå, ä½¿ç”¨æ³›åŸŸåçš„å¥½å¤„æ˜¯åªéœ€è¦é…ç½®ä¸€ä¸ªæ³›åŸŸåå³å¯æ”¯æŒæ— é™å¤šçš„äºŒçº§åŸŸå, è¿™æ ·å®¶é‡Œæ–°å¢äº†æœåŠ¡åå°±ä¸éœ€è¦å†å»äº‘æœåŠ¡å‚å•†é…ç½®åŸŸåäº†, ä¸‹é¢åˆ†åˆ«è¯´ä¸€ä¸‹åŸŸåæ³›è§£æçš„é…ç½®.

#### 3.1.1 é˜¿é‡Œäº‘

![20241229154732_iGIIYyxR.webp](https://cdn.dong4j.site/source/image/20241229154732_iGIIYyxR.webp)

> _ï¼šæ³›è§£æï¼ŒåŒ¹é…å…¶ä»–æ‰€æœ‰åŸŸå, æ¯”å¦‚é…ç½®äº† _.aliyun.com, å°†åŒ¹é…: a.aliyun.com, b.aliyun,com

#### 3.1.1 è…¾è®¯äº‘

![20241229154732_jJspV63h.webp](https://cdn.dong4j.site/source/image/20241229154732_jJspV63h.webp)

é…ç½®æ–¹å¼ä¸é˜¿é‡Œäº‘ä¸€è‡´. **www å…¶å®ä¸éœ€è¦é…ç½®.**

### 3.2 è·¯ç”±å™¨ç«¯å£è½¬å‘

å®¶é‡Œéƒ½æ˜¯å°ç±³è·¯ç”±å™¨, æ‰€ä»¥ç«¯å£è½¬å‘é…ç½®æ–¹å¼ä¸€è‡´:

#### 3.2.1 AX9000-ç”µä¿¡

![20241229154732_SAA9DagP.webp](https://cdn.dong4j.site/source/image/20241229154732_SAA9DagP.webp)

1. å¤–éƒ¨ç«¯å£, æ¯”å¦‚: **3200**;
2. å†…éƒ¨ IP åœ°å€, æ¯”å¦‚: **192.168.10.10**;
3. å†…éƒ¨ç«¯å£: æ¯”å¦‚: **32443**, è¿™é‡Œçš„å†…éƒ¨ç«¯å£éœ€è¦é…ç½®æˆ NPM çš„ HTTPS ç«¯å£.

ä¸Šè¿°é…ç½®è¡¨ç¤ºä»»ä½•ä½¿ç”¨ 3200 ç«¯å£è®¿é—®è·¯ç”±å™¨çš„æµé‡éƒ½ä¼šè¢«è½¬å‘åˆ° **192.168.10.10** æœåŠ¡å™¨çš„ **32443** ç«¯å£.

#### 3.2.2 HD-è”é€š

å°†å¤–éƒ¨çš„ **3400** ç«¯å£è½¬å‘åˆ°å†…éƒ¨ **192.168.20.10** æœåŠ¡å™¨çš„ **32443** ç«¯å£;

### 3.3 NPM ä»£ç†

R5S å’Œ R2S åˆ†åˆ«è¿æ¥äº†ç”µä¿¡å’Œè”é€š, NPM ä½¿ç”¨ docker éƒ¨ç½², docker-compose.yml å¦‚ä¸‹:

```yaml
version: '3.8'
services:
  app:
    image: 'chishin/nginx-proxy-manager-zh:latest'
    restart: unless-stopped
    ports:
    	# HTTP ç«¯å£
      - '8080:80'
      # web ç®¡ç†ç«¯ç«¯å£
      - '8081:81'
      # HTTPS ç«¯å£
      - '32443:443'
    volumes:
      - ./data:/data
      - ./letsencrypt:/etc/letsencrypt
```

#### 3.3.1 R5S-ç”µä¿¡

è½¬å‘é…ç½®å¦‚ä¸‹:

![20241229154732_oGR0KeTR.webp](https://cdn.dong4j.site/source/image/20241229154732_oGR0KeTR.webp)

ä½¿ç”¨ `https://ip.xxx.info:3200` è¿›å…¥çš„æµé‡å°†è¢«è½¬å‘åˆ° `192.168.10.10:8000` æ‰€åœ¨çš„æœåŠ¡, è€Œ **192.168.10.10** æ‰€åœ¨çš„æœåŠ¡å™¨å°±æ˜¯ NPM æ‰€åœ¨çš„å¯„ä¸»æœº(R5S), **8000** ç«¯å£éœ€è¦åç»­çš„é…ç½®.

#### 3.3.2 R2S-è”é€š

![20241229154732_AfBq8dyJ.webp](https://cdn.dong4j.site/source/image/20241229154732_AfBq8dyJ.webp)

ä½¿ç”¨ `https://ip.xxx.cc:3200` è¿›å…¥çš„æµé‡å°†è¢«è½¬å‘åˆ° `192.168.20.10:8000` æ‰€åœ¨çš„æœåŠ¡, è€Œ **192.168.20.10** æ‰€åœ¨çš„æœåŠ¡å™¨å°±æ˜¯ NPM æ‰€åœ¨çš„å¯„ä¸»æœº (R2S), **8000** ç«¯å£éœ€è¦åç»­çš„é…ç½®.

ä»¥ä¸Šé…ç½®å®Œæˆå, ç½‘ç»œæ‹“æ‰‘å›¾å¦‚ä¸‹:

![xxx.drawio.svg](https://cdn.dong4j.site/source/image/xxx.drawio.svg)

### 3.4 é…ç½® NPM ä»¥æ”¯æŒè·å–å…¬ç½‘ IP

> R5S å’Œ R2S çš„ NPM é…ç½®ä¸€è‡´, è¿™é‡Œå°±ä»¥ R5S çš„é…ç½®ä¸ºä¾‹æ¥è¯´æ˜.

ä¿®æ”¹ `./data/nginx/proxy_host` ä¸‹çš„é…ç½®æ–‡ä»¶ (å…·ä½“çš„è·¯å¾„æ ¹æ®è‡ªå·±çš„ docker-compose.yml æ¥), å…·ä½“æ­¥éª¤ä¸º:

1. æ‰¾åˆ°åˆšåˆšé…ç½®çš„ä»£ç†é…ç½®æ–‡ä»¶, æ¯”å¦‚æˆ‘æ˜¯ 1.conf:

   ```ini
   # ------------------------------------------------------------
   # ip.xxx.info
   # ------------------------------------------------------------

   server {
     set $forward_scheme http;
     set $server         "192.168.10.10";
     set $port           8000;

     listen 80;
     listen [::]:80;
     listen 443 ssl http2;
   	listen [::]:443 ssl http2;
     server_name ip.xxx.info;

    	# Let's Encrypt SSL
     include conf.d/include/letsencrypt-acme-challenge.conf;
     include conf.d/include/ssl-ciphers.conf;
     ssl_certificate /etc/letsencrypt/live/npm-21/fullchain.pem;
     ssl_certificate_key /etc/letsencrypt/live/npm-21/privkey.pem;

     access_log /data/logs/proxy-host-22_access.log proxy;
     error_log /data/logs/proxy-host-22_error.log warn;
     location / {
       # Proxy!
       include conf.d/include/proxy.conf;
     }
     # Custom
     include /data/nginx/custom/server_proxy[.]conf;
   }
   ```

2. æ·»åŠ  IP é…ç½®:

   ```ini
   # ------------------------------------------------------------
   # ip.xxx.info
   # ------------------------------------------------------------

   server {
     set $forward_scheme http;
     set $server         "192.168.10.10";
     set $port           8000;

     listen 80;
     listen [::]:80;
     listen 443 ssl http2;
   	listen [::]:443 ssl http2;
     server_name ip.xxx.info;

     # Let's Encrypt SSL
     include conf.d/include/letsencrypt-acme-challenge.conf;
     include conf.d/include/ssl-ciphers.conf;
     ssl_certificate /etc/letsencrypt/live/npm-21/fullchain.pem;
     ssl_certificate_key /etc/letsencrypt/live/npm-21/privkey.pem;

     access_log /data/logs/proxy-host-22_access.log proxy;
     error_log /data/logs/proxy-host-22_error.log warn;
     location / {
       # Proxy!
       include conf.d/include/proxy.conf;
     }

     # è¿™æ˜¯æ–°å¢çš„
     location = /ip {
       add_header Content-Type text/plain;
       access_log off;
       return 200 "$remote_addr\n";
     }

     # Custom
     include /data/nginx/custom/server_proxy[.]conf;
   }
   ```

#### 3.4.1 é‡å¯ NPM

```shell
docker-compose restart
```

é‡å¯ NPM åå³å¯ä½¿ç”¨ ` curl https://ip.xxx.info:3200/ip` è·å–å…¬ç½‘ IP.

#### 3.4.2 DDNS-GO é…ç½®

##### 3.4.2.1 ç”µä¿¡

![20241229154732_VXHcTW4M.webp](https://cdn.dong4j.site/source/image/20241229154732_VXHcTW4M.webp)

##### 3.4.2.2 è”é€š

![20241229154732_XtP1vVr9.webp](https://cdn.dong4j.site/source/image/20241229154732_XtP1vVr9.webp)

##### 3.4.2.3 é‡å¯ DDNS-GO

```
docker-compose restart
```

å®Œæˆåçš„ç½‘ç»œæ‹“æ‰‘å›¾å¦‚ä¸‹:

![yyy.drawio.svg](https://cdn.dong4j.site/source/image/yyy.drawio.svg)

## 4. æ€»ç»“

1. DDNS-GO ä¸€å®šè¦ä½¿ç”¨åŸŸåæ¥è·å–å…¬ç½‘ IP, å¦åˆ™åªèƒ½è·å–åˆ°å±€åŸŸç½‘ IP;

2. ä»¥ä¸Šæ ¸å¿ƒçš„è¿˜æ˜¯ä¸‹é¢çš„é…ç½®:

   ```
   location = /ip {
     add_header Content-Type text/plain;
     access_log off;
     return 200 "$remote_addr\n";
   }
   ```

3. NPM è¦åŒºåˆ† HTTP å’Œ HTTPS ç«¯å£, å¦‚æœè·¯ç”±å™¨è½¬å‘åˆ° NPM çš„ **8080** åˆ™æ˜¯ HTTP, è½¬å‘åˆ° **32443** åˆ™æ˜¯ HTTPS;
4. HTTPS ç«¯å£éœ€è¦é…ç½® HTTPS , å¯ä»¥ä½¿ç”¨ NPM è‡ªå¸¦çš„ **Let's Encrypt** æœåŠ¡è·å–, å…·ä½“çš„é…ç½®æ–¹å¼å¯ä»¥å‚è€ƒå®˜ç½‘;

## 5. å‚è€ƒ

1. [ä½¿ç”¨ nginx è·å–è‡ªå·±çš„å…¬ç½‘ IP åœ°å€](https://hellodk.cn/post/1133)
2. [åˆ©ç”¨ Nginx å®ç°ç®€æ˜“çš„å…¬ç½‘ IP æŸ¥è¯¢](https://zhuanlan.zhihu.com/p/629311484)
3. [çº¯ Nginx æ‰“é€  IP åœ°å€æŸ¥è¯¢æ¥å£](https://www.rehiy.com/post/467/)

## [ä¸šåŠ¡åœºæ™¯å…¨è§£ï¼šå¦‚ä½•åº”å¯¹è§†é¢‘é›†æˆæŒ‘æˆ˜](https://blog.dong4j.site/posts/a31e50a5.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

ä¸»è¦ä»‹ç»äº†è§†é¢‘é›†æˆè§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬è§†é¢‘ç›‘æ§æ•°æ®æµè½¬ã€éŸ³è§†é¢‘ä¼ è¾“åè®®å¯¹æ¯”ã€åè®®æ¥å…¥ã€ä¸»æµçš„æµåª’ä½“åè®®ã€æ’­æ”¾åè®®å¯¹æ¯”ã€ä¸»æµçš„å°è£…æ ¼å¼ã€ä¸»è¦è§†é¢‘ç¼–ç ã€å¸¸è§çš„è®¾å¤‡ä¸è¿æ¥æ–¹æ¡ˆã€æœ¯è¯­è§£é‡Šã€ä¸šåŠ¡åœºæ™¯ã€è§†é¢‘æ¥å…¥å¹³å°ã€æµåª’ä½“æœåŠ¡é€‰å‹ä»¥åŠå¹³å°é€‰å‹ç­‰æ–¹é¢çš„å†…å®¹ã€‚é€šè¿‡è¿™ç¯‡æ–‡ç« ï¼Œè¯»è€…å¯ä»¥äº†è§£åˆ°è§†é¢‘é›†æˆå¸¸è§çš„è§£å†³æ–¹æ¡ˆï¼Œå¹¶ä»ç°æœ‰æ–¹æ¡ˆä¸­å­¦ä¹ æ€»ç»“ï¼Œä»¥åº”å¯¹æ—¥ç›Šå¤æ‚çš„ä¸šåŠ¡åœºæ™¯ã€‚

## 1. ç›®çš„

éšç€æ‰¿æ¥çš„é¡¹ç›®é€æ¸å¢å¤š, ä¸”å¤§å¤šæ•°é¡¹ç›®éƒ½ä¼šæ¶‰åŠåˆ°è§†é¢‘ç›‘ç®¡éœ€æ±‚, ä¸ºäº†é¿å…é‡å¤è°ƒç ”å¼€å‘, åŠ å¿«é¡¹ç›®ä¸Šçº¿é€Ÿåº¦, è¿™é‡Œæ±‡æ€»æ€»ç»“äº†å¤šç§ä¸šåŠ¡åœºæ™¯å¹¶æå‡ºå¯¹åº”çš„è§£å†³æ–¹æ¡ˆ, ä¸€æ–¹é¢æ˜¯ä½œä¸ºæŠ€æœ¯çŸ¥è¯†ç§¯ç´¯, è®©å›¢é˜Ÿäººå‘˜äº†è§£è§†é¢‘é›†æˆå¸¸è§çš„è§£å†³æ–¹æ¡ˆ, äºŒæ˜¯å¯ä»¥ä»ç°æœ‰æ–¹æ¡ˆä¸­å­¦ä¹ æ€»ç»“, ä»¥åº”å¯¹æ—¥ç›Šå¤æ‚çš„ä¸šåŠ¡åœºæ™¯.

## 2. é¢†åŸŸçŸ¥è¯†

### 2.1 ç›‘æ§æ•°æ®æµ

![1.drawio.svg](https://cdn.dong4j.site/source/image/1.drawio.svg)

è§†é¢‘ç›‘æ§æ•°æ®æµè½¬ä¸»è¦ç»è¿‡ä¸‹é¢ 5 ä¸ªè¿‡ç¨‹:

1. é‡‡é›†: é€šè¿‡ç¡¬ä»¶è®¾å¤‡é‡‡é›†éŸ³è§†é¢‘æ•°æ®, å¦‚æœç¡¬ä»¶è®¾å¤‡æ”¯æŒ, è¿˜å¯ä»¥å¯¹æ•°æ®è¿›è¡Œç²—åŠ å·¥, æ¯”å¦‚æ·»åŠ æ°´å°;
2. æ¨æµ: è®¾å¤‡ç«¯å°†éŸ³è§†é¢‘æ•°æ®è¿›`è¡Œç¼–ç å‹ç¼©(H.264/H.265)åå‘é€ç»™æµåª’ä½“æœåŠ¡å™¨, ä¸€èˆ¬ä½¿ç”¨ RTSP (å»¶è¿Ÿæœ€ä½);
3. æµåª’ä½“å¤„ç†: è´Ÿè´£è½¬ç , ä¼ è¾“, æ•°æ®åˆ†å‘;
4. æ‹‰æµ: å®¢æˆ·ç«¯è¯·æ±‚æµåª’ä½“æœåŠ¡å™¨éŸ³è§†é¢‘èµ„æº, æµåª’ä½“æœåŠ¡å™¨é€šè¿‡ RTSP, HLS ç­‰æµåª’ä½“ä¼ è¾“åè®®ä¼ è¾“æ•°æ®;
5. è§£ç : è®¾å¤‡ç«¯åœ¨æ‹¿åˆ°éŸ³è§†é¢‘æ•°æ®åéœ€è¦é€šè¿‡ç¡¬è§£ç æˆ–è½¯è§£ç çš„æ–¹å¼æ’­æ”¾éŸ³è§†é¢‘æµ;

### 2.2 éŸ³è§†é¢‘ä¼ è¾“åè®®å¯¹æ¯”

![20241229154732_JlUVbWmH.webp](https://cdn.dong4j.site/source/image/20241229154732_JlUVbWmH.webp)

### 2.3 åè®®æ¥å…¥

#### 2.3.1 GB/T28181

![20241229154732_OfCzxzaf.webp](https://cdn.dong4j.site/source/image/20241229154732_OfCzxzaf.webp)

**GB/T28181 æ˜¯æ‘„åƒå¤´ä¸»åŠ¨å‘ä¸Šçº§å¹³å°è¿æ¥æ³¨å†Œï¼Œæ‘„åƒå¤´ä¸éœ€è¦æœ‰å›ºå®šçš„å¤–ç½‘ IPï¼Œåªè¦æ±‚æµåª’ä½“æœåŠ¡å™¨æœ‰å›ºå®šçš„ IP åœ°å€å³å¯**

#### 2.3.2 ONVIF

![20241229154732_2e3a6yQY.webp](https://cdn.dong4j.site/source/image/20241229154732_2e3a6yQY.webp)

**ONVIF åè®®æ˜¯æµåª’ä½“æœåŠ¡å™¨ä¸»åŠ¨å»è¿æ¥æ‘„åƒå¤´ï¼Œç„¶åè¿›è¡Œæ§åˆ¶æˆ–è§†é¢‘è°ƒå–ï¼Œå› æ­¤åœ¨ç»„ç½‘æ—¶éœ€è¦æµåª’ä½“æœåŠ¡å™¨èƒ½å¤Ÿè®¿é—®åˆ°æ‘„åƒå¤´çš„ IP åœ°å€**

### 2.4 ä¸»æµçš„æµåª’ä½“åè®®

| åç§°     | æ¨å‡ºæœºæ„       | ä¼ è¾“å±‚åè®® | å®¢æˆ·ç«¯  | ä½¿ç”¨é¢†åŸŸ          |
| -------- | -------------- | ---------- | ------- | ----------------- |
| RTSP+RTP | IETF           | TCP+UDP    | VLC WMP | IPTV              |
| RTMP     | Adobe Inc.     | TCP        | Flash   | äº’è”ç½‘ç›´æ’­        |
| RTMFP    | Adobe Inc.     | UDP        | Flash   | äº’è”ç½‘ç›´æ’­        |
| MMS      | Microsoft Inc. | TCP/UDP    | WMP     | äº’è”ç½‘ç›´æ’­ + ç‚¹æ’­ |
| HTTP     | WWW IETF       | TCP        | Flash   | äº’è”ç½‘ç‚¹æ’­        |

### 2.5 æ’­æ”¾åè®®å¯¹æ¯”

RTMPï¼šRTMP åè®®æ¯”è¾ƒå…¨èƒ½ã€‚æ—¢å¯ä»¥ç”¨æ¥æ¨é€åˆå¯ä»¥ç”¨æ¥ç›´æ’­ã€‚å…¶æ ¸å¿ƒç†å¿µæ˜¯å°†å¤§å—çš„è§†é¢‘å¸§å’ŒéŸ³é¢‘å¸§æ‹†åˆ†ï¼Œç„¶åä»¥å°æ•°æ®åŒ…çš„å½¢å¼åœ¨äº’è”ç½‘ä¸Šè¿›è¡Œä¼ è¾“ï¼Œè€Œä¸”æ”¯æŒåŠ å¯†ï¼Œå› æ­¤éšç§æ€§ç›¸å¯¹æ¯”è¾ƒç†æƒ³ï¼Œä½†æ‹†åŒ…ç»„åŒ…çš„è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥åœ¨æµ·é‡å¹¶å‘æ—¶ä¹Ÿå®¹æ˜“å‡ºç°ä¸€äº›ä¸å¯é¢„æœŸçš„ç¨³å®šæ€§é—®é¢˜ã€‚

FLVï¼šFLV åè®®ç”± Adobe å…¬å¸ä¸»æ¨ï¼Œæ ¼å¼æå…¶ç®€å•ï¼Œåªæ˜¯åœ¨å¤§å—çš„è§†é¢‘å¸§å’ŒéŸ³è§†é¢‘å¤´éƒ¨åŠ å…¥ä¸€äº›æ ‡è®°å¤´ä¿¡æ¯ï¼Œç”±äºè¿™ç§ç®€æ´ï¼Œåœ¨å»¶è¿Ÿè¡¨ç°å’Œå¤§è§„æ¨¡å¹¶å‘æ–¹é¢éƒ½å¾ˆæˆç†Ÿï¼Œå”¯ä¸€çš„ä¸è¶³å°±æ˜¯åœ¨æ‰‹æœºæµè§ˆå™¨ä¸Šçš„æ”¯æŒéå¸¸æœ‰é™ï¼Œä½†æ˜¯ç”¨ä½œæ‰‹æœºç«¯
App ç›´æ’­åè®®å´å¼‚å¸¸åˆé€‚ã€‚

HLSï¼šè‹¹æœæ¨å‡ºçš„è§£å†³æ–¹æ¡ˆï¼Œå°†è§†é¢‘åˆ† 5 ç§’ - 10 ç§’çš„è§†é¢‘å°åˆ†ç‰‡ï¼Œç„¶åç”¨ m3u8 ç´¢å¼•è¡¨è¿›è¡Œç®¡ç†ï¼Œç”±äºå®¢æˆ·ç«¯ä¸‹è½½åˆ°çš„è§†é¢‘éƒ½æ˜¯ 5 ç§’ - 10
ç§’çš„å®Œæ•´æ•°æ®ï¼Œæ•…è§†é¢‘çš„æµç•…æ€§å¾ˆå¥½ï¼Œä½†ä¹ŸåŒæ ·å¼•å…¥äº†å¾ˆå¤§çš„å»¶è¿Ÿï¼ˆHLS çš„ä¸€èˆ¬å»¶è¿Ÿåœ¨ 10 ç§’ - 30 ç§’å·¦å³ï¼‰ã€‚ç›¸æ¯”äº FLVï¼ŒHLS åœ¨ iPhone å’Œå¤§éƒ¨åˆ† Android
æ‰‹æœºæµè§ˆå™¨ä¸Šçš„æ”¯æŒéƒ½éå¸¸å¥½ã€‚

| æ’­æ”¾åè®®  | ä¼˜ç‚¹                   | ç¼ºç‚¹                                      | æ’­æ”¾å»¶è¿Ÿ |
| --------- | ---------------------- | ----------------------------------------- | -------- |
| FLV       | æˆç†Ÿåº¦é«˜ã€é«˜å¹¶å‘æ— å‹åŠ› | éœ€é›†æˆ SDK æ‰èƒ½æ’­æ”¾                       | 2s-3s    |
| RTMP      | ä¼˜è´¨çº¿è·¯ä¸‹ç†è®ºå»¶è¿Ÿæœ€ä½ | é«˜å¹¶å‘æƒ…å†µä¸‹è¡¨ç°ä¸ä½³ï¼›éœ€é›†æˆ SDK æ‰èƒ½æ’­æ”¾ | 1s-3s    |
| HLS(m3u8) | æ‰‹æœºæµè§ˆå™¨æ”¯æŒåº¦é«˜     | å»¶è¿Ÿéå¸¸é«˜                                | 10s-30s  |

### 2.6 ä¸»æµçš„å°è£…æ ¼å¼

| åç§° | æ¨å‡ºæœºæ„           | è§†é¢‘ç¼–ç                                  | éŸ³é¢‘ç¼–ç                                | ä½¿ç”¨é¢†åŸŸ       |
| ---- | ------------------ | ---------------------------------------- | -------------------------------------- | -------------- |
| AVI  | Microsoft Inc.     | ä¸æ”¯æŒå‡ ä¹æ‰€æœ‰æ ¼å¼                       | å‡ ä¹æ‰€æœ‰æ ¼å¼                           | BT ä¸‹è½½å½±è§†    |
| MP4  | MPEG               | æ”¯æŒ MPEG-2, MPEG-4, H.264, H.263 ç­‰     | AAC, MPEG-1,Layers I, II, III, AC-3 ç­‰ | äº’è”ç½‘è§†é¢‘ç½‘ç«™ |
| TS   | MPEG               | æ”¯æŒ MPEG-1, MPEG-2, MPEG-4, H.264MPEG-1 | Layers I, II, III, AAC                 | IPTVï¼Œæ•°å­—ç”µè§† |
| FLV  | Adobe Inc.         | æ”¯æŒ Sorenson, VP6, H.264                | MP3, ADPCM, Linear PCM, AAC ç­‰         | äº’è”ç½‘è§†é¢‘ç½‘ç«™ |
| MKV  | CoreCodec Inc.     | æ”¯æŒå‡ ä¹æ‰€æœ‰æ ¼å¼                         | å‡ ä¹æ‰€æœ‰æ ¼å¼                           | äº’è”ç½‘è§†é¢‘ç½‘ç«™ |
| RMVB | Real Networks Inc. | æ”¯æŒ RealVideo 8, 9, 10                  | AAC, Cook Codec, RealAudio,Lossless    | BT ä¸‹è½½å½±è§†    |

### 2.7 ä¸»è¦è§†é¢‘ç¼–ç 

| åç§°         | æ¨å‡ºæœºæ„       | æ¨å‡ºæ—¶é—´ | ç›®å‰ä½¿ç”¨é¢†åŸŸ |
| ------------ | -------------- | -------- | ------------ |
| HEVC (H.265) | MPEG/ITU-T     | 2013     | ç ”å‘ä¸­       |
| H.264        | MPEG/ITU-T     | 2003     | å„ä¸ªé¢†åŸŸ     |
| MPEG4        | MPEG           | 2001     | ä¸æ¸©ä¸ç«     |
| MPEG2        | MPEG           | 1994     | æ•°å­—ç”µè§†     |
| VP9          | Google         | 2013     | ç ”å‘ä¸­       |
| VP8          | Google         | 2008     | ä¸æ™®åŠ       |
| VC-1         | Microsoft Inc. | 2006     | å¾®è½¯å¹³å°     |
| AVS          | ä¸­å›½           |          |              |
| AVS+         | ä¸­å›½           |          |              |

### 8. å¸¸è§çš„è®¾å¤‡ä¸è¿æ¥æ–¹æ¡ˆ

#### 2.8.1 ç›‘æ§ç³»ç»Ÿä¸­å¸¸è§è®¾å¤‡åŠä½œç”¨

åœ¨ç›‘æ§ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨å¾ˆå¤šçš„è®¾å¤‡ï¼Œåœ¨æ­¤ï¼Œæˆ‘ä»¬åªè®²è¿°ä¸€äº›é€šç”¨çš„è®¾å¤‡ã€‚

1. **æ‘„åƒæœº**ï¼šè¿™ä¸ªæ˜¯ä¿¡å·æºï¼Œæ˜¯è§†é¢‘å›¾åƒçš„æ¥æºï¼Œæ‘„åƒæœºä¹Ÿåˆ†å¾ˆå¤šç§ï¼Œæ¯”å¦‚ï¼šé«˜é€Ÿçƒã€çº¢å¤–æªæœºç­‰ï¼›ä¸€èˆ¬æ¥è¯´æ‘„åƒæœºåé¢æ¥è§†é¢‘åˆ†é…å™¨ï¼ˆç½‘ç»œé«˜æ¸…æ‘„åƒæœºéœ€è¦æ¥è§£ç å™¨åæ‰èƒ½æ¥è§†é¢‘åˆ†é…å™¨ï¼‰ã€‚
2. **è§†é¢‘åˆ†é…å™¨**ï¼šæ˜¯å°†æ‘„åƒæœºå‡ºæ¥çš„è§†é¢‘ä¿¡å·è¿›è¡Œåˆ†é…çš„ï¼Œä¸€èˆ¬æ˜¯æ¯è·¯æ‘„åƒæœºåˆ†é…ä¸º 2 è·¯ç›¸åŒçš„è§†é¢‘ä¿¡å·ï¼Œå°†è§†é¢‘ä¿¡å·è¿›è¡Œåˆ†é…çš„ç›®çš„æ˜¯ 1
   è·¯ä¿¡å·ç»™ç›‘æ§çŸ©é˜µï¼Œå¦ä¸€è·¯ç»™ç¡¬ç›˜å½•åƒæœºï¼Œè§†é¢‘åˆ†é…å™¨çš„è¾“å…¥ç«¯æ¥æ‘„åƒæœºï¼Œè¾“å‡ºç«¯æ¥ç¡¬ç›˜å½•åƒæœºå’Œç›‘æ§çŸ©é˜µã€‚
3. **ç¡¬ç›˜å½•åƒæœº**ï¼šå°†è§†é¢‘ä¿¡æ¯è¿›è¡Œå½•åˆ¶çš„ï¼Œä»¥å¤‡éšæ—¶çš„è°ƒå–è§†é¢‘èµ„æ–™ï¼Œç¡¬ç›˜å½•åƒæœºçš„è¾“å…¥ç«¯æ¥åˆ†é…å™¨çš„è¾“å‡ºç«¯ï¼Œç¡¬ç›˜å½•åƒæœºçš„è¾“å‡ºç«¯ä¸€èˆ¬æ¥æ˜¾ç¤ºå™¨ã€‚
4. **ç›‘æ§çŸ©é˜µ**ï¼šè¿™ä¸ªè®¾å¤‡æ˜¯ç›‘æ§ç³»ç»Ÿä¸­æ ¸å¿ƒè®¾å¤‡ï¼Œæ˜¯å°†æ‘„åƒæœºè¿‡æ¥ç»è¿‡åˆ†é…å™¨åçš„è§†é¢‘ä¿¡å·ä¼ è¾“è‡³ç»ˆç«¯æ˜¾ç¤ºè®¾å¤‡ä¸Šçš„ï¼Œç›‘æ§çŸ©é˜µçš„è¾“å…¥ç«¯æ¥åˆ†é…å™¨çš„è¾“å‡ºç«¯ï¼Œç›‘æ§çŸ©é˜µçš„è¾“å‡ºç«¯æ¥ç»ˆç«¯æ˜¾ç¤ºè®¾å¤‡ï¼Œæ­¤å¤–ç›‘æ§çŸ©é˜µçš„é™„å¸¦å“æ˜¯æ§åˆ¶é”®ç›˜ï¼Œæ˜¯ç”¨æ¥æ§åˆ¶è§†é¢‘åˆ‡æ¢çš„è®¾å¤‡ï¼Œä¸ç›‘æ§çŸ©é˜µç›´æ¥ç›¸è¿å³å¯ã€‚
5. **ç»ˆç«¯æ˜¾ç¤º**ï¼šæ˜¯å°†è§†é¢‘ä¿¡æ¯å±•ç¤ºçš„è®¾å¤‡ï¼Œç»ˆç«¯æ˜¾ç¤ºè®¾å¤‡ä¸€èˆ¬æœ‰æ˜¾ç¤ºå™¨ã€ç”µè§†å¢™ã€LED æ˜¾ç¤ºå±ã€æ‹¼æ¥å±ã€ç›‘è§†å™¨ç­‰ï¼Œç»ˆç«¯æ˜¾ç¤ºè®¾å¤‡çš„è¾“å…¥ç«¯æ¥ç›‘æ§çŸ©é˜µçš„è¾“å‡ºç«¯ï¼Œç»ˆç«¯æ˜¾ç¤ºè®¾å¤‡æ²¡æœ‰è¾“å‡ºç«¯çš„ã€‚

#### 2.8.2 ç›‘æ§ç³»ç»Ÿä¸­å¸¸è§çš„è¿æ¥æ–¹æ¡ˆ

æ‘„åƒæœºçš„è¾“å‡ºç«¯æ¥è§†é¢‘åˆ†é…å™¨çš„è¾“å…¥ç«¯ï¼Œè§†é¢‘åˆ†é…å™¨çš„è¾“å‡ºç«¯åˆ†æˆ 2 ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ¥ç¡¬ç›˜å½•åƒæœºï¼Œç¬¬äºŒéƒ¨åˆ†ï¼ˆè§†é¢‘ä¿¡å·ä¸ç¬¬ä¸€éƒ¨åˆ†å®Œå…¨ç›¸åŒï¼‰æ¥ç›‘æ§çŸ©é˜µçš„è¾“å…¥ç«¯ï¼Œç›‘æ§çŸ©é˜µçš„è¾“å‡ºç«¯æ¥ç»ˆç«¯æ˜¾ç¤ºè®¾å¤‡ï¼Œæ­¤å¤–ç›‘æ§çŸ©é˜µå’Œæ§åˆ¶é”®ç›˜ç”¨ç½‘çº¿è¿æ¥ã€‚

![2.svg](https://cdn.dong4j.site/source/image/2.svg)

#### 2.8.3 è§†é¢‘åˆ†é…å™¨

![20241229154732_fxJlVXLo.webp](https://cdn.dong4j.site/source/image/20241229154732_fxJlVXLo.webp)

### 9. æœ¯è¯­è§£é‡Š

#### **GB/T28181**

GB/T28181ã€Šå®‰å…¨é˜²èŒƒè§†é¢‘ç›‘æ§è”ç½‘ç³»ç»Ÿä¿¡æ¯ä¼ è¾“ã€äº¤æ¢ã€æ§åˆ¶æŠ€æœ¯è¦æ±‚ã€‹æ˜¯ç”±å…¬å®‰éƒ¨ç§‘æŠ€ä¿¡æ¯åŒ–å±€æå‡ºï¼Œç”±å…¨å›½å®‰å…¨é˜²èŒƒæŠ¥è­¦ç³»ç»Ÿæ ‡å‡†åŒ–æŠ€æœ¯å§”å‘˜ä¼šã€å…¬å®‰éƒ¨ä¸€æ‰€ç­‰å¤šå®¶å•ä½å…±åŒèµ·è‰çš„ä¸€éƒ¨å›½å®¶æ ‡å‡†ã€‚æ ‡å‡†è§„å®šäº†åŸå¸‚ç›‘æ§æŠ¥è­¦è”ç½‘ç³»ç»Ÿä¸­ä¿¡æ¯ä¼ è¾“ã€äº¤æ¢ã€æ§åˆ¶çš„äº’è”ç»“æ„ã€é€šä¿¡åè®®ç»“æ„ï¼Œä¼ è¾“ã€äº¤æ¢ã€æ§åˆ¶çš„åŸºæœ¬è¦æ±‚å’Œå®‰å…¨æ€§è¦æ±‚ï¼Œä»¥åŠæ§åˆ¶ã€ä¼ è¾“æµç¨‹å’Œåè®®æ¥å£ç­‰æŠ€æœ¯è¦æ±‚ã€‚è¯¥æ ‡å‡†é€‚ç”¨äºå®‰å…¨é˜²èŒƒç›‘æ§æŠ¥è­¦è”ç½‘ç³»ç»Ÿçš„æ–¹æ¡ˆè®¾è®¡ã€ç³»ç»Ÿæ£€æµ‹ã€éªŒæ”¶ä»¥åŠä¸ä¹‹ç›¸å…³çš„è®¾å¤‡ç ”å‘ã€ç”Ÿäº§ï¼Œå…¶ä»–ä¿¡æ¯ç³»ç»Ÿå¯å‚è€ƒé‡‡ç”¨ã€‚è”ç½‘ç³»ç»Ÿåº”å¯¹å‰ç«¯è®¾å¤‡ã€ç›‘æ§ä¸­å¿ƒè®¾å¤‡ã€ç”¨æˆ·ç»ˆç«¯
ID è¿›è¡Œç»Ÿä¸€ç¼–ç ï¼Œè¯¥ç¼–ç å…·æœ‰å…¨å±€å”¯ä¸€æ€§ã€‚

#### **RTMP**

RTMP æ˜¯ Real Time Messaging Protocolï¼ˆå®æ—¶æ¶ˆæ¯ä¼ è¾“åè®®ï¼‰çš„é¦–å­—æ¯ç¼©å†™ã€‚è¯¥åè®®åŸºäº TCPï¼Œæ˜¯ä¸€ä¸ªåè®®æ—ï¼ŒåŒ…æ‹¬ RTMP åŸºæœ¬åè®®åŠ RTMPT/RTMPS/RTMPE
ç­‰å¤šç§å˜ç§ã€‚RTMP æ˜¯ä¸€ç§è®¾è®¡ç”¨æ¥è¿›è¡Œå®æ—¶æ•°æ®é€šä¿¡çš„ç½‘ç»œåè®®ï¼Œä¸»è¦ç”¨æ¥åœ¨ Flash/AIR å¹³å°å’Œæ”¯æŒ RTMP åè®®çš„æµåª’ä½“ / äº¤äº’æœåŠ¡å™¨ä¹‹é—´è¿›è¡ŒéŸ³è§†é¢‘å’Œæ•°æ®é€šä¿¡ã€‚

#### **ONVIF**

ONVIFï¼ˆå¼€æ”¾å¼ç½‘ç»œè§†é¢‘æ¥å£è®ºå›ï¼‰æ˜¯ä¸€ä¸ªå…¨çƒæ€§çš„å¼€æ”¾å¼è¡Œä¸šè®ºå›ï¼Œå…¶ç›®æ ‡æ˜¯ä¿ƒè¿›å¼€å‘å’Œä½¿ç”¨åŸºäºç‰©ç† IP çš„å®‰å…¨äº§å“æ¥å£çš„å…¨çƒå¼€æ”¾æ ‡å‡†ã€‚ONVIF
åˆ›å»ºäº†ä¸€ä¸ªè§†é¢‘ç›‘æ§å’Œå…¶ä»–ç‰©ç†å®‰å…¨é¢†åŸŸçš„ IP äº§å“å¦‚ä½•è¿›è¡Œç›¸äº’é€šä¿¡çš„æ ‡å‡†ã€‚ONVIF æ˜¯ç”± Axis Communicationsï¼Œåšä¸–å®‰é˜²ç³»ç»Ÿå’Œç´¢å°¼äº 2008 å¹´åˆ›ç«‹çš„ã€‚

#### **RTSP**

RTSPï¼ˆReal Time Streaming Protocolï¼‰ï¼ŒRFC2326ï¼Œå®æ—¶æµä¼ è¾“åè®®ï¼Œæ˜¯ TCP/IP åè®®ä½“ç³»ä¸­çš„ä¸€ä¸ªåº”ç”¨å±‚åè®®ï¼Œç”±å“¥ä¼¦æ¯”äºšå¤§å­¦ã€ç½‘æ™¯å’Œ RealNetworks å…¬å¸æäº¤çš„
IETF RFC æ ‡å‡†ã€‚è¯¥åè®®å®šä¹‰äº†ä¸€å¯¹å¤šåº”ç”¨ç¨‹åºå¦‚ä½•æœ‰æ•ˆåœ°é€šè¿‡ IP ç½‘ç»œä¼ é€å¤šåª’ä½“æ•°æ®ã€‚

#### **GA/T 1400**

GA/T 1400 ä¸ GB/T 28181 æœ‰å…±æ€§çš„åœ°æ–¹ï¼Œæ¯”å¦‚è®¾å¤‡ç¼–ç è§„èŒƒã€ä¿¡ä»¤äº¤äº’è§„èŒƒç­‰ï¼Œ GB/T28181 å®šä¹‰çš„æ˜¯è§†é¢‘è”ç½‘ï¼ŒGA/TGA/T 1400 å®šä¹‰çš„æ˜¯å›¾ç‰‡ä¼ è¾“ï¼Œåº”ç”¨æœ€å¤šçš„æ˜¯
IPC ä¼ è¾“å›¾ç‰‡åŠç›¸å…³ä¿¡æ¯åˆ°åç«¯è®¾å¤‡ / å¹³å°ï¼Œä»¥åŠè§†å›¾åº“å¹³å°ä¸å¹³å°å¯¹æ¥ç­‰ï¼Œæ¯”å¦‚äººè„¸æŠ“æ‹æœºä¼ è¾“äººè„¸å›¾ç‰‡ã€äººè„¸ç‰¹å¾ç­‰åˆ°äººè„¸åº”ç”¨å¹³å°ï¼Œè½¦è¾†æŠ“æ‹æœºä¼ è¾“è½¦è¾†å›¾ç‰‡ã€è½¦ç‰Œä¿¡æ¯åˆ°è½¦è¾†å¡å£å¹³å°ã€‚

#### **FLV**

FLV æ˜¯ FLASH VIDEO çš„ç®€ç§°ï¼ŒFLV æµåª’ä½“æ ¼å¼æ˜¯éšç€ Flash MX çš„æ¨å‡ºå‘å±•è€Œæ¥çš„è§†é¢‘æ ¼å¼ã€‚ç”±äºå®ƒå½¢æˆçš„æ–‡ä»¶æå°ã€åŠ è½½é€Ÿåº¦æå¿«ï¼Œä½¿å¾—ç½‘ç»œè§‚çœ‹è§†é¢‘æ–‡ä»¶æˆä¸ºå¯èƒ½ï¼Œå®ƒçš„å‡ºç°æœ‰æ•ˆåœ°è§£å†³äº†è§†é¢‘æ–‡ä»¶å¯¼å…¥
Flash åï¼Œä½¿å¯¼å‡ºçš„ SWF æ–‡ä»¶ä½“ç§¯åºå¤§ï¼Œä¸èƒ½åœ¨ç½‘ç»œä¸Šå¾ˆå¥½çš„ä½¿ç”¨ç­‰é—®é¢˜ã€‚

#### **HLS**

HLS (HTTP Live Streaming) æ˜¯ Apple çš„åŠ¨æ€ç ç‡è‡ªé€‚åº”æŠ€æœ¯ã€‚ä¸»è¦ç”¨äº PC å’Œ Apple ç»ˆç«¯çš„éŸ³è§†é¢‘æœåŠ¡ã€‚åŒ…æ‹¬ä¸€ä¸ª m3u (8) çš„ç´¢å¼•æ–‡ä»¶ï¼ŒTS åª’ä½“åˆ†ç‰‡æ–‡ä»¶å’Œ
key åŠ å¯†ä¸²æ–‡ä»¶ã€‚

#### **WebRTC**

WebRTCï¼Œåç§°æºè‡ªç½‘é¡µå³æ—¶é€šä¿¡ï¼ˆè‹±è¯­ï¼šWeb Real-Time Communicationï¼‰çš„ç¼©å†™ï¼Œæ˜¯ä¸€ä¸ªæ”¯æŒç½‘é¡µæµè§ˆå™¨è¿›è¡Œå®æ—¶è¯­éŸ³å¯¹è¯æˆ–è§†é¢‘å¯¹è¯çš„ APIã€‚

#### **IPC**

IPC æ˜¯ç½‘ç»œæ‘„åƒæœºï¼ˆInternet Protocol Cameraï¼‰çš„ç¼©å†™ã€‚

#### **NVR**

NVR æ˜¯ç½‘ç»œç¡¬ç›˜å½•åƒæœºï¼ˆNetwork Video Recorderï¼‰çš„ç¼©å†™ã€‚

#### ICC

ICC æ˜¯å¤§åæ¨å‡ºçš„ä¸€æ¬¾æ™ºèƒ½ç‰©è”ç»¼åˆç®¡ç†å¹³å°, tigong è®¾å¤‡å¯¹æ¥, äººå‘˜å¸ƒæ§, åœè½¦ç®¡ç†, æ¶ˆè´¹ç®¡ç†, åŠ¨ç¯ç®¡ç†åŠ¨ä¼—å¤šåŠŸèƒ½.

#### IVSS

IVSS æ˜¯å¤§åçš„ä¸€æ¬¾ç¡¬ä»¶è®¾å¤‡, å°†äººè„¸ã€äººä½“ã€è½¦è¾†ã€å‘¨ç•Œç­‰ä¼—å¤šâ€œè¾¹ç•Œæ™ºèƒ½â€èåˆä¸€ä½“çš„ä¸€ä½“æœºç³»åˆ—, å…·å¤‡ IPCã€çƒæœºã€DVRã€NVR ç­‰ IP è®¾å¤‡ç®¡ç†, èƒ½å¤Ÿè¿›è¡Œäººè„¸è¯†åˆ«ã€è½¦è¾†è¯†åˆ«ã€äººè„¸æ¯”å¯¹ã€å®æ—¶å¸ƒæ§ç­‰ AI è®¡ç®—.

#### IVS

IVS æ™ºèƒ½ç›‘æ§ç³»ç»Ÿå¯ä»¥æ ¹æ®ç”¨æˆ·çš„éœ€æ±‚ï¼Œåœ¨æŒ‡å®šæ—¶é—´æ®µå†…å¯¹ç›®æ ‡è¿›è¡Œå®æ—¶ç›‘æ§ã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ä»ªè¡¨ç›˜å’Œæ‰‹åŠ¨æ–°å»ºè‡ªå®šä¹‰å‘Šè­¦æ¨¡æ¿ã€‚æ‚¨å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè‡ªå®šä¹‰ç›‘æ§æŒ‡æ ‡ï¼Œç³»ç»Ÿä¼šæŒ‰ç…§è®¾å®šçš„æŒ‡æ ‡æ”¶é›†ä¸šåŠ¡æ•°æ®ã€‚ç³»ç»Ÿè¿˜å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€è¦ï¼Œå¯¹å¼‚å¸¸äº‹ä»¶ã€å‘Šè­¦å’Œäº‹ä»¶è¿›è¡Œåˆ†ç±»ç»Ÿè®¡å’Œå‘Šè­¦ä¸ŠæŠ¥ã€‚

#### **è§†é¢‘æµ**

åœ¨ç½‘ç»œä¸Šï¼Œè§†é¢‘æ•°æ®æŒ‰æ—¶é—´å…ˆåæ¬¡åºä¼ è¾“å’Œæ’­æ”¾çš„è¿ç»­è§†é¢‘æ•°æ®æµã€‚

#### **æ¨æµ**

æ¨æµæ˜¯æŒ‡åˆ©ç”¨æ¨æµå®¢æˆ·ç«¯æˆ–è€…æ¨æµå·¥å…·ï¼Œé€šè¿‡æ¨æµåœ°å€å°† RTMP åè®®çš„è§†é¢‘æµæ¨é€åˆ°å®¢æˆ·ç«¯ã€‚

#### **æ‹‰æµ**

æ‹‰æµæ˜¯æŒ‡é€šè¿‡äº’è”ç½‘ç¯å¢ƒï¼Œå°†è§†é¢‘æµä»æŒ‡å®šå¹³å°æˆ– IP åœ°å€è·å–åˆ°è§†é¢‘è§‚çœ‹å®¢æˆ·ç«¯æˆ–è®¾å¤‡ã€‚

## 3. ä¸šåŠ¡åœºæ™¯

### 3.1 å›ºå®šåœ°ç‚¹

#### 3.1.1 æœ‰çº¿æ¥å…¥

![å›ºå®š+æœ‰çº¿æ¥å…¥.drawio.svg](https://cdn.dong4j.site/source/image/%E5%9B%BA%E5%AE%9A%2B%E6%9C%89%E7%BA%BF%E6%8E%A5%E5%85%A5.drawio.svg)

â€‹ 1. IPC å’Œ NVR åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘, NVR æœ‰ç‹¬ç«‹çš„ Web ç«¯ç”¨äºç®¡ç†è§†é¢‘å’Œå½•åƒ;

â€‹ 2. NVR æä¾› RTSP è§†é¢‘æµ, ä¾›å†…éƒ¨ç³»ç»Ÿå’Œå¤–éƒ¨ç³»ç»Ÿé›†æˆ;

â€‹ 3. å¤–ç½‘å¯é€šè¿‡å…¬ç½‘ IP æˆ– VPN ç»„ç½‘è®¿é—®å†…éƒ¨ NVR;

ä¼ä¸šè‡ªå»ºç½‘ç»œï¼Œæœ¬åœ°ç¯å¢ƒæœ‰è¾ƒå¤šçš„ IPCï¼Œæœ¬åœ°é…ç½® NVR è®¾å¤‡ï¼Œæä¾›æœ¬åœ°çš„è§†é¢‘ç›‘æµ‹ã€‚ç¬¬ä¸‰æ–¹ä¸€èˆ¬ä¸å…è®¸ä»è¿œç«¯è®¿é—®å½“åœ°çš„è§†é¢‘ã€‚

![å›ºå®š+æœ‰çº¿æ¥å…¥2.drawio.svg](https://cdn.dong4j.site/source/image/%E5%9B%BA%E5%AE%9A%2B%E6%9C%89%E7%BA%BF%E6%8E%A5%E5%85%A52.drawio.svg)

é’ˆå¯¹äº **å·¥ä½œç°åœºå›ºå®šä¸”èƒ½å¤Ÿæ–¹ä¾¿å¸ƒçº¿** çš„ç¯å¢ƒ, æ¨èä½¿ç”¨ä¼ ç»Ÿæ–¹å¼ï¼šç”±ç½‘ç»œæ‘„åƒæœº+ç”µæº+ç½‘ç»œç”µç¼† çš„æ–¹æ¡ˆ.

è¿™ç§æ–¹å¼æ˜¯æœ€ç®€å•çš„ä¸€ç§æ–¹æ¡ˆ, ä¸”èƒ½å¤Ÿä¿è¯æµåª’ä½“ä¼ è¾“çš„ç¨³å®šæ€§.

**è§£å†³æ–¹æ¡ˆ**

å› ä¸º IPC å’Œ NVR åœ¨ä¸€ä¸ªå±€åŸŸç½‘å†…, å› æ­¤åªè¦ NVR æ”¯æŒçš„åè®®çš„ IPC éƒ½å¯ä»¥å¯¹æ¥:

1. ç™»å½• IPC ç®¡ç†ç«¯è¿›è¡Œæ‘„åƒå¤´è®¾ç½®;
2. ç™»å½• NVR æ·»åŠ  IPC (åè®®æ¥å…¥å¯æ ¹æ® IPC å‹å·é€‰æ‹©);

NVR è¿˜å¯ä»¥æ›¿æ¢æˆå…·æœ‰ AI è¯†åˆ«çš„å…·æœ‰è§†é¢‘å­˜å‚¨åŠŸèƒ½çš„ç¡¬ä»¶è®¾å¤‡, æ¯”å¦‚ IVSS.

**é’ˆå¯¹äºæœ‰çº¿æ¥å…¥, æœ€é‡è¦çš„ä¸€ç‚¹å°±æ˜¯é€šè¿‡äº¤æ¢æœºå°† IPC å’Œ NVR åˆ’åˆ†åˆ°åŒä¸€ä¸ªå±€åŸŸç½‘å†…, è¿™æ · NVR æ‰èƒ½è¯†åˆ« IPC.**

1. å†…éƒ¨ç³»ç»Ÿç›´æ¥ä» NVR ä¸Šæ‹‰å–è§†é¢‘æµ;
2. å¤–éƒ¨ç³»ç»Ÿéœ€è¦é€šè¿‡ NAT è®¿é—® NVR æ‹‰å–è§†é¢‘æµ;

**å…³é”®ç‚¹:**

> IPC/NVR åœ¨å†…ç½‘, ä¸šåŠ¡ç³»ç»Ÿåœ¨å¤–ç½‘, ä¸”ä¸šåŠ¡ç³»ç»Ÿèƒ½å¤Ÿé€šè¿‡ NAT è®¿é—® IPC æˆ– NVR.

#### 3.1.2 æ— çº¿æ¥å…¥

##### **åœºæ™¯ä¸‰: æ˜†ä»‘å…ˆé”‹å˜ç”µç«™**

é’ˆå¯¹äº **å·¥ä½œç°åœºå›ºå®šä½†æ— æ³•é€šè¿‡æœ‰çº¿å®½å¸¦æ¥å…¥** çš„ç¯å¢ƒ, æ¨èä½¿ç”¨ 4G è·¯ç”±å™¨æ¥å…¥æ–¹æ¡ˆ.

**è§£å†³æ–¹æ¡ˆä¸€:**

![å›ºå®š+æ— çº¿æ¥å…¥1.drawio.svg](https://cdn.dong4j.site/source/image/%E5%9B%BA%E5%AE%9A%2B%E6%97%A0%E7%BA%BF%E6%8E%A5%E5%85%A51.drawio.svg)

1. é’ˆå¯¹äºæ‘„åƒå¤´æ•°é‡è¾ƒå°‘çš„å·¥ä½œåœ°ç‚¹å¯ä»¥ä¸éƒ¨ç½² NVR, ç›´æ¥å°† IPC é€šè¿‡äº¤æ¢æœºå’Œ 4G è·¯ç”±å™¨ä¸€èµ·ç»„å»ºä¸€ä¸ªå±€åŸŸç½‘, å¹¶é€šè¿‡ 4G ä¸Šä¼ è§†é¢‘æµ.

2. å› ä¸º 4G ç‰©è”ç½‘å¡çš„ IP ä¸å›ºå®š, å› æ­¤éœ€è¦ä¸è¿œç«¯çš„ NVR é€šè¿‡ VPN çš„æ–¹å¼ç»„å»ºå±€åŸŸç½‘, NVR æ‰èƒ½æ¥å…¥ IPC.

**å…³é”®åœ°:**

> IPC åœ¨å†…ç½‘, NVR åœ¨å¤–ç½‘, éœ€è¦ç»„å»º VPN ä¸“ç½‘;

**è§£å†³æ–¹æ¡ˆäºŒ:**

![å›ºå®š+æ— çº¿æ¥å…¥2.drawio.svg](https://cdn.dong4j.site/source/image/%E5%9B%BA%E5%AE%9A%2B%E6%97%A0%E7%BA%BF%E6%8E%A5%E5%85%A52.drawio.svg)

1. é’ˆå¯¹æ‘„åƒå¤´æ•°é‡è¾ƒå¤šçš„å·¥ä½œåœ°ç‚¹, å»ºè®®ç›´æ¥åœ¨é¡¹ç›®éƒ¨éƒ¨ç½²è‡³å°‘ä¸€å° NVR, ç”¨äºæœ¬åœ°å­˜å‚¨è§†é¢‘, é¿å…å› ä¸º 4G ç½‘ç»œçš„ä¸ç¨³å®šæ€§å’Œ IPC æ•°é‡è¾ƒå¤šçš„åŸå› é€ æˆè§†é¢‘å»¶è¿Ÿçš„é—®é¢˜;
2. ç½‘ç»œæ‹“æ‰‘å›¾ä¸æ–¹æ¡ˆä¸€ä¸€è‡´, å› ä¸º **4G è·¯ç”±å™¨** æ²¡æœ‰å›ºå®š IP, ä¸ºäº† NVR èƒ½å¤Ÿè¯†åˆ« IPC, åªèƒ½ä½¿ç”¨ VPN ä¸“ç½‘;

**å…³é”®ç‚¹:**

> IPC åœ¨å†…ç½‘, ä¸Šçº§ NVR åœ¨å¤–ç½‘, éœ€è¦ç»„å»º VPN ä¸“ç½‘;

**è§£å†³æ–¹æ¡ˆä¸‰:**

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ 4G NVR ä»£æ›¿ä¼ ç»Ÿçš„ NVR + 4G è·¯ç”±å™¨, å…¶ä»–ä¸æ–¹æ¡ˆäºŒä¸€è‡´.

### 3.2 éå›ºå®šåœ°ç‚¹

é’ˆå¯¹äº **å·¥ä½œç°åœºä¸å›ºå®š** çš„ç§»åŠ¨ä½œä¸šçš„ä¸šåŠ¡åœºæ™¯, ä¸€èˆ¬ä½¿ç”¨ 4G æ‘„åƒå¤´é‡‡é›†è§†é¢‘, å› ä¸º 4G SIM å¡ä¸€èˆ¬æ²¡æœ‰å›ºå®šå…¬ç½‘ IP, æ•…æ— æ³•ç›´æ¥è®¿é—® IPC.

ä¸åŒçš„å‚å•†å¯èƒ½ä¼šæœ‰ä¸åŒçš„å¹³å°ç”¨äºå¯¹æ¥ IPC, æ¯”å¦‚æµ·åº·å¨è§†çš„ **æµ·åº·äº’è” APP**.

**è§£å†³æ–¹æ¡ˆ:**

é€šè¿‡ GB/T28181 å¹³å°ç›´æ¥ç®¡ç† IPC/NVR

![ç§»åŠ¨ä½œä¸š.drawio.svg](https://cdn.dong4j.site/source/image/%E7%A7%BB%E5%8A%A8%E4%BD%9C%E4%B8%9A.drawio.svg)

1. åœ¨ 4G IPC ä¸Šè®¾ç½® GB/T28181 æ¥å…¥å¹³å°ç›¸å…³ä¿¡æ¯, ä¸»åŠ¨å‘å¹³å°æ³¨å†Œè®¾å¤‡ä¿¡æ¯;
2. å¹³å°ç®¡ç†æ¥å…¥çš„ IPC/NVR ç­‰æ”¯æŒ GB/T28181 åè®®çš„è®¾å¤‡;

**å…³é”®ç‚¹:**

> 1. å¾…æ¥å…¥è®¾å¤‡éœ€è¦æ”¯æŒ GB/T28181 åè®®;
> 2. å¾…æ¥å…¥è®¾å¤‡èƒ½è®¿é—®å¹³å°;

#### 3.2.1 ç±»ä¼¼è§£å†³æ–¹æ¡ˆ

ç§»åŠ¨ä½œä¸šçš„ä¸šåŠ¡åœºæ™¯ä¸€èˆ¬é€‰ç”¨å¸¦æœ‰ 4G ç½‘å¡çš„è®¾å¤‡æ¥å…¥å…¬ç½‘, ä¸è¿‡å¸¦æ¥çš„é—®é¢˜å°±æ˜¯ IP ä¸å›ºå®š, è¿™æ ·å°±ä¸èƒ½ç›´æ¥é€šè¿‡è¿œç«¯è¿æ¥åˆ° IPC. ä¸ºäº†è§£å†³è¿™ç±»é—®é¢˜, éœ€è¦ä¸€ç§ä¸»åŠ¨æ³¨å†Œçš„æ–¹æ¡ˆ, å³ 4G IPC è®¾å¤‡ä¸»åŠ¨å‘å¹³å°æ³¨å†Œè®¾å¤‡ä¿¡æ¯, å…¶ä¸­ GB/T28181 åè®®å°±æ˜¯å…¸å‹ä»£è¡¨, å…¶åº•å±‚åŸºäº SIP å’Œ SUP åè®®å®ç°.

ä¸€äº›ç¬¬ä¸‰æ–¹å‚å•†ä¹Ÿä¼šå¼€å‘ç¬¦åˆè‡ªèº«ä¸šåŠ¡éœ€æ±‚çš„å…¶ä»–åè®®, ä¸‹é¢ä»‹ç» 2 ç§æ¯”è¾ƒå¸¸ç”¨çš„ç±»ä¼¼åè®®.

##### 3.2.1.1 Ehome åè®®

EHome åè®®æ˜¯æµ·åº·å¨è§†åŸºäºç§»åŠ¨ç›‘æ§åœºæ™¯ä¸‹å¼€å‘çš„è®¾å¤‡ä¸»åŠ¨æ³¨å†Œç§æœ‰åè®®ï¼Œæ”¯æŒå®æ—¶é¢„è§ˆã€å½•åƒå›æ”¾ã€å¯¹è®²ã€æŠ¥è­¦ã€å®šä½ç­‰åŠŸèƒ½ã€‚

EHome åè®®ä¸ä»…å®ç°äº† GB/T28181 é‡Œæ‰€æœ‰çš„åŠŸèƒ½ï¼Œå¹¶ä¸”åœ¨æµ·åº·çš„ä¸åŒç±»å‹è®¾å¤‡ä¸Šæ”¯æŒäº†å…¶è‡ªå®šä¹‰çš„åœºåˆä¸‹çš„åŠŸèƒ½ç‰¹æ€§ã€‚åŒ…æ‹¬æ™ºèƒ½æŠ¥è­¦ã€åœ¨ä½åŠŸè€—åœºæ™¯ä¸‹çš„è®¾å¤‡æ§åˆ¶åŠå…¬ç½‘ç¯å¢ƒä¸‹çš„è¯­éŸ³å¯¹è®²æŒ‡æŒ¥ç­‰åœºæ™¯éƒ½æ¯” GB/T28181 åè®®æ›´å®Œå–„ã€‚

æµ·åº· EHome åè®®æ¶æ„åŒ…æ‹¬ä¸‰ä¸ªä¸»è¦éƒ¨åˆ†ï¼šç¼–ç å™¨ã€ä¼ è¾“ç½‘ç»œå’Œç›‘æ§ä¸­å¿ƒã€‚

1. ç¼–ç å™¨ï¼šè´Ÿè´£å°†éŸ³è§†é¢‘ä¿¡å·è¿›è¡Œå‹ç¼©ç¼–ç ï¼Œé€šè¿‡ IP ç½‘ç»œå‘é€è‡³ç›‘æ§ä¸­å¿ƒã€‚ç¼–ç å™¨æ”¯æŒå¤šç§åˆ†è¾¨ç‡å’Œç ç‡è°ƒæ•´ï¼Œæ»¡è¶³ä¸åŒåœºæ™¯éœ€æ±‚ã€‚
2. ä¼ è¾“ç½‘ç»œï¼šåŸºäº IP ç½‘ç»œï¼Œæ”¯æŒ TCP/IPã€UDP ç­‰åè®®ï¼Œå®ç°éŸ³è§†é¢‘æ•°æ®çš„ä¼ è¾“ä¸é€šä¿¡ã€‚
3. ç›‘æ§ä¸­å¿ƒï¼šæ¥æ”¶æ¥è‡ªç¼–ç å™¨çš„éŸ³è§†é¢‘æ•°æ®ï¼Œè¿›è¡Œè§£ç ã€æ˜¾ç¤ºåŠå­˜å‚¨ç­‰æ“ä½œã€‚ç›‘æ§ä¸­å¿ƒæ”¯æŒå¤šçº§æ¶æ„ï¼Œæ–¹ä¾¿é›†ä¸­ç®¡ç†å’Œè°ƒåº¦ã€‚

**ç‰¹ç‚¹:**

1. é«˜æ¸…ç”»è´¨ï¼šé‡‡ç”¨å…ˆè¿›çš„éŸ³è§†é¢‘å‹ç¼©ç¼–ç æŠ€æœ¯ï¼Œæä¾›é«˜æ¸…ç”»è´¨ï¼Œè¿˜åŸç°åœºçœŸå®åœºæ™¯ã€‚
2. ä½å»¶è¿Ÿï¼šéŸ³è§†é¢‘ä¼ è¾“å»¶è¿Ÿä½ï¼Œæ»¡è¶³å®æ—¶ç›‘æ§éœ€æ±‚ã€‚
3. åŒå‘é€šä¿¡ï¼šæ”¯æŒç›‘æ§ä¸­å¿ƒä¸ç¼–ç å™¨ä¹‹é—´çš„åŒå‘é€šä¿¡ï¼Œå®ç°è¿œç¨‹æ§åˆ¶åŠæŠ¥è­¦é€šçŸ¥ç­‰åŠŸèƒ½ã€‚
4. ç¨³å®šæ€§ï¼šå…·å¤‡è¾ƒé«˜çš„ç¨³å®šæ€§å’ŒæŠ—å¹²æ‰°èƒ½åŠ›ï¼Œä¿è¯é•¿æ—¶é—´ç¨³å®šè¿è¡Œã€‚
5. å®‰å…¨æ€§ï¼šé‡‡ç”¨åŠ å¯†ä¼ è¾“å’Œè®¤è¯æˆæƒæœºåˆ¶ï¼Œç¡®ä¿æ•°æ®å®‰å…¨å’Œéšç§ä¿æŠ¤ã€‚

##### 3.2.1.2 è¤çŸ³åè®®

è¤çŸ³åè®®æ˜¯è¤çŸ³äº‘å¼€å‘çš„ä¸€ç§è®¾å¤‡ä¸»åŠ¨æ³¨å†Œçš„ç§æœ‰åè®®, ç±»ä¼¼äºå›½æ ‡åè®®å’Œ Ehome åè®®, å¦‚æœè®¾å¤‡åŒæ—¶æ”¯æŒè¤çŸ³åè®®å’Œ Ehome åè®®, åªèƒ½äºŒé€‰ä¸€.

##### 3.2.1.3 DAHUA åè®®

å¤§åä¸»åŠ¨æ³¨å†Œåè®®æ˜¯ç±»ä¼¼æµ·åº· E-homeã€ISUP åè®®ï¼Œä¹Ÿæ˜¯å‰ç«¯è®¾å¤‡å‘ä¸­å¿ƒå¹³å°å’ŒæœåŠ¡æ³¨å†Œçš„ä¸€ç§ä¸»åŠ¨æ³¨å†Œåè®®ï¼Œå¯¹äºå‰ç«¯ç½‘ç»œæ— å›ºå®š IP æƒ…å†µä¸‹å¯¹è§†é¢‘çš„è”ç½‘ã€è§†é¢‘ä¸Šäº‘ç­‰åœºæ™¯åº”ç”¨å°¤ä¸ºé€‚ç”¨ã€‚

##### 3.2.1.5 JTT1078

JT/1078 å³<**é“è·¯è¿è¾“è½¦è¾†å«æ˜Ÿå®šä½ç³»ç»Ÿ-è§†é¢‘é€šä¿¡åè®®**>ï¼Œäº 2016 å¹´å‘å¸ƒï¼Œç»è¿‡å‡ å¹´çš„æ²‰æ·€ï¼Œé€æ¸åº”ç”¨äºé“è·¯ä¸¤å®¢ä¸€å±ã€ä¸­é«˜ç«¯å®šåˆ¶åŒ–è´§è¿ã€å‡ºç§Ÿè½¦è¿è¾“ç­‰è¡Œä¸šã€‚

##### 3.2.1.4 SDK

æµ·åº·, å¤§å, å®‡è§†, ä¹æ©™ç­‰å‚å•†çš„ SDK éƒ½å¯ä»¥å®Œæˆ shebeui åœ¨äº’åŠ¨æ³¨å†Œé€»è¾‘, éœ€è¦è¿›è¡ŒäºŒæ¬¡å¼€å‘.

> ä»¥ä¸Šåè®®éƒ½èƒ½å¤Ÿè§£å†³è®¾å¤‡æ— å›ºå®š IP å¸¦æ¥çš„é—®é¢˜, ä½†æ˜¯é™¤äº† GB/T28181 åè®®å¤–, å…¶ä»–éƒ½æ˜¯å‚å•†çš„ç§æœ‰åè®®, è™½ç„¶åœ¨æ€§èƒ½ä¸Šä¼˜äº GB/T28181 åè®®, ä½†æ˜¯éœ€è¦ç‰¹å®šçš„è®¾å¤‡æ”¯æŒ, è€Œ GB/T28181 åè®® å¹¿æ³›è¢«å„å¤§å‚å•†è®¾å¤‡æ”¯æŒ, å› æ­¤é€‰æ‹©ä½¿ç”¨ **GB/T28181 åè®®** æ¥å…¥ç›‘æ§è®¾å¤‡.

## 4. è§†é¢‘æ¥å…¥å¹³å°

### 4.1 ä¸ºä»€ä¹ˆéœ€è¦ä¸€ä¸ªè§†é¢‘æ¥å…¥å¹³å°

åœ¨æ²¡æœ‰è§†å±æ¥å…¥å¹³å°ä¹‹å‰, æ¯ä¸ªé¡¹ç›®éƒ½ä¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰è´­ä¸åŒå‚å•†çš„ IPC/NVR, æµåª’ä½“æœåŠ¡å™¨, AI è¯†åˆ«æœåŠ¡å™¨ç­‰, æ¯ä¸ªé¡¹ç›®éƒ½éœ€è¦ç»å†ä¸€æ¬¡è§†é¢‘å¯¹æ¥çš„æµç¨‹, å¦‚æœæœ‰äº†è§†é¢‘æ¥å…¥å¹³å°:

![xxx.drawio.svg](https://cdn.dong4j.site/source/image/xxx.drawio.svg)

1. æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰è´­æ”¯æŒ GB/T28181 åè®®çš„ IPC/ NVR, åœ¨å±€åŸŸç½‘å†…å¯ä»¥ä½¿ç”¨åŒæ–¹æ”¯æŒçš„ä»»æ„åè®®å®Œæˆé…ç½‘ä¸å¯¹æ¥, æ¯”å¦‚ IPC é€šè¿‡å±€åŸŸç½‘æ¥å…¥åˆ° NVR/ICC/IVSS;
2. å°† NVR/IVSS ç­‰æ”¯æŒ GB/T28181 åè®®ä¸”èƒ½ç®¡ç†å¤šå° IPC çš„è®¾å¤‡æˆ–å°† IPC ç›´æ¥æ¥å…¥ **GB/T28181 è§†é¢‘æ¥å…¥å¹³å°**;
3. ç»Ÿä¸€åœ¨ **GB/T28181 è§†é¢‘æ¥å…¥å¹³å°** ç®¡ç†å„ç§ IPC/NVR ç­‰è®¾å¤‡, ä¸ºä¸Šå±‚ä¸šåŠ¡ç³»ç»Ÿæä¾›ç‚¹æ’­, å½•åƒæŸ¥çœ‹, è§†é¢‘åˆ†å±å±•ç¤ºç­‰å¸¸è§„åŠŸèƒ½;

è¿™é‡Œçš„ **GB/T28181 è§†é¢‘æ¥å…¥å¹³å°** ç›¸å½“ä¸ä¸€ä¸ªä¸­ä»‹, ä¸šåŠ¡ç³»ç»Ÿä¸å†éœ€è¦ä¸å„ä¸ªè®¾å¤‡å‚å•†å¯¹æ¥ç§æœ‰çš„è§†é¢‘æ¥å…¥åè®®, è€Œå®æ–½å›¢é˜Ÿåªéœ€è¦å°† IPC/NVR ç­‰è®¾å¤‡è¿›è¡Œæ­£ç¡®çš„ç»„ç½‘å³å¯, è¿™æ ·èƒ½å¤Ÿå¤§å¤§ç¼©çŸ­é¡¹ç›®ä¸Šçº¿æ—¶é—´.

> ç®€è€Œè¨€ä¹‹, è§†é¢‘æ¥å…¥å¹³å°å¯¹ä¸‹èƒ½æœ‰æ•ˆå±è”½ä¸åŒå‚å•†ä¸åŒåè®®æ¥å…¥å¸¦æ¥çš„å¤æ‚æ€§, å¯¹ä¸Šèƒ½å¤Ÿå…¼å®¹å„ç§è§†é¢‘æŸ¥çœ‹éœ€æ±‚, å‡å°‘é‡å¤å¼€å‘æˆæœ¬, ä¾¿äºåœ¨ä¸€å¤„ç»Ÿä¸€ç®¡ç†è§†é¢‘è®¾å¤‡, ä»è€ŒåŠ å¿«é¡¹ç›®è¿›åº¦.

### 4.2 ä»€ä¹ˆæ˜¯ GB/T28181 å¹³å°

> GB/T28181 åè®®æŒ‡çš„æ˜¯å›½å®¶æ ‡å‡† GB/T 28181â€”2016ã€Šå…¬å…±å®‰å…¨è§†é¢‘ç›‘æ§è”ç½‘ç³»ç»Ÿä¿¡æ¯ä¼ è¾“ã€äº¤æ¢ã€æ§åˆ¶æŠ€æœ¯è¦æ±‚ã€‹1ï¼Œè¯¥æ ‡å‡†è§„å®šäº†å…¬å…±å®‰å…¨è§†é¢‘ç›‘æ§è”ç½‘ç³»ç»Ÿçš„äº’è”ç»“æ„ï¼Œ ä¼ è¾“ã€äº¤æ¢ã€æ§åˆ¶çš„åŸºæœ¬è¦æ±‚å’Œå®‰å…¨æ€§è¦æ±‚ï¼Œ ä»¥åŠæ§åˆ¶ã€ä¼ è¾“æµç¨‹å’Œåè®®æ¥å£ç­‰æŠ€æœ¯è¦æ±‚ï¼Œæ˜¯è§†é¢‘ç›‘æ§é¢†åŸŸçš„å›½å®¶æ ‡å‡†ã€‚GB/T28181 åè®®ä¿¡ä»¤å±‚é¢ä½¿ç”¨çš„æ˜¯ SIPï¼ˆSession Initiation Protocolï¼‰åè®® 2ï¼Œæµåª’ä½“ä¼ è¾“å±‚é¢ä½¿ç”¨çš„æ˜¯å®æ—¶ä¼ è¾“åè®®ï¼ˆReal-time Transport Protocolï¼ŒRTPï¼‰åè®® 3ï¼Œå› æ­¤å¯ä»¥ç†è§£ä¸º GB/T28181 æ˜¯åœ¨å›½é™…é€šç”¨æ ‡å‡†çš„åŸºç¡€ä¹‹ä¸Šè¿›è¡Œäº†ç§æœ‰åŒ–å®šåˆ¶ä»¥æ»¡è¶³è§†é¢‘ç›‘æ§è”ç½‘ç³»ç»Ÿäº’è”ä¼ è¾“çš„æ ‡å‡†åŒ–éœ€æ±‚ã€‚æœ¬æ–‡æ—¨åœ¨è¯´æ˜åœ¨ FFmpeg ä¸­å¢åŠ å¯¹ GB/T28181 åè®®çš„æ”¯æŒï¼Œä½¿å…¶å¯ä»¥ä¸æ”¯æŒ GB/T28181 åè®®çš„è®¾å¤‡è¿›è¡Œé€šä¿¡ä¸æ§åˆ¶ï¼Œå®ç°è®¾å¤‡çš„æ³¨å†Œã€ä¿æ´»ä»¥åŠæµåª’ä½“çš„ä¼ è¾“ã€‚

å› ä¸ºæ˜¯å›½å®¶æ ‡å‡†åè®®, ç›®å‰å¸‚é¢ä¸Šå¤§å¤šæ•°è§†é¢‘è®¾å¤‡éƒ½å·²æ”¯æŒ GB/T28181 åè®®, æ¯”å¦‚å¤§å, æµ·åº·ç­‰ä¸»æµçš„ç›‘æ§å‚å•†.

ä¸€ä¸ªå®Œæ•´çš„ GB/T28181 å¹³å°ï¼Œé€šå¸¸ç”±**ç®¡ç†å¹³å°ã€ä¿¡ä»¤æœåŠ¡å™¨ã€æµåª’ä½“æœåŠ¡å™¨ã€ç›‘æ§è®¾å¤‡ï¼ˆIPCã€NVRï¼‰ã€ç®¡ç†ç»ˆç«¯**ç­‰å‡ éƒ¨åˆ†ç»„æˆ:

![yyy.drawio.svg](https://cdn.dong4j.site/source/image/yyy.drawio.svg)

1. **ä¿¡ä»¤æœåŠ¡å™¨** æ˜¯ä¸ç½‘ç»œä¸­ **ç›‘æ§è®¾å¤‡** ä¸ **ç®¡ç†ç»ˆç«¯** ä¹‹é—´è¿›è¡Œé€šä¿¡çš„ä»£ç†ï¼Œä¹Ÿæ˜¯å„çº§ç³»ç»Ÿä¹‹é—´çš„ä»£ç†ï¼Œ**ä¿¡ä»¤æœåŠ¡å™¨** è¦æœ‰å›ºå®šçš„ IP åœ°å€æˆ–åŸŸåï¼Œå¦‚æœè¦é¢å‘å…¬ç½‘æœåŠ¡ï¼Œè¿˜éœ€è¦æœ‰å…¬ç½‘ IPã€‚ç”±äºæ˜¯ **ç›‘æ§è®¾å¤‡** ä¸»åŠ¨å‘ä¿¡ä»¤æœåŠ¡å™¨æ³¨å†Œï¼Œæ‰€ä»¥ **ç›‘æ§è®¾å¤‡** ä¸éœ€è¦æœ‰å›ºå®šçš„ IPã€‚**ç›‘æ§è®¾å¤‡** æ³¨å†Œåˆ°ä¿¡ä»¤æœåŠ¡å™¨ä¸Šä¹‹åï¼Œç®¡ç†è€…é€šè¿‡å‘ä¿¡ä»¤æœåŠ¡å™¨å‘é€æŒ‡ä»¤æ¥ç®¡ç† **ç›‘æ§è®¾å¤‡**ã€‚
2. **æµåª’ä½“æœåŠ¡å™¨** æ˜¯è§†é¢‘ä¼ è¾“çš„ä»£ç†ï¼Œè¯¥ç³»ç»Ÿæ¥å—ç›‘æ§è®¾å¤‡å‘é€çš„è§†é¢‘æµï¼Œå‘è§†é¢‘è°ƒå–æ–¹è½¬å‘è§†é¢‘ã€‚è§†é¢‘è°ƒå–æ–¹å¯ä»¥æ˜¯ç›‘æ§ç›‘æ§è§†é¢‘çš„ç”¨æˆ·ã€ç¬¬ä¸‰æ–¹ä¸šåŠ¡ç³»ç»Ÿæˆ–è€…æ˜¯ä¸Šä¸‹çº§å¹³å°ã€‚åè®®è§„å®šç›‘æ§è®¾å¤‡é€šè¿‡ rtp åè®®å‘æµåª’ä½“æœåŠ¡å™¨å‘é€è§†é¢‘æµï¼Œä½†æ˜¯æ²¡æœ‰çº¦å®šæµåª’ä½“æœåŠ¡å™¨å‘å…¶ä»–æ–¹è½¬å‘è§†é¢‘çš„åè®®ï¼Œå› æ­¤åœ¨è§†é¢‘è½¬å‘æ—¶å…·æœ‰æ›´å¤§çš„çµæ´»æ€§ï¼Œå¯ä»¥æ ¹æ®éœ€è¦é‡‡ç”¨åˆé€‚çš„åè®®è½¬å‘è§†é¢‘ã€‚

å›½æ ‡ GB/T28181 æ¥å…¥æœåŠ¡åŒ…å«è®¾å¤‡ç®¡ç†ï¼Œè§†é¢‘æµåè®®è½¬æ¢ï¼Œç›´æ’­ç›‘æ§ï¼Œå½•åƒå›æ”¾ç­‰ã€‚

|    åŠŸèƒ½åç§°    |                                                          åŠŸèƒ½æè¿°                                                           |
| :------------: | :-------------------------------------------------------------------------------------------------------------------------: |
|    è®¾å¤‡ç®¡ç†    |                              æ”¯æŒå¸¸è§è®¾å¤‡å“ç‰Œæ¥å…¥åˆ°è¤çŸ³å¼€æ”¾å¹³å°è¿›è¡Œè®¾å¤‡çš„ç»Ÿä¸€ç®¡ç†ï¼Œè¿œç¨‹æ§åˆ¶ã€‚                               |
| è§†é¢‘æµåè®®è½¬æ¢ |                          æ”¯æŒå°† GB/T28181 è§†é¢‘åè®®è½¬æ¢ä¸º RTMPã€FLVã€HLSã€EZopen åè®®ï¼Œå¹¶è¿›è¡Œåˆ†å‘ã€‚                          |
|    ç›´æ’­ç›‘æ§    |        æ”¯æŒä¸»æµç›´æ’­æ ‡å‡†åè®® HLSã€RTMPã€ FLV ä»¥åŠ EZopen åè®®ï¼Œè½»æ¾è¦†ç›–å„ç§åº”ç”¨ç«¯ï¼šAndroidã€iOSã€å°ç¨‹åºã€PCã€Web ç­‰ã€‚        |
|    å½•åƒå›æ”¾    |                    æ”¯æŒå¤šè·¯è§†é¢‘åŒæ—¶å›æ”¾ã€å€é€Ÿå›è®¿ã€è¿›åº¦æ¡æ§åˆ¶ã€äº‘ç«¯å½•åˆ¶ç­‰åŠŸèƒ½ï¼Œå®¢æˆ·å¯æŒ‰éœ€å®ç°å›æ”¾æ§åˆ¶ã€‚                     |
| å¯¹è®²ä¸è®¾å¤‡æ§åˆ¶ | å¯ä»¥é€šè¿‡è°ƒç”¨è¯­éŸ³å¯¹è®²åŠŸèƒ½çš„ API å®ç°è¯­éŸ³å¯¹è®²åŠŸèƒ½ï¼›åŒæ—¶æ”¯æŒäº‘å°æ§åˆ¶ç›¸å…³è®¾å¤‡æ§åˆ¶åŠŸèƒ½ã€‚æ»¡è¶³å¤šé¡¹è®¾å¤‡äº¤äº’éœ€æ±‚ï¼Œé€‚ç”¨æ›´å¤šåœºæ™¯éœ€æ±‚ã€‚ |
|    æ¶ˆæ¯æ¨é€    |                            æ”¯æŒè·å–åŒ…æ‹¬è®¾å¤‡æŠ¥è­¦ã€è§†é¢‘æŠ¥è­¦ã€è®¾å¤‡æ•…éšœæŠ¥è­¦ç­‰ç±»å‹çš„è®¾å¤‡ç«¯äº‹ä»¶ä¸ŠæŠ¥ã€‚                             |
| å­˜å‚¨ä¸åª’ä½“å¤„ç† |  åœ¨å›½æ ‡åè®®åŸºç¡€ä¸Šï¼Œæ”¯æŒè®¾å¤‡æŠ½å¸§ï¼Œè·å–é‡ç‚¹å›¾ç‰‡æ•°æ®è¿›è¡Œå­˜å‚¨ã€‚å¹¶æ”¯æŒäº‘ç«¯è§†é¢‘ç”»é¢å½•åˆ¶ä¸å­˜å‚¨ï¼Œä¿å­˜ä¸šåŠ¡åœºæ™¯ä¸­çš„é‡ç‚¹éŸ³è§†é¢‘æ•°æ®ã€‚   |

### 4.3 æ•´ä½“æµç¨‹

![zzz.drawio.svg](https://cdn.dong4j.site/source/image/zzz.drawio.svg)

1. IPC/NVR æœ¬åœ°é…ç½® SIP ç›¸å…³ä¿¡æ¯, ç„¶åå®šæ—¶å‘ SIP ä¿¡æ¯æœåŠ¡å™¨æ³¨å†Œå½“å‰çš„è®¾å¤‡ä¿¡æ¯, æ¯”å¦‚ IP, è®¾å¤‡ ID, è®¾å¤‡ç±»å‹ç­‰;
2. SIP ä¿¡ä»¤æœåŠ¡å™¨ä¼šé€šè¿‡ç®¡ç†å¹³å°è®¾ç½®çš„ç›¸å…³ä¿¡æ¯è¿›è¡Œè®¾å¤‡éªŒè¯, æ¯”å¦‚ SIP ç¼–å·, å¯†ç æ˜¯å¦æ­£ç¡®ç­‰;
3. è®¾å¤‡æ³¨å†ŒæˆåŠŸåå°†ä¼šå±•ç¤ºåœ¨ç®¡ç†å¹³å°ä¸­, å¯é€šè¿‡æ­¤å¹³å°ç»´æŠ¤è®¾å¤‡çš„é€šé“, åœ°ç†ä½ç½®, å½•åƒæ–‡ä»¶, è®¾å¤‡åˆ†ç»„, è§†é¢‘å¢™å’Œæµåª’ä½“æœåŠ¡å™¨èŠ‚ç‚¹ç­‰ä¿¡æ¯;
4. ç»ˆç«¯è®¾å¤‡éœ€è¦æŸ¥çœ‹å®æ—¶è§†é¢‘æ—¶, ç®¡ç†å¹³å°ä¼šé€šè¿‡æµåª’ä½“æœåŠ¡å™¨ä¸‹å‘æ‹‰æµåŠ¨ä½œ, æµåª’ä½“æœåŠ¡å™¨å‘è®¾å¤‡å‘é€æ‹‰æµè¯·æ±‚å, è®¾å¤‡ä½¿ç”¨ RTP åè®®å‘æµåª’ä½“æœåŠ¡å™¨æ¨æµ;
5. æµåª’ä½“æœåŠ¡å™¨åœ¨æ¥æ”¶åˆ° RTP è§†é¢‘æµå, æ ¹æ®ç®¡ç†ç»ˆç«¯çš„éœ€è¦å¯ä»¥è½¬æ¢æˆä¸åŒçš„è§†é¢‘æµè¾“å‡º, æ¯”å¦‚ FLV, MP4, HLS, TS, RTC ,RTMP, RTSP ç­‰, å› æ­¤å¯ä»¥æ»¡è¶³ç»å¤§å¤šæ•°çš„ä¸šåŠ¡åœºæ™¯;
6. GB/T28181 è§„å®š SIP åº”è¯¥åŒ…å«æ§åˆ¶ä¿¡å·å’Œè§†é¢‘ä¿¡å·, æ§åˆ¶ä¿¡å·ç”¨äºæ§åˆ¶çƒæœºçš„ç§»åŠ¨, å› æ­¤åªè¦æ˜¯æ”¯æŒ GB/T28181 çš„è®¾å¤‡, ä¸å†éœ€è¦å•ç‹¬å¯¹æ¥å‚å•†çš„ SDK å»æ§åˆ¶è®¾å¤‡;
7. SIP ä¿¡ä»¤æœåŠ¡å™¨è¿˜èƒ½å¤Ÿå°†è®¾å¤‡çš„æ¶ˆæ¯æ¨é€åˆ°ç®¡ç†å¹³å°, æ¯”å¦‚ç¦»çº¿, è®¾å¤‡ç›‘æµ‹åˆ°åŠ¨ä½œ, è®¾å¤‡ä¸Šçº¿ç­‰, è€Œç®¡ç†å¹³å°å¯ä»¥æ ¹æ®è¿™äº›æ¶ˆæ¯è¿›è¡Œè‡ªå®šä¹‰ä¸šåŠ¡å¤„ç†;

## 5. æµåª’ä½“æœåŠ¡é€‰å‹

### 5.1 ZLMediaKit

https://docs.zlmediakit.com/zh/

![20241229154732_Eg8Am302.webp](https://cdn.dong4j.site/source/image/20241229154732_Eg8Am302.webp)

**ZLMediaKit** æ˜¯ä¸€å¥—é«˜æ€§èƒ½çš„æµåª’ä½“æœåŠ¡æ¡†æ¶ï¼Œç›®å‰æ”¯æŒ rtmpã€rtspã€hlsã€http-flv ç­‰æµåª’ä½“åè®®ï¼Œæ”¯æŒ linuxã€macosã€windows ä¸‰å¤§ PC å¹³å°å’Œ iosã€android ä¸¤å¤§ç§»åŠ¨ç«¯å¹³å°ã€‚

**ä¸»è¦åŠŸèƒ½:**

1. åŸºäº C++11 å¼€å‘ï¼Œé¿å…ä½¿ç”¨è£¸æŒ‡é’ˆï¼Œä»£ç ç¨³å®šå¯é ï¼Œæ€§èƒ½ä¼˜è¶Šã€‚
2. æ”¯æŒå¤šç§åè®®(RTSP/RTMP/HLS/HTTP-FLV/WebSocket-FLV/GB28181/HTTP-TS/WebSocket-TS/HTTP-fMP4/WebSocket-fMP4/MP4),æ”¯æŒåè®®äº’è½¬ã€‚
3. ä½¿ç”¨å¤šè·¯å¤ç”¨/å¤šçº¿ç¨‹/å¼‚æ­¥ç½‘ç»œ IO æ¨¡å¼å¼€å‘ï¼Œå¹¶å‘æ€§èƒ½ä¼˜è¶Šï¼Œæ”¯æŒæµ·é‡å®¢æˆ·ç«¯è¿æ¥ã€‚
4. ä»£ç ç»è¿‡é•¿æœŸå¤§é‡çš„ç¨³å®šæ€§ã€æ€§èƒ½æµ‹è¯•ï¼Œå·²ç»åœ¨çº¿ä¸Šå•†ç”¨éªŒè¯å·²ä¹…ã€‚
5. æ”¯æŒ linuxã€macosã€iosã€androidã€windows å…¨å¹³å°ã€‚
6. æ”¯æŒç”»é¢ç§’å¼€ã€æä½å»¶æ—¶(500 æ¯«ç§’å†…ï¼Œæœ€ä½å¯è¾¾ 100 æ¯«ç§’)ã€‚
7. æä¾›å®Œå–„çš„æ ‡å‡† C API,å¯ä»¥ä½œ SDK ç”¨ï¼Œæˆ–ä¾›å…¶ä»–è¯­è¨€è°ƒç”¨ã€‚
8. æä¾›å®Œæ•´çš„ MediaServer æœåŠ¡å™¨ï¼Œå¯ä»¥å…å¼€å‘ç›´æ¥éƒ¨ç½²ä¸ºå•†ç”¨æœåŠ¡å™¨ã€‚
9. æä¾›å®Œå–„çš„ restful api ä»¥åŠ web hookï¼Œæ”¯æŒä¸°å¯Œçš„ä¸šåŠ¡é€»è¾‘ã€‚
10. æ‰“é€šäº†è§†é¢‘ç›‘æ§åè®®æ ˆä¸ç›´æ’­åè®®æ ˆï¼Œå¯¹ RTSP/RTMP æ”¯æŒéƒ½å¾ˆå®Œå–„ã€‚
11. å…¨é¢æ”¯æŒ H265/H264/AAC/G711/OPUSã€‚

> æ€»ç»“: åŒæ—¶æ”¯æŒ rtsp/rtmp æ¨æ‹‰æµï¼Œè€Œä¸”æ”¯æŒ h265 çš„æ¨æ‹‰æµï¼ˆæ¨æµç«¯è¦æ”¯æŒ 265 çš„ ffmpeg/æ‹‰æµæ’­æ”¾ç«¯ä¹Ÿè¦æ”¯æŒ 265 çš„æ’­æ”¾å™¨ï¼‰ï¼Œæ”¯æŒå„ç§æ ¼å¼æ‹‰æµï¼Œä½¿ç”¨è€…ä¼—å¤š

### 5.2 Monibuca

https://m7s.live/#ui

![20241229154732_HaiZHt44.webp](https://cdn.dong4j.site/source/image/20241229154732_HaiZHt44.webp)

Monibuca æ˜¯ä¸€ä¸ªå¼€æºçš„æµåª’ä½“æœåŠ¡å™¨å¼€å‘æ¡†æ¶ï¼Œé€‚ç”¨äºå¿«é€Ÿå®šåˆ¶åŒ–å¼€å‘æµåª’ä½“æœåŠ¡å™¨ï¼Œå¯ä»¥å¯¹æ¥ CDN å‚å•†ï¼Œä½œä¸ºå›æºæœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥è‡ªå·±æ­å»ºé›†ç¾¤éƒ¨ç½²ç¯å¢ƒã€‚ ä¸°å¯Œçš„å†…ç½®æ’ä»¶æä¾›äº†æµåª’ä½“æœåŠ¡å™¨çš„å¸¸è§åŠŸèƒ½ï¼Œä¾‹å¦‚ rtmp serverã€http-flvã€è§†é¢‘å½•åˆ¶ã€QoS ç­‰ã€‚é™¤æ­¤ä»¥å¤–è¿˜å†…ç½®äº†åå° web ç•Œé¢ï¼Œæ–¹ä¾¿è§‚å¯ŸæœåŠ¡å™¨è¿è¡Œçš„çŠ¶æ€ã€‚ ä¹Ÿå¯ä»¥è‡ªå·±å¼€å‘åå°ç®¡ç†ç•Œé¢ï¼Œé€šè¿‡ api æ–¹å¼è·å–æœåŠ¡å™¨çš„è¿è¡Œä¿¡æ¯ã€‚ Monibuca æä¾›äº†å¯ä¾›å®šåˆ¶åŒ–å¼€å‘çš„æ’ä»¶æœºåˆ¶ï¼Œå¯ä»¥ä»»æ„æ‰©å±•å…¶åŠŸèƒ½ã€‚

![20241229154732_1Z6xq7im.webp](https://cdn.dong4j.site/source/image/20241229154732_1Z6xq7im.webp)

**ä¸»è¦åŠŸèƒ½:**

1. é’ˆå¯¹æµåª’ä½“æœåŠ¡å™¨ç‹¬ç‰¹çš„æ€§è´¨è¿›è¡Œçš„ä¼˜åŒ–ï¼Œå……åˆ†åˆ©ç”¨ Golang çš„ goroutine çš„æ€§è´¨å¯¹å¤§é‡çš„è¿æ¥çš„è¯»å†™è¿›è¡Œåˆç†çš„åˆ†é…è®¡ç®—èµ„æºï¼Œä»¥åŠå°½å¯èƒ½çš„å‡å°‘å†…å­˜ Copy æ“ä½œã€‚ä½¿ç”¨å¯¹è±¡æ± å‡å°‘ Golang çš„ GC æ—¶é—´ã€‚
2. ä¸“ä¸ºäºŒæ¬¡å¼€å‘è€Œè®¾è®¡ï¼ŒåŸºäº Golang è¯­è¨€ï¼Œå¼€å‘æ•ˆç‡æ›´é«˜ï¼›ç‹¬åˆ›çš„æ’ä»¶æœºåˆ¶ï¼Œå¯ä»¥æ–¹ä¾¿ç”¨æˆ·å®šåˆ¶ä¸ªæ€§åŒ–çš„åŠŸèƒ½ç»„åˆï¼Œæ›´é«˜æ•ˆç‡çš„åˆ©ç”¨æœåŠ¡å™¨èµ„æºã€‚
3. åŠŸèƒ½å¼ºå¤§çš„ä»ªè¡¨ç›˜å¯ä»¥ç›´è§‚çš„çœ‹åˆ°æœåŠ¡å™¨è¿è¡Œçš„çŠ¶æ€ã€æ¶ˆè€—çš„èµ„æºã€ä»¥åŠå…¶ä»–ç»Ÿè®¡ä¿¡æ¯ã€‚ç”¨æˆ·å¯ä»¥åˆ©ç”¨æ§åˆ¶å°å¯¹æœåŠ¡å™¨è¿›è¡Œé…ç½®å’Œæ§åˆ¶ã€‚ç‚¹å‡»å³ä¸Šè§’èœå•æ é‡Œé¢çš„æ¼”ç¤ºï¼Œå¯ä»¥çœ‹åˆ°æ¼”ç¤ºæ§åˆ¶å°ç•Œé¢ã€‚
4. çº¯ Go ç¼–å†™ï¼Œä¸ä¾èµ– cgoï¼Œä¸ä¾èµ– FFMpeg æˆ–è€…å…¶ä»–è¿è¡Œæ—¶ï¼Œéƒ¨ç½²æå…¶æ–¹ä¾¿ï¼Œå¯¹æœåŠ¡å™¨çš„è¦æ±‚æä¸ºå®½æ¾ã€‚

> æ€»ç»“: æ”¯æŒè‡ªå®šä¹‰æ’ä»¶, æ‰©å±•æ–°åŠŸèƒ½éå¸¸æ–¹ä¾¿, ç¼ºç‚¹å°±æ˜¯éƒ¨åˆ†æ’ä»¶æ”¶è´¹.

### 5.3 SRS

https://ossrs.net/lts/zh-cn/

![20241229154732_Ne0IQhYm.webp](https://cdn.dong4j.site/source/image/20241229154732_Ne0IQhYm.webp)

SRS(Simple Realtime Server)æ˜¯ä¸€ä¸ªç®€å•é«˜æ•ˆçš„å®æ—¶è§†é¢‘æœåŠ¡å™¨ï¼Œæ”¯æŒ RTMPã€WebRTCã€HLSã€HTTP-FLVã€SRT ç­‰å¤šç§å®æ—¶æµåª’ä½“åè®®ã€‚

SRS ä½œä¸ºå½“å‰éå¸¸æ™®éçš„è¿è¥çº§è§£å†³æ–¹æ¡ˆï¼Œå…·å¤‡éå¸¸å…¨é¢çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬é›†ç¾¤ã€åè®®ç½‘å…³ã€CDN åŠŸèƒ½ç­‰ï¼Œä¸»è¦åŠŸèƒ½å¦‚ä¸‹ï¼š

1. SRS å®šä½æ˜¯è¿è¥çº§çš„äº’è”ç½‘ç›´æ’­æœåŠ¡å™¨é›†ç¾¤ï¼Œè¿½æ±‚æ›´å¥½çš„æ¦‚å¿µå®Œæ•´æ€§å’Œæœ€ç®€å•å®ç°çš„ä»£ç ã€‚
2. SRS æä¾›äº†ä¸°å¯Œçš„æ¥å…¥æ–¹æ¡ˆå°† RTMP æµæ¥å…¥ SRSï¼Œ åŒ…æ‹¬æ¨é€ RTMP åˆ° SRSã€æ¨é€ RTSP/UDP/FLV åˆ° SRSã€æ‹‰å–æµåˆ° SRSã€‚ SRS è¿˜æ”¯æŒå°†æ¥å…¥çš„ RTMP æµè¿›è¡Œå„ç§å˜æ¢ï¼Œè­¬å¦‚å°† RTMP æµè½¬ç ã€æµæˆªå›¾ã€ è½¬å‘ç»™å…¶ä»–æœåŠ¡å™¨ã€è½¬å°è£…æˆ HTTP-FLV æµã€è½¬å°è£…æˆ HLSã€ è½¬å°è£…æˆ HDSã€è½¬å°è£…æˆ DASHã€å½•åˆ¶æˆ FLV/MP4ã€‚
3. SRS åŒ…å«æ”¯å¤§è§„æ¨¡é›†ç¾¤å¦‚ CDN ä¸šåŠ¡çš„å…³é”®ç‰¹æ€§ï¼Œ è­¬å¦‚ RTMP å¤šçº§é›†ç¾¤ã€æºç«™é›†ç¾¤ã€VHOST è™šæ‹ŸæœåŠ¡å™¨ ã€ æ— ä¸­æ–­æœåŠ¡ Reloadã€HTTP-FLV é›†ç¾¤ã€‚
4. SRS è¿˜æä¾›ä¸°å¯Œçš„åº”ç”¨æ¥å£ï¼Œ åŒ…æ‹¬ HTTP å›è°ƒã€å®‰å…¨ç­–ç•¥ Securityã€HTTP API æ¥å£ã€ RTMP æµ‹é€Ÿã€‚
5. SRS åœ¨æºç«™å’Œ CDN é›†ç¾¤ä¸­éƒ½å¾—åˆ°äº†å¹¿æ³›çš„åº”ç”¨ Applicationsã€‚

> æ€»ç»“: æ”¯æŒ rtmp æ¨æµï¼Œæ—©æœŸç‰ˆæœ¬æ”¯æŒ rtsp æ¨æµï¼Œä¸çŸ¥é“ä¸ºä½•ç§»é™¤äº†ã€‚æ”¯æŒéƒ¨åˆ†æ ¼å¼æ‹‰æµï¼Œä¸æ”¯æŒ ws-flv æ‹‰æµï¼Œä½¿ç”¨è€…ä¼—å¤š

### 5.5 EasyDarwin

https://www.easydarwin.org/

![20241229154732_jMsecsHY.webp](https://cdn.dong4j.site/source/image/20241229154732_jMsecsHY.webp)

**EasyDarwin** æ˜¯ç”±å›½å†…å¼€æºæµåª’ä½“å›¢é˜Ÿç»´æŠ¤å’Œè¿­ä»£çš„ä¸€æ•´å¥—å¼€æºæµåª’ä½“è§†é¢‘å¹³å°æ¡†æ¶ï¼ŒGolang å¼€å‘ï¼Œä» 2012 å¹´ 12 æœˆåˆ›å»ºå¹¶å‘å±•è‡³ä»Šï¼ŒåŒ…å«æœ‰å•ç‚¹æœåŠ¡çš„å¼€æºæµåª’ä½“æœåŠ¡å™¨ï¼Œå’Œæ‰©å±•åçš„æµåª’ä½“äº‘å¹³å°æ¶æ„çš„å¼€æºæ¡†æ¶ï¼Œå¼€è¾Ÿäº†è¯¸å¤šçš„ä¼˜è´¨å¼€æºé¡¹ç›®ï¼Œèƒ½æ›´å¥½åœ°å¸®åŠ©å¹¿å¤§æµåª’ä½“å¼€å‘è€…å’Œåˆ›ä¸šå‹ä¼ä¸šå¿«é€Ÿæ„å»ºæµåª’ä½“æœåŠ¡å¹³å°ï¼Œæ›´å¿«ã€æ›´ç®€å•åœ°å®ç°æœ€æ–°çš„ç§»åŠ¨äº’è”ç½‘(å®‰å“ã€iOSã€H5ã€å¾®ä¿¡)æµåª’ä½“ç›´æ’­ä¸ç‚¹æ’­çš„éœ€æ±‚ï¼Œå°¤å…¶æ˜¯å®‰é˜²è¡Œä¸šä¸äº’è”ç½‘è¡Œä¸šçš„è¡”æ¥ã€‚

**ä¸»è¦åŠŸèƒ½:**

1. åŸºäº Golang è¯­è¨€å¼€å‘ç»´æŠ¤ã€‚
2. æ”¯æŒ Windowsã€Linuxã€macOS ä¸‰å¤§ç³»ç»Ÿå¹³å°éƒ¨ç½²ã€‚
3. æ”¯æŒ RTSP æ¨æµåˆ†å‘ï¼ˆæ¨æ¨¡å¼è½¬å‘ï¼‰ã€‚
4. æ”¯æŒ RTSP æ‹‰æµåˆ†å‘ï¼ˆæ‹‰æ¨¡å¼è½¬å‘ï¼‰ã€‚
5. æœåŠ¡ç«¯å½•åƒã€æ£€ç´¢ã€å›æ”¾ã€‚
6. æ”¯æŒå…³é”®å¸§ç¼“å­˜ã€ç§’å¼€ç”»é¢ã€‚
7. Web åå°ç®¡ç†ã€‚
8. åˆ†å¸ƒå¼è´Ÿè½½å‡è¡¡ã€‚

> æ€»ç»“: åªæ”¯æŒ rtsp æ¨æ‹‰æµï¼Œé»˜è®¤ç«¯å£ 5541ï¼Œä¸æ”¯æŒå…¶ä»–æ ¼å¼æ‹‰æµï¼Œå¦‚æœä»…ä»…æ˜¯ç›‘æ§æ‘„åƒå¤´ä½¿ç”¨ï¼Œéå¸¸æ–¹ä¾¿ï¼Œæœ‰ä¸ªç½‘é¡µç®¡ç†åå°ï¼Œä¸ä¼šè¿‡æœŸå¯ä»¥ä¸€ç›´ç”¨ï¼Œç¼ºç‚¹æ˜¯åŠŸèƒ½å•ä¸€ï¼Œåªèƒ½åœ¨ä»–çš„åå°æŸ¥çœ‹è§†é¢‘æµï¼Œæˆ–è€…ç”¨æ’­æ”¾å™¨æ’­æ”¾.

**ä¸Šè¿° 4 ç§æµåª’ä½“æœåŠ¡å¯¹æ¯”:**

![20241229154732_ZYApFZks.webp](https://cdn.dong4j.site/source/image/20241229154732_ZYApFZks.webp)

### 5.6 MediaMTX

https://github.com/bluenviron/mediamtx

_MediaMTX_ï¼ˆä»¥å‰ç§°ä¸º*rtsp-simple-server*ï¼‰æ˜¯ä¸€ä¸ªå³ç”¨å‹ã€é›¶ä¾èµ–çš„å®æ—¶åª’ä½“æœåŠ¡å™¨å’Œåª’ä½“ä»£ç†ï¼Œå…è®¸å‘å¸ƒã€è¯»å–ã€ä»£ç†å’Œè®°å½•è§†é¢‘å’ŒéŸ³é¢‘æµã€‚å®ƒè¢«è®¾æƒ³ä¸ºä¸€ç§â€œåª’ä½“è·¯ç”±å™¨â€ï¼Œå°†åª’ä½“æµä»ä¸€ç«¯è·¯ç”±åˆ°å¦ä¸€ç«¯ã€‚

**ä¸»è¦åŠŸèƒ½:**

- å°†ç›´æ’­æµå‘å¸ƒåˆ°æœåŠ¡å™¨
- ä»æœåŠ¡å™¨è¯»å–ç›´æ’­æµ
- æµè‡ªåŠ¨ä»ä¸€ç§åè®®è½¬æ¢ä¸ºå¦ä¸€ç§åè®®
- åœ¨ä¸åŒçš„è·¯å¾„ä¸­åŒæ—¶æä¾›å¤šä¸ªæµ
- å°†æµè®°å½•åˆ°ç£ç›˜
- éªŒè¯ç”¨æˆ·èº«ä»½ï¼›ä½¿ç”¨å†…éƒ¨æˆ–å¤–éƒ¨èº«ä»½éªŒè¯
- å°†è¯»å–å™¨é‡å®šå‘åˆ°å…¶ä»– RTSP æœåŠ¡å™¨ï¼ˆè´Ÿè½½å¹³è¡¡ï¼‰
- é€šè¿‡ API æŸ¥è¯¢å’Œæ§åˆ¶æœåŠ¡å™¨
- åœ¨ä¸æ–­å¼€ç°æœ‰å®¢æˆ·ç«¯è¿æ¥çš„æƒ…å†µä¸‹é‡æ–°åŠ è½½é…ç½®ï¼ˆçƒ­é‡è½½ï¼‰
- è¯»å– Prometheus å…¼å®¹çš„æŒ‡æ ‡
- å½“å®¢æˆ·ç«¯è¿æ¥ã€æ–­å¼€è¿æ¥ã€è¯»å–æˆ–å‘å¸ƒæµæ—¶è¿è¡ŒæŒ‚é’©ï¼ˆå¤–éƒ¨å‘½ä»¤ï¼‰
- ä¸ Linuxã€Windows å’Œ macOS å…¼å®¹ï¼Œä¸éœ€è¦ä»»ä½•ä¾èµ–é¡¹æˆ–è§£é‡Šå™¨ï¼Œå®ƒæ˜¯å•ä¸ªå¯æ‰§è¡Œæ–‡ä»¶

> æ€»ç»“: åŒæ—¶æ”¯æŒ rtsp/rtmp æ¨æ‹‰æµï¼Œæ‹‰æµè¿˜æ”¯æŒ hls/webrtc ä¸¤ç§æ–¹å¼ï¼Œæœ€æ–°ç‰ˆæœ¬è¿˜æ”¯æŒäº† srt æ–¹å¼ã€‚æ¨å‡ºæ¥çš„ hls/webrtc å¯ä»¥ç›´æ¥åµŒå…¥ä¸ª iframe ç½‘é¡µæ’­æ”¾ï¼Œæ²¡æœ‰ä»»ä½•ä¾èµ–ï¼Œå¦‚æœå¸Œæœ›ç›´æ¥åœ¨ç½‘é¡µä¸­æ’­æ”¾æ— ä¾èµ–ï¼Œå¼ºçƒˆæ¨èç”¨ mediamtx

### 5.7 Nginx-rtmp-module

https://github.com/arut/nginx-rtmp-module

Nginx æœ¬èº«æ˜¯ä¸€ä¸ªéå¸¸å‡ºè‰²çš„ HTTP æœåŠ¡å™¨,FFMPEG æ˜¯éå¸¸å¥½çš„éŸ³è§†é¢‘è§£å†³æ–¹æ¡ˆ.è¿™ä¸¤ä¸ªä¸œè¥¿é€šè¿‡ä¸€ä¸ª nginx çš„æ¨¡å— nginx-rtmp-module,ç»„åˆåœ¨ä¸€èµ·å³å¯ä»¥æ­å»ºä¸€ä¸ªåŠŸèƒ½ç›¸å¯¹æ¯”è¾ƒå®Œå–„çš„æµåª’ä½“æœåŠ¡å™¨. è¿™ä¸ªæµåª’ä½“æœåŠ¡å™¨å¯ä»¥æ”¯æŒ RTMP å’Œ HLS(Live Http Stream)ã€‚

**ä¸»è¦ç‰¹æ€§:**

1. æ”¯æŒ RTMPã€HLSã€MPEG-DASH
2. æ”¯æŒ RTMPã€HLS ç‚¹æ’­
3. å¯å°†ç›´æ’­è§†é¢‘åˆ†æ®µå­˜å‚¨
4. æ”¯æŒ H.264 è§†é¢‘ç¼–è§£ç ã€AAC éŸ³é¢‘ç¼–è§£ç 
5. æ”¯æŒ FFmpeg å‘½ä»¤å†…åµŒ
6. æ”¯æŒå›è°ƒ HTTP
7. å¯ä½¿ç”¨ HTTP å¯¹ç›´æ’­è¿›è¡Œåˆ é™¤ã€å½•æ’­ç­‰æ§åˆ¶
8. å…·æœ‰å¼ºå¤§çš„ç¼“å†²åŠŸèƒ½ï¼Œå¯ç¡®ä¿åœ¨æ•ˆç‡ä¸ç ç‡é—´è¾¾åˆ°å¹³è¡¡
9. æ”¯æŒå¤šç§æ“ä½œç³»ç»Ÿï¼ˆLinuxã€MacOSã€Windowsï¼‰

> æ€»ç»“: åªæ”¯æŒ rtmp æ¨æ‹‰æµï¼Œé»˜è®¤ç«¯å£ 1935ï¼Œä¸æ”¯æŒå…¶ä»–æ ¼å¼æ‹‰æµï¼ŒåŠŸèƒ½æå…¶å•ä¸€ï¼Œä¸æ¨èã€‚

## 6. å¹³å°é€‰å‹

### 6.1 WVP

WEB VIDEO PLATFORM æ˜¯ä¸€ä¸ªå¼€æºçš„åŸºäº GB28181-2016 æ ‡å‡†å®ç°çš„å¼€ç®±å³ç”¨çš„ç½‘ç»œè§†é¢‘å¹³å°ï¼Œè´Ÿè´£å®ç°æ ¸å¿ƒä¿¡ä»¤ä¸è®¾å¤‡ç®¡ç†åå°éƒ¨åˆ†ï¼Œæ”¯æŒ NAT ç©¿é€ï¼Œæ”¯æŒæµ·åº·ã€å¤§åã€å®‡è§†ç­‰å“ç‰Œçš„ IPCã€NVR æ¥å…¥ã€‚æ”¯æŒå›½æ ‡çº§è”ï¼Œæ”¯æŒå°†ä¸å¸¦å›½æ ‡åŠŸèƒ½çš„æ‘„åƒæœº/ç›´æ’­æµ/ç›´æ’­æ¨æµè½¬å‘åˆ°å…¶ä»–å›½æ ‡å¹³å°ã€‚

æµåª’ä½“æœåŠ¡åŸºäº@å¤æ¥š ZLMediaKit [https://github.com/ZLMediaKit/ZLMediaKit](https://link.zhihu.com/?target=https%3A//github.com/ZLMediaKit/ZLMediaKit)
æ’­æ”¾å™¨ä½¿ç”¨@dexter jessibuca [https://github.com/langhuihui/jessibuca/tree/v3](https://link.zhihu.com/?target=https%3A//github.com/langhuihui/jessibuca/tree/v3)
å‰ç«¯é¡µé¢åŸºäº@Kyle MediaServerUI [https://gitee.com/kkkkk5G/MediaServerUI](https://link.zhihu.com/?target=https%3A//gitee.com/kkkkk5G/MediaServerUI) è¿›è¡Œä¿®æ”¹.

å®˜ç½‘åœ°å€ï¼š [https://github.com/648540858/wv](https://link.zhihu.com/?target=https%3A//github.com/648540858/wvp-GB28181-pro)

![20241229154732_CtvQE7i1.webp](https://cdn.dong4j.site/source/image/20241229154732_CtvQE7i1.webp)

**ä¸»è¦ç‰¹æ€§:**

- å®ç°æ ‡å‡†çš„ 28181 ä¿¡ä»¤ï¼Œå…¼å®¹å¸¸è§çš„å“ç‰Œè®¾å¤‡ï¼Œæ¯”å¦‚æµ·åº·ã€å¤§åã€å®‡è§†ç­‰å“ç‰Œçš„ IPCã€NVR ä»¥åŠå¹³å°ã€‚
- æ”¯æŒå°†å›½æ ‡è®¾å¤‡çº§è”åˆ°å…¶ä»–å›½æ ‡å¹³å°ï¼Œä¹Ÿæ”¯æŒå°†ä¸æ”¯æŒå›½æ ‡çš„è®¾å¤‡çš„å›¾åƒæˆ–è€…ç›´æ’­æ¨é€åˆ°å…¶ä»–å›½æ ‡å¹³å°
- å‰ç«¯å®Œå–„ï¼Œè‡ªå¸¦å®Œæ•´å‰ç«¯é¡µé¢ï¼Œæ— éœ€äºŒæ¬¡å¼€å‘å¯ç›´æ¥éƒ¨ç½²ä½¿ç”¨ã€‚
- å®Œå…¨å¼€æºï¼Œä¸”ä½¿ç”¨ MIT è®¸å¯åè®®ã€‚ä¿ç•™ç‰ˆæƒçš„æƒ…å†µä¸‹å¯ä»¥ç”¨äºå•†ä¸šé¡¹ç›®ã€‚
- æ”¯æŒå¤šæµåª’ä½“èŠ‚ç‚¹è´Ÿè½½å‡è¡¡ã€‚

### 6.2 LiveGBS

LiveGBS å›½æ ‡ GB/T28181 æµåª’ä½“æœåŠ¡å™¨è½¯ä»¶ï¼Œæ”¯æŒè®¾å¤‡|å¹³å° GB28181 æ³¨å†Œæ¥å…¥ã€å‘ä¸Šçº§è”ç¬¬ä¸‰æ–¹å›½æ ‡å¹³å°ï¼Œ å¯è§†åŒ–çš„ WEB é¡µé¢ç®¡ç†(é¡µé¢æºç å¼€æº)ï¼›æ”¯æŒäº‘å°æ§åˆ¶ã€è®¾å¤‡å½•åƒæ£€ç´¢ã€å›æ”¾ï¼Œæ”¯æŒè¯­éŸ³å¯¹è®²ï¼Œç”¨æˆ·ç®¡ç†ï¼Œ å¤šç§åè®®æµè¾“å‡ºï¼Œå®ç°æµè§ˆå™¨æ— æ’ä»¶ç›´æ’­ã€‚

å®˜ç½‘åœ°å€: [https://gbs.liveqing.com/docs/products/LiveGBS.html](https://gbs.liveqing.com/docs/products/LiveGBS.html)

![20241229154732_RPzdHD7W.webp](https://cdn.dong4j.site/source/image/20241229154732_RPzdHD7W.webp)

**ä¸»è¦ç‰¹æ€§:**

1. LiveGBS å›½æ ‡ (GB28181) æµåª’ä½“æœåŠ¡è½¯ä»¶
2. æ”¯æŒå„ä¸ªç‰ˆæœ¬çš„ GB28181 åè®®ï¼›
3. æä¾›ç”¨æˆ·ç®¡ç†åŠ Web å¯è§†åŒ–é¡µé¢ç®¡ç†ï¼›
4. æä¾›è®¾å¤‡çŠ¶æ€ç®¡ç†ï¼Œå¯å®æ—¶æŸ¥çœ‹è®¾å¤‡æ˜¯å¦æ‰çº¿ç­‰ä¿¡æ¯ï¼›
5. å®æ—¶æµåª’ä½“å¤„ç†ï¼ŒPSï¼ˆTSï¼‰è½¬ ESï¼›
6. è®¾å¤‡çŠ¶æ€ç›‘æµ‹ã€äº‘å°æ§åˆ¶ã€å½•åƒæ£€ç´¢ã€å›æ”¾ï¼›
7. æä¾› RTSPã€RTMPã€HTTP-FLVã€HLS ç­‰å¤šç§åè®®æµè¾“å‡ºï¼›
8. å¯¹å¤–æä¾›æœåŠ¡å™¨è·å–çŠ¶æ€ã€ä¿¡æ¯ï¼Œæ§åˆ¶ç­‰ HTTP API æ¥å£ï¼›
9. ä¼ä¸šç§æœ‰äº‘éƒ¨ç½²ï¼Œæ”¯æŒ Linux & Windows;

![20241229154732_IywNDkIH.webp](https://cdn.dong4j.site/source/image/20241229154732_IywNDkIH.webp)

### 6.3 AeroGBD

åŸºäº GB/T 28181-2016 åè®®æ ‡å‡†ï¼Œæä¾›æ ‡å‡†æ¥å…¥ã€æ ‡å‡†åª’ä½“ã€æ ‡å‡†åº”ç”¨ã€æ ‡å‡†å…±äº«çš„å›½æ ‡æœåŠ¡èƒ½åŠ›ã€‚èƒ½å¤Ÿæ¥å…¥ç¬¦åˆ GB/T 28181-2016 çš„è§†é¢‘ç›‘æ§å¹³å°ã€ç¡¬ç›˜å½•åƒæœºã€æ‘„åƒæœºã€æ— äººæœºã€æœºå™¨äººç­‰å¸‚é¢å„ç±»å‚å®¶è®¾å¤‡ï¼›èƒ½å¤Ÿå®ç°æŒ‰ç…§ GB/T 28181-2016 æ–¹å¼è¿›è¡Œå›½æ ‡å…±äº«è¾“å‡ºï¼Œæä¾›å®æ—¶è§†é¢‘ã€ä¸‹çº§/å‰ç«¯å½•åƒã€ç³»ç»Ÿç®¡ç†ç­‰åº”ç”¨åŠŸèƒ½ï¼Œå…·æœ‰è”ç½‘èƒ½åŠ›å¼ºã€å¼€æ”¾å…¼å®¹ã€æ˜“ç”¨ä¾¿æ·ç­‰çš„ç‰¹ç‚¹ã€‚é€‚ç”¨äºæ™ºæ…§åŸå¸‚ã€é›ªäº®å·¥ç¨‹ã€è¡Œä¸šè§†é¢‘è”ç½‘ç­‰å„è¡Œä¸šè§†é¢‘æ ‡å‡†è”ç½‘æ¥å…¥åœºæ™¯ã€‚

![20241229154732_Yl2AZeCG.webp](https://cdn.dong4j.site/source/image/20241229154732_Yl2AZeCG.webp)

**ä¸»è¦ç‰¹æ€§:**

1. **æ¥å…¥æ€§èƒ½å¼ºï¼š**å•å¥—æ”¯æŒæ¥å…¥>10 ä¸ªä¸‹çº§å¹³å°ï¼Œ>2 ä¸‡è·¯è®¾å¤‡ï¼Œå¯é›†ç¾¤æ‰©å®¹ï¼›
2. **å…±äº«æ€§èƒ½å¼ºï¼š**å•å¥—æ”¯æŒ>10 ä¸ªä¸Šçº§å…±äº«æ¨é€ï¼Œå¯é›†ç¾¤æ‰©å®¹ï¼›
3. **è§†é¢‘å¹¶å‘é«˜ï¼š**å•å¥—æ”¯æŒ 500 è·¯è§†é¢‘å¹¶å‘ï¼Œå¯é›†ç¾¤æ‰©å®¹ï¼›
4. **è§£ç æ€§èƒ½ï¼š**å®¢æˆ·ç«¯æœ€å¤§æ”¯æŒ 9 è·¯è§†é¢‘åŒå±æ’­æ”¾ï¼Œ2K è§†é¢‘ä¸ä½äº 2 è·¯ï¼›
5. **è§†é¢‘å¼€æµï¼š**å®æ—¶è§†é¢‘å¼€æµé€Ÿåº¦å°äº 3 ç§’ï¼›å‰ç«¯/ä¸‹çº§å½•åƒè°ƒé˜…å¼€æµå°äº 3 ç§’ã€‚
6. **å½•åƒå¼€æµï¼š** ä¸‹çº§å¹³å°å½•åƒå¼€æµå°äº 3 ç§’ï¼›
7. **ç”¨æˆ·å¹¶å‘ï¼š** å•å¥—ä¸ä½äº 100 ä¸ªç”¨æˆ·å¹¶å‘ä½¿ç”¨ï¼›
8. **éƒ¨ç½²å®‰è£…ï¼š** ä¸€å°èµ·æ­¥ï¼Œä¸€é”®å®‰è£…éƒ¨ç½²ï¼Œå•æ¬¡æ ‡å‡†æœåŠ¡å™¨éƒ¨ç½²æ—¶é—´å°äº 10 åˆ†é’Ÿã€‚

### 6.4 EasyGBS

EasyGBS å›½æ ‡è§†é¢‘äº‘æœåŠ¡æä¾›æµè½¬å‘æœåŠ¡ï¼Œè´Ÿè´£å°† GB28181 è®¾å¤‡/å¹³å°æ¨é€çš„ PS æµè½¬æˆ ES æµï¼Œç„¶åæä¾› RTSPã€RTMPã€FLVã€HLS å¤šç§æ ¼å¼è¿›è¡Œåˆ†å‘ï¼Œå®ç° web æµè§ˆå™¨ã€æ‰‹æœºæµè§ˆå™¨ã€å¾®ä¿¡ã€PC å®¢æˆ·ç«¯ç­‰å„ç§ç»ˆç«¯æ— æ’ä»¶æ’­æ”¾ã€‚

![20241229154732_oWxv8mHR.webp](https://cdn.dong4j.site/source/image/20241229154732_oWxv8mHR.webp)

**ä¸»è¦ç‰¹æ€§:**

1. **å¯è§†åŒ–é¡µé¢**: æä¾›ç”¨æˆ·ç®¡ç†åŠ web å¯è§†åŒ–é¡µé¢ç®¡ç†ï¼ŒåŠå½•åƒæ£€ç´¢ã€å›æ”¾
2. **è®¾å¤‡çŠ¶æ€ç®¡ç†**: æä¾›è®¾å¤‡çŠ¶æ€ç®¡ç†ï¼Œå¯å®æ—¶æŸ¥çœ‹è®¾å¤‡æ˜¯å¦æ‰çº¿ç­‰ä¿¡æ¯
3. **å®æ—¶æµå¤„ç†**: å®æ—¶æµåª’ä½“å¤„ç†ï¼ŒPSï¼ˆTSï¼‰è½¬ ESï¼Œæä¾›éŸ³è§†é¢‘è½¬ç èƒ½åŠ›
4. **äº‘å°æ§åˆ¶**: åŸºäºåŠ¨æ€ç»„ç½‘æœåŠ¡åˆ›å»ºæ™ºèƒ½ç½‘ç»œï¼ŒæŒ‰éœ€é€‰æ‹©éœ€è¦ç»„ç½‘çš„ç½‘ç»œæˆå‘˜å®ç°ç‚¹ç‚¹äº’è”
5. **å¤šç§æµè¾“å‡º**: æä¾› RTSPã€RTMPã€HTTP-FLVã€HLS ç­‰å¤šç§åè®®æµè¾“å‡º
6. **API æ¥å£**: å¯¹å¤–æä¾›æœåŠ¡å™¨è·å–çŠ¶æ€ã€ä¿¡æ¯ï¼Œæ§åˆ¶ HTTP API æ¥å£

### 6.5 NTV GBS

NTV GBS æ˜¯ä¸€æ¬¾æˆç†Ÿã€åŠŸèƒ½å®Œå–„ã€äº§å“åŒ–ç¨‹åº¦å¾ˆé«˜çš„ GB28181 æœåŠ¡å¹³å°ï¼Œä» 2022 å¹´æ¨å‡ºä»¥æ¥è¿…é€Ÿè·å¾—å„æŠ€æœ¯å¹³å°æŠ¥é“è½¬å‘ï¼Œå› å…¶ç•Œé¢ç®€æ´èˆ’ç•…ã€æ“ä½œç®€å•è·å¾—ä¼—å¤šå¤§å°ç”¨æˆ·é’çã€‚

NTV GBS æä¾›äº‘æœåŠ¡å’Œç‹¬ç«‹éƒ¨ç½²ä¸¤ç§ä½¿ç”¨æ¨¡å¼ï¼Œäº‘æœåŠ¡æ–¹å¼æ³¨å†Œè´¦å·å°±å¯ä»¥ä½¿ç”¨ï¼Œè€Œä¸”æä¾›å…è´¹æµé‡ä¾›ä½¿ç”¨ï¼›ç‹¬ç«‹éƒ¨ç½²æ–¹å¼éœ€è¦è‡ªå·±è´­ä¹°è®¾å¤‡å®‰è£…è¯¥è½¯ä»¶ã€‚

å®˜ç½‘åœ°å€ï¼š [GB28181 è§†é¢‘ç›‘æ§å›½æ ‡å¹³å° - NTV GBS](https://link.zhihu.com/?target=http%3A//www.ntvgbs.com/%3Ff%3Dzh)

![20241229154732_PbEm8IGB.webp](https://cdn.dong4j.site/source/image/20241229154732_PbEm8IGB.webp)

**ä¸»è¦åŠŸèƒ½:**

1. è§†é¢‘ç›‘æ§è®¾å¤‡è¿œç¨‹æ¥å…¥ã€è¿œç¨‹ç®¡ç†ã€äº‘å°æ§åˆ¶å’Œè§†é¢‘è°ƒé˜…ï¼Œäº‘ç«¯å½•åƒå’Œå›çœ‹
2. æ”¯æŒå„å‹å· GB28181 å›½æ ‡æ‘„åƒå¤´ IPC å’Œç¡¬ç›˜å½•åƒæœº NVR/HVR/DVR
3. æ”¯æŒå„ç±» rtmp/rtsp æ”¯æŒç›´æ’­æ¨æµæ‘„åƒæœºï¼Œå…¼å®¹ ONVIF åè®®
4. è§†é¢‘æ¥å…¥åˆ†ææœåŠ¡ï¼Œç”¨äºå„ç§æ™ºæ…§åº”ç”¨åœºæ™¯ï¼Œé‡æ–°å®šä¹‰ç›‘æ§è§†é¢‘ä»·å€¼
5. åœ¨ç½‘é¡µã€å°ç¨‹åºã€ä¸šåŠ¡å¹³å°ä¸­æ— æ’ä»¶æ’­æ”¾ï¼Œæä¾› rtmp/rtsp/hls/http/websocket æ’­å‡ºåœ°å€
6. æ”¯æŒ**H265**è§†é¢‘ç¼–ç ï¼Œæ›´çœæµé‡æ›´æµç•…
7. å¤šçº§å¹³å°çº§è”å¯¹æ¥ï¼Œå®ç°ä¸Šä¸‹çº§å¹³å°ç›‘æ§è§†é¢‘èåˆæ±‡èš

### 6.6 AKStream

AKStream æ˜¯ä¸€å¥—å…¨åŠŸèƒ½çš„è½¯ NVR æ¥å£å¹³å°ï¼Œè½¯ NVR æŒ‡çš„æ˜¯è½¯ä»¶å®šä¹‰çš„ NVRï¼ˆNetwork Video Recoderï¼‰ï¼ŒAKStream ç»è¿‡é•¿è¾¾ä¸€å¹´åŠçš„å¼€å‘ï¼Œæµ‹è¯•ä¸è°ƒä¼˜ï¼Œå·²ç»å…·å¤‡äº†ä¸€å®šçš„ä½¿ç”¨ä»·å€¼ï¼Œåœ¨å¯é æ€§ï¼Œå®ç”¨æ€§æ–¹é¢éƒ½æœ‰ç€è¾ƒä¸ºä¸é”™çš„è¡¨ç°ï¼ŒåŒæ—¶å› ä¸º AKStream æ˜¯ä¸€å¥—å®Œå…¨å¼€æºçš„è½¯ä»¶äº§å“ï¼Œåœ¨ä¼—å¤šç½‘å‹çš„ä¸€èµ·åŠ æŒä¸‹ï¼ŒAKStream çš„å®‰å…¨æ€§ä¹Ÿå¾—åˆ°äº†éªŒè¯ã€‚

AKStream é›†æˆäº† ZLMediaKit ä½œä¸ºå…¶æµåª’ä½“æœåŠ¡å™¨ï¼ŒAKStream æ”¯æŒå¯¹ ZLMediaKit çš„é›†ç¾¤ç®¡ç†ï¼ˆé€šè¿‡ AKStreamKeeper-æµåª’ä½“æ²»ç†ç»„ä»¶ï¼‰ï¼Œå¯ä»¥å°†åˆ†å¸ƒåœ¨ä¸åŒæœåŠ¡å™¨çš„å¤šä¸ª ZLMediaKit é›†ç¾¤èµ·æ¥ï¼Œç»Ÿä¸€ç®¡ç†ï¼Œç»Ÿä¸€è°ƒåº¦ã€‚

å®˜ç½‘åœ°å€ï¼š[https://github.com/chatop2020/AKStream](https://github.com/chatop2020/AKStream)

![20241229154732_dRpr9eti.webp](https://cdn.dong4j.site/source/image/20241229154732_dRpr9eti.webp)

**ä¸»è¦ç‰¹æ€§:**

1. æ§åˆ¶å°ï¼ˆæµåª’ä½“æœåŠ¡æ€§èƒ½ç›‘æ§ï¼‰
2. è§†é¢‘å¹¿åœºï¼ˆå¤šè§†é¢‘ï¼‰
3. è®¾å¤‡ç®¡ç†
4. å½•åƒè®¡åˆ’ï¼ˆæœ¬åœ°å½•åˆ¶ï¼‰
5. å½•åƒå›æ”¾ï¼ˆGB28181 å’Œæœ¬åœ°å½•åˆ¶ï¼‰
6. è§†é¢‘æ¨æµ
7. è§†é¢‘æ‹‰æµ
8. è§†é¢‘æœ¬åœ°å½•åˆ¶
9. äº‘å°åŠŸèƒ½

### 6.7 LiteCVR

![20241229154732_CeJAULOF.webp](https://cdn.dong4j.site/source/image/20241229154732_CeJAULOF.webp)

LiteCVR å¹³å°æ”¯æŒå›½æ ‡ GB/T28181ã€RTMPã€RTSP/Onvif åè®®ç­‰ï¼Œä»¥åŠæµ·åº· SDKã€å¤§å SDKã€æµ·åº· Ehome ç­‰å‚å®¶ç§æœ‰åè®®ï¼Œä¹Ÿæ”¯æŒæ ‡å‡†çš„ API å¼€å‘æ¥å£ï¼Œå¯é›†æˆè‡³ç§»åŠ¨ç«¯ APPã€å°ç¨‹åºã€å…¶ä»–ä¸šåŠ¡å¹³å°æ’­æ”¾ï¼Œå¹¶æä¾›åˆ†äº«é“¾æ¥å’Œ iframe åœ°å€ï¼Œå¯ç›´æ¥åœ¨æµè§ˆå™¨æ’­æ”¾ã€‚

> ç»¼åˆå¯¹æ¯”ä¸‹æ¥, æœ€ç»ˆé€‰æ‹© WVP å¹³å°ä½œä¸ºè§†é¢‘æ¥å…¥å¹³å°, ä¸»è¦åŸå› å¦‚ä¸‹:
>
> 1. WVP å¹³å°å…¨éƒ¨å¼€æºä¸”å¼€æºåè®®å‹å¥½;
> 2. WVP å¹³å°çš„åŠŸèƒ½è¾ƒä¸ºå®Œå–„, ä¸”æœ‰æ•´å¥—å¹³å°, åŒ…æ‹¬ç®¡ç†ç«¯, SIP æœåŠ¡å’Œæµåª’ä½“æœåŠ¡;
> 3. WVP æµåª’ä½“æœåŠ¡ä½¿ç”¨ä¸šå†…è¾ƒä¸ºæµè¡Œä¸”ç¤¾åŒºæ´»è·ƒçš„ ZLMediaKit;
> 4. WVP ç®¡ç†ç«¯ä½¿ç”¨ Spring Boot å¼€å‘, å¯ä»¥å¿«é€Ÿçš„è¿›è¡ŒäºŒæ¬¡å¼€å‘;

## 7. WVP

WEB VIDEO PLATFORM æ˜¯ä¸€ä¸ªåŸºäº GB28181-2016 æ ‡å‡†å®ç°çš„å¼€ç®±å³ç”¨çš„ç½‘ç»œè§†é¢‘å¹³å°ï¼Œè´Ÿè´£å®ç°æ ¸å¿ƒä¿¡ä»¤ä¸è®¾å¤‡ç®¡ç†åå°éƒ¨åˆ†ï¼Œæ”¯æŒ NAT ç©¿é€ï¼Œæ”¯æŒæµ·åº·ã€å¤§åã€å®‡è§†ç­‰å“ç‰Œçš„ IPCã€NVR æ¥å…¥ã€‚æ”¯æŒå›½æ ‡çº§è”ï¼Œæ”¯æŒå°†ä¸å¸¦å›½æ ‡åŠŸèƒ½çš„æ‘„åƒæœº/ç›´æ’­æµ/ç›´æ’­æ¨æµè½¬å‘åˆ°å…¶ä»–å›½æ ‡å¹³å°ã€‚

**é¡¹ç›®åœ°å€**ï¼š[wvp-GB28181-pro](https://gitee.com/pan648540858/wvp-GB28181-pro)

[æ–‡æ¡£åœ°å€](https://doc.wvp-pro.cn/#/)

### 7.1 åº”ç”¨åœºæ™¯

- æ”¯æŒæµè§ˆå™¨æ— æ’ä»¶æ’­æ”¾æ‘„åƒå¤´è§†é¢‘ã€‚
- æ”¯æŒæ‘„åƒæœºã€å¹³å°ã€NVR ç­‰è®¾å¤‡æ¥å…¥ã€‚ æ”¯æŒå›½æ ‡çº§è”ã€‚
- æ”¯æŒ rtsp/rtmp ç­‰è§†é¢‘æµè½¬å‘åˆ°å›½æ ‡å¹³å°ã€‚
- æ”¯æŒ rtsp/rtmp ç­‰æ¨æµè½¬å‘åˆ°å›½æ ‡å¹³å°ã€‚

### 7.2 ä¸»è¦ç‰¹æ€§

- å®ç°æ ‡å‡†çš„ 28181 ä¿¡ä»¤ï¼Œå…¼å®¹å¸¸è§çš„å“ç‰Œè®¾å¤‡ï¼Œæ¯”å¦‚æµ·åº·ã€å¤§åã€å®‡è§†ç­‰å“ç‰Œçš„ IPCã€NVR ä»¥åŠå¹³å°ã€‚
- æ”¯æŒå°†å›½æ ‡è®¾å¤‡çº§è”åˆ°å…¶ä»–å›½æ ‡å¹³å°ï¼Œä¹Ÿæ”¯æŒå°†ä¸æ”¯æŒå›½æ ‡çš„è®¾å¤‡çš„å›¾åƒæˆ–è€…ç›´æ’­æ¨é€åˆ°å…¶ä»–å›½æ ‡å¹³å°
- å‰ç«¯å®Œå–„ï¼Œè‡ªå¸¦å®Œæ•´å‰ç«¯é¡µé¢ï¼Œæ— éœ€äºŒæ¬¡å¼€å‘å¯ç›´æ¥éƒ¨ç½²ä½¿ç”¨ã€‚
- å®Œå…¨å¼€æºï¼Œä¸”ä½¿ç”¨ MIT è®¸å¯åè®®ã€‚ä¿ç•™ç‰ˆæƒçš„æƒ…å†µä¸‹å¯ä»¥ç”¨äºå•†ä¸šé¡¹ç›®ã€‚
- æ”¯æŒå¤šæµåª’ä½“èŠ‚ç‚¹è´Ÿè½½å‡è¡¡ã€‚

### 7.3 åŸºç¡€åŠŸèƒ½

1. è§†é¢‘é¢„è§ˆ;
2. äº‘å°æ§åˆ¶ï¼ˆæ–¹å‘ã€ç¼©æ”¾æ§åˆ¶ï¼‰;
3. è§†é¢‘è®¾å¤‡ä¿¡æ¯åŒæ­¥;
4. ç¦»åœ¨çº¿ç›‘æ§;
5. å½•åƒæŸ¥è¯¢ä¸å›æ”¾ï¼ˆåŸºäº NVR/DVRï¼Œæš‚ä¸æ”¯æŒå¿«è¿›ã€seek æ“ä½œï¼‰;
6. æ— äººè§‚çœ‹è‡ªåŠ¨æ–­æµ;
7. æ”¯æŒ UDP å’Œ TCP ä¸¤ç§å›½æ ‡ä¿¡ä»¤ä¼ è¾“æ¨¡å¼;
8. é›†æˆ web ç•Œé¢, ä¸éœ€è¦å•ç‹¬éƒ¨ç½²å‰ç«¯æœåŠ¡, ç›´æ¥åˆ©ç”¨ wvp å†…ç½®æ–‡ä»¶æœåŠ¡éƒ¨ç½², éš wvp ä¸€èµ·éƒ¨ç½²;
9. æ”¯æŒå¹³å°æ¥å…¥, é’ˆå¯¹å¤§å¹³å°å¤§é‡è®¾å¤‡çš„æƒ…å†µè¿›è¡Œä¼˜åŒ–;
10. æ”¯æŒæ£€ç´¢,é€šé“ç­›é€‰;
11. æ”¯æŒè‡ªåŠ¨é…ç½® ZLM åª’ä½“æœåŠ¡, å‡å°‘å› é…ç½®é—®é¢˜æ‰€å‡ºç°çš„é—®é¢˜;
12. æ”¯æŒå¯ç”¨ udp å¤šç«¯å£æ¨¡å¼, æé«˜ udp æ¨¡å¼ä¸‹åª’ä½“ä¼ è¾“æ€§èƒ½;
13. æ”¯æŒé€šé“æ˜¯å¦å«æœ‰éŸ³é¢‘çš„è®¾ç½®;
14. æ”¯æŒé€šé“å­ç›®å½•æŸ¥è¯¢;
15. æ”¯æŒ udp/tcp å›½æ ‡æµä¼ è¾“æ¨¡å¼;
16. æ”¯æŒç›´æ¥è¾“å‡º RTSPã€RTMPã€HTTP-FLVã€Websocket-FLVã€HLS å¤šç§åè®®æµåœ°å€
17. æ”¯æŒå›½æ ‡ç½‘ç»œæ ¡æ—¶
18. æ”¯æŒå…¬ç½‘éƒ¨ç½², æ”¯æŒ wvp ä¸ zlm åˆ†å¼€éƒ¨ç½²
19. æ”¯æŒæ’­æ”¾ h265, g.711 æ ¼å¼çš„æµ(éœ€è¦å°† closeWaitRTPInfo è®¾ä¸º false)
20. æŠ¥è­¦ä¿¡æ¯å¤„ç†ï¼Œæ”¯æŒå‘å‰ç«¯æ¨é€æŠ¥è­¦ä¿¡æ¯

### 7.4 éƒ¨ç½²

WVP å¹³å°ç”± ç®¡ç†å¹³å°, SIP æœåŠ¡å’Œæµåª’ä½“æœåŠ¡ç»„æˆ, å…³ç³»å›¾å¦‚ä¸‹:

![wvp.drawio.svg](https://cdn.dong4j.site/source/image/wvp.drawio.svg)

1. ä½¿ç”¨ Spring å®ç°äº† SIP åè®®, ä¾¿äºäºŒæ¬¡å¼€å‘;
2. ä½¿ç”¨ MySQL å­˜å‚¨ç»“æ„åŒ–æ•°æ®;
3. ä½¿ç”¨ Redis å­˜å‚¨æ³¨å†Œä¿¡æ¯;
4. æµåª’ä½“æœåŠ¡å™¨ä½¿ç”¨å¼€æºçš„é«˜æ€§èƒ½ ZLMediaKit å®ç°;
5. ä½¿ç”¨ assist æœåŠ¡ç”¨äºå­˜å‚¨è§†é¢‘å¹¶æä¾›å†å²è§†é¢‘æŸ¥çœ‹;

WVP å¹³å°éƒ¨ç½²å¯æ˜¯ä½¿ç”¨ 2 ç§æ–¹å¼, ä¸€æ˜¯ä½¿ç”¨æºç è‡ªè¡Œç¼–è¯‘éƒ¨ç½², äºŒæ˜¯ä½¿ç”¨å·²æœ‰ docker é•œåƒä¸€é”®éƒ¨ç½², ä½†æ˜¯å®˜æ–¹ docker é•œåƒæœ€åæ›´æ–°ä¸ 2 å¹´å‰, å› æ­¤æœ€å¥½çš„æ–¹å¼æ˜¯ä½¿ç”¨æºç ç¼–è¯‘éƒ¨ç½², ä¸è¿‡ä¸ºäº†å¯ç§»æ¤æ€§å’Œæ–¹ä¾¿å¿«æ·çš„å®‰è£…éƒ¨ç½², è¿™é‡Œè€ƒè™‘ä½¿ç”¨æºç æ‰“åŒ…ä¸º docker é•œåƒå®‰è£…éƒ¨ç½², å…·ä½“è¿‡ç¨‹åç»­å†å®Œå–„è¡¥å…….

**æ•°æ®æµå‘**

![æ•°æ®æµ.drawio.svg](https://cdn.dong4j.site/source/image/%E6%95%B0%E6%8D%AE%E6%B5%81.drawio.svg)

**å®æ—¶è§†é¢‘æµ:**

1. ä¸šåŠ¡ç³»ç»Ÿå‘ WVP ç®¡ç†å¹³å°å‘èµ·è§‚çœ‹å®æ—¶è§†é¢‘çš„è¯·æ±‚;
2. WVP æ¥æ”¶åˆ°è¯·æ±‚å, æ ¹æ®è®¾å¤‡ç¼–ç å’Œé€šé“å·æŸ¥è¯¢è®¾å¤‡æ˜¯å¦å­˜åœ¨, ç„¶åå°†ç¼–ç æˆ RTSP è§†é¢‘æµåè®®å¹¶è°ƒç”¨æµåª’ä½“æœåŠ¡å™¨è¿›è¡Œè§†é¢‘æµè½¬ç ;
3. æµåª’ä½“æœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚åè½¬æ¢æˆ H5 èƒ½å¤Ÿç›´æ¥æ’­æ”¾çš„è§†é¢‘æµåœ°å€, æ¯”å¦‚ mp4/FLV ç­‰æ ¼å¼;

**å†å²è§†é¢‘**

1. æµåª’ä½“æœåŠ¡å™¨ä¼šå°†å®æ—¶è§†é¢‘å…¨éƒ¨å­˜å‚¨åˆ°æœåŠ¡å™¨, ä¾›ä¸šåŠ¡ç«¯æŸ¥è¯¢å†å²è§†é¢‘;
2. æµåª’ä½“æœåŠ¡å™¨ä¼šå°†å†å²è§†é¢‘å­˜å‚¨åˆ° NAS;
3. IPC/æ‰§æ³•è®°å½•ä»ªç­‰æ”¯æŒ FTP çš„è®¾å¤‡, å¯ä»¥å°†æœ¬åœ°çš„å†å²è§†é¢‘ä¼ è¾“åˆ° NAS çš„ FTP æœåŠ¡å™¨;

### 7.5 ä½¿ç”¨

ç›®å‰å·²åœ¨å…¬å¸å†…éƒ¨æœåŠ¡å™¨ä½¿ç”¨æœ€æ–°çš„æºç å®‰è£…éƒ¨ç½²äº†ä¸€å¥— WVP å¹³å°, è®¿é—®åœ°å€ä¸º: http://10.100.10.135:18080/#/login, ç™»å½•è´¦å·ä¸å¯†ç : admin/admin.

#### 7.5.1 æ§åˆ¶å°

èƒ½å¤Ÿå±•ç¤ºæœåŠ¡å™¨ä¸»è¦èµ„æºçš„ä½¿ç”¨æƒ…å†µä»¥åŠè®¾å¤‡æ¥å…¥æ•°é‡:

![20241229154732_uk6e6kTz.webp](https://cdn.dong4j.site/source/image/20241229154732_uk6e6kTz.webp)

#### 7.5.2 è§†é¢‘å¢™

è‡ªå¸¦ 1/4/9 ä¸ªè§†é¢‘çª—å£, å¦‚æœéœ€è¦æ›´å¤šçª—å£éœ€è¦äºŒå¼€

![20241229154732_1bYIRYDQ.webp](https://cdn.dong4j.site/source/image/20241229154732_1bYIRYDQ.webp)

#### 7.5.3 è®¾å¤‡ç®¡ç†

ç›®å‰å·²æ¥å…¥æ™ºæ…§å·¥åœ°çš„ IVSS, å…¬å¸å†…éƒ¨çš„ NVR å’Œä¸€ä¸ª 4G IPC:

![20241229154732_05vro0nZ.webp](https://cdn.dong4j.site/source/image/20241229154732_05vro0nZ.webp)

å®æ—¶è§†é¢‘:

![20241229154732_PoX5ufi9.webp](https://cdn.dong4j.site/source/image/20241229154732_PoX5ufi9.webp)

åœ¨ç‚¹æ’­è§†é¢‘å, ä¼šå°†è§†é¢‘å­˜å‚¨åˆ°æœåŠ¡å™¨:

![20241229154732_Wzk1RDR2.webp](https://cdn.dong4j.site/source/image/20241229154732_Wzk1RDR2.webp)

ä¹Ÿå¯ä»¥æŸ¥çœ‹å’Œä¸‹è½½ NVR æˆ– IPC å­˜å‚¨å¡ä¸­çš„å†å²è§†é¢‘:

![20241229154732_fdR6jGCP.webp](https://cdn.dong4j.site/source/image/20241229154732_fdR6jGCP.webp)

äº‘å°æ§åˆ¶:

![20241229154732_OFughEBk.webp](https://cdn.dong4j.site/source/image/20241229154732_OFughEBk.webp)

å¦ä¸€ä¸ªæœ‰ç”¨çš„åŠŸèƒ½æ˜¯ç”µå­åœ°å›¾, ä¸è¿‡ç›®å‰æ²¡æœ‰é¡µé¢å¯ä»¥ç›´æ¥è®¾ç½®, å¦‚æœåæœŸéœ€è¦å¯ä»¥è¿›è¡ŒäºŒå¼€:

![20241229154732_pWdpx07u.webp](https://cdn.dong4j.site/source/image/20241229154732_pWdpx07u.webp)

#### 7.5.4 æ‹‰æµä»£ç†

å¯ä»¥å°†ä¸å…·å¤‡ GB/T28181 åè®®ä½†æ˜¯åˆå›ºå®š IP çš„è§†é¢‘è®¾å¤‡æ¥å…¥åˆ°æ­¤å¹³å°:

![20241229154732_0BLonsNd.webp](https://cdn.dong4j.site/source/image/20241229154732_0BLonsNd.webp)

### 7.6 è®¾å¤‡å¯¹æ¥

#### 7.6.1 æœåŠ¡ç«¯

è®¾å¤‡æ¥å…¥ä¸»è¦æ˜¯éœ€è¦åœ¨è®¾å¤‡ä¸Šé…ç½® 28181 ä¸Šçº§ä¹Ÿå°±æ˜¯ WVP çš„ä¿¡æ¯ï¼Œåªæœ‰ä¿¡æ¯ä¸€è‡´çš„æƒ…å†µæ‰å¯ä»¥æ³¨å†ŒæˆåŠŸã€‚è®¾å¤‡æ³¨å†ŒæˆåŠŸåæ‰“å¼€ WVP->å›½æ ‡è®¾å¤‡,å¯ä»¥çœ‹åˆ°æ–°å¢åŠ çš„è®¾å¤‡ï¼›
ä¸»è¦æœ‰ä»¥ä¸‹å­—æ®µéœ€è¦é…ç½®ï¼š

- sip->ip
  æœ¬æœº IPï¼Œä¸è¦ä½¿ç”¨ 127.0.0.1/0.0.0.0, é™¤éä½ å¯¹é¡¹ç›®åŠå…¶ç†Ÿæ‚‰
- sip->port
  28181 æœåŠ¡ç›‘å¬çš„ç«¯å£
- sip->domain
  domain å®œé‡‡ç”¨ ID ç»Ÿä¸€ç¼–ç çš„å‰åä½ç¼–ç ã€‚
- sip->id
  28181 æœåŠ¡ ID
- sip->password
  28181 æœåŠ¡å¯†ç 
- é…ç½®ä¿¡æ¯åœ¨å¦‚ä¸‹ä½ç½®

![20241229154732_qgjUmtFS.webp](https://cdn.dong4j.site/source/image/20241229154732_qgjUmtFS.webp)

#### 7.6.2 å®¢æˆ·ç«¯

SIP å®¢æˆ·ç«¯è®¾ç½®åŸºæœ¬ä¸€è‡´, è¿™é‡Œä»¥å¤§å NVR ä¸ºä¾‹:

![20241229154732_AV3XWako.webp](https://cdn.dong4j.site/source/image/20241229154732_AV3XWako.webp)

å› ä¸º NVR ä¸ WVP å¹³å°éƒ¨ç½²åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘å†…, å› æ­¤ NVR é…ç½®çš„ SIP æœåŠ¡å™¨ IP ä¸ºå±€åŸŸç½‘ IP, å¦‚æœé€šè¿‡å…¬ç½‘è®¿é—®, SIP æœåŠ¡å™¨ IP åˆ™é…ç½®ä¸ºå…¬ç½‘å›ºå®š IP.

### 7.7 ä¸šåŠ¡ç³»ç»Ÿå¯¹æ¥

å‰é¢å·²ç»è®²è¿‡, WVP å¯ä»¥ä½œä¸ºè§†é¢‘æ¥å…¥å±‚, è´Ÿè´£æ”¯æŒ GB/T28181 åè®®çš„è§†é¢‘è®¾å¤‡çš„æ¥å…¥ç®¡ç†, ä¸”èƒ½å¤Ÿä¸ºä¸Šå±‚ä¸šåŠ¡æä¾›å¤šç§æ ¼å¼çš„è§†å±æµ, æ¯”å¦‚:

![20241229154732_oVR2eFvq.webp](https://cdn.dong4j.site/source/image/20241229154732_oVR2eFvq.webp)

ä¸šåŠ¡ç³»ç»Ÿåªéœ€è¦è°ƒç”¨ API è·å–è§†é¢‘æµåœ°å€å³å¯æ¥å…¥è§†é¢‘, é¿å…äº†å¯¹æ¥å¤šå®¶å‚å•†è®¾å¤‡çš„çƒ¦æ¼, ä¸”å¦‚æœåæœŸæ›´æ¢äº†ä¸åŒå‚å•†çš„è§†é¢‘è®¾å¤‡, ä¸šåŠ¡ç³»ç»Ÿä¸éœ€è¦ä»»ä½•ä¿®æ”¹, åªéœ€è¦åœ¨ WVP å¹³å°ä¸­æ¥å…¥å³å¯.

åœ¨åŸæœ‰è§†é¢‘è®¾å¤‡ç»„ç½‘æ–¹å¼ä¸å˜çš„æƒ…å†µä¸‹, ä¸‹é¢ 3 ä¸ªç³»ç»Ÿå¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡æƒ…å†µé€‰æ‹©æ˜¯å¦å°†ç°æœ‰è§†é¢‘æ¥å£ä½¿ç”¨ WVP API æ›¿æ¢.

#### 7.7.1 é…ç”µç›‘æµ‹å¯¹æ¥

é…ç”µç›‘æµ‹ç›®å‰å·²ä½¿ç”¨ ZLMediaKit ä»£æ›¿åŸæ¥çš„ ICC ä½œä¸ºæµåª’ä½“æœåŠ¡å™¨,å¹¶å°† NVR ä¸­çš„å½•åƒä½¿ç”¨ RTSP æ¨é€åˆ°æµåª’ä½“æœåŠ¡å™¨å¹¶è½¬æ¢æˆ mp4 æ ¼å¼, ç„¶åç”±å‰ç«¯çš„ EasyPlayer æ’­æ”¾å™¨æ’­æ”¾, ç›®å‰æ”¯æŒå®æ—¶é¢„è§ˆå’Œå†å²å›çœ‹.

å› ä¸ºç°åœ¨å·²ç»å°† NVR æ¥å…¥åˆ° WVP å¹³å°, å› æ­¤åªéœ€ç®€å•çš„ä¿®æ”¹å³å¯æ¥å…¥è§†é¢‘:

1. åœ¨é…ç”µç›‘æµ‹å¹³å°å°†æ‘„åƒå¤´çš„è®¾å¤‡å·ä¸é€šé“å·ä¸æ‘„åƒå¤´ç»‘å®š (é€šé“ç¼–å· + è®¾å¤‡ç¼–å·å”¯ä¸€ç¡®è®¤å¯ä½¿ç”¨çš„é€šé“);

   ![20241229154732_5icH1XyW.webp](https://cdn.dong4j.site/source/image/20241229154732_5icH1XyW.webp)

2. åœ¨ WVP å¹³å°ä¸­æ ¹æ®æ‘„åƒå¤´çš„è®¾å¤‡å·ä¸é€šé“å·è·å–å®æ—¶è§†é¢‘æµåœ°å€;

   ![20241229154732_M2mSNZkd.webp](https://cdn.dong4j.site/source/image/20241229154732_M2mSNZkd.webp)

   ä¸€æ¬¡è¿”å›æ‰€æœ‰èƒ½ä½¿ç”¨çš„ url, æ–¹ä¾¿å‰ç«¯å„ç§æ’­æ”¾å™¨å¯¹æ¥

3. åœ¨ WVP å¹³å°ä¸­æ ¹æ®æ‘„åƒå¤´çš„è®¾å¤‡å·ä¸é€šé“å·è·å–å½•åƒåˆ—è¡¨;

   ![20241229154732_39EelAbb.webp](https://cdn.dong4j.site/source/image/20241229154732_39EelAbb.webp)

   æ­¤æ¥å£ç”¨äºè¿”å› NVR æˆ– IPC æœ¬åœ°å­˜å‚¨å¡ä¸Šçš„å½•åƒåˆ—è¡¨

4. ä½¿ç”¨å½•åƒæ’­æ”¾æ¥å£æ’­æ”¾æœ€è¿‘çš„å½•åƒ:

   æ ¹æ®å½•åƒå¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´ç‚¹æ’­å½•åƒ.

#### 7.7.2 ä½œä¸šç®¡æ§å¹³å°å¯¹æ¥

ä½œä¸šç®¡æ§å¹³å°å¯¹æ¥åŒæ ·ä½¿ç”¨é…ç”µç›‘æµ‹å¯¹æ¥çš„é€»è¾‘, ä¸»è¦ä½¿ç”¨ä»¥ä¸‹ 3 ä¸ªæ¥å£:

1. æ ¹æ®è®¾å¤‡å·å’Œé€šé“å·è·å–å®æ—¶æ’­æ”¾ url;
2. æ ¹æ®è®¾å¤‡å·å’Œé€šé“å·è·å–å½•åƒåˆ—è¡¨;
3. æ ¹æ®è®¾å¤‡å·, é€šé“å·, å½•åƒå¼€å§‹æ—¶é—´å’Œå½•åƒç»“æŸæ—¶é—´ç‚¹æ’­å½•åƒ;

å¦‚æœéœ€è¦å¯¹çƒæœºè¿›è¡Œæ§åˆ¶, è¿˜éœ€è¦é¢å¤–æ¥å…¥çƒæœºæ§åˆ¶æ¥å£.

#### 7.7.3 å¤§å±å¯¹æ¥

å¤§å±å¯¹æ¥åˆ†ä¸ºä¸¤ç§æƒ…å†µ:

1. å¤§å±ä½¿ç”¨ä¸šåŠ¡ç³»ç»Ÿçš„æ¥å£è·å–å®æ—¶è§†é¢‘æˆ–å†å²å›çœ‹;
2. å¤§å±ç›´æ¥ä½¿ç”¨ WVP çš„æ¥å£;

ä¸Šé¢ 2 ç§æ–¹å¼å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚è‡ªè¡Œé€‰æ‹©, ä¸è¿‡å¦‚æœéœ€è¦ä½¿ç”¨ç¬¬äºŒç§æ–¹å¼, å‰ç«¯éœ€è¦ç¡®å®šè®¾å¤‡å·å’Œé€šé“å·æ˜¯å¦æ­£ç¡®;

#### 7.7.4 å°ç¨‹åºå¯¹æ¥

å°ç¨‹åºå¯¹æ¥å’Œå¤§å±å¯¹æ¥ä¸€æ ·, 2 ç§æ–¹å¼éƒ½æ”¯æŒ, ä¸è¿‡æ¨èä½¿ç”¨ç¬¬ä¸€ç§æ–¹å¼, å› ä¸ºä¸šåŠ¡ç³»ç»Ÿä¼šç»´æŠ¤è®¾å¤‡å·å’Œé€šé“å·, å°ç¨‹åºåªéœ€è¦ä½¿ç”¨è‡ªèº«çš„ä¸šåŠ¡ id å³å¯è·å–è§†é¢‘ url, æ’­æ”¾å™¨æ¨èä½¿ç”¨ HLS åè®®, æ”¯æŒ Android å’Œ iOS.

> æ€»çš„æ¥è¯´, ä¸šåŠ¡ç³»ç»Ÿæ¥å…¥ WVP è§†é¢‘æ¥å£å·¥ä½œé‡è¾ƒå°, ä¸” å¯¹ç°æœ‰ä¸šåŠ¡ç³»ç»Ÿå½±å“è¾ƒå°, æ–°çš„ä¸šåŠ¡å¯ä»¥ç›´æ¥å¯¹æ¥ WVP.

### 7.8 å¤§å±å±•ç¤º

WVP å¹³å°è‡ªå¸¦åˆ†å±å±•ç¤ºåŠŸèƒ½, ä½†æ˜¯æœ€å¤šåªæ”¯æŒ 9 åˆ†å±, å¦‚æœéœ€è¦å¢åŠ åˆ†å±æ˜¾ç¤º, ç›®å‰æœ‰ 2 ç§æ–¹å¼:

1. å¯¹ WVP è¿›è¡ŒäºŒæ¬¡å¼€å‘, å¢åŠ åˆ†å±æ•°é‡;
2. åœ¨ä¸šåŠ¡å¤§å±æ˜¯ç›´æ¥å¼€å‘åˆ†å±é¡µé¢;

å› ä¸ºåˆ†å±é€»è¾‘ç›¸å¯¹ç®€å•, æ— éå°±æ˜¯åœ¨ä¸€ä¸ªé¡µé¢ä¸Šå¤šæ”¾å‡ ä¸ªæ’­æ”¾å™¨è€Œå·², å› æ­¤ä¸Šè¿° 2 ç§æ–¹å¼éƒ½èƒ½å¤Ÿå¿«é€Ÿå®ç°, æ‰€ä»¥å¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡éœ€æ±‚è‡ªè¡Œé€‰æ‹©, æ¯”è¾ƒæ¨èçš„åšæ³•:

1. åœ¨è°ƒåº¦ä¸­å¿ƒä½¿ç”¨ WVP å¹³å°è¿›è¡Œåˆ†å±å±•ç¤º;
2. ä¸šåŠ¡å¤§å±ä½¿ç”¨è‡ªå·±çš„åˆ†å±åŠŸèƒ½å±•ç¤ºå¤šä¸ªè§†é¢‘;

## 8. è§„åˆ’

1. æ¥ç®¡æ‰€æœ‰è§†é¢‘ç›‘æ§è®¾å¤‡, åœ¨ä¸€ä¸ªå¹³å°å³å¯æŸ¥çœ‹æ‰€æœ‰è§†é¢‘ä¸å½•åƒ, å„éƒ¨é—¨é¢†å¯¼å¯é€šè¿‡è§†é¢‘å¢™å®æ—¶æŸ¥çœ‹å„é¡¹ç›®ä½œä¸šæƒ…å†µ, æ»¡è¶³å®‰å…¨å®¡è®¡è¦æ±‚;
2. é€šè¿‡ API ç®€åŒ–ä¸šåŠ¡ç³»ç»Ÿå¯¹è§†é¢‘ç›‘æ§éœ€æ±‚çš„é›†æˆ, ç¼©çŸ­å¼€å‘æ—¶é—´;

ä¸ºæ»¡è¶³ä»¥ä¸Š 2 ä¸ªç›®æ ‡, éœ€è¦ä»¥ä¸‹å‰æ:

1. è®¾å¤‡éœ€è¦æ”¯æŒ GB/T28181 åè®®;
2. è®¾å¤‡èƒ½å¤Ÿè®¿é—®åˆ°å¹³å° (é€šè¿‡å…¬ç½‘æˆ– VPN å‡å¯);
3. ä¸šåŠ¡ç³»ç»Ÿèƒ½å¤Ÿè®¿é—®è§†é¢‘æµæœåŠ¡å™¨(é€šè¿‡å…¬ç½‘æˆ– VPN å‡å¯);

**å¹³å°æ¶æ„å›¾:**

![è§„åˆ’.drawio.svg](https://cdn.dong4j.site/source/image/%E8%A7%84%E5%88%92.drawio.svg)

### 8.1 èµ„æºè§„åˆ’

#### 8.1.2 ç¡¬ä»¶èµ„æº

ç›®å‰ä½¿ç”¨ 8C 16G æœåŠ¡å™¨, åœ¨æ¥å…¥ 3 ä¸ªè®¾å¤‡, å…±è®¡ 95 è§†é¢‘é€šé“çš„æƒ…å†µä¸‹, å†…å­˜å ç”¨ 40%, å› ä¸ºæœªè¿›è¡Œä»»ä½•ç‚¹æ’­è§†é¢‘, CPU å ç”¨è¾ƒä½(CPU ä¸»è¦ç”¨äºè§†é¢‘ç¼–è§£ç ), ä¸”å› ä¸ºæ¯æ¬¡ç‚¹æ’­åä¼šå­˜å‚¨è§†é¢‘, å› æ­¤éšç€æ—¶é—´çš„æ¨ç§», ç£ç›˜å ç”¨ä¼šè¶Šæ¥è¶Šå¤§, å› æ­¤è€ƒè™‘åˆ°åæœŸæ¥å…¥çš„è®¾å¤‡æ•°é‡ä»¥åŠè§†é¢‘ä¿å­˜æ—¶é—´, åœ¨ 3 å¹´å†…çš„è‡³å°‘æ»¡è¶³ 100 è·¯è§†é¢‘çš„æ¥å…¥éœ€æ±‚ä¸‹, å¯¹ç¡¬ä»¶èµ„æºè¿›è¡Œå¦‚ä¸‹è¯„ä¼°:

##### 8.1.2.1 ç£ç›˜

###### 1. å­˜å‚¨æ–¹å¼

äº‘å‚å•†æä¾›çš„ OSS æœåŠ¡èƒ½å¤Ÿè§£å†³è¯¸å¦‚è§†é¢‘, å›¾åƒç­‰æ–‡ä»¶çš„å­˜å‚¨å’Œè°ƒå–æœåŠ¡, æ”¶è´¹ä»¥ä¾¿æŒ‰ç…§ç©ºé—´å¤§å°æ”¶è´¹, å› æ­¤è¿™é‡Œä¸è€ƒè™‘äº‘å­˜å‚¨æ–¹æ¡ˆ, ä¸€æ˜¯å› ä¸ºè§†é¢‘æ–‡ä»¶è¾ƒå¤§, å­˜å‚¨è´¹ç”¨ä¼šè¾ƒé«˜; äºŒæ˜¯è§†é¢‘è¿™ç±»æ–‡ä»¶è¾ƒä¸ºæ•æ„Ÿ, ä½¿ç”¨äº‘å­˜å‚¨æ— æ³•ä¿è¯æ•°æ®å®‰å…¨.

###### 2. å®¹é‡è¯„ä¼°

ç›®å‰ä¸šåŠ¡ä¸Šå·²ä½¿ç”¨åˆ°çš„ç›‘æ§è®¾å¤‡å¦‚ä¸‹:

1. é‡åº†åœ°é“ 15 å·çº¿é¡¹ç›®, IPC æ•°é‡ 7 ä¸ª, å†å²å½•åƒç›´æ¥å­˜å‚¨åˆ°é¡¹ç›®éƒ¨ä¸Šçš„ NVR ä¸­;
2. æ™ºæ…§å·¥åœ°é¡¹ç›®, IPC æ•°é‡ 280 ä¸ª, å†å²å½•åƒç›´æ¥å­˜å‚¨åˆ°é¡¹ç›®éƒ¨ä¸Šçš„ IVSS ä¸­;
3. é›·æ³¢çŸ¿å±±é¡¹ç›®, IPC æ•°é‡åœ¨ä¸€å¹´åè®¡åˆ’å®‰è£… 100 +, å†å²å½•åƒç›´æ¥å­˜å‚¨åˆ°é¡¹ç›®éƒ¨ä¸Šçš„ NVR ä¸­;
4. å˜ç”µç«™, åœºç«™ä¸Šçš„ IPC ç›®å‰åœ¨ç”¨çš„åªæœ‰æ˜†ä»‘å…ˆé”‹å˜ç”µç«™å’Œé“å±±å¡ä¸€å…± 10 å°, å†å²å½•åƒå­˜å‚¨åˆ°è°ƒåº¦ä¸­å¿ƒçš„ NVR ä¸­;
5. é›†å›¢å®‰å…¨ç›‘æ§é¡¹ç›®, IPC æ•°é‡ä¸º 30 å°, å†å²å½•åƒå­˜å‚¨åœ¨è®¾å¤‡çš„ TF å¡ä¸­;
6. æ‰§æ³•è®°å½•ä»ªæ•°é‡ 30 å°, å†å²å½•åƒå­˜å‚¨åœ¨è®¾å¤‡çš„ TF å¡ä¸­;
7. æ— äººæœºæ•°é‡ 8 ä¸ª, å†å²å½•åƒå­˜åœ¨è®¾å¤‡çš„ TF å¡ä¸­;

æ¥å…¥ WVP å¹³å°çš„è®¾å¤‡å½•åƒåˆ†ä¸ºä¸¤ç§æ¨¡å¼:

1. äº‘ç«¯å½•åƒ: åªæœ‰ä¸»åŠ¨æŸ¥çœ‹è®¾å¤‡å®æ—¶è§†é¢‘æ—¶æ‰ä¼šå½•åˆ¶, è§†é¢‘æ–‡ä»¶å­˜å‚¨åœ¨ WVP æœåŠ¡å™¨ä¸­;
2. è®¾å¤‡å½•åƒ: æ”¯æŒæœ¬åœ°å½•åˆ¶çš„è®¾å¤‡æ‰€å­˜å‚¨çš„å½•åƒ, å¦‚æœæ˜¯ NVR åˆ™ä¿å­˜åœ¨ NVR æœåŠ¡å™¨ä¸­, å¦‚æœæ˜¯ IPC åˆ™ä¿å­˜åœ¨ TF å¡ä¸­;

**è®¾å¤‡å½•åƒ:**

å› ä¸ºè®¾å¤‡å½•åƒéƒ½æ˜¯æ»šåŠ¨å½•åˆ¶, æ‰€ä»¥éœ€è¦è¯„ä¼°ä¸€ä¸ªä½œä¸šå‘¨æœŸå†…çš„å½•åƒå¤§å°, è¿™é‡Œè¯´æ˜ä¸€ä¸‹ IPC æ‰€éœ€è¦çš„ TF å¡å­˜å‚¨å¤§å°è¯„ä¼°æ–¹å¼:

1. ä½œä¸šæŒç»­æ—¶é—´, æ¯”å¦‚ä¸€å¤©åªå½•åˆ¶ 8 ä¸ªå°æ—¶è§†é¢‘;
2. è§†é¢‘æµç ç‡: ç ç‡è¶Šå¤§æ‰€éœ€è¦çš„å­˜å‚¨ç©ºé—´è¶Šå¤§, æ¯”å¦‚ç ç‡ä¸º 1Mbps;
3. å½•åƒå­˜å‚¨æ—¶é—´, æ¯”å¦‚æ‰§æ³•è®°å½•ä»ªéœ€è¦ä¿å­˜è‡³å°‘ 7 å¤©çš„æ•°æ®;

æŒ‰ç…§ä¸Šè¿°è¦æ±‚ä¼°ç®—æœ¬åœ°å­˜å‚¨ç©ºé—´:

`1Mbps * 1024Kbps/8 * 60 ç§’ * 60 åˆ† * 8 å°æ—¶ * 7 å¤© * 1 é€šé“/1024/1024â‰ˆ 25G`, å†åŠ ä¸Šä¸€äº›å…ƒæ•°æ®çš„å­˜å‚¨ç©ºé—´, æ‰€ä»¥å»ºè®®è‡³å°‘é…ç½® 32G çš„ TF å¡.

NVR è‡ªå¸¦ç£ç›˜é˜µåˆ—ä¸”æœ‰ä¸€å¥—å®Œå–„çš„å½•åƒå­˜å‚¨å’Œæ‰©å®¹æœºåˆ¶, å› ä¸ºä¸åŒçš„é¡¹ç›®å¯¹è§†é¢‘å‚¨å­˜çš„è¦æ±‚ä¸ä¸€æ ·, æ‰€ä»¥ NVR çš„å­˜å‚¨ç©ºé—´æœ€å¥½æ ¹æ®è‡ªèº«ä¸šåŠ¡éœ€æ±‚è®©å‚å®¶æ¨èå¹¶é…ç½®åˆç†çš„ç£ç›˜é˜µåˆ—, å› ä¸º WVP å¯¹åº”çš„éƒ½æ˜¯ **äº‘ç«¯å½•åƒ**, æ‰€ä»¥è¿™é‡Œä¸å¯¹ NVR çš„æœ¬åœ°å­˜å‚¨åšè®¨è®º.

**äº‘ç«¯å½•åƒ:**

åªæœ‰åœ¨ä¸»åŠ¨ç‚¹æ’­è§†é¢‘çš„æƒ…å†µä¸‹æ‰ä¼šè§¦å‘äº‘ç«¯å½•åƒåŠŸèƒ½, ä¸”å½•åˆ¶çš„æ–‡ä»¶ä¿å­˜åœ¨ WVP çš„æœåŠ¡å™¨ä¸­, ä¸ºäº†åœ¨æ»¡è¶³ä¸šåŠ¡éœ€æ±‚çš„å‰æä¸‹å‡å°‘ç¡¬ä»¶æŠ•å…¥, è¿™é‡Œå¯¹ WVP æ‰€éœ€çš„ç£ç›˜é˜µåˆ—è¿›è¡Œå¤§å°è¯„ä¼°:

**1. ç‚¹æ’­å½•åƒ:**

1. æŒ‰ç…§æ€»å…± 100 ä¸ªè§†é¢‘é€šé“, æ¯å¤©æŸ¥çœ‹ 10 æ¬¡, æ¯æ¬¡æŸ¥çœ‹å­˜å‚¨ 10 åˆ†é’Ÿçš„å½•åƒ;
2. æ¯ä¸ªè§†é¢‘æµç ç‡ç»Ÿä¸€ä¸º 1Mbps;
3. å½•åƒè‡³å°‘ä¿å­˜ 7 å¤©;

è®¡ç®—å…¬å¼å¦‚ä¸‹:

`1Mbps * 1024Kbps/8 * 60 ç§’ * 10 åˆ†é’Ÿ * 10 æ¬¡ * 7 å¤© * 100 é€šé“/1024/1024 â‰ˆ 512G`

**2. å½•åƒå¤‡ä»½**

åƒæ‰§æ³•è®°å½•ä»ªè¿™ç±»å…·å¤‡å½•åƒæ–‡ä»¶ä¸ŠæŠ¥çš„è®¾å¤‡, ä¼šé€šè¿‡ FTP å°†å½•åƒæ–‡ä»¶ä¸Šä¼ åˆ° WVP æœåŠ¡å™¨, è¿™ç±»è®¾å¤‡çš„æ‰€éœ€çš„ç£ç›˜å¤§å°è¯„ä¼°æ–¹å¼ä¸º:

1. ä»ä½œä¸šç®¡æ§-ä½œä¸šè®¡åˆ’ç®¡æ§-è®°å½•ä»ªå½•åƒå¯ä»¥çœ‹å‡º, 10 åˆ†é’Ÿçš„è§†å±å ç”¨ 300M;
2. æŒ‰ç…§ä¸€å¤©å·¥ä½œ 8 å°æ—¶è®¡ç®—;
3. å½•åƒè‡³å°‘ä¿å­˜ 7 å¤©;

è®¡ç®—å…¬å¼å¦‚ä¸‹:

`300M * 6 * 8 å°æ—¶ * 7 å¤© * 30 ä¸ªè®¾å¤‡/1024/1024 â‰ˆ 3T`

ç»“åˆç‚¹æ’­å½•åƒå’Œå½•åƒå¤‡ä»½çš„åœºæ™¯, è‡³å°‘åº”è¯¥å‡†å¤‡ 4T çš„ç£ç›˜, ä¸”ä¸ºäº†ä¿è¯æ•°æ®å®‰å…¨, æœ€å°‘éœ€è¦ 2 å— 4T ç»„æˆ RAID1, è‡³å°‘ä¿è¯åœ¨ä¸€å—ç£ç›˜æŸåçš„æƒ…å†µä¸‹æ•°æ®ä¸ä¼šä¸¢å¤±.

###### 3. æ‰©å®¹æ–¹å¼

ç£ç›˜é˜µåˆ—é¦–å…ˆä½¿ç”¨ 2 å— 4T ç£ç›˜ç»„æˆ RAID1:

> **RAID 1**: 2 å—ç¡¬ç›˜æˆ–ä»¥ä¸Šï¼Œåˆ©ç”¨é•œåƒæŠ€æœ¯ï¼Œåœ¨æŸå¤±ä¸è¶…è¿‡ä¸€ä¸ªæˆå‘˜ç£ç›˜æ—¶æä¾›å®¹é”™åŠŸèƒ½ã€‚
> ä¼˜åŠ¿ï¼šæ•°æ®å®‰å…¨æ€§æœ€é«˜ï¼Œä¸€å—åäº†ï¼Œå…¶å®ƒç¡¬ç›˜æœ‰å®Œæ•´æ•°æ®ï¼Œä¿éšœè¿è¡Œã€‚
> ç¼ºç‚¹ï¼šå®¹é‡ä½ï¼Œç¡¬ç›˜ä½¿ç”¨ç‡ä¸º 50%

å¯ç”¨ç©ºé—´ä¸º 4T, ä½†æ˜¯èƒ½å¤Ÿåœ¨ä¸€å—ç£ç›˜æŸåçš„æƒ…å†µä¸‹ä¿è¯æ•°æ®ä¸ä¸¢å¤±, åœ¨åæœŸå¦‚æœç£ç›˜ç©ºé—´ä¸è¶³, éœ€è¦è¿›è¡Œæ— æŸæ‰©å®¹æ¥ä¿è¯ä¸šåŠ¡çš„è¿ç»­æ€§, è¿™é‡Œç»™å‡ºå‡ ç§æ‰©å®¹æ–¹æ¡ˆ:

**æ–¹æ¡ˆä¸€:**

å¢åŠ ä¸€å— 4T ç£ç›˜, ä½¿ç”¨æ€»å…± 3 å— 4T ç£ç›˜ä» RAID1 è¿ç§»åˆ° RAID5, ç£ç›˜é˜µåˆ—å¯ç”¨å®¹é‡ä» 4T å¢åŠ åˆ° 8T;

> **RAID 5**: 3 å—ç¡¬ç›˜æˆ–ä»¥ä¸Šï¼ŒåŒæ—¶ä½¿ç”¨æ¡å¸¦å’Œå¥‡å¶æ ¡éªŒæŠ€æœ¯ã€‚æä¾›ä¸ RAID0 ç›¸ä¼¼çš„è¯»å–é€Ÿåº¦ï¼Œåœ¨æŸå¤±ä¸è¶…è¿‡ä¸€ä¸ªæˆå‘˜ç£ç›˜æ—¶ä»èƒ½æ­£å¸¸è¿è¡Œã€‚
> ä¼˜åŠ¿ï¼šRAID5 å…¼é¡¾ RAID0 ä¸ RAID1 çš„ä¼˜åŠ¿ã€‚RAID5 æœ€å°‘éœ€è¦ä¸‰å—ç¡¬ç›˜ï¼Œé€šç”¨æ˜¯ç”¨ 4 å—ç¡¬ç›˜ï¼Œå…¶ä¸­æœ‰ä¸€å—ç¡¬ç›˜ç”¨æ¥åšæ•°æ®å†—ä½™çš„ï¼Œæ¢æ–°ç¡¬ç›˜ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¿›è¡Œæ•°æ®åŒæ­¥ã€‚
> ç¼ºç‚¹ï¼šåªå…è®¸å•ç›˜æ•…éšœï¼Œä¸€ç›˜å‡ºç°æ•…éšœå°½å¿«å¤„ç†ã€‚æœ‰ç›˜åæƒ…å†µä¸‹ï¼ŒIO/CPU æ€§èƒ½ç‹‚è·Œã€‚

**æ–¹æ¡ˆäºŒ:**

å¢åŠ  2 å— 4T ç£ç›˜, ä» RAID1 è¿ç§»åˆ° RAID6;

> **RAID 6**ï¼š4 å—ç¡¬ç›˜æˆ–ä»¥ä¸Šï¼Œç±»ä¼¼ RAID5ï¼Œå¯¹æ•°æ®å®‰å…¨æ€§è¦æ±‚é«˜ï¼Œæ€§èƒ½è¦æ±‚ä¸é«˜çš„å¯é€‰æ‹©
> ä¼˜åŠ¿ï¼šRAID6 æ˜¯åœ¨ RAID5 åŸºç¡€ä¸Šä¸ºåŠ å¼ºæ•°æ®ä¿æŠ¤è€Œè®¾è®¡çš„ã€‚å¯å…è®¸æŸå 2 å—ç¡¬ç›˜
> ç¼ºç‚¹ï¼šæ€§èƒ½æå‡ä¸æ˜æ˜¾

![20241229154732_WJZluMXm.webp](https://cdn.dong4j.site/source/image/20241229154732_WJZluMXm.webp)

![20241229154732_LSPTz6Jv.webp](https://cdn.dong4j.site/source/image/20241229154732_LSPTz6Jv.webp)

##### 8.1.2.2 æœåŠ¡å™¨

**æœåŠ¡éƒ¨ç½²æ¶æ„:**

![éƒ¨ç½²æ–¹æ¡ˆ.drawio.svg](https://cdn.dong4j.site/source/image/%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88.drawio.svg)

éœ€è¦éƒ¨ç½²çš„æœåŠ¡åˆ—è¡¨:

| æœåŠ¡å       | æ‰€éœ€èµ„æº   | å¤‡æ³¨                             |
| ------------ | ---------- | -------------------------------- |
| Nginx        | 4C/1G/10G  | åå‘ä»£ç†æœåŠ¡å™¨                   |
| WVP ç®¡ç†ç³»ç»Ÿ | 4C/2G/100G | è§†é¢‘ç®¡ç†                         |
| æµåª’ä½“æœåŠ¡   | 8C/8G/200G | è§†é¢‘æµè½¬æ¢, æ‹‰æµ, æ¨æµç­‰         |
| å½•åƒæœåŠ¡     | 4C/2G/100G | ä¸æµåª’ä½“éƒ¨ç½²åœ¨ä¸€èµ·çš„ç”¨äºç‚¹æ’­å½•åƒ |
| ç¼“å­˜æœåŠ¡     | 2C/1G/10G  | WVP å’Œ æµåª’ä½“æœåŠ¡å™¨ä½¿ç”¨çš„ç¼“å­˜    |
| æ•°æ®åº“æœåŠ¡   | 8C/8G/200G | WVP ç®¡ç†ç«¯ä½¿ç”¨çš„ç»“æ„åŒ–æ•°æ®å­˜å‚¨   |

ä»¥ä¸ŠæœåŠ¡å¯ä»¥æŒ‰ç…§åŠŸèƒ½å’Œæ‰€éœ€èµ„æºå¤§å°éƒ¨ç½²åˆ° 2 å°æœåŠ¡å™¨ä¸­:

| ç¡¬ä»¶åç§°                            | é…ç½®            | å¤‡æ³¨                                        |
| ----------------------------------- | --------------- | ------------------------------------------- |
| æ•°æ®åº“ä¸ç¼“å­˜æœåŠ¡å™¨ + ç®¡ç†å¹³å°æœåŠ¡å™¨ | 32C65G 1T       | WVP ç»“æ„åŒ–æ•°æ®ä¸ç¼“å­˜æœåŠ¡ + WVP ç®¡ç†å¹³å°æœåŠ¡ |
| æµåª’ä½“æœåŠ¡å™¨                        | `32C64G *2 500G` | æµåª’ä½“æœåŠ¡å™¨                                |

#### 8.1.3 ç½‘ç»œèµ„æº

å‡è®¾åŒæ—¶æŸ¥çœ‹ 32 è·¯æ‘„åƒå¤´, åˆ†æ¯”ç‡ç»Ÿä¸€ä¸º 1080P, å¸§ç‡ä¸º 25 fps, è§†é¢‘ç¼–ç ç±»å‹ä¸º H.265, éœ€è¦çš„å¸¦å®½ä¸º:

`(1920 * 1080 * 24 ä½è‰² * 25 * 32)/300å‹ç¼©ç‡/1024/1024 * 1.3å¸¦å®½ç³»æ•° â‰ˆ 127M`

ä¸ºä¿è¯æ›´å¤šæ•°é‡çš„é€šé“åŒæ—¶æŸ¥çœ‹çš„éœ€æ±‚, æœ€å¥½ä½¿ç”¨ `200M` çš„å¸¦å®½.

**ç¡¬ä»¶æ¸…å•:**

| å“ç±»     | å‹å·           | é…ç½®                           | æ•°é‡ | å•ä»·  |
| -------- | -------------- | ------------------------------ | ---- | ----- |
| æœåŠ¡å™¨   | DELL R750XS    | 1U å…±è®¡ 16 æ ¸ 32 çº¿ç¨‹ 64G å†…å­˜ | 2    | 26499 |
| å›ºæ€ç¡¬ç›˜ | ä¼ä¸šçº§å›ºæ€     | 1.92T                          | 6    | 1500  |
| CPU      | è‡³å¼º Xeon-é“¶ç‰Œ | 16 æ ¸ 32 çº¿ç¨‹                  | 2    | 4500  |
| NAS      | ç¾¤æ™– DS923+    | `4*8T`                          | 1    | 11146 |

ä¸»æœº: DELL R750XS

CPU: 4310 2 é¢—
å†…å­˜: 16G
ç£ç›˜: `1.92T * 4`
é˜µåˆ—: H755
ç”µæº: 800W ä¸€ä¸ª

`26499 * 2 + 1500 * 6 + 4500 * 2 + 11146 = 82144`

**2023-12-18 ä»Šæ—¥æœ€æ–°ä»·æ ¼, æœåŠ¡å™¨ 2U + å›ºæ€ç¡¬ç›˜, å•å° 37000 å…ƒ**, å› æ­¤æ€»ä»·æ ¼å˜æ›´ä¸º: `37000 * 2 + 11146 = 85146 å…ƒ`

åæœŸä¼˜åŒ–æ–¹æ¡ˆ:

| ä¼ä¸šäº¤æ¢æœº     | åä¸ºäº¤æ¢æœºä¸‡å…†ä¸‰å±‚æ ¸å¿ƒ S5731S-S24T4X-A | 24 å£åƒå…†ç”µ 4 å£ä¸‡å…†å…‰æ±‡èšå…¨ç½‘ç®¡   | 1   | 8640  |
| -------------- | -------------------------------------- | ---------------------------------- | --- | ----- |
| ä¼ä¸šé˜²ç«å¢™     | åä¸ºä¼ä¸šçº§é˜²ç«å¢™ USG6315E-AC           | å¸¦æœº 600|åå 1G|æ”¯æŒ 500 æ¡ VPN | 1   | 19999 |
| æœåŠ¡å™¨ä¸‡å…†ç½‘å¡ | X710                                   | è‹±ç‰¹å°” X710 åŒç«¯å£ 10GB (ç”µå£)     | 2   | 1599  |
| NAS-ä¸‡å…†ç½‘å¡   | NAS ä¸“ç”¨ RJ45 ä¸‡å…†å•ç”µå£ç½‘å¡           | 10GB                               | 1   | 1160  |

#### 8.1.4 ç½‘ç»œæ‹“æ‰‘å›¾

æ–¹æ¡ˆä¸€:

![20241229154732_luDJhvo9.webp](https://cdn.dong4j.site/source/image/20241229154732_luDJhvo9.webp)

##### æ–¹æ¡ˆäºŒ

ä½¿ç”¨ä¸‡å…†äº¤æ¢æœºç»„ä¸‡å…†å±€åŸŸç½‘

![20241229154732_R2loOIvu.webp](https://cdn.dong4j.site/source/image/20241229154732_R2loOIvu.webp)

1. å› ä¸ºè§†é¢‘å­˜å‚¨æ–‡ä»¶è¾ƒå¤§, ä¸ºåŠ å¿«æ–‡ä»¶è®¿é—®é€Ÿåº¦ä»¥æå‡æœåŠ¡ä½“éªŒ, å†…ç½‘ä½¿ç”¨ä¸‡å…†é€šè®¯, éœ€è¦åˆ†åˆ«ä¸ºæœåŠ¡å™¨å’Œ NAS æ·»åŠ ä¸‡å…†ç½‘å¡. å¸‚é¢ä¸Šä¸‡å…†ç”µå£çš„äº¤æ¢å™¨è¾ƒå°‘, ä¸”ç”µå£å‘çƒ­é‡å¤§, ç›®å‰é€‰ç”¨ä¸‡å…†å…‰å£äº¤æ¢æœº; NAS åªæ”¯æŒä¸‡å…†ç”µå£ç½‘å¡, å› æ­¤éœ€è¦å¢åŠ ä¸€ä¸ªä¸‡å…†å…‰è½¬ç”µå£; 2 å°æœåŠ¡å™¨ä½¿ç”¨ä¸‡å…†å…‰å£æ¥å…¥äº¤æ¢æœº.
2. å…¶ä»–åƒå…†å£ç”¨äºæ¥å…¥å…¶ä»–å®¢æˆ·ç«¯;
3. æµåª’ä½“æœåŠ¡å™¨é€šè¿‡ä¸‡å…†äº¤æ¢æœºå°†è§†é¢‘æ–‡ä»¶å­˜å‚¨åˆ° NAS;

##### æ–¹æ¡ˆä¸‰

ä½¿ç”¨åƒå…†äº¤æ¢æœº, å°èŒƒå›´ç»„ä¸‡å…†å†…ç½‘

![20241229154732_BcMLwJMa.webp](https://cdn.dong4j.site/source/image/20241229154732_BcMLwJMa.webp)

1. ä½¿ç”¨ NAS è‡ªå¸¦åƒå…†ç½‘å£å’Œ 2 å°æœåŠ¡å™¨é€šè¿‡åƒå…†äº¤æ¢æœºç»„æˆå±€åŸŸç½‘, å…¶ä»–å®¢æˆ·ç«¯é€šè¿‡äº¤æ¢æœºä¸æœåŠ¡å™¨å’Œ NAS è¿æ¥;
2. å†…éƒ¨ä½¿ç”¨ä¸‡å…†ç½‘å¡ç›´è¿, è®©æœåŠ¡å™¨å’Œ NAS ä¹‹é—´ç»„æˆå†…éƒ¨ç½‘ç»œ, åŠ å¿«æ–‡ä»¶ä¼ è¾“é€Ÿåº¦;

**æ–¹æ¡ˆäºŒ** æ¯” **æ–¹æ¡ˆä¸‰** ç»„ç½‘æ–¹å¼ç®€å•, ä½†æ˜¯ä»·æ ¼ä¸”å¤šå‡ºä¸€ä¸ªå…‰è½¬ç”µæ¥å£, æ•´ä½“ä»·æ ¼è¾ƒæ–¹æ¡ˆäºŒè´µ.

NAS è§†é¢‘å¤‡ä»½:

![20241229154732_H6Nvn6Vz.webp](https://cdn.dong4j.site/source/image/20241229154732_H6Nvn6Vz.webp)

![20241229154732_HZQ9jRyE.webp](https://cdn.dong4j.site/source/image/20241229154732_HZQ9jRyE.webp)

![20241229154732_nAOChXlw.webp](https://cdn.dong4j.site/source/image/20241229154732_nAOChXlw.webp)

ç¾¤æ™– DS923+ è‡ªå¸¦ 2 ä¸ªåƒå…†ç½‘å£, å¯å†æ‰©å±•ä¸€ä¸ªä¸‡å…†ç½‘å¡.

æœåŠ¡å™¨:

![20241229154732_b9ikqzmd.webp](https://cdn.dong4j.site/source/image/20241229154732_b9ikqzmd.webp)

## è„‘å›¾

![20241229154732_kego3KSs.webp](https://cdn.dong4j.site/source/image/20241229154732_kego3KSs.webp)

## [IDEAæ’ä»¶å¼€å‘ä¸­çš„å›½é™…åŒ–é…ç½®å®è·µï¼šè½»é‡çº§ResourceBundleåº”ç”¨](https://blog.dong4j.site/posts/c1e0543.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ç¼˜èµ·

æœ€è¿‘ä¸€æ®µæ—¶é—´åœ¨å¼€å‘ IDEA æ’ä»¶, UI ç•Œé¢éœ€è¦ä½¿ç”¨åˆ°å›½é™…åŒ–é…ç½®, äºæ˜¯å°±çœ‹äº†çœ‹ IDEA æ˜¯æ€ä¹ˆå®ç°çš„, å‘ç°å¾ˆç®€å•, æ­£å¥½èƒ½ç”¨åˆ°æ¡†æ¶å¼€å‘ä¸Š.

æ‰“ç®—ä¸ºæ¯ä¸ª `atom-kernel` æ¨¡å—é…ç½®ä¸€ä¸ªå›½é™…åŒ–é…ç½®, åŒæ—¶å°†é”™è¯¯ä¿¡æ¯é…ç½®åŒ–. å› ä¸ºæ˜¯æ¡†æ¶åº•å±‚çš„ç»„ä»¶, å¦‚æœä½¿ç”¨ Spring Boot çš„ i18n å®ç°å°±å¤ªé‡äº†, å› æ­¤éœ€è¦ä¸€ç§è¶…è½»é‡çº§çš„å®ç°æ–¹å¼.

## IDEA ä¸­å¦‚ä½•å®ç° i18n

IDEA ä½¿ç”¨ `ResourceBundle` è¿™ä¸ªç±»å®ç°äº† i18n, æºç å¦‚ä¸‹:

```java
/**
 * ç‰¹å®šä½œç”¨åŸŸæ†ç»‘åŒ…çš„åŸºç±»ï¼ˆä¾‹å¦‚â€œvcsâ€æ†ç»‘åŒ…ã€â€œaopâ€æ†ç»‘åŒ…ç­‰ï¼‰ã€‚
 * ä½¿ç”¨æ¨¡å¼ï¼š
 * åˆ›å»ºä¸€ä¸ªæ‰©å±•è¯¥ç±»å¹¶ä¸ºå½“å‰ç±»æ„é€ å‡½æ•°æä¾›ç›®æ ‡bundleè·¯å¾„çš„ç±»ï¼›
 * å¯é€‰åœ°åœ¨å­ç±»ä¸­åˆ›å»ºé™æ€facadeæ–¹æ³•-åˆ›å»ºå•ä¸ªå…±äº«å®ä¾‹å¹¶å§”æ‰˜ç»™å®ƒçš„getMessageï¼ˆStringï¼ŒObjectâ€¦ï¼‰
 *
 * @author Denis Zhdanov
 */
public abstract class AbstractBundle {
  private static final Logger LOG = Logger.getInstance("#com.intellij.AbstractBundle");
  private Reference<ResourceBundle> myBundle;
  @NonNls private final String myPathToBundle;

  protected AbstractBundle(@NonNls @NotNull String pathToBundle) {
    myPathToBundle = pathToBundle;
  }

  @NotNull
  public String getMessage(@NotNull String key, @NotNull Object... params) {
    // CommonBundle.message() ä¸»è¦ç”¨äºå‚æ•°æ›¿æ¢ä¸ç©ºå€¼å¤„ç†, å¿«æ·é”®æ ‡è¯†ç­‰
    return CommonBundle.message(getBundle(), key, params);
  }

  private ResourceBundle getBundle() {
    ResourceBundle bundle = com.intellij.reference.SoftReference.dereference(myBundle);
    if (bundle == null) {
      bundle = getResourceBundle(myPathToBundle, getClass().getClassLoader());
      myBundle = new SoftReference<>(bundle);
    }
    return bundle;
  }

  private static final Map<ClassLoader, Map<String, ResourceBundle>> ourCache =
    ConcurrentFactoryMap.createWeakMap(k -> ContainerUtil.createConcurrentSoftValueMap());

  /**
   * ä½¿ç”¨ ResourceBundle.Control æ¥å®ç° i18n
   */
  public static ResourceBundle getResourceBundle(@NotNull String pathToBundle, @NotNull ClassLoader loader) {
    Map<String, ResourceBundle> map = ourCache.get(loader);
    ResourceBundle result = map.get(pathToBundle);
    if (result == null) {
      try {
        ResourceBundle.Control control = ResourceBundle.Control.getControl(ResourceBundle.Control.FORMAT_PROPERTIES);
        result = ResourceBundle.getBundle(pathToBundle, Locale.getDefault(), loader, control);
      }
      catch (MissingResourceException e) {
        LOG.info("Cannot load resource bundle from *.properties file, falling back to slow class loading: " + pathToBundle);
        ResourceBundle.clearCache(loader);
        result = ResourceBundle.getBundle(pathToBundle, Locale.getDefault(), loader);
      }
      map.put(pathToBundle, result);
    }
    return result;
  }
}
```

**å®ç°è‡ªå·±çš„ Bundle ç±»:**

```java
public class IdeBundle extends AbstractBundle {
  public static String message(@NotNull @PropertyKey(resourceBundle = BUNDLE) String key, @NotNull Object... params) {
    return INSTANCE.getMessage(key, params);
  }

  public static final String BUNDLE = "messages.IdeBundle";
  private static final IdeBundle INSTANCE = new IdeBundle();

  private IdeBundle() {
    super(BUNDLE);
  }
}
```

**æ·»åŠ é…ç½®æ–‡ä»¶:**

è¿˜éœ€è¦åœ¨ classpath ä¸­æ·»åŠ ä¸€ä¸ª messages ç›®å½•, ç„¶åæ·»åŠ  `IdeBundle.properties` é…ç½®æ–‡ä»¶, æˆ–è€…å¯ä»¥ç›´æ¥ä½¿ç”¨ IDEA æ–°å¢èµ„æºåŒ…, éœ€è¦æ³¨æ„çš„æ˜¯, `messages.IdeBundle` è¡¨ç¤ºåœ¨ `messages` ç›®å½•ä¸‹çš„ `IdeBundle.properties` æ–‡ä»¶, ä¸€å®šä¸èƒ½é”™:

```properties
error.malformed.url=Malformed url: {0}
browsers.explorer=Internet Explorer
```

**ä½¿ç”¨æ–¹å¼:**

```java
# æœ‰å ä½ç¬¦çš„
IdeBundle.message("error.malformed.url", "xxx")
# æ— å ä½ç¬¦
IdeBundle.message("browsers.explorer")
```

ä»ä¸Šé¢å¯ä»¥çœ‹å‡º, ç›´æ¥ JDK è‡ªå¸¦çš„ `ResourceBundle` ç±»å®ç°äº†å›½é™…åŒ–å’Œå ä½ç¬¦æ›¿æ¢çš„åŠŸèƒ½, åˆšå¥½ç¬¦åˆæˆ‘çš„è¦æ±‚, å› æ­¤æ‰“ç®—ä½¿ç”¨è¿™ç§æ–¹å¼æ¥å®ç°ä¸€ä¸‹.

## å®ç°é€»è¾‘

æˆ‘éœ€è¦çš„åŠŸèƒ½:

1. å›½é™…åŒ–;
2. å ä½ç¬¦æ›¿æ¢;

IDEA çš„ `AbstractBundle` æœ‰å¾ˆå¤šæˆ‘ä¸éœ€è¦çš„åŠŸèƒ½, åšäº†ä¸€äº›ç®€å•çš„ä¿®æ”¹åå®Œå…¨ç¬¦åˆæˆ‘çš„è¦æ±‚:

```java
@Slf4j
public abstract class AbstractBundle {
    private static final Map<ClassLoader, Map<String, ResourceBundle>> CACHE =
            ConcurrentFactoryMap.createWeakMap(k -> new ConcurrentSoftValueHashMap<>());
    @NonNls
    private final String myPathToBundle;
    private Reference<ResourceBundle> myBundle;

    @Contract(pure = true)
    protected AbstractBundle(@NonNls @NotNull String pathToBundle) {
        this.myPathToBundle = pathToBundle;
    }

    /**
     * è·å–å»¶è¿ŸåŠ è½½çš„å­—ç¬¦ä¸²
     *
     * @param key    é”®
     * @param params å‚æ•°
     * @return Supplierå­—ç¬¦ä¸²
     */
    @NotNull
    public Supplier<String> getLazyMessage(@NotNull String key, Object... params) {
        return () -> this.getMessage(key, params);
    }

    /**
     * è·å–å­—ç¬¦ä¸²
     *
     * @param key    é”®
     * @param params å‚æ•°
     * @return å­—ç¬¦ä¸²
     */
    @NotNull
    public String getMessage(@NotNull String key, Object... params) {
        return message(this.getResourceBundle(), key, params);
    }

    /**
     * è·å–æœ¬åœ°åŒ–å­—ç¬¦ä¸²
     *
     * @param bundle èµ„æºåŒ…
     * @param key    é”®
     * @param params å‚æ•°
     * @return å­—ç¬¦ä¸²
     */
    @Nls
    @NotNull
    public static String message(@NotNull ResourceBundle bundle, @NotNull String key, Object... params) {
        return messageOrDefault(bundle, key, null, params);
    }

    /**
     * è·å–èµ„æºåŒ…
     *
     * @return èµ„æºåŒ…
     */
    public ResourceBundle getResourceBundle() {
        ResourceBundle bundle = SoftReference.dereference(this.myBundle);
        if (bundle == null) {
            bundle = this.getResourceBundle(this.myPathToBundle, this.getClass().getClassLoader());
            this.myBundle = new SoftReference<>(bundle);
        }
        return bundle;
    }

    /**
     * è·å–èµ„æºåŒ…
     *
     * @param pathToBundle èµ„æºåŒ…è·¯å¾„
     * @param loader       ç±»åŠ è½½å™¨
     * @return èµ„æºåŒ…
     */
    @NotNull
    public ResourceBundle getResourceBundle(@NotNull String pathToBundle, @NotNull ClassLoader loader) {
        Map<String, ResourceBundle> map = CACHE.get(loader);
        ResourceBundle result = map.get(pathToBundle);
        if (result == null) {
            try {
                ResourceBundle.Control control = ResourceBundle.Control.getControl(ResourceBundle.Control.FORMAT_PROPERTIES);
                result = this.findBundle(pathToBundle, loader, control);
            } catch (MissingResourceException e) {
                log.info("æ— æ³•ä» *.properties æ–‡ä»¶ä¸­åŠ è½½èµ„æºåŒ…ï¼Œé™çº§ä¸ºæ…¢çš„ç±»åŠ è½½ï¼š " + pathToBundle);
                ResourceBundle.clearCache(loader);
                result = ResourceBundle.getBundle(pathToBundle, Locale.getDefault(), loader);
            }
            map.put(pathToBundle, result);
        }
        return result;
    }

    /**
     * æŸ¥æ‰¾èµ„æºåŒ…
     *
     * @param pathToBundle èµ„æºåŒ…è·¯å¾„
     * @param loader       ç±»åŠ è½½å™¨
     * @param control      æ§åˆ¶
     * @return èµ„æºåŒ…
     */
    protected ResourceBundle findBundle(@NotNull String pathToBundle, @NotNull ClassLoader loader,
                                        @NotNull ResourceBundle.Control control) {
        return ResourceBundle.getBundle(pathToBundle, Locale.getDefault(), loader, control);
    }

    /**
     * è·å–æœ¬åœ°åŒ–å­—ç¬¦ä¸²æˆ–é»˜è®¤å€¼
     *
     * @param bundle       èµ„æºåŒ…
     * @param key          é”®
     * @param defaultValue é»˜è®¤å€¼
     * @param params       å‚æ•°
     * @return å­—ç¬¦ä¸²
     */
    public static String messageOrDefault(@Nullable ResourceBundle bundle,
                                          @NotNull String key,
                                          @Nullable String defaultValue,
                                          @NotNull Object... params) {
        if (bundle != null) {
            String value;
            try {
                value = bundle.getString(key);
            } catch (MissingResourceException e) {
                value = useDefaultValue(bundle, key, defaultValue);
            }
            return postprocessValue(bundle, value, params);
        }

        return defaultValue;
    }

    /**
     * ä½¿ç”¨é»˜è®¤å€¼
     *
     * @param bundle       èµ„æºåŒ…
     * @param key          é”®
     * @param defaultValue é»˜è®¤å€¼
     * @return å­—ç¬¦ä¸²
     */
    @NotNull
    static String useDefaultValue(ResourceBundle bundle, @NotNull String key, @Nullable String defaultValue) {
        if (defaultValue != null) {
            return defaultValue;
        }

        log.error("åœ¨èµ„æºåŒ…ä¸­ {} æœªæ‰¾åˆ°é”®: [{}]", bundle.getBaseBundleName(), key);
        return StringPool.NULL_STRING;
    }

    /**
     * åå¤„ç†å€¼
     *
     * @param bundle èµ„æºåŒ…
     * @param value  å€¼
     * @param params å‚æ•°
     * @return åå¤„ç†åçš„å€¼
     */
    static String postprocessValue(@NotNull ResourceBundle bundle, @NotNull String value, @NotNull Object @NotNull [] params) {
        if (params.length > 0 && value.indexOf('{') >= 0) {
            if (value.contains("{0")) {
                Locale locale = bundle.getLocale();
                try {
                    MessageFormat format = locale != null ? new MessageFormat(value, locale) : new MessageFormat(value);
                    OrdinalFormat.apply(format);
                    value = format.format(params);
                } catch (IllegalArgumentException e) {
                    value = "!format é”™è¯¯: `" + value + "`!";
                }
            } else {
                value = StrFormatter.format(value, params);
            }
        }

        return value;
    }
}
```

åˆ›å»ºç»‘å®šç±»:

```java
public final class CoreBundle extends DynamicBundle {
    @NonNls
    private static final String BUNDLE = "i18n.CoreBundle";
    private static final CoreBundle INSTANCE = new CoreBundle();

    @Contract(pure = true)
    private CoreBundle() {
        super(BUNDLE);
    }

    @NotNull
    public static String message(@NotNull String key, Object... params) {
        return INSTANCE.getMessage(key, params);
    }

    public static @NotNull Supplier<String> messagePointer(@NotNull String key, Object... params) {
        return INSTANCE.getLazyMessage(key, params);
    }
}

```

ä¸Šé¢çš„ä»£ç åŸºæœ¬ä¸Šæ˜¯å›ºå®šçš„å†™æ³•, åªéœ€è¦ä¿®æ”¹ `BUNDLE` å³å¯, ç„¶ååˆ›å»ºå›½é™…åŒ–é…ç½®æ–‡ä»¶:

![20241229154732_JF2bLLEZ.webp](https://cdn.dong4j.site/source/image/20241229154732_JF2bLLEZ.webp)

**æµ‹è¯•ä¸€ä¸‹:**

```java
@Slf4j
class CoreBundleTest {
    @Test
    void test_1() {
      	// æœ‰å ä½ç¬¦ä½†æ˜¯æ²¡æœ‰å‚æ•°, å ä½ç¬¦åŸæ ·è¾“å‡º
        log.info("{}", CoreBundle.message("code.param.verify.error"));
      	// ä¸å­˜åœ¨çš„ key
        log.info("{}", CoreBundle.message("aaa"));
      	// æ­£å¸¸è¾“å‡º
        log.info("{}", CoreBundle.messagePointer("code.param.verify.error", "aaaaa").get());
    }
}
```

è¾“å‡º:

```
[main] INFO io.github.atom.kernel.core.CoreBundleTest - å‚æ•°æ ¡éªŒå¤±è´¥: [{}]
[main] ERROR io.github.atom.kernel.core.bundle.AbstractBundle - åœ¨èµ„æºåŒ… [i18n.CoreBundle] æœªæ‰¾åˆ°é”®: [aaa]
[main] INFO io.github.atom.kernel.core.CoreBundleTest - N/A
[main] INFO io.github.atom.kernel.core.CoreBundleTest - å‚æ•°æ ¡éªŒå¤±è´¥: [aaaaa]
```

## [é€šç”¨çš„å‘Šè­¦é€šçŸ¥æ–¹æ¡ˆè®¾è®¡](https://blog.dong4j.site/posts/ca466aa0.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

> ç›‘æ§å‘Šè­¦æ¨¡å—ç”¨äºå®æ—¶ç›‘æ§å„ç±»è®¾å¤‡æ•°æ®ï¼Œé€šè¿‡é‡‡é›†ã€åˆ†æå’Œå¤„ç†æ•°æ®ï¼Œç”Ÿæˆæœ‰ä»·å€¼çš„æŒ‡æ ‡å’Œè­¦æŠ¥ä¿¡æ¯ï¼Œå¹¶å‘ç®¡ç†å‘˜å‘é€é€šçŸ¥ï¼Œç¡®ä¿ä¸šåŠ¡ç¨³å®šè¿è¡Œã€‚

### 1.1 ç›®æ ‡

ç›‘æ§å‘Šè­¦æ¨¡å—ç”¨äºå®æ—¶ç›‘æ§å„ç±»è®¾å¤‡æ•°æ®ï¼Œé€šè¿‡é‡‡é›†ã€åˆ†æå’Œå¤„ç†æ•°æ®ï¼Œç”Ÿæˆæœ‰ä»·å€¼çš„æŒ‡æ ‡å’Œè­¦æŠ¥ä¿¡æ¯ï¼Œå¹¶å‘ç®¡ç†å‘˜å‘é€é€šçŸ¥ï¼Œç¡®ä¿ä¸šåŠ¡ç¨³å®šè¿è¡Œã€‚

- **ä¿æŒä¸šåŠ¡ç¨³å®šï¼š**ç›‘æ§å‘Šè­¦æ¨¡å—éœ€è¦å®æ—¶ç›‘æ§è®¾å¤‡è¿è¡ŒçŠ¶æ€ï¼Œå¹¶èƒ½å¤ŸåŠæ—¶å‘ç°é—®é¢˜å’Œå¼‚å¸¸æƒ…å†µï¼ŒåŠæ—¶å‘å‡ºå‘Šè­¦é€šçŸ¥å¹¶è¿…é€Ÿå“åº”å¼‚å¸¸ï¼Œä»¥ä¾¿ç®¡ç†å‘˜é‡‡å–åŠæ—¶æªæ–½ã€‚
- **æ”¹å–„æœåŠ¡è´¨é‡ï¼š**ç›‘æ§å‘Šè­¦æ¨¡å—æ”¯æŒå¯¹è®¾å¤‡æ•°æ®è¿›è¡Œé‡‡é›†å’Œåˆ†æï¼Œç”Ÿæˆæœ‰ä»·å€¼çš„æŒ‡æ ‡å’Œè­¦æŠ¥ä¿¡æ¯ï¼ŒåŠæ—¶å‘ç°å¹¶è§£å†³é—®é¢˜ï¼Œé¿å…ç”¨æˆ·å—åˆ°å½±å“ï¼Œæé«˜ç”¨æˆ·ä½“éªŒã€‚ä¾‹å¦‚é€šè¿‡ç›‘æ§è®¾å¤‡çš„åœ¨çº¿ç‡ï¼Œå½“å‡ºç°å¤§è§„æ¨¡çš„è®¾å¤‡ç¦»çº¿æ—¶ï¼Œèƒ½ç¬¬ä¸€æ—¶é—´ä»‹å…¥è§£å†³é—®é¢˜ï¼Œé¿å…è®¾å¤‡å› æ•…éšœå¯¼è‡´å®¢æˆ·ä¸šåŠ¡å—é˜»ã€‚

### 1.2 åŠŸèƒ½

![111.drawio.svg](https://cdn.dong4j.site/source/image/111.drawio.svg)

ä¸»è¦åŒ…æ‹¬æ•°æ®é‡‡é›†ã€æ•°æ®åˆ†æã€å‘Šè­¦é€šçŸ¥ã€å‘Šè­¦å¤„ç†ã€æ•°æ®å±•ç¤ºã€æ•°æ®ç®¡ç†ç•Œé¢ç­‰å¤šä¸ªåŠŸèƒ½æ¨¡å—ã€‚

- **æ•°æ®é‡‡é›†ï¼š**è´Ÿè´£é‡‡é›†å„ä¸ªæ¨¡å—çš„æ•°æ®ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºä¸šåŠ¡å¹³å°ç³»ç»Ÿã€DBã€è®¾å¤‡ç­‰çš„æ•°æ®ã€‚é‡‡é›†çš„æ•°æ®ä¼šå­˜å‚¨åˆ°å¯¹åº”çš„æ•°æ®åº“ä¸­ï¼Œä¾›åç»­åˆ†æä½¿ç”¨ã€‚
- **æ•°æ®åˆ†æï¼š**è´Ÿè´£å¯¹é‡‡é›†åˆ°çš„æ•°æ®è¿›è¡Œå¤„ç†ã€åˆ†æå’Œè®¡ç®—ï¼Œä»è€Œå¾—å‡ºæœ‰ä»·å€¼çš„æŒ‡æ ‡å’Œè­¦æŠ¥ä¿¡æ¯ã€‚æ•°æ®å¤„ç†æ¨¡å—åŒ…æ‹¬æ•°æ®åˆ†æã€å‘Šè­¦è§„åˆ™å’Œç®—æ³•ç­‰å­æ¨¡å—ã€‚
- **å‘Šè­¦é€šçŸ¥ï¼š**è´Ÿè´£å‘ç®¡ç†å‘˜/å…¶ä»–ç³»ç»Ÿå‘é€æ•°æ®åˆ†ææ¨¡å—ç”Ÿæˆçš„è­¦æŠ¥é€šçŸ¥ï¼ŒåŒ…æ‹¬çŸ­ä¿¡ã€é‚®ä»¶ã€å³æ—¶æ¶ˆæ¯ç­‰å¤šç§å½¢å¼ã€‚ç®¡ç†å‘˜å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚ï¼Œé€‰æ‹©æ¥æ”¶å‘Šè­¦é€šçŸ¥çš„æ–¹å¼å’Œé€šçŸ¥äººã€‚
- **å‘Šè­¦å¤„ç†ï¼š**è´Ÿè´£è®°å½•å‘Šè­¦ä¿¡æ¯çš„å¤„ç†æƒ…å†µï¼ŒåŒ…æ‹¬å‘Šè­¦ä¿¡æ¯çš„å¤„ç†èŠ‚ç‚¹ã€æ˜¯å¦å·²ç»è¢«å¤„ç†ã€å¤„ç†ç»“æœå¦‚ä½•ç­‰ã€‚ç®¡ç†å‘˜åœ¨æ”¶åˆ°å‘Šè­¦é€šçŸ¥åï¼Œé‡‡å–æªæ–½è§£å†³é—®é¢˜ï¼Œå¹¶å°†å¤„ç†æƒ…å†µè®°å½•ï¼Œä»¥ä¾¿åç»­åˆ†æå’Œè·Ÿè¸ªã€‚
- **æ•°æ®å±•ç¤ºï¼š**è´Ÿè´£å°†ç›‘æ§æ•°æ®ä»¥åŠåˆ†æç»“æœä»¥ Dashboard çš„å½¢å¼å±•ç¤ºå‡ºæ¥ï¼Œå¸®åŠ©ç®¡ç†å‘˜æ›´ç›´è§‚åœ°äº†è§£è®¾å¤‡/åœºç«™ç­‰çš„è¿è¡ŒçŠ¶å†µã€‚
- **ç®¡ç†ç•Œé¢ï¼š**æä¾›ç›‘æ§å‘Šè­¦çš„ç®¡ç†ç•Œé¢ï¼Œç®¡ç†å‘˜å¯ä»¥é€šè¿‡è¯¥ç•Œé¢è¿›è¡Œè­¦æŠ¥è®¾ç½®ã€æ•°æ®æŸ¥çœ‹ç­‰æ“ä½œã€‚ç®¡ç†å‘˜å¯ä»¥åœ¨è¯¥ç•Œé¢ä¸­è®¾ç½®é¢„è­¦é˜ˆå€¼ç­‰å‚æ•°ï¼Œç”¨äºæ•°æ®åˆ†ææ¨¡å—çš„åˆ¤æ–­æ ‡å‡†ã€‚

## 2. å‘Šè­¦è§„åˆ™(æ¡ä»¶)

å‘Šè­¦è§„åˆ™éœ€è¦ç»“åˆä¸šåŠ¡éœ€æ±‚ï¼Œé€šè¿‡å¯¹ç›‘æ§æŒ‡æ ‡è¿›è¡Œåˆ†æå’Œæ¯”å¯¹ï¼Œåˆ¤æ–­å½“å‰çŠ¶æ€æ˜¯å¦æ­£å¸¸ï¼Œå¹¶ç”Ÿæˆç›¸åº”çš„å‘Šè­¦ä¿¡æ¯çš„è§„åˆ™ã€‚å‘Šè­¦è§„åˆ™éœ€è¦è€ƒè™‘å¤šä¸ªå› ç´ ï¼Œå¦‚ç›‘æ§æŒ‡æ ‡çš„å˜åŒ–è¶‹åŠ¿ã€é˜ˆå€¼è®¾å®šã€å‘Šè­¦çº§åˆ«ã€å‘Šè­¦é€šçŸ¥æ–¹å¼ç­‰ã€‚å¸¸ç”¨çš„å‘Šè­¦è§„åˆ™æœ‰ï¼š

1. **é˜ˆå€¼å‘Šè­¦è§„åˆ™ï¼š**è¯¥è§„åˆ™æ ¹æ®ç›‘æ§æŒ‡æ ‡çš„é˜ˆå€¼æ¥è§¦å‘è­¦æŠ¥ï¼Œä¾‹å¦‚ï¼Œæ¸©åº¦é«˜äºé˜ˆå€¼æ—¶ï¼Œå°±ä¼šè§¦å‘è­¦æŠ¥ï¼Œå¹¶é€šçŸ¥ç›¸å…³äººå‘˜å’Œéƒ¨é—¨ã€‚
2. **æŒç»­æ—¶é—´å‘Šè­¦è§„åˆ™ï¼š**è¯¥è§„åˆ™æ ¹æ®ç›‘æ§æŒ‡æ ‡çš„æŒç»­æ—¶é—´æ¥è§¦å‘è­¦æŠ¥ï¼Œä¾‹å¦‚ï¼Œå½“åœ¨çº¿è®¾å¤‡æ•…éšœç‡è¶…è¿‡äº†é˜ˆå€¼ï¼Œå¹¶æŒç»­ 5 åˆ†é’Ÿä»¥ä¸Šæ—¶ï¼Œå°±ä¼šè§¦å‘è­¦æŠ¥ï¼Œå¹¶é€šçŸ¥ç›¸å…³äººå‘˜å’Œéƒ¨é—¨ã€‚
3. **æ¨¡å¼å‘Šè­¦è§„åˆ™ï¼š**è¯¥è§„åˆ™æ ¹æ®ç›‘æ§æŒ‡æ ‡çš„æ¨¡å¼å’Œè¶‹åŠ¿æ¥è§¦å‘è­¦æŠ¥ï¼Œä¾‹å¦‚ï¼Œå½“åœ¨çº¿è®¾å¤‡çš„å¯ç”¨ç‡åœ¨ä¸€æ®µæ—¶é—´å†…ä¸€ç›´å¤„äºä¸‹é™è¶‹åŠ¿æ—¶ï¼Œå°±ä¼šè§¦å‘è­¦æŠ¥ï¼Œå¹¶é€šçŸ¥ç›¸å…³äººå‘˜å’Œéƒ¨é—¨ã€‚
4. **ç»„åˆå‘Šè­¦è§„åˆ™ï¼š**è¯¥è§„åˆ™æ˜¯å°†å¤šä¸ªå‘Šè­¦è§„åˆ™è¿›è¡Œç»„åˆï¼Œå½“æ»¡è¶³å…¶ä¸­ä¸€ä¸ªæˆ–å¤šä¸ªè§„åˆ™æ—¶ï¼Œå°±ä¼šè§¦å‘è­¦æŠ¥ï¼Œå¹¶é€šçŸ¥ç›¸å…³äººå‘˜å’Œéƒ¨é—¨ã€‚
5. **å®šæ—¶å‘Šè­¦è§„åˆ™ï¼š**è¯¥è§„åˆ™æ ¹æ®æ—¶é—´è®¾ç½®æ¥è§¦å‘è­¦æŠ¥ï¼Œä¾‹å¦‚ï¼Œæ¯å¤©ä¸‹åˆ 4 ç‚¹æ—¶ï¼Œå¯¹è®¾å¤‡è¿›è¡Œä¸€æ¬¡å·¡æ£€ï¼Œè‹¥å‘ç°å¼‚å¸¸ï¼Œåˆ™è§¦å‘è­¦æŠ¥ï¼Œå¹¶é€šçŸ¥ç›¸å…³äººå‘˜å’Œéƒ¨é—¨ã€‚
6. **åŸºäºäº‹ä»¶çš„å‘Šè­¦è§„åˆ™ï¼š** åŸºäºäº‹ä»¶çš„å‘Šè­¦è§„åˆ™å¯ä»¥æ ¹æ®äº‹ä»¶çš„å‘ç”Ÿæ¥è§¦å‘è­¦æŠ¥ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡å¯¹è®¾å¤‡çŠ¶æ€æ•°æ®çš„ç›‘æµ‹ï¼Œå½“å‡ºç°è®¾å¤‡å¼‚å¸¸æ•…éšœè¿™äº›äº‹ä»¶æ—¶ï¼Œå¯ä»¥è‡ªåŠ¨è§¦å‘è­¦æŠ¥ï¼Œå¹¶é€šçŸ¥ç›¸å…³äººå‘˜è¿›è¡Œæ•…éšœè¯Šæ–­å’Œä¿®å¤ã€‚

è®¾ç½®å‘Šè­¦è§„åˆ™çš„æ•´ä½“æµç¨‹å¦‚ä¸‹:

![222.drawio.svg](https://cdn.dong4j.site/source/image/222.drawio.svg)

1. é€‰æ‹©å‘Šè­¦è§„åˆ™çš„æ•°æ®æ¥æº, å°†è®¾å¤‡çš„ç‰©æ¨¡å‹ä½œä¸ºè®¾ç½®è§¦å‘æ¡ä»¶çš„å…¥å‚;
2. è®¾ç½®ä»€ä¹ˆæƒ…å†µä¸‹è§¦å‘å‘Šè­¦, æ¯”å¦‚æŸä¸ªè®¾å¤‡çš„æŸä¸ªå±æ€§çš„å½“å‰å€¼è¶…è¿‡é˜ˆå€¼; æŸå‡ ä¸ªè®¾å¤‡çš„çš„æŸå‡ ä¸ªå€¼å‘ç”Ÿç¬¦åˆæ¡ä»¶çš„å˜æ›´, åˆ™è§¦å‘æŸç§å‘Šè­¦;
3. æ ¹æ®å‘Šè­¦ä¸¥é‡ç­‰çº§è®¾ç½®å‘Šè­¦çº§åˆ«, ä¸åŒçš„çº§åˆ«ä¼šæœ‰ä¸åŒçš„å¤„ç†æ–¹å¼å’Œç»Ÿè®¡æ–¹æ³•;
4. è®¾ç½®å‘Šè­¦æ–¹å¼;

### 2.1 è®¾å¤‡æº

å‘Šè­¦è§„åˆ™æ”¯æŒä¸¤ç§è®¾å¤‡æºç±»å‹ï¼š

- è®¾å¤‡ç±»å‹ï¼šå‘Šè­¦è§„åˆ™çš„ä½œç”¨èŒƒå›´åŒ…æ‹¬è®¾å¤‡ç±»å‹ä¸‹çš„æ‰€æœ‰è®¾å¤‡(åŒä¸€ä¸ªç±»è®¾ç½®çš„ç‰©æ¨¡å‹ä¸€è‡´)ã€‚ä¾‹å¦‚ï¼šæ¯”å¦‚æŸå‚å•†çš„åŒä¸€å‹å·çš„æ™ºèƒ½æ°´è¡¨ï¼Œé‚£ä¹ˆè¯¥ç±»å‹ä¸‹çš„æ‰€æœ‰æ™ºèƒ½è®¾å¤‡ï¼Œéƒ½å¯ä½¿ç”¨è¯¥å‘Šè­¦è§„åˆ™ï¼Œè€Œæ— éœ€ä¸ºæ¯ä¸ªè®¾å¤‡é‡å¤åˆ›å»ºå‘Šè­¦è§„åˆ™ã€‚
- è®¾å¤‡ï¼šå‘Šè­¦è§„åˆ™çš„ä½œç”¨èŒƒå›´ä»…é’ˆå¯¹æŒ‡å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ªè®¾å¤‡ã€‚
- å¤šä¸ªè®¾å¤‡ç»„åˆ, è¿™ç§ä¸»è¦ç”¨äºè®¾ç½®ä¸šåŠ¡ä¸Šå‘Šè­¦è§„åˆ™, æ¯”å¦‚æŸä¸ªåœºç«™çš„å‘Šè­¦è§„åˆ™, ä¼šç”±å¤šä¸ªè®¾å¤‡å…±åŒç»„åˆéªŒè¯ã€‚

### 2.2 è§¦å‘æ¡ä»¶

è§¦å‘æ¡ä»¶æ˜¯å‘Šè­¦è§„åˆ™ä¸­çš„é‡è¦éƒ¨åˆ†ï¼Œæ”¯æŒè®¾ç½®å¤šä¸ªå±æ€§è¿ç®—æ¡ä»¶, æ¯”å¦‚:

1. æ°´ä½é«˜äºæŸä¸ªé˜ˆå€¼;
2. æŸç‚¹ç®¡é“æµé‡ä½äºæŸä¸ªé˜ˆå€¼;

å¯åŒæ—¶æ·»åŠ å¤šä¸ªè§¦å‘æ¡ä»¶ï¼Œä»»æ„ä¸€ä¸ªè§¦å‘å™¨æ»¡è¶³æ¡ä»¶æˆ–å…¨éƒ¨æ»¡è¶³æ¡ä»¶æ‰ä¼šè§¦å‘.

#### 2.2.1 é‡å¤æ¬¡æ•°

è®¾ç½®é‡å¤æ¬¡æ•°åï¼Œå‘Šè­¦æ¡ä»¶é¦–æ¬¡è§¦å‘æ—¶ä¸ä¼šè¿›å…¥å‘Šè­¦çŠ¶æ€ï¼Œä¹Ÿä¸ä¼šå‘é€å‘Šè­¦é€šçŸ¥ã€‚å½“å‘Šè­¦æ¡ä»¶ **è¿ç»­é‡å¤** è§¦å‘è¯¥æ¬¡æ•°åï¼Œè¿›å…¥å‘Šè­¦çŠ¶æ€å¹¶å‘é€å‘Šè­¦é€šçŸ¥ã€‚

#### 2.2.2 æŒç»­æ—¶é—´

è®¾ç½®æŒç»­æ—¶é—´åï¼Œç³»ç»Ÿä¼šåœ¨å‘Šè­¦æ¡ä»¶è¢« **è¿ç»­è§¦å‘** è¾¾åˆ°è¯¥æŒç»­æ—¶é—´åï¼Œè¿›å…¥å‘Šè­¦çŠ¶æ€ã€‚

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ **é‡å¤æ¬¡æ•°** å’Œ **æŒç»­æ—¶é—´** åŒæ—¶è®¾ç½®æ—¶ï¼Œä¸¤è€…å¿…é¡»åŒæ—¶æ»¡è¶³ï¼Œè®¾å¤‡æ‰ä¼šè¿›å…¥ **å‘Šè­¦** çŠ¶æ€ã€‚

æ¯”å¦‚:

1. è§¦å‘æ¡ä»¶æ˜¯æ¸©åº¦å¤§äº 29â„ƒ
2. é‡å¤æ¬¡æ•°æ˜¯ 3 æ¬¡
3. æŒç»­æ—¶é—´æ˜¯ 10 åˆ†é’Ÿ

#### 2.2.3 æœ‰æ•ˆæ—¶é—´æ®µ(å¾…å®š)

å½“å¸Œæœ›å‘Šè­¦è§„åˆ™åªåœ¨éƒ¨åˆ†æ—¶æ®µæœ‰æ•ˆæ—¶ï¼Œå¯ä»¥å¼€å¯æœ‰æ•ˆæ—¶æ®µé€‰é¡¹:

1. å…¨å¤©æ¯ 30 åˆ†é’Ÿä½œä¸ºä¸€ä¸ªæ—¶æ®µå•ä½;

2. å¯ä»¥é€‰æ‹©ä»»æ„æƒ³è¦çš„æ—¶æ®µ;
3. **æ— æ•ˆæ—¶æ®µå…è®¸å‘Šè­¦æ¢å¤**;

### 2.3. å‘Šè­¦çº§åˆ«

å‘Šè­¦çº§åˆ«ç”¨æ¥åŒºåˆ†å‘Šè­¦çš„é‡è¦çº§åˆ«ï¼Œç”¨åœ¨å‘Šè­¦å†å²å’Œå‘Šè­¦é€šçŸ¥çš„æ˜¾ç¤ºæ–‡å­—ä¸­ã€‚ä¾‹å¦‚ï¼Œåœ¨çŸ­ä¿¡é€šçŸ¥æ–¹å¼ä¸­ï¼Œå‘Šè­¦çº§åˆ«ä¼šæ˜¾ç¤ºåœ¨çŸ­ä¿¡ç‰¹æ®Šä½ç½®ã€‚

å¯é€‰çš„å‘Šè­¦çº§åˆ«åŒ…æ‹¬ï¼š

- æ™®é€šå‘Šè­¦
- é‡è¦å‘Šè­¦
- ç´§æ€¥å‘Šè­¦

å¯ä»¥æ ¹æ®ä¸åŒçš„å‘Šè­¦çº§åˆ«è¿›è¡Œçµæ´»é…ç½®ï¼Œå¦‚è®¾ç½®æ™®é€šå‘Šè­¦æ— éœ€å¤„ç†ï¼Œä½†éœ€è¦è®°å½•æ—¥å¿—ï¼›ä¸¥é‡å‘Šè­¦éœ€è¦åŠæ—¶é€šçŸ¥ç›¸å…³äººå‘˜ï¼Œä»¥ä¾¿è¿›è¡Œå¤„ç†ï¼›ç´§æ€¥å‘Šè­¦éœ€è¦ç«‹å³é‡‡å–æªæ–½ï¼Œä»¥é¿å…æŸå¤±ã€‚

## 3. å‘Šè­¦é€šçŸ¥(åŠ¨ä½œ)

å½“ç³»ç»Ÿå‘ç°é—®é¢˜å¹¶ç”Ÿæˆå‘Šè­¦æ—¶ï¼Œå‘Šè­¦é€šçŸ¥æ¨¡å—ä¼šè‡ªåŠ¨è§¦å‘ï¼Œå¹¶å°†å‘Šè­¦ä¿¡æ¯é€šçŸ¥ç»™ç›¸å…³äººå‘˜å’Œéƒ¨é—¨ï¼Œä»¥ä¾¿åŠæ—¶é‡‡å–æªæ–½è§£å†³é—®é¢˜ã€‚

å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š

1. **å‘Šè­¦ç”Ÿæˆï¼š**ç³»ç»Ÿæ£€æµ‹åˆ°å¼‚å¸¸æƒ…å†µå¹¶ç”Ÿæˆå‘Šè­¦ä¿¡æ¯ã€‚

2. **å‘Šè­¦åˆ†ç±»ï¼š**å‘Šè­¦é€šçŸ¥æ¨¡å—å¯¹å‘Šè­¦ä¿¡æ¯è¿›è¡Œåˆ†ç±»ï¼Œæ ¹æ®ä¸åŒçš„å‘Šè­¦ç­‰çº§å’Œç±»å‹ï¼Œé€‰æ‹©ç›¸åº”çš„é€šçŸ¥æ–¹å¼å’Œæ¥æ”¶äººå‘˜ã€‚

3. **é€šçŸ¥æ–¹å¼é€‰æ‹©ï¼š**å‘Šè­¦é€šçŸ¥æ¨¡å—æ ¹æ®ç”¨æˆ·è®¾ç½®çš„é€šçŸ¥æ–¹å¼ï¼Œé€‰æ‹©åˆé€‚çš„æ–¹å¼é€šçŸ¥ç›¸å…³äººå‘˜ã€‚ä¾‹å¦‚ï¼Œå¯¹äºç´§æ€¥çš„å‘Šè­¦ï¼Œå¯ä»¥é€šè¿‡çŸ­ä¿¡æˆ–ç”µè¯é€šçŸ¥è´Ÿè´£äººå‘˜ï¼›å¯¹äºé‡è¦çš„å‘Šè­¦ï¼Œå¯ä»¥é€šè¿‡é‚®ä»¶æˆ–å³æ—¶é€šè®¯å·¥å…·ï¼ˆä¼ä¸šå¾®ä¿¡æˆ–é’‰é’‰ç­‰ï¼‰é€šçŸ¥ç›¸å…³äººå‘˜ï¼Œæ™®é€šå‘Šè­¦åˆ™åœ¨å¤§å±å¹•ä¸Šè¿›è¡Œå±•ç¤ºå³å¯ã€‚

   - é‚®ä»¶é€šçŸ¥ï¼šå°†å‘Šè­¦ä¿¡æ¯é€šè¿‡é‚®ä»¶å‘é€ç»™ç›¸å…³äººå‘˜æˆ–éƒ¨é—¨ã€‚è¯¥æ–¹å¼é€‚ç”¨äºéœ€è¦åŠæ—¶é€šçŸ¥å¹¶ä¸”ä¿¡æ¯é‡è¾ƒå¤§çš„å‘Šè­¦æƒ…å†µã€‚

   - çŸ­ä¿¡é€šçŸ¥ï¼šå°†å‘Šè­¦ä¿¡æ¯ä»¥çŸ­ä¿¡çš„å½¢å¼å‘é€ç»™ç›¸å…³äººå‘˜æˆ–éƒ¨é—¨ã€‚è¯¥æ–¹å¼é€‚ç”¨äºéœ€è¦ç´§æ€¥é€šçŸ¥ä½†ä¿¡æ¯é‡è¾ƒå°‘çš„å‘Šè­¦æƒ…å†µã€‚

   - è¯­éŸ³ç”µè¯é€šçŸ¥ï¼šå°†å‘Šè­¦ä¿¡æ¯é€šè¿‡è¯­éŸ³ç”µè¯å½¢å¼é€šçŸ¥ç›¸å…³äººå‘˜æˆ–éƒ¨é—¨ã€‚è¯¥æ–¹å¼é€‚ç”¨äºéœ€è¦ç´§æ€¥é€šçŸ¥ä½†åˆä¸èƒ½ç«‹å³æŸ¥çœ‹ä¿¡æ¯çš„å‘Šè­¦æƒ…å†µã€‚

   - å¾®ä¿¡/é’‰é’‰/ä¼ä¸šå¾®ä¿¡ç­‰å³æ—¶é€šè®¯å·¥å…·é€šçŸ¥ï¼šå°†å‘Šè­¦ä¿¡æ¯é€šè¿‡å³æ—¶é€šè®¯å·¥å…·å‘é€ç»™ç›¸å…³äººå‘˜æˆ–éƒ¨é—¨ã€‚è¯¥æ–¹å¼é€‚ç”¨äºéœ€è¦åŠæ—¶é€šçŸ¥ä¸”æ–¹ä¾¿å¤„ç†çš„å‘Šè­¦æƒ…å†µã€‚

   - å¤§å±å¹•å±•ç¤ºï¼šå°†å‘Šè­¦ä¿¡æ¯ä»¥å¯è§†åŒ–çš„å½¢å¼å±•ç¤ºåœ¨å¤§å±å¹•ä¸Šï¼Œæ–¹ä¾¿ç›¸å…³äººå‘˜å®æ—¶äº†è§£ç›‘æ§æƒ…å†µã€‚

   - ç«™å†…é€šçŸ¥ï¼šå½“ç›‘æ§ç³»ç»Ÿäº§ç”Ÿå‘Šè­¦ä¿¡æ¯æ—¶ï¼Œå¯é€šè¿‡åº”ç”¨å†…é€šçŸ¥çš„æ–¹å¼å¿«é€Ÿé€šçŸ¥ç›¸å…³äººå‘˜ï¼Œå¹¶æä¾›è¯¦ç»†çš„å‘Šè­¦ä¿¡æ¯ã€‚

4. **é€šçŸ¥å†…å®¹ç”Ÿæˆï¼š**å‘Šè­¦é€šçŸ¥æ¨¡å—ç”Ÿæˆå‘Šè­¦é€šçŸ¥å†…å®¹ï¼Œå¹¶å°†å‘Šè­¦ä¿¡æ¯ã€è®¾å¤‡ä¿¡æ¯ã€æ—¶é—´ç­‰å…³é”®ä¿¡æ¯åŒ…å«åœ¨é€šçŸ¥ä¸­ï¼Œä»¥ä¾¿ç›¸å…³äººå‘˜äº†è§£é—®é¢˜çš„å…·ä½“æƒ…å†µã€‚

5. **é€šçŸ¥å‘é€ï¼š**é€šè¿‡è‡ªå®šä¹‰è§„åˆ™ï¼Œå‘Šè­¦é€šçŸ¥æ¨¡å—å°†é€šçŸ¥å‘é€ç»™é¢„è®¾çš„æ¥æ”¶äººå‘˜ï¼ŒåŒæ—¶è®°å½•å‘é€æ—¶é—´ã€å‘é€çŠ¶æ€ç­‰ä¿¡æ¯ï¼Œæ–¹ä¾¿åç»­è·Ÿè¿›å’Œå¤„ç†ã€‚

### 3.1 é€šçŸ¥ç»„

å‘Šè­¦é€šçŸ¥æ–¹å¼å‰æœŸä¸»è¦è€ƒè™‘ **çŸ­ä¿¡**, åæœŸå¯åŠ å…¥å…¶ä»–å‘Šè­¦æ–¹å¼.

åœ¨ä½¿ç”¨é€šçŸ¥æ–¹å¼ä¹‹å‰, éœ€è¦åˆ›å»º **é€šçŸ¥ç»„**.

**å¦‚æœä¸è®¾ç½®å‘Šè­¦é€šçŸ¥ç»„, åˆ™åªä¼šè®°å½•å‘Šè­¦å†å²è®°å½•**.

**é€šçŸ¥ç»„** çš„ä½œç”¨æ˜¯å¤ç”¨é€šçŸ¥é…ç½®, æ¯”å¦‚å¼ ä¸‰è´Ÿè´£å¤šä¸ªé¡¹ç›®éƒ¨, åœ¨è®¾ç½®å‘Šè­¦è§„åˆ™æ—¶, ä¸éœ€è¦å¤šæ¬¡å¡«å†™å¼ ä¸‰ä½œä¸ºé€šçŸ¥äºº, åªéœ€è¦é€‰æ‹©ç¬¬ä¸€æ¬¡åˆ›å»ºå¥½çš„é€šçŸ¥ç»„å³å¯.

ä¸€ä¸ªé€šçŸ¥ç»„åªèƒ½é€‰æ‹©ä¸€ä¸ªé€šçŸ¥æ–¹å¼ï¼Œå¦‚æœéœ€è¦å¤šç§é€šçŸ¥æ–¹å¼ï¼Œåˆ™éœ€è¦åˆ›å»ºå¤šä¸ªé€šçŸ¥ç»„ã€‚

### 3.2 é€šçŸ¥æ–¹å¼

ç›®å‰åªè€ƒè™‘ **çŸ­ä¿¡** é€šçŸ¥.

### 3.3 æ¯æ—¥é€šçŸ¥ä¸Šé™

è®¾ç½®å‘Šè­¦è§„åˆ™çš„æ¯æ—¥æ€»é€šçŸ¥æ¬¡æ•°ä¸Šé™ï¼Œè¶…è¿‡ä¸Šé™åå½“æ—¥ä¸å†å‘é€é€šçŸ¥.

## 4. å‘Šè­¦è§„åˆ™çš„å¯ç”¨çŠ¶æ€

æ¯ä¸ªå‘Šè­¦è§„åˆ™å¯è®¾ç½®å…¨å±€å¯ç”¨çŠ¶æ€ï¼Œç”¨æ¥å¯ç”¨æˆ–ç¦ç”¨è¯¥è§„åˆ™ï¼Œå¯¹è¯¥å‘Šè­¦è§„åˆ™çš„æ‰€æœ‰è®¾å¤‡æºéƒ½ç”Ÿæ•ˆã€‚

åœ¨å…¨å±€å¯ç”¨çŠ¶æ€å¼€å¯çš„æƒ…å†µä¸Šï¼Œå¯ä»¥å¯¹å…³è”çš„è®¾å¤‡ç‹¬ç«‹è®¾ç½®å¯ç”¨æˆ–ç¦ç”¨çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œå½“å¯¹æŸä¸ªè®¾å¤‡è¿›è¡Œç»´æŠ¤æ—¶ï¼Œå¯ä¸´æ—¶å…³é—­è¯¥è®¾å¤‡çš„å‘Šè­¦è§„åˆ™ï¼Œä½†ä¸å½±å“å‘Šè­¦è§„åˆ™å…³è”çš„å…¶å®ƒè®¾å¤‡ã€‚

## 5. å‘Šè­¦è§„åˆ™çš„å‘Šè­¦çŠ¶æ€

å‘Šè­¦è§„åˆ™æ‹¥æœ‰ä»¥ä¸‹å‡ ç§çš„å‘Šè­¦çŠ¶æ€ï¼š

- æ­£å¸¸ï¼ˆOkï¼‰ï¼šè¡¨ç¤ºæœ€è¿‘ä¸€æ¬¡è®¾å¤‡å±æ€§ä¸ŠæŠ¥æœªè§¦å‘å‘Šè­¦è§„åˆ™ã€‚
- å‘Šè­¦ï¼ˆAlertingï¼‰ï¼šè¡¨ç¤ºæœ€è¿‘ä¸€æ¬¡è®¾å¤‡å±æ€§ä¸ŠæŠ¥å·²è§¦å‘å‘Šè­¦è§„åˆ™ï¼Œä¸”è¾¾åˆ°è®¾ç½®çš„é‡å¤æ¬¡æ•°å’ŒæŒç»­æ—¶é—´ã€‚å¦‚æœæœªè®¾ç½®é‡å¤æ¬¡æ•°å’ŒæŒç»­æ—¶é—´ï¼Œåˆ™é¦–æ¬¡è§¦å‘ä¼šè¿›å…¥å‘Šè­¦çŠ¶æ€ã€‚
- å¾…å®šï¼ˆPendingï¼‰ï¼šè¡¨ç¤ºæœ€è¿‘ä¸€æ¬¡è®¾å¤‡å±æ€§ä¸ŠæŠ¥å·²è§¦å‘å‘Šè­¦è§„åˆ™ï¼Œä½†æœªè¾¾åˆ°è®¾ç½®çš„é‡å¤æ¬¡æ•°å’ŒæŒç»­æ—¶é—´ã€‚
- æœªçŸ¥ï¼ˆUnknownï¼‰ï¼šè¡¨ç¤ºå‘Šè­¦è§„åˆ™æš‚æ—¶æ— æ˜ç¡®çš„å‘Šè­¦çŠ¶æ€ï¼Œä¾‹å¦‚ï¼šè§„åˆ™åˆ›å»ºåä¸€ç›´æ²¡æœ‰ç›¸å…³è®¾å¤‡å±æ€§ä¸ŠæŠ¥ï¼Œæˆ–è€…å‘Šè­¦è§„åˆ™è¢«ç¦ç”¨ã€ä¸åœ¨æœ‰æ•ˆæ—¶æ®µç­‰æƒ…å†µã€‚

![20241229154732_9Tt1ae8Q.webp](https://cdn.dong4j.site/source/image/20241229154732_9Tt1ae8Q.webp)

## 6. è­¦æŠ¥ä¿¡æ¯å¤„ç†

å¯¹å·²ç»å‘å‡ºæ¥çš„å‘Šè­¦ä¿¡æ¯è¿›è¡Œå¤„ç†ä»¥åŠè®°å½•å¤„ç†çš„å†…å®¹ï¼Œå¯ä»¥æ¸…æ™°äº†è§£æ¯ä¸ªå‘Šè­¦çš„å¤„ç†çŠ¶æ€å’Œå¤„ç†è¿‡ç¨‹ï¼Œæ›´å¥½åœ°ç®¡ç†å’Œç»´æŠ¤ç³»ç»Ÿã€‚

### 6.1. å‘Šè­¦ä¿¡æ¯çš„å¤„ç†

å½“ä¸€ä¸ªå‘Šè­¦è¢«è§¦å‘å¹¶ä¸”é€šçŸ¥ç»™è°ƒåº¦åï¼Œè°ƒåº¦éœ€è¦å¯¹è¿™ä¸ªå‘Šè­¦ä¿¡æ¯è¿›è¡Œå¤„ç†ã€‚è¿™ä¸ªå¤„ç†è¿‡ç¨‹åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

1. **åˆ†æå‘Šè­¦ä¿¡æ¯**ï¼šè°ƒåº¦éœ€è¦å¯¹å‘Šè­¦ä¿¡æ¯è¿›è¡Œåˆ†æï¼Œäº†è§£å‘Šè­¦çš„æ¥æºã€å‘Šè­¦ç­‰çº§ä»¥åŠå½±å“èŒƒå›´ç­‰ï¼Œä»¥ä¾¿æ›´å¥½åœ°åˆ¤æ–­å‘Šè­¦çš„ç´§æ€¥ç¨‹åº¦å’Œå¤„ç†æ–¹æ³•ã€‚
2. **åˆ¤æ–­å‘Šè­¦çš„å¤„ç†æ–¹æ³•ï¼š**æ ¹æ®å‘Šè­¦çš„ç´§æ€¥ç¨‹åº¦å’Œå½±å“èŒƒå›´ï¼Œè°ƒåº¦éœ€è¦åˆ¤æ–­å‘Šè­¦çš„å¤„ç†æ–¹æ³•ã€‚å¦‚æœå‘Šè­¦æ¯”è¾ƒç´§æ€¥ä¸”å½±å“èŒƒå›´è¾ƒå¤§ï¼Œè°ƒåº¦éœ€è¦ç¬¬ä¸€æ—¶é—´è”ç³»ä¸€çº¿è¿ç»´è¿›è¡Œç°åœºå¤„ç†ï¼›å¦‚æœå‘Šè­¦æ¯”è¾ƒæ™®é€šä¸”å½±å“èŒƒå›´è¾ƒå°ï¼Œè°ƒåº¦å¯ä»¥åœ¨åˆé€‚çš„æ—¶é—´è¿›è¡Œå¤„ç†ã€‚
3. **å¤„ç†å‘Šè­¦**ï¼šå…·ä½“æªæ–½åŒ…æ‹¬åˆé—¸ã€é‡å¯è®¾å¤‡ç­‰ç­‰ã€‚å¤„ç†å®Œæˆåï¼Œä¸€çº¿è¿ç»´éœ€è¦è®°å½•å¤„ç†çš„å†…å®¹ï¼Œä»¥ä¾¿åç»­çš„è·Ÿè¸ªå’Œåˆ†æã€‚

### 6.2. å¤„ç†è®°å½•çš„è·Ÿè¸ª

æ¯ä¸ªå‘Šè­¦ä¿¡æ¯éƒ½åº”è¯¥æœ‰ç›¸åº”çš„å¤„ç†è®°å½•ï¼Œä»¥ä¾¿è¿½è¸ªå‘Šè­¦çš„å¤„ç†æƒ…å†µã€‚å¤„ç†è®°å½•çš„è·Ÿè¸ªåŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1. **è®°å½•å‘Šè­¦çš„å¤„ç†è¿‡ç¨‹**

   éœ€è¦è®°å½•å‘Šè­¦çš„å¤„ç†è¿‡ç¨‹ï¼ŒåŒ…æ‹¬é‡‡å–çš„æªæ–½ã€å¤„ç†æ—¶é—´ã€å¤„ç†ç»“æœç­‰ç­‰ã€‚è¿™äº›è®°å½•å¯ä»¥å¸®åŠ©äº†è§£å‘Šè­¦çš„å¤„ç†æƒ…å†µå’Œå¤„ç†æ•ˆæœã€‚

2. **è®°å½•å‘Šè­¦çš„å¤„ç†äººå‘˜**

   éœ€è¦è®°å½•å¤„ç†å‘Šè­¦çš„äººå‘˜ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¤„ç†äººå‘˜çš„å§“åã€å·¥å·ã€è”ç³»æ–¹å¼ç­‰ç­‰ã€‚è¿™äº›è®°å½•å¯ä»¥å¸®åŠ©äº†è§£å‘Šè­¦çš„å¤„ç†è´£ä»»äººå’Œè´£ä»»åŒºåŸŸã€‚

3. **è®°å½•å‘Šè­¦çš„å¤„ç†çŠ¶æ€**

   éœ€è¦è®°å½•å‘Šè­¦çš„å¤„ç†çŠ¶æ€ï¼ŒåŒ…æ‹¬å‘Šè­¦çš„å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´ã€å¤„ç†çŠ¶æ€ç­‰ç­‰ã€‚è¿™äº›è®°å½•å¯ä»¥å¸®åŠ©äº†è§£å‘Šè­¦çš„å¤„ç†çŠ¶æ€å’Œå¤„ç†æ•ˆç‡ã€‚

**å‘Šè­¦ä¿¡æ¯å¤„ç†çŠ¶æ€:**

- æœªå¤„ç†ï¼šå½“ç³»ç»Ÿæ¥æ”¶åˆ°å‘Šè­¦ä¿¡æ¯åï¼Œè¿˜æ²¡æœ‰è¿›è¡Œä»»ä½•å¤„ç†ï¼Œæ­¤æ—¶å‘Šè­¦çŠ¶æ€ä¸ºæœªå¤„ç†çŠ¶æ€;
- å¤„ç†ä¸­ï¼šå½“å¼€å§‹å¤„ç†å‘Šè­¦ä¿¡æ¯æ—¶ï¼Œå‘Šè­¦çŠ¶æ€ä¼šè¢«è®¾ç½®ä¸ºå¤„ç†ä¸­;
- å·²è§£å†³ï¼šå½“å¤„ç†å‘Šè­¦ä¿¡æ¯åï¼Œç¡®å®šé—®é¢˜å·²ç»å¾—åˆ°è§£å†³ï¼Œå‘Šè­¦çŠ¶æ€å°†è¢«è®¾ç½®ä¸ºå·²è§£å†³çŠ¶æ€;

  - äººå·¥å¤å½’
  - è‡ªåŠ¨å¤å½’

- è¯¯æŠ¥ï¼šå½“å‘Šè­¦ä¿¡æ¯è¢«åˆ¤å®šä¸ºè¯¯æŠ¥æ—¶ï¼Œå‘Šè­¦çŠ¶æ€ä¼šè¢«è®¾ç½®ä¸ºè¯¯æŠ¥çŠ¶æ€;
- å¿½ç•¥ï¼šå½“ç®¡å‘Šè­¦ä¿¡æ¯ä¸éœ€è¦è¢«å¤„ç†æ—¶ï¼Œå¯ä»¥å°†å‘Šè­¦çŠ¶æ€è®¾ç½®ä¸ºå¿½ç•¥çŠ¶æ€;

## 6. å‘Šè­¦å†å²

å¯é€šè¿‡å‘Šè­¦çº§åˆ«, å½“å‰å‘Šè­¦çŠ¶æ€, è®¾å¤‡ç­‰æ¡ä»¶æŸ¥è¯¢å‘Šè­¦å†å².

## 7. å‘Šè­¦ç»Ÿè®¡

ç›´è§‚çš„åˆ†æåœ¨è¿‡å»çš„ä¸åŒæ—¶æ®µä¸­ï¼Œè®¾å¤‡å‘Šè­¦çš„å‡ºç°é¢‘æ¬¡ã€‚

## 8. ç«™å†…é€šçŸ¥

å½“è®¾å¤‡è§¦å‘å‘Šè­¦æˆ–æ¢å¤æ­£å¸¸æ—¶ï¼Œæ§åˆ¶å°å³ä¸Šè§’ä¼šæœ‰é€šçŸ¥æç¤ºï¼Œç‚¹å‡»æç¤ºæ å¯ä»¥å¿«é€Ÿåˆ°è¾¾å‘Šè­¦å†å²è¯¦æƒ…é¡µã€‚

## 9. ç•Œé¢è®¾è®¡

æ­¤æ–¹æ¡ˆåŒ…æ‹¬ä»¥ä¸‹åŠŸèƒ½æ¨¡å—ï¼š

1. **å‘Šè­¦è®¾ç½®æ¨¡å—**

   ç”¨äºè®¾ç½®å‘Šè­¦çš„è§„åˆ™å’Œå¤„ç†æ–¹å¼ï¼Œå¦‚è®¾ç½®å‘Šè­¦çš„çº§åˆ«ã€è§¦å‘æ¡ä»¶ã€å‘Šè­¦é€šçŸ¥æ–¹å¼ã€å‘Šè­¦çš„å¤„ç†æ–¹å¼ç­‰ã€‚

2. **å‘Šè­¦åˆ—è¡¨æ¨¡å—**

   åŒ…æ‹¬å½“å‰æ‰€æœ‰çš„å‘Šè­¦ä¿¡æ¯ä»¥åŠè¿‡å»æ‰€æœ‰å‘ç”Ÿçš„å‘Šè­¦ä¿¡æ¯ï¼ŒåŒ…æ‹¬å‘Šè­¦ç­‰çº§ã€å‘Šè­¦ç±»å‹ã€å‘Šè­¦å†…å®¹ã€å‘Šè­¦æ—¶é—´ç­‰ä¿¡æ¯ã€‚

3. **å‘Šè­¦è¯¦æƒ…**

   å±•ç¤ºé€‰ä¸­å‘Šè­¦çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬å‘Šè­¦çš„å‘ç”Ÿæ—¶é—´ã€å‘Šè­¦çš„å½±å“èŒƒå›´ã€å‘Šè­¦çš„å¤„ç†æƒ…å†µç­‰ä¿¡æ¯ã€‚

4. **å‘Šè­¦å¤„ç†**

   ç”¨äºå¤„ç†å·²ç»å‘ç”Ÿçš„å‘Šè­¦ï¼Œé€šå¸¸åœ¨å‘Šè­¦è¯¦æƒ…é¡µé¢è¿›è¡Œå¤„ç†é€šè¿‡è¯¥æ¨¡å—å¯¹å‘Šè­¦ä¿¡æ¯è¿›è¡Œå¤„ç†ï¼ŒåŒ…æ‹¬å‘Šè­¦ç¡®è®¤ã€å‘Šè­¦åˆ†é…ã€å‘Šè­¦å¤„ç†è¿›å±•è·Ÿè¸ªç­‰ã€‚åŒæ—¶å¯ä»¥å°†å¤„ç†ç»“æœè®°å½•åœ¨è¯¥æ¨¡å—ä¸­ï¼Œä¾¿äºåç»­çš„è·Ÿè¸ªå’Œåˆ†æã€‚

5. **å‘Šè­¦ç»Ÿè®¡**

   å¯¹æ‰€æœ‰å‘Šè­¦ä¿¡æ¯è¿›è¡Œç»Ÿè®¡åˆ†æï¼ŒåŒ…æ‹¬å‘Šè­¦çº§åˆ«ã€å‘Šè­¦ç±»å‹ã€è®¾å¤‡ç±»å‹ã€å‘Šè­¦æ—¶é—´ã€å‘Šè­¦å†…å®¹ç­‰ç­‰ã€‚é€šè¿‡è¯¥æ¨¡å—æ¥äº†è§£å‘Šè­¦æƒ…å†µçš„æ€»ä½“æ¦‚æ‹¬ï¼ŒåŒæ—¶ä¹Ÿä¸ºç›‘æ§ç³»ç»Ÿçš„æ”¹è¿›å’Œä¼˜åŒ–æä¾›æ•°æ®æ”¯æŒã€‚

6. æ€»è§ˆç•Œé¢ï¼šå±•ç¤ºç³»ç»Ÿä¸­çš„æ‰€æœ‰å‘Šè­¦ä¿¡æ¯ï¼Œä»¥åŠå‘Šè­¦çš„å¤„ç†æƒ…å†µå’Œå¤„ç†ç»“æœï¼Œå¹¶æŒ‰ç…§å‘Šè­¦çº§åˆ«ã€å‘Šè­¦ç±»å‹ç­‰åˆ†ç±»ã€‚

7. æ•°æ®å¯è§†åŒ–åˆ†æç•Œé¢ï¼šç»“åˆå…·ä½“çš„ç›‘æ§å‘Šè­¦æŒ‡æ ‡ï¼Œé€šè¿‡å›¾è¡¨çš„å½¢å¼å±•ç¤ºå…·ä½“å‘Šè­¦æ•°æ®çš„è¶‹åŠ¿å’Œå˜åŒ–ï¼Œä¾‹å¦‚å†å²å‘Šè­¦æ•…éšœè®¾å¤‡è¶‹åŠ¿ã€å†å²æ•…éšœ SIM å¡åˆ†å¸ƒç­‰ã€‚

## [å‘Šåˆ«æ–‡æ¡£ææƒ§ç—‡ï¼šè½»æ¾æŒæ¡æŠ€æœ¯æ–‡æ¡£å†™ä½œæŠ€å·§](https://blog.dong4j.site/posts/22b8af79.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

ä¸ºä»€ä¹ˆä½ ä¸çˆ±å†™æŠ€æœ¯æ–‡æ¡£ï¼Ÿä»¥åŠæ€æ ·æ‰èƒ½å†™å¥½æŠ€æœ¯æ–‡æ¡£ï¼Ÿ
æˆ‘ä»¥å‰çœ‹è¿‡ä¸€ä¸ªæŠ•ç¥¨ï¼Œç›˜ç‚¹ç¨‹åºå‘˜ä¸å–œæ¬¢çš„äº‹ï¼Œæœ‰ä¸¤æ¡å’Œæ–‡æ¡£ç›¸å…³ï¼š

> ä¸å–œæ¬¢å†™æ–‡æ¡£ï¼›
> ä¸å–œæ¬¢é¡¹ç›®æ–‡æ¡£å¤ªå°‘ã€‚

çœ‹èµ·æ¥å¾ˆçŸ›ç›¾ï¼Œå´å¾ˆç°å®ã€‚åŸºæœ¬ä¸Šå¤§å®¶éƒ½è®¤åŒï¼šâ€œé¡¹ç›®æ–‡æ¡£å¾ˆé‡è¦â€ï¼Œç„¶è€Œæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­æ€»æ˜¯**çŸ­æœŸé«˜ä¼°æ–‡æ¡£çš„é‡è¦æ€§ï¼Œè€Œé•¿æœŸä½ä¼°æ–‡æ¡£çš„é‡è¦æ€§ã€‚**

![20241229154732_szVGAweo.webp](https://cdn.dong4j.site/source/image/20241229154732_szVGAweo.webp)

ç»“æœå°±æ˜¯å£å·å–Šçš„å¾ˆå“ï¼šè¦é‡è§†æ–‡æ¡£ã€è¦å†™å¥½æ–‡æ¡£ã€è¦å¤šå†™æ–‡æ¡£ï¼Œç„¶è€Œéšç€é¡¹ç›®çš„æ¨è¿›ï¼Œæ€»æœ‰æ¯”æ–‡æ¡£ä¼˜å…ˆçº§æ›´é‡è¦çš„ä»»åŠ¡ï¼Œæ–‡æ¡£çš„ä¼˜å…ˆçº§æ€»æ˜¯è¢«æœ‰æ„æ— æ„æ¨è¿Ÿï¼Œå¯¼è‡´é¡¹ç›®çš„æ–‡æ¡£ç¼ºå¤±ã€è€æ—§ã€æ— äººç»´æŠ¤ã€‚

### 1.1 ä¸ºä»€ä¹ˆä¸çˆ±å†™æ–‡æ¡£?

é‚£ä¹ˆä¸ºä»€ä¹ˆç¨‹åºå‘˜éƒ½ä¸çˆ±å†™æ–‡æ¡£å‘¢ï¼Ÿæˆ‘æ€»ç»“äº†ä¸€ä¸‹å¤§è‡´æœ‰ä¸‹é¢è¿™äº›åŸå› ã€‚

- **ä¸çŸ¥é“æ€ä¹ˆå†™**

ä¸çŸ¥é“æ€ä¹ˆå†™æ–‡æ¡£çš„åº”è¯¥å å¾ˆå¤§ä¸€éƒ¨åˆ†æ¯”ä¾‹ã€‚

- **å¤ªå¿™æ²¡æ—¶é—´å†™æˆ–è€…æ‡’å¾—å†™**

ç¨‹åºå‘˜ç¡®å®å¾ˆå¿™ï¼Œä½†æ€»æœ‰ä¸é‚£ä¹ˆå¿™çš„æ—¶å€™ï¼Œå´ä¹Ÿå¾ˆå°‘è§æœ‰äººåˆ©ç”¨è¿™æ—¶é—´å»å†™æ–‡æ¡£ã€‚åŒ…æ‹¬æˆ‘è‡ªå·±ä¹Ÿè¿™æ ·ï¼Œæœ‰æ—¶å€™æ²¡é‚£ä¹ˆå¿™çš„æ—¶å€™ï¼Œå®å¯å»æƒ³æƒ³æ€ä¹ˆé‡æ„ä¸‹ä»£ç ï¼Œå´å¾ˆå°‘ä¼šæ„¿æ„å»å†™æ–‡æ¡£ï¼Œä¸»è¦è¿˜æ˜¯å¤ªæ‡’ã€‚

- **å› ä¸ºæ˜¯æ•æ·å¼€å‘ï¼Œæ‰€ä»¥ä¸ç”¨å†™æ–‡æ¡£ï¼Ÿ**

å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘å…¶å®åé©³è¿‡å¤šæ¬¡ï¼Œ[æ•æ·å®£è¨€](http://agilemanifesto.org/iso/zhchs/manifesto.html) æœ€åä¸€å¥è¯æ˜ç¡®æŒ‡å‡ºï¼šã€Œå°½ç®¡å³é¡¹æœ‰å…¶ä»·å€¼ï¼Œæˆ‘ä»¬æ›´é‡è§†å·¦é¡¹çš„ä»·å€¼ã€‚ã€ä¹Ÿå°±æ˜¯è¯´æ•æ·ä»æ¥æ²¡æœ‰å¦è®¤æ–‡æ¡£çš„ä»·å€¼ï¼Œåªæ˜¯æ›´é‡è§† ã€Œå·¥ä½œçš„è½¯ä»¶ã€ ç½¢äº†ã€‚

### 1.2 ä¸ºä»€ä¹ˆè¦å†™æŠ€æœ¯æ–‡æ¡£?

å†™æ–‡æ¡£ï¼Œå…¶å®å¯¹ä¸ªäººã€å¯¹é¡¹ç›®ã€å¯¹å›¢é˜Ÿï¼Œéƒ½æ˜¯éå¸¸é‡è¦çš„äº‹æƒ…ã€‚

#### 1.2.1 ç†æ¸…æ€è·¯

æˆ‘æƒ³ä½ åº”è¯¥æœ‰è¿™æ ·çš„æ„Ÿå—ï¼šå†™ä½œçš„è¿‡ç¨‹ï¼Œå°±æ˜¯ä¸€ä¸ªæ€è€ƒçš„è¿‡ç¨‹ã€‚

å†™æ–‡æ¡£ï¼Œå¯ä»¥è®©ä½ åœ¨å†™ä»£ç ä¹‹å‰ï¼Œæ¢³ç†æ¸…æ¥šæ€è·¯ï¼Œæƒ³æ¸…æ¥šæ•´ä½“ç»“æ„ï¼Œæ¯”å¦‚è¯´æœ‰å“ªäº›å·¥ä½œæ˜¯é‡ç‚¹éš¾ç‚¹ï¼›å“ªäº›è¦ä¾èµ–å…¶ä»–äººï¼Œéœ€è¦åŠæ—©åå•†çš„ï¼›å“ªäº›æ˜¯è¦è€ƒè™‘å®‰å…¨æ€§çš„ã€‚

å¦‚æœä¸Šæ‰‹å°±å†™ä»£ç ï¼Œå°±å¾ˆå®¹æ˜“é™·å…¥åˆ°æŸä¸ªæŠ€æœ¯ç»†èŠ‚ä¸­ï¼Œè€Œå¿½ç•¥äº†æ•´ä½“ç»“æ„ã€‚å†™çš„æ—¶å€™æ‰å‘ç°ä¸€ä¸ªæŠ€æœ¯éš¾ç‚¹æ— æ³•è§£å†³ï¼Œæˆ–è€…å·²ç»åœ¨æŸä¸ªä¸é‡è¦çš„ç»†èŠ‚ä¸Šæµªè´¹äº†å¾ˆå¤šæ—¶é—´ï¼›æˆ–æ˜¯å‘ç°æœ‰äº›ä¾èµ–å…¶ä»–äººæä¾›çš„æœåŠ¡è¿˜æ²¡å‡†å¤‡å¥½ï¼›åˆæˆ–è€…æ˜¯ä¸Šçº¿åæ‰å‘ç°æœ‰å®‰å…¨æ¼æ´ã€‚

**å…ˆå†™æ–‡æ¡£ï¼Œå°±ä¼šæŠ›å¼€ä»£ç ç»†èŠ‚ï¼Œå»ç«™åœ¨å…¨å±€æ€è€ƒã€‚**å†™çš„æ—¶å€™ï¼Œå„ä¸ªæ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€å„ç§å¯èƒ½çš„å®‰å…¨éšæ‚£ã€å„ç§å¯èƒ½éœ€è¦å…¶ä»–äººé…åˆçš„åœ°æ–¹ï¼Œå°±éƒ½å†’å‡ºæ¥äº†ï¼Œå¿…é¡»è¦å»æŸ¥èµ„æ–™ï¼Œå»æ‰¾äººè®¨è®ºï¼Œåå¤ç¼œå¯†çš„æ€è€ƒåæœ€ç»ˆå†™å‡ºæ¥ã€‚

**å…¶ç›®çš„æ˜¯è¿«ä½¿ä½ å¯¹è®¾è®¡å±•å¼€ç¼œå¯†çš„æ€è€ƒï¼Œå¹¶æ”¶é›†ä»–äººçš„åé¦ˆï¼Œè¿›è€Œå®Œå–„ä½ çš„æƒ³æ³•**

**æ¢ä¸ªè§’åº¦æ¥è¯´ï¼Œå¦‚æœä½ è¿æ–‡æ¡£éƒ½å†™ä¸å‡ºæ¥ï¼Œé‚£åˆæ€ä¹ˆèƒ½æŒ‡æœ›ä»£ç å†™å¾—å¥½å‘¢ï¼Ÿ**

#### 1.2.2 ä¾¿äºç»´æŠ¤å’Œäº¤æ¥

ã€Œå¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´ã€ï¼Œå­˜åœ¨è„‘å­é‡Œçš„å†…å®¹æ˜¯ä¸å¯é çš„ï¼Œä¸€ä¸ªæ­£å¸¸çš„é¡¹ç›®ç»„ï¼Œå¦‚æœéœ€è¦é•¿æœŸç»´æŠ¤ï¼Œå°±éœ€è¦ä¸€å®šçš„æ–‡æ¡£ï¼ŒæŠŠè®¾è®¡ã€æ“ä½œæµç¨‹ã€ç¯å¢ƒé…ç½®ç­‰å†…å®¹è®°å½•ä¸‹æ¥ï¼Œè€Œä¸ä»…ä»…ä¾èµ–äº **å£å£ç›¸ä¼ **ã€‚

#### 1.2.3 ä¾¿äºåä½œæ²Ÿé€š

åœ¨ä¸€ä¸ªé¡¹ç›®ç»„ä¸­ï¼Œå¤§å®¶éƒ½æœ‰ä¸åŒçš„åˆ†å·¥ï¼Œæœ‰äººè´Ÿè´£äº§å“è®¾è®¡ï¼Œæœ‰äººè´Ÿè´£æ¶æ„è®¾è®¡ï¼Œæœ‰äººè´Ÿè´£æµ‹è¯•ã€‚è€Œæ–‡æ¡£ï¼Œå°±æˆä¸ºäº†å›¢é˜Ÿæˆå‘˜å¾ˆå¥½çš„æ²Ÿé€šå·¥å…·ã€‚

æ¯”å¦‚è¯´äº§å“è®¾è®¡æœ‰é›å‹çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸€ä¸ªäº§å“è®¾è®¡çš„è¯„å®¡ä¼šè®®ï¼ŒåŸºäºæ–‡æ¡£ï¼Œé¡¹ç›®æˆå‘˜å¯ä»¥ä¸€èµ·å‚ä¸å…¶ä¸­ï¼Œæå‡ºè‡ªå·±çš„æ„è§å’Œçœ‹æ³•ã€‚è¿™æ ·å°±ä¸è‡³äºç­‰åˆ°äº§å“è®¾è®¡å‡ºæ¥ä¹‹åï¼Œå¤§å®¶æ‰å¯¹äºè®¾è®¡æœ‰æ”¹è¿›æƒ³æ³•æˆ–æ„è§ï¼Œé€ æˆæ— æ³•æ›´æ”¹çš„ç»“æœã€‚

### 1.3 æŠ€æœ¯æ–‡æ¡£çš„æ³¨æ„äº‹é¡¹

æˆ‘å‚ä¸è¿‡å¾ˆå¤šæ¬¡è®¾è®¡è¯„å®¡ï¼Œç»å¸¸ä¼šå‘ç°**å¦‚ä¸‹é—®é¢˜**ï¼š

- æ–‡æ¡£å·¥å…·ä¸ç»Ÿä¸€ï¼Œä¸åŒçš„å°ç»„ã€éƒ¨é—¨å­˜åœ¨å·®å¼‚ï¼Œæœ‰äº›ç”šè‡³ä¸çŸ¥é“æ˜¯ä»€ä¹ˆæ ¼å¼çš„æ–‡ä»¶ï¼Œæ— æ³•æ‰“å¼€ï¼›
- è¿‡åº¦æ‹·è´éœ€æ±‚æ–‡æ¡£ï¼Œç¼ºå°‘è½¯ä»¶è®¾è®¡çš„å†…å®¹ï¼Œä¸åƒè½¯ä»¶è®¾è®¡æ–‡æ¡£ï¼›
- æ’ç‰ˆæ··ä¹±ï¼Œè®¾è®¡æ–‡æ¡£æœªæŒ‰ç…§æ ‡å‡†æ¨¡æ¿é¡ºåºï¼Œç¼ºå°‘æ¸…æ™°çš„ç›®å½•ç»“æ„ï¼›
- è®¾è®¡æ–‡æ¡£å¤ªå¤šå›¾ç‰‡ï¼Œæœ‰äº›è´¨é‡å¾ˆå·®ï¼Œä¸”ç¼ºå¤±åŸå§‹æ–‡ä»¶ï¼Œæ¯”å¦‚ EA å·¥å…·åšçš„ç¼ºä¹ eapx æ–‡ä»¶ï¼Œä¼šå¯¼è‡´æ–‡æ¡£è¿­ä»£éœ€è¦å…¨éƒ¨é‡æ–°ç»˜å›¾ï¼Œä¹…è€Œä¹…ä¹‹æ›´åŠ ä¸æ„¿æ„å»ç»´æŠ¤æ›´æ–°æ–‡æ¡£äº†ï¼›
- æ²¡æœ‰ç»Ÿä¸€çš„æ–‡æ¡£ç‰ˆæœ¬ç®¡ç†å·¥å…·ï¼Œç¼ºå°‘è¿½æº¯å’Œç»Ÿè®¡ç®¡ç†çš„èƒ½åŠ›ï¼›
- æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡æ ·å¼æ‚ä¹±ä¸ç»Ÿä¸€ï¼Œå­—æ®µæ— ä¸­æ–‡æè¿°ï¼ˆæ¯•ç«Ÿæ¯è¯­ä¸æ˜¯è‹±è¯­ï¼‰ï¼Œä¸”åŸºæœ¬æ²¡æœ‰è€ƒè™‘ä¸»é”®å’Œç´¢å¼•è®¾è®¡ï¼›
- ç¨‹åºæµç¨‹åŸºæœ¬æ¯”è¾ƒç®€å•ï¼Œç¼ºå°‘ä¸»çº¿ï¼Œæ— æ³•æè¿°æ ¸å¿ƒç®—æ³•åŠå…³é”®ç‚¹ ï¼ˆä¾‹å¦‚å„ç§æ ¡éªŒã€äº‹åŠ¡ã€å¹¶å‘ã€ç¼“å­˜ç­‰å¤„ç†ï¼‰ï¼›
- ç±»å›¾ç¼ºä¹ä½“ç°ç±»ä¹‹é—´çš„å…³ç³»ï¼Œæœ‰çš„ç›´æ¥ç”¨è‹±æ–‡å‡½æ•°åï¼Œç¼ºä¹æè¿°ï¼›
- æ—¶åºå›¾å¤§å¤šåªæè¿°ä¸æ•°æ®åº“çš„äº¤äº’ï¼Œç¼ºå°‘ä¸šåŠ¡æµç¨‹å’Œç¨‹åºæ‰§è¡Œçš„æ—¶åºå›¾ï¼›
- ä¸ç†è§£è®¾è®¡æ–‡æ¡£çš„æ„ä¹‰ï¼Œå¾ˆç®€å•çš„ä»»åŠ¡éœ€æ±‚å°±ä¸éœ€è¦å†™è®¾è®¡æ–‡æ¡£äº†ï¼›
- ç¼ºå°‘å¯¹å®‰å…¨ã€æ€§èƒ½ã€è¾¹ç•Œæƒ…å†µã€æ€§ä»·æ¯”çš„æ€è€ƒï¼Œè€ƒè™‘è¿˜ä¸å¤Ÿå…¨é¢ï¼Œè¯„å®¡æŠŠå…³ä¸ä¸¥ï¼›

æ€»ç»“äº†å‡ ç‚¹éœ€è¦æ³¨æ„çš„é—®é¢˜ç»™å¤§å®¶å‚è€ƒï¼š

1. **æ–‡æ¡£æ’°å†™äºº**ï¼šæ¶æ„è®¾è®¡å¸ˆæˆ–åŠŸèƒ½çš„å¼€å‘è€…ï¼›
2. **æ˜ç¡®æ–‡æ¡£é¢å‘çš„è¯»è€…**ï¼šæ˜¯éƒ¨é—¨å†…éƒ¨çš„å¼€å‘è€…ï¼Ÿä¼™ä¼´å®æ–½äººå‘˜ï¼Ÿå¤–éƒ¨çš„å¼€å‘è€…ï¼Ÿ
3. **è®¾è®¡å…ˆè¡Œ**ï¼šè®¾è®¡æ–‡æ¡£åœ¨æ’°å†™åº”è¯¥æ˜¯åœ¨ç¼–ç ä¹‹å‰ï¼Œå¯ä»¥æå¤§çš„é¿å…åæœŸå‡ºç°è¿”å·¥çš„æƒ…å†µï¼Œä¹Ÿèƒ½æå‡å¼€å‘æ•ˆç‡ï¼›
4. **ä¸€å›¾èƒœåƒè¨€**ï¼šå°½å¯èƒ½çš„ä½¿ç”¨å›¾æ–‡çš„æ–¹å¼è¡¨è¾¾æ¸…æ¥šè®¾è®¡æ€è·¯ï¼›
5. **ç»Ÿä¸€çš„ç»˜å›¾å·¥å…·**ï¼šéœ€è¦æ”¯æŒå¯¼å…¥åŠå¯¼å‡ºï¼Œæ–¹ä¾¿åç»­æ›´æ–°ï¼›
6. **ç»Ÿä¸€çš„æ–‡æ¡£æ¨¡æ¿**ï¼šä¸ºäº†é˜²æ­¢å‡ºç°åƒå¥‡ç™¾æ€ªçš„æ–‡æ¡£ã€æ’ç‰ˆä¸ä¸€è‡´ã€éš¾ä»¥é˜…è¯»ç­‰çš„é—®é¢˜ï¼›
7. **ç¡®å®šæ‰¿è½½çš„å½¢å¼**ï¼šå¯ä»¥ä»å®‰å…¨æ€§ï¼ˆæ–‡æ¡£åŠ å¯†ï¼‰ã€ä¾¿äºæŸ¥çœ‹ã€ç‰ˆæœ¬ç®¡ç†ç­‰æ–¹é¢è€ƒè™‘ï¼Œæ¨èå†…éƒ¨çš„çŸ¥è¯†æ–‡æ¡£ç®¡ç†ç³»ç»Ÿã€ç±»ä¼¼ wiki, git, svn çš„ç‰ˆæœ¬ç®¡ç†å·¥å…·ã€å†…ç½‘å¾®ç›˜ï¼›
8. **å¥½ä»£ç ä¼˜äºè®¾è®¡æ–‡æ¡£**ï¼šæœ‰æ—¶å€™å†™å‡ºä¼˜é›…çš„ä»£ç å’Œæ³¨é‡Šæ›´èƒœäºå†™ä¸€ç¯‡è®¾è®¡æ–‡æ¡£ï¼›
9. **ç‰ˆæœ¬è¿­ä»£**ï¼šåœ¨è½¯ä»¶åŠŸèƒ½è¿­ä»£çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ç»è¿‡å‡ æ¬¡è¿­ä»£ååŠŸèƒ½å’Œè®¾è®¡æœ‰äº†å¾ˆå¤§çš„å˜åŒ–ï¼Œè®¾è®¡æ–‡æ¡£åº”è¯¥åŠæ—¶æ›´æ–°ï¼Œä»¥å…ç»™äººä¼ é€’é”™è¯¯çš„ä¿¡æ¯ï¼›

## 2. å¦‚ä½•å†™å¥½æŠ€æœ¯æ–‡æ¡£

### 2.1 æ–¹æ³•è®º

#### 2.1.1 5W æ³•åˆ™

5W æ³•åˆ™ç›¸ä¿¡å¤§å®¶å·²ç»å¬çš„å¤šäº†ï¼Œåˆ†åˆ«æ˜¯ Whoã€Whatã€Whenã€Whereã€Whyã€‚è¿™æ˜¯ä¸€ä¸ªå¹¿æ³›è¢«ç”¨åœ¨å„è¡Œå„ä¸šçš„æ³•åˆ™ï¼Œå†™æ–‡æ¡£å½“ç„¶ä¹Ÿä¸ä¾‹å¤–ã€‚

**Who**ï¼šæ–‡æ¡£çš„é’ˆå¯¹å¯¹è±¡æ˜¯è°ï¼Œè¯»è€…æ˜¯è°ã€‚

**What**ï¼šæ˜ç¡®æ–‡æ¡£å†™ä½œçš„ç”¨é€”ï¼Œé€šå¸¸ä»…éœ€è¯´æ˜æ–‡æ¡£çš„ç”¨é€”å’Œç›®çš„å°±èƒ½å¸®ä½ æ­å»ºèµ·æ•´ä¸ªæ–‡æ¡£çš„æ¡†æ¶ã€‚

**When**ï¼šæ˜ç¡®æ–‡æ¡£çš„åˆ›å»ºã€Review å’Œæ›´æ–°æ—¥æœŸã€‚å› ä¸ºæ–‡æ¡£ä¹Ÿæœ‰æ—¶æ•ˆæ€§ï¼Œæ˜ç¡®ç›¸å…³æ—¥æœŸå¯ä»¥é¿å…é˜…è¯»è€…è¸©å‘ã€‚

**Where**ï¼šæ–‡æ¡£åº”è¯¥æ”¾åœ¨å“ªï¼å»ºè®®ä¸€ä¸ªç»„ç»‡æˆ–è€…å›¢é˜Ÿæœ‰ç»Ÿä¸€çš„æ°¸ä¹…æ–‡æ¡£å­˜æ”¾åœ°å€ï¼Œå¹¶ä¸”æœ‰ç‰ˆæœ¬æ§åˆ¶ã€‚æœ€å¥½æ˜¯æ–¹ä¾¿æŸ¥æ‰¾ã€ä½¿ç”¨å’Œåˆ†äº«ã€‚

**Why**ï¼šä¸ºä»€ä¹ˆè¦å†™è¿™ç¯‡æ–‡æ¡£ï¼Œ ä½ æœŸæœ›è¯»è€…è¯»å®Œåä»æ–‡æ¡£ä¸­è·å¾—ä»€ä¹ˆï¼

#### 2.1.2 é‡‘å­—å¡”åŸåˆ™

æˆ‘çŸ¥é“è¿™æ˜¯å°å­¦ä½œæ–‡é‡Œéƒ½ä¼šç”¨çš„å¥—è·¯ã€‚ä½†æ˜¯ï¼Œit worksã€‚å¯¹äº†ï¼Œæ¯”è¾ƒä¸“ä¸šä¸€ç‚¹çš„è¯´æ³•æ˜¯å«åš **é‡‘å­—å¡”åŸç†**ã€‚
é‡‘å­—å¡”åŸç†ï¼š

```
ä¸­å¿ƒæ€æƒ³1
1. æ”¯æ’‘è§‚ç‚¹
2. æ”¯æ’‘è§‚ç‚¹
3. æ”¯æ’‘è§‚ç‚¹

ä¸­å¿ƒæ€æƒ³2
4. æ”¯æ’‘è§‚ç‚¹
5. æ”¯æ’‘è§‚ç‚¹
6. æ”¯æ’‘è§‚ç‚¹
```

#### 2.1.3 ä»æ¨¡ä»¿å¼€å§‹

[Vue.js](https://cn.vuejs.org/guide/introduction.html)

[Dubbo](https://cn.dubbo.apache.org/zh-cn/overview/home/)

[ShardingSphere](https://shardingsphere.apache.org/document/current/cn/overview/)

[Mybatis-Plus](https://baomidou.com/)

[GitBook](https://docs.gitbook.com/)

[docsify](https://docsify.js.org/#/?id=docsify)

[Docusaurus](https://docusaurus.io/zh-CN/)

#### 2.1.4 ä»å°æ–‡æ¡£å¼€å§‹

ä»ä¸€ä¸ªå°çš„æŠ€æœ¯å®ç°ç»†èŠ‚å¼€å§‹, åˆ°æ•´ä¸ªæŠ€æœ¯æ–¹æ¡ˆ, å†åˆ°ç³»ç»Ÿçš„æŠ€æœ¯æ–¹æ¡ˆã€‚

#### 2.1.5 ä»ç²—åˆ°ç»†, è¿­ä»£æ›´æ–°

**å¤§çº²ç”±äºç»†èŠ‚**.

è¯¦ç»†çš„æŠ€æœ¯æ–‡æ¡£è¦èŠ±å¾ˆå¤šæ—¶é—´ç²¾åŠ›ï¼Œç”šè‡³å¯èƒ½å†™ä¸ä¸‹å»ï¼›å¦ä¸€ä¸ªåŸå› å°±æ˜¯åœ¨æ”¶é›†åé¦ˆçš„è¿‡ç¨‹ä¸­ï¼Œä¼šæœ‰å¾ˆå¤šä¿®æ”¹ã€‚**å†™å¾—è¶Šç»†åˆ™æ— ç”¨åŠŸè¶Šå¤šï¼Œæœ€åï¼Œä½ ç”šè‡³ä¼šå› ä¸ºä¸æƒ³æ”¹æ–‡æ¡£è€ŒæŠµè§¦ä¸åŒçš„æ„è§ã€‚**

è€Œä»ç²—åˆ°ç»†é€æ­¥è¿­ä»£çš„æ–¹å¼å°±å¥½å¤šäº†ï¼Œä¸€å¼€å§‹çš„ç›®çš„æ˜¯ä¸ºäº†æ¢³ç†æ¸…æ¥šæ€è·¯ï¼Œåªè¦è„‘å›¾è¿™ç§çº§åˆ«çš„å†…å®¹å°±å¥½äº†ï¼Œç„¶åè¿›è¡Œè°ƒæ•´ã€‚å› ä¸ºæ–‡æ¡£å¾ˆç²—ï¼Œè°ƒæ•´ä¹Ÿæ–¹ä¾¿ï¼Œç­‰åˆ°åŸºæœ¬ç¡®å®šåå†å†™ç»†èŠ‚ï¼Œå°±ä¸ä¼šæœ‰å¤§çš„åå¤ã€‚

### 2.2 æ’ç‰ˆ

æ–‡æ¡£æ’ç‰ˆæˆ‘æ”¾åœ¨æ¯”è¾ƒé‡è¦çš„ä½ç½®, å› ä¸ºæˆ‘åªè¦çœ‹åˆ°æ’ç‰ˆç‰¹åˆ«ä¹±çš„æ–‡æ¡£å°±ç›´æ¥æ”¾å¼ƒé˜…è¯», è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä¸æ„¿æ„æ¥å—æˆ–ä½¿ç”¨ Word æ¥å†™æŠ€æœ¯æ–‡æ¡£çš„åŸå› (å› ä¸ºä¼šèŠ±è´¹å¤§é‡çš„æ—¶é—´åœ¨æ’ç‰ˆä¸Š)ã€‚

è¿™é‡Œç®€å•çš„ç½—åˆ—ä¸€ä¸‹å¥½çš„æ’ç‰ˆ:

- **é¿å…ä½çº§é”™è¯¯**ï¼šé¿å…å‡ºç°é”™åˆ«å­—ã€è¯è¯­è¯¯ç”¨ã€æ ‡ç‚¹ç¬¦å·é”™è¯¯ç­‰ç°è±¡ï¼›
- **é¦–è¡Œä¸ç”¨ç¼©è¿›**ï¼šå°æ—¶å€™è€å¸ˆç»å¸¸æ•™æˆ‘ä»¬é¦–è¡Œç¼©è¿›ï¼Œä½†æ˜¯ä¸ªäººå»ºè®®ä¸ç¼©è¿›ï¼Œå› ä¸ºä½ ä¸æ˜¯å†™è®ºæ–‡ï¼›
- **æ®µè½åŒºåˆ†**ï¼šé€šè¿‡ã€Œç©ºä¸€è¡Œã€æ¥åŒºåˆ†æ®µè½ï¼Œå¹¶ä¸”æ¯ä¸ªæ®µè½çš„æ–‡å­—ä¸è¦è¿‡é•¿ï¼Œå¦åˆ™ä½ ä¼šå‘ç°ä¸€å †çš„æ–‡å­—å †ç Œåœ¨ä¸€èµ·ï¼Œå¯†å¯†éº»éº»çš„è®©äººå¤±å»ç»§ç»­é˜…è¯»ä¸‹å»çš„å…´è¶£ï¼›
- **ä¿ç•™ç©ºæ ¼**ï¼šå½“è‹±æ–‡ã€æ•°å­—å’Œä¸­æ–‡ç›¸é‡çš„æ—¶å€™ï¼Œä»–ä»¬ä¹‹é—´è¦ **ç•™ä¸€ä¸ªç©ºæ ¼**ï¼Œè¿™æ ·é˜…è¯»èµ·æ¥ä¼šæ›´èˆ’é€‚ï¼›
- **ä¸“æœ‰åè¯**ï¼šå¾ˆå¤šäººæŠŠ Java å†™æˆ JAVAï¼ŒMySQL å†™æˆ mysqlï¼Œä¼šæ˜¾å¾—å¾ˆä¸ä¸“ä¸šã€‚

**é¦–è¡Œç¼©è¿›å’Œæ®µè½åŒºåˆ†ï¼š**

![20241229154732_z2mHN74B.webp](https://cdn.dong4j.site/source/image/20241229154732_z2mHN74B.webp)

**å½“è‹±æ–‡ã€æ•°å­—å’Œä¸­æ–‡ç›¸é‡çš„æ—¶å€™ï¼š**

![20241229154732_2DaghWgm.webp](https://cdn.dong4j.site/source/image/20241229154732_2DaghWgm.webp)

1. [ä¸­æ–‡æŠ€æœ¯æ–‡æ¡£ä¹¦å†™æŒ‡ä¸œ](https://sspai.com/post/68349)
2. [ç»™ç¨‹åºå‘˜çš„ä¸­æ–‡å†™ä½œæŒ‡åŒ—](https://blog.csdn.net/weixin_39638014/article/details/112327421)

### 2.3 å¸¸ç”¨å·¥å…·

1. Markdown: åŸºç¡€è¯­æ³•
2. Typora: Markdown ç¼–è¾‘å·¥å…·
3. draw.io: è·¨å¹³å°çš„ç”»å›¾å·¥å…·; IDEAã€Visual Studio Code æ’ä»¶
4. Figma: åŸå‹å·¥å…·

ä¸€èˆ¬æ¥è¯´ï¼Œåªè¦åˆ«äººå‘ç»™æˆ‘çš„æ–‡æ¡£æ˜¯ä¸€ä»½ Word æ–‡æ¡£ï¼Œæˆ‘åŸºæœ¬å°±æŠŠè¿™ä»½æ–‡æ¡£æ’åœ¨äº†æœ€ Low çš„ä¸€æ¡£ã€‚å¯¹äºè¿™ç§æ–‡æ¡£ï¼Œæˆ‘å°±æƒ³é—®ä¸‰ç‚¹ï¼š

- æ–‡æ¡£æœ‰æ›´æ–°æ€ä¹ˆåˆ†å‘ç»™æ¯ä¸ªéœ€è¦è¿™ä»½æ–‡æ¡£çš„äººï¼Ÿ
- Word æ ¼å¼ä¸å…¼å®¹å¯¼è‡´å…³é”®å›¾è¡¨æ’ç‰ˆæ··ä¹±æ€ä¹ˆåŠï¼Ÿ
- ä»£ç å› ç³»ç»Ÿä¸åŒå­˜åœ¨çš„æ¢ä½ç¬¦ä¸åŒå¯¼è‡´çš„é”™è¯¯é—®é¢˜æ€ä¹ˆè§£å†³?

**ä¸çŸ¥é“å¤§å®¶å¤šå¹´å‰æœ‰æ²¡æœ‰è¢« Windows æ–‡æœ¬ç¼–è¾‘å™¨çš„ BOM æå¾—é¸¡é£ç‹—è·³?**

å¯¹äº Word/Pdf æˆ‘æ˜¯æåŠ›æ’æ–¥çš„ï¼Œå› ä¸ºå¾ˆå¤šæ–‡æ¡£éƒ½æ˜¯éœ€è¦æ›´æ–°çš„ï¼Œè¿™ä¸¤ç§æ ¼å¼æ²¡æ³•åšåˆ°**åŠ¨æ€æ›´æ–°** ã€‚

#### 2.3.1 ä¸ºä»€ä¹ˆç”¨ Markdown

- Markdown æ—¶ä¸‹æœ€ä¸ºç«çƒ­çš„æ–‡æœ¬æ ‡è®°è¯­è¨€ï¼Œæ˜¯ç›®å‰å®˜æ–¹æ–‡æ¡£ã€æŠ€æœ¯åšå®¢ä¸­æœ€ä¸»æµçš„æ–‡æ¡£ç¼–æ’æ–¹å¼ï¼›
- ä¸éœ€è¦èŠ±è´¹å¾ˆé•¿çš„æ—¶é—´å­¦ä¹  Markdown çš„è¯­æ³•ï¼Œå®ƒçš„è¯­æ³•çœŸçš„éå¸¸ç®€å•ï¼›
- ä¸“æ³¨äºæ–‡æ¡£ç¼–å†™ï¼Œå°½é‡å°‘çš„ç²¾åŠ›å…³æ³¨å¤æ‚çš„æ ¼å¼ã€‚é™¤ä¸€äº›é¡¹ç›®è®¾è®¡ä¹¦å¤–ï¼Œæ¯”è¾ƒå»ºè®®ç”¨ Word æ¥ç¼–å†™ï¼Œç»å¤§å¤šæ•°æŒ‡å¯¼ç±»æ–‡æ¡£ã€ç¯å¢ƒé…ç½®æŒ‡å¯¼ç­‰æ–‡æ¡£éƒ½æ¨èä½¿ç”¨ Markdown æ¥ä¹¦å†™ï¼›
- ä¸“æ³¨äºæ–‡æ¡£å†…å®¹çš„ç¼–å†™ï¼Œæ— éœ€è¿‡å¤šå…³ç³»æ–‡æœ¬æ ¼å¼ï¼Œæ”¯æŒè·¨å¹³å°æ–‡æ¡£ï¼Œä¸éœ€è¦è€ƒè™‘å…¼å®¹æ€§ï¼›
- æ›´åŠ ç¬¦åˆç¨‹åºå‘˜çš„ç¼–ç¨‹è§„èŒƒï¼Œåƒç¼–ç¨‹ä¸€äº›ç¼–å†™æ–‡æ¡£ï¼Œåƒä»£ç å·¥ç¨‹ä¸€æ ·æ¼”è¿›æ–‡æ¡£ï¼›
- åœ¨é¡¹ç›®å¼€å‘ä¸­å¸¸å¸¸ä¼šéœ€è¦ç¼–å†™ `REAMDE.md` æ–‡æ¡£ï¼Œç‰¹åˆ«åœ¨ Github çš„å¼€æºæ¼”è¿›ä¸­ï¼›

Markdown æ¯”è¾ƒå—å¼€æºç¤¾åŒºçš„æ¬¢è¿ï¼Œå› ä¸ºå®ƒåœ¨è¡¨è¾¾åŠ›å’Œç®€æ´æ€§ä¹‹é—´æ‰¾åˆ°äº†ä¸€ä¸ªå¹³è¡¡ç‚¹ï¼Œä½†æ˜¯å®ƒæœ‰ä¸€ä¸ªè‡´å‘½é—®é¢˜å°±æ˜¯ **æ— æ³•åº”ä»˜ç¨å¾®å¤æ‚ä¸€ç‚¹çš„æ’ç‰ˆ**ã€‚

#### 2.3.2 ä¸ºä»€ä¹ˆä½¿ç”¨ draw.io

> [draw.io](http://draw.io/) å½“å‰å·²ç»æ”¹åæˆ [diagrams.net](http://diagrams.net/)ï¼Œæ˜¯ä¸€æ¬¾å…è´¹çš„åœ¨çº¿å›¾è¡¨ç¼–è¾‘å·¥å…·ï¼Œå¯ä»¥ç”¨æ¥ç¼–è¾‘ BPM, org charts, UML, ER å›¾, ç½‘ç»œæ‹“æœ´å›¾ç­‰å„ç§è¦†ç›–çš„å›¾ã€‚
>
> ç±»ä¼¼äº ProcessOn çš„åœ¨çº¿ç”»å›¾å¹³å°ï¼Œä½†æ˜¯ [draw.io](http://draw.io/) **è·¨å¹³å°** ä¸”å®Œå…¨å…è´¹ã€‚æ”¯æŒåœ¨çº¿ç›´æ¥ç”»å›¾ï¼Œchrome æ’ä»¶å®¢æˆ·ç«¯ï¼Œæ¡Œé¢å®¢æˆ·ç«¯ã€‚

**æ¨èä½¿ç”¨ [draw.io](http://draw.io/) ç»˜å›¾ï¼Œå¯¼å‡ºä¸º svg å›¾ç‰‡ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨æˆªå›¾, åŸå› æœ‰ 2 ç‚¹:**

1. svg æ˜¯çŸ¢é‡å›¾, æ— é™æ”¾å¤§ä¸å¤±çœŸ;
2. **å¯åœ¨åŸæ¥çš„åŸºç¡€ä¸Šå†æ¬¡ç¼–è¾‘**;

åˆ—ä¸¾äº†ä¸€äº›å‚è€ƒèµ„æ–™ï¼š

1. [æµç¨‹å›¾](http://www.woshipm.com/zhichang/2329530.html)
2. [æ—¶åºå›¾](http://www.woshipm.com/ucd/607593.html)
3. [ç±»å›¾](https://design-patterns.readthedocs.io/zh_CN/latest/read_uml.html)
4. [ç¨‹åºæµç¨‹å›¾](https://cn.vuejs.org/v2/guide/instance.html#ç”Ÿå‘½å‘¨æœŸå›¾ç¤º)
5. [E-R å›¾](http://www.woshipm.com/pmd/4282120.html)

### 2.4 é…å›¾æŠ€å·§

**ä¸€å›¾èƒœåƒè¨€, æ— å›¾æ— çœŸç›¸**

![20241229154732_hafXGYDV.webp](https://cdn.dong4j.site/source/image/20241229154732_hafXGYDV.webp)

1. é…å›¾ä¸‹é¢åŠ ä¸Šä¸€äº›å›¾ç‰‡çš„å…³é”®æè¿°
2. **ä½¿ç”¨ svg ä»£æ›¿ png**
3. ä¸è¦è®²èƒŒæ™¯è®¾ç½®ä¸ºç½‘æ ¼
4. æ•´ä½“ä½¿ç”¨ä½é¥±å’Œé¢œè‰²å³å¯, å…³é”®çš„åœ°æ–¹å¯é€‚å½“ä½¿ç”¨é«˜é¥±å’Œé¢œè‰²

### 2.5 å¼•ç”¨/å‚è€ƒèµ„æ–™

- ç›¸å…³éœ€æ±‚å•ï¼šæ¯”å¦‚æŸä¸ªä¸šåŠ¡æ‰€æœ‰ç›¸å…³çš„éœ€æ±‚å•éƒ½æ”¾åœ¨è¿™é‡Œï¼Œæ–¹ä¾¿å…¶ä»–äººæ›´è¿›ä¸€æ­¥äº†è§£èƒŒæ™¯ï¼Œä¹Ÿæ–¹ä¾¿è‡ªå·±æŸ¥æ‰¾ã€‚
- å‚è€ƒèµ„æ–™ã€‚

![20241229154732_0fcUdhjY.webp](https://cdn.dong4j.site/source/image/20241229154732_0fcUdhjY.webp)

![20241229154732_zejNqXzR.webp](https://cdn.dong4j.site/source/image/20241229154732_zejNqXzR.webp)

### 2.6 å˜æ›´å†å²

å˜æ›´æ—¥å¿—ï¼Œä¸€èˆ¬å¼€æºé¡¹ç›®éƒ½ä¼šè®°å½•æ¯ä¸ªç‰ˆæœ¬çš„é‡è¦å˜æ›´ã€‚

![20241229154732_RiUlq0xE.webp](https://cdn.dong4j.site/source/image/20241229154732_RiUlq0xE.webp)

**æ–‡æ¡£å˜æ›´è®°å½•:**

![20241229154732_W4R6f7Gy.webp](https://cdn.dong4j.site/source/image/20241229154732_W4R6f7Gy.webp)

### 2.7 ç»´æŠ¤å·¥å…·

å¯¹äºæ–‡æ¡£çš„ç®¡ç†ï¼Œæˆ‘æ¨èä½¿ç”¨ Gitï¼Œåƒç®¡ç†ä»£ç ä¸€æ ·ç®¡ç†æ–‡æ¡£ã€‚å¦å¤–æˆ‘æ¨èä½¿ç”¨ä¸€ä¸ªé™æ€ç½‘ç«™æ¥å­˜æ”¾è‡ªå·±çš„æ–‡æ¡£ï¼Œè¿™æ ·å…¶ä»–åŒäº‹è®¿é—®çš„æ—¶å€™çœ‹åˆ°çš„æ€»æ˜¯æœ€æ–°çš„æ–‡æ¡£ã€‚

![20241229154732_dAKcrIAo.webp](https://cdn.dong4j.site/source/image/20241229154732_dAKcrIAo.webp)

## 3. æ¦‚è¦/è¯¦ç»†è®¾è®¡

åœ¨å†™è½¯ä»¶æ¦‚è¦/è¯¦ç»†è®¾è®¡è¯´æ˜ä¹¦æ—¶ï¼Œé¦–å…ˆåº”è¯¥æ˜ç¡®è¯»è€…æ˜¯ **ä¸“ä¸šçš„å¼€å‘äººå‘˜**ï¼Œæ–‡æ¡£åº”è¯¥ä¸¥è°¨ç»†è‡´ï¼Œä¸“ä¸šæ€§å¼ºã€‚

å…¶æ¬¡åº”è¯¥æ˜ç¡®è½¯ä»¶æ¦‚è¦/è¯¦ç»†è¯´æ˜ä¹¦çš„è®¾è®¡ä¾æ®æ˜¯éœ€æ±‚è§„æ ¼è¯´æ˜ä¹¦ï¼Œéœ€æ±‚è§„æ ¼è¯´æ˜ä¹¦ä¸­çš„è¦ç´ åº”è¯¥èƒ½å¤Ÿä¸è½¯ä»¶æ¦‚è¦/è¯¦ç»†è¯´æ˜ä¹¦ä¸­çš„è¦ç´ å®Œå…¨å¯¹åº”ï¼Œå³ç¬¦åˆéœ€æ±‚è¿½è¸ªè¡¨ã€‚

è½¯ä»¶æ¦‚è¦/è¯¦ç»†è®¾è®¡è¯´æ˜ä¹¦æ˜¯ä»æŠ€æœ¯å®ç°çš„è§’åº¦å°†éœ€æ±‚è§„æ ¼è¯´æ˜ä¹¦è¿›è¡Œå±•å¼€ï¼Œå½¢æˆæè¿°è½¯ä»¶æ¶æ„çš„æ–‡æ¡£ã€‚è½¯ä»¶æ¶æ„åº”è¯¥æ˜¯æŒ‰ç…§ã€ŒMECE åŸåˆ™ã€æ‹†åˆ†ä¸ºå¤šä¸ªæ¨¡å—çš„å¤šå±‚æ¬¡çš„ç»“æ„ï¼Œè¿™äº›æ¨¡å—èƒ½å¤Ÿå®Œå…¨ç©·å°½éœ€æ±‚è§„æ ¼è¯´æ˜ä¹¦ä¸­çš„è¦æ±‚ï¼ŒåŒæ—¶åˆç›¸äº’ç‹¬ç«‹ã€‚ä½¿ç”¨ UML å›¾æè¿°ç±»å›¾ã€ç»“æ„å›¾ã€‚

è½¯ä»¶æ¦‚è¦/è¯¦ç»†è®¾è®¡è¯´æ˜ä¹¦è¿˜éœ€è¦å†™åŠ¨æ€è¿‡ç¨‹ï¼Œå€ŸåŠ©æµç¨‹å›¾[æ³³é“å›¾ã€çŠ¶æ€å›¾ï¼Œå†™æ¸…æ¥šè½¯ä»¶æ¨¡å—çš„æ‰§è¡Œè¿‡ç¨‹ã€‚

è½¯ä»¶æ¦‚è¦/è¯¦ç»†è®¾è®¡è¯´æ˜ä¹¦æ‹Ÿåˆ¶ç»“æŸåï¼Œåº”è¯¥æ˜¯å¤šä¸ªäº’ç›¸ç‹¬ç«‹è§£è€¦çš„æ¨¡å—ï¼Œè¿™äº›æ¨¡å—å°±å¯ä»¥åˆ†é…ç»™ä¸åŒçš„ç¨‹åºå‘˜åŒæ­¥è¿›è¡Œå¼€å‘ã€‚

## 4. æ€»ç»“

é‚£ä¹ˆä»€ä¹ˆæ ·çš„æ–‡æ¡£æ‰ç§°å¾—ä¸Šæ˜¯ä¸€ä¸ªå¥½çš„æ–‡æ¡£? æˆ‘è®¤ä¸ºåº”è¯¥æ»¡è¶³ä»¥ä¸‹å‡ ç‚¹ï¼š

1. **é«˜åº¦å¯ç»´æŠ¤çš„å¹¶ä¸”ç»å¸¸ç»´æŠ¤**ï¼›
2. æ˜“äºç†è§£ï¼šè¡¨è¾¾å‡†ç¡®ã€ç»“æ„æ¸…æ™°ã€æ’ç‰ˆç¾è§‚ã€é£æ ¼ç»Ÿä¸€ï¼›

æœ‰å“ªäº›æ–¹æ³•è®ºå’Œå·¥å…·èƒ½å¸®åŠ©æˆ‘ä»¬å»æä¾›æ–‡æ¡£è´¨é‡:

1. å¤šçœ‹ä¼˜è´¨çš„æŠ€æœ¯æ–‡æ¡£, å­¦ä¹ å†™ä½œå¤§çº²ã€ é…å›¾ã€æ’ç‰ˆ;
2. å¤šæ„æ€, å¤šå†™, å¤šç»ƒä¹ , å½¢æˆä¸€å¥—è‡ªå·±çš„æ„Ÿè°¢åšæ–¹å¼ä¸æ–¹æ³•;
3. ä½¿ç”¨ä¸šå†…å¸¸ç”¨çš„ã€è·¨å¹³å°çš„å·¥å…·, ä¸€ä¸ªå›¢é˜Ÿæœ€å¥½å…¨éƒ¨ç»Ÿä¸€;

## [Mavenå…¥é—¨æŒ‡å—ï¼šæŒæ¡é¡¹ç›®ç®¡ç†çš„æ ¸å¿ƒå·¥å…·](https://blog.dong4j.site/posts/6c5526f1.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## 1. ä¸ºä»€ä¹ˆç”¨æ„ä»¶ç®¡ç†å·¥å…·

1. ä¸€ä¸ªé¡¹ç›®å°±æ˜¯ä¸€ä¸ªå·¥ç¨‹

â€‹ å¦‚æœé¡¹ç›®éå¸¸åºå¤§ï¼Œå°±ä¸é€‚åˆä½¿ç”¨ package æ¥åˆ’åˆ†æ¨¡å—ï¼Œæœ€å¥½æ˜¯æ¯ä¸€ä¸ªæ¨¡å—å¯¹åº”ä¸€ä¸ªå·¥ç¨‹ï¼Œåˆ©äºåˆ†å·¥åä½œã€‚å€ŸåŠ©äºæ„ä»¶ç®¡ç†å·¥å…·å°±å¯ä»¥å°†ä¸€ä¸ªé¡¹ç›®æ‹†åˆ†æˆå¤šä¸ªå·¥ç¨‹

2. é¡¹ç›®ä¸­ä½¿ç”¨ jar åŒ…ï¼Œéœ€è¦â€œå¤åˆ¶â€ã€â€œç²˜è´´â€é¡¹ç›®çš„ lib ä¸­

â€‹ åŒæ ·çš„ jar åŒ…é‡å¤çš„å‡ºç°åœ¨ä¸åŒçš„é¡¹ç›®å·¥ç¨‹ä¸­ï¼Œä½ éœ€è¦åšä¸åœçš„å¤åˆ¶ç²˜è´´çš„é‡å¤å·¥ä½œã€‚å€ŸåŠ©äºæ„ä»¶ç®¡ç†å·¥å…·å¯ä»¥å°† jar åŒ…ä¿å­˜åœ¨â€œä»“åº“â€ä¸­ï¼Œä¸ç®¡åœ¨å“ªä¸ªé¡¹ç›®åªè¦ä½¿ç”¨å¼•ç”¨å³å¯å°±è¡Œã€‚

3. jar åŒ…éœ€è¦çš„æ—¶å€™æ¯æ¬¡éƒ½è¦è‡ªå·±å‡†å¤‡å¥½æˆ–åˆ°å®˜ç½‘ä¸‹è½½

â€‹ å€ŸåŠ©äºæ„ä»¶ç®¡ç†å·¥å…·æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç»Ÿä¸€çš„è§„èŒƒæ–¹å¼ä¸‹è½½ jar åŒ… L

4. jar åŒ…ç‰ˆæœ¬ä¸ä¸€è‡´çš„é£é™©

â€‹ ä¸åŒçš„é¡¹ç›®åœ¨ä½¿ç”¨ jar åŒ…çš„æ—¶å€™ï¼Œæœ‰å¯èƒ½ä¼šå¯¼è‡´å„ä¸ªé¡¹ç›®çš„ jar åŒ…ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå¯¼è‡´æœªæ‰§è¡Œé”™è¯¯ã€‚å€ŸåŠ©äºæ„ä»¶ç®¡ç†å·¥å…·ï¼Œæ‰€æœ‰çš„ jar åŒ…éƒ½æ”¾åœ¨â€œä»“åº“â€ä¸­ï¼Œæ‰€æœ‰çš„é¡¹ç›®éƒ½ä½¿ç”¨ä»“åº“çš„ä¸€ä»½ jar åŒ…ã€‚

5. ä¸€ä¸ª jar åŒ…ä¾èµ–å…¶ä»–çš„ jar åŒ…éœ€è¦è‡ªå·±æ‰‹åŠ¨çš„åŠ å…¥åˆ°é¡¹ç›®ä¸­

â€‹ FileUpload ç»„ä»¶->IO ç»„ä»¶ï¼Œcommons-fileupload-1.3.jar ä¾èµ–äº commons-io-2.0.1.jar

â€‹ æå¤§çš„æµªè´¹äº†æˆ‘ä»¬å¯¼å…¥åŒ…çš„æ—¶é—´æˆæœ¬ï¼Œä¹Ÿæå¤§çš„å¢åŠ äº†å­¦ä¹ æˆæœ¬ã€‚å€ŸåŠ©äºæ„ä»¶ç®¡ç†å·¥å…·ï¼Œå®ƒä¼šè‡ªåŠ¨çš„å°†ä¾èµ–çš„ jar åŒ…å¯¼å…¥è¿›æ¥ã€‚

6. ä¸åŒçš„é¡¹ç›®ä¸åŒçš„æ„å»ºæ–¹å¼

   åœ¨æ²¡æœ‰æ„ä»¶ç®¡ç†å·¥å…·ä¹‹å‰, ä¸åŒçš„é¡¹ç›®å¯èƒ½æœ‰å„ç§æ„å»ºæ–¹å¼, å­¦ä¹ æˆæœ¬é«˜, ä¸åˆ©äºå›¢é˜Ÿæ ‡å‡†åŒ–å»ºè®¾;

## 2. ä¸ºä»€ä¹ˆé€‰æ‹© Maven

| æ„å»ºå·¥å…·ç±»å‹ | ä¼˜ç‚¹     | ç¼ºç‚¹                             |
| ------------ | -------- | -------------------------------- |
| å£°æ˜å¼       | é…ç½®ç®€å• | çµæ´»æ€§ä¸å¤Ÿ                       |
| è¿‡ç¨‹å¼       | çµæ´»åº¦é«˜ | ç¼–å†™å¤æ‚, é¡¹ç›®æ„å»ºä»£ç å¤ç”¨éš¾åº¦å¤§ |

Maven æ˜¯ä¸€ç§**å£°æ˜å¼**é¡¹ç›®ç®¡ç†å·¥å…·ï¼Œé€šè¿‡åœ¨ POM ä¸­é…ç½® "who","what","where"ç­‰ä¿¡æ¯ï¼Œå³å¯æ»¡è¶³ç¼–è¯‘ã€æµ‹è¯•ã€æ‰“åŒ…ã€å‘å¸ƒç­‰é¡¹ç›®æ„å»ºéœ€æ±‚ã€‚ å£°æ˜å¼çš„å¥½å¤„æ˜¯ï¼Œç”¨æˆ·æ— éœ€å…³å¿ƒæ„å»ºå·¥å…·çš„å®ç°ç»†èŠ‚ï¼Œåªéœ€åœ¨ `pom.xml` ä¸­é…ç½®å¥½é¡¹ç›®åï¼Œä¾èµ–ç­‰åŸºç¡€ä¿¡æ¯å³å¯ã€‚åå¤„æ˜¯ï¼Œå®ç°è‡ªå®šä¹‰çš„æ„å»ºé€»è¾‘ï¼Œç›¸å¯¹å¤æ‚ã€‚ï¼ˆMaven ä¹Ÿæä¾›äº†æ’ä»¶ï¼Œå¦‚ï¼š`maven-antrun-plugin`ï¼Œæ¥è¿è¡Œç”¨æˆ·è‡ªå®šä¹‰è„šæœ¬ã€‚å½“ç„¶ï¼Œæ’ä»¶æœ€ç»ˆ apply åˆ° Maven çš„æ–¹å¼æœ€ç»ˆä»ç„¶æ˜¯**å£°æ˜å¼**çš„ï¼Œå³éœ€è¦åœ¨ POM ä¸­å£°æ˜æ’ä»¶è¿è¡Œæ—¶æœºå’Œæ’ä»¶ç›¸å…³é…ç½®ã€‚ï¼‰

ç›¸å¯¹åº”åœ°ï¼ŒMake å’Œ Ant ç­‰æ„å»ºå·¥å…·æ˜¯**è¿‡ç¨‹å¼**é¡¹ç›®ç®¡ç†å·¥å…·ï¼Œç”¨æˆ·éœ€è¦ç¼–å†™æ„å»ºè„šæœ¬å¹¶ç»„ç»‡å„è„šæœ¬çš„ä¾èµ–å…³ç³»ã€‚è¿‡ç¨‹å¼é¡¹ç›®ç®¡ç†å·¥å…·å¥½å¤„æ˜¯ï¼Œç”¨æˆ·è‡ªç”±åº¦å¾ˆå¤§ï¼›åå¤„æ˜¯ï¼Œé¡¹ç›®ç®¡ç†ç»éªŒæ— æ³•å¤ç”¨ï¼Œæ„å»ºè„šæœ¬ç¼–å†™è¾ƒä¸ºå¤æ‚ã€‚

**Spring Boot æŠŠ Maven å¹²æ‰äº†ï¼Œæ­£å¼æ‹¥æŠ± Gradle**

## 3. Maven æ˜¯ä»€ä¹ˆ

### 3.1 åè¯è§£é‡Š

**1. ä¾èµ–ï¼š** ä¾‹å¦‚æˆ‘ä»¬çš„é¡¹ç›®ä¸­éœ€è¦ servlet.jarï¼Œè¿™ä¸ª jar åŒ…å°±å¯ä»¥å«åšä¾èµ–ï¼Œæˆ–è€…è¯´é¡¹ç›®ä¾èµ– servlet.jarã€‚æˆ‘ä»¬åœ¨å¯¼å…¥ a.jar çš„æ—¶å€™å‘ç°è¿˜éœ€è¦å¯¼å…¥ b.jarï¼Œè¯´æ˜ a.jar ä¾èµ– b.jarã€‚

**2. é¡¹ç›®æ„å»ºï¼š** é¡¹ç›®æ„å»ºæè¿°çš„æ˜¯ä»£ç çš„ç¼–è¯‘ã€è¿è¡Œã€æ‰“åŒ…ã€éƒ¨ç½²ç­‰ä¸€ç³»åˆ—**è¿‡ç¨‹**ã€‚

- 1.é¡¹ç›®æ¸…ç†ï¼šæ¸…ç†ä¹‹å‰ç¼–è¯‘çš„ä»£ç ã€‚
- 2.ç¼–è¯‘ï¼šå°†ç¨‹åºæºä»£ç ç¼–è¯‘ä¸ºè™šæ‹Ÿæœºå¯æ‰§è¡Œçš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯ class æ–‡ä»¶ã€‚maven å¯ä»¥å¸®æˆ‘ä»¬æ‰¹é‡ç¼–è¯‘ä¸€å †ä»£ç ã€‚
- 3.æµ‹è¯•ï¼šmaven å¯ä»¥æ‰§è¡Œæµ‹è¯•ç¨‹åºä»£ç ï¼ŒéªŒè¯ä½ çš„åŠŸèƒ½æ˜¯å¦æ­£ç¡®ã€‚
- 4.æ‰“åŒ…ï¼šå°†æ‰€æœ‰çš„ class æ–‡ä»¶ã€é…ç½®æ–‡ä»¶ç­‰èµ„æºæ”¾åˆ°ä¸€ä¸ªå‹ç¼©æ–‡ä»¶ä¸­ã€‚ å¯¹äº java ç¨‹åºï¼Œå‹ç¼©æ–‡ä»¶æ˜¯ xx.jarï¼Œå¯¹äº web åº”ç”¨ï¼Œå‹ç¼©æ–‡ä»¶æ‰©å±•åæ˜¯ xx.warã€‚
- 5.å®‰è£…ï¼šå°† jar æ–‡ä»¶æˆ–è€… war æ–‡ä»¶å®‰è£…åˆ°æœ¬æœºä»“åº“ä¸­ã€‚
- 6.éƒ¨ç½²ï¼šå°†ç¨‹åºéƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç½‘å€è¿›è¡Œè®¿é—®ã€‚

### 3.2 Maven çš„ä½œç”¨

Maven æ˜¯ Apache è½¯ä»¶åŸºé‡‘ä¼šæ——ä¸‹ä¸€æ¬¾**è‡ªåŠ¨åŒ–æ„å»ºå·¥å…·**ï¼Œä¸“æ³¨äº Java å¹³å°çš„**é¡¹ç›®æ„å»º**å’Œ**ä¾èµ–ç®¡ç†**ã€‚

- Maven çš„å®˜ç½‘ï¼š https://maven.apache.org/
- Maven ä¸‹è½½åœ°å€ï¼šhttps://maven.apache.org/download.cgi
- Maven èµ„æºæ£€ç´¢ï¼šhttps://search.maven.org/

**ç®€å•ç‚¹è¯´ Maven å°±æ˜¯ä¸€ä¸ªå¥½ç”¨çš„å·¥å…·ã€‚æˆ‘ä»¬ä»¥å‰åšé¡¹ç›®éœ€è¦è‡ªå·±åˆ°ç½‘ä¸Šæ‰¾ jar åŒ…ï¼Œè€Œç”¨äº† Maven ä¹‹åï¼Œæˆ‘ä»¬åªéœ€è¦é…ç½®ä¸€ä¸‹ä¾èµ–çš„åæ ‡ï¼Œå®ƒä¼šè‡ªåŠ¨å°† jar åŒ…ä¸‹è½½åˆ°æˆ‘ä»¬ç”µè„‘ç¡¬ç›˜çš„æŸä¸€ä¸ªç›®å½•ä¸‹ã€‚**

é™¤äº†ç®¡ç† jar åŒ…ï¼Œå®ƒè¿˜èƒ½å¸®æˆ‘ä»¬å¹²å¾ˆå¤šäº‹æƒ…ï¼š

- è‡ªåŠ¨ä¸‹è½½éœ€è¦çš„ jar åŒ…ï¼Œç®¡ç† jar åŒ…çš„ç‰ˆæœ¬ä»¥åŠå®ƒä»¬ä¹‹é—´çš„ä¾èµ–å…³ç³»
- å¸®ä½ ç¼–è¯‘ç¨‹åº, æ‰“åŒ…ç¨‹åº, éƒ¨ç½²ç¨‹åº;
- ç”Ÿæˆ Javadoc site, åˆ›å»ºæµ‹è¯•æŠ¥å‘Š;
- å¸®ä½ ç®¡ç†é¡¹ç›®ä¸­å„ä¸ªæ¨¡å—çš„å…³ç³»
- ç»Ÿä¸€å¼€å‘ç»“æ„, æä¾›æ ‡å‡†çš„, ç»Ÿä¸€çš„é¡¹ç›®ç»“æ„

### 3.3 ä¸»è¦ç‰¹ç‚¹å’Œä¼˜åŠ¿

1. çº¦å®šä¼˜äºé…ç½®ï¼šMaven éµå¾ªä¸€å®šçš„ç›®å½•ç»“æ„å’Œçº¦å®šï¼Œé™ä½äº†é¡¹ç›®é…ç½®çš„å¤æ‚æ€§ã€‚
2. ä¾èµ–ç®¡ç†ï¼šMaven å¯ä»¥è‡ªåŠ¨å¤„ç†é¡¹ç›®çš„ä¾èµ–å…³ç³»ï¼ŒåŒ…æ‹¬ä¸‹è½½ã€ç‰ˆæœ¬æ§åˆ¶ç­‰ã€‚
3. æ’ä»¶ç”Ÿæ€ï¼šMaven æ‹¥æœ‰ä¸°å¯Œçš„æ’ä»¶ç”Ÿæ€ï¼Œæä¾›äº†è®¸å¤šç”¨äºæ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²ç­‰ä»»åŠ¡çš„æ’ä»¶ã€‚
4. ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šMaven å°†é¡¹ç›®æ„å»ºè¿‡ç¨‹åˆ’åˆ†ä¸ºè‹¥å¹²é˜¶æ®µï¼Œå¯ä»¥çµæ´»åœ°æ§åˆ¶æ¯ä¸ªé˜¶æ®µçš„ä»»åŠ¡ã€‚
5. å¤šæ¨¡å—é¡¹ç›®æ”¯æŒï¼šMaven æ”¯æŒå¤šæ¨¡å—é¡¹ç›®ï¼Œå¯ä»¥æ–¹ä¾¿åœ°ç®¡ç†å¤æ‚çš„é¡¹ç›®ç»“æ„ã€‚

## 4. Maven çš„å®‰è£…

ç•¥

### 4.1 ä½¿ç”¨ Maven Wrapper

Maven Wrapper æ˜¯å—åˆ° Gradle Wrapper çš„å¯å‘è€Œæ¥çš„ã€‚å®ƒä½¿ Maven çš„ä¸€äº›é…ç½® wrap åˆ°é¡¹ç›®é‡Œé¢ï¼ŒåŒæ—¶èµ‹äºˆäº†é¡¹ç›®ä½¿ç”¨æ‰§è¡Œ Maven ç‰ˆæœ¬çš„èƒ½åŠ›ã€‚

```
.
â”œâ”€â”€ .mvn
â”‚Â Â  â”œâ”€â”€ wrapper
â”‚Â Â  â”‚		â”œâ”€â”€ MavenWrapperDownloader.java									# ä¸‹è½½ maven äºŒè¿›åˆ¶æ–‡ä»¶(~/.m2/wrapper/dists)
â”‚Â Â  â”‚   â””â”€â”€ maven-wrapper.proerties											# ä¸‹è½½åœ°å€é…ç½®
â”‚Â Â  â”œâ”€â”€ jvm.properties																	# maven çš„ JVM å‚æ•°é…ç½®
â”‚Â Â  â””â”€â”€ maven.config																		# mvn å‘½ä»¤çš„é…ç½®
â”œâ”€â”€ mvnw																								# linux/unix è„šæœ¬
â”œâ”€â”€ mvnw.cmd																						# Windows è„šæœ¬
â””â”€â”€ pom.xml
```

## 5. æ ‡å‡†çš„é¡¹ç›®ç»“æ„

```
â”œâ”€â”€ src
â”‚Â Â  â”œâ”€â”€ main
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ java
â”‚Â Â  â”‚Â Â  â””â”€â”€ resources
â”‚Â Â  â””â”€â”€ test
â”‚Â Â      â”œâ”€â”€ java
â”‚Â Â      â””â”€â”€ resources
â”œâ”€â”€ target
â”‚   â”œâ”€â”€ classes
â”‚   â””â”€â”€ generated-sources
â””â”€â”€ pom.xml
```

1. `pom.xml`: pom æ˜¯ project object model çš„é¦–å­—æ¯ç¼©å†™ï¼Œæ˜¯ maven çš„é¡¹ç›®é…ç½®æ–‡ä»¶ï¼Œä¹Ÿæ˜¯ maven å·¥å…·çš„æ ¸å¿ƒï¼›
2. `src/main/java`: Java é¡¹ç›®çš„æºä»£ç ç›®å½•ï¼›
3. `src/main/resources`: Java é¡¹ç›®çš„èµ„æºæ–‡ä»¶ç›®å½•ï¼›
4. `src/test`: é¡¹ç›®çš„æµ‹è¯•ä»£ç åŒ…ï¼Œæµ‹è¯•ç”¨ä¾‹å­˜å‚¨çš„ä½ç½®ï¼›
5. `target/classes`: è¾“å‡ºçš„å­—èŠ‚ç æ–‡ä»¶ç›®å½•;

## 6. POM

POM æ–‡ä»¶æ˜¯ Maven çš„æ ¸å¿ƒæ–‡ä»¶ï¼ŒåŒ…å«é¡¹ç›®æ„å»ºç›¸å…³çš„æ‰€æœ‰é…ç½®ä¿¡æ¯ï¼Œå¦‚ï¼šé¡¹ç›®æºä»£ç ç›®å½•ï¼Œclass æ–‡ä»¶è¾“å‡ºç›®å½•ç­‰ã€‚Maven æ‰§è¡Œ goal æ—¶ï¼Œä¼šé¦–å…ˆè¯»å–å½“å‰ç›®å½•çš„ POM æ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œå¯¹åº” goalã€‚

![pom.drawio.svg](https://cdn.dong4j.site/source/image/pom.drawio.svg)

```xml
<project>
  <modelVersion>4.0.0</modelVersion>
 	<!-- NOTE: ä¾èµ– repo å’Œ æ’ä»¶ repo é»˜è®¤ä»“åº“åœ°å€-->
  <repositories>
	<!-- ....é»˜è®¤ repo -->
  </repositories>
  <pluginRepositories>
    <pluginRepository>
		<!-- ....é»˜è®¤repo -->
    </pluginRepository>
  </pluginRepositories>
 	<!-- NOTE: é¡¹ç›®é»˜è®¤é…ç½®ï¼Œå¦‚ï¼šmianä»£ç ç›®å½•ï¼Œ-->
  <build>
    <directory>${project.basedir}/target</directory>
    <outputDirectory>${project.build.directory}/classes</outputDirectory>
    <finalName>${project.artifactId}-${project.version}</finalName>
    <testOutputDirectory>${project.build.directory}/test-classes</testOutputDirectory>
    <sourceDirectory>${project.basedir}/src/main/java</sourceDirectory>
    <scriptSourceDirectory>${project.basedir}/src/main/scripts</scriptSourceDirectory>
    <testSourceDirectory>${project.basedir}/src/test/java</testSourceDirectory>
    <resources>
      <resource>
        <directory>${project.basedir}/src/main/resources</directory>
      </resource>
    </resources>
    <testResources>
      <testResource>
        <directory>${project.basedir}/src/test/resources</directory>
      </testResource>
    </testResources>
    <pluginManagement>
      <plugins>
			<!-- ....è¿™é‡Œæ˜¯ä¸€ç³»åˆ—çš„é»˜è®¤æ’ä»¶ -->
      </plugins>
    </pluginManagement>
  </build>
</project>

```

### 6.1 ç»§æ‰¿ä¸èšåˆ

- Project Inheritance: ç»§æ‰¿å·²æœ‰`pom.xml`ï¼Œä¾¿äºåšå…¬å…±é…ç½®ç®¡ç†ã€‚Super POM æ˜¯ `Project Inheritance` çš„å…¸å‹ä¾‹å­;
- Project Aggregation: åŒä¸€é¡¹ç›®ä¸­å­˜åœ¨å¤šä¸ª`module`;

### 6.2 å¸¸ç”¨å±æ€§

ç”¨æˆ·å¯ä»¥ä½¿ç”¨è¯¥å±æ€§å¼•ç”¨ POM æ–‡ä»¶ä¸­å¯¹åº”å…ƒç´ çš„å€¼ï¼Œå¸¸ç”¨çš„ POM å±æ€§åŒ…æ‹¬ï¼š

- ${project.build.sourceDirectory}ï¼šé¡¹ç›®çš„ä¸»æºç ç›®å½•ï¼Œé»˜è®¤ä¸º src/main/java
- ${project.build.testSourceDirectory}ï¼šé¡¹ç›®çš„æµ‹è¯•æºç ç›®å½•ï¼Œé»˜è®¤ä¸º src/test/java
- ${project.build.directory}ï¼šé¡¹ç›®æ„ä»¶è¾“å‡ºç›®å½•ï¼Œé»˜è®¤ä¸º target/
- ${project.outputDirectory}ï¼šé¡¹ç›®ä¸»ä»£ç ç¼–è¯‘è¾“å‡ºç›®å½•ï¼Œé»˜è®¤ä¸º target/classes/
- ${project.testOutputDirectory}ï¼šé¡¹ç›®æµ‹è¯•ä»£ç ç¼–è¯‘è¾“å‡ºç›®å½•ï¼Œé»˜è®¤ä¸º target/test-classes/
- ${project.groupId}ï¼šé¡¹ç›®çš„ groupId
- ${project.artifactId}ï¼šé¡¹ç›®çš„ artifactId

### 6.3 version

#### 6.3.1 ç»„æˆ

æˆ‘ä»¬åœ¨å¼•å…¥å…¶ä»–ä¾èµ–çš„æ—¶å€™ï¼Œç»å¸¸çœ‹åˆ°ï¼Œæ¯”å¦‚ 1.2.1ã€1.7ã€1.0-SNAPSHOTã€1.1-releaseã€2.3-alpha ç­‰çš„ versionã€‚ä½†å®ƒä»¬çš„ç»„æˆæ¯”è¾ƒç®€å•ï¼Œå¦‚ä¸‹ï¼Œmaven çš„ç‰ˆæœ¬æ„æˆï¼š

    <ä¸»ç‰ˆæœ¬>.<æ¬¡ç‰ˆæœ¬>.<å¢é‡ç‰ˆæœ¬> - <é‡Œç¨‹ç¢‘ç‰ˆæœ¬>

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸»ç‰ˆæœ¬å’Œæ¬¡ç‰ˆæœ¬ä¼šä¸€ç›´å­˜åœ¨ï¼Œå¢é‡ç‰ˆæœ¬å’Œé‡Œç¨‹ç¢‘ç‰ˆæœ¬è§åˆ°çš„ç›¸å¯¹å°‘çš„å¤šã€‚

1. ä¸»ç‰ˆæœ¬ï¼š è¡¨ç¤ºé¡¹ç›®çš„é‡å¤§æ¶æ„å˜åŒ–ã€‚å¦‚ struts2 å’Œ struts1 é‡‡ç”¨ä¸åŒçš„æ¶æ„ã€‚
2. æ¬¡ç‰ˆæœ¬ï¼š è¾ƒå¤§èŒƒå›´åŠŸèƒ½å¢åŠ å’Œå˜åŒ–ï¼ŒåŠ bug ä¿®å¤ï¼Œå¹¶ä¸”ä¸æ¶‰åŠåˆ°æ¶æ„å˜åŒ–çš„ã€‚
3. å¢é‡ç‰ˆæœ¬ï¼šè¡¨ç¤ºé‡å¤§ bug çš„ä¿®å¤ï¼Œå¦‚æœå‘ç°é¡¹ç›®å‘å¸ƒä¹‹åï¼Œå‡ºç°å½±å“åŠŸèƒ½çš„ bugï¼ŒåŠæ—¶ä¿®å¤ï¼Œåˆ™åº”è¯¥æ˜¯å¢é‡ç‰ˆæœ¬çš„å˜åŒ–ã€‚
4. é‡Œç¨‹ç¢‘ç‰ˆæœ¬ï¼šå¾€å¾€è¡¨ç¤ºæŸä¸ªç‰ˆæœ¬çš„é‡Œç¨‹ç¢‘ï¼Œç»å¸¸è§åˆ° snapshotï¼Œå¦å¤–è¿˜æœ‰ alphaã€betaï¼Œæ¯”å¦‚ï¼š1.0-SNAPSHOTã€3.0-alpha-1ã€1.1.2-beta-2ã€‚

#### 6.3.2 å¿«ç…§

SNAPSHOT è¡¨ç¤ºå¿«ç…§ç‰ˆï¼Œå®ƒä¸æ˜¯ä¸ªç¨³å®šç‰ˆæœ¬ï¼Œå±äºå¼€å‘è¿‡ç¨‹ä¸­ä½¿ç”¨çš„ç‰ˆæœ¬ã€‚å½“æˆ‘ä»¬é¡¹ç›®å¤„äºä¸åœçš„è¿­ä»£å¼€å‘æœŸï¼Œå¦‚æœå­˜åœ¨ä¾èµ–å…³ç³»ï¼Œæ¯”å¦‚ A é¡¹ç›®ç»„å¼€å‘åå‘å¸ƒçš„æ–°åŒ…ï¼Œè¢« B é¡¹ç›®ç»„å¼•ç”¨ï¼Œè¿™æ—¶å€™ä½¿ç”¨å¿«ç…§ç‰ˆæœ¬ SNAPSHOTï¼Œèƒ½å¤Ÿåœ¨ A é¡¹ç›®ç»„å‘å¸ƒåˆ°ä»“åº“åï¼Œè‡ªåŠ¨è½¬ä¸ºæœ€æ–°æ—¶é—´æˆ³çš„åç¼€ï¼Œä¾› B é¡¹ç›®ç»„è‡ªåŠ¨å¼•ç”¨æˆåŠŸã€‚

è¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œå½“æˆ‘ä»¬æœ‰ä¾èµ–å…³ç³»çš„ä¸¤ä¸ªé¡¹ç›®ç»„åŒæ—¶å¼€å‘æ—¶ï¼Œå¯ä»¥äº’ä¸å½±å“ï¼Œæ¯æ¬¡ A é¡¹ç›®ç»„å‘å¸ƒåï¼ŒB é¡¹ç›®ç»„éƒ½ä¼šåˆ·æ–°ã€é‡æ–°ç¼–è¯‘çš„æ–¹å¼ï¼Œè‡ªåŠ¨æ›´æ–°åˆ°æœ€æ–°çš„ A é¡¹ç›®å¼€å‘çš„ä¾èµ–åŒ…ã€‚åªæœ‰å½“å‡†å¤‡è¿›å…¥æµ‹è¯•é˜¶æ®µï¼Œæ‰ä¼šå°†é‡Œç¨‹ç¢‘ç‰ˆæœ¬å·çš„ SNAPSHOT æ›¿æ¢æˆ alpha æˆ– betaï¼Œå³æµ‹è¯•ç‰ˆæœ¬ã€‚

#### 6.3.3 ç‰ˆæœ¬èŒƒå›´

å®Œæ•´çš„ç‰ˆæœ¬å·èŒƒå›´è¯´æ˜å¦‚ä¸‹ï¼šï¼ˆx ä¸ºå…·ä½“ä½¿ç”¨çš„ç‰ˆæœ¬å·ï¼‰

```
(,1.0]          x <= 1.0
[1.0]           x = 1.0 è·Ÿç›´æ¥æŒ‡å®š1.0æ²¡æœ‰åŒºåˆ«
[1.2,1.3]       1.2 <= x <= 1.3
[1.0,2.0)       1.0 <= x < 2.0
[1.5,)          x >= 1.5
(,1.0],[1.2,)   x <= 1.0 or x >= 1.2
(,1.1),(1.1,)   x < 1.1 or x > 1.1 å³æ’é™¤1.1çš„ç‰ˆæœ¬
```

## 7. åæ ‡å’Œä¾èµ–

### 7.1 GAV

Maven åæ ‡ä¸ºå„ç§æ„ä»¶å¼•å…¥äº†ç§©åºï¼Œä»»ä½•ä¸€ä¸ªæ„ä»¶éƒ½å¿…é¡»æ˜ç¡®å®šä¹‰è‡ªå·±çš„åæ ‡ï¼Œè€Œä¸€ç»„ Maven åæ ‡æ˜¯é€šè¿‡ä¸€äº›å…ƒç´ å®šä¹‰çš„ã€‚Maven åæ ‡ä¸€èˆ¬å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªäº”å…ƒç»„ï¼Œå³ï¼šï¼ˆgroupIdï¼ŒartifactIdï¼Œversionï¼Œtypeï¼Œclassifierï¼‰ã€‚

- groupIdï¼šMaven é¡¹ç›®éš¶å±çš„å®é™…é¡¹ç›®åç§°;
- artifactIdï¼šå®é™…é¡¹ç›®ä¸­çš„ä¸€ä¸ªæ¨¡å—åç§°;
- versionï¼šç‰ˆæœ¬å·;
- type:
  - `jar`: jar åŒ…ï¼ŒåŒ…å«ä¾èµ–é¡¹ç›®ä¸»ä»£ç  class æ–‡ä»¶;
  - `test-jar`: jar åŒ…ï¼Œclassifier ä¸º testsï¼ŒåŒ…å«ä¾èµ–é¡¹ç›®æµ‹è¯•ä»£ç  class æ–‡ä»¶ã€‚ç”¨äºå¤ç”¨æµ‹è¯•ä»£ç ;
- classifier: ç”¨äºåŒºåˆ†ä»åŒä¸€ä¸ª POM ä¸­ï¼Œæ„å»ºå‡ºçš„ä¸åŒ artifactsã€‚æ¯”å¦‚ï¼šåŒä¸€ä¸ªé¡¹ç›®å¯èƒ½åŒæ—¶æä¾› jdk11 å’Œ jdk 8 å¯¹åº”çš„ä¾èµ–;

ä¸Šè¿°äº”ä¸ªå…ƒç´ ä¸­ï¼ŒgroupIdã€artifactIdã€version æ˜¯å¿…é¡»å®šä¹‰çš„ï¼Œtype æ˜¯å¯é€‰çš„ï¼ˆé»˜è®¤ä¸º jarï¼‰ï¼Œè€Œ classifier æ˜¯å–å†³äºå¯¹åº”ä¾èµ–æ˜¯å¦æä¾›ã€‚

### 7.2 Scope

Scope ä½œç”¨æœ‰ä¸¤ä¸ª:

1. é™åˆ¶ä¾èµ–ä¼ é€’;
2. æ§åˆ¶ä¾èµ–æ˜¯å¦å‡ºç°åœ¨å„ä¸ª classpath ä¸­

#### 7.2.1 Dependency Scope

Maven ä¸­æœ‰äº”ç§ Scopeï¼Œåˆ†åˆ«æ˜¯:

1. compile: é»˜è®¤, å¯¹äºç¼–è¯‘ã€æµ‹è¯•ã€è¿è¡Œä¸‰ç§ classpath éƒ½æœ‰æ•ˆ;
2. provided: åªåœ¨å¼€å‘ã€æµ‹è¯•é˜¶æ®µä½¿ç”¨ï¼Œç›®çš„æ˜¯ä¸è®© Servlet å®¹å™¨å’Œä½ æœ¬åœ°ä»“åº“çš„ jar åŒ…å†²çª
3. runtime: åªåœ¨è¿è¡Œæ—¶ä½¿ç”¨ï¼Œå¦‚ JDBC é©±åŠ¨ï¼Œé€‚ç”¨è¿è¡Œå’Œæµ‹è¯•é˜¶æ®µ;
4. test: åªå¯¹äºæµ‹è¯• classpath æœ‰æ•ˆ, ç”¨äºç¼–è¯‘å’Œè¿è¡Œæµ‹è¯•ä»£ç , ä¸ä¼šéšé¡¹ç›®å‘å¸ƒ;
5. system: ç±»ä¼¼ providedï¼Œéœ€è¦æ˜¾å¼æä¾›åŒ…å«ä¾èµ–çš„ jarï¼ŒMaven ä¸ä¼šåœ¨ Repository ä¸­æŸ¥æ‰¾å®ƒ;

Maven ä¸­å¤§è‡´å¯ä»¥åˆ†æˆå››ç±» class pathï¼š

- main ä»£ç ç¼–è¯‘ classpathï¼šç¼–è¯‘ main ä»£ç çš„ classpath
- main ä»£ç è¿è¡Œ classpathï¼šè¿è¡Œ main ä»£ç çš„ classpath
- test ä»£ç ç¼–è¯‘ classpathï¼šç¼–è¯‘æµ‹è¯•ä»£ç çš„ classpath
- test ä»£ç è¿è¡Œ classpathï¼šè¿è¡Œæµ‹è¯•ä»£ç çš„ classpath

ç»“åˆä¾èµ–çš„ Scope å’Œå››ç±» classpath æ€»ç»“å‡º classpath ä¸ä¾èµ–çš„å…³ç³»:

| classpath        | ç»„æˆ                                                                                                     | å¤‡æ³¨                                                                                                                                                                          |
| ---------------- | -------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| main compile     | scope ä¸º compile, provided, system                                                                       |                                                                                                                                                                               |
| main run         | ä¸»ä»£ç ç¼–è¯‘çš„è¾“å‡ºç›®å½•+ scope ä¸º compile å’Œ runtime çš„ä¾èµ–ç»„æˆ                                             | ä¸€èˆ¬æƒ…å†µä¸‹éœ€è¦æŒ‡å®š classpath, è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ IDEA é‡Œé¢ç›´æ¥è¿è¡Œ main code ä¸­ä½¿ç”¨äº† provided ä¾èµ–çš„ main æ–¹æ³•ä¼šæŠ¥é”™çš„åŸå› , å› ä¸º provided ä¾èµ–ä¸ä¼šåŠ å…¥ main run classpath ä¸­ |
| test run/compile | ä¸»ä»£ç  class è¾“å‡ºç›®å½• + scope ä¸º compile, provided, system, runtime, test çš„ä¾èµ– + test class çš„è¾“å‡ºç›®å½• |                                                                                                                                                                               |

#### 7.2.1 Dependency Management Scope

```xml
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>com.xxx</groupId>
            <artifactId>xxx-center-dependencies</artifactId>
            <version>${xxx-center-dependencies.version}</version>
            <scope>import</scope>
            <type>pom</type>
        </dependency>
    </dependencies>
</dependencyManagement>
```

### 7.3 ä¾èµ–ä¼ é€’

æˆ‘ä»¬éƒ½çŸ¥é“ä¾èµ–æ˜¯ä¼šä¼ é€’çš„ï¼Œä¾‹å¦‚ B æ¨¡å—å¼•å…¥äº† A æ¨¡å—ï¼ŒC æ¨¡å—å¼•å…¥äº† B æ¨¡å—ï¼Œå°±ç›¸å½“äº C æ¨¡å—å¼•å…¥äº† A æ¨¡å—ã€‚

è€Œåœ¨é¡¹ç›®ä¸­æˆ‘ä»¬çŸ¥é“ service ä¾èµ– daoï¼Œcontroller ä¾èµ– serviceã€‚daoã€serviceã€controller åˆéƒ½ä¾èµ– model å®ä½“ç±»ï¼Œdao å’Œ service åˆéƒ½éœ€è¦ç”¨åˆ° common ã€‚ä½†æ˜¯æˆ‘ä»¬ä¸å¯èƒ½åœ¨ä»–ä»¬ä¸‰ä¸ªä¸­éƒ½æ·»åŠ  model çš„ä¾èµ–ï¼Œåœ¨ dao å’Œ service ä¸­éƒ½æ·»åŠ  common çš„ä¾èµ–ã€‚

æ ¹æ®ä¾èµ–çš„ä¼ é€’æ€§ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ common æ¨¡å—ä¸­æ·»åŠ  model çš„ä¾èµ–ï¼Œåœ¨ dao ä¸­æ·»åŠ  common çš„ä¾èµ–ï¼Œåœ¨ service ä¸­æ·»åŠ  dao çš„ä¾èµ–ï¼Œåœ¨ controller ä¸­æ·»åŠ  service çš„ä¾èµ–ã€‚

![ä¾èµ–ä¼ é€’.drawio-6237674.svg](https://cdn.dong4j.site/source/image/%E4%BE%9D%E8%B5%96%E4%BC%A0%E9%80%92.drawio-6237674.svg)

ä¾èµ–ä¼ é€’å…³ç³»:

- A -> B (compile) ç¬¬ä¸€å…³ç³» : A ä¾èµ– B compile
- B -> C (compile) ç¬¬äºŒå…³ç³» : B ä¾èµ– C compile

åˆ™ A ä¼šè‡ªåŠ¨ä¾èµ– C

è¯¦ç»†çš„å…³ç³»ä¼ é€’å¦‚ä¸‹:

| A/B      | compile  | test | provided | runtime  |
| -------- | -------- | ---- | -------- | -------- |
| compile  | compile  | -    | -        | runtime  |
| test     | test     | -    | -        | test     |
| provided | provided | -    | provided | provided |
| runtime  | runtime  | -    | -        | runtime  |

**é‚£ä¹ˆè¯¥å¦‚æœç¦æ­¢ä¾èµ–ä¼ é€’?**

### 7.4 ä¾èµ–è°ƒè§£

ä¾èµ–è°ƒè§£éµå¾ªä»¥ä¸‹ä¸¤å¤§åŸåˆ™ï¼šè·¯å¾„æœ€çŸ­ä¼˜å…ˆã€å£°æ˜é¡ºåºä¼˜å…ˆï¼Œ

- ç¬¬ä¸€åŸåˆ™ï¼šè·¯å¾„æœ€è¿‘è€…ä¼˜å…ˆã€‚ æŠŠå½“å‰æ¨¡å—å½“ä½œé¡¶å±‚æ¨¡å—ï¼Œç›´æ¥ä¾èµ–çš„åŒ…åˆ™ä½œä¸ºæ¬¡å±‚æ¨¡å—ï¼Œé—´æ¥ä¾èµ–çš„åŒ…åˆ™ä½œä¸ºæ¬¡å±‚æ¨¡å—çš„æ¬¡å±‚æ¨¡å—ï¼Œä¾æ¬¡é€’æ¨...ï¼Œæœ€åæ„æˆä¸€æ£µå¼•ç”¨ä¾èµ–æ ‘ã€‚å‡è®¾å½“å‰æ¨¡å—æ˜¯ Aï¼Œä¸¤ç§ä¾èµ–è·¯å¾„å¦‚ä¸‹æ‰€ç¤ºï¼š

  ```
  A --> B --> X(1.1)         // å±‚çº§(A->X) = 2
  A --> C --> D --> X(1.0)   // å±‚çº§(A->X) = 3
  ```

  æ­¤æ—¶ï¼ŒMaven å¯ä»¥æŒ‰ç…§ç¬¬ä¸€åŸåˆ™è‡ªåŠ¨è°ƒè§£ä¾èµ–ï¼Œç»“æœæ˜¯ä½¿ç”¨ X(1.1)ä½œä¸ºä¾èµ–ã€‚

- ç¬¬äºŒåŸåˆ™ï¼šç¬¬ä¸€å£°æ˜è€…ä¼˜å…ˆã€‚è‹¥å†²çªä¾èµ–çš„è·¯å¾„é•¿åº¦ç›¸åŒï¼Œé‚£ä¹ˆç¬¬ä¸€åŸåˆ™å°±æ— æ³•èµ·ä½œç”¨äº†ã€‚ å‡è®¾å½“å‰æ¨¡å—æ˜¯ Aï¼Œä¸¤ç§ä¾èµ–è·¯å¾„å¦‚ä¸‹æ‰€ç¤ºï¼š

  ```
  A --> B --> X(1.1)   // å±‚çº§(A->X) = 2
  A --> C --> X(1.0)   // å±‚çº§(A->X) = 2
  ```

  å½“è·¯å¾„é•¿åº¦ç›¸åŒï¼Œåˆ™éœ€è¦æ ¹æ® A ç›´æ¥ä¾èµ–åŒ…åœ¨ pom æ–‡ä»¶ä¸­çš„å…ˆåé¡ºåºæ¥åˆ¤å®šä½¿ç”¨é‚£æ¡ä¾èµ–è·¯å¾„ï¼Œå¦‚æœæ¬¡çº§æ¨¡å—ç›¸åŒåˆ™å‘ä¸‹çº§æ¨¡å—æ¨ï¼Œç›´è‡³å¯ä»¥åˆ¤æ–­å…ˆåä½ç½®ä¸ºæ­¢ã€‚

  ```
  <!-- A pom.xml -->
  <dependencies>
      ...
      dependency B
      ...
      dependency C
  </dependencies>
  ```

  å‡è®¾ä¾èµ– B ä½ç½®åœ¨ä¾èµ– C ä¹‹å‰ï¼Œåˆ™æœ€ç»ˆä¼šé€‰æ‹© X(1.1)ä¾èµ–ã€‚

å…¶å®ƒæƒ…å†µï¼š**è¦†ç›–ç­–ç•¥**ã€‚è‹¥ç›¸åŒç±»å‹ä½†ç‰ˆæœ¬ä¸åŒçš„ä¾èµ–å­˜åœ¨äºåŒä¸€ä¸ª pom æ–‡ä»¶ï¼Œä¾èµ–è°ƒè§£ä¸¤å¤§åŸåˆ™éƒ½ä¸èµ·ä½œç”¨ï¼Œéœ€è¦é‡‡ç”¨è¦†ç›–ç­–ç•¥æ¥è°ƒè§£ä¾èµ–å†²çªï¼Œæœ€ç»ˆä¼šå¼•å…¥æœ€åä¸€ä¸ªå£°æ˜çš„ä¾èµ–ã€‚

```xml
<dependencies>
  <dependency>
    <groupId>a</groupId>
    <artifactId>a</artifactId>
    <version>1.2</version>
  </dependency>
  <dependency>
    <groupId>a</groupId>
    <artifactId>a</artifactId>
    <version>1.4</version>
  </dependency>
  <dependency>
    <groupId>a</groupId>
    <artifactId>a</artifactId>
    <version>1.3</version>
  </dependency>
</dependencies>
```

### 7.5 ClassNotFoundException

ä¸ºä»€ä¹ˆæœ¬åœ°å¼€å‘æ²¡é—®é¢˜, ä¸€åˆ°çº¿ä¸Šå°±å‡ºç°æ¯”å¦‚ class æ‰¾ä¸åˆ°, æ–¹æ³•ç­¾åä¸æ­£ç¡®ç­‰é—®é¢˜?

**maven healper**

## 8. ä»“åº“

![ä»“åº“.drawio.svg](https://cdn.dong4j.site/source/image/%E4%BB%93%E5%BA%93.drawio.svg)

å½“é€šè¿‡ Maven æ„å»ºé¡¹ç›®æ—¶ï¼ŒMaven æŒ‰ç…§å¦‚ä¸‹é¡ºåºæŸ¥æ‰¾ä¾èµ–çš„æ„ä»¶ã€‚

1. ä»æœ¬åœ°ä»“åº“æŸ¥æ‰¾æ„ä»¶ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè·³åˆ°ç¬¬ 2 æ­¥ï¼Œå¦åˆ™ç»§ç»­æ‰§è¡Œå…¶ä»–å¤„ç†ã€‚
2. ä»è¿œç¨‹ä»“åº“æŸ¥æ‰¾æ„ä»¶ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå¹¶ä¸”å·²ç»è®¾ç½®å…¶ä»–è¿œç¨‹ä»“åº“ï¼Œç„¶åç§»åŠ¨åˆ°ç¬¬ 4 æ­¥ï¼›å¦‚æœæ‰¾åˆ°ï¼Œé‚£ä¹ˆå°†æ„ä»¶ä¸‹è½½åˆ°æœ¬åœ°ä»“åº“ä¸­ä½¿ç”¨ã€‚
3. å¦‚æœæ²¡æœ‰è®¾ç½®å…¶ä»–è¿œç¨‹ä»“åº“ï¼ŒMaven åˆ™ä¼šåœæ­¢å¤„ç†å¹¶æŠ›å‡ºé”™è¯¯ã€‚
4. åœ¨è¿œç¨‹ä»“åº“æŸ¥æ‰¾æ„ä»¶ï¼Œå¦‚æœæ‰¾åˆ°ï¼Œåˆ™ä¼šä¸‹è½½åˆ°æœ¬åœ°ä»“åº“å¹¶ä½¿ç”¨ï¼Œå¦åˆ™ Maven åœæ­¢å¤„ç†å¹¶æŠ›å‡ºé”™è¯¯ã€‚

![20241229154732_Nzl60lsR.webp](https://cdn.dong4j.site/source/image/20241229154732_Nzl60lsR.webp)

## 9. ç”Ÿå‘½å‘¨æœŸ

Maven æœ‰ä¸‰å¥—ç‹¬ç«‹çš„ Lifecycle:`default`ã€`clean` å’Œ `site`ï¼Œæ¯ä¸ª Lifecycle åŒ…å«å¤šä¸ª Phaseã€‚ä¸‹å›¾è¯¦ç»†çš„å±•ç¤ºäº† Lifecycle å’Œ Phase çš„å…³ç³»ã€‚

![ç”Ÿå‘½å‘¨æœŸ.drawio.svg](https://cdn.dong4j.site/source/image/%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.drawio.svg)

### 9.1 Clean

clean ç”Ÿå‘½å‘¨æœŸçš„ç›®çš„ä¸»è¦æ˜¯æ¸…ç†é¡¹ç›®ã€‚

- pre-clean: æ‰§è¡Œä¸€äº›æ¸…ç†å‰éœ€è¦å®Œæˆçš„å·¥ä½œã€‚
- **clean**: æ¸…ç†ä¸Šä¸€æ¬¡æ„å»ºç”Ÿæˆçš„æ–‡ä»¶ã€‚
- post-clean: æ‰§è¡Œä¸€äº›æ¸…ç†åéœ€è¦å®Œæˆçš„å·¥ä½œã€‚

### 9.2 Default

default ç”Ÿå‘½å‘¨æœŸå®šä¹‰äº†çœŸæ­£æ„å»ºæ—¶æ‰€éœ€è¦æ‰§è¡Œçš„æ‰€æœ‰æ­¥éª¤ï¼Œå®ƒæ˜¯æ‰€æœ‰ç”Ÿå‘½å‘¨æœŸä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå…¶åŒ…å«çš„é˜¶æ®µå¦‚ä¸‹ï¼š

- validateï¼šéªŒè¯é¡¹ç›®æ˜¯å¦åˆæ³•ä»¥åŠé¡¹ç›®æ„å»ºä¿¡æ¯æ˜¯å¦å®Œå¤‡ã€‚
- initializeï¼šåˆå§‹åŒ–ã€‚
- generate-sources: ç”Ÿæˆæºä»£ç ï¼Œå¦‚ï¼š`ANTLR` æ’ä»¶ä¼šæ ¹æ®è¯­æ³•æ–‡ä»¶ç”Ÿæˆå¯¹åº”çš„ Java æºä»£ç ã€‚
- process-sources: å¤„ç†é¡¹ç›®ä¸»èµ„æºæ–‡ä»¶ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ˜¯å¯¹ src/main/resources ç›®å½•çš„å†…å®¹è¿›è¡Œå˜é‡æ›¿æ¢ç­‰å·¥ä½œåï¼Œå¤åˆ¶åˆ°é¡¹ç›®è¾“å‡ºçš„ä¸» classpath ç›®å½•ä¸­ã€‚
- generate-resourcesï¼šç”Ÿæˆèµ„æºæ–‡ä»¶ã€‚
- process-resourcesï¼šå¤„ç†èµ„æºæ–‡ä»¶ã€‚
- **compile**ï¼šç¼–è¯‘é¡¹ç›®çš„ä¸»æºç ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ˜¯ç¼–è¯‘ src/main/java ç›®å½•ä¸‹çš„ Java æ–‡ä»¶è‡³é¡¹ç›®è¾“å‡ºçš„ä¸» classpath ç›®å½•ä¸­ã€‚
- process-classesï¼šå¤„ç† class æ–‡ä»¶ï¼Œå¦‚ï¼šå­—èŠ‚ç å¢å¼ºã€‚
- generate-test-sourcesï¼šç”Ÿæˆæµ‹è¯•æºä»£ç ï¼Œå¦‚ï¼š`ANTLR`ã€‚
- process-test-sourcesï¼šå¤„ç†é¡¹ç›®æµ‹è¯•èµ„æºæ–‡ä»¶ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ˜¯å¯¹ src/test/resources ç›®å½•çš„å†…å®¹è¿›è¡Œå˜é‡æ›¿æ¢ç­‰å·¥ä½œåï¼Œå¤åˆ¶åˆ°é¡¹ç›®è¾“å‡ºçš„æµ‹è¯• classpath ç›®å½•ä¸­ã€‚
- generate-test-resourcesï¼šç”Ÿæˆæµ‹è¯•èµ„æºæ–‡ä»¶ã€‚
- process-test-resourcesï¼šæ‹·è´æˆ–å¤„ç†æµ‹è¯•èµ„æºæ–‡ä»¶è‡³ç›®æ ‡æµ‹è¯•ç›®å½•ã€‚
- test-compileï¼šç¼–è¯‘é¡¹ç›®çš„æµ‹è¯•ä»£ç ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ˜¯ç¼–è¯‘ src/test/java ç›®å½•ä¸‹çš„ Java æ–‡ä»¶è‡³é¡¹ç›®è¾“å‡ºçš„æµ‹è¯• classpath ç›®å½•ä¸­ã€‚
- process-test-classesï¼šå¤„ç† test class æ–‡ä»¶ã€‚
- **test**ï¼šä½¿ç”¨å•å…ƒæµ‹è¯•æ¡†æ¶è¿è¡Œæµ‹è¯•ï¼Œæµ‹è¯•ä»£ç ä¸ä¼šè¢«æ‰“åŒ…æˆ–éƒ¨ç½²ã€‚
- prepare-packageï¼šæ‰“åŒ…å‰ç½®å·¥ä½œã€‚
- **package**ï¼šæ¥å—ç¼–è¯‘å¥½çš„ä»£ç ï¼Œæ‰“åŒ…æˆå¯å‘å¸ƒçš„æ ¼å¼ï¼Œå¦‚ JARï¼ŒWAR ç­‰ã€‚
- pre-integration-testï¼šé›†æˆæµ‹è¯•çš„å‰ç½®å·¥ä½œ
- integration-testï¼šé›†æˆæµ‹è¯•ã€‚
- post-integration-test ï¼šé›†æˆæµ‹è¯•åï¼Œéœ€è¦åšçš„ä¸€äº›äº‹æƒ…ã€‚
- **verify**ï¼šæ£€æµ‹æ‰€æœ‰çš„é›†æˆæµ‹è¯•ç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œä¿éšœä»£ç è´¨é‡ã€‚
- **install**ï¼šå°†åŒ…å®‰è£…åˆ° Maven æœ¬åœ°ä»“åº“ï¼Œä¾›æœ¬åœ°å…¶ä»– Maven é¡¹ç›®ä½¿ç”¨ã€‚
- **deploy**ï¼šå°†æœ€ç»ˆçš„åŒ…å¤åˆ¶åˆ°è¿œç¨‹ä»“åº“ï¼Œä¾›å…¶ä»–å¼€å‘äººå‘˜å’Œ Maven é¡¹ç›®ä½¿ç”¨ã€‚

### 9.3 Site

site ç”Ÿå‘½å‘¨æœŸç”¨äºç”Ÿæˆä»£ç ç«™ç‚¹æ–‡æ¡£å¹¶å‘å¸ƒè‡³å¯¹åº” Web Serverã€‚

- pre-siteï¼šå‰ç½®å·¥ä½œã€‚
- **site**ï¼šç”Ÿæˆä»£ç å¯¹åº”çš„ç«™ç‚¹æ–‡æ¡£ã€‚
- post-siteï¼šsite åç½®å·¥ä½œï¼Œdeploy å‰ç½®å·¥ä½œã€‚
- site-deployï¼šå‘å¸ƒç«™ç‚¹æ–‡æ¡£è‡³å¯¹åº”çš„ Web Serverã€‚

## 10. å…¶ä»–

### 10.1 æ’é™¤å…¨éƒ¨ä¾èµ–

```xml
<!-- å…¨å±€æ’é™¤ é»˜è®¤çš„ logging ä¾èµ–, ä½¿ç”¨ log4j2 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter</artifactId>
    <version>${spring-boot-dependencies.version}</version>
    <exclusions>
        <exclusion>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-logging</artifactId>
        </exclusion>
    </exclusions>
</dependency>
<!-- ä½¿ç”¨ log4j2 æ—¥å¿—æ¡†æ¶ (åˆ é™¤æ‰€æœ‰ä¾èµ–ï¼Œåœ¨ xxx-logsystem-spring-boot æ¨¡å—ä¸­å‡çº§ log4j ç‰ˆæœ¬ä»¥ä¿®å¤æ¼æ´) -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-log4j2</artifactId>
    <version>${spring-boot-dependencies.version}</version>
    <exclusions>
        <exclusion>
            <groupId>*</groupId>
            <artifactId>*</artifactId>
        </exclusion>
    </exclusions>
</dependency>
<!-- å…¨å±€æ’é™¤ spring-boot-starter-logging å†…çš„æ‰€æœ‰ä¾èµ–, é¿å…æ‰‹åŠ¨å¼•å…¥é€ æˆæ—¥å¿—æ¡†æ¶å†²çª -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-logging</artifactId>
    <version>${spring-boot-dependencies.version}</version>
    <exclusions>
        <exclusion>
            <groupId>*</groupId>
            <artifactId>*</artifactId>
        </exclusion>
    </exclusions>
</dependency>
```

### 10.2 mvnd

maven-mvnd æ˜¯ A pache Maven å›¢é˜Ÿå€Ÿé‰´äº† Gradle å’Œ Takari åè¡ç”Ÿå‡ºçš„æ›´å¿«çš„æ„å»ºå·¥å…·ã€‚mvnd å†…åµŒäº† Mavenï¼Œä¹Ÿæ­£æ˜¯å› ä¸ºè¿™ä¸ªåŸå› æˆ‘ä»¬å¯ä»¥æ— ç¼åœ°å°† Maven åˆ‡æ¢ ä¸º mvndï¼ˆä¹Ÿä¸éœ€è¦å•ç‹¬å®‰è£… Mavenï¼‰

- è¿è¡Œæ„å»ºçš„ JVM ä¸éœ€è¦ä¸ºæ¯ä¸ªæ„å»ºé‡æ–°å¯åŠ¨ã€‚
- Maven æ’ä»¶ç±»çš„ç±»åŠ è½½å™¨ç¼“å­˜åœ¨å¤šä¸ªæ„å»ºä¸­ï¼Œæ’ä»¶ jars åªä¼šè¢«è¯»å–å’Œè§£æä¸€æ¬¡ã€‚
- JVM ä¸­ JIT ç”Ÿæˆçš„æœ¬æœºä»£ç ä¼šè¢«ä¿ç•™ã€‚ä¸ Maven ç›¸æ¯”ï¼ŒJIT ç¼–è¯‘èŠ±è´¹çš„æ—¶é—´æ›´å°‘ã€‚åœ¨é‡å¤æ„å»ºæœŸé—´ï¼ŒJIT ä¼˜åŒ–çš„ä»£ç ç«‹å³å¯ç”¨ã€‚è¿™ä¸ä»…é€‚ç”¨äºæ¥è‡ª Maven æ’ä»¶å’Œ Maven å†…æ ¸çš„ä»£ç ï¼Œä¹Ÿé€‚ç”¨äºæ¥è‡ª JDK æœ¬èº«çš„æ‰€æœ‰ä»£ç ã€‚

### 10.3 é¡¹ç›®éª¨æ¶

![20241229154732_69thf4js.webp](https://cdn.dong4j.site/source/image/20241229154732_69thf4js.webp)

### 10.4 æ’ä»¶å¼€å‘

å‚çœ‹ **xxx-maven-plugin**

## [ä»£ç å®¡æŸ¥çš„è‰ºæœ¯ï¼šæ ¼å¼åˆ°åŠŸèƒ½çš„å…¨é¢å®¡è§†](https://blog.dong4j.site/posts/77edbced.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

è®©æˆ‘ä»¬æ¥è°ˆè°ˆä»£ç å®¡æŸ¥ã€‚å¦‚æœä½ èŠ±å‡ åˆ†é’Ÿæ—¶é—´æœç´¢æœ‰å…³ä»£ç å®¡æŸ¥çš„ä¿¡æ¯ï¼Œä½ ä¼šçœ‹åˆ°å¾ˆå¤šæ–‡ç« è®¨è®ºä¸ºä»€ä¹ˆä»£ç å®¡æŸ¥æ˜¯ä¸€ä»¶å¥½äº‹.

ä½ è¿˜ä¼šçœ‹åˆ°å¾ˆå¤šå…³äºå¦‚ä½•ä½¿ç”¨ä»£ç å®¡æŸ¥å·¥å…·çš„æ–‡æ¡£ï¼Œæ¯”å¦‚ Upsourceã€‚ä½†ä½ ä¸å¤ªå®¹æ˜“æ‰¾åˆ°ä¸€ä»½æŒ‡å¯¼ä½ åœ¨å®¡æŸ¥ä»–äººä»£ç æ—¶åº”è¯¥å…³æ³¨ä»€ä¹ˆçš„æŒ‡å—ã€‚

å¯èƒ½æ²¡æœ‰æ˜ç¡®æ–‡ç« è§£é‡Šåº”è¯¥å¯»æ‰¾ä»€ä¹ˆçš„åŸå› æ˜¯ï¼šæœ‰å¾ˆå¤šä¸åŒçš„äº‹æƒ…éœ€è¦è€ƒè™‘ã€‚å¹¶ä¸”ï¼Œåƒä»»ä½•ä¸€ç»„è¦æ±‚ï¼ˆåŠŸèƒ½æ€§çš„æˆ–éåŠŸèƒ½æ€§çš„ï¼‰ä¸€æ ·ï¼Œä¸åŒçš„ç»„ç»‡å¯¹äºæ¯ä¸ªæ–¹é¢éƒ½ä¼šæœ‰ä¸åŒçš„ä¼˜å…ˆçº§ã€‚

ç”±äºè¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ä¸»é¢˜ï¼Œæœ¬ç« çš„ç›®æ ‡åªæ˜¯æ¦‚è¿°åœ¨æ‰§è¡Œä»£ç å®¡æŸ¥æ—¶ï¼Œå®¡é˜…è€…å¯èƒ½ä¼šå…³æ³¨çš„ä¸€äº›äº‹æƒ…ã€‚ç¡®å®šæ¯ä¸ªæ–¹é¢çš„ä¼˜å…ˆçº§å¹¶ä¿æŒä¸€è‡´æ€§æ£€æŸ¥æ˜¯ä¸€ä¸ªè¶³å¤Ÿå¤æ‚çš„è¯é¢˜ï¼Œè¶³ä»¥æˆä¸ºä¸€ä¸ªç‹¬ç«‹çš„ç« èŠ‚ã€‚

## åœ¨å®¡æŸ¥ä»–äººçš„ä»£ç æ—¶ï¼Œä½ å¯»æ‰¾ä»€ä¹ˆï¼Ÿ

æ— è®ºä½ æ˜¯é€šè¿‡ Upsource è¿™æ ·çš„å·¥å…·è¿˜æ˜¯åœ¨ä¸åŒäº‹ä¸€èµ·èµ°æŸ¥ä»–ä»¬çš„ä»£ç ï¼Œæ— è®ºæƒ…å†µå¦‚ä½•ï¼Œæœ‰äº›ä¸œè¥¿æ¯”å…¶ä»–ä¸œè¥¿æ›´å®¹æ˜“è¯„è®ºã€‚ä¸€äº›ä¾‹å­ï¼š

- æ ¼å¼åŒ–ï¼šç©ºæ ¼å’Œæ¢è¡Œåœ¨å“ªé‡Œï¼Ÿä»–ä»¬ä½¿ç”¨åˆ¶è¡¨ç¬¦è¿˜æ˜¯ç©ºæ ¼ï¼ŸèŠ±æ‹¬å·æ˜¯å¦‚ä½•æ’åˆ—çš„ï¼Ÿ
- é£æ ¼ï¼šå˜é‡/å‚æ•°æ˜¯å¦è¢«å£°æ˜ä¸º finalï¼Ÿæ–¹æ³•å˜é‡æ˜¯åœ¨å®ƒä»¬ä½¿ç”¨çš„ä»£ç é™„è¿‘å®šä¹‰è¿˜æ˜¯åœ¨æ–¹æ³•çš„å¼€å§‹å¤„å®šä¹‰ï¼Ÿ
- å‘½åï¼šå­—æ®µ/å¸¸é‡/å˜é‡/ç±»åçš„å‘½åæ˜¯å¦ç¬¦åˆæ ‡å‡†ï¼Ÿåç§°è¿‡é•¿å—ï¼Ÿ
- æµ‹è¯•è¦†ç›–ç‡ï¼šæœ‰æ²¡æœ‰é’ˆå¯¹è¿™æ®µä»£ç çš„æµ‹è¯•ï¼Ÿè¿™äº›éƒ½æ˜¯æœ‰æ•ˆçš„æ£€æŸ¥äº‹é¡¹â€”â€”ä½ å¸Œæœ›æœ€å°åŒ–åœ¨ä¸åŒä»£ç åŒºåŸŸä¹‹é—´åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼Œå‡å°‘è®¤çŸ¥è´Ÿè·ï¼Œæ‰€ä»¥ä½ çš„ä»£ç çœ‹èµ·æ¥è¶Šä¸€è‡´è¶Šå¥½ã€‚

ç„¶è€Œï¼Œè®©äººç±»å»æ‰¾è¿™äº›å¯èƒ½ä¸æ˜¯åœ¨ä½ çš„ç»„ç»‡ä¸­æœ€ä½³çš„æ—¶é—´å’Œèµ„æºçš„ä½¿ç”¨æ–¹å¼ï¼Œå› ä¸ºè®¸å¤šè¿™äº›æ£€æŸ¥éƒ½å¯ä»¥è‡ªåŠ¨åŒ–ã€‚æœ‰å¾ˆå¤šå·¥å…·å¯ä»¥ç¡®ä¿æ‚¨çš„ä»£ç æ ¼å¼ä¿æŒä¸€è‡´ï¼Œéµå¾ªå‘½åå’Œ final å…³é”®å­—ä½¿ç”¨çš„æ ‡å‡†ï¼Œå¹¶ä¸”æ‰¾å‡ºç”±ç®€å•çš„ç¼–ç¨‹é”™è¯¯å¼•èµ·çš„å¸¸è§é”™è¯¯ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä»å‘½ä»¤è¡Œè¿è¡Œ IntelliJ IDEA çš„æ£€æŸ¥ï¼Œè¿™æ ·ä½ å°±ä¸å¿…ä¾èµ–æ‰€æœ‰å›¢é˜Ÿæˆå‘˜åœ¨ IDE ä¸­è¿è¡Œç›¸åŒçš„æ£€æŸ¥ã€‚

<http://blog.codinghorror.com/code-reviews-just-do-it/>

<https://en.wikipedia.org/wiki/Cognitive_load>

## ä½ åº”è¯¥å¯»æ‰¾ä»€ä¹ˆ

äººç±»çœŸæ­£æ“…é•¿çš„æ˜¯ä»€ä¹ˆï¼Ÿåœ¨ä»£ç å®¡æŸ¥ä¸­ï¼Œæˆ‘ä»¬èƒ½æ³¨æ„åˆ°å“ªäº›äº‹æƒ…æ˜¯å·¥å…·æ— æ³•å§”æ‰˜çš„ï¼Ÿ

ç»“æœæ˜¯ï¼Œæœ‰å¾ˆå¤šäº‹æƒ…ã€‚è¿™ç»å¯¹ä¸æ˜¯ä¸€ä»½è¯¦å°½æ— é—çš„æ¸…å•ï¼Œæˆ‘ä»¬ä¹Ÿä¸ä¼šåœ¨è¿™é‡Œè¯¦ç»†è®¨è®ºå…¶ä¸­çš„ä»»ä½•ä¸€ä¸ªã€‚ç›¸åï¼Œè¿™åº”è¯¥æ˜¯ä½ ç»„ç»‡å†…å…³äºç›®å‰ä½ åœ¨ä»£ç å®¡æŸ¥ä¸­å¯»æ‰¾å“ªäº›äº‹æƒ…çš„å¯¹è¯çš„å¼€å§‹ï¼Œä»¥åŠå¯èƒ½ä½ è¿˜åº”è¯¥å¯»æ‰¾ä»€ä¹ˆã€‚

## è®¾è®¡

- æ–°ä»£ç å¦‚ä½•ä¸æ•´ä½“æ¶æ„ç›¸åŒ¹é…ï¼Ÿ
- ä»£ç æ˜¯å¦éµå¾ª SOLID åŸåˆ™ã€é¢†åŸŸé©±åŠ¨è®¾è®¡ Â® å’Œå…¶ä»–å›¢é˜Ÿé’ççš„è®¾è®¡èŒƒå¼ï¼Ÿ
- åœ¨æ–°ä»£ç ä¸­ä½¿ç”¨äº†å“ªäº›è®¾è®¡æ¨¡å¼ï¼Ÿè¿™äº›æ˜¯å¦é€‚å½“ï¼Ÿ
- å¦‚æœä»£ç åº“æ··åˆäº†æ ‡å‡†æˆ–è®¾è®¡é£æ ¼ï¼Œæ–°ä»£ç æ˜¯å¦éµå¾ªå½“å‰çš„å®è·µï¼Ÿä»£ç æ˜¯å¦æœç€æ­£ç¡®çš„æ–¹å‘è¿ç§»ï¼Œè¿˜æ˜¯å®ƒæ¨¡ä»¿äº†åº”è¯¥é€æ­¥æ·˜æ±°çš„æ—§ä»£ç ï¼Ÿ
- ä»£ç æ˜¯å¦ä½äºæ­£ç¡®çš„åœ°æ–¹ï¼Ÿä¾‹å¦‚ï¼Œå¦‚æœä»£ç ä¸è®¢å•ç›¸å…³ï¼Œå®ƒæ˜¯ä½äºè®¢å•æœåŠ¡ä¸­å—ï¼Ÿ
- æ–°ä»£ç æ˜¯å¦æœ‰åœ¨ç°æœ‰ä»£ç ä¸­å¤ç”¨æŸç§ä¸œè¥¿çš„å¯èƒ½æ€§ï¼Ÿæ–°ä»£ç æ˜¯å¦æä¾›äº†å¯ä»¥åœ¨ç°æœ‰ä»£ç ä¸­å¤ç”¨çš„åŠŸèƒ½ï¼Ÿæ–°ä»£ç æ˜¯å¦å¼•å…¥äº†é‡å¤å†…å®¹ï¼Ÿå¦‚æœæ˜¯çš„è¯ï¼Œåº”è¯¥å°†å…¶é‡æ„ä¸ºæ›´å¯é‡ç”¨çš„æ¨¡å¼ï¼Œè¿˜æ˜¯åœ¨è¿™ä¸ªé˜¶æ®µå¯ä»¥æ¥å—ï¼Ÿ
- ä»£ç æ˜¯å¦è¿‡åº¦è®¾è®¡ï¼Ÿå®ƒä¸ºäº†ä¸å¿…è¦çš„å¯å¤ç”¨æ€§è€Œæ„å»ºäº†å—ï¼Ÿå›¢é˜Ÿæ˜¯å¦‚ä½•å¹³è¡¡è€ƒè™‘å¯å¤ç”¨æ€§ä¸ YAGNI10 çš„ï¼Ÿ

<https://www.jetbrains.com/idea/help/running-inspections-offline.html>  
<https://en.wikipedia.org/wiki/SOLID_(object-oriented_design>)  
<https://en.wikipedia.org/wiki/Domain-driven_design>  
<https://en.wikipedia.org/wiki/Software_design_pattern>  
<https://en.wikipedia.org/wiki/You_aren%27t_gonna_need_it>

## å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§

- å­—æ®µã€å˜é‡ã€å‚æ•°ã€æ–¹æ³•å’Œç±»åçš„å‘½åæ˜¯å¦çœŸæ­£åæ˜ äº†å®ƒä»¬ä»£è¡¨çš„å®ä½“ï¼Ÿ
- é€šè¿‡é˜…è¯»ä»£ç ï¼Œæˆ‘èƒ½å¦ç†è§£ä»£ç çš„åŠŸèƒ½ï¼Ÿ
- æˆ‘èƒ½ç†è§£æµ‹è¯•çš„åŠŸèƒ½å—ï¼Ÿ
- æµ‹è¯•è¦†ç›–äº†å¥½çš„æ¡ˆä¾‹å­é›†å—ï¼Ÿå®ƒä»¬æ¶µç›–äº†æ­£å¸¸è·¯å¾„å’Œå¼‚å¸¸æƒ…å†µå—ï¼Ÿæ˜¯å¦æœ‰æœªè¢«è€ƒè™‘çš„æ¡ˆä¾‹ï¼Ÿ
- å¼‚å¸¸é”™è¯¯æ¶ˆæ¯æ˜¯å¦å®¹æ˜“ç†è§£ï¼Ÿ
- æ˜¯å¦æœ‰ä»¤äººå›°æƒ‘çš„ä»£ç éƒ¨åˆ†å·²ç»è¢«æ–‡æ¡£åŒ–ã€æ³¨é‡Šæˆ–è€…è¢«å¯ç†è§£çš„æµ‹è¯•ï¼ˆæ ¹æ®å›¢é˜Ÿçš„åå¥½ï¼‰æ‰€æ¶µç›–ï¼Ÿ

## åŠŸèƒ½æ€§

- ä»£ç å®é™…ä¸Šæ˜¯å¦åšåˆ°äº†å®ƒåº”è¯¥åšçš„äº‹æƒ…ï¼Ÿå¦‚æœæœ‰è‡ªåŠ¨åŒ–æµ‹è¯•æ¥ç¡®ä¿ä»£ç çš„æ­£ç¡®æ€§ï¼Œè¿™äº›æµ‹è¯•æ˜¯å¦çœŸçš„æµ‹è¯•äº†ä»£ç æ˜¯å¦ç¬¦åˆçº¦å®šçš„è¦æ±‚ï¼Ÿ
- ä»£ç çœ‹èµ·æ¥æ˜¯å¦å«æœ‰æ½œåœ¨çš„ç»†å¾®é”™è¯¯ï¼Œæ¯”å¦‚ä½¿ç”¨é”™è¯¯çš„å˜é‡è¿›è¡Œæ£€æŸ¥ï¼Œæˆ–è€…æ˜¯æ— æ„ä¸­ä½¿ç”¨â€œå’Œâ€è€Œä¸æ˜¯â€œæˆ–â€ï¼Ÿ

# ä½ æœ‰è€ƒè™‘è¿‡â€¦

- ä»£ç ä¸­æ˜¯å¦æœ‰æ½œåœ¨çš„å®‰å…¨é—®é¢˜ï¼Ÿ
- æ˜¯å¦éœ€è¦æ»¡è¶³ç›‘ç®¡è¦æ±‚ï¼Ÿ
- å¯¹äºæ²¡æœ‰è‡ªåŠ¨åŒ–æ€§èƒ½æµ‹è¯•è¦†ç›–çš„åŒºåŸŸï¼Œæ–°ä»£ç æ˜¯å¦å¼•å…¥äº†å¯é¿å…çš„æ€§èƒ½é—®é¢˜ï¼Œæ¯”å¦‚ä¸å¿…è¦çš„æ•°æ®åº“è°ƒç”¨æˆ–è¿œç¨‹æœåŠ¡è°ƒç”¨ï¼Ÿ
- ä½œè€…æ˜¯å¦éœ€è¦åˆ›å»ºå…¬å…±æ–‡æ¡£ï¼Œæˆ–è€…æ›´æ”¹ç°æœ‰çš„å¸®åŠ©æ–‡ä»¶ï¼Ÿ
- ç”¨æˆ·ç•Œé¢æ¶ˆæ¯æ˜¯å¦å·²ç»è¢«æ£€æŸ¥è¿‡æ­£ç¡®æ€§ï¼Ÿ
- æ˜¯å¦æœ‰æ˜æ˜¾çš„é”™è¯¯ä¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­åœæ­¢å·¥ä½œï¼Ÿä»£ç æ˜¯å¦ä¼šä¸å°å¿ƒæŒ‡å‘æµ‹è¯•æ•°æ®åº“ï¼Œæˆ–è€…æ˜¯æ˜¯å¦æœ‰ç¡¬ç¼–ç çš„å ä½ç¬¦åº”è¯¥è¢«æ›¿æ¢ä¸ºå®é™…çš„æœåŠ¡ï¼Ÿ

# æµ‹è¯•

åœ¨å‰ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºäº†åœ¨ä»£ç å®¡æŸ¥ä¸­å¯ä»¥å¯»æ‰¾çš„å¹¿æ³›å†…å®¹ã€‚ç°åœ¨æˆ‘ä»¬å°†é‡ç‚¹æ”¾åœ¨ä¸€ä¸ªé¢†åŸŸï¼šåº”è¯¥å…³æ³¨æµ‹è¯•ä»£ç çš„å“ªäº›æ–¹é¢ã€‚

æˆ‘ä»¬å‡è®¾ï¼šâ€œ_ä½ çš„å›¢é˜Ÿå·²ç»ä¸ºä»£ç ç¼–å†™äº†è‡ªåŠ¨åŒ–æµ‹è¯•ã€‚_ æµ‹è¯•ä¼šåœ¨æŒç»­é›†æˆï¼ˆCIï¼‰ç¯å¢ƒä¸­å®šæœŸè¿è¡Œã€‚æ­£åœ¨è¢«å®¡æŸ¥çš„ä»£ç å·²ç»é€šè¿‡äº†è‡ªåŠ¨ç¼–è¯‘/æµ‹è¯•è¿‡ç¨‹ã€‚â€

## æé—®

åœ¨è¿™ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨åœ¨ä»£ç å®¡æŸ¥ä¸­æŸ¥çœ‹æµ‹è¯•æ—¶å®¡é˜…è€…å¯èƒ½ä¼šè€ƒè™‘çš„ä¸€äº›äº‹é¡¹ã€‚

## æ˜¯å¦æœ‰å¯¹æ–°/ä¿®æ”¹åçš„ä»£ç è¿›è¡Œæµ‹è¯•ï¼Ÿ

å¯¹äºæ–°çš„æˆ–ä¿®æ”¹åçš„ä»£ç æ¥è¯´ï¼Œæ— è®ºæ˜¯ä¿®å¤é”™è¯¯è¿˜æ˜¯æ·»åŠ æ–°åŠŸèƒ½ï¼Œéƒ½å¾ˆå°‘ä¸éœ€è¦ä¸€ä¸ªæ–°æˆ–æ›´æ–°çš„æµ‹è¯•æ¥è¦†ç›–å®ƒã€‚å³ä½¿æ˜¯å‡ºäºâ€œéåŠŸèƒ½æ€§â€åŸå› çš„æ›´æ”¹ï¼Œå¦‚æ€§èƒ½æå‡ï¼Œä¹Ÿç»å¸¸å¯ä»¥é€šè¿‡æµ‹è¯•æ¥è¯æ˜ã€‚å¦‚æœä»£ç å®¡æŸ¥ä¸­æ²¡æœ‰åŒ…å«ä»»ä½•æµ‹è¯•ï¼Œä½œä¸ºå®¡é˜…è€…ï¼Œä½ é¦–å…ˆåº”è¯¥é—®çš„é—®é¢˜æ˜¯ï¼šâ€œä¸ºä»€ä¹ˆä¸ï¼Ÿâ€

## æµ‹è¯•æ˜¯å¦è‡³å°‘è¦†ç›–äº†å¤æ‚çš„ä»£ç éƒ¨åˆ†ï¼Ÿ

è¶…è¶Šç®€å•åœ°â€œæ˜¯å¦æœ‰æµ‹è¯•â€çš„é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å›ç­”çš„æ˜¯ï¼šâ€œé‡è¦çš„ä»£ç æ˜¯å¦è‡³å°‘è¢«ä¸€ä¸ªæµ‹è¯•æ‰€è¦†ç›–ï¼Ÿâ€

æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡å½“ç„¶æ˜¯æˆ‘ä»¬å¯ä»¥è‡ªåŠ¨åŒ–çš„äº‹æƒ…ã€‚ä½†æˆ‘ä»¬ä¸ä»…ä»…å¯ä»¥æ£€æŸ¥ç‰¹å®šçš„ç™¾åˆ†æ¯”è¦†ç›–ç‡ï¼šæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨è¦†ç›–ç‡å·¥å…·æ¥ç¡®ä¿æ­£ç¡®çš„ä»£ç åŒºåŸŸè¢«è¦†ç›–ã€‚

è€ƒè™‘ä»¥ä¸‹ä¾‹å­ï¼š

xxxxxxxxxxxxx

## æˆ‘èƒ½å¦ç†è§£æµ‹è¯•ï¼Ÿ

æ‹¥æœ‰æä¾›å……åˆ†è¦†ç›–ç‡çš„æµ‹è¯•æ˜¯ä¸€ä»¶äº‹æƒ…ï¼Œä½†å¦‚æœè¿æˆ‘ä¹Ÿä½œä¸ºäººç±»éƒ½æ— æ³•ç†è§£è¿™äº›æµ‹è¯•ï¼Œå®ƒä»¬çš„ä½¿ç”¨ä»·å€¼å°±æœ‰é™äº†ã€‚å½“æµ‹è¯•å¤±è´¥æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿå°†å¾ˆéš¾çŸ¥é“å¦‚ä½•ä¿®å¤å®ƒä»¬ã€‚

è€ƒè™‘ä»¥ä¸‹æƒ…å†µï¼š

## æµ‹è¯•æ˜¯å¦ä¸è¦æ±‚ç›¸ç¬¦ï¼Ÿ

è¿™æ˜¯ä¸€ä¸ªçœŸæ­£éœ€è¦äººç±»ä¸“ä¸šçŸ¥è¯†çš„åœ°æ–¹ã€‚æ— è®ºæ˜¯è¢«å®¡æŸ¥çš„ä»£ç æ»¡è¶³çš„è¦æ±‚ç¼–ç åœ¨æŸä¸ªæ­£å¼æ–‡ä»¶ä¸­ï¼Œè¿˜æ˜¯ä½äºç”¨æˆ·æ•…äº‹çš„å¡ç‰‡ä¸Šï¼Œæˆ–è€…æ˜¯ç”¨æˆ·æå‡ºçš„é”™è¯¯æŠ¥å‘Šå†…ï¼Œæ­£åœ¨è¢«å®¡æŸ¥çš„ä»£ç åº”è¯¥ä¸æŸäº›åˆå§‹è¦æ±‚ç›¸å…³ã€‚

å®¡é˜…è€…åº”è¯¥æ‰¾åˆ°åŸå§‹è¦æ±‚å¹¶æŸ¥çœ‹ï¼š

- æµ‹è¯•æ˜¯å¦ä¸å…¶ç›¸ç¬¦ï¼Œæ— è®ºå®ƒä»¬æ˜¯å•å…ƒæµ‹è¯•ã€ç«¯åˆ°ç«¯æµ‹è¯•è¿˜æ˜¯å…¶ä»–ç±»å‹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœè¦æ±‚æ˜¯â€œåº”è¯¥åœ¨å¯†ç å­—æ®µä¸­å…è®¸ç‰¹æ®Šå­—ç¬¦â€˜#â€™ã€â€˜!â€™å’Œâ€˜&â€™â€ï¼Œé‚£ä¹ˆåº”è¯¥æœ‰ä¸€ä¸ªä½¿ç”¨è¿™äº›å€¼çš„å¯†ç å­—æ®µçš„æµ‹è¯•ã€‚å¦‚æœæµ‹è¯•ä½¿ç”¨äº†ä¸åŒçš„ç‰¹æ®Šå­—ç¬¦ï¼Œé‚£ä¹ˆå®ƒä¸èƒ½è¯æ˜ä»£ç ç¬¦åˆæ ‡å‡†ã€‚
- æµ‹è¯•è¦†ç›–äº†æ‰€æœ‰æåˆ°çš„æ ‡å‡†ã€‚åœ¨æˆ‘ä»¬çš„ç‰¹æ®Šå­—ç¬¦ä¾‹å­ä¸­ï¼Œè¦æ±‚å¯èƒ½ç»§ç»­è¯´â€œâ€¦å¹¶ä¸”å¦‚æœä½¿ç”¨äº†å…¶ä»–ç‰¹æ®Šå­—ç¬¦ï¼Œåˆ™å‘ç”¨æˆ·æä¾›é”™è¯¯æ¶ˆæ¯â€ã€‚åœ¨è¿™é‡Œï¼Œå®¡é˜…è€…åº”è¯¥æ£€æŸ¥æ˜¯å¦æœ‰é’ˆå¯¹ä½¿ç”¨æ— æ•ˆå­—ç¬¦æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆçš„æµ‹è¯•ã€‚

## æˆ‘èƒ½å¦æƒ³åˆ°ç°æœ‰æµ‹è¯•æœªè¦†ç›–çš„æƒ…å†µï¼Ÿ

é€šå¸¸æˆ‘ä»¬çš„è¦æ±‚å¹¶æ²¡æœ‰æ˜ç¡®è§„å®šã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œå®¡é˜…è€…åº”è¯¥è€ƒè™‘åŸå§‹é”™è¯¯/é—®é¢˜/æ•…äº‹ä¸­æ²¡æœ‰è¢«è¦†ç›–çš„è¾¹ç¼˜æƒ…å†µã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æ–°çš„åŠŸèƒ½æ˜¯â€œèµ‹äºˆç”¨æˆ·ç™»å½•ç³»ç»Ÿçš„èƒ½åŠ›â€ï¼Œå®¡é˜…è€…å¯èƒ½ä¼šæƒ³ï¼Œâ€œå¦‚æœç”¨æˆ·è¾“å…¥ null ä½œä¸ºç”¨æˆ·åä¼šæ€æ ·ï¼Ÿâ€æˆ–è€…â€œå¦‚æœç”¨æˆ·ä¸å­˜åœ¨äºç³»ç»Ÿä¸­ä¼šå‘ç”Ÿä»€ä¹ˆæ ·çš„é”™è¯¯ï¼Ÿâ€ã€‚å¦‚æœåœ¨è¢«å®¡æŸ¥çš„ä»£ç ä¸­å­˜åœ¨è¿™äº›æµ‹è¯•ï¼Œé‚£ä¹ˆå®¡é˜…è€…å°±å¯ä»¥å¢åŠ å¯¹ä»£ç æœ¬èº«å¤„ç†è¿™äº›æƒ…å†µçš„ä¿¡å¿ƒã€‚å¦‚æœè¿™äº›å¼‚å¸¸æƒ…å†µçš„æµ‹è¯•ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå®¡é˜…è€…å¿…é¡»æ£€æŸ¥ä»£ç ä»¥ç¡®å®šå®ƒä»¬æ˜¯å¦å·²å¾—åˆ°å¤„ç†ã€‚

å¦‚æœä»£ç å­˜åœ¨ä½†æµ‹è¯•æ²¡æœ‰ï¼Œè¿™å–å†³äºä½ çš„å›¢é˜Ÿæ¥å†³å®šæ”¿ç­–â€”â€”ä½ æ˜¯å¦è¦æ±‚ä½œè€…æ·»åŠ è¿™äº›æµ‹è¯•ï¼Ÿæˆ–è€…ä½ æ»¡æ„äºä»£ç å®¡æŸ¥è¯æ˜äº†è¾¹ç¼˜æƒ…å†µè¢«è¦†ç›–ï¼Ÿ

## æ˜¯å¦æœ‰æµ‹è¯•æ¥è®°å½•ä»£ç çš„é™åˆ¶ï¼Ÿ

ä½œä¸ºä¸€ä¸ªå®¡é˜…è€…ï¼Œå¾€å¾€å¯ä»¥çœ‹åˆ°æ­£åœ¨å®¡æŸ¥çš„ä»£ç ä¸­çš„é™åˆ¶ã€‚è¿™äº›é™åˆ¶æœ‰æ—¶æ˜¯æ•…æ„çš„â€”â€”ä¾‹å¦‚ï¼Œä¸€ä¸ªåªèƒ½å¤„ç†æ¯ä¸ªæ‰¹æ¬¡æœ€å¤š 1000 é¡¹çš„æ‰¹é‡å¤„ç†è¿‡ç¨‹ã€‚

ä¸€ç§è®°å½•è¿™äº›æ•…æ„é™åˆ¶çš„æ–¹æ³•å°±æ˜¯æ˜ç¡®åœ°æµ‹è¯•å®ƒä»¬ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½æœ‰ä¸€ä¸ªæµ‹è¯•æ¥è¯æ˜å¦‚æœä½ çš„æ‰¹æ¬¡å¤§å°è¶…è¿‡ 1000 ä¼šæŠ›å‡ºæŸç§å¼‚å¸¸ã€‚

ä¸æ˜¯å¼ºåˆ¶çš„å¿…é¡»åœ¨è‡ªåŠ¨åŒ–æµ‹è¯•ä¸­è¡¨è¾¾è¿™äº›é™åˆ¶ï¼Œä½†å¦‚æœä½œè€…å†™äº†ä¸€ä¸ªæ˜¾ç¤ºä»–ä»¬å·²å®æ–½çš„é™åˆ¶çš„æµ‹è¯•ï¼Œé‚£ä¹ˆæœ‰è¿™ä¸ªæµ‹è¯•å°±æ„å‘³ç€è¿™äº›é™åˆ¶æ˜¯æ•…æ„çš„ï¼ˆå¹¶ä¸”è¢«è®°å½•äº†ï¼‰ï¼Œè€Œä¸æ˜¯ä»…ä»…æ˜¯ä¸€ä¸ªç–å¿½ã€‚

## ä»£ç å®¡æŸ¥ä¸­çš„æµ‹è¯•æ˜¯å¦æ˜¯æ­£ç¡®çš„ç±»å‹/çº§åˆ«ï¼Ÿ

ä¾‹å¦‚ï¼Œä½œè€…æ˜¯åœ¨åšæ˜‚è´µçš„é›†æˆæµ‹è¯•ï¼Œè€Œå•å…ƒæµ‹è¯•å¯èƒ½å°±è¶³å¤Ÿäº†å—ï¼Ÿä»–ä»¬æœ‰æ²¡æœ‰ç¼–å†™é‚£äº›åœ¨æŒç»­é›†æˆï¼ˆCIï¼‰ç¯å¢ƒä¸­æ— æ³•æœ‰æ•ˆæˆ–ä¸€è‡´è¿è¡Œçš„æ€§èƒ½å¾®åŸºå‡†æµ‹è¯•ï¼Ÿ

ç†æƒ³æƒ…å†µä¸‹ï¼Œä½ çš„è‡ªåŠ¨åŒ–æµ‹è¯•åº”è¯¥å°½å¯èƒ½åœ°å¿«åœ°è¿è¡Œï¼Œè¿™æ„å‘³ç€ä¸éœ€è¦è¿›è¡Œæ˜‚è´µçš„ç«¯åˆ°ç«¯æµ‹è¯•æ¥æ£€æŸ¥æ‰€æœ‰ç±»å‹çš„ç‰¹æ€§ã€‚ä¸€ä¸ªæ‰§è¡ŒæŸäº›æ•°å­¦åŠŸèƒ½æˆ–å¸ƒå°”é€»è¾‘æ£€æŸ¥çš„æ–¹æ³•ä¼¼ä¹æ˜¯æ–¹æ³•çº§å•å…ƒæµ‹è¯•çš„è‰¯å¥½å€™é€‰ã€‚

## æ˜¯å¦æœ‰é’ˆå¯¹å®‰å…¨æ–¹é¢çš„æµ‹è¯•ï¼Ÿ

å®‰å…¨æ€§æ˜¯ä»£ç å®¡æŸ¥å¯ä»¥çœŸæ­£å¸¦æ¥å¥½å¤„çš„é¢†åŸŸä¹‹ä¸€ã€‚æˆ‘ä»¬ä¼šåœ¨ä»¥åä¸“é—¨å†™ä¸€ç¯‡å…³äºå®‰å…¨æ€§çš„æ–‡ç« ï¼Œä½†åœ¨æµ‹è¯•è¯é¢˜ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºè®¸å¤šå¸¸è§é—®é¢˜ç¼–å†™æµ‹è¯•ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸Šè¿°çš„ç™»å½•ä»£ç ï¼Œæˆ‘ä»¬å¯èƒ½è¿˜æƒ³è¦å†™ä¸€ä¸ªæµ‹è¯•æ¥æ˜¾ç¤ºå¦‚æœä¸èƒ½é¦–å…ˆè¿›è¡Œèº«ä»½éªŒè¯ï¼Œæˆ‘ä»¬å°±ä¸èƒ½è¿›å…¥ç½‘ç«™çš„å—ä¿æŠ¤åŒºåŸŸï¼ˆæˆ–è°ƒç”¨å—ä¿æŠ¤çš„ API æ–¹æ³•ï¼‰ã€‚

## æ€§èƒ½æµ‹è¯•

åœ¨å‰ä¸€ç« ä¸­ï¼Œæˆ‘æåˆ°äº†æ€§èƒ½ä½œä¸ºå®¡é˜…è€…å¯èƒ½ä¼šæ£€æŸ¥çš„ä¸€ä¸ªé¢†åŸŸã€‚è‡ªåŠ¨åŒ–æ€§èƒ½æµ‹è¯•æ˜¾ç„¶æ˜¯æœ¬ç« å¯ä»¥æ¢ç´¢çš„å¦ä¸€ç±»æµ‹è¯•ï¼Œä½†æˆ‘å°†æŠŠè¿™äº›ç±»å‹æµ‹è¯•çš„è®¨è®ºç•™åˆ°ä»¥åå…³äºä»£ç å®¡æŸ¥ä¸­çš„ç‰¹å®šæ€§èƒ½æ–¹é¢çš„ç« èŠ‚ã€‚

## å®¡é˜…è€…ä¹Ÿå¯ä»¥ç¼–å†™æµ‹è¯•

ä¸åŒçš„ç»„ç»‡å¯¹ä»£ç å®¡æŸ¥æœ‰ä¸åŒçš„æ–¹æ³•ã€‚æœ‰æ—¶éå¸¸æ¸…æ¥šä½œè€…è´Ÿè´£åšå‡ºæ‰€æœ‰å¿…è¦çš„ä»£ç æ›´æ”¹ï¼›æœ‰æ—¶åˆ™æ›´å…·æœ‰åˆä½œæ€§ï¼Œå®¡é˜…è€…è‡ªå·±æäº¤å¯¹ä»£ç çš„å»ºè®®ã€‚

æ— è®ºä½ é‡‡å–å“ªç§æ–¹æ³•ï¼Œä½œä¸ºä¸€ä¸ªå®¡é˜…è€…ï¼Œä½ å¯èƒ½å‘ç°ç¼–å†™ä¸€äº›é¢å¤–çš„æµ‹è¯•æ¥æ£€æŸ¥å®¡æŸ¥ä¸­çš„ä»£ç éå¸¸æœ‰ä»·å€¼ï¼Œè¿™å¯¹äºç†è§£é‚£ç‰‡ä»£ç æ¥è¯´å°±åƒå¯åŠ¨ UI å¹¶ä¸ä¸€ä¸ªæ–°ç‰¹æ€§äº’åŠ¨ä¸€æ ·æœ‰ä»·å€¼ã€‚æŸäº›æ–¹æ³•å’Œä»£ç å®¡æŸ¥å·¥å…·ä½¿å®éªŒä»£ç å˜å¾—æ›´åŠ å®¹æ˜“ï¼Œè€Œå…¶ä»–åˆ™ä¸é‚£ä¹ˆå®¹æ˜“ã€‚å›¢é˜Ÿçš„åˆ©ç›Šåœ¨äºå°½å¯èƒ½è½»æ¾åœ°æŸ¥çœ‹å’Œç©è½¬ä»£ç ï¼Œè¿›è¡Œä»£ç å®¡æŸ¥ã€‚

æäº¤è¿™äº›é¢å¤–æµ‹è¯•ä½œä¸ºå®¡æŸ¥çš„ä¸€éƒ¨åˆ†å¯èƒ½æ˜¯æœ‰ä»·å€¼çš„ï¼Œä½†åŒæ ·ä¹Ÿå¯èƒ½æ˜¯æ²¡æœ‰å¿…è¦çš„ï¼Œä¾‹å¦‚å¦‚æœå®éªŒå·²ç»ç»™äº†æˆ‘ï¼Œä½œä¸ºå®¡é˜…è€…ï¼Œæ»¡æ„çš„ç­”æ¡ˆæ¥å›ç­”æˆ‘çš„é—®é¢˜çš„è¯ã€‚

## æ€»ç»“

æ— è®ºä½ çš„ç»„ç»‡å¦‚ä½•å¤„ç†ä»£ç å®¡æŸ¥è¿‡ç¨‹ï¼Œè¿›è¡Œä»£ç å®¡æŸ¥éƒ½æœ‰è®¸å¤šä¼˜åŠ¿ã€‚ä½ å¯ä»¥åœ¨ä»£ç é›†æˆåˆ°ä¸»ä»£ç åº“ä¹‹å‰ï¼Œåœ¨å®ƒä»ç„¶å®¹æ˜“ä¿®å¤å¹¶ä¸”ä¸Šä¸‹æ–‡ä»åœ¨å¼€å‘è€…çš„å¤§è„‘ä¸­æ—¶ï¼Œä½¿ç”¨ä»£ç å®¡æŸ¥æ¥å‘ç°æ½œåœ¨çš„ä»£ç é—®é¢˜ã€‚

ä½œä¸ºä¸€ä¸ªä»£ç å®¡é˜…è€…ï¼Œä½ åº”è¯¥æ£€æŸ¥åŸå§‹å¼€å‘äººå‘˜æ˜¯å¦æ€è€ƒè¿‡ä»–ä»¬çš„ä»£ç å¯èƒ½çš„ä½¿ç”¨æ–¹å¼ã€å¯èƒ½åœ¨å“ªäº›æ¡ä»¶ä¸‹ä¼šå‡ºé”™ï¼Œå¹¶å¤„ç†äº†è¾¹ç¼˜æƒ…å†µï¼Œå¯èƒ½é€šè¿‡è‡ªåŠ¨åŒ–æµ‹è¯•â€œæ–‡æ¡£åŒ–â€é¢„æœŸçš„è¡Œä¸ºï¼ˆåœ¨æ­£å¸¸ä½¿ç”¨å’Œå¼‚å¸¸æƒ…å†µä¸‹ï¼‰ã€‚

å¦‚æœå®¡é˜…è€…å¯»æ‰¾æµ‹è¯•çš„å­˜åœ¨æ€§å¹¶æ£€æŸ¥æµ‹è¯•çš„æ­£ç¡®æ€§ï¼Œä½œä¸ºä¸€ä¸ªå›¢é˜Ÿï¼Œä½ å°±å¯ä»¥å¯¹ä»£ç çš„åŠŸèƒ½æœ‰ç›¸å½“é«˜çš„ä¿¡å¿ƒã€‚æ­¤å¤–ï¼Œå¦‚æœè¿™äº›æµ‹è¯•åœ¨ä¸€ä¸ª CI ç¯å¢ƒä¸­å®šæœŸè¿è¡Œï¼Œä½ å¯ä»¥çœ‹åˆ°ä»£ç æŒç»­å·¥ä½œâ€”â€”å®ƒä»¬æä¾›äº†è‡ªåŠ¨å›å½’æ£€æµ‹ã€‚å¦‚æœä»£ç å®¡é˜…è€…é«˜åº¦é‡è§†ä»–ä»¬æ­£åœ¨å®¡æŸ¥çš„ä»£ç çš„è‰¯å¥½è´¨é‡æµ‹è¯•ï¼Œé‚£ä¹ˆè¿™é¡¹ä»£ç å®¡æŸ¥çš„ä»·å€¼åœ¨å®¡é˜…è€…ç‚¹å‡»â€œæ¥å—â€æŒ‰é’®ä¹‹åä¹Ÿä¼šç»§ç»­å­˜åœ¨ã€‚

### æ€§èƒ½

åœ¨è¿™ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºåœ¨ä»£ç å®¡æŸ¥è¿‡ç¨‹ä¸­å¯ä»¥å¯»æ‰¾å“ªäº›å…³äºè¢«å®¡æŸ¥ä»£ç æ€§èƒ½çš„é—®é¢˜ã€‚

å°±åƒæ‰€æœ‰æ¶æ„/è®¾è®¡é¢†åŸŸä¸€æ ·ï¼Œç³»ç»Ÿæ€§èƒ½çš„éåŠŸèƒ½æ€§è¦æ±‚åº”è¯¥äº‹å…ˆè®¾å®šã€‚æ— è®ºä½ æ˜¯åœ¨å¼€å‘ä¸€ä¸ªå¿…é¡»ä»¥çº³ç§’å“åº”çš„ä½å»¶è¿Ÿäº¤æ˜“ç³»ç»Ÿï¼Œè¿˜æ˜¯åœ¨åˆ›å»ºä¸€ä¸ªéœ€è¦å“åº”ç”¨æˆ·çš„åœ¨çº¿è´­ç‰©ç½‘ç«™ï¼Œæˆ–è€…ä½ åœ¨ç¼–å†™ä¸€ä¸ªç®¡ç†â€œå¾…åŠäº‹é¡¹â€åˆ—è¡¨çš„æ‰‹æœºåº”ç”¨ç¨‹åºï¼Œä½ åº”è¯¥æœ‰ä¸€äº›å…³äºä»€ä¹ˆè¢«è®¤ä¸ºæ˜¯â€œå¤ªæ…¢â€çš„æ¦‚å¿µã€‚

è®©æˆ‘ä»¬æ¥çœ‹çœ‹å½±å“æ€§èƒ½çš„ä¸€äº›å› ç´ ï¼Œå®¡é˜…è€…åœ¨ä»£ç å®¡æŸ¥è¿‡ç¨‹ä¸­å¯ä»¥å¯»æ‰¾è¿™äº›å› ç´ ã€‚

æ€§èƒ½è¦æ±‚

åœ¨æˆ‘ä»¬å†³å®šæ˜¯å¦åŸºäºæ€§èƒ½è¿›è¡Œä»£ç å®¡æŸ¥ä¹‹å‰ï¼Œæˆ‘ä»¬åº”è¯¥é—®è‡ªå·±å‡ ä¸ªé—®é¢˜ã€‚

#### è¿™éƒ¨åˆ†åŠŸèƒ½æ˜¯å¦æœ‰ç¡¬æ€§çš„æ€§èƒ½è¦æ±‚ï¼Ÿ

è¢«å®¡æŸ¥çš„è¿™æ®µä»£ç æ˜¯å¦å±äºä¹‹å‰å·²ç»å…¬å¸ƒ SLAï¼ˆæœåŠ¡ç­‰çº§åè®®ï¼‰çš„åŒºåŸŸï¼Ÿæˆ–è€…è¦æ±‚ä¸­æ˜¯å¦è¯´æ˜äº†æ‰€éœ€æ€§èƒ½ç‰¹æ€§ï¼Ÿ

å¦‚æœåŸå§‹è¦æ±‚æ˜¯ä¸€ä¸ªâ€œç™»å½•å±å¹•åŠ è½½å¤ªæ…¢â€çš„é”™è¯¯æŠ¥å‘Šï¼Œé‚£ä¹ˆåŸå§‹å¼€å‘è€…åº”è¯¥æ¾„æ¸…ä¸€ä¸ªåˆé€‚çš„åŠ è½½æ—¶é—´æ˜¯å¤šå°‘â€”â€”å¦åˆ™å®¡é˜…è€…æˆ–ä½œè€…å¦‚ä½•èƒ½å¤Ÿç¡®ä¿¡é€Ÿåº¦å¾—åˆ°äº†è¶³å¤Ÿçš„æ”¹è¿›ï¼Ÿ

å¦‚æœæœ‰ç¡¬æ€§çš„æ€§èƒ½è¦æ±‚ï¼Œé‚£ä¹ˆæ˜¯å¦å­˜åœ¨ä¸€ä¸ªæµ‹è¯•æ¥è¯æ˜å®ƒæ»¡è¶³é‚£äº›è¦æ±‚ï¼Ÿ

ä»»ä½•æ€§èƒ½å…³é”®çš„ç³»ç»Ÿéƒ½åº”è¯¥æœ‰è‡ªåŠ¨åŒ–æ€§èƒ½æµ‹è¯•æ¥ç¡®ä¿å‘å¸ƒ SLAsï¼ˆä¾‹å¦‚ï¼šåœ¨ 10 æ¯«ç§’å†…å¤„ç†å®Œæ‰€æœ‰è¯·æ±‚ï¼‰å¾—ä»¥å®ç°ã€‚å¦‚æœæ²¡æœ‰è¿™äº›æµ‹è¯•ï¼Œä½ åªèƒ½ä¾é ç”¨æˆ·å‘Šè¯‰ä½ æ²¡æœ‰è¾¾åˆ°ä½ çš„ SLA çš„æƒ…å†µã€‚è¿™ä¸ä»…æ˜¯ä¸€ä¸ªç³Ÿç³•çš„ç”¨æˆ·ä½“éªŒï¼Œè¿˜å¯èƒ½å¯¼è‡´å¯ä»¥é¿å…çš„ç½šæ¬¾å’Œè´¹ç”¨ã€‚æœ¬ç³»åˆ—æœ€åä¸€ç¯‡å¸–å­è¯¦ç»†ä»‹ç»äº†ä»£ç å®¡æŸ¥ä¸­çš„æµ‹è¯•ã€‚

### ä¿®å¤/æ–°åŠŸèƒ½æ˜¯å¦å½±å“ç°æœ‰æ€§èƒ½æµ‹è¯•çš„ç»“æœï¼Ÿ

å¦‚æœä½ ç»å¸¸è¿è¡Œæ€§èƒ½æµ‹è¯•ï¼ˆæˆ–è€…ä½ æœ‰å¯ä»¥åœ¨éœ€è¦æ—¶è¿è¡Œçš„å¥—ä»¶ï¼‰ï¼Œæ£€æŸ¥æ–°çš„ä»£ç åœ¨æ€§èƒ½å…³é”®åŒºåŸŸæ˜¯å¦å¼•å…¥äº†ç³»ç»Ÿæ€§èƒ½ä¸‹é™çš„æƒ…å†µã€‚è¿™å¯èƒ½æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–è¿‡ç¨‹ï¼Œä½†æ˜¯ç”±äºä½œä¸º CI ç¯å¢ƒä¸€éƒ¨åˆ†è¿è¡Œæ€§èƒ½æµ‹è¯•è¿œä¸å¦‚è¿è¡Œå•å…ƒæµ‹è¯•å¸¸è§ï¼Œæ‰€ä»¥åœ¨å®¡æŸ¥ä¸­ç‰¹åˆ«æåˆ°è¿™ä¸€æ­¥éª¤æ˜¯æœ‰ä»·å€¼çš„ã€‚

### å¦‚æœæ²¡æœ‰ç¡¬æ€§çš„æ€§èƒ½è¦æ±‚å‘¢ï¼Ÿ

èŠ±å‡ ä¸ªå°æ—¶ç—›è‹¦åœ°æ€è€ƒé‚£äº›èƒ½ä¸ºä½ èŠ‚çœå‡ ä¸ª CPU å‘¨æœŸçš„ä¼˜åŒ–æ˜¯æ²¡æœ‰å¤šå¤§ä»·å€¼çš„ã€‚ä½†å®¡é˜…è€…å¯ä»¥æ£€æŸ¥ä¸€äº›äº‹æƒ…ä»¥ç¡®ä¿ä»£ç ä¸ä¼šå—åˆ°å®Œå…¨å¯é¿å…çš„å¸¸è§æ€§èƒ½é™·é˜±çš„å½±å“ã€‚æŸ¥çœ‹å…¶ä½™åˆ—è¡¨ä»¥äº†è§£æ˜¯å¦æœ‰ä¸€äº›æ˜“äºå–èƒœçš„æ–¹æ³•æ¥é˜²æ­¢æœªæ¥çš„æ€§èƒ½é—®é¢˜ã€‚

### æœåŠ¡çš„/åº”ç”¨ç¨‹åºä¹‹å¤–è°ƒç”¨æ˜¯æ˜‚è´µçš„

ä»»ä½•éœ€è¦ç½‘ç»œè·³è½¬æ¥ä½¿ç”¨ä½ åº”ç”¨ä¹‹å¤–çš„ç³»ç»Ÿéƒ½æ˜¯ä¸€èˆ¬ä¼šæ¯”ä½ ä¸€ä¸ªä¼˜åŒ–ä¸ä½³çš„ equals() æ–¹æ³•è¦è€—è´¹æ›´å¤šæˆæœ¬ã€‚è€ƒè™‘ï¼š

### æ•°æ®åº“è°ƒç”¨

æœ€ä¸¥é‡çš„è¿è§„è€…å¯èƒ½éšè—åœ¨åƒ ORMsï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„å™¨ï¼‰è¿™æ ·çš„æŠ½è±¡èƒŒåã€‚ä½†åœ¨ä»£ç å®¡æŸ¥ä¸­ï¼Œä½ åº”è¯¥èƒ½å¤Ÿæ•æ‰åˆ°æ€§èƒ½é—®é¢˜çš„å¸¸è§åŸå› ï¼Œæ¯”å¦‚åœ¨ä¸€ä¸ªå¾ªç¯ä¸­è°ƒç”¨çš„æ•°æ®åº“å•ä¸ªè°ƒç”¨â€”â€”ä¾‹å¦‚ï¼ŒåŠ è½½ä¸€ä¸ª ID åˆ—è¡¨ï¼Œç„¶åå¯¹æ¯ä¸ªå¯¹åº”çš„ ID æŸ¥è¯¢æ•°æ®åº“ã€‚

æ•°æ®åº“è°ƒç”¨

ä¾‹å¦‚ï¼Œä¸Šé¢çš„ç¬¬ 19 è¡Œå¯èƒ½çœ‹èµ·æ¥ç›¸å½“æ— è¾œï¼Œä½†å®ƒä½äºä¸€ä¸ª for å¾ªç¯å†…â€”â€”ä½ ä¸çŸ¥é“è¿™æ®µä»£ç å¯èƒ½å¯¼è‡´å¤šå°‘æ¬¡æ•°æ®åº“è°ƒç”¨ã€‚

### ä¸å¿…è¦çš„ç½‘ç»œè°ƒç”¨

åƒæ•°æ®åº“ä¸€æ ·ï¼Œè¿œç¨‹æœåŠ¡æœ‰æ—¶å¯èƒ½ä¼šè¿‡åº¦ä½¿ç”¨ï¼Œæœ‰å¤šä¸ªè¿œç¨‹è°ƒç”¨å¯èƒ½åªéœ€è¦ä¸€ä¸ªï¼Œæˆ–è€…æ‰¹å¤„ç†æˆ–ç¼“å­˜å¯ä»¥é˜²æ­¢æ˜‚è´µçš„ç½‘ç»œè°ƒç”¨ã€‚åŒæ ·åœ°ï¼Œåƒæ•°æ®åº“ä¸€æ ·ï¼Œæœ‰æ—¶å€™æŠ½è±¡ä¼šéšè—å®é™…ä¸Šæ–¹æ³•è°ƒç”¨æ˜¯åœ¨è°ƒç”¨è¿œç¨‹ APIã€‚

### ç§»åŠ¨/å¯ç©¿æˆ´åº”ç”¨ç¨‹åºè¿‡å¤šè°ƒç”¨åç«¯

è¿™åŸºæœ¬ä¸Šä¸â€œä¸å¿…è¦çš„ç½‘ç»œè°ƒç”¨â€ç›¸åŒï¼Œä½†è¿˜å¢åŠ äº†åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šï¼Œä¸å¿…è¦åœ°è°ƒç”¨åç«¯ä¸ä»…ä¼šé™ä½æ€§èƒ½ï¼Œè¿˜ä¼šæ¶ˆè€—ç”µæ± çš„é—®é¢˜ã€‚

é«˜æ•ˆä½¿ç”¨èµ„æº

åœ¨è®¨è®ºæˆ‘ä»¬å¦‚ä½•ä½¿ç”¨æˆ‘ä»¬çš„ç½‘ç»œèµ„æºä¹‹åï¼Œå®¡é˜…è€…å¯ä»¥æŸ¥çœ‹å…¶ä»–èµ„æºçš„ç”¨æ³•æ¥è¯†åˆ«å¯èƒ½å­˜åœ¨çš„æ€§èƒ½é—®é¢˜ã€‚

ä»£ç æ˜¯å¦ä½¿ç”¨é”æ¥è®¿é—®å…±äº«èµ„æºï¼Ÿè¿™å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™æˆ–æ­»é”ï¼Ÿ

é”æ˜¯æ€§èƒ½æ€æ‰‹ 11ï¼Œå¹¶ä¸”åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å¾ˆéš¾æ¨ç†ã€‚å¯ä»¥è€ƒè™‘ä»¥ä¸‹æ¨¡å¼ï¼›åªæœ‰ä¸€ä¸ªçº¿ç¨‹å†™å…¥/æ”¹å˜å€¼ï¼Œè€Œæ‰€æœ‰å…¶ä»–çº¿ç¨‹éƒ½å¯ä»¥è‡ªç”±è¯»å–ï¼›æˆ–è€…ä½¿ç”¨æ— é”ç®—æ³• 12ã€‚

## ä»£ç ä¸­æ˜¯å¦æœ‰å¯èƒ½å¼•èµ·å†…å­˜æ³„éœ²çš„ä¸œè¥¿ï¼Ÿ

åœ¨ Java ä¸­ï¼Œä¸€äº›å¸¸è§çš„åŸå› å¯ä»¥æ˜¯ï¼šå¯å˜çš„é™æ€å­—æ®µã€ä½¿ç”¨ ThreadLocal ä»¥åŠä½¿ç”¨ ClassLoader13ã€‚

## åº”ç”¨ç¨‹åºçš„å†…å­˜å ç”¨æœ‰æ— é™å¢é•¿çš„å¯èƒ½æ€§å—ï¼Ÿ

è¿™ä¸åŒäºå†…å­˜æ³„éœ²â€”â€”å†…å­˜æ³„éœ²æ˜¯æœªä½¿ç”¨çš„å¯¹è±¡ä¸èƒ½è¢«åƒåœ¾å›æ”¶å™¨æ”¶é›†ã€‚ä½†ä»»ä½•è¯­è¨€ï¼Œç”šè‡³æ˜¯éåƒåœ¾å›æ”¶çš„è¯­è¨€ï¼Œéƒ½å¯ä»¥åˆ›å»º

11 <http://mechanical-sympathy.blogspot.com.es/2013/08/lock-based-vs-lock-free-concurrent.html>

12 <https://en.wikipedia.org/wiki/Non-blocking_algorithm>

13 <http://docs.oracle.com/javase/8/docs/api/java/lang/ClassLoader.html>

æ•°æ®ç»“æ„æ— é™å¢é•¿ã€‚å¦‚æœä½œä¸ºå®¡é˜…è€…ï¼Œä½ çœ‹åˆ°åˆ—è¡¨æˆ–æ˜ å°„ä¸­ä¸æ–­åœ°æ·»åŠ æ–°å€¼ï¼Œè¯¢é—®åˆ—è¡¨æˆ–æ˜ å°„ä½•æ—¶è¢«ä¸¢å¼ƒæˆ–ä¿®å‰ªã€‚

## æ— é™å†…å­˜å ç”¨

åœ¨ä¸Šé¢çš„ä»£ç å®¡æŸ¥ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰€æœ‰æ¥è‡ª Twitter çš„æ¶ˆæ¯éƒ½è¢«æ·»åŠ åˆ°ä¸€ä¸ªæ˜ å°„ä¸­ã€‚å¦‚æœæˆ‘ä»¬æ›´å…¨é¢åœ°æ£€æŸ¥è¿™ä¸ªç±»ï¼Œæˆ‘ä»¬ä¼šå‘ç° `allTwitterUsers` æ˜ å°„æ°¸è¿œä¸ä¼šè¢«ä¿®å‰ªï¼Œ`TwitterUser` ä¸­çš„æ¨æ–‡åˆ—è¡¨ä¹Ÿæ²¡æœ‰è¢«æ¸…ç†ã€‚å–å†³äºæˆ‘ä»¬æ­£åœ¨ç›‘æ§å¤šå°‘ç”¨æˆ·ä»¥åŠæˆ‘ä»¬å¤šä¹…æ·»åŠ ä¸€æ¬¡æ¨æ–‡ï¼Œè¿™ä¸ªæ˜ å°„å¯èƒ½ä¼šå˜å¾—éå¸¸å¤§ï¼Œé€Ÿåº¦éå¸¸å¿«ã€‚

## ä»£ç æ˜¯å¦å…³é—­äº†è¿æ¥/æµï¼Ÿ

å¿˜è®°å…³é—­è¿æ¥æˆ–æ–‡ä»¶/ç½‘ç»œæµæ˜¯å¾ˆå¸¸è§çš„ã€‚å½“ä½ å®¡æŸ¥ä»–äººçš„ä»£ç æ—¶ï¼Œæ— è®ºä½¿ç”¨ä»€ä¹ˆè¯­è¨€ï¼Œå¦‚æœä½ æ­£åœ¨ä½¿ç”¨çš„æ–‡ä»¶ã€ç½‘ç»œæˆ–æ•°æ®åº“è¿æ¥æ²¡æœ‰è¢«æ­£ç¡®å…³é—­ï¼Œè¯·ç¡®ä¿å®ƒä»¬è¢«æ­£ç¡®å…³é—­ã€‚

å…³é—­èµ„æº

åŸå§‹ä»£ç ä½œè€…å¾ˆå®¹æ˜“é”™è¿‡è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºä¸Šé¢çš„ä»£ç å¯ä»¥é¡ºåˆ©ç¼–è¯‘ã€‚ä½œä¸ºå®¡é˜…è€…ï¼Œä½ åº”è¯¥æ³¨æ„åœ¨æ–¹æ³•é€€å‡ºä¹‹å‰è¿æ¥ã€è¯­å¥å’Œç»“æœé›†éœ€è¦å…³é—­ã€‚åœ¨ Java 7 ä¸­ï¼Œç”±äº try-with-resources14 çš„å­˜åœ¨ï¼Œè¿™å˜å¾—å®¹æ˜“ç®¡ç†äº†è®¸å¤šã€‚ä¸‹é¢çš„æˆªå›¾æ˜¾ç¤ºäº†ä¸€ä¸ªä»£ç å®¡æŸ¥çš„ç»“æœï¼Œå…¶ä¸­ä½œè€…å·²ç»å°†ä»£ç æ›´æ”¹ä¸ºä½¿ç”¨ try-with-resourcesã€‚

14 <https://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html>

try-with-resources

# èµ„æºæ± æ˜¯å¦é…ç½®æ­£ç¡®ï¼Ÿ

ä¸€ä¸ªç¯å¢ƒçš„æœ€ä½³é…ç½®å°†å–å†³äºè®¸å¤šå› ç´ ï¼Œå› æ­¤ä½œä¸ºå®¡é˜…è€…ï¼Œä½ å¯èƒ½ä¸ä¼šç«‹å³çŸ¥é“ä¾‹å¦‚æ•°æ®åº“è¿æ¥æ± çš„å¤§å°æ˜¯å¦åˆé€‚ã€‚ä½†ä½ å¯ä»¥ä¸€çœ¼çœ‹å‡ºä¸€äº›äº‹æƒ…ï¼Œä¾‹å¦‚æ˜¯å¦å¤ªå°ï¼ˆæ¯”å¦‚è®¾ç½®ä¸º 1ï¼‰æˆ–å¤ªå¤§ï¼ˆæ•°ç™¾ä¸‡ä¸ªçº¿ç¨‹ï¼‰ã€‚è¿™äº›å€¼çš„å¾®è°ƒéœ€è¦åœ¨ä¸€ä¸ªå°½å¯èƒ½æ¥è¿‘çœŸå®ç¯å¢ƒçš„ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•ï¼Œä½†ä»£ç å®¡æŸ¥ä¸­å¯ä»¥å¾ˆå®¹æ˜“è¯†åˆ«çš„ä¸€ä¸ªå…±åŒé—®é¢˜æ˜¯å½“èµ„æºæ± ï¼ˆä¾‹å¦‚çº¿ç¨‹æ± æˆ–è¿æ¥æ± ï¼‰çœŸæ­£å¤ªå¤§æ—¶ã€‚é€»è¾‘è¡¨æ˜è¶Šå¤§è¶Šå¥½ï¼Œä½†å½“ç„¶æ¯ä¸ªè¿™æ ·çš„å¯¹è±¡éƒ½å ç”¨èµ„æºï¼Œç®¡ç†æ•°åƒä¸ªå®ƒä»¬çš„å¼€é”€é€šå¸¸æ¯”ä¿æŒå®ƒä»¬å¯ç”¨å¸¦æ¥çš„å¥½å¤„é«˜å¾—å¤šã€‚å¦‚æœæœ‰ç–‘é—®ï¼Œé»˜è®¤è®¾ç½®é€šå¸¸æ˜¯å¥½çš„èµ·ç‚¹ã€‚åç¦»é»˜è®¤è®¾ç½®çš„ä»£ç åº”è¯¥é€šè¿‡æŸç§æµ‹è¯•æˆ–è®¡ç®—æ¥è¯æ˜å…¶ä»·å€¼ã€‚

å®¡é˜…è€…å¯ä»¥è½»æ¾è¯†åˆ«çš„è­¦å‘Šä¿¡å·

ä¸€äº›ç±»å‹çš„ä»£ç ç«‹å³è¡¨æ˜å¯èƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚è¿™å°†å–å†³äºä½¿ç”¨çš„è¯­è¨€å’Œåº“ï¼ˆè¯·åœ¨è¯„è®ºä¸­å‘Šè¯‰æˆ‘ä»¬æ‚¨ç¯å¢ƒä¸­â€œä»£ç å¼‚å‘³â€çš„æƒ…å†µï¼‰ã€‚

## åå°„

åœ¨ Java ä¸­ï¼Œä½¿ç”¨åå°„æ¯”ä¸ä½¿ç”¨åå°„è¦æ…¢ 15ã€‚å¦‚æœä½ æ­£åœ¨å®¡æŸ¥åŒ…å«åå°„çš„ä»£ç ï¼Œè¯¢é—®æ˜¯å¦ç»å¯¹éœ€è¦è¿™æ ·ã€‚

15 <http://docs.oracle.com/javase/tutorial/reflect/index.html>

åå°„

ä¸Šé¢çš„æˆªå›¾æ˜¾ç¤ºäº†ä¸€ä¸ªå®¡é˜…è€…åœ¨ Upsource ä¸­ç‚¹å‡»ä¸€ä¸ªæ–¹æ³•æ¥æ£€æŸ¥å®ƒçš„æ¥æºï¼Œä½ å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•æ˜¯è¿”å›äº† java.lang.reflect åŒ…ä¸­çš„æŸä¸ªä¸œè¥¿ï¼Œè¿™åº”è¯¥æ˜¯ä¸€ä¸ªè­¦å‘Šä¿¡å·ã€‚

## è¶…æ—¶

å½“ä½ å®¡æŸ¥ä»£ç æ—¶ï¼Œä½ å¯èƒ½ä¸çŸ¥é“æ“ä½œçš„æ­£ç¡®è¶…æ—¶æ—¶é—´æ˜¯ä»€ä¹ˆï¼Œä½†ä½ åº”è¯¥æ€è€ƒâ€œå½“è¿™ä¸ªè¶…æ—¶æ­£åœ¨è®¡æ—¶ä¸‹é™æ—¶ï¼Œå¯¹æ•´ä¸ªç³»ç»Ÿçš„å½±å“æ˜¯ä»€ä¹ˆï¼Ÿâ€ã€‚ä½œä¸ºå®¡é˜…è€…ï¼Œä½ åº”è¯¥è€ƒè™‘æœ€åçš„æƒ…å†µâ€”â€”åœ¨ 5 åˆ†é’Ÿçš„è¶…æ—¶è®¡æ—¶è¿‡ç¨‹ä¸­åº”ç”¨ç¨‹åºæ˜¯å¦è¢«é˜»å¡ï¼Ÿå¦‚æœå°†è¿™ä¸ªè®¾ç½®ä¸º 1 ç§’é’Ÿï¼Œæœ€åä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿå¦‚æœä»£ç çš„ä½œè€…ä¸èƒ½è¯æ˜è¶…æ—¶é•¿åº¦çš„åˆç†æ€§ï¼Œè€Œä½ ï¼Œä½œä¸ºå®¡æŸ¥è€…ï¼Œä¸çŸ¥é“é€‰å®šå€¼çš„åˆ©å¼Šï¼Œé‚£ä¹ˆè¿™æ˜¯ä¸€ä¸ªé‚€è¯·äº†è§£è¿™äº›å½±å“çš„æŸäººå‚ä¸çš„å¥½æ—¶æœºã€‚ä¸è¦ç­‰åˆ°ä½ çš„ç”¨æˆ·å‘Šè¯‰ä½ æ€§èƒ½é—®é¢˜æ—¶æ‰è¡ŒåŠ¨ã€‚

## å¹¶è¡Œ

ä»£ç æ˜¯å¦ä½¿ç”¨å¤šä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä¸€ä¸ªç®€å•çš„æ“ä½œï¼Ÿè¿™ä¼šå¢åŠ æ›´å¤šæ—¶é—´å’Œå¤æ‚æ€§è€Œä¸æ˜¯æé«˜æ€§èƒ½å—ï¼Ÿåœ¨ Java 8 ä¸­ï¼Œè¿™å¯èƒ½æ¯”æ˜¾å¼åˆ›å»ºæ–°çº¿ç¨‹æ›´å¾®å¦™ï¼šä»£ç æ˜¯å¦ä½¿ç”¨äº† Java 8 çš„æ–°é¢–å¹¶è¡Œæµä½†æ²¡æœ‰ä»å¹¶è¡Œæ€§ä¸­è·å¾—å¥½å¤„ï¼Ÿä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªå°æ•°ç›®çš„å…ƒç´ ä¸Šæˆ–åœ¨å¯¹ä¸€ä¸ªæ‰§è¡Œéå¸¸ç®€å•æ“ä½œçš„æµä¸Šä½¿ç”¨å¹¶è¡Œæµå¯èƒ½æ¯”åœ¨ä¸€ä¸ªé¡ºåºæµä¸Šæ‰§è¡Œæ“ä½œè¦æ…¢ã€‚

å¹¶è¡Œ

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæ·»åŠ å¹¶è¡Œçš„ä½¿ç”¨ä¸å¤ªå¯èƒ½ç»™æˆ‘ä»¬å¸¦æ¥ä»»ä½•å¥½å¤„â€”â€”è¿™ä¸ªæµæ­£åœ¨ä½œç”¨äºæ¨æ–‡ï¼Œå› æ­¤æ˜¯ 140 ä¸ªå­—ç¬¦çš„å­—ç¬¦ä¸²ã€‚å¯¹ä¸€ä¸ªå°†è¦å¤„ç†è¿™ä¹ˆå°‘å•è¯çš„æ“ä½œè¿›è¡Œå¹¶è¡ŒåŒ–ï¼Œå¯èƒ½ä¸ä¼šæé«˜æ€§èƒ½ï¼Œå¹¶ä¸”å°†æ“ä½œåˆ†æ•£åˆ°å¤šä¸ªå¹¶è¡Œçº¿ç¨‹çš„æˆæœ¬å‡ ä¹è‚¯å®šé«˜äºä»»ä½•æ”¶ç›Šã€‚

## æ­£ç¡®æ€§

è¿™äº›äº‹æƒ…å¹¶ä¸ä¸€å®šä¼šå½±å“æ‚¨ç³»ç»Ÿçš„æ€§èƒ½ï¼Œä½†å®ƒä»¬åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šä¸åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­è¿è¡Œæœ‰å…³ï¼Œå› æ­¤ä¸ä¸»é¢˜ç›¸å…³ã€‚

## ä»£ç æ˜¯å¦ä½¿ç”¨é€‚ç”¨äºå¤šçº¿ç¨‹ç¯å¢ƒçš„æ•°æ®ç»“æ„ï¼Ÿ

## çº¿ç¨‹å®‰å…¨

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œä½œè€…åœ¨ç¬¬ 12 è¡Œä½¿ç”¨ ArrayList å­˜å‚¨æ‰€æœ‰ä¼šè¯ã€‚ç„¶è€Œï¼Œè¿™ä¸ªä»£ç ï¼Œç‰¹åˆ«æ˜¯ onOpen æ–¹æ³•ï¼Œæ˜¯ç”±å¤šä¸ªçº¿ç¨‹è°ƒç”¨çš„ï¼Œæ‰€ä»¥ sessions å­—æ®µéœ€è¦æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„é›†åˆç»“æ„ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬æœ‰å‡ ç§é€‰é¡¹ï¼šæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Vector16ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Collections.synchronizedList()17 æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ Listï¼Œä½†æœ€åˆé€‚çš„é€‰é¡¹å¯èƒ½æ˜¯ä½¿ç”¨ CopyOnWriteArrayList18ï¼Œå› ä¸ºåˆ—è¡¨å˜åŒ–çš„é¢‘ç‡è¿œä½äºå®ƒè¢«è¯»å–çš„é¢‘ç‡ã€‚

çº¿ç¨‹å®‰å…¨

17<http://docs.oracle.com/javase/8/docs/api/java/util/Collections.html#synchronizedList-java.util.List->

18<http://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CopyOnWriteArrayList.html>

## ä»£ç æ˜¯å¦å®¹æ˜“å—åˆ°ç«äº‰æ¡ä»¶çš„å½±å“ï¼Ÿ

ç¼–å†™åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ä½¿ç”¨æ—¶å¯èƒ½å¼•èµ·å¾®å¦™ç«äº‰æ¡ä»¶çš„ä»£ç æ˜¯ç›¸å½“ç®€å•çš„ã€‚ä¾‹å¦‚ï¼š

## ç«äº‰æ¡ä»¶

å°½ç®¡å¢é‡ä»£ç åªåœ¨ä¸€è¡Œï¼ˆç¬¬ 16 è¡Œï¼‰ï¼Œä½†åœ¨å¦ä¸€ä¸ªçº¿ç¨‹åœ¨è¿™æ®µä»£ç è·å–å®ƒå’Œè®¾ç½®æ–°å€¼ä¹‹é—´ï¼Œä»ç„¶æœ‰å¯èƒ½å¢åŠ  ordersã€‚ä½œä¸ºå®¡é˜…è€…ï¼Œç•™æ„é‚£äº›éåŸå­çš„ get å’Œ set ç»„åˆ 19ã€‚

## ä»£ç æ˜¯å¦æ­£ç¡®ä½¿ç”¨é”ï¼Ÿ

ä¸ç«äº‰æ¡ä»¶ç›¸å…³ï¼Œä½œä¸ºå®¡é˜…è€…ä½ åº”è¯¥æ£€æŸ¥è¢«å®¡æŸ¥çš„ä»£ç æ²¡æœ‰å…è®¸å¤šä¸ªçº¿ç¨‹ä»¥å¯èƒ½å†²çªçš„æ–¹å¼ä¿®æ”¹å€¼ã€‚ä»£ç å¯èƒ½éœ€è¦åŒæ­¥ 20ã€é” 21 æˆ–åŸå­å˜é‡ 22 æ¥æ§åˆ¶ä»£ç å—çš„æ›´æ”¹ã€‚

## æ€§èƒ½æµ‹è¯•å¯¹äºä»£ç æ˜¯å¦æœ‰ä»·å€¼ï¼Ÿ

å¾ˆå®¹æ˜“å†™å‡ºå·®çš„å¾®åŸºå‡†æµ‹è¯• 23ï¼Œä¾‹å¦‚ã€‚æˆ–è€…å¦‚æœæµ‹è¯•ä½¿ç”¨ä¸ç”Ÿäº§æ•°æ®å®Œå…¨ä¸ç±»ä¼¼çš„æ•°æ®ï¼Œå®ƒå¯èƒ½ä¼šç»™å‡ºè¯¯å¯¼æ€§çš„ç»“æœã€‚

## ç¼“å­˜

è™½ç„¶ç¼“å­˜å¯èƒ½æ˜¯é˜²æ­¢è¿‡å¤šå¤–éƒ¨è¯·æ±‚çš„ä¸€ç§æ–¹å¼ï¼Œä½†å®ƒä¹Ÿå¸¦æ¥äº†è‡ªå·±çš„æŒ‘æˆ˜ã€‚å¦‚æœè¢«å®¡æŸ¥çš„ä»£ç ä½¿ç”¨äº†ç¼“å­˜ï¼Œä½ åº”è¯¥å¯»æ‰¾ä¸€äº›å¸¸è§çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼Œä¸æ­£ç¡®åœ°å¤±æ•ˆç¼“å­˜é¡¹ã€‚

## ä»£ç çº§åˆ«çš„ä¼˜åŒ–

å¦‚æœä½ æ­£åœ¨å®¡æŸ¥ä»£ç ï¼Œè€Œä½ æ˜¯ä¸€åå¼€å‘äººå‘˜ï¼Œä¸‹é¢çš„éƒ¨åˆ†å¯èƒ½æœ‰ä¼˜åŒ–å»ºè®®æ˜¯ä½ å¸Œæœ›æå‡ºçš„ã€‚ä½œä¸ºä¸€ä¸ªå›¢é˜Ÿï¼Œä½ éœ€è¦æå‰äº†è§£æ€§èƒ½å¯¹ä½ ä»¬æœ‰å¤šé‡è¦ï¼Œä»¥åŠè¿™äº›ç±»å‹çš„ä¼˜åŒ–æ˜¯å¦å¯¹ä½ çš„ä»£ç æœ‰å¥½å¤„ã€‚

å¯¹äºå¤§å¤šæ•°ä¸æ˜¯æ„å»ºä½å»¶è¿Ÿåº”ç”¨çš„æœºæ„æ¥è¯´ï¼Œè¿™äº›ä¼˜åŒ–å¯èƒ½å±äºè¿‡æ—©ä¼˜åŒ–çš„ 24 èŒƒç•´ã€‚

- ä»£ç æ˜¯å¦ä¸éœ€è¦åŒæ­¥/é”æ—¶ä¹Ÿä½¿ç”¨äº†ï¼Ÿå¦‚æœä»£ç æ€»æ˜¯è¿è¡Œåœ¨å•ä¸ªçº¿ç¨‹ä¸Šï¼Œé”æ˜¯ä¸å¿…è¦çš„å¼€é”€ã€‚
- ä»£ç æ˜¯å¦åœ¨æ²¡æœ‰å¿…è¦æ—¶ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„é›†åˆç»“æ„ï¼Ÿä¾‹å¦‚ï¼ŒVector å¯ä»¥è¢« ArrayList æ›¿æ¢å—ï¼Ÿ
- ä»£ç æ˜¯å¦ä½¿ç”¨æ€§èƒ½è¾ƒå·®çš„æ•°æ®ç»“æ„æ¥æ‰§è¡ŒåŠ¨ä½œï¼Ÿä¾‹å¦‚ï¼Œä½¿ç”¨é“¾è¡¨ä½†éœ€è¦å®šæœŸåœ¨å…¶ä¸­æœç´¢å•é¡¹ã€‚
- ä»£ç æ˜¯å¦ä½¿ç”¨é”æˆ–åŒæ­¥æ—¶å¯ä»¥ä½¿ç”¨åŸå­å˜é‡ä»£æ›¿ï¼Ÿ
- ä»£ç èƒ½å¦ä»å»¶è¿ŸåŠ è½½ä¸­å—ç›Šï¼Ÿ
- if è¯­å¥æˆ–å…¶ä»–é€»è¾‘èƒ½å¦é€šè¿‡å°†æœ€å¿«çš„è¯„ä¼°æ”¾åœ¨é¦–ä½æ¥çŸ­è·¯ï¼Ÿ
- ä»£ç ä¸­æ˜¯å¦æœ‰å¤§é‡å­—ç¬¦ä¸²æ ¼å¼åŒ–ï¼Ÿè¿™èƒ½å¦æ›´é«˜æ•ˆï¼Ÿ
- æ—¥å¿—è¯­å¥æ˜¯å¦ä½¿ç”¨äº†å­—ç¬¦ä¸²æ ¼å¼åŒ–ï¼Ÿå®ƒä»¬æ˜¯å¦è¢«ä¸€ä¸ªæ£€æŸ¥æ—¥å¿—çº§åˆ«çš„ if ä¿æŠ¤ï¼Œæˆ–è€…ä½¿ç”¨ä¸€ä¸ªæ±‚å€¼æ‡’æƒ°çš„ä¾›åº”å•†ï¼Ÿ

## æ—¥å¿—

ä¸Šé¢çš„ä»£ç åªæœ‰åœ¨è®°å½•å™¨è®¾ç½®ä¸º FINEST æ—¶æ‰ä¼šè®°å½•æ¶ˆæ¯ã€‚ç„¶è€Œï¼Œæ˜‚è´µçš„å­—ç¬¦ä¸²æ ¼å¼ä¼šæ¯æ¬¡éƒ½å‘ç”Ÿï¼Œä¸ç®¡æ¶ˆæ¯å®é™…ä¸Šæ˜¯å¦è¢«è®°å½•ã€‚

### æ—¥å¿—

é€šè¿‡ç¡®ä¿åªåœ¨è¿™ä¸ªä»£ç åœ¨æ—¥å¿—çº§åˆ«è®¾ç½®åˆ°ä¼šå°†æ¶ˆæ¯å†™å…¥æ—¥å¿—çš„ä»·å€¼ä¸Šè¿è¡Œæ¥æé«˜æ€§èƒ½ï¼Œå¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºã€‚

Logging

24 <http://www.oracle.com/technetwork/articles/java/architect-evans-pt1-2266278.html>

åœ¨ Java 8 ä¸­ï¼Œè¿™äº›æ€§èƒ½æ”¶ç›Šå¯ä»¥é€šè¿‡ä½¿ç”¨ lambda è¡¨è¾¾å¼æ¥å®ç°ï¼Œè€Œæ— éœ€æ ·æ¿ä»£ç ã€‚ç”±äº lambda çš„ä½¿ç”¨æ–¹å¼ï¼Œåªæœ‰åœ¨æ¶ˆæ¯å®é™…ä¸Šè¢«è®°å½•æ—¶æ‰ä¼šè¿›è¡Œå­—ç¬¦ä¸²æ ¼å¼åŒ–ã€‚è¿™åº”è¯¥æ˜¯ Java 8 ä¸­é¦–é€‰çš„æ–¹æ³•ã€‚

## æ€»ç»“

æ­£å¦‚æˆ‘åœ¨åŸå§‹åˆ—è¡¨ä¸­æ‰€åˆ—å‡ºçš„å®¡æŸ¥æ—¶è¦å¯»æ‰¾çš„äº‹é¡¹ä¸€æ ·ï¼Œæœ¬ç« çªå‡ºäº†ä½ çš„å›¢é˜Ÿåœ¨å®¡æŸ¥æœŸé—´å¯èƒ½å¸Œæœ›ä¸€è´¯æ£€æŸ¥çš„ä¸€äº›åŒºåŸŸã€‚è¿™å°†å–å†³äºä½ é¡¹ç›®çš„æ€§èƒ½è¦æ±‚ã€‚

å°½ç®¡è¿™ä¸ªç« èŠ‚é’ˆå¯¹æ‰€æœ‰å¼€å‘äººå‘˜ï¼Œä½†è®¸å¤šä¾‹å­éƒ½æ˜¯ Java / JVM ç‰¹å®šçš„ã€‚æˆ‘æƒ³ä»¥ä¸€äº›ç®€å•çš„å»ºè®®ç»“æŸï¼Œä¾› Java ä»£ç çš„å®¡é˜…è€…æŸ¥æ‰¾ï¼Œè¿™å°†ä¸º JVM ä¼˜åŒ–ä½ çš„ä»£ç æä¾›è‰¯å¥½çš„æœºä¼šï¼Œè¿™æ ·ä½ å°±ä¸ç”¨ï¼š

- ç¼–å†™å°çš„æ–¹æ³•å’Œç±»
- ä¿æŒé€»è¾‘ç®€å•â€”â€”æ²¡æœ‰æ·±å±‚åµŒå¥—çš„ if æˆ–å¾ªç¯

å¯¹äººç±»æ¥è¯´è¶Šå®¹æ˜“ç†è§£çš„ä»£ç ï¼ŒJIT ç¼–è¯‘å™¨ 25 å°±è¶Šæœ‰å¯èƒ½ç†è§£ä½ çš„ä»£ç åˆ°è¶³ä»¥ä¼˜åŒ–çš„ç¨‹åº¦ã€‚è¿™åº”è¯¥åœ¨ä»£ç å®¡æŸ¥æœŸé—´å¾ˆå®¹æ˜“çœ‹å‡ºâ€”â€”å¦‚æœä»£ç çœ‹èµ·æ¥å¯ç†è§£å’Œå¹²å‡€ï¼Œå®ƒä¹Ÿæœ‰å¾ˆå¥½çš„æœºä¼šè¡¨ç°è‰¯å¥½ã€‚

å½“è°ˆåˆ°æ€§èƒ½æ—¶ï¼Œè¦äº†è§£æœ‰äº›é¢†åŸŸä½ å¯èƒ½èƒ½å¤Ÿåœ¨ä»£ç å®¡æŸ¥æœŸé—´å¾—åˆ°å¿«é€Ÿèƒœåˆ©ï¼ˆä¾‹å¦‚ï¼Œä¸å¿…è¦çš„æ•°æ®åº“è°ƒç”¨ï¼‰ that can be identified during code review, and some areas that will be tempting to comment on (like the code-level optimisations) that might not gain enough value for the needs of your system.

25 <http://www.oracle.com/technetwork/articles/java/architect-evans-pt1-2266278.html>

## [æ‰“é€ ä¸ªæ€§åŒ– GitHub ä¸»é¡µï¼šå®ç”¨æ¨¡æ¿ä¸æ’ä»¶æ¨è](https://blog.dong4j.site/posts/d8463a4b.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ç®€ä»‹

èŠ±äº†ç‚¹æ—¶é—´è£…é¥°äº†ä¸€ä¸‹ GitHub ä¸»é¡µ, æ„Ÿè§‰å¥½è¿‡å¾—å» ğŸ™‰.

GItHub ä¸ªäººä¸»é¡µç›¸å…³çš„é¡¹ç›®éå¸¸å¤š, ä¹Ÿæ²¡æœ‰ä¸€ä¸ªä¸ªå»å°è¯•, æ‰€ä»¥è¿™é‡Œå…ˆåšä¸€ä¸ªè®°å½•, å…ˆåšä¸€ä¸ªèµ„æºæ”¶é›†, ç­‰æœ‰æ—¶é—´å†å»æŠ˜è…¾.

ç›®å‰çš„æ•ˆæœå¦‚ä¸‹:

[dong4j çš„ GitHub ä¸»é¡µ](https://github.com/dong4j)

![20250211142640_FMSbhYAb.webp](https://cdn.dong4j.site/source/image/20250211142640_FMSbhYAb.webp)

## ç»Ÿè®¡ç±»

### Metrics

![20250211145345_IvIe11kA.webp](https://cdn.dong4j.site/source/image/20250211145345_IvIe11kA.webp)

è·å¾—ç±»ä¼¼ä¸Šå›¾çš„ GitHub æ•°æ®ç»Ÿè®¡ï¼Œéœ€è¦ç”¨åˆ°ä¸€ä¸ªåœ¨çº¿å·¥å…·[ã€ŒMetricsã€](https://metrics.lecoq.io/embed?user=)ï¼Œæ‰“å¼€ç½‘ç«™ä¹‹åï¼Œåœ¨å·¦ä¾§è¾“å…¥ä½ çš„ GitHub IDï¼Œç¨ç­‰ä¸€ä¼šï¼Œå°±ä¼šè¿”å›å³ä¾§æ‰€æœ‰å’Œä½ ç›¸å…³çš„æ•°æ®ã€‚

### GitHub Stats Card

è‡ªè¿°æ–‡ä»¶ä¸­è·å–åŠ¨æ€ç”Ÿæˆçš„ GitHub ç»Ÿè®¡ä¿¡æ¯ --> [github-readme-stats](https://github.com/anuraghazra/github-readme-stats)

![20250211145629_Yr4AUODL.webp](https://cdn.dong4j.site/source/image/20250211145629_Yr4AUODL.webp)

### Most used languages

è‡ªè¿°æ–‡ä»¶ä¸­æ·»åŠ ä½¿ç”¨ç¼–ç¨‹è¯­è¨€å¯¹æ¯”ç»Ÿè®¡å›¾ --> [github-readme-stats](https://github.com/anuraghazra/github-readme-stats)

![20250211150016_PRbKlFSs.webp](https://cdn.dong4j.site/source/image/20250211150016_PRbKlFSs.webp)

### Github Profile Trophy

æ·»åŠ å¥–æ¯ä¿¡æ¯--> [github-profile-trophy](https://github.com/ryo-ma/github-profile-trophy)

![20250211150119_lR1xPDHT.webp](https://cdn.dong4j.site/source/image/20250211150119_lR1xPDHT.webp)

### GitHub Readme Activity Graph

åŠ¨æ€ç”Ÿæˆçš„æ´»åŠ¨å›¾ï¼Œç”¨äºæ˜¾ç¤ºè¿‡å» 31 å¤©çš„ GitHub æ´»åŠ¨ã€‚ --> [github-readme-activity-graph](https://github.com/Ashutosh00710/github-readme-activity-graph)

![20250211151121_AY6a7pzd.webp](https://cdn.dong4j.site/source/image/20250211151121_AY6a7pzd.webp)

### GitHub streak

åœ¨ README ä¸­å±•ç¤ºè¿ç»­æäº¤ä»£ç çš„æ¬¡æ•°ã€‚ --> [github-readme-streak-stats](https://github.com/DenverCoder1/github-readme-streak-stats)

![20250211151401_ufzhtpxc.webp](https://cdn.dong4j.site/source/image/20250211151401_ufzhtpxc.webp)

### GitHub Profile Views Counter

[github-profile-views-counter](https://github.com/antonkomarev/github-profile-views-counter)

![20250211155918_8yGEdjik.webp](https://cdn.dong4j.site/source/image/20250211155918_8yGEdjik.webp)

```
![Profile views](https://komarev.com/ghpvc/?username=dong4j&color=0366d6)
```

### Visitor Badge

https://visitor-badge.laobi.icu/

![20250211160100_U8ImH8vl.webp](https://cdn.dong4j.site/source/image/20250211160100_U8ImH8vl.webp)

```
![Visitors](https://visitor-badge.laobi.icu/badge?page_id=dong4j)
```

### Stats Cards

åœ¨ README ä¸­å±•ç¤ºä½ åœ¨ä¸€äº›æµè¡Œçš„ç½‘ç«™çš„æ•°æ®ã€‚ --> **[stats-cards](https://github.com/songquanpeng/stats-cards)**

![20250211151602_ATOCbJe3.webp](https://cdn.dong4j.site/source/image/20250211151602_ATOCbJe3.webp)

### Github OG Image

[github-og-image](https://github.com/ccbikai/github-og-image)

æå– Github OpenGraph å›¾ç‰‡ç”¨äºå¡ç‰‡é¢„è§ˆ:

![20250211160837_xq6T4gRh.webp](https://cdn.dong4j.site/source/image/20250211160837_xq6T4gRh.webp)

å¦ä¸€ä¸ªä¸ä¾èµ– Cloudflare ç‰ˆæœ¬: https://github.com/dong4j/github-og-image-node

ä»€ä¹ˆæ˜¯: [Open Graph åè®®](https://ogp.me/)

## æ¨¡ç‰ˆä»“åº“

### awesome-github-profiles

**[awesome-github-profiles](https://github.com/EddieHubCommunity/awesome-github-profiles)**

![20250211152511_sRcGUCZq.webp](https://cdn.dong4j.site/source/image/20250211152511_sRcGUCZq.webp)

### awesome-github-profile-readme

[awesome-github-profile-readme](https://github.com/abhisheknaiidu/awesome-github-profile-readme)

![20250211152412_yY3aozcb.webp](https://cdn.dong4j.site/source/image/20250211152412_yY3aozcb.webp)

### Awesome-Profile-README-templates

[Awesome-Profile-README-templates](https://github.com/kautukkundan/Awesome-Profile-README-templates)

![20250211152719_Y3Rcdv84.webp](https://cdn.dong4j.site/source/image/20250211152719_Y3Rcdv84.webp)

### github-profile-readme-generator

[github-profile-readme-generator](https://github.com/rahuldkjain/github-profile-readme-generator)

![20250211152919_2TCPdLJe.webp](https://cdn.dong4j.site/source/image/20250211152919_2TCPdLJe.webp)

### beautify-github-profile

**[beautify-github-profile](https://github.com/rzashakeri/beautify-github-profile)**

![20250211154240_CobMgG77.webp](https://cdn.dong4j.site/source/image/20250211154240_CobMgG77.webp)

## GitHub Actions

### waka-readme-stats

[waka-readme-stats](https://github.com/anmol098/waka-readme-stats)

![20250211154711_JxOuQ4K4.webp](https://cdn.dong4j.site/source/image/20250211154711_JxOuQ4K4.webp)

### blog-post-workflow

[blog-post-workflow](https://github.com/gautamkrishnar/blog-post-workflow)

![20250211155132_AFCLjUHL.webp](https://cdn.dong4j.site/source/image/20250211155132_AFCLjUHL.webp)

### snk

[snk](https://github.com/Platane/snk)

![20250211155403_2HTpjSAZ.webp](https://cdn.dong4j.site/source/image/20250211155403_2HTpjSAZ.webp)

## å…¶ä»–

### Shieldsï¼ˆGitHub å¾½ç« ï¼‰

ä¸ºä½ çš„å¼€æºé¡¹ç›®ç”Ÿæˆé«˜è´¨é‡å°å¾½ç« å›¾æ ‡ï¼Œç›´æ¥å¤åˆ¶é“¾æ¥ä½¿ç”¨ã€‚ --> [Shields.io](https://shields.io/)

![20250211150413_uYyk2TlC.webp](https://cdn.dong4j.site/source/image/20250211150413_uYyk2TlC.webp)

**åŒç±»å‹æ¨è:**

https://badgen.net/

![20250211153716_0vSXxMPP.webp](https://cdn.dong4j.site/source/image/20250211153716_0vSXxMPP.webp)

https://badgie.me
https://github.com/pavi2410/PlayBadges
https://nodei.co

### 3D æ•ˆæœ

[github-profile-3d-contrib](https://github.com/yoshi389111/github-profile-3d-contrib)

![20250211153931_bEFEnkOW.webp](https://cdn.dong4j.site/source/image/20250211153931_bEFEnkOW.webp)

### æ‰“å­—ç‰¹æ•ˆ

å¾ªç¯æ‰“å­—çš„æ•ˆæœï¼Œå¾ˆç‚«é…·ï¼Œ--> https://github.com/DenverCoder1/readme-typing-svg

![20250211151704_HXOUtfSR.webp](https://cdn.dong4j.site/source/image/20250211151704_HXOUtfSR.webp)

### emoji ç¬¦å·åŠæŠ€èƒ½å›¾æ ‡

https://www.webfx.com/tools/emoji-cheat-sheet
https://simpleicons.org
https://github.com/tandpfun/skill-icons
https://github.com/alexandresanlim/Badges4-README.md-Profile

## ç›¸å…³èµ„æºä¸æ•™ç¨‹

- [https://www.yuque.com/janeyork/blog/sw2sqlfgg47u1g2s?singleDoc#](https://www.yuque.com/janeyork/blog/sw2sqlfgg47u1g2s?singleDoc#)
- https://zhuanlan.zhihu.com/p/454597068

- GitHub Token ç”Ÿæˆåœ°å€: https://github.com/settings/tokens
- æ·»åŠ  action çš„å˜é‡: https://github.com/{username}/{username}/settings/secrets/actions
- è®¾ç½®ä»“åº“ Action æƒé™

![20250109143952_tqgikaid.webp](https://cdn.dong4j.site/source/image/20250109143952_tqgikaid.webp)

## [ã€ŒHexoã€anzhiyu ä¸»é¢˜ï¼šæœ‹å‹åœˆéƒ¨ç½²æ•™ç¨‹](https://blog.dong4j.site/posts/f7489f5a.md)

![/images/cover/20250103184959_Qh3w85TN.webp](https://cdn.dong4j.site/source/image/20250103184959_Qh3w85TN.webp)

å®‰çŸ¥é±¼ä¸»é¢˜è‡ªå¸¦æœ‹å‹åœˆåŠŸèƒ½, ä¸è¿‡éœ€è¦è‡ªè¡Œéƒ¨ç½²åç«¯, ä¸‹é¢è¯´è¯´æˆ‘çš„éƒ¨ç½²è¿‡ç¨‹.

## åˆ›å»ºæœ‹å‹åœˆé¡µé¢

åœ¨ Hexo åšå®¢æ ¹ç›®å½•ä¸‹æ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥

```bash
hexo new page fcircle
```

æ‰“å¼€ `source/fcircle/index.md`,æ·»åŠ ä¸€è¡Œ `type: 'fcircle'`:

```yaml
---
title: æœ‹å‹åœˆ
date: 2022-11-21 17:06:17
comments: false
aside: false
top_img: false
type: "fcircle"
---
```

## ä¸»é¢˜é…ç½®

é…ç½®èœå•:

```yaml
menu:
  å‹é“¾:
    æœ‹å‹åœˆ: /fcircle/ || anzhiyu-icon-artstation
```

å¼€å¯æœ‹å‹åœˆ:

```yaml
# æœ‹å‹åœˆé…ç½®
friends_vue:
  enable: true
  vue_js: xxx
  apiurl: xxx
  top_background: xxx
```

| å‚æ•°           | å¤‡é€‰å€¼/ç±»å‹ | è§£é‡Š                           |
| :------------- | :---------- | :----------------------------- |
| enable         | boolean     | ã€å¿…é¡»ã€‘æ˜¯å¦å¯ç”¨               |
| vue_js         | url         | ã€å¿…é¡»ã€‘æœ‹å‹åœˆå‰ç«¯æ„å»ºåçš„ url |
| apiurl         | string      | ã€å¿…é¡»ã€‘æœ‹å‹åœˆåç«¯ url         |
| top_background | url         | ã€å¯é€‰ã€‘æœ‹å‹åœˆé¡¶éƒ¨èƒŒæ™¯å›¾       |

å‰ç«¯åŸé¡¹ç›®åœ°å€ï¼š[hexo-circle-of-friends-front](https://github.com/anzhiyu-c/hexo-circle-of-friends-front), éœ€è¦è‡ªè¡Œç¼–è¯‘æ­¤é¡¹ç›®.

## æœ‹å‹åœˆå‰ç«¯

<!-- MBP  /Users/dong4j/Developer/3.Knowledge/site/hexo-circle-of-friends-front/ -->

```bash
git clone git@github.com:anzhiyu-c/hexo-circle-of-friends-front.git

cd hexo-circle-of-friends-front
npm install
```

ä¿®æ”¹é…ç½®æ–‡ä»¶(`src/utils/config.ts`):

```javascript
const DefaultConfig: any = {
  private_api_url: "https://yourdomain/",
  public_api_url: "https://yourdomain/",
  page_default_number: 20,
  page_turning_number: 20,
  error_img: "https://sdn.geekzu.org/avatar/57d8260dfb55501c37dde588e7c3852c",
  sort_rule: "created",
  defaultFish: 100,
  hungryFish: 100,
};
export default DefaultConfig;
```

æœ€åç¼–è¯‘:

```bash
npm run build
```

æ‰§è¡ŒæˆåŠŸåä¼šåœ¨ `dist/assets/` ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª JS æ–‡ä»¶, æˆ‘å°†å®ƒæ”¹åä¸º `friends.js`, æˆ‘å°†å®ƒä¸Šä¼ åˆ°äº†å›¾åºŠ, ç„¶ååœ¨é…ç½®ä¸­ä½¿ç”¨ url è·å–æ­¤æ–‡ä»¶.

```yaml
# æœ‹å‹åœˆé…ç½®
friends_vue:
  enable: true
  vue_js: https://{friends.js}çš„å›¾åºŠåœ°å€
  apiurl: xxx
  top_background: xxx
```

## æœ‹å‹åœˆåç«¯

åç«¯æœåŠ¡æˆ‘ä½¿ç”¨ Docker éƒ¨ç½²åˆ°æœ¬åœ°çš„æœåŠ¡å™¨, ç„¶åä½¿ç”¨ Nginx å‘å¤–æš´éœ²æœåŠ¡

```bash
git clone git@github.com:Rock-Candy-Tea/hexo-circle-of-friends.git

cd hexo-circle-of-friends
python3 deploy.py
```

> å»ºè®®æå‰ä¸‹è½½é•œåƒï¼š
>
> ```bash
> docker pull yyyzyyyz/fcircle:latest
> ```

æˆåŠŸè¿è¡Œåä¼šè¿›å…¥äº¤äº’ç•Œé¢, æ ¹æ®æ‰§è¡Œçš„æƒ…å†µé€‰æ‹©å³å¯:

```
$ python3 deploy.py
æ¬¢è¿ä½¿ç”¨éƒ¨ç½²å·¥å…·ï¼Œé€‰æ‹©éƒ¨ç½²æ–¹å¼ï¼š
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
| 1ã€server | 2ã€docker | qã€é€€å‡º |
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
2
è¯·é€‰æ‹©ï¼š
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
| 1ã€éƒ¨ç½² | 2ã€å–æ¶ˆéƒ¨ç½² | qã€é€€å‡º |
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
1
æŒ‡å®šapiæœåŠ¡ç«¯å£ï¼ŒæŒ‰å›è½¦ä¸è¾“å…¥åˆ™é»˜è®¤ä¸º8000
7773
989b605b330db943cf172dc893bf4dd3706f0460e18fc5bbaa48e7129a1d2f56
å·²éƒ¨ç½²ï¼
æ¬¢è¿ä½¿ç”¨éƒ¨ç½²å·¥å…·ï¼Œé€‰æ‹©éƒ¨ç½²æ–¹å¼ï¼š
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
| 1ã€server | 2ã€docker | qã€é€€å‡º |
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
q
å†è§ï¼
```

å°è¯•è®¿é—® API éªŒè¯éƒ¨ç½²æ˜¯å¦æˆåŠŸï¼š

```bash
curl http://192.168.31.7:7773/all
```

å‡ºç°æ•°æ®å³ä¸ºéƒ¨ç½²æˆåŠŸã€‚

æ¥ä¸‹æ¥é€šè¿‡ Nginx é…ç½®åå‘ä»£ç†å’Œ HTTPS è¯ä¹¦, æ¯”å¦‚æœ€ç»ˆæ˜¯ `https://friends.dong4j.tele/`, æœ‹å‹åœˆå®Œæˆé…ç½®:

```yaml
# æœ‹å‹åœˆé…ç½®
friends_vue:
  enable: true
  vue_js: https://{friends.js}çš„å›¾åºŠåœ°å€
  apiurl: https://friends.dong4j.tele/
  top_background: { æœ‹å‹åœˆé¡µé¢å¤´å›¾åœ°å€ }
```

## æ•ˆæœ

![20250103180000_Iq6UCEvX.webp](https://cdn.dong4j.site/source/image/20250103180000_Iq6UCEvX.webp)

å¯ä»¥é€šè¿‡é¡µé¢å³ä¸‹è§’çš„ **è®¾ç½®** è¿›å…¥è®¾ç½®é¡µé¢, é¦–æ¬¡ç™»å½•è¾“å…¥çš„å¯†ç å°†æˆä¸ºç®¡ç†å‘˜å¯†ç , è¯¦ç»†çš„é…ç½®é¡¹å¯æŸ¥çœ‹ [å®˜æ–¹æ–‡æ¡£](https://fcircle-doc.yyyzyyyz.cn/#/settings?id=%e9%a1%b9%e7%9b%ae%e9%85%8d%e7%bd%ae)

## [ä¸ªæ€§åŒ–åŠ è½½åŠ¨ç”»ï¼Œè®©ä½ çš„ Hexo åšå®¢æ›´ç‚«é…·ï¼](https://blog.dong4j.site/posts/a239fff8.md)

![/images/cover/20250103184959_iDTIF6Dq.webp](https://cdn.dong4j.site/source/image/20250103184959_iDTIF6Dq.webp)

å‚è€ƒ [ã€Hexoåšå®¢ã€‘è‡ªå®šä¹‰Butterflyä¸»é¢˜ Loading åŠ è½½åŠ¨ç”»](https://blog.meta-code.top/2022/06/18/2022-73/) å’Œ [Hexoçš„Butterflyä¸‹è‡ªå®šä¹‰åŠ è½½åŠ¨ç”»ä¹‹å°æ±½è½¦åŠ¨ç”»çš„å®ç°](https://blog.zhheo.com/p/32776e99.html) å®ç°äº†åœ¨ anzhiyu ä¸»é¢˜ä¸‹çš„è‡ªå®šä¹‰åŠ è½½åŠ¨ç”»ã€‚

## æ·»åŠ  loading æ¨¡ç‰ˆ

æ–°å»ºç›®å½•: `themes/anzhiyu/layout/includes/loading/load_style`, æ·»åŠ å¦‚ä¸‹ pug:

{% tabs loading template %}

<!-- tab car.pug -->

```javascript
#loading-box
  .carplay

script.
  const preloader = {
    endLoading: () => {
      document.getElementById('loading-box').classList.add("loaded");
    },
    initLoading: () => {
      document.getElementById('loading-box').classList.remove("loaded")
    }
  }

  window.addEventListener('load',()=> { preloader.endLoading() })
  setTimeout(function(){preloader.endLoading();},10000)

  document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})

  if (!{theme.pjax && theme.pjax.enable}) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
```

<!-- endtab -->

<!-- tab default.pug -->

```javascript
#loading-box
  .loading-left-bg
  .loading-right-bg
  .spinner-box
    .configure-border-1
      .configure-core
    .configure-border-2
      .configure-core
    .loading-word= _p('loading')

script.
  const preloader = {
    endLoading: () => {
      document.getElementById('loading-box').classList.add("loaded");
    },
    initLoading: () => {
      document.getElementById('loading-box').classList.remove("loaded")
    }
  }

  window.addEventListener('load',()=> { preloader.endLoading() })
  setTimeout(function(){preloader.endLoading();},10000)
  document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})
  
  if (!{theme.pjax && theme.pjax.enable}) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
```

<!-- endtab -->

<!-- tab gear.pug -->

```javascript
#loading-box
  .gear-loader
    .gear-loader_overlay
    .gear-loader_cogs
      .gear-loader_cogs__top
        .gear-top_part
        .gear-top_part
        .gear-top_part
        .gear-top_hole
      .gear-loader_cogs__left
        .gear-left_part
        .gear-left_part
        .gear-left_part
        .gear-left_hole
      .gear-loader_cogs__bottom
        .gear-bottom_part
        .gear-bottom_part
        .gear-bottom_part
        .gear-bottom_hole

script.
  const preloader = {
    endLoading: () => {
      document.getElementById('loading-box').classList.add("loaded");
    },
    initLoading: () => {
      document.getElementById('loading-box').classList.remove("loaded")
    }
  }

  window.addEventListener('load',()=> { preloader.endLoading() })
  setTimeout(function(){preloader.endLoading();},10000)
  document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})
  
  if (!{theme.pjax && theme.pjax.enable}) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
```

<!-- endtab -->

<!-- tab heo.pug -->

```javascript
- loading_img = theme.preloader.avatar ? theme.preloader.avatar : theme.avatar.img
#loading-box(onclick='document.getElementById("loading-box").classList.add("loaded")')
  .loading-bg
    img.loading-img(alt="åŠ è½½å¤´åƒ" class='nolazyload' src=url_for(loading_img))
    .loading-image-dot
script.
  const preloader = {
    endLoading: () => {
      document.getElementById('loading-box').classList.add("loaded");
    },
    initLoading: () => {
      document.getElementById('loading-box').classList.remove("loaded")
    }
  }
  window.addEventListener('load',()=> { preloader.endLoading() })
  setTimeout(function(){preloader.endLoading();},10000)

  if (!{theme.pjax && theme.pjax.enable}) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }

```

<!-- endtab -->

<!-- tab image.pug -->

```javascript
- var loadimage = theme.preloader.load_image ? theme.preloader.load_image : theme.error_img.post_page
#loading-box
  .loading-left-bg
  .loading-right-bg
  img.load-image(src=url_for(loadimage) alt='')

script.
  const preloader = {
    endLoading: () => {
      document.getElementById('loading-box').classList.add("loaded");
    },
    initLoading: () => {
      document.getElementById('loading-box').classList.remove("loaded")
    }
  }

  window.addEventListener('load',()=> { preloader.endLoading() })
  setTimeout(function(){preloader.endLoading();},10000)
  document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})
  
  if (!{theme.pjax && theme.pjax.enable}) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
```

<!-- endtab -->

<!-- tab ironheart.pug -->

```javascript
#loading-box
  .loading-left-bg
  .loading-right-bg
  .iron-container.iron-circle
    .iron-box1.iron-circle.iron-center
    .iron-box2.iron-circle.iron-center
    .iron-box3.iron-circle.iron-center
    .iron-box4.iron-circle.iron-center
    .iron-box5.iron-circle.iron-center
    .iron-box6.iron-circle
      .iron-coil(style='--i: 0')
      .iron-coil(style='--i: 1')
      .iron-coil(style='--i: 2')
      .iron-coil(style='--i: 3')
      .iron-coil(style='--i: 4')
      .iron-coil(style='--i: 5')
      .iron-coil(style='--i: 6')
      .iron-coil(style='--i: 7')

script.
  const preloader = {
    endLoading: () => {
      document.getElementById('loading-box').classList.add("loaded");
    },
    initLoading: () => {
      document.getElementById('loading-box').classList.remove("loaded")
    }
  }

  window.addEventListener('load',()=> { preloader.endLoading() })
  setTimeout(function(){preloader.endLoading();},10000)
  document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})
  
  if (!{theme.pjax && theme.pjax.enable}) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
```

<!-- endtab -->

<!-- tab pace.pug -->

```javascript
link(rel="stylesheet", href=url_for(theme.preloader.pace_css_url || theme.asset.pace_default_css))
script(async src=url_for(theme.asset.pace_js), data-pace-options='{ "restartOnRequestAfter":false,"eventLag":false}')
```

<!-- endtab -->

<!-- tab scarecrow.pug -->

```javascript
#loading-box
  .loading-left-bg
  .loading-right-bg
  .scarecrow
    .scarecrow__hat
      .scarecrow__ribbon
    .scarecrow__head
      .scarecrow__eye
      .scarecrow__eye
      .scarecrow__mouth
      .scarecrow__pipe
    .scarecrow__body
      .scarecrow__glove.scarecrow__glove--l
      .scarecrow__sleeve.scarecrow__sleeve--l
      .scarecrow__bow
      .scarecrow__shirt
      .scarecrow__coat
      .scarecrow__waistcoat
      .scarecrow__sleeve.scarecrow__sleeve--r
      .scarecrow__glove.scarecrow__glove--r
      .scarecrow__coattails
      .scarecrow__pants
    .scarecrow__arms
    .scarecrow__leg   

script.
  const preloader = {
    endLoading: () => {
      document.getElementById('loading-box').classList.add("loaded");
    },
    initLoading: () => {
      document.getElementById('loading-box').classList.remove("loaded")
    }
  }

  window.addEventListener('load',()=> { preloader.endLoading() })
  setTimeout(function(){preloader.endLoading();},10000)
  document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})
  
  if (!{theme.pjax && theme.pjax.enable}) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
```

<!-- endtab -->

<!-- tab triangles.pug -->

```javascript
#loading-box
  .triangles-wrap
    .triangles-eiz
    .triangles-seiz
    .triangles-sei
    .triangles-fei
    .triangles-feir
    .triangles-trei
    .triangles-dvai
    .triangles-ein
    .triangles-zero


script.
  const preloader = {
    endLoading: () => {
      document.getElementById('loading-box').classList.add("loaded");
    },
    initLoading: () => {
      document.getElementById('loading-box').classList.remove("loaded")
    }
  }

  window.addEventListener('load',()=> { preloader.endLoading() })
  setTimeout(function(){preloader.endLoading();},10000)
  document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})
  
  if (!{theme.pjax && theme.pjax.enable}) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
```

<!-- endtab -->

<!-- tab wizard.pug -->

```javascript
#loading-box
  .loading-left-bg
  .loading-right-bg
  .wizard-scene
    .wizard-objects
      .wizard-square
      .wizard-circle
      .wizard-triangle
    .wizard
      .wizard-body
      .wizard-right-arm
        .wizard-right-hand
      .wizard-left-arm
        .wizard-left-hand
      .wizard-head
        .wizard-beard
        .wizard-face
          .wizard-adds
        .wizard-hat
          .wizard-hat-of-the-hat
          .wizard-four-point-star.--first
          .wizard-four-point-star.--second
          .wizard-four-point-star.--third

script.
  const preloader = {
    endLoading: () => {
      document.getElementById('loading-box').classList.add("loaded");
    },
    initLoading: () => {
      document.getElementById('loading-box').classList.remove("loaded")
    }
  }

  window.addEventListener('load',()=> { preloader.endLoading() })
  setTimeout(function(){preloader.endLoading();},10000)
  document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})
  
  if (!{theme.pjax && theme.pjax.enable}) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
```

<!-- endtab -->

{% endtabs %}

## ä¿®æ”¹ loading é…ç½®

ä¿®æ”¹ `themes/anzhiyu/layout/includes/loading/index.pug`

```javascript
if theme.preloader.source === 'heo'
  include ./load_style/heo.pug
else if theme.preloader.source === 'car'
  include ./load_style/car.pug
else if theme.preloader.source === 'gear'
  include ./load_style/gear.pug
else if theme.preloader.source === 'ironheart'
  include ./load_style/ironheart.pug
else if theme.preloader.source === 'scarecrow'
  include ./load_style/scarecrow.pug
else if theme.preloader.source === 'triangles'
  include ./load_style/triangles.pug
else if theme.preloader.source === 'wizard'
  include ./load_style/wizard.pug
else if theme.preloader.source === 'image'
  include ./load_style/image.pug
else if theme.preloader.source === 'default'
  include ./load_style/default.pug
else
  include ./load_style/heo.pug

include ./load_style/pace.pug
```

## æ·»åŠ  loading æ ·å¼æ¨¡ç‰ˆ

æ–°å»ºåŠ¨ç”»æ ·å¼æ¨¡æ¿å­˜æ”¾çš„æ–‡ä»¶å¤¹ï¼Œå¦‚æ— ç‰¹åˆ«æç¤ºï¼Œæ‰€æœ‰åŠ¨ç”»æ ·å¼å‡å­˜æ”¾åœ¨ `themes/anzhiyu/layout/includes/loading/load_style` ç›®å½•ä¸‹:

{% tabs loading style template %}

æºæ–‡ä»¶æ¥è‡ªäº: [Hexoçš„Butterflyä¸‹è‡ªå®šä¹‰åŠ è½½åŠ¨ç”»ä¹‹å°æ±½è½¦åŠ¨ç”»çš„å®ç°](https://blog.zhheo.com/p/32776e99.html), ä¸è¿‡åšäº†ç›¸åº”é€‚é…, å¯ç›´æ¥ä½¿ç”¨è¿™é‡Œçš„æ ·å¼.

<!-- tab car.css -->

```css
.carplay {
  box-sizing: border-box;

  --black: #1a1c20;
  --white: #fff;
  --green: #00c380;
  --d-green: #019b66;
  --gray: #c1c1c1;
  --l-gray: #c4c4c4;
  --m-gray: #373838;
  --d-gray: #282724;
  --d-blue: #202428;
  --orange: #ef6206;
  --yellow: #dfa500;
  --l-yellow: #deb953;
  --light: #fbfbfb;
  --n-road: -4em;
  --p-road: 7em;

  background-color: var(--green);
}

.carplay *,
.carplay *::before,
.carplay *::after {
  box-sizing: inherit;
}

.carplay::before,
.carplay::after {
  content: " ";
  position: absolute;
  z-index: 1002;
}

.carplay {
  margin: 0;
  height: 100vh;
  display: flex;
  overflow: hidden;
  position: relative;
  align-items: center;
  justify-content: center;
  background-repeat: no-repeat;
  animation: car 3.5s cubic-bezier(0.57, 0.63, 0.49, 0.65) infinite;

  background-image: 


    /* ===rubber-l */ radial-gradient(
      circle at 49% 117%,
      var(--black) 37%,
      transparent 38%
    ),
    radial-gradient(circle at -24% 50%, var(--white) 31%, transparent 49%),
    radial-gradient(2.95em 2.5em at 52% 1.2%, var(--black) 37%, transparent 38%),
    radial-gradient(2.95em 2.5em at 52% 1.2%, var(--black) 37%, transparent 38%),
    linear-gradient(var(--black) 100%, transparent 0),
    /* rubber-l=== */ /* ===rubber-r */
      radial-gradient(circle at 49% 117%, var(--black) 37%, transparent 38%),
    radial-gradient(circle at 124% 50%, var(--white) 31%, transparent 49%),
    radial-gradient(2.95em 2.5em at 48% 1.2%, var(--black) 37%, transparent 38%),
    radial-gradient(2.95em 2.5em at 48% 1.2%, var(--black) 37%, transparent 38%),
    linear-gradient(var(--black) 100%, transparent 0),
    /* rubber-r=== */ /* ===shadow */
      linear-gradient(var(--d-green) 100%, transparent 0);

  /* shadow=== */

  background-size: 


    /* ===rubber-l */ 2.5em 2.5em, 0.7em 0.6em, 2.5em 0.9em,
    2.5em 0.9em, 1.95em 3.9em, /* rubber-l=== */ /* ===rubber-r */ 2.5em 2.5em,
    0.7em 0.6em, 2.5em 0.9em, 2.5em 0.9em, 1.95em 3.9em,
    /* rubber-r=== */ /* ===shadow */ 13em 0.9em;

  /* shadow=== */

  background-position: 


    /* ===rubber-l */ calc(50% - 6.4em) calc(50% - 1.7em),
    calc(50% - 5.26em) calc(50% - -3.4em), calc(50% - 6.5em) calc(50% - -3.8em),
    calc(50% - 4.3em) calc(50% - -3.2em), calc(50% - 6.58em) calc(50% - -1.5em),
    /* rubber-l=== */ /* ===rubber-r */ calc(50% - -6.45em) calc(50% - 1.7em),
    calc(50% - -5.26em) calc(50% - -3.4em),
    calc(50% - -6.5em) calc(50% - -3.8em), calc(50% - -4.3em) calc(50% - -3.2em),
    calc(50% - -6.58em) calc(50% - -1.5em),
    /* rubber-r=== */ /* ===shadow */ center calc(50% - -3.8em);

  /* shadow=== */
}

.carplay::before {
  width: 15.5em;
  height: 62.9em;
  top: calc(50% - 26.2em);
  background-size: 24.6% 491%;
  background-repeat: no-repeat;
  background-position: center 0;
  animation: line 1.5s infinite linear, move-road 3.5s infinite linear;
  transform: perspective(311px) rotateX(83deg)
    translate3d(var(--n-road), -11.975em, 0);
  background-image: repeating-linear-gradient(
    to top,
    var(--white),
    var(--white) 4.6%,
    transparent 0,
    transparent 13.01%
  );
}

.carplay::after {
  width: 15.2em;
  height: 13.2em;
  top: calc(50% - 8.8em);
  left: calc(50% - 7.55em);
  background-repeat: no-repeat;
  animation: light 1s linear infinite, shake 3.5s linear infinite;

  background-image: 

    /* ===ceiling */ radial-gradient(
      58em 20em at 50% 215%,
      transparent 20%,
      var(--white) 20.5%,
      var(--white) 20.8%,
      var(--green) 21.5%
    ),
    /* ceiling=== */ /* ===antenna */
      radial-gradient(circle at center 100%, var(--black) 30%, transparent 0),
    /* antenna=== */ /* ===antenna */
      linear-gradient(var(--white) 100%, transparent 0),
    /* antenna=== */ /* ===glass-l */
      radial-gradient(
        17.8em 37em at 70% 240%,
        var(--black) 30%,
        transparent 30.5%
      ),
    /* glass-l=== */ /* ===glass-r */
      radial-gradient(
        17.8em 37em at 31% 240%,
        var(--black) 30%,
        transparent 30.5%
      ),
    /* glass-r=== */ /* ===light */
      radial-gradient(
        circle,
        var(--light) 48%,
        var(--black) 52%,
        var(--black) 59%,
        transparent 62%
      ),
    /* light=== */ /* ===light */
      radial-gradient(
        circle,
        var(--light) 48%,
        var(--black) 52%,
        var(--black) 59%,
        transparent 62%
      ),
    /* light=== */ /* ===hood-ro */
      radial-gradient(1em 1em at 102% 100%, var(--m-gray) 28%, #f3f3f3 30%),
    /* hood-ro=== */ /* ===hood-ro */
      radial-gradient(1em 1em at 97% -7%, var(--m-gray) 28%, var(--l-gray) 30%),
    /* hood-ro=== */ /* ===hood-ro */
      radial-gradient(1em 1em at -6% 102%, var(--m-gray) 28%, #efefef 30%),
    /* hood-ro=== */ /* ===hood-ro */
      radial-gradient(1em 1em at -6% -1%, var(--m-gray) 28%, var(--l-gray) 30%),
    /* hood-ro=== */ /* ===hood-f */
      linear-gradient(
        to top,
        var(--m-gray) 50%,
        var(--d-gray) 0,
        var(--d-gray) 58%,
        var(--m-gray) 0
      ),
    /* hood-f=== */ /* ===hood-e */
      linear-gradient(
        to top,
        var(--l-gray) 30%,
        var(--white) 100%,
        transparent 0
      ),
    /* hood-e=== */ /* ===hood-l */
      radial-gradient(
        16.4em 30.1em at 209% 333%,
        var(--white) 30%,
        transparent 30.2%
      ),
    /* hood-l=== */ /* ===hood-r */
      radial-gradient(
        16.4em 30.1em at -109% 333%,
        var(--white) 30%,
        transparent 30.2%
      ),
    /* hood-r=== */ /* ===hood-o */
      linear-gradient(var(--gray) 100%, transparent 0),
    /* hood-o=== */ /* ===hood */
      linear-gradient(var(--white) 100%, transparent 0),
    /* hood=== */ /* ===mirror */
      radial-gradient(6.7em 2.5em at 154% 8%, var(--black) 30%, transparent 33%),
    /* mirror=== */ /* ===mirror */
      radial-gradient(6.7em 2.5em at -53% 8%, var(--black) 30%, transparent 33%),
    /* mirror=== */ /* ===guide-l */
      linear-gradient(var(--orange) 100%, transparent 0),
    /* guide-l=== */ /* ===guide-r */
      linear-gradient(var(--orange) 100%, transparent 0),
    /* guide-r=== */ /* ===plaque */
      linear-gradient(var(--yellow) 100%, transparent 0),
    /* plaque=== */ /* ===plaque */
      linear-gradient(var(--l-yellow) 100%, transparent 0),
    /* plaque=== */ /* ===bumper */
      linear-gradient(var(--d-blue) 100%, transparent 0),
    /* bumper=== */ /* ===bumper-l */
      radial-gradient(circle at 124% 39%, var(--d-blue) 60%, transparent 64%),
    /* bumper-l=== */ /* ===bumper-r */
      radial-gradient(circle at -44% 39%, var(--d-blue) 60%, transparent 64%),
    /* bumper-r=== */ /* ===bumper-d */
      radial-gradient(
        13.2em 2em at 50% 59%,
        var(--l-gray) 96%,
        transparent 100%
      ),
    /* bumper-d=== */ /* ===bumper-l */
      radial-gradient(
        1.6em 1.6em at 75% -9%,
        var(--l-gray) 60%,
        transparent 64%
      ),
    /* bumper-l=== */ /* ===bumper-r */
      radial-gradient(
        1.6em 1.6em at 15% -9%,
        var(--l-gray) 60%,
        transparent 64%
      ),
    /* bumper-r=== */ /* ===floor */
      linear-gradient(var(--d-blue) 100%, transparent 0),
    /* floor=== */ /* ===floor-l */
      radial-gradient(
        6.9em 4.6em at 295% 3%,
        var(--d-blue) 30%,
        transparent 31%
      ),
    /* floor-l=== */ /* ===floor-r */
      radial-gradient(
        6.9em 4.6em at -189% 3%,
        var(--d-blue) 30%,
        transparent 31%
      );

  /* floor-r=== */

  background-size: 

    /*=== ceiling */ 61.5% 20%,
    /* ceiling=== */ /* ===antenna */ 5% 6%,
    /* antenna=== */ /*=== antenna */ 0.4% 39%,
    /* antenna=== */ /* ===glass-l */ 60% 30%,
    /* glass-l=== */ /* ===glass-r */ 60% 30%,
    /* glass-r=== */ /* ===light */ 16% 16%,
    /* light=== */ /* ===light */ 16% 16%,
    /* light=== */ /* ===hood-ro */ 2.4% 2%,
    /* hood-ro=== */ /* ===hood-ro */ 2.4% 2.3%,
    /* hood-ro=== */ /* ===hood-ro */ 2.4% 2.3%,
    /* hood-ro=== */ /* ===hood-ro */ 2.4% 2.3%,
    /* hood-ro=== */ /* ===hood-f */ 91% 12%,
    /* hood-f=== */ /* ===hood-e */ 93.9% 17%,
    /* hood-e=== */ /* ===hood-l */ 12% 17.5%,
    /* hood-l=== */ /* ===hood-r */ 12% 17.5%,
    /* hood-r=== */ /* ===hood-o */ 38% 1.1%,
    /* hood-o=== */ /* ===hood */ 77% 25%, /* hood=== */ /* ===mirror */ 9% 30%,
    /* mirror=== */ /* ===mirror */ 9% 30%,
    /* mirror=== */ /* ===guide-l */ 8.4% 3%,
    /* guide-l=== */ /* ===guide-r */ 8.4% 3%,
    /* guide-r=== */ /* ===plaque */ 33% 6.5%,
    /* plaque=== */ /* ===plaque */ 36% 9%,
    /* plaque=== */ /* ===bumper */ 87% 30%,
    /* bumper=== */ /* ===bumper-l */ 10% 12%,
    /* bumper-l=== */ /* ===bumper-r */ 10% 12%,
    /* bumper-r=== */ /* ===bumper-d */ 78% 35%,
    /* bumper-d=== */ /* ===bumper-l */ 11% 8%,
    /* bumper-l=== */ /* ===bumper-r */ 11% 8%,
    /* bumper-r=== */ /* ===floor */ 68% 8%,
    /* floor=== */ /* ===floor-l */ 5% 7%,
    /* floor-l=== */ /* ===floor-r */ 5% 7%;

  /* floor-r=== */

  background-position: 


    /*=== ceiling */ 50.5% 0,
    /* ceiling=== */ /* ===antenna */ 90% 37%,
    /* antenna=== */ /*=== antenna */ 88% 1.2%,
    /* antenna=== */ /* ===glass-l */ 0 11.7%,
    /* glass-l=== */ /* ===glass-r */ 100% 11.7%,
    /* glass-r=== */ /* ===light */ 5% 63%,
    /* light=== */ /* ===light */ 95% 63%,
    /* light=== */ /* ===hood-ro */ 4.1% 55.7%,
    /* hood-ro=== */ /* ===hood-ro */ 4.1% 65.9%,
    /* hood-ro=== */ /* ===hood-ro */ 95.8% 55.7%,
    /* hood-ro=== */ /* ===hood-ro */ 95.8% 65.8%,
    /* hood-ro=== */ /* ===hood-f */ center 62%,
    /* hood-f=== */ /* ===hood-e */ 49% 63.6%,
    /* hood-e=== */ /* ===hood-l */ 3.4% 46.2%,
    /* hood-l=== */ /* ===hood-r */ 96.5% 46.2%,
    /* hood-r=== */ /* ===hood-o */ center 40.9%,
    /* hood-o=== */ /* ===hood */ center 50.3%,
    /* hood=== */ /* ===mirror */ 5.7% 48.6%,
    /* mirror=== */ /* ===mirror */ 95% 48.6%,
    /* mirror=== */ /* ===guide-l */ 5% 75.2%,
    /* guide-l=== */ /* ===guide-r */ 95% 75.2%,
    /* guide-r=== */ /* ===plaque */ 51% 86%,
    /* plaque=== */ /* ===plaque */ 51.5% 87.3%,
    /* plaque=== */ /* ===bumper */ center 71.9%,
    /* bumper=== */ /* ===bumper-l */ -0.8% 77.8%,
    /* bumper-l=== */ /* ===bumper-r */ 101.7% 77.8%,
    /* bumper-r=== */ /* ===bumper-d */ center 80.2%,
    /* bumper-d=== */ /* ===bumper-l */ 4% 85.9%,
    /* bumper-l=== */ /* ===bumper-r */ 97% 85.9%,
    /* bumper-r=== */ /* ===floor */ center 92.5%,
    /* floor=== */ /* ===floor-l */ 11.7% 92.6%,
    /* floor-l=== */ /* ===floor-r */ 88.3% 92.6%;
}

@keyframes line {
  100% {
    background-position: center 100%;
  }
}

@keyframes car {
  15%,
  23% {
    transform: translate3d(-2.3em, 0, 0);
  }

  36%,
  42% {
    transform: translate3d(-0.8em, 0, 0);
  }

  61%,
  71.5% {
    transform: translate3d(2.8em, 0, 0);
  }

  81%,
  88% {
    transform: translate3d(1.5em, 0, 0);
  }
}

@keyframes move-road {
  5.5% {
    transform: perspective(311px) rotateX(83deg)
      translate3d(var(--n-road), -11.975em, 0);
  }

  27%,
  51% {
    transform: perspective(311px) rotateX(83deg)
      translate3d(var(--p-road), -11.975em, 0);
  }

  73%,
  100% {
    transform: perspective(311px) rotateX(83deg)
      translate3d(var(--n-road), -11.975em, 0);
  }
}

@keyframes light {
  0%,
  37% {
    --light: #fbfbfb;
  }

  50% {
    --light: #f1f1f1;
  }

  62% {
    --light: #fbfbfb;
  }

  65% {
    --light: #f1f1f1;
  }

  95% {
    --light: #fbfbfb;
  }

  100% {
    --light: #f1f1f1;
  }
}

@keyframes shake {
  5%,
  26% {
    transform: rotate(-1.5deg);
  }

  33%,
  41% {
    transform: rotate(-0.5deg);
  }

  48%,
  69% {
    transform: rotate(1.5deg);
  }

  80%,
  95% {
    transform: rotate(0.5deg);
  }
}

```

<!-- endtab -->

<!-- tab car.styl-->

```css
if hexo-config('preloader')
  .carplay
    display: flex;
    width: 100%;
    height: 100%;
    position: fixed;
    z-index: 1001;
    opacity: 1;
    overflow: hidden;
    transition: 0.2s;
    &::-webkit-scrollbar 
      display: none; 

  #loading-box
    user-select none
    &.loaded
      .carplay
        display: none

  @keyframes loadingAction
    0% {
        opacity: 1;
    }

    100% {
        opacity: .4;
    }

```

<!-- endtab -->

<!-- tab default.styl -->

```css
.loading-bg
  position fixed
  z-index 1000
  width 50%
  height 100%
  background var(--preloader-bg)
#loading-box
  .loading-left-bg
    @extend .loading-bg
    left 0
  .loading-right-bg
    @extend .loading-bg
    right 0
  &.loaded
    z-index -1000
    .loading-left-bg
      transition all 1.0s
      transform translate(-100%, 0)
    .loading-right-bg
      transition all 1.0s
      transform translate(100%, 0)
#loading-box
  .spinner-box
    position fixed
    z-index 1001
    display flex
    justify-content center
    align-items center
    width 100%
    height 100vh

    .configure-border-1
      position absolute
      padding 3px
      width 115px
      height 115px
      background #ffab91
      animation configure-clockwise 3s ease-in-out 0s infinite alternate

    .configure-border-2
      left -115px
      padding 3px
      width 115px
      height 115px
      background rgb(63, 249, 220)
      transform rotate(45deg)
      animation configure-xclockwise 3s ease-in-out 0s infinite alternate

    .loading-word
      position absolute
      color var(--preloader-color)
      font-size 16px

    .configure-core
      width 100%
      height 100%
      background-color var(--preloader-bg)

  &.loaded
    .spinner-box
      display none

@keyframes configure-clockwise
  0%
    transform rotate(0)

  25%
    transform rotate(90deg)

  50%
    transform rotate(180deg)

  75%
    transform rotate(270deg)

  100%
    transform rotate(360deg)

@keyframes configure-xclockwise
  0%
    transform rotate(45deg)

  25%
    transform rotate(-45deg)

  50%
    transform rotate(-135deg)

  75%
    transform rotate(-225deg)

  100%
    transform rotate(-315deg)

```

<!-- endtab -->

<!-- tab gear.styl -->

```css
#loading-box
  position fixed
  z-index 1000
  width 100vw
  height 100vh
  overflow hidden
  text-align center
  &.loaded
    z-index -1000
    .gear-loader
      display none
  .gear-loader
    height 100%
    position relative
    margin auto
    width 400px
  .gear-loader_overlay
    width 150px
    height 150px
    background transparent
    box-shadow 0px 0px 0px 1000px rgba(255, 255, 255, 0.67), 0px 0px 19px 0px rgba(0, 0, 0, 0.16) inset
    border-radius 100%
    z-index -1
    position absolute
    left 0
    right 0
    top 0
    bottom 0
    margin auto
  .gear-loader_cogs
    z-index -2
    width 100px
    height 100px
    top -120px !important
    position absolute
    left 0
    right 0
    top 0
    bottom 0
    margin auto
  .gear-loader_cogs__top
    position relative
    width 100px
    height 100px
    transform-origin 50px 50px
    -webkit-animation rotate 10s infinite linear
    animation rotate 10s infinite linear
    div
      &:nth-of-type(1)
        transform rotate(30deg)
      &:nth-of-type(2)
        transform rotate(60deg)
      &:nth-of-type(3)
        transform rotate(90deg)
      &.gear-top_part
        width 100px
        border-radius 10px
        position absolute
        height 100px
        background #f98db9
      &.gear-top_hole
        width 50px
        height 50px
        border-radius 100%
        background white
        position absolute
        position absolute
        left 0
        right 0
        top 0
        bottom 0
        margin auto
  .gear-loader_cogs__left
    position relative
    width 80px
    transform rotate(16deg)
    top 28px
    transform-origin 40px 40px
    animation rotate_left 10s 0.1s infinite reverse linear
    left -24px
    height 80px
    div
      &:nth-of-type(1)
        transform rotate(30deg)
      &:nth-of-type(2)
        transform rotate(60deg)
      &:nth-of-type(3)
        transform rotate(90deg)
      &.gear-left_part
        width 80px
        border-radius 6px
        position absolute
        height 80px
        background #97ddff
      &.gear-left_hole
        width 40px
        height 40px
        border-radius 100%
        background white
        position absolute
        position absolute
        left 0
        right 0
        top 0
        bottom 0
        margin auto
  .gear-loader_cogs__bottom
    position relative
    width 60px
    top -65px
    transform-origin 30px 30px
    -webkit-animation rotate_left 10.2s 0.4s infinite linear
    animation rotate_left 10.2s 0.4s infinite linear
    transform rotate(4deg)
    left 79px
    height 60px
    div
      &:nth-of-type(1)
        transform rotate(30deg)
      &:nth-of-type(2)
        transform rotate(60deg)
      &:nth-of-type(3)
        transform rotate(90deg)
      &.gear-bottom_part
        width 60px
        border-radius 5px
        position absolute
        height 60px
        background #ffcd66
      &.gear-bottom_hole
        width 30px
        height 30px
        border-radius 100%
        background white
        position absolute
        position absolute
        left 0
        right 0
        top 0
        bottom 0
        margin auto



/* Animations */
@-webkit-keyframes rotate {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}
@keyframes rotate {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}
@-webkit-keyframes rotate_left {
  from {
    transform: rotate(16deg);
  }
  to {
    transform: rotate(376deg);
  }
}
@keyframes rotate_left {
  from {
    transform: rotate(16deg);
  }
  to {
    transform: rotate(376deg);
  }
}
@-webkit-keyframes rotate_right {
  from {
    transform: rotate(4deg);
  }
  to {
    transform: rotate(364deg);
  }
}
@keyframes rotate_right {
  from {
    transform: rotate(4deg);
  }
  to {
    transform: rotate(364deg);
  }
}

```

<!-- endtab -->

<!-- tab heo.styl -->

```css
if hexo-config('preloader')
  .loading-bg
    display: flex;
    width: 100%;
    height: 100%;
    position: fixed;
    background: var(--anzhiyu-card-bg);
    z-index: 1001;
    opacity: 1;
    overflow: hidden;
    transition: 0.2s;
    animation: showLoading 0.3s 0s backwards;
    &::-webkit-scrollbar 
      display: none

  #loading-box
    user-select none
    .loading-img
      width: 100px;
      height: 100px;
      border-radius: 50%;
      margin: auto;
      border: 4px solid #f0f0f2;
      animation-duration: 0.2s;
      animation-name: loadingAction;
      animation-iteration-count: infinite;
      animation-direction: alternate;
    .loading-image-dot
      width: 30px;
      height: 30px;
      background: #6bdf8f;
      position: absolute;
      border-radius: 50%;
      border: 6px solid #fff;
      top: 50%;
      left: 50%;
      transform: translate(18px, 24px);
    &.loaded
      .loading-bg
        opacity: 0;
        z-index: -1000;

  @keyframes loadingAction
    0% {
        opacity: 1;
    }

    100% {
        opacity: .4;
    }
```

<!-- endtab -->

<!-- tab image.styl -->

```css
.loading-bg
  position fixed
  z-index 1000
  width 50%
  height 100%
  background var(--preloader-bg)
#loading-box
  .loading-left-bg
    @extend .loading-bg
    left 0
  .loading-right-bg
    @extend .loading-bg
    right 0
  &.loaded
    z-index -1000
    .loading-left-bg
      transition all 1.0s
      transform translate(-100%, 0)
    .loading-right-bg
      transition all 1.0s
      transform translate(100%, 0)
#loading-box
  position fixed
  z-index 1000
  display -webkit-box
  display flex
  -webkit-box-align center
  align-items center
  -webkit-box-pack center
  justify-content center
  -webkit-box-orient vertical
  -webkit-box-direction normal
  flex-direction column
  flex-wrap wrap
  width 100vw
  height 100vh
  overflow hidden

  .load-image
    position fixed
    z-index 1001
    display flex

  &.loaded
    .load-image
      display none

```

<!-- endtab -->

<!-- tab ironheart.styl -->

```css
.loading-bg
  position fixed
  z-index 1000
  width 50%
  height 100%
  background var(--preloader-bg)
#loading-box
  .loading-left-bg
    @extend .loading-bg
    left 0
  .loading-right-bg
    @extend .loading-bg
    right 0
  &.loaded
    z-index -1000
    .loading-left-bg
      transition all 1.0s
      transform translate(-100%, 0)
    .loading-right-bg
      transition all 1.0s
      transform translate(100%, 0)
#loading-box
  position fixed
  z-index 1000
  display -webkit-box
  display flex
  -webkit-box-align center
  align-items center
  -webkit-box-pack center
  justify-content center
  -webkit-box-orient vertical
  -webkit-box-direction normal
  flex-direction column
  flex-wrap wrap
  width 100vw
  height 100vh
  overflow hidden

  &.loaded
    .iron-container
      display none

  .iron-circle
    border-radius 50%

  .iron-center
    position absolute
    top 50%
    left 50%
    transform translate(-50%, -50%)

  .iron-container
    z-index 1001
    position relative
    width 300px
    height 300px
    border 1px solid rgb(18, 20, 20)
    background-color #384c50
    box-shadow 0 0 32px 8px rgb(18, 20, 20), 0 0 4px 1px rgb(18, 20, 20) inset
    .iron-box1
      width 238px
      height 238px
      background-color rgb(22, 26, 27)
      box-shadow 0 0 4px 1px #52fefe
    .iron-box2
      width 220px
      height 220px
      background-color #fff
      box-shadow 0 0 5px 1px #52fefe, 0 0 5px 4px #52fefe inset
    .iron-box3
      width 180px
      height 180px
      background-color #073c4b
      box-shadow 0 0 5px 4px #52fefe, 0 0 6px 2px #52fefe inset
    .iron-box4
      width 120px
      height 120px
      border 1px solid #52fefe
      background-color #fff
      box-shadow 0 0 2px 1px #52fefe, 0 0 10px 5px #52fefe inset
    .iron-box5
      width 70px
      height 70px
      border 5px solid #1b4e5f
      box-shadow 0 0 7px 5px #52fefe, 0 0 10px 10px #52fefe inset
    .iron-box6
      position relative
      width 100%
      height 100%
      animation ironrotate 3s linear infinite
      .iron-coil
        position absolute
        width 30px
        height 20px
        top calc(50% - 110px)
        left calc(50% - 15px)
        background-color #073c4b
        box-shadow 0 0 5px #52fefe inset
        transform rotate(calc(var(--i) * 45deg))
        transform-origin center 110px
@keyframes ironrotate
  0%
    transform rotate(0)
  100%
    transform rotate(360deg)
```

<!-- endtab -->

<!-- tab scarecrow.styl -->

```css
.loading-bg
  position fixed
  z-index 1000
  width 50%
  height 100%
  background var(--preloader-bg)
#loading-box
  .loading-left-bg
    @extend .loading-bg
    left 0
  .loading-right-bg
    @extend .loading-bg
    right 0
  &.loaded
    z-index -1000
    .loading-left-bg
      transition all 1.0s
      transform translate(-100%, 0)
    .loading-right-bg
      transition all 1.0s
      transform translate(100%, 0)

#loading-box
  position fixed
  z-index 1000
  display -webkit-box
  display flex
  -webkit-box-align center
  align-items center
  -webkit-box-pack center
  justify-content center
  -webkit-box-orient vertical
  -webkit-box-direction normal
  flex-direction column
  flex-wrap wrap
  width 100vw
  height 100vh
  overflow hidden
  &.loaded
    .scarecrow
      display none
  .scarecrow
    z-index 1001
    position relative
    animation hop 0.2s ease-in alternate infinite

  .scarecrow__hat
    position relative
    border-top-left-radius 5px
    border-top-right-radius 5px
    border-top 45px solid #515559
    border-left 1px solid transparent
    border-right 1px solid transparent
    width 55px
    margin 0 auto -3px
    z-index 1
    &:before
      content ""
      position absolute
      top -87px
      right -23px
      background-color #515559
      width 9px
      height 55px
      border-radius 100%
      transform rotate(50deg)
    &:after
      content ""
      position absolute
      top 12px
      left -15px
      background-color #515559
      width 85px
      height 10px
      border-radius 40% 40% 70% 70%

  .scarecrow__ribbon
    width 55px
    height 12px
    background-color #d996b5
    margin 0 auto

  .scarecrow__head
    position relative
    background-color #f2f2f2
    width 70px
    height 55px
    margin 0 auto
    border-radius 50%
    display flex
    justify-content space-around
    flex-flow row wrap

  .scarecrow__eye
    width 6px
    height 6px
    background-color #000
    border-radius 50%
    margin 20px 5px 0

  .scarecrow__mouth
    width 45px
    height 15px
    background-color #fff
    border-radius 50%

  .scarecrow__pipe
    position absolute
    top 40px
    left 60px
    width 40px
    height 2px
    background-color #8c8070
    &:before
      content ""
      position absolute
      width 9px
      height 17px
      background-color #8c8070
      border-radius 3px
      left 40px
      top -7px

  .scarecrow__body
    position relative
    width 250px
    z-index 1

  .scarecrow__coat
    position absolute
    top 15px
    left 0
    right 0
    margin-left auto
    margin-right auto
    border-top 100px solid #515559
    border-left 5px solid transparent
    border-right 5px solid transparent
    width 75px

  .scarecrow__bow
    position absolute
    top 20px
    left 0
    right 0
    margin-left auto
    margin-right auto
    background-color #3a485d
    width 10px
    height 10px
    z-index 3
    border-radius 2px
    &:before
      content ""
      position absolute
      top -10px
      left -25px
      width 0
      height 10px
      border-top 10px solid transparent
      border-left 25px solid #5a6b8c
      border-bottom 10px solid transparent
      border-radius 8px
    &:after
      content ""
      position absolute
      top -10px
      right -25px
      width 0
      height 10px
      border-top 10px solid transparent
      border-right 25px solid #5a6b8c
      border-bottom 10px solid transparent
      border-radius 8px

  .scarecrow__shirt
    position absolute
    top 8px
    left 0
    right 0
    margin-left auto
    margin-right auto
    width 30px
    height 35px
    z-index 2
    &:before
      content ""
      position absolute
      top 0
      left -5px
      height 100%
      width 70%
      background-color #dbb2c2
      transform skew(1deg, 35deg)
      border-bottom-left-radius 90px
      border-top-left-radius 15px
      border-bottom-right-radius 15px
      border-top-right-radius 10px
    &:after
      content ""
      position absolute
      top 0
      right -5px
      height 100%
      width 70%
      background-color #dbb2c2
      transform skew(-1deg, -35deg)
      border-top-right-radius 15px
      border-bottom-right-radius 90px
      border-bottom-left-radius 15px
      border-top-left-radius 10px

  .scarecrow__waistcoat
    position absolute
    top 15px
    left -1px
    right 0
    margin-left auto
    margin-right auto
    width 35px
    height 50px
    &:before
      content ""
      position absolute
      top 0
      left -4px
      height 100%
      width 65%
      background-color #83a6bc
      transform skew(0deg, 40deg)
      border-bottom-left-radius 90px
      border-top-left-radius 90px
      border-bottom-right-radius 15px
    &:after
      content ""
      position absolute
      top 0
      right -5px
      height 100%
      width 65%
      background-color #83a6bc
      transform skew(0deg, -40deg)
      border-top-right-radius 90px
      border-bottom-right-radius 90px
      border-bottom-left-radius 15px

  .scarecrow__coattails
    position absolute
    top 105px
    left 0
    right 0
    margin-left auto
    margin-right auto
    width 75px
    height 120px
    z-index 1
    &:before
      content ""
      position absolute
      top 0
      left 8px
      height 100%
      width 60%
      background-color #515559
      transform-origin top
      transform skew(-25deg, 30deg) rotate(0deg)
      border-bottom-left-radius 50px
      border-bottom-right-radius 5px
      animation coattails-left 0.2s ease-in alternate infinite
    &:after
      content ""
      position absolute
      top 0
      right 8px
      height 100%
      width 60%
      background-color #515559
      transform-origin top
      transform skew(25deg, -30deg) rotate(0deg)
      border-bottom-right-radius 50px
      border-bottom-left-radius 5px
      animation coattails-right 0.2s ease-in alternate infinite

  .scarecrow__pants
    position absolute
    top 115px
    left 0
    right 0
    margin-left auto
    margin-right auto
    width 50px
    height 150px
    &:before
      content ""
      position absolute
      top 0
      left -8px
      height 100%
      width 60%
      background-color #393c3e
      transform rotate(0deg)
      transform-origin top
      animation pants 0.5s linear alternate infinite
    &:after
      content ""
      position absolute
      top 0
      right -8px
      height 100%
      width 60%
      background-color #393c3e
      transform rotate(0deg)
      transform-origin top
      animation pants 0.3s linear alternate infinite

  .scarecrow__sleeve
    position absolute
    top 15px
    background-color #515559
    width 80px
    height 25px

  .scarecrow__sleeve--l
    left 10px
    &:before
      content ""
      position absolute
      top -3px
      left -22px
      width 0
      height 25px
      border-top 3px solid transparent
      border-left 25px solid #515559
      border-bottom 3px solid transparent
      border-radius 3px

  .scarecrow__sleeve--r
    right 10px
    &:before
      content ""
      position absolute
      top -3px
      right -22px
      width 0
      height 25px
      border-top 3px solid transparent
      border-right 25px solid #515559
      border-bottom 3px solid transparent
      border-radius 3px

  .scarecrow__glove
    position absolute
    top 12px
    width 0px
    height 12px
    &:before
      content ""
      position absolute
      top -7px
      border-radius 100%
      background-color #f2f2f2
      width 35px
      height 15px

  .scarecrow__glove--l
    border-top 3px solid transparent
    border-right 20px solid #f2f2f2
    border-bottom 3px solid transparent
    left -50px
    &:before
      transform-origin right
      left -30px
      transform rotate(0deg)
      animation glove-l 0.2s linear alternate infinite

  .scarecrow__glove--r
    border-top 3px solid transparent
    border-left 20px solid #f2f2f2
    border-bottom 3px solid transparent
    right -50px
    &:before
      transform-origin left
      right -30px
      transform rotate(0deg)
      animation glove-r 0.2s linear alternate infinite

  .scarecrow__arms
    position absolute
    left 50%
    transform translate(-50%, -50%)
    background-color #8c8070
    width 350px
    height 8px
    border-radius 5px
    margin 20px auto

  .scarecrow__leg
    position relative
    background-color #8c8070
    width 8px
    height 380px
    border-bottom-left-radius 5px
    border-bottom-right-radius 5px
    margin 0 auto

@keyframes hop
  0%
    transform translateY(-10px)
  100%
    transform translateY(10px)

@keyframes coattails-left
  0%
    transform skew(-25deg, 30deg) rotate(-3deg)
  100%
    transform skew(-25deg, 30deg) rotate(3deg)

@keyframes coattails-right
  0%
    transform skew(25deg, -30deg) rotate(3deg)
  100%
    transform skew(25deg, -30deg) rotate(-3deg)

@keyframes pants
  0%
    transform rotate(3deg)
  100%
    transform rotate(-3deg)

@keyframes glove-l
  0%
    transform rotate(-50deg)
  100%
    transform rotate(-30deg)

@keyframes glove-r
  0%
    transform rotate(50deg)
  100%
    transform rotate(30deg)

```

<!-- endtab -->

<!-- tab triangles.styl -->

```css
#loading-box
  position fixed
  z-index 1000
  width 100vw
  height 100vh
  overflow hidden
  &.loaded
    z-index -1000
    .triangles-wrap
      display none

.triangles-wrap
  position absolute
  top 50%
  left 50%
  transform translate(-50%,-66.6666666666666666%)
  -ms-transform translate(-50%,-66.6666666666666666%)
  -webkit-transform translate(-50%,-66.6666666666666666%)
  -webkit-animation animascale 2s linear alternate infinite
  animation animascale 2s linear alternate both infinite



.triangles-zero, .triangles-ein, .triangles-dvai, .triangles-trei, .triangles-feir, .triangles-fei, .triangles-sei, .triangles-seiz, .triangles-eiz
  width 0px
  height 0px
  position absolute
  top 50%
  left 50%
  transform translate(-50%,-66.6666666666666666%)
  -ms-transform translate(-50%,-66.6666666666666666%)
  -webkit-transform translate(-50%,-66.6666666666666666%)

.triangles-zero
  border-style solid
  border-width 0 5px 8.7px 5px
  border-color transparent transparent #1274b6 transparent
  -webkit-animation anima 2s linear reverse both infinite 4s, animacolorzero 2s linear alternate both infinite
  animation anima 2s linear reverse both infinite 4s, animacolorzero 2s linear alternate both infinite
  -webkit-transform-origin top left

.triangles-ein
  border-style solid
  border-width 0 10px 17.3px 10px
  border-color transparent transparent #167bbf transparent
  -webkit-animation anima 2s linear both infinite 4.2s, animacolorein 2s linear alternate both infinite
  animation anima 2s linear both infinite 4.2s, animacolorein 2s linear alternate both infinite
  -webkit-transform-origin top left

.triangles-dvai
  border-style solid
  border-width 0 20px 34.6px 20px
  border-color transparent transparent #1b82c8 transparent
  -webkit-animation anima 2s linear reverse both infinite 4.4s, animacolordvai 2s linear alternate both infinite
  animation anima 2s linear reverse both infinite 4.4s, animacolordvai 2s linear alternate both infinite
  -webkit-transform-origin top left

.triangles-trei
  border-style solid
  border-width 0 40px 69.3px 40px
  border-color transparent transparent #228bd2 transparent
  -webkit-animation anima 2s linear  both infinite 4.6s, animacolortrei 2s linear alternate both infinite
  animation anima 2s linear  both infinite 4.6s, animacolortrei 2s linear alternate both infinite
  -webkit-transform-origin top left

.triangles-feir
  border-style solid
  border-width 0 80px 138.6px 80px
  border-color transparent transparent #2992d9 transparent
  -webkit-animation anima 2s linear reverse  both infinite 4.8s, animacolorfeir 2s linear alternate both infinite
  animation anima 2s linear reverse  both infinite 4.8s, animacolorfeir 2s linear alternate both infinite
  -webkit-transform-origin top left

.triangles-fei
  border-style solid
  border-width 0 160px 277.1px 160px
  border-color transparent transparent #3498db transparent
  -webkit-animation anima 2s linear  both infinite 5s, animacolorfei 2s linear alternate both infinite
  animation anima 2s linear  both infinite 5s, animacolorfei 2s linear alternate both infinite
  -webkit-transform-origin top left

.triangles-sei
  border-style solid
  border-width 0 320px 554.3px 320px
  border-color transparent transparent #3f9edd transparent
  -webkit-animation anima 2s linear reverse  both infinite 5.2s, animacolorsei 2s linear alternate both infinite
  animation anima 2s linear reverse  both infinite 5.2s, animacolorsei 2s linear alternate both infinite
  -webkit-transform-origin top left

.triangles-seiz
  border-style solid
  border-width 0 640px 1108.5px 640px
  border-color transparent transparent #48a2de transparent
  -webkit-animation anima 2s linear  both infinite 5.4s, animacolorseiz 2s linear alternate both infinite
  animation anima 2s linear  both infinite 5.4s, animacolorseiz 2s linear alternate both infinite
  -webkit-transform-origin top left

.triangles-eiz
  border-style solid
  border-width 0 1280px 2217.0px 1280px
  border-color transparent transparent #59aae0 transparent
  -webkit-animation anima 2s linear reverse  both infinite 5.6s, animacoloreiz 2s linear alternate both infinite
  animation anima 2s linear reverse  both infinite 5.6s, animacoloreiz 2s linear alternate both infinite
  -webkit-transform-origin top left


@-webkit-keyframes anima
  from
    -webkit-transform: rotate(0deg) translate(-50%,-66.6666666666666666%)
  to
    -webkit-transform: rotate(360deg) translate(-50%,-66.6666666666666666%)


@keyframes anima
    from
      transform rotate(0deg) translate(-50%,-66.6666666666666666%)
    to
      transform rotate(360deg) translate(-50%,-66.6666666666666666%)

@-webkit-keyframes animacolorzero
{
0%{border-color: transparent transparent #1274b6 transparent;}
12.5%{border-color: transparent transparent #167bbf transparent;}
25%{border-color: transparent transparent #1b82c8 transparent;}
37.5%{border-color: transparent transparent #228bd2 transparent;}
50%{border-color: transparent transparent #2992d9 transparent;}
62.5%{border-color: transparent transparent #3498db transparent;}
75%{border-color: transparent transparent #3f9edd transparent;}
87.5%{border-color: transparent transparent #48a2de transparent;}
100%{border-color: transparent transparent #59aae0 transparent;}
}

@keyframes animacolorzero
{
0%{border-color: transparent transparent #1274b6 transparent;}
12.5%{border-color: transparent transparent #167bbf transparent;}
25%{border-color: transparent transparent #1b82c8 transparent;}
37.5%{border-color: transparent transparent #228bd2 transparent;}
50%{border-color: transparent transparent #2992d9 transparent;}
62.5%{border-color: transparent transparent #3498db transparent;}
75%{border-color: transparent transparent #3f9edd transparent;}
87.5%{border-color: transparent transparent #48a2de transparent;}
100%{border-color: transparent transparent #59aae0 transparent;}
}

@-webkit-keyframes animacolorein
{
0%{border-color: transparent transparent #167bbf transparent;}
12.5%{border-color: transparent transparent #1b82c8 transparent;}
25%{border-color: transparent transparent #228bd2 transparent;}
37.5%{border-color: transparent transparent #2992d9 transparent;}
50%{border-color: transparent transparent #3498db transparent;}
62.5%{border-color: transparent transparent #3f9edd transparent;}
75%{border-color: transparent transparent #48a2de transparent;}
87.5%{border-color: transparent transparent #59aae0 transparent;}
100%{border-color: transparent transparent #1274b6 transparent;}
}

@keyframes animacolorein
{
0%{border-color: transparent transparent #167bbf transparent;}
12.5%{border-color: transparent transparent #1b82c8 transparent;}
25%{border-color: transparent transparent #228bd2 transparent;}
37.5%{border-color: transparent transparent #2992d9 transparent;}
50%{border-color: transparent transparent #3498db transparent;}
62.5%{border-color: transparent transparent #3f9edd transparent;}
75%{border-color: transparent transparent #48a2de transparent;}
87.5%{border-color: transparent transparent #59aae0 transparent;}
100%{border-color: transparent transparent #1274b6 transparent;}
}

@-webkit-keyframes animacolordvai
{
0%{border-color: transparent transparent #1b82c8 transparent;}
12.5%{border-color: transparent transparent #228bd2 transparent;}
25%{border-color: transparent transparent #2992d9 transparent;}
37.5%{border-color: transparent transparent #3498db transparent;}
50%{border-color: transparent transparent #3f9edd transparent;}
62.5%{border-color: transparent transparent #48a2de transparent;}
75%{border-color: transparent transparent #59aae0 transparent;}
87.5%{border-color: transparent transparent #1274b6 transparent;}
100%{border-color: transparent transparent #167bbf transparent;}
}

@keyframes animacolordvai
{
0%{border-color: transparent transparent #1b82c8 transparent;}
12.5%{border-color: transparent transparent #228bd2 transparent;}
25%{border-color: transparent transparent #2992d9 transparent;}
37.5%{border-color: transparent transparent #3498db transparent;}
50%{border-color: transparent transparent #3f9edd transparent;}
62.5%{border-color: transparent transparent #48a2de transparent;}
75%{border-color: transparent transparent #59aae0 transparent;}
87.5%{border-color: transparent transparent #1274b6 transparent;}
100%{border-color: transparent transparent #167bbf transparent;}
}

@-webkit-keyframes animacolortrei
{
0%{border-color: transparent transparent #228bd2 transparent;}
12.5%{border-color: transparent transparent #2992d9 transparent;}
25%{border-color: transparent transparent #3498db transparent;}
37.5%{border-color: transparent transparent #3f9edd transparent;}
50%{border-color: transparent transparent #48a2de transparent;}
62.5%{border-color: transparent transparent #59aae0 transparent;}
75%{border-color: transparent transparent #1274b6 transparent;}
87.5%{border-color: transparent transparent #167bbf transparent;}
100%{border-color: transparent transparent #1b82c8 transparent;}
}

@keyframes animacolortrei
{
0%{border-color: transparent transparent #228bd2 transparent;}
12.5%{border-color: transparent transparent #2992d9 transparent;}
25%{border-color: transparent transparent #3498db transparent;}
37.5%{border-color: transparent transparent #3f9edd transparent;}
50%{border-color: transparent transparent #48a2de transparent;}
62.5%{border-color: transparent transparent #59aae0 transparent;}
75%{border-color: transparent transparent #1274b6 transparent;}
87.5%{border-color: transparent transparent #167bbf transparent;}
100%{border-color: transparent transparent #1b82c8 transparent;}
}

@-webkit-keyframes animacolorfeir
{
0%{border-color: transparent transparent #2992d9 transparent;}
12.5%{border-color: transparent transparent #3498db transparent;}
25%{border-color: transparent transparent #3f9edd transparent;}
37.5%{border-color: transparent transparent #48a2de transparent;}
50%{border-color: transparent transparent #59aae0 transparent;}
62.5%{border-color: transparent transparent #1274b6 transparent;}
75%{border-color: transparent transparent #167bbf transparent;}
87.5%{border-color: transparent transparent #1b82c8 transparent;}
100%{border-color: transparent transparent #228bd2 transparent;}
}

@keyframes animacolorfeir
{
0%{border-color: transparent transparent #2992d9 transparent;}
12.5%{border-color: transparent transparent #3498db transparent;}
25%{border-color: transparent transparent #3f9edd transparent;}
37.5%{border-color: transparent transparent #48a2de transparent;}
50%{border-color: transparent transparent #59aae0 transparent;}
62.5%{border-color: transparent transparent #1274b6 transparent;}
75%{border-color: transparent transparent #167bbf transparent;}
87.5%{border-color: transparent transparent #1b82c8 transparent;}
100%{border-color: transparent transparent #228bd2 transparent;}
}

@-webkit-keyframes animacolorfei
{
0%{border-color: transparent transparent #3498db transparent;}
12.5%{border-color: transparent transparent #3f9edd transparent;}
25%{border-color: transparent transparent #48a2de transparent;}
37.5%{border-color: transparent transparent #59aae0 transparent;}
50%{border-color: transparent transparent #1274b6 transparent;}
62.5%{border-color: transparent transparent #167bbf transparent;}
75%{border-color: transparent transparent #1b82c8 transparent;}
87.5%{border-color: transparent transparent #228bd2 transparent;}
100%{border-color: transparent transparent #2992d9 transparent;}
}

@keyframes animacolorfei
{
0%{border-color: transparent transparent #3498db transparent;}
12.5%{border-color: transparent transparent #3f9edd transparent;}
25%{border-color: transparent transparent #48a2de transparent;}
37.5%{border-color: transparent transparent #59aae0 transparent;}
50%{border-color: transparent transparent #1274b6 transparent;}
62.5%{border-color: transparent transparent #167bbf transparent;}
75%{border-color: transparent transparent #1b82c8 transparent;}
87.5%{border-color: transparent transparent #228bd2 transparent;}
100%{border-color: transparent transparent #2992d9 transparent;}
}

@-webkit-keyframes animacolorsei
{
0%{border-color: transparent transparent #3f9edd transparent;}
12.5%{border-color: transparent transparent #48a2de transparent;}
25%{border-color: transparent transparent #59aae0 transparent;}
37.5%{border-color: transparent transparent #1274b6 transparent;}
50%{border-color: transparent transparent #167bbf transparent;}
62.5%{border-color: transparent transparent #1b82c8 transparent;}
75%{border-color: transparent transparent #228bd2 transparent;}
87.5%{border-color: transparent transparent #2992d9 transparent;}
100%{border-color: transparent transparent #3498db transparent;}
}

@keyframes animacolorsei
{
0%{border-color: transparent transparent #3f9edd transparent;}
12.5%{border-color: transparent transparent #48a2de transparent;}
25%{border-color: transparent transparent #59aae0 transparent;}
37.5%{border-color: transparent transparent #1274b6 transparent;}
50%{border-color: transparent transparent #167bbf transparent;}
62.5%{border-color: transparent transparent #1b82c8 transparent;}
75%{border-color: transparent transparent #228bd2 transparent;}
87.5%{border-color: transparent transparent #2992d9 transparent;}
100%{border-color: transparent transparent #3498db transparent;}
}

@-webkit-keyframes animacolorseiz
{
0%{border-color: transparent transparent #48a2de transparent;}
12.5%{border-color: transparent transparent #59aae0 transparent;}
25%{border-color: transparent transparent #1274b6 transparent;}
37.5%{border-color: transparent transparent #167bbf transparent;}
50%{border-color: transparent transparent #1b82c8 transparent;}
62.5%{border-color: transparent transparent #228bd2 transparent;}
75%{border-color: transparent transparent #2992d9 transparent;}
87.5%{border-color: transparent transparent #3498db transparent;}
100%{border-color: transparent transparent #3f9edd transparent;}
}

@keyframes animacolorseiz
{
0%{border-color: transparent transparent #48a2de transparent;}
12.5%{border-color: transparent transparent #59aae0 transparent;}
25%{border-color: transparent transparent #1274b6 transparent;}
37.5%{border-color: transparent transparent #167bbf transparent;}
50%{border-color: transparent transparent #1b82c8 transparent;}
62.5%{border-color: transparent transparent #228bd2 transparent;}
75%{border-color: transparent transparent #2992d9 transparent;}
87.5%{border-color: transparent transparent #3498db transparent;}
100%{border-color: transparent transparent #3f9edd transparent;}
}

@-webkit-keyframes animacoloreiz
{
0%{border-color: transparent transparent #59aae0 transparent;}
12.5%{border-color: transparent transparent #1274b6 transparent;}
25%{border-color: transparent transparent #167bbf transparent;}
37.5%{border-color: transparent transparent #1b82c8 transparent;}
50%{border-color: transparent transparent #228bd2 transparent;}
62.5%{border-color: transparent transparent #2992d9 transparent;}
75%{border-color: transparent transparent #3498db transparent;}
87.5%{border-color: transparent transparent #3f9edd transparent;}
100%{border-color: transparent transparent #48a2de transparent;}
}

@keyframes animacoloreiz
{
0%{border-color: transparent transparent #59aae0 transparent;}
12.5%{border-color: transparent transparent #1274b6 transparent;}
25%{border-color: transparent transparent #167bbf transparent;}
37.5%{border-color: transparent transparent #1b82c8 transparent;}
50%{border-color: transparent transparent #228bd2 transparent;}
62.5%{border-color: transparent transparent #2992d9 transparent;}
75%{border-color: transparent transparent #3498db transparent;}
87.5%{border-color: transparent transparent #3f9edd transparent;}
100%{border-color: transparent transparent #48a2de transparent;}
}

@-webkit-keyframes animascale
{
0%{-webkit-transform: scale(1);}
100%{-webkit-transform: scale(1.2);}
}

@keyframes animascale
{
0%{-webkit-transform: scale(1);}
100%{-webkit-transform: scale(1.2);}
}

```

<!-- endtab -->

<!-- tab wizard.styl -->

```css
.loading-bg
  position fixed
  z-index 1000
  width 50%
  height 100%
  background var(--preloader-bg)
#loading-box
  .loading-left-bg
    @extend .loading-bg
    left 0
  .loading-right-bg
    @extend .loading-bg
    right 0
  &.loaded
    z-index -1000
    .loading-left-bg
      transition all 1.0s
      transform translate(-100%, 0)
    .loading-right-bg
      transition all 1.0s
      transform translate(100%, 0)
#loading-box
  position fixed
  z-index 1000
  display -webkit-box
  display flex
  -webkit-box-align center
  align-items center
  -webkit-box-pack center
  justify-content center
  -webkit-box-orient vertical
  -webkit-box-direction normal
  flex-direction column
  flex-wrap wrap
  width 100vw
  height 100vh
  overflow hidden

  &.loaded
    .wizard-scene
      display none

.wizard-scene
  position fixed
  z-index 1001
  display -webkit-box
  display flex

.wizard
  position relative
  width 190px
  height 240px

.wizard-body
  position absolute
  bottom 0
  left 68px
  height 100px
  width 60px
  background #3f64ce
  &::after
    content ""
    position absolute
    bottom 0
    left 20px
    height 100px
    width 60px
    background #3f64ce
    -webkit-transform skewX(14deg)
    transform skewX(14deg)

.wizard-right-arm
  position absolute
  bottom 74px
  left 110px
  height 44px
  width 90px
  background #3f64ce
  border-radius 22px
  -webkit-transform-origin 16px 22px
  transform-origin 16px 22px
  -webkit-transform rotate(70deg)
  transform rotate(70deg)
  -webkit-animation right_arm 10s ease-in-out infinite
  animation right_arm 10s ease-in-out infinite
  .right-hand
    position absolute
    right 8px
    bottom 8px
    width 30px
    height 30px
    border-radius 50%
    background #f1c5b4
    -webkit-transform-origin center center
    transform-origin center center
    -webkit-transform rotate(-40deg)
    transform rotate(-40deg)
    -webkit-animation right_hand 10s ease-in-out infinite
    animation right_hand 10s ease-in-out infinite
  .wizard-right-hand
    &::after
      content ""
      position absolute
      right 0px
      top -8px
      width 15px
      height 30px
      border-radius 10px
      background #f1c5b4
      -webkit-transform translateY(16px)
      transform translateY(16px)
      -webkit-animation right_finger 10s ease-in-out infinite
      animation right_finger 10s ease-in-out infinite

.wizard-left-arm
  position absolute
  bottom 74px
  left 26px
  height 44px
  width 70px
  background #3f64ce
  border-bottom-left-radius 8px
  -webkit-transform-origin 60px 26px
  transform-origin 60px 26px
  -webkit-transform rotate(-70deg)
  transform rotate(-70deg)
  -webkit-animation left_arm 10s ease-in-out infinite
  animation left_arm 10s ease-in-out infinite
  .wizard-left-hand
    position absolute
    left -18px
    top 0
    width 18px
    height 30px
    border-top-left-radius 35px
    border-bottom-left-radius 35px
    background #f1c5b4
    &::after
      content ""
      position absolute
      right 0
      top 0
      width 30px
      height 15px
      border-radius 20px
      background #f1c5b4
      -webkit-transform-origin right bottom
      transform-origin right bottom
      -webkit-transform scaleX(0)
      transform scaleX(0)
      -webkit-animation left_finger 10s ease-in-out infinite
      animation left_finger 10s ease-in-out infinite

.wizard-head
  position absolute
  top 0
  left 14px
  width 160px
  height 210px
  -webkit-transform-origin center center
  transform-origin center center
  -webkit-transform rotate(-3deg)
  transform rotate(-3deg)
  -webkit-animation head 10s ease-in-out infinite
  animation head 10s ease-in-out infinite
  .wizard-beard
    position absolute
    bottom 0
    left 38px
    height 106px
    width 80px
    border-bottom-right-radius 55%
    background #ffffff
    &::after
      content ""
      position absolute
      top 16px
      left -10px
      width 40px
      height 20px
      border-radius 20px
      background #ffffff
  .wizard-face
    position absolute
    bottom 76px
    left 38px
    height 30px
    width 60px
    background #f1c5b4
    &::before
      content ""
      position absolute
      top 0px
      left 40px
      width 20px
      height 40px
      border-bottom-right-radius 20px
      border-bottom-left-radius 20px
      background #f1c5b4
    &::after
      content ""
      position absolute
      top 16px
      left -10px
      width 50px
      height 20px
      border-radius 20px
      border-bottom-right-radius 0px
      background #ffffff
    .wizard-adds
      position absolute
      top 0px
      left -10px
      width 40px
      height 20px
      border-radius 20px
      background #f1c5b4
      &::after
        content ""
        position absolute
        top 5px
        left 80px
        width 15px
        height 20px
        border-bottom-right-radius 20px
        border-top-right-radius 20px
        background #f1c5b4
  .wizard-hat
    position absolute
    bottom 106px
    left 0
    width 160px
    height 20px
    border-radius 20px
    background #3f64ce
    &::before
      content ""
      position absolute
      top -70px
      left 50%
      -webkit-transform translatex(-50%)
      transform translatex(-50%)
      width 0
      height 0
      border-style solid
      border-width 0 34px 70px 50px
      border-color transparent transparent #3f64ce transparent
    &::after
      content ""
      position absolute
      top 0
      left 0
      width 160px
      height 20px
      background #3f64ce
      border-radius 20px
    .wizard-hat-of-the-hat
      position absolute
      bottom 78px
      left 79px
      width 0
      height 0
      border-style solid
      border-width 0 25px 25px 19px
      border-color transparent transparent #3f64ce transparent
      &::after
        content ""
        position absolute
        top 6px
        left -4px
        width 35px
        height 10px
        border-radius 10px
        border-bottom-left-radius 0px
        background #3f64ce
        -webkit-transform rotate(40deg)
        transform rotate(40deg)
    .wizard-four-point-star
      position absolute
      width 12px
      height 12px
      &::after
        -webkit-transform rotate(156.66deg) skew(45deg)
        transform rotate(156.66deg) skew(45deg)
      &.--first
        bottom 28px
        left 46px
      &.--second
        bottom 40px
        left 80px
      &.--third
        bottom 15px
        left 108px

.wizard-head .wizard-hat .wizard-four-point-star::after, .wizard-head .wizard-hat .wizard-four-point-star::before
  content ""
  position absolute
  background #ffffff
  display block
  left 0
  width 141.4213%
  top 0
  bottom 0
  border-radius 10%
  -webkit-transform rotate(66.66deg) skewX(45deg)
  transform rotate(66.66deg) skewX(45deg)

.wizard-objects
  position relative
  width 200px
  height 240px

.wizard-square
  position absolute
  bottom -60px
  left -5px
  width 120px
  height 120px
  border-radius 50%
  -webkit-transform rotate(-360deg)
  transform rotate(-360deg)
  -webkit-animation path_square 10s ease-in-out infinite
  animation path_square 10s ease-in-out infinite
  &::after
    content ""
    position absolute
    top 10px
    left 0
    width 50px
    height 50px
    background #9ab3f5

.wizard-circle
  position absolute
  bottom 10px
  left 0
  width 100px
  height 100px
  border-radius 50%
  -webkit-transform rotate(-360deg)
  transform rotate(-360deg)
  -webkit-animation path_circle 10s ease-in-out infinite
  animation path_circle 10s ease-in-out infinite
  &::after
    content ""
    position absolute
    bottom -10px
    left 25px
    width 50px
    height 50px
    border-radius 50%
    background #c56183

.wizard-triangle
  position absolute
  bottom -62px
  left -10px
  width 110px
  height 110px
  border-radius 50%
  -webkit-transform rotate(-360deg)
  transform rotate(-360deg)
  -webkit-animation path_triangle 10s ease-in-out infinite
  animation path_triangle 10s ease-in-out infinite
  &::after
    content ""
    position absolute
    top 0
    right -10px
    width 0
    height 0
    border-style solid
    border-width 0 28px 48px 28px
    border-color transparent transparent #89beb3 transparent


/** 10s animation - 10% = 1s */
@-webkit-keyframes right_arm
  0%
    -webkit-transform rotate(70deg)
    transform rotate(70deg)
  10%
    -webkit-transform rotate(8deg)
    transform rotate(8deg)
  15%
    -webkit-transform rotate(20deg)
    transform rotate(20deg)
  20%
    -webkit-transform rotate(10deg)
    transform rotate(10deg)
  25%
    -webkit-transform rotate(26deg)
    transform rotate(26deg)
  30%
    -webkit-transform rotate(10deg)
    transform rotate(10deg)
  35%
    -webkit-transform rotate(28deg)
    transform rotate(28deg)
  40%
    -webkit-transform rotate(9deg)
    transform rotate(9deg)
  45%
    -webkit-transform rotate(28deg)
    transform rotate(28deg)
  50%
    -webkit-transform rotate(8deg)
    transform rotate(8deg)
  58%
    -webkit-transform rotate(74deg)
    transform rotate(74deg)
  62%
    -webkit-transform rotate(70deg)
    transform rotate(70deg)

@keyframes right_arm
  0%
    -webkit-transform rotate(70deg)
    transform rotate(70deg)
  10%
    -webkit-transform rotate(8deg)
    transform rotate(8deg)
  15%
    -webkit-transform rotate(20deg)
    transform rotate(20deg)
  20%
    -webkit-transform rotate(10deg)
    transform rotate(10deg)
  25%
    -webkit-transform rotate(26deg)
    transform rotate(26deg)
  30%
    -webkit-transform rotate(10deg)
    transform rotate(10deg)
  35%
    -webkit-transform rotate(28deg)
    transform rotate(28deg)
  40%
    -webkit-transform rotate(9deg)
    transform rotate(9deg)
  45%
    -webkit-transform rotate(28deg)
    transform rotate(28deg)
  50%
    -webkit-transform rotate(8deg)
    transform rotate(8deg)
  58%
    -webkit-transform rotate(74deg)
    transform rotate(74deg)
  62%
    -webkit-transform rotate(70deg)
    transform rotate(70deg)

@-webkit-keyframes left_arm
  0%
    -webkit-transform rotate(-70deg)
    transform rotate(-70deg)
  10%
    -webkit-transform rotate(6deg)
    transform rotate(6deg)
  15%
    -webkit-transform rotate(-18deg)
    transform rotate(-18deg)
  20%
    -webkit-transform rotate(5deg)
    transform rotate(5deg)
  25%
    -webkit-transform rotate(-18deg)
    transform rotate(-18deg)
  30%
    -webkit-transform rotate(5deg)
    transform rotate(5deg)
  35%
    -webkit-transform rotate(-17deg)
    transform rotate(-17deg)
  40%
    -webkit-transform rotate(5deg)
    transform rotate(5deg)
  45%
    -webkit-transform rotate(-18deg)
    transform rotate(-18deg)
  50%
    -webkit-transform rotate(6deg)
    transform rotate(6deg)
  58%
    -webkit-transform rotate(-74deg)
    transform rotate(-74deg)
  62%
    -webkit-transform rotate(-70deg)
    transform rotate(-70deg)

@keyframes left_arm
  0%
    -webkit-transform rotate(-70deg)
    transform rotate(-70deg)
  10%
    -webkit-transform rotate(6deg)
    transform rotate(6deg)
  15%
    -webkit-transform rotate(-18deg)
    transform rotate(-18deg)
  20%
    -webkit-transform rotate(5deg)
    transform rotate(5deg)
  25%
    -webkit-transform rotate(-18deg)
    transform rotate(-18deg)
  30%
    -webkit-transform rotate(5deg)
    transform rotate(5deg)
  35%
    -webkit-transform rotate(-17deg)
    transform rotate(-17deg)
  40%
    -webkit-transform rotate(5deg)
    transform rotate(5deg)
  45%
    -webkit-transform rotate(-18deg)
    transform rotate(-18deg)
  50%
    -webkit-transform rotate(6deg)
    transform rotate(6deg)
  58%
    -webkit-transform rotate(-74deg)
    transform rotate(-74deg)
  62%
    -webkit-transform rotate(-70deg)
    transform rotate(-70deg)

@-webkit-keyframes right_hand
  0%
    -webkit-transform rotate(-40deg)
    transform rotate(-40deg)
  10%
    -webkit-transform rotate(-20deg)
    transform rotate(-20deg)
  15%
    -webkit-transform rotate(-5deg)
    transform rotate(-5deg)
  20%
    -webkit-transform rotate(-60deg)
    transform rotate(-60deg)
  25%
    -webkit-transform rotate(0deg)
    transform rotate(0deg)
  30%
    -webkit-transform rotate(-60deg)
    transform rotate(-60deg)
  35%
    -webkit-transform rotate(0deg)
    transform rotate(0deg)
  40%
    -webkit-transform rotate(-40deg)
    transform rotate(-40deg)
  45%
    -webkit-transform rotate(-60deg)
    transform rotate(-60deg)
  50%
    -webkit-transform rotate(10deg)
    transform rotate(10deg)
  60%
    -webkit-transform rotate(-40deg)
    transform rotate(-40deg)


@keyframes right_hand
  0%
    -webkit-transform rotate(-40deg)
    transform rotate(-40deg)
  10%
    -webkit-transform rotate(-20deg)
    transform rotate(-20deg)
  15%
    -webkit-transform rotate(-5deg)
    transform rotate(-5deg)
  20%
    -webkit-transform rotate(-60deg)
    transform rotate(-60deg)
  25%
    -webkit-transform rotate(0deg)
    transform rotate(0deg)
  30%
    -webkit-transform rotate(-60deg)
    transform rotate(-60deg)
  35%
    -webkit-transform rotate(0deg)
    transform rotate(0deg)
  40%
    -webkit-transform rotate(-40deg)
    transform rotate(-40deg)
  45%
    -webkit-transform rotate(-60deg)
    transform rotate(-60deg)
  50%
    -webkit-transform rotate(10deg)
    transform rotate(10deg)
  60%
    -webkit-transform rotate(-40deg)
    transform rotate(-40deg)

@-webkit-keyframes right_finger
  0%
    -webkit-transform translateY(16px)
    transform translateY(16px)
  10%
    -webkit-transform none
    transform none
  50%
    -webkit-transform none
    transform none
  60%
    -webkit-transform translateY(16px)
    transform translateY(16px)

@keyframes right_finger
  0%
    -webkit-transform translateY(16px)
    transform translateY(16px)
  10%
    -webkit-transform none
    transform none
  50%
    -webkit-transform none
    transform none
  60%
    -webkit-transform translateY(16px)
    transform translateY(16px)

@-webkit-keyframes left_finger
  0%
    -webkit-transform scaleX(0)
    transform scaleX(0)
  10%
    -webkit-transform scaleX(1) rotate(6deg)
    transform scaleX(1) rotate(6deg)
  15%
    -webkit-transform scaleX(1) rotate(0deg)
    transform scaleX(1) rotate(0deg)
  20%
    -webkit-transform scaleX(1) rotate(8deg)
    transform scaleX(1) rotate(8deg)
  25%
    -webkit-transform scaleX(1) rotate(0deg)
    transform scaleX(1) rotate(0deg)
  30%
    -webkit-transform scaleX(1) rotate(7deg)
    transform scaleX(1) rotate(7deg)
  35%
    -webkit-transform scaleX(1) rotate(0deg)
    transform scaleX(1) rotate(0deg)
  40%
    -webkit-transform scaleX(1) rotate(5deg)
    transform scaleX(1) rotate(5deg)
  45%
    -webkit-transform scaleX(1) rotate(0deg)
    transform scaleX(1) rotate(0deg)
  50%
    -webkit-transform scaleX(1) rotate(6deg)
    transform scaleX(1) rotate(6deg)
  58%
    -webkit-transform scaleX(0)
    transform scaleX(0)

@keyframes left_finger
  0%
    -webkit-transform scaleX(0)
    transform scaleX(0)
  10%
    -webkit-transform scaleX(1) rotate(6deg)
    transform scaleX(1) rotate(6deg)
  15%
    -webkit-transform scaleX(1) rotate(0deg)
    transform scaleX(1) rotate(0deg)
  20%
    -webkit-transform scaleX(1) rotate(8deg)
    transform scaleX(1) rotate(8deg)
  25%
    -webkit-transform scaleX(1) rotate(0deg)
    transform scaleX(1) rotate(0deg)
  30%
    -webkit-transform scaleX(1) rotate(7deg)
    transform scaleX(1) rotate(7deg)
  35%
    -webkit-transform scaleX(1) rotate(0deg)
    transform scaleX(1) rotate(0deg)
  40%
    -webkit-transform scaleX(1) rotate(5deg)
    transform scaleX(1) rotate(5deg)
  45%
    -webkit-transform scaleX(1) rotate(0deg)
    transform scaleX(1) rotate(0deg)
  50%
    -webkit-transform scaleX(1) rotate(6deg)
    transform scaleX(1) rotate(6deg)
  58%
    -webkit-transform scaleX(0)
    transform scaleX(0)

@-webkit-keyframes head
  0%
    -webkit-transform rotate(-3deg)
    transform rotate(-3deg)
  10%
    -webkit-transform translatex(10px) rotate(7deg)
    transform translatex(10px) rotate(7deg)
  50%
    -webkit-transform translatex(0px) rotate(0deg)
    transform translatex(0px) rotate(0deg)
  56%
    -webkit-transform rotate(-3deg)
    transform rotate(-3deg)

@keyframes head
  0%
    -webkit-transform rotate(-3deg)
    transform rotate(-3deg)
  10%
    -webkit-transform translatex(10px) rotate(7deg)
    transform translatex(10px) rotate(7deg)
  50%
    -webkit-transform translatex(0px) rotate(0deg)
    transform translatex(0px) rotate(0deg)
  56%
    -webkit-transform rotate(-3deg)
    transform rotate(-3deg)
/** 10s animation - 10% = 1s */
@-webkit-keyframes path_circle
  0%
    -webkit-transform translateY(0)
    transform translateY(0)
  10%
    -webkit-transform translateY(-100px) rotate(-5deg)
    transform translateY(-100px) rotate(-5deg)
  55%
    -webkit-transform translateY(-100px) rotate(-360deg)
    transform translateY(-100px) rotate(-360deg)
  58%
    -webkit-transform translateY(-100px) rotate(-360deg)
    transform translateY(-100px) rotate(-360deg)
  63%
    -webkit-transform rotate(-360deg)
    transform rotate(-360deg)

@keyframes path_circle
  0%
    -webkit-transform translateY(0)
    transform translateY(0)
  10%
    -webkit-transform translateY(-100px) rotate(-5deg)
    transform translateY(-100px) rotate(-5deg)
  55%
    -webkit-transform translateY(-100px) rotate(-360deg)
    transform translateY(-100px) rotate(-360deg)
  58%
    -webkit-transform translateY(-100px) rotate(-360deg)
    transform translateY(-100px) rotate(-360deg)
  63%
    -webkit-transform rotate(-360deg)
    transform rotate(-360deg)

@-webkit-keyframes path_square
  0%
    -webkit-transform translateY(0)
    transform translateY(0)
  10%
    -webkit-transform translateY(-155px) translatex(-15px) rotate(10deg)
    transform translateY(-155px) translatex(-15px) rotate(10deg)
  55%
    -webkit-transform translateY(-155px) translatex(-15px) rotate(-350deg)
    transform translateY(-155px) translatex(-15px) rotate(-350deg)
  57%
    -webkit-transform translateY(-155px) translatex(-15px) rotate(-350deg)
    transform translateY(-155px) translatex(-15px) rotate(-350deg)
  63%
    -webkit-transform rotate(-360deg)
    transform rotate(-360deg)

@keyframes path_square
  0%
    -webkit-transform translateY(0)
    transform translateY(0)
  10%
    -webkit-transform translateY(-155px) translatex(-15px) rotate(10deg)
    transform translateY(-155px) translatex(-15px) rotate(10deg)
  55%
    -webkit-transform translateY(-155px) translatex(-15px) rotate(-350deg)
    transform translateY(-155px) translatex(-15px) rotate(-350deg)
  57%
    -webkit-transform translateY(-155px) translatex(-15px) rotate(-350deg)
    transform translateY(-155px) translatex(-15px) rotate(-350deg)
  63%
    -webkit-transform rotate(-360deg)
    transform rotate(-360deg)

@-webkit-keyframes path_triangle
  0%
    -webkit-transform translateY(0)
    transform translateY(0)
  10%
    -webkit-transform translateY(-172px) translatex(10px) rotate(-10deg)
    transform translateY(-172px) translatex(10px) rotate(-10deg)
  55%
    -webkit-transform translateY(-172px) translatex(10px) rotate(-365deg)
    transform translateY(-172px) translatex(10px) rotate(-365deg)
  58%
    -webkit-transform translateY(-172px) translatex(10px) rotate(-365deg)
    transform translateY(-172px) translatex(10px) rotate(-365deg)
  63%
    -webkit-transform rotate(-360deg)
    transform rotate(-360deg)

@keyframes path_triangle
  0%
    -webkit-transform translateY(0)
    transform translateY(0)
  10%
    -webkit-transform translateY(-172px) translatex(10px) rotate(-10deg)
    transform translateY(-172px) translatex(10px) rotate(-10deg)
  55%
    -webkit-transform translateY(-172px) translatex(10px) rotate(-365deg)
    transform translateY(-172px) translatex(10px) rotate(-365deg)
  58%
    -webkit-transform translateY(-172px) translatex(10px) rotate(-365deg)
    transform translateY(-172px) translatex(10px) rotate(-365deg)
  63%
    -webkit-transform rotate(-360deg)
    transform rotate(-360deg)

```

<!-- endtab -->

{% endtabs %}

## ä¿®æ”¹ loading.styl

æ–‡ä»¶è·¯å¾„ä¸º: `themes/anzhiyu/source/css/_global/loading.styl`, ä¿®æ”¹ä¸ºæ ¹æ®é…ç½®åŠ è½½å¯¹åº”çš„æ ·å¼æ–‡ä»¶:


```css
if hexo-config('preloader.enable')
  if hexo-config('preloader.source') == 'car'
    @import '../_layout/_load_style/car.css'
    @import '../_layout/_load_style/car'
  else if hexo-config('preloader.source') == 'heo'
    @import '../_layout/_load_style/heo'
  else if hexo-config('preloader.source') == 'gear'
    @import '../_layout/_load_style/gear'
  else if hexo-config('preloader.source') == 'ironheart'
    @import '../_layout/_load_style/ironheart'
  else if hexo-config('preloader.source') == 'scarecrow'
    @import '../_layout/_load_style/scarecrow'
  else if hexo-config('preloader.source') == 'triangles'
    @import '../_layout/_load_style/triangles'
  else if hexo-config('preloader.source') == 'wizard'
    @import '../_layout/_load_style/wizard'
  else if hexo-config('preloader.source') == 'image'
    @import '../_layout/_load_style/image'
  else if hexo-config('preloader.source') == 'default'
    @import '../_layout/_load_style/default'
  else
    @import '../_layout/_load_style/heo'
```

## ä¿®æ”¹ä¸»é¢˜é…ç½®

```yaml
# Loading Animation (åŠ è½½åŠ¨ç”»)
preloader:
  enable: true
  # load_styleï¼šæ§åˆ¶åŠ è½½åŠ¨ç”»çš„æ ·å¼
  # car å°æ±½è½¦
  # heo heoå¼ æ´ªåŒæ¬¾
  # default æ˜¯ä¸»é¢˜åŸç‰ˆçš„ç›’å­åŠ è½½åŠ¨ç”»
  # gear æ˜¯æ—‹è½¬é½¿è½®åŠ è½½åŠ¨ç”»
  # ironheart æ˜¯é’¢é“ä¾ æ ¸å¿ƒåŠ è½½åŠ¨ç”»
  # scarecrow æ˜¯ç¨»è‰äººè·³åŠ¨åŠ è½½åŠ¨ç”»
  # triangles æ˜¯æ—‹è½¬ä¸‰è§’åŠ è½½åŠ¨ç”»
  # wizard æ˜¯å·«å¸ˆæ–½æ³•åŠ è½½åŠ¨ç”»
  # image ä¸ºè‡ªå®šä¹‰æ·»åŠ é™æ€å›¾ç‰‡æˆ–gifä½œä¸ºåŠ è½½åŠ¨ç”»
  # https://blog.anheyu.com/posts/52d8.html https://blog.zhheo.com/p/32776e99.html https://blog.meta-code.top/2022/06/18/2022-73/
  source: car
  # pace theme (see https://codebyzach.github.io/pace/)
  pace_css_url: 
  avatar: # è‡ªå®šåŠ è½½åŠ¨ç”»ä¹‰å¤´åƒ, heo åŠ¨ç”»ä½¿ç”¨
  load_color: '#37474f'
  load_image: https://images.unsplash.com/photo-1572666341285-c8cb9790ca50?q=80&w=6000&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D # image åŠ¨ç”»ä½¿ç”¨
```

**é…ç½®é¡¹å‚æ•°è¯´æ˜**:

- enableï¼š æ§åˆ¶åŠ è½½åŠ¨ç”»çš„å¼€å…³ï¼Œå–å€¼æœ‰trueå’Œfalseï¼Œtrueå¼€å¯ï¼Œfalseå…³é—­ã€‚
- load_colorï¼š è¯¥é…ç½®é¡¹ä¸ºè‡ªå®šä¹‰åŠ è½½åŠ¨ç”»èƒŒæ™¯é¢œè‰²ã€‚é»˜è®¤å€¼ä¸º `#37474f`,ä½¿ç”¨æ—¶æ³¨æ„ç”¨å•å¼•å·''åŒ…èµ·æ¥ï¼Œä¸ç„¶ä¼šè¢«è¯†åˆ«æˆæ³¨é‡Šç¬¦ã€‚è¿™ä¸ªé…ç½®é¡¹æœ€å¤§çš„ä½œç”¨æ˜¯é…åˆload_imageä½¿ç”¨çš„å›¾ç‰‡çš„èƒŒæ™¯è‰²ï¼Œå¯ä»¥ç”¨å–è‰²å™¨æå–è‡ªå®šä¹‰å›¾ç‰‡çš„ä¸»è¦è‰²è°ƒï¼Œä»¥è¾¾åˆ°å›¾ç‰‡å’ŒèƒŒæ™¯èä¸ºä¸€ä½“çš„æ•ˆæœã€‚
- sourceï¼š æ§åˆ¶åŠ è½½åŠ¨ç”»çš„æ ·å¼:
  - car: å°æ±½è½¦
  - heo: heoå¼ æ´ªåŒæ¬¾
  - default: æ˜¯ä¸»é¢˜åŸç‰ˆçš„ç›’å­åŠ è½½åŠ¨ç”»
  - gear: æ˜¯æ—‹è½¬é½¿è½®åŠ è½½åŠ¨ç”»
  - ironheart: æ˜¯é’¢é“ä¾ æ ¸å¿ƒåŠ è½½åŠ¨ç”»
  - scarecrow: æ˜¯ç¨»è‰äººè·³åŠ¨åŠ è½½åŠ¨ç”»
  - triangles: æ˜¯æ—‹è½¬ä¸‰è§’åŠ è½½åŠ¨ç”»
  - wizard: æ˜¯å·«å¸ˆæ–½æ³•åŠ è½½åŠ¨ç”»
  - image: ä¸ºè‡ªå®šä¹‰æ·»åŠ é™æ€å›¾ç‰‡æˆ–gifä½œä¸ºåŠ è½½åŠ¨ç”»ã€‚
- load_imageï¼šè¯¥é…ç½®é¡¹çš„ç”Ÿæ•ˆå‰ææ˜¯ load_style è®¾ç½®ä¸º image,å†…å®¹å¡«å†™å›¾åºŠé“¾æ¥æˆ–è€…æœ¬åœ°ç›¸å¯¹åœ°å€ã€‚

## é—®é¢˜å‚è€ƒ

æŒ‰ç…§ä¸Šè¿°é…ç½®å®Œæˆå, åªéœ€è¦ä¿®æ”¹ä¸»é¢˜é…ç½®å³å¯æ–¹ä¾¿åˆ‡æ¢ loading åŠ¨ç”»æ ·å¼.

ä¸Šè¿°é™¤äº† car loading åŠ¨ç”»è·ŸåŸåšå®¢æœ‰å·®å¼‚å¤–(ä¸»è¦æ˜¯åšäº†ä¸»é¢˜é€‚é…), å…¶ä»–é…ç½®é¡¹è·Ÿ [ã€Hexoåšå®¢ã€‘è‡ªå®šä¹‰Butterflyä¸»é¢˜ Loading åŠ è½½åŠ¨ç”»](https://blog.meta-code.top/2022/06/18/2022-73/) å®Œå…¨ä¸€è‡´(é™¤äº†æ–‡ä»¶è·¯å¾„).

å…¶ä»–é—®é¢˜å¯å‚è€ƒåŸåšå®¢:

{% link ã€Hexoåšå®¢ã€‘è‡ªå®šä¹‰Butterflyä¸»é¢˜ Loading åŠ è½½åŠ¨ç”», ç™¾é‡Œé£æ´‹ Barry-Flynn, https://blog.meta-code.top/2022/06/18/2022-73/ %}

## [ä¸º Hexo æ·»åŠ ç»Ÿè®¡åŠŸèƒ½ï¼šDocker éƒ¨ç½² Busuanzi æœåŠ¡æ•™ç¨‹](https://blog.dong4j.site/posts/a83edbc6.md)

![/images/cover/20250103184959_OX6XnOyd.webp](https://cdn.dong4j.site/source/image/20250103184959_OX6XnOyd.webp)

[[hexo-hitokoto|è‡ªå»º Hitokoto æœåŠ¡]]
[[hexo-rss|Hexo æ·»åŠ  RSS è®¢é˜…åŠŸèƒ½]]
[[hexo-load|Hexo è‡ªå®šä¹‰åŠ è½½åŠ¨ç”»]]

## ç®€ä»‹

åŒæ ·æ˜¯å› ä¸ºé»˜è®¤çš„ `https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js` å·²æ— æ³•æ‰“å¼€, æ‰€ä»¥å‚è€ƒ [self-hosted busuanzi](https://github.com/soxft/busuanzi) åœ¨æœ¬åœ°æœåŠ¡å™¨è‡ªå»ºä¸€ä¸ª.

## éƒ¨ç½²

æ ¹æ® [å®˜æ–¹æ–‡æ¡£](https://gitee.com/soxft/busuanzi/wikis/install) ä½¿ç”¨ docker-compose ç›´æ¥éƒ¨ç½²:

```yaml
services:
  busuanzi:
    image: xcsoft/busuanzi:latest
    ports:
      - 8888:8080
    volumes:
      - ./data/config.yaml:/app/config.yaml
      # å¦‚æœä¸éœ€è¦ä¿®æ”¹é¦–é¡µ, å¯ä»¥ä¸éœ€è¦æŒ‚è½½
      - ./data/dist/index.html:/app/dist/index.html
    environment:
      WEB_LOG: true
      WEB_DEBUG: false
      WEB_CORS: "*"
      BSZ_EXPIRE: 0
      BSZ_SECRET: ç»™ä¸€ä¸ª uuid å³å¯
      API_SERVER: éœ€è¦ä¿®æ”¹æˆæœ€åç»‘å®šä½ çš„åŸŸå
      REDIS_ADDRESS: redis-ip:redis-port
      REDIS_PASSWORD: password
      REDIS_DATABASE: 0
      BSZ_PATHSTYLE: true
      BSZ_ENCRYPT: MD516
```

é…ç½®æ–‡ä»¶:

```yaml
Web:
  Address: 0.0.0.0:8080 # ç›‘å¬åœ°å€
  Cors: "https://xsot.cn,https://google.com" # è·¨åŸŸè®¿é—®
  Debug: false # æ˜¯å¦å¼€å¯debugæ¨¡å¼
  Log: false # æ˜¯å¦å¼€å¯æ—¥å¿—
Redis:
  Address: redis:6379 # redisåœ°å€
  Password:
  Database: 0
  TLS: false # æ˜¯å¦ä½¿ç”¨TLSè¿æ¥redis
  Prefix: bsz # rediså‰ç¼€
  MaxIdle: 25 # æœ€å¤§ç©ºé—²è¿æ¥æ•°
  MaxActive: 100 # æœ€å¤§è¿æ¥æ•°
  MinIdle: 25 # æœ€å°ç©ºé—²è¿æ¥æ•°
  MaxRetries: 3 # æœ€å¤§é‡è¯•æ¬¡æ•°
Bsz:
  Expire: 0 # ç»Ÿè®¡æ•°æ®è¿‡æœŸæ—¶é—´ å•ä½ç§’, è¯·è¾“å…¥æ•´æ•° (æ— ä»»ä½•è®¿é—®, è¶…è¿‡è¿™ä¸ªæ—¶é—´å, ç»Ÿè®¡æ•°æ®å°†è¢«æ¸…ç©º, 0ä¸ºä¸è¿‡æœŸ)
  Secret: "bsz" # JWTç­¾åå¯†é’¥ // è¯·è®¾ç½®ä¸ºä»»æ„é•¿åº¦çš„éšæœºå€¼
  Encrypt: "MD516" # åŠ å¯†ç®—æ³• (MD516 / MD532) è€ç‰ˆæœ¬è¯·ä½¿ç”¨ MD532
  PathStyle: true # è·¯å¾„æ ·å¼ (false: url&path, true: path) è€ç‰ˆæœ¬è¯·ä½¿ç”¨ false,  true æ›´ä¾¿äºæ•°æ®è¿ç§»

# TIPS, æ‰€æœ‰ config å†…çš„è®¾ç½®, å‡å¯ä½¿ç”¨ ç¯å¢ƒå˜é‡ è¦†ç›–
# Ex BSZ_SECRET=123 å°†è¦†ç›– config.yaml ä¸­çš„ Bsz.Secret
```

ä¸Šè¿°çš„é…ç½®æ–‡ä»¶æ˜¯å®˜æ–¹æä¾›çš„, æˆ‘æœªåšä»»ä½•ä¿®æ”¹, å› ä¸ºåœ¨ docker-compose.yml ä¸­éƒ½å¯ä»¥ç›´æ¥è¦†ç›–.

éƒ¨ç½²åè®¿é—® `http://ip:8888` æ£€æŸ¥æ˜¯å¦éƒ¨ç½²æˆåŠŸ:

![20241229154732_dxuLdyt7.webp](https://cdn.dong4j.site/source/image/20241229154732_dxuLdyt7.webp)

æˆ‘åœ¨ä¸Šé¢æŒ‚è½½äº† `index.html` æ˜¯å› ä¸ºéœ€è¦ä¿®æ”¹ `<script async src="https://åŸŸå/js"></script>` ä¸ç„¶å°±æ˜¯å®˜æ–¹é»˜è®¤çš„.

## Hexo é…ç½®

### ä¿®æ”¹ä¸»é¢˜é…ç½®

```yaml
CDN:
  ...
  option:
    busuanzi: https://ä½ çš„åŸŸå/js # http://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js é»˜è®¤çš„æ„æ— æ³•æ‰“å¼€
```

### ä¿®æ”¹ä¸»é¢˜ä»£ç 

ä¿®æ”¹æ–‡ä»¶ `themes/anzhiyu/layout/includes/additional-js.pug`

å°†ä¸€ä¸‹ä»£ç :

```javascript
script(async data-pjax src= theme.asset.busuanzi || '//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js')'
```

ä¿®æ”¹ä¸º:

```javascript
script(async data-pjax data-prefix="busuanzi_value" src= theme.asset.busuanzi || '//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js')
```

è®°å¾—ä¸€å®šè¦åŠ ä¸Š `data-prefix="busuanzi_value"`, [æ–°è€ç‰ˆæœ¬å…¼å®¹é—®é¢˜çš„å¤„ç†](https://busuanzi.apifox.cn/doc-5083722).

æœ€å Hexo ä¸‰è¿å‡»å³å¯æ˜¾ç¤ºæ•ˆæœ.

## [ç”¨ Docker éƒ¨ç½² Hitokoto APIï¼Œè®©ä½ çš„ Hexo ä¸»é¢˜æ›´é…·ï¼](https://blog.dong4j.site/posts/dd32a18c.md)

![/images/cover/Hitokoto.png](https://cdn.dong4j.site/source/image/Hitokoto.png)

## å‰è¨€

æœ€è¿‘ä½¿ç”¨çš„ Hexo ä¸»é¢˜ [hexo-theme-anzhiyu](https://github.com/anzhiyu-c/hexo-theme-anzhiyu) é»˜è®¤çš„éšæœºä¸€è¨€æ¥å£è¢«é™æµäº†, æ ¹æ®å®˜æ–¹æ–‡æ¡£åœ¨å®¶é‡Œçš„æœåŠ¡å™¨ä¸Šæ­å»ºäº†ä¸€ä¸ª, ç›®å‰ç”¨äºæˆ‘çš„åšå®¢.

## éƒ¨ç½²

æ ¹æ® [å®˜æ–¹æ–‡æ¡£](https://github.com/hitokoto-osc/hitokoto-api) ä½¿ç”¨ docker-compose éƒ¨ç½²:

```yml
services:
  hitokoto_api:
    image: hitokoto/api:release
    container_name: hitokoto_api
    hostname: hitokoto_api
    environment:
      NODE_ENV: production
      url: https://ä½ çš„åŸŸå
      api_name: blog
      redis.host: ä½ çš„ redis ip
      redis.port: ä½ çš„ redis ç«¯å£
      redis.password: ä½ çš„ redis å¯†ç 
      redis.database: ä½ çš„ redis æ•°æ®åº“
    ports:
      - 8888:8000
    restart: unless-stopped
    volumes:
      - ./data:/usr/src/app/data
```

é…ç½®æ–‡ä»¶:

```yaml
name: "hitokoto" # æœåŠ¡åç§°ï¼Œä¾‹å¦‚ï¼šhitokoto
url: "https://v1.hitokoto.cn" # æœåŠ¡åœ°å€ï¼Œä¾‹å¦‚ï¼šhttps://v1.hitokoto.cn
api_name: "demo_prprpr" # æœåŠ¡æ ‡è¯†ï¼Œå–ä¸ªå¥½åŒºåˆ†çš„æ ‡è¯†å§ï¼Œä¾‹å¦‚ï¼šcd-01-demo
server: # é…ç½® HTTP æœåŠ¡çš„ä¿¡æ¯
  host: 127.0.0.1 # ç›‘å¬çš„åœ°å€
  port: 8000 # ç›‘å¬çš„ç«¯å£
  compress_body: true # æ˜¯å¦ä½¿ç”¨ GZIP å‹ç¼©
redis: # é…ç½® Redis
  host: 127.0.0.1 # Redis ä¸»æœºå
  port: 6379 # Redis ç«¯å£
  password: "" # Redis å¯†ç 
  database: 0 # Redis æ•°æ®åº“
sentences_ab_switcher: # æœ¬èŠ‚æ˜¯æœåŠ¡ AB å¼‚æ­¥æ›´æ–°çš„é…ç½®ï¼Œå¦‚æœæ‚¨ä¸çŸ¥é“è¿™ä¸ªæ˜¯ä»€ä¹ˆæ„æ€ï¼Œè¯·ä¿æŒé»˜è®¤
  a: 1 # a çŠ¶æ€å¯¹åº”çš„ redis æ•°æ®åº“
  b: 2 # b çŠ¶æ€å¯¹åº”çš„ redis æ•°æ®åº“
remote_sentences_url: https://cdn.jsdelivr.net/gh/hitokoto-osc/sentences-bundle@latest/ # è¯­å¥åº“åœ°å€ï¼Œé€šå¸¸é»˜è®¤å³å¯ã€‚å¦‚æœæ‚¨æƒ³ä½¿ç”¨æ‚¨è‡ªå·±æ‰“åŒ…éƒ¨ç½²çš„è¯­å¥åº“ï¼Œæ‚¨å¯ä»¥ä¿®æ”¹æ­¤é¡¹
workers: 1 # å¯åŠ¨ Worker æ•°ç›®ã€‚0 è¡¨ç¤ºå¯åŠ¨å’Œ CPU æ ¸å¿ƒæ•°ç›¸åŒæ•°é‡çš„ Worker
extensions: # æ§åˆ¶æ‰©å±•
  netease: true # ç½‘æ˜“äº‘éŸ³ä¹æ¥å£
requests:
  enabled: false # æ˜¯å¦å¯ç”¨è¯·æ±‚æ•°ç›®ç»Ÿè®¡
  hosts: # éœ€è¦å•ç‹¬ç»Ÿè®¡çš„ä¸»æœºå
    - sslapi.hitokoto.cn
telemetry: # é¥æµ‹æœåŠ¡
  performance: false # æ€§èƒ½ç›‘æ§
  error: false # é”™è¯¯æŠ¥å‘Š
  usage: false # ä½¿ç”¨æŠ¥å‘Š
  debug: false # æ˜¯å¦å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆè¯¥æ¨¡å¼ä¼šè®©é¥æµ‹æœåŠ¡æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼‰
```

ä¸Šé¢å®˜æ–¹çš„é…ç½®æ–‡ä»¶æˆ‘åªå°† `requests` å’Œ `telemetry` å…³é—­äº†, å› ä¸ºæˆ‘å¹¶ä¸éœ€è¦è¿™äº›åŠŸèƒ½.

éƒ¨ç½²åè‡ªå·±è®¿é—® ip:port æµ‹è¯•æ˜¯å¦æ­£å¸¸:

```json
ä¿å­˜
{
    "id": 9241,
    "uuid": "a444bb92-9800-4b8e-a3ab-054ade2e78a2",
    "hitokoto": "ç”Ÿæ´»å’Œæ¼«ç”»é‡Œé¢çš„é‚£ç§çƒ­è¡€è¿˜æ˜¯ä¸ä¸€æ ·çš„ã€‚",
    "type": "h",
    "from": "å½±è§†é£“é£",
    "from_who": "Tim",
    "creator": "wssb",
    "creator_uid": 14374,
    "reviewer": 4756,
    "commit_from": "web",
    "created_at": "1679128135",
    "length": 19
}
```

å¦‚æœæ²¡é—®é¢˜å°±æ˜¯åŸŸåé…ç½®äº†, è¿™éƒ¨åˆ†å°±å¿½ç•¥äº†

## Hexo é…ç½®

å®‰çŸ¥é±¼æœ‰ 2 ä¸ªåœ°æ–¹ä¼šç”¨åˆ°éšæœºä¸€è¨€:

```yaml
# Footer Settings
footer:
  list:
    enable: true
    ...
    subTitle:
      enable: true
      ...
      # source è°ƒç”¨ç¬¬ä¸‰æ–¹æœåŠ¡
      # source: false å…³é—­è°ƒç”¨
      # source: 1  è°ƒç”¨ä¸€è¨€ç½‘çš„ä¸€å¥è¯ï¼ˆç®€ä½“ï¼‰ https://hitokoto.cn/
      # source: 2  è°ƒç”¨ä¸€å¥ç½‘ï¼ˆç®€ä½“ï¼‰ http://yijuzhan.com/
      # source: 3  è°ƒç”¨ä»Šæ—¥è¯—è¯ï¼ˆç®€ä½“ï¼‰ https://www.jinrishici.com/
      # source: 4  è°ƒç”¨ä¸€è¨€ç½‘çš„ä¸€å¥è¯ï¼ˆç®€ä½“ï¼‰ https://hitokoto.dong4j.ink:1024
      # subtitle ä¼šå…ˆæ˜¾ç¤º source , å†æ˜¾ç¤º sub çš„å†…å®¹
      source: 4
      ...
```

```yaml
# the subtitle on homepage (ä¸»é¡µsubtitle)
subtitle:
  enable: true
  # source è°ƒç”¨ç¬¬ä¸‰æ–¹æœåŠ¡
  # source: false å…³é—­è°ƒç”¨
  # source: 1  è°ƒç”¨ä¸€è¨€ç½‘çš„ä¸€å¥è¯ï¼ˆç®€ä½“ï¼‰ https://hitokoto.cn/
  # source: 2  è°ƒç”¨ä¸€å¥ç½‘ï¼ˆç®€ä½“ï¼‰ http://yijuzhan.com/
  # source: 3  è°ƒç”¨ä»Šæ—¥è¯—è¯ï¼ˆç®€ä½“ï¼‰ https://www.jinrishici.com/
  # source: 4  è°ƒç”¨ä¸€è¨€ç½‘çš„ä¸€å¥è¯ï¼ˆç®€ä½“ï¼‰ https://hitokoto.dong4j.ink:1024
  # subtitle ä¼šå…ˆæ˜¾ç¤º source , å†æ˜¾ç¤º sub çš„å†…å®¹
  source: 4
  ...
```

åŸæ¥é…ç½®çš„ `source` åªæœ‰ 3 ä¸ªé€‰æ‹©, è¿™é‡Œæ–°å¢ä¸€ä¸ª, ç„¶åä¿®æ”¹ `themes/anzhiyu/layout/includes/third-party/footerBarSubtitle.pug` æ–‡ä»¶:

ç›´æ¥æ‹·è´ä¸‹é¢çš„ä»£ç åˆ°æŒ‡å®šä½ç½®å³å¯:

```pug
when 4
    script.
      function subtitleType () {
        fetch('https://ä½ ç»‘å®šçš„åŸŸå')
          .then(response => response.json())
          .then(data => {
            if (!{effect}) {
              const from = 'å‡ºè‡ª ' + data.from
              const sub = !{JSON.stringify(subContent)}
              sub.unshift(data.hitokoto, from)
              window.typed = new Typed('#footer-type-tips', {
                strings: sub,
                startDelay: !{startDelay},
                typeSpeed: !{typeSpeed},
                loop: !{loop},
                backSpeed: !{backSpeed},
              })
            } else {
              document.getElementById('footer-type-tips').innerHTML = data.hitokoto
            }
          })
      }

      if (!{effect}) {
        if (typeof Typed === 'function') {
          subtitleType()
        } else {
          getScript('!{url_for(theme.asset.typed)}').then(subtitleType)
        }
      } else {
        subtitleType()
      }
```

æœ€å Hexo ä¸‰è¿å‡»å³å¯æ˜¾ç¤ºæ•ˆæœ, æ¯”å®˜æ–¹çš„å¿«çš„å¤š.

## [Hexo åšå®¢å‡çº§æŒ‡å—ï¼šé›†æˆ RSS è®¢é˜…](https://blog.dong4j.site/posts/65647068.md)

![/images/cover/20250103184959_gB2NVpXf.webp](https://cdn.dong4j.site/source/image/20250103184959_gB2NVpXf.webp)

Hexo åšå®¢æ·»åŠ  RSS è®¢é˜…åŠŸèƒ½ æ’ä»¶ GitHub [https://github.com/hexojs/hexo-generator-feed](https://github.com/hexojs/hexo-generator-feed) å®‰è£… hexo......

è¿™ç¯‡æ–‡ç« ä»‹ç»äº†å¦‚ä½•åœ¨ Hexo åšå®¢ä¸­æ·»åŠ  RSS è®¢é˜…åŠŸèƒ½ã€‚éœ€è¦ä½¿ç”¨æ—¶å…‰æ’ä»¶ï¼Œå¹¶æä¾›äº† GitHub åœ°å€ã€‚åœ¨é…ç½® RSS æ—¶ï¼Œå¯ä»¥é€‰æ‹©åŸå­æˆ– RSS2 çš„ç±»å‹ï¼Œè®¾ç½®æ–‡ä»¶è·¯å¾„ï¼Œå†³å®šå±•ç¤ºæ–‡ç« çš„æ•°é‡ï¼Œè¿˜å¯ä»¥é€‰æ‹©åŒ…å«æ–‡ç« çš„å…¨éƒ¨å†…å®¹æˆ–æ‘˜è¦ã€‚åŒæ—¶ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰è®¢é˜…å›¾æ ‡å’Œè®¢é˜…å†…å®¹çš„é¡ºåºã€‚åœ¨éƒ¨ç½²åï¼Œç›´æ¥åœ¨æ ¹ç›®å½•ä¸­è®¿é—®é…ç½®çš„æ–‡ä»¶å³å¯ä½¿ç”¨ RSS è®¢é˜…åŠŸèƒ½ã€‚

æ’ä»¶ GitHub åœ°å€ï¼š[https://github.com/hexojs/hexo-generator-feed](https://github.com/hexojs/hexo-generator-feed)

## å®‰è£… `hexo-generator-feed` æ’ä»¶

```bash
npm install hexo-generator-feed --save
```

## ä¿®æ”¹ `_config.yml` é…ç½®

```yaml
feed:
  type: atom
  path: atom.xml
  limit: false
```

`type`: RSS çš„ç±»å‹ (atom/rss2)  
`path`: æ–‡ä»¶è·¯å¾„ï¼Œé»˜è®¤æ˜¯ atom.xml/rss2.xml  
`limit`: å±•ç¤ºæ–‡ç« çš„æ•°é‡, ä½¿ç”¨ 0 æˆ–åˆ™ false ä»£è¡¨å±•ç¤ºå…¨éƒ¨  
`hub`: URL of the PubSubHubbub hubs (å¦‚æœä½¿ç”¨ä¸åˆ°å¯ä»¥ä¸ºç©º)  
`content`: ï¼ˆå¯é€‰ï¼‰è®¾ç½® true å¯ä»¥åœ¨ RSS æ–‡ä»¶ä¸­åŒ…å«æ–‡ç« å…¨éƒ¨å†…å®¹ï¼Œé»˜è®¤ï¼šfalse  
`content_limit`: ï¼ˆå¯é€‰ï¼‰æ‘˜è¦ä¸­ä½¿ç”¨çš„å¸–å­å†…å®¹çš„é»˜è®¤é•¿åº¦ã€‚ ä»…åœ¨å†…å®¹è®¾ç½®ä¸º false ä¸”æœªæ˜¾ç¤ºè‡ªå®šä¹‰å¸–å­æè¿°æ—¶æ‰ä½¿ç”¨ã€‚  
`content_limit_delim`: ï¼ˆå¯é€‰ï¼‰å¦‚æœ content_limit ç”¨äºç¼©çŸ­ post å†…å®¹ï¼Œåˆ™ä»…åœ¨æ­¤åˆ†éš”ç¬¦çš„æœ€åä¸€æ¬¡å‡ºç°æ—¶è¿›è¡Œå‰ªåˆ‡ï¼Œç„¶åæ‰è¾¾åˆ°å­—ç¬¦é™åˆ¶ã€‚é»˜è®¤ä¸ä½¿ç”¨ã€‚  
`icon`: ï¼ˆå¯é€‰ï¼‰è‡ªå®šä¹‰è®¢é˜…å›¾æ ‡ï¼Œé»˜è®¤è®¾ç½®ä¸ºä¸»é…ç½®ä¸­æŒ‡å®šçš„å›¾æ ‡ã€‚  
`order_by`: è®¢é˜…å†…å®¹çš„é¡ºåºã€‚ (é»˜è®¤: -date)

## ä¿®æ”¹ä¸»é¢˜é…ç½®

```yaml
rss: /atom.xml
```

## é‡æ–°ç”Ÿæˆé™æ€æ–‡ä»¶

```bash
hexo clean && hexo g
```

åœ¨ `public` æ–‡ä»¶å¤¹ä¸­ä¼šç”Ÿæˆ `atom.xml` æ–‡ä»¶ï¼Œéƒ¨ç½²åç›´æ¥åœ¨æ ¹ç›®å½•ä¸­è®¿é—®è¯¥æ–‡ä»¶å³å¯ã€‚

## [Spring Boot 3.3.x è„šæ‰‹æ¶é‡æ„ï¼šä¼ä¸šçº§åº”ç”¨å®è·µ](https://blog.dong4j.site/posts/321ba84a.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## å‰è¨€

åœ¨è€ä¸œå®¶èŠ±äº†ä¸€å¹´çš„æ—¶é—´ï¼ŒåŸºäºå½“æ—¶æœ€æ–°çš„ Spring Boot 2.5.x å†™äº†ä¸€å¥—è„šæ‰‹æ¶å·¥ç¨‹ï¼Œç»è¿‡ 1 å¹´å¤šçš„è¿­ä»£, è¿™å¥—è„šæ‰‹æ¶å·²åœ¨æŠ€æœ¯ä¸­å¿ƒå¤šä¸ªéƒ¨åˆ†åº”ç”¨.

è„šæ‰‹æ¶åŒ…å«æœ€åº•å±‚çš„ maven ä¾èµ–ç®¡ç†, å¯ä»¥è¯´æ˜¯æ•´ä¸ªå·¥ç¨‹çš„çµé­‚, æœŸé—´é‡æ„è¿‡ 3 æ¬¡, è¿™ä¸ªåé¢å†è¯´.
ç¬¬äºŒå±‚æ˜¯æ ¸å¿ƒæ¨¡å—å±‚, å°±æ˜¯æˆ‘ä»¬å¸¸è§çš„ core åŒ…, ä½†æ˜¯ä¹Ÿåˆ†ä¸ºè‡³å°‘ 8 å¤§æ¨¡å—.
ç¬¬ä¸‰å±‚æ˜¯åŸºäº Spring Boot 2.5.x å°è£…çš„ starter å±‚, è¿™ä¸ªå±‚æ˜¯æ•´ä¸ªè„šæ‰‹æ¶å·¥ç¨‹çš„ç²¾é«“æ‰€åœ¨, ä¹Ÿæ˜¯æˆ‘ä»¬åç»­è¦é‡ç‚¹ä»‹ç»çš„.
ç¬¬å››å±‚æ˜¯æ”¯æ’‘å±‚, åŒ…æ‹¬ Maven æ’ä»¶å’Œ IDEA æ’ä»¶.
æœ€åå½“ç„¶æ˜¯ç¤ºä¾‹å·¥ç¨‹, åŒ…å«æ¯ä¸ª starter ç»„ä»¶çš„ä½¿ç”¨æ–¹å¼.

å†™è¿™å¥—è„šæ‰‹æ¶çš„æ—¶å€™æ­£å¥½èµ¶ä¸Š **ä¸šåŠ¡ä¸­å°** ç«çƒ­çš„æ—¶æœŸ, å› æ­¤æ¯”å¦‚é€šç”¨çš„ ç”¨æˆ·ä¸­å¿ƒ, æ”¯ä»˜ä¸­å¿ƒç­‰ä¹Ÿåº”è¿è€Œç”Ÿ, ä½†æ˜¯è¿™éƒ¨åˆ†æ¶‰åŠåˆ°å…¬å¸çš„ä¸šåŠ¡æµç¨‹, åé¢å°†ä¸ä¼šè¿‡å¤šæè¿°.

ä»Šå¤©å†³å®šå¼€å§‹æ–°ä¸€è½®çš„é‡æ„, åŸºäº Spring Boot 3.3.x æ¥å†™ä¸€ä¸ªä¼ä¸šçº§çš„è„šæ‰‹æ¶å·¥ç¨‹, ä¸»è¦è€ƒè™‘ä»¥ä¸‹å‡ ç‚¹:

1. æƒ³ä½“éªŒä¸€ä¸‹æœ€æ–°çš„ Spring Boot 3.3.x ä¸ Spring AI;
2. æœ€æ–°çš„ Spring Boot 3.3.x ä¸ 2.x ç‰ˆæœ¬ç›¸å·®å¤ªå¤§, ç›´æ¥å‡çº§ä¼šå­˜åœ¨å¾ˆå¤šçš„å…¼å®¹æ€§é—®é¢˜;
3. è¿˜æœ‰å¾ˆå¤šè®¾æƒ³æ²¡æœ‰å®ç°, æ„Ÿè§‰è¿˜èƒ½ä¼˜åŒ–ä¸€ä¸‹;
4. ç®¡ç†å¤ªç´¯, æ²¡æœ‰å¤ªå¤šæ—¶é—´å†™ä»£ç , ä¸€å¤©ä¸å†™ä»£ç æ„Ÿè§‰å°±åƒä»€ä¹ˆäº‹éƒ½æ²¡æœ‰åšä¸€æ ·;
5. å¯ä»¥æ°´å‡ ç¯‡åšå®¢;
6. å› ä¸ºæƒ³ç€å¼€æº, æœ‰ç¢äºè€ä¸œå®¶çš„ä»£ç çŸ¥è¯†äº§æƒçš„é—®é¢˜, åªèƒ½é‡å†™ä¸€ä»½;
7. è‡ªæˆ‘æ„Ÿè§‰åŸæ¥é‚£å¥—è„šæ‰‹æ¶è¿˜æ˜¯æœ‰å¯åœˆå¯ç‚¹çš„åœ°æ–¹, æƒ³æ‹¿å‡ºæ¥åˆ†äº«ä¸€ä¸‹;

åé¢çš„ç³»åˆ—åšå®¢ä¼šæŒç»­è¾“å‡ºå¦‚ä½•ä» 0 åˆ° 1 å»å¼€å‘ä¸€å¥—è‡ªå·±çš„è„šæ‰‹æ¶å·¥ç¨‹, ä¸€æ˜¯å¯ä»¥æ€»ç»“ä¸å·©å›ºä¸€ä¸‹ Java çŸ¥è¯†, äºŒæ˜¯å¥½å¥½åšä¸€ä¸ªè‡ªå·±çš„å¼€æºé¡¹ç›®, ä»¥æ­¤ç»“å®æ›´å¤šçš„ Javaer.

## è®¡åˆ’

ç¬¬ä¸€æ­¥å½“ç„¶æ˜¯ä¸ºé¡¹ç›®å–ä¸€ä¸ªåå­—äº†, æ€è€ƒè‰¯ä¹…, å°±å«: **watt** å§, ä¸ä¸ºåˆ«çš„, å¥½è®°å•è¯å°‘, è€Œä¸”å¯ä»¥è°éŸ³ **ç“¦ç‰¹**, å“ˆå“ˆ.

ä»Šå¤©å°±åˆ°è¿™é‡Œå§, ç®—æ˜¯æ­£å¼å¼€å§‹äº†.

ç»™è‡ªå·±å®šå‡ ä¸ªå°ç›®æ ‡:

1. æŠŠ Github ä¸Šå…è´¹çš„æœåŠ¡ç”¨ä¸ªé, å­¦ä¹ ä¸€ä¸‹ç”¨ Github çš„å…¶ä»–æ“ä½œ, è™½ç„¶ç°åœ¨æ˜¯ä¸€ä¸ªäºº, ä¸‡ä¸€ä»¥åæœ‰äººäº†å‘¢;
2. æŠŠè‡ªå·±æ„Ÿå…´è¶£çš„å¼€æºé¡¹ç›®é›†æˆåˆ°è¿™ä¸ªè„šæ‰‹æ¶é‡Œé¢, ç»Ÿç»Ÿç©ä¸ªé, ä¸ç®¡åˆ«äººç”¨ä¸ç”¨å¾—åˆ°, åªè¦æˆ‘æ„¿æ„, æˆ‘å°±ç©;
3. ç»™å…¶ä»–ç”¨åˆ°çš„å¼€æºé¡¹ç›®æ‰¾ bug, åˆ·åˆ·å­˜åœ¨æ„Ÿ;
4. æ‰¾ JetBrains è¦ä¸ªæˆæƒç ç©ç©, å…è´¹ç”¨äº†è¿™ä¹ˆå¤šå¹´, è¿˜å¾—æ˜¯å…è´¹çš„é¦™;

ç°åœ¨å°±æŠŠç»„ç»‡å’Œç¬¬ä¸€ä¸ªä»“åº“åˆ›å»ºäº†å§:

- [watt-stack](https://github.com/watt-stack)
- [watt-supreme](https://github.com/watt-stack/watt-supreme)

å°±é—®æ•ˆç‡ä¸æ•ˆç‡ ğŸ¥³

## [Hexo Theme Aurora ä¸»é¢˜å›¾ç‰‡å±…ä¸­æ˜¾ç¤ºçš„è§£å†³æ–¹æ¡ˆ](https://blog.dong4j.site/posts/c1f388ed.md)

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ç®€ä»‹

è®°å½•ä¸€ä¸‹å¦‚ä½•å°† `hexo-theme-aurora` ä¸»é¢˜çš„åšå®¢å›¾ç‰‡å±…ä¸­æ˜¾ç¤º

ä¿®æ”¹æ–‡ä»¶: `node_modules/hexo-theme-aurora/source/static/css/a14e1a22.css`:

```css
.post-html img {
  margin: auto;
  cursor: zoom-in;
  transition-property: all;
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration: 0.15s;
}
```

## [æ‰“é€ æ™ºèƒ½URLåˆ‡æ¢å™¨ï¼šè®©å†…å¤–ç½‘è®¿é—®æ›´ä¾¿æ·](https://blog.dong4j.site/posts/9f1d6e11.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![/images/cover/20250113234024_3rZyCVYe.webp](https://cdn.dong4j.site/source/image/20250113234024_3rZyCVYe.webp)

## èƒŒæ™¯

ä½œä¸ºä¸€ä¸ªæ™ºèƒ½å®¶å±…çˆ±å¥½è€…ï¼Œæˆ‘åœ¨å®¶é‡Œéƒ¨ç½²äº†å¤šå°æœåŠ¡å™¨ä»¥åŠå¼€å‘æ¿ã€‚å› ä¸ºæœ‰å…¬ç½‘ IP, å¹¶é€šè¿‡ DDNS ç»‘å®šäº†åŸŸå, æˆ‘å¯ä»¥éšæ—¶åœ¨å¤–ç½‘è®¿é—®å®¶ä¸­çš„å„ç§æœåŠ¡ã€‚

è™½ç„¶æˆ‘é€šè¿‡ Surge çš„é…ç½®å¯ä»¥åœ¨å¤–ç½‘é€šè¿‡å±€åŸŸç½‘è®¿é—®å®¶ä¸­çš„å†…éƒ¨æœåŠ¡, å½“é—®é¢˜æ˜¯æˆ‘éœ€è¦ä¸ºåŒä¸€ä¸ªæœåŠ¡æ·»åŠ å¤šä¸ªä¹¦ç­¾, å½“æœåŠ¡æ•°é‡å¢å¤šæ—¶ï¼Œä¹¦ç­¾ç®¡ç†å˜å¾—å¼‚å¸¸ç¹çã€‚

## è§£å†³æ–¹æ¡ˆ

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘å¼€å‘äº†ä¸€ä¸ª Chrome æ‰©å±• - URL Switcher Proã€‚è¿™ä¸ªæ‰©å±•ç¨‹åºèƒ½å¤Ÿï¼š

1. è‡ªåŠ¨æ£€æµ‹å½“å‰ç½‘ç»œç¯å¢ƒ
2. æ ¹æ®é…ç½®æ™ºèƒ½åˆ‡æ¢å†…å¤–ç½‘ URL
3. æ”¯æŒæ‰¹é‡ URL é…ç½®ç®¡ç†
4. æä¾› URL å¯è®¿é—®æ€§æ£€æµ‹

## æŠ€æœ¯å®ç°

### 1. æ ¸å¿ƒåŠŸèƒ½

æ‰©å±•çš„æ ¸å¿ƒåŠŸèƒ½ä¸»è¦åŒ…æ‹¬ï¼š

- **URL åŒ¹é…ä¸åˆ‡æ¢**ï¼šé€šè¿‡æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œ URL æ¨¡å¼åŒ¹é…
- **ç½‘ç»œç¯å¢ƒæ£€æµ‹**ï¼šæ£€æµ‹ URL å¯è®¿é—®æ€§
- **é…ç½®åŒæ­¥**ï¼šåˆ©ç”¨ Chrome å­˜å‚¨ API å®ç°å¤šè®¾å¤‡é…ç½®åŒæ­¥
- **å›½é™…åŒ–æ”¯æŒ**ï¼šå†…ç½®ä¸­è‹±æ–‡è¯­è¨€æ”¯æŒ

### 2. ä¸»è¦æŠ€æœ¯æ ˆ

- Chrome Extension Manifest V3
- Chrome Storage API
- Chrome Tabs & WebNavigation API
- JavaScript ES6+

### 3. å…³é”®ä»£ç å®ç°

```javascript
// URLè‡ªåŠ¨æ£€æµ‹
async function detectUrlPattern(url) {
  const configs = await chrome.storage.sync.get("siteConfigs");
  for (const config of configs.siteConfigs || []) {
    if (url.includes(config.intranetUrl) || url.includes(config.internetUrl)) {
      // æ£€æµ‹URLå¯è®¿é—®æ€§å¹¶è‡ªåŠ¨åˆ‡æ¢
      const intranetAccessible = await checkUrl(config.intranetUrl);
      return intranetAccessible ? config.intranetUrl : config.internetUrl;
    }
  }
  return url;
}

// URLå¯è®¿é—®æ€§æ£€æµ‹
async function checkUrl(url) {
  try {
    const response = await fetch(url, { method: "HEAD" });
    return response.ok;
  } catch (error) {
    return false;
  }
}
```

## ä½¿ç”¨æ–¹æ³•

1. **å®‰è£…æ‰©å±•**ï¼š

   - ä» Chrome å•†åº—å®‰è£…æˆ–é€šè¿‡å¼€å‘è€…æ¨¡å¼åŠ è½½
   - ç‚¹å‡»å·¥å…·æ çš„æ‰©å±•å›¾æ ‡è¿›è¡Œé…ç½®

2. **æ·»åŠ  URL é…ç½®**ï¼š

   - é…ç½®åç§°ï¼šç”¨äºè¯†åˆ«ä¸åŒçš„æœåŠ¡
   - å†…ç½‘åœ°å€ï¼šå±€åŸŸç½‘è®¿é—®åœ°å€
   - å¤–ç½‘åœ°å€ï¼šå…¬ç½‘è®¿é—®åŸŸå

3. **å¯ç”¨è‡ªåŠ¨åˆ‡æ¢**ï¼š
   - æ‰“å¼€å…¨å±€å¼€å…³
   - è®¿é—®ä»»æ„é…ç½®çš„ URL æ—¶ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°æœ€ä½³è®¿é—®åœ°å€

## ç‰¹è‰²åŠŸèƒ½

1. **æ‰¹é‡é…ç½®ç®¡ç†**ï¼š

   - æ”¯æŒå¯¼å…¥/å¯¼å‡ºé…ç½®
   - æ–¹ä¾¿åœ¨å¤šä¸ªè®¾å¤‡é—´åŒæ­¥é…ç½®

2. **çŠ¶æ€æ£€æµ‹**ï¼š

   - æ£€æµ‹ URL å¯è®¿é—®æ€§
   - ç›´è§‚çš„çŠ¶æ€æŒ‡ç¤ºå™¨æ˜¾ç¤º

3. **æ™ºèƒ½åˆ‡æ¢**ï¼š

   - è‡ªåŠ¨æ£€æµ‹ç½‘ç»œç¯å¢ƒ
   - æ— æ„ŸçŸ¥åˆ‡æ¢åˆ°æœ€ä½³è®¿é—®åœ°å€

## æœªæ¥å±•æœ›

1. **æ™ºèƒ½ç¼“å­˜**ï¼š

   - å®ç° URL è®¿é—®æ€§èƒ½ç¼“å­˜
   - å‡å°‘æ£€æµ‹è¯·æ±‚é¢‘ç‡

2. **æ‰¹é‡å¯¼å…¥**ï¼š

   - æ”¯æŒä»ä¹¦ç­¾å¯¼å…¥é…ç½®
   - æ”¯æŒæ‰¹é‡ URL æ ¼å¼è½¬æ¢

3. **æ›´å¤šè‡ªå®šä¹‰é€‰é¡¹**ï¼š

   - è‡ªå®šä¹‰æ£€æµ‹é—´éš”
   - æ›´çµæ´»çš„ URL åŒ¹é…è§„åˆ™

## ç»“è¯­

URL Switcher Pro é€šè¿‡æ™ºèƒ½çš„ URL åˆ‡æ¢æœºåˆ¶ï¼Œè§£å†³äº†å†…å¤–ç½‘è®¿é—®çš„ç—›ç‚¹ã€‚å®ƒä¸ä»…æé«˜äº†è®¿é—®æ•ˆç‡ï¼Œä¹Ÿå¤§å¤§ç®€åŒ–äº† URL ç®¡ç†çš„å¤æ‚åº¦ã€‚å¯¹äºç»å¸¸éœ€è¦åœ¨ä¸åŒç½‘ç»œç¯å¢ƒä¸‹è®¿é—®å†…ç½‘æœåŠ¡çš„ç”¨æˆ·æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸å¯å¤šçš„æ•ˆç‡å·¥å…·ã€‚

æ¬¢è¿è®¿é—®[GitHub ä»“åº“](https://github.com/dong4j/url-switcher-pro)è·å–æ›´å¤šä¿¡æ¯æˆ–å‚ä¸é¡¹ç›®å¼€å‘ã€‚

## [HomeLabæ•°æ®å¤‡ä»½ï¼šæ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿](https://blog.dong4j.site/posts/6c25aa66.md)

![/images/cover/20241229154732_oUxZug2L.webp](https://cdn.dong4j.site/source/image/20241229154732_oUxZug2L.webp)
[å°é¢æ¥æº: Unsplash-Kvistholt Photography](https://unsplash.com/photos/photo-of-computer-cables-oZPwn40zCK4)

## æ•°æ®å¤‡ä»½

å¤‡ä»½æ˜¯ **Homelab** å¿…ä¸å¯å°‘çš„ä¸€éƒ¨åˆ†ï¼ŒæŒ‰ç…§ä¸åŒçš„ç³»ç»Ÿæ¶æ„ï¼Œå¤‡ä»½å¤§è‡´æœ‰ä¸‹åˆ—å‡ ç±»ï¼š

- æ–‡ä»¶çº§åˆ«çš„å¤‡ä»½ï¼šç›´æ¥åœ¨åº”ç”¨æ‰€å±å®¿ä¸»æœºä¸Šè¿è¡Œå®šæ—¶ä»»åŠ¡ï¼Œå¢é‡æˆ–è€…å…¨é‡å°†æ–‡ä»¶å¤åˆ¶åˆ°å…¶ä»–è¿œç¨‹ä½ç½®ï¼Œå¯ä»¥ä½¿ç”¨ **Synologo Drive**, **Rsync**, **Rclone**, **Restic** ç­‰è¿™ç±»å·¥å…·è¿›è¡Œå¤‡ä»½;
- åº”ç”¨çº§åˆ«çš„å¤‡ä»½ï¼šé€šè¿‡åº”ç”¨å®Œæˆå¤‡ä»½ï¼Œä¾‹å¦‚ Gitlab, Portainer, 1Panle, Home Assistant ç­‰è‡ªå¸¦çš„å¤‡ä»½åŠŸèƒ½ï¼Œå¯ä»¥å°†ç”¨æˆ·æ•°æ®å’Œæ•°æ®åº“ç­‰æ•°æ®ä¸€èµ·å¤‡ä»½åˆ°è¿œç¨‹ä½ç½®ï¼Œ
- ç³»ç»Ÿçº§åˆ«çš„å¤‡ä»½ï¼šä¾‹å¦‚ macOS è‡ªå¸¦çš„å¤‡ä»½ï¼ˆTime Machineï¼‰ï¼Œæ ‘è“æ´¾å’Œ OpenWrt çš„å…¨ç³»ç»Ÿå¤‡ä»½, OpenWrt, DSM ç­‰è‡ªå¸¦çš„ç³»ç»Ÿçº§å¤‡ä»½åŠŸèƒ½, æˆ–è€…å…¶ä»–è½¯ä»¶å®ç°çš„å…¨ç›˜å¤‡ä»½(æ¯”å¦‚ rsync + dd å‘½å)ã€‚
- è™šæ‹ŸåŒ–å¤‡ä»½ï¼šåœ¨æœ‰è™šæ‹ŸåŒ–çš„æ—¶å€™ï¼Œæ•´ä¸ªæ“ä½œç³»ç»Ÿç­‰äºå¤šä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥åªéœ€è¦å°†æ­¤æ–‡ä»¶å¤‡ä»½ä¾¿èƒ½å®ç°æ•´ä¸ªè™šæ‹Ÿæœºçš„å¤‡ä»½ï¼Œæ¯”å¦‚ **Parallels Desktop** çš„ **\*.pvm** è™šæ‹Ÿæœºæ–‡ä»¶, UTM çš„ **\*.utm** è™šæ‹Ÿæœºæ–‡ä»¶, KVM çš„è™šæ‹Ÿæœºæ–‡ä»¶ç­‰;
- å­˜å‚¨å·å¤‡ä»½: ä¸€ç§ **å®Œæ•´å¤‡ä»½ç­–ç•¥**ï¼Œä¼šå°†æ•´ä¸ªå­˜å‚¨å·ï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰ä½œä¸ºä¸€ä¸ªå•å…ƒè¿›è¡Œå¤‡ä»½, æ¯”å¦‚ [**Synology Snapshot Replication**](https://www.synology.cn/zh-cn/dsm/feature/snapshot_replication);
- RAID (ç£ç›˜å†—ä½™é˜µåˆ—)ï¼šè™½ç„¶ RAID ä¸èƒ½ç®—ä½œä¸€ç§å¤‡ä»½æ–¹å¼, ä½†æ˜¯æä¾›äº†ä¸€å®šç¨‹åº¦çš„æ•°æ®å†—ä½™ä¸å¯é æ€§, æ¯”å¦‚æˆ‘çš„ 2 å° NAS éƒ½é€šè¿‡ SSD ç»„äº† RAID1, ç¡®ä¿åœ¨ä¸€å— SSD åäº†çš„æƒ…å†µä¸‹ç³»ç»Ÿä»ç„¶èƒ½å¤Ÿè¿è¡Œ.

> æ•°æ®å¤‡ä»½è¿™ä¸€ç« æˆ‘ä¼šå…ˆä»å„ä¸ªæœåŠ¡å™¨å¼€å§‹æ€»ç»“, å› ä¸ºæœ€åå¤‡ä»½æ–‡ä»¶éƒ½ä¼šæ±‡æ€»åˆ° DS923+ ä¸Š, æ‰€ä»¥ä¼šæœ€åè¯´æ˜ Synology NAS çš„å¤‡ä»½.

**ç›¸å…³æ–‡ç« :**

1. [[homelab-guide|å…ˆå¯¼ç¯‡]]ï¼šæˆ‘çš„ HomeLab æ¦‚è¦;
2. [[homelab-hardware|ç¡¬ä»¶ç¯‡]]ï¼šä»‹ç»æˆ‘æ‰€æ‹¥æœ‰çš„ç¡¬ä»¶è®¾å¤‡;
3. [[homelab-network|ç½‘ç»œç¯‡]]ï¼šåŒ…æ‹¬ç½‘ç»œç¯å¢ƒã€å¼‚åœ°ç»„ç½‘ä¸ç½‘ç»œå®‰å…¨;
4. [[homelab-service|æœåŠ¡ç¯‡]]ï¼šä½¿ç”¨ Docker æ­å»ºçš„å„ç±»æœåŠ¡;
5. [[homelab-data|æ•°æ®ç¯‡]]ï¼šåŒ…æ‹¬æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆ;
6. [[homelab-data-sync|HomeLabæ•°æ®åŒæ­¥ï¼šæ„å»ºé«˜æ•ˆçš„æ•°æ®åŒæ­¥ç½‘ç»œ]]
7. [[homelab-data-backup|HomeLabæ•°æ®å¤‡ä»½ï¼šæ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿]]
8. [[homelab-upgrade-to-10g|HomeLab ç½‘ç»œç»­é›†ï¼šå‡çº§ 10G ç½‘ç»œ-å†æˆ˜ 10 å¹´]]
9. [[homelab-guide|NAT å†…ç½‘ç©¿é€è¯¦è§£ï¼šæ­ç§˜ç½‘ç»œè¿æ¥èƒŒåçš„å¥¥ç§˜]]

---

### æ ‘è“æ´¾å¤‡ä»½

æ ‘è“æ´¾è®¾å¤‡æœ‰ 4 ä¸ª:

- Raspberry Pi Zero 2 W
- Raspberry Pi 4B
- Raspberry Pi 5B \* 2

#### TF å¤åˆ¶

åœ¨ Linux ç³»ç»Ÿä¸­ä¸€é”®å¤‡ä»½æ ‘è“æ´¾ç³»ç»Ÿ SD å¡çš„è„šæœ¬ è„šæœ¬æ–‡ä»¶æ¥æº: https://blog.csdn.net/qingtian11112/article/details/99825257

**ä½¿ç”¨æ–¹æ³•ï¼š**

step1ï¼šä¸‹è½½è„šæœ¬æ–‡ä»¶ `rpi-backup.sh` åˆ° Linux ç³»ç»Ÿä¸­
step2ï¼šæŠŠéœ€è¦å¤‡ä»½çš„ SD å¡æ’å…¥ Linux ç³»ç»Ÿä¸­ï¼Œç”¨ df -h å‘½ä»¤æŸ¥è¯¢ä¸‹ SD å¡å¯¹åº”çš„è®¾å¤‡åã€‚
step3ï¼šè¿›å…¥è„šæœ¬æ–‡ä»¶ `rpi-backup.sh` æ‰€åœ¨ç›®å½•ï¼Œåªéœ€è¦ä¸‹é¢ä¸¤è¡Œå‘½ä»¤å³å¯å®Œæˆ SD å¡å¤‡ä»½ï¼Œæœ€ç»ˆ img æ–‡ä»¶ä¼šç”Ÿæˆåœ¨ `~/backupimg/` æ–‡ä»¶å¤¹ä¸‹:

```bash
# èµ‹å¯æ‰§è¡Œæƒé™
sudo chmod +x rpi-backup.sh
# ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ ‘è“æ´¾ SD å¡ /boot åˆ†åŒºçš„è®¾å¤‡åï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ / åˆ†åŒºçš„è®¾å¤‡å, è§†æƒ…å†µä¿®æ”¹
./rpi-backup.sh /dev/sdb1 /dev/sdb2
```

#### dd å‘½ä»¤

```bash
# 1.ä½¿ç”¨ dd å¤åˆ¶æ–‡ä»¶åˆ° NAS(æå‰ä½¿ç”¨ NFS å°† NAS æŒ‚è½½åˆ°æ ‘è“æ´¾ä¸Š)
sudo dd if=/dev/mmcblk0 of=/mnt/ds923/remote/PI4/20240730.img bs=1MB status=progress
# 2.ä½¿ç”¨ PiShrink.sh å‹ç¼©æ–‡ä»¶ (åœ¨ /mnt/lankxin.u/Developer ç›®å½•ä¸‹æ‰§è¡Œ)
sudo ./pishrink.sh /mnt/ds923/remote/PI4/20240816.img /mnt/ds923/remote/PI4/20240816-lite.img
```

> ä¸Šè¿°æ–¹å¼åœ¨æ ‘è“æ´¾ä¸Šæ‰§è¡Œ, éœ€è¦æå‰æŒ‚è½½ NAS åˆ°æœ¬åœ°.

#### é€šè¿‡ç½‘ç»œå¤åˆ¶

```bash
# å°† è¿œç¨‹çš„ /dev/mmcblk1 å¤‡ä»½åˆ° æœ¬æœºçš„ backup_image.img
ssh root@<ip_board_to_be_backup> "dd if=/dev/mmcblk1" | dd of=backup_image.img bs=1M status=progress
```

> æ­¤æ–¹æ³•åŒæ ·é€‚ç”¨ eMMC å¤‡ä»½, å‡ºå¤„: [**HOW TO CLONE EMMC (NANOPI NEO CORE)**](https://forum.armbian.com/topic/11404-how-to-clone-emmc-nanopi-neo-core/).

ä¸Šè¿°æ–¹å¼éƒ½ä¼šç”Ÿæˆä¸€ä¸ª img æ–‡ä»¶, åç»­å¦‚æœè¦æ¢å¤, å¯ä»¥ä½¿ç”¨åƒ **balenaEtcher** è¿™ç±»å·¥å…·å°†æœ€æ–°çš„ img æ–‡ä»¶çƒ§å½•åˆ° SD å¡ä¸Š.

---

ä½¿ç”¨ç¬¬äºŒç§ **dd å‘½å** å¤‡ä»½æ ‘è“æ´¾ SD å¡æ—¶, éœ€è¦åœ¨æ¯å°æ ‘è“æ´¾ä¸Šæ‰§è¡Œ, ä¸”è¿˜éœ€è¦æŒ‚è½½ NAS, æ‰€ä»¥æˆ‘ä½¿ç”¨å¦ä¸€ç§æ–¹å¼é›†ä¸­åŒ–å¤„ç†çš„æ–¹å¼.

æœ‰ 2 ç§æ–¹å¼:

1. ç›´æ¥åœ¨ NAS ä¸Šé€šè¿‡ç½‘ç»œå¤åˆ¶ SD å¡, ç„¶åä½¿ç”¨ **pishrink.sh** å‡å°é•œåƒå¤§å°;
2. åœ¨å…¶ä»–ä¸»æœºä¸Šæ‰§è¡Œ, ä½¿ç”¨ **pishrink.sh** å‡å°é•œåƒå¤§å°åå†è‡ªåŠ¨ä¸Šä¼ åˆ° DS923+;

ç¬¬ä¸€ç§æ–¹æ¡ˆçš„é—®é¢˜æ˜¯ **pishrink.sh** æ— æ³•ç›´æ¥åœ¨ DS923+ ä¸Šè¿è¡Œ, ä¸ºäº†é¿å…å®‰è£… **pishrink.sh** çš„ä¾èµ–å¯¹ NAS æœ‰å½±å“, æˆ‘çš„è®¡åˆ’æ˜¯åœ¨ M920x ä¸Šæ‰§è¡Œæ•´ä¸ªæµç¨‹, æœ€åå°†å‹ç¼©åçš„é•œåƒä¸Šä¼ åˆ° DS923+ ä¸Š.

æ‰€ä»¥ç¬¬ä¸€æ­¥å°±æ˜¯åœ¨ M920x ä¸Šå®‰è£…ä¾èµ–å¹¶ä¸‹è½½è„šæœ¬:

```bash
sudo apt update && sudo apt install -y wget parted gzip pigz xz-utils udev e2fsprogs
wget https://raw.githubusercontent.com/Drewsif/PiShrink/master/pishrink.sh
chmod +x pishrink.sh
```

ä¸‹é¢æ˜¯è‡ªåŠ¨åŒ–è„šæœ¬:

```bash
#!/bin/bash

# åœ¨ m920x ä¸Šå¤‡ä»½æ ‘è“æ´¾çš„ SD å¡
# ç”¨æ³•:
# ./backup_sd.sh pi4 /dev/mmcblk1 3
# ./backup_sd.sh zero2w /dev/mmcblk1 3
# ./backup_sd.sh pi51 /dev/mmcblk1 3
# ./backup_sd.sh pi52 /dev/mmcblk1 3

# æ£€æŸ¥å‚æ•°
if [[ $# -lt 3 ]]; then
  echo "Usage: $0 <REMOTE_SD> <REMOTE_DEVICE> <MAX_BACKUPS>"
  echo "Example: $0 raspberrypi /dev/mmcblk1 3"
  exit 1
fi

# å‚æ•°èµ‹å€¼
REMOTE_SD="$1"                                  # æ ‘è“æ´¾çš„ SSH åˆ«å
REMOTE_DEVICE="$2"                              # æ ‘è“æ´¾çš„ SD å¡è®¾å¤‡
MAX_BACKUPS="$3"                                # NAS ä¸Šä¿ç•™çš„æœ€å¤§é•œåƒæ–‡ä»¶æ•°
LOCAL_DIR="/mnt/2.870.ssd/pi.backup"            # æœ¬åœ°å¤‡ä»½å­˜æ”¾ç›®å½•
PISHRINK_PATH="${LOCAL_DIR}/pishrink.sh"        # pishrink.sh è„šæœ¬è·¯å¾„
NAS_TARGET="/volume4/backups/SD/${REMOTE_SD}"   # NAS ç›®æ ‡ç›®å½•
TIMESTAMP=$(date "+%Y%m%d%H%M%S")               # æ—¶é—´æˆ³
LOCAL_IMAGE="$LOCAL_DIR/temp_image_${REMOTE_SD}_$TIMESTAMP.img"
LOCAL_IMAGE_LITE="$LOCAL_DIR/${REMOTE_SD}_lite_$TIMESTAMP.img"
LOG_FILE="$LOCAL_DIR/backup_${REMOTE_SD}_${TIMESTAMP}.log"

# ç¡®ä¿æœ¬åœ°å¤‡ä»½ç›®å½•å­˜åœ¨
mkdir -p "$LOCAL_DIR"

# æ—¥å¿—è®°å½•å‡½æ•°
log_message() {
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# æ£€æŸ¥å¹¶åˆ›å»º NAS ç›®æ ‡ç›®å½•
log_message "Checking and creating NAS target directory if it doesn't exist..."
ssh ds923 "mkdir -p $NAS_TARGET"
if [[ $? -ne 0 ]]; then
  log_message "Error creating NAS target directory. Exiting."
  exit 1
fi
log_message "NAS target directory is ready: $NAS_TARGET"

# ç¬¬ä¸€æ­¥ï¼šå¤‡ä»½ SD å¡åˆ°æœ¬åœ°
log_message "Starting SD card backup from $REMOTE_SD..."
ssh $REMOTE_SD "dd if=$REMOTE_DEVICE" | dd of=$LOCAL_IMAGE bs=1M status=progress 2>>"$LOG_FILE"
if [[ $? -ne 0 ]]; then
  log_message "Error during SD card backup. Exiting."
  exit 1
fi
log_message "SD card backup completed: $LOCAL_IMAGE"

# ç¬¬äºŒæ­¥ï¼šå‹ç¼©é•œåƒæ–‡ä»¶
log_message "Compressing the backup image using pishrink..."
$PISHRINK_PATH $LOCAL_IMAGE $LOCAL_IMAGE_LITE >>"$LOG_FILE" 2>&1
if [[ $? -ne 0 ]]; then
  log_message "Error during image compression. Exiting."
  exit 1
fi
log_message "Compression completed: $LOCAL_IMAGE_LITE"

# åˆ é™¤åŸå§‹æœªå‹ç¼©é•œåƒæ–‡ä»¶
rm -f "$LOCAL_IMAGE"
log_message "Deleted uncompressed backup image: $LOCAL_IMAGE"

# ç¬¬ä¸‰æ­¥ï¼šä¸Šä¼ åˆ° NAS
log_message "Uploading compressed image to NAS..."
rsync -azvP $LOCAL_IMAGE_LITE ds923:$NAS_TARGET >>"$LOG_FILE" 2>&1
if [[ $? -ne 0 ]]; then
  log_message "Error during upload to NAS. Exiting."
  exit 1
fi
log_message "Upload completed: $LOCAL_IMAGE_LITE"

# åˆ é™¤æœ¬åœ°å‹ç¼©é•œåƒæ–‡ä»¶
rm -f "$LOCAL_IMAGE_LITE"
log_message "Deleted local compressed backup image: $LOCAL_IMAGE_LITE"

# ç¬¬å››æ­¥ï¼šæ¸…ç† NAS ä¸Šå¤šä½™çš„å¤‡ä»½
ssh ds923 "
  find ${NAS_TARGET} -type f -name '*.img' | sort -r | tail -n +$((MAX_BACKUPS + 1)) | while read -r file; do
    echo \"åˆ é™¤è¿œç¨‹çš„æ—§å¤‡ä»½: \$file\"
    rm -f \"\$file\"
  done
"

echo "å¤‡ä»½å®Œæˆå¹¶æ¸…ç†ã€‚"

# æ¸…ç†æœ¬åœ°æ—§æ—¥å¿—æ–‡ä»¶ï¼Œä¿ç•™æœ€æ–° 5 ä»½
log_message "Cleaning up old local logs..."
cd "$LOCAL_DIR" && ls -t backup_${REMOTE_SD}_*.log | tail -n +6 | xargs -r rm -f
if [[ $? -ne 0 ]]; then
  log_message "Error during log cleanup."
  exit 1
fi

log_message "Log cleanup completed. Retained latest 5 logs for $REMOTE_SD."

log_message "Backup process finished successfully!"
```

**æ·»åŠ å®šæ—¶ä»»åŠ¡**:

```bash
# pishrink.sh éœ€è¦ root è¿è¡Œ
sudo crontab -e
```

```bash
0 10 * * 7 /mnt/2.870.ssd/pi.backup/backup.sd.sh pi4 /dev/mmcblk0 3
30 10 * * 7 /mnt/2.870.ssd/pi.backup/backup.sd.sh pi51 /dev/mmcblk0 3
0 11 * * 7 /mnt/2.870.ssd/pi.backup/backup.sd.sh pi52 /dev/mmcblk0 3
30 11 * * 7 /mnt/2.870.ssd/pi.backup/backup.sd.sh zero2w /dev/mmcblk0 3
```

---

#### å‚è€ƒ

- [å†æ¨èä¸€ä¸ªå¤‡ä»½æ ‘è“æ´¾ç³»ç»Ÿçš„è„šæœ¬ | æ ‘è“æ´¾å®éªŒå®¤](https://shumeipai.nxez.com/2020/10/28/backup-the-raspberry-pi-system-as-an-img-file.html)
- [ã€å°ç™½æ•™ç¨‹ã€‘ç»™ä½ çš„ openwrt å¯åŠ¨ç›˜åšä¸ªå¯æ¢å¤â€œå¿«ç…§â€ã€‚-OPENWRT ä¸“ç‰ˆ-æ©å±±æ— çº¿è®ºå› - Powered by Discuz!](https://www.right.com.cn/forum/thread-4056313-1-1.html)
- [æ ‘è“æ´¾ç³»ç»Ÿå¤‡ä»½\_51CTO åšå®¢\_æ ‘è“æ´¾å¤‡ä»½](https://blog.51cto.com/wangjichuan/5691223)
- [æ ‘è“æ´¾å®‰è£…ç³»ç»Ÿå’Œç³»ç»Ÿå¤‡ä»½è¿˜åŸ\_æ ‘è“æ´¾å¤‡ä»½ç³»ç»Ÿé•œåƒ\_çº¢è‰²å°å°èƒèŸ¹çš„åšå®¢-CSDN åšå®¢](https://blog.csdn.net/yangcunbiao/article/details/123079103)
- [æ ‘è“æ´¾å¤‡ä»½ç³»ç»Ÿåˆ°ç¡¬ç›˜ | AllanHao](https://allanhao.com/2022/09/18/2022-09-18-rpi-backup/)
- [GitHub - nanhantianyi/rpi-backup: raspberry pi backupï¼Œæ ‘è“æ´¾ç³»ç»Ÿå¤‡ä»½ï¼Œæœ€å°é•œåƒå¤‡ä»½](https://github.com/nanhantianyi/rpi-backup)
- [æ ‘è“æ´¾ç³»ç»Ÿé•œåƒä¸€é”®å¤‡ä»½è„šæœ¬, æœ€å°åŒ–é•œåƒä¿å­˜-æ¬¡ä¸–ä»£ BUG æ± ](https://neucrack.com/p/107)
- [GitHub - mghcool/Raspberry-backup: æ ‘è“æ´¾å¤‡ä»½è„šæœ¬](https://github.com/mghcool/Raspberry-backup)
- [æ ‘è“æ´¾å¤‡ä»½ç³»ç»Ÿåˆ°ç¡¬ç›˜ | AllanHao](https://allanhao.com/2022/09/18/2022-09-18-rpi-backup/)
- [å…‹éš†æ ‘è“ Raspberry Pi Mode4 çš„ TF å¡\_tf å¡å…‹éš†-CSDN åšå®¢](https://blog.csdn.net/zhuoqingjoking97298/article/details/114875177)
- [æ•™ä½ æ ‘è“æ´¾ 4B çš„ç³»ç»Ÿå¤‡ä»½æ–¹æ³•æ•™ç¨‹å¤§å…¨ï¼ˆå…¨å¡+å‹ç¼©å¤‡ä»½ï¼‰ - bongem - åšå®¢å›­](https://www.cnblogs.com/bongem/p/12312878.html)
- [GitHub - BigBubbleGum/RaspberryBackup: åœ¨ Linux ç³»ç»Ÿä¸­ä¸€é”®å¤‡ä»½æ ‘è“æ´¾ç³»ç»Ÿ SD å¡çš„è„šæœ¬](https://github.com/BigBubbleGum/RaspberryBackup)
- [PiShrink](https://github.com/Drewsif/PiShrink) && [åœ¨ macOS ä¸­è¿è¡Œ](https://github.com/Drewsif/PiShrink/issues?q=macos)
- [æ ‘è“æ´¾ç³»ç»Ÿå‹ç¼©å¤‡ä»½â€”â€”PiShrink åº”ç”¨å®æ“-CSDN åšå®¢](https://blog.csdn.net/m0_37728676/article/details/108581488)
- [æ ‘è“æ´¾ç³»ç»Ÿé•œåƒä¸€é”®å¤‡ä»½è„šæœ¬, æœ€å°åŒ–é•œåƒä¿å­˜-æ¬¡ä¸–ä»£ BUG æ± ](https://neucrack.com/p/107)
- [æ ‘è“æ´¾ç³»ç»Ÿé•œåƒå¤‡ä»½åŠå‹ç¼©è‡³æœ€å°çš„æ–¹æ³•\_æ ‘è“æ´¾å‹ç¼©å¤‡ä»½-CSDN åšå®¢](https://blog.csdn.net/u013735688/article/details/121130583)
- [GitHub - elespec/rpi-backup: RaspberryPi Backup shell](https://github.com/elespec/rpi-backup?tab=readme-ov-file)
- [MAC ä¸Šå¤‡ä»½ï¼ˆå¤åˆ¶ï¼‰æ ‘è“æ´¾é•œåƒ | ä¸ªäººç¬”è®°å­˜æ¡£](https://www.zhangjc.tech/backup_or_copy_raspberrypi_image_on_mac/)

---

### OpenWrt å¤‡ä»½

OpenWrt è®¾å¤‡æœ‰ 4 ä¸ª:

- R2S \* 3
- R5S

#### è‡ªåŠ¨å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash

# å‚æ•°é…ç½®
DEST_DIR=$1      # æœ¬åœ°å¤‡ä»½ç›®çš„åœ°ç›®å½•ï¼ˆä¾‹å¦‚: /mnt/lankxin.u/backupï¼‰
BACKUP_PREFIX=$2 # å¤‡ä»½æ–‡ä»¶å‰ç¼€ï¼ˆä¾‹å¦‚: backup-r2s2ï¼‰
MAX_BACKUPS=$3   # æœ€å¤§ä¿ç•™å¤‡ä»½æ•°é‡ï¼ˆä¾‹å¦‚: 5ï¼‰
REMOTE_DIR="/volume1/driver/Others/Router/backup/automatic"  # è¿œç¨‹å¤‡ä»½ç›®å½•

# æ£€æŸ¥å‚æ•°æ˜¯å¦è¶³å¤Ÿ
if [ -z "$DEST_DIR" ] || [ -z "$BACKUP_PREFIX" ] || [ -z "$MAX_BACKUPS" ]; then
  echo "ä½¿ç”¨æ–¹æ³•: $0 <å¤‡ä»½ç›®çš„åœ°ç›®å½•> <å¤‡ä»½æ–‡ä»¶å‰ç¼€> <æœ€å¤§å¤‡ä»½æ•°é‡>"
  exit 1
fi

# å¤‡ä»½æ–‡ä»¶è·¯å¾„
backup_file="/tmp/${BACKUP_PREFIX}-$(date +%F).tar.gz"

# åˆ›å»ºå¤‡ä»½
umask go=
sysupgrade -b "$backup_file"
echo "å¤‡ä»½æ–‡ä»¶: ${backup_file}"

# å°†å¤‡ä»½æ–‡ä»¶å¤åˆ¶åˆ°æŒ‡å®šç›®çš„åœ°ç›®å½•
cp "$backup_file" "$DEST_DIR"

# åŒæ­¥åˆ°è¿œç¨‹æœåŠ¡å™¨
rsync -azvP "$backup_file" "ds218:$REMOTE_DIR"

# åˆ é™¤ä¸´æ—¶å¤‡ä»½æ–‡ä»¶
rm -rf /tmp/${BACKUP_PREFIX}-*.tar.gz

# ä¿ç•™æœ¬åœ°å¤‡ä»½æ•°é‡
echo "æ£€æŸ¥å¹¶æ¸…ç†æœ¬åœ°å¤‡ä»½æ–‡ä»¶..."
find "${DEST_DIR}" -type f -name "${BACKUP_PREFIX}-*.tar.gz" -printf '%T+ %p\n' | \
sort -r | \
tail -n +$((MAX_BACKUPS + 1)) | \
awk '{print $2}' | \
while read -r file; do
  echo "åˆ é™¤æ—§çš„æœ¬åœ°å¤‡ä»½: $file"
  rm -f "$file"
done

# ä¿ç•™è¿œç¨‹å¤‡ä»½æ•°é‡
echo "æ£€æŸ¥å¹¶æ¸…ç†è¿œç¨‹å¤‡ä»½æ–‡ä»¶..."
ssh ds218 "
  find ${REMOTE_DIR} -type f -name '${BACKUP_PREFIX}-*.tar.gz' -printf '%T+ %p\n' | \
  sort -r | \
  tail -n +$((MAX_BACKUPS + 1)) | \
  awk '{print \$2}' | \
  while read -r file; do
    echo \"åˆ é™¤è¿œç¨‹çš„æ—§å¤‡ä»½: \$file\"
    rm -f \"\$file\"
  done
"

echo "å¤‡ä»½å®Œæˆå¹¶æ¸…ç†ã€‚"

# bark é€šçŸ¥
curl http://192.168.x.x:port/token/ç³»ç»Ÿå¤‡ä»½æˆåŠŸ\(R2S.U\)\?group\=System.Backup
```

è„šæœ¬çš„ä½œç”¨æ˜¯è‡ªåŠ¨ç”Ÿæˆå¤‡ä»½æ–‡ä»¶, ç„¶åé€šè¿‡ `rsync` ä¸Šä¼ åˆ° NAS çš„ `/volume1/driver/Others/Router/backup/automatic` ç›®å½•ä¸‹, è€Œ `/volume1/driver` ç›®å½•åç»­ä¼šè¢«å…¶ä»–å¥—ä»¶å¤‡ä»½.

> è„šæœ¬ä¸­çš„ **ds218** æ˜¯ä¸€ä¸ª ssh åˆ«å, éœ€è¦åœ¨ .ssh/config ä¸­é…ç½®, ä¸”é…ç½®å…å¯†ç™»å½•.

ç„¶ååœ¨ OpenWrt ç³»ç»Ÿä¸­æ·»åŠ å®šæ—¶ä»»åŠ¡:

```bash
# æ¯å‘¨ 2, 4, 6 æ—©ä¸Š 5 ç‚¹æ‰§è¡Œ
0 5 * * 2,4,6 /root/backup.sh /mnt/lankxin.u/backup r2st 5 > /tmp/backup.log 2>&1
```

![20241229154732_GLxIfNZ5.webp](https://cdn.dong4j.site/source/image/20241229154732_GLxIfNZ5.webp)

> crontab è§„åˆ™:
>
> ```
> * * * * * éœ€è¦æ‰§è¡Œçš„å‘½ä»¤
> - - - - -
> | | | | |
> | | | |  ----- ä¸€æ˜ŸæœŸä¸­çš„ç¬¬å‡ å¤© (0 - 6) (å…¶ä¸­0è¡¨ç¤ºæ˜ŸæœŸæ—¥)
> | | |  ------- æœˆä»½ (1 - 12)
> | |  --------- ä¸€ä¸ªæœˆä¸­çš„ç¬¬å‡ å¤© (1 - 31)
> |  ----------- ä¸€å¤©ä¸­çš„ç¬¬å‡ å°æ—¶ (0 - 23)
>  ------------- ä¸€å°æ—¶ä¸­çš„ç¬¬å‡ åˆ†é’Ÿ (0 - 59)
> ```
>
> ç¤ºä¾‹:
>
> | åˆ†é’Ÿ 0-59 | å°æ—¶ 0-23 | æœˆå†…ç¬¬å‡ å¤© 1-31 | æœˆä»½ 1-12 | æ¯å‘¨ç¬¬å‡ å¤© 0-6(0 è¡¨ç¤ºå‘¨æ—¥) | æ•ˆæœ                                                   |
> | --------- | --------- | --------------- | --------- | -------------------------- | ------------------------------------------------------ |
> | \*        | \*        | \*              | \*        | \*                         | æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡                                         |
> | \*/5      | \*        | \*              | \*        | \*                         | æ¯äº”åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡                                       |
> | 12        | \*/3      | \*              | \*        | \*                         | æ¯è¿‡ 3 ä¸ªå°æ—¶åçš„ç¬¬ 12 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡                    |
> | 57        | 11        | 15              | 1,6,12    | \*                         | åœ¨ 1ã€6ã€12 æœˆä¸­çš„ 15 å·çš„ 11 ç‚¹ 57 åˆ†å„æ‰§è¡Œä¸€æ¬¡       |
> | 25        | 6         | \*              | \*        | 1-5                        | å·¥ä½œæ—¥æœŸé—´ï¼ˆå‘¨ 1 åˆ°å‘¨ 5ï¼‰ï¼Œæ¯å¤©æ—©ä¸Š 6 ç‚¹ 25 åˆ†æ‰§è¡Œä¸€æ¬¡ |
> | 0         | 0         | 4,12,26         | \*        | \*                         | æ¯æœˆçš„ç¬¬ 4ã€12ã€26 æ—¥ï¼Œæ™šä¸Š 12 ç‚¹æ‰§è¡Œä¸€æ¬¡              |

#### WebUI æ‰‹åŠ¨å¤‡ä»½

åœ¨ä¿®æ”¹äº†é…ç½®ååŠæ—¶æ‰‹åŠ¨æ‰§è¡Œå¤‡ä»½æ“ä½œ:

![20241229154732_mNVD9sKb.webp](https://cdn.dong4j.site/source/image/20241229154732_mNVD9sKb.webp)

ä¸‹è½½åçš„å¤‡ä»½æ–‡ä»¶æˆ‘ä¼šç›´æ¥æ‰”åˆ° **~Synology/Others/Router/backup/manual** ä»¥åŒæ­¥åˆ° NAS çš„ **driver** ç›®å½•, è€Œæ­¤ç›®å½•æœ€ç»ˆä¼šè¢«å…¶ä»–å¥—ä»¶å¤‡ä»½.

### eMMC å¤‡ä»½

eMMC è®¾å¤‡æœ‰ 4 ä¸ª:

- H28K (Armbian)
- HB1 Box (Armbian)
- NanoPi NEO4 \* 2 (Ubuntu/Debian)

é¦–å…ˆéœ€è¦ç¡®è®¤ eMMC çš„åˆ†åŒº:

```bash
âœ  ~ fdisk -l

Disk /dev/mmcblk1: 29.13 GiB, 31272730624 bytes, 61079552 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: gpt
Disk identifier: B6CA70E8-D82F-BA42-AFC0-6A872D21A362

Device          Start      End  Sectors  Size Type
/dev/mmcblk1p1  32768   557055   524288  256M Linux extended boot
/dev/mmcblk1p2 557056 60456959 59899904 28.6G Linux filesystem
```

å¯ä»¥ç¡®è®¤åˆ†åŒºä¸º **/dev/mmcblk1**, ç„¶åä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ„å»ºé•œåƒ:

```bash
# å°† è¿œç¨‹çš„ /dev/mmcblk1 å¤‡ä»½åˆ° æœ¬æœºçš„ backup_image.img
ssh root@<ip_board_to_be_backup> "dd if=/dev/mmcblk1" | dd of=backup_image.img bs=1M status=progress
```

![20241229154732_ZllEgtpX.webp](https://cdn.dong4j.site/source/image/20241229154732_ZllEgtpX.webp)

å› ä¸ºæˆ‘æœ‰å¤šä¸ª eMMC è®¾å¤‡, æ‰€ä»¥å†™äº†ä¸€ä¸ªè‡ªåŠ¨åŒ–è„šæœ¬æ‰§è¡Œ:

```bash
#!/bin/bash

# è„šæœ¬ç›®å½•
SCRIPT_DIR=$(dirname "$0")
# æ—¥å¿—æ–‡ä»¶è·¯å¾„
LOG_FILE="$SCRIPT_DIR/backup_emmc.log"

# å°†æ‰€æœ‰è¾“å‡ºé‡å®šå‘åˆ°æ—¥å¿—æ–‡ä»¶
exec > >(tee -a "$LOG_FILE") 2>&1

# =========================
# è‡ªåŠ¨åŒ– eMMC å¤‡ä»½è„šæœ¬
# =========================

# å‚æ•°
REMOTE_EMMC="$1"          # è¿œç¨‹ä¸»æœº(.ssh/config åˆ«å, å…å¯†ç™»å½•)
REMOTE_DEVICE="$2"        # è¿œç¨‹å¤‡ä»½çš„è®¾å¤‡è·¯å¾„ (å¦‚ /dev/mmcblk1)
BACKUP_DIR="$3"           # æœ¬åœ°å¤‡ä»½å­˜å‚¨è·¯å¾„ (å¦‚ /path/to/backups)
BACKUP_PREFIX="$4"        # å¤‡ä»½æ–‡ä»¶åå‰ç¼€ (å¦‚ backup_emmc)
MAX_BACKUPS="$5"          # æœ€å¤§ä¿ç•™å¤‡ä»½æ•°é‡ (å¦‚ 5)

# æ£€æŸ¥å‚æ•°æ˜¯å¦å®Œæ•´
if [ -z "$REMOTE_EMMC" ] || [ -z "$REMOTE_DEVICE" ] || [ -z "$BACKUP_DIR" ] || [ -z "$BACKUP_PREFIX" ] || [ -z "$MAX_BACKUPS" ]; then
  echo "Usage: $0 <REMOTE_EMMC> <REMOTE_DEVICE> <BACKUP_DIR> <BACKUP_PREFIX> <MAX_BACKUPS>"
  exit 1
fi

# åˆ›å»ºå¤‡ä»½ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
mkdir -p "$BACKUP_DIR"

# è·å–å½“å‰æ—¶é—´æˆ³
TIMESTAMP=$(date +%Y%m%d%H%M%S)

# æœ¬åœ°å¤‡ä»½æ–‡ä»¶è·¯å¾„
BACKUP_FILE="$BACKUP_DIR/${BACKUP_PREFIX}_${TIMESTAMP}.img"

# å¼€å§‹å¤‡ä»½
echo "Starting backup from $REMOTE_EMMC:$REMOTE_DEVICE to $BACKUP_FILE"
ssh ${REMOTE_EMMC} "dd if=${REMOTE_DEVICE} bs=1M" | dd of=$BACKUP_FILE bs=1M status=progress

# æ£€æŸ¥å¤‡ä»½æ˜¯å¦æˆåŠŸ
if [ $? -eq 0 ]; then
  echo "Backup completed: $BACKUP_FILE"
else
  echo "Backup failed!"
  exit 1
fi

# åˆ é™¤å¤šä½™çš„å¤‡ä»½æ–‡ä»¶
echo "Cleaning up old backups..."
find "$BACKUP_DIR" -type f -name "${BACKUP_PREFIX}_*.img" -printf '%T+ %p\n' | \
sort -r | \
tail -n +$((MAX_BACKUPS + 1)) | \
awk '{print $2}' | \
while read -r file; do
  echo "Deleting old backup: $file"
  rm -f "$file"
done

echo "Backup process completed."
```

å°†ä¸Šè¿°è„šæœ¬ä¿å­˜ä¸º `backup.emmc.sh`ï¼Œå¹¶èµ‹äºˆæ‰§è¡Œæƒé™ï¼š

```bash
chmod +x backup.emmc.sh
```

è¿è¡Œè„šæœ¬:

```bash
./backup.emmc.sh <REMOTE_EMMC> <REMOTE_DEVICE> <BACKUP_DIR> <BACKUP_PREFIX> <MAX_BACKUPS>
```

- REMOTE_EMMCï¼šè¦å¤‡ä»½çš„è®¾å¤‡çš„åˆ«å, éœ€è¦åœ¨ `.ssh/config` é…ç½®, å¹¶åœ¨è®¾å¤‡ç«¯å¼€å¯å…å¯†ç™»å½•;
- REMOTE_DEVICEï¼šéœ€è¦å¤‡ä»½çš„è®¾å¤‡è·¯å¾„ï¼ˆå¦‚ /dev/mmcblk1ï¼‰;
- BACKUP_DIRï¼šæœ¬åœ°å­˜å‚¨å¤‡ä»½æ–‡ä»¶çš„ç›®å½•;
- BACKUP_PREFIXï¼šå¤‡ä»½æ–‡ä»¶åå‰ç¼€ï¼ˆå¦‚ backup_emmcï¼‰;
- MAX_BACKUPSï¼šä¿ç•™çš„æœ€å¤§å¤‡ä»½æ•°é‡ï¼ˆå¦‚ 5ï¼‰ã€‚

ç¤ºä¾‹:

```bash
# å¤‡ä»½åˆ°å½“å‰ç›®å½•ä¸‹
./backup.emmc.sh h28k /dev/mmcblk1 . h28k 5
```

æ·»åŠ å®šæ—¶ä»»åŠ¡:

```bash
sudo crontab -e
```

æ¯å¤©å‡Œæ™¨ 2 ç‚¹æ‰§è¡Œ:

```bash
0 2 * * * /path/to/backup.emmc.sh <REMOTE_EMMC> <REMOTE_DEVICE> <BACKUP_DIR> <BACKUP_PREFIX> <MAX_BACKUPS>
```

> å¦‚æœæ˜¯åœ¨ NAS ä¸Šæ‰§è¡Œ, ç›´æ¥ä½¿ç”¨ WebUI è®¾ç½®å®šæ—¶ä»»åŠ¡å³å¯:
>
> æ¯”å¦‚å¤‡ä»½è„šæœ¬è·¯å¾„: `/volume4/backups/eMMC/backup.emmc.sh`, è®¾ç½®ä»»åŠ¡è®¡åˆ’:
>
> ![20241229154732_km0ameIh.webp](https://cdn.dong4j.site/source/image/20241229154732_km0ameIh.webp)
>
> ```bash
> /volume4/backups/eMMC/backup.emmc.sh h28k /dev/mmcblk1 /volume4/backups/eMMC h28k 5
> ```

---

### Linux å¤‡ä»½

Linux ä¸»æœºåªåŒ…æ‹¬ M920x å’Œ Station 2 ä¸ª Ubuntu Server è¿™ç§ç›¸å¯¹æ¥è¯´è¾ƒå¤§çš„ä¸»æœº, å…¶ä»–çš„æ¯”å¦‚ Armbian ç­‰è¡ç”Ÿçš„ Linux ç³»ç»Ÿä¸åŒ…å«åœ¨å†….

#### M920x å¤‡ä»½

åœ¨ [Synology NAS](#ç‰©ç†æœåŠ¡å™¨å¤‡ä»½) ä¸€èŠ‚ä¸­ä¼šä½¿ç”¨ **Active Backup for Business** çš„ [ç‰©ç†æœåŠ¡å™¨å¤‡ä»½åŠŸèƒ½](#ç‰©ç†æœåŠ¡å™¨å¤‡ä»½) å¤‡ä»½ M920x çš„ç³»ç»Ÿç›˜.

M920x æ˜¯ä½œä¸º Docker ä¸»åŠ›æœºä½¿ç”¨, æ‰€ä»¥ä¸Šé¢å¯åŠ¨äº†å¤§é‡çš„ Docker å®¹å™¨ä»¥åŠå°‘é‡ KVM è™šæ‹Ÿæœº, è¿™éƒ¨åˆ†æ•°æ®æˆ‘æ‰“ç®—ä½¿ç”¨ `rsync` å¢é‡å¤‡ä»½åˆ°å¦ä¸€å— SSD ä¸Š(M920x æœ‰ 4 å—ç‹¬ç«‹çš„ 1T SSD):

```bash
#!/bin/bash

# å®šä¹‰æºç›®å½•å’Œç›®æ ‡ç›®å½•
SOURCE_DIR_DOCKER="/mnt/3.860.ssd/docker"
SOURCE_DIR_KVM="/mnt/3.860.ssd/kvm"
SOURCE_DIR_KVM_CONFIG="/etc/libvirt"  # å‡è®¾ KVM é…ç½®æ–‡ä»¶åœ¨è¿™é‡Œï¼Œå¦‚æœä¸å¯¹éœ€è¦ä¿®æ”¹
DEST_DIR="/mnt/1.870.ssd"
LOG_DIR="/mnt/1.870.ssd/backup_logs"  # å®šä¹‰æ—¥å¿—ç›®å½•
TIMESTAMP=$(date "+%Y-%m-%d_%H-%M-%S")
LOG_FILE="$LOG_DIR/rsync_backup_$TIMESTAMP.log"

# å¢é‡å¤‡ä»½ Docker ç›®å½•, ä¸ä½¿ç”¨ --progress é¿å…äº§ç”Ÿå¤§é‡æ—¥å¿—
echo "Starting backup of Docker directory..." >> "$LOG_FILE"
rsync -avh --delete "$SOURCE_DIR_DOCKER" "$DEST_DIR" >> "$LOG_FILE" 2>&1

# å¢é‡å¤‡ä»½ KVM ç›®å½•
echo "Starting backup of KVM directory..." >> "$LOG_FILE"
rsync -avh --progress --delete "$SOURCE_DIR_KVM" "$DEST_DIR" >> "$LOG_FILE" 2>&1

# å¢é‡å¤‡ä»½ KVM é…ç½®æ–‡ä»¶
echo "Starting backup of KVM configuration files..." >> "$LOG_FILE"
rsync -avh --progress --delete "$SOURCE_DIR_KVM_CONFIG" "$DEST_DIR" >> "$LOG_FILE" 2>&1

# è¾“å‡ºå®Œæˆä¿¡æ¯
echo "Backup completed on $(date)" >> "$LOG_FILE"

# ä¿ç•™æœ€è¿‘çš„ 5 ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œåˆ é™¤æ—§æ—¥å¿—
echo "Cleaning up old log files..." >> "$LOG_FILE"
find "$LOG_DIR" -type f -name "rsync_backup_*.log" | sort -r | tail -n +6 | xargs -r rm -f

# ç¡®è®¤å®Œæˆ
echo "Cleanup completed. Latest 5 logs are kept." >> "$LOG_FILE"
```

æ­¤è„šæœ¬å°† **docker**, **KVM è™šæ‹Ÿæœºæ–‡ä»¶** ä»¥åŠ **KVM çš„é…ç½®æ–‡ä»¶** ä» `/mnt/3.860.ssd` å¤‡ä»½åˆ° `/mnt/1.870.ssd` ç›®å½•ä¸‹, å°†ä¸Šè¿°è„šæœ¬é‡å‘½åä¸º `backup.sh` å¹¶èµ‹äºˆæ‰§è¡Œæƒé™, ç„¶åæ·»åŠ åˆ°å®šæ—¶ä»»åŠ¡ä¸­:

```bash
# å¿…é¡»ä½¿ç”¨ sudo è¿è¡Œ
sudo crontab -e

# æ¯å¤©å‡Œæ™¨ 2 ç‚¹æ‰§è¡Œ
0 2 * * * /mnt/1.870.ssd/backup.sh
```

> M920x é™¤äº†ç³»ç»Ÿç›˜å¤‡ä»½, `/mnt/3.860.ssd` ä¹Ÿä¼šé€šè¿‡ **Active Backup for Business** å¤‡ä»½åˆ° NAS ä¸Š, ç›¸å½“äº 2 ä»½å¤‡ä»½, æœ€åä¸€ä»½äº‘ç«¯å¤‡ä»½ç”± DS923+ ç»Ÿä¸€å¤„ç†.

---

#### Station

Station ä½œä¸º AI å®éªŒå®¤ä½¿ç”¨, ç›®å‰åªæœ‰ 2 ä¸ª 1T çš„ m.2 å›ºæ€, æ¨¡å‹æ•°æ®å’Œç³»ç»Ÿæ˜¯åˆ†å¼€çš„, åƒ LLM è¿™äº›æ¯”è¾ƒå®¹æ˜“åœ¨ç½‘ä¸Šè·å–çš„æ•°æ®å°±æ²¡æœ‰å¿…è¦å¤‡ä»½äº†, æ‰€ä»¥åªéœ€è¦å¤‡ä»½ç³»ç»Ÿç›˜å³å¯.

åœ¨ [Synology NAS](#ç‰©ç†æœåŠ¡å™¨å¤‡ä»½) ä¸€èŠ‚ä¸­ä¼šä½¿ç”¨ **Active Backup for Business** çš„ [ç‰©ç†æœåŠ¡å™¨å¤‡ä»½åŠŸèƒ½](#ç‰©ç†æœåŠ¡å™¨å¤‡ä»½) å¤‡ä»½ Station çš„ç³»ç»Ÿç›˜.

### macOS å¤‡ä»½

macOS è®¾å¤‡æœ‰ 3 å°:

- Macbook Pro Apple M1 Max
- Mac mini 2018
- Mac mini Apple M2

MBP æ˜¯ä¸»åŠ›æœº, å…¶ä»–ä¸¤å°æ”¾å®¶é‡Œå½“æœåŠ¡å™¨ç”¨, å› ä¸º **AirPort Time Capsule** åªæœ‰ 2T çš„ç©ºé—´, ä¸”å¤‡ä»½é€Ÿåº¦è¾ƒæ…¢, æ‰€ä»¥æˆ‘æ‰“ç®—å°† MBP å¤‡ä»½åˆ° DS923+ ä¸Š, è€Œå…¶ä»– 2 å° Mac å¤‡ä»½åˆ° **AirPort Time Capsule**.

#### ç³»ç»Ÿå¤‡ä»½

##### ä½¿ç”¨ ABB å¤‡ä»½

æˆ‘å°†ä½¿ç”¨ **Active Backup for Business** çš„ macOS å¤‡ä»½åŠŸèƒ½å¤‡ä»½æ•´ä¸ª MBP, å…·ä½“æ–¹å¼çœ‹ [**Windows/macOS å¤‡ä»½**](#Windows/macOS-å¤‡ä»½).

##### ä½¿ç”¨ Time Machine

å¦å¤–ä¸¤å° Mac ç›´æ¥ä½¿ç”¨ **AirPort Time Capsule 2T** å¤‡ä»½, åªéœ€è¦åœ¨ macOS ä¸Šç®€å•é…ç½®å³å¯, è€Œ NAS åŒæ ·å¯ä»¥ä½œä¸º Time Machine å¤‡ä»½ macOS.

é¦–å…ˆæ‰“å¼€ **å¯ç”¨é€šè¿‡ SMB è¿›è¡Œ Bonjour Time Machine æ’­é€** (AFP å¯èƒ½å¯¹æœ€æ–°çš„ macOS å­˜åœ¨å…¼å®¹æ€§é—®é¢˜, æ‰€ä»¥æ¨èä½¿ç”¨ SMB åè®®):

![20241229154732_qsi93R7k.webp](https://cdn.dong4j.site/source/image/20241229154732_qsi93R7k.webp)

æ¥ç€è®¾ç½® Time Machine çš„å­˜å‚¨ç›®å½•, æœ€å¥½æ–°å»ºä¸€ä¸ªä¸“é—¨ç”¨äº Time Machine çš„å…±äº«ç›®å½•, å¹¶å¯ç”¨ **ç´¢å¼•** åŠŸèƒ½, åç»­å¯ä»¥ç›´æ¥ä½¿ç”¨ Mac Finder æœç´¢å¯åŠ¨çš„æ–‡ä»¶å’Œå†…å®¹.

ç„¶ååœ¨ macOS ä¸Šé…ç½® Time Machine:

![20241229154732_XyeMqjkU.webp](https://cdn.dong4j.site/source/image/20241229154732_XyeMqjkU.webp)

æ¨èä½¿ç”¨ [TimeMachineEditor](https://tclementdev.com/timemachineeditor/), å¯åœ¨ç‰¹å®šæ—¶é—´å¯åŠ¨ Time Machine ä¸­çš„å¤‡ä»½. æ¯”å¦‚å¯ä»¥é€‰æ‹©é—´éš”æˆ–åˆ›å»ºå…¶ä»–ç±»å‹çš„è®¡åˆ’:

![20241229154732_pgJJBWR8.webp](https://cdn.dong4j.site/source/image/20241229154732_pgJJBWR8.webp)

#### é‡è¦æ–‡ä»¶å¤‡ä»½

ä½¿ç”¨ [Synology Driver Client](#Synology-Drive-Client) å¤‡ä»½.

### iCloud æ•°æ®å¤‡ä»½

iCloud æ¯”è¾ƒé‡è¦çš„å°± 3 ä¸ª:

- Surge
- Obsidian
- ç…§ç‰‡

å¯¹äºå‰ 2 ä¸ªç›®å½•ç›´æ¥åœ¨ Mac mini 2018 ä¸Šé€šè¿‡è„šæœ¬è‡ªåŠ¨å¤‡ä»½ (`backup.icloud.sh`) :

```bash
#!/bin/bash

# å®ƒä¼šå°† iCloud ä¸­çš„ Surge å’Œ Obsidian ç›®å½•å¤‡ä»½åˆ°æŒ‡å®šçš„ Synology Drive è·¯å¾„ï¼Œå¹¶ä½¿ç”¨ yyyy-mm-dd æ ¼å¼çš„æ—¥æœŸä½œä¸ºå¤‡ä»½æ–‡ä»¶å¤¹å

# å®šä¹‰æºç›®å½•å’Œç›®æ ‡ç›®å½•
SOURCE_SURGE="$HOME/Library/Mobile Documents/iCloud~com~nssurge~inc/Documents"
SOURCE_OBSIDIAN="$HOME/Library/Mobile Documents/iCloud~md~obsidian/Documents"

# è¿™æ˜¯ Synology Drive çš„ç›®å½•, ä¼šè‡ªåŠ¨åŒæ­¥åˆ° NAS
DEST_SURGE="$HOME/Library/CloudStorage/SynologyDrive-driver/macOS/apps/surge"
DEST_OBSIDIAN="$HOME/Library/CloudStorage/SynologyDrive-driver/Obsidian"

# è·å–å½“å‰æ—¥æœŸï¼Œæ ¼å¼ä¸º yyyy-mm-dd
DATE=$(date +%F)

# åˆ›å»ºå¤‡ä»½æ–‡ä»¶å¤¹
SURGE_BACKUP="$DEST_SURGE/$DATE"
OBSIDIAN_BACKUP="$DEST_OBSIDIAN/$DATE"

mkdir -p "$SURGE_BACKUP"
mkdir -p "$OBSIDIAN_BACKUP"

# å¼€å§‹å¤‡ä»½
echo "Backing up Surge to $SURGE_BACKUP..."
rsync -avh --delete "$SOURCE_SURGE/" "$SURGE_BACKUP/"

echo "Backing up Obsidian to $OBSIDIAN_BACKUP..."
rsync -avh --delete "$SOURCE_OBSIDIAN/" "$OBSIDIAN_BACKUP/"

# æ‰“å°å®Œæˆä¿¡æ¯
echo "Backup completed: $DATE"
```

**ä½¿ç”¨ launchd æ·»åŠ å®šæ—¶ä»»åŠ¡**:

1. åœ¨ `~/Library/LaunchAgents` ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `.plist` æ–‡ä»¶ (`touch ~/Library/LaunchAgents/xx.xxx.icloud-backup.plist`):

   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
   <plist version="1.0">
     <dict>
       <key>Label</key>
       <string>xx.xxx.icloud-backup</string>
       <key>ProgramArguments</key>
       <array>
         <string>~/Library/CloudStorage/SynologyDrive-driver/DevOps/batch-script/shell/backup/backup.icloud.sh</string>
       </array>
       <key>StartCalendarInterval</key>
       <dict>
         <key>Hour</key>
         <integer>3</integer> <!-- è®¾ç½®æ¯å¤©å‡Œæ™¨ 3 ç‚¹è¿è¡Œ -->
         <key>Minute</key>
         <integer>0</integer>
       </dict>
       <key>StandardOutPath</key>
       <string>/tmp/backup.log</string>
       <key>StandardErrorPath</key>
       <string>/tmp/backup_error.log</string>
       <key>RunAtLoad</key>
       <true/>
     </dict>
   </plist>
   ```

2. åŠ è½½ launchd é…ç½®:

   ```bash
   launchctl load ~/Library/LaunchAgents/xx.xxx.icloud-backup.plist
   ```

3. æ£€æŸ¥ä»»åŠ¡çŠ¶æ€:

   ```bash
   launchctl list | grep xx.xxx.icloud-backup
   ```

4. ä¸ç”¨åå¯ä»¥å¸è½½:

   ```bash
   launchctl unload ~/Library/LaunchAgents/xx.xxx.icloud-backup.plist
   ```

> ç…§ç‰‡æˆ‘åˆ™ä½¿ç”¨ **Synology Photos Mobile** å¤‡ä»½åˆ° DS218+, ç„¶åå†è‡ªåŠ¨åŒæ­¥åˆ° DS923+.

**å…¶ä»–å‚è€ƒ:**

- [ä½¿ç”¨ Docker ä¸º iCloud ç…§ç‰‡ç”Ÿæˆæœ¬åœ°å¤‡ä»½](https://ios.sspai.com/post/90641)

---

### Synology NAS

> ä¹‹æ‰€ä»¥å…ˆè®²å…¶ä»–è®¾å¤‡çš„å¤‡ä»½æ–¹å¼, æ˜¯å› ä¸ºå®ƒä»¬çš„å¤‡ä»½æ–‡ä»¶æœ€ç»ˆéƒ½ä¼šå†™å…¥åˆ° DS923+ ä¸­, æœ€åæˆ‘åªéœ€è¦å¯¹ DS923+ ä¸Šçš„æ–‡ä»¶è¿›è¡Œå¤‡ä»½å³å¯.

[Synology NAS æä¾›å¤šç§å¤‡ä»½æ–¹å¼](https://kb.synology.com/zh-tw/DSM/tutorial/How_to_back_up_your_Synology_NAS#x_anchor_id12), ä»–ä»¬çš„å¯¹æ¯”å¦‚ä¸‹:

| å¤‡ä»½ç›®çš„åœ°          | Hyper Backup | Snapshot Replication | USB Copy | Cloud Sync                          |
| :------------------ | :----------- | :------------------- | :------- | :---------------------------------- |
| æœ¬åœ°å…±ç”¨èµ„æ–™å¤¹      | å¯ä½¿ç”¨       | å¯ä½¿ç”¨               | ä¸å¯ä½¿ç”¨ | ä¸å¯ä½¿ç”¨                            |
| å¤–æ¥è£…ç½®(USB)       | å¯ä½¿ç”¨       | ä¸å¯ä½¿ç”¨             | å¯ä½¿ç”¨   | ä¸å¯ä½¿ç”¨                            |
| å¦ä¸€å° Synology NAS | å¯ä½¿ç”¨       | å¯ä½¿ç”¨               | ä¸å¯ä½¿ç”¨ | ä¸å¯ä½¿ç”¨                            |
| æ¡£æ¡ˆä¼ºæœå™¨          | å¯ä½¿ç”¨       | ä¸å¯ä½¿ç”¨             | ä¸å¯ä½¿ç”¨ | ä»…æ”¯æ´ WebDAV åŠ OpenStack èµ„æ–™åŒæ­¥ |
| å…¬æœ‰äº‘              | å¯ä½¿ç”¨       | ä¸å¯ä½¿ç”¨             | ä¸å¯ä½¿ç”¨ | å¯ä½¿ç”¨                              |

**åŠŸèƒ½æ€»ç»“**:

| åº”ç”¨ç¨‹å¼åŠç³»ç»Ÿè®¾å®šå¤‡ä»½      | å¯ä½¿ç”¨   | ä¸å¯ä½¿ç”¨                                    | ä¸å¯ä½¿ç”¨   | ä¸å¯ä½¿ç”¨         |
| --------------------------- | -------- | ------------------------------------------- | ---------- | ---------------- |
| å¤‡ä»½åŠè¿˜åŸæ•ˆèƒ½              | ä½       | é«˜                                          | ä¸­         | ä¸­               |
| å‚¨å­˜ç©ºé—´åˆ©ç”¨æ•ˆç‡            | ä¸­       | é«˜                                          | ä½         | ä½               |
| å¤‡ä»½é¢‘ç‡                    | æ¯å°æ—¶   | æ¯ 5 åˆ†é’Ÿ(å…±ç”¨èµ„æ–™å¤¹) æ¯ 15 åˆ†é’Ÿ(iSCSI LUN) | çƒ­æ’æ‹”å¤‡ä»½ | äºèµ„æ–™å˜æ›´æ—¶åŒæ­¥ |
| é€è¿‡ WriteOnce ä¿æŠ¤å¤‡ä»½èµ„æ–™ | ä¸å¯ä½¿ç”¨ | ä»…æ”¯æ´ä¸å¯å˜å¿«ç…§                            | ä¸å¯ä½¿ç”¨   | ä¸å¯ä½¿ç”¨         |

æ ¹æ®ä¸Šé¢çš„åŠŸèƒ½æ€»ç»“, æˆ‘è®¡åˆ’çš„å¤‡ä»½æ–¹æ¡ˆä¸º:

1. ä½¿ç”¨ **Snapshot Replication** åœ¨å½“å‰ NAS ä¸ºé‡è¦å…±äº«ç›®å½•åˆ›å»ºå¿«ç…§ä½œä¸ºç¬¬ä¸€å±‚ä¿æŠ¤, åœ¨æ‰‹æ®‹è¯¯åˆ æ–‡ä»¶æ—¶èƒ½å¤Ÿå¿«é€Ÿæ¢å¤ (**æœ¬åœ°å¤‡ä»½**);
2. åœ¨ DS218+ ä¸Šä½¿ç”¨ **Hyper Backup** å°†é‡è¦çš„ APP é…ç½®ä¸æ•°æ®å¤‡ä»½åˆ° DS923+, åŒæ—¶é€šè¿‡ WebDAV åŠ å¯†å¤‡ä»½åˆ°äº‘ç«¯, è¿˜åŸé¢—ç²’åº¦å¯ä»¥ç²¾ç¡®åˆ°æ–‡ä»¶çº§åˆ« (**ä¸åŒçš„å­˜å‚¨ä»‹è´¨å¤‡ä»½**);
3. åœ¨ DS218+ ä¸Šä½¿ç”¨ **Hyper Backup** å°†æ•´ä¸ªç³»ç»Ÿå¤‡ä»½åˆ° DS923+, åŒæ—¶é€šè¿‡ WebDAV åŠ å¯†å¤‡ä»½åˆ°äº‘ç«¯, ä»¥ä¾¿åœ¨ç³»ç»Ÿå´©æºƒæˆ–æŸåæ—¶è¿˜åŸ (**ä¸åŒçš„å­˜å‚¨ä»‹è´¨å¤‡ä»½**);
4. åœ¨ DS923+ ä¸Šä½¿ç”¨ **Hyper Backup** å°†æ‰€æœ‰ç…§ç‰‡å’Œå®¶åº­è§†é¢‘é€šè¿‡ rsync å¤‡ä»½åˆ° Mac mini 2018 è¿æ¥çš„ **LaCie 8TB d2 Professional** (**ä¸åŒçš„å­˜å‚¨ä»‹è´¨å¤‡ä»½**);
5. åœ¨ DS923+ ä¸Šä½¿ç”¨ **Hyper Backup** å°†é‡è¦çš„ APP é…ç½®ä¸æ•°æ®å¤‡ä»½(åŒ…æ‹¬ç…§ç‰‡å’Œå®¶åº­è§†é¢‘)é€šè¿‡ WebDAV åŠ å¯†å¤‡ä»½åˆ°äº‘ç«¯ (**äº‘ç«¯å¤‡ä»½**);
6. åœ¨ DS923+ ä¸Šä½¿ç”¨ **Active Backup for Business** æ•´æœºå¤‡ä»½ DS218+ (**ä¸åŒçš„å­˜å‚¨ä»‹è´¨å¤‡ä»½**);
7. åœ¨ DS923+ ä¸Šä½¿ç”¨ **Active Backup for Business** ç‰©ç†æœåŠ¡å™¨å¤‡ä»½åŠŸèƒ½é›†ä¸­å¤‡ä»½ M920x å’Œ Station æ•´ä¸ªç³»ç»Ÿ (**ä¸åŒçš„å­˜å‚¨ä»‹è´¨å¤‡ä»½**);
8. åœ¨ DS923+ ä¸Šä½¿ç”¨ **Active Backup for Business** æ–‡ä»¶æœåŠ¡å™¨å¤‡ä»½åŠŸèƒ½é›†ä¸­å¤‡ä»½æ‰€æœ‰å¼€å‘æ¿å’Œå°ä¸»æœºçš„é‡è¦æ–‡ä»¶ (**ä¸åŒçš„å­˜å‚¨ä»‹è´¨å¤‡ä»½**);
9. åœ¨ DS923+ ä¸Šä½¿ç”¨å¤–ç½®å­˜å‚¨å®šæ—¶å¤‡ä»½ **Active Backup for Business** äº§ç”Ÿçš„å¤‡ä»½æ–‡ä»¶ (**ä¸åŒçš„å­˜å‚¨ä»‹è´¨å¤‡ä»½**);
10. å…¶ä»–èƒ½å¤Ÿå®‰è£… **Synology Drive Client** çš„ä¸»è¦è®¾å¤‡ä¸Š, ä½¿ç”¨ **Drive** è‡ªå¸¦çš„å¤‡ä»½åŠŸèƒ½å¤‡ä»½æœ¬æœºä¸Šé‡è¦çš„æ–‡ä»¶ (**ä¸åŒçš„å­˜å‚¨ä»‹è´¨å¤‡ä»½**);

---

#### Snapshot Replication

[**Snapshot Replication**](https://www.synology.cn/zh-cn/dsm/feature/snapshot_replication) æ˜¯ Synology æä¾›çš„ä¸€é¡¹æ•°æ®å¤‡ä»½åŠŸèƒ½ï¼Œå®ƒé€šè¿‡åˆ©ç”¨ Btrfs æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºæ—¶é—´ç‚¹å‰¯æœ¬ï¼Œå®ç°æ•°æ®çš„å—çº§ä¿æŠ¤å’Œå¿«é€Ÿæ¢å¤ã€‚è¯¥åŠŸèƒ½æ”¯æŒå¤šç§å¤åˆ¶ç­–ç•¥ï¼Œå¯çµæ´»éƒ¨ç½²ï¼Œå¹¶é…å¤‡ä¾¿æ·çš„ç®¡ç†å·¥å…·ï¼Œå¸®åŠ©æˆ‘ä»¬è½»æ¾å®ç°æ•°æ®çš„å¤‡ä»½å’Œç¾éš¾æ¢å¤.

åœ¨ç³»ç»Ÿæ”¯æŒ Btrfs æ–‡ä»¶æ ¼å¼çš„æƒ…å†µä¸‹ï¼Œå»ºè®®ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨å¿«ç…§å¤åˆ¶ä½œä¸ºå¤‡ä»½ç­–ç•¥ã€‚è¿™ç§æ–¹å¼å¯ä»¥å°†å¤‡ä»½å‘¨æœŸè®¾ç½®å¾—éå¸¸çŸ­ï¼Œéå¸¸é€‚åˆå¤„ç†å…¬å…±æ–‡ä»¶å¤¹ä¸­åŒæ—¶è¿›è¡Œå¤§é‡ç¼–è¾‘çš„æƒ…å†µã€‚
å½“é‡åˆ°é—®é¢˜ï¼ˆä¾‹å¦‚ï¼šä¸æ…åˆ é™¤äº†å¤§é‡æ•°æ®ï¼Œæˆ–æ˜¯ä¸çŸ¥é“è¿›è¡Œäº†å“ªäº›ä¿®æ”¹ï¼‰éœ€è¦æ¢å¤æ–‡ä»¶æˆ–æ•´ä¸ªå…±äº«æ–‡ä»¶å¤¹æ—¶ï¼Œä½ ä¼šéå¸¸æ„Ÿæ¿€ä¸éœ€è¦æŒ‰ç…§ä¸€å¤©æˆ–ä¸¤å¤©çš„æ—¶é—´å•ä½æ¥å›æº¯ã€‚
ä¼˜ç‚¹æ˜¯ï¼šå¤‡ä»½å‘¨æœŸè¶ŠçŸ­ï¼Œæ¢å¤æ—¶åªéœ€è¿˜åŸå•ä¸ªæ–‡ä»¶æˆ–æ•´ä¸ªæ–‡ä»¶å¤¹ï¼Œè€Œä¸”è¿˜åŸé€Ÿåº¦æå¿«ã€‚è¿™æ ·çš„å¤‡ä»½æ–¹æ¡ˆåœ¨ç´§æ€¥æƒ…å†µä¸‹èƒ½å¤Ÿå¤§å¤§å‡è½»å·¥ä½œå‹åŠ›ã€‚

![20241229154732_m09bLGED.webp](https://cdn.dong4j.site/source/image/20241229154732_m09bLGED.webp)

å¦‚æœåœ¨å‹¾é€‰ **é«˜çº§-è®©å¿«ç…§å¯è§** çš„é€‰é¡¹å, å¯åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­æŸ¥çœ‹å·²ä¿å­˜çš„å¿«ç…§, æ­¤ç›®å½•ä¿å­˜åœ¨æ¯ä¸ªåˆ›å»ºäº†å¿«ç…§çš„å…±äº«ç›®å½•ä¸‹, ä¸”ä¸ä¼šè¢«å…¶ä»–ç¾¤æ™–å¤‡ä»½å¥—ä»¶å¤‡ä»½:

![20241229154732_d7mCWrSi.webp](https://cdn.dong4j.site/source/image/20241229154732_d7mCWrSi.webp)

åŒæ—¶è¿˜å…·å¤‡ **å¤åˆ¶** åŠŸèƒ½, é€‰æ‹©è¿œç¨‹æœåŠ¡å™¨ä½œä¸ºå¤åˆ¶ç›®çš„åœ°æ—¶, æ¯”å¦‚å¦ä¸€å° NAS, å³å¯å°†å¿«ç…§åœ¨å¦ä¸€å° NAS **é‡ç°**, ä¸è¿‡æˆ‘ä¸€ç›´å¡åœ¨å¾ªç¯éªŒè¯çš„åœ°æ–¹, æš‚æ—¶å¹¶æœªä½¿ç”¨æ­¤åŠŸèƒ½:

![20241229154732_smrtCyCo.webp](https://cdn.dong4j.site/source/image/20241229154732_smrtCyCo.webp)

> Snapshot Replication å±äºæœ¬åœ°å¤‡ä»½, æ€§èƒ½å’Œè¿˜åŸé€Ÿåº¦éƒ½æ˜¯æœ€ä¼˜çš„, ä¸”å¿«ç…§å ç”¨çš„ç£ç›˜ç©ºé—´è¾ƒå°.

---

#### Hyper Backup

Hyper Backup æ˜¯å‡ ä¸ªå¤‡ä»½å¥—ä»¶ä¸­åŠŸèƒ½æœ€å…¨çš„ä¸€ä¸ª, é™¤äº†æ•´æœºå¤‡ä»½, è¿˜èƒ½å•ç‹¬å¤‡ä»½å…±äº«ç›®å½•å’Œ APP é…ç½®, æ‰€ä»¥åœ¨ [æ•´æœºå¤‡ä»½](#NAS-æ•´æœºå¤‡ä»½) çš„åŸºç¡€ä¸Š, æˆ‘è¿˜æ˜¯ç”¨å®ƒæ¥å•ç‹¬å¤‡ä»½ä¸ªåˆ«å…±äº«ç›®å½•å’Œå…¨éƒ¨çš„ APP é…ç½®, è¿™æ ·æˆ‘å¯ä»¥åœ¨ä¸éœ€è¦æ•´æœºè¿˜åŸçš„æƒ…å†µä¸‹å•ç‹¬æ¢å¤éƒ¨åˆ†æ•°æ®æˆ– APP:

![20241229154732_bpGajtWl.webp](https://cdn.dong4j.site/source/image/20241229154732_bpGajtWl.webp)

Hyper Backup å¤‡ä»½ APP æ—¶ä¼šä¸€å¹¶å°†å¯¹åº”çš„å…±äº«ç›®å½•ä¸€èµ·å¤‡ä»½:

![20241229154732_bQkbLo6V.webp](https://cdn.dong4j.site/source/image/20241229154732_bQkbLo6V.webp)

> åœ¨ DS218+ ä¸Š ä½¿ç”¨æ­¤å¥—ä»¶å°†æ–‡ä»¶å¤‡ä»½åˆ° DS923+, å¹¶åŠ å¯†å¤‡ä»½åˆ°é˜¿é‡Œäº‘ç›˜, ç›¸å½“äºæœ‰ 2 ä»½å¤‡ä»½, ä¸”ä¸€ä»½åœ¨å¼‚åœ°.
>
> Hyper Backup æä¾›äº†çµæ´»çš„æ–¹æ³•æ¥é€‰æ‹©è¦å¤‡ä»½çš„å…±äº«æ–‡ä»¶å¤¹ã€æ–‡ä»¶å¤¹å’Œæ–‡ä»¶ã€‚å¯ä»¥å‹¾é€‰å’Œå–æ¶ˆå‹¾é€‰å¤é€‰æ¡†ä»¥é€‰æ‹©è¦å¤‡ä»½çš„å†…å®¹ã€‚æœ‰ 3 ç§ä¸åŒçš„å¤‡ä»½é€‰æ‹©å¯ä¾›é€‰æ‹©ï¼š
>
> ![20241229154732_s5fn82qw.webp](https://cdn.dong4j.site/source/image/20241229154732_s5fn82qw.webp)

---

#### Active Backup for Business

[Active Backup for Business](https://www.synology.cn/zh-cn/dsm/feature/active_backup_business#pc) æ˜¯ä¸€æ¬¾åŠŸèƒ½å…¨é¢çš„å¤‡ä»½ä¸æ¢å¤å·¥å…·ï¼Œé€‚åˆéœ€è¦é›†ä¸­ç®¡ç†å¤šç§è®¾å¤‡æ•°æ®çš„éœ€æ±‚. ç›®å‰æˆ‘æ­£åœ¨ç”¨å®ƒæ¥é›†ä¸­å¤‡ä»½å¤šä¸ªå¼€å‘æ¿ä¸Šçš„é‡è¦æ–‡ä»¶, Linux æ•´æœºå¤‡ä»½ä»¥åŠ DS218+ çš„æ•´æœºå¤‡ä»½.

##### NAS æ•´æœºå¤‡ä»½

è¿™ä¸ªå°†åœ¨ [NAS æ•´æœºå¤‡ä»½](#NAS-æ•´æœºå¤‡ä»½) ä¸€èŠ‚ä¸­è¯¦ç»†ä»‹ç», è¿™é‡Œå°±ä¸å†èµ˜è¿°äº†.

##### Windows/macOS å¤‡ä»½

æˆ‘ç›®å‰æ²¡æœ‰ Windows ä¸»æœº, æ ¹æ® [å‰é¢çš„è®¡åˆ’](#macOS-å¤‡ä»½), MBP å°†ä½¿ç”¨æ­¤åŠŸèƒ½å¤‡ä»½(å¯ä»¥äº«å—ä¸‡å…†å†…ç½‘çš„é€Ÿåº¦), å¦å¤– 2 å° Mac å°†ä½¿ç”¨ [Time Machine](#ç³»ç»Ÿå¤‡ä»½) å¤‡ä»½åˆ° **AirPort Time Capsule 2T**.

macOS éœ€è¦ä¸‹è½½ **Active Backup for Business Agent**, åœ¨ macOS ç«¯ä¸»åŠ¨è¿æ¥åˆ° DS923+ çš„å¤‡ä»½æœåŠ¡å™¨:

![20241229154732_ZfhbpwPy.webp](https://cdn.dong4j.site/source/image/20241229154732_ZfhbpwPy.webp)

å› ä¸ºæ˜¯å†…ç½‘è¿æ¥, å¯ä»¥ä¸ç”¨ç®¡è¿™ä¸ª SSL è¯ä¹¦é—®é¢˜, ç‚¹å‡» **ä»ç„¶ç»§ç»­** å³å¯. ä¸è¿‡ä¸ºäº†é¿å…å› ä¸ºè¯ä¹¦åˆ°æœŸå¯¼è‡´å¤‡ä»½å¤±è´¥, æœ€å¥½ç›´æ¥ä½¿ç”¨ **Active Backup for Business è¯ä¹¦**:

![20241229154732_a4IEYPy8.webp](https://cdn.dong4j.site/source/image/20241229154732_a4IEYPy8.webp)

å¯ç”¨åä¼šè‡ªåŠ¨åœ¨ **æ§åˆ¶é¢æ¿-å®‰å…¨æ€§-è¯ä¹¦** ä¸­æ·»åŠ ç›¸åº”çš„è¯ä¹¦:

![20241229154732_VnZMCUOS.webp](https://cdn.dong4j.site/source/image/20241229154732_VnZMCUOS.webp)

å¦ä¸€ä¸ªé—®é¢˜æ˜¯æ¨¡ç‰ˆåŒ¹é…:

![20241229154732_6v2p4f48.webp](https://cdn.dong4j.site/source/image/20241229154732_6v2p4f48.webp)

è¿æ¥æœåŠ¡å™¨æ—¶, å› ä¸º **å¤‡ä»½ç›®çš„åœ°æ ¼å¼ä¸å—æ”¯æŒ** è€Œæ·»åŠ å¤±è´¥, å…¶å®ä¸æ˜¯æ ¼å¼ä¸å—æ”¯æŒ, **æ˜¯å¤‡ä»½çš„ç›®çš„åœ°ç›®å½•ä¸å­˜åœ¨**.

![20241229154732_xKF38i63.webp](https://cdn.dong4j.site/source/image/20241229154732_xKF38i63.webp)

åœ¨ DS923+ çš„ **Active Backup for Business** ä¿®æ”¹æ¨¡ç‰ˆä¸­çš„ **ç›®çš„åœ°**, é»˜è®¤æ˜¯ **ActiveBackupforBusiness**, ä½†æ˜¯æˆ‘ä»¬çš„ NAS æ ¹æœ¬å°±æ²¡æœ‰è¿™ä¸ªå…±äº«ç›®å½•, æ‰€ä»¥å‡ºé”™äº†(ä¹Ÿæœ‰å¯èƒ½æ˜¯æˆ‘ä»¥å‰æŠŠè¿™ä¸ªç›®å½•æ‰‹åŠ¨åˆ é™¤äº† ğŸ˜‚).

![20241229154732_svmFryzc.webp](https://cdn.dong4j.site/source/image/20241229154732_svmFryzc.webp)

æ›´æ¢ä¸€ä¸ªå­˜åœ¨ä¸”å¯ç”¨çš„å…±äº«ç›®å½•å³å¯, æ·»åŠ æˆåŠŸåçš„ **Agent ä¿¡æ¯**:

![20241229154732_ZzsyQIdD.webp](https://cdn.dong4j.site/source/image/20241229154732_ZzsyQIdD.webp)

**æœåŠ¡ç«¯ä¿¡æ¯**:

![20241229154732_o6QFY31x.webp](https://cdn.dong4j.site/source/image/20241229154732_o6QFY31x.webp)

åç»­å°±æ˜¯æ ¹æ®è‡ªå·±çš„æƒ…å†µé…ç½®ä»»åŠ¡äº†.

---

##### ç‰©ç†æœåŠ¡å™¨å¤‡ä»½

Active Backup for Business ç›®å‰æ”¯æŒä»¥ä¸‹ Linux ç³»ç»Ÿ:

- Debianï¼š10, 11, 12
- Ubuntuï¼š16.04, 18.04, 20.04, 22.04, 24.04
- Architechture: x86_64

è¿æ¥æ–¹å¼ä¹Ÿéå¸¸ç®€å•:

1. ä¸‹è½½å®˜æ–¹çš„ agent, è¿™ä¸ªåœ¨ **Active Backup for Business - ç‰©ç†æœåŠ¡å™¨ - æ·»åŠ è®¾å¤‡** æ—¶ä¼šå‘ŠçŸ¥ä¸‹è½½åœ°å€;

2. ä¿®æ”¹æ¨¡ç‰ˆ(å› ä¸ºæˆ‘æ²¡æœ‰è¿™ä¸€æ­¥å¯¼è‡´è¿æ¥å¤±è´¥): **Active Backup for Business - è®¾ç½® - æ¨¡ç‰ˆ**, å°† **å…±äº«æ–‡ä»¶å¤¹** ä¿®æ”¹æˆå­˜åœ¨çš„å…±äº«ç›®å½•;

3. åœ¨ Linux ä¸Šå®‰è£… Agent, å¯æŸ¥çœ‹ **README** çš„æ“ä½œæŒ‡å—;

4. å®‰è£…å®Œæˆåä½¿ç”¨ **abb-cli -c** è¿æ¥ NAS:

   ```bash
   $ abb-cli -c
   Enter server address: NAS çš„ IP
   Enter username: NAS çš„ç”¨æˆ·å
   Enter password: å¯¹åº”çš„å¯†ç 
   Connecting...
   The SSL certificate of the Synology NAS is not trusted. To learn how to obtain a valid certificate, please have a registered domain by setting up DDNS (http://sy.to/ddns) and applying for Let's Encrypt (http://sy.to/letsencrypt) certificate. Proceed anyway? [y/n](default: y): y
   Enter a 6-digit verification code xxxxx (2FA code)

   Server address: x.x.x.x
   Username: xxx
   Backup type: Server
   Applied template: Default
   Backup destination: backup
   Source type: System volumes backup
   Restoration privilege: admin, xxx, administrators
   Back up by time: Monday, Tuesday, Wednesday, Thursday, Friday Start at: 03:00(Daily/Weekly)
   Retention policy: Advanced retention policy settings
   Backup window: Disabled
   Data transfer compression: Enable
   Data transfer encryption: Enable
   Bandwidth consumption limit: Disabled
   Compression at backup destination: Enable
   Encryption at backup destination: Disabled
   Backup verification: Disabled
   Pre/post script: Disabled
   Confirm authentication? [y/n](default: y):
   Confirming authentication...
   Successfully connected
   ```

æœ€ååœ¨ **Active Backup for Business** ç«¯å¯ä¿®æ”¹å¤‡ä»½è®¡åˆ’:

![20241229154732_uMETHAjv.webp](https://cdn.dong4j.site/source/image/20241229154732_uMETHAjv.webp)

å¦‚æœæ˜¯æ•´æœºè¿˜åŸ, éœ€è¦ä½¿ç”¨ Linux æ¢å¤åª’ä½“åˆ›å»ºä¸€ä¸ª [å¯å¯åŠ¨çš„ USB æ¢å¤é©±åŠ¨å™¨](https://kb.synology.com/en-global/DSM/tutorial/How_do_I_create_a_bootable_USB_drive_for_restoring_Linux):

![20241229154732_PS1X66hN.webp](https://cdn.dong4j.site/source/image/20241229154732_PS1X66hN.webp)

å¦‚æœåªæ˜¯æ–‡ä»¶è¿˜åŸ, å¯ä½¿ç”¨ **Active Backup for Business Portal** æ“ä½œ:

![20241229154732_upTgftjF.webp](https://cdn.dong4j.site/source/image/20241229154732_upTgftjF.webp)

##### æ–‡ä»¶æœåŠ¡å™¨å¤‡ä»½

å°†å¼€å‘æ¿è¿æ¥åˆ° **Active Backup for Business Portal** é›†ä¸­å¤‡ä»½:

![20241229154732_BiIE6axw.webp](https://cdn.dong4j.site/source/image/20241229154732_BiIE6axw.webp)

æ–‡ä»¶æœåŠ¡å™¨å¤‡ä»½ä½¿ç”¨çš„æ˜¯ **rsync**, ä¸”æœ€å¥½ä½¿ç”¨ root ç”¨æˆ·, ä¸ç„¶æŸäº›ç›®å½•ç”±äºæƒé™é—®é¢˜æ— æ³•å¤‡ä»½:

![20241229154732_Wu9lAdyl.webp](https://cdn.dong4j.site/source/image/20241229154732_Wu9lAdyl.webp)

##### è™šæ‹Ÿæœºå¤‡ä»½

**Active Backup for Business** åªèƒ½å¤‡ä»½ VMwareÂ® vSphereâ„¢ ä¸ MicrosoftÂ® Hyper-VÂ® è™šæ‹Ÿæœº, æ‰€ä»¥ [M920x ä¸Šçš„ KVM è™šæ‹Ÿæœºæˆ‘åªèƒ½ä½¿ç”¨è„šæœ¬å¤‡ä»½](#M920x-å¤‡ä»½),

è€Œ Synology Virtual Machine Manager ä¸­çš„è™šæ‹Ÿæœºå¯ä»¥é€šè¿‡å¿«ç…§æ¥å¤‡ä»½, å¦ä¸€ç§æ–¹å¼æ˜¯å°†è™šæ‹Ÿæœºå¯¼å‡ºåˆ°å…±äº«ç›®å½•, ç„¶åä½¿ç”¨å…¶ä»–æ–¹å¼å¤‡ä»½è™šæ‹Ÿæœºæ–‡ä»¶.

---

#### Synology Drive Client

Synology Drive Client åœ¨æä¾›åŒæ­¥åŠŸèƒ½çš„åŒæ—¶è¿˜å…·å¤‡å¤‡ä»½åŠŸèƒ½, æ‰€ä»¥æˆ‘å°†ä¸»åŠ›æœºä¸Šçš„é‡è¦æ–‡ä»¶ä½¿ç”¨å®ƒå¤‡ä»½åˆ° NAS ä¸­, å¤‡ä»½çš„ç›®çš„åœ°åªèƒ½é€‰æ‹©å½“å‰ç™»å½•ç”¨æˆ·çš„ home ç›®å½•:

![20241229154732_sF7Y1PVi.webp](https://cdn.dong4j.site/source/image/20241229154732_sF7Y1PVi.webp)

---

#### DSM ç³»ç»Ÿå†—ä½™

é¦–å…ˆéœ€è¦äº†è§£ä¸€ä¸‹ **RAID çš„å‡ ç§ç±»å‹**:

| RAID ç±»å‹ | ç£ç›˜æ•°é‡   | æ•°æ®åˆ†å¸ƒ          | å†—ä½™èƒ½åŠ›                     | æ€§èƒ½ | æœ€å°‘ç£ç›˜è¦æ±‚ |
| --------- | ---------- | ----------------- | ---------------------------- | ---- | ------------ |
| RAID 0    | 2+         | æ¡å¸¦åŒ–            | æ—                            | æœ€é«˜ | 2            |
| RAID 1    | 2+ï¼ˆå¶æ•°ï¼‰ | é•œåƒ              | å®Œå…¨                         | ä¸€èˆ¬ | 2            |
| RAID 5    | 3+         | æ¡å¸¦åŒ–+å¥‡å¶æ ¡éªŒ   | å•ç£ç›˜æ•…éšœ                   | è¾ƒé«˜ | 3            |
| RAID 6    | 4+         | æ¡å¸¦åŒ–+åŒå¥‡å¶æ ¡éªŒ | åŒç£ç›˜æ•…éšœ                   | è¾ƒé«˜ | 4            |
| RAID 10   | 4+ï¼ˆå¶æ•°ï¼‰ | é•œåƒ+æ¡å¸¦åŒ–       | å•ç£ç›˜æ•…éšœï¼ˆæ¯ä¸ªé•œåƒç»„ï¼‰     | é«˜   | 4            |
| RAID 50   | 6+         | RAID 5 + æ¡å¸¦åŒ–   | å•ç£ç›˜æ•…éšœï¼ˆæ¯ä¸ª RAID 5 ç»„ï¼‰ | è¾ƒé«˜ | 6            |
| RAID 60   | 8+         | RAID 6 + æ¡å¸¦åŒ–   | åŒç£ç›˜æ•…éšœï¼ˆæ¯ä¸ª RAID 6 ç»„ï¼‰ | è¾ƒé«˜ | 8            |

> æ¡å¸¦åŒ–ï¼ˆStripingï¼‰æ˜¯ä¸€ç§æ•°æ®åˆ†é…æŠ€æœ¯ï¼Œå®ƒå°†æ•°æ®åˆ†å‰²æˆå°å—ï¼ˆé€šå¸¸ç§°ä¸ºâ€œæ¡å¸¦â€æˆ–â€œå—â€ï¼‰ï¼Œå¹¶å°†è¿™äº›å°å—åˆ†æ•£å­˜å‚¨åœ¨å¤šä¸ªç£ç›˜ä¸Šã€‚è¿™ç§æŠ€æœ¯åœ¨ RAIDï¼ˆç‹¬ç«‹å†—ä½™ç£ç›˜é˜µåˆ—ï¼‰é…ç½®ä¸­éå¸¸å¸¸è§ï¼Œå°¤å…¶æ˜¯åœ¨ RAID 0ã€RAID 5ã€RAID 6 å’Œ RAID 10 ç­‰çº§åˆ«ä¸­ã€‚

**è¯´æ˜ï¼š**

1. **RAID 0**ï¼šé€Ÿåº¦å¿«ï¼Œä½†æ— ä»»ä½•å†—ä½™ï¼Œé€‚åˆä¸å…³å¿ƒæ•°æ®ä¸¢å¤±çš„é«˜æ€§èƒ½åœºæ™¯ã€‚
2. **RAID 1**ï¼šå®‰å…¨æ€§é«˜ï¼Œå†™å…¥æ—¶éœ€è¦å¤åˆ¶æ•°æ®ï¼Œç£ç›˜åˆ©ç”¨ç‡è¾ƒä½ã€‚
3. **RAID 5**ï¼šæä¾›å¥‡å¶æ ¡éªŒï¼Œå®¹å¿å•ä¸ªç£ç›˜æ•…éšœï¼Œé€‚åˆå¹³è¡¡æ€§èƒ½ä¸å†—ä½™éœ€æ±‚ã€‚
4. **RAID 6**ï¼šåŒé‡å¥‡å¶æ ¡éªŒï¼Œæ›´é«˜å®‰å…¨æ€§ï¼Œé€‚ç”¨äºå…³é”®æ•°æ®ä¿æŠ¤ã€‚
5. **RAID 10ï¼ˆ1+0ï¼‰**ï¼šå…¼é¡¾ RAID 1 çš„å®‰å…¨æ€§å’Œ RAID 0 çš„é€Ÿåº¦ã€‚
6. **RAID 50/60**ï¼šé€‚åˆä¼ä¸šçº§å¤§å‹å­˜å‚¨ç³»ç»Ÿï¼Œç»“åˆ RAID 0 çš„æ€§èƒ½å’Œ RAID 5/6 çš„å†—ä½™ã€‚

å‚è€ƒ:

- [RAID ç±»å‹](https://zh.wikipedia.org/wiki/RAID)
- [Synology-é€‰æ‹© RAID ç±»å‹](https://kb.synology.cn/zh-cn/DSM/help/DSM/StorageManager/storage_pool_what_is_raid?version=7)
- [ä»€ä¹ˆæ˜¯ Synology Hybrid RAID (SHR)](https://kb.synology.cn/zh-cn/DSM/tutorial/What_is_Synology_Hybrid_RAID_SHR)
- [RAID è®¡ç®—å™¨](https://www.synology.cn/zh-cn/support/RAID_calculator)

é™¤äº†ä¸Šè¿°è¿™äº›å¸¸è§çš„ RAID ç±»å‹, ä¸€äº›ç¡¬ä»¶å’Œè½¯ä»¶å‚å•†è¿˜ä¼šå¼€å‘è‡ªå·±çš„ç£ç›˜å†—ä½™é˜µåˆ—æŠ€æœ¯æˆ–å¢å¼ºæŠ€æœ¯ï¼š

{% folding ğŸª¬ å…¶ä»–å‚å•†çš„ç£ç›˜å†—ä½™é˜µåˆ—æŠ€æœ¯æˆ–å¢å¼ºæŠ€æœ¯ %}

1. **ZFS**ï¼ˆZettabyte File Systemï¼‰

   - **å‚å•†/å¼€å‘è€…**ï¼šSun Microsystemsï¼ˆç°å±äº Oracleï¼‰
   - **ç‰¹ç‚¹**ï¼š
     - ZFS é›†æ–‡ä»¶ç³»ç»Ÿå’Œå·ç®¡ç†å™¨äºä¸€ä½“ã€‚
     - æä¾›ç±»ä¼¼äº RAID çš„å¤šç§æ¨¡å¼ï¼ˆå¦‚ RAID-Zã€RAID-Z2ã€RAID-Z3ï¼‰ã€‚
     - æ”¯æŒå¿«ç…§ã€æ•°æ®å®Œæ•´æ€§æ ¡éªŒã€é‡å¤æ•°æ®åˆ é™¤ï¼ˆdeduplicationï¼‰ã€‚
     - æä¾›åŠ¨æ€æ¡å¸¦åŒ–ï¼Œæ— éœ€å›ºå®šæ¡å¸¦å¤§å°ã€‚
   - **ä¼˜åŠ¿**ï¼š
     - é«˜æ•°æ®å®Œæ•´æ€§ï¼šåŸºäºæ ¡éªŒç æ£€æµ‹å’Œä¿®å¤æ•°æ®æŸåã€‚
     - çµæ´»æ€§ï¼šæ”¯æŒåœ¨çº¿æ‰©å±•å­˜å‚¨æ± ã€‚
   - **é€‚ç”¨åœºæ™¯**ï¼šå®¶åº­ NASï¼ˆå¦‚ TrueNASï¼‰ã€ä¼ä¸šå­˜å‚¨ã€é«˜å¯é æ€§å¤‡ä»½ã€‚

2. **SHR**ï¼ˆSynology Hybrid RAIDï¼‰

   - **å‚å•†/å¼€å‘è€…**ï¼šSynology
   - **ç‰¹ç‚¹**ï¼š

     - æä¾›ç±»ä¼¼äº RAID çš„åŠŸèƒ½ï¼Œä½†æ”¯æŒ**æ··åˆç¡¬ç›˜å®¹é‡**ã€‚
     - è‡ªåŠ¨ä¼˜åŒ–å­˜å‚¨åˆ©ç”¨ç‡ï¼Œå…è®¸ç”¨æˆ·ä½¿ç”¨ä¸åŒå¤§å°çš„ç¡¬ç›˜ç»„åˆã€‚
     - æ”¯æŒ 1 è‡³ 2 å—ç¡¬ç›˜å†—ä½™ï¼ˆç±»ä¼¼ RAID 5 æˆ– RAID 6ï¼‰ã€‚

   - **ä¼˜åŠ¿**ï¼š
     - æ˜“ç”¨æ€§ï¼šé¢å‘æ™®é€šç”¨æˆ·ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®å¤æ‚çš„ RAID æ¨¡å¼ã€‚
     - çµæ´»æ€§ï¼šå…è®¸éšæ—¶æ·»åŠ æ›´å¤§å®¹é‡çš„ç¡¬ç›˜ã€‚
   - **é€‚ç”¨åœºæ™¯**ï¼šSynology NAS ç”¨æˆ·ï¼Œç‰¹åˆ«æ˜¯å®¶åº­å’Œå°å‹ä¼ä¸šå­˜å‚¨ç³»ç»Ÿã€‚

3. UnRAID

   - **å‚å•†/å¼€å‘è€…**ï¼šLime Technology
   - **ç‰¹ç‚¹**ï¼š
     - ä¸ä¼ ç»Ÿ RAID ä¸åŒï¼ŒUnRAID ä¸åšæ¡å¸¦åŒ–æˆ–é•œåƒï¼Œè€Œæ˜¯å°†æ•°æ®ç‹¬ç«‹å­˜å‚¨åœ¨æ¯å—ç¡¬ç›˜ä¸Šã€‚
     - æä¾›ä¸€ä¸ªä¸“ç”¨çš„**å¥‡å¶æ ¡éªŒç›˜**ç”¨äºæ•°æ®å†—ä½™ã€‚
     - æ”¯æŒçµæ´»æ‰©å±•ï¼Œå…è®¸éšæ—¶å¢åŠ ç¡¬ç›˜å¹¶ä½¿ç”¨ä¸åŒå®¹é‡çš„ç¡¬ç›˜ã€‚â€‹
   - **ä¼˜åŠ¿**ï¼š
     - æ•°æ®ç‹¬ç«‹æ€§ï¼šå³ä½¿å¤šå—ç¡¬ç›˜æŸåï¼ŒæœªæŸåçš„ç¡¬ç›˜æ•°æ®ä»å¯ç›´æ¥è¯»å–ã€‚
     - çµæ´»æ€§ï¼šæ— éœ€æ‰€æœ‰ç¡¬ç›˜å®¹é‡ä¸€è‡´ã€‚
   - **é€‚ç”¨åœºæ™¯**ï¼šå®¶åº­åª’ä½“æœåŠ¡å™¨ã€å¤§å®¹é‡å­˜å‚¨éœ€æ±‚ã€‚

4. HPâ€™s ADG (Advanced Data Guarding)

   - **å‚å•†/å¼€å‘è€…**ï¼šHewlett-Packard (HP)
   - **ç‰¹ç‚¹**ï¼š
     - ç±»ä¼¼äº RAID 6ï¼Œæä¾›åŒé‡å¥‡å¶æ ¡éªŒã€‚
     - å¯å…è®¸ä¸¤å—ç£ç›˜åŒæ—¶æ•…éšœè€Œä¸ä¸¢å¤±æ•°æ®ã€‚
     - ä¸“ä¸º HP çš„ä¼ä¸šçº§å­˜å‚¨ç³»ç»Ÿè®¾è®¡ã€‚
   - **ä¼˜åŠ¿**ï¼š
     - æ›´é«˜çš„å®¹é”™æ€§ã€‚
     - ä¸“ä¸ºå¤§å‹ä¼ä¸šçš„é«˜å¯ç”¨æ€§ç¯å¢ƒè€Œè®¾è®¡ã€‚
   - **é€‚ç”¨åœºæ™¯**ï¼šä¼ä¸šå­˜å‚¨ç³»ç»Ÿï¼ˆå¦‚ HP ProLiant æœåŠ¡å™¨ï¼‰ã€‚

5. NetApp RAID-DP

   - **å‚å•†/å¼€å‘è€…**ï¼šNetApp
   - **ç‰¹ç‚¹**ï¼š
     - åŸºäº RAID 4ï¼ˆå•å¥‡å¶æ ¡éªŒï¼‰æ”¹è¿›ï¼Œæä¾›åŒå¥‡å¶æ ¡éªŒï¼ˆç±»ä¼¼ RAID 6ï¼‰ã€‚
     - ä¸“ä¸ºä¼ä¸šçº§å­˜å‚¨ç³»ç»Ÿå’Œå¤§è§„æ¨¡éƒ¨ç½²ä¼˜åŒ–ã€‚
   - **ä¼˜åŠ¿**ï¼š

     - æé«˜å®¹é”™èƒ½åŠ›ï¼Œå¯å®¹å¿ä¸¤å—ç£ç›˜åŒæ—¶æ•…éšœã€‚
     - é›†æˆåœ¨ NetApp çš„ Data ONTAP æ“ä½œç³»ç»Ÿä¸­ï¼Œæ”¯æŒé«˜æ•ˆå¿«ç…§å’Œå¤‡ä»½ã€‚

   - **é€‚ç”¨åœºæ™¯**ï¼šå¤§è§„æ¨¡ä¼ä¸šå­˜å‚¨å’Œè™šæ‹ŸåŒ–ç¯å¢ƒã€‚

6. VMware VSANï¼ˆVirtual SANï¼‰

   - **å‚å•†/å¼€å‘è€…**ï¼šVMware
   - **ç‰¹ç‚¹**ï¼š
     - è½¯ä»¶å®šä¹‰å­˜å‚¨ï¼Œå°†å¤šä¸ªæœåŠ¡å™¨çš„æœ¬åœ°å­˜å‚¨æ•´åˆæˆå…±äº«å­˜å‚¨æ± ã€‚
     - æä¾›åˆ†å¸ƒå¼æ•°æ®å†—ä½™ï¼Œæ”¯æŒ RAID 1ã€RAID 5 å’Œ RAID 6 çº§åˆ«çš„ä¿æŠ¤ã€‚
     - æ•°æ®è·¨èŠ‚ç‚¹åˆ†å¸ƒï¼Œæ”¯æŒä¼ä¸šçº§é«˜å¯ç”¨æ€§ã€‚
   - **ä¼˜åŠ¿**ï¼š
     - é«˜å¯æ‰©å±•æ€§ï¼Œé€‚åˆè¶…èåˆåŸºç¡€æ¶æ„ã€‚
     - ä¸ VMware ç¯å¢ƒæ·±åº¦é›†æˆã€‚
   - **é€‚ç”¨åœºæ™¯**ï¼šè™šæ‹ŸåŒ–å’Œäº‘è®¡ç®—ç¯å¢ƒã€‚

7. Dell EMC VxRail

   - **å‚å•†/å¼€å‘è€…**ï¼šDell EMC
   - **ç‰¹ç‚¹**ï¼š
     - VxRail æ˜¯ Dell EMC æä¾›çš„è¶…èåˆåŸºç¡€æ¶æ„ï¼Œæ•´åˆè®¡ç®—ã€å­˜å‚¨å’Œç½‘ç»œã€‚
     - å­˜å‚¨é‡‡ç”¨åˆ†å¸ƒå¼å†—ä½™æŠ€æœ¯ï¼Œä¸ç›´æ¥ä½¿ç”¨ä¼ ç»Ÿ RAIDï¼Œè€Œæ˜¯åŸºäºå¯¹è±¡çš„å­˜å‚¨åˆ†å¸ƒã€‚
   - **ä¼˜åŠ¿**ï¼š
     - é«˜æ‰©å±•æ€§ï¼šèŠ‚ç‚¹æ‰©å±•çµæ´»ï¼Œé€‚åˆäº‘å’Œä¼ä¸šçº§å­˜å‚¨ã€‚
     - æä¾›ä¼ä¸šçº§å®¹é”™å’Œå†—ä½™ã€‚
   - **é€‚ç”¨åœºæ™¯**ï¼šäº‘è®¡ç®—ã€è¶…èåˆæ•°æ®ä¸­å¿ƒã€‚

8. Windows Storage Spaces

   - **å‚å•†/å¼€å‘è€…**ï¼šMicrosoft
   - **ç‰¹ç‚¹**ï¼š
     - æä¾›ç±»ä¼¼äº RAID çš„åŠŸèƒ½ï¼Œå¦‚æ¡å¸¦åŒ–ï¼ˆRAID 0ï¼‰ã€é•œåƒï¼ˆRAID 1ï¼‰å’Œå¥‡å¶æ ¡éªŒï¼ˆRAID 5ï¼‰ã€‚
     - æ”¯æŒæ··åˆç¡¬ç›˜å®¹é‡ï¼Œå…è®¸åŠ¨æ€æ‰©å±•å­˜å‚¨æ± ã€‚
   - **ä¼˜åŠ¿**ï¼š
     - é›†æˆåœ¨ Windows ç³»ç»Ÿä¸­ï¼Œéƒ¨ç½²æˆæœ¬ä½ã€‚
     - æ˜“äºé…ç½®ï¼Œé€‚åˆä¸­å°å‹ä¼ä¸šå’Œä¸ªäººç”¨æˆ·ã€‚
   - **é€‚ç”¨åœºæ™¯**ï¼šWindows Server æˆ–å®¶åº­ Windows ç³»ç»Ÿä¸Šçš„å­˜å‚¨ç®¡ç†ã€‚

9. Ceph

   - **å‚å•†/å¼€å‘è€…**ï¼šç¤¾åŒºé©±åŠ¨ï¼ˆå¼€æºï¼‰
   - **ç‰¹ç‚¹**ï¼š
     - åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿï¼Œä¸ä¾èµ–ä¼ ç»Ÿ RAIDã€‚
     - æ•°æ®å­˜å‚¨åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œæä¾›é«˜å¯ç”¨æ€§å’Œæ•…éšœæ¢å¤èƒ½åŠ›ã€‚
     - åŸºäºå¯¹è±¡å­˜å‚¨ï¼Œæ”¯æŒåŠ¨æ€æ‰©å±•ã€‚
   - **ä¼˜åŠ¿**ï¼š
     - é«˜æ‰©å±•æ€§å’Œçµæ´»æ€§ã€‚
     - æ— éœ€ä¸“ç”¨ç¡¬ä»¶ï¼Œé€‚åˆå¤§å‹åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿã€‚
   - **é€‚ç”¨åœºæ™¯**ï¼šäº‘å­˜å‚¨ã€è¶…å¤§è§„æ¨¡ä¼ä¸šç¯å¢ƒã€‚

10. IBM GPFSï¼ˆGeneral Parallel File Systemï¼‰
    - **å‚å•†/å¼€å‘è€…**ï¼šIBM
    - **ç‰¹ç‚¹**ï¼š
      - æä¾›åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿå’Œå¹¶è¡Œè®¿é—®åŠŸèƒ½ã€‚
      - æ•°æ®åˆ†å¸ƒåœ¨å¤šä¸ªç£ç›˜æˆ–èŠ‚ç‚¹ä¸Šï¼Œæä¾›é«˜å¯é æ€§å’Œé«˜æ€§èƒ½ã€‚
      - æ”¯æŒè‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œæ•°æ®ä¿®å¤ã€‚
    - **ä¼˜åŠ¿**ï¼š
      - é«˜æ€§èƒ½å’Œé«˜å¯é æ€§ã€‚
      - é€‚åˆå¤§è§„æ¨¡ã€é«˜ååé‡çš„å­˜å‚¨éœ€æ±‚ã€‚
    - **é€‚ç”¨åœºæ™¯**ï¼šä¼ä¸šæ•°æ®ä¸­å¿ƒã€å¤§æ•°æ®åˆ†æã€é«˜æ€§èƒ½è®¡ç®—ï¼ˆHPCï¼‰ã€‚

**æ€»ç»“**

ç°ä»£å‚å•†å¼€å‘çš„ç£ç›˜å†—ä½™æŠ€æœ¯å¤§å¤šæ˜¯å¯¹ä¼ ç»Ÿ RAID çš„ä¼˜åŒ–ï¼Œæä¾›æ›´å¼ºçš„çµæ´»æ€§ã€æ‰©å±•æ€§å’Œå®¹é”™èƒ½åŠ›ã€‚è¿™äº›æŠ€æœ¯ä¸»è¦æœåŠ¡äºä»¥ä¸‹éœ€æ±‚ï¼š

- **å®¶åº­çº§å­˜å‚¨**ï¼šå¦‚ Synology SHRã€UnRAIDã€ZFS;
- **ä¼ä¸šçº§å­˜å‚¨**ï¼šå¦‚ NetApp RAID-DPã€Dell EMC VxRailã€Ceph;
- **è¶…èåˆä¸åˆ†å¸ƒå¼å­˜å‚¨**ï¼šå¦‚ VMware VSANã€IBM GPFS;

{% endfolding %}

> å› ä¸ºæˆ‘çš„ **DS218+** åªæœ‰ 2 ä¸ªç›˜ä½, è€Œ **DS923+** ä¹Ÿåªæ”¯æŒ 2 å— M.2 çš„ SSD, æ‰€ä»¥ç´¢æ€§å°†ä»–ä»¬å…¨éƒ¨æ›´æ¢ä¸º SSD å¹¶ç»„ RAID1, è‡³å°‘èƒ½ä¿è¯åäº†ä¸€å— SSD çš„æƒ…å†µä¸‹ç³»ç»Ÿä»ç„¶èƒ½å¤Ÿè¿è¡Œ.

---

#### DSM é…ç½®å¤‡ä»½

Synology æä¾› [DSM çš„é…ç½®å¤‡ä»½](https://kb.synology.cn/zh-cn/DSM/help/DSM/AdminCenter/system_configbackup?version=7), å¯ä»¥è‡ªåŠ¨å¤‡ä»½åˆ°ä½ çš„ Synology è´¦æˆ·ä¸­, ä¸”å¯æ‰‹åŠ¨å¯¼å‡ºå¤‡ä»½åˆ°æœ¬åœ°(**ç›®å‰åœ¨å¯»æ‰¾å¯è‡ªåŠ¨å¯¼å‡ºå¤‡ä»½æ–‡ä»¶çš„æ–¹æ³•**):

![20241229154732_zlEIvRtE.webp](https://cdn.dong4j.site/source/image/20241229154732_zlEIvRtE.webp)

#### NAS æ•´æœºå¤‡ä»½

[Hyper Backup](https://www.synology.cn/dsm/feature/hyper_backup) å’Œ [Active Backup for Business](https://www.synology.cn/zh-cn/dsm/feature/active_backup_business#pc) éƒ½æä¾›äº† NAS æ•´æœºå¤‡ä»½çš„åŠŸèƒ½, å®ƒä»¬çš„åŒºåˆ«ä¸º:

- å¤‡ä»½æ–¹å¼ä¸åŒ:
  - Active Backup for Business æ˜¯ä½œä¸ºå¤‡ä»½ **ç›®çš„åœ°** ç«¯çš„å¥—ä»¶(A å¤‡ä»½åˆ° B, åœ¨ B ç«¯æ“ä½œ);
  - Hyper Backup æ˜¯ä½œä¸º **å¤‡ä»½æº** ä¸ºè§’è‰²çš„å¥—ä»¶(A å¤‡ä»½åˆ° B, åœ¨ A ç«¯æ“ä½œ);
- è¿˜åŸæ–¹å¼ä¸åŒ:
  - æ•´æœºè¿˜åŸ([è¿˜åŸæ­¥éª¤](https://kb.synology.cn/zh-cn/DSM/help/HyperBackup/restore?version=7)):
    - ä¸¤è€…éƒ½å¯ä»¥;
  - éƒ¨åˆ†æ•°æ®è¿˜åŸ:
    - Active Backup for Business ç›´æ¥åœ¨è¿œç¨‹ NAS ä¸Šæ“ä½œ;
    - Hyper Backup åªèƒ½åœ¨æœ¬æœºæ“ä½œ;
- æ•°æ®æŸ¥çœ‹æ–¹å¼ä¸åŒ:
  - Active Backup for Business èƒ½å¤Ÿé€šè¿‡ **Active Backup for Business Portal** æŸ¥çœ‹å…±äº«ç›®å½•ä¸‹çš„ä»»ä½•æ–‡ä»¶;
  - Hyper Backup æ— æ³•å‹å¥½çš„æŸ¥çœ‹å¤‡ä»½çš„æ–‡ä»¶ç›®å½•ä¸å†…å®¹;
- å¤‡ä»½æ•°æ®æ ¼å¼ä¸åŒ:
  - Active Backup for Business ä¼šå°† NAS ç³»ç»Ÿå¤‡ä»½ä¸º æ•°æ®ç›˜.img å’Œ ç³»ç»Ÿ.img 2 ä¸ªé•œåƒæ–‡ä»¶, åªèƒ½é€šè¿‡ **Active Backup for Business Portal** æŸ¥çœ‹å†…éƒ¨æ•°æ®;
  - Hyper Backup å¤‡ä»½çš„æ˜¯å‹ç¼©æ–‡ä»¶.

> å®˜æ–¹æ¨èçš„æ•´æœºå¤‡ä»½æ–¹å¼æ˜¯ **Hyper Backup**, å¯ä»¥å¤‡ä»½ NAS ä¸Šçš„ **å…±äº«æ–‡ä»¶å¤¹**ã€**åº”ç”¨ç¨‹åºè®¾ç½®** å’Œ **ç³»ç»Ÿé…ç½®**ï¼Œä»è€Œç¡®ä¿æ•´æœºæ•°æ®ä¸ç¯å¢ƒä¸€è‡´æ€§, ä»¥ä¾¿åœ¨ç³»ç»Ÿå‡ºç°é—®é¢˜éœ€è¦é‡è£…æˆ–å½»åº•åæ‰åèƒ½å¤Ÿæ¢å¤åˆ°å¦ä¸€å° NAS ä¸Š, ä½†æ˜¯æˆ‘ä¼šåŒæ—¶ä½¿ç”¨ **Active Backup for Business** å¤‡ä»½å…¨éƒ¨çš„å…±äº«æ•°æ®æ–‡ä»¶, ä»¥ä¾¿åœ¨æ•°æ®è¢«è¯¯åˆ åèƒ½å¤Ÿå•ç‹¬æ¢å¤.

---

##### Hyper Backup

åœ¨ DS218+ ä¸Šåˆ›å»ºæ•´æœºå¤‡ä»½ä»»åŠ¡:

![20241229154732_VUIY1Q8F.webp](https://cdn.dong4j.site/source/image/20241229154732_VUIY1Q8F.webp)

ä»»åŠ¡åˆ›å»ºæˆåŠŸå, å¯åœ¨è¿œç«¯ NAS(DS923+) çš„ **Hyper Backup Vault** æŸ¥çœ‹å¤‡ä»½ä»»åŠ¡:

![20241229154732_U8AJ0dt9.webp](https://cdn.dong4j.site/source/image/20241229154732_U8AJ0dt9.webp)

##### Active Backup for Business

åœ¨ DS923+ ä¸Šåˆ›å»ºæ•´æœºå¤‡ä»½ä»»åŠ¡(éœ€è¦åœ¨ DS218+ ä¸Šå®‰è£… Agent):

![20241229154732_haQLMkXU.webp](https://cdn.dong4j.site/source/image/20241229154732_haQLMkXU.webp)

å¤‡ä»½å®Œæˆåå¯é€šè¿‡ **Active Backup for Business Portal** æŸ¥çœ‹å¤‡ä»½çš„æ•°æ®:

![20241229154732_Vv4y25dU.webp](https://cdn.dong4j.site/source/image/20241229154732_Vv4y25dU.webp)

> ##### è¿˜åŸæ•´ä¸ªç³»ç»Ÿ
>
> **å¯¹äºå·²å®Œæˆé¦–æ¬¡è®¾ç½®çš„ Synology NAS è®¾å¤‡**:
>
> 1. å•å‡» **è¿˜åŸ**ï¼Œç„¶åé€‰æ‹© **æ•´ä¸ªç³»ç»Ÿ**ã€‚æ‚¨å°†è¢«é‡å®šå‘åˆ° **æ§åˆ¶é¢æ¿**ã€‚
> 2. å•å‡» **è¿˜åŸç³»ç»Ÿ** å¹¶é€‰æ‹©å­˜å‚¨å¤‡ä»½æ•°æ®çš„è¿˜åŸæ¥æºã€‚
> 3. æŒ‰å‘å¯¼å®Œæˆè¿˜åŸã€‚
>
> **å¯¹äºå°šæœªå®Œæˆé¦–æ¬¡è®¾ç½®çš„ Synology NAS è®¾å¤‡**:
>
> 1. åœ¨æ¬¢è¿é¡µé¢ä¸Šå•å‡» **è¿˜åŸç³»ç»Ÿ**ã€‚
> 2. é€‰æ‹©å­˜å‚¨å¤‡ä»½æ•°æ®çš„è¿˜åŸæ¥æºã€‚
> 3. æŒ‰å‘å¯¼å®Œæˆè¿˜åŸã€‚

![20241229154732_VC4tJUte.webp](https://cdn.dong4j.site/source/image/20241229154732_VC4tJUte.webp)

---

#### å‚è€ƒ

- [å‚™ä»½ Synology NAS å¤šç¨®è§£æ±ºæ–¹æ¡ˆæ¯”è¼ƒ](https://www.cjkuo.net/synology-nas-backup/)
- [å½“ä½ æ‹¥æœ‰äº†ç¬¬äºŒå° NASï¼Œè¿™æ˜¯ä½ éœ€è¦äº†è§£çš„æ•°æ®è¿ç§»å’ŒåŒæ­¥æ–¹å¼-å°‘æ•°æ´¾](https://sspai.com/post/81509)
- [æ‹…å¿ƒç¾¤æ™–ç¡¬ç›˜æŸåä¸¢å¤±æ•°æ®ï¼Ÿä¸æ¥è¯•è¯• Hyper Backup ï¼Ÿ](https://post.smzdm.com/p/a8pe67kn/)
- [ç¾¤æ™– NAS äº‘ç›˜å¤‡ä»½ç¥å™¨ï¼Œä½¿ç”¨ Cloud Sync æ‰“é€š NAS ä¸æ— ç¼ç½‘ç›˜åŒæ­¥](https://post.smzdm.com/p/all247z8/)
- [Synology-ä¼ä¸šåº”ç”¨ç¯‡](https://post.smzdm.com/p/az59k63n/)
- [ç¾¤æ™– DSM6.1 æ•°æ®å®‰å…¨ä¸‰çŒ›å°† â†’ åŒæ­¥ã€å¤‡ä»½ã€å¿«ç…§ï¼Œ+æ–°å…µ USB Copy2.0](https://post.smzdm.com/p/545304/)
- [Synology-Backup Solution Guide 2023](https://cndl.synology.cn/download/Document/Software/WhitePaper/Package/ActiveBackup/All/enu/Synology_Backup_Solution_Guide_2023_enu.pdf)
- [Synology-å‚™ä»½è§£æ±ºæ–¹æ¡ˆæ¦‚è¦½](https://global.download.synology.com/download/Document/Software/WhitePaper/Os/DSM/All/cht/backup_solution_guide_cht.pdf)

### å†—ä½™å¤‡ä»½

å› ä¸ºæ‰€æœ‰çš„å¤‡ä»½æ–‡ä»¶éƒ½ä¼šæ±‡æ€»åˆ° DS923+ ä¸Š, æ‰€ä»¥æœ€åä¸€é“ä¿é™©å°±æ˜¯ä¸º DS923+ ä¸Šçš„æ–‡ä»¶åˆ›å»ºå†—ä½™å¤‡ä»½.

æ­£å¥½æœ‰ä¸€ä¸ª 8TB çš„ **LaCie d2 Professional** é—²ç½®, å¯ä»¥ç›´æ¥ç”¨ä½œ DS923+ çš„å†—ä½™å¤‡ä»½.

**LaCie d2 Professional** é€šè¿‡ type-c è¿æ¥åˆ°äº†æˆ‘çš„ Mac mini 2018, å…·æœ‰ 10Gb/s çš„é€Ÿåº¦, åœ¨ NAS ä¸Šä½¿ç”¨ **Hyper Backup** å¥—ä»¶, åˆé€‚çš„è¿œç¨‹è¿æ¥æœ‰ rsync å’Œ WebDAV 2 ç§, å°è¯•äº†åœ¨ Mac mini 2018 ä¸Šåˆ†åˆ«éƒ¨ç½² Rsync Server å’Œ WebDAV å, æœ€ç»ˆé€‰æ‹©äº†ç¬¬ä¸€ç§æ–¹å¼.

é¦–å…ˆéœ€è¦äº†è§£ä¸€ä¸‹ rsync åŸºæœ¬å‚æ•°:

```
ä¸€èˆ¬åšå¢é‡åŒæ­¥æ—¶ï¼Œç›´æ¥ä½¿ç”¨ -avz å³å¯ã€‚

rsyncå‚æ•°ï¼š
-a           #å½’æ¡£æ¨¡å¼ä¼ è¾“, ç­‰äº-tropgDl
-v           #è¯¦ç»†æ¨¡å¼è¾“å‡º, æ‰“å°é€Ÿç‡, æ–‡ä»¶æ•°é‡ç­‰ã€‚ä¸€èˆ¬é»˜è®¤æ˜¾ç¤º info=all1ï¼Œæ·»åŠ  -v åä¼šæ˜¾ç¤º info=all2
-z           #ä¼ è¾“æ—¶è¿›è¡Œå‹ç¼©ä»¥æé«˜æ•ˆç‡

-r           #é€’å½’ä¼ è¾“ç›®å½•åŠå­ç›®å½•ï¼Œå³ç›®å½•ä¸‹å¾—æ‰€æœ‰ç›®å½•éƒ½åŒæ ·ä¼ è¾“ã€‚
-t           #ä¿æŒæ–‡ä»¶æ—¶é—´ä¿¡æ¯
-o           #ä¿æŒæ–‡ä»¶å±ä¸»ä¿¡æ¯
-p           #ä¿æŒæ–‡ä»¶æƒé™
-g           #ä¿æŒæ–‡ä»¶å±ç»„ä¿¡æ¯
-l           #ä¿ç•™è½¯è¿æ¥
-P           #æ˜¾ç¤ºåŒæ­¥çš„è¿‡ç¨‹åŠä¼ è¾“æ—¶çš„è¿›åº¦ç­‰ä¿¡æ¯
-D           #ä¿æŒè®¾å¤‡æ–‡ä»¶ä¿¡æ¯
-L           #ä¿ç•™è½¯è¿æ¥æŒ‡å‘çš„ç›®æ ‡æ–‡ä»¶
-e           #ä½¿ç”¨çš„ä¿¡é“åè®®,æŒ‡å®šæ›¿ä»£rshçš„shellç¨‹åº  ssh
--exclude=PATTERN   #æŒ‡å®šæ’é™¤ä¸éœ€è¦ä¼ è¾“çš„æ–‡ä»¶æ¨¡å¼
--exclude-from=file #æ–‡ä»¶åæ‰€åœ¨çš„ç›®å½•æ–‡ä»¶
--bwlimit=100       #é™é€Ÿä¼ è¾“
--partial           #æ–­ç‚¹ç»­ä¼ 
--delete            #è®©ç›®æ ‡ç›®å½•å’Œæºç›®å½•æ•°æ®ä¿æŒä¸€è‡´ï¼Œå½“ src åˆ é™¤æŸä¸ªæ–‡ä»¶æ—¶ï¼Œdst ä¼šåŒæ­¥åˆ é™¤ï¼Œé»˜è®¤æ˜¯ä»…ä¼ è¾“æ–°å¢çš„æ•°æ®ï¼Œä¸ä¼šåˆ é™¤è¿œç«¯å­˜åœ¨ä½†æœ¬ç«¯ä¸å­˜åœ¨çš„æ–‡ä»¶
--debug=all4        #å¼€å¯æœ€é«˜çº§åˆ«çš„debugï¼Œall è¡¨ç¤ºæ˜¾ç¤ºæ‰€æœ‰ä¿¡æ¯ï¼Œ4 ä¸º loglevel çš„æœ€é«˜çº§åˆ«ã€‚
```

åŸºç¡€å‘½ä»¤

```
rsync -avz --delete SRC DST
```

**å‚è€ƒèµ„æ–™**:

- https://ss64.com/bash/rsync_options.html

- [Linux ä¸‹ Rsync å’Œ Tar å¢é‡å¤‡ä»½æ¢³ç†](https://www.cnblogs.com/kevingrace/p/6601088.html)

- [å¤‡ä»½æ•°æ®çš„é‡è¦æ€§ä»¥åŠ rsync çš„åŸºæœ¬ä½¿ç”¨](https://zhuanlan.zhihu.com/p/88338737)

#### macOS ä¸Šæ­å»º Rsync Server

```bash
$ tree
.
â”œâ”€â”€ rsync													# äºŒè¿›åˆ¶æ–‡ä»¶
â”œâ”€â”€ rsyncd.conf.txt								# rsync çš„é…ç½®
â”œâ”€â”€ rsyncd.log										# rsync æ—¥å¿—
â”œâ”€â”€ rsyncd.secrets.txt						# å¯†é’¥
â”œâ”€â”€ rsyncd_nas.log								# åŒæ­¥æ—¥å¿—
â””â”€â”€ start													# å¯åŠ¨è„šæœ¬
```

**å¯åŠ¨è„šæœ¬**:

```bash
#!/bin/bash

nohup /path/to/rsync -vvv --daemon --no-detach --ipv4 --config=/path/to/rsyncd.conf.txt . > /dev/null 2>&1 &
```

**é…ç½®æ–‡ä»¶(rsync.conf.txt)**:

```bash
port = 8873
log file = /path/to/rsyncd.log
use chroot = no

[NAS]
# å¤‡ä»½çš„ç›®çš„åœ°
path = /Volumes/LaCie/Backup/NAS
comment = NAS
log file = /path/to/rsyncd_nas.log
transfer logging = true
read only = false
# è®¤è¯çš„ç”¨æˆ·
auth users = username
secrets file = /path/to/rsyncd.secrets.txt
```

**è®¤è¯é…ç½®(rsyncd.secrets.txt)**

```bash
username:password
```

åœ¨ DS923+ ä¸Šé…ç½® **Hyper Backup** :

![20241229154732_pDQp416p.webp](https://cdn.dong4j.site/source/image/20241229154732_pDQp416p.webp)

ä¸Šé¢çš„ Rsync Server éœ€è¦åœ¨ macOS å¯åŠ¨åæ‰‹åŠ¨æ‰§è¡Œ **start** è„šæœ¬å¯åŠ¨, ä¸ºäº†å‡å°‘æ‰‹åŠ¨æ“ä½œ, æˆ‘ä»¬å¯ä»¥é€šè¿‡ macOS çš„ launchctl æ¥ç®¡ç† Rsync Server çš„è‡ªå¯åŠ¨:

åœ¨ `~/Library/LaunchAgents` ä¸‹æ–°å¢ `xx.xxx.rsync.plist` æ–‡ä»¶:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
  <dict>
    <key>Label</key>
    <string>xx.xxx.rsync.plist</string>
    <key>UserName</key>
    <string>xxx</string>
    <key>KeepAlive</key>
    <true/>
    <key>ProgramArguments</key>
    <array>
        <string>./rsync</string>
        <string>-vvv</string>
        <string>--daemon</string>
        <string>--no-detach</string>
        <string>--ipv4</string>
        <string>--config=rsyncd.conf.txt</string>
        <string>.</string>
    </array>
    <key>WorkingDirectory</key>
    <!-- å·¥ä½œç›®å½•, æ‰€ä»¥ä¸Šé¢çš„ ProgramArguments ä½¿ç”¨çš„æ˜¯ ./rsync -->
    <string>~/rsync-server</string>
    <key>RunAtLoad</key>
    <true/>
    <key>OnDemand</key>
    <false/>
    <key>LaunchOnlyOnce</key>
    <true/>
    <key>StandardErrorPath</key>
    <string>~/rsync-server/err.log</string>
    <key>StandardOutPath</key>
    <string>~/rsync-server/out.log</string>
  </dict>
</plist>
```

åŠ è½½ plist:

```
launchctl load ~/Library/LaunchAgents/xx.xxx.rsync.plist
```

ç¡®è®¤æœåŠ¡å·²è¿è¡Œ:

```bash
$ launchctl list | grep xx.xxx.rsync
3130	0	xx.xxx.rsync
```

```bash
$ ps -ef | grep -v grep | grep --color=auto rsync
  501  3130     1   0 10:47AM ??         0:00.09 ./rsync -vvv --daemon --no-detach --ipv4 --config=rsyncd.conf.txt .
```

![20241229154732_GRk3xPdz.webp](https://cdn.dong4j.site/source/image/20241229154732_GRk3xPdz.webp)

**åŒæ­¥æ—¥å¿—**:

![20241229154732_7zbndo4b.webp](https://cdn.dong4j.site/source/image/20241229154732_7zbndo4b.webp)

å¦‚æœéœ€è¦å¸è½½æœåŠ¡ï¼ˆä¸´æ—¶åœæ­¢å¹¶ä»å¯åŠ¨é¡¹ä¸­ç§»é™¤ï¼‰:

```bash
launchctl unload ~/Library/LaunchAgents/xx.xxx.rsync.plist
```

**å‚è€ƒ**:

- [macOS è®¾ç½®å¼€æœºå¯åŠ¨ä»»åŠ¡](https://0clickjacking0.github.io/2020/05/20/macos%E8%AE%BE%E7%BD%AE%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8%E4%BB%BB%E5%8A%A1/)
- [macOS å®ç°è½¯ä»¶å¼€å¯è‡ªå¯åŠ¨](https://www.liangguanghui.com/macos-login-startup/)
- [Creating Launch Daemons and Agents](https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingLaunchdJobs.html#//apple_ref/doc/uid/10000172i-SW7-BCIEDDBJ)
- [Daemons and Services Programming Guide](https://developer.apple.com/library/content/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/Introduction.html)
- [Technical Note TN2083: Daemons and Agents](http://developer.apple.com/library/mac/technotes/tn2083/)

---

### äº‘ç«¯å¤‡ä»½

æœ€åå°±æ˜¯å¼‚åœ°å¤‡ä»½äº†, è¿™é‡Œç›´æ¥ä½¿ç”¨ **é˜¿é‡Œäº‘ç›˜çš„ WebDAV æœåŠ¡**.

> ä¸ºä»€ä¹ˆä¸ç”¨ **Cloud Sync** åˆ©ç”¨å•å‘åŒæ­¥çš„æ–¹å¼å¤‡ä»½åˆ°äº‘ç«¯:
>
> 1. **Cloud Sync** æ›´é€‚åˆåŒæ­¥æ•°æ®, ä¼šä¿ç•™åŸå§‹çš„æ–‡ä»¶è·¯å¾„;
> 2. **Cloud Sync** ä¸€ä¸ªä»»åŠ¡åªèƒ½é€‰æ‹©ä¸€ä¸ªå…±äº«ç›®å½•;
> 3. æ²¡æœ‰ **Hyper Backup** çš„ **å‹ç¼©å¤‡ä»½**, **å—çº§ä¼ è¾“**, **å¤šç‰ˆæœ¬ç®¡ç†** ç­‰é«˜çº§åŠŸèƒ½;

**å¤‡ä»½åˆ°äº‘ç«¯**:

Hyper Backup æ”¯æŒå¤‡ä»½åˆ°äº‘ç«¯, è¿™é‡Œæˆ‘ç›´æ¥ä½¿ç”¨ **é˜¿é‡Œäº‘ç›˜ WebDAV** è¿™ä¸ªç¬¬ä¸‰æ–¹å¥—ä»¶:

![20241229154732_OjkqZdJm.webp](https://cdn.dong4j.site/source/image/20241229154732_OjkqZdJm.webp)

ç„¶å Hyper Backup é€šè¿‡ **WevDAV** å¤‡ä»½åˆ°é˜¿é‡Œäº‘ç›˜:

![20241229154732_4DViff2E.webp](https://cdn.dong4j.site/source/image/20241229154732_4DViff2E.webp)

[**é˜¿é‡Œäº‘ç›˜ WebDAV å¥—ä»¶ä½¿ç”¨æ•™ç¨‹**](https://imnks.com/3939.html), è·å–åˆ° **refresh_token** åå°±å¯ç›´æ¥ä½¿ç”¨, è¿˜èƒ½åœ¨ File Station ä¸­é€šè¿‡ **è¿œç¨‹è¿æ¥** æŒ‚è½½é˜¿é‡Œäº‘ç›˜åˆ°æœ¬åœ°, å¯ä»¥æ–¹ä¾¿çš„æµè§ˆäº‘ç›˜å†…å®¹:

![20241229154732_X52qX4Ur.webp](https://cdn.dong4j.site/source/image/20241229154732_X52qX4Ur.webp)

> æˆ‘è¿˜ä¼šä½¿ç”¨ é˜¿é‡Œäº‘ç›˜ WebDAV é…åˆ Cloud Sync ä¸‹è½½äº‘ç›˜å†…å®¹, å·¥ä½œæµä¸º:
>
> 1. å°†å¾…ä¸‹è½½çš„æ–‡ä»¶ä¿å­˜åˆ°é˜¿é‡Œäº‘ç›˜;
> 2. ç„¶ååœ¨ DS923+ çš„ Cloud Sync è¿æ¥é˜¿é‡Œäº‘ç›˜çš„ WebDAV æœåŠ¡, è®¾ç½®ä¸º **å•å‘åŒæ­¥**;
> 3. äº‘ç›˜å†…å®¹ä¸‹è½½å®Œæˆåç›´æ¥åœ¨ File Station æŒ‚è½½çš„é˜¿é‡Œäº‘ç›˜ WebDAV ä¸­åˆ é™¤å³å¯. é™¤äº†ç¬¬ä¸€æ­¥, åç»­æµç¨‹å®Œå…¨ä¸éœ€è¦ç™»å½•åˆ°å®˜æ–¹çš„é˜¿é‡Œäº‘ç›˜æ“ä½œ;

### å¤‡ä»½æ—¶é—´æ•´ç†

å› ä¸ºæˆ‘ä½¿ç”¨ NAS ä½œä¸ºå¤‡ä»½ä¸­æ¢, ä¸” 2 å° NAS ä¹‹é—´å­˜åœ¨å…³è”å…³ç³», æ‰€ä»¥æˆ‘éœ€è¦æ•´ç†å¤‡ä»½çš„æ—¶é—´, ä»¥ä¿è¯å¤‡ä»½çš„æ­£ç¡®æ€§ä¸å¯ç”¨æ€§.

> è¿˜éœ€è¦è€ƒè™‘åˆ° 2 å°è·¯ç”±å™¨çš„é‡å¯è®¡åˆ’:
>
> - å°ç±³ AX9000 å‘¨ 2 4 6 çš„ 04:30 å®šæ—¶é‡å¯;
> - å°ç±³ 6500Pro å‘¨ 1 3 5 04:00 å®šæ—¶é‡å¯;

#### macOS

| æºæ–‡ä»¶                   | å¤‡ä»½æ–¹å¼                                   | ç›®çš„åœ°                           | æ—¶é—´                | å¤‡ä»½æ•°é‡ |
| ------------------------ | ------------------------------------------ | -------------------------------- | ------------------- | -------- |
| ç³»ç»Ÿå· [MBP]             | Active Backup for Business(ç‰©ç†æœåŠ¡å™¨å¤‡ä»½) | DS923+:/backups/ActiveBackupData | å‘¨ 1 3 5 21:00 å¯åŠ¨ | 3        |
| æ•´ä¸ªç£ç›˜ [MBP]           | Time Machine                               | DS923+:/timemachine              | å‘¨ 2 4 6 22:00 å¯åŠ¨ | è‡ªåŠ¨è½®è½¬ |
| å…¶ä»–é‡è¦æ–‡ä»¶ [MBP]       | Synology Drive Client                      | DS923+:/home/Backup              | æ¯éš” 8 å°æ—¶å¯åŠ¨     | 1        |
| æ•´ä¸ªç£ç›˜ [Mac mini M2]   | Time Machine                               | AirPort Time Capsule 2T          | æ¯å‘¨                | è‡ªåŠ¨è½®è½¬ |
| æ•´ä¸ªç£ç›˜ [Mac mini 2018] | Time Machine                               | AirPort Time Capsule 2T          | æ¯å‘¨                | è‡ªåŠ¨è½®è½¬ |

#### M920x

| æºæ–‡ä»¶       | å¤‡ä»½æ–¹å¼                                   | ç›®çš„åœ°                          | æ—¶é—´                | å¤‡ä»½æ•°é‡ |
| ------------ | ------------------------------------------ | ------------------------------- | ------------------- | -------- |
| ç³»ç»Ÿå·       | Active Backup for Business(ç‰©ç†æœåŠ¡å™¨å¤‡ä»½) | DS923+:/backup/ActiveBackupData | å‘¨ 1 3 5 12:00 å¯åŠ¨ | 3        |
| 3.860.ssd    | Active Backup for Business(ç‰©ç†æœåŠ¡å™¨å¤‡ä»½) | DS923+:/backup/ActiveBackupData | å‘¨ 2 4 6 12:00 å¯åŠ¨ | 3        |
| 3.860.ssd    | [è‡ªåŠ¨åŒ–è„šæœ¬](#M920x-%20å¤‡ä»½)               | 1.870.ssd                       | æ¯å¤© 2 ç‚¹å¢é‡å¤‡ä»½   | 1        |
| å…¶ä»–é‡è¦æ–‡ä»¶ | Active Backup for Business(æ–‡ä»¶æœåŠ¡å™¨å¤‡ä»½) | DS923+:/backup/m920x            | å‘¨ 1 3 5 05:20 å¯åŠ¨ | 5        |

#### Station

| æºæ–‡ä»¶       | å¤‡ä»½æ–¹å¼                                   | ç›®çš„åœ°                          | æ—¶é—´            | å¤‡ä»½æ•°é‡ |
| ------------ | ------------------------------------------ | ------------------------------- | --------------- | -------- |
| ç³»ç»Ÿå·       | Active Backup for Business(ç‰©ç†æœåŠ¡å™¨å¤‡ä»½) | DS923+:/backup/ActiveBackupData | å‡æ—¥ 22:00 å¯åŠ¨ | 3        |
| å…¶ä»–é‡è¦æ–‡ä»¶ | Active Backup for Business(æ–‡ä»¶æœåŠ¡å™¨å¤‡ä»½) | DS923+:/backup/station          | å‡æ—¥ 19:00 å¯åŠ¨ | 5        |

#### H28K

| æºæ–‡ä»¶       | å¤‡ä»½æ–¹å¼                                        | ç›®çš„åœ°               | æ—¶é—´                | å¤‡ä»½æ•°é‡ |
| ------------ | ----------------------------------------------- | -------------------- | ------------------- | -------- |
| eMMC         | DS923+ ä»»åŠ¡è®¡åˆ’: [eMMC å¤‡ä»½è„šæœ¬](#eMMC-%20å¤‡ä»½) | DS923+:/backups/eMMC | å‘¨ 2 08:00 å¯åŠ¨     | 3        |
| å…¶ä»–é‡è¦æ–‡ä»¶ | Active Backup for Business(æ–‡ä»¶æœåŠ¡å™¨å¤‡ä»½)      | DS923+:/backup/H28K  | å‘¨ 2 4 6 07:00 å¯åŠ¨ | 5        |

#### HK1Box

| æºæ–‡ä»¶       | å¤‡ä»½æ–¹å¼                                        | ç›®çš„åœ°               | æ—¶é—´                | å¤‡ä»½æ•°é‡ |
| ------------ | ----------------------------------------------- | -------------------- | ------------------- | -------- |
| eMMC         | DS923+ ä»»åŠ¡è®¡åˆ’: [eMMC å¤‡ä»½è„šæœ¬](#eMMC-%20å¤‡ä»½) | DS923+:/backups/eMMC | å‘¨ 3 08:00 å¯åŠ¨     | 3        |
| å…¶ä»–é‡è¦æ–‡ä»¶ | Active Backup for Business(æ–‡ä»¶æœåŠ¡å™¨å¤‡ä»½)      | DS923+:/backup/HA    | å‘¨ 1 3 5 09:00 å¯åŠ¨ | 5        |

#### NanoPI NEO4

2 ä¸ª NEO4, ç¬¬äºŒä¸ªå¾€åå»¶é•¿ 30 åˆ†é’Ÿæ‰§è¡Œ.

| æºæ–‡ä»¶                | å¤‡ä»½æ–¹å¼                                        | ç›®çš„åœ°                | æ—¶é—´            | å¤‡ä»½æ•°é‡ |
| --------------------- | ----------------------------------------------- | --------------------- | --------------- | -------- |
| ç³»ç»Ÿ(eMMC) [NEO4.1]   | DS923+ ä»»åŠ¡è®¡åˆ’: [eMMC å¤‡ä»½è„šæœ¬](#eMMC-%20å¤‡ä»½) | DS923+:/backups/eMMC  | å‘¨ 6 19:00 å¯åŠ¨ | 3        |
| å…¶ä»–é‡è¦æ–‡ä»¶ [NEO4.1] | Active Backup for Business(æ–‡ä»¶æœåŠ¡å™¨å¤‡ä»½)      | DS923+:/backup/NEO4.1 | å‘¨ 6 20:00 å¯åŠ¨ | 3        |
| ç³»ç»Ÿ(eMMC) [NEO4.2]   | DS923+ ä»»åŠ¡è®¡åˆ’: [eMMC å¤‡ä»½è„šæœ¬](#eMMC-%20å¤‡ä»½) | DS923+:/backups/eMMC  | å‘¨ 6 19:30 å¯åŠ¨ | 3        |
| å…¶ä»–é‡è¦æ–‡ä»¶ [NEO4.2] | Active Backup for Business(æ–‡ä»¶æœåŠ¡å™¨å¤‡ä»½)      | DS923+:/backup/NEO4.2 | å‘¨ 6 20:30 å¯åŠ¨ | 3        |

#### æ ‘è“æ´¾

4 å°æ ‘è“æ´¾, æ¯å°é—´éš” 30 åˆ†é’Ÿæ‰§è¡Œå¤‡ä»½ä»»åŠ¡

| æºæ–‡ä»¶                | å¤‡ä»½æ–¹å¼                                          | ç›®çš„åœ°                    | æ—¶é—´            | å¤‡ä»½æ•°é‡ |
| --------------------- | ------------------------------------------------- | ------------------------- | --------------- | -------- |
| ç³»ç»Ÿ(SD å¡) [pi4]     | M920x å®šæ—¶ä»»åŠ¡: [é€šè¿‡ç½‘ç»œå¤åˆ¶è„šæœ¬](#é€šè¿‡ç½‘ç»œå¤åˆ¶) | DS923+:/backups/SD/pi4    | å‘¨å¤© 10:00 å¯åŠ¨ | 3        |
| å…¶ä»–é‡è¦æ–‡ä»¶ [pi4]    | Active Backup for Business(æ–‡ä»¶æœåŠ¡å™¨å¤‡ä»½)        | DS923+:/backup/PI4        | å‘¨å¤© 11:00 å¯åŠ¨ | 5        |
| ç³»ç»Ÿ(SD å¡) [pi51]    | M920x å®šæ—¶ä»»åŠ¡: [é€šè¿‡ç½‘ç»œå¤åˆ¶è„šæœ¬](#é€šè¿‡ç½‘ç»œå¤åˆ¶) | DS923+:/backups/SD/pi51   | å‘¨å¤© 10:30 å¯åŠ¨ | 3        |
| å…¶ä»–é‡è¦æ–‡ä»¶ [pi51]   | Active Backup for Business(æ–‡ä»¶æœåŠ¡å™¨å¤‡ä»½)        | DS923+:/backup/PI51       | å‘¨å¤© 11:30 å¯åŠ¨ | 5        |
| ç³»ç»Ÿ(SD å¡) [pi52]    | M920x å®šæ—¶ä»»åŠ¡: [é€šè¿‡ç½‘ç»œå¤åˆ¶è„šæœ¬](#é€šè¿‡ç½‘ç»œå¤åˆ¶) | DS923+:/backups/SD/pi52   | å‘¨å¤© 11:00 å¯åŠ¨ | 3        |
| å…¶ä»–é‡è¦æ–‡ä»¶ [pi52]   | Active Backup for Business(æ–‡ä»¶æœåŠ¡å™¨å¤‡ä»½)        | DS923+:/backup/PI52       | å‘¨å¤© 12:00 å¯åŠ¨ | 5        |
| ç³»ç»Ÿ(SD å¡) [zero2w]  | M920x å®šæ—¶ä»»åŠ¡: [é€šè¿‡ç½‘ç»œå¤åˆ¶è„šæœ¬](#é€šè¿‡ç½‘ç»œå¤åˆ¶) | DS923+:/backups/SD/zero2w | å‘¨å¤© 11:30 å¯åŠ¨ | 3        |
| å…¶ä»–é‡è¦æ–‡ä»¶ [zero2w] | Active Backup for Business(æ–‡ä»¶æœåŠ¡å™¨å¤‡ä»½)        | DS923+:/backup/Zero       | å‘¨å¤© 12:30 å¯åŠ¨ | 5        |

#### R2S && R5S

| æºæ–‡ä»¶               | å¤‡ä»½æ–¹å¼                                                                  | ç›®çš„åœ°                     | æ—¶é—´                | å¤‡ä»½æ•°é‡ |
| -------------------- | ------------------------------------------------------------------------- | -------------------------- | ------------------- | -------- |
| ç³»ç»Ÿ(SD å¡) [R2S.T]  | DS923+ ä»»åŠ¡è®¡åˆ’: [eMMC å¤‡ä»½è„šæœ¬](#eMMC-%20å¤‡ä»½)                           | DS923+:/backups/eMMC       | å‘¨ 1 10:00 å¯åŠ¨     | 3        |
| OpenWrt é…ç½® [R2S.T] | OpenWrt ä»»åŠ¡è®¡åˆ’: [OpenWrt è‡ªåŠ¨å¤‡ä»½è„šæœ¬](#OpenWrt-%20å¤‡ä»½) + æ‰‹åŠ¨ä¸´æ—¶å¤‡ä»½ | æœ¬åœ° U ç›˜ + DS218+:/driver | å‘¨ 1 06:00 å¯åŠ¨     | 5        |
| å…¶ä»–é‡è¦æ–‡ä»¶ [R2S.T] | Active Backup for Business(æ–‡ä»¶æœåŠ¡å™¨å¤‡ä»½)                                | DS923+:/backup/R2ST        | å‘¨ 1 3 5 14:00 å¯åŠ¨ | 5        |
| ç³»ç»Ÿ(SD å¡) [R2S.U]  | DS923+ ä»»åŠ¡è®¡åˆ’: [eMMC å¤‡ä»½è„šæœ¬](#eMMC-%20å¤‡ä»½)                           | DS923+:/backups/eMMC       | å‘¨ 1 11:30 å¯åŠ¨     | 3        |
| OpenWrt é…ç½® [R2S.U] | OpenWrt ä»»åŠ¡è®¡åˆ’: [OpenWrt è‡ªåŠ¨å¤‡ä»½è„šæœ¬](#OpenWrt-%20å¤‡ä»½) + æ‰‹åŠ¨ä¸´æ—¶å¤‡ä»½ | æœ¬åœ° U ç›˜ + DS218+:/driver | å‘¨ 1 07:00 å¯åŠ¨     | 5        |
| å…¶ä»–é‡è¦æ–‡ä»¶ [R2S.U] | Active Backup for Business(æ–‡ä»¶æœåŠ¡å™¨å¤‡ä»½)                                | DS923+:/backup/R2SU        | å‘¨ 1 3 5 15:00 å¯åŠ¨ | 5        |
| ç³»ç»Ÿ(SD å¡) [R2S.C]  | DS923+ ä»»åŠ¡è®¡åˆ’: [eMMC å¤‡ä»½è„šæœ¬](#eMMC-%20å¤‡ä»½)                           | DS923+:/backups/eMMC       | å‘¨ 1 12:30 å¯åŠ¨     | 3        |
| OpenWrt é…ç½® [R2S.C] | OpenWrt ä»»åŠ¡è®¡åˆ’: [OpenWrt è‡ªåŠ¨å¤‡ä»½è„šæœ¬](#OpenWrt-%20å¤‡ä»½) + æ‰‹åŠ¨ä¸´æ—¶å¤‡ä»½ | æœ¬åœ° U ç›˜ + DS218+:/driver | å‘¨ 1 08:00 å¯åŠ¨     | 5        |
| å…¶ä»–é‡è¦æ–‡ä»¶ [R2S.C] | Active Backup for Business(æ–‡ä»¶æœåŠ¡å™¨å¤‡ä»½)                                | DS923+:/backup/R2SC        | å‘¨ 1 3 5 16:00 å¯åŠ¨ | 5        |
| ç³»ç»Ÿ(SD å¡) [R5S]    | DS923+ ä»»åŠ¡è®¡åˆ’: [eMMC å¤‡ä»½è„šæœ¬](#eMMC-%20å¤‡ä»½)                           | DS923+:/backups/eMMC       | å‘¨ 1 13:30 å¯åŠ¨     | 3        |
| OpenWrt é…ç½® [R5S]   | OpenWrt ä»»åŠ¡è®¡åˆ’: [OpenWrt è‡ªåŠ¨å¤‡ä»½è„šæœ¬](#OpenWrt-%20å¤‡ä»½) + æ‰‹åŠ¨ä¸´æ—¶å¤‡ä»½ | æœ¬åœ° U ç›˜ + DS218+:/driver | å‘¨ 1 09:00 å¯åŠ¨     | 5        |
| å…¶ä»–é‡è¦æ–‡ä»¶ [R5S]   | Active Backup for Business(æ–‡ä»¶æœåŠ¡å™¨å¤‡ä»½)                                | DS923+:/backup/R5S         | å‘¨ 1 3 5 17:00 å¯åŠ¨ | 5        |

#### NAS å¿«ç…§

| ä»»åŠ¡å               | å¤‡ä»½æ—¶é—´       | æºåœ°å€           | ç›®çš„åœ°                     | å¤‡ä»½æ•°é‡ |
| -------------------- | -------------- | ---------------- | -------------------------- | -------- |
| DS218-photo-Snap     | æ¯å¤© 00:00     | DS218:/photo     | DS218:/photo/#snapshot     | 5        |
| DS218-driver-Snap    | æ¯å¤© 01:00     | DS218:/driver    | DS218:/driver/#snapshot    | 5        |
| DS218-1Panel-Snap    | æ¯å¤© 20:00     | DS218:/1Panel    | DS218:/1Panel/#snapshot    | 5        |
| DS218-docker-Snap    | æ¯å¤© 20:10     | DS218:/docker    | DS218:/docker/#snapshot    | 5        |
| DS218-Memos-Snap     | æ¯å¤© 22:00     | DS218:/Memos     | DS218:/Memos/#snapshot     | 5        |
| DS218-homes-Snap     | æ¯å¤© 23:00     | DS218:/homes     | DS218:/homes/#snapshot     | 5        |
| DS923-backup-Snap    | å‘¨ 1 3 5 00:10 | DS923:/backup    | DS923:/backup/#snapshot    | 3        |
| DS923-backups-Snap   | å‘¨ 2 4 6 00:10 | DS923:/backups   | DS923:/backups/#snapshot   | 3        |
| DS923-Developer-Snap | å‘¨å¤© 01:00     | DS923:/Developer | DS923:/Developer/#snapshot | 3        |
| DS923-homes-Snap     | æ¯å¤© 01:30     | DS923:/homes     | DS923:/homes/#snapshot     | 5        |
| DS923-photo-Snap     | æ¯å¤© 02:10     | DS923:/photo     | DS923:/photo/#snapshot     | 5        |
| DS923-driver-Snap    | æ¯å¤© 05:00     | DS923:/driver    | DS923:/driver/#snapshot    | 5        |
| DS923-1Panel-Snap    | æ¯å¤© 12:00     | DS923:/1Panel    | DS923:/1Panel/#snapshot    | 5        |
| DS923-Memos-Snap     | æ¯å¤© 13:00     | DS923:/Memos     | DS923:/Memos/#snapshot     | 5        |
| DS923-docker-Snap    | æ¯å¤© 23:00     | DS923:/docker    | DS923:/docker/#snapshot    | 5        |

#### DS218+

| ä»»åŠ¡å          | å¤‡ä»½å¥—ä»¶     | å¤‡ä»½æ—¶é—´   | å¤‡ä»½æº              | ç›®çš„åœ°                            | å¤‡ä»½æ•°é‡ |
| --------------- | ------------ | ---------- | ------------------- | --------------------------------- | -------- |
| backup.apps     | Hyper Backup | å‘¨ 3 14:00 | æ‰€æœ‰ APP            | DS923:/backups/DS218.Apps.hbk     | 3        |
| backup.datas    | Hyper Backup | å‘¨ 2 14:00 | éƒ¨åˆ†å…±äº«ç›®å½•        | DS923:/backups/DS218.Datas.hbk    | 3        |
| backup.system   | Hyper Backup | å‘¨ 4 14:00 | æ•´ä¸ªç³»ç»Ÿ            | DS923:/backups/DS218.System.hbk   | 3        |
| backup.to.cloud | Hyper Backup | å‘¨ 5 14:00 | æ‰€æœ‰ APP + é‡è¦æ•°æ® | é˜¿é‡Œäº‘ç›˜:/backups/DS218.Datas.hbk | 3        |

> **Hyper Backup** æ•´æœºå¤‡ä»½æ— æ³•ä½¿ç”¨ **WebDAV**, åªèƒ½æ˜¯è¿œç¨‹ NAS æˆ– Synology C2 Storage, æ‰€ä»¥åªèƒ½å°† APP å’Œé‡è¦æ•°æ®å¤‡ä»½åˆ°é˜¿é‡Œäº‘ç›˜.

#### DS923+

| ä»»åŠ¡å          | å¤‡ä»½å¥—ä»¶     | å¤‡ä»½æ—¶é—´   | å¤‡ä»½æº                  | ç›®çš„åœ°                            | å¤‡ä»½æ•°é‡ |
| --------------- | ------------ | ---------- | ----------------------- | --------------------------------- | -------- |
| backup.to.Lacie | Hyper Backup | å‘¨å¤© 16:00 | æ‰€æœ‰ APP                | Lacie:/Backup/NAS/DS923           | 3        |
| backup.datas    | Hyper Backup | å‘¨ 3 16:00 | éƒ¨åˆ†å…±äº«ç›®å½•            | é˜¿é‡Œäº‘ç›˜:/backups/DS923.Datas.hbk | 3        |
| VMS             | -            | æ‰‹åŠ¨å¤‡ä»½   | Virtual Machine Manager | DS923:/backups/NAS.VMs            | 3        |

### æ•°æ®å¤‡ä»½æ€»ç»“

![data-backup.drawio.svg](https://cdn.dong4j.site/source/image/data-backup.drawio.svg)

1. macOS ä½¿ç”¨ Time machine å’Œ ABB è¿›è¡Œæ•´æœºå¤‡ä»½, Synology Drive Client åˆ™ç”¨äºé‡è¦æ•°æ®æ•°æ®å†—ä½™å¤‡ä»½;
2. OpenWrt ä½¿ç”¨ ABB æ–‡ä»¶å¤‡ä»½, å¹¶ä½¿ç”¨è„šæœ¬è¿›è¡Œæ•´ä¸ªç³»ç»Ÿå¤‡ä»½;
3. Linux ä½¿ç”¨ ABB çš„ç‰©ç†æœåŠ¡å™¨å’Œæ–‡ä»¶å¤‡ä»½, è¿˜éœ€è¦ä½¿ç”¨è„šæœ¬åœ¨ç‰¹æ®Šæƒ…å†µä¸‹å¤‡ä»½;
4. å¼€å‘ç‰ˆä½¿ç”¨ ABB çš„æ–‡ä»¶å¤‡ä»½, å¹¶ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬å¯¹æ•´ä¸ªç³»ç»Ÿå¤‡ä»½, åŒ…æ‹¬ eMMC å’Œ SD å¡;
5. 2 å° NAS åˆ†åˆ«ä½¿ç”¨å¿«ç…§å¯¹é‡è¦å…±äº«ç›®å½•è¿›è¡Œå¤‡ä»½;
6. DS218+ ä½¿ç”¨ Hyper Backup å¤‡ä»½æ•°æ®åˆ° DS923+, å¹¶ä½¿ç”¨ ABB è¿›è¡Œæ•´æœºå¤‡ä»½;
7. å…¶ä»–è®¾å¤‡çš„å¤‡ä»½æ–‡ä»¶å…¨éƒ¨ä¼ è¾“åˆ° DS923+;
8. DS923+ ä½¿ç”¨ Hyper Backup å¤‡ä»½æ•°æ®åˆ°äº‘ç›˜å’Œå¤–ç½®ç£ç›˜;

è¿™ä¸€æ¬¡ç®—æ˜¯æŠŠæ‰€æœ‰è®¾å¤‡çš„å¤‡ä»½å…¨éƒ¨æ¢³ç†äº†ä¸€é, æ•´ä¸ªå¤‡ä»½ç³»æ­å»ºä¸‹æ¥, æ„Ÿè§‰ DS923+ æ‰¿æ‹…äº†æ‰€æœ‰, å°±æ˜¯ä¸çŸ¥é“å®ƒæ‰›ä¸æ‰›å¾—ä½, è¿™å°±è¦é€šè¿‡æ—¶é—´å»éªŒè¯è¿™å¥—å¤‡ä»½ä½“ç³»äº†.

## æ€»ç»“

è‡³æ­¤, 7 ç¯‡å…³äº HomeLab çš„æ–‡ç« ç®—æ˜¯å…¨éƒ¨å®Œç»“äº†, æˆ‘ä»¥ä¸ºèŠ±ä¸ªä¸€å‘¨æ—¶é—´åº”è¯¥å¯ä»¥å†™ä¸ªä¸ƒä¸ƒå…«å…«, ä½†æ˜¯è¿™å‡ ç¯‡æ–‡ç« åŠ èµ·æ¥èŠ±äº†æ¥è¿‘ä¸€ä¸ªæœˆçš„æ—¶é—´, çœ‹æ¥è¿˜æ˜¯å¤ªé«˜ä¼°è‡ªå·±çš„èƒ½åŠ›äº†, åŸå› åº”è¯¥æ˜¯èŠ±äº†å¤§é‡æ—¶é—´æŸ¥é˜…æ–‡æ¡£ä»¥åŠè¿›è¡Œå„ç§æµ‹è¯•.

å¦‚ä»ŠåŸºäºç›®å‰çš„æ¶æ„, åº”è¯¥å¯ä»¥æ”¯æ’‘å¾ˆé•¿ä¸€æ®µæ—¶é—´, åªè¦æˆ‘ä¸æ‰‹æ®‹æˆ–ä¸æ·»ç½®æ–°çš„è®¾å¤‡, æ‰€ä»¥ HomeLab ç›¸å…³çš„æ–‡ç« åº”è¯¥åˆ°æ­¤ç»“æŸäº†, æˆ–è®¸ä¸‹ä¸€ç¯‡ HomeLab çš„å¼€å§‹åº”è¯¥å°±æ˜¯å¦ä¸€ç§æ¶æ„äº†, æ¯”å¦‚å…¨å¥— [UniFi](https://store.ui.com/us/en) + æœºæ¶äº†, æ…¢æ…¢æŠ˜è…¾å§.

**ç›¸å…³æ–‡ç« :**

1. [[homelab-guide|å…ˆå¯¼ç¯‡]]ï¼šæˆ‘çš„ HomeLab æ¦‚è¦;
2. [[homelab-hardware|ç¡¬ä»¶ç¯‡]]ï¼šä»‹ç»æˆ‘æ‰€æ‹¥æœ‰çš„ç¡¬ä»¶è®¾å¤‡;
3. [[homelab-network|ç½‘ç»œç¯‡]]ï¼šåŒ…æ‹¬ç½‘ç»œç¯å¢ƒã€å¼‚åœ°ç»„ç½‘ä¸ç½‘ç»œå®‰å…¨;
4. [[homelab-service|æœåŠ¡ç¯‡]]ï¼šä½¿ç”¨ Docker æ­å»ºçš„å„ç±»æœåŠ¡;
5. [[homelab-data|æ•°æ®ç¯‡]]ï¼šåŒ…æ‹¬æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆ;
6. [[homelab-data-sync|HomeLabæ•°æ®åŒæ­¥ï¼šæ„å»ºé«˜æ•ˆçš„æ•°æ®åŒæ­¥ç½‘ç»œ]]
7. [[homelab-data-backup|HomeLabæ•°æ®å¤‡ä»½ï¼šæ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿]]
8. [[homelab-upgrade-to-10g|HomeLab ç½‘ç»œç»­é›†ï¼šå‡çº§ 10G ç½‘ç»œ-å†æˆ˜ 10 å¹´]]
9. [[homelab-guide|NAT å†…ç½‘ç©¿é€è¯¦è§£ï¼šæ­ç§˜ç½‘ç»œè¿æ¥èƒŒåçš„å¥¥ç§˜]]

## [HomeLabæ•°æ®åŒæ­¥ï¼šæ„å»ºé«˜æ•ˆçš„æ•°æ®åŒæ­¥ç½‘ç»œ](https://blog.dong4j.site/posts/273b6766.md)

![/images/cover/20241229154732_NXaPIT2E.webp](https://cdn.dong4j.site/source/image/20241229154732_NXaPIT2E.webp)
[å°é¢æ¥æº: Unsplash-Tianyi Ma](https://unsplash.com/photos/macbook-pro-on-white-surface-WiONHd_zYI4)

## æ•°æ®åŒæ­¥

æˆ‘çš„æ•°æ®åŒæ­¥éœ€æ±‚ä¸»è¦æ¶‰åŠåˆ°å·¥ä½œæ–‡ä»¶, å¸¸ç”¨çš„é…ç½®æ–‡ä»¶ä»¥åŠ docker-compose å®¹å™¨ç¼–æ’æ–‡ä»¶, è¿™äº›æ–‡ä»¶éœ€è¦åœ¨å¤šå°ä¸»æœºä¸Šä½¿ç”¨, æ‰€ä»¥ç›´æ¥é‡‡ç”¨ **Synology Drive** åœ¨æ”¯æŒ **Synology Drive Client** çš„ä¸»æœºä¸ŠåŒæ­¥æ–‡ä»¶, ä¸€äº›æ— æ³•å®‰è£… **Synology Drive Client** çš„å¼€å‘æ¿, åˆ™ç›´æ¥ä½¿ç”¨ **Syncthing** åŒæ­¥.

**ç›¸å…³æ–‡ç« :**

1. [[homelab-guide|å…ˆå¯¼ç¯‡]]ï¼šæˆ‘çš„ HomeLab æ¦‚è¦;
2. [[homelab-hardware|ç¡¬ä»¶ç¯‡]]ï¼šä»‹ç»æˆ‘æ‰€æ‹¥æœ‰çš„ç¡¬ä»¶è®¾å¤‡;
3. [[homelab-network|ç½‘ç»œç¯‡]]ï¼šåŒ…æ‹¬ç½‘ç»œç¯å¢ƒã€å¼‚åœ°ç»„ç½‘ä¸ç½‘ç»œå®‰å…¨;
4. [[homelab-service|æœåŠ¡ç¯‡]]ï¼šä½¿ç”¨ Docker æ­å»ºçš„å„ç±»æœåŠ¡;
5. [[homelab-data|æ•°æ®ç¯‡]]ï¼šåŒ…æ‹¬æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆ;
6. [[homelab-data-sync|HomeLabæ•°æ®åŒæ­¥ï¼šæ„å»ºé«˜æ•ˆçš„æ•°æ®åŒæ­¥ç½‘ç»œ]]
7. [[homelab-data-backup|HomeLabæ•°æ®å¤‡ä»½ï¼šæ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿]]
8. [[homelab-upgrade-to-10g|HomeLab ç½‘ç»œç»­é›†ï¼šå‡çº§ 10G ç½‘ç»œ-å†æˆ˜ 10 å¹´]]
9. [[homelab-guide|NAT å†…ç½‘ç©¿é€è¯¦è§£ï¼šæ­ç§˜ç½‘ç»œè¿æ¥èƒŒåçš„å¥¥ç§˜]]

### Synology Drive

**Synology Drive Server** ç”± 3 ä¸ªç‹¬ç«‹çš„å¥—ä»¶ç»„æˆ:

- Synology Drive ç®¡ç†æ§åˆ¶å°: æ˜¯ Synology Drive åº”ç”¨çš„é…ç½®å’Œç›‘æ§ä¸­å¿ƒ, å¯ä»¥é…ç½®åŒæ­¥ä»»åŠ¡, å¤‡ä»½ç‰ˆæœ¬æ§åˆ¶, å®¢æˆ·ç«¯ç®¡ç†ç­‰åŠŸèƒ½;
- Synology Drive ShareSync: ç”¨äºåœ¨ä¸åŒ Synology NAS è®¾å¤‡ä¹‹é—´åŒæ­¥å…±äº«æ–‡ä»¶å¤¹;
- Synology Drive: å¯ä»¥ç†è§£ä¸º NAS ä¸Šçš„ **Synology Drive Client**, å¯ä»¥ç›´æ¥ç®¡ç†å…±äº«çš„æ–‡ä»¶;

#### Synology Drive Server

![20241229154732_hUCM2IhN.webp](https://cdn.dong4j.site/source/image/20241229154732_hUCM2IhN.webp)

**Synology Drive** è¢«æˆ‘ç”¨æ¥åŒæ­¥å·¥ä½œæ–‡ä»¶å’Œå¸¸ç”¨é…ç½®:

![20241229154732_hH5ILzhY.webp](https://cdn.dong4j.site/source/image/20241229154732_hH5ILzhY.webp)

ä¸ºäº†å‡å°‘å¯¹æœ¬åœ°ç£ç›˜çš„ç©ºé—´å ç”¨, **Synology Drive Client** æä¾›äº† **æŒ‰éœ€åŒæ­¥** çš„åŠŸèƒ½, æ–‡ä»¶åªæœ‰åœ¨ä½¿ç”¨æ—¶æ‰ä¼šä¸‹è½½åˆ°æœ¬åœ°(ä½ ä¹Ÿå¯ä»¥è‡ªè¡Œæ‰‹åŠ¨ä¸‹è½½), å…¶ä»–æ—¶å€™éƒ½æ˜¯ä¸€ä¸ªæ–‡ä»¶é“¾æ¥.

æ ¹æ®è‡ªå·±çš„éœ€æ±‚, åœ¨ **MBP** ä¸Š docker-compose å®¹å™¨ç¼–æ’æ–‡ä»¶æ˜¯éœ€è¦å®æ—¶åŒæ­¥çš„, è€Œä¸Šå›¾æ‰€ç¤ºä¸­çš„ **driver** ä¸­çš„æ–‡ä»¶åˆ™é‡‡ç”¨ **æŒ‰éœ€åŒæ­¥**, ä¸ºäº†æ–¹ä¾¿ç»Ÿä¸€ç®¡ç† **Synology Drive** ä¸­çš„æ–‡ä»¶, æˆ‘ä½¿ç”¨è½¯é“¾æ¥çš„æ–¹å¼å°†ä»–ä»¬ä¿å­˜åœ¨ `~/Synology` ç›®å½•ä¸‹(å¦‚æœé‡‡ç”¨ **æŒ‰éœ€åŒæ­¥**, ä¼šåœ¨ `~/Library/CloudStorage/SynologyDrive-xxx` ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåŒæ­¥ç›®å½•).

![20241229154732_yJlCcGKr.webp](https://cdn.dong4j.site/source/image/20241229154732_yJlCcGKr.webp)

åœ¨ **Mac mini 2018** ä¸Šåˆ™å…¨éƒ¨ä½¿ç”¨å®æ—¶åŒæ­¥, ä¸€æ–¹é¢å¯ä»¥å½“åšæœ¬åœ°å¤‡ä»½, å¦ä¸€æ–¹é¢ä¼šå°† **Mac mini 2018** ä½œä¸º **Syncthing** çš„æ¢çº½ä¸å…¶ä»–ä¸æ”¯æŒ **Synology Drive Client** çš„å¼€å‘æ¿è¿›è¡Œæ•°æ®åŒæ­¥.

ä¸è¿‡é—æ†¾çš„æ˜¯åœ¨ Linux ä¸Š **Synology Drive Client** æ²¡æœ‰ **æŒ‰éœ€åŒæ­¥** çš„åŠŸèƒ½, æ‰€ä»¥æˆ‘ä¹Ÿå°† M920x(Ubuntu Server 24.04) å’Œ Station(Ubuntu Server 22.04) ä½œä¸º **Drive** æ–‡ä»¶å¤‡ä»½ä¸»æœº:

#### Synology Drive ShareSync

**Synology Drive ShareSync** ç”¨äºåœ¨ä¸åŒçš„ Synology NAS è®¾å¤‡ä¹‹é—´åŒæ­¥å…±äº«ç›®å½•(å‡†ç¡®çš„è¯´æ˜¯ Drive çš„å›¢é˜Ÿæ–‡ä»¶å¤¹):

![20241229154732_vmqZaw1b.webp](https://cdn.dong4j.site/source/image/20241229154732_vmqZaw1b.webp)

æˆ‘çš„ **Drive** ä¸­çš„æ–‡ä»¶å…¥å£æ˜¯ **DS218+**, æ‰€æœ‰å®¢æˆ·ç«¯éƒ½é“¾æ¥ç€è¿™å° NAS, ç„¶åä¼šé€šè¿‡ **Synology Drive ShareSync** å°† DS218+ ä¸­çš„ **Drive** æ–‡ä»¶å…¨é‡å¤‡ä»½åˆ° **DS923+** ä¸Š:

![20241229154732_DvG8faKw.webp](https://cdn.dong4j.site/source/image/20241229154732_DvG8faKw.webp)

**DS923+** çš„ **Synology Drive ShareSync** ä¸Šé¢å¤–å¢åŠ äº† **photo** å…±äº«ç›®å½•çš„åŒæ­¥, ç›®çš„æ˜¯ç¡®ä¿åœ¨ **DS218+** æŒ‚äº†ä¹‹å, æˆ‘çš„å®¶åº­ç…§ç‰‡ä»ç„¶å¯ä»¥é€šè¿‡ **DS923+** å¿«é€Ÿæ¢å¤.

---

### Cloud Sync

[Cloud Sync](https://www.synology.cn/zh-cn/dsm/feature/cloud_sync) å¯ä»¥å°† Synology NAS ä¸­çš„ä»»æ„æ–‡ä»¶åŒæ­¥è‡³äº‘ç«¯ï¼Œæ”¯æŒå¤šç§äº‘å¹³å°ï¼Œå¹¶æä¾›å•å‘æˆ–åŒå‘åŒæ­¥é€‰é¡¹, å•å‘å¯ä»¥ç”¨ä½œä¸‹è½½ä½¿ç”¨, åŒå‘ç”¨ä½œåŒæ­¥.

å› ä¸º **Synology Drive** åªèƒ½åŒæ­¥å…±äº«ç›®å½•ä¸‹çš„æ–‡ä»¶è€Œæ— æ³•åŒæ­¥ **homes** ä¸‹çš„æ–‡ä»¶, ä½†æ˜¯ Synology çš„ **Photos Mobile** ä¼šå°†ä¸ªäººç…§ç‰‡åŒæ­¥åˆ° **homes** ä¸‹çš„ä¸ªäºº home ç›®å½•ä¸‹, æ‰€ä»¥ä¸ºäº†åŒæ­¥ä¸å¤‡ä»½å…¨å®¶æ‰‹æœºä¸Šçš„ç…§ç‰‡, æˆ‘ä½¿ç”¨ **WebDAV æœåŠ¡** å°† DS218+ ä¸Šçš„å¤šä¸ªä¸ªäºº home ç›®å½•æš´éœ²å‡ºæ¥, ç„¶ååœ¨ DS923+ ä¸Šä½¿ç”¨ **Cloud Sync** åŒæ­¥ä¸ªäºº home ç›®å½•ä¸‹çš„ **Photos** å­ç›®å½•å’Œä¸»è¦ç›®å½•(é Synology Drive å›¢é˜Ÿæ–‡ä»¶å¤¹):

![20241229154732_VC7FApAg.webp](https://cdn.dong4j.site/source/image/20241229154732_VC7FApAg.webp)

è¿™ç§æ–¹å¼çš„å¥½å¤„æ˜¯å½“ Client ä» DS218+ åˆ‡æ¢åˆ° DS923+ ä¸Šå, ä»ç„¶å¯ä»¥é€šè¿‡ **Photos Mobile** æŸ¥çœ‹æ‰‹æœºä¸Šä¿å­˜çš„ä¸ªäººç…§ç‰‡.

> **Synology** çš„æ–‡ä»¶åŒæ­¥æ–¹å¼éå¸¸å¤š, æ¯”å¦‚ **/Memos** ç›®å½•ä½ ä¹Ÿå¯ä»¥è®¾ç½®ä¸º Synology Drive å›¢é˜Ÿæ–‡ä»¶å¤¹, ç„¶åä½¿ç”¨ **Synology Drive ShareSync** æ¥åŒæ­¥:
>
> ![20241229154732_rbcrPTO2.webp](https://cdn.dong4j.site/source/image/20241229154732_rbcrPTO2.webp)

#### ä¸ºä»€ä¹ˆä¸é€‰æ‹© Hyper Backup

**Hyper Backup** ä¹Ÿèƒ½å°†æ•°æ®åŒæ­¥/å¤‡ä»½åˆ°è¿œç¨‹ NAS ä¸Š, ä¸”æä¾›äº† 3 ç§æ–¹å¼:

- è‡ªå¸¦çš„ **å¤‡ä»½åˆ°è¿œç¨‹ NAS è®¾å¤‡**;
- ä½¿ç”¨ rsync;
- ä½¿ç”¨ WebDAV;

åé¢ä¸¤ç§æˆ‘ä»¬å¯ä»¥åœ¨ NAS ä¸Šéƒ¨ç½²ç›¸åº”çš„æœåŠ¡æ¥å®Œæˆä¸Šè¿°éœ€æ±‚(ç›®å‰è¿˜æ²¡æœ‰å°è¯•è¿‡), é—®é¢˜æ˜¯å¤‡ä»½çš„æ–‡ä»¶æ˜¯ **Hyper Backup** ç‰¹æœ‰çš„å‹ç¼©æ–‡ä»¶, æ— æ³•æµè§ˆåŸå§‹æ–‡ä»¶, æ‰€ä»¥å¹¶ä¸èƒ½æ»¡è¶³ç…§ç‰‡çš„åŒæ­¥éœ€æ±‚, ä¸”å®æ—¶æ€§æ²¡æœ‰ **Cloud Sync** é«˜(**Hyper Backup** ä»¥å°æ—¶ä¸ºå•ä½, **Cloud Sync** ä»¥ç§’ä¸ºå•ä½).

### Docker å®¹å™¨æ–‡ä»¶åŒæ­¥

ä¸¤å° NAS ä¸Šçš„ docker å®¹å™¨æ–‡ä»¶éƒ½å­˜å‚¨åœ¨æœ¬æœºçš„ `/docker/0.nas` ç›®å½•ä¸‹, ç„¶åä½¿ç”¨ **Synology Drive ShareSync** åœ¨ä¸¤å° NAS ä¹‹é—´åŒæ­¥, è¿™æ ·å¯ä»¥åœ¨æŸå° NAS å®•æœºåå¿«é€Ÿæ¢å¤æœåŠ¡.

è€Œ `Vaultwarden` è¿™ç±»æ¯”è¾ƒé‡è¦çš„å®¹å™¨ä¼šåŒæ—¶åœ¨ 2 å° NAS ä¸Šå¯åŠ¨, DS218+ ä½œä¸ºä¸»è¦æœåŠ¡æä¾›è€…, ä¸”é€šè¿‡ **Synology Drive ShareSync** å°† **Vaultwarden** å®¹å™¨çš„æ•°æ®æ–‡ä»¶å®æ—¶åŒæ­¥åˆ° DS923+ ä¸Š, è¿™æ ·æˆ‘å¯ä»¥éšæ—¶åˆ‡æ¢ **Vaultwarden** çš„æœåŠ¡æä¾›è€…(**Vaultwarden** çš„æ•°æ®æ–‡ä»¶è¿˜ä¼šé‡‡ç”¨è„šæœ¬å®šæ—¶å¤‡ä»½åˆ°å…¶ä»–å­˜å‚¨è®¾å¤‡).

docker-compose çš„ç¼–æ’æ–‡ä»¶åŒæ ·ä¼šä½¿ç”¨ **Drive** + **Syncthing** åœ¨å…¨è®¾å¤‡åŒæ­¥, å¥½å¤„æ˜¯èƒ½å¤Ÿåœ¨å…¶ä»–å¯„ä¸»æœºå¿«é€Ÿé‡å»ºæœåŠ¡, é—®é¢˜æ˜¯äº§ç”Ÿçš„å®¹å™¨æ–‡ä»¶æ”¹å¦‚ä½•ç»´æŠ¤.

æ¯”å¦‚æŸäº›é…ç½®æ˜¯å¯„ä¸»æœºç‰¹å®šé…ç½®(æœåŠ¡ç«¯å£ä¸ä¸€æ ·æˆ–ç½‘å¡é…ç½®ä¸ä¸€æ ·ç­‰), æŸäº›æ˜¯é€šç”¨é…ç½®(æ¯”å¦‚ä¸¤å° NAS çš„ docker å®¹å™¨æ–‡ä»¶å¯ä»¥å…±ç”¨), è¿™å°±éœ€è¦æ ¹æ®æƒ…å†µé€‰æ‹©æ€§åŒæ­¥å®¹å™¨æ–‡ä»¶, æ‰€ä»¥æˆ‘åœ¨åŒæ­¥çš„ **docker** ç›®å½•ä¸‹åˆ›å»ºäº†å¤šä¸ªå­ç›®å½•:

```bash
$ tree -d -L 3
docker
    â”œâ”€â”€ docker-compose
    â”‚Â Â  â”œâ”€â”€ AI
    â”‚Â Â  â”œâ”€â”€ apitable
    â”‚Â Â  â”œâ”€â”€ dev
    â”‚Â Â  â”œâ”€â”€ dockge
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ data
    â”‚Â Â  â”‚Â Â  â””â”€â”€ stacks
    â”‚Â Â  â”œâ”€â”€ ...
    â”‚Â Â  â””â”€â”€ v2ray
    â”‚Â Â      â””â”€â”€ data
    â”œâ”€â”€ docker-data
    â”‚Â Â  â”œâ”€â”€ n8n
    â”‚Â Â  â”œâ”€â”€ ...
    â”‚Â Â  â””â”€â”€ watchyourlan
    â””â”€â”€ dockerfiles
        â”œâ”€â”€ anylink
        â”‚Â Â  â”œâ”€â”€ ....
        â””â”€â”€ zfile
```

1. docker-compose ç›®å½•ç”¨äºå­˜å‚¨ docker-compose.yml æ–‡ä»¶, è¿™ä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ä¼šå…¨é‡åŒæ­¥, æ‰€ä»¥ä¼šå°†é€šç”¨çš„ docker å®¹å™¨çš„æŒ‚åœ¨ç›®å½•é…ç½®åˆ° docker-compose.yml çš„åŒçº§ data ç›®å½•ä¸‹;
2. å…¶ä»–ä¸é€šç”¨çš„ docker å®¹å™¨æ–‡ä»¶ä¼šç»Ÿä¸€æŒ‚è½½åˆ° **docker-data** ç›®å½•ä¸‹, docker-data åªä¼šåœ¨å½“å‰æœåŠ¡å™¨ä¸Š;

ä½¿ç”¨ **Drive** åŒæ­¥ docker-compose ç›®å½•, ä¸åŒæ­¥ **docker-data** ç›®å½•, é€šè¿‡è¿™ç§æ–¹å¼æ—¢èƒ½ä¿è¯ docker-compose.yml æ–‡ä»¶åœ¨å…¨è®¾å¤‡åŒæ­¥å’Œå¤‡ä»½, åˆèƒ½ä¿è¯ä¸é€šç”¨çš„ docker å®¹å™¨æ–‡ä»¶åªä¿ç•™åœ¨æœ¬åœ°.

---

### Syncthing

ä¸Šè¿°åŒæ­¥ docker-compose ç¼–æ’æ–‡ä»¶å’Œ docker å®¹å™¨æ–‡ä»¶çš„æ–¹å¼åªé€‚ç”¨äºèƒ½å¤Ÿå®‰è£… **Synology Drive Client** çš„ä¸»æœº, è€Œåœ¨ä¸æ”¯æŒçš„æœåŠ¡å™¨ä¸Šåˆ™é€šè¿‡ **Syncthing** è¿›è¡Œæ–‡ä»¶åŒæ­¥.

#### è‡ªå»ºå‘ç°å’Œä¸­ç»§æœåŠ¡å™¨

å¯ä»¥å‚è€ƒ: [[homelab-service#Syncthing|è‡ªå»º Syncthing çš„å‘ç°æœåŠ¡å™¨å’Œä¸­ç»§æœåŠ¡å™¨]]

#### å…¨å±€å¿½ç•¥æ–‡ä»¶

Syncthing é€šè¿‡ **.stignore** æ–‡ä»¶æ¥å¿½ç•¥åŒæ­¥çš„æ–‡ä»¶æˆ–ç›®å½•, ä½†æ˜¯è¿™ä¸ªæ–‡ä»¶ç¡®ä¸èƒ½è¢« Syncthing åŒæ­¥, æ‰€æœ‰éœ€è¦åœ¨æ¯å°å®‰è£…äº† **Syncthing** çš„ä¸»æœºä¸Šå»é…ç½®éœ€è¦å¿½ç•¥çš„æ–‡ä»¶å’Œç›®å½•. è¿™ä¸ªé—®é¢˜æœ‰ 2 ç§æ–¹å¼å¯ä»¥è§£å†³(å¯ä»¥å‚è€ƒ: [Syncronize .stignore file](https://forum.syncthing.net/t/syncronize-stignore-file/557):

- ä½¿ç”¨è½¯é“¾æ¥, å°† **.stignore** ä¿®æ”¹ä¸ºå…¶ä»–å¯ä»¥åŒæ­¥çš„æ–‡ä»¶å, æ¯”å¦‚ **stignore**;
- ä½¿ç”¨å…¨å±€å¿½ç•¥æ–‡ä»¶, ç„¶åç”¨ `#include å…¨å±€å¿½ç•¥æ–‡ä»¶`;

ä¸ºäº†æé«˜é€šç”¨æ€§, æˆ‘é‡‡ç”¨ç¬¬äºŒç§æ–¹å¼, å…·ä½“å®æ–½æ–¹å¼å¦‚ä¸‹:

æ¯”å¦‚ç°åœ¨ **Mac mini 2018** ä¸Šçš„ `~/Synology` ç›®å½•ç»“æ„å¦‚ä¸‹:

```bash
$ tree -d -L 3
~/Synology											# è¢« Synology Drive Client æ¥ç®¡
    â”œâ”€â”€ docker
    â”‚Â Â  â”œâ”€â”€ docker-compose			# è‡ªæœ‰ docker-compose.yml å’Œ docker å®¹å™¨æ–‡ä»¶, å®æ—¶åŒæ­¥ (åŒæ ·ä¼šè¢« Syncthing æ¥ç®¡)
    â”‚Â Â  â”œâ”€â”€ docker-data					# å¿½ç•¥åŒæ­¥
    â”‚Â Â  â””â”€â”€ dockerfiles					# ç¬¬ä¸‰æ–¹ docker-compose.yml, å®æ—¶åŒæ­¥
    â””â”€â”€ driver
     Â Â  â”œâ”€â”€ ...
     Â Â  â”œâ”€â”€ ...
     Â Â  â””â”€â”€ Syncthing						# è¢« Syncthing æ¥ç®¡çš„ç›®å½•, ä¼šåŒæ­¥åˆ°æ— æ³•å®‰è£… Synology Drive Client çš„è®¾å¤‡ä¸Š
     Â Â   Â Â  â”œâ”€â”€ NanoPI					# NanoPI è®¾å¤‡ä¸“ç”¨
     Â Â   Â Â  â”œâ”€â”€ PI							# æ ‘è“æ´¾ä¸“ç”¨
     Â Â   Â Â  â”œâ”€â”€ share						# å…¨è®¾å¤‡å…±ç”¨
     Â Â   Â Â  â””â”€â”€ temp						# å…¨è®¾å¤‡å…±ç”¨
```

**ç›®å½•ä½¿ç”¨è€…ä¸º:**

![syncthing.drawio.svg](https://cdn.dong4j.site/source/image/syncthing.drawio.svg)

1. docker-compose å…¨è®¾å¤‡åŒæ­¥, ç›®å½•ä¸‹æœ‰ docker-compose.yml å’Œ docker å®¹å™¨æ–‡ä»¶;
2. Share: åœ¨å…¨è®¾å¤‡åŒæ­¥;
3. Temp: ä¸´æ—¶æ–‡ä»¶, åœ¨å…¨è®¾å¤‡åŒæ­¥;
4. NanoPI: ç»™ NanoPI å¼€å‘æ¿ä½¿ç”¨çš„æ–‡ä»¶, åªä¼šåœ¨ NanoPI å¼€å‘æ¿è®¾å¤‡ä¹‹é—´åŒæ­¥;
5. PI: åªç»™æ ‘è“æ´¾ä½¿ç”¨çš„æ–‡ä»¶, åªä¼šåœ¨æ ‘è“æ´¾ä¹‹é—´åŒæ­¥;

> è€Œå‰é¢è¯´çš„ **Mac mini 2018** ä½œä¸º Syncthing çš„æ¢çº½å°±ä½“ç°åœ¨è¿™é‡Œ: `/driver/Syncthing` ä¼šè¢« **Drive** åŒæ­¥åˆ°æ”¯æŒå®‰è£… **Synology Drive Client** çš„è®¾å¤‡ä¸Š, è€Œ `Syncthing` ç›®å½•åˆ™ç”¨äºåœ¨æ— æ³•å®‰è£… **Synology Drive Client** çš„è®¾å¤‡ä¹‹é—´åŒæ­¥æ•°æ®, **Mac mini 2018** ä¼šé€šè¿‡ **Syncthing** æœåŠ¡é“¾æ¥å…¶ä»–å®¢æˆ·ç«¯å®Œæˆæ•°æ®åŒæ­¥.

---

##### stglobalignore

{% folding ğŸª¬ stglobalignore æ–‡ä»¶åŒ…å«äº†é€šç”¨çš„å¿½ç•¥æ–‡ä»¶é…ç½® %}

```
$RECYCLE.BIN
$WINDOWS.~BT
(?d)(?i).DS_Store
(?d)(?i)ehthumbs.db
(?d)(?i)ehthumbs_vista.db
(?d)(?i)Thumbs.db
(?d)(?i)Thumbs.db:encryptable
(?d)(?i)desktop.ini
*.!Sync
*.bak
*.bts
*.Cache
*.crdownload
*.git
*.icloud
*.lnk
*.lock
(?d)(?i)*.log
nohup.out
*.old
*.part
*.shm
*.sqlite*
*.stackdump
*.svn
*.swp
*.sync
*.SyncOld
*.SyncPart
*.SyncTemp
*.tmp
*.wal
*CACHE*
*cache*
*inaccessible*
*S*Conflict*
*s*conflict*
*Temporary*
*~
.#*
.*.swp
.apdisk
.AppleDB
.AppleDesktop
.AppleDouble
.com.apple.timemachine.donotpresent
.DocumentRevisions-V100
.escheck.tmp
.fseventsd
.gvfs
.local/share/trash
.LSOverride
.Prullenbak
.Shared
.Spotlight-V100
.svn
.sync
.SyncArchive
.SyncID
.SyncIgnore
.TemporaryItems
.thumbnails
.Trash*
.trash*
.Trashes
.VolumeIcon.icns
._*
.~lock.
@eaDir
asset-cache
a_writable
captcha_tmp
checkouts
data/searchIndex
dev/
files_trashbin/
forms.json
lost+found
LOST.DIR
Network Trash Folder
nobackup
pagefile.sys
proc/
run/
searchIndex
selinux/
staging.*
sys/
System*Volume*
(?d)temp
templates_c
thumbnails
tmp/
tmp_uploads
trash
Trash*
var/lib/lxcfs/
~$*
```

{% endfolding %}

- ä»¥ `(?i)` å‰ç¼€çš„æ¨¡å¼ä¼šå¯ç”¨å¤§å°å†™ä¸æ•æ„Ÿã€‚å¦‚ `(?!)test` åŒ¹é…ï¼š

  - `test`
  - `TEST`
  - `sEsT`

  `(?!)` å¯ä»¥ä¸å…¶å®ƒæ¨¡å¼ç»“åˆï¼Œä¾‹å¦‚ï¼š`(?!)!picture*.png` ä¼šæŒ‡å®š `Picture1.PNG` ä¸è¢«å¿½ç•¥ã€‚åœ¨ macOS å’Œ Windows ä¸Šï¼Œæ¨¡å¼æ°¸è¿œæ˜¯å¤§å°å†™ä¸æ•æ„Ÿçš„ã€‚

- ä»¥ `(?d)` å‰ç¼€çš„æ¨¡å¼ï¼Œå¦‚æœè¿™äº›æ–‡ä»¶åœ¨é˜»æ­¢ç›®å½•çš„åˆ é™¤ï¼Œå°±ä¼šåˆ é™¤è¿™äº›æ–‡ä»¶ã€‚è¿™ä¸ªå‰ç¼€åº”è¯¥è¢«ä»»ä½• OS ç”Ÿæˆçš„èƒ½éšæ„ç§»é™¤çš„æ–‡ä»¶ä½¿ç”¨ã€‚

##### .stignore

åœ¨æ¯ä¸ªéœ€è¦åŒæ­¥çš„ç›®å½•ä¸‹éƒ½éœ€è¦é…ç½®ä¸€ä¸ªè¿™æ ·çš„æ–‡ä»¶, ç”¨äºé…ç½®å½“å‰ç›®å½•çš„åŒæ­¥è§„åˆ™, é¦–å…ˆéœ€è¦åœ¨æ­¤æ–‡ä»¶ä¸­å¼•å…¥ **stglobalignore** æ–‡ä»¶, ç„¶åå¯ä»¥æ ¹æ®éœ€æ±‚æ·»åŠ å…¶ä»–éœ€è¦å¿½ç•¥çš„æ–‡ä»¶æˆ–ç›®å½•.

æˆ‘çš„ç›®æ ‡æ˜¯è®© **stglobalignore** èƒ½å¤Ÿé€šè¿‡ **Syncthing** åŒæ­¥, æ‰€ä»¥æˆ‘å°† **stglobalignore** æ”¾åœ¨äº† **share** ç›®å½•ä¸‹, é‚£ä¹ˆæ ¹æ®å‰é¢çš„ **Mac mini 2018** ç›®å½•ç»“æ„:

```bash
$ tree -d -L 3
~/Synology
    â”œâ”€â”€ docker
    â”‚Â Â  â”œâ”€â”€ docker-compose
    â”‚Â Â  â”œâ”€â”€ docker-data
    â”‚		â””â”€â”€ dockerfiles
    â””â”€â”€ driver
     Â Â  â”œâ”€â”€ ...
     Â Â  â”œâ”€â”€ ...
     Â Â  â””â”€â”€ Syncthing
     Â Â   Â Â  â”œâ”€â”€ NanoPI
     Â Â   Â Â  â”œâ”€â”€ PI
     Â Â   Â Â  â”œâ”€â”€ share
            â”‚     â””â”€â”€ stglobalignore æ–‡ä»¶
            â”œâ”€â”€ temp
     Â Â   Â Â  â””â”€â”€ åç»­å…¶ä»–å¯èƒ½éœ€è¦æ·»åŠ çš„ç›®å½•
```

1. NanoPI, PI, temp ç›®å½•ä¸‹çš„ `.stignore` é…ç½®: `#include ../share/stglobalignore`;
2. share ç›®å½•ä¸‹çš„ `.stignore` é…ç½®: `#include stglobalignore`;
3. docker-compose ç›®å½•ä¸‹çš„ `.stignore` é…ç½®: `#include ../../driver/Syncthing/share/stglobalignore`

> å› ä¸ºå†å²åŸå› , **docker-compose** ç›®å½•å¹¶æ²¡æœ‰æ”¾åˆ° **driver/Syncthing** ç›®å½•ä¸‹.
>
> ä½†æ˜¯åœ¨å…¶ä»–æ— æ³•éƒ¨ç½² **Synology Drive Client** çš„è®¾å¤‡ä¸Š, **docker-compose** åŒæ ·æ˜¯åœ¨ **Syncthing** ç›®å½•ä¸‹, æ‰€ä»¥æ­¤æ—¶ docker-compose ç›®å½•ä¸‹çš„ `.stignore` åº”è¯¥é…ç½®ä¸º: `#include ../share/stglobalignore`;

è‡³æ­¤æˆ‘ä»¬å°† **stglobalignore** é€šè¿‡ **Syncthing** åŒæ­¥åˆ°å…¨è®¾å¤‡, ç„¶ååªéœ€è¦åœ¨æ¯ä¸ªè®¾å¤‡ä¸Šé…ç½®ä¸€æ¬¡å³å¯å…¨è®¾å¤‡ä½¿ç”¨, åé¢å¦‚æœéœ€è¦æ·»åŠ å…¶ä»–é€šç”¨çš„å¿½ç•¥é…ç½®, åªéœ€è¦åœ¨ä»»æ„ä¸€å°è®¾å¤‡ä¸Šä¿®æ”¹ **stglobalignore** é…ç½®å³å¯.

Mac mini 2018 è´Ÿè´£æ‰€æœ‰ç›®å½•çš„åŒæ­¥, è€Œå…¶ä»–è®¾å¤‡åªéœ€è¦åŒæ­¥è‡ªå·±å…³å¿ƒçš„ç›®å½•å³å¯.

![20241229154732_07FruUGY.webp](https://cdn.dong4j.site/source/image/20241229154732_07FruUGY.webp)

<!-- R2S å’Œæ ‘è“æ´¾ æ²¡å¤„ç† -->

#### å‚è€ƒ

- [Syncthing-Ignoring Files](https://docs.syncthing.net/users/ignoring.html)
- [Syncthing å¿½ç•¥æ¨¡å¼](https://publish.obsidian.md/chinesehelp/01+2021%E6%96%B0%E6%95%99%E7%A8%8B/Syncthing%E5%BF%BD%E7%95%A5%E6%A8%A1%E5%BC%8F+by+%E6%B7%B3%E5%B8%85%E4%BA%8C%E4%BB%A3)
- [ä½¿ç”¨ Syncthing å¿½ç•¥æ¨¡å¼ï¼Œç”¨ç™½åå•çš„æ–¹å¼åŒæ­¥æŒ‡å®šæ ¼å¼æ–‡ä»¶](https://forum-zh.obsidian.md/t/topic/731)
- [Syncthing global ignore file](https://gist.github.com/marksharrison/ec7646f9539a770f2e86b53c7fc7d309)
- [Syncthing ç”±ã€Œå¿½ç•¥æ¨¡å¼ã€å¯¼è‡´çš„åŒæ­¥å¼‚å¸¸](https://keenwon.com/syncthing-error-caused-by-ignoring-mode/)

---

### æ•°æ®åŒæ­¥æ€»ç»“

![data-sync.drawio.svg](https://cdn.dong4j.site/source/image/data-sync.drawio.svg)

1. ä½¿ç”¨ **Synology Drive Client** åŒæ­¥å·¥ä½œæ–‡ä»¶å’Œå¸¸ç”¨é…ç½®ç­‰ä¸€äº›éœ€è¦ç»å¸¸ä½¿ç”¨åˆ°çš„æ–‡ä»¶, å¯ä»¥é€‰æ‹© **å®æ—¶åŒæ­¥** å’Œ **æŒ‰éœ€åŒæ­¥**( Linux å®¢æˆ·ç«¯ä¸æ”¯æŒ **æŒ‰éœ€åŒæ­¥**);
2. **DS218+** ä½œä¸ºæ‰€æœ‰ **Synology Drive Client** çš„å¤–éƒ¨å…¥å£, æ‰€æœ‰çš„ Drive æ•°æ®éƒ½å…ˆé€šè¿‡ DS218+ è¿›å…¥ HomeLab;
3. åœ¨ DS923+ ä¸Šä½¿ç”¨ **Synology Drive ShareSync** ä¸ DS218+ ä¸Šçš„ **photo** , **docker** å’Œ **driver** 3 ä¸ªå…±äº«ç›®å½•åŒæ­¥;
4. åœ¨ DS923+ ä¸Šä½¿ç”¨ **Cloud Sync** ä¸ DS218+ ä¸Šçš„ä¸ªäºº home ç›®å½•ä¸‹çš„ Photos ç›®å½•åŒæ­¥;
5. **Mac mini 2018** ä½œä¸º **HomeLab** ä¸­é‡è¦æ•°æ®åŒæ­¥çš„æ¢çº½, ä¸ºä¸æ”¯æŒ **Synology Drive Client** çš„ä¸»æœºæä¾›é€šè¿‡ **Syncthing** åŒæ­¥æ•°æ®;

ä¸Šè¿°æ–¹å¼åˆ†åˆ«ç»“åˆ **Drive** å’Œ **Syncthing**, æŠŠ **Mac mini 2018** ä½œä¸ºåŒæ­¥æ¢çº½, å°†é‡è¦æ–‡ä»¶åœ¨å…¨å¹³å°è¿›è¡Œäº†åŒæ­¥. åç»­åªéœ€è¦åœ¨æŸä¸€å°ä¸»æœºä¸Šæ“ä½œ **~/Synology** ç›®å½•ä¸‹çš„æ–‡ä»¶å³å¯åŒæ­¥åˆ°æ‰€æœ‰è®¾å¤‡.

æˆ‘ç°åœ¨çš„æ“ä½œæ–¹å¼ä¸º:

- æ„Ÿå…´è¶£çš„ Docker å®¹å™¨ç›´æ¥åœ¨ **docker-compose** ç›®å½•ä¸‹åˆ›å»º **docker-compose.yml** æ–‡ä»¶, æ ¹æ®éœ€è¦é€‰æ‹©æ˜¯å¦åŒæ­¥åˆ°å…¶ä»–è®¾å¤‡(éœ€è¦åŒæ­¥çš„å°±æŒ‚è½½åœ¨ docker-compose ä¸‹, ä¸éœ€è¦åŒæ­¥çš„å°±æŒ‚è½½ docker-data ç›®å½•ä¸‹), è¿™æ ·æˆ‘å°±èƒ½åœ¨å…¨å¹³å°ä»»æ„ä¸€å°ä¸»æœºä¸Šéƒ¨ç½²è¿™ä¸ª Docker æœåŠ¡;
- å…³é”®çš„å·¥ä½œæ–‡ä»¶ç›´æ¥æ‰”åˆ° **~/Synology/driver/å·¥ä½œæ–‡ä»¶** ç›®å½•ä¸‹, è¿™æ ·åœ¨å®¶ä¹Ÿèƒ½éšæ—¶ç¼–è¾‘å·¥ä½œæ–‡ä»¶;
- è„‘å›¾, Obsidian, Drawio, Surge é…ç½®ç­‰æ–‡ä»¶ç›´æ¥æ‰”åˆ° **~/Synology/driver/** æŒ‡å®šç›®å½•ä¸‹, åŒæ­¥çš„åŒæ—¶ä¹Ÿèƒ½å¤‡ä»½åˆ°å…¶ä»–è®¾å¤‡ä¸Š;
- éœ€è¦å¯¹å¼€å‘æ¿, æ ‘è“æ´¾ç­‰æ‰¹é‡å¤„ç†çš„æ–‡ä»¶, å…¨éƒ¨æ‰”åˆ° **~/Synology/driver/Syncthing** ç›®å½•ä¸‹, å®ƒä»¬ä¼šè‡ªåŠ¨åŒæ­¥åˆ°æŒ‡å®šçš„è®¾å¤‡ä¸Š, ä¸å†éœ€è¦é€šè¿‡ FTP ä¸€ä¸ªä¸ªæ‹·è´;
- è‡ªå®šä¹‰è„šæœ¬å…¨éƒ¨æ‰”åˆ° **~/Synology/driver/DevOps** ç›®å½•ä¸‹,
- å¤šå° macOS å…±ç”¨çš„é…ç½®æ–‡ä»¶å…¨éƒ¨æ‰”åˆ° **~/Synology/driver/macOS** ç›®å½•ä¸‹, æ¯”å¦‚ **.zshrc**, **.ssh/config**, **SSH å¯†é’¥**, **Alfred é…ç½®** ç­‰, æ­¤ç›®å½•åŒæ—¶å…¼å¤‡æ–‡ä»¶å¤‡ä»½çš„åŠŸèƒ½, æ¯”å¦‚å¤šå¹³å°çš„ **Wireguard** é…ç½®, **Royal TSX é…ç½®**, **SnippetsLab æ–‡ä»¶** ç­‰;

**ç›¸å…³æ–‡ç« :**

1. [[homelab-guide|å…ˆå¯¼ç¯‡]]ï¼šæˆ‘çš„ HomeLab æ¦‚è¦;
2. [[homelab-hardware|ç¡¬ä»¶ç¯‡]]ï¼šä»‹ç»æˆ‘æ‰€æ‹¥æœ‰çš„ç¡¬ä»¶è®¾å¤‡;
3. [[homelab-network|ç½‘ç»œç¯‡]]ï¼šåŒ…æ‹¬ç½‘ç»œç¯å¢ƒã€å¼‚åœ°ç»„ç½‘ä¸ç½‘ç»œå®‰å…¨;
4. [[homelab-service|æœåŠ¡ç¯‡]]ï¼šä½¿ç”¨ Docker æ­å»ºçš„å„ç±»æœåŠ¡;
5. [[homelab-data|æ•°æ®ç¯‡]]ï¼šåŒ…æ‹¬æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆ;
6. [[homelab-data-sync|HomeLabæ•°æ®åŒæ­¥ï¼šæ„å»ºé«˜æ•ˆçš„æ•°æ®åŒæ­¥ç½‘ç»œ]]
7. [[homelab-data-backup|HomeLabæ•°æ®å¤‡ä»½ï¼šæ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿]]
8. [[homelab-upgrade-to-10g|HomeLab ç½‘ç»œç»­é›†ï¼šå‡çº§ 10G ç½‘ç»œ-å†æˆ˜ 10 å¹´]]
9. [[homelab-guide|NAT å†…ç½‘ç©¿é€è¯¦è§£ï¼šæ­ç§˜ç½‘ç»œè¿æ¥èƒŒåçš„å¥¥ç§˜]]

## [HomeLab å­˜å‚¨ä¸å¤‡ä»½ï¼šæ•°æ®å ¡å’-ä¿éšœæ•°æ®å’Œéšç§çš„å­˜å‚¨è§£å†³æ–¹æ¡ˆ](https://blog.dong4j.site/posts/b808f350.md)

![/images/cover/20241229154732_woi0CTG0.webp](https://cdn.dong4j.site/source/image/20241229154732_woi0CTG0.webp)
[å°é¢æ¥æº: Unsplash-Taylor Vick](https://unsplash.com/photos/cable-network-M5tzZtFCOfs)

**ç›¸å…³æ–‡ç« :**

1. [[homelab-guide|å…ˆå¯¼ç¯‡]]ï¼šæˆ‘çš„ HomeLab æ¦‚è¦;
2. [[homelab-hardware|ç¡¬ä»¶ç¯‡]]ï¼šä»‹ç»æˆ‘æ‰€æ‹¥æœ‰çš„ç¡¬ä»¶è®¾å¤‡;
3. [[homelab-network|ç½‘ç»œç¯‡]]ï¼šåŒ…æ‹¬ç½‘ç»œç¯å¢ƒã€å¼‚åœ°ç»„ç½‘ä¸ç½‘ç»œå®‰å…¨;
4. [[homelab-service|æœåŠ¡ç¯‡]]ï¼šä½¿ç”¨ Docker æ­å»ºçš„å„ç±»æœåŠ¡;
5. [[homelab-data|æ•°æ®ç¯‡]]ï¼šåŒ…æ‹¬æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆ;
6. [[homelab-data-sync|HomeLabæ•°æ®åŒæ­¥ï¼šæ„å»ºé«˜æ•ˆçš„æ•°æ®åŒæ­¥ç½‘ç»œ]]
7. [[homelab-data-backup|HomeLabæ•°æ®å¤‡ä»½ï¼šæ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿]]
8. [[homelab-upgrade-to-10g|HomeLab ç½‘ç»œç»­é›†ï¼šå‡çº§ 10G ç½‘ç»œ-å†æˆ˜ 10 å¹´]]
9. [[homelab-guide|NAT å†…ç½‘ç©¿é€è¯¦è§£ï¼šæ­ç§˜ç½‘ç»œè¿æ¥èƒŒåçš„å¥¥ç§˜]]


## ç®€ä»‹

åœ¨æœ¬ç¯‡åšå®¢ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨å¦‚ä½•åœ¨ HomeLab ä¸­å®ç°é«˜æ•ˆçš„æ•°æ®å­˜å‚¨ã€å¤‡ä»½å’ŒåŒæ­¥æ–¹æ¡ˆã€‚

éšç€ä¸ªäººæ•°æ®çš„ä¸æ–­å¢é•¿ï¼Œæ•°æ®çš„å®‰å…¨æ€§å’Œå¯ç”¨æ€§å˜å¾—è¶Šæ¥è¶Šé‡è¦ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¸€ç§è¢«ç§°ä¸º **3-2-1 åŸåˆ™** çš„å¤‡ä»½ç­–ç•¥ï¼Œä»¥ç¡®ä¿æˆ‘ä»¬çš„æ•°æ®åœ¨å‘ç”Ÿæ„å¤–æ—¶èƒ½å¤Ÿå¾—åˆ°åŠæ—¶æ¢å¤ã€‚

**[3-2-1 å¤‡ä»½åŸåˆ™](https://www.backblaze.com/blog/the-3-2-1-backup-strategy/) çš„æ ¸å¿ƒè¦ç‚¹å¦‚ä¸‹ï¼š** (å¦å¤–ä¸€äº›ç»†èŠ‚åˆ†æå¯ä»¥çœ‹éŸ¦æ˜“ç¬‘åœ¨çŸ¥ä¹çš„å›ç­”:[ã€Šå¦‚ä½•é•¿æ—¶é—´ä¿å­˜é‡è¦æ•°æ®ï¼Ÿã€‹](https://www.zhihu.com/question/313837243/answer/660457814?edition=yidianzixun&utm_source=yidianzixun))

- **3 ä»½å¤‡ä»½æ•°æ®**ï¼šæˆ‘ä»¬ä¸åº”ä¾èµ–å•ä¸€çš„æ•°æ®å¤‡ä»½ï¼Œè€Œåº”è¯¥æ‹¥æœ‰è‡³å°‘ä¸¤ä»½æ•°æ®å‰¯æœ¬ä½œä¸ºé¢å¤–çš„å®‰å…¨ä¿éšœã€‚è¿™æ ·å¯ä»¥å¤§å¤§é™ä½å› å•ä¸€å¤‡ä»½æ•…éšœå¯¼è‡´æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚
- **2 ç§ä¸åŒçš„å­˜å‚¨å½¢å¼**ï¼šä¸ºäº†è¿›ä¸€æ­¥ç¡®ä¿æ•°æ®çš„å†—ä½™å’Œå®‰å…¨ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ä¸¤ç§ä¸åŒç±»å‹çš„åª’ä»‹æ¥å­˜å‚¨æ•°æ®ã€‚ä¾‹å¦‚ï¼Œé™¤äº†ä¼ ç»Ÿçš„æœ¬åœ°ç¡¬ç›˜å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è€ƒè™‘å°†æ•°æ®ä¸Šä¼ åˆ°äº‘æœåŠ¡æä¾›å•†ï¼Œæˆ–è€…åˆ¶ä½œç‰©ç†åª’ä½“å¦‚ DVD ä½œä¸ºå¤‡ä»½æ•°æ®çš„å­˜å‚¨æ–¹å¼ã€‚
- **1 ä»½å¼‚åœ°å¤‡ä»½**ï¼šè€ƒè™‘åˆ°è‡ªç„¶ç¾å®³ã€ç«ç¾ç­‰ä¸å¯æŠ—åŠ›å› ç´ å¯èƒ½å¯¼è‡´æœ¬åœ°å¤‡ä»½å¤±æ•ˆçš„æƒ…å†µï¼Œæˆ‘ä»¬åº”è¯¥è‡³å°‘æœ‰ä¸€ä»½æ•°æ®å¤‡ä»½åœ¨ç¦»æœ¬åœ°è¾ƒè¿œçš„åœ°æ–¹ã€‚è¿™æ ·å³ä½¿å‘ç”Ÿäº†æç«¯æƒ…å†µï¼Œæˆ‘ä»¬ä¹Ÿèƒ½ä»å¼‚åœ°å¤‡ä»½ä¸­æ¢å¤æ•°æ®ã€‚

åœ¨æ‰§è¡Œ 321 åŸåˆ™ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è¿›è¡Œä¸€æ­¥é‡è¦çš„å·¥ä½œâ€”â€”å¯¹æ•°æ®è¿›è¡Œåˆ†ç±»ã€‚ä¸æ˜¯æ‰€æœ‰çš„æ•°æ®éƒ½éœ€è¦è¿›è¡Œä¸¥æ ¼çš„å¤‡ä»½ä¿æŠ¤ã€‚ä¾‹å¦‚ï¼Œä¸€äº›å¯ä»¥é€šè¿‡äº’è”ç½‘è½»æ¾è·å–çš„ç”µå½±å’Œæ¸¸æˆæ–‡ä»¶ï¼Œå¯èƒ½å°±ä¸éœ€è¦ä½œä¸ºé‡ç‚¹å¤‡ä»½å¯¹è±¡ã€‚ç›¸åï¼Œæˆ‘ä»¬åº”è¯¥é›†ä¸­ç²¾åŠ›å¯¹é‚£äº›å…·æœ‰é«˜ä»·å€¼ã€éš¾ä»¥æ¢å¤æˆ–ä¸å¯æ›¿ä»£çš„æ•°æ®è¿›è¡Œå…¨é¢çš„å¤‡ä»½ä¿æŠ¤ã€‚

é€šè¿‡éµå¾ª 321 åŸåˆ™å¹¶åˆç†åˆ†ç±»æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ HomeLab ä¸­å»ºç«‹ä¸€ä¸ªå¼ºå¤§çš„æ•°æ®å ¡å’ï¼Œç¡®ä¿æˆ‘ä»¬çš„æ•°æ®å’Œéšç§å¾—åˆ°æœ‰æ•ˆä¿éšœã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ NAS ç³»ç»Ÿä¸­å®ç°è¿™äº›å¤‡ä»½å’ŒåŒæ­¥ç­–ç•¥ï¼Œå¹¶æä¾›ä¸€äº›å®ç”¨çš„æŠ€å·§å’Œå»ºè®®ã€‚è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢å¦‚ä½•æ‰“é€ ä¸€ä¸ªæ—¢å®‰å…¨åˆé«˜æ•ˆçš„æ•°æ®å­˜å‚¨è§£å†³æ–¹æ¡ˆå§ï¼

---

## å¤‡ä»½ç­–ç•¥

ä»¥ä¸‹æ˜¯ä¸º HomeLab å®æ–½æœ‰æ•ˆå¤‡ä»½ç­–ç•¥çš„å…³é”®æ­¥éª¤ï¼š

1. **ç¡®å®šå¤‡ä»½å†…å®¹**ï¼šç¡®å®šéœ€è¦å¤‡ä»½çš„æ•°æ®ï¼ŒåŒ…æ‹¬ç³»ç»Ÿæ–‡ä»¶ã€åº”ç”¨ç¨‹åºé…ç½®ã€ä¸ªäººæ–‡ä»¶ç­‰ã€‚
2. **é€‰æ‹©å¤‡ä»½å·¥å…·**ï¼šæ ¹æ®éœ€æ±‚å’Œè®¾å¤‡é€‰æ‹©åˆé€‚çš„å¤‡ä»½å·¥å…·ï¼Œå¦‚ Rsyncã€Duplicati æˆ–å…¶ä»–å•†ä¸šå¤‡ä»½è§£å†³æ–¹æ¡ˆã€‚
3. **åˆ¶å®šå¤‡ä»½è®¡åˆ’**ï¼šæ ¹æ®æ•°æ®çš„é‡è¦æ€§å’Œå˜åŠ¨é¢‘ç‡åˆ¶å®šå¤‡ä»½è®¡åˆ’ï¼Œå¦‚æ¯å¤©ã€æ¯å‘¨æˆ–æ¯æœˆè¿›è¡Œå¤‡ä»½ã€‚
4. **é…ç½®å¤‡ä»½ç›®æ ‡**ï¼šä¸ºå¤‡ä»½æ•°æ®é€‰æ‹©åˆé€‚çš„å­˜å‚¨ä»‹è´¨å’Œä½ç½®ï¼Œç¡®ä¿éµå¾ª 3-2-1 å¤‡ä»½åŸåˆ™ã€‚
5. **ç›‘æ§å’ŒéªŒè¯å¤‡ä»½**ï¼šå®šæœŸæ£€æŸ¥å¤‡ä»½æ˜¯å¦æˆåŠŸå®Œæˆï¼Œå¹¶éªŒè¯å¤‡ä»½æ•°æ®çš„å®Œæ•´æ€§ã€‚
6. **æµ‹è¯•æ•°æ®æ¢å¤**ï¼šå®šæœŸè¿›è¡Œæ•°æ®æ¢å¤æµ‹è¯•ï¼Œç¡®ä¿åœ¨å®é™…éœ€è¦æ—¶èƒ½å¤Ÿå¿«é€Ÿæ¢å¤æ•°æ®ã€‚

## ç¡®å®šå¤‡ä»½å†…å®¹

### æ•°æ®åˆ†ç±»

åœ¨ **HomeLab** ç¯å¢ƒä¸­, æ•°æ®æ–‡ä»¶é€šå¸¸å¯ä»¥åˆ†ä¸ºå·²ä¸‹å‡ ç±»:

#### ç³»ç»Ÿä¸é…ç½®

è¿™äº›æ–‡ä»¶ä¸»è¦ç”¨äºç³»ç»Ÿæ¢å¤å’Œç¯å¢ƒé‡å»ºï¼Œç¡®ä¿ HomeLab ç¨³å®šè¿è¡Œï¼Œé¿å…å› ç³»ç»Ÿæ•…éšœå¯¼è‡´æ•°æ®ä¸¢å¤±æˆ–æœåŠ¡ä¸å¯ç”¨ã€‚

1. **ç³»ç»Ÿé•œåƒ**ï¼š
   - æ ‘è“æ´¾ã€å¼€å‘æ¿ã€NASï¼ˆå¦‚ DSMï¼‰ã€è™šæ‹Ÿæœºé•œåƒï¼ˆKVMï¼‰ç­‰;
   - æ“ä½œç³»ç»Ÿå®Œæ•´å¤‡ä»½ï¼ˆå¦‚ OpenWrt è·¯ç”±ç³»ç»Ÿã€Ubuntu Serverï¼‰;
2. **é…ç½®æ–‡ä»¶**ï¼š
   - **æœåŠ¡é…ç½®**ï¼šä¾‹å¦‚ docker-compose.yml æ–‡ä»¶ã€Nginx Proxy Manager é…ç½®ç­‰;
   - **ç½‘ç»œé…ç½®**ï¼šWireGuard é…ç½®ã€Surge é…ç½®ã€DNS è®°å½•ç­‰;
   - **å¼€å‘ç›¸å…³çš„é…ç½®**: IntelliJ IDEA é…ç½®å’Œæ’ä»¶ã€Maven é…ç½®ã€Obsidian é…ç½®å’Œæ’ä»¶ç­‰;
   - **ç³»ç»Ÿä¸ªæ€§åŒ–è®¾ç½®**ï¼šmacOS/Linux ä¸Šçš„ dotfilesï¼ˆzshã€vimã€tmuxã€ssh é…ç½®ï¼‰;

#### æ•°æ®ç±»

æ•°æ®ç±»æ–‡ä»¶åŒ…æ‹¬æ‰€æœ‰ç”±ä¸ªäººç”¨æˆ·ç”Ÿæˆæˆ–å­˜å‚¨çš„æ•°æ®ï¼Œè¿™äº›æ–‡ä»¶é€šå¸¸æ˜¯ä¸å¯æ›¿ä»£çš„ï¼Œå¿…é¡»é‡ç‚¹ä¿æŠ¤ã€‚

1. **ä¸ªäººä¸å®¶åº­æ•°æ®**ï¼š

   - å®¶åº­ç…§ç‰‡ã€è§†é¢‘ã€ä¸ªäººè®°å½•ï¼ˆç¬”è®°ã€ç”µå­ä¹¦åº“ï¼‰;
   - é‡è¦æ–‡æ¡£ï¼šå·¥ä½œæ–‡ä»¶ã€ç®€å†ã€æŠ¥è¡¨ã€æ‰‹ç¨¿ç­‰ã€‚

2. **å·¥ä½œä¸ä»£ç å­˜å‚¨**ï¼š

   - æºä»£ç ã€é¡¹ç›®æ–‡æ¡£ã€å¼€å‘ç¯å¢ƒæ•°æ®ã€‚
   - Git ä»“åº“å¤‡ä»½ï¼ˆå¯åœ¨æœ¬åœ°æˆ–è¿œç¨‹é•œåƒä¿å­˜ï¼‰ã€‚

3. **æ•°æ®åº“ä¸åº”ç”¨æ•°æ®**ï¼š
   - è‡ªæ‰˜ç®¡æœåŠ¡çš„æ•°æ®å¤‡ä»½ï¼Œå¦‚ Bitwarden æ•°æ®åº“ã€Home Assistant é…ç½®ã€‚
   - MySQLã€PostgreSQLã€MongoDB ç­‰æ•°æ®åº“å®šæœŸå¯¼å‡ºå’Œå¤‡ä»½;

#### åª’ä½“ä¸èµ„æº

ä¸»è¦åŒ…æ‹¬è§†é¢‘ã€éŸ³ä¹ã€ç”µå­ä¹¦ç­‰éç‹¬ä¸€æ— äºŒçš„èµ„æºï¼Œå¤‡ä»½æ—¶å¯é™ä½ä¼˜å…ˆçº§ï¼Œä¸»è¦ç¡®ä¿å¯è®¿é—®æ€§ã€‚

1. **å½±è§†èµ„æº**ï¼šç”µå½±ã€ç”µè§†å‰§ã€ç»¼è‰ºèŠ‚ç›®ç­‰;

2. **éŸ³ä¹èµ„æº**ï¼šNAS ä¸­çš„æ— æŸéŸ³ä¹;

3. **ç”µå­ä¹¦ä¸å­¦ä¹ èµ„æ–™**ï¼šè¯¾ç¨‹èµ„æºã€PDF æ–‡ä»¶ã€æŠ€æœ¯ä¹¦ç±ç­‰;

#### è™šæ‹Ÿæœºä¸å®¹å™¨å¤‡ä»½

å¯¹äºè¿è¡Œåœ¨ HomeLab ä¸­çš„è™šæ‹Ÿæœºï¼ˆVMï¼‰å’Œå®¹å™¨åŒ–åº”ç”¨ï¼Œå¤‡ä»½é•œåƒå’Œæ•°æ®æ˜¯é‡å»ºæœåŠ¡çš„å…³é”®ã€‚

1. **è™šæ‹Ÿæœºå¤‡ä»½**ï¼šKVM/QEMUã€VMware ESXiã€Proxmox VE è™šæ‹Ÿæœºé•œåƒ;

2. **å®¹å™¨å¤‡ä»½**ï¼šDocker é•œåƒä¸å®¹å™¨å·ï¼ˆVolumeï¼‰æ•°æ®;

   å‚è€ƒ:

   - [4 Easy Ways to Backup Docker Volumes](https://dev.to/code42cate/4-easy-ways-to-backup-docker-volumes-cjg)
   - [docker-volume-backup](https://github.com/offen/docker-volume-backup)
   - [Backup and Restore of Docker Volumes: A Step-by-Step Guide](https://osmosys.co/blog/backup-and-restore-of-docker-volumes-a-step-by-step-guide/)
   - [Back Up and Share Docker Volumes with This Extension](https://www.docker.com/blog/back-up-and-share-docker-volumes-with-this-extension/)

#### è‡ªåŠ¨åŒ–è„šæœ¬ä¸å·¥å…·

åœ¨ HomeLab ç¯å¢ƒä¸­ï¼Œå¾ˆå¤šä»»åŠ¡ä¾èµ–è‡ªåŠ¨åŒ–è„šæœ¬å’Œå·¥å…·ï¼Œå¤‡ä»½è¿™äº›å†…å®¹å¯ä»¥èŠ‚çœé‡å»ºæ—¶é—´.

1. **è‡ªåŠ¨åŒ–è„šæœ¬**ï¼šShell è„šæœ¬ã€Ansible Playbookã€Python è„šæœ¬ç­‰è‡ªåŠ¨åŒ–ä»»åŠ¡;
2. **å·¥å…·é…ç½®**ï¼šå¦‚ CI/CD æµæ°´çº¿é…ç½®ï¼ˆGitLab Runnerã€Jenkinsï¼‰, è‡ªåŠ¨å¤‡ä»½ä»»åŠ¡ï¼ˆCron Jobã€systemd å®šæ—¶ä»»åŠ¡ï¼‰;

---

### å¤‡ä»½åŸåˆ™

#### è‡ªäº§å†…å®¹å¤‡ä»½

è‡ªäº§å†…å®¹æ˜¯ä¸ªäººèµ„äº§çš„ç²¾åï¼Œå®ƒä»¬ä¸ä»…åŒ…å«äº†å®è´µçš„æ•°æ®ï¼Œè¿˜ä½“ç°äº†ä¸ªäººçš„æˆé•¿ç»å†ã€‚ä¸ºäº†ç¡®ä¿è¿™äº›å†…å®¹çš„å®‰å…¨ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œç»†è‡´çš„åˆ†ç±»å’Œå¤‡ä»½ã€‚

##### å†…å®¹ç±»

å†…å®¹ç±»æ•°æ®æ˜¯ä¸ªäººç”Ÿæ´»ä¸­ä¸å¯æˆ–ç¼ºçš„éƒ¨åˆ†ï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ç±»ï¼š

- **å®¶åº­ç…§ç‰‡**ï¼šè®°å½•äº†å®¶åº­ç”Ÿæ´»çš„ç‚¹ç‚¹æ»´æ»´ï¼Œæ˜¯çè´µçš„å›å¿†ã€‚å¤‡ä»½æ—¶éœ€ç¡®ä¿ç…§ç‰‡çš„åŸå§‹è´¨é‡å’Œåˆ†è¾¨ç‡ä¸å—æŸå¤±ã€‚
- **ä¸ªäººç¬”è®°**ï¼šåŒ…æ‹¬å­¦ä¹ ç¬”è®°ã€æ—¥è®°ã€çµæ„Ÿè®°å½•ç­‰ï¼Œæ˜¯ä¸ªäººæˆé•¿å’Œæ€è€ƒçš„è§è¯ã€‚éœ€å¤‡ä»½ä¸ºå¯æ£€ç´¢çš„æ ¼å¼ï¼Œä»¥ä¾¿æ—¥åæŸ¥é˜…ã€‚
- **å·¥ä½œæ–‡ä»¶ä¸æºä»£ç **ï¼šå·¥ä½œä¸­äº§ç”Ÿçš„æ–‡æ¡£ã€æŠ¥å‘Šã€é¡¹ç›®æºä»£ç ç­‰ï¼Œå…³ç³»åˆ°èŒä¸šå‘å±•å’Œå·¥ä½œæˆæœçš„ä¿å­˜ã€‚åº”é‡‡ç”¨ç‰ˆæœ¬æ§åˆ¶å·¥å…·è¿›è¡Œå¤‡ä»½ï¼Œä»¥ä¾¿è¿½æº¯å†å²ç‰ˆæœ¬ã€‚

##### é…ç½®ç±»

é…ç½®ç±»æ•°æ®è™½ç„¶ä¸ç›´æ¥äº§ç”Ÿå†…å®¹ï¼Œä½†å®ƒä»¬æ˜¯ä¿è¯ HomeLab ç¡¬ä»¶å’Œè½¯ä»¶æ­£å¸¸è¿è¡Œçš„å…³é”®ã€‚ä¸»è¦åŒ…æ‹¬ï¼š

- **OpenWrt ç³»ç»Ÿé…ç½®**ï¼šç½‘ç»œè®¾å¤‡çš„æ“ä½œç³»ç»Ÿï¼Œå¤‡ä»½åå¯å¿«é€Ÿæ¢å¤ç½‘ç»œç¯å¢ƒã€‚
- **DSM é…ç½®**ï¼šç¾¤æ™– NAS çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«å­˜å‚¨æ± ã€å…±äº«æ–‡ä»¶å¤¹ã€ç”¨æˆ·æƒé™ç­‰é‡è¦ä¿¡æ¯ã€‚
- **æ ‘è“æ´¾ç³»ç»Ÿé•œåƒ**ï¼šå°å‹æœåŠ¡å™¨æˆ–å®éªŒè®¾å¤‡çš„æ“ä½œç³»ç»Ÿï¼Œå¤‡ä»½åå¯å¿«é€Ÿæ¢å¤ç³»ç»ŸçŠ¶æ€ã€‚
- **docker-compose.yml**ï¼šå®¹å™¨ç¼–æ’æ–‡ä»¶ï¼Œç¡®ä¿æœåŠ¡çš„ä¸€è‡´æ€§å’Œå¯è¿ç§»æ€§ã€‚
- **macOS é…ç½®æ–‡ä»¶**ï¼šåŒ…æ‹¬ç³»ç»Ÿè®¾ç½®ã€åº”ç”¨é…ç½®ç­‰ï¼Œä¾¿äºåœ¨æ–°è®¾å¤‡ä¸Šå¿«é€Ÿæ¢å¤å·¥ä½œç¯å¢ƒã€‚
- **è‡ªåŠ¨åŒ–è„šæœ¬**: ä¸€äº›è‡ªç”¨çš„å°è„šæœ¬, åŒ…æ‹¬è‡ªå¯åŠ¨, å®šæ—¶ä»»åŠ¡ç­‰å¯åŠ¨æ–¹å¼çš„é…ç½®;
- å…³é”®è‡ªæ‰˜ç®¡æœåŠ¡çš„æ•°æ®, æ¯”å¦‚ **Bitwarden æ•°æ®**;

ä»¥ä¸Šä¸¤ç±»æ•°æ®å‡éœ€éµå¾ª **3-2-1 å¤‡ä»½åŸåˆ™**ï¼Œå³è‡³å°‘ä¿ç•™ä¸‰ä»½å¤‡ä»½ï¼Œå…¶ä¸­ä¸¤ä»½å­˜å‚¨åœ¨ä¸åŒä»‹è´¨ä¸Šï¼Œä¸€ä»½å­˜æ”¾åœ¨å¼‚åœ°ã€‚

#### çè´µèµ„æº

çè´µèµ„æºä¸»è¦æ˜¯æ¥è‡ªäº’è”ç½‘æˆ–å…¶ä»–æ¸ é“çš„å…±äº«èµ„æºï¼Œæ¯”å¦‚å­¦ä¹ èµ„æ–™ã€ç”µå­ä¹¦ã€å·¥å…·è½¯ä»¶ã€æŠ€æœ¯æ–‡æ¡£ç­‰ã€‚è¿™ç±»èµ„æºè™½ç„¶ä¸å…·å¤‡å”¯ä¸€æ€§ï¼Œä½†æ•´ç†ä¸å½’æ¡£ä»ç„¶èƒ½æå‡å­˜å‚¨æ•ˆç‡ä¸å¯ç”¨æ€§ã€‚

å¯¹äºè¿™ç±»æ•°æ®ï¼Œå¯ä»¥é‡‡å–ä»¥ä¸‹å¤‡ä»½ç­–ç•¥ï¼š

- **æœ¬åœ°åŒå¤‡ä»½**ï¼šåœ¨åŒä¸€å­˜å‚¨è®¾å¤‡ä¸Šä¿å­˜ä¸¤ä»½å‰¯æœ¬ï¼Œä»¥é˜²æ•°æ®ä¸¢å¤±ã€‚
- **å®šæœŸæ£€æŸ¥**ï¼šå®šæœŸæ£€æŸ¥å¤‡ä»½æ–‡ä»¶çš„å®Œæ•´æ€§å’Œå¯è®¿é—®æ€§ï¼Œç¡®ä¿æ•°æ®å®‰å…¨ã€‚

#### å½±è§†æ–‡ä»¶

å½±è§†æ–‡ä»¶åŒ…æ‹¬ç”µå½±ã€ç”µè§†å‰§ã€ç»¼è‰ºèŠ‚ç›®ç­‰ã€‚è¿™ç±»æ–‡ä»¶é€šå¸¸ä½“ç§¯è¾ƒå¤§ï¼Œä½†å¹¶éç¨€ç¼ºèµ„æºï¼Œé‡æ–°è·å–çš„æˆæœ¬è¾ƒä½ã€‚å› æ­¤ï¼Œå­˜å‚¨æ—¶åº”æ³¨é‡é«˜æ•ˆç‡ä¸ä¾¿åˆ©æ€§ã€‚

å½±è§†æ–‡ä»¶é€šå¸¸ä½“ç§¯è¾ƒå¤§ï¼Œå¤‡ä»½æ—¶éœ€è€ƒè™‘å­˜å‚¨ç©ºé—´å’Œè®¿é—®ä¾¿æ·æ€§ã€‚

**å­˜å‚¨å»ºè®®**

1. **ç½‘ç»œäº‘ç›˜**ï¼š

   - é€‰æ‹©å­˜å‚¨ç©ºé—´å¤§ã€æ”¯æŒåœ¨çº¿æ’­æ”¾çš„äº‘ç›˜ï¼Œå¦‚ **115 ç½‘ç›˜**ã€**é˜¿é‡Œäº‘ç›˜** å’Œ **ç™¾åº¦ç½‘ç›˜**ã€‚
   - ä½¿ç”¨ **Alist** ç­‰å·¥å…·ï¼Œç›´æ¥æŒ‚è½½äº‘ç›˜èµ„æºï¼Œæä¾›æµåª’ä½“æ’­æ”¾ä½“éªŒã€‚

2. **æœ¬åœ°å­˜å‚¨ï¼ˆå¯é€‰ï¼‰**ï¼š
   - å¯¹äºéå¸¸å–œæ¬¢çš„å½±è§†ä½œå“ï¼Œå¯ä»¥ä½¿ç”¨ NAS æˆ–å¤–æ¥ç¡¬ç›˜è¿›è¡Œå­˜å‚¨ï¼Œå¹¶é…åˆ **Plex**ã€**Emby** ç­‰åª’ä½“æœåŠ¡å™¨ç®¡ç†ä¸æ’­æ”¾ã€‚
   - å¯ä»¥è®¾ç½®è‡ªåŠ¨åŒ–ä¸‹è½½å·¥å…·ï¼ˆå¦‚ **qBittorrent**ï¼‰å®šæœŸæ•´ç†å’Œä¸‹è½½æ–°èµ„æºã€‚

---

## å·¥å…·é€‰æ‹©

åœ¨é€‰æ‹©å¤‡ä»½å·¥å…·æ—¶ï¼Œä¸»è¦è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªæ ‡å‡†ï¼š

- **æ”¯æŒæœ¬åœ°å’Œäº‘å¤‡ä»½**ï¼šè¿™æ ·å¯ä»¥ç¡®ä¿æ•°æ®åœ¨æœ¬åœ°å’Œè¿œç¨‹éƒ½æœ‰å¤‡ä»½ã€‚
- **æ”¯æŒå¢é‡å¤‡ä»½**ï¼šåªå¤‡ä»½è‡ªä¸Šæ¬¡å¤‡ä»½ä»¥æ¥å‘ç”Ÿå˜åŒ–çš„æ•°æ®ï¼ŒèŠ‚çœæ—¶é—´å’Œå­˜å‚¨ç©ºé—´ã€‚
- **æ”¯æŒå‹ç¼©å’ŒåŠ å¯†**ï¼šä¿æŠ¤æ•°æ®å®‰å…¨çš„åŒæ—¶ï¼Œå‡å°‘å­˜å‚¨éœ€æ±‚ã€‚
- **æ”¯æŒå°†å¤‡ä»½æ•°æ®åˆ†å‰²æˆä¸€å®šå¤§å°**ï¼šè¿™å¯¹äºè¿œç¨‹å¤‡ä»½å°¤å…¶æœ‰ç”¨ï¼Œå¯ä»¥æé«˜å°æ–‡ä»¶çš„ä¸Šä¼ é€Ÿåº¦ï¼Œé™ä½å¤§æ–‡ä»¶ä¸Šä¼ å¤±è´¥çš„é£é™©ã€‚
- **æ”¯æŒå®šæ—¶å¤‡ä»½**ï¼šè‡ªåŠ¨åŒ–çš„å®šæ—¶å¤‡ä»½å¯ä»¥ç¡®ä¿æ•°æ®å§‹ç»ˆæ˜¯æœ€æ–°çš„ã€‚
- **ç¨³å®šæ€§å’Œæ˜“ç”¨æ€§**ï¼šå·¥å…·éœ€è¦ç¨³å®šè¿è¡Œï¼Œå¹¶ä¸”ç”¨æˆ·ç•Œé¢å‹å¥½ï¼Œæ˜“äºæ“ä½œã€‚

ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„å¤‡ä»½å·¥å…·.

### Duplicati

[Duplicati](https://github.com/duplicati/duplicati) æ‹¥æœ‰ä¸€ç³»åˆ—å¼ºå¤§çš„åŠŸèƒ½ï¼Œä½¿å…¶æˆä¸ºè‡ªåŠ©å¼äº‘å¤‡ä»½çš„é¦–é€‰å·¥å…·ï¼š

![20241229154732_itkz82Ci.webp](https://cdn.dong4j.site/source/image/20241229154732_itkz82Ci.webp)

- **å¼ºå¤§çš„åŠ å¯†**ï¼šDuplicati ä½¿ç”¨ AES-256 åŠ å¯†ï¼ˆæˆ– GNU éšç§å«å£«ï¼‰æ¥åœ¨ä¸Šä¼ ä¹‹å‰ä¿æŠ¤æ‰€æœ‰æ•°æ®çš„å®‰å…¨æ€§ã€‚
- **å¢é‡å¤‡ä»½**ï¼šDuplicati é¦–æ¬¡ä¸Šä¼ å®Œæ•´å¤‡ä»½ï¼Œç„¶åå­˜å‚¨è¾ƒå°çš„å¢é‡æ›´æ–°ï¼Œä»¥èŠ‚çœå¸¦å®½å’Œå­˜å‚¨ç©ºé—´ã€‚
- **å®šæ—¶å¤‡ä»½**ï¼šå†…ç½®çš„è®¡åˆ’ç¨‹åºå¯ä»¥è‡ªåŠ¨ä¿æŒå¤‡ä»½æœ€æ–°ã€‚
- **é›†æˆåº”ç”¨æé†’**ï¼šDuplicati ä¼šåœ¨å¤‡ä»½å®Œæˆï¼Œå¤±è´¥ååŠæ—¶é€šçŸ¥ä½ ï¼Œè®©ä½ ç¡ä¸ªå¥½è§‰
- **æ”¯æŒå¤šç§ç›®æ ‡**ï¼šåŠ å¯†çš„å¤‡ä»½æ–‡ä»¶å¯ä»¥ä¼ è¾“åˆ° FTPã€Cloudfilesã€WebDAVã€SSHï¼ˆSFTPï¼‰ã€Amazon S3 ç­‰ç›®æ ‡ã€‚

åœ¨å¤‡ä»½è¿‡ç¨‹ä¸­æŠŠå°æ–‡ä»¶æ‰“åŒ…æˆå—, å—å¤§å°å¯ä»¥è°ƒåˆ°å¾ˆå¤§, å¯ä»¥æ›´å¥½åœ°æ”¯æŒå°æ–‡ä»¶ä¸å‹å¥½çš„åç«¯, ä¸Šä¼ é€Ÿåº¦æ›´é«˜, ä½†ä¾èµ–æœ¬åœ°æ•°æ®åº“ä¸” CPU å ç”¨é«˜. æ¢å¤æ–‡ä»¶æ…¢.

---

### Duplicacy

[Duplicacy](https://github.com/gilbertchen/duplicacy): ä¸ä¾èµ–æœ¬åœ°æ•°æ®åº“, ä½†åœ¨æœåŠ¡å™¨ä¸Šä¼šäº§ç”Ÿå¤§é‡å°æ–‡ä»¶, å¤‡ä»½å¤±è´¥ç‡ç›¸å¯¹æ›´é«˜ä¸€äº›, é€Ÿåº¦æ¯”è¾ƒæ…¢. æ¢å¤æ–‡ä»¶ç›¸å¯¹è¾ƒå¿«.

**CLI** å¼€æºä¸”å¯¹ä¸ªäººå…è´¹, GUI ç‰ˆæœ¬æ”¶è´¹.

Duplicacy ç›®å‰æä¾›ä»¥ä¸‹å­˜å‚¨åç«¯ï¼š

- Local disk
- SFTP
- Dropbox
- Amazon S3
- Wasabi
- DigitalOcean Spaces
- Google Cloud Storage
- Microsoft Azure
- Backblaze B2
- Google Drive
- Microsoft OneDrive
- Hubic
- OpenStack Swift
- **WebDAV (under beta testing)**
- pcloud (via WebDAV)
- Box.com (via WebDAV)
- File Fabric by Storage Made Easy

**å‚è€ƒ**:

- [Duplicati åŠ©ä½ å®ˆæŠ¤å®¶åº­æ•°æ®](https://nasdaddy.com/how-to-install-duplicati-on-your-nas/)
- [Big Comparison - Borg vs Restic vs Arq 5 vs Duplicacy vs Duplicati](https://forum.duplicati.com/t/big-comparison-borg-vs-restic-vs-arq-5-vs-duplicacy-vs-duplicati/9952)

---

### Kopia

[Kopia](https://github.com/kopia/kopia/) æ”¯æŒå°† [åŠ å¯†](https://kopia.io/docs/features/#end-to-end-zero-knowledge-encryption) å’Œ [å‹ç¼©çš„](https://kopia.io/docs/features/#compression) å¿«ç…§ä¿å­˜åˆ°ä»¥ä¸‹æ‰€æœ‰ [å­˜å‚¨ä½ç½®](https://kopia.io/docs/features/#save-snapshots-to-cloud-network-or-local-storage)ï¼š

- **Amazon S3**ä»¥åŠä»»ä½•**ä¸ S3 å…¼å®¹çš„äº‘å­˜å‚¨**
- **Azure Blob å­˜å‚¨**
- **Backblaze B2**
- **Google äº‘ç«¯å­˜å‚¨**
- ä»»ä½•æ”¯æŒ**WebDAV çš„è¿œç¨‹æœåŠ¡å™¨æˆ–äº‘å­˜å‚¨**
- ä»»ä½•æ”¯æŒ**SFTP çš„è¿œç¨‹æœåŠ¡å™¨æˆ–äº‘å­˜å‚¨**
- **Rclone**æ”¯æŒçš„ä¸€äº›äº‘å­˜å‚¨é€‰é¡¹
  - é™¤äº† Kopia ä¹‹å¤–ï¼Œè¿˜éœ€è¦ä¸‹è½½å¹¶è®¾ç½® Rcloneï¼Œä½†ä¹‹å Kopia ä¼šç®¡ç†/è¿è¡Œ Rclone
  - Rclone æ”¯æŒæ˜¯å®éªŒæ€§çš„ï¼šå¹¶éæ‰€æœ‰ Rclone æ”¯æŒçš„äº‘å­˜å‚¨äº§å“éƒ½ç»è¿‡æµ‹è¯•å¯ä»¥ä¸ Kopia é…åˆä½¿ç”¨ï¼Œæœ‰äº›å¯èƒ½æ— æ³•ä¸ Kopia é…åˆä½¿ç”¨ï¼›Kopia å·²ç»é€šè¿‡ Rclone æµ‹è¯•å¯ä»¥ä¸**Dropbox**ã€**OneDrive**å’Œ**Google Drive é…åˆä½¿ç”¨**
- æœ¬åœ°è®¡ç®—æœºä»¥åŠä»»ä½•ç½‘ç»œè¿æ¥å­˜å‚¨æˆ–æœåŠ¡å™¨
- é€šè¿‡è®¾ç½® [Kopia å­˜å‚¨åº“æœåŠ¡å™¨æ¥æ‹¥æœ‰è‡ªå·±çš„æœåŠ¡å™¨](https://kopia.io/docs/repository-server/)

{% asciinema 299387 %}

---

### å¸¸ç”¨å·¥å…·

<!--

[MicroBin](https://github.com/szabodanika/microbin): æ–‡æœ¬å’Œæ–‡ä»¶å…±äº« Web åº”ç”¨ç¨‹åºã€é˜…åå³ç„šï¼›

-->

- [Nextcloud](https://nextcloud.com/): ç§æœ‰äº‘ç›˜ï¼Œå®Œæˆ PC ç«¯æ–‡ä»¶åŒæ­¥ã€ç‰ˆæœ¬æ§åˆ¶ï¼Œæä¾› web ç«¯ã€ç§»åŠ¨ç«¯ appï¼›

- [Immich](https://immich.app/): ç›¸å†Œå¤‡ä»½ã€æµè§ˆï¼Œæä¾› web ç«¯ã€ç§»åŠ¨ç«¯ appï¼›

- [Resilio Sync](https://www.resilio.com/sync/): P2P æ–‡ä»¶åŒæ­¥ï¼Œå…¨å¹³å°æ–‡ä»¶åŒæ­¥ï¼›

- [Restic](https://github.com/restic/restic)ï¼šæ”¯æŒ Linuxã€Windowsã€mac å¹³å°ï¼Œæ”¯æŒå¤‡ä»½ã€æ¢å¤å’Œ mount ä¸‰ç§æ“ä½œï¼Œç”¨æ³•ç®€å•ï¼Œåç«¯æ”¯æŒï¼šæœ¬åœ°æ–‡ä»¶å¤¹ã€SFTPã€HTTP rest serverã€AWS S3ã€Openstack Swiftã€BackBlaze B2ã€å¾®è½¯ Azure Blob å­˜å‚¨ã€Google Cloud Storage

- [Rsync](https://github.com/RsyncProject/rsync): ä¸€ä¸ªç”¨çš„æ¯”è¾ƒå¤šçš„åŒæ­¥å·¥å…·ï¼Œå¯ä»¥ç®€å•çš„å®ç°æ–‡ä»¶çº§åˆ«çš„å¤‡ä»½ã€‚

  æœ‰å¾ˆå¤šäººå†™è¿‡ç›¸å…³çš„æ–‡æ¡£ï¼š

  - [åŸºäº rsync çš„æ•°æ®å¼‚åœ°å¤‡ä»½æ–¹æ¡ˆ](http://wiki.lostsummer.love/Docker/åŸºäºrsyncçš„æ•°æ®å¼‚åœ°å¤‡ä»½æ–¹æ¡ˆ.html)
  - https://www.cnblogs.com/kevingrace/p/6601088.html
  - https://www.jianshu.com/p/db46c42bf51e
  - https://blog.csdn.net/weixin_41843699/article/details/90246940
  - https://averagelinuxuser.com/backup-and-restore-your-linux-system-with-rsync/

- [Rclone](https://github.com/rclone/rclone): ç”¨äºåœ¨äº‘å­˜å‚¨ä¹‹é—´åŒæ­¥æ–‡ä»¶å’Œç›®å½•ã€‚è¯¥ç¨‹åºæ”¯æŒå¤šç§äº‘å­˜å‚¨æä¾›å•†ï¼ŒåŒ…æ‹¬ Google Driveã€S3ã€Dropbox ç­‰ï¼Œå¹¶æä¾›å¤šç§åŠŸèƒ½ï¼Œå¦‚æ–‡ä»¶åŒæ­¥ã€åŠ å¯†ã€å‹ç¼©ç­‰.

  - [åˆ©ç”¨ Rclone å°† PVE å¤‡ä»½åŒæ­¥åˆ° OneDrive](https://www.dolingou.com/article/rclone-pve-backup-onedrive)
  - [rclone é£Ÿç”¨æ‰‹å†Œï¼Œå¿«é€Ÿä¸Šæ‰‹è‡ªåŠ¨å¤‡ä»½ï¼Œå®ç° Google Drive åŒæ­¥ç½‘ç«™çš„å¤‡ä»½ç›®å½•](https://vilark.com/167.html)

- [Mackup](https://github.com/lra/mackup?tab=readme-ov-file): å®ƒå¯ä»¥å¸®åŠ©ç”¨æˆ·åœ¨ macOS å’Œ Linux ç³»ç»Ÿä¸­åŒæ­¥åº”ç”¨ç¨‹åºé…ç½®æ–‡ä»¶ã€‚Mackup æ”¯æŒå¤šç§å­˜å‚¨æ–¹æ¡ˆï¼Œå¦‚ Dropboxã€Google Drive å’Œ iCloudï¼Œå¹¶æ”¯æŒå¤šç§åº”ç”¨ç¨‹åºï¼Œå¦‚ Gitã€1Passwordã€Visual Studio Code ç­‰ã€‚

  âš ï¸Mackup åœ¨ Macos Sonoma ä¸­æ— æ³•æ­£å¸¸å·¥ä½œï¼Œå› ä¸ºå®ƒä¸æ”¯æŒé¦–é€‰é¡¹çš„ç¬¦å·é“¾æ¥æ–‡ä»¶ã€‚è¿è¡Œæ­¤ä»£ç å°†ç ´åæ‰€æœ‰ç”¨æˆ·é¦–é€‰é¡¹ï¼Œå¹¶ä¸”æ— æ³•æ¢å¤ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…é—®é¢˜ [#1924](https://github.com/lra/mackup/issues/1924)å’Œ [2035](https://github.com/lra/mackup/issues/2035)ã€‚

### å…¶ä»–å·¥å…·

- [awesome-sysadmin-Backups](https://github.com/awesome-foss/awesome-sysadmin?tab=readme-ov-file#backups)
- [List of Backup Software](https://github.com/restic/others)

### å‚è€ƒ

- [Synchronization and backup programs - ArchWiki (archlinux.org)](https://wiki.archlinux.org/title/Synchronization_and_backup_programs#Chunk-based_increments)

## éœ€æ±‚æ•´ç†

åŸºäº HomeLab æ•°æ®ç‰¹æ€§çš„å››è±¡é™åˆ†ç±»ï¼š

![20241229154732_8WFfKaV8.webp](https://cdn.dong4j.site/source/image/20241229154732_8WFfKaV8.webp)

### é‡è¦ä¸”æ•æ„Ÿ

- **è±¡é™ä¸€ï¼šå…³é”®çš„ä¸ªäººæ•°æ®**
  - **ç‰¹ç‚¹**ï¼šåŒ…å«ä¸ªäººæ•æ„Ÿä¿¡æ¯ï¼Œå¯¹ä¸ªäººç”Ÿæ´»æˆ–å·¥ä½œè‡³å…³é‡è¦;
  - **ä¾‹å­**ï¼šå®¶åº­ç…§ç‰‡å’Œè§†é¢‘ã€ä¸ªäººèº«ä»½ä¿¡æ¯ã€å¯†ç ä»¥åŠå…¶ä»–ä¸ªäººéšç§ç›¸å…³å’Œè®¤è¯æˆæƒç›¸å…³çš„æ–‡ä»¶(æ¯”å¦‚ 2FA äºŒç»´ç , æ¢å¤å¯†é’¥);
- **å¤‡ä»½ç­–ç•¥**ï¼šé‡‡ç”¨ **3-2-1 å¤‡ä»½åŸåˆ™**ï¼ŒåŠ å¯†åå¤‡ä»½åˆ°äº‘ç«¯;

### é‡è¦ä¸æ•æ„Ÿ

- **è±¡é™äºŒï¼šæŠ€æœ¯é…ç½®ä¸é¡¹ç›®æ•°æ®**
  - **ç‰¹ç‚¹**ï¼šå¯¹ HomeLab çš„è¿è¡Œè‡³å…³é‡è¦ï¼Œä½†ä¸å«æ•æ„Ÿä¸ªäººä¿¡æ¯;
  - **ä¾‹å­**ï¼šç³»ç»Ÿé…ç½®æ–‡ä»¶ã€æºä»£ç ã€è‡ªåŠ¨åŒ–è„šæœ¬ã€è™šæ‹Ÿæœºé•œåƒã€docker-compose.yml ç­‰;
- **å¤‡ä»½ç­–ç•¥**: é‡‡ç”¨ **3-2-1 å¤‡ä»½åŸåˆ™**ï¼Œç›´æ¥å¤‡ä»½åˆ°äº‘ç«¯, æ–¹ä¾¿ç›´æ¥æŸ¥çœ‹æ–‡ä»¶å†…å®¹;

### ä¸é‡è¦ä½†æ•æ„Ÿ

- **è±¡é™ä¸‰ï¼šæ•æ„Ÿä½†éå…³é”®æ•°æ®**
  - **ç‰¹ç‚¹**ï¼šå¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œä½†å¯¹ HomeLab çš„æ—¥å¸¸è¿è¡Œå½±å“ä¸å¤§;
  - **ä¾‹å­**ï¼šæ—§é‚®ä»¶ã€éæ´»è·ƒè´¦æˆ·ä¿¡æ¯ã€ä¸å†ä½¿ç”¨ä½†åŒ…å«æ•æ„Ÿæ•°æ®çš„æ–‡æ¡£;
- **å¤‡ä»½ç­–ç•¥**ï¼šæœ¬åœ°å†—ä½™å¤‡ä»½, ä¸å­˜å‚¨åˆ°äº‘ç«¯;

### ä¸é‡è¦ä¸æ•æ„Ÿ

- **è±¡é™å››ï¼šéå…³é”®å…¬å…±æ•°æ®**
  - **ç‰¹ç‚¹**ï¼šå¯¹ HomeLab çš„è¿è¡Œå½±å“è¾ƒå°ï¼Œä¸”ä¸åŒ…å«æ•æ„Ÿä¿¡æ¯;
  - **ä¾‹å­**ï¼šä¸‹è½½çš„å½±è§†æ–‡ä»¶ã€è½¯ä»¶å®‰è£…åŒ…ã€å…¬å…±æ–‡æ¡£ã€éæ•æ„Ÿçš„ç½‘ç»œæ—¥å¿—ç­‰;
- **å¤‡ä»½ç­–ç•¥**ï¼šæœ¬åœ°å¤‡ä»½, å¤‡ä»½é¢‘ç‡å¯ä»¥è¾ƒä½ï¼Œä»…åœ¨éœ€è¦æ—¶å¤‡ä»½ã€‚

## é€»è¾‘å›¾

Synology æä¾›äº†éå¸¸å¤šçš„æ–‡ä»¶åŒæ­¥ä¸å¤‡ä»½æ–¹æ¡ˆ, æ¯”å¦‚:

- [å¤‡ä»½è§£å†³æ–¹æ¡ˆæ¦‚è§ˆ](https://global.download.synology.com/download/Document/Software/WhitePaper/Os/DSM/All/cht/backup_solution_guide_cht.pdf)
- [æ–‡ä»¶åŒæ­¥ä¸å…±äº«æ–¹æ¡ˆ](https://www.synology.cn/zh-cn/dsm/solution/cross-office_file_sharing)
- [å¤šå¹³å°æ–‡ä»¶å¤‡ä»½æ–¹æ¡ˆ](https://www.synology.cn/zh-cn/dsm/solution/personal_backup)
- [ç³»ç»Ÿ, æœåŠ¡æœåŠ¡å™¨, æ–‡ä»¶æœåŠ¡å™¨ä¸è™šæ‹Ÿæœºå¤‡ä»½æ–¹æ¡ˆ](https://www.synology.cn/zh-cn/dsm/feature/active-backup-business/overview)

è€Œæˆ‘æ°å·§æœ‰ 2 å° Synology NAS, ä¸” Synology æä¾›çš„æ–¹æ¡ˆå®Œå…¨èƒ½å¤Ÿæ»¡è¶³æˆ‘çš„éœ€æ±‚, æ‰€ä»¥æˆ‘çš„æ•´ä¸ªæ•°æ®åŒæ­¥ä¸å¤‡ä»½æ–¹æ¡ˆå…¨éƒ¨å›´ç»• Synology NAS å±•å¼€:

![Synchronization-and-Backup.drawio.svg](https://cdn.dong4j.site/source/image/Synchronization-and-Backup.drawio.svg)

### æ•°æ®åŒæ­¥çº¿

æ•´ä½“ä½¿ç”¨ **Synology Drive** å¥—ä»¶ä½œä¸ºåŒæ­¥å·¥å…·, Client ä¸ NAS ä¹‹é—´åŒæ­¥ **Drive** æ•°æ®, 2 å° NAS ä¹‹é—´ä½¿ç”¨ **Synology Drive ShareSync** å’Œ **Cloud Sync** åŒæ­¥æ•°æ®.

### æ•°æ®å¤‡ä»½çº¿

DS923+ ä½œä¸ºæœ€ç»ˆå¤‡ä»½æ–‡ä»¶çš„å­˜å‚¨åœ°, å…¶ä»–è®¾å¤‡é€šè¿‡è„šæœ¬æˆ– Synology å¤‡ä»½å¥—ä»¶å°†æ•°æ®å¤‡ä»½åˆ° DS923+, ç„¶åç»Ÿä¸€ä½¿ç”¨ **Hyper Backup** å¤‡ä»½åˆ°å¤–ç½®ç¡¬ç›˜ä»¥åŠäº‘ç«¯.

**ç›¸å…³æ–‡ç« :**

1. [[homelab-guide|å…ˆå¯¼ç¯‡]]ï¼šæˆ‘çš„ HomeLab æ¦‚è¦;
2. [[homelab-hardware|ç¡¬ä»¶ç¯‡]]ï¼šä»‹ç»æˆ‘æ‰€æ‹¥æœ‰çš„ç¡¬ä»¶è®¾å¤‡;
3. [[homelab-network|ç½‘ç»œç¯‡]]ï¼šåŒ…æ‹¬ç½‘ç»œç¯å¢ƒã€å¼‚åœ°ç»„ç½‘ä¸ç½‘ç»œå®‰å…¨;
4. [[homelab-service|æœåŠ¡ç¯‡]]ï¼šä½¿ç”¨ Docker æ­å»ºçš„å„ç±»æœåŠ¡;
5. [[homelab-data|æ•°æ®ç¯‡]]ï¼šåŒ…æ‹¬æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆ;
6. [[homelab-data-sync|HomeLabæ•°æ®åŒæ­¥ï¼šæ„å»ºé«˜æ•ˆçš„æ•°æ®åŒæ­¥ç½‘ç»œ]]
7. [[homelab-data-backup|HomeLabæ•°æ®å¤‡ä»½ï¼šæ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿]]
8. [[homelab-upgrade-to-10g|HomeLab ç½‘ç»œç»­é›†ï¼šå‡çº§ 10G ç½‘ç»œ-å†æˆ˜ 10 å¹´]]
9. [[homelab-guide|NAT å†…ç½‘ç©¿é€è¯¦è§£ï¼šæ­ç§˜ç½‘ç»œè¿æ¥èƒŒåçš„å¥¥ç§˜]]

## [HomeLab æœåŠ¡ç¯‡ï¼šè‡ªæ‰˜ç®¡çš„ä¹è¶£-æ¢ç´¢å’Œåˆ›é€ ä¸ªäººäº‘ç«¯ä¸–ç•Œçš„æ—…ç¨‹](https://blog.dong4j.site/posts/b2341239.md)

![/images/cover/20241229154732_hoB1PW2R.webp](https://cdn.dong4j.site/source/image/20241229154732_hoB1PW2R.webp)

åœ¨è¿™ä¸ªå……æ»¡æ— é™å¯èƒ½çš„æ•°å­—æ—¶ä»£, æˆ‘ä»¬æœ‰æœºä¼šé€šè¿‡è‡ªæ‰˜ç®¡çš„äº‘æœåŠ¡å¹³å°æ¥æ„å»ºä¸€ä¸ªå±äºä¸ªäººçš„äº‘ç«¯ä¸–ç•Œ. è¿™ä¸æ˜¯ç®€å•åœ°è®¿é—®è¿œç¨‹æœåŠ¡å™¨, è€Œæ˜¯äº²æ‰‹æ‰“é€ ã€å®šåˆ¶å¹¶ç®¡ç†è‡ªå·±çš„è™šæ‹Ÿå®éªŒå®¤, è¿›è¡Œå„ç§æ–°å¥‡æœ‰è¶£çš„æœåŠ¡éƒ¨ç½². è¿™ç§â€œæŠ˜è…¾â€ä¸ä»…ä»…æ˜¯ä¸€ç§ä¹è¶£, æ›´æ˜¯ä¸€ç§è‡ªæˆ‘æŒ‘æˆ˜å’Œåˆ›é€ åŠ›çš„é‡Šæ”¾.

ä»è¿™ç¯‡åšå®¢å¼€å§‹, æˆ‘ä¼šä¸æ—¶åœ°ä»‹ç»ä¸€äº›æˆ‘åœ¨è‡ªæ‰˜ç®¡ç¯å¢ƒä¸­å®‰è£…å’Œé…ç½®çš„æ–°å¥‡æœ‰è¶£æœåŠ¡. è¿™äº›æœåŠ¡æˆ–è®¸å¹¶éæˆ‘å½“ä¸‹æ‰€éœ€, ä½†æ­£æ˜¯è¿™ç§åˆ›é€ éœ€æ±‚çš„ç²¾ç¥é©±åŠ¨ç€æˆ‘ä¸æ–­åœ°æ¢ç´¢æ–°é¢†åŸŸã€å­¦ä¹ æ–°æŠ€æœ¯. åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­, æˆ‘ä¹Ÿå¸Œæœ›èƒ½å¤Ÿä¸å¤§å®¶åˆ†äº«æˆ‘çš„ç»éªŒå’Œè§è§£, ä¸€èµ·æ¢è®¨å¦‚ä½•åœ¨ä¸ªäººäº‘ç«¯ä¸–ç•Œä¸­æ‰¾åˆ°ä¹è¶£å’Œä»·å€¼.

åœ¨è¿™é‡Œ, ä½ å°†ä¼šçœ‹åˆ°æˆ‘å¦‚ä½•ä¸€æ­¥æ­¥æ­å»ºå±äºè‡ªå·±çš„å®éªŒç¯å¢ƒ, ä»é€‰æ‹©åˆé€‚çš„ç¡¬ä»¶åˆ°é…ç½®å„ç§è½¯ä»¶æœåŠ¡. æ— è®ºæ˜¯å¯¹æŠ€æœ¯å……æ»¡çƒ­æƒ…çš„çˆ±å¥½è€…, è¿˜æ˜¯å¸Œæœ›æ‹“å±•æŠ€èƒ½çš„åˆå­¦è€…, è¿™é‡Œéƒ½ä¼šæœ‰ä¸€äº›å®ç”¨çš„æŠ€å·§å’Œå»ºè®®.

è®©æˆ‘ä»¬ä¸€èµ·è¸ä¸Šè¿™æ®µæ—…ç¨‹å§ï¼è®©æˆ‘ä»¬åœ¨è‡ªæ‰˜ç®¡çš„ä¹è¶£ä¸­ä¸æ–­å­¦ä¹ ã€åˆ›é€ å’Œæˆé•¿. æ•¬è¯·å…³æ³¨æ¥ä¸‹æ¥çš„åšå®¢æ–‡ç« , æœŸå¾…ä¸ä½ çš„å…±åŒæ¢è®¨å’Œåˆ†äº«.

**ç›¸å…³æ–‡ç« :**

1. [[homelab-guide|å…ˆå¯¼ç¯‡]]ï¼šæˆ‘çš„ HomeLab æ¦‚è¦;
2. [[homelab-hardware|ç¡¬ä»¶ç¯‡]]ï¼šä»‹ç»æˆ‘æ‰€æ‹¥æœ‰çš„ç¡¬ä»¶è®¾å¤‡;
3. [[homelab-network|ç½‘ç»œç¯‡]]ï¼šåŒ…æ‹¬ç½‘ç»œç¯å¢ƒã€å¼‚åœ°ç»„ç½‘ä¸ç½‘ç»œå®‰å…¨;
4. [[homelab-service|æœåŠ¡ç¯‡]]ï¼šä½¿ç”¨ Docker æ­å»ºçš„å„ç±»æœåŠ¡;
5. [[homelab-data|æ•°æ®ç¯‡]]ï¼šåŒ…æ‹¬æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆ;
6. [[homelab-data-sync|HomeLabæ•°æ®åŒæ­¥ï¼šæ„å»ºé«˜æ•ˆçš„æ•°æ®åŒæ­¥ç½‘ç»œ]]
7. [[homelab-data-backup|HomeLabæ•°æ®å¤‡ä»½ï¼šæ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿]]
8. [[homelab-upgrade-to-10g|HomeLab ç½‘ç»œç»­é›†ï¼šå‡çº§ 10G ç½‘ç»œ-å†æˆ˜ 10 å¹´]]
9. [[homelab-guide|NAT å†…ç½‘ç©¿é€è¯¦è§£ï¼šæ­ç§˜ç½‘ç»œè¿æ¥èƒŒåçš„å¥¥ç§˜]]

## HomeLab çš„æ ¸å¿ƒ: Docker

åœ¨ä¸ªäººäº‘ç«¯å®éªŒå®¤ï¼ˆHomeLabï¼‰ä¸­, Docker èµ‹äºˆäº†æˆ‘ä»¬å¼ºå¤§çš„åŠŸèƒ½å’ŒæœåŠ¡éƒ¨ç½²èƒ½åŠ›. å®ƒæˆä¸ºäº† HomeLab æ¶æ„ä¸­ä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†, æä¾›äº†è¯¸å¤šä¾¿åˆ©:

1. **å®¹å™¨åŒ–éƒ¨ç½²**ï¼šDocker å…è®¸æˆ‘ä»¬å°†åº”ç”¨ç¨‹åºåŠå…¶ä¾èµ–é¡¹æ‰“åŒ…åœ¨ä¸€ä¸ªç§°ä¸ºå®¹å™¨çš„è½»é‡çº§æ‰§è¡Œç¯å¢ƒä¸­. è¿™æ„å‘³ç€æ— è®ºåœ¨å“ªä¸ªç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿä¸Š, åªè¦å®‰è£…äº† Docker å¼•æ“, æˆ‘ä»¬å°±å¯ä»¥è½»æ¾åœ°éƒ¨ç½²å’Œç®¡ç†è¿™äº›å®¹å™¨.
2. **å¯ç§»æ¤æ€§ä¸ä¸€è‡´æ€§**ï¼šé€šè¿‡ä½¿ç”¨ Docker, æˆ‘ä»¬å¯ä»¥ä¿è¯åœ¨ä¸åŒçš„å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒä¹‹é—´çš„ä¸€è‡´æ€§, å› ä¸ºåº”ç”¨ç¨‹åºè¿è¡Œåœ¨ç›¸åŒçš„éš”ç¦»ç¯å¢ƒä¸‹. è¿™å¤§å¤§ç®€åŒ–äº†åº”ç”¨çš„è¿ç§»å’Œéƒ¨ç½²è¿‡ç¨‹.
3. **èµ„æºåˆ©ç”¨ç‡**ï¼šDocker å®¹å™¨ä¸ä¼ ç»Ÿçš„è™šæ‹Ÿæœºç›¸æ¯”, å…·æœ‰æ›´ä½çš„ç³»ç»Ÿå¼€é”€, å› ä¸ºå®ƒä¸éœ€è¦é¢å¤–çš„æ“ä½œç³»ç»Ÿæ¥æ”¯æŒ. è¿™ä½¿å¾— Docker èƒ½å¤Ÿæ›´é«˜æ•ˆåœ°åˆ©ç”¨ä¸»æœºèµ„æº.

å› æ­¤, æ˜¯å¦èƒ½å¤Ÿæ”¯æŒ Docker è¿è¡Œä¹Ÿæˆä¸ºäº†æˆ‘åœ¨é€‰æ‹©ç¡¬ä»¶æ—¶çš„é‡è¦è€ƒé‡å› ç´ ä¹‹ä¸€, è‡³äºä¸ºä»€ä¹ˆæ²¡æœ‰ä¸Š K8S, è¿˜æ˜¯å› ä¸ºå¯¹äºç›®å‰çš„æƒ…å†µç›´æ¥ä½¿ç”¨ Docker å®Œå…¨èƒ½èƒœä»», æš‚æ—¶è¿˜ä¸æƒ³å› ä¸ºå¼•å…¥ K8S å¢åŠ å¤æ‚æ€§.

æ¥ä¸‹æ¥æˆ‘å°†åˆ†äº«åœ¨ä½¿ç”¨ Docker è¿‡ç¨‹ä¸­çš„å®æˆ˜ç»éªŒå’Œæ‰€é‡åˆ°çš„é—®é¢˜, å¹¶åœ¨è¿™äº›åº•å±‚åŸºç¡€æœåŠ¡ç¨³å®šè¿è¡Œä¹‹å, ç»§ç»­ä»‹ç»æˆ‘çš„å…¶ä»–æœåŠ¡å’Œåº”ç”¨æ­å»ºè¿‡ç¨‹.

### è¿œç¨‹ç®¡ç†

æˆ‘æ‹¥æœ‰ä¸€ä¸ªç”±å¤šä¸ª Docker ä¸»æœºç»„æˆçš„ç½‘ç»œ. ä¸ºäº†æ›´æœ‰æ•ˆåœ°ç®¡ç†å’Œç›‘æ§è¿™äº›ä¸»æœºåŠå®ƒä»¬ä¸Šçš„å®¹å™¨, æˆ‘éœ€è¦ä¸€ä¸ªé›†ä¸­çš„ç®¡ç†è§£å†³æ–¹æ¡ˆ. è¿™æ„å‘³ç€æˆ‘éœ€è¦ä¸€ç§æ–¹æ³•æ¥ä»å•ä¸€ç•Œé¢è®¿é—®å’Œæ§åˆ¶æ‰€æœ‰ Docker å®ä¾‹.

ç›®å‰æ­£åœ¨ä½¿ç”¨ **[Portainer](https://www.portainer.io/):**

![20241229154732_GOnzu0wY.webp](https://cdn.dong4j.site/source/image/20241229154732_GOnzu0wY.webp)

Portainer Community Edition æ˜¯ä¸€ä¸ªè½»é‡çº§å¹³å°, ç”¨äºè·¨ Dockerã€Swarmã€Kubernetes å’Œ ACI ç¯å¢ƒç®¡ç†å®¹å™¨åŒ–åº”ç”¨ç¨‹åº. å®ƒæä¾›ç”¨äºç®¡ç†èµ„æºçš„ GUI å’Œ API, å¹¶ä¸”å¯ä»¥éƒ¨ç½²ä¸º Linux æˆ– Windows æœ¬æœºå®¹å™¨.

Portainer å•†ä¸šç‰ˆå»ºç«‹åœ¨å¼€æºåŸºç¡€ä¹‹ä¸Š, åŒ…å«é€‚åˆå•†ä¸šç”¨æˆ·çš„é«˜çº§åŠŸèƒ½. ç¤¾åŒºç‰ˆå®šæœŸæ›´æ–°, å¤§çº¦æ¯å‡ ä¸ªæœˆæ›´æ–°ä¸€æ¬¡.

å¥½ç”¨ä¸”å…è´¹, æ˜¯ç›®å‰ä¸»è¦çš„ç®¡ç†å·¥å…·.

---

å¦ä¸€ä¸ªæ˜¯åˆšéƒ¨ç½²ä¸ä¹…çš„ **[DPanel](https://github.com/donknap/dpanel)**, åŒæ ·æ”¯æŒå¤š Docker ä¸»æœºç®¡ç†, äº®ç‚¹æ˜¯æ”¯æŒ [ç¬¬ä¸‰æ–¹åº”ç”¨å•†åº—](https://dpanel.cc/#/zh-cn/manual/setting/store), ä¸è¿‡ç”¨èµ·æ¥ä¸æ˜¯ç‰¹åˆ«æµç•…, ç›®å‰ç®—ä½œå¤‡ç”¨é€‰æ‹©:

![20241229154732_l4aJ1BNh.webp](https://cdn.dong4j.site/source/image/20241229154732_l4aJ1BNh.webp)

**ç‰¹æ€§**:

- å…¨ä¸­æ–‡çš„ç•Œé¢, æ›´é€‚åˆä¸­æ–‡ç¯å¢ƒä½¿ç”¨.
- å®‰è£…ç®€å•, å ç”¨èµ„æºæå°‘, é€‚åˆå„ç§ Nas è®¾å¤‡ã€ç›’å­ä»¥åŠå°å‹æœåŠ¡å™¨.
- ä»¥å®¹å™¨çš„æ–¹å¼è¿è¡Œ, ä¸éœ€è¦ç‰¹æƒæ¨¡å¼, å¯¹å®¿ä¸»æœºæ²¡æœ‰ä¾èµ–åŠä¾µå…¥, å®‰å…¨ä¸”å¯é .
- æä¾›å®Œå–„çš„å®¹å™¨åˆ›å»ºåŠç®¡ç†åŠŸèƒ½, å¹¶æä¾›å®¹å™¨åŸŸåç»‘å®šåŠŸèƒ½é€‚é…ç®€å•ä½¿ç”¨åœºæ™¯.
- æä¾›çš„æ–‡ä»¶ç®¡ç†åŠŸèƒ½, å¯ä»¥æ–¹ä¾¿ã€å¿«é€Ÿçš„æŸ¥çœ‹åŠè°ƒè¯•å®¹å™¨å†…çš„å„ç§æ–‡ä»¶.
- æä¾›å®Œå–„çš„ç½‘ç»œç®¡ç†åŠŸèƒ½, ä¾¿äºå®¹å™¨ä¹‹é—´çš„äº’è”ã€äº’é€š, ä»¥åŠå„ç§ç½‘ç»œé…ç½®éœ€æ±‚.
- æ”¯æŒæ–‡æœ¬ã€è¿œç¨‹åœ°å€ã€æŒ‚è½½ç›®å½•ç­‰å¤šç§ compose.yml æ·»åŠ æ–¹å¼, å¿«é€Ÿéƒ¨ç½²å’Œç®¡ç† Compose ä»»åŠ¡.
- æä¾›å¤šç§è¯­è¨€çš„åŸºç¡€é•œåƒå’Œæ¨¡æ¿, å¯ä»¥å¿«é€Ÿæ„å»ºå±äºè‡ªå·±çš„é•œåƒ, å¹¶å¯ä»¥é€šè¿‡ Zip æˆ–æ˜¯ Git ç­‰æ–¹å¼, å¿«é€Ÿå®ç°å¯æŒç»­åŒ–æ„å»º.

---

**Dockge**

Uptime Kuma ä½œè€…çš„å¦ä¸€ä¸ªå¼€æºé¡¹ç›®-[Dockge](https://github.com/louislam/dockge) æ˜¯ä¸€ä¸ªç”¨äºç®¡ç† Docker Compose YAML æ–‡ä»¶çš„å †æ ˆå¼ç®¡ç†å·¥å…·. Dockge æä¾›äº†åˆ›å»ºã€ç¼–è¾‘ã€å¯åŠ¨ã€åœæ­¢ã€é‡å¯å’Œåˆ é™¤å †æ ˆç­‰åŠŸèƒ½, å¹¶å…·æœ‰äº¤äº’å¼ç¼–è¾‘å™¨å’Œ Web ç»ˆç«¯ç­‰ç‰¹æ€§.

![20241229154732_QEIZq3Kn.webp](https://cdn.dong4j.site/source/image/20241229154732_QEIZq3Kn.webp)

**ç‰¹æ€§**:

- **åŠŸèƒ½å…¨é¢**ï¼šæ”¯æŒåˆ›å»ºã€ç¼–è¾‘ã€å¯åŠ¨ã€åœæ­¢ã€é‡å¯å’Œåˆ é™¤ Docker Compose å †æ ˆ, ä»¥åŠæ›´æ–° Docker é•œåƒ.
- **å¼ä½“éªŒ**ï¼šæä¾›äº¤äº’å¼ç¼–è¾‘å™¨å’Œ Web ç»ˆç«¯, æ–¹ä¾¿ç”¨æˆ·ç®¡ç† Docker ç¯å¢ƒ.
- **è·¨å¹³å°æ”¯æŒ**ï¼šå¯åœ¨ä¸»æµ Linux å‘è¡Œç‰ˆä¸Šè¿è¡Œ, åŒ…æ‹¬ Ubuntuã€Debianã€Raspbianã€CentOSã€Fedora å’Œ ArchLinux.
- **å¼€æºå…è´¹**ï¼šé‡‡ç”¨ MIT è®¸å¯åè®®, å…è´¹å¼€æº.

> Dockge åªèƒ½ç®¡ç†å•å° Docker ä¸»æœº, å®ƒçš„é‡ç‚¹æ˜¯ dockerc-compose çš„ç®¡ç†ä¸ç»´æŠ¤.

---

Docker é›†ä¸­ç®¡æ§çš„å‰ææ˜¯éœ€è¦å¼€å¯ Docker ä¸»æœºçš„è¿œç¨‹ç®¡ç†ç«¯å£, å› ä¸ºæ¶‰åŠåˆ°å¤šç§ç±»å‹çš„ç³»ç»Ÿ, æˆ‘è¿™é‡Œç»Ÿä¸€æ•´ç†ä¸€ä¸‹:

#### Linux

```shell
vim /usr/lib/systemd/system/docker.service

# è¿½åŠ  tcp
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock -H tcp://0.0.0.0:2375

# é‡æ–°åŠ è½½ Docker å®ˆæŠ¤è¿›ç¨‹
systemctl daemon-reload
# é‡å¯ Docker æœåŠ¡
systemctl restart docker
```

#### macOS

åœ¨ macOS ä¸‹æ— æ³•ç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶æ¥å¼€å¯ Remote API æœåŠ¡, é€šè¿‡è¿è¡Œ `socat` å®¹å™¨, å°† `unix socket` ä¸Š Docker API è½¬å‘åˆ° MacOS æŒ‡å®šçš„ç«¯å£ï¼š

```shell
docker run -d --restart=unless-stopped -v /var/run/docker.sock:/var/run/docker.sock -p 2375:2375 bobrik/socat TCP-LISTEN:2375,fork UNIX-CONNECT:/var/run/docker.sock
```

æˆ–è€…ä½¿ç”¨ docker-compose:

```yaml
services:
  docker-socat:
    image: bobrik/socat
    container_name: docker-socat
    restart: unless-stopped
    ports:
      - "2375:2375"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: "TCP-LISTEN:2375,fork UNIX-CONNECT:/var/run/docker.sock"
```

#### OpenWrt

OpenWrt ç›´æ¥é€šè¿‡ WebUI ä¿®æ”¹:

![20241229154732_SxM9gN4W.webp](https://cdn.dong4j.site/source/image/20241229154732_SxM9gN4W.webp)

æˆ–è€…ç¼–è¾‘é…ç½®æ–‡ä»¶:

```shell
vim /etc/config/dockerd

config globals 'globals'
	# æ·»åŠ è¿™ä¸€è¡Œ
	list hosts 'tcp://0.0.0.0:2375'
```

```
# é‡å¯
/etc/init.d/docker restart
```

#### NAS

```shell
# DSM 7.2 ä¹‹å‰
sudo vim /var/packages/Docker/etc/dockerd.json
# DSM 7.2
sudo vim /var/packages/ContainerManager/etc/dockerd.json
```

æ·»åŠ å¦‚ä¸‹é…ç½®:

```json
"hosts":["tcp://0.0.0.0:2375","unix:///run/docker.sock"]
```

```shell
# é‡å¯ Docker
sudo synosystemctl restart pkgctl-ContainerManager
```

#### æ ‘è“æ´¾

```shell
vim /etc/default/docker
# æœ«å°¾æ·»åŠ 
DOCKER_OPTS="-H tcp://0.0.0.0:2375"
# é‡å¯ docker
sudo systemctl restart docker
```

---

### ä¸€æ¬¡é…ç½®, åˆ°å¤„è¿è¡Œ

æˆ‘çš„æ‰€æœ‰ Docker å®¹å™¨å…¨éƒ¨ä½¿ç”¨ docker-compose å¯åŠ¨, ç”¨ docker-compose.yml æ–‡ä»¶(å¯ä»¥ä½¿ç”¨ä¸€äº›è½¬æ¢å·¥å…·å°† docker run è½¬æ¢æˆ docker-compose.yml), æ–¹ä¾¿åœ¨ä¸åŒç¯å¢ƒä¸­é‡ç°, ç„¶åä½¿ç”¨ Synology Drive + Syncthing åŒæ­¥ docker-compose.yml æ–‡ä»¶, ç„¶ååœ¨å¤šè®¾å¤‡ä¸Šè¿è¡Œ:

![docker-sync.drawio.svg](https://cdn.dong4j.site/source/image/docker-sync.drawio.svg)

1. å…·å¤‡å®‰è£… Synology Drive Client çš„ä¸»æœºç›´æ¥ä½¿ç”¨ Drive åŒæ­¥æ•°æ®;
2. å…¶ä»–çš„åˆ™é€šè¿‡ Syncthing åŒæ­¥, Mac mini 2018 ä½œä¸º Synology Drive å’Œ Syncthing çš„æ¢çº½;

è¿™æ ·æˆ‘åœ¨ä»»æ„è®¾å¤‡ä¸Šæ–°å¢æˆ–ä¿®æ”¹äº† docker-compose.yml éƒ½ä¼šé€šè¿‡åˆ°å…¶ä»–è®¾å¤‡ä¸Š, å…·ä½“é…ç½®æ–¹å¼å°†åœ¨ä¸‹ç« çš„ [[homelab-data|æ•°æ®ç¯‡]] ä¸­è¯¦ç»†è¯´æ˜.

---

### æ•°æ®ç›®å½•è¿ç§»

M920x çš„ç³»ç»Ÿç›˜åªæœ‰ 512G, å› ä¸º M920x å®šä½ä¸º Docker å®¹å™¨çš„ä¸»åŠ›æœº, æ‰€ä»¥é¢„è®¡ Docker é•œåƒä¼šå æ®å¤§é‡ç©ºé—´, å› æ­¤è€ƒè™‘å°† Docker çš„æ•°æ®ç›®å½•è¿ç§»åˆ° 1T SSD ä¸­. è¿ç§»æœ‰ä¸¤ç§æ–¹æ¡ˆ:

1. ä½¿ç”¨è½¯é“¾æ¥;
2. ä¿®æ”¹é»˜è®¤å­˜å‚¨ç›®å½•;

#### ä½¿ç”¨è½¯é“¾æ¥

è¿ç§»ä¹‹å‰éœ€è¦åœæ­¢ Docker, ä½†æ˜¯åœ¨åœæ­¢æŠ¥é”™äº†:

```
Stopping 'docker.service', but its triggering units are still active:
docker.socket
```

è¿™æ˜¯å› ä¸º docker.socket ä¾ç„¶åœ¨è¿è¡Œ, å®ƒæ˜¯ Docker çš„ç›‘å¬å¥—æ¥å­—, è´Ÿè´£ç›‘å¬ Docker API è¯·æ±‚å¹¶è§¦å‘ docker.service.

åœ¨åœæ­¢ docker.service ä¹‹å‰, éœ€è¦å…ˆåœæ­¢ docker.socketï¼š

```shell
sudo systemctl stop docker.socket
sudo systemctl stop docker
```

ç„¶åè¿ç§»æ•°æ®:

```shell
rsync -avzP /var/lib/docker /mnt/3.860.ssd/
```

- **-a**: å½’æ¡£æ¨¡å¼, è¡¨ç¤ºé€’å½’ä¼ è¾“å¹¶ä¿æŒæ–‡ä»¶å±æ€§;
- **-v**: æ˜¾ç¤º rsync è¿‡ç¨‹ä¸­è¯¦ç»†ä¿¡æ¯. å¯ä»¥ä½¿ç”¨"-vvvv"è·å–æ›´è¯¦ç»†ä¿¡æ¯;
- **-P**: æ˜¾ç¤ºæ–‡ä»¶ä¼ è¾“çš„è¿›åº¦ä¿¡æ¯. (å®é™…ä¸Š `-P=--partial --progress`, å…¶ä¸­çš„ `--progress` æ‰æ˜¯æ˜¾ç¤ºè¿›åº¦ä¿¡æ¯çš„);
- **-z**: ä¼ è¾“æ—¶è¿›è¡Œå‹ç¼©æé«˜æ•ˆç‡;

å¤‡ä»½æ•°æ®ç›®å½•:

```shell
mv /var/lib/docker  /var/lib/docker.bak
```

é‡å¯ Docker

```
systemctl restart docker
```

å¯åŠ¨ Docker ä¹‹å, Docker å†™å…¥çš„è·¯å¾„ä¾ç„¶æ˜¯ `/var/lib/docker` , ä½†æ˜¯å› ä¸ºè½¯é“¾æ¥çš„è®¾ç½®, å®é™…å·²ç»æ˜¯å¾€æ–°çš„ç›®å½•å†™å…¥äº†. è‡³æ­¤, å®Œæˆäº† Docker å®‰è£…(å­˜å‚¨)ç›®å½•çš„è¿ç§».

é€šè¿‡ä¸Šè¿°æ–¹æ³•å®Œæˆè¿ç§»ä¹‹å, åœ¨ç¡®è®¤ Docker èƒ½æ­£å¸¸å·¥ä½œä¹‹å, åˆ é™¤åŸç›®å½•å¤‡ä»½æ•°æ®ï¼š

```bash
rm -rf /var/lib/docker.bak
```

#### ä¿®æ”¹é»˜è®¤å­˜å‚¨ç›®å½•

è¿ç§»æ•°æ®çš„è¿‡ç¨‹éƒ½ä¸€æ ·:

```shell
rsync -avzP /var/lib/docker /mnt/3.860.ssd/
```

ä¿®æ”¹ `/etc/docker/daemon.json`:

```json
{
  "data-root": "/mnt/3.860.ssd/docker",
  ...
}
```

ä½¿ç”¨ `data-root` å®šä¹‰æ•°æ®ç›®å½•, æœ€åé‡å¯ docker, éªŒè¯ç›®å½•:

```shell
docker info | grep "Docker Root Dir"
```

æ²¡é—®é¢˜å°±å¯ä»¥åˆ é™¤åŸç›®å½•äº†.

### å®¹å™¨è‡ªåŠ¨æ›´æ–°

åœ¨ä½¿ç”¨ Docker çš„è¿‡ç¨‹ä¸­, è™½ç„¶æˆ‘ä»¬çŸ¥é“åœ¨å®¹å™¨å¯¹åº”çš„é•œåƒåé¢æ·»åŠ  latest æ ‡ç­¾, ç„¶åé€šè¿‡æ‰‹åŠ¨ç¼–è¾‘å®¹å™¨, å³å¯æ‹‰å–æœ€æ–°é•œåƒ, ç„¶åè¾¾æˆæ›´æ–°å®¹å™¨çš„ç›®çš„. ä½†æ˜¯å½“å»ºç«‹éå¸¸å¤šçš„å®¹å™¨ä¹‹å, ä½¿ç”¨æ‰‹åŠ¨æ›´æ–°å®¹å™¨å°†ä¼šæ˜¯ä¸€ä»¶éå¸¸ç¹ççš„äº‹æƒ…, è¿™é‡Œæ¨èä¸€æ¬¾éå¸¸ä¼˜é›…çš„å®¹å™¨æ›´æ–°å·¥å…·-[Watchtower](https://github.com/containrrr/watchtower).

Watchtower æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®, å®ƒå¯ä»¥ç›‘æ§ä½ çš„ Docker å®¹å™¨, å¹¶åœ¨å®¹å™¨çš„åŸºç¡€é•œåƒæœ‰æ›´æ–°æ—¶è‡ªåŠ¨é‡å¯å®¹å™¨. è¿™ä¸ªå·¥å…·å¯¹äºéœ€è¦æŒç»­éƒ¨ç½²å’Œé›†æˆçš„é¡¹ç›®æ¥è¯´éå¸¸æœ‰ç”¨, å¯ä»¥ç®€åŒ–ç®¡ç†å·¥ä½œå¹¶ç¡®ä¿ä½ çš„åº”ç”¨å§‹ç»ˆè¿è¡Œæœ€æ–°çš„é•œåƒ.

æˆ‘ç›®å‰çš„é…ç½®å¦‚ä¸‹:

```yaml
services:
  watchtower:
    image: containrrr/watchtower
    restart: unless-stopped
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --http-api-update --http-api-periodic-polls --cleanup
    environment:
      - WATCHTOWER_HTTP_API_TOKEN=xxx
      - WATCHTOWER_NOTIFICATIONS=email
      - WATCHTOWER_NOTIFICATION_EMAIL_FROM=xxx
      - WATCHTOWER_NOTIFICATION_EMAIL_TO=xxx
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER=xxx
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_PORT=xxx
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_USER=xxx
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_PASSWORD=xxx
      - WATCHTOWER_NOTIFICATION_EMAIL_DELAY=2
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    ports:
      - 8088:8080
```

1. ä½¿ç”¨ `--http-api-update` å¼€å§‹ API æ‰‹åŠ¨æ›´æ–°åŠŸèƒ½;
2. ä½¿ç”¨ `--http-api-periodic-polls` å¼€å§‹è‡ªåŠ¨å®šæ—¶æ›´æ–°åŠŸèƒ½;
3. ä½¿ç”¨ `--cleanup` åˆ é™¤æ—§çš„é•œåƒ;
4. ä½¿ç”¨ `WATCHTOWER_NOTIFICATION_EMAIL` å°†æ›´æ–°é€šè¿‡é‚®ä»¶é€šçŸ¥, å½“ç„¶è¿˜æœ‰å…¶ä»–é€šçŸ¥æ–¹å¼;

å…¶ä¸­ `WATCHTOWER_HTTP_API_TOKEN` æ˜¯ API çš„ token, è°ƒç”¨ API æ—¶éœ€è¦æ·»åŠ åˆ° Header ä¸­, å¹¶ä½¿ç”¨é‚®ä»¶é€šçŸ¥æ›´æ–°çš„å†…å®¹.

ä¸Šè¿°é…ç½®ä¼šç›‘å¬å½“å‰ä¸»æœºæ‰€æœ‰çš„ Docker å®¹å™¨, ç›®å‰é€‚ç”¨æˆ‘ç°åœ¨çš„åœºæ™¯, æ›´å¤šçš„é«˜çº§åŠŸèƒ½æ¯”å¦‚ æ›´æ–°ç‰¹å®šå®¹å™¨, å¿½ç•¥æ›´æ–°æŸäº›å®¹å™¨, ç›‘æ§è¿œç¨‹ Docker å®¹å™¨ç­‰å¯æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£äº†è§£.

---

### å¸¸è§æ“ä½œå¤‡å¿˜

#### é root ç”¨æˆ·ä½¿ç”¨ Docker å‘½ä»¤

Docker é»˜è®¤ä½¿ç”¨ Unix å¥—æ¥å­—ä¸å®ˆæŠ¤è¿›ç¨‹é€šä¿¡, è€Œè¯¥å¥—æ¥å­—çš„æƒé™åªå…è®¸ root ç”¨æˆ·å’Œ docker ç»„ç”¨æˆ·è®¿é—®, å› æ­¤éœ€è¦å°†è¯¥ç”¨æˆ·æ·»åŠ åˆ° docker ç»„.

**ç¾¤æ™–**

```shell
sudo synogroup --add docker
sudo synogroup --member docker $USER
sudo chown root:docker /var/run/docker.sock
```

**Linux**:

```shell
sudo groupadd docker
sudo usermod -aG docker $USER
# newgrpæ˜¯ä¸€ä¸ªLinuxç³»ç»Ÿå‘½ä»¤, ç”¨äºåˆ‡æ¢å½“å‰ä¼šè¯çš„æœ‰æ•ˆç»„
newgrp docker
```

#### æ‰¹é‡åˆ é™¤é•œåƒ

```shell
docker rmi $(docker images -q)

# å¼ºåˆ¶åˆ é™¤
docker rmi -f $(docker images -q)
```

#### å®¹å™¨ä¸å¯„ä¸»æœºä¹‹é—´æ‹·è´æ–‡ä»¶

```shell
# å®¹å™¨ --> å¯„ä¸»æœº
docker cp <å®¹å™¨ID>:<å®¹å™¨å†…è·¯å¾„> <å®¿ä¸»æœºè·¯å¾„>

# å¯„ä¸»æœº --> å®¹å™¨
docker cp <å®¿ä¸»æœºè·¯å¾„> <å®¹å™¨ID>:<å®¹å™¨å†…è·¯å¾„>
```

#### docker run äº’è½¬ docker-compose

- [composerize](https://github.com/composerize/composerize)
- [decomposerize](https://github.com/composerize/decomposerize)

#### docker ä»£ç†

##### è¿è¡Œæ—¶ä»£ç†

1. é…ç½®å…¨å±€ä»£ç†ï¼ˆé€‚ç”¨äºæ‰€æœ‰å®¹å™¨ï¼‰

   åˆ›å»ºæˆ–ç¼–è¾‘ Docker å®ˆæŠ¤è¿›ç¨‹é…ç½®æ–‡ä»¶:

   ```shell
   sudo mkdir -p /etc/systemd/system/docker.service.d
   sudo nano /etc/systemd/system/docker.service.d/http-proxy.conf
   ```

   æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

   ```shell
   [Service]
   Environment="HTTP_PROXY=http://proxy.example.com:8080"
   Environment="HTTPS_PROXY=http://proxy.example.com:8080"
   Environment="NO_PROXY=localhost,127.0.0.1,.example.com"
   ```

   é‡æ–°åŠ è½½å¹¶é‡å¯ Docker æœåŠ¡ï¼š

   ```shell
   sudo systemctl daemon-reload
   sudo systemctl restart docker
   ```

2. ä¸ºç‰¹å®šå®¹å™¨é…ç½®ä»£ç†

   - ä½¿ç”¨ docker run æ—¶é…ç½®ä»£ç†

     ```shell
     docker run -e HTTP_PROXY=http://proxy.example.com:8080 \
                -e HTTPS_PROXY=http://proxy.example.com:8080 \
                -e NO_PROXY=localhost,127.0.0.1 \
                ubuntu
     ```

   - åœ¨ docker-compose.yml ä¸­é…ç½®ä»£ç†

     ```shell
     version: '3'
     services:
       web:
         image: nginx
         environment:
           - HTTP_PROXY=http://proxy.example.com:8080
           - HTTPS_PROXY=http://proxy.example.com:8080
           - NO_PROXY=localhost,127.0.0.1,.example.com
     ```

3. é€šè¿‡ .env æ–‡ä»¶ç®¡ç†ä»£ç†

   ```shell
   # .env
   HTTP_PROXY=http://proxy.example.com:8080
   HTTPS_PROXY=http://proxy.example.com:8080
   NO_PROXY=localhost,127.0.0.1,.example.com
   ```

   åœ¨ docker-compose.yml ä¸­å¼•ç”¨ç¯å¢ƒå˜é‡ï¼š

   ```shell
   services:
     web:
       image: nginx
       environment:
         - HTTP_PROXY=${HTTP_PROXY}
         - HTTPS_PROXY=${HTTPS_PROXY}
         - NO_PROXY=${NO_PROXY}
   ```

4. åœ¨ Dockerfile ä¸­é…ç½®ä»£ç†

   ```shell
   FROM ubuntu
   ARG HTTP_PROXY
   ARG HTTPS_PROXY
   ENV HTTP_PROXY=${HTTP_PROXY}
   ENV HTTPS_PROXY=${HTTPS_PROXY}

   RUN apt-get update && apt-get install -y curl
   ```

   æ„å»ºæ—¶ä¼ é€’ä»£ç†å˜é‡

   ```shell
   docker build --build-arg HTTP_PROXY=http://proxy.example.com:8080 \
                --build-arg HTTPS_PROXY=http://proxy.example.com:8080 \
                -t my_image .
   ```

##### æ‹‰å–é•œåƒæ—¶ä½¿ç”¨ä»£ç†

docker pull /push çš„ä»£ç†è¢« systemd æ¥ç®¡, æ‰€ä»¥éœ€è¦è®¾ç½® systemd:

```bash
$ sudo mkdir -p /etc/systemd/system/docker.service.d
sudo vim /etc/systemd/system/docker.service.d/http-proxy.conf
```

```bash
[Service]
Environment="HTTP_PROXY=http://127.0.0.1:8123"
Environment="HTTPS_PROXY=https://127.0.0.1:8123"
```

```
sudo systemctl daemon-reload && sudo systemctl restart docker
```

æ£€æŸ¥ç¡®è®¤ç¯å¢ƒå˜é‡å·²ç»æ­£ç¡®é…ç½®ï¼š

```shell
$ sudo systemctl show --property=Environment docker
```

æˆ–ä» `docker info` çš„ç»“æœä¸­æŸ¥çœ‹é…ç½®é¡¹:

![20241229154732_roBMUc0U.webp](https://cdn.dong4j.site/source/image/20241229154732_roBMUc0U.webp)

> docker é•œåƒç”± docker daemon ç®¡ç†, æ‰€ä»¥ **ä¸èƒ½ç”¨ä¿®æ”¹ shell ç¯å¢ƒå˜é‡çš„æ–¹æ³•ä½¿ç”¨ä»£ç†æœåŠ¡**, è€Œæ˜¯ä» systemd è§’åº¦è®¾ç½®ç¯å¢ƒå˜é‡.

**ä¿®æ”¹ä»£ç†åå‡ºç°çš„é—®é¢˜**:

```
Error response from daemon: Get "https://docker.n8n.io/v2/": proxyconnect tcp: net/http: TLS handshake timeout
```

**è§£å†³åŠæ³•:**

- æ–¹å¼ä¸€: å°† https ä»£ç†çš„åœ°å€æ”¹æˆ http

  ```bash
  [Service]
  Environment="HTTP_PROXY=http://127.0.0.1:8123"
  Environment="HTTPS_PROXY=http://127.0.0.1:8123"
  ```

- æ–¹å¼äºŒ: è¯·åˆ é™¤ `https://` å’Œ `http://`

  ```bash
  [Service]
  Environment="HTTP_PROXY=127.0.0.1:8123"
  Environment="HTTPS_PROXY=127.0.0.1:8123"
  ```

<!--

https://neucrack.com/p/286

https://www.lfhacks.com/tech/pull-docker-images-behind-proxy/

-->

---

#### å®¹å™¨è®¿é—®ä¸»æœºç½‘ç»œ

è¿™é‡Œåªæ˜¯è¯´ä¸€ä¸‹ `host.docker.internal`:

æ¯”å¦‚, åœ¨ä¸»æœºä¸Šè¿è¡Œ MySQL æœåŠ¡å™¨, Docker å®¹å™¨å¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®è¿æ¥åˆ°ä¸»æœºçš„ MySQL å…·ä½“åä¸º host.docker.internal:3306 . å½“åœ¨ Windows æˆ– Mac è®¡ç®—æœºä¸Šå·¥ä½œæ—¶, è¿™æ˜¯æœ€ç®€å•çš„æŠ€æœ¯.

Linux ä¸Šçš„ Docker å¼•æ“ç”¨æˆ·ä¹Ÿå¯ä»¥é€šè¿‡ docker run çš„ `--add-host` æ ‡å¿—å¯ç”¨ä¸»æœºçš„é»˜è®¤åç§° `host.docker.internal`.

**docker run**:

```
docker run -d --add-host host.docker.internal:host-gateway my-container:latest
```

**docker-compose**

```shell
services:
  web:
    image: nginx
    ports:
      - "8080:80"
    extra_hosts:
      - "host.docker.internal:host-gateway"
```

extra_hosts é…ç½®ä¼šå°† host.docker.internal æ˜ å°„åˆ°å®¿ä¸»æœº.

`â€“add-host` æ ‡å¿—å‘å®¹å™¨çš„ `/etc/hosts` æ–‡ä»¶æ·»åŠ ä¸€ä¸ªæ¡ç›®. ä¸Šé¢æ˜¾ç¤ºçš„å€¼å°† `host.docker.internal` æ˜ å°„åˆ°å®¹å™¨çš„ä¸»æœºç½‘å…³ .

> ä¸Šè¿°æ–¹å¼åœ¨ä¸»æœºéƒ¨ç½² LLM æ¨¡å‹, è€Œåº”ç”¨å±‚ä½¿ç”¨ Docker éƒ¨ç½²æ—¶ç»å¸¸ä½¿ç”¨åˆ°.

## Docker æœåŠ¡

### Docker å•†åº—

ä¸ºäº†ç®€åŒ–å®‰è£…éƒ¨ç½² Docker æœåŠ¡, æˆ‘ç›®å‰ä½¿ç”¨äº†å¤šä¸ªç¬¬ä¸‰æ–¹åº”ç”¨å•†åº—:

**[1Panel](https://1panel.cn/)**

![20241229154732_wWV312Dl.webp](https://cdn.dong4j.site/source/image/20241229154732_wWV312Dl.webp)

- **å¼€æº, ç°ä»£åŒ–**ï¼š1Panel æ˜¯ä¸€æ¬¾å¼€æºçš„ Linux æœåŠ¡å™¨è¿ç»´ç®¡ç†é¢æ¿, æä¾› Web å›¾å½¢ç•Œé¢è¿›è¡Œé«˜æ•ˆç®¡ç†.
- **åŠŸèƒ½ä¸°å¯Œ**ï¼šæ”¯æŒä¸»æœºç›‘æ§ã€æ–‡ä»¶ç®¡ç†ã€æ•°æ®åº“ç®¡ç†ã€å®¹å™¨ç®¡ç†ç­‰åŠŸèƒ½.
- **å¿«é€Ÿå»ºç«™**ï¼šæ·±åº¦é›†æˆ WordPress å’Œ Halo å»ºç«™å·¥å…·, å®ç°ä¸€é”®ç»‘å®šåŸŸåå’Œé…ç½® SSL è¯ä¹¦.
- **å®‰å…¨å¯é **ï¼šåŸºäºå®¹å™¨ç®¡ç†å¹¶éƒ¨ç½²åº”ç”¨, æä¾›ç—…æ¯’é˜²æŠ¤ã€é˜²ç«å¢™å’Œæ—¥å¿—å®¡è®¡ç­‰åŠŸèƒ½.
- **ä¸€é”®å¤‡ä»½**ï¼šæ”¯æŒä¸€é”®å¤‡ä»½å’Œæ¢å¤, å°†æ•°æ®å¤‡ä»½åˆ°å„ç±»äº‘ç«¯å­˜å‚¨ä»‹è´¨.

**[CasaOS](https://casaos.io/)**

![20241229154732_e38oDLTM.webp](https://cdn.dong4j.site/source/image/20241229154732_e38oDLTM.webp)

- åŸºäº Docker, å¯è¿è¡Œåœ¨å¤šç§è®¾å¤‡ä¸Š, åŒ…æ‹¬ x86 å’Œ Raspberry Pi.
- æä¾›è¶…è¿‡ 20 ä¸ªé¢„å®‰è£…åº”ç”¨å’Œ 50+ ä¸ªç¤¾åŒºéªŒè¯åº”ç”¨.
- æ”¯æŒç¤¾åŒºè´¡çŒ®, ç”¨æˆ·æäº¤æ–°çš„åº”ç”¨.
- ç”¨æˆ·ç•Œé¢ç®€æ´ä¼˜é›…, æ˜“äºæ“ä½œ.
- æ”¯æŒå¤‡ä»½è®¾ç½®, æ–¹ä¾¿å¿«é€Ÿå®‰è£…å’Œæ¢å¤åº”ç”¨.

[**Runtipi**](https://runtipi.io/)

![20241229154732_Z7Jb8Npn.webp](https://cdn.dong4j.site/source/image/20241229154732_Z7Jb8Npn.webp)

- **å…è´¹å¼€æº**: Runtipi æ˜¯ä¸€æ¬¾å…è´¹ä¸”å¼€æºçš„è½¯ä»¶, ç”¨æˆ·å¯ä»¥è‡ªç”±ä½¿ç”¨å’Œä¿®æ”¹.
- **ç®€åŒ–å®‰è£…**: é€šè¿‡ä¸€é”®å®‰è£…, ç”¨æˆ·å¯ä»¥è½»æ¾åœ°å°† 200 å¤šä¸ªæµè¡Œçš„è‡ªæ‰˜ç®¡åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°å®¶ä¸­æœåŠ¡å™¨.
- **ä¸€é”®æ›´æ–°**: ç”¨æˆ·å¯ä»¥è½»æ¾åœ°æ›´æ–°åº”ç”¨ç¨‹åº, ç¡®ä¿å®ƒä»¬å§‹ç»ˆä¿æŒæœ€æ–°çŠ¶æ€.
- **æ˜“äºé…ç½®**: Runtipi æä¾›äº†ä¸€ä¸ªç®€å•çš„ Web UI, ç”¨æˆ·å¯ä»¥è½»æ¾åœ°è‡ªå®šä¹‰åº”ç”¨ç¨‹åºçš„é…ç½®.
- **SSL è¯ä¹¦ç®¡ç†**: Runtipi è‡ªåŠ¨ç®¡ç† SSL è¯ä¹¦, ç¡®ä¿åº”ç”¨ç¨‹åºçš„å®‰å…¨è¿æ¥.
- **å¿«é€Ÿéƒ¨ç½²**: ç”¨æˆ·å¯ä»¥åœ¨å‡ åˆ†é’Ÿå†…å°†åº”ç”¨ç¨‹åºä»é›¶éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ.

**OpenWrt ä¸­çš„ç¬¬ä¸‰æ–¹å•†åº—:**

![20241229154732_ctFyXsKX.webp](https://cdn.dong4j.site/source/image/20241229154732_ctFyXsKX.webp)

OpenWrt æœ¬èº«å­˜åœ¨å¤§é‡ç¬¬ä¸‰æ–¹åº”ç”¨, ä½¿ç”¨ iStore æ–¹ä¾¿ç‚¹.

æ¨è 2 ä¸ªæºåœ°å€:

- [https://dl.photonicat.com](https://dl.photonicat.com/)
- [https://dl.openwrt.ai](https://dl.openwrt.ai/)

**NAS ä¸­çš„ç¬¬ä¸‰æ–¹å•†åº—:**

![20241229154732_uwDcMglt.webp](https://cdn.dong4j.site/source/image/20241229154732_uwDcMglt.webp)

ç›®å‰åœ¨ç”¨çš„å‡ ä¸ªç¬¬ä¸‰æ–¹æº:

- **synocommunity**: https://packages.synocommunity.com/
- **spk7**: https://spk7.imnks.com/
- **äº‘æ¢¦:** https://spk.520810.xyz:666
- **4saG SPK Server:** https://spk.4sag.ru/
- **Community Package Hub:** https://www.cphub.net

---

> æˆ‘çš„ç»å¤§éƒ¨åˆ†æœåŠ¡éƒ½å·²ç»é€šè¿‡ Docker å®¹å™¨åŒ–æŠ€æœ¯éƒ¨ç½²åœ¨ä¸åŒçš„è®¾å¤‡ä¸Š. è¿™ç§çµæ´»çš„éƒ¨ç½²æ–¹å¼ä¸ä»…æé«˜äº†èµ„æºçš„åˆ©ç”¨ç‡, è¿˜ä½¿å¾—æœåŠ¡çš„æ‰©å±•å’Œç®¡ç†å˜å¾—æ›´åŠ ä¾¿æ·.
>
> é€‰æ‹©è®¾å¤‡æ—¶, æˆ‘ä¸»è¦è€ƒè™‘ä¸¤ä¸ªå› ç´ ï¼šèµ„æºå’Œç½‘ç»œç¯å¢ƒ. ä¸åŒçš„æœåŠ¡å™¨æˆ–è®¾å¤‡å¯èƒ½æœ‰ä¸åŒçš„è®¡ç®—èƒ½åŠ›ã€å­˜å‚¨å®¹é‡å’Œç½‘ç»œè¿æ¥é€Ÿåº¦, å› æ­¤æˆ‘ä¼šæ ¹æ®æœåŠ¡çš„å…·ä½“éœ€æ±‚æ¥é€‰æ‹©æœ€åˆé€‚çš„ç¡¬ä»¶èµ„æº.
>
> æ¥ä¸‹æ¥, æˆ‘å°†æŒ‰ç…§è®¾å¤‡çš„åˆ†ç±», ç›˜ç‚¹ä¸€ä¸‹æˆ‘éƒ½å®‰è£…äº†å“ªäº›è‡ªæ‰˜ç®¡æœåŠ¡.

## NAS

2 å°ç¾¤æ™– NAS æ›´å¤šçš„æ˜¯è‚©è´Ÿç€æ•°æ®å­˜å‚¨ä¸åŒæ­¥çš„é‡ä»», ä½¿ç”¨ä¸€ä¸»ä¸€å¤‡çš„æ–¹å¼ä¿è¯é‡è¦æ•°æ®çš„å®‰å…¨æ€§.

DS218+ çš„ä»»åŠ¡æ˜¯å¯¹å¤–æä¾› Synology Drive æœåŠ¡, æˆ‘çš„æ‰€æœ‰å·¥ä½œæ–‡ä»¶, å®¶åº­ç…§ç‰‡å…¨éƒ¨å­˜å‚¨åœ¨è¿™ä¸Šé¢, è€Œ DS923+ åˆ™ä¾§é‡äºæ•°æ®å¤‡ä»½ä¸å½±éŸ³æ–‡ä»¶ç®¡ç†, é¦–å…ˆä¼šå…¨é‡å¤‡ä»½ DS218+ çš„æ•°æ®, è¿˜ä¼šä¸ºå…¶ä»–è®¾å¤‡æä¾›å¤‡ä»½æœåŠ¡, å…¶æ¬¡ä¸ºå®¶äººæä¾›æµåª’ä½“æœåŠ¡.

> è¿™é‡Œæ¨èä¸€ä¸ª NAS ç›¸å…³çš„é«˜è´¨é‡ç©æœºç½‘ç«™ - [æˆ‘ä¸æ˜¯çŸ¿ç¥](https://imnks.com/).

### DS218+

#### Vaultwarden

[Vaultwarden](https://github.com/dani-garcia/vaultwarden) æ˜¯ä¸€ä¸ªä½¿ç”¨ Rust ç¼–å†™çš„éå®˜æ–¹ Bitwarden æœåŠ¡å™¨å®ç°, å®ƒä¸ [å®˜æ–¹ Bitwarden å®¢æˆ·ç«¯](https://bitwarden.com/download/) å…¼å®¹, éå¸¸é€‚åˆä¸å¸Œæœ›è¿è¡Œå®˜æ–¹çš„å ç”¨å¤§é‡èµ„æºçš„è‡ªæ‰˜ç®¡éƒ¨ç½², å®ƒæ˜¯ç†æƒ³çš„é€‰æ‹©. Vaultwarden ä¸»è¦é¢å‘ä¸ªäººã€å®¶åº­å’Œå°å‹ç»„ç»‡.

![20241229154732_ipFMiyMU.webp](https://cdn.dong4j.site/source/image/20241229154732_ipFMiyMU.webp)

> å¦‚æœæœ€è¿‘ä½ çš„ iOS å®¢æˆ·ç«¯æ— æ³•æ­£å¸¸ç™»å½•ä½¿ç”¨, å¯ä»¥å°†æœåŠ¡ç«¯æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬, æˆ‘å°±æ˜¯è¿™æ ·è§£å†³çš„.

è€ƒè™‘åˆ°å®‰å…¨é—®é¢˜, ç›®å‰æ­£åœ¨ä½¿ç”¨ Vaultwarden å…¨é¢æ›¿ä»£ 1Password. å› ä¸º Vaultwarden å¼ºåˆ¶è¦æ±‚é€šè¿‡ HTTPS è®¿é—®, æˆ‘ç›®å‰ä½¿ç”¨ 1Panel æ¥ç”³è¯·è¯ä¹¦, ç»“åˆ WAF ä½¿ç”¨.

å¦‚æœåªæ˜¯åœ¨å†…ç½‘ä½¿ç”¨çš„è¯, å¯ä»¥å‚è€ƒä½¿ç”¨ [mkcert](https://github.com/FiloSottile/mkcert) æ¥å¼€å¯ HTTPS.

ä¸ºäº†é˜²æ­¢æ•°æ®ä¸¢å¤±, æˆ‘åšäº†ä¸¤é‡ä¿æŠ¤:

- å°† Vaultwarden çš„æ•°æ®ä½¿ç”¨ Drive å®æ—¶åŒæ­¥åˆ° DS923+, ç„¶ååœ¨ DS923+ ä¸Šé¢ä¹Ÿå¯åŠ¨ä¸€ä¸ª Vaultwarden, é¿å… DS218+ æŒ‚æ‰ä¹‹åæ— æ³•ä½¿ç”¨;

- ä½¿ç”¨è„šæœ¬ç¦»çº¿å¤‡ä»½ Vaultwarden æ•°æ®æ–‡ä»¶:

  ```shell
  #!/bin/bash

  NOW=$(date +"%Y.%m.%d")
  # Vaultwarden çš„æ•°æ®ç›®å½•
  cd /volume1/docker/0.nas
  # æ‰“åŒ…æ•´ä¸ªç›®å½•
  zip -q -r vaultwarden_$NOW.zip vaultwarden/
  # ç§»åŠ¨åˆ° Synology Drive ç›¸å…³ç›®å½•ä¸‹, è¿™æ ·å°±èƒ½é€šè¿‡åˆ°å…¶ä»–å®¢æˆ·ç«¯ä¸Š, ç›¸å½“äºå¤šç«¯å¤‡ä»½
  mv vaultwarden_$NOW.zip /volume1/driver/NAS/Bitwarden
  ```

  ç„¶åä½¿ç”¨å®šæ—¶ä»»åŠ¡å®šæœŸå¤‡ä»½:

  ![20241229154732_e8P5IGnz.webp](https://cdn.dong4j.site/source/image/20241229154732_e8P5IGnz.webp)

ç›¸å…³æ•™ç¨‹:

- [å—å¤Ÿäº†å¯†ç æ•°æ®æ³„æ¼äº‹ä»¶ï¼Ÿç”¨ Bitwarden åšè‡ªå·±çš„å®‰å…¨è´Ÿè´£äºº](https://sspai.com/post/79183)

- https://github.com/dani-garcia/vaultwarden/wiki/Enabling-HTTPS
- [çº¯å†…ç½‘ä½¿ç”¨ Bitwarden](https://blog.cfandora.com/archives/449/#cl-2).

---

#### MyIP

[MyIP](https://github.com/jason5ng32/MyIP) å¯èƒ½æ˜¯æœ€å¥½ç”¨çš„ IP å·¥å…·ç®±. è½»æ¾æ£€æŸ¥ä½ çš„ IP, IP åœ°ç†ä½ç½®, æ£€æŸ¥ DNS æ³„æ¼, æ£€æŸ¥ WebRTC è¿æ¥, é€Ÿåº¦æµ‹è¯•, ping æµ‹è¯•, MTR æµ‹è¯•, æ£€æŸ¥ç½‘ç«™å¯ç”¨æ€§, æŸ¥è¯¢ Whois ä¿¡æ¯ç­‰ç­‰.

æˆ‘ä¸»è¦æ‹¿æ¥åšä¸€äº›è¿é€šæ€§æµ‹è¯•:

![20241229154732_WHL8FkrH.webp](https://cdn.dong4j.site/source/image/20241229154732_WHL8FkrH.webp)

**ç‰¹æ€§**:

- ğŸ–¥ï¸ **çœ‹è‡ªå·±çš„ IP**ï¼šä»å¤šä¸ª IPv4 å’Œ IPv6 æ¥æºæ£€æµ‹æ˜¾ç¤ºæœ¬æœºçš„ IP
- ğŸ•µï¸ **çœ‹ IP ä¿¡æ¯**ï¼šæ˜¾ç¤ºæ‰€æœ‰ IP çš„ç›¸å…³ä¿¡æ¯, åŒ…æ‹¬å›½å®¶ã€åœ°åŒºã€ASNã€åœ°ç†ä½ç½®ç­‰
- ğŸš¦ **å¯ç”¨æ€§æ£€æµ‹**ï¼šæ£€æµ‹ä¸€äº›ç½‘ç«™çš„å¯ç”¨æ€§ï¼šGoogle, Github, Youtube, ç½‘æ˜“, ç™¾åº¦ç­‰
- ğŸš¥ **WebRTC æ£€æµ‹**ï¼šæŸ¥çœ‹ä½¿ç”¨ WebRTC è¿æ¥æ—¶ä½¿ç”¨çš„ IP
- ğŸ›‘ **DNS æ³„éœ²æ£€æµ‹**ï¼šæŸ¥çœ‹ DNS å‡ºå£ä¿¡æ¯, ä»¥ä¾¿æŸ¥çœ‹åœ¨ VPN/ä»£ç†çš„æƒ…å†µä¸‹, æ˜¯å¦å­˜åœ¨ DNS æ³„éœ²éšç§çš„é£é™©
- ğŸš€ **ç½‘é€Ÿæµ‹è¯•**ï¼šåˆ©ç”¨è¾¹ç¼˜ç½‘ç»œè¿›è¡Œç½‘é€Ÿæµ‹è¯•
- ğŸš **ä»£ç†è§„åˆ™æµ‹è¯•**ï¼šé…åˆä»£ç†è½¯ä»¶çš„è§„åˆ™è®¾ç½®, æµ‹è¯•è§„åˆ™è®¾ç½®æ˜¯å¦æ­£å¸¸
- â±ï¸ **å…¨çƒå»¶è¿Ÿæµ‹è¯•**ï¼šä»åˆ†å¸ƒåœ¨å…¨çƒçš„å¤šä¸ªæœåŠ¡å™¨è¿›è¡Œå»¶è¿Ÿæµ‹è¯•, äº†è§£ä½ ä¸å…¨çƒç½‘ç»œçš„è¿æ¥é€Ÿåº¦
- ğŸ“¡ **MTR æµ‹è¯•**ï¼šä»åˆ†å¸ƒåœ¨å…¨çƒçš„å¤šä¸ªæœåŠ¡å™¨è¿›è¡Œ MTR æµ‹è¯•, äº†è§£ä½ ä¸å…¨çƒçš„è¿æ¥è·¯å¾„
- ğŸ”¦ **DNS è§£æå™¨**ï¼šä»å¤šä¸ªæ¸ é“å¯¹åŸŸåè¿›è¡Œ DNS è§£æ, è·å–å®æ—¶çš„è§£æç»“æœ, å¯ç”¨äºæ±¡æŸ“åˆ¤æ–­
- ğŸš§ **å°é”æµ‹è¯•**ï¼šæ£€æŸ¥ç‰¹å®šçš„ç½‘ç«™åœ¨éƒ¨åˆ†å›½å®¶æ˜¯å¦è¢«å°é”
- ğŸ““ **Whois æŸ¥è¯¢**ï¼šå¯¹åŸŸåæˆ– IP è¿›è¡Œ whois ä¿¡æ¯æŸ¥è¯¢
- ğŸ“€ **MAC åœ°å€æŸ¥è¯¢**ï¼šæŸ¥è¯¢ç‰©ç†åœ°å€çš„å½’å±ä¿¡æ¯
- ğŸŒ— **æš—é»‘æ¨¡å¼**ï¼šæ ¹æ®ç³»ç»Ÿè®¾ç½®è‡ªåŠ¨åˆ‡æ¢æš—é»‘/ç™½å¤©æ¨¡å¼, ä¹Ÿå¯ä»¥æ‰‹åŠ¨åˆ‡æ¢
- ğŸ“± **ç®€çº¦æ¨¡å¼**ï¼šä¸ºç§»åŠ¨ç‰ˆæä¾›çš„ä¸“é—¨æ¨¡å¼, ç¼©çŸ­é¡µé¢é•¿åº¦, å¿«é€ŸæŸ¥çœ‹æœ€é‡è¦çš„ä¿¡æ¯
- ğŸ” **æŸ¥ä»»æ„ IP ä¿¡æ¯**ï¼šå¯ä»¥é€šè¿‡å°å·¥å…·æŸ¥è¯¢ä»»æ„ IP çš„ä¿¡æ¯
- ğŸ“² **æ”¯æŒ PWA**ï¼šå¯ä»¥æ·»åŠ ä¸ºæ‰‹æœºåº”ç”¨ä»¥åŠç”µè„‘é‡Œçš„æ¡Œé¢åº”ç”¨, æ–¹ä¾¿ä½¿ç”¨
- âŒ¨ï¸ **æ”¯æŒå¿«æ·é”®**ï¼šå¯ä»¥éšæ—¶è¾“å…¥ `?` æŸ¥çœ‹å¿«æ·é”®èœå•
- ğŸŒ æ ¹æ®å¯ç”¨æ€§æ£€æµ‹ç»“æœ, è¿”å›ç›®å‰æ˜¯å¦å¯ä»¥è®¿é—®å…¨ä¸–ç•Œç½‘ç»œçš„æç¤º
- ğŸ‡ºğŸ‡¸ ğŸ‡¨ğŸ‡³ ğŸ‡«ğŸ‡· æ”¯æŒä¸­æ–‡ã€è‹±æ–‡ã€æ³•æ–‡

---

#### DDNS-GO

[DDNS-GO](https://github.com/jeessy2/ddns-go) èƒ½å¤Ÿè‡ªåŠ¨è·å¾—å…¬ç½‘ IPv4 æˆ– IPv6 åœ°å€, å¹¶è§£æåˆ°å¯¹åº”çš„åŸŸåæœåŠ¡.

![20241229154732_KXWXUX58.webp](https://cdn.dong4j.site/source/image/20241229154732_KXWXUX58.webp)

**ç‰¹æ€§**:

- æ”¯æŒ Macã€Windowsã€Linux ç³»ç»Ÿ, æ”¯æŒ ARMã€x86 æ¶æ„
- æ”¯æŒçš„åŸŸåæœåŠ¡å•† `é˜¿é‡Œäº‘` `è…¾è®¯äº‘` `Dnspod` `Cloudflare` `åä¸ºäº‘` `Callback` `ç™¾åº¦äº‘` `Porkbun` `GoDaddy` `Namecheap` `NameSilo` `Dynadot`
- æ”¯æŒæ¥å£/ç½‘å¡/[å‘½ä»¤](https://github.com/jeessy2/ddns-go/wiki/é€šè¿‡å‘½ä»¤è·å–IPå‚è€ƒ)è·å– IP
- æ”¯æŒä»¥æœåŠ¡çš„æ–¹å¼è¿è¡Œ
- é»˜è®¤é—´éš” 5 åˆ†é’ŸåŒæ­¥ä¸€æ¬¡
- æ”¯æŒåŒæ—¶é…ç½®å¤šä¸ª DNS æœåŠ¡å•†
- æ”¯æŒå¤šä¸ªåŸŸååŒæ—¶è§£æ
- æ”¯æŒå¤šçº§åŸŸå
- ç½‘é¡µä¸­é…ç½®, ç®€å•åˆæ–¹ä¾¿, é»˜è®¤å‹¾é€‰`ç¦æ­¢ä»å…¬ç½‘è®¿é—®`
- ç½‘é¡µä¸­æ–¹ä¾¿å¿«é€ŸæŸ¥çœ‹æœ€è¿‘ 50 æ¡æ—¥å¿—
- æ”¯æŒ Webhook é€šçŸ¥
- æ”¯æŒ TTL
- æ”¯æŒéƒ¨åˆ† DNS æœåŠ¡å•† [ä¼ é€’è‡ªå®šä¹‰å‚æ•°](https://github.com/jeessy2/ddns-go/wiki/ä¼ é€’è‡ªå®šä¹‰å‚æ•°), å®ç°åœ°åŸŸè§£æ/å¤š IP ç­‰åŠŸèƒ½

> åœ¨ [[homelab-network|ç½‘ç»œç¯‡]] ä¸­è¯¦ç»†çš„ä»‹ç».

---

#### LibreSpeed

[LibreSpeed](https://github.com/librespeed/speedtest) ä¸€ä¸ªåŸºäº HTML5 çš„è‡ªæ‰˜ç®¡ç½‘ç»œé€Ÿåº¦æµ‹è¯•å·¥å…·. å®ƒæ”¯æŒå¤šç§åç«¯è¯­è¨€å’Œæ•°æ®åº“, æ˜“äºéƒ¨ç½²å’Œä½¿ç”¨, å¹¶æä¾›å¤šç§æµ‹è¯•é€‰é¡¹.

![20241229154732_eMc0tcC3.webp](https://cdn.dong4j.site/source/image/20241229154732_eMc0tcC3.webp)

**ç‰¹ç‚¹**:

- **åŠŸèƒ½ä¸°å¯Œ**ï¼šæ”¯æŒä¸‹è½½ã€ä¸Šä¼ ã€æŠ–åŠ¨æµ‹è¯•, å¹¶æä¾› IP åœ°å€ã€ISPã€è·ç¦»ç­‰ä¿¡æ¯.
- **å…¼å®¹æ€§å¼º**ï¼šæ”¯æŒæ‰€æœ‰ç°ä»£æµè§ˆå™¨, åŒ…æ‹¬ç§»åŠ¨ç«¯.
- **æ˜“äºéƒ¨ç½²**ï¼šæä¾›è¯¦ç»†çš„æŒ‡å—å’Œè§†é¢‘æ•™ç¨‹.
- **æ”¯æŒå¤šç§åç«¯è¯­è¨€**ï¼šåŒ…æ‹¬ PHPã€Nodeã€Goã€Rust ç­‰.

---

#### Speedtest Tracker

[Speedtest Tracker](https://github.com/alexjustesen/speedtest-tracker) æ˜¯ä¸€ä¸ªè‡ªæ‰˜ç®¡åº”ç”¨ç¨‹åº, å¯ç›‘æ§äº’è”ç½‘è¿æ¥çš„æ€§èƒ½å’Œæ­£å¸¸è¿è¡Œæ—¶é—´.

![20241229154732_HntLQamY.webp](https://cdn.dong4j.site/source/image/20241229154732_HntLQamY.webp)

è¯¥åº”ç”¨ä½¿ç”¨ Ookla çš„ Speedtest æœåŠ¡è¿›è¡Œç½‘ç»œé€Ÿåº¦æµ‹è¯•, å¹¶è®°å½•æµ‹è¯•ç»“æœ, å¸®åŠ©æˆ‘ä»¬äº†è§£è‡ªèº«ç½‘ç»œæ€§èƒ½å’Œç¨³å®šæ€§.

**é‡è¦äº®ç‚¹**:

- **åŠŸèƒ½**ï¼šç›‘æ§ç½‘ç»œæ€§èƒ½å’Œç¨³å®šæ€§, è®°å½•æµ‹è¯•ç»“æœ, ç”Ÿæˆå†å²æ•°æ®.
- **éƒ¨ç½²æ–¹å¼**ï¼šå®¹å™¨åŒ–, æ”¯æŒ Docker å’Œ Docker Compose éƒ¨ç½².
- **æ•°æ®åº“æ”¯æŒ**ï¼šæ”¯æŒ SQLiteã€/MariaDB å’Œ PostgreSQL æ•°æ®åº“.
- **ä¼˜åŠ¿**ï¼šå¼€æºå…è´¹, å¯è‡ªå®šä¹‰é…ç½®, é€‚ç”¨äºå„ç§åœºæ™¯.

---

#### Snapdrop

[Snapdrop](https://github.com/SnapDrop/snapdrop) æ˜¯ä¸€ä¸ªåŸºäº WebRTC çš„æœ¬åœ°æ–‡ä»¶åˆ†äº«æ¸è¿›å¼ Web åº”ç”¨. é¡¹ç›®ä½¿ç”¨ HTML5ã€ES6ã€CSS3ã€WebRTCã€WebSockets å’Œ NodeJS ç­‰æŠ€æœ¯æ„å»º, æ”¯æŒç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­å¿«é€Ÿåˆ†äº«æ–‡ä»¶.

![20241229154732_5YIDLYVG.webp](https://cdn.dong4j.site/source/image/20241229154732_5YIDLYVG.webp)

**é‡è¦äº®ç‚¹**:

- **æŠ€æœ¯æ ˆ**: HTML5ã€ES6ã€CSS3ã€WebRTCã€WebSocketsã€NodeJS
- **åŠŸèƒ½**: æœ¬åœ°æ–‡ä»¶åˆ†äº« **ç‰¹æ€§**: æ”¯æŒæ¸è¿›å¼ Web åº”ç”¨
- **è®¸å¯è¯**: GPL-3.0
- **å¼€æº**: å¯åœ¨ GitHub ä¸Šå…è´¹ä¸‹è½½å’Œä½¿ç”¨

> æ–¹ä¾¿çš„ç‚¹æ˜¯åªè¦æœ‰æµè§ˆå™¨å³å¯è¿›è¡Œæ–‡ä»¶å…±äº«, è¿™åœ¨ä¸ Android å…±äº«æ–‡ä»¶æ—¶æ¯”è¾ƒæ–¹ä¾¿.

---

#### Memos

[Memos](https://github.com/usememos/memos) æ˜¯ä¸€æ¬¾è½»é‡çº§ã€è‡ªæ‰˜ç®¡çš„ç¬”è®°å·¥å…·, æ”¯æŒ Markdown è¯­æ³•, å¹¶æä¾›å¤šç§è‡ªå®šä¹‰é€‰é¡¹.

![20241229154732_fxfM2D7h.webp](https://cdn.dong4j.site/source/image/20241229154732_fxfM2D7h.webp)

**é‡è¦äº®ç‚¹**:

- **éšç§ä¼˜å…ˆ**ï¼šæ‰€æœ‰æ•°æ®æœ¬åœ°å­˜å‚¨, ä¿éšœç”¨æˆ·éšç§.
- **å¿«é€Ÿåˆ›å»º**ï¼šæ”¯æŒçº¯æ–‡æœ¬å’Œ Markdown è¯­æ³•, æ–¹ä¾¿æ ¼å¼åŒ–å’Œåˆ†äº«.
- **è½»é‡çº§**ï¼šä½¿ç”¨ Go å’Œ React æ„å»º, æ€§èƒ½å¼ºå¤§ä½†å ç”¨èµ„æºå°‘.
- **å¯å®šåˆ¶**ï¼šå¯è‡ªå®šä¹‰æœåŠ¡å™¨åç§°ã€å›¾æ ‡ã€æ ·å¼ç­‰.
- **å¼€æºå…è´¹**ï¼šä»£ç å¼€æº, å¯å…è´¹ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½.

macOS ä¸Šæœ‰å…è´¹çš„å®¢æˆ·ç«¯-[MoeMemos](https://github.com/mudkipme/MoeMemos):

![20241229154732_fgToqa1H.webp](https://cdn.dong4j.site/source/image/20241229154732_fgToqa1H.webp)

---

#### Homebox

[Homebox](https://github.com/XGHeaven/homebox) ç”¨äºç»„å»ºå®¶åº­å±€åŸŸç½‘æ—¶, å¯¹ç½‘ç»œè¿›è¡Œè°ƒè¯•ã€æ£€æµ‹ã€å‹æµ‹çš„å·¥å…·é›†åˆ.

![20241229154732_r6wS9X64.webp](https://cdn.dong4j.site/source/image/20241229154732_r6wS9X64.webp)

**ç‰¹æ€§**:

1. é¢å‘æœªæ¥æµè§ˆå™¨è®¾è®¡
2. é«˜è¾¾ 10G çš„æµè§ˆå™¨é€Ÿåº¦æµ‹è¯•
3. è‡ªå¸¦ Ping æ£€æµ‹
4. ä¸°å¯Œçš„è‡ªå®šä¹‰æµ‹é€Ÿå‚æ•°
5. æœåŠ¡ç«¯æ— éœ€åƒä¼ ç»Ÿæ–‡ä»¶æ‹·è´ä¸€æ ·éœ€è¦å›ºæ€çš„æ”¯æŒ
6. å‹å¥½çš„ UI äº¤äº’
7. é’ˆå¯¹ä½é€Ÿç½‘ç»œ(< 2.5G)ä¼˜åŒ–æµ‹é€Ÿèµ„æºå ç”¨

---

#### 1Panel

[1Panel](https://github.com/1Panel-dev/1Panel) æ˜¯ä¸€æ¬¾å¼€æºçš„ Linux æœåŠ¡å™¨è¿ç»´ç®¡ç†å·¥å…·. æä¾› Web ç•Œé¢, æ”¯æŒä¸»æœºç›‘æ§ã€æ–‡ä»¶ç®¡ç†ã€æ•°æ®åº“ç®¡ç†ç­‰åŠŸèƒ½, å¹¶æ·±åº¦é›†æˆ WordPress å’Œ Halo ç­‰å»ºç«™è½¯ä»¶.

å› ä¸ºç°åœ¨ 1Panel ä¸æ”¯æŒå¤šä¸»æœºç®¡ç†, æ‰€ä»¥åœ¨å¤§å¤šæ•°å¸¸ç”¨æœåŠ¡å™¨ä¸Šéƒ½å®‰è£…äº† 1Panel.

![20241229154732_IoLQHeCb.webp](https://cdn.dong4j.site/source/image/20241229154732_IoLQHeCb.webp)

**é‡è¦äº®ç‚¹**:

- æ”¯æŒä¸»æœºç›‘æ§ã€æ–‡ä»¶ç®¡ç†ã€æ•°æ®åº“ç®¡ç†ç­‰åŠŸèƒ½ æ·±åº¦é›†æˆ WordPress å’Œ Halo ç­‰å»ºç«™è½¯ä»¶.
- æä¾›ä¸€é”®å®‰è£…æŒ‡å—å’Œæ–‡æ¡£é“¾æ¥.
- å­˜åœ¨ä¸“ä¸šç‰ˆ, æä¾›æ›´å¤šåŠŸèƒ½å’ŒæŠ€æœ¯æ”¯æŒæœåŠ¡

---

#### Syncthing

[Syncthing](https://syncthing.net/) æ˜¯ä¸€ä¸ªå¼€æºçš„æ–‡ä»¶åŒæ­¥å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨è½¯ä»¶, é‡‡ç”¨ Go è¯­è¨€ç¼–å†™. å®ƒå¯ä»¥åœ¨æœ¬åœ°ç½‘ç»œä¸Šçš„è®¾å¤‡ä¹‹é—´æˆ–é€šè¿‡ Internet åœ¨è¿œç¨‹è®¾å¤‡ä¹‹é—´åŒæ­¥æ–‡ä»¶, ä½¿ç”¨äº†å…¶ç‹¬æœ‰çš„å¯¹ç­‰è‡ªç”±å—äº¤æ¢åè®®.

é€šè¿‡å‘ç°æœåŠ¡å™¨å¯»æ‰¾èŠ‚ç‚¹, å¦‚æœèŠ‚ç‚¹ä¸èƒ½ç›´è¿çš„æƒ…å†µä¸‹, é€šè¿‡ä¸­ç»§æœåŠ¡å™¨ç©¿é€å†…ç½‘ä¼ è¾“æ•°æ®. ç”¨æˆ·å¯ä»¥è‡ªè¡Œæ­å»ºå‘ç°æœåŠ¡å™¨å’Œä¸­ç»§æœåŠ¡å™¨, åœ¨ç¨‹åºé‡Œé¢ä¹Ÿå¯ä»¥æŒ‡å®šä½¿ç”¨ç›¸åº”çš„æœåŠ¡å™¨. å¹¶æä¾›åŸºäº Web çš„æ§åˆ¶ç•Œé¢, è¿™ä¹Ÿä¾¿äºè¿œç¨‹æœåŠ¡å™¨çš„ä½¿ç”¨.

![20241229154732_TRIl2gkR.webp](https://cdn.dong4j.site/source/image/20241229154732_TRIl2gkR.webp)

**é‡è¦äº®ç‚¹**:

- **ç§æœ‰æ€§**: æ–‡ä»¶ä»…åœ¨æœ¬åœ°è®¾å¤‡ä¸Šå­˜å‚¨, æ— ä¸­å¤®æœåŠ¡å™¨, ä¿æŠ¤æ•°æ®å®‰å…¨.
- **å®‰å…¨æ€§**: ä½¿ç”¨ TLS åŠ å¯†, ç¡®ä¿é€šä¿¡å®‰å…¨, å¹¶é‡‡ç”¨è¯ä¹¦è®¤è¯è®¾å¤‡.
- **å¼€æº**: æºä»£ç å¼€æ”¾, ç¡®ä¿é€æ˜å¯ä¿¡ä»»æ€§.
- **æ˜“ç”¨æ€§**: ç•Œé¢ç®€æ´, é…ç½®ç®€å•, æ˜“äºä¸Šæ‰‹.
- **å¤šå¹³å°**: æ”¯æŒ macOSã€Windowsã€Linux ç­‰å¤šç§æ“ä½œç³»ç»Ÿ.

> [[homelab-data|æ•°æ®ç¯‡]] å†è¯¦ç»†ä»‹ç»å¦‚ä½•ç»“åˆ Synology Drive åŒæ­¥æ–‡ä»¶çš„æ€è·¯.

ç›®å‰éƒ½æ˜¯åœ¨å±€åŸŸç½‘å†…å…±äº«æ–‡ä»¶, ä¸ºäº†æ–¹ä¾¿æ”¾åœ¨å…¬å¸çš„ R2S ä¹Ÿèƒ½åŒæ­¥æ–‡ä»¶, éœ€è¦æ­å»ºå‘ç°æœåŠ¡å’Œä¸­ç»§æœåŠ¡.

##### å‘ç°æœåŠ¡

Syncthing ä¾é å‘ç°æœåŠ¡å™¨åœ¨äº’è”ç½‘ä¸Šå¯»æ‰¾å¯¹ç­‰ç‚¹. ä»»ä½•äººéƒ½å¯ä»¥è¿è¡Œå‘ç°æœåŠ¡å™¨å¹¶å°† Syncthing å®‰è£…æŒ‡å‘å®ƒ.

[discosrv](https://github.com/syncthing/discosrv) ä¸‹è½½å¹¶ä¸Šä¼ æœåŠ¡å™¨åç›´æ¥è¿è¡Œå³å¯:

```shell
âœ  discosrv ./stdiscosrv
stdiscosrv v1.23.4 "Fermium Flea" (go1.20.2 linux-amd64) teamcity@build.syncthing.net 2023-04-05 13:25:55 UTC [purego]
Server device ID is 1111111-2222222-3333333-4444444-5555555-6666666-7777777-8888888
```

æ‹¿åˆ°å‘ç°æœåŠ¡å™¨çš„ ID å, å°†è¯¥ ID å¡«å†™è‡³ **Syncthing** å®¢æˆ·ç«¯ä¸­, å¡«å†™ä½ç½®å¦‚ä¸‹:

![20241229154732_OAInVUPJ.webp](https://cdn.dong4j.site/source/image/20241229154732_OAInVUPJ.webp)

æ ¼å¼ä¸º: `https://æœåŠ¡å™¨ IP:port/?id={å‘ç°æœåŠ¡å™¨ ID}`.

è®°å¾—é˜²ç«å¢™å¼€å¯ 8443 ç«¯å£, å‘ç°æœåŠ¡å™¨é»˜è®¤ç«¯å£ä¸º 8443, è‹¥æƒ³æ›´æ”¹, å¯ä»¥ä½¿ç”¨ `./stdiscosrv -listen=ä½ çš„ç«¯å£` æ¥å¯åŠ¨.

##### ä¸­ç»§æœåŠ¡

Syncthing ä¾èµ–äºç¤¾åŒºè´¡çŒ®çš„ä¸­ç»§æœåŠ¡å™¨ç½‘ç»œ. ä»»ä½•äººéƒ½å¯ä»¥è¿è¡Œä¸­ç»§æœåŠ¡å™¨, å®ƒä¼šè‡ªåŠ¨åŠ å…¥ä¸­ç»§æ± å¹¶å¯ä¾› Syncthing ç”¨æˆ·ä½¿ç”¨.

[relaysrv](https://github.com/syncthing/relaysrv) ä¸‹è½½å¹¶ä¸Šä¼ æœåŠ¡å™¨åç›´æ¥è¿è¡Œå³å¯:

```shell
âœ  relaysrv ./strelaysrv -pools=""
2024/12/02 15:05:38 main.go:141: strelaysrv v1.22.1 "Fermium Flea" (go1.19.2 linux-amd64) teamcity@build.syncthing.net 2022-11-02 06:27:53 UTC
2024/12/02 15:05:38 main.go:147: Connection limit 52428
2024/12/02 15:05:38 main.go:259: URI: relay://0.0.0.0:{port}/?id=aaaaaaa-bbbbbbb-ccccccc-ddddddd-eeeeeee-fffffff-ggggggg-hhhhhhh&networkTimeout=2m0s&pingInterval=1m0s&statusAddr=%3A22070
```

![20241229154732_Ig5uN2Qn.webp](https://cdn.dong4j.site/source/image/20241229154732_Ig5uN2Qn.webp)

æ ¼å¼ä¸º:`relay://ä½ çš„æœåŠ¡å™¨IP:22067/?id=ä¸­ç»§æœåŠ¡å™¨ID&networkTimeout=2m0s&pingInterval=1m0s&statusAddr=%3A22070`

æ³¨æ„ï¼š

- `-pools=""`: æ„æ€æ˜¯ä¸åŠ å…¥ä»»ä½•ä¸­ç»§æ± , å¯ä»¥ä¿æŒä½ çš„ä¸­ç»§æœåŠ¡å™¨ä¸ºç§æœ‰çš„;
- è®°å¾—å¼€æ”¾é˜²ç«å¢™ 22067 ç«¯å£, è‹¥æƒ³æ›´æ¢ç«¯å£, å¯ä»¥ä½¿ç”¨ `-listen=ä½ çš„ç«¯å£` æ¥æ›´æ”¹ç«¯å£;

---

### DS923+

#### Stirling-PDF

[Stirling-PDF](https://www.stirlingpdf.com/) æ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„æœ¬åœ°æ‰˜ç®¡ Web PDF å¤„ç†å·¥å…·. å®ƒæ”¯æŒå„ç§ PDF æ“ä½œ, å¦‚æ‹†åˆ†ã€åˆå¹¶ã€è½¬æ¢ã€æ—‹è½¬ã€å‹ç¼©ç­‰, å¹¶æä¾›äº†ä¸°å¯Œçš„åŠŸèƒ½å’Œå®šåˆ¶é€‰é¡¹, é€‚ç”¨äºä¸ªäººå’Œå›¢é˜Ÿ.

![20241229154732_wQbrqMTX.webp](https://cdn.dong4j.site/source/image/20241229154732_wQbrqMTX.webp)

**é‡è¦äº®ç‚¹**:

- **æœ¬åœ°æ‰˜ç®¡**ï¼šæ— éœ€å®‰è£…, é€šè¿‡ Docker è¿è¡Œ, æ–¹ä¾¿å¿«æ·.
- **åŠŸèƒ½ä¸°å¯Œ**ï¼šæ”¯æŒå¤šç§ PDF æ“ä½œ, å¦‚é¡µé¢æ“ä½œã€è½¬æ¢æ“ä½œã€å®‰å…¨å’Œæƒé™ã€æ“ä½œç­‰.
- **æ˜“äºå®šåˆ¶**ï¼šå¯è‡ªå®šä¹‰åº”ç”¨ç¨‹åºåç§°ã€æ ‡è¯­ã€å›¾æ ‡ç­‰.
- **æ”¯æŒå¤šç§è¯­è¨€**ï¼šç›®å‰æ”¯æŒ 37 ç§è¯­è¨€.
- **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒæ‰©å±• OCR å’Œå‹ç¼©åŠŸèƒ½.

---

<!--

#### Zerox OCR

[Zerox OCR](https://github.com/getomni-ai/zerox)

-->

#### Draw.io

[Draw.io](https://github.com/jgraph) æ˜¯ä¸€æ¬¾å…è´¹ä¸”å¼€æºçš„åœ¨çº¿ç»˜å›¾å·¥å…·, ç°å·²æ›´åä¸º **diagrams.net**. å®ƒæ”¯æŒåˆ›å»ºå„ç§å›¾è¡¨, å¦‚æµç¨‹å›¾ã€ç½‘ç»œæ‹“æ‰‘å›¾ã€UML å›¾ã€ç»„ç»‡ç»“æ„å›¾ç­‰. Draw.io æä¾›ç›´è§‚çš„æ‹–æ”¾å¼ç•Œé¢, æ”¯æŒæœ¬åœ°å’Œäº‘ç«¯å­˜å‚¨ï¼ˆå¦‚ Google Driveã€OneDriveã€GitHub ç­‰ï¼‰, é€‚åˆå›¢é˜Ÿåä½œå’Œä¸ªäººä½¿ç”¨, å¹¿æ³›åº”ç”¨äºè½¯ä»¶å¼€å‘ã€é¡¹ç›®ç®¡ç†å’Œæ–‡æ¡£è®¾è®¡ç­‰é¢†åŸŸ.

![20241229154732_TVib1acn.webp](https://cdn.dong4j.site/source/image/20241229154732_TVib1acn.webp)

åšå¼€å‘çš„æœ‹å‹åº”è¯¥ç»å¸¸ç”¨åˆ°, Draw.io åœ¨ IDEA, Visual Studio Code ç­‰å¸¸è§å¼€å‘å¹³å°ä¸Šéƒ½æœ‰é›†æˆ, ç›®å‰ä½¿ç”¨æœ€å¤šçš„æ˜¯ [æ¡Œé¢ç‰ˆ](https://github.com/jgraph/drawio-desktop), æ”¯æŒå„å¤§å¹³å°.

**ç›¸å…³èµ„æº**:

- [drawio-libs](https://github.com/jgraph/drawio-libs)
- [other drawio-libs](https://github.com/JF-Dumont/drawio-libs)
- [ä½¿ç”¨æ¥è‡ªç½‘ç»œçš„è‡ªå®šä¹‰å½¢çŠ¶åº“](https://www.drawio.com/blog/public-custom-libraries)

---

#### Excalidraw

[Excalidraw](https://github.com/excalidraw/excalidraw) æ˜¯ä¸€ä¸ªå¼€æºçš„è™šæ‹Ÿæ‰‹ç»˜é£æ ¼ç™½æ¿å·¥å…·, æ”¯æŒåä½œå’Œç«¯åˆ°ç«¯åŠ å¯†. å®ƒå¯ä»¥å¸®åŠ©ç”¨æˆ·åˆ›å»ºå„ç§æ‰‹ç»˜é£æ ¼çš„å›¾è¡¨ã€çº¿æ¡†å›¾æˆ–å…¶ä»–å›¾å½¢, é€‚ç”¨äºç»˜å›¾ã€è®¾è®¡ã€ä¼šè®®è®°å½•ç­‰å¤šç§åœºæ™¯.

![20241229154732_WTC7w3BE.webp](https://cdn.dong4j.site/source/image/20241229154732_WTC7w3BE.webp)

**ä¸»è¦ç‰¹ç‚¹**ï¼š

- **æ— é™ç”»å¸ƒ**ï¼š å¯ä»¥è‡ªç”±åœ°æ‹–åŠ¨ã€ç¼©æ”¾å’Œç§»åŠ¨ç”»å¸ƒ, ä¸å—é™åˆ¶.
- **æ‰‹ç»˜é£æ ¼**ï¼š æ”¯æŒå„ç§ç»˜å›¾å·¥å…·, åŒ…æ‹¬çº¿æ¡ã€çŸ©å½¢ã€ã€ç®­å¤´ç­‰, å¹¶æä¾›ä¸°å¯Œçš„æ ·å¼é€‰é¡¹.
- **è‡ªå®šä¹‰**ï¼š å¯ä»¥è‡ªå®šä¹‰ç”»å¸ƒèƒŒæ™¯ã€å·¥å…·æ ã€é¢œè‰²ç­‰, æ»¡è¶³ä¸ªæ€§åŒ–éœ€æ±‚.
- **å›¾ç‰‡å’Œå½¢çŠ¶åº“**ï¼š æ”¯æŒå¯¼å…¥å›¾ç‰‡å’Œå½¢çŠ¶åº“, æ–¹ä¾¿å¿«é€Ÿåˆ›å»ºå›¾å½¢.
- **å›½é™…åŒ–**ï¼š æ”¯æŒå¤šç§è¯­è¨€, æ–¹ä¾¿å…¨çƒç”¨æˆ·ä½¿ç”¨.
- **å¯¼å‡ºåŠŸèƒ½**ï¼š æ”¯æŒå°†å›¾å½¢å¯¼å‡ºä¸º PNGã€SVG å’Œå¯å¤åˆ¶ç²˜è´´çš„æ ¼å¼, æ–¹ä¾¿åˆ†äº«å’Œç¼–è¾‘.

> ç›®å‰ä¾èµ–äº Draw.io æºæ–‡ä»¶å¯åœ¨ Markdown æŸ¥çœ‹ä¸”å¯ç›´æ¥ç¼–è¾‘çš„ç‰¹æ€§, Excalidraw è¿˜ä¸å…·å¤‡, `.excalidraw` æ ¼å¼æ–‡ä»¶è™½ç„¶èƒ½äºŒæ¬¡ç¼–è¾‘, ä½†æ˜¯æ— æ³•åœ¨ Markdown ä¸­é¢„è§ˆ. å› æ­¤ Excalidraw ç®—å¤‡é€‰æ–¹æ¡ˆå¶å°”ä½¿ç”¨.

---

#### Portainer

[Portainer](https://www.portainer.io/) ä¸€æ¬¾ç”¨äºç®¡ç†å’Œéƒ¨ç½² Dockerã€Swarm å’Œ Kubernetes é›†ç¾¤çš„å®¹å™¨ç®¡ç†è½¯ä»¶. å®ƒæä¾›é›†ä¸­å¼ç•Œé¢, ç®€åŒ–å®¹å™¨åŒ–è¿›ç¨‹, å¹¶æ”¯æŒå¤šäº‘å’Œè¾¹ç¼˜ç¯å¢ƒ.

![20241229154732_GOnzu0wY.webp](https://cdn.dong4j.site/source/image/20241229154732_GOnzu0wY.webp)

**é‡è¦äº®ç‚¹**:

- **è·¨å¹³å°ç®¡ç†**ï¼šæ”¯æŒ Dockerã€Swarm å’Œ Kubernetes, é€‚ç”¨äºå¤šäº‘å’Œè¾¹ç¼˜ç¯å¢ƒ.
- **ç”¨æˆ·å‹å¥½çš„ç•Œé¢**ï¼šæä¾›ç›´è§‚çš„ UI, ç®€åŒ–æ“ä½œæµç¨‹.
- **å®‰å…¨è®¿é—®**ï¼šæ”¯æŒé›†ä¸­å¼éªŒè¯å’Œæˆæƒ.
- **å¤šäº‘å’Œè¾¹ç¼˜æ”¯æŒ**ï¼šé€‚ç”¨äºä¸åŒç¯å¢ƒ, åŒ…æ‹¬æ•°æ®ä¸­å¿ƒã€äº‘å’Œè¾¹ç¼˜è®¾å¤‡.

---

#### å°é›… Alist

[docker-xiaoya](https://github.com/monlor/docker-xiaoya) ä½¿ç”¨ Docker Compose ä¸€é”®éƒ¨ç½² Xiaoya æœåŠ¡çš„å…¨å¥—è§£å†³æ–¹æ¡ˆ, æ”¯æŒ Alist + Emby + Jellyfin çš„ä¸€é”®éƒ¨ç½², å¹¶å…¼å®¹å¤šç§å¹³å°å’Œæ¶æ„.

![20241229154732_wCLUNTfT.webp](https://cdn.dong4j.site/source/image/20241229154732_wCLUNTfT.webp)

**é‡è¦äº®ç‚¹**:

- **ä¸€é”®éƒ¨ç½²**ï¼šç®€åŒ–äº† Xiaoya æœåŠ¡çš„éƒ¨ç½²æµç¨‹, æ— éœ€äººå·¥å¹²é¢„.
- **å…¨å¹³å°æ”¯æŒ**ï¼šå…¼å®¹ Linuxã€Windowsã€Macã€Synology ç­‰å¹³å°, ä»¥åŠ X å’Œ Arm æ¶æ„.
- **é›†æˆè„šæœ¬**ï¼šæ‰€æœ‰è„šæœ¬é›†æˆåˆ° Docker é•œåƒ, é¿å…æ±¡æŸ“ç³»ç»Ÿç¯å¢ƒ.
- **è‡ªåŠ¨æ›´æ–°**ï¼šæ”¯æŒè‡ªåŠ¨æ›´æ–°é•œåƒã€äº‘ç›˜æ•°æ®ã€æœåŠ¡é…ç½®å’Œåª’ä½“æ•°æ®.
- **å¤šç§äº‘ç›˜æ”¯æŒ**ï¼šæ”¯æŒå°é›… Alistã€å¤¸å…‹ç½‘ç›˜ã€PikPak ç½‘ç›˜å’Œé˜¿é‡Œäº‘ç›˜èµ„æº.

---

#### RSSHub

[RSSHub](https://github.com/DIYgod/RSSHub) æ˜¯ä¸€ä¸ªå¯ä»¥å°†**ä»»ä½•**å†…å®¹éƒ½å¯ä»¥æŠ“å–ç„¶åè½¬æ¢æˆ RSS è®¢é˜…çš„ç½‘ç«™.

é¡¹ç›®çš„ slogan **ä¸‡ç‰©çš†å¯ RSS**, å®ƒä¸ä»…å¯ä»¥è®¢é˜…å„ç§åšå®¢ã€è®ºå›ã€æ–°åª’ä½“, ç”šè‡³ç¤¾äº¤åª’ä½“ã€æ¨ç‰¹ç­‰éƒ½ä¸åœ¨è¯ä¸‹, å¾ˆå¼º, è¯¦è§[é£Ÿç”¨æŒ‡å—](https://docs.rsshub.app/zh/guide/).

è¯¥é¡¹ç›®å·²ç»æŒç»­å‘å±• 6 å¹´äº†, ä¸€ç›´åœ¨æŒç»­æ›´æ–°, ç”šè‡³ä»Šå¹´[è¿›è¡Œäº†ä¸€æ¬¡é‡æ„](https://diygod.cc/6-year-of-rsshub), ä¸å¾—ä¸ä½©æœå¤§ä½¬ä»¬çš„è¡ŒåŠ¨åŠ›.

![20241229154732_OObcuEZH.webp](https://cdn.dong4j.site/source/image/20241229154732_OObcuEZH.webp)

é™¤æ­¤ä¹‹å¤–, å®˜æ–¹è¿˜æä¾›äº† [Radar åŠŸèƒ½](https://docs.rsshub.app/zh/guide/#radar), ç»“åˆæµè§ˆå™¨æ’ä»¶å°±å¯ä»¥å‘ç°ä½ æ­£åœ¨è®¿é—®çš„ç«™ç‚¹ RSSHub æ˜¯å¦å·²ç»æ”¯æŒè®¢é˜…äº†, å¦‚æœæ”¯æŒäº†å¯ä»¥ä¸€é”®è½¬æ¢æˆè®¢é˜…çš„åœ°å€, å¾ˆæ–¹ä¾¿. ä¸ä»…å¦‚æ­¤, è¿˜æ”¯æŒç§»åŠ¨ç«¯.

![20241229154732_HV9qq6Zt.webp](https://cdn.dong4j.site/source/image/20241229154732_HV9qq6Zt.webp)

**é‡è¦äº®ç‚¹**:

- **åŠŸèƒ½**: å°†å„ç§å†…å®¹æºè½¬æ¢ä¸º RSS, æ”¯æŒè¶…è¿‡ 5,000 ä¸ªå…¨çƒå®ä¾‹.
- **ç‰¹ç‚¹**: æ˜“äºä½¿ç”¨ã€åŠŸèƒ½å¼ºå¤§ã€æ”¯æŒä¸°å¯Œçš„æ’ä»¶å’Œæ‰©å±•.
- **ç›¸å…³é¡¹ç›®**: RSSHub Radarã€RSSBudã€Aid ç­‰.
- **è´¡çŒ®è€…**: è¶…è¿‡ 1,100 ä½è´¡çŒ®è€….
- **éƒ¨ç½²**: æ”¯æŒ GitHub Pagesã€Vercel ç­‰å¤šç§éƒ¨ç½²æ–¹å¼.

<!--

https://razeen.me/posts/improve-information-sources-with-rss/

-->

---

#### Navidrome

[Navidrome](https://github.com/navidrome/navidrome) å…è®¸ç”¨æˆ·ä»ä»»ä½•æµè§ˆå™¨æˆ–ç§»åŠ¨è®¾å¤‡è®¿é—®å…¶éŸ³ä¹åº“, å¹¶æä¾›ä¸°å¯Œçš„åŠŸèƒ½, ä¾‹å¦‚å¤„ç†å¤§å‹éŸ³ä¹åº“ã€æ”¯æŒå¤šç§éŸ³é¢‘æ ¼å¼ã€å¤šç”¨æˆ·æ”¯æŒã€è‡ªåŠ¨ç›‘æ§åº“ç­‰.

![20241229154732_ple0Nxse.webp](https://cdn.dong4j.site/source/image/20241229154732_ple0Nxse.webp)

**é‡è¦äº®ç‚¹**:

- Navidrome æ˜¯ä¸€ä¸ªå¼€æºéŸ³ä¹æœåŠ¡å™¨é¡¹ç›®.
- æ”¯æŒä»ä»»ä½•è®¾å¤‡è®¿é—®éŸ³ä¹åº“.
- æ”¯æŒå¤šç§éŸ³é¢‘æ ¼å¼.
- å¤šç”¨æˆ·æ”¯æŒ, æ¯ä¸ªç”¨æˆ·æ‹¥æœ‰è‡ªå·±çš„æ’­æ”¾ç­‰.
- è‡ªåŠ¨ç›‘æ§éŸ³ä¹åº“å˜åŒ–.
- ç•Œé¢åŸºäº Material UI.
- å…¼å®¹ Subsonic/Madsonic/Airsonic å®¢æˆ·ç«¯.

---

#### Music Tag Web

[Music Tag Web](https://github.com/xhongc/music-tag-web) æ˜¯ä¸€æ¬¾å¯ä»¥ç¼–è¾‘æ­Œæ›²çš„æ ‡é¢˜, ä¸“è¾‘, è‰ºæœ¯å®¶, æ­Œè¯, å°é¢ç­‰ä¿¡æ¯çš„éŸ³ä¹æ ‡ç­¾ç¼–è¾‘å™¨ç¨‹åº, æ”¯æŒ FLAC, APE, WAV, AIFF, WV, TTA, MP3, M4A, OGG, MPC, OPUS, WMA, DSF, DFF, MP4 ç­‰éŸ³é¢‘æ ¼å¼. æˆ‘ä¸»è¦ä½¿ç”¨è‡ªåŠ¨åˆ®å‰ŠåŠŸèƒ½æ¥æ‰¹é‡ä¿®æ”¹éŸ³ä¹æ ‡ç­¾.

åªæœ‰ V2 ç‰ˆæœ¬æ‰å…·å¤‡é«˜çº§åŠŸèƒ½, éœ€è¦ä»˜è´¹ä½¿ç”¨.

![20241229154732_YQl8DLNI.webp](https://cdn.dong4j.site/source/image/20241229154732_YQl8DLNI.webp)

**ç‰¹æ€§**:

- æ”¯æŒå¤§éƒ¨åˆ†éŸ³é¢‘æ ¼å¼å…ƒæ•°æ®çš„æŸ¥çœ‹ã€ç¼–è¾‘å’Œä¿®æ”¹
- **æ”¯æŒæ‰¹é‡è‡ªåŠ¨ä¿®æ”¹ï¼ˆåˆ®å‰Šï¼‰éŸ³ä¹æ ‡ç­¾**
- æ”¯æŒéŸ³ä¹æŒ‡çº¹è¯†åˆ«, å³ä½¿æ²¡æœ‰å…ƒæ•°æ®ä¹Ÿå¯ä»¥è¯†åˆ«éŸ³ä¹
- æ”¯æŒæ•´ç†éŸ³ä¹æ–‡ä»¶, æŒ‰è‰ºæœ¯å®¶, ä¸“è¾‘åˆ†ç»„, æˆ–è€…è‡ªå®šä¹‰å¤šçº§åˆ†ç»„
- æ”¯æŒæ–‡ä»¶æ’åº, æŒ‰ç…§æ–‡ä»¶å, æ–‡ä»¶å¤§å°, æ›´æ–°æ—¶é—´æ’åº
- æ”¯æŒæ‰¹é‡è½¬æ¢éŸ³ä¹å…ƒæ•°æ®ç¹ä½“è½¬ç®€ä½“, æˆ–è€…ç®€ä½“è½¬ç¹ä½“
- æ”¯æŒæ–‡ä»¶åç§°çš„æ‹†åˆ†è§£åŒ…, è¡¥å……ç¼ºå¤±å…ƒæ•°æ®ä¿¡æ¯
- æ”¯æŒæ–‡æœ¬æ›¿æ¢, æ‰¹é‡æ›¿æ¢éŸ³ä¹å…ƒæ•°æ®ä¸­è„æ•°æ®
- æ”¯æŒéŸ³ä¹æ ¼å¼è½¬æ¢, å¼•å…¥ ffmpeg æ”¯æŒéŸ³ä¹æ ¼å¼è½¬æ¢
- æ”¯æŒæ•´è½¨éŸ³ä¹æ–‡ä»¶çš„åˆ‡å‰²
- æ”¯æŒå¤šç§éŸ³ä¹æ ‡ç­¾æ¥æº
- æ”¯æŒæ­Œè¯ç¿»è¯‘åŠŸèƒ½
- æ”¯æŒæ˜¾ç¤ºæ“ä½œè®°å½•
- æ”¯æŒå¯¼å‡ºä¸“è¾‘å°é¢æ–‡ä»¶, æ”¯æŒè‡ªå®šä¹‰ä¸Šä¼ ä¸“è¾‘å°é¢
- æ”¯æŒé€‚é…ç§»åŠ¨ç«¯ UI, æ”¯æŒæ‰‹æœºç«¯è®¿é—®
- æ”¯æŒä½¿ç”¨å°çˆ±åŒå­¦æ’­æ”¾æœ¬åœ°éŸ³ä¹, æ’­æ”¾ NAS æœ¬åœ°éŸ³ä¹

---

#### Roon

[Roon](https://roon.app/en/) æ˜¯ä¸€æ¬¾ä¸“ä¸šçš„éŸ³ä¹æ’­æ”¾å’ŒéŸ³ä¹åº“ç®¡ç†è½¯ä»¶ï¼Œæ—¨åœ¨ä¸ºéŸ³ä¹çˆ±å¥½è€…æä¾›æ›´ä¸°å¯Œã€æ›´æ·±å…¥çš„éŸ³ä¹ä½“éªŒã€‚

DS923+ å®‰è£… Roon çš„ Core Server, å°†æ— æŸéŸ³ä¹å…¨éƒ¨å¯¼å…¥åˆ° Roon, åœ¨ macOS å’Œ iPhone å°±å¯ä»¥æ–¹ä¾¿çš„å¬éŸ³ä¹äº†.

![20241229154732_kR2q8gAJ.webp](https://cdn.dong4j.site/source/image/20241229154732_kR2q8gAJ.webp)

**ä¸»è¦åŠŸèƒ½**ï¼š

- **éŸ³ä¹åº“ç®¡ç†**ï¼š å°†æ‰€æœ‰éŸ³ä¹æ–‡ä»¶æ•´åˆåˆ°ä¸€ä¸ªä¸­å¤®åº“ä¸­ï¼Œæ–¹ä¾¿ç®¡ç†å’Œæµè§ˆã€‚
- **éŸ³ä¹ä¿¡æ¯ä¸°å¯Œ**ï¼š æä¾›è‰ºæœ¯å®¶ã€ä¸“è¾‘ã€æ­Œæ›²çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¼ è®°ã€è¯„è®ºã€ç…§ç‰‡ã€æ­Œè¯ã€å·¡æ¼”æ—¥æœŸç­‰ã€‚
- **æ— ç¼æ’­æ”¾**ï¼š æ”¯æŒå¤šç§éŸ³ä¹æ’­æ”¾è®¾å¤‡å’Œå¹³å°ï¼Œ AirPlayã€Chromecastã€Roon Readyã€Squeezeboxã€æ™ºèƒ½ç”µè§†ã€æ™ºèƒ½éŸ³ç®±ã€USB/HDMI æ’­æ”¾å™¨ã€ç§»åŠ¨è®¾å¤‡ç­‰ã€‚
- **é«˜ä¿çœŸéŸ³è´¨**ï¼š é‡‡ç”¨ä¸“ä¸šéŸ³é¢‘å¼•æ“ï¼Œæä¾›é«˜ä¿çœŸéŸ³è´¨ï¼Œè®©éŸ³ä¹æ›´çœŸå®ã€æ›´ç”ŸåŠ¨ã€‚
- **Nucleus**ï¼š Roon çš„ä¸“ç”¨æœåŠ¡å™¨ï¼Œæä¾›æ›´å¼ºå¤§çš„éŸ³ä¹å¤„ç†èƒ½åŠ›å’Œæ›´çµæ´»çš„é…ç½®é€‰é¡¹ã€‚

---

## M920x

M920x æ˜¯ x86 å¹³å°, ä½œä¸º Docker å®¹å™¨çš„æ ¸å¿ƒå®¿ä¸»æœº, å·²éƒ¨ç½²å¤šé¡¹æœåŠ¡.

### é›·æ±  Safeline

![20241229154732_QTQjeMVr.webp](https://cdn.dong4j.site/source/image/20241229154732_QTQjeMVr.webp)

åœ¨ [[homelab-network|ç½‘ç»œç¯‡]] ä¸­æœ‰ WAF çš„è¯¦ç»†ä»‹ç»ä»¥åŠåº”ç”¨åœºæ™¯.

### Dify

[Dify](https://github.com/langgenius/dify) æ˜¯ä¸€ä¸ªå¼€æºçš„ LLM åº”ç”¨å¼€å‘å¹³å°. Dify æä¾›ç›´è§‚çš„ç”¨æˆ·ç•Œé¢, ç»“åˆ AI å·¥ä½œæµã€RAG ç®¡é“ã€ä»£ç†èƒ½åŠ›ã€æ¨¡å‹ç®¡ç†ã€å¯è§‚å¯Ÿæ€§åŠŸèƒ½ç­‰, å¸®åŠ©ç”¨æˆ·å¿«é€Ÿä»åŸå‹å¼€å‘åˆ°ç”Ÿäº§éƒ¨ç½².

![20241229154732_2pK3lVHY.webp](https://cdn.dong4j.site/source/image/20241229154732_2pK3lVHY.webp)

**é‡è¦äº®ç‚¹**:

- **åŠŸèƒ½ä¸°å¯Œ**ï¼šæ”¯æŒ AI å·¥ä½œæµã€RAG ç®¡é“ã€ä»£ç†ã€æ¨¡å‹ç®¡ç†ã€å¯è§‚å¯Ÿæ€§ç­‰åŠŸèƒ½.
- **æ¨¡å‹æ”¯æŒ**é›†æˆ GPTã€Mistralã€Llama3 ç­‰å¤šç§ LLM æ¨¡å‹.
- **æ˜“äºä½¿ç”¨**ï¼šæä¾›äº‘ç«¯æœåŠ¡ã€ç¤¾åŒºç‰ˆå’Œä¼ä¸šç‰ˆ, æ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨.
- **å¼€æºå…è´¹**ï¼šéµå¾ª Dify å¼€æºè®¸å¯è¯, å…è´¹ä½¿ç”¨.

### Netmaker

[**Netmaker**](https://github.com/gravitl/netmaker) æ˜¯ä¸€ä¸ªå¼€æºçš„é«˜æ€§èƒ½ã€åŸºäº **WireGuard** çš„ **è™šæ‹Ÿç½‘ç»œç®¡ç†å¹³å°**. å®ƒå…è®¸ç”¨æˆ·è½»æ¾æ„å»ºå’Œç®¡ç†è·¨åœ°åŸŸçš„å®‰å…¨è™šæ‹Ÿç½‘ç»œï¼ˆVPNï¼‰, é€‚ç”¨äºäº‘ç¯å¢ƒã€æ•°æ®ä¸­å¿ƒã€ç‰©è”ç½‘ (IoT) è®¾å¤‡ç­‰åœºæ™¯. Netmaker é€šè¿‡è‡ªåŠ¨åŒ–ç½‘ç»œé…ç½®å’Œç®¡ç†, å¤§å¹…é™ä½äº†è¿ç»´æˆæœ¬, å¹¶æä¾›äº†ä¸ç°æœ‰åŸºç¡€è®¾æ–½æ— ç¼é›†æˆçš„èƒ½åŠ›.

![20241229154732_iQxUFXbA.webp](https://cdn.dong4j.site/source/image/20241229154732_iQxUFXbA.webp)

**ä¸»è¦åŠŸèƒ½**

1. **åŸºäº WireGuard çš„é«˜æ€§èƒ½ç½‘ç»œ**: æä¾›åŠ å¯†ã€é«˜é€Ÿçš„ç‚¹å¯¹ç‚¹é€šä¿¡, é€šè¿‡ WireGuard åè®®å®ç°ä½å»¶è¿Ÿå’Œé«˜å®‰å…¨æ€§.
2. **è‡ªåŠ¨åŒ–ç½‘ç»œé…ç½®**: è‡ªåŠ¨é…ç½®èŠ‚ç‚¹ã€å­ç½‘å’Œéš§é“, å¤§å¹…å‡å°‘æ‰‹åŠ¨è®¾ç½®å’Œç®¡ç†æ­¥éª¤.

3. **å¤šå¹³å°æ”¯æŒ**: æ”¯æŒ Linuxã€Windowsã€macOS, ä»¥åŠå®¹å™¨åŒ–ç¯å¢ƒï¼ˆDocker/Kubernetesï¼‰.

4. **é›†ä¸­ç®¡ç†ç•Œé¢**: æä¾› Web UI å’Œ API æ¥å£, ä¾¿äºé›†ä¸­ç®¡ç†ç½‘ç»œé…ç½®ã€ç›‘æ§å’Œè¿ç»´.

5. **åŠ¨æ€èŠ‚ç‚¹ç®¡ç†**: æ”¯æŒåŠ¨æ€ IP åˆ†é…ã€è´Ÿè½½å‡è¡¡, ä»¥åŠèŠ‚ç‚¹çš„è‡ªåŠ¨å‘ç°å’Œè¿æ¥.

6. **å¤šäº‘å’Œæ··åˆç¯å¢ƒæ”¯æŒ**: å…¼å®¹å¤šç§äº‘å¹³å°ï¼ˆå¦‚ AWSã€Azureã€GCPï¼‰å’Œæœ¬åœ°æ•°æ®ä¸­å¿ƒ, é€‚ç”¨äºæ··åˆäº‘ç¯å¢ƒ.

7. **é«˜å¯æ‰©å±•æ€§**: é€šè¿‡æ°´å¹³æ‰©å±•æ”¯æŒå¤§è§„æ¨¡èŠ‚ç‚¹å’Œå¤æ‚æ‹“æ‰‘, é€‚ç”¨äºä¼ä¸šçº§ç½‘ç»œéœ€æ±‚.

8. **ACL å’Œå®‰å…¨è§„åˆ™ç®¡ç†**: æ”¯æŒè®¿é—®æ§åˆ¶åˆ—è¡¨ (ACL) å’Œè‡ªå®šä¹‰é˜²ç«å¢™è§„åˆ™, ç¡®ä¿ç½‘ç»œå®‰å…¨.

### Coolify

[Coolify](https://coolify.io/) æ˜¯ä¸€æ¬¾å¼€æºä¸”å¯è‡ªæ‰˜ç®¡çš„å¹³å°, æ—¨åœ¨ä¸ºå¼€å‘è€…æä¾›ç±»ä¼¼ Herokuã€Netlify å’Œ Vercel çš„æœåŠ¡. Coolify æ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶, å…è®¸ç”¨æˆ·å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°ä»»ä½•æœåŠ¡å™¨, åŒ…æ‹¬ä¸ªäººæœåŠ¡å™¨ã€VPSã€Raspberry Piã€äº‘æœåŠ¡å™¨ç­‰. è¯¥å¹³å°æä¾›äº†ä¸°å¯Œçš„åŠŸèƒ½, å¦‚æ¨é€éƒ¨ç½²ã€å…è´¹ SSL è¯ä¹¦ã€è‡ªåŠ¨æ•°æ®åº“å¤‡ä»½ Webhook é›†æˆã€å¼ºå¤§çš„ API å’Œå®æ—¶ç»ˆç«¯ç­‰, æ—¨åœ¨æä¾›é«˜æ•ˆã€çµæ´»çš„å¼€å‘ç¯å¢ƒ.

![20241229154732_sRYeCMVK.webp](https://cdn.dong4j.site/source/image/20241229154732_sRYeCMVK.webp)

**é‡è¦äº®ç‚¹**:

- **å…¼å®¹æ€§**ï¼šCoolify å…¼å®¹å¤šç§ç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶, æ”¯æŒé™æ€ç½‘ç«™ã€APIã€åç«¯ã€æ•°æ®åº“ã€ç­‰å¤šç§ç±»å‹çš„åº”ç”¨ç¨‹åº.
- **éƒ¨ç½²çµæ´»æ€§**ï¼šæ”¯æŒéƒ¨ç½²åˆ°ä»»ä½•æœåŠ¡å™¨, åŒ…æ‹¬ä¸ªäººæœåŠ¡å™¨ã€VPSã€Raspberry Piã€äº‘æœåŠ¡å™¨ç­‰, å¹¶æ”¯æŒ Docker å’Œ Docker Swarm.
- **æœåŠ¡å¤šæ ·æ€§**ï¼šå¯ä»¥éƒ¨ç½²ä»»ä½•ä¸ Docker å…¼å®¹çš„æœåŠ¡, å¹¶æä¾›è®¸å¤šä¸€é”®å¼æœåŠ¡.
- **é›†æˆä¸è‡ªåŠ¨åŒ–**ï¼šæä¾›ä¸ GitHubã€GitLabã€Bitbucketã€Gitea ç­‰å¹³å°çš„é›†æˆ, æ”¯æŒæ¨é€éƒ¨ç½²å’Œè‡ªåŠ¨æ•°æ®åº“å¤‡ä»½.
- **å®‰å…¨æ€§**ï¼šæä¾› SSL è¯ä¹¦, ç¡®ä¿æ•°æ®ä¼ è¾“å®‰å…¨, å¹¶å…è®¸ç”¨æˆ·å®Œå…¨æ§åˆ¶è‡ªå·±çš„æ•°æ®.
- **æ§åˆ¶æ€§**ï¼šæä¾›å¼ºå¤§çš„ API å’Œå®æ—¶ç»ˆç«¯, å…è®¸ç”¨æˆ·ç›´æ¥åœ¨æµè§ˆå™¨ä¸­ç®¡ç†æœåŠ¡å™¨, å¹¶ä¸ CI/CD ç®¡é“é›†æˆ.
- **ç¤¾åŒºå’ŒèµåŠ©**ï¼šCoolify æ‹¥æœ‰ä¸€ä¸ªæ´»è·ƒçš„ç¤¾åŒº, å¹¶æä¾›èµåŠ©å•†æ”¯æŒ.

![20241229154732_XXA3r2Un.webp](https://cdn.dong4j.site/source/image/20241229154732_XXA3r2Un.webp)

> ç›®å‰åªå®‰è£…éƒ¨ç½²äº†, è¿˜æ²¡å®Œå…¨ç”¨èµ·æ¥

---

### n8n

[n8n](https://github.com/n8n-io/n8n) æ˜¯ä¸€æ¬¾å¼€æºçš„æµç¨‹è‡ªåŠ¨åŒ–å·¥å…·, å…è®¸ç”¨æˆ·é€šè¿‡è¿æ¥å„ç§æœåŠ¡å’Œåº”ç”¨ç¨‹åºæ¥æ„å»ºè‡ªåŠ¨åŒ–æµç¨‹. å®ƒé‡‡ç”¨åŸºäºèŠ‚ç‚¹çš„ç¼–ç¨‹æ–¹å¼, æ˜“äºä½¿ç”¨ä¸”åŠŸèƒ½å¼ºå¤§.

![20241229154732_5h6yU0pd.webp](https://cdn.dong4j.site/source/image/20241229154732_5h6yU0pd.webp)

**ä¸»è¦ç‰¹ç‚¹**ï¼š

- **æ˜“äºä½¿ç”¨**ï¼š n8n é‡‡ç”¨æ‹–æ”¾å¼çš„èŠ‚ç‚¹ç¼–è¾‘å™¨, ç”¨æˆ·å¯ä»¥è½»æ¾åœ°å°†èŠ‚ç‚¹è¿æ¥èµ·æ¥, åˆ›å»ºå¤æ‚çš„è‡ªåŠ¨åŒ–æµç¨‹.
- **å¯æ‰©å±•æ€§**ï¼š n8n æ”¯æŒç”¨æˆ·æ·»åŠ è‡ªå®šä¹‰èŠ‚ç‚¹, ä»¥æ‰©å±•å…¶åŠŸèƒ½.
- **ä¸°å¯Œçš„**ï¼š n8n æä¾›äº† 200 å¤šä¸ªé›†æˆèŠ‚ç‚¹, åŒ…æ‹¬å¸¸ç”¨çš„ç¤¾äº¤åª’ä½“ã€é‚®ä»¶ã€æ•°æ®åº“ã€äº‘æœåŠ¡ç­‰.
- **å¼€æº**ï¼š n8n æ˜¯å¼€æºè½¯ä»¶, ç”¨æˆ·å¯ä»¥è‡ªç”±åœ°ä½¿ç”¨ã€ä¿®æ”¹å’Œåˆ†å‘å®ƒ.

**é€‚ç”¨åœºæ™¯**ï¼š

- **è‡ªåŠ¨åŒ–æ—¥å¸¸ä»»åŠ¡**ï¼š ä¾‹å¦‚, è‡ªåŠ¨åŒ–é‚®ä»¶å‘é€ã€æ•°æ®åŒæ­¥ã€æ–‡ä»¶å¤„ç†ç­‰.
- **æ„å»ºå¤æ‚çš„ä¸šåŠ¡æµç¨‹**ï¼š ä¾‹å¦‚, è‡ªåŠ¨åŒ–å®¢æˆ·å…³ç³»ç®¡ç†ã€ä¾›åº”é“¾ç®¡ç†ã€æ•°æ®åˆ†æç­‰.

ç›¸å…³èµ„æº:

- [n8n çš„è‡ªæ‰˜ç®¡ AI å…¥é—¨å¥—ä»¶](#AI-starter-kit)

- [åœ¨æœ¬åœ°è¿è¡Œ LLMï¼š5 ç§æœ€ä½³æ–¹æ³•ï¼ˆ+ è‡ªæ‰˜ç®¡ AI å…¥é—¨å¥—ä»¶ï¼‰](https://blog.n8n.io/local-llm/)
- [åœ¨ç¾¤æ™–éƒ¨ç½² n8n çš„ä¸€äº›å‘å’Œç»éªŒ](https://1q43.blog/post/5821/)

<!--

### Cockpit

[Cockpit](https://cockpit-project.org/)

---

-->

### Smokeping

[SmokePing](https://github.com/oetiker/SmokePing) æ˜¯ä¸€ä¸ªå¼€æºçš„ç½‘ç»œå»¶è¿Ÿç›‘æ§ç³»ç»Ÿ, å®ƒé€šè¿‡å®šæœŸæµ‹é‡ç›®æ ‡ä¸»æœºçš„å“åº”æ—¶é—´å¹¶ç”Ÿæˆå›¾å½¢åŒ–çš„ç»“æœ, å¸®åŠ©ç”¨æˆ·å®æ—¶ç›‘æ§ç½‘ç»œæ€§èƒ½. å®ƒåŸºäº RRDtool åº“è¿›è¡Œæ•°æ®å­˜å‚¨å’Œå›¾å½¢å±•ç¤º, æ”¯æŒå¤šç§æ’ä»¶å’Œå®šåˆ¶åŒ–é…ç½®, é€‚ç”¨äºå„ç§ç½‘ç»œç¯å¢ƒå’Œéœ€æ±‚.

![20241229154732_zsOwYKR6.webp](https://cdn.dong4j.site/source/image/20241229154732_zsOwYKR6.webp)

**é‡ç‚¹åŠŸèƒ½ï¼š**

1. **ç½‘ç»œå»¶è¿Ÿç›‘æ§**ï¼šå®šæœŸæµ‹é‡ç›®æ ‡ä¸»æœºçš„å“åº”æ—¶é—´, å¹¶ç”Ÿæˆç›´è§‚çš„å›¾å½¢åŒ–ç»“æœ.
2. **åŠ¨æ€ IP æ”¯æŒ**èƒ½å¤Ÿå¤„ç†åŠ¨æ€ IP åœ°å€, ç¡®ä¿ç›‘æ§çš„è¿ç»­æ€§å’Œå‡†ç¡®æ€§.
3. **æ’ä»¶æ‰©å±•**ï¼šæ”¯æŒå¤šç§æ’ä»¶, æ‰©å±•åŠŸèƒ½, ä¾‹å¦‚æ•°æ®æºé›†æˆã€é€šçŸ¥ç³»ç»Ÿç­‰.
4. **Web æ¨¡æ¿å®šåˆ¶**ï¼šæä¾›ä¸°å¯Œçš„ Web æ¨¡æ¿é€‰é¡¹, æ–¹ä¾¿ç”¨æˆ·è‡ªå®šä¹‰å›¾å½¢ç•Œé¢.
5. **é…ç½®æ–‡ä»¶ç®¡ç†**ï¼šæä¾›è¯¦ç»†çš„é…ç½®æ–‡ä»¶, æ–¹ä¾¿ç”¨æˆ·æ ¹æ®å®é™…éœ€æ±‚è¿›è¡Œå®šåˆ¶.
6. **è·¨å¹³å°æ”¯æŒ**ï¼šé€‚ç”¨äºå„ç§ Unix ç³»ç»Ÿ, åŒ…æ‹¬ Linuxã€MacOS å’Œ.
7. **æ˜“äºé›†æˆ**ï¼šä¸å…¶ä»–ç½‘ç»œç›‘æ§å·¥å…·å’Œç³»ç»Ÿæ— ç¼é›†æˆ.

---

### IT Tools

[IT Tools](https://github.com/CorentinTh/it-tools) æ˜¯ä¸€ä¸ªé›†åˆäº†å¤šç§å¼€å‘è€…å¸¸ç”¨åœ¨çº¿å·¥å…·çš„å¹³å°, æ‹¥æœ‰ç®€æ´çš„ç•Œé¢å’Œè‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ. å®ƒæ—¨åœ¨å¸®åŠ©å¼€å‘è€…æé«˜å·¥ä½œæ•ˆç‡, è½»æ¾å¤„ç†å„ç§å¼€å‘ä»»åŠ¡.

![20241229154732_Y1Y3jCOi.webp](https://cdn.dong4j.site/source/image/20241229154732_Y1Y3jCOi.webp)

**é‡ç‚¹åŠŸèƒ½**:

- **åœ¨çº¿å·¥å…·**ï¼š æä¾›å¤šç§åœ¨çº¿å·¥å…·, ä¾‹å¦‚ä»£ç æ ¼å¼åŒ–ã€ä»£ç å‹ç¼©ã€åœ¨çº¿ API æµ‹è¯•ç­‰, è¦†ç›–å¼€å‘ã€æµ‹è¯•ã€æ–‡æ¡£ç­‰å¤šä¸ªæ–¹é¢.
- **å·¥å…·åˆ†ç±»**ï¼š å·¥å…·æŒ‰ç…§åŠŸèƒ½åˆ†ç±», æ–¹ä¾¿ç”¨æˆ·å¿«é€Ÿæ‰¾åˆ°æ‰€éœ€å·¥å…· **è‡ªå®šä¹‰å·¥å…·**ï¼š ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰æ·»åŠ å·¥å…·, æ»¡è¶³ä¸ªæ€§åŒ–éœ€æ±‚.
- **é›†æˆ**ï¼š éƒ¨åˆ†å·¥å…·æ”¯æŒä¸å…¶ä»–å¹³å°é›†æˆ, ä¾‹å¦‚ GitHubã€GitLab ç­‰.
- **ä»£ç ç¤ºä¾‹**ï¼š æ¯ä¸ªå·¥å…·éƒ½æä¾›ä»£ç ç¤ºä¾‹, å¸®åŠ©ç”¨æˆ·å¿«é€Ÿä¸Šæ‰‹.

### Uptime Kuma

[Uptime Kuma](https://github.com/louislam/uptime-kuma) æ˜¯ä¸€æ¬¾æ˜“äºä½¿ç”¨çš„è‡ªæ‰˜ç®¡ç›‘æ§å·¥å…·, å¯ä»¥ç›‘æ§å„ç§æœåŠ¡çš„å¯ç”¨æ€§, ä¾‹å¦‚ HTTP(s)ã€TCPã€Pingã€DNS è®°å½•ã€æ¸¸æˆæœåŠ¡å™¨ç­‰. å®ƒå…·æœ‰å‹å¥½çš„ç•Œé¢ã€ä¸°å¯Œçš„é€šçŸ¥é€‰é¡¹å’Œå¤šç§éƒ¨ç½²æ–¹å¼, éå¸¸é€‚åˆä¸ªäººå’Œä¼ä¸šä½¿ç”¨.

![20241229154732_kNhdmHz5.webp](https://cdn.dong4j.site/source/image/20241229154732_kNhdmHz5.webp)

**é‡ç‚¹åŠŸèƒ½**:

- **å¤šç§ç›‘æ§ç±»å‹**ï¼šæ”¯æŒ HTTP(s)ã€TCPã€Pingã€DNS è®°å½•ã€æ¸¸æˆæœåŠ¡å™¨ã€Docker å®¹å™¨ç­‰å¤šç§ç›‘æ§ç±»å‹.
- **ä¸°å¯Œçš„é€šçŸ¥é€‰é¡¹**ï¼šæ”¯æŒ Telegramã€Discordã€Gotifyã€Slackã€Pushoverã€SMTP é‚®ä»¶ç­‰å¤šç§é€šçŸ¥æ–¹å¼, å¹¶æ”¯æŒè‡ªå®šä¹‰é€šçŸ¥æ¨¡æ¿.
- **å‹å¥½çš„ç•Œé¢**ï¼šæä¾›å“åº”å¼ã€å¿«é€Ÿçš„ç”¨æˆ·ç•Œé¢, æ–¹ä¾¿ç”¨æˆ·æŸ¥çœ‹å’Œç®¡ç†ç›‘æ§æ•°æ®.
- **å¤šè¯­è¨€æ”¯æŒ**ï¼šæ”¯æŒå¤šç§è¯­è¨€, æ–¹ä¾¿å…¨çƒç”¨æˆ·ä½¿ç”¨.
- **å¤šç§éƒ¨ç½²æ–¹å¼**ï¼šæ”¯æŒ Dockerã€Node.js ç­‰å¤šç§éƒ¨ç½²æ–¹å¼, æ–¹ä¾¿ç”¨æˆ·æ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„éƒ¨ç½²æ–¹å¼.
- **çŠ¶æ€é¡µé¢**å¯ä»¥åˆ›å»ºå¤šä¸ªçŠ¶æ€é¡µé¢, å¹¶å°†çŠ¶æ€é¡µé¢æ˜ å°„åˆ°ç‰¹å®šçš„åŸŸå.
- **Ping å›¾è¡¨**ï¼šå¯ä»¥æŸ¥çœ‹å†å²ç›‘æ§æ•°æ®, å¹¶ç”Ÿæˆ Ping å›¾è¡¨.
- **è¯ä¹¦ä¿¡æ¯**ï¼šå¯ä»¥æŸ¥çœ‹ç›‘æ§æœåŠ¡çš„ SSL/TLS è¯ä¹¦ä¿¡æ¯.
- **ä»£ç†æ”¯æŒ**ï¼šæ”¯æŒä»£ç†è®¾ç½®, æ–¹ä¾¿ç”¨æˆ·é€šè¿‡ä»£ç†è¿›è¡Œç›‘æ§.
- **åŒå› ç´ è®¤è¯**ï¼šæ”¯æŒåŒå› ç´ è®¤è¯, æé«˜è´¦æˆ·å®‰å…¨æ€§.

> ç›®å‰ä¸»è¦çš„ç›‘æ§å·¥å…·, ä½¿ç”¨ [Bark](https://bark.day.app) è¿›è¡Œæ¶ˆæ¯é€šçŸ¥.

<!--

M920x æ˜¯åœ¨ `/mnt/4.860.ssd/Drive/docker/docker-compose` ç›®å½•ä¸‹è¿è¡Œçš„ uptime-kuma, æ•°æ®ç›®å½•åœ¨ `/mnt/4.860.ssd/Drive/docker/docker-data` ä¸­.

-->

### Homepage

<!--

http://192.168.31.7:2000/

https://gethomepage.dev/
https://www.himiku.com/archives/homepage.html

-->

[Homepage](https://github.com/gethomepage/homepage) æ˜¯ä¸€ä¸ªé«˜åº¦å¯å®šåˆ¶çš„ä¸ªäººä¸»é¡µé¡¹ç›®, æ”¯æŒ Docker å’ŒæœåŠ¡ API é›†æˆ. é¡¹ç›®æä¾›å¿«é€Ÿæœç´¢ã€ä¹¦ç­¾ã€å¤©æ°”æ”¯æŒç­‰åŠŸèƒ½, å¹¶é›†æˆäº†è¶…è¿‡ 100 ä¸ªæœåŠ¡å’Œç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åº.

![20241229154732_2gDay2gg.webp](https://cdn.dong4j.site/source/image/20241229154732_2gDay2gg.webp)

**é‡è¦äº®ç‚¹**:

- **é«˜åº¦å¯å®šåˆ¶**ï¼šæ”¯æŒè‡ªå®šä¹‰ä¸»é¢˜ã€CSSã€JSã€å¸ƒå±€å’Œæœ¬åœ°åŒ–.
- **å¿«é€Ÿ**ï¼šé™æ€ç”Ÿæˆ, åŠ è½½é€Ÿåº¦å¿«.
- **å®‰å…¨**ï¼š API è¯·æ±‚éƒ½é€šè¿‡ä»£ç†, ä¿æŠ¤ API å¯†é’¥å®‰å…¨.
- **æœåŠ¡é›†æˆ**ï¼šé›†æˆè¶…è¿‡ 100 ä¸ªæœåŠ¡å’Œåº”ç”¨ç¨‹åº, ä¾‹å¦‚ Radarrã€Sonarr ç­‰.
- **ä¿¡æ¯å°éƒ¨ä»¶**ï¼šæä¾›å¤©æ°”ã€æ—¶é—´ã€æœç´¢ç­‰ä¿¡æ¯å°éƒ¨ä»¶.
- **Docker é›†æˆ**ï¼šæ”¯æŒ Docker é›†æˆå’Œè‡ªåŠ¨æœåŠ¡å‘ç°.

ç›¸å…³èµ„æº:

- [Dashboard Icons](https://github.com/walkxcode/dashboard-icons)

### Nezha Monitoring

<!--

http://192.168.31.7:8008/

-->

[Nezha Monitoring](https://github.com/nezhahq/nezha) æ˜¯ä¸€æ¬¾å¼€æºçš„ã€è½»é‡çº§çš„ç›‘æ§å·¥å…·, æ—¨åœ¨å¸®åŠ©ç”¨æˆ·è½»æ¾ç›‘æ§æœåŠ¡å™¨å’Œç½‘ç«™çŠ¶æ€. å®ƒæ”¯æŒå¤šç§ç›‘æ§æŒ‡æ ‡, åŒ…æ‹¬ç³»ç»ŸçŠ¶æ€ã€HTTPã€TCPã€Ping ç­‰, å¹¶æä¾›æ¨é€è­¦æŠ¥ã€å®šæ—¶ä»»åŠ¡å’Œ Web ç»ˆç«¯ç­‰å®ç”¨åŠŸèƒ½. è¯¥å·¥å…·é‡‡ç”¨ Go è¯­è¨€å¼€å‘, å¹¶æä¾›ä¸­æ–‡å’Œè‹±æ–‡æ–‡æ¡£, æ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨.

![20241229154732_02qgJDlI.webp](https://cdn.dong4j.site/source/image/20241229154732_02qgJDlI.webp)

**ä¸»è¦åŠŸèƒ½ï¼š**

- **æœåŠ¡å™¨ç›‘æ§**ï¼š ç›‘æ§æœåŠ¡å™¨èµ„æºä½¿ç”¨æƒ…å†µ, åŒ…æ‹¬ CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œç­‰.
- **æœåŠ¡ç›‘æ§**ï¼š ç›‘æ§æœåŠ¡å™¨ä¸Šçš„æœåŠ¡çŠ¶æ€, ä¾‹å¦‚ Web æœåŠ¡ã€æ•°æ®åº“æœåŠ¡ç­‰.
- **ä»»åŠ¡ç®¡ç†**ï¼š åˆ›å»ºå’Œç®¡ç†è‡ªåŠ¨åŒ–ä»»åŠ¡, ä¾‹å¦‚å®šæ—¶ä»»åŠ¡ã€è„šæœ¬æ‰§è¡Œç­‰.
- **é€šçŸ¥ç®¡ç†**ï¼š è®¾ç½®æ¥æ”¶æœåŠ¡å™¨çŠ¶æ€å¼‚å¸¸é€šçŸ¥, ä¾‹å¦‚é‚®ä»¶ã€çŸ­ä¿¡ç­‰.
- **DDNS**ï¼š è‡ªåŠ¨æ›´æ–° DNS è®°å½•, æ–¹ä¾¿æœåŠ¡å™¨.
- **å†…ç½‘ç©¿é€**ï¼š å°†å†…ç½‘æœåŠ¡å™¨æ˜ å°„åˆ°å…¬ç½‘, æ–¹ä¾¿è¿œç¨‹è®¿é—®.
- **è®¾ç½®**ï¼š é…ç½®ç›‘æ§é¡¹ã€æ•°æ®å±•ç¤ºç­‰.
- **åˆ†ç»„**ï¼š å°†æœåŠ¡å™¨åˆ†ç»„ç®¡ç†.

### APITable

[APITable](https://github.com/apitable/apitable) æ˜¯ä¸€ä¸ªé¢å‘ API çš„ä½ä»£ç å¹³å°, ç”¨äºæ„å»ºåä½œåº”ç”¨ç¨‹åº. å®ƒæä¾›äº†ä¸°å¯Œçš„åŠŸèƒ½, å¯ä»¥å¸®åŠ©ç”¨æˆ·è½»æ¾åˆ›å»ºå’Œç®¡ç†å„ç§åº”ç”¨ç¨‹åº, ä¾‹å¦‚é¡¹ç›®ç®¡ç†ã€å®¢æˆ·å…³ç³»ç®¡ç†ã€ä¸šåŠ¡æ™ºèƒ½ç­‰.

![20241229154732_7Ezss4Vw.webp](https://cdn.dong4j.site/source/image/20241229154732_7Ezss4Vw.webp)

**é‡ç‚¹äº®ç‚¹**:

- **å®æ—¶åä½œ**ï¼š æ”¯æŒå¤šäººå®æ—¶åä½œç¼–è¾‘, æé«˜å›¢é˜Ÿæ•ˆç‡.
- **è‡ªåŠ¨è¡¨å•**ï¼š è‡ªåŠ¨ç”Ÿæˆè¡¨å•, æ— éœ€æ‰‹åŠ¨ç¼–å†™ä»£ç .
- **API é¦–é¢æ¿**ï¼š æä¾›ç›´è§‚çš„ API é¢æ¿, ç”¨æˆ·ä½¿ç”¨ API.
- **æ— é™è·¨è¡¨é“¾æ¥**ï¼š æ”¯æŒæ— é™è·¨è¡¨é“¾æ¥, å®ç°æ•°æ®å…³è”.
- **å¼ºå¤§çš„è¡Œ/åˆ—æƒé™**ï¼š æ”¯æŒè¡Œ/åˆ—æƒé™æ§åˆ¶, ä¿éšœæ•°æ®å®‰å…¨.
- **åµŒå…¥å¼**ï¼š æ”¯æŒåµŒå…¥å¼, æ–¹ä¾¿ç”¨æˆ·å°† APITable åº”ç”¨ç¨‹åºé›†æˆåˆ°å…¶ä»–åº”ç”¨ç¨‹åºä¸­.
- **ä¸°å¯Œçš„æ•°æ®åº“-ç”µå­è¡¨æ ¼ UI**ï¼š æä¾›å¤šç§è§†å›¾ç±»å‹, ä¾‹å¦‚ç½‘æ ¼è§†å›¾ã€ç”»å»Šè§†å›¾ã€ç”˜ç‰¹å›¾è§†å›¾ç­‰.
- **ä¸°å¯Œçš„**ï¼š æä¾›å¤šç§å®˜æ–¹æ¨¡æ¿, æ–¹ä¾¿ç”¨æˆ·å¿«é€Ÿåˆ›å»ºåº”ç”¨ç¨‹åº.
- **æœºå™¨äººè‡ªåŠ¨åŒ–**ï¼š æ”¯æŒæœºå™¨äººè‡ªåŠ¨åŒ–, æé«˜å·¥ä½œæ•ˆç‡.
- **BI ä»ªè¡¨æ¿**ï¼š æä¾› BI ä»ªè¡¨æ¿, æ–¹ä¾¿ç”¨æˆ·è¿›è¡Œæ•°æ®åˆ†æå’Œå¯è§†åŒ–.
- **å¯æ‰©å±•æ€§**ï¼š æ”¯æŒè‡ªå®šä¹‰ç»„ä»¶ã€å›¾è¡¨ã€ä»ªè¡¨æ¿ç­‰, æ»¡è¶³ç”¨æˆ·ä¸ªæ€§åŒ–éœ€æ±‚.

---

### CasaOS

[CasaOS](https://casaos.io/) æ˜¯ä¸€æ¬¾åŸºäº Docker çš„å¼€æºä¸ªäººäº‘æ“ä½œç³»ç»Ÿ, æ—¨åœ¨æä¾›ç®€å•æ˜“ç”¨çš„ä¸ªäººäº‘ä½“éªŒ. å®ƒæ”¯æŒä¸°å¯Œçš„åº”ç”¨ç¨‹åº, å¹¶æ‹¥æœ‰å‹å¥½çš„ç”¨æˆ·ç•Œé¢, é€‚åˆç”¨äºæ­å»ºåª’ä½“ä¸­å¿ƒã€ç§æœ‰äº‘ã€æ™ºèƒ½å®¶å±…ç­‰åœºæ™¯.

![20241229154732_JQAtbuPc.webp](https://cdn.dong4j.site/source/image/20241229154732_JQAtbuPc.webp)

**é‡ç‚¹äº®ç‚¹**ï¼š

- **ç®€å•æ˜“ç”¨**ï¼šç”¨æˆ·ç•Œé¢ç®€æ´ç›´è§‚, æ˜“äºä¸Šæ‰‹.
- **åº”ç”¨ç¨‹åºä¸°å¯Œ**ï¼šæ”¯æŒè¶…è¿‡ 20 ä¸ªé¢„å®‰è£…åº”ç”¨ç¨‹åºå’Œ 50+ ä¸ªç¤¾åŒºéªŒè¯åº”ç”¨ç¨‹åº.
- **å…¼å®¹æ€§å¼º**ï¼šæ”¯æŒ 86 å’Œ Raspberry Pi è®¾å¤‡.
- **åŸºäº Docker**ï¼šæ˜“äºæ‰©å±•å’Œå®šåˆ¶.

---

### Open WebUI

[Open WebUI ](https://github.com/open-webui/open-webui) ä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œã€æ˜“äºä½¿ç”¨çš„è‡ªæ‰˜ç®¡ WebUI, æ—¨åœ¨å®Œå…¨ç¦»çº¿è¿è¡Œ. å®ƒæ”¯æŒå„ç§ LLM è¿è¡Œå™¨, åŒ…æ‹¬ Ollama å’Œå…¼å®¹ OpenAI çš„ API.

![20241229154732_8PC1JmDq.webp](https://cdn.dong4j.site/source/image/20241229154732_8PC1JmDq.webp)

**é‡ç‚¹äº®ç‚¹**:

- **æ˜“äºè®¾ç½®**ï¼šä½¿ç”¨ Docker æˆ– Kubernetes (kubectl, kustomize æˆ– helm) è½»æ¾å®‰è£…, æ”¯æŒå¸¦ :ollama å’Œ :cuda æ ‡ç­¾çš„é•œåƒ.
- **Ollama/OpenAI API é›†æˆ**ï¼šæ— ç¼é›†æˆ OpenAI å…¼å®¹çš„ API, å¹¶æ”¯æŒ Ollama æ¨¡å‹.
- **ç»†ç²’åº¦æƒé™å’Œç”¨æˆ·ç»„**ï¼šç®¡ç†å‘˜å¯ä»¥åˆ›å»ºè¯¦ç»†çš„è§’è‰²å’Œæƒé™, ç¡®ä¿å®‰å…¨çš„ç¯å¢ƒå¹¶å®šåˆ¶ç”¨æˆ·ä½“éªŒ.
- **å…æè¯­éŸ³/è§†é¢‘é€šè¯**ï¼šé›†æˆå…æè¯­éŸ³å’Œè§†é¢‘é€šè¯åŠŸèƒ½, æä¾›æ›´åŠ¨æ€çš„èŠå¤©ç¯å¢ƒ.
- **æ¨¡å‹æ„å»ºå™¨**ï¼šé€šè¿‡ Web UI è½»æ¾åˆ›å»º Ollama æ¨¡å‹, å¹¶æ”¯æŒå¯¼å…¥æ¥è‡ª Open WebUI ç¤¾åŒºçš„æ¨¡å‹.
- **æœ¬åœ° Python å‡½æ•°è°ƒç”¨å·¥å…·**ï¼šæ”¯æŒåœ¨å·¥å…·å·¥ä½œåŒºä¸­æ·»åŠ çº¯ Python å‡½æ•°, å¹¶å®ç° LLM ä¸è‡ªå®šä¹‰å‡½æ•°çš„æ— ç¼é›†æˆ.
- **RAG é›†æˆ**ï¼šæ”¯æŒæ£€ç´¢å¢å¼ºç”Ÿæˆ (RAG), å°†æ–‡æ¡£äº¤äº’æ— ç¼é›†æˆåˆ°èŠå¤©ä½“éªŒä¸­.
- **Web æœç´¢åŠŸèƒ½**ï¼šæ”¯æŒä½¿ç”¨ SearXNGã€Google PSEã€Brave Searchã€serpstackã€serperã€Serplyã€DuckDuckGoã€TavilySearchã€SearchApi å’Œ Bing ç­‰æä¾›å•†è¿›è¡Œ Web æœç´¢, å¹¶å°†ç»“æœç›´æ¥æ³¨å…¥åˆ°èŠå¤©ä½“éªŒä¸­.
- **å›¾åƒç”Ÿæˆé›†æˆ**ï¼šæ”¯æŒä½¿ç”¨ AUTOMATIC1111 APIã€ComfyUI (æœ¬åœ°) å’Œ OpenAI çš„ DALL-E (å¤–éƒ¨) è¿›è¡Œå›¾åƒç”Ÿæˆ.
- **å¤šæ¨¡å‹å¯¹è¯**ï¼šå¯ä»¥è½»æ¾ä¸å„ç§æ¨¡å‹åŒæ—¶è¿›è¡Œå¯¹è¯, åˆ©ç”¨å®ƒä»¬çš„ç‹¬ç‰¹ä¼˜åŠ¿.
- **ç®¡é“å’Œ Open WebUI æ’ä»¶æ”¯æŒ**ï¼šæ”¯æŒå°†è‡ªå®šä¹‰é€»è¾‘å’Œ Python åº“é›†æˆåˆ° Open WebUI ä¸­.

---

### LobeChat

[LobeChat](https://github.com/lobehub/lobe-chat) æ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„å¼€æº AI èŠå¤©æ¡†æ¶, è‡´åŠ›äºæ‰“é€ ç°ä»£ã€é«˜æ•ˆçš„æ™ºèƒ½å¯¹è¯ä½“éªŒ. å®ƒæ”¯æŒå¤šç§ AI æœåŠ¡æä¾›å•†, æ¶µç›–æ–‡æœ¬ã€å›¾åƒã€è¯­éŸ³ç­‰å¤šæ¨¡æ€äº¤äº’, å¹¶æä¾›çŸ¥è¯†åº“ã€æ’ä»¶ç³»ç»Ÿã€å¤šç”¨æˆ·ç®¡ç†ç­‰ä¸°å¯ŒåŠŸèƒ½, è®©ç”¨æˆ·è½»æ¾æ„å»ºä¸ªæ€§åŒ–ã€å¯æ‰©å±•çš„èŠå¤©æœºå™¨äºº. Lobe Chat æ—¨åœ¨ä¸ºå¼€å‘è€…æä¾›ä¾¿æ·ã€é«˜æ•ˆçš„å·¥å…·, æ¨åŠ¨ AI èŠå¤©æŠ€æœ¯çš„å‘å±•.

![20241229154732_ff8ygTBy.webp](https://cdn.dong4j.site/source/image/20241229154732_ff8ygTBy.webp)

**é‡ç‚¹äº®ç‚¹**:

- **å¤šæ¨¡æ€æ”¯æŒ**ï¼š æ”¯æŒæ–‡æœ¬ã€å›¾åƒã€è¯­éŸ³ç­‰å¤šç§æ¨¡æ€, æä¾›æ›´ä¸°å¯Œçš„äº¤äº’ä½“éªŒ.
- **çŸ¥è¯†åº“**ï¼š æ”¯æŒæ–‡ä»¶ä¸Šä¼ ã€çŸ¥è¯†ç®¡ç†å’Œæ£€ç´¢, æ–¹ä¾¿ç”¨æˆ·ç®¡ç†ä¿¡æ¯.
- **æ’ä»¶ç³»ç»Ÿ**ï¼š æ”¯æŒè‡ªå®šä¹‰æ’ä»¶, æ‰©å±•, ä¾‹å¦‚æœç´¢ã€å›¾åƒç”Ÿæˆç­‰.
- **å¤šç”¨æˆ·ç®¡ç†**ï¼š æ”¯æŒå¤šç”¨æˆ·ç™»å½•å’Œæƒé™ç®¡ç†, é€‚åˆå›¢é˜Ÿåä½œ.
- **PWA æ”¯æŒ**ï¼š æ”¯æŒæ¸è¿›å¼ç½‘é¡µåº”ç”¨, æä¾›ç±»ä¼¼åŸç”Ÿåº”ç”¨çš„æµç•…ä½“éªŒ.
- **è‡ªå®šä¹‰ä¸»é¢˜**ï¼š æ”¯æŒè‡ªå®šä¹‰ä¸»é¢˜, æ»¡è¶³ä¸ªæ€§åŒ–éœ€æ±‚.

---

### MaxKB

[MaxKB](https://github.com/1Panel-dev/MaxKB) æ˜¯ä¸€æ¬¾åŸºäºå¤§è¯­è¨€æ¨¡å‹å’Œ RAG çš„å¼€æºçŸ¥è¯†åº“é—®ç­”ç³»ç»Ÿ, å¹¿æ³›åº”ç”¨äºæ™ºèƒ½å®¢æœã€ä¼ä¸šå†…éƒ¨çŸ¥è¯†åº“ã€å­¦æœ¯ç ”ç©¶ä¸æ•™è‚²ç­‰åœºæ™¯.

![20241229154732_hOhYdKMO.webp](https://cdn.dong4j.site/source/image/20241229154732_hOhYdKMO.webp)

**é‡ç‚¹äº®ç‚¹**:

- **å¼€ç®±å³ç”¨**ï¼šæ”¯æŒç›´æ¥ä¸Šä¼ æ–‡æ¡£/è‡ªåŠ¨çˆ¬å–åœ¨çº¿æ–‡æ¡£, æ”¯æŒæ–‡æœ¬è‡ªåŠ¨æ‹†åˆ†ã€å‘é‡åŒ–å’Œ RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰, æœ‰æ•ˆå‡å°‘å¤§æ¨¡å‹å¹»è§‰, æ™ºèƒ½é—®ç­”äº¤äº’ä½“éªŒå¥½.
- **æ¨¡å‹ä¸­ç«‹**ï¼šæ”¯æŒå¯¹æ¥å¤§æ¨¡å‹, åŒ…æ‹¬æœ¬åœ°ç§æœ‰å¤§æ¨¡å‹ï¼ˆLlama 3 / Qwen 2 ç­‰ï¼‰ã€å›½å†…å…¬å…±å¤§æ¨¡å‹ï¼ˆé€šä¹‰åƒé—® / è…¾è®¯æ··å…ƒ / å­—èŠ‚è±†åŒ… / ç™¾åº¦åƒå¸† / æ™ºè°± AI / Kimi ç­‰ï¼‰å’Œå›½å¤–å…¬å…±å¤§æ¨¡å‹ï¼ˆOpenAI / Claude / Gemini ç­‰ï¼‰.
- **çµæ´»ç¼–æ’**ï¼šå†…ç½®å¼ºå¤§çš„å·¥ä½œæµå¼•æ“å’Œå‡½æ•°åº“, æ”¯æŒç¼–æ’ AI å·¥ä½œè¿‡ç¨‹, æ»¡è¶³å¤æ‚ä¸šåŠ¡åœºæ™¯ä¸‹çš„éœ€æ±‚ **æ— ç¼åµŒå…¥**ï¼šæ”¯æŒé›¶ç¼–ç å¿«é€ŸåµŒå…¥åˆ°ç¬¬ä¸‰æ–¹ä¸šåŠ¡ç³»ç»Ÿ, è®©å·²æœ‰ç³»ç»Ÿå¿«é€Ÿæ‹¥æœ‰æ™ºèƒ½é—®ç­”èƒ½åŠ›, æé«˜ç”¨æˆ·æ»¡æ„åº¦.

### One API

[One API](https://github.com/songquanpeng/one-api) æ˜¯ä¸€ä¸ª OpenAI æ¥å£ç®¡ç† & åˆ†å‘ç³»ç»Ÿ, æ”¯æŒå¤šç§å¤§æ¨¡å‹, åŒ…æ‹¬ Azure OpenAI APIã€Anthropic Claudeã€Google PaLM2/Geminiã€æ™ºè°± ChatGLMã€ç™¾åº¦æ–‡å¿ƒä¸€è¨€ã€é˜¿é‡Œé€šä¹‰åƒé—®ã€è®¯é£æ˜Ÿç«è®¤çŸ¥ã€360 æ™ºè„‘ä»¥åŠè…¾è®¯æ··å…ƒç­‰.

![20241229154732_vtlqwol5.webp](https://cdn.dong4j.site/source/image/20241229154732_vtlqwol5.webp)

**é‡ç‚¹äº®ç‚¹**:

- **æ”¯æŒå¤šç§å¤§æ¨¡å‹**ï¼šæ— éœ€åˆ‡æ¢ API, å³å¯é€šè¿‡ç»Ÿä¸€çš„ API æ ¼å¼è®¿é—®æ‰€æœ‰å¤§æ¨¡å‹.
- **æ”¯æŒ stream æ¨¡å¼**ï¼šé€šè¿‡æµå¼ä¼ è¾“å®ç°æ‰“å­—æœºæ•ˆæœ, æä¾›æ›´æµç•…çš„äº¤äº’ä½“éªŒ.
- **æ”¯æŒå¤šæœºéƒ¨ç½²**ï¼šæ–¹ä¾¿ç”¨æˆ·è¿›è¡Œå’Œå‡çº§.
- **æ”¯æŒä»¤ç‰Œç®¡ç†**ï¼šè®¾ç½®ä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´ã€é¢åº¦ã€å…è®¸çš„ IP èŒƒå›´ä»¥åŠå…è®¸çš„æ¨¡å‹è®¿é—®.
- **æ”¯æŒå…‘æ¢ç ç®¡ç†**ï¼šæ”¯æŒæ‰¹é‡ç”Ÿæˆå’Œå¯¼å‡ºå…‘æ¢ç , æ–¹ä¾¿ç”¨æˆ·è¿›è¡Œå……å€¼.
- **æ”¯æŒç”¨æˆ·åˆ†ç»„å’Œæ¸ é“åˆ†ç»„**ï¼šæ”¯æŒä¸ºä¸åŒåˆ†ç»„è®¾ç½®ä¸åŒçš„å€ç‡.
- **æ”¯æŒæ¨¡å‹æ˜ å°„**ï¼šé‡å®šå‘ç”¨æˆ·çš„è¯·æ±‚æ¨¡å‹æ–¹ä¾¿ç”¨æˆ·è¿›è¡Œè‡ªå®šä¹‰.
- **æ”¯æŒå¤±è´¥è‡ªåŠ¨é‡è¯•**ï¼šæé«˜ç³»ç»Ÿçš„å¥å£®æ€§.
- **æ”¯æŒç»˜å›¾æ¥å£**ï¼šæ–¹ä¾¿ç”¨æˆ·è¿›è¡Œç»˜å›¾æ“ä½œ.
- **æ”¯æŒä¸°å¯Œçš„è‡ªå®šä¹‰è®¾ç½®**ï¼šåŒ…æ‹¬ç³»ç»Ÿåç§°ã€logoã€é¡µè„šã€é¦–é¡µã€å…³äºé¡µé¢ç­‰.
- **æ”¯æŒç³»ç»Ÿè®¿é—®ä»¤ç‰Œè°ƒç”¨ç®¡ç† API**ï¼šæ–¹ä¾¿ç”¨æˆ·è¿›è¡Œæ‰©å±•å’Œè‡ªå®šä¹‰.

åŒç±»äº§å“:

- [One Hub](https://github.com/MartialBE/one-hub?tab=readme-ov-file)

---

### Gitea

[Gitea](https://github.com/go-gitea/gitea) æ˜¯ä¸€ä¸ªå¼€æºçš„ Git æœåŠ¡è½¯ä»¶, æ—¨åœ¨æä¾›æ˜“äºä½¿ç”¨ä¸”åŠŸèƒ½å¼ºå¤§çš„è‡ªæ‰˜ç®¡ Git ä»“åº“æ‰˜ç®¡å¹³å°. å®ƒæ”¯æŒå¤šç§å¹³å°å’Œæ¶æ„, å¹¶æä¾›ä»£ç å®¡æŸ¥ã€å›¢é˜Ÿåä½œç­‰åŠŸèƒ½, éå¸¸é€‚åˆä¸ªäººæˆ–å›¢é˜Ÿè¿›è¡Œè½¯ä»¶å¼€å‘. Gitea çš„ç¤¾åŒºæ´»è·ƒ, æ–‡æ¡£å®Œå–„, æ˜“äºæ‰©å±•, æ˜¯æ„å»ºè‡ªæ‰˜ç®¡ Git æœåŠ¡å™¨çš„ç†æƒ³é€‰æ‹©.

![20241229154732_epp5JO9j.webp](https://cdn.dong4j.site/source/image/20241229154732_epp5JO9j.webp)

**é‡ç‚¹äº®ç‚¹**:

- **è·¨å¹³å°æ”¯æŒ**ï¼šGitea æ”¯æŒ Linuxã€macOSã€Windows ç­‰å¹³å°, å¹¶å…¼å®¹å¤šç§æ¶æ„.
- **åŠŸèƒ½ä¸°å¯Œ**ï¼šæä¾› Git ä»“åº“æ‰˜ç®¡ã€ä»£ç å®¡æŸ¥ã€å›¢é˜Ÿåä½œã€åŒ…ç®¡ç†ç­‰åŠŸèƒ½.
- **æ˜“äºä½¿ç”¨**ï¼šç•Œé¢ç®€æ´æ˜“ç”¨, æ–°æ‰‹ä¹Ÿèƒ½å¿«é€Ÿä¸Šæ‰‹.
- **å¼€æºå…è´¹**ï¼šGitea æ˜¯å¼€æºè½¯ä»¶, å…è´¹ä½¿ç”¨.
- **ç¤¾åŒºæ´»è·ƒ**ï¼šæ‹¥æœ‰åºå¤§çš„ç¤¾åŒºå’Œè´¡çŒ®è€…ç¾¤ä½“, é—®é¢˜è§£å†³å’ŒåŠŸèƒ½è¿…é€Ÿ.

#### éƒ¨ç½²

```yaml
networks:
  gitea:
    external: false

services:
  server:
    image: gitea/gitea:1.22.3
    container_name: gitea
    environment:
      - USER_UID=1002
      - USER_GID=1002
      - GITEA__database__DB_TYPE=mysql
      - GITEA__database__HOST=192.168.31.7:3306
      - GITEA__database__NAME=gitea
      - GITEA__database__USER={username}
      - GITEA__database__PASSWD={password}
    restart: always
    networks:
      - gitea
    volumes:
      - /mnt/4.860.ssd/docker/gitea:/data
      - /home/git/.ssh/:/data/git/.ssh
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "3400:3000"
      - "2222:22"
```

1. USER_UID å’Œ USER_GID ä½¿ç”¨ git ç”¨æˆ· id;
2. ä½¿ç”¨è‡ªå»º MySQL;
3. è‡ªå®šä¹‰ gitea å­˜å‚¨ç›®å½•: /mnt/4.860.ssd/docker/gitea ([åæœŸå¤‡ä»½](https://docs.gitea.cn/administration/backup-and-restore/));
4. æ·»åŠ  `/home/git/.ssh/` ç”¨äº SSH ç›´é€š;

#### SSH ç›´é€š

1. ä¸»æœºä¸Šç”Ÿæˆ key

   ```bash
   sudo -u git ssh-keygen -t rsa -b 4096 -C "Gitea Host Key"
   ```

2. ä¸»æœºä¸Šåˆ›å»ºè„šæœ¬: `/usr/local/bin/gitea`, å¹¶èµ‹äºˆæ‰§è¡Œæƒé™: `chmod +x /usr/local/bin/gitea`

   ```bash
   ssh -p 2222 -o StrictHostKeyChecking=no git@127.0.0.1 "SSH_ORIGINAL_COMMAND=\"$SSH_ORIGINAL_COMMAND\" $0 $@"
   ```

3. ä¸»æœºä¸Šæ·»åŠ  `authorized_key`:

   ```bash
   echo "$(cat /home/git/.ssh/id_rsa.pub)" >> /home/git/.ssh/authorized_keys
   ```

4. åœ¨ gitea ä¸Šæ·»åŠ  ssh é…ç½®åè¿›è¡Œä¸‹é¢çš„é…ç½®:

   ```bash
   vim /mnt/4.860.ssd/docker/gitea/gitea/conf/app.ini

   [server]
   DOMAIN = gitea.lan
   SSH_DOMAIN = gitea.lan
   ROOT_URL = http://gitea.lan:3400/
   ```

ä¸»è¦æ˜¯å°† ip ä¿®æ”¹ä¸ºåŸŸå:

å®¢æˆ·æœºé…ç½® 1. æ·»åŠ  hosts: `192.168.31.7 gitea.lan`

5. æ·»åŠ  .ssh/config é…ç½®:

   ```bash
   Host gitea.lan
       HostName gitea.lan
       User git
       Port 2222
       IdentityFile ~/.ssh/server
   ```

æµ‹è¯•: `ssh -T git@gitea.lan`:

```txt
Hi there, xxx! You've successfully authenticated with the key named xxx.yyy, but Gitea does not provide shell access.
If this is unexpected, please log in with password and setup Gitea under another user.
```

---

### Jellyfin ä»£ç†é…ç½®

æ–°å»º `/etc/default/jellyfin_proxy.env` å¹¶æ·»åŠ :

```shell
http_proxy=192.168.1.88:7890
https_proxy=192.168.1.88:7890
all_proxy=socks5://192.168.1.88:8080
```

ä¿®æ”¹ `/etc/systemd/system/jellyfin.service.d/override.conf`:

```shell
[Service]
EnvironmentFile = /etc/default/jellyfin_proxy.env
```

é‡å¯:

```shell
sudo systemctl daemon-reload && sudo systemctl restart jellyfin.service
```

Jellyfin æœ‰ä¸ªå‘ç‚¹, è‡³å°‘å¯¹äºæˆ‘æµ‹è¯•çš„ä¸¤ä¸ªåœ°å€: ä¸€ä¸ªæ˜¯ç¯å›åœ°å€ (127.0.0.1), ä¸€ä¸ªæ˜¯å±€åŸŸç½‘åœ°å€ (192.168.31.88, ä½¿ç”¨å±€åŸŸç½‘çš„å¦ä¸€å°è®¾å¤‡åšä»£ç†æœåŠ¡å™¨) æ¥è¯´, è®¾ç½®ç¯å¢ƒå˜é‡æ—¶ä¸èƒ½åŠ ä¸Šåè®®å¤´ (`http://` æˆ– `https://`), å¦åˆ™å°±ç®—è®¾ç½®æˆåŠŸä¹Ÿä¸ä¼šç”Ÿæ•ˆ, ä¸æ¸…æ¥šæ˜¯ä¸æ˜¯ Jellyfin çš„ç„å­¦ bug, äº¦æˆ–è€…è¯´æ˜¯ç¥å¥‡ feature ğŸ˜‘. æ‰€ä»¥ä¸Šæ–‡å†™çš„éƒ½æ˜¯æ²¡æœ‰åŠ åè®®å¤´çš„é…ç½®, å¯ä»¥èµ°ä»£ç†å¹¶æ­£å¸¸å·¥ä½œ, åŠ äº†å³ä½¿è®¾ç½®æˆåŠŸ, åœ¨ Jellyfin é‡Œä¹Ÿæ— æ•ˆ ~(ç„¶è€Œåœ¨å…¶ä»–ç¯å¢ƒè¿™ä¸¤ä¸ªç¯å¢ƒå˜é‡çš„åè®®å¤´æ˜¯å¯åŠ å¯ä¸åŠ çš„, ä¸å½±å“)~.

### Nginx Proxy Manager

[Nginx Proxy Manager](https://nginxproxymanager.com/) æ˜¯ä¸€ä¸ªåŸºäº Docker çš„ Nginx åå‘ä»£ç†ç®¡ç†å·¥å…·, å®ƒæä¾›äº†ç®€å•æ˜“ç”¨çš„ç•Œé¢æ¥ç®¡ç† Nginx ä»£ç†ä¸»æœº.

![20241229154732_VO44KEDv.webp](https://cdn.dong4j.site/source/image/20241229154732_VO44KEDv.webp)

**é‡ç‚¹äº®ç‚¹**:

- **ç®€å•æ˜“ç”¨**ï¼šæ— éœ€æ·±å…¥äº†è§£ Nginx æˆ– Let's Encrypt, å³å¯è½»æ¾åˆ›å»ºè½¬å‘åŸŸåã€é‡å®šå‘ã€æµå’Œ 404 ä¸»æœº.
- **å…è´¹ SSL**ï¼šæ”¯æŒ Let's Encrypt è‡ªåŠ¨ç»­è®¢ SSL è¯ä¹¦, æˆ–æä¾›è‡ªå®šä¹‰ SSL è¯ä¹¦.
- **åŠŸèƒ½ä¸°å¯Œ**ï¼šæä¾›è®¿é—®åˆ—è¡¨ã€åŸºæœ¬ HTTP è®¤è¯ã€é«˜çº§ Nginx é…ç½®ã€ç”¨æˆ·ç®¡ç†ã€æƒé™æ§åˆ¶å’Œå®¡è®¡æ—¥å¿—ç­‰åŠŸèƒ½.
- **é€‚ç”¨äºå®¶åº­ç½‘ç»œ**ï¼šå¯ä»¥è½»æ¾å°†å®¶åº­ç½‘ç»œä¸­çš„ç½‘ç«™æ‰˜ç®¡åœ¨å…¬ç½‘ä¸Š, å¹¶æ”¯æŒç«¯å£è½¬å‘å’ŒåŸŸåæŒ‡å‘è®¾ç½®.

ä½¿ç”¨ DNSPOD æ—¶æŠ¥é”™:

```
ModuleNotFoundError: No module named 'zope' #2440
```

[Fetching Title#rlbf](https://github.com/NginxProxyManager/nginx-proxy-manager/issues/2440)

è§£å†³æ–¹æ³•:

```shell
# è¿›å…¥ docker å®¹å™¨
docker exec -it /bin/bash xxxx
pip install certbot-dns-dnspod
pip install zope -i https://pypi.tuna.tsinghua.edu.cn/simple
```

ç”³è¯·è¯ä¹¦æ—¶æŠ¥é”™:

```
Another instance of Certbot is already running
```

è§£å†³æ–¹æ³•:

```
find / -type f -name '.certbot.lock' -exec rm {} \;
```

---

### 1Panel

ä½¿ç”¨ 1Panel å®‰è£…äº† `OpenResty`, å¹¶åˆ›å»ºäº†é™æ€ç«™ç‚¹, ç”¨äºç”Ÿæˆ Surge çš„è§„åˆ™. ä¸ºäº†æ–¹ä¾¿æ–‡ä»¶å…±äº«ç¼–è¾‘, å°†`/mnt/lankxin.u/docker/docker-compose/sub/data/subconverter/rules/ACL4SSR` é€šè¿‡è½¯é“¾æ¥çš„æ–¹å¼æ·»åŠ åˆ°äº† `/opt/1panel/apps/openresty/openresty/www/sites/ACLSSR/index` ç›®å½•ä¸‹, é…ç½®åæŠ¥ **404 é—®é¢˜**.

å®˜æ–¹ç»™çš„è§£å†³ç‰ˆæœ¬æ˜¯è®¾ç½® `disable_symlinks off`, ä½†æ˜¯å¹¶ä¸èƒ½è§£å†³ä¸Šè¿°é—®é¢˜, å› ä¸ºé»˜è®¤å°±æ˜¯ off:

![20241229154732_aZ8ulzeH.webp](https://cdn.dong4j.site/source/image/20241229154732_aZ8ulzeH.webp)

é—®é¢˜çš„åŸå› æ˜¯ OpenResty ä½¿ç”¨ docker å®¹å™¨å¯åŠ¨, è¿›å…¥å®¹å™¨æŸ¥çœ‹å‘ç°è¯†åˆ«ä¸äº† `/mnt/lankxin.u/docker/docker-compose/sub/data/subconverter/rules/ACL4SSR` ç›®å½•, å› æ­¤éœ€è¦å°†æ­¤ç›®å½•æ˜ å°„åˆ°å®¹å™¨ä¸­:

![20241229154732_CHLTtY12.webp](https://cdn.dong4j.site/source/image/20241229154732_CHLTtY12.webp)

---

### Hishtory

[Hishtory](https://github.com/ddworken/hishtory) æ˜¯ä¸€ä¸ªæ›´å¥½çš„ shell å†å²è®°å½•. å®ƒå°†æ‚¨çš„ shell å†å²è®°å½•å­˜å‚¨åœ¨ä¸Šä¸‹æ–‡ä¸­ï¼ˆå“ªä¸ªç›®å½•ä¸­è¿è¡Œå‘½ä»¤ã€å‘½ä»¤æ˜¯å¦æˆåŠŸæˆ–å¤±è´¥ã€èŠ±è´¹äº†å¤šé•¿æ—¶é—´ç­‰ï¼‰. æ‰€æœ‰è¿™äº›éƒ½å­˜å‚¨åœ¨æœ¬åœ°å¹¶è¿›è¡Œç«¯åˆ°ç«¯åŠ å¯†, ä»¥ä¾¿åŒæ­¥åˆ°å…¶ä»–è®¡ç®—æœº. æ‰€æœ‰è¿™äº›éƒ½å¯ä»¥é€šè¿‡`hishtory`CLI è½»æ¾æŸ¥è¯¢. æ„æ€æ˜¯èƒ½å¤Ÿåœ¨å¤šå°è®¾å¤‡ä¹‹é—´åŒæ­¥å‘½ä»¤è¡Œè®°å½•.

![20241229154732_bPhPdPuS.webp](https://cdn.dong4j.site/source/image/20241229154732_bPhPdPuS.webp)

å®‰è£…æ–¹å¼éå¸¸ç®€å•:

```
curl https://hishtory.dev/install.py | python3 -
```

ç„¶åé‡æ–°æ‰“å¼€ä¸€ä¸ª shell(å¦‚æœä½ ä½¿ç”¨ zsh, ç›´æ¥ source .zshrc ä¹Ÿè¡Œ), ä½¿ç”¨ `Control+R` å³å¯æŸ¥çœ‹å†å²è®°å½•. ä½¿ç”¨ `hishtory status` æŸ¥çœ‹çŠ¶æ€ä¸å¯†é’¥, ç„¶ååœ¨å¦ä¸€å°ä¸»æœºä¸Šé€šè¿‡ä¸Šè¿°å‘½ä»¤å®‰è£…, å¹¶ä½¿ç”¨ `hishtory init {å¯†é’¥}` æ¥åŒæ­¥å†å²è®°å½•.

#### hishtory-server

å½“ç„¶ä¹Ÿå¯ä»¥æ‰§è¡Œéƒ¨ç½² `hoshtory-server` æ¥ä½œä¸ºå¤šå°ä¸»æœºå†å²è®°å½•çš„åŒæ­¥æœåŠ¡å™¨:

```yaml
services:
  hishtory-server:
    image: lscr.io/linuxserver/hishtory-server:latest
    container_name: hishtory-server
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Shanghai
      - HISHTORY_SQLITE_DB=/config/hishtory.db #optional
    ports:
      - 4000:8080
    restart: unless-stopped
```

ç„¶åä¿®æ”¹å„ä¸ªä¸»æœºä¸­çš„ `hishtory` é…ç½®(æˆ‘ä½¿ç”¨ `oh-my-zsh`, æ‰€ä»¥ç›´æ¥ä¿®æ”¹ .zshrc å³å¯):

```shell
export PATH="$PATH:/Users/dong4j/.hishtory"
# æ·»åŠ è¿™ä¸€è¡Œ
export HISHTORY_SERVER="http://{hoshtory-server çš„ IP}:4000"
source /Users/dong4j/.hishtory/config.zsh
```

æœ€åé‡æ–°åŠ è½½é…ç½®:

```shell
source .zshrc
```

è¿™æ ·å°±èƒ½ä½¿ç”¨è‡ªæ‰˜ç®¡çš„ `hoshtory-server` åœ¨å¤šä¸ªä¸»æœºä¹‹é—´åŒæ­¥å‘½ä»¤è¡Œå†å²è®°å½•äº†.

---

### å¸¸ç”¨ä¸­é—´ä»¶

#### MediaMTX

[MediaMTX](https://github.com/bluenviron/mediamtx) æ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„å®æ—¶åª’ä½“æœåŠ¡å™¨å’Œåª’ä½“ä»£ç†, æ”¯æŒè§†é¢‘å’ŒéŸ³é¢‘æµçš„å‘å¸ƒã€è¯»å–ã€ä»£ç†ã€å½•åˆ¶å’Œæ’­æ”¾. å®ƒå¯ä»¥å°†ä¸åŒåè®®çš„åª’ä½“æµè¿›è¡Œè·¯ç”±, å®ç°å¤šç§åª’ä½“æµçš„äº’è”äº’é€š.

æˆ‘ç›®å‰ä¸»è¦ç”¨æ¥æ’­æ”¾æ ‘è“æ´¾æ‘„åƒå¤´ä¸Šçš„è§†é¢‘:

![20241229154732_cwXHOY7g.webp](https://cdn.dong4j.site/source/image/20241229154732_cwXHOY7g.webp)

> [[raspberry-pi-stream|æ ‘è“æ´¾ç»“åˆ MediaMTX/WVP + ZLMediaKit å®ç°è§†é¢‘æµæ’­æ”¾çš„æ•™ç¨‹]]

**ä¸»è¦åŠŸèƒ½**ï¼š

- **æ”¯æŒå¤šç§åè®®**ï¼š æ”¯æŒ SRTã€WebRTCã€RTSPã€RTMPã€HLS ç­‰å¤šç§ä¸»æµåª’ä½“åè®®, å…¼å®¹æ€§è‰¯å¥½.
- **å®æ—¶å¤„ç†**ï¼š å¯å®æ—¶å¤„ç†åª’ä½“æµ, åŒ…æ‹¬è½¬æ¢ã€è§£ç ã€ç¼–ç ã€å‹ç¼©ç­‰æ“ä½œ.
- **å¤šè·¯å¤ç”¨**ï¼š å¯åŒæ—¶å¤„ç†å¤šä¸ªåª’ä½“æµ, å¹¶æä¾›ä¸åŒçš„è®¿é—®è·¯å¾„.
- **å½•åˆ¶å’Œå›æ”¾**ï¼š å¯å°†åª’ä½“æµå½•åˆ¶åˆ°ç£ç›˜, å¹¶æ”¯æŒå›æ”¾.
- **å®‰å…¨è®¤è¯**ï¼š æ”¯æŒç”¨æˆ·è®¤è¯å’Œè®¿é—®æ§åˆ¶, ä¿éšœåª’ä½“æµçš„å®‰å…¨.
- **çµæ´»é…ç½®**ï¼š æä¾›ä¸°å¯Œçš„é…ç½®é€‰é¡¹, å¯æ»¡è¶³ä¸åŒåœºæ™¯çš„éœ€æ±‚.

#### WVP PRO + ZLMediaKit

[WVP PRO](https://github.com/648540858/wvp-GB28181-pro) æ˜¯ä¸€ä¸ªåŸºäº GB28181-2016 æ ‡å‡†å®ç°çš„å¼€ç®±å³ç”¨çš„ç½‘ç»œè§†é¢‘å¹³å°, è´Ÿè´£å®ç°æ ¸å¿ƒä¿¡ä»¤ä¸è®¾å¤‡ç®¡ç†åå°éƒ¨åˆ†, æ”¯æŒ NAT ç©¿é€, æ”¯æŒæµ·åº·ã€å¤§åã€å®‡è§†ç­‰å“ç‰Œçš„ IPCã€NVR æ¥å…¥. æ”¯æŒå›½æ ‡çº§è”, æ”¯æŒå°†ä¸å¸¦å›½æ ‡åŠŸèƒ½çš„æ‘„åƒæœº/ç›´æ’­æµ/ç›´æ’­æ¨æµè½¬å‘åˆ°å…¶ä»–å›½æ ‡å¹³å°, æµåª’ä½“æœåŠ¡åŸºäº [ZLMediaKit](https://github.com/ZLMediaKit/ZLMediaKit).

![20241229154732_u8EjJ7jh.webp](https://cdn.dong4j.site/source/image/20241229154732_u8EjJ7jh.webp)

**ç‰¹æ€§**:

- å®ç°æ ‡å‡†çš„ 28181 ä¿¡ä»¤, å…¼å®¹å¸¸è§çš„å“ç‰Œè®¾å¤‡, æ¯”å¦‚æµ·åº·ã€å¤§åã€å®‡è§†ç­‰å“ç‰Œçš„ IPCã€NVR ä»¥åŠå¹³å°.
- æ”¯æŒå°†å›½æ ‡è®¾å¤‡çº§è”åˆ°å…¶ä»–å›½æ ‡å¹³å°, ä¹Ÿæ”¯æŒå°†ä¸æ”¯æŒå›½æ ‡çš„è®¾å¤‡çš„å›¾åƒæˆ–è€…ç›´æ’­æ¨é€åˆ°å…¶ä»–å›½æ ‡å¹³å°
- å‰ç«¯å®Œå–„, è‡ªå¸¦å®Œæ•´å‰ç«¯é¡µé¢, æ— éœ€äºŒæ¬¡å¼€å‘å¯ç›´æ¥éƒ¨ç½²ä½¿ç”¨.
- å®Œå…¨å¼€æº, ä¸”ä½¿ç”¨ MIT è®¸å¯åè®®. ä¿ç•™ç‰ˆæƒçš„æƒ…å†µä¸‹å¯ä»¥ç”¨äºå•†ä¸šé¡¹ç›®.
- æ”¯æŒå¤šæµåª’ä½“èŠ‚ç‚¹è´Ÿè½½å‡è¡¡.

#### JSON Crack

[JSON Crack](https://github.com/AykutSarac/jsoncrack.com) ä¸“æ³¨äºç®€åŒ– JSON æ•°æ®çš„å¤„ç†å’Œå¯è§†åŒ–. å®ƒé€šè¿‡å°† JSON æ•°æ®è½¬æ¢ä¸ºäº¤äº’å¼å›¾è¡¨, å¸®åŠ©ç”¨æˆ·æ›´ç›´è§‚åœ°ç†è§£æ•°æ®ç»“æ„å’Œå…³ç³». æ­¤å¤–, å®ƒè¿˜æä¾›æ ¼å¼åŒ–ã€éªŒè¯ã€ä»£ç ç”Ÿæˆç­‰åŠŸèƒ½, æ”¯æŒå¤šç§æ•°æ®æ ¼å¼, æ˜¯å¤„ç† JSON æ•°æ®çš„ç†æƒ³é€‰æ‹©.

![20241229154732_IxKLtILH.webp](https://cdn.dong4j.site/source/image/20241229154732_IxKLtILH.webp)

**é‡ç‚¹**ï¼š

- **å¯è§†åŒ– JSON æ•°æ®**ï¼š å°†å¤æ‚çš„ JSON ç»“æ„ä»¥å›¾è¡¨å½¢å¼å±•ç°, æ–¹ä¾¿ç”¨æˆ·å¿«é€Ÿç†è§£å’Œåˆ†ææ•°æ®.
- **æ ¼å¼åŒ–ä¸éªŒè¯**ï¼š è‡ªåŠ¨æ ¼å¼åŒ– JSON æ•°æ®, å¹¶æä¾›éªŒè¯åŠŸèƒ½, ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®.
- **å¤šç§æ ¼å¼æ”¯æŒ**ï¼š æ”¯æŒå¤šç§æ•°æ®æ ¼å¼, åŒ…æ‹¬ JSONã€YAMLã€CSVã€XML å’Œ TOML, æ»¡è¶³ä¸åŒéœ€æ±‚.

**äº®ç‚¹**ï¼š

- **äº¤äº’å¼ä½“éªŒ**ï¼š é€šè¿‡äº¤äº’å¼å›¾è¡¨, ç”¨æˆ·å¯ä»¥å±•å¼€å’ŒæŠ˜å æ•°æ®ç»“æ„, æ¢ç´¢æ•°æ®ç»†èŠ‚.
- **æ˜“äºä½¿ç”¨**ï¼š ç•Œé¢ç®€æ´ç›´è§‚, æ“ä½œç®€å•, å³ä½¿æ˜¯éæŠ€æœ¯ç”¨æˆ·ä¹Ÿèƒ½è½»æ¾ä¸Šæ‰‹.
- **å®‰å…¨å¯é **ï¼š æ•°æ®å¤„ç†å®Œå…¨åœ¨æœ¬åœ°è¿›è¡Œ, æ— éœ€ä¸Šä¼ æˆ–å­˜å‚¨æ•°æ®, ç¡®ä¿ç”¨æˆ·éšç§å®‰å…¨.
- **å¤šåŠŸèƒ½æ€§**ï¼š é™¤äº†å¯è§†åŒ–, è¿˜æä¾›æ ¼å¼åŒ–ã€éªŒè¯ã€ä»£ç ç”Ÿæˆç­‰åŠŸèƒ½, æ»¡è¶³ JSON æ•°æ®å¤„ç†çš„å…¨é¢éœ€æ±‚.

ç›¸å…³èµ„æº:

- [JSON Crack VS Code æ’ä»¶](https://marketplace.visualstudio.com/items?itemName=AykutSarac.jsoncrack-vscode)
- [IDEA ä¸­çš„æ’ä»¶](https://plugins.jetbrains.com/plugin/22308-jsoncrack)

##### éƒ¨ç½²

```bash
git clone git@github.com:AykutSarac/jsoncrack.com.git
cd jsoncrack.com
docker build -t jsoncrack .
docker-compose up -d
```

<!-- ä¸‹é¢å…¨éƒ¨ä½¿ç”¨ 1Panel éƒ¨ç½² -->

å…¶ä»–ä¸€äº›å¸¸ç”¨çš„å¼€å‘ä¸­é—´ä»¶å…¨éƒ¨ä½¿ç”¨ 1Panel éƒ¨ç½²:

- mongodb
- nacos
- kafka
- mysql
- postgresql
- emqx
- redis

## AI.Station

è¿™å°ä¸»æœºå› ä¸ºè€—ç”µé‡æœ‰ç‚¹é«˜, åªä¼šåœ¨ä½¿ç”¨æ—¶å¼€ä¸€ä¸‹, ç›®å‰ä¸»è¦ç”¨ä½œ AI ç›¸å…³çš„æµ‹è¯•ç¯å¢ƒ, åæœŸæ‰“ç®—æ¢æˆ 22G ç‰ˆæœ¬çš„ 2080Ti ç©ä¸€ç©.

### Stable Diffusion

[Stable Diffusion web UI](https://github.com/AUTOMATIC1111/stable-diffusion-webui) æ˜¯ä¸€ä¸ªåŸºäº Gradio åº“å®ç°çš„ Stable Diffusion æ¨¡å‹çš„ç½‘é¡µç•Œé¢. å®ƒæä¾›äº†ä¸€ç³»åˆ—åŠŸèƒ½, æ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨ Stable Diffusion æ¨¡å‹è¿›è¡Œå›¾åƒç”Ÿæˆå’Œç¼–è¾‘.

å°±æ˜¯çœ‹äº† [è¿™ç¯‡æ–‡ç« ](https://medium.com/@croath/%E4%BD%8E%E6%88%90%E6%9C%AC%E4%BD%93%E9%AA%8C%E7%94%9F%E6%88%90-ai-%E5%B0%8F%E5%A7%90%E5%A7%90%E7%85%A7%E7%89%87-85ffa7c13cd7)å¼€å§‹å…¥å‘çš„, å¯ä»¥è¯´æ˜¯å› ä¸º **Stable Diffusion** ç»„è£…äº† **AI.Station** è¿™å°ä¸»æœº, ä¹Ÿæ˜¯æˆ‘å°è¯•çš„ç¬¬ä¸€æ¬¾ AI å·¥å…·, ç›®å‰åšå®¢çš„ cover å›¾ç‰‡ä¹Ÿæ˜¯é€šè¿‡å®ƒæ¥ç”Ÿæˆçš„.

![20241229154732_tkgmSIsV.webp](https://cdn.dong4j.site/source/image/20241229154732_tkgmSIsV.webp)

**ä¸»è¦åŠŸèƒ½**ï¼š

- **å›¾åƒç”Ÿæˆ**ï¼šæ”¯æŒ txt2img å’Œ img2img æ¨¡å¼, å¯ä»¥è¾“å…¥æ–‡å­—æè¿°ç”Ÿæˆå›¾åƒ, æˆ–å°†å›¾åƒä½œä¸ºè¾“å…¥è¿›è¡Œé£æ ¼è¿ç§»æˆ–å†…å®¹ç¼–è¾‘.
- **å›¾åƒç¼–è¾‘**ï¼šæ”¯æŒ outpaintingã€inpaintingã€color ç­‰åŠŸèƒ½, å¯ä»¥æ‰©å±•å›¾åƒå†…å®¹ã€ä¿®å¤å›¾åƒç¼ºé™·æˆ–æ”¹å˜å›¾åƒé¢œè‰².
- **æ¨¡å‹æ‰©å±•**ï¼šé›†æˆäº† GFPGANã€CodeFormerã€RealESRGANã€ESRGANã€SwinIRã€Swin2SRã€LDSR ç­‰æ¨¡å‹, å¯ä»¥ä¿®å¤äººè„¸ã€ä¿®å¤å›¾åƒã€æå‡å›¾åƒåˆ†è¾¨ç‡ç­‰.
- **å‚æ•°æ§åˆ¶**ï¼šæä¾›ä¸°å¯Œçš„å‚æ•°è®¾ç½®é€‰é¡¹, åŒ…æ‹¬é‡‡æ ·æ–¹æ³•ã€æ³¨æ„åŠ›æœºåˆ¶ã€ç”Ÿæˆå‚æ•°ç­‰, å¯ä»¥æ§åˆ¶å›¾åƒç”Ÿæˆçš„é£æ ¼å’Œè´¨é‡ **æ‰¹é‡å¤„ç†**ï¼šæ”¯æŒæ‰¹é‡å¤„ç†å›¾åƒ, å¯ä»¥åŒæ—¶ç”Ÿæˆå¤šå¼ å›¾åƒ.
- **è‡ªå®šä¹‰è„šæœ¬**ï¼šæ”¯æŒè‡ªå®šä¹‰è„šæœ¬, å¯ä»¥æ‰©å±•åŠŸèƒ½æˆ–å®ç°ç‰¹å®šéœ€æ±‚.

**å…¶ä»–ç‰¹ç‚¹**ï¼š

- **æ˜“äºä½¿ç”¨**ï¼šç½‘é¡µç•Œé¢ç®€æ´æ˜“ç”¨, æ“ä½œæ–¹ä¾¿.
- **è·¨å¹³å°**ï¼šæ”¯æŒ Windowsã€Linuxã€macOS ç­‰æ“ä½œç³»ç»Ÿ.
- **å¼€æº**ï¼šå¼€æºä»£ç , æ–¹ä¾¿ç”¨æˆ·å­¦ä¹ å’Œæ”¹è¿›.

#### ç›¸å…³èµ„æº

##### æ¨¡å‹èµ„æº

- [9 ä¸ª Stable Diffusion æ¨¡å‹ç½‘ç«™](https://www.mdnice.com/writing/a6c04462013e469793b3ff41830a7b08)
- [Stable Diffusion å¸¸ç”¨æ¨¡å‹ä¸‹è½½ä¸è¯´æ˜](https://blog.csdn.net/libaiup/article/details/139167972)

##### æ•™ç¨‹

- [Stable Diffusion æ•™ç¨‹](https://github.com/ai-vip/stable-diffusion-tutorial)
- [å¤–å©†éƒ½èƒ½çœ‹æ‡‚çš„ Stable Diffusion å…¥é—¨æ•™ç¨‹](https://www.uisdc.com/stable-diffusion-3)
- [ä¸‡å­—é•¿æ–‡ï¼šStable Diffusion ä¿å§†çº§æ•™ç¨‹](https://blog.csdn.net/jarodyv/article/details/129387945)
- [è¶…è¯¦ç»†çš„èƒæ•™çº§ Stable Diffusion ä½¿ç”¨æ•™ç¨‹](https://mp.weixin.qq.com/s/eFi-xoVDQomzCBr5kO9nHA)
- [è§†é¢‘æ•™ç¨‹-Stable Diffusion æ•™ç¨‹ ä»å…¥é—¨åˆ°ç²¾é€š](https://www.youtube.com/playlist?list=PL4L5yXcAegdxwcD2RRffQntmXygv26auT)

#### ç›¸å…³é—®é¢˜

```
ImportError: Using SOCKS proxy, but the 'socksio' package is not installed. Make sure to install httpx using `pip install httpx[socks]`.
```

```shell
pip install 'httpx[socks]'
```

> zsh ç¯å¢ƒä¸èƒ½ç›´æ¥ä½¿ç”¨ `pip install httpx[socks]`, è¿™æ˜¯ Zsh çš„è·¯å¾„æ‰©å±•æœºåˆ¶å¯¼è‡´çš„é—®é¢˜, å®ƒä¼šå°è¯•å°†æ–¹æ‹¬å· [] è§†ä¸ºé€šé…ç¬¦

éªŒè¯:

```
python -c "import httpx; print(httpx.__version__)"
```

ç„¶è€Œä¸Šè¿°æ“ä½œå¹¶æ— æ³•è§£å†³, ä¸‹é¢æ‰æ˜¯æ­£ç¡®çš„æ–¹æ³•:

```
unset all_proxy && unset ALL_PROXY
```

å› ä¸ºæˆ‘å¼€å¯äº†ç»ˆç«¯ä»£ç†, éœ€è¦å…ˆå…³é—­ä»£ç†.

### ComfyUI

[ComfyUI](https://github.com/comfyanonymous/ComfyUI) æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„æ‰©æ•£æ¨¡å‹å›¾å½¢ç•Œé¢ã€API å’Œåç«¯å·¥å…·, æä¾›åŸºäºå›¾//æµç¨‹å›¾çš„ç•Œé¢, è®©æ‚¨æ— éœ€ç¼–å†™ä»£ç å³å¯è®¾è®¡å’Œæ‰§è¡Œå¤æ‚çš„ç¨³å®šæ‰©æ•£å·¥ä½œæµç¨‹.

![20241229154732_rUrd5dZq.webp](https://cdn.dong4j.site/source/image/20241229154732_rUrd5dZq.webp)

**ä¸»è¦ç‰¹ç‚¹**ï¼š

- **å›¾å½¢ç•Œé¢**ï¼š ä½¿ç”¨èŠ‚ç‚¹/å›¾/æµç¨‹å›¾ç•Œé¢, æ— éœ€ä»£ç å³å¯è®¾è®¡å’Œæ‰§è¡Œå·¥ä½œæµç¨‹.
- **å…¼å®¹å¤šç§æ¨¡å‹**ï¼š æ”¯æŒ SD1.xã€SD2.xã€SDXLã€Stable Video Diffusionã€Stableã€SD3 å’Œ Stable Audio ç­‰å¤šç§æ‰©æ•£æ¨¡å‹.
- **é«˜æ•ˆç®¡ç†**ï¼š å¼‚æ­¥é˜Ÿåˆ—ç³»ç»Ÿã€æ™ºèƒ½å†…å­˜ç®¡ç†ã€ä»…é‡æ‰§è¡Œæ›´æ”¹éƒ¨åˆ†ç­‰ä¼˜åŒ–åŠŸèƒ½.
- **æ¨¡å‹å…¼å®¹**ï¼š æ”¯æŒåŠ è½½ ckptã€safetensors å’Œ diffusers æ¨¡å‹/æ£€æŸ¥ç‚¹, ä»¥åŠç‹¬ç«‹çš„ VAE å’Œ CLIP æ¨¡å‹.
- **æ–‡æœ¬å¤„ç†**ï¼š æ”¯æŒåµŒå…¥/æ–‡æœ¬åè½¬ã€Loras (regular, locon å’Œ loha)ã€è¶…ç½‘ç»œç­‰æ–‡æœ¬åŠŸèƒ½.
- **å·¥ä½œæµç¨‹ç®¡ç†**ï¼š å¯ä»¥ä» PNGã€WebP å’Œ FLAC æ–‡ä»¶åŠ è½½åŒ…å«ç§å­çš„å·¥ä½œæµç¨‹, å¹¶ä¿å­˜/åŠ è½½å·¥ä½œæµç¨‹ä¸º JSON æ–‡ä»¶.
- **å¤šç§å·¥å…·**ï¼š æ”¯æŒåŒºåŸŸåˆæˆã€ä¿®å¤ã€ControlNet å’Œ T2I-Adapterã€å‡é‡‡æ ·æ¨¡å‹ (ESRGANã€SwinIRã€Swin2SR ç­‰)ã€unCLIP æ¨¡å‹ã€GLIGENã€æ¨¡å‹åˆå¹¶ã€LCM æ¨¡å‹å’Œ Lorasã€XL Turboã€AuraFlowã€HunyuanDiTã€TAESD éšå¼é¢„è§ˆç­‰åŠŸèƒ½.
- **ç¦»çº¿å·¥ä½œ**ï¼š å®Œå…¨ç¦»çº¿å·¥ä½œ, æ— éœ€ä¸‹è½½ä»»ä½•å†…å®¹.
- **é…ç½®æ–‡ä»¶**ï¼š å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶è®¾ç½®æ¨¡å‹æœç´¢è·¯å¾„.

> ConfyUI å®˜ç½‘çš„ [æ¡Œé¢ç‰ˆ](https://github.com/Comfy-Org/desktop) æœ€è¿‘å¼€å§‹å…¬æµ‹äº†, ä¸‹è½½åœ°å€:
> Windows (NVIDIA) NSIS x64: [Download](https://download.comfy.org/windows/nsis/x64)
> macOS ARM: [Download](https://download.comfy.org/mac/dmg/arm64)

#### ç›¸å…³èµ„æº

- [ComfyUI å…¥é—¨å’Œè¿›é˜¶æŒ‡å—](https://www.uisdc.com/zt/comfyui)
- [ç³»åˆ—æ•™ç¨‹](https://comfyui-wiki.com/zh/tutorial)
- [RunComfy çš„æ•™ç¨‹](https://www.runcomfy.com/zh-CN/tutorials)
- [è§†é¢‘æ•™ç¨‹-ComfyUI å…¥é—¨åˆ°ç²¾é€š](https://www.youtube.com/playlist?list=PL4L5yXcAegdy6aZGttxu2lVhjSaYVAquX)
- [è§†é¢‘æ•™ç¨‹-ComfyUI ç³»ç»Ÿæ•™ç¨‹](https://www.youtube.com/playlist?list=PLPr2bJ5ZkFrx4MmCLHemoHC3qWEGk6XN1)

### AI starter kit

[Self-hosted AI starter kit](https://github.com/n8n-io/self-hosted-ai-starter-kit) æ˜¯ä¸€ä¸ªå¼€æºçš„ Docker Compose æ¨¡æ¿, æ—¨åœ¨å¿«é€Ÿæ­å»ºæœ¬åœ° AI å’Œä½ä»£ç å¼€å‘ç¯å¢ƒ. å®ƒç”± **[n8n](#n8n)** ç²¾å¿ƒæ‰“é€ , é›†æˆäº†è‡ªæ‰˜ç®¡ n8n å¹³å°å’Œä¸€ç³»åˆ—å…¼å®¹çš„ AI äº§å“å’Œç»„ä»¶, è®©æ‚¨å¯ä»¥è½»æ¾å¼€å§‹æ„å»ºè‡ªæ‰˜ç®¡çš„ AI å·¥ä½œæµç¨‹.

![20241229154732_38N0rSw2.webp](https://cdn.dong4j.site/source/image/20241229154732_38N0rSw2.webp)

**ä¸»è¦åŠŸèƒ½**ï¼š

- **è‡ªæ‰˜ç®¡ n8n å¹³å°**ï¼šä½ä»£ç å¹³å°, æ‹¥æœ‰è¶…è¿‡ 400 ä¸ªé›†æˆå’Œé«˜çº§ ç»„ä»¶.
- **Ollama**ï¼šè·¨å¹³å° LLM å¹³å°, å¯å®‰è£…å’Œè¿è¡Œæœ€æ–°çš„æœ¬åœ° LLM.
- **Qdrant**ï¼šå¼€æºã€é«˜æ€§èƒ½å‘é‡å­˜å‚¨, æ‹¥æœ‰å…¨é¢çš„ API.
- **PostgreSQL**ï¼šæ•°æ®å·¥ç¨‹é¢†åŸŸçš„â€œå·¥ä½œé©¬â€, å®‰å…¨å¤„ç†å¤§é‡æ•°æ®.

> æˆ‘è¿˜æ˜¯ç”¨ ChatGLM4 æŠŠ, è‡³å°‘ä¸Šé¢çš„é—®é¢˜å®ƒèƒ½å›ç­”å‡ºæ¥:
>
> ![20241229154732_AlTfxeF4.webp](https://cdn.dong4j.site/source/image/20241229154732_AlTfxeF4.webp)

#### å®‰è£… Nvidia å®¹å™¨å·¥å…·åŒ…

1. é…ç½®å­˜å‚¨åº“

   ```bash
   curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey \
       | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
   curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list \
       | sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' \
       | sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
   sudo apt-get update
   ```

2. å®‰è£…å·¥å…·åŒ…

   ```bash
   sudo apt-get install -y nvidia-container-toolkit
   ```

#### é…ç½® Docker ä»¥ä½¿ç”¨ Nvidia é©±åŠ¨ç¨‹åº

```bash
sudo nvidia-ctk runtime configure --runtime=docker
sudo systemctl restart docker
```

ä¸Šè¿°å‘½ä»¤åœ¨ `/etc/docker/daemon.json` æ·»åŠ å¦‚ä¸‹å†…å®¹:

```json
"runtimes": {
      "nvidia": {
          "args": [],
          "path": "nvidia-container-runtime"
      }
  }
```

#### éƒ¨ç½²

```bash
git clone https://github.com/n8n-io/self-hosted-ai-starter-kit.git
cd self-hosted-ai-starter-kit
docker compose --profile gpu-nvidia up -d
```

> å¦‚æœéœ€è¦åœ¨éæœ¬æœºä¸Šè®¿é—® WebUI, environment éœ€è¦æ·»åŠ  `N8N_SECURE_COOKIE=false`.

å¯åŠ¨åéœ€è¦è€å¿ƒç­‰å¾… `llama3.2:latest` æ¨¡å‹ä¸‹è½½å®Œæˆåæ‰èƒ½æ‰§è¡ŒèŠå¤©. ä¸‹è½½æ¨¡å‹èŠ±äº†å¤§æ¦‚ 10 åˆ†é’Ÿ:

![20241229154732_xut64rTN.webp](https://cdn.dong4j.site/source/image/20241229154732_xut64rTN.webp)

---

## MBP

macOS ä¸‹æ¨èä½¿ç”¨ [OrbStack](https://orbstack.dev/) , å®ƒæ˜¯ä¸€æ¬¾æ›¿ä»£ Docker Desktop çš„è½»é‡çº§ Docker å’Œ Linux è¿è¡Œç¯å¢ƒ. å®ƒå…·æœ‰å¯åŠ¨å¿«ã€å ç”¨èµ„æºå°‘ã€æ˜“äºé›†æˆç­‰ç‰¹ç‚¹, å¹¶æä¾›å®¹å™¨ã€Kubernetes å’Œ Linux å‘è¡Œç‰ˆç­‰åŠŸèƒ½.

![20241229154732_jbwSIPKq.webp](https://cdn.dong4j.site/source/image/20241229154732_jbwSIPKq.webp)

**é‡è¦äº®ç‚¹**:

- **è½»é‡çº§**ï¼šå ç”¨èµ„æºå°‘, å¯¹ç”µæ± ç»­èˆªå½±å“å°.
- **é€Ÿåº¦å¿«**ï¼šå¯åŠ¨é€Ÿåº¦å¿«, ç½‘ç»œæ€§èƒ½ä¼˜å¼‚.
- **æ˜“äºé›†æˆ**ï¼šä¸ Docker Desktop å…¼å®¹, æ”¯æŒè¿œç¨‹ SSH å’Œæ–‡ä»¶å…±äº«.
- **åŠŸèƒ½ä¸°å¯Œ**ï¼šæ”¯æŒå®¹å™¨ã€Kubernetes å’Œ Linux å‘è¡Œç‰ˆç­‰åŠŸèƒ½.
- **æ€§èƒ½ä¼˜å¼‚**ï¼šåœ¨æ€§èƒ½æµ‹è¯•ä¸­ä¼˜äº Docker Desktop.

### LM Studio

[LM Studio](https://lmstudio.ai/) æ˜¯ä¸€ä¸ªå¯ä»¥æœ¬åœ°è¿è¡Œå¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰çš„å·¥å…·, ç”¨æˆ·æ— éœ€è¿æ¥äº’è”ç½‘å³å¯åœ¨ç”µè„‘ä¸Šè¿è¡Œå„ç§ LLM, åŒ…æ‹¬ Llamaã€Mistralã€Phi ç­‰

![20241229154732_ziXFTeHa.webp](https://cdn.dong4j.site/source/image/20241229154732_ziXFTeHa.webp)

**é‡ç‚¹äº®ç‚¹**:

- **æœ¬åœ°è¿è¡Œ**ï¼šæ— éœ€è¿æ¥äº’è”ç½‘, åœ¨æœ¬åœ°ç”µè„‘ä¸Šè¿è¡Œ LLM.
- **æ¨¡å‹åº“ä¸°å¯Œ**ï¼šæ”¯æŒå¤šç§ LLM æ¨¡å‹, åŒ…æ‹¬ Llamaã€Mistralã€Phiã€Gemmaã€DeepSeekã€Qwen2.5 ç­‰.
- **æ–‡æ¡£å¯¹è¯**ï¼šå¯ä»¥ä¸æœ¬åœ°æ–‡æ¡£è¿›è¡Œå¯¹è¯, è·å–ä¿¡æ¯æˆ–ç”Ÿæˆå†…å®¹.
- **å¤šç§æ¥å£**ï¼šæ”¯æŒé€šè¿‡ Chat UI æˆ– OpenAI å…¼å®¹çš„æœ¬åœ°æœåŠ¡å™¨ä½¿ç”¨æ¨¡å‹.
- **æ¨¡å‹ä¸‹è½½**ï¼šå¯ä»¥ä¸‹è½½ Hugging Face ä¸Šçš„ä»»ä½•å…¼å®¹æ¨¡å‹æ–‡ä»¶.
- **éšç§ä¿æŠ¤**ï¼šä¸æ”¶é›†ç”¨æˆ·æ•°æ®, ä¿æŠ¤ç”¨æˆ·éšç§.

**ä¼˜åŠ¿**:

- **æ— éœ€äº’è”ç½‘**ï¼šéšæ—¶éšåœ°ä½¿ç”¨ LLM, ä¸å—ç½‘ç»œé™åˆ¶.
- **éšç§ä¿æŠ¤**ï¼šä¿æŠ¤ç”¨æˆ·æ•°æ®å®‰å…¨, é¿å…æ•°æ®æ³„éœ²é£é™©.
- **åŠŸèƒ½ä¸°å¯Œ**ï¼šæ»¡è¶³å¤šç§ LLM åº”ç”¨éœ€æ±‚.
- **æ˜“äºä½¿ç”¨**ï¼šç®€æ´çš„ç•Œé¢, æ˜“äºä¸Šæ‰‹.

![20241229154732_ehBTUUoX.webp](https://cdn.dong4j.site/source/image/20241229154732_ehBTUUoX.webp)

ç›®å‰æ˜¯æˆ‘ä¸»è¦ä½¿ç”¨çš„æœ¬åœ° LLM å·¥å…·, ä¸”å…¼å®¹ OpenAI API, è¿™æ ·æˆ‘å°±å¯ä»¥åœ¨å…¶ä»–éœ€è¦ LLM çš„åº”ç”¨ä¸­ä½¿ç”¨.

### Ollama ç›¸å…³é—®é¢˜

```shell
# å…è®¸è·¨åŸŸ
launchctl setenv OLLAMA_ORIGINS "*"
# æ›´æ”¹æ¨¡å‹ä½ç½®
launchctl setenv OLLAMA_MODELS "/Users/dong4j/Library/CloudStorage/SynologyDrive-AI/models/ollama"
# ä¿®æ”¹ bind
launchctl setenv OLLAMA_HOST "0.0.0.0"
```

è¿™é‡Œè¡¥å……ä¸€ä¸‹å¦‚æœæ˜¯åœ¨ Docker ä¸­å®‰è£…, æœ‰å¯èƒ½ä¼šé‡åˆ° [Unable to make cors work in docker container](https://github.com/ollama/ollama/issues/3365) é—®é¢˜, ä¸è¿‡æœ€æ–°ç‰ˆæœ¬å·²ç»ä¿®å¤äº†.

## Mac mini 2018

ä½œä¸ºæœ€åä¸€ä»£æ”¯æŒ Intel èŠ¯ç‰‡çš„ macOS ä¸»æœº, äºŒæ‰‹å·²ç»å–ä¸èµ·ä»·äº†, æ‰€ä»¥ç•™ç€å½“å°æœåŠ¡å™¨ç”¨. æœ€å¤§çš„é—®é¢˜å°±æ˜¯å‘çƒ­ä¸¥é‡, ç°åœ¨æ•£çƒ­é£æ‰‡ 24 å°æ—¶å¼€ç€, ä¸€ç‚¹ä¸æ•¢æ€ æ…¢, å¸Œæœ›è¿˜èƒ½å¤šç”¨å‡ å¹´.

### Rsync Server

Mac mini 2018 é€šè¿‡é›·é›³ 3 è¿æ¥ç€ä¸€ä¸ª 8T çš„ LaCie d2 Professional, ç”¨ä½œé‡è¦æ•°æ®çš„å†—ä½™å¤‡ä»½.

ç›®å‰é€šè¿‡ Rsync å°† DS923+ ä¸Šçš„é‡è¦æ•°æ®åŒæ­¥åˆ° LaCie d2 ä¸Š. å…·ä½“çš„é…ç½®æ–¹å¼å°†åœ¨ [[homelab-data|æ•°æ®ç¯‡]] è¯¦ç»†è¯´æ˜, ä¸»è¦æ¶‰åŠåˆ° Rsync çš„ Server å¯åŠ¨æ¨¡å¼ä»¥åŠ macOS ä¸Šçš„è‡ªå¯åŠ¨é…ç½®.

![20241229154732_9bWUOu7s.webp](https://cdn.dong4j.site/source/image/20241229154732_9bWUOu7s.webp)

### V2ray

å¦ä¸€ç§ VPN æ–¹æ¡ˆ, ä½¿ç”¨ Surge ä½œä¸ºå®¢æˆ·ç«¯è¿æ¥å®¶ä¸­çš„è®¾å¤‡å’ŒæœåŠ¡:

> ä½¿ç”¨ V2ray åªä½œä¸ºè¿æ¥å®¶ä¸­ç½‘ç»œ, ä¸ä½œå…¶ä»–ç”¨é€”.

```yaml
services:
  v2ray:
    command: "v2ray -config /srv/docker/v2ray/config.json"
    image: "v2ray/official:latest"
    restart: always
    ports:
      - "54321:54321"
    volumes:
      - "/path/to/data:/srv/docker/v2ray"
```

`config.json` é…ç½®å¦‚ä¸‹:

```json
{
  "inbounds": [
    {
      "port": 54321,
      "protocol": "vmess",
      "settings": {
        "clients": [
          {
            "id": "ac2a5d46-a3c4-4c35-9db1-614f403dedff",
            "alterId": 64
          }
        ]
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "freedom",
      "settings": {}
    }
  ]
}
```

Surge é…ç½®å¦‚ä¸‹:

```
ğŸ’» V.Intel = vmess, your.domain.name, 54321, username=ac2a5d46-a3c4-4c35-9db1-614f403dedff
```

---

### NextChat

[NextChat](https://github.com/ChatGPTNextWeb/ChatGPT-Next-Web) æ˜¯ä¸€ä¸ªåŸºäº ChatGPT å’Œ Gemini çš„è·¨å¹³å°åº”ç”¨, æ”¯æŒ Webã€PWAã€Linuxã€Windowsã€MacOS ç­‰å¤šç§å¹³å°. å®ƒå¯ä»¥å¸®åŠ©ç”¨æˆ·ä¸€é”®éƒ¨ç½²è‡ªå·±çš„ ChatGPT åº”ç”¨, å¹¶æä¾› GPT3ã€GPT4 å’Œ Gemini Pro ç­‰å¤šç§ AI æ¨¡å‹æ”¯æŒ.

![20241229154732_TdYndv4v.webp](https://cdn.dong4j.site/source/image/20241229154732_TdYndv4v.webp)

**é‡ç‚¹äº®ç‚¹**:

- **ä¸€é”®éƒ¨ç½²**ï¼šåªéœ€åœ¨ Vercel ä¸Šè¿›è¡Œç®€å•æ“ä½œ, å³å¯åœ¨ 1 åˆ†é’Ÿå†…å®Œæˆéƒ¨ç½².
- **è½»é‡çº§**ï¼šLinux/Windows/MacOS ç‰ˆæœ¬çš„å®¢æˆ·ç«¯ä½“ç§¯å°å·§ï¼ˆçº¦ 5MBï¼‰, æ˜“äºå®‰è£…å’Œä½¿ç”¨.
- **å…¼å®¹è‡ªéƒ¨ç½²æ¨¡å‹**ï¼šæ”¯æŒä¸è‡ªéƒ¨ç½²çš„ LLM æ¨¡å‹ï¼ˆå¦‚ RWKV-Runner å’Œ LocalAIï¼‰æ— ç¼é…åˆ.
- **éšç§ä¿æŠ¤**ï¼šæ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­, ç¡®ä¿ç”¨æˆ·éšç§å®‰å…¨.
- **ä¸°å¯Œçš„åŠŸèƒ½**ï¼šæ”¯æŒ Markdownã€å“åº”å¼è®¾è®¡ã€æ·±è‰²æ¨¡å¼ã€PWA ç­‰åŠŸèƒ½, å¹¶æä¾›é¢„åˆ¶è§’è‰²æµ·é‡å†…ç½® prompt åˆ—è¡¨.
- **å¤šè¯­è¨€æ”¯æŒ**ï¼šæ”¯æŒè‹±è¯­ã€ç®€ä½“ä¸­æ–‡ã€ç¹ä½“ä¸­æ–‡ã€æ—¥è¯­ã€è¥¿ç­ç‰™è¯­ç­‰å¤šç§è¯­è¨€.

### ChatGPT on WeChat

[ChatGPT on WeChat](https://github.com/zhayujie/chatgpt-on-wechat) æ˜¯åŸºäºå¤§æ¨¡å‹æ­å»ºçš„èŠå¤©æœºå™¨äºº, åŒæ—¶æ”¯æŒ å¾®ä¿¡å…¬ä¼—å·ã€ä¼ä¸šå¾®ä¿¡åº”ç”¨ã€é£ä¹¦ã€é’‰é’‰ ç­‰æ¥å…¥, å¯é€‰æ‹© GPT3.5/GPT-4o/GPT-o1/ Claude/æ–‡å¿ƒä¸€è¨€/è®¯é£æ˜Ÿç«/é€šä¹‰åƒé—®/ Gemini/GLM-4/Claude/Kimi/LinkAI, èƒ½å¤„ç†æ–‡æœ¬ã€è¯­éŸ³å’Œå›¾ç‰‡, è®¿é—®æ“ä½œç³»ç»Ÿå’Œäº’è”ç½‘, æ”¯æŒåŸºäºè‡ªæœ‰çŸ¥è¯†åº“è¿›è¡Œå®šåˆ¶ä¼ä¸šæ™ºèƒ½å®¢æœ.

![20241229154732_G3FSok7x.webp](https://cdn.dong4j.site/source/image/20241229154732_G3FSok7x.webp)

[æ•ˆæœæ¼”ç¤º](https://cdn.link-ai.tech/doc/cow_demo.mp4)

### Dify on WeChat

[Dify on WeChat](https://github.com/hanfangyuan4396/dify-on-wechat) é¡¹ç›®ä¸º [chatgpt-on-wechat](https://github.com/zhayujie/chatgpt-on-wechat) ä¸‹æ¸¸åˆ†æ”¯, é¢å¤–å¯¹æ¥äº† LLMOps å¹³å° [Dify](https://github.com/langgenius/dify), æ”¯æŒ Dify æ™ºèƒ½åŠ©æ‰‹æ¨¡å‹, è°ƒç”¨å·¥å…·å’ŒçŸ¥è¯†åº“, æ”¯æŒ Dify å·¥ä½œæµ.

![20241229154732_s934kJDk.webp](https://cdn.dong4j.site/source/image/20241229154732_s934kJDk.webp)

Dify æ¥å…¥å¾®ä¿¡ç”Ÿæ€çš„è¯¦ç»†æ•™ç¨‹è¯·æŸ¥çœ‹æ–‡ç«  [**æ‰‹æ‘¸æ‰‹æ•™ä½ æŠŠ Dify æ¥å…¥å¾®ä¿¡ç”Ÿæ€**](https://docs.dify.ai/v/zh-hans/learn-more/use-cases/dify-on-wechat).

## Mac mini M2

Mac mini M2 ä¸»è¦ä½œä¸º AI è¾…ä½ä¸»æœº, éƒ¨ç½²äº†ä¸€äº›å°æ¨¡å‹æ¥è¾…ä½ RAG çš„å»ºè®¾, æ¯”å¦‚:

- reranker
- m3e-large

## è½¯è·¯ç”±

### R2S

#### AdGuard Home

[AdGuard Home](https://github.com/AdguardTeam/AdGuardHome) æ˜¯ä¸€æ¬¾å…è´¹å¼€æºçš„ç½‘ç»œå¹¿å‘Šå’Œè·Ÿè¸ªå™¨å±è”½è½¯ä»¶, å®ƒé€šè¿‡å……å½“ DNS æœåŠ¡å™¨æ¥é˜»æ­¢è·Ÿè¸ªåŸŸ, ä»è€Œé˜²æ­¢æ‚¨çš„è®¾å¤‡è¿æ¥åˆ°è¿™äº›æœåŠ¡å™¨.

![20241229154732_wJLNXSok.webp](https://cdn.dong4j.site/source/image/20241229154732_wJLNXSok.webp)

**ç‰¹æ€§**:

- **ç½‘ç»œçº§ä¿æŠ¤**ï¼š AdGuard Home å¯ä»¥è¦†ç›–æ‚¨å®¶ä¸­æ‰€æœ‰è®¾å¤‡çš„ç½‘ç»œ, æ— éœ€åœ¨è®¾å¤‡ä¸Šå®‰è£…ä»»ä½•å®¢æˆ·ç«¯è½¯ä»¶.
- **å¼ºå¤§çš„åŠŸèƒ½**ï¼š å®ƒä¸ä»…èƒ½å¤Ÿå±è”½å¹¿å‘Šå’Œè·Ÿè¸ªå™¨, è¿˜å¯ä»¥é˜»æ­¢æ¶æ„è½¯ä»¶ã€é’“é±¼ç½‘ç«™ã€æˆäººå†…å®¹, å¹¶å¼ºåˆ¶è¿›è¡Œå®‰å…¨æœç´¢.
- **è‡ªå®šä¹‰è§„åˆ™**ï¼š æ‚¨å¯ä»¥æ·»åŠ è‡ªå®šä¹‰è§„åˆ™æ¥å±è”½ç‰¹å®šç½‘ç«™æˆ–å¹¿å‘Š.
- **æ˜“äºä½¿ç”¨**ï¼š AdGuard Home éå¸¸æ˜“äºè®¾ç½®å’Œä½¿ç”¨, å³ä½¿æ˜¯éæŠ€æœ¯ç”¨æˆ·ä¹Ÿå¯ä»¥è½»æ¾ä¸Šæ‰‹.
- **å¼€æº**ï¼š AdGuard Home æ˜¯å¼€æºè½¯ä»¶, è¿™æ„å‘³ç€æ‚¨å¯ä»¥æŸ¥çœ‹å…¶æºä»£ç , å¹¶æ ¹æ®è‡ªå·±çš„éœ€æ±‚è¿›è¡Œä¿®æ”¹å’Œæ‰©å±•.

R2S çš„ OpenWrt å›ºä»¶è‡ªå¸¦ **AdGuard Home** æœåŠ¡, ç›®å‰ä¸»è¦ç”¨æ¥æ‹¦æˆªå¹¿å‘Š.

---

#### OpenClash

[OpenClash](https://github.com/vernesong/OpenClash) æ˜¯ä¸€ä¸ªåŸºäº OpenWrt çš„ **Clash** å®¢æˆ·ç«¯æ’ä»¶, æ—¨åœ¨ä¸º OpenWrt è·¯ç”±å™¨ç”¨æˆ·æä¾›å¼ºå¤§çš„ç½‘ç»œä»£ç†ç®¡ç†åŠŸèƒ½. OpenClash æ”¯æŒå¤šç§ä»£ç†åè®®ï¼ˆå¦‚ VMessã€Shadowsocksã€Trojan ç­‰ï¼‰, å¹¶å…è®¸ç”¨æˆ·çµæ´»é…ç½®è§„åˆ™è¿›è¡Œæµé‡åˆ†æµ.

![20241229154732_tsSGCxrN.webp](https://cdn.dong4j.site/source/image/20241229154732_tsSGCxrN.webp)

**ç‰¹æ€§**:

- **å›¾å½¢åŒ–ç®¡ç†ç•Œé¢**ï¼šé€šè¿‡ OpenWrt çš„ Luci ç•Œé¢, ç”¨æˆ·å¯ä»¥è½»æ¾é…ç½®å’Œç®¡ç† Clash.

- **å¤šé…ç½®æ–‡ä»¶æ”¯æŒ**ï¼šå…è®¸ç”¨æˆ·åˆ‡æ¢å’Œç®¡ç†å¤šä¸ªä»£ç†é…ç½®æ–‡ä»¶.

- **å®æ—¶æ—¥å¿—ä¸è°ƒè¯•å·¥å…·**ï¼šä¾¿äºç”¨æˆ·æŸ¥çœ‹ä»£ç†è¿è¡ŒçŠ¶æ€å¹¶å¿«é€Ÿæ’æŸ¥é—®é¢˜.

- **è‡ªåŠ¨åŒ–æ›´æ–°**ï¼šæ”¯æŒè®¢é˜…é…ç½®æ–‡ä»¶å’Œè§„åˆ™çš„è‡ªåŠ¨æ›´æ–°, ä¿æŒæœ€æ–°ç½‘ç»œç¯å¢ƒ.

#### SmartDNS

[SmartDNS](https://github.com/pymumu/smartdns) ä¸€ä¸ªè¿è¡Œåœ¨æœ¬åœ°çš„ DNS æœåŠ¡å™¨, æ—¨åœ¨é€šè¿‡è·å–æœ€å¿«çš„ç½‘ç«™ IP åœ°å€æ¥æé«˜ç½‘ç»œè®¿é—®é€Ÿåº¦. å®ƒæ”¯æŒ DoH å’Œ DoT åè®®, å¹¶å…¼å®¹å¤šç§æ“ä½œç³»ç»Ÿ, å¦‚æ ‘è“æ´¾ã€OpenWrt å’Œ Windows.

![20241229154732_PmqxAXjC.webp](https://cdn.dong4j.site/source/image/20241229154732_PmqxAXjC.webp)

**ç‰¹æ€§**:

- **å¤šè™šæ‹Ÿ DNS æœåŠ¡å™¨**ï¼š æ”¯æŒå¤šä¸ªè™šæ‹Ÿ DNS æœåŠ¡å™¨, æ¯ä¸ªæœåŠ¡å™¨æ‹¥æœ‰ä¸åŒçš„ç«¯å£ã€è§„åˆ™å’Œå®¢æˆ·ç«¯, å®ç°ä¸åŒåœºæ™¯ä¸‹çš„éœ€æ±‚.
- **å¤š DNS ä¸Šæ¸¸æœåŠ¡å™¨**ï¼š æ”¯æŒé…ç½®å¤šä¸ªä¸Šæ¸¸ DNS æœåŠ¡å™¨, å¹¶è¡ŒæŸ¥è¯¢å¹¶è¿”å›è®¿é—®é€Ÿåº¦æœ€å¿«çš„è§£æç»“æœ, æé«˜æŸ¥è¯¢æ•ˆç‡å’Œå¯é æ€§.
- **å®¢æˆ·ç«¯ç‹¬ç«‹æ§åˆ¶**ï¼š æ”¯æŒåŸºäº MAC æˆ– IP åœ°å€æ§åˆ¶å®¢æˆ·ç«¯ä½¿ç”¨ä¸åŒçš„æŸ¥è¯¢è§„åˆ™, å®ç°å®¶é•¿æ§åˆ¶ç­‰åŠŸèƒ½.
- **è¿”å›æœ€å¿« IP åœ°å€**ï¼šåŸŸåæ‰€å± IP åœ°å€åˆ—è¡¨ä¸­æŸ¥æ‰¾è®¿é—®é€Ÿåº¦æœ€å¿«çš„ IP åœ°å€, å¹¶è¿”å›ç»™å®¢æˆ·ç«¯, æé«˜ç½‘ç»œè®¿é—®é€Ÿåº¦.
- **å¤šç§æŸ¥è¯¢åè®®**ï¼š æ”¯æŒ UDPã€TCPã€DOT å’Œ DOH æŸ¥è¯¢åŠæœåŠ¡, ä»¥åŠé 53 ç«¯å£æŸ¥è¯¢ï¼›æ”¯æŒé€šè¿‡ socks5, HTTP ä»£ç†æŸ¥è¯¢.
- **ç‰¹å®šåŸŸå IP åœ°å€æŒ‡å®š**ï¼š æ”¯æŒæŒ‡å®šåŸŸåçš„ IP åœ°å€, å®ç°å¹¿å‘Šè¿‡æ»¤ã€é¿å…æ¶æ„ç½‘ç«™ç­‰åŠŸèƒ½.
- **åŸŸåé«˜æ€§èƒ½åç¼€åŒ¹é…**ï¼šæŒåŸŸååç¼€åŒ¹é…æ¨¡å¼, ç®€åŒ–è¿‡æ»¤é…ç½®, è¿‡æ»¤æ•ˆç‡é«˜.
- **åŸŸååˆ†æµ**ï¼š æ”¯æŒåŸŸååˆ†æµ, ä¸åŒç±»å‹çš„åŸŸåå‘ä¸åŒçš„ DNS æœåŠ¡å™¨æŸ¥è¯¢, æ”¯æŒ iptable å’Œ nftable æ›´å¥½çš„åˆ†æµï¼›æ”¯æŒæµ‹é€Ÿå¤±è´¥çš„æƒ…å†µä¸‹è®¾ç½®åŸŸåç»“æœåˆ°å¯¹åº” ipset å’Œ nftset é›†åˆ.
- **å¤šå¹³å°æ”¯æŒ**ï¼š æ”¯æŒæ ‡å‡† Linux ç³»ç»Ÿï¼ˆæ ‘è“æ´¾ï¼‰ã€OpenWrt ç³»ç»Ÿå„ç§å›ºä»¶å’Œåç¡•è·¯ç”±å™¨åŸç”Ÿå›ºä»¶. æ”¯æŒ WSLï¼ˆWindows Subsystem for Linux, é€‚ç”¨äº Linux çš„ Windows å­ç³»ç»Ÿï¼‰.
- **IPv4ã€IPv6 åŒæ ˆ**ï¼š æ”¯æŒ IPv4 å’Œ IPV 6 ç½‘ç»œ, æ”¯æŒæŸ¥è¯¢ A å’Œ AAAA è®°å½•, æ”¯æŒåŒæ ˆ IP é€Ÿåº¦ä¼˜åŒ–, å¹¶æ”¯æŒå®Œå…¨ç¦ç”¨ IPv6 AAAA è§£æ.

---

#### PushBot

[PushBot](https://github.com/zzsj0928/luci-app-pushbot) æ”¯æŒå¤šç§æ¨é€æœåŠ¡, åŒ…æ‹¬é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ã€å¾®ä¿¡ã€é£ä¹¦ç­‰, å¹¶æä¾›è®¾å¤‡çŠ¶æ€ç›‘æ§ã€æµé‡ç»Ÿè®¡ç­‰åŠŸèƒ½.

![20241229154732_vrU8TQzI.webp](https://cdn.dong4j.site/source/image/20241229154732_vrU8TQzI.webp)

**é‡è¦äº®ç‚¹**:

- æ”¯æŒå¤šç§æ¨é€æœåŠ¡, åŒ…æ‹¬é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ã€å¾®ä¿¡ã€é£ä¹¦ç­‰.
- æä¾›è®¾å¤‡çŠ¶æ€ç›‘æ§ã€æµé‡ç»Ÿè®¡ç­‰åŠŸèƒ½.
- æ”¯æŒè®¾å¤‡åˆ«åã€ç™½åå•ã€åå•ç­‰è®¾ç½®.
- ä»£ç åŸºäº serverchan æä¾›çš„æ¥å£è¿›è¡Œå‘é€ä¿¡æ¯.

### R5S

#### WireGuard Easy

[WireGuard Easy](https://github.com/wg-easy/wg-easy) æ˜¯ä¸€ä¸ªåŸºäº Web ç•Œé¢çš„ **WireGuard** VPN ç®¡ç†å·¥å…·, æ—¨åœ¨ç®€åŒ– WireGuard æœåŠ¡å™¨çš„è®¾ç½®å’Œç®¡ç†. å®ƒæä¾›äº†ä¸€ä¸ªç”¨æˆ·å‹å¥½çš„ç•Œé¢, ä½¿ç”¨æˆ·èƒ½å¤Ÿè½»æ¾åˆ›å»ºã€ç®¡ç†å’Œç›‘æ§ WireGuard é…ç½®, è€Œæ— éœ€æ‰‹åŠ¨ç¼–è¾‘é…ç½®æ–‡ä»¶.

![20241229154732_AyoFVrAx.webp](https://cdn.dong4j.site/source/image/20241229154732_AyoFVrAx.webp)

**ç‰¹æ€§**:

- **ç®€åŒ–çš„ WireGuard é…ç½®ç®¡ç†**ï¼šé€šè¿‡ Web UI, ç”¨æˆ·å¯ä»¥è½»æ¾åœ°æ·»åŠ å’Œç®¡ç† WireGuard å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é…ç½®.

- **æ”¯æŒå¤šç”¨æˆ·ç®¡ç†**ï¼šå¯ä»¥ä¸ºå¤šä¸ªå®¢æˆ·ç«¯ç”Ÿæˆå’Œç®¡ç† WireGuard å¯†é’¥å¯¹, æ–¹ä¾¿åˆ†é…å’Œæ§åˆ¶è®¿é—®æƒé™.

- **å®æ—¶çŠ¶æ€ç›‘æ§**ï¼šæä¾› WireGuard è¿æ¥çŠ¶æ€çš„å®æ—¶æ›´æ–°å’Œæ—¥å¿—è®°å½•, å¸®åŠ©ç”¨æˆ·ç›‘æ§ VPN æœåŠ¡çš„è¿è¡ŒçŠ¶å†µ.

- **Docker æ”¯æŒ**ï¼šwg-easy å¯ä»¥é€šè¿‡ Docker å®¹å™¨éƒ¨ç½², ä¾¿äºè·¨å¹³å°ä½¿ç”¨.

---

#### Bark

[Bark](https://github.com/Finb/Bark) å…è®¸ç”¨æˆ·å°†è‡ªå®šä¹‰é€šçŸ¥æ¨é€åˆ°ä»–ä»¬çš„ iPhone. å®ƒå¯ä»¥å°†å„ç§ä¿¡æ¯, å¦‚çŸ­ä¿¡ã€é‚®ä»¶ã€ç¤¾äº¤åª’ä½“æ›´æ–°ç­‰, è½¬æ¢ä¸ºè¯­éŸ³æˆ–æ–‡å­—é€šçŸ¥, æ–¹ä¾¿ç”¨æˆ·åœ¨æ— æ³•æŸ¥çœ‹æ‰‹æœºæ—¶æ¥æ”¶é‡è¦ä¿¡æ¯.

Bark æ”¯æŒå¤šç§é€šçŸ¥æ–¹å¼, åŒ…æ‹¬ Pushoverã€IFTTTã€HTTP API ç­‰, å¹¶å¯ä»¥ä¸å„ç§åº”ç”¨ç¨‹åºå’ŒæœåŠ¡è¿›è¡Œé›†æˆ. ç”¨æˆ·å¯ä»¥é€šè¿‡ bark-server æ­å»ºè‡ªå·±çš„ [Bark æœåŠ¡å™¨](https://github.com/Finb/bark-server), å®ç°å®Œå…¨è‡ªæ‰˜ç®¡çš„è§£å†³æ–¹æ¡ˆ.

![20241229154732_nKrY4HMo.webp](https://cdn.dong4j.site/source/image/20241229154732_nKrY4HMo.webp)

ç›®å‰ä½¿ç”¨ Bark ä½œä¸ºæ¨é€æœåŠ¡çš„æœ‰:

- Uptime Kuma
- OpenWrt çš„ PushBot
- è„šæœ¬æ‰§è¡Œç»“æœæ¨é€
- æµè§ˆå™¨æ’ä»¶æ¨é€
- Synology NAS çš„ Webhook

**ç›¸å…³èµ„æº:**

- [Bar Server Markdown](https://github.com/adams549659584/bark-server)

---

### H28K

#### Linux Command

[Linux Command](https://github.com/jaywcjlove/linux-command) æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®, æ—¨åœ¨æ”¶é›†æ•´ç† Linux å‘½ä»¤æ‰‹å†Œã€è¯¦è§£ã€å­¦ä¹ èµ„æºç­‰å†…å®¹, å¹¶æä¾›æ–¹ä¾¿å¿«æ·çš„æœç´¢å·¥å…·. è¯¥é¡¹ç›®ç”± GitHub ç”¨æˆ· jaywcjlove ç»´æŠ¤, å¹¶ç”Ÿæˆäº†ä¸€ä¸ª Web ç½‘ç«™æ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨.

![20241229154732_etdTnBBP.webp](https://cdn.dong4j.site/source/image/20241229154732_etdTnBBP.webp)

**ä¸»è¦ç‰¹ç‚¹**ï¼š

- **å†…å®¹å…¨é¢**ï¼š æœé›†äº† 580 å¤šä¸ª Linux å‘½ä»¤, æ¶µç›–æ–‡ä»¶ç®¡ç†ã€æ–‡ä»¶ä¼ è¾“ã€å¤‡ä»½å‹ç¼©ã€ç£ç›˜ç®¡ç†ã€ç³»ç»Ÿè®¾ç½®ã€ç³»ç»Ÿç®¡ç†ã€æ–‡æœ¬å¤„ç†ç½‘ç»œé€šè®¯ã€è®¾å¤‡ç®¡ç†ã€ç”µå­é‚®ä»¶ä¸æ–°é—»ç»„ç­‰å¤šä¸ªæ–¹é¢.
- **æ–¹ä¾¿æœç´¢**ï¼š æä¾›å¼ºå¤§çš„æœç´¢åŠŸèƒ½, ç”¨æˆ·å¯ä»¥å¿«é€Ÿæ‰¾åˆ°æ‰€éœ€çš„å‘½ä»¤åŠå…¶ç›¸å…³ä¿¡æ¯.
- **å¤šç§ç‰ˆæœ¬**ï¼š æä¾›å¤šç§ç‰ˆæœ¬, åŒ…æ‹¬ Web ç‰ˆæœ¬ã€å¾®ä¿¡å°ç¨‹åºã€Chrome æ’ä»¶ã€Raycast ç‰ˆæœ¬ã€Alfred ç‰ˆæœ¬ã€Android ç‰ˆæœ¬ã€Mac/Win/Linux ç‰ˆæœ¬ç­‰, æ–¹ä¾¿ç”¨æˆ·åœ¨ä¸åŒå¹³å°ä¸Šä½¿ç”¨.
- **æ˜“äºéƒ¨ç½²**ï¼š æä¾›å¤šç§éƒ¨ç½²æ–¹å¼, Dockerã€Vercelã€å®å¡”é¢æ¿ç­‰, æ–¹ä¾¿ç”¨æˆ·è‡ªè¡Œéƒ¨ç½².

## HK1 Box

### Home Assistant

[Home Assistant](https://www.home-assistant.io/) ä¸€æ¬¾å¼€æºçš„æ™ºèƒ½å®¶å±…è‡ªåŠ¨åŒ–å¹³å°. å®ƒæ”¯æŒå¤šç§è®¾å¤‡å’ŒæœåŠ¡çš„é›†æˆ, æä¾›å¼ºå¤§çš„è‡ªåŠ¨åŒ–åŠŸèƒ½, å¹¶å¼ºè°ƒæœ¬åœ°æ§åˆ¶å’Œéšç§ä¿æŠ¤.

ç›®å‰è¿˜æ²¡æœ‰èŠ±å¤ªå¤šå¿ƒæ€å»åšé…ç½®:

![20241229154732_gdpIiGkb.webp](https://cdn.dong4j.site/source/image/20241229154732_gdpIiGkb.webp)

**é‡è¦äº®ç‚¹**

- **å¼€æºç¤¾åŒº**: ç”±å…¨çƒçˆ±å¥½è€…å’Œå¼€å‘è€…å…±åŒç»´æŠ¤.
- **è®¾å¤‡å…¼å®¹æ€§**: æ”¯æŒè¶…è¿‡ 1000 ç§è®¾å¤‡å’ŒæœåŠ¡çš„é›†æˆ.
- **è‡ªåŠ¨åŒ–åŠŸèƒ½**: å¯ä»¥æ ¹æ®æ—¶é—´ã€äº‹ä»¶å’Œæ¡ä»¶è‡ªåŠ¨æ§åˆ¶æ™ºèƒ½å®¶å±…è®¾å¤‡.
- **æœ¬åœ°æ§åˆ¶**: æ•°æ®å­˜å‚¨å’Œå¤„ç†å‡åœ¨æœ¬åœ°, ç¡®ä¿éšç§å®‰å…¨.
- **ç§»åŠ¨åº”ç”¨**: æä¾›å®˜æ–¹ç§»åŠ¨åº”ç”¨, æ–¹ä¾¿è¿œç¨‹æ§åˆ¶å’Œç›‘æ§.

### Node-RED

[Node-RED](https://nodered.org/) æ˜¯ä¸€ä¸ªåŸºäº Node.js çš„ä½ä»£ç ç¼–ç¨‹å¹³å°, æ—¨åœ¨ç®€åŒ–äº‹ä»¶é©±åŠ¨åº”ç”¨ç¨‹åºçš„å¼€å‘. å®ƒæä¾›ç›´è§‚çš„æµè§ˆå™¨ç¼–è¾‘å™¨, å…è®¸ç”¨æˆ·é€šè¿‡æ‹–æ”¾èŠ‚ç‚¹çš„æ–¹å¼è¿æ¥ç¡¬ä»¶ã€API å’Œåœ¨çº¿æœåŠ¡, æ„å»ºå¤æ‚çš„æµç¨‹. Node-RED é€‚ç”¨äºå„ç§åœºæ™¯, åŒ…æ‹¬ç‰©è”ç½‘ã€æ•°æ®é›†æˆå’Œè‡ªåŠ¨åŒ–ç­‰.

![20241229154732_fGEzcSLj.webp](https://cdn.dong4j.site/source/image/20241229154732_fGEzcSLj.webp)

**é‡ç‚¹äº®ç‚¹**:

- **ä½ä»£ç ç¼–ç¨‹å¹³å°**ï¼š Node-RED æ˜¯ä¸€ä¸ªç”¨äºäº‹ä»¶é©±åŠ¨çš„åº”ç”¨ç¨‹åºçš„ä½ä»£ç ç¼–ç¨‹å¹³å°, å®ƒå…è®¸ç”¨æˆ·é€šè¿‡å›¾å½¢ç•Œé¢è¿æ¥å„ç§ç¡¬ä»¶è®¾å¤‡ã€API å’Œæ•°æ®æº.
- **å¯è§†åŒ–ç¼–ç¨‹**ï¼š ç”¨æˆ·å¯ä»¥é€šè¿‡æ‹–æ”¾èŠ‚ç‚¹æ¥æ„å»ºåº”ç”¨ç¨‹åº, æ— éœ€ç¼–å†™ä»£ç , è¿™é™ä½äº†å¼€å‘éš¾åº¦, å¹¶æé«˜äº†å¼€å‘æ•ˆç‡.
- **å¹¿æ³›çš„åº”ç”¨åœºæ™¯**ï¼š Node-RED å¯ç”¨äºå„ç§åœºæ™¯, ä¾‹å¦‚ç‰©è”ç½‘ã€è‡ªåŠ¨åŒ–ã€æ•°æ®åˆ†æç­‰.
- **å¼€æºé¡¹ç›®** Node-RED æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®, ç”± OpenJS Foundation ç»´æŠ¤.
- **æ´»è·ƒç¤¾åŒº**ï¼š Node-RED æ‹¥æœ‰ä¸€ä¸ªæ´»è·ƒçš„ç¤¾åŒº, ç”¨æˆ·å¯ä»¥åœ¨è¿™é‡Œè·å–å¸®åŠ©ã€åˆ†äº«ç»éªŒå’Œè´¡çŒ®ä»£ç .
- **ä¸°å¯Œçš„èŠ‚ç‚¹åº“**ï¼š Node-RED æä¾›äº†ä¸°å¯Œçš„èŠ‚ç‚¹åº“, ç”¨æˆ·å¯ä»¥ä»ä¸­é€‰æ‹©æ‰€éœ€çš„èŠ‚ç‚¹æ¥æ„å»ºåº”ç”¨ç¨‹åº.
- **è·¨å¹³å°**ï¼š Node-RED æ”¯æŒå¤šç§æ“ä½œç³»ç»Ÿ, åŒ…æ‹¬ Windowsã€Linux å’Œ macOS.

---

## å…¶ä»–æœåŠ¡

### Captive Portal æ£€æµ‹æœåŠ¡

å¤§å®¶è‚¯å®šéƒ½è¿è¿‡å…¬å…±åœºæ‰€çš„ wifi çƒ­ç‚¹, æ¯”å¦‚éº¦å½“åŠ³ç­‰åœ°æ–¹çš„. ä»–ä»¬çš„ wifi å¾€å¾€ä¸€è¿ä¸Šå»å°±ä¼šå¼¹å‡ºä¸€ä¸ªè¦æ±‚ç™»å½•æˆ–è€…å¾®ä¿¡å…³æ³¨ä¹‹ç±»çš„é¡µé¢, åªæœ‰åœ¨è¿™ä¸ªé¡µé¢å®Œæˆæ“ä½œäº†æ‰èƒ½æ­£å¸¸è®¿é—®ç½‘ç»œçš„. ä¹‹å‰çœ‹åˆ°è¿™ä¸ªå¾ˆç¥å¥‡, ä¸ºä»€ä¹ˆä¸€è¿ wifi, æ‰‹æœºå°±ä¼šè‡ªåŠ¨æ‰“å¼€è¿™ä¸ªç½‘é¡µçš„, å°±çŸ¥é“ android ç³»ç»Ÿåº”è¯¥æ˜¯æä¾›äº†ä¸€äº›æ¥å£çš„. æœ€è¿‘æ¥è§¦åˆ°è¿™ä¸ª, æŸ¥äº†ä¸€ä¸‹æ‰çŸ¥é“è¿™ä¸ªä¸œè¥¿å«åš `captive portal`, å°±æ˜¯ä¸“é—¨ç”¨æ¥ç»™åç«¯çš„ç½‘å…³æä¾›é‰´æƒè®¡è´¹ä¹‹ç±»çš„æœåŠ¡çš„. å¾ˆå¤šå…¬å…±åœºåˆçš„ wifi çƒ­ç‚¹åº”è¯¥éƒ½ç”¨äº†è¿™ä¹ˆä¸€ä¸ªæŠ€æœ¯, æ¯”å¦‚é…’åº—, å•†åœº, é“¶è¡Œç­‰ç­‰.

`Captive Portal` çš„ä½œç”¨å°±æ˜¯æ£€æµ‹ç½‘ç»œçš„è¿é€šæ€§, è¿™ä¸ªåœ¨åˆ†æµè§„åˆ™ä¸­éå¸¸å¸¸è§, ä¸‹é¢æ˜¯ä¸€äº›å¸¸ç”¨çš„ `Captive Portal` ç«™ç‚¹:

| æœåŠ¡æä¾›è€… | é“¾æ¥                                                       | å¤§é™†ä½“éªŒ | å¢ƒå¤–ä½“éªŒ | http/https | IP Version |
| ---------- | ---------------------------------------------------------- | -------- | -------- | ---------- | ---------- |
| Google     | http://www.gstatic.com/generate_204                        | 5        | 10       | 204/204    | 4+6        |
| Google     | http://www.google-analytics.com/generate_204               | 6        | 10       | 204/204    | 4+6        |
| Google     | http://www.google.com/generate_204                         | 0        | 10       | 204/204    | 4+6        |
| Google     | http://connectivitycheck.gstatic.com/generate_204          | 4        | 10       | 204/204    | 4+6        |
| Apple      | [http://captive.apple.com](http://captive.apple.com/)      | 3        | 10       | 200/200    | 4+6        |
| Apple      | http://www.apple.com/library/test/success.html             | 7        | 10       | 200/200    | 4+6        |
| MicroSoft  | http://www.msftconnecttest.com/connecttest.txt             | 5        | 10       | 200/error  | 4          |
| Cloudflare | http://cp.cloudflare.com/                                  | 4        | 10       | 204/204    | 4+6        |
| Firefox    | http://detectportal.firefox.com/success.txt                | 5        | 10       | 200/200    | 4+6        |
| V2ex       | http://www.v2ex.com/generate_204                           | 0        | 10       | 204/301    | 4+6        |
| å°ç±³       | http://connect.rom.miui.com/generate_204                   | 10       | 4        | 204/204    | 4          |
| åä¸º       | http://connectivitycheck.platform.hicloud.com/generate_204 | 10       | 5        | 204/204    | 4          |
| Vivo       | http://wifi.vivo.com.cn/generate_204                       | 10       | 5        | 204/204    | 4          |

æˆ‘çš„ç›®çš„æ˜¯æ£€æµ‹ WireGuard æ˜¯å¦èƒ½è¿æ¥å®¶ä¸­çš„ç½‘ç»œ, æ‰€ä»¥å‡†å¤‡åœ¨å®¶ä¸­çš„æŸå°æœåŠ¡å™¨ä¸Šè‡ªå»ºä¸€ä¸ª `Captive Portal` æœåŠ¡, å‡å°‘å¤–éƒ¨ç½‘ç»œçš„ä¾èµ–.

ç›´æ¥åœ¨ Nginx é…ç½®ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹å³å¯:

```ini
server {
    listen   80;
    listen   443 ssl http2;
    server_name  your.domain.name;
    location = /generate_204 {
    return   204;
    }
}
```

æ¯”å¦‚ `Captive Portal` æœåŠ¡éƒ¨ç½²åœ¨å®¶ä¸­çš„ `192.168.10.33` æœåŠ¡å™¨ä¸Š, æµ‹è¯•ä¸º:

```bash
$ curl -i 192.168.10.33/generate_204
HTTP/1.1 204 No Content
Server: openresty
Date: Tue, 03 Dec 2024 14:17:49 GMT
Connection: keep-alive
```

ç„¶åå°±å¯ä»¥åœ¨ **Surge** çš„ `proxy` é…ç½®ä¸­ä½¿ç”¨, æ¯”å¦‚:

```
ğŸŒ¤ï¸ H28K = wireguard, section-name=H28K, test-url=http://192.168.10.33/generate_204, ip-version=v4-only
```

`test-url` è¡¨ç¤º **Surge** ä¼šé€šè¿‡æ­¤åœ°å€å»æµ‹è¯• **WireGuard** éš§é“æ˜¯å¦æ­£å¸¸(å› ä¸º **WireGuard** ä¹Ÿéƒ¨ç½²åœ¨å†…ç½‘, **Surge** ä¼šå°†æµé‡é€šè¿‡ **WireGuard** å‘é€åˆ° `192.168.10.33/generate_204`, æ‰€ä»¥åªè¦èƒ½å¤Ÿæµ‹è¯•é€šè¿‡å°±ä»£è¡¨éš§é“æ˜¯é€šç•…çš„.

åœ¨æ²¡æœ‰è‡ªå»º `Captive Portal` æœåŠ¡ä¹‹å‰, æˆ‘éƒ½æ˜¯é€šè¿‡è®¿é—®å°ç±³è·¯ç”±å™¨çš„ WebUI æ¥æ£€æµ‹ç½‘ç»œæ˜¯å¦æ­£å¸¸, ä½†æ˜¯è¾ƒå¤šçš„å“åº”å†…å®¹ä¼šå¢åŠ æµ‹è¯•çš„å»¶è¿Ÿ, æ‰€ä»¥å°±ä½¿ç”¨äº†ä¸Šè¿°æ–¹å¼æ¥ä¼˜åŒ–.

<!--

https://www.cnblogs.com/chenxiaomeng/p/11993741.html

-->

---

### å…¬ç½‘ IP è·å–æœåŠ¡

å› ä¸ºä½¿ç”¨åˆ«å®¶çš„æœåŠ¡æ¥ç»™ DDNS-GO ä¼šå‡ºç°é™æµçš„æƒ…å†µ, æ‰€ä»¥åœ¨ ECS ä¸Šè‡ªè¡Œéƒ¨ç½²äº†ä¸€ä¸ªè¿™æ ·çš„æœåŠ¡.

#### è·å– JSON æ ¼å¼

```ini
server {
   listen 80;
   listen [::]:80;

   listen 443 ssl http2;
   listen [::]:443 ssl http2;

   # ç”¨ä»¥æ”¯æŒ HTTP/3, è‹¥æ‰€ç”¨ Nginx ç‰ˆæœ¬æ”¯æŒ HTTP/3, å¯å»æ‰æ³¨é‡Š
   # listen 443 http3;
   # listen [::]:443 http3;

   server_name ipv4.ddnsip.cn ipv6.ddnsip.cn ddnsip.cn;

   # ç”¨ä»¥æ”¯æŒ HTTP/3, è‹¥æ‰€ç”¨ Nginx ç‰ˆæœ¬æ”¯æŒ HTTP/3, å¯å»æ‰æ³¨é‡Š
   # add_header Alt-Svc 'h3=":443"; ma=86400';

   # HSTS
   add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload";

   # å…è®¸è·¨åŸŸï¼ˆåœ¨å…¶ä»–ç«™ç‚¹è°ƒç”¨æ¥å£ä¼šç”¨åˆ°ï¼‰
   add_header Access-Control-Allow-Origin *;
   add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept";
   add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";

   # è·å– IP åœ°å€
   location / {
       default_type application/json;
       return 200 '{"ip":"$remote_addr"}';
       # è‹¥ä½¿ç”¨ CDN è¯·å°†$remote_addræ”¹ä¸º$http_x_forwarded_for
     }

   # è¯ä¹¦é…ç½®
   ssl_certificate /root/.acme.sh/*.ddnsip.cn/fullchain.cer;
   ssl_certificate_key /root/.acme.sh/*.ddnsip.cn/*.ddnsip.cn.key;
   ssl_session_timeout 5m;
   ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;
   ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
   ssl_prefer_server_ciphers on;
}
```

#### è·å–çº¯æ–‡æœ¬

```ini
server {
   listen 80;
   listen [::]:80;

   listen 443 ssl http2;
   listen [::]:443 ssl http2;

   # ç”¨ä»¥æ”¯æŒ HTTP/3, è‹¥æ‰€ç”¨ Nginx ç‰ˆæœ¬æ”¯æŒ HTTP/3, å¯å»æ‰æ³¨é‡Š
   # listen 443 http3;
   # listen [::]:443 http3;

   server_name ipv4.ddnsip.cn ipv6.ddnsip.cn ddnsip.cn;

   # ç”¨ä»¥æ”¯æŒ HTTP/3, è‹¥æ‰€ç”¨ Nginx ç‰ˆæœ¬æ”¯æŒ HTTP/3, å¯å»æ‰æ³¨é‡Š
   # add_header Alt-Svc 'h3=":443"; ma=86400';

   # HSTS
   add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload";

   # è·å– IP åœ°å€
   location / {
       default_type text/plain;
       return 200 $remote_addr;
       # è‹¥ä½¿ç”¨ CDN è¯·å°†$remote_addræ”¹ä¸º$http_x_forwarded_for
     }

   # è¯ä¹¦é…ç½®
   ssl_certificate /root/.acme.sh/*.ddnsip.cn/fullchain.cer;
   ssl_certificate_key /root/.acme.sh/*.ddnsip.cn/*.ddnsip.cn.key;
   ssl_session_timeout 5m;
   ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;
   ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
   ssl_prefer_server_ciphers on;
}
```

è¿™æœ‰ç°æˆçš„:

- [https://www.ddnsip.cn/](https://www.ddnsip.cn/)
- [https://ip.ddnsip.cn/](https://ip.ddnsip.cn/)

---

### åˆ†æµè§„åˆ™æœåŠ¡

æˆ‘æœ‰å¤šç§å®¢æˆ·ç«¯ä¸”åœ¨å¤šä¸ªåœ°æ–¹éœ€è¦ç”¨åˆ°åˆ†æµè§„åˆ™:

- Surge

- OpenClash
- å…¶ä»–ç»ˆç«¯ä¸Šçš„ Clash

ä¸ºäº†ç®€åŒ–è§„åˆ™çš„ç®¡ç†, éœ€è¦ä¸€ä¸ªé›†ä¸­ç®¡ç†åˆ†æµè§„åˆ™å’Œè§„åˆ™è½¬æ¢çš„æœåŠ¡, ç›®å‰é€‰æ‹© [Subconverter Web](https://github.com/CareyWang/sub-web) + [Sub-Store](https://github.com/sub-store-org/Sub-Store) ç»“åˆçš„æ–¹å¼æ¥å®Œæˆè§„åˆ™ç»Ÿä¸€ç®¡ç†ä¸è§„åˆ™è½¬æ¢.

#### é€»è¾‘å›¾

![sub.drawio.svg](https://cdn.dong4j.site/source/image/sub.drawio.svg)

1. `Subconverter Server` ä½œä¸ºè§„åˆ™è½¬æ¢æœåŠ¡, å¯ä»¥æ ¹æ®é…ç½®ç”Ÿæˆé…ç½®æ–‡ä»¶, å¯é€‰æ‹©å®¢æˆ·ç«¯ç±»å‹ä»¥åŠè¿œç¨‹é…ç½®:

   ![20241229154732_VfhO8Aar.webp](https://cdn.dong4j.site/source/image/20241229154732_VfhO8Aar.webp)

   - å¯ä»¥é¢„å…ˆè®¾ç½®å‡ ä¸ªå¸¸ç”¨çš„é…ç½®, è€Œ **è‡ªå®šä¹‰è¿œç¨‹é…ç½®åœ°å€** å¯ä»¥ç›´æ¥ä½¿ç”¨ Nginx æ­å»ºä¸€ä¸ªé™æ€ç½‘ç«™, éšæ—¶ä¿®æ”¹è§„åˆ™;
   - è½¬æ¢åå¯ä»¥ä½¿ç”¨ **MyUrls** çŸ­é“¾æœåŠ¡è‡ªåŠ¨ç”ŸæˆçŸ­é“¾æ¥, æ–¹ä¾¿åˆ†äº«ä¸ä½¿ç”¨;

2. å‚æ•°ä¸­å¯è®¾ç½®: Emoji, æ˜¯å¦å¼€å¯ UDP, æ’åºèŠ‚ç‚¹, **å…³é—­è¯ä¹¦æ£€æŸ¥** ä»¥åŠæ˜¯å¦åªè¿”å›èŠ‚ç‚¹åˆ—è¡¨.
   å› ä¸ºæœ‰äº›è®¢é˜…åœ°å€å¦‚æœè¯ä¹¦è¿‡æœŸ, sub-store ä¼šæ— æ³•è§£æ, æ‰€ä»¥éœ€è¦å…ˆä½¿ç”¨ `Subconverter Server` å¤„ç†ä¸€æ¬¡(å…³é—­è¯ä¹¦æ£€æŸ¥), ç„¶åå°†çŸ­é“¾æ¥ç»™åˆ° `sub-store` ä½¿ç”¨.

3. è½¬æ¢åçš„çŸ­é“¾æ¥ä¼šç›´æ¥é…ç½®åˆ° Clash å’Œ OpenClash ä¸­, ä¿è¯å¤šç«¯è§„åˆ’ä¸€è‡´;
4. sub-store ä¸»è¦ä½œç”¨æ˜¯æ”¶é›†æ•´ç†è®¢é˜…åœ°å€è¿”å›çš„èŠ‚ç‚¹åˆ—è¡¨, è™½ç„¶ `Subconverter Server` ä¹Ÿæ”¯æŒè¿™ä¸ªåŠŸèƒ½, ä½†æ˜¯`sub-store` æ‹¥æœ‰æ›´å¤šçš„èŠ‚ç‚¹é…ç½®åŠŸèƒ½, æ¯”å¦‚ æ­£åˆ™è¿‡æ»¤, åŒºåŸŸè¿‡æ»¤, æ­£åˆ™åˆ é™¤, èŠ‚ç‚¹å»é‡ç­‰ç­‰åŠŸèƒ½:
   ![20241229154732_wQmAUaFA.webp](https://cdn.dong4j.site/source/image/20241229154732_wQmAUaFA.webp)

5. `sub-store` å¤„ç†åçš„èŠ‚ç‚¹ä¼šç»™ Surge ä½¿ç”¨(Surge ç›®å‰æ˜¯å•ç‹¬çš„è§„åˆ™ä¸é…ç½®, ä¸»è¦æ˜¯ä¸»åŠ›æœºåœ¨ä½¿ç”¨, æ‰€ä»¥ç‰¹æ®Šçš„é…ç½®è¦å¤šä¸€äº›, è€Œ Clash å’Œ OpenClash åˆ™æ˜¯ç»™å†…ç½‘çš„è®¾å¤‡ä½¿ç”¨, è§„åˆ™ç›¸å¯¹ç®€å•ä¸€äº›, æ‰€ä»¥éœ€è¦ `Subconverter Server` å»ç»Ÿä¸€ç®¡ç†è§„åˆ™, é¿å…é‡å¤æ“ä½œ), `policy-path` ä¸­é…ç½® `sub-store` çš„èŠ‚ç‚¹åœ°å€å³å¯:

   ![20241229154732_e22kWb9J.webp](https://cdn.dong4j.site/source/image/20241229154732_e22kWb9J.webp)

6. `sub-store` ä¼šåœ¨å¤šå°æœåŠ¡å™¨ä¸Šéƒ¨ç½², ç„¶åä½¿ç”¨ Nginx æ¥è¿›è¡Œè´Ÿè½½, è€Œ `sub-store` çš„æ•°æ®æ–‡ä»¶åˆ™é€šè¿‡ **Syncthing** åœ¨åŠ¨æ€æœåŠ¡å™¨ä¹‹é—´åŒæ­¥;
7. `sub-store` è¿˜æœ‰ä¸€ä¸ª Surge ç‰ˆæœ¬, éœ€è¦åœ¨ Surge å®¢æˆ·ç«¯ä¸Šå®‰è£…ç›¸åº”çš„æ¨¡å—, ç›®å‰ç”¨çš„æ¯”è¾ƒå°‘, ä¸»è¦æ˜¯å› ä¸ºä¼šå­˜åœ¨å¾ªç¯ä¾èµ–é—®é¢˜: æ›´æ–°é…ç½®éœ€è¦å¼€å¯ä»£ç†, è€Œå¼€ä»£ç†åˆå¿…é¡»å…ˆå¾—æ›´æ–°é…ç½®.....

#### éƒ¨ç½²

`Subconverter Web`, `Subconverter Server` å’Œ `MyUrls` å¯é€šè¿‡ [docker-compose ä¸€é”®éƒ¨ç½²](https://github.com/stilleshan/dockerfiles/tree/main/sub).

å¦‚æœåªéœ€è¦åœ¨å†…ç½‘ä½¿ç”¨, è®°å¾—ä¿®æ”¹ä¸€ä¸‹ `config.js` ä¸­çš„ `apiUrl` å’Œ `shortUrl`, docker-compose.yml ä¸­çš„ `myurls.environment.MYURLS_DOMAIN` ä¹Ÿè¦åšç›¸åº”ä¿®æ”¹.

å¯ä»¥æŒ‚è½½ä¸‹é¢çš„ç›®å½•, æ–¹ä¾¿ä¿®æ”¹è§„åˆ™ä¸å…¶ä»–é…ç½®:

```yaml
services:
  subconverter:
    image: stilleshan/sub
    container_name: sub
    volumes:
      - ./conf:/usr/share/nginx/html/conf
      # è§„åˆ™æ‰€åœ¨ç›®å½•
      - ./data/subconverter:/base
      - ./data/subweb:/usr/share/nginx/html
    ...
```

`Sub-Store` docker-compose éƒ¨ç½²:

```yaml
version: "3"
services:
  sub-store:
    image: instartlove/sub-store
    container_name: sub-store
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./data/root.json:/app/root.json
      - ./data/sub-store.json:/app/sub-store.json
```

#### ä½¿ç”¨æ–¹å¼

`Subconverter` å’Œ `Sub-Store` çš„åŠŸèƒ½ä¾§é‡ç‚¹ä¸ä¸€æ ·, å¯ä»¥è¯´æ˜¯ç›¸è¾…ç›¸æˆçš„, å¯ä»¥æ€»ç»“ä¸º:

1. é Surege å®¢æˆ·ç«¯ä½¿ç”¨ `Subconverter` ç»Ÿä¸€è§„åˆ™;
2. Surege å®¢æˆ·ç«¯åªä½¿ç”¨ `Sub-Store` èŠ‚ç‚¹å¤„ç†åŠŸèƒ½;
3. `Subconverter` å¤„ç† `Sub-Store` æ— æ³•è§£æçš„ HTTPS è¯ä¹¦å¤±æ•ˆçš„è®¢é˜…åœ°å€;

æ‰€ä»¥ä¼šç»“åˆä¸¤è€…çš„ä¼˜ç‚¹ä¸ä¾§é‡ç‚¹æŒ‰åœºæ™¯ä½¿ç”¨:

1. `Sub-Store` ä½¿ç”¨åŸå§‹è®¢é˜…åœ°å€å¤„ç†èŠ‚ç‚¹åˆ—è¡¨, æä¾›ç»™ Surge å®¢æˆ·ç«¯ä½¿ç”¨;
2. å¦‚æœ HTTPS è¯ä¹¦å¤±æ•ˆ, ä¼šå°†åŸå§‹è®¢é˜…åœ°å€å…ˆä½¿ç”¨ `Subconverter` å¤„ç†ä¸€æ¬¡, å‚æ•°ä½¿ç”¨ **å…³é—­è¯ä¹¦æ£€æŸ¥** å¹¶åªè¿”å›èŠ‚ç‚¹åˆ—è¡¨, ç„¶åå°†çŸ­é“¾æ¥ç»™åˆ° `Sub-Store` ä½¿ç”¨;
3. `Subconverter` ä½¿ç”¨ `Sub-Store` å¤„ç†åçš„èŠ‚ç‚¹åˆ—è¡¨, é…åˆè‡ªå®šä¹‰è§„åˆ™ç”Ÿæˆ `Clash` å’Œ `OpenClash` çš„é€šç”¨é…ç½®, ä¿è¯ä¸¤ç«¯è§„åˆ™ä¸€è‡´;

`Sub-Store` å’Œ `Subconverter` åŒæ—¶å…·å¤‡å°†å¤šä¸ªè®¢é˜…åœ°å€åˆå¹¶ä¸ºåŒä¸€ä¸ªé…ç½®çš„åŠŸèƒ½(ç»„åˆè®¢é˜…), æˆ‘çš„æ–¹å¼æ˜¯åœ¨ `Sub-Store` ä¸­å°†èŠ‚ç‚¹åˆå¹¶, ç„¶åå°†åˆå¹¶åçš„èŠ‚ç‚¹åˆ—è¡¨ç»™åˆ° `Subconverter` , æ ¹æ®å®¢æˆ·ç«¯ç±»å‹é€‰æ‹©ä¸åŒçš„è§„åˆ™ç”Ÿæˆé…ç½®æ–‡ä»¶:

![20241229154732_7f0XSl03.webp](https://cdn.dong4j.site/source/image/20241229154732_7f0XSl03.webp)

#### ä½¿ç”¨åœºæ™¯

æ¯”å¦‚æˆ‘æœ‰ 3 ä¸ªè®¢é˜…åœ°å€, åˆ†åˆ«æ˜¯ A, B, C, å…¶ä¸­ C çš„ HTTPS è¯ä¹¦è¿‡æœŸ, ä»¥åŠä¸€ä¸ªè‡ªå®šä¹‰çš„ home èŠ‚ç‚¹åˆ—è¡¨:

![20241229154732_OFztI62Y.webp](https://cdn.dong4j.site/source/image/20241229154732_OFztI62Y.webp)

åˆ†åˆ«åœ¨ä¸åŒåœºæ™¯ä¸‹ä½¿ç”¨ `Sub-Store` å’Œ `Subconverter`.

##### åœ¨å…¬å¸çš„è®¾å¤‡ä¸Šä½¿ç”¨

![sub-company.drawio.svg](https://cdn.dong4j.site/source/image/sub-company.drawio.svg)

å…¬å¸çš„è®¾å¤‡(R2S) éœ€è¦è®¿é—®å®¶ä¸­çš„ç½‘ç»œä¸å¤–ç½‘, æ‰€ä»¥ä½¿ç”¨äº† AIO + è‡ªå®šä¹‰ Home èŠ‚ç‚¹åˆ—è¡¨, ç„¶åä½¿ç”¨ `Subconverter` çš„ç»„åˆè®¢é˜…åŠŸèƒ½ç”Ÿæˆæœ€ç»ˆé…ç½®.

##### åœ¨å®¶ä¸­çš„è®¾å¤‡ä¸Šä½¿ç”¨

å®¶ä¸­çš„è®¾å¤‡ä¸éœ€è¦ Home èŠ‚ç‚¹, æ‰€ä»¥ç›´æ¥æ˜¯ç”¨ AIO èŠ‚ç‚¹åˆ—è¡¨, ç„¶åä½¿ç”¨ `Subconverter` ç”Ÿæˆæœ€ç»ˆé…ç½®.

##### åœ¨ Surge å®¢æˆ·ç«¯ä¸Šä½¿ç”¨

Surge åªéœ€è¦ AIO èŠ‚ç‚¹åˆ—è¡¨, ä¸éœ€è¦ `Subconverter` ç”Ÿæˆé…ç½®.

#### é…ç½®åŒæ­¥

é…ç½®åŒæ­¥åªä¼šæ¶‰åŠåˆ° `Sub-Store`, å®ƒè‡ªå¸¦é€šè¿‡ `Gist` åŒæ­¥, ä½†æ˜¯éœ€è¦æ‰‹åŠ¨ç‚¹å‡»ä¸‹è½½æ‰èƒ½åŒæ­¥, å› ä¸ºæˆ‘åœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šéƒ½éƒ¨ç½²äº† `Sub-Store` , æ‰€ä»¥è¿™ç§åŒæ­¥æ–¹å¼ä¸å¤ªä¼˜é›….

`Sub-Store` å®¹å™¨æš´éœ²å‡ºæ¥æ–‡ä»¶åªæœ‰ 2 ä¸ª, `root.json`æ˜¯èŠ‚ç‚¹é…ç½®, `sub-store.json` æ˜¯æœåŠ¡é…ç½®, æ‰€ä»¥æˆ‘åªéœ€è¦å°†è¿™ 2 ä¸ªæ–‡ä»¶åŒæ­¥åˆ°å…¶ä»–æœåŠ¡å™¨å³å¯, æœ€æ–¹ä¾¿çš„å°±æ˜¯æ˜¯ç”¨ **Syncthing**.

> **Syncthing** ç›¸å…³çš„æ•°æ®åŒæ­¥æ–¹æ¡ˆå°†åœ¨ [[homelab-data|æ•°æ®ç¯‡]] è¯¦ç»†ä»‹ç».

---

### ç½‘ç»œ

#### è¿é€šæ€§æ£€æŸ¥

é€šè¿‡ Ping å»æ£€æµ‹ç½‘ç»œæ˜¯å¦æ­£å¸¸, å¦‚æœä¸æ­£å¸¸å°±è¦é€šçŸ¥ Uptime Kuma

```bash
#!/bin/bash

# æ£€æµ‹ç½‘ç»œæ˜¯å¦ç•…é€š
function ping_domain() {
    # pingçš„åŸŸåæˆ–è€…DNS(é˜¿é‡Œäº‘çš„)
    local domain=223.5.5.5
    # pingçš„æ¬¡æ•°
    local tries=6
    # è¯·æ±‚æˆåŠŸæ¬¡æ•°
    local packets_responded=0

    for i in $(seq 1 $tries); do
        if ping -c 1 $domain >/dev/null; then
            ((packets_responded++))
            sleep 1
        fi
    done

    # å¦‚æœè¯·æ±‚æˆåŠŸæ€»æ¬¡æ•°å¤§äº2, åˆ™è¡¨ç¤ºæˆåŠŸ
    if [ $packets_responded -ge 2 ]; then
        echo "true"
    else
        echo "false"
    fi
}

# æ£€æµ‹ç½‘ç»œè¿æ¥å‡½æ•°
function check_network() {
    # å¦‚æœping 6æ¬¡è‡³å°‘æœ‰2æ¬¡åŒ…æœªå“åº”, åˆ™æ‰§è¡Œä¸€ä¸‹ä»£ç 
    if [ $(ping_domain) = "false" ]; then
        # å¦‚æœNæ— æ³•è¿æ¥ç½‘ç»œ, åˆ™é‡å¯ç½‘ç»œ
        echo "$(date '+%Y-%m-%d %H:%M:%S') ç½‘ç»œè¿æ¥å¤±è´¥"
        curl {uptime-kuma webhook}
    else
        echo "$(date '+%Y-%m-%d %H:%M:%S') ç½‘ç»œè¿æ¥æ­£å¸¸"
        curl {uptime-kuma webhook}
    fi
}

check_network

echo "$(date '+%Y-%m-%d %H:%M:%S') network æ£€æŸ¥å®Œæ¯•"
```

#### WireGuard æ£€æŸ¥

å¯ä»¥ä¼ å…¥ä¸åŒçš„ WireGuard ç«¯å£æ¥æ£€æµ‹å¤šä¸ª WireGuard æœåŠ¡, é¡ºå¸¦æ£€æµ‹ä¸€ä¸‹ IPSec æœåŠ¡.

```bash
#!/bin/sh

port=$1
# æ£€æŸ¥ WireGuard ç«¯å£æ˜¯å¦å­˜åœ¨
WireGuard=$(netstat -an | egrep ":${port}" | awk '$1 == "udp" && $NF == "0.0.0.0:*" {print $0}' | wc -l)
# æ£€æŸ¥ IPSec çš„ç«¯å£æ˜¯å¦å­˜åœ¨
IPSec=$(netstat -an | egrep ":4500" | awk '$1 == "udp" && $NF == "0.0.0.0:*" {print $0}' | wc -l)

if [ "$WireGuard" == 0 ]; then
    curl {uptime-kuma webhook}
else
    curl {uptime-kuma webhook}
fi

if [ "$IPSec" == 0 ]; then
    curl {uptime-kuma webhook}
else
    curl {uptime-kuma webhook}
fi
```

#### VPN æ£€æŸ¥

æ£€æŸ¥å¤–éƒ¨ç½‘ç»œæ˜¯å¦æ­£å¸¸

```bash
#!/bin/bash

# æ£€æµ‹ç½‘ç»œæ˜¯å¦ç•…é€š
function curl_domain() {
    http_code=$(curl -sIL --connect-timeout 5 -w "%{http_code}\n" -o /dev/null http://www.v2ex.com/generate_204)
    if [ "$http_code" != "204" ]; then
        echo 'OpenClash æœªæ­£å¸¸å·¥ä½œ'
        curl {uptime-kuma webhook}
    else
        echo 'OpenClash æ­£å¸¸'
        curl {uptime-kuma webhook}
    fi
}
curl_domain
```

## èµ„æºæ¨è

- [Awesome-Selfhosted](https://awesome-selfhosted.net/):

  åŒ…å«è¶…è¿‡ 1500 ä¸ªè‡ªæ‰˜ç®¡çš„å¼€æºè½¯ä»¶é¡¹ç›®, æ¶µç›–å„ç§é¢†åŸŸ, å¦‚åšå®¢ã€è®ºå›ã€ç¤¾äº¤åª’ä½“ã€é‚®ä»¶æœåŠ¡ã€æ•°æ®åº“ã€åŠå…¬è½¯ä»¶ã€åª’ä½“æœåŠ¡å™¨ã€æ¸¸æˆç­‰.

  ![20241229154732_fc7ddJ4c.webp](https://cdn.dong4j.site/source/image/20241229154732_fc7ddJ4c.webp)

- [Awesome Homelab](https://www.awesome-homelab.com/):

  æ”¶å½•è¶…è¿‡ 150 ä¸ªå¼€æºåº”ç”¨, æ¶µç›–æ™ºèƒ½å®¶å±…ã€å®éªŒå®¤å»ºè®¾ã€æ•ˆç‡æå‡ç­‰å¤šä¸ªæ–¹é¢.

  ![20241229154732_3zWlmZGe.webp](https://cdn.dong4j.site/source/image/20241229154732_3zWlmZGe.webp)

- [theme.park](https://theme-park.dev/):

  åŒ…å«å¤šæ¬¾è‡ªæ‰˜ç®¡æœåŠ¡ä¸»é¢˜:

  ![20241229154732_iG1943kQ.webp](https://cdn.dong4j.site/source/image/20241229154732_iG1943kQ.webp)

<!--

https://razeen.me/tags/homelab/page/3/

https://dao.fm/2024/05/14/%E7%A0%81%E5%86%9C%E6%85%8E%E5%85%A5-%E5%85%A5%E5%9D%91%E8%BD%AF%E8%B7%AF%E7%94%B1%EF%BC%8C%E9%80%80%E7%83%A7idc%EF%BC%8Chomelab%E6%8A%98%E8%85%BE%E8%AE%B0/


https://wiki-power.com/Homelab-%E8%BD%BB%E9%87%8F%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AE%A1%E7%90%86%E9%9D%A2%E6%9D%BFCasaOS/
https://chi.miantiao.me/posts/homelab-services/

-->

<!--

TODO List

- æ•´ç†å¾®ä¿¡æ”¶è—çš„æ–‡ç« , è¾“å‡º AI ç›¸å…³çš„æ–‡æ¡£
- æ•´ç† GitHub æ˜Ÿæ ‡
- B ç«™æ”¶è—æ•´ç†
- Bark é—®é¢˜å¤„ç†
- Uptime Kuma é—®é¢˜å¤„ç†
- Homepage é…ç½®
- å“ªå’é¢æ¿é…ç½®

-->

**ç›¸å…³æ–‡ç« :**

1. [[homelab-guide|å…ˆå¯¼ç¯‡]]ï¼šæˆ‘çš„ HomeLab æ¦‚è¦;
2. [[homelab-hardware|ç¡¬ä»¶ç¯‡]]ï¼šä»‹ç»æˆ‘æ‰€æ‹¥æœ‰çš„ç¡¬ä»¶è®¾å¤‡;
3. [[homelab-network|ç½‘ç»œç¯‡]]ï¼šåŒ…æ‹¬ç½‘ç»œç¯å¢ƒã€å¼‚åœ°ç»„ç½‘ä¸ç½‘ç»œå®‰å…¨;
4. [[homelab-service|æœåŠ¡ç¯‡]]ï¼šä½¿ç”¨ Docker æ­å»ºçš„å„ç±»æœåŠ¡;
5. [[homelab-data|æ•°æ®ç¯‡]]ï¼šåŒ…æ‹¬æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆ;
6. [[homelab-data-sync|HomeLabæ•°æ®åŒæ­¥ï¼šæ„å»ºé«˜æ•ˆçš„æ•°æ®åŒæ­¥ç½‘ç»œ]]
7. [[homelab-data-backup|HomeLabæ•°æ®å¤‡ä»½ï¼šæ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿]]
8. [[homelab-upgrade-to-10g|HomeLab ç½‘ç»œç»­é›†ï¼šå‡çº§ 10G ç½‘ç»œ-å†æˆ˜ 10 å¹´]]
9. [[homelab-guide|NAT å†…ç½‘ç©¿é€è¯¦è§£ï¼šæ­ç§˜ç½‘ç»œè¿æ¥èƒŒåçš„å¥¥ç§˜]]

## [NAT å†…ç½‘ç©¿é€è¯¦è§£ï¼šæ­ç§˜ç½‘ç»œè¿æ¥èƒŒåçš„å¥¥ç§˜](https://blog.dong4j.site/posts/46fb4e89.md)

![/images/cover/20241229154732_ygRx9mbO.webp](https://cdn.dong4j.site/source/image/20241229154732_ygRx9mbO.webp)

## å‰è¨€

NAT (ç½‘ç»œåœ°å€è½¬æ¢, Network Address Translation) çš„ç”±æ¥ä¸äº’è”ç½‘çš„å‘å±•å†å²å¯†åˆ‡ç›¸å…³, ä¸»è¦æ˜¯ä¸ºäº†è§£å†³ IPv4 åœ°å€èµ„æºç´§å¼ é—®é¢˜, åŒæ—¶å¢å¼ºç½‘ç»œå®‰å…¨æ€§å’Œç®¡ç†çµæ´»æ€§.

**ç›¸å…³æ–‡ç« :**

1. [[homelab-guide|å…ˆå¯¼ç¯‡]]ï¼šæˆ‘çš„ HomeLab æ¦‚è¦;
2. [[homelab-hardware|ç¡¬ä»¶ç¯‡]]ï¼šä»‹ç»æˆ‘æ‰€æ‹¥æœ‰çš„ç¡¬ä»¶è®¾å¤‡;
3. [[homelab-network|ç½‘ç»œç¯‡]]ï¼šåŒ…æ‹¬ç½‘ç»œç¯å¢ƒã€å¼‚åœ°ç»„ç½‘ä¸ç½‘ç»œå®‰å…¨;
4. [[homelab-service|æœåŠ¡ç¯‡]]ï¼šä½¿ç”¨ Docker æ­å»ºçš„å„ç±»æœåŠ¡;
5. [[homelab-data|æ•°æ®ç¯‡]]ï¼šåŒ…æ‹¬æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆ;
6. [[homelab-data-sync|HomeLabæ•°æ®åŒæ­¥ï¼šæ„å»ºé«˜æ•ˆçš„æ•°æ®åŒæ­¥ç½‘ç»œ]]
7. [[homelab-data-backup|HomeLabæ•°æ®å¤‡ä»½ï¼šæ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿]]
8. [[homelab-upgrade-to-10g|HomeLab ç½‘ç»œç»­é›†ï¼šå‡çº§ 10G ç½‘ç»œ-å†æˆ˜ 10 å¹´]]
9. [[homelab-guide|NAT å†…ç½‘ç©¿é€è¯¦è§£ï¼šæ­ç§˜ç½‘ç»œè¿æ¥èƒŒåçš„å¥¥ç§˜]]

### èƒŒæ™¯ä¸ç”±æ¥

#### 1. IPv4 åœ°å€æ¯ç«­é—®é¢˜

IPv4 ä½¿ç”¨ 32 ä½åœ°å€ç©ºé—´, æœ€å¤šå¯ä»¥æä¾›çº¦ 43 äº¿ä¸ªå”¯ä¸€åœ°å€. éšç€äº’è”ç½‘çš„æ™®åŠ, è”ç½‘è®¾å¤‡æ•°é‡è¿…é€Ÿå¢é•¿, ç‰¹åˆ«æ˜¯ 1990 å¹´ä»£åæœŸ, åœ°å€åˆ†é…ç´§å¼ çš„é—®é¢˜æ„ˆå‘æ˜æ˜¾.

æ—©æœŸè§£å†³æ–¹æ¡ˆå¦‚å­ç½‘åˆ’åˆ†å’Œæ— ç±»åˆ«åŸŸé—´è·¯ç”± (CIDR) å»¶ç¼“äº†åœ°å€è€—å°½, ä½†å¹¶ä¸èƒ½å½»åº•è§£å†³é—®é¢˜.

#### 2. ç§æœ‰ç½‘ç»œéœ€æ±‚

- å¾ˆå¤šç»„ç»‡å’Œä¼ä¸šéœ€è¦å°†å¤§é‡å†…éƒ¨è®¾å¤‡è”ç½‘, ä½†æ²¡æœ‰è¶³å¤Ÿçš„å…¬æœ‰ IPv4 åœ°å€.
- [RFC 1918](https://www.rfc-editor.org/rfc/rfc1918) åœ¨ 1996 å¹´æå‡ºäº†ç§æœ‰åœ°å€æ ‡å‡†, ä¸ºå†…éƒ¨ç½‘ç»œé¢„ç•™äº†ä¸€äº›ä¸“ç”¨åœ°å€æ®µï¼š
  - `10.0.0.0/8`
  - `172.16.0.0/12`
  - `192.168.0.0/16`
- ç§æœ‰åœ°å€æ— æ³•ç›´æ¥é€šè¿‡äº’è”ç½‘é€šä¿¡, éœ€è¦ä¸€ä¸ªæœºåˆ¶å°†å…¶è½¬æ¢ä¸ºå…¬æœ‰åœ°å€.

#### 3. NAT çš„è¯ç”Ÿ

- NAT æ¦‚å¿µæœ€æ—©åœ¨ 1994 å¹´ç”± IETF æå‡º, è®°å½•åœ¨ [RFC 1631](https://www.rfc-editor.org/rfc/rfc1631) ä¸­, ä½œä¸ºä¸€ç§è§£å†³ IPv4 åœ°å€çŸ­ç¼ºé—®é¢˜çš„æ–¹æ³•.
- NAT å…è®¸å¤šä¸ªè®¾å¤‡é€šè¿‡ä¸€ä¸ªæˆ–å°‘é‡çš„å…¬æœ‰ IP åœ°å€è®¿é—®äº’è”ç½‘. å®ƒé€šè¿‡åœ¨è·¯ç”±å™¨æˆ–é˜²ç«å¢™ä¸Šä¿®æ”¹ IP æ•°æ®åŒ…çš„æºåœ°å€æˆ–ç›®æ ‡åœ°å€, å®ç°åœ°å€çš„æ˜ å°„.

### NAT çš„ä½œç”¨

1. **ç¼“è§£åœ°å€æ¯ç«­**: å†…éƒ¨è®¾å¤‡ä½¿ç”¨ç§æœ‰åœ°å€, å¤šä¸ªè®¾å¤‡å¯ä»¥å…±äº«ä¸€ä¸ªå…¬æœ‰åœ°å€è®¿é—®äº’è”ç½‘.
2. **æé«˜å®‰å…¨æ€§**: å¤–éƒ¨æ— æ³•ç›´æ¥è®¿é—®å†…éƒ¨è®¾å¤‡, å½¢æˆä¸€å®šçš„ç½‘ç»œéš”ç¦».
3. **ç½‘ç»œç®¡ç†çµæ´»æ€§**: ç»„ç»‡å†…éƒ¨åœ°å€å¯ä»¥è‡ªè¡Œè§„åˆ’, é¿å…æ›´æ”¹ ISP æ—¶éœ€è°ƒæ•´å†…éƒ¨ç½‘ç»œç»“æ„.

### NAT çš„ç±»å‹

1. **é™æ€ NAT**: ä¸€ä¸ªç§æœ‰åœ°å€æ˜ å°„åˆ°ä¸€ä¸ªå›ºå®šçš„å…¬æœ‰åœ°å€, å¸¸ç”¨äºéœ€è¦å¤–éƒ¨è®¿é—®çš„è®¾å¤‡.
2. **åŠ¨æ€ NAT**: ä¸€ç»„ç§æœ‰åœ°å€åŠ¨æ€æ˜ å°„åˆ°ä¸€ç»„å…¬æœ‰åœ°å€, åŸºäºéœ€æ±‚åˆ†é….
3. **ç«¯å£åœ°å€è½¬æ¢ (PAT/NAT Overload)**: ä½¿ç”¨å•ä¸ªå…¬æœ‰ IP åœ°å€, é€šè¿‡ç«¯å£å·åŒºåˆ†å¤šä¸ªå†…éƒ¨è®¾å¤‡çš„è¿æ¥, æ˜¯æœ€å¸¸è§çš„ NAT ç±»å‹.

### åç»­å‘å±•

- éšç€ **IPv6** çš„æ¨å‡º, NAT çš„è§’è‰²å¼€å§‹è¢«é‡æ–°å®¡è§†. IPv6 æä¾›äº† 128 ä½åœ°å€ç©ºé—´, å‡ ä¹å¯ä»¥ä¸ºæ¯å°è®¾å¤‡åˆ†é…ä¸€ä¸ªå”¯ä¸€åœ°å€.
- ç„¶è€Œ, ç”±äº IPv6 çš„éƒ¨ç½²è¿›å±•ç¼“æ…¢, NAT ä»ç„¶å¹¿æ³›åº”ç”¨äº IPv4 ç½‘ç»œ, å¹¶åœ¨åŒæ ˆç¯å¢ƒä¸‹ç»§ç»­æ‰®æ¼”é‡è¦è§’è‰².

---

### æ€»ç»“

NAT çš„è¯ç”Ÿå……åˆ†ä½“ç°äº†äº’è”ç½‘æ—©æœŸæŠ€æœ¯å¯¹ç°å®é—®é¢˜çš„çµæ´»åº”å¯¹. å³ä½¿æœªæ¥ IPv6 æ™®åŠ, NAT çš„æ¦‚å¿µåœ¨æŸäº›åœºæ™¯ (å¦‚éšç§ä¿æŠ¤) ä¸­ä»å¯èƒ½ä¿ç•™å…¶ä»·å€¼.

æ¥ä¸‹æ¥, æˆ‘å°†è¯¦ç»†ä»‹ç» NAT çš„å®ç°ç»†èŠ‚, åŒ…æ‹¬ NAT è¡¨çš„æ„å»ºã€åœ°å€è½¬æ¢è¿‡ç¨‹, ä»¥åŠå¦‚ä½•é€šè¿‡ NAT å®ç°å†…ç½‘ç©¿é€.

## æ¦‚è¿°

åœ¨æˆ‘ä»¬å®¶ä¸­çš„å±€åŸŸç½‘å†…éƒ¨, ç½‘ç»œè®¾å¤‡é€šå¸¸éƒ½ä½¿ç”¨æ‰€è°“çš„**ç§æœ‰ IP åœ°å€**, ä¾‹å¦‚`192.168.xx.xx`. å½“æˆ‘ä»¬åœ¨ç½‘ç»œä¸Šå‘é€æ•°æ®åŒ…æ—¶, å¦‚æœå¡«å†™çš„æ˜¯è¿™æ ·çš„ç§æœ‰ IP åœ°å€, é‚£ä¹ˆåœ¨ç½‘ç»œæ”¶åˆ°å›å¤çš„æ•°æ®åŒ…æ—¶å¯èƒ½ä¼šé‡åˆ°ä¸€ä¸ªéš¾é¢˜ï¼šå› ä¸ºæˆåƒä¸Šä¸‡çš„ç”¨æˆ·éƒ½å¯èƒ½åœ¨ä½¿ç”¨åŒæ ·çš„ç§æœ‰ IP åœ°å€â€”â€”æ¯”å¦‚`192.168.31.2`. ç½‘ç»œæ— æ³•ä»…å‡­è¿™äº›å†…éƒ¨åœ°å€æ¥åˆ¤æ–­ç©¶ç«Ÿåº”è¯¥å°†æ•°æ®åŒ…è½¬å‘ç»™å“ªä¸€ä¸ªè®¾å¤‡.

![20241229154732_LxYJaHYG.webp](https://cdn.dong4j.site/source/image/20241229154732_LxYJaHYG.webp)

å› æ­¤, ä¸ºäº†ä½¿å±€åŸŸç½‘å†…çš„ç§æœ‰ IP èƒ½å¤Ÿå‘å¤–éƒ¨å…¬æœ‰ IP å‘é€å’Œæ¥æ”¶ä¿¡æ¯, æˆ‘ä»¬éœ€è¦è¿›è¡Œä¸€ç§ç§°ä¸º**ç½‘ç»œåœ°å€è½¬æ¢ (NAT)**çš„æœºåˆ¶. ç®€å•æ¥è¯´å°±æ˜¯å°†**å†…éƒ¨çš„ç§æœ‰ IP åœ°å€è½¬æ¢ä¸ºå¤–éƒ¨çš„å…¬æœ‰ IP åœ°å€çš„è¿‡ç¨‹**.

åœ¨å±€åŸŸç½‘ä¸äº’è”ç½‘ä¹‹é—´, é€šå¸¸ä¼šæœ‰ä¸€ä¸ªä¸“é—¨çš„è®¾å¤‡æˆ–æœåŠ¡æ¥æ‰§è¡Œè¿™ä¸€è½¬æ¢, å®ƒç¡®ä¿äº†å³ä½¿å¤šä¸ªå†…éƒ¨è®¾å¤‡å…±äº«ç›¸åŒçš„ç§æœ‰ IP åœ°å€, ä¹Ÿèƒ½æ­£ç¡®åœ°æ¥æ”¶å’Œå‘é€æ•°æ®. è¿™ä¸ªè½¬æ¢è¿‡ç¨‹å¯ä»¥åœ¨è·¯ç”±å™¨ã€é˜²ç«å¢™æˆ–è€… NAT è®¾å¤‡ä¸­å®Œæˆ.

## NAT çš„å·¥ä½œåŸç†

åœ¨ä½ çš„å®¶åº­ç½‘ç»œä¸­, ä½ æ‹¥æœ‰äº†ä¸€ä¸ªç‹¬ç«‹çš„å…¬ç½‘ IP åœ°å€ `20.20.20.20`, å¹¶ä¸”è¿™ä¸ª IP åœ°å€å·²ç»é…ç½®åœ¨ä½ å®¶å†…ç½®äº† NAT åŠŸèƒ½çš„è·¯ç”±å™¨ä¸Š. ä½ çš„æ‰‹æœºã€ç”µè„‘ä»¥åŠå…¶ä»–éœ€è¦è¿æ¥åˆ°äº’è”ç½‘çš„è®¾å¤‡éƒ½ç»„æˆäº†ä¸€ä¸ªå±€åŸŸç½‘, æ¯ä¸ªè®¾å¤‡éƒ½æœ‰ä¸€ä¸ªç§æœ‰ IP åœ°å€.

### å‘é€æµç¨‹

å½“ä½ æƒ³åœ¨ç”µè„‘ä¸Šè®¿é—®å…¬ç½‘ä¸Šçš„ä¸€ä¸ªç‰¹å®šæœåŠ¡, æ¯”å¦‚ IP åœ°å€ä¸º `30.30.30.30` çš„æœåŠ¡æ—¶, ä½ éœ€è¦é€šè¿‡ NAT è·¯ç”±å™¨æ¥å®Œæˆè¿™ä¸ªè¯·æ±‚. å½“ä½ ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…· (å¦‚ ifconfig) åœ¨ä½ çš„ç”µè„‘ä¸ŠæŸ¥çœ‹ç½‘ç»œé…ç½®æ—¶, ä½ ä¼šçœ‹åˆ°ä½ çš„ç”µè„‘çš„ç§æœ‰ IP åœ°å€ `192.168.31.2`:

![20241229154732_u4I1HElD.webp](https://cdn.dong4j.site/source/image/20241229154732_u4I1HElD.webp)

åœ¨å‡†å¤‡å‘é€æ•°æ®åŒ…çš„è¿‡ç¨‹ä¸­, ä½ çš„ç”µè„‘å†…æ ¸åè®®æ ˆä¼šæ„å»ºä¸€ä¸ªåŒ…å«æº IP åœ°å€ `192.168.31.2` å’Œç›®æ ‡ IP åœ°å€ `30.30.30.30` çš„ IP æ•°æ®åŒ…. è¿™ä¸ª IP æ•°æ®åŒ…çš„æŠ¥å¤´åŒ…å«äº†å…³äºå¦‚ä½•å°†æ•°æ®åŒ…ä»æºç‚¹ä¼ è¾“åˆ°ç»ˆç‚¹çš„å…¨éƒ¨ä¿¡æ¯.

å½“è¿™ä¸ª IP æ•°æ®åŒ…è¢«å‘é€åˆ° NAT è·¯ç”±å™¨æ—¶, è·¯ç”±å™¨çš„ç½‘ç»œåœ°å€è½¬æ¢ (SNAT) åŠŸèƒ½ä¼šä»‹å…¥: å°†åŸå§‹æ•°æ®åŒ…ä¸­çš„ç§æœ‰ IP åœ°å€ `192.168.31.2` æ›¿æ¢ä¸ºåˆ†é…ç»™ä½ çš„å…¬ç½‘ IP åœ°å€ `20.20.20.20`, è¿™ä¸ªè¿‡ç¨‹ç§°ä¸º**æºåœ°å€è½¬æ¢** (Source Network Address Translation) .

åŒæ—¶, NAT è·¯ç”±å™¨ä¼šè®°ä½è¿™ä¸ªæ˜ å°„å…³ç³», å³åœ¨å†…éƒ¨ç»´æŠ¤ä¸€å¼ æ˜ å°„è¡¨, è®°å½•ç€ç§æœ‰ IP åœ°å€å’Œå…¬ç½‘ IP åœ°å€ä¹‹é—´çš„å¯¹åº”å…³ç³». è¿™æ¡æ˜ å°„ä¿¡æ¯å¯¹äºåç»­å°†å“åº”æ•°æ®åŒ…æ­£ç¡®åœ°è½¬å‘å›åŸå§‹è®¾å¤‡è‡³å…³é‡è¦.

ä¿®æ”¹åçš„æ•°æ®åŒ…ç°åœ¨åŒ…å«æº IP åœ°å€ `20.20.20.20` å’Œç›®æ ‡ IP åœ°å€ `30.30.30.30`, å¹¶ç»è¿‡äº’è”ç½‘ä¸Šçš„å¤šä¸ªè·¯ç”±å™¨è¿›è¡Œä¼ è¾“å’Œè½¬å‘. è¿™äº›è·¯ç”±å™¨æ ¹æ®æ•°æ®åŒ…ä¸­çš„ç›®æ ‡ IP åœ°å€æ¥å†³å®šå¦‚ä½•å°†æ•°æ®åŒ…å‘é€åˆ°ä¸‹ä¸€ä¸ªç›®çš„åœ°. åˆ°è¿™é‡Œ**å‘é€æµç¨‹**ç»“æŸ.

### å“åº”æµç¨‹

![20241229154732_vKx8zBTH.webp](https://cdn.dong4j.site/source/image/20241229154732_vKx8zBTH.webp)

å½“æ¥æ”¶ç«¯å¤„ç†å®Œä½ çš„è¯·æ±‚å¹¶å‘é€å“åº”æ—¶, å®ƒä¼šåœ¨å…¶æ„é€ çš„æ•°æ®åŒ…ä¸­å¡«å†™è‡ªå·±çš„ IP åœ°å€ä½œä¸ºæºåœ°å€, å³ `30.30.30.30`, å¹¶å°†ç›®æ ‡åœ°å€è®¾ç½®ä¸ºä½ çš„å…¬ç½‘ IP åœ°å€, å³ `20.20.20.20`. è¿™ä¸ªä¿®æ”¹åçš„æ•°æ®åŒ…ä¼šè¢«å‘é€å› NAT è·¯ç”±å™¨.

NAT è·¯ç”±å™¨æ¥æ”¶åˆ°æ¥è‡ªå…¬ç½‘çš„å“åº”å, ä¼šæ£€æŸ¥å…¶å†…éƒ¨ç»´æŠ¤çš„æ˜ å°„è®°å½•è¡¨. åœ¨è¿™ä¸ªè¡¨ä¸­, å®ƒä¼šæ‰¾åˆ°ä¸€ä¸ªä¸å…¬ç½‘ IP åœ°å€ `20.20.20.20` ç›¸å…³è”çš„ç§æœ‰ IP åœ°å€, å³ä¹‹å‰ç•™ä¸‹çš„æ˜ å°„è®°å½• `192.168.31.2 -> 20.20.20.20`.

NAT è·¯ç”±å™¨æ ¹æ®è¿™æ¡æ˜ å°„ä¿¡æ¯çŸ¥é“åŸå§‹æ•°æ®åŒ…æ˜¯ä»ä½ çš„ç”µè„‘å‘é€å‡ºå»çš„. å› æ­¤, å®ƒä¼šæ‰§è¡Œ**ç›®çš„åœ°å€è½¬æ¢** (Destination Network Address Translation, DNAT) åŠŸèƒ½, å°†æ•°æ®åŒ…çš„ç›®æ ‡ IP åœ°å€ä»å…¬ç½‘ IP åœ°å€ `20.20.20.20` ä¿®æ”¹ä¸ºå†…éƒ¨ç½‘ç»œçš„ç§æœ‰ IP åœ°å€ `192.168.31.2`.

éšå, NAT è·¯ç”±å™¨ä¼šå°†è¿™ä¸ªä¿®æ”¹åçš„æ•°æ®åŒ…è½¬å‘å›å±€åŸŸç½‘å†…çš„ä½ çš„ç”µè„‘. ä½ çš„ç”µè„‘æ”¶åˆ°æ•°æ®åŒ…å, ä¼šæ ¹æ®å…¶ç›®æ ‡ IP åœ°å€è¯†åˆ«å‡ºè¿™æ˜¯ä¸€ä¸ªé’ˆå¯¹å®ƒçš„å“åº”.

> NAT (ç½‘ç»œåœ°å€è½¬æ¢) åœ¨ç”¨æˆ·æ¯«ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹, éšç§˜åœ°æ”¹å˜äº† IP æ•°æ®åŒ…ä¸­çš„æºåœ°å€å’Œç›®æ ‡åœ°å€. å¯¹äºåŸå§‹çš„å‘é€è€…å’Œæ¥æ”¶è€…è€Œè¨€, è¿™ç§æ›´æ”¹æ˜¯å®Œå…¨çœ‹ä¸è§çš„. è¿™æ­£æ˜¯ NAT è¿ä½œçš„æ ¸å¿ƒæœºåˆ¶ï¼š**å®ƒç¡®ä¿äº†å³ä½¿æ˜¯ä½¿ç”¨ç§æœ‰ IP åœ°å€çš„è®¾å¤‡ä¹Ÿèƒ½å¤Ÿå®‰å…¨ã€æœ‰æ•ˆåœ°ä¸äº’è”ç½‘ä¸Šçš„ä»»ä½•å…¬ç½‘ IP è¿›è¡Œé€šä¿¡, è€Œæ— éœ€æ¯ä¸ªè®¾å¤‡éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„å…¬ç½‘ IP åœ°å€. **

---

## NAPT çš„å·¥ä½œåŸç†

### æ¦‚è¿°

åœ¨äº†è§£äº† NAT çš„å·¥ä½œåŸç†å, ä½ å¯èƒ½ä¼šäº§ç”Ÿä¸€ä¸ªç–‘é—®ï¼šå±€åŸŸç½‘ä¸­ä¸ä»…æœ‰ä½ çš„ç”µè„‘, è¿˜æœ‰å…¶ä»–è®¾å¤‡å¦‚æ‰‹æœºã€å¹³æ¿ç­‰, å®ƒä»¬å„è‡ªçš„æ˜ å°„è®°å½•ä¹Ÿå°†æ˜¯ `192.168.xx.xx -> 20.20.20.20`. è¿™çœ‹èµ·æ¥æ²¡é—®é¢˜, ä½†å½“æˆ‘ä»¬éœ€è¦æ¥æ”¶å“åº”æ—¶, NAT è·¯ç”±å™¨å°†å¦‚ä½•çŸ¥é“å“ªä¸ªå“åº”åº”è¯¥å‘é€ç»™å“ªä¸€ä¸ªå†…éƒ¨çš„è®¾å¤‡å‘¢ï¼Ÿ

è¿™ä¸ªé—®é¢˜ç¡®å®å¾ˆé‡è¦, å› ä¸ºå¦‚æœ NAT æ— æ³•åŒºåˆ†å†…éƒ¨ç½‘ç»œçš„å¤šä¸ªè¿æ¥, é‚£ä¹ˆå®ƒå°±æ— æ³•æ­£ç¡®åœ°å°†å¤–éƒ¨çš„å“åº”æ•°æ®åŒ…è½¬å‘å›ç‰¹å®šçš„å†…éƒ¨è®¾å¤‡. ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜, æˆ‘ä»¬éœ€è¦å¼•å…¥é¢å¤–çš„ä¿¡æ¯æ¥æ ‡è¯†å±€åŸŸç½‘å†…çš„æ¯ä¸ªç½‘ç»œè¿æ¥.

ä¸€ä¸ªç®€å•è€Œæœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ç«¯å£. æ¯ä¸ªå†…éƒ¨è®¾å¤‡åœ¨å‘èµ·ç½‘ç»œè¯·æ±‚æ—¶, éƒ½ä¼šåˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ç«¯å£å·, è¿™é€šå¸¸æ˜¯é€šè¿‡ä¼ è¾“æ§åˆ¶åè®® (TCP) æˆ–ç”¨æˆ·æ•°æ®æŠ¥åè®® (UDP) çš„æºç«¯å£å®ç°çš„. è¿™æ ·, NAT è·¯ç”±å™¨å°±å¯ä»¥æ ¹æ®è¿™äº›ç«¯å£å·æ¥åŒºåˆ†ä¸åŒçš„å†…éƒ¨è®¾å¤‡, å³ä½¿å®ƒä»¬çš„ç§æœ‰ IP åœ°å€ç›¸åŒ.

### NAPT åŸç†è§£æ

IP æ•°æ®åŒ… (åœ¨ç½‘ç»œå±‚çš„åè®®) ä¸åŒ…å«ç«¯å£å·ä¿¡æ¯. ç«¯å£å·ä¿¡æ¯æ˜¯å­˜å‚¨åœ¨ä¼ è¾“å±‚ (å¦‚ TCP æˆ– UDP) çš„æ•°æ®æŠ¥å¤´ä¸­çš„. å½“è®¡ç®—æœºå‘é€ä¸€ä¸ª IP æ•°æ®åŒ…æ—¶, å®ƒä¼šåœ¨ç½‘ç»œå±‚åŒ…å«æº IP åœ°å€å’Œç›®æ ‡ IP åœ°å€. ä½†åœ¨ä¼ è¾“å±‚, TCP æˆ– UDP åè®®ä¼šæ·»åŠ é¢å¤–çš„å¤´éƒ¨, å…¶ä¸­åŒ…æ‹¬æºç«¯å£å·å’Œç›®æ ‡ç«¯å£å·.

![20241229154732_hDXcxREr.webp](https://cdn.dong4j.site/source/image/20241229154732_hDXcxREr.webp)

![20241229154732_RQZrPRqR.webp](https://cdn.dong4j.site/source/image/20241229154732_RQZrPRqR.webp)

äºæ˜¯æµç¨‹å°±å˜æˆäº†ä¸‹é¢è¿™æ ·å­. å½“ä½ å‡†å¤‡å‘é€æ•°æ®åŒ…çš„æ—¶å€™, ä½ çš„ç”µè„‘å†…æ ¸åè®®æ ˆå°±ä¼šå…ˆæ„é€ ä¸€ä¸ª TCP æˆ–è€… UDP æ•°æ®æŠ¥å¤´, é‡Œé¢å†™å…¥ç«¯å£å·, æ¯”å¦‚å‘é€ç«¯å£æ˜¯`5000`, æ¥æ”¶ç«¯å£æ˜¯`3000`, ç„¶ååœ¨è¿™ä¸ªåŸºç¡€ä¸Š, åŠ å…¥ IP æ•°æ®æŠ¥å¤´, å¡«å…¥å‘é€ç«¯å’Œæ¥æ”¶ç«¯çš„ IP åœ°å€. é‚£æ•°æ®åŒ…é•¿è¿™æ ·.

![20241229154732_2jxPYBwL.webp](https://cdn.dong4j.site/source/image/20241229154732_2jxPYBwL.webp)

---

### æ•°æ®åŒ…ä¼ è¾“æµç¨‹

å‡è®¾, **å‘é€ç«¯**IP åœ°å€å¡«çš„å°±æ˜¯`192.168.31.2`, **æ¥æ”¶ç«¯**IP åœ°å€å°±æ˜¯`30.30.30.30`. å°†æ•°æ®åŒ…å‘åˆ° NAT è·¯ç”±å™¨ä¸­. æ­¤æ—¶ NAT è·¯ç”±å™¨ä¼šå°† IP æ•°æ®åŒ…é‡Œçš„**æº IP åœ°å€å’Œç«¯å£å·**ä¿®æ”¹ä¸€ä¸‹, ä»`192.168.31.2:5000`æ”¹å†™æˆ`20.20.20.20:6000`. å¹¶ä¸”è¿˜ä¼šåœ¨ NAT è·¯ç”±å™¨å†…éƒ¨ç•™ä¸‹ä¸€æ¡ `192.168.31.2:5000 -> 20.20.20.20:6000`çš„æ˜ å°„è®°å½•. ä¹‹åæ•°æ®åŒ…ç»è¿‡å…¬ç½‘é‡Œå„ä¸ªè·¯ç”±å™¨çš„è½¬å‘, å‘åˆ°äº†æ¥æ”¶ç«¯`30.30.30.30:3000`, åˆ°è¿™é‡Œ**å‘é€æµç¨‹**ç»“æŸ.

![20241229154732_xCgdZUIZ.webp](https://cdn.dong4j.site/source/image/20241229154732_xCgdZUIZ.webp)

å½“æ¥æ”¶ç«¯å‡†å¤‡å‘é€å“åº”æ—¶, å®ƒä¼šåœ¨æ•°æ®åŒ…ä¸­å†™å…¥åŸå§‹è¯·æ±‚æºçš„ IP åœ°å€ (å³ä½ çš„å…¬ç½‘ IP `20.20.20.20`) ä½œä¸ºæºåœ°å€, ä»¥åŠç›®æ ‡ IP åœ°å€ (å³ NAT è·¯ç”±å™¨çš„å†…éƒ¨ç«¯å£ `6000`) , å› ä¸ºè¿™æ˜¯å®ƒæ¥æ”¶åˆ°æ•°æ®çš„æ¥æº. ç„¶å, è¿™ä¸ªä¿®æ”¹åçš„æ•°æ®åŒ…ä¼šè¢«å‘é€å› NAT è·¯ç”±å™¨.

NAT è·¯ç”±å™¨åœ¨å¤„ç†è¿™ä¸ªå“åº”æ—¶, ä¼šæŸ¥æ‰¾åˆ°ä¹‹å‰ç•™ä¸‹çš„æ˜ å°„è®°å½•ï¼š`192.168.31.2:5000 -> 20.20.20.20:6000`. åŸºäºè¿™ä¸ªè®°å½•, NAT ä¼šå°†æ•°æ®åŒ…çš„ç›®çš„ IP åœ°å€å’Œç«¯å£ä» `20.20.20.20:6000` ä¿®æ”¹å›ä½ çš„ç§æœ‰ç½‘ç»œå†…çš„ IP åœ°å€ `192.168.31.2` ä»¥åŠå¯¹åº”çš„ç«¯å£å· `5000`, ä¹‹åå°†å…¶è½¬å‘ç»™ä½ çš„ç”µè„‘ä¸Š.

![20241229154732_pOnKvvT7.webp](https://cdn.dong4j.site/source/image/20241229154732_pOnKvvT7.webp)

å¦‚æœå±€åŸŸç½‘å†…æœ‰å¤šä¸ªè®¾å¤‡, ä»–ä»¬å°±ä¼šæ˜ å°„åˆ°ä¸åŒçš„å…¬ç½‘ç«¯å£ä¸Š, æ¯•ç«Ÿç«¯å£æœ€å¤§å¯è¾¾ 65535, å®Œå…¨å¤Ÿç”¨. è¿™æ ·å¤§å®¶éƒ½å¯ä»¥ç›¸å®‰æ— äº‹. åƒè¿™ç§åŒæ—¶è½¬æ¢ **IP å’Œç«¯å£**çš„æŠ€æœ¯, å°±æ˜¯**NAPT** (Network Address Port Transfer , **ç½‘ç»œåœ°å€ç«¯å£è½¬æ¢** ) .

---

### Ping å‘½ä»¤

è¿™é‡Œå‡ºç°äº†ä¸€ä¸ªç–‘é—®. é€šå¸¸æˆ‘ä»¬è®¤ä¸ºåªæœ‰é‚£äº›åŒ…å«ç«¯å£ä¿¡æ¯çš„ç½‘ç»œåè®®æ‰èƒ½è¢« NAT (ç½‘ç»œåœ°å€è½¬æ¢) è¯†åˆ«å¹¶è¿›è¡Œè½¬å‘. ç„¶è€Œ, è¿™å¦‚ä½•è§£é‡Š ping å‘½ä»¤çš„å·¥ä½œåŸç†å‘¢ï¼Ÿping å‘½ä»¤æ˜¯åŸºäº ICMP åè®®çš„, è€Œ ICMP åè®®çš„æŠ¥æ–‡ä¸­å¹¶ä¸åŒ…å«ç«¯å£ä¿¡æ¯. å°½ç®¡å¦‚æ­¤, æˆ‘ä»¬ä»ç„¶èƒ½å¤Ÿæ­£å¸¸åœ°ä½¿ç”¨ ping å‘½ä»¤ä¸å…¬ç½‘ä¸Šçš„æœºå™¨é€šä¿¡, å¹¶æ¥æ”¶åˆ°å›åº”åŒ…. è¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿ

![20241229154732_e6uSRrHO.webp](https://cdn.dong4j.site/source/image/20241229154732_e6uSRrHO.webp)

**å®ä¸Šé’ˆå¯¹ ICMP åè®®, NAT è·¯ç”±å™¨åšäº†ç‰¹æ®Šå¤„ç†. ping æŠ¥æ–‡å¤´é‡Œæœ‰ä¸ª`Identifier`çš„ä¿¡æ¯, å®ƒå…¶å®æŒ‡çš„æ˜¯æ”¾å‡º ping å‘½ä»¤çš„è¿›ç¨‹ id**. å¯¹ NAT è·¯ç”±å™¨æ¥è¯´, è¿™ä¸ª`Identifier`çš„ä½œç”¨å°±è·Ÿ`ç«¯å£`ä¸€æ ·.

> å¦å¤–, å½“æˆ‘ä»¬å»æŠ“åŒ…çš„æ—¶å€™, å°±ä¼šå‘ç°æœ‰ä¸¤ä¸ª`Identifier`, ä¸€ä¸ªåé¢å¸¦ä¸ª`BE (Big Endian) `, å¦ä¸€ä¸ªå¸¦ä¸ª`LE (Little Endian) `. å…¶å®ä»–ä»¬éƒ½æ˜¯**åŒä¸€ä¸ªæ•°å€¼**, åªä¸è¿‡**å¤§å°ç«¯ä¸åŒ**, è¯»å‡ºæ¥çš„å€¼ä¸ä¸€æ ·. å°±å¥½åƒåŒæ ·çš„æ•°å­— 345, åç€è¯»å°±æˆäº† 543. è¿™æ˜¯ä¸ºäº†å…¼å®¹ä¸åŒæ“ä½œç³»ç»Ÿ (æ¯”å¦‚ linux å’Œ Windows) ä¸‹å¤§å°ç«¯ä¸åŒçš„æƒ…å†µ.

![20241229154732_c6rHtCc5.webp](https://cdn.dong4j.site/source/image/20241229154732_c6rHtCc5.webp)

---

## å†…ç½‘ç©¿é€

### æ¦‚è¿°

å½“ä½¿ç”¨ NAT (ç½‘ç»œåœ°å€è½¬æ¢) ä¸Šç½‘æ—¶, ä¸€ä¸ªåŸºæœ¬çš„å‰ææ˜¯å†…ç½‘æœºå™¨å¿…é¡»ä¸»åŠ¨å‘å…¬ç½‘ IP å‘èµ·è¯·æ±‚, è¿™æ · NAT æ‰èƒ½å°†å†…ç½‘çš„ IP åœ°å€å’Œç«¯å£æ˜ å°„åˆ°å¤–ç½‘çš„ IP åœ°å€å’Œç«¯å£ä¸Š. ç„¶è€Œ, å¦‚æœå…¬ç½‘ä¸Šçš„æœºå™¨è¯•å›¾ä¸»åŠ¨è¿æ¥åˆ°å†…ç½‘æœºå™¨, è¿™ä¸ªè¯·æ±‚å°†ä¼šåœ¨ NAT è·¯ç”±å™¨å¤„å—é˜».

ç”±äº NAT è·¯ç”±å™¨ä¸Šæ²¡æœ‰ç›¸åº”çš„ IP åœ°å€å’Œç«¯å£æ˜ å°„è®°å½•, å› æ­¤å®ƒä¸ä¼šå°†æ•°æ®è½¬å‘åˆ°å†…ç½‘çš„ä»»ä½•æœºå™¨.

ä¾‹å¦‚, å‡è®¾ä½ åœ¨å®¶é‡Œç”µè„‘ä¸Šå¯åŠ¨äº†ä¸€ä¸ª HTTP æœåŠ¡, åœ°å€æ˜¯`192.168.31.2:5000`, ä½†ä½ åœ¨å…¬å¸åŠå…¬å®¤è¯•å›¾é€šè¿‡æ‰‹æœºè®¿é—®è¿™ä¸ªæœåŠ¡æ—¶, ä¼šå‘ç°æ— æ³•è¿æ¥. è¿™å°±å¼•å‡ºäº†ä¸€ä¸ªé—®é¢˜ï¼šæœ‰æ²¡æœ‰åŠæ³•è®©å¤–ç½‘æœºå™¨è®¿é—®å†…ç½‘çš„æœåŠ¡å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„. æœ‰ä¸€å¥è¯è¯´å¾—å¥½, **ä»»ä½•é—®é¢˜éƒ½å¯ä»¥é€šè¿‡å¢åŠ ä¸€ä¸ªä¸­é—´å±‚æ¥è§£å†³, å¦‚æœä¸è¡Œ, é‚£å°±å†åŠ ä¸€å±‚.** åœ¨è¿™ä¸ªæƒ…å†µä¸‹, è¿™ä¸ªåŸåˆ™åŒæ ·é€‚ç”¨.

å½’æ ¹ç»“åº•, ç”±äº NAT (ç½‘ç»œåœ°å€è½¬æ¢) çš„å­˜åœ¨, æˆ‘ä»¬é€šå¸¸åªèƒ½ä»å†…ç½‘å‘å¤–ç½‘ä¸»åŠ¨å‘èµ·è¿æ¥. å¦‚æœå†…ç½‘æœºå™¨æ²¡æœ‰é¦–å…ˆå»ºç«‹è¿æ¥, NAT è®¾å¤‡å°±ä¸ä¼šåˆ›å»ºç›¸åº”çš„æ˜ å°„å…³ç³», è€Œæ²¡æœ‰è¿™ä¸ªæ˜ å°„å…³ç³», å¤–ç½‘çš„æ•°æ®å°±æ— æ³•è¢«è½¬å‘åˆ°å†…ç½‘.

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜, æˆ‘ä»¬å¯ä»¥åœ¨å…¬ç½‘ä¸Šéƒ¨ç½²ä¸€å°æœåŠ¡å™¨ x, å¹¶ä¸ºå…¶åˆ†é…ä¸€ä¸ªå¯è®¿é—®çš„åŸŸå. ç„¶å, è®©å†…ç½‘çš„æœåŠ¡ä¸»åŠ¨è¿æ¥åˆ°è¿™å°æœåŠ¡å™¨ x, è¿™æ · NAT è·¯ç”±å™¨å°±ä¼šå»ºç«‹ç›¸åº”çš„æ˜ å°„å…³ç³». ä¹‹å, ä»»ä½•å¤–ç½‘çš„è®¿é—®è¯·æ±‚éƒ½å¯ä»¥å‘é€åˆ°æœåŠ¡å™¨ x, æœåŠ¡å™¨ x å†å°†è¿™äº›è¯·æ±‚è½¬å‘åˆ°å†…ç½‘æœºå™¨, å¹¶å°†å†…ç½‘æœºå™¨çš„å“åº”è¿”å›ç»™è¯·æ±‚è€…, ä»è€Œå®ç°æ•°æ®çš„åŒå‘é€šä¿¡. è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„å†…ç½‘ç©¿é€.

è‡³äºæœåŠ¡å™¨ x, ä½ å¹¶ä¸éœ€è¦è‡ªå·±æ­å»º, å¸‚é¢ä¸Šå·²ç»æœ‰è®¸å¤šç°æˆçš„å†…ç½‘ç©¿é€æœåŠ¡. æ¯”å¦‚ä½¿ç”¨æŸå£³æä¾›çš„å†…ç½‘ç©¿é€è§£å†³æ–¹æ¡ˆ, æˆ–è€…å¼€æºçš„å†…ç½‘ç©¿é€æœåŠ¡:

- [**frp (Fast Reverse Proxy)**](https://github.com/fatedier/frp)
- [**ngrok**](https://github.com/inconshreveable/ngrok)
- [**nps (Network Proxy Server)**](https://github.com/ehang-io/nps)
- [**lanproxy**](https://github.com/ffay/lanproxy)

![20241229154732_y9pPR1xV.webp](https://cdn.dong4j.site/source/image/20241229154732_y9pPR1xV.webp)

åˆ°è¿™é‡Œ, æˆ‘ä»¬å°±å¯ä»¥å›ç­”è¿™ä¸ªé—®é¢˜ï¼š**ä¸ºä»€ä¹ˆæˆ‘åœ¨å…¬å¸é‡Œè®¿é—®ä¸äº†å®¶é‡Œçš„ç”µè„‘**ï¼Ÿ

é‚£æ˜¯å› ä¸ºå®¶é‡Œçš„ç”µè„‘åœ¨å±€åŸŸç½‘å†…, å±€åŸŸç½‘å’Œå¹¿åŸŸç½‘ä¹‹é—´æœ‰ä¸ª NAT è·¯ç”±å™¨. ç”±äº NAT è·¯ç”±å™¨çš„å­˜åœ¨, å¤–ç½‘æœåŠ¡æ— æ³•ä¸»åŠ¨è¿é€šå±€åŸŸç½‘å†…çš„ç”µè„‘.

---

### å³æ—¶é€šè®¯è½¯ä»¶çš„ç½‘ç»œé€šä¿¡æœºåˆ¶

æˆ‘å®¶ç”µè„‘ä½äºæˆ‘ä»¬å°åŒºçš„å±€åŸŸç½‘ä¸­, è€Œè€å©†é—ºèœœå®¶çš„ç”µè„‘åˆ™ä½äºå¥¹ä»¬å°åŒºçš„å±€åŸŸç½‘å†…. æ—¢ç„¶ä¸¤å°ç”µè„‘éƒ½å¤„äºå„è‡ªçš„å±€åŸŸç½‘ä¸­, ä¸” NAT åªå…è®¸å†…ç½‘è®¾å¤‡ä¸»åŠ¨è¿æ¥åˆ°å¤–ç½‘, é‚£æˆ‘ç”µè„‘ä¸Šç™»å½•çš„ QQ æ˜¯å¦‚ä½•ä¸è€å©†é—ºèœœç”µè„‘ä¸Šçš„ QQ å»ºç«‹è¿æ¥çš„å‘¢ï¼Ÿ

![20241229154732_fWxM3JVM.webp](https://cdn.dong4j.site/source/image/20241229154732_fWxM3JVM.webp)

è¿™ç§æé—®æ–¹å¼éšå«äº†ä¸€ä¸ªé”™è¯¯çš„å‡è®¾, å³è®¤ä¸ºä¸¤ä¸ª QQ å®¢æˆ·ç«¯åº”ç”¨èƒ½å¤Ÿç›´æ¥å»ºç«‹ç‚¹å¯¹ç‚¹çš„è¿æ¥. ä½†å®é™…æƒ…å†µå¹¶éå¦‚æ­¤, ä¸¤ä¸ª QQ å®¢æˆ·ç«¯ä¹‹é—´çš„é€šä¿¡æ˜¯é—´æ¥çš„, å®ƒä»¬ä¹‹é—´è¿˜æœ‰ä¸€ä¸ªä¸­é—´ç¯èŠ‚, é‚£å°±æ˜¯é€šè®¯è½¯ä»¶æœåŠ¡å™¨:

![20241229154732_aI9dT9wY.webp](https://cdn.dong4j.site/source/image/20241229154732_aI9dT9wY.webp)

æ¢è¨€ä¹‹, å½“ä¸¤ä¸ªä½äºå†…ç½‘çš„ QQ å®¢æˆ·ç«¯ç™»å½•æ—¶, å®ƒä»¬éƒ½ä¼šä¸»åŠ¨ä¸å…¬ç½‘ä¸Šçš„é€šè®¯æœåŠ¡å™¨å»ºç«‹è¿æ¥, æ­¤æ—¶å„è‡ªçš„ NAT è·¯ç”±å™¨ä¼šè®°å½•ä¸‹ç›¸åº”çš„æ˜ å°„æ¡ç›®. å½“ä¸€ä¸ªå®¢æˆ·ç«¯é€šè¿‡ QQ å‘é€æ¶ˆæ¯æ—¶, è¿™äº›æ•°æ®é¦–å…ˆä¼šä¼ è¾“åˆ°æœåŠ¡å™¨, ç„¶åç”±æœåŠ¡å™¨å°†å…¶è½¬å‘åˆ°å¦ä¸€ä¸ªå®¢æˆ·ç«¯. åä¹‹äº¦ç„¶, é€šè¿‡è¿™ç§æœºåˆ¶, ä¸¤å°å¤„äºå†…ç½‘çš„è®¡ç®—æœºå¾—ä»¥å®ç°æ•°æ®çš„äº¤æ¢.

---

### ç‚¹å¯¹ç‚¹ (P2P) ç½‘ç»œé€šä¿¡

åœ¨ P2P ä¸‹è½½ç­‰åŒå‘é€šä¿¡åœºæ™¯ä¸­, é€šå¸¸ä¼šæ¶‰åŠåˆ° NAT ç©¿è¶Šçš„é—®é¢˜. å‡è®¾è¿˜æ˜¯ A å’Œ B ä¸¤ä¸ª**å±€åŸŸç½‘å†…**çš„æœºå­, A å†…ç½‘å¯¹åº”çš„ NAT è®¾å¤‡å«`NAT_A`, B å†…ç½‘é‡Œçš„ NAT è®¾å¤‡å«`NAT_B`, å’Œä¸€ä¸ªç¬¬ä¸‰æ–¹æœåŠ¡å™¨`Server`.

é€šè¿‡ç¬¬ä¸‰æ–¹æœåŠ¡å™¨å¸®åŠ©ä¸¤å°ä½äºä¸åŒå±€åŸŸç½‘çš„æœºå™¨ A å’Œ B å»ºç«‹è¿æ¥çš„ç®€åŒ–æµç¨‹å¦‚ä¸‹ï¼š

1. **Step1 + Step2**: A æœºå™¨é¦–å…ˆä¸»åŠ¨è¿æ¥ç¬¬ä¸‰æ–¹æœåŠ¡å™¨, å…¶ NAT è®¾å¤‡ (NAT_A) è®°å½•ä¸‹ A çš„å†…ç½‘å’Œå¤–ç½‘åœ°å€çš„æ˜ å°„å…³ç³». åŒæ—¶, `Server` è®°ä¸‹äº† A çš„å¤–ç½‘ IP å’Œç«¯å£.
2. **Step3 + Step4**: B æœºå™¨ä¹Ÿè¿›è¡ŒåŒæ ·çš„æ“ä½œ, ä¸»åŠ¨è¿æ¥æœåŠ¡å™¨, NAT_B è®°å½•ä¸‹ B çš„å†…ç½‘å’Œå¤–ç½‘åœ°å€æ˜ å°„, `Server` åŒæ ·è·å–äº† B çš„å¤–ç½‘ IP å’Œç«¯å£.
3. **Step5 + Step6 + Step7**: å…³é”®æ­¥éª¤æ¥äº†, `Server` é€šçŸ¥ A, è®© A ä¸»åŠ¨å‘ B çš„å¤–ç½‘ IP å’Œç«¯å£å‘é€ UDP æ¶ˆæ¯. æ­¤æ—¶ NAT_B æ”¶åˆ°è¿™ä¸ª A çš„ UDP æ•°æ®åŒ…æ—¶, è¿™æ—¶å€™**æ ¹æ® NAT_B çš„è®¾ç½®ä¸åŒ** å¯èƒ½å­˜åœ¨ 2 ç§æƒ…å†µ:
   1. NAT_B ä¸Šæ²¡æœ‰å…³äº A çš„æ˜ å°„å…³ç³»å¯¼è‡´ç›´æ¥ä¸¢åŒ…, ä¸è¿‡ä¸¢åŒ…æ²¡å…³ç³», è¿™ä¸ªæ“ä½œçš„ **ç›®çš„æ˜¯** ç»™ NAT_A ä¸Šç•™ä¸‹ **æœ‰å…³ B çš„æ˜ å°„å…³ç³»**;
   2. æœ‰å¯èƒ½å› ä¸ºå»¶è¿Ÿæˆ–æ¶ˆæ¯è¾¾åˆ°çš„é¡ºåºé—®é¢˜, NAT_B å·²ç»æœ‰äº†å…³äº A çš„æ˜ å°„å…³ç³», æ­¤æ—¶ A å’Œ B å°±èƒ½æ­£å¸¸é€šä¿¡äº†;
4. **Step8 + Step9 + Step10**: è·Ÿ 5,6,7 æ­¥éª¤ä¸€æ ·, `Server`é€šçŸ¥ B, è®© B å‘ A çš„å¤–ç½‘ IP å’Œç«¯å£å‘é€ UDP æ¶ˆæ¯. NAT_B ä¸Šä¹Ÿç•™ä¸‹äº†å…³äº A çš„æ˜ å°„å…³ç³», è¿™æ—¶å€™ç”±äºä¹‹å‰ NAT_A ä¸Šæœ‰è¿‡å…³äº B çš„æ˜ å°„å…³ç³», æ­¤æ—¶ NAT_A å°±èƒ½æ­£å¸¸æ¥å— B çš„æ•°æ®åŒ…, å¹¶å°†å…¶è½¬å‘ç»™ A. åˆ°è¿™é‡Œ A å’Œ B å°±èƒ½æ­£å¸¸è¿›è¡Œæ•°æ®é€šä¿¡äº†. è¿™å°±æ˜¯æ‰€è°“çš„ **NAT æ‰“æ´**.
5. **Step11**: æ³¨æ„, ä¹‹å‰æˆ‘ä»¬éƒ½æ˜¯ç”¨çš„ **UDP æ•°æ®åŒ…**, ç›®çš„åªæ˜¯ä¸ºäº†åœ¨ä¸¤ä¸ªå±€åŸŸç½‘çš„ NAT ä¸Š**æ‰“ä¸ªæ´**å‡ºæ¥, å®é™…ä¸Šå¤§éƒ¨åˆ†åº”ç”¨ç”¨çš„éƒ½æ˜¯ TCP è¿æ¥, æ‰€ä»¥, è¿™æ—¶å€™æˆ‘ä»¬è¿˜éœ€è¦ A ä¸»åŠ¨å‘ B å‘èµ· TCP è¿æ¥(æ¯”å¦‚æˆ‘ä»¬ç†ŸçŸ¥çš„ **WireGuard**). åˆ°æ­¤, æˆ‘ä»¬å°±å®Œæˆäº†ä¸¤ç«¯ä¹‹é—´çš„é€šä¿¡.

![20241229154732_fq5jEgvm.webp](https://cdn.dong4j.site/source/image/20241229154732_fq5jEgvm.webp)

å¯èƒ½ä¼šæœ‰è¿™æ ·çš„ç–‘é—®ï¼šæ—¢ç„¶ UDP å·²ç»ä½¿ç”¨äº†ä¸€ä¸ªç«¯å£, é‚£ä¹ˆ TCP å†ä½¿ç”¨ç›¸åŒçš„ç«¯å£, ä¼šä¸ä¼šå‡ºç°ç«¯å£é‡å¤å ç”¨çš„é”™è¯¯ï¼Ÿ

å®é™…ä¸Š, è¿™ç§æƒ…å†µå¹¶ä¸ä¼šå‘ç”Ÿ. ç«¯å£é‡å¤å ç”¨çš„é”™è¯¯é€šå¸¸å‡ºç°åœ¨ä¸¤ä¸ª TCP è¿æ¥æ²¡æœ‰ä½¿ç”¨ **SO_REUSEADDR** é€‰é¡¹, å¹¶ä¸”å°è¯•åœ¨åŒä¸€ä¸ª IP åœ°å€ä¸Šä½¿ç”¨ç›¸åŒçš„ç«¯å£. ç„¶è€Œ, UDP å’Œ TCP ä¹‹é—´å¹¶ä¸ä¼šå¼•å‘è¿™æ ·çš„é”™è¯¯.

åŸå› åœ¨äº, åœ¨ Linux å†…æ ¸ä¸­, ç½‘ç»œæ•°æ®åŒ…æ˜¯æ ¹æ®äº”å…ƒç»„ (**ä¼ è¾“åè®®**ã€**æº IP**ã€**ç›®çš„ IP**ã€**æºç«¯å£**ã€**ç›®çš„ç«¯å£**) æ¥å”¯ä¸€ç¡®å®šæ¥æ”¶è€…çš„. å½“ä¸¤ä¸ªè¿æ¥çš„äº”å…ƒç»„å®Œå…¨ç›¸åŒæ—¶, å†…æ ¸å°±æ— æ³•åˆ¤æ–­æ•°æ®åº”è¯¥å‘é€ç»™å“ªä¸ªè¿æ¥. ä½†ç”±äº UDP å’Œ TCP çš„ **ä¼ è¾“åè®®** ä¸åŒ, å³ä½¿å®ƒä»¬ä½¿ç”¨äº†ç›¸åŒçš„ IP åœ°å€å’Œç«¯å£, äº”å…ƒç»„ä¹Ÿæ˜¯ä¸åŒçš„.

å› æ­¤, UDP å’Œ TCP å¯ä»¥å…±äº«ç›¸åŒçš„ç«¯å£è€Œä¸ä¼šå‘ç”Ÿå†²çª.

---

### UDP æ‰“æ´çš„å±€é™æ€§

ä» 2019 å¹´å¼€å§‹, ä¸€äº›ä¼ ç»Ÿçš„ç½‘ç»œç©¿é€æŠ€æœ¯ (å¦‚ pwnat) ä¸å†æœ‰æ•ˆ. [pwnat](https://github.com/samyk/pwnat) æ˜¯ä¸€ç§åˆ›æ–°çš„ç½‘ç»œç©¿é€æ–¹æ³•, å®ƒå…è®¸è®¾å¤‡åœ¨æ²¡æœ‰ä»£ç†æœåŠ¡å™¨ã€ç¬¬ä¸‰æ–¹æœåŠ¡å™¨ã€UPnPã€DMZ è®¾ç½®ã€æºç«¯å£æ¬ºéª—æˆ– DNS è½¬æ¢çš„æƒ…å†µä¸‹, å®ç° NAT ç¯å¢ƒä¸‹çš„ç‚¹å¯¹ç‚¹é€šä¿¡.

**å·¥ä½œåŸç†**

**1. æœåŠ¡ç«¯çš„æ“ä½œ**

- **æ¨¡æ‹Ÿå‘é€è¯·æ±‚ï¼š** æœåŠ¡ç«¯å¯åŠ¨å, ä¼šä¸æ–­å‘ä¸€ä¸ªå›ºå®šçš„ã€æ— æ³•è®¿é—®çš„ IP åœ°å€ (æ¯”å¦‚ 3.3.3.3) å‘é€ **ICMP å›æ˜¾è¯·æ±‚åŒ…** (ICMP echo request) .

  - æ³¨æ„ï¼š3.3.3.3 åªæ˜¯ä¸€ä¸ªå ä½ç¬¦, æœåŠ¡ç«¯ä¸æ˜¯çœŸçš„æœŸå¾…ä»è¿™ä¸ªåœ°å€æ”¶åˆ°ä»»ä½•å›åº”.
  - è¿™äº›è¯·æ±‚åŒ…ä¼šè¢«æœåŠ¡ç«¯çš„ NAT è®°å½•ä¸º "æœ‰ä¸€ä¸ªæ•°æ®åŒ…æ­£åœ¨å‘å¾€ 3.3.3.3, ç­‰å¾…è¿”å›æ•°æ®": `æœåŠ¡ç«¯å†…ç½‘ IP:ç«¯å£ â†’ NAT å…¬ç½‘ IP:ç«¯å£ â†’ 3.3.3.3`

- **æ ¸å¿ƒç›®æ ‡ï¼š**

  æœåŠ¡ç«¯çš„ NAT è®¾å¤‡åœ¨ç­‰å¾…è¿™äº› ICMP å›æ˜¾è¯·æ±‚åŒ…çš„å“åº”, ä½†ç”±äº 3.3.3.3 å¹¶ä¸å­˜åœ¨, å“åº”åŒ…è‡ªç„¶ä¸ä¼šåˆ°è¾¾.

**2. å®¢æˆ·ç«¯çš„æ“ä½œ**

- **ä¼ªè£…æˆä¸€ä¸ªè·³è·ƒç‚¹ï¼š** å½“å®¢æˆ·ç«¯å¸Œæœ›è¿æ¥æœåŠ¡ç«¯æ—¶, å®¢æˆ·ç«¯éœ€è¦çŸ¥é“ **æœåŠ¡ç«¯çš„ IP åœ°å€**. ç„¶å, å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª **ICMP è¶…æ—¶åŒ…** (ICMP Time Exceeded) åˆ°æœåŠ¡ç«¯.
  - è¿™ä¸ªè¶…æ—¶åŒ…ä¼ªè£…æˆæŸä¸ªç½‘ç»œèŠ‚ç‚¹çš„å“åº”, å‘Šè¯‰æœåŠ¡ç«¯ï¼šâ€œä½ å‘å¾€ 3.3.3.3 çš„ ICMP å›æ˜¾è¯·æ±‚åŒ…è¶…æ—¶äº†, æ— æ³•åˆ°è¾¾ç›®çš„åœ°. â€
  - å…³é”®ç‚¹åœ¨äº, å®¢æˆ·ç«¯å‘é€çš„è¶…æ—¶åŒ…ä¸­, åŒ…å«äº†æœåŠ¡ç«¯åŸå§‹å‘é€çš„ ICMP å›æ˜¾è¯·æ±‚åŒ…çš„å®Œæ•´ä¿¡æ¯ (åŸå§‹æ•°æ®åŒ…çš„å†…å®¹) .

**3. NAT çš„è¡Œä¸º**

- **è¯†åˆ«åŒ¹é…çš„è¯·æ±‚ï¼š** å½“å®¢æˆ·ç«¯å‘é€çš„ ICMP è¶…æ—¶åŒ…åˆ°è¾¾æœåŠ¡ç«¯çš„ NAT æ—¶, NAT ä¼šæ£€æŸ¥åŒ…çš„å†…å®¹, å‘ç°é‡Œé¢åµŒå¥—äº†æœåŠ¡ç«¯æœ€åˆå‘å¾€ 3.3.3.3 çš„ ICMP è¯·æ±‚åŒ….

- **æ™ºèƒ½è½¬å‘ï¼š** NAT è®¤ä¸ºè¿™ä¸ª ICMP è¶…æ—¶åŒ…æ˜¯å’ŒæœåŠ¡ç«¯æœ€åˆçš„ ICMP è¯·æ±‚åŒ…ç›¸å…³è”çš„å›åº”, äºæ˜¯å°†åŒ…è½¬å‘ç»™ NAT åé¢çš„æœåŠ¡ç«¯.

**4. æœåŠ¡ç«¯è·å–å®¢æˆ·ç«¯çš„ IP åœ°å€**

- **æå– IP ä¿¡æ¯ï¼š** æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯ä¼ªè£…çš„ ICMP è¶…æ—¶åŒ…å, ä»ä¸­æå–å‡ºå®¢æˆ·ç«¯çš„çœŸå® IP åœ°å€å’Œç«¯å£.

- **å®Œæˆè¿æ¥ï¼š** æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ­¤æ—¶å¯ä»¥é€šè¿‡æå–çš„åœ°å€å»ºç«‹ç‚¹å¯¹ç‚¹è¿æ¥.

![20241229154732_loEPi3DG.webp](https://cdn.dong4j.site/source/image/20241229154732_loEPi3DG.webp)

- æœåŠ¡ç«¯(`192.168.1.2`) å¯åŠ¨åå®ƒä¼šå¼€å§‹å‘å›ºå®šåœ°å€ 3.3.3.3 å‘é€ **å›ºå®šçš„ ICMP è¯·æ±‚æ•°æ®åŒ…**, åŒæ—¶ä¼šåˆ›å»ºä¸€ä¸ª NAT è®°å½•: `ICMP: 192.168.1.2:Identifier -> 40.40.40.40:xxx -> 3.3.3.3`, è¿™ä¸ªè¯·æ±‚æ•°æ®åŒ…åœ¨ç»è¿‡ NAT è½¬æ¢åçš„å†…å®¹ä¸º:

  ```
  IP Header
  ------------------------
  æº IP: 40.40.40.40
  ç›®æ ‡ IP: 3.3.3.3

  ICMP Header
  -------------------
  Type: 8 (Echo Request)
  Code: 0
  Identifier: 1111 (ç”¨äºåŒºåˆ†ä¼šè¯, pwnat ä½¿ç”¨çš„å›ºå®šå€¼, æ–¹ä¾¿ä¸å®¢æˆ·ç«¯å‘é€çš„ ICMP è¶…æ—¶åŒ…åŒ¹é…)
  Sequence Number: 2222 (ç”¨äºè¿½è¸ªåŒ…çš„é¡ºåº, pwnat ä½¿ç”¨çš„å›ºå®šå€¼, æ–¹ä¾¿ä¸å®¢æˆ·ç«¯å‘é€çš„ ICMP è¶…æ—¶åŒ…åŒ¹é…)
  ```

- å®¢æˆ·ç«¯(`192.168.31.2`) åœ¨åªçŸ¥é“æœåŠ¡ç«¯å¯¹åº”çš„å…¬ç½‘ IP (`40.40.40.40`) çš„æƒ…å†µä¸‹å‘é€ **ä¼ªé€ çš„è¶…æ—¶åŒ…**, ç»è¿‡ NAT è½¬æ¢åçš„å†…å®¹ä¸º:

  ```
  IP Header (ä¼ªé€ çš„è¶…æ—¶åŒ…)
  ------------------------
  æº IP: 20.20.20.20
  ç›®æ ‡ IP: 40.40.40.40

  ICMP Header (è¶…æ—¶åŒ…)
  -------------------
  Type: 11 (Time Exceeded)
  Code: 0
  Data: (æœåŠ¡ç«¯åŸå§‹å‘å‡ºçš„ ICMP å›æ˜¾è¯·æ±‚çš„ IP å’Œ ICMP å¤´)
  		IP Header
      ------------------------
      æº IP: 40.40.40.40
      ç›®æ ‡ IP: 3.3.3.3

      ICMP Header
      -------------------
      Type: 8 (Echo Request)
      Code: 0
      Identifier: 1111 (ç”¨äºåŒºåˆ†ä¼šè¯, pwnat ä½¿ç”¨çš„å›ºå®šå€¼, æ–¹ä¾¿ä¸å®¢æˆ·ç«¯å‘é€çš„ ICMP è¶…æ—¶åŒ…åŒ¹é…)
      Sequence Number: 2222 (ç”¨äºè¿½è¸ªåŒ…çš„é¡ºåº, pwnat ä½¿ç”¨çš„å›ºå®šå€¼, æ–¹ä¾¿ä¸å®¢æˆ·ç«¯å‘é€çš„ ICMP è¶…æ—¶åŒ…åŒ¹é…)
  ```

  å› ä¸º ICMP çš„è¯·æ±‚å’Œå“åº”åŒ…åŒ¹é…ä¾èµ–äº **IP å±‚çš„æº IP å’Œç›®æ ‡ IP** ä»¥åŠ **ICMP æ•°æ®åŒ…å¤´ä¸­çš„å­—æ®µ**ï¼šTypeã€Codeã€Identifier å’Œ Sequence Number. æœ€ä¸»è¦çš„æ˜¯æ„å»º Identifier å’Œ Sequence Number, å› ä¸ºå‰é¢æœåŠ¡å™¨ç«¯å‘é€çš„éƒ½æ˜¯å›ºå®šçš„ ICMP è¯·æ±‚æ•°æ®åŒ…, æ‰€ä»¥è¿™é‡Œå°±éå¸¸å®¹æ˜“ä¼ªé€ è¶…æ—¶åŒ….

- ä¼ªé€ çš„æ•°æ®åŒ…é¦–å…ˆè¾¾åˆ°æœåŠ¡å™¨å‰é¢çš„ NAT è®¾å¤‡, åœ¨æ£€æŸ¥å†…åå‘ç°ä¸æœåŠ¡ç«¯ä¹‹å‰å‘å¾€ `3.3.3.3` çš„è¯·æ±‚ç›¸å…³è”, è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªåˆæ³•çš„å“åº”.
- å› ä¸º NAT è®¾å¤‡ å·²ç»æœ‰ç›¸å…³çš„ NAT è®°å½•äº†(`ICMP:  2.168.1.2:Identifier -> 40.40.40.40:xxx -> 3.3.3.3`), å°±ä¼šæŠŠç›®æ ‡ IP ä¸º `40.40.40.40` çš„æ•°æ®åŒ…è½¬å‘ç»™ `192.168.1.2`.

---

## NAT ç±»å‹

### ç®€ä»‹

NAT åˆ†ä¸ºä¸¤å¤§ç±», åŸºæœ¬çš„ NAT å’Œ NAPT (å³ **ç«¯å£ NAT**, è‹±æ–‡å…¨ç§°ä¸º **Network Address/Port Translator**) .

![20241229154732_JGgmpHKR.webp](https://cdn.dong4j.site/source/image/20241229154732_JGgmpHKR.webp)

### åŸºæœ¬ NAT ä¸ NAPT

#### åŸºæœ¬ NAT

è¿™ç§ç±»å‹çš„ NAT (Basic NAT) ä¸»è¦æ˜¯è¿›è¡Œ IP åœ°å€çš„è½¬æ¢, å®ƒå°†ç§æœ‰ç½‘ç»œä¸­çš„ IP åœ°å€æ˜ å°„åˆ°å…¬ç½‘ä¸Šçš„ä¸€ä¸ªæˆ–å¤šä¸ªå…¬ç½‘ IP åœ°å€. å®ƒçš„å¯ä»¥åˆ†ä¸º:

- **é™æ€ NAT (Static NAT)**: é™æ€ NAT æ˜¯ä¸€ç§å°†å†…éƒ¨ç½‘ç»œçš„ç§æœ‰ IP åœ°å€æ˜ å°„åˆ°ä¸€ä¸ªå›ºå®šçš„å…¬æœ‰ IP åœ°å€çš„æ–¹æ³•. è¿™ç§æ˜ å°„å…³ç³»æ˜¯ç”±ç½‘ç»œç®¡ç†å‘˜æ‰‹åŠ¨é…ç½®çš„, å¹¶ä¸”åœ¨æ˜ å°„å»ºç«‹åä¸ä¼šæ”¹å˜.ç‰¹ç‚¹ä¸ºï¼š
  - **ä¸€å¯¹ä¸€æ˜ å°„**ï¼šæ¯ä¸ªç§æœ‰ IP åœ°å€éƒ½å¯¹åº”ä¸€ä¸ªå”¯ä¸€çš„å…¬æœ‰ IP åœ°å€.
  - **æ°¸ä¹…æ€§**ï¼šæ˜ å°„å…³ç³»æ˜¯æ°¸ä¹…æ€§çš„, é™¤éç®¡ç†å‘˜æ‰‹åŠ¨æ›´æ”¹é…ç½®.
- **åŠ¨æ€ NAT (Dynamic NAT)**: åŠ¨æ€ NAT æ˜¯ä¸€ç§å°†å†…éƒ¨ç½‘ç»œçš„ç§æœ‰ IP åœ°å€åŠ¨æ€åœ°æ˜ å°„åˆ°å…¬æœ‰ IP åœ°å€æ± ä¸­çš„åœ°å€çš„æ–¹æ³•. æ˜ å°„å…³ç³»ä¸æ˜¯æ°¸ä¹…å›ºå®šçš„, è€Œæ˜¯æ ¹æ®éœ€è¦åŠ¨æ€åˆ†é…å’Œé‡Šæ”¾. ç‰¹ç‚¹ä¸ºï¼š
  - **å¤šå¯¹å¤šæ˜ å°„**ï¼šç§æœ‰ IP åœ°å€å¯ä»¥æ˜ å°„åˆ°å…¬æœ‰ IP åœ°å€æ± ä¸­çš„ä»»ä½•ä¸€ä¸ªåœ°å€.
  - **ä¸´æ—¶æ€§**ï¼šæ˜ å°„å…³ç³»åœ¨ä¼šè¯ç»“æŸæ—¶é‡Šæ”¾, IP åœ°å€å¯ä»¥é‡æ–°åˆ†é…ç»™å…¶ä»–å†…éƒ¨ä¸»æœº.

#### NAPT

ä¹Ÿç§°ä¸ºç«¯å£ NAT (Network Address/Port Translator) , æ˜¯ä¸€ç§æ›´é«˜çº§çš„ NAT å½¢å¼. å®ƒä¸ä»…è½¬æ¢ IP åœ°å€, è¿˜è½¬æ¢ä¼ è¾“å±‚åè®®çš„ç«¯å£å·. NAPT å…è®¸å¤šä¸ªå†…éƒ¨ç§æœ‰ IP åœ°å€å…±äº«åŒä¸€ä¸ªå…¬ç½‘ IP åœ°å€, é€šè¿‡ä¸åŒçš„ç«¯å£å·æ¥åŒºåˆ†ä¸åŒçš„æ•°æ®æµ. è¿™æ˜¯æœ€å¸¸è§çš„ NAT ç±»å‹, å¹¿æ³›ç”¨äºå®¶åº­å’Œå°å‹ä¼ä¸šç½‘ç»œä¸­, å› ä¸ºå®ƒå¯ä»¥æœ‰æ•ˆåœ°è§£å†³å…¬ç½‘ IP åœ°å€ä¸è¶³çš„é—®é¢˜.

NAPT åˆåˆ†ä¸º**é”¥å‹ (Cone) å’Œå¯¹ç§°å‹ (Symmetric)**ï¼š

- **é”¥å‹ NAT (Cone NAT)**: å®ƒåœ¨ NAT è½¬æ¢æ—¶, å†…éƒ¨ä¸»æœºçš„ç§æœ‰ IP åœ°å€å’Œç«¯å£å·ä¸å…¬ç½‘ IP åœ°å€å’Œç«¯å£å·ä¹‹é—´çš„æ˜ å°„å…³ç³»æ˜¯ä¸€è‡´çš„, ä¸ä¾èµ–äºé€šä¿¡çš„ç›®çš„åœ°å€.

  - **ç‰¹ç‚¹**ï¼š**æ˜ å°„ä¸€è‡´æ€§**, ä¸€æ—¦å†…éƒ¨ä¸»æœºçš„ç§æœ‰ç«¯å£æ˜ å°„åˆ°å…¬ç½‘çš„ä¸€ä¸ªç«¯å£, æ— è®ºç›®çš„åœ°å€æ˜¯ä»€ä¹ˆ, è¿™ä¸ªæ˜ å°„å…³ç³»éƒ½ä¿æŒä¸å˜.

  å¦‚æœ client A ä½¿ç”¨å†…ç½‘ç«¯å£ 123 ä¸ server A é€šä¿¡, å¹¶ä¸” NAT å°†å…¬ç½‘ç«¯å£ 456 åˆ†é…ç»™ client A çš„ç«¯å£ 123, é‚£ä¹ˆå½“ client A ä½¿ç”¨åŒä¸€ä¸ªç«¯å£ 123 å‘ä»»ä½•å…¶ä»–æœåŠ¡å™¨ (å¦‚ server B) å‘èµ·é€šä¿¡æ—¶, NAT ä»ç„¶ä¼šå°†å…¬ç½‘ç«¯å£ 456 åˆ†é…ç»™ client A çš„ç«¯å£ 123.

- **å¯¹ç§°å‹ NAT (Symmetric NAT)**: æ˜¯ä¸€ç§æ›´ä¸¥æ ¼çš„ NAPT, å®ƒåœ¨è¿›è¡Œ NAT è½¬æ¢æ—¶, ä¸ä»…è€ƒè™‘å†…éƒ¨ä¸»æœºçš„ç§æœ‰ IP åœ°å€å’Œç«¯å£å·, è¿˜è€ƒè™‘é€šä¿¡çš„ç›®çš„åœ°å€. å¯¹äºæ¯ä¸ªæ–°çš„ç›®çš„åœ°, NAT å¯èƒ½ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„å…¬ç½‘ç«¯å£.

  - **ç‰¹ç‚¹**ï¼š**æ˜ å°„ä¾èµ–æ€§**, æ˜ å°„å…³ç³»ä¾èµ–äºç›®çš„åœ°å€. å³ä½¿å†…éƒ¨ä¸»æœºçš„æºç«¯å£ç›¸åŒ, å¦‚æœç›®çš„åœ°å€ä¸åŒ, NAT ä¹Ÿä¼šåˆ†é…ä¸åŒçš„å…¬ç½‘ç«¯å£.

  å¦‚æœ client A å·²ç»ä½¿ç”¨å†…ç½‘ç«¯å£ 123 ä¸ server A é€šä¿¡, å¹¶ä¸” NAT å°†å…¬ç½‘ç«¯å£ 456 åˆ†é…ç»™è¿™ä¸ªé€šä¿¡, é‚£ä¹ˆå½“ client A æƒ³è¦ä¸ server B é€šä¿¡æ—¶, NAT å¯èƒ½ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„å…¬ç½‘ç«¯å£ (å¦‚ 789) ç»™åŒä¸€ä¸ªå†…ç½‘ç«¯å£ 123.

**é”¥å‹ NAT ä¸ å¯¹ç§°å‹ NAT çš„åŒºåˆ«ï¼š**

- **é”¥å‹ NAT (Cone NAT)**ï¼šæ˜ å°„å…³ç³»ä¸ç›®çš„åœ°å€æ— å…³, åªè¦æºåœ°å€ (å†…éƒ¨ä¸»æœºçš„ IP å’Œç«¯å£) ç›¸åŒ, æ˜ å°„å…³ç³»å°±ç›¸åŒ.
- **å¯¹ç§°å‹ NAT**ï¼šæ˜ å°„å…³ç³»ä¸ä»…ä¸æºåœ°å€æœ‰å…³, è¿˜ä¸ç›®çš„åœ°å€æœ‰å…³. å³ä½¿æ˜¯åŒä¸€ä¸ªæºåœ°å€, å¦‚æœç›®çš„åœ°å€ä¸åŒ, æ˜ å°„å…³ç³»ä¹Ÿå¯èƒ½ä¸åŒ.

---

### é”¥å‹ NAT åˆ†ç±»

é”¥å½¢ NAT åˆå¯åˆ†ä¸ºï¼š**å®Œå…¨åœ†é”¥ä½“ (Full Cone NAT)**ã€**å—é™åˆ¶çš„åœ†é”¥ä½“ (Restricted Cone NAT)**ã€**ç«¯å£å—é™åˆ¶çš„åœ†é”¥ä½“ NAT (Port Restricted Cone NAT) ä¸‰ç§**.

#### å®Œå…¨åœ†é”¥ä½“ NAT

Full Cone NAT

**ç‰¹æ€§**

- **æœ€å®½æ¾çš„é™åˆ¶**;
- å†…ç½‘å®¢æˆ·ç«¯ä¸å¤–éƒ¨è®¾å¤‡é€šä¿¡æ—¶, NAT ä¼šåˆ›å»ºä¸€ä¸ªæ˜ å°„ (å†…éƒ¨ IP å’Œç«¯å£åˆ°å¤–éƒ¨ IP å’Œç«¯å£çš„æ˜ å°„) ;
- **ä»»ä½•å¤–éƒ¨è®¾å¤‡**, åªè¦çŸ¥é“è¿™ä¸ªæ˜ å°„çš„å¤–éƒ¨ IP å’Œç«¯å£, éƒ½å¯ä»¥é€šè¿‡è¯¥ç«¯å£ç›´æ¥ä¸å†…ç½‘å®¢æˆ·ç«¯é€šä¿¡;

**è§„åˆ™**

- å†…ç½‘å®¢æˆ·ç«¯ä¸»åŠ¨å‘èµ·è¿æ¥æ—¶, NAT åˆ›å»ºçš„æ˜ å°„æ˜¯å›ºå®šçš„ï¼š**å†…éƒ¨ IP:ç«¯å£ â†’ å¤–éƒ¨ IP(è·¯ç”±å™¨å…¬ç½‘ IP):ç«¯å£**;

- å¤–éƒ¨è®¾å¤‡åªéœ€çŸ¥é“å¤–éƒ¨çš„ IP å’Œç«¯å£, å°±èƒ½å‘åŒ…åˆ°å†…ç½‘å®¢æˆ·ç«¯, **æ— éœ€å†…ç½‘å®¢æˆ·ç«¯ä¸ä¹‹é€šä¿¡è¿‡**;

![20241229154732_VtTs6uzK.webp](https://cdn.dong4j.site/source/image/20241229154732_VtTs6uzK.webp)

å†…éƒ¨æœåŠ¡ `192.168.31.2:123` ä¸»åŠ¨è®¿é—® `30.30.30.30:789` æ—¶. åˆ›å»ºçš„ NAT è®°å½•ä¸º:

```
å†…éƒ¨IP:ç«¯å£ (192.168.31.2:123) â†’ å¤–å€IP:ç«¯å£ (20.20.20.20:456)
```

æ­¤æ—¶ **ä»»ä½•å¤–éƒ¨æœåŠ¡** éƒ½å¯ä»¥é€šè¿‡ `20.20.20.20:456` è®¿é—®åˆ°å†…éƒ¨çš„ `192.168.31.2:123`. å› ä¸º NAT è®¾å¤‡å¹¶ä¸å…³å¿ƒæŠ¥æ–‡çš„æº IP å’Œæºç«¯å£å· (å³æŠ¥æ–‡æ¥è‡ªè°) , åªè¦æ”¶åˆ° **åŒ¹é… NAT è®°å½•çš„æŠ¥æ–‡**, éƒ½èƒ½å‘é€åˆ°å†…ç½‘è®¾å¤‡.

æ­¤æ—¶å†…éƒ¨æœåŠ¡ `192.168.31.2:123` è®¿é—®å…¶ä»–çš„æœåŠ¡æ¯”å¦‚ `40.40.40.40:1234`, å› ä¸ºæºåœ°å€ç›¸åŒ(`192.168.31.2:123`) çš„ç¼˜æ•…, NAT åˆ™ä¸ä¼šå†åˆ›å»ºæ˜ å°„: **NAT ä¸ä¼šä¸ºåŒä¸€ä¸ªå†…ç½‘åœ°å€å’Œç«¯å£ (192.168.1.10:12345)** é’ˆå¯¹ä¸åŒç›®æ ‡æœåŠ¡å™¨åˆ›å»ºå¤šä¸ªæ˜ å°„.

---

#### å—é™åˆ¶çš„åœ†é”¥ä½“ NAT

Restricted Cone NAT

**ç‰¹æ€§**

- **ä¸­ç­‰é™åˆ¶**;
- å†…ç½‘å®¢æˆ·ç«¯å‘èµ·è¿æ¥æ—¶, NAT ä¼šåˆ›å»ºä¸€ä¸ªæ˜ å°„;
- **åªæœ‰å®¢æˆ·ç«¯ä¸»åŠ¨é€šä¿¡è¿‡çš„å¤–éƒ¨è®¾å¤‡**, æ‰èƒ½é€šè¿‡è¯¥æ˜ å°„è®¿é—®å†…ç½‘å®¢æˆ·ç«¯(**è®°å½•å…è®¸çš„ IP**).

**è§„åˆ™**

- å†…ç½‘å®¢æˆ·ç«¯å‘èµ·è¿æ¥æ—¶, NAT åˆ›å»ºæ˜ å°„ï¼š**å†…éƒ¨ IP:ç«¯å£ â†’ å¤–éƒ¨ IP(è·¯ç”±å™¨å…¬ç½‘ IP):ç«¯å£ â†’ å…è®¸ç›®æ ‡ IP**
- åªæœ‰å®¢æˆ·ç«¯é€šä¿¡è¿‡çš„å¤–éƒ¨è®¾å¤‡ (å³ç›®æ ‡ IP åœ¨ NAT æ˜ å°„è®°å½•ä¸­ä¸”é€šè®¯è¿‡çš„å¤–éƒ¨è®¾å¤‡, è®°è¿˜è¦åŒ¹é…å…è®¸çš„ IP) , æ‰èƒ½é€šè¿‡æ˜ å°„è®¿é—®å®¢æˆ·ç«¯.
- å¤–éƒ¨è®¾å¤‡å‘æ¥çš„æ•°æ®åŒ…, **å¿…é¡»ä¸å®¢æˆ·ç«¯é€šä¿¡çš„å¤–éƒ¨ IP å’Œç«¯å£ ä¸€è‡´**.

![20241229154732_NPRlSHn6.webp](https://cdn.dong4j.site/source/image/20241229154732_NPRlSHn6.webp)

å†…éƒ¨æœåŠ¡ `192.168.31.2:123` ä¸»åŠ¨è®¿é—® `30.30.30.30:789` æ—¶. åˆ›å»ºçš„ NAT è®°å½•ä¸º:

```
å†…ç½‘IP:ç«¯å£ (192.168.31.2:123) â†’ å¤–éƒ¨IP:ç«¯å£ (20.20.20.20:456) â†’ å…è®¸ç›®æ ‡IP (30.30.30.30)
```

æ­¤æ—¶åªæœ‰æ¥è‡ª `30.30.30.30` ä»»æ„ç«¯å£çš„è¯·æ±‚æ‰èƒ½é€šè¿‡ `20.20.20.20:456` è®¿é—®åˆ°å†…éƒ¨çš„ `192.168.31.2:123`.

æ¯”å¦‚æ¥è‡ª `40.40.40.40` çš„è¯·æ±‚åˆ™ä¸èƒ½è®¿é—®å†…éƒ¨æœåŠ¡, **å› ä¸ºå®ƒæ²¡æœ‰åœ¨å…è®¸ç›®æ ‡åœ°å€ä¸­(å†…ç½‘è®¾å¤‡æ­£åœ¨ä¸å“ªäº›å¤–éƒ¨è®¾å¤‡é€šä¿¡)** æ­¤æ—¶å¿…é¡»ç”±å†…éƒ¨æœåŠ¡å…ˆå‘èµ·è¯·æ±‚(`40.40.40.40:xxx`) ä»¥å¢åŠ æ–°çš„å…è®¸çš„ç›®æ ‡ IP è®°å½•æ‰èƒ½è®© Server C è®¿é—®:

```
å†…ç½‘IP:ç«¯å£ (192.168.31.2:123) â†’ å¤–éƒ¨IP:ç«¯å£ (20.20.20.20:456) â†’ å…è®¸ç›®æ ‡IP (30.30.30.30 & 40.40.40.40)
```

> è¿™æ ·çš„ NAT å®‰å…¨æ€§æœ‰ä¸€å®šçš„æé«˜, ä½†æ˜¯ä¹Ÿæé«˜äº†æ‰“æ´éš¾åº¦. ä¸¤å°å†…ç½‘è®¾å¤‡éœ€è¦äº’ç›¸ç»™å¯¹æ–¹å‘é€ä¸€ä¸ªæŠ¥æ–‡, æ‰èƒ½æ‰“æ´æˆåŠŸ.

---

#### ç«¯å£å—é™åˆ¶çš„åœ†é”¥ä½“ NAT

Port Restricted Cone NAT

**ç‰¹æ€§**

- **æœ€ä¸¥æ ¼çš„é™åˆ¶**;
- å†…ç½‘å®¢æˆ·ç«¯å‘èµ·è¿æ¥æ—¶, NAT ä¼šåˆ›å»ºä¸€ä¸ªæ˜ å°„;
- **åªæœ‰å®¢æˆ·ç«¯ä¸»åŠ¨é€šä¿¡è¿‡çš„å¤–éƒ¨è®¾å¤‡**, æ‰èƒ½é€šè¿‡è¯¥æ˜ å°„è®¿é—®å†…ç½‘å®¢æˆ·ç«¯(**è®°å½•å…è®¸çš„ IP + Port**).

**è§„åˆ™**

- å†…ç½‘å®¢æˆ·ç«¯å‘èµ·è¿æ¥æ—¶, NAT åˆ›å»ºæ˜ å°„ï¼š**å†…éƒ¨ IP:ç«¯å£ â†’ å¤–éƒ¨ IP(è·¯ç”±å™¨å…¬ç½‘ IP):ç«¯å£ â†’ å…è®¸çš„ç›®æ ‡ IP+ç«¯å£**

- å¤–éƒ¨è®¾å¤‡å‘æ¥çš„æ•°æ®åŒ…, **å¿…é¡»ä¸å®¢æˆ·ç«¯é€šä¿¡çš„å¤–éƒ¨ IP å’Œç«¯å£ ä¸€è‡´**.

- æ¯”å—é™åˆ¶çš„åœ†é”¥ä½“ NAT å¢åŠ äº†ä¸€å±‚å¯¹ **ç«¯å£** çš„é™åˆ¶.

![20241229154732_fwclbrwC.webp](https://cdn.dong4j.site/source/image/20241229154732_fwclbrwC.webp)

å†…éƒ¨æœåŠ¡ `192.168.31.2:123` ä¸»åŠ¨è®¿é—® `30.30.30.30:789` æ—¶. åˆ›å»ºçš„ NAT è®°å½•ä¸º:

```
å†…ç½‘IP:ç«¯å£ (192.168.31.2:123) â†’ å¤–éƒ¨IP:ç«¯å£ (20.20.20.20:456) â†’ å…è®¸çš„ç›®æ ‡IP:ç«¯å£ (30.30.30.30:789)
```

æ­¤æ—¶æ¥è‡ª `30.30.30.30` **ä¸”ç«¯å£æ˜¯** `789` çš„è¯·æ±‚æ‰èƒ½é€šè¿‡ `20.20.20.20:456` è®¿é—®åˆ°å†…éƒ¨çš„ `192.168.31.2:123`.

åŒç†å¦‚æœæƒ³è®© `30.30.30.30:987` ä¹Ÿèƒ½è®¿é—® `192.168.31.2.123`, åˆ™å¿…é¡» **ç”±å†…éƒ¨æœåŠ¡å…ˆå‘èµ·è¯·æ±‚ä»¥æ–°å¢å…è®¸çš„ç›®æ ‡ IP+ç«¯å£è®°å½•**:

```
å†…ç½‘IP:ç«¯å£ (192.168.31.2:123) â†’ å¤–éƒ¨IP:ç«¯å£ (20.20.20.20:456) â†’ å…è®¸çš„ç›®æ ‡IP:ç«¯å£ (30.30.30.30:789 & 30.30.30.30:987)
```

---

#### æ€»ç»“

ä¸å®Œå…¨åœ†é”¥å½¢ NAT ç›¸æ¯”, å—é™åœ†é”¥å½¢ NAT åœ¨å†…ç½‘è®¾å¤‡å‘å¤–å‘é€æŠ¥æ–‡æ—¶, è·¯ç”±å™¨é™¤äº†ç”Ÿæˆ NAT è®°å½•, è¿˜ä¼šæ ¹æ®æŠ¥æ–‡çš„ç›®çš„ IP, **è®°å½•ä¸‹å†…ç½‘è®¾å¤‡æ­£åœ¨ä¸å“ªäº›å¤–éƒ¨è®¾å¤‡é€šä¿¡.**

è¿™æ ·, åªæœ‰å†…ç½‘è®¾å¤‡å…ˆå‘é€æŠ¥æ–‡ç»™å¤–éƒ¨è®¾å¤‡, å¤–éƒ¨è®¾å¤‡å›åº”çš„æŠ¥æ–‡, æ‰ä¼šè¢«è½¬å‘åˆ°å†…ç½‘è®¾å¤‡. è€Œå…¶ä»–å¤–éƒ¨è®¾å¤‡å‘é€è¿‡æ¥çš„æŠ¥æ–‡, å³ä½¿åŒ¹é… NAT è®°å½•, ä¹Ÿæ— æ³•å‘é€åˆ°å†…ç½‘è®¾å¤‡.

è€Œ **å—é™åˆ¶çš„åœ†é”¥ä½“ NAT** ä¸ **ç«¯å£å—é™åˆ¶çš„åœ†é”¥ä½“ NAT** æœ€æ˜¾è‘—çš„åŒºåˆ«æ˜¯å—é™åˆ¶çš„èŒƒå›´ä¸ä¸€æ ·: åè€…ç›¸å¯¹äºå‰è€…æ·»åŠ äº† **ç«¯å£** çš„é™åˆ¶.

æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ **åœ†é”¥å½¢ NAT** çš„å®šä¹‰: **ä¸€æ—¦å†…éƒ¨ä¸»æœºçš„ç§æœ‰ç«¯å£æ˜ å°„åˆ°å…¬ç½‘çš„ä¸€ä¸ªç«¯å£, æ— è®ºç›®çš„åœ°å€æ˜¯ä»€ä¹ˆ, è¿™ä¸ªæ˜ å°„å…³ç³»éƒ½ä¿æŒä¸å˜.**

è€Œä¸Šè¿°ä¸‰ç§ **åœ†é”¥å½¢ NAT** çš„ç¤ºä¾‹ä¸­è‡ªå§‹è‡³ç»ˆéƒ½åªæœ‰ 1 æ¡ NAT è®°å½•, ä¸åŒçš„æ˜¯ **æ˜¯å¦éœ€è¦é€šè¿‡å…è®¸çš„åœ°å€æ¥æ”¾è¡Œè¯·æ±‚**(ä¸è°é€šä¿¡è¿‡çš„è®°å½•).

è€Œ **å¯¹ç§°å‹ NAT** ä¼šåŒæ—¶æ ¹æ®å†…ç½‘è®¾å¤‡å‡ºæ–¹å‘æŠ¥æ–‡çš„ **æº IP**ã€**æºç«¯å£å·**ã€**ç›®çš„ IP**ã€**ç›®çš„ç«¯å£å·** å››ä¸ªä¿¡æ¯æ¥å»ºç«‹ NAT è®°å½•. å¦‚æœæŠ¥æ–‡çš„ç›®çš„ IPã€ç›®çš„ç«¯å£å·å‘ç”Ÿäº†å˜åŒ–, æ˜ å°„åˆ°çš„å¤–éƒ¨ç«¯å£å·ä¹Ÿä¼šå‘ç”Ÿæ”¹å˜.

![20241229154732_bXSwBRvy.webp](https://cdn.dong4j.site/source/image/20241229154732_bXSwBRvy.webp)

å†…ç½‘è®¾å¤‡é¦–å…ˆå’Œ ServerA é€šä¿¡, å†…ç½‘ IP å’Œå†…ç½‘ç«¯å£å·ä¼šè¢«æ˜ å°„ä¸ºä¸€ä¸ªå¤–éƒ¨ IP å’Œå¤–éƒ¨ç«¯å£å·:

```
å†…ç½‘IP:ç«¯å£ (192.168.31.2:123) â†’ å¤–éƒ¨IP:ç«¯å£ (20.20.20.20:456)
```

æ¥ä¸‹æ¥, å†…ç½‘è®¾å¤‡å’Œå¦ä¸€å°è®¾å¤‡ (Server B)é€šä¿¡, ç›¸åŒçš„å†…ç½‘ IP å’Œå†…ç½‘ç«¯å£å·, åˆä¼šè¢«æ˜ å°„ä¸ºå¦å¤–ä¸€ä¸ªå¤–éƒ¨ç«¯å£å·:

```
å†…ç½‘IP:ç«¯å£ (192.168.31.2:123) â†’ å¤–éƒ¨IP:ç«¯å£ (20.20.20.20:1456)
```

æˆ‘ä»¬ä»¥å‰æ–‡è¯´çš„ [UDP æ‰“æ´](#ç‚¹å¯¹ç‚¹ (P2P) ç½‘ç»œé€šä¿¡) ä¸ºä¾‹, è¯´è¯´ä¸ºä»€ä¹ˆ **å¯¹ç§°å‹ NAT** æ— æ³•æˆåŠŸæ‰“æ´:

ç¬¬ä¸€æ­¥éƒ½æ˜¯ä¸€æ ·çš„, A å’Œ B åŒæ—¶å‘ Server å‘é€æ•°æ®, è¿™æ—¶ä¼šåˆ†åˆ«åœ¨ NAT è®¾å¤‡ä¸Šç”Ÿæˆå¯¹åº”çš„ NAT è®°å½•, åŒæ—¶ Server è®°å½•è®¾å¤‡ A å’Œ B å¯¹åº”çš„å¤–ç½‘ IP å’Œç«¯å£:

![20241229154732_GlDOpN6t.webp](https://cdn.dong4j.site/source/image/20241229154732_GlDOpN6t.webp)

ç¬¬äºŒæ­¥æ˜¯ Server å°†å¯¹åº”çš„å…¬ç½‘ IP å’Œå¤–éƒ¨ç«¯å£å‘é€ç»™ A å’Œ B, è®©å®ƒä»¬äº’ç›¸è®¿é—®:

![20241229154732_Nj3UnNvf.webp](https://cdn.dong4j.site/source/image/20241229154732_Nj3UnNvf.webp)

æ­¤æ—¶åœ¨ä¸¤ç«¯çš„ NAT è®¾å¤‡ä¸Šå„æ–°å¢äº†ä¸€æ¡ NAT è®°å½•, ä½†å› ä¸º **å¯¹ç§°å‹ NAT** çš„ç‰¹æ€§, å› ä¸ºç›®æ ‡åœ°å€ä¸åŒ(IP æˆ–ç«¯å£ä¸åŒ), å³ä½¿æ˜¯åŒä¸€ä¸ªå†…ç½‘ IP é€šè¿‡ç›¸åŒçš„ç«¯å£å‘é€æ•°æ®åŒ…, åœ¨ NAT è®¾å¤‡ç”Ÿæˆçš„ NAT è®°å½•çš„å¤–éƒ¨ç«¯å£ä¹Ÿä¼šä¸ä¸€æ ·, å³è¿™æ¬¡ç”Ÿæˆçš„å¤–éƒ¨ç«¯å£ä¸º `1456`, ç» NAT è½¬æ¢å, æºåœ°å€ä¸º: `20.20.20.20:1456` ç›®æ ‡åœ°å€ä¸º `40.40.40.40:789`.

è€Œ B ç«¯ NAT è®°å½•ä¸­çš„ `40.40.40.40:789` åªèƒ½è¢«æºåœ°å€ä¸º `30.30.30.30:5678` è®¿é—®, æ‰€ä»¥ A å‘é€ç»™ B çš„æ•°æ®åŒ…è¢«ä¸¢å¤±, å¯¼è‡´æ‰“æ´å¤±è´¥.

---

### NAT ç±»å‹æ€»ç»“

åŸºæœ¬çš„ NAT, å®ƒä»…å°†å†…ç½‘ä¸»æœºçš„ç§æœ‰ IP åœ°å€è½¬æ¢æˆå…¬ç½‘ IP åœ°å€, ä½†å¹¶ä¸å°† TCP/UDP ç«¯å£ä¿¡æ¯è¿›è¡Œè½¬æ¢, æœ‰åŠ¨æ€ä¸é™æ€ä¹‹åŒºåˆ†. ç”±äºç°åœ¨å¤§éƒ¨åˆ†éƒ½å±äºå¦ä¸€ç§ç±»å‹, å³ NAPT, å…¶ä¸­å¯¹ç§° NAT æ‰“æ´å›°éš¾å¾ˆé«˜, ä½†æ˜¯å®‰å…¨æ€§å¥½ï¼›è€Œé”¥å‹ NAT æ‰“æ´æ¯”è¾ƒå®¹æ˜“.

å®é™…ä¸Šå¤§éƒ¨è¿è¥å•†æä¾›çš„ **å…‰çŒ«ä¸Šç½‘æœåŠ¡éƒ½æ˜¯é”¥å½¢ NAT**. **è€Œå…‰çº¤å…¥æˆ·, 4G, 5G ç½‘ç»œ, å…¬å…± WiFi ç­‰å› ä¸ºå®‰å…¨å› ç´ éƒ½æ˜¯å¯¹ç§° NAT**, å¦å¤–ç›®å‰**ç»å¤§å¤šæ•°çš„è·¯ç”±å™¨éƒ½æ˜¯éå¯¹ç§°å‹ NAT(Cone NAT)**. åªè¦è¯·æ±‚é“¾æ¥çš„å¯¹æ–¹æ˜¯éç«¯å£é™åˆ¶é”¥å‹ nat å°±éƒ½èƒ½å®ç°æ‰“æ´ P2P é“¾æ¥çš„.

åªæœ‰åŒæ–¹éƒ½æ˜¯ **å¯¹ç§° NAT** æ˜¯ä¸€å®šæ— æ³•å®ç°, æˆ–ä¸€æ–¹å¯¹ç§°ä¸€æ–¹æ˜¯ ç«¯å£é™åˆ¶é”¥å‹ NAT çš„æƒ…å†µä¹Ÿæ— æ³•å®ç°æ‰“æ´. ä¸‹é¢æ˜¯å„ç§ç±»å‹æ‰“æ´æ€»ç»“:

| å‘é€ç«¯ NAT ç±»å‹    | æ¥æ”¶ç«¯ NAT ç±»å‹    | æ˜¯å¦èƒ½æ‰“æ´ |
| ------------------ | ------------------ | ---------- |
| å®Œå…¨é”¥å½¢ NAT       | å®Œå…¨é”¥å½¢ NAT       | âœ…         |
| å®Œå…¨é”¥å½¢ NAT       | IP é™åˆ¶æ€§é”¥å½¢ NAT  | âœ…         |
| å®Œå…¨é”¥å½¢ NAT       | ç«¯å£é™åˆ¶æ€§é”¥å½¢ NAT | âœ…         |
| å®Œå…¨é”¥å½¢ NAT       | å¯¹ç§°å¼ NAT         | âœ…         |
| IP é™åˆ¶æ€§é”¥å½¢ NAT  | IP é™åˆ¶æ€§é”¥å½¢ NAT  | âœ…         |
| IP é™åˆ¶æ€§é”¥å½¢ NAT  | ç«¯å£é™åˆ¶æ€§é”¥å½¢ NAT | âœ…         |
| IP é™åˆ¶æ€§é”¥å½¢ NAT  | å¯¹ç§°å¼ NAT         | âœ…         |
| ç«¯å£é™åˆ¶æ€§é”¥å½¢ NAT | ç«¯å£é™åˆ¶æ€§é”¥å½¢ NAT | âœ…         |
| ç«¯å£é™åˆ¶æ€§é”¥å½¢ NAT | å¯¹ç§°å¼ NAT         | ğŸš«         |
| å¯¹ç§°å¼ NAT         | å¯¹ç§°å¼ NAT         | ğŸš«         |

---

## NAT ç±»å‹æå‡

ç®€å•å›é¡¾ä¸€ä¸‹, NAT çš„ 4 ä¸ªç±»å‹, å®ƒä»¬åˆ†åˆ«æ˜¯ï¼š**NAT1ã€NAT2ã€NAT3ã€NAT4**

- **NAT1: Full Cone NAT**, å…¨é”¥å½¢ NAT, è¿™æ˜¯æœ€å®½æ¾çš„ç½‘ç»œç¯å¢ƒ, ä½ æƒ³åšä»€ä¹ˆ, åŸºæœ¬æ²¡å•¥é™åˆ¶ IP å’Œç«¯å£éƒ½ä¸å—é™
- **NAT2: Address-Restricted Cone NAT**, å—é™é”¥å‹ NAT, ç›¸æ¯” NAT1, NAT2 å¢åŠ äº†åœ°å€é™åˆ¶, ä¹Ÿå°±æ˜¯ IP å—é™, è€Œç«¯å£ä¸å—é™
- **NAT3: Port-Restricted Cone NAT**, ç«¯å£å—é™é”¥å‹, ç›¸æ¯” NAT2, NAT3 å¢åŠ äº†ç«¯å£é™åˆ¶, å³ IPã€ç«¯å£éƒ½å—é™
- **NAT4: Symmetric NAT**, å¯¹ç§°å‹ NAT, å¯¹ç§°å‹ NAT å…·æœ‰ç«¯å£å—é™é”¥å‹çš„å—é™ç‰¹æ€§, å†…éƒ¨åœ°å€æ¯ä¸€æ¬¡è¯·æ±‚ä¸€ä¸ªç‰¹å®šçš„å¤–éƒ¨åœ°å€, éƒ½ä¼šç»‘å®šåˆ°ä¸€ä¸ªæ–°çš„ç«¯å£. è¿™ç§ç±»å‹åŸºæœ¬ä¸Šå°±å‘Šåˆ« P2P äº†

ä» NAT1 åˆ° NAT4 é™åˆ¶è¶Šæ¥è¶Šå¤š, ä¸ºäº†æ»¡è¶³å„ç§éœ€æ±‚, æˆ‘ä»¬å¸Œæœ›æå‡ NAT ç±»å‹. æå‡ NAT ç±»å‹çš„å¥½å¤„æœ‰, æµè§ˆç½‘é¡µã€è§‚çœ‹è§†é¢‘ã€æ¸¸æˆç­‰æ›´é¡ºç•…, ä¸‹è½½é€Ÿåº¦æ›´ç¨³å®šå¿«é€Ÿ, ç‰¹åˆ«æ˜¯å¯¹é‚£äº›ç©æ¸¸æˆçš„, æå‡æ”¹å–„ NAT ç±»å‹åè”æœºé€Ÿåº¦æ›´å¿«, æ¸¸æˆä½“éªŒæ˜æ˜¾æé«˜.

### ä½å»¶è¿Ÿæ–¹æ¡ˆ

> æƒ³è¦æ¸¸æˆç½‘é€Ÿå¿«, å»¶è¿Ÿä½, å°±è¦ nat1, å…¬ç½‘, æ¡¥æ¥, unpn, ç¡¬ä»¶ nat åŠ é€Ÿ

- **ä¿®æ”¹å…‰çŒ«å·¥ä½œæ¨¡å¼**

  æŠŠå…‰çŒ«å·¥ä½œæ¨¡å¼è®¾ç½®ä¸ºæ¡¥æ¥æ¨¡å¼(éœ€è¦è¶…çº§ç®¡ç†å‘˜è´¦å·å¯†ç , å¾ˆå¤šéƒ½æ˜¯é»˜è®¤, å¯ä»¥æ ¹æ®åœ°åŒºä¸Šç½‘æœç´¢, æ–°æ¬¾çš„ç›´æ¥è”ç³»ç»´ä¿®å·¥äºº), ä¿®æ”¹æ¨¡å¼, å› ä¸ºè¿è¥å•†ä¸€èˆ¬é»˜è®¤è®¾ç½®å…‰çŒ«å·¥ä½œåœ¨è·¯ç”±æ¨¡å¼. æ— çº¿è·¯ç”±å™¨ç›´æ¥è¿åˆ°çŒ«ä¸Šå°±å¯ä»¥ä¸Šç½‘çš„, é‚£ä¹ˆå…‰çŒ«æ˜¯è·¯ç”±æ¨¡å¼. **æ— çº¿è·¯ç”±å™¨éœ€è¦ PPPoE æ‹¨å·ä¸Šç½‘çš„å°±æ˜¯æ¡¥æ¥æ¨¡å¼**.

- **æ›´æ”¹è·¯ç”±å™¨è®¾ç½®**

  å¯ç”¨æ— çº¿è·¯ç”±å™¨çš„ uPnP åŠŸèƒ½, uPnP å¤§éƒ¨åˆ†è·¯ç”±å™¨éƒ½æ”¯æŒ. æŠŠè¦æå‡ NAT ç±»å‹çš„ä¸»æœº IP è®¾ç½®ä¸ºé™æ€, ç„¶åå¼€å¯ DMZ(é€šè¿‡è·¯ç”±å™¨æ‹¨å·, è·¯ç”±å™¨æœ€å¥½è¦åˆ·æœº, ç„¶åé€‰æ‹© NAT1 æ¨¡å¼)

### æ€»ç»“

- è·¯ç”±å™¨å±‚æ•°è¶Šå°‘, è¶Šå¯èƒ½å¾—åˆ° NAT1 å’Œ NAT2 ç±»å‹

- NAT1 æ˜¯æœ€å®½æ¾çš„ç½‘ç»œç¯å¢ƒ, åŸºæœ¬æ²¡é™åˆ¶. NAT4 æ˜¯æœ€ä¸¥æ ¼çš„ç½‘ç»œç¯å¢ƒ, å¯èƒ½ä¼šç©ä¸äº†æ¸¸æˆã€P2P ä¸‹è½½éƒ½æ²¡é€Ÿåº¦

- å¦‚æœå…‰çŒ«æ˜¯æ¡¥æ¥æ¨¡å¼, è·¯ç”±å™¨æ‹¨å·ä¸Šç½‘çš„æœ‰å¯èƒ½æ˜¯ NAT2 å’Œ NAT3, å¯¹ä¸Šç½‘ã€æ¸¸æˆå’Œä¸‹è½½éƒ½æ²¡æœ‰å¤ªå¤šé™åˆ¶

- æ‹¨å·èƒ½è·å¾—å…¬ç½‘ IP çš„, å¯ä»¥ä¼˜åŒ–åˆ° NAT1, æ‹¨å·è·å¾—å†…ç½‘ IP åŸºæœ¬æ˜¯ NAT4

- ä¸­å›½ç”µä¿¡ã€ä¸­å›½è”é€šå®½å¸¦ä¸€èˆ¬æ˜¯å…¬ç½‘ IP, ä¸­å›½ç§»åŠ¨ã€ä¸­å›½å¹¿ç”µã€é•¿å®½ç­‰åŸºæœ¬æ˜¯å†…ç½‘ IP.

  å› ä¸ºç§»åŠ¨å…¬ç½‘ ip æ± æ¯”å…¶ä»–è¿è¥å•†å°‘, æ‰€ä»¥ä¸€èˆ¬éƒ½ç”¨å¯¹ç§°å‹ nat(èŠ‚çº¦å…¬ç½‘ ip, å› ä¸ºæ–­å¼€è¿æ¥å°±ä¼šè§£ç»‘æ˜ å°„, ä¸è¿‡ç»‘å®šå…³ç³»çš„å»ºç«‹å’Œè§£é™¤ä¼šæ¶ˆè€— cpu æ€§èƒ½, æ‰€ä»¥ç§»åŠ¨æ‰“æ¸¸æˆæ—¶ä¸æ—¶è·³ ping)

---

## UPnP

**UPnP** (Universal Plug and Play) æ˜¯ä¸€ç§ç½‘ç»œåè®®, å…è®¸è®¾å¤‡åœ¨ç½‘ç»œä¸­è‡ªåŠ¨å‘ç°å½¼æ­¤, å¹¶é€šè¿‡ç½‘ç»œè¿›è¡Œäº’æ“ä½œ. UPnP ä½¿è®¾å¤‡èƒ½å¤Ÿåœ¨ç½‘ç»œä¸­åŠ¨æ€åœ°å‘ç°ã€æ§åˆ¶å’Œé…ç½®å…¶ä»–è®¾å¤‡, è€Œæ— éœ€æ‰‹åŠ¨é…ç½®. å®ƒå¹¿æ³›åº”ç”¨äºå®¶åº­å’ŒåŠå…¬ç¯å¢ƒä¸­, ç‰¹åˆ«æ˜¯åœ¨æ¶‰åŠåˆ°ç½‘ç»œè®¾å¤‡ä¹‹é—´çš„åä½œæ—¶.

**ä¸»è¦ç‰¹ç‚¹**

1. **è‡ªåŠ¨å‘ç°**ï¼šè®¾å¤‡èƒ½å¤Ÿè‡ªåŠ¨å‘ç°ç½‘ç»œä¸­çš„å…¶ä»–è®¾å¤‡, å¹¶èƒ½å¤Ÿä¸å…¶è¿›è¡Œé€šä¿¡. ä¾‹å¦‚, æ™ºèƒ½å®¶ç”µã€è·¯ç”±å™¨ã€æ‰“å°æœºç­‰è®¾å¤‡é€šè¿‡ UPnP åè®®å¯ä»¥è‡ªåŠ¨è¿æ¥å¹¶ç›¸äº’é…åˆ.

2. **é›¶é…ç½®**ï¼šè®¾å¤‡ä¸éœ€è¦ç”¨æˆ·è¿›è¡Œå¤æ‚çš„ç½‘ç»œé…ç½® (å¦‚ IP åœ°å€æˆ–ç«¯å£æ˜ å°„) , UPnP è‡ªåŠ¨å®Œæˆè¿™äº›æ“ä½œ.

3. **è®¾å¤‡æ§åˆ¶**ï¼šé€šè¿‡ UPnP åè®®, å¯ä»¥æ§åˆ¶å…¶ä»–è®¾å¤‡çš„åŠŸèƒ½, å¦‚æ’­æ”¾éŸ³ä¹ã€æ§åˆ¶è§†é¢‘æ’­æ”¾ã€ç½‘ç»œæ‘„åƒå¤´çš„è°ƒèŠ‚ç­‰.

**UPnP ä¸ NAT çš„å…³ç³»**

**NAT** (Network Address Translation) æ˜¯ä¸€ç§ç”¨äºç½‘ç»œå±‚çš„æŠ€æœ¯, ç”¨æ¥å°†å†…ç½‘è®¾å¤‡çš„ç§æœ‰ IP åœ°å€è½¬æ¢ä¸ºå…¬å…± IP åœ°å€, ä½¿å¾—å¤šä¸ªè®¾å¤‡èƒ½å¤Ÿå…±äº«ä¸€ä¸ªå…¬å…± IP åœ°å€. NAT çš„å…¸å‹åº”ç”¨åœºæ™¯æ˜¯å®¶åº­è·¯ç”±å™¨, å®ƒå°†å†…ç½‘è®¾å¤‡çš„è¯·æ±‚æ˜ å°„åˆ°ä¸€ä¸ªå…¬å…±çš„ IP åœ°å€ä¸Š, ä»è€Œå…è®¸å¤šä¸ªè®¾å¤‡é€šè¿‡ä¸€ä¸ªå…¬å…± IP åœ°å€è®¿é—®äº’è”ç½‘.

ç„¶è€Œ, NAT ä¼šå¸¦æ¥ä¸€äº›é—®é¢˜, å°¤å…¶æ˜¯å½“å¤šä¸ªè®¾å¤‡éœ€è¦ä¸å¤–éƒ¨è®¾å¤‡è¿›è¡Œç‚¹å¯¹ç‚¹é€šä¿¡æ—¶. ä¾‹å¦‚, NAT ä¸ä¼šè‡ªåŠ¨å°†å¤–éƒ¨è®¾å¤‡çš„è¯·æ±‚è½¬å‘åˆ°å†…ç½‘è®¾å¤‡, å› æ­¤éœ€è¦æ‰‹åŠ¨é…ç½®ç«¯å£æ˜ å°„ (ç«¯å£è½¬å‘) , æ‰èƒ½å…è®¸å¤–éƒ¨è®¾å¤‡é€šè¿‡å…¬å…± IP åœ°å€è®¿é—®å†…ç½‘è®¾å¤‡.

**UPnP å¦‚ä½•å¸®åŠ© NAT ç©¿é€**

å…·ä½“æ¥è¯´, UPnP åè®®å…è®¸å†…ç½‘è®¾å¤‡é€šè¿‡ UPnP åè®®è‡ªåŠ¨è¯·æ±‚è·¯ç”±å™¨å¼€æ”¾ç‰¹å®šçš„ç«¯å£å¹¶è¿›è¡Œç«¯å£æ˜ å°„. è¿™ä½¿å¾—å†…ç½‘è®¾å¤‡èƒ½å¤Ÿåœ¨ä¸æ‰‹åŠ¨é…ç½®ç«¯å£è½¬å‘çš„æƒ…å†µä¸‹, å…è®¸å¤–éƒ¨è®¾å¤‡è®¿é—®å†…ç½‘æœåŠ¡, çªç ´äº† NAT çš„é™åˆ¶.

**UPnP å·¥ä½œåŸç†**

1. **è®¾å¤‡å‘ç°**ï¼šå†…ç½‘è®¾å¤‡ (å¦‚è®¡ç®—æœºã€æ¸¸æˆä¸»æœºã€æ™ºèƒ½æ‘„åƒå¤´ç­‰) é€šè¿‡å‘é€ **SSDP** (Simple Service Discovery Protocol) è¯·æ±‚, å¯»æ‰¾æ”¯æŒ UPnP åè®®çš„è·¯ç”±å™¨.

2. **ç«¯å£æ˜ å°„è¯·æ±‚**ï¼šå†…ç½‘è®¾å¤‡é€šè¿‡ UPnP å‘è·¯ç”±å™¨å‘é€è¯·æ±‚, è¦æ±‚è·¯ç”±å™¨å°†æŒ‡å®šçš„ç«¯å£æ˜ å°„åˆ°è®¾å¤‡çš„ IP åœ°å€å’Œç«¯å£ä¸Š. è·¯ç”±å™¨é€šå¸¸ä¼šå“åº”å¹¶å°†ç«¯å£æ˜ å°„æ·»åŠ åˆ° NAT è¡¨ä¸­.

3. **å¤–éƒ¨è®¿é—®**ï¼šå¤–éƒ¨è®¾å¤‡é€šè¿‡è·¯ç”±å™¨çš„å…¬å…± IP åœ°å€å’Œå¼€æ”¾çš„ç«¯å£è®¿é—®å†…ç½‘è®¾å¤‡. è·¯ç”±å™¨æ ¹æ® UPnP é…ç½®çš„ç«¯å£æ˜ å°„, å°†è¯·æ±‚è½¬å‘åˆ°æ­£ç¡®çš„å†…ç½‘è®¾å¤‡.

**NAT ç©¿é€çš„åº”ç”¨åœºæ™¯**

UPnP ç‰¹åˆ«é€‚ç”¨äºä»¥ä¸‹å‡ ç§æƒ…å†µï¼š

- **VoIP å’Œè§†é¢‘é€šè¯**ï¼šé€šè¿‡ UPnP è‡ªåŠ¨é…ç½®ç«¯å£æ˜ å°„, ä½¿å¾— VoIP æˆ–è§†é¢‘ä¼šè®®å¯ä»¥ç©¿é€ NAT, ç›´æ¥è¿›è¡Œé€šä¿¡.

- **P2P æ–‡ä»¶å…±äº«**ï¼šå¦‚ BitTorrentã€åœ¨çº¿æ¸¸æˆç­‰, å†…ç½‘ç”¨æˆ·é€šè¿‡ UPnP è‡ªåŠ¨åˆ›å»ºç«¯å£æ˜ å°„, ä½¿å¾—å¤–éƒ¨ç”¨æˆ·èƒ½å¤Ÿç›´æ¥è¿æ¥åˆ°å†…ç½‘ç”¨æˆ·.

- **æ¸¸æˆæ§åˆ¶å°**ï¼šå¦‚ Xbox æˆ– PlayStation, è®¾å¤‡é€šè¿‡ UPnP è¯·æ±‚å¼€æ”¾ç«¯å£ä»¥ä¾¿ä¸å…¶ä»–è®¾å¤‡è¿›è¡Œè”ç½‘å¯¹æˆ˜.

**UPnP çš„å®‰å…¨æ€§é—®é¢˜**

è™½ç„¶ UPnP æä¾›äº†ä¾¿åˆ©æ€§, ä½†ä¹Ÿå­˜åœ¨ä¸€äº›å®‰å…¨éšæ‚£ï¼š

1. **è‡ªåŠ¨ç«¯å£æ˜ å°„**ï¼šå¦‚æœ UPnP åŠŸèƒ½å¯ç”¨, è·¯ç”±å™¨ä¼šå…è®¸å†…ç½‘è®¾å¤‡è‡ªåŠ¨è¯·æ±‚ç«¯å£æ˜ å°„, è¿™æ„å‘³ç€æ¶æ„è½¯ä»¶ä¹Ÿå¯ä»¥é€šè¿‡ UPnP è¯·æ±‚å°†æŸäº›ç«¯å£æš´éœ²åˆ°å¤–éƒ¨ç½‘ç»œ.

2. **æœªç»æˆæƒçš„è®¾å¤‡è®¿é—®**ï¼šæœªç»æˆæƒçš„è®¾å¤‡å¯èƒ½ä¼šé€šè¿‡ UPnP è¯·æ±‚ç«¯å£æ˜ å°„, å…è®¸å¤–éƒ¨æ”»å‡»è€…è®¿é—®å†…ç½‘è®¾å¤‡.

3. **é˜²ç«å¢™ç»•è¿‡**ï¼šæ¶æ„è½¯ä»¶å¯ä»¥é€šè¿‡ UPnP è‡ªåŠ¨æ‰“å¼€ç«¯å£, ä»è€Œç»•è¿‡é˜²ç«å¢™, è·å–ä¸åº”æœ‰çš„ç½‘ç»œè®¿é—®æƒé™.

**æ€»ç»“**

- **UPnP** æ˜¯ä¸€ç§ä½¿è®¾å¤‡èƒ½å¤Ÿè‡ªåŠ¨å‘ç°å¹¶äº’ç›¸é€šä¿¡çš„åè®®, å¹¿æ³›åº”ç”¨äºå®¶åº­å’ŒåŠå…¬ç½‘ç»œä¸­.

- **NAT** ä¼šé˜»æ­¢å¤–éƒ¨è®¾å¤‡ç›´æ¥è®¿é—®å†…ç½‘è®¾å¤‡, ä½† **UPnP** å¯ä»¥è‡ªåŠ¨åŒ–ç«¯å£æ˜ å°„è¿‡ç¨‹, è§£å†³ NAT ç©¿é€é—®é¢˜.

- UPnP å¯¹ NAT è¿›è¡Œäº†ä¼˜åŒ–, ä½¿å¾—å†…ç½‘è®¾å¤‡èƒ½å¤Ÿè‡ªåŠ¨é…ç½®è·¯ç”±å™¨è¿›è¡Œç«¯å£æ˜ å°„, ä»è€Œä½¿å¤–éƒ¨è®¾å¤‡èƒ½å¤Ÿè®¿é—®å†…ç½‘æœåŠ¡.

## DMA

ä¸Šæ–‡ä¸­ä»‹ç»çš„ NAT, è·¯ç”±å™¨ä¼šæ ¹æ®å†…ç½‘è®¾å¤‡å‘å‡ºçš„æŠ¥æ–‡, è‡ªåŠ¨å½¢æˆ NAT è¡¨é¡¹. å®é™…ä¸Š, ç”¨æˆ·è¿˜å¯ä»¥åœ¨è·¯ç”±å™¨ä¸Šæ‰‹åŠ¨é…ç½®ç«¯å£æ˜ å°„å…³ç³», è®©å†…ç½‘è®¾å¤‡å¯è¢«å¤–éƒ¨è®¿é—®.

å…¶ä¸­, **DMZ** åŠŸèƒ½, å¯ä»¥æŒ‡å®šä¸€å°å†…ç½‘è®¾å¤‡ä¸º DMZ ä¸»æœº. åˆ°è¾¾è·¯ç”±å™¨ä¸Šçš„æŠ¥æ–‡, å¦‚æœæ²¡æœ‰åŒ¹é… NAT è¡¨é¡¹, å°±ä¼šè½¬å‘åˆ° DMZ ä¸»æœº. ä»è€Œä½¿ DMZ ä¸»æœºå¯è¢«å¤–éƒ¨è®¿é—®.

DMZ åŠŸèƒ½èƒ½è®©ä¸€å°å†…ç½‘è®¾å¤‡ä¸Šçš„æ‰€æœ‰ç«¯å£, éƒ½èƒ½è¢«å…¬ç½‘è®¿é—®. ä½†è¿™æ ·åšä¹Ÿå½±å“äº†å†…ç½‘è®¾å¤‡çš„å®‰å…¨æ€§, å¦‚æœæ²¡æœ‰ç‰¹æ®Šéœ€è¦, ä¸å»ºè®®æ‰“å¼€è¿™ä¸€åŠŸèƒ½.

---

## ç«¯å£æ˜ å°„

![20241229154732_8PwJl34p.webp](https://cdn.dong4j.site/source/image/20241229154732_8PwJl34p.webp)

ç«¯å£æ˜ å°„æ˜¯æŒ‡å°†å¤–éƒ¨ç½‘ç»œ (é€šå¸¸æ˜¯å…¬å…±ç½‘ç»œ) ä¸Šçš„æŸä¸ªç«¯å£æ˜ å°„åˆ°å†…ç½‘è®¾å¤‡ä¸Šçš„ç›¸åº”ç«¯å£, å…è®¸å¤–éƒ¨ç”¨æˆ·é€šè¿‡è·¯ç”±å™¨è®¿é—®å†…ç½‘è®¾å¤‡çš„æœåŠ¡. å®ƒé€šå¸¸ä¸ NAT é…åˆä½¿ç”¨, åœ¨è·¯ç”±å™¨æˆ–é˜²ç«å¢™ä¸Šè®¾ç½®æ˜ å°„è§„åˆ™, ä»è€Œå®ç°å¤–éƒ¨ä¸å†…ç½‘çš„é€šä¿¡.

**ä¸¾ä¸ªä¾‹å­**ï¼š

- å‡è®¾ä½ æœ‰ä¸€å°å†…éƒ¨è®¾å¤‡, IP åœ°å€ä¸º 192.168.1.10, å¹¶ä¸”è¿™å°è®¾å¤‡ä¸Šçš„æŸä¸ªæœåŠ¡ç›‘å¬çš„æ˜¯ç«¯å£ 8080.

- ä½ å¸Œæœ›å¤–éƒ¨ç”¨æˆ·èƒ½å¤Ÿè®¿é—®è¿™ä¸ªæœåŠ¡, ä½†å†…ç½‘çš„ 192.168.1.10 åœ°å€æ— æ³•ç›´æ¥æš´éœ²ç»™å¤–éƒ¨ç½‘ç»œ.

- ä½ å¯ä»¥åœ¨è·¯ç”±å™¨ä¸Šè®¾ç½®ç«¯å£æ˜ å°„è§„åˆ™, å°†å¤–éƒ¨çš„æŸä¸ªå…¬å…±ç«¯å£ (ä¾‹å¦‚ 80) æ˜ å°„åˆ°å†…ç½‘è®¾å¤‡çš„ç«¯å£ 8080. è¿™æ ·, å¤–éƒ¨ç”¨æˆ·è®¿é—®è·¯ç”±å™¨çš„ 80 ç«¯å£æ—¶, å®é™…ä¸Šä¼šè½¬å‘åˆ°å†…ç½‘è®¾å¤‡çš„ 192.168.1.10:8080.

**ä½œç”¨**ï¼š

- é€šè¿‡ç«¯å£æ˜ å°„, å¤–éƒ¨è®¾å¤‡å¯ä»¥è®¿é—®å†…ç½‘ä¸­çš„ç‰¹å®šè®¾å¤‡æˆ–æœåŠ¡.

- å®ƒç”¨äºè§£å†³ NAT å¸¦æ¥çš„â€œå†…ç½‘è®¾å¤‡æ— æ³•ç›´æ¥è¢«å¤–éƒ¨è®¿é—®â€çš„é—®é¢˜.

**NAT å’Œç«¯å£æ˜ å°„åŒºåˆ«**

- **NAT** æ˜¯ä¸€ç§æŠ€æœ¯æˆ–æœºåˆ¶, ç”¨äºå°†ç§æœ‰ IP åœ°å€è½¬æ¢ä¸ºå…¬å…± IP åœ°å€.

- **ç«¯å£æ˜ å°„** æ˜¯ NAT çš„ä¸€ç§é…ç½®, é€šè¿‡è®¾ç½®è§„åˆ™, å°†å¤–éƒ¨è®¿é—®çš„ç«¯å£æ˜ å°„åˆ°å†…ç½‘è®¾å¤‡çš„ç«¯å£, ä½¿å¾—å¤–éƒ¨è®¾å¤‡èƒ½å¤Ÿè®¿é—®å†…ç½‘è®¾å¤‡.

---

## æ£€æµ‹ NAT ç±»å‹

[pystun3](https://github.com/talkiq/pystun3) æ˜¯ä¸€ä¸ªç”¨äºè·å– NAT ç±»å‹å’Œå¤–éƒ¨ IP çš„ Python STUN å®¢æˆ·ç«¯

å®‰è£…ï¼š

```sh
pip install pystun3
```

![20241229154732_DglFSGxe.webp](https://cdn.dong4j.site/source/image/20241229154732_DglFSGxe.webp)

ä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰ STUN æœåŠ¡å™¨:

```shell
pystun3 -d -H stun.l.google.com -P 19302
```

![20241229154732_msZYrKtd.webp](https://cdn.dong4j.site/source/image/20241229154732_msZYrKtd.webp)

**pystun3** é»˜è®¤çš„ STUN Server åœ¨ `stun/__init__.py` ä¸­å®šä¹‰:

```python
STUN_SERVERS = (
    'stun.ekiga.net',
    'stun.ideasip.com',
    'stun.voiparound.com',
    'stun.voipbuster.com',
    'stun.voipstunt.com',
    'stun.voxgratia.org'
)
```

è‡ªå·±ä¹Ÿå¯ä»¥æ­å»ºä¸€ä¸ª [STUN Server](https://github.com/jselbie/stunserver):

```shell
git clone https://github.com/jselbie/stunserver
cd stunserver
docker image build -t=stun-server .
docker run -d -p 3478:3478/tcp -p 3478:3478/udp --name=stun-server stun-server
```

ä½¿ç”¨è‡ªå»ºæœåŠ¡å™¨

<!-- åœ¨ M920x /mnt/4.860.ssd/docker/stunserver docker build æ²¡æœ‰æˆåŠŸ -->

```
pystun3 -d -H [STUN Server æœåŠ¡çš„åŸŸåæˆ– IP] -P {STUN Server çš„ç«¯å£å·}
```

å¦‚æœä½ åš **WebRTC** ç›¸å…³å·¥ä½œçš„å¼€å‘, é‚£ä¹ˆ [Always Online: STUN servers](https://github.com/pradt2/always-online-stun) è¿™ä¸ªå¼€æºé¡¹ç›®å¯ä»¥å…³æ³¨ä¸€ä¸‹.

---

## å‚è€ƒ

- [42 å¼ å›¾è¯¦è§£ NAT : æ¢ä¸ªé©¬ç”²å°±èƒ½ä¸Šç½‘](https://mp.weixin.qq.com/s/nQBRhfZuufPB72_jGDXQwg)
- [å®¶åº­ç½‘ç»œä¸­çš„ã€ŒNATã€åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ](https://sspai.com/post/68037)
- [å…¥ç½‘æŒ‡å— 04 | IP åœ°å€å¤§æ­ç§˜ - å°‘æ•°æ´¾](https://sspai.com/post/64430)
- [å±€åŸŸç½‘æ¸¸æˆä¸²æµï¼šè®©æˆ‘ä»¬éƒ½åšä¸€å›ã€Œäº‘ã€ç©å®¶ - å°‘æ•°æ´¾](https://sspai.com/post/62402)
- [å°ç™½ä¹Ÿèƒ½çœ‹æ‡‚çš„ç½‘ç»œåŸºç¡€ 04 | IP åœ°å€æ˜¯å¦‚ä½•å·¥ä½œçš„ - å°‘æ•°æ´¾](https://sspai.com/post/64688)
- [å°ç™½ä¹Ÿèƒ½çœ‹æ‡‚çš„ç½‘ç»œåŸºç¡€ 05 | IP åœ°å€æ·±åº¦å­¦ä¹  - å°‘æ•°æ´¾](https://sspai.com/post/65428)
- [å°ç™½ä¹Ÿèƒ½çœ‹æ‡‚çš„ç½‘ç»œåŸºç¡€ 07 | TCP å’Œ UDP æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ - å°‘æ•°æ´¾](https://sspai.com/post/65470)
- [NAT ç§‘æ™®ä¸ç±»å‹æå‡](https://chenhe.me/post/nat-type)
- [äº’è”ç½‘ç½‘å…³è®¾å¤‡åè®® - ç»´åŸºç™¾ç§‘, è‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦](https://zh.wikipedia.org/wiki/%E4%BA%92%E8%81%94%E7%BD%91%E7%BD%91%E5%85%B3%E8%AE%BE%E5%A4%87%E5%8D%8F%E8%AE%AE)
- [NAT ç«¯å£æ˜ å°„åè®® - ç»´åŸºç™¾ç§‘, è‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦](https://zh.wikipedia.org/wiki/NAT%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84%E5%8D%8F%E8%AE%AE)
- [è§£å†³ NAT é”™è¯¯å’Œå¤šäººæ¸¸æˆé—®é¢˜ | Xbox Support](https://support.xbox.com/zh-CN/help/hardware-network/connect-network/xbox-one-nat-error)
- [Port Control Protocol (PCP) - RFC6887](https://datatracker.ietf.org/doc/html/rfc6887)
- [How NAT traversal works Â· Tailscale](https://tailscale.com/blog/how-nat-traversal-works)
- [How Tailscale works Â· Tailscale](https://tailscale.com/blog/how-tailscale-works)
- [QUIC, a multiplexed transport over UDP - The Chromium Projects](https://www.chromium.org/quic/)
- [awesome-home-networking-cn](https://github.com/blanboom/awesome-home-networking-cn)

<!--

[NAT åŸºç¡€æ•™ç¨‹](https://blog.nnwk.net/article/1525)

çœ‹ NAT éƒ¨åˆ† https://icloudnative.io/posts/wireguard-docs-practice/

-->

**ç›¸å…³æ–‡ç« :**

1. [[homelab-guide|å…ˆå¯¼ç¯‡]]ï¼šæˆ‘çš„ HomeLab æ¦‚è¦;
2. [[homelab-hardware|ç¡¬ä»¶ç¯‡]]ï¼šä»‹ç»æˆ‘æ‰€æ‹¥æœ‰çš„ç¡¬ä»¶è®¾å¤‡;
3. [[homelab-network|ç½‘ç»œç¯‡]]ï¼šåŒ…æ‹¬ç½‘ç»œç¯å¢ƒã€å¼‚åœ°ç»„ç½‘ä¸ç½‘ç»œå®‰å…¨;
4. [[homelab-service|æœåŠ¡ç¯‡]]ï¼šä½¿ç”¨ Docker æ­å»ºçš„å„ç±»æœåŠ¡;
5. [[homelab-data|æ•°æ®ç¯‡]]ï¼šåŒ…æ‹¬æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆ;
6. [[homelab-data-sync|HomeLabæ•°æ®åŒæ­¥ï¼šæ„å»ºé«˜æ•ˆçš„æ•°æ®åŒæ­¥ç½‘ç»œ]]
7. [[homelab-data-backup|HomeLabæ•°æ®å¤‡ä»½ï¼šæ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿]]
8. [[homelab-upgrade-to-10g|HomeLab ç½‘ç»œç»­é›†ï¼šå‡çº§ 10G ç½‘ç»œ-å†æˆ˜ 10 å¹´]]
9. [[homelab-guide|NAT å†…ç½‘ç©¿é€è¯¦è§£ï¼šæ­ç§˜ç½‘ç»œè¿æ¥èƒŒåçš„å¥¥ç§˜]]

## [HomeLab ç½‘ç»œç¯‡ï¼šäº’è”ä¸–ç•Œ-æ„å»ºé«˜æ•ˆçš„è‡ªæ‰˜ç®¡ç½‘ç»œç¯å¢ƒ](https://blog.dong4j.site/posts/e537d446.md)

![/images/cover/20241229154732_xLHg6epx.webp](https://cdn.dong4j.site/source/image/20241229154732_xLHg6epx.webp)

åœ¨æ„å»ºä¸ªäººäº‘ç«¯å®éªŒå®¤ (HomeLab) çš„è¿‡ç¨‹ä¸­, ç¡¬ä»¶æ˜¯åŸºçŸ³, è€Œç½‘ç»œåˆ™æ˜¯è®©è¿™äº›ç¡¬ä»¶ååŒå·¥ä½œçš„è¡€è„‰å’Œçµé­‚. æœ¬ç¯‡å°†æ·±å…¥æ¢è®¨å®¶åº­ç½‘ç»œçš„é…ç½®, ä»åŸºç¡€çš„æ¶æ„è®¾è®¡åˆ°é«˜çº§çš„å®‰å…¨æ€§å’Œå¼‚åœ°ç»„ç½‘æŠ€æœ¯, é€æ­¥å±•ç¤ºå¦‚ä½•æ­å»ºä¸€ä¸ªé«˜æ•ˆã€ç¨³å®šä¸”å®‰å…¨çš„è‡ªæ‰˜ç®¡ç½‘ç»œç¯å¢ƒ.

æˆ‘å°†ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œè¯¦ç»†é˜è¿°:

1. **ç½‘ç»œæ¶æ„**: ä»‹ç»å¦‚ä½•é€‰æ‹©åˆé€‚çš„ç½‘ç»œè®¾å¤‡ (å¦‚è·¯ç”±å™¨ã€äº¤æ¢æœºç­‰) , ä»¥åŠå¦‚ä½•åœ¨ä¸åŒçš„æˆ¿é—´å’Œä½ç½®éƒ¨ç½²ç½‘ç»œè¦†ç›–.
2. **å®‰å…¨æ€§**: è®¨è®ºå¦‚ä½•è®¾ç½®ç½‘ç»œå®‰å…¨ç­–ç•¥, åŒ…æ‹¬é˜²ç«å¢™è§„åˆ™ã€VPN é…ç½®ã€åŠ å¯†é€šä¿¡ç­‰, ä»¥ç¡®ä¿æ•°æ®çš„å®‰å…¨æ€§å’Œéšç§ä¿æŠ¤.
3. **å¼‚åœ°ç»„ç½‘**: å±•ç¤ºå¦‚ä½•é€šè¿‡è¿œç¨‹è®¿é—®æŠ€æœ¯, å°†å®¶åº­å®éªŒå®¤æ‰©å±•åˆ°å¤–éƒ¨ç½‘ç»œ, å®ç°å¼‚åœ°ç®¡ç†å’Œæ“ä½œ.
4. **å®è·µæ¡ˆä¾‹**: åˆ†äº«å®é™…æ“ä½œæ­¥éª¤å’Œç»éªŒ, å¸®åŠ©è¯»è€…æ›´å¥½åœ°ç†è§£å’Œåº”ç”¨è¿™äº›ç½‘ç»œæŠ€æœ¯å’Œæ¦‚å¿µ.

é€šè¿‡æœ¬ç¯‡çš„æ¢è®¨, ä½ å°†èƒ½å¤Ÿäº†è§£åˆ°å¦‚ä½•æ„å»ºä¸€ä¸ªé«˜æ•ˆã€å®‰å…¨ä¸”å¯æ‰©å±•çš„è‡ªæ‰˜ç®¡ç½‘ç»œç¯å¢ƒ. è¿™ä¸ä»…èƒ½å¤Ÿæ»¡è¶³æ—¥å¸¸å·¥ä½œå’Œå­¦ä¹ çš„éœ€æ±‚, è¿˜èƒ½ä¸ºä½ çš„ä¸ªäººäº‘ç«¯å®éªŒå®¤æä¾›ä¸€ä¸ªç¨³å›ºçš„ç½‘ç»œåŸºç¡€. è®©æˆ‘ä»¬ä¸€èµ·æ­å¼€å®¶åº­ç½‘ç»œé…ç½®çš„ç¥ç§˜é¢çº±, æ¢ç´¢è‡ªæ‰˜ç®¡çš„æ— é™å¯èƒ½å§ï¼

**ç›¸å…³æ–‡ç« **:

1. [[homelab-guide|å…ˆå¯¼ç¯‡]]ï¼šæˆ‘çš„ HomeLab æ¦‚è¦;
2. [[homelab-hardware|ç¡¬ä»¶ç¯‡]]ï¼šä»‹ç»æˆ‘æ‰€æ‹¥æœ‰çš„ç¡¬ä»¶è®¾å¤‡;
3. [[homelab-network|ç½‘ç»œç¯‡]]ï¼šåŒ…æ‹¬ç½‘ç»œç¯å¢ƒã€å¼‚åœ°ç»„ç½‘ä¸ç½‘ç»œå®‰å…¨;
4. [[homelab-service|æœåŠ¡ç¯‡]]ï¼šä½¿ç”¨ Docker æ­å»ºçš„å„ç±»æœåŠ¡;
5. [[homelab-data|æ•°æ®ç¯‡]]ï¼šåŒ…æ‹¬æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆ;
6. [[homelab-data-sync|HomeLabæ•°æ®åŒæ­¥ï¼šæ„å»ºé«˜æ•ˆçš„æ•°æ®åŒæ­¥ç½‘ç»œ]]
7. [[homelab-data-backup|HomeLabæ•°æ®å¤‡ä»½ï¼šæ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿]]
8. [[homelab-upgrade-to-10g|HomeLab ç½‘ç»œç»­é›†ï¼šå‡çº§ 10G ç½‘ç»œ-å†æˆ˜ 10 å¹´]]
9. [[homelab-guide|NAT å†…ç½‘ç©¿é€è¯¦è§£ï¼šæ­ç§˜ç½‘ç»œè¿æ¥èƒŒåçš„å¥¥ç§˜]]

## é˜…è¯»æŒ‡å¼•

ç”±äºç¯‡å¹…è¾ƒé•¿ä¸”ä¸æƒ³åˆ‡åˆ†å¤šç¯‡æ–‡ç« å½±å“é˜…è¯»è¿ç»­æ€§, å› æ­¤è¿™é‡Œç»™å‡ºä¸€ä¸ªé˜…è¯»æŒ‡å¼•, ä»¥å¸®åŠ©å¿«é€Ÿç†è§£ç« èŠ‚ç›´æ¥çš„é€»è¾‘å…³ç³»:

1. [ä»ç½‘ç»œç›¸å…³çš„ç¡¬ä»¶å‡ºå‘, ä»¥ç½‘ç»œå¸ƒçº¿å¼€å§‹åˆ°ç¡¬ä»¶è®¾å¤‡è¿æ¥, é‡ç‚¹ä»‹ç»äº†å¼±ç”µç®±å’Œä¹¦æˆ¿çš„ç½‘ç»œå¸ƒå±€](#ç½‘ç»œæ¶æ„)
2. [é€šè¿‡å¤–ç½‘, å†…ç½‘å’Œå¤–ç½‘->å®¶çš„ç½‘é€Ÿæµ‹è¯•éªŒè¯å®½å¸¦çš„å¯ç”¨æ€§](#ç½‘é€Ÿ)
3. [æœ‰äº†ç¡¬ä»¶å’ŒåŸºç¡€ç½‘ç»œå, å¦‚ä½•åˆç†çš„åˆ†é…è®¾å¤‡ IP åœ°å€](#è®¾å¤‡-IP-ç®¡ç†) <!-- ä½¿ç”¨ - ä»£æ›¿ç©ºæ ¼ -->
4. [ä¸ºäº†æ–¹ä¾¿è®°å¿†, ä¸ºè®¾å¤‡åˆ†é…è‡ªå®šä¹‰åŸŸå](#è®¾å¤‡åŸŸåç®¡ç†)
5. [å®Œæˆä¸Šé¢ 2 æ­¥å·¥ä½œå, æ¥ä¸‹æ¥å°±æ˜¯å¦‚ä½•ç®¡ç†å¤šå°æœåŠ¡å™¨](#è®¾å¤‡è¿æ¥ç®¡ç†)
6. [å†…ç½‘é…ç½®å®Œæˆå, æ¥ä¸‹æ¥å°±è¦è€ƒè™‘å¦‚ä½•é«˜æ•ˆçš„ä»å¤–ç½‘è®¿é—®å®¶ä¸­çš„è®¾å¤‡å’ŒæœåŠ¡](#æš´éœ²æœåŠ¡åˆ°å…¬ç½‘)
7. [å› ä¸ºæš´éœ²åˆ°å…¬ç½‘å, é¦–å…ˆéœ€è¦è€ƒè™‘çš„å°±æ˜¯ç½‘ç»œå®‰å…¨é—®é¢˜](#ç½‘ç»œå®‰å…¨)
8. [å‡ºé—¨åœ¨å¤–, å¦‚ä½•å¿«é€Ÿä¸”å®‰å…¨çš„è®¿é—®å®¶ä¸­ç½‘ç»œ, çœ‹ä¸ªå°ç”µå½±, å¬å¬æ­Œ](#å¤–ç½‘è®¿é—®å®¶åº­ç½‘ç»œ)
9. [ä¸ºäº†æå‡ç½‘ç»œä½“éªŒ, éœ€è¦è€ƒè™‘å¦‚ä½•å±è”½å¹¿å‘Š](#å¹¿å‘Šè¿‡æ»¤)
10. [åœ¨å¤–èƒ½å¤Ÿæµç•…è®¿é—®å®¶ä¸­çš„ç½‘ç»œ, é‚£ä¹ˆåœ¨å®¶è¯¥å¦‚ä½•è®¿é—®å…¬å¸çš„ç½‘ç»œå‘¢? ](#å¼‚åœ°ç»„ç½‘)
11. [å¦‚ä½•æµç•…çš„è®¿é—®äº’è”ç½‘ä¸–ç•Œ, åªèƒ½è¯´ä¸€ç‚¹ç‚¹](#åˆ†æµ)
12. [æœ€åçš„æœ€å, æˆ‘ä»¬åº”è¯¥å¦‚ä½•å®æ—¶äº†è§£ç½‘ç»œæƒ…å†µ](#ç½‘ç»œç›‘æµ‹ä¸é€šçŸ¥)

---

## ç½‘ç»œæ¶æ„

### å¸ƒçº¿

ä»è£…ä¿®å¼€å§‹å°±è€ƒè™‘åˆ°ä¸€å®šä¼šç»„å»ºè‡ªå·±çš„ HomeLab, ä½†æ˜¯è€ƒè™‘åˆ°å¼±ç”µç®±ä¸å¤Ÿå¤§ä¸”æ²¡æœ‰æ¡ä»¶å¢å¤§, åªèƒ½å°†ç¡¬ä»¶æ”¾ç½®åˆ°å„ä¸ªæˆ¿é—´, å› æ­¤åœ¨å¼±ç”µå¸ƒçº¿æ—¶å°±åšäº†å†—ä½™.

å¾—ç›Šäºå¼€å‘å•† 2 æ ¹å…‰çº¤å…¥æˆ·, ä½¿å¾—å®½å¸¦å†—ä½™æ–¹æ¡ˆå¾—ä»¥å®æ–½, åŒæ—¶é—æ†¾çš„æ˜¯æ— æ³•å¢åŠ æ›´å¤šçš„å®½å¸¦æ•°é‡.

ä»å¼±ç‚¹ç®±é¢„åŸ‹äº†æ€»å…± 8 æ ¹å…«ç±»ç½‘çº¿, å®¢å… 3 æ ¹, ä¸»å§å’Œä¹¦æˆ¿å„ 2 æ ¹, æ¬¡å§ 1 æ ¹.

![å¹³é¢å›¾.drawio.svg](https://cdn.dong4j.site/source/image/%E5%B9%B3%E9%9D%A2%E5%9B%BE.drawio.svg)

ç”µä¿¡å’Œè”é€šé€šè¿‡å¼±ç”µç®±å…‰çº¤å…¥æˆ·

**ç”µä¿¡å®½å¸¦**:

1. ç”µä¿¡å…‰çŒ«é€šè¿‡ç½‘çº¿è¿æ¥ç”µä¿¡æœºé¡¶ç›’;
2. ç”µä¿¡å…‰çŒ«é€šè¿‡ç½‘çº¿è¿æ¥ç”µè§†æŸœä¸­ `AX9000` çš„åƒå…† wan å£, ç”± `AX9000` æ‹¨å·ä¸Šç½‘;
3. `AX9000` çš„ 2.5G lan å£é€šè¿‡ç½‘çº¿å›è¿è‡³å¼±ç”µç®±çš„ `TL-SH1005` 2.5G äº¤æ¢æœº;
4. `TL-SH1005` äº¤æ¢æœºé€šè¿‡ç½‘çº¿è¿æ¥ä¸»å§å’Œä¹¦æˆ¿, å®ç°ä¸»è¦æˆ¿é—´ 2.5G ç”µä¿¡æœ‰çº¿ç½‘ç»œ;

**è”é€šå®½å¸¦**:

1. è”é€šå…‰çŒ«é€šè¿‡ç½‘çº¿è¿æ¥å¼±ç”µç®±æ—è¾¹ `6500Pro` çš„ 2.5G wan å£, ç”± `6500Pro` æ‹¨å·ä¸Šç½‘;
2. `6500Pro` é€šè¿‡ 2.5G lan å£è¿æ¥å¼±ç”µç®±ä¸­çš„å¦ä¸€ä¸ª `TL-SH1005` äº¤æ¢æœº;
3. `TL-SH1005` äº¤æ¢æœºé€šè¿‡ç½‘çº¿è¿æ¥ä¸»å§, æ¬¡å§å’Œä¹¦æˆ¿, å®ç°æˆ¿é—´ 2.5G è”é€šæœ‰çº¿ç½‘ç»œ;

å› ä¸ºå¼±ç”µç®±å°æ— æ³•æ”¾ä¸‹æ‰€æœ‰ç¡¬ä»¶, å› æ­¤åªèƒ½é‡‡ç”¨è¿™ç§è¿‚å›çš„æ–¹å¼å¸ƒçº¿, å…³é”®ç‚¹æ˜¯éœ€è¦é¢å¤–é¢„åŸ‹ä¸€æ¡ç½‘çº¿å°†ç½‘ç»œä»è·¯ç”±å™¨æ¥åˆ°äº¤æ¢æœº, å†ç”±äº¤æ¢æœºå°†ç½‘ç»œè¾“é€åˆ°å„ä¸ªæˆ¿é—´.

å¦‚æœåœ¨è£…ä¿®æ—¶æ²¡æœ‰è€ƒè™‘å¯¼è‡´ç½‘çº¿ä¸å¤Ÿ, å¯ä»¥ç”¨å…¶ä»–æ–¹å¼å®ç°:

1. ç½‘çº¿ä¸€åˆ†ä¸ºäºŒ, å››èŠ¯ç”¨äºè¿æ¥æ— çº¿è·¯ç”±å™¨, è¿™ç§æ–¹å¼å½“ç„¶ **ä¸æ¨è**, ç½‘é€Ÿè¾¾ä¸åˆ°è¦æ±‚;

2. ä½¿ç”¨ç”µåŠ›çŒ«è¿æ¥ IPTV ç”µè§†ç›’å­, ç½‘çº¿è¿æ¥æ— çº¿è·¯ç”±å™¨, è¿™ç§æ–¹å¼ä¼šå¯¼è‡´ IPTV ç”µè§†ä¿¡å·ç¨³å®šæ€§ä¸é«˜;

   ![20241229154732_QgATxj9Q.webp](https://cdn.dong4j.site/source/image/20241229154732_QgATxj9Q.webp)

3. å•çº¿å¤ç”¨: ä½¿ç”¨æ”¯æŒ VLAN çš„äº¤æ¢æœº, åˆ’åˆ†ä¸¤ä¸ªé€»è¾‘ç‹¬ç«‹çš„ç½‘ç»œ. è¿™ç§è¿æ¥æ–¹å¼ä¼šå¢åŠ é…ç½®å¤æ‚åº¦. [è¿™é‡Œæœ‰è¯¦ç»†çš„è§†é¢‘æ•™ç¨‹](https://www.youtube.com/watch?v=1CuyE5HXhA8)

   ![20241229154732_LTEiwoQJ.webp](https://cdn.dong4j.site/source/image/20241229154732_LTEiwoQJ.webp)

### å¼±ç”µç®±

![20241229154732_bBOS3J6w.webp](https://cdn.dong4j.site/source/image/20241229154732_bBOS3J6w.webp)

è¿˜å¥½æ²™å‘åé¢æœ‰ä¸€ä¸ª 10 å…¬åˆ†å®½çš„æœ¨æ¶, ä¸ç„¶è¿™äº›è®¾å¤‡å¼±ç”µç®±è¿˜å¡ä¸ä¸‹.

#### æ‹“æ‰‘å›¾

![å¼±ç”µç®±.drawio.svg](https://cdn.dong4j.site/source/image/%E5%BC%B1%E7%94%B5%E7%AE%B1.drawio.svg)

1. ç”µè§†æŸœ 3 ä¸ªç½‘å£å®ç° IPTV, è·¯ç”±å™¨æ‹¨å·ä¸Šç½‘ä¸æœ‰çº¿å›ç¨‹;
2. å¼±ç”µç®±çš„ç”µä¿¡äº¤æ¢æœºè¿æ¥ R2S å’Œ R5S, å‰©ä¸‹çš„ 2 ä¸ªç½‘å£æ¥åˆ°ä¸»å§å’Œä¹¦æˆ¿;
3. è”é€šå…‰çŒ«è¿æ¥ 6500Pro å¹¶ç”±è·¯ç”±å™¨æ‹¨å·ä¸Šç½‘, 6500Pro è¿æ¥äº¤æ¢æœºä¸ R5S;
4. è”é€šäº¤æ¢æœºè¿æ¥ R2S, å…¶ä»–ç½‘å£æ¥åˆ°ä¸»å§, æ¬¡å§å’Œä¹¦æˆ¿;

å…¶ä¸­ R5S å’Œ R2S éƒ½å·²å°† **lan ä¿®æ”¹ä¸º wan å£**, ç„¶åä½œä¸ºæ—è·¯ç”±å’Œè½»é‡æœåŠ¡å™¨æ˜¯ç”¨, è·‘äº†å‡ ä¸ª Docker æœåŠ¡.

#### å…‰çŒ«æ”¹æ¡¥æ¥

å…‰çŒ«æ”¹æ¡¥æ¥çš„ä¼˜åŠ¿:

1. **æå‡ç½‘ç»œæ€§èƒ½**: åœ¨æ¡¥æ¥æ¨¡å¼ä¸‹, å…‰çŒ«åªè´Ÿè´£å…‰ç”µè½¬æ¢, å°†è·¯ç”±åŠŸèƒ½äº¤ç»™ä¸“é—¨çš„è·¯ç”±å™¨å¤„ç†, è¿™æ ·å¯ä»¥å‡è½»å…‰çŒ«çš„è´Ÿæ‹…, ä½¿ç½‘ç»œæ€§èƒ½å¾—åˆ°æå‡. åŒæ—¶, æ‰€æœ‰çš„è®¾å¤‡éƒ½ä½äºåŒä¸€å­ç½‘å†…, ç½‘ç»œç»“æ„æ›´åŠ ç®€å•, ä¾¿äºç®¡ç†å’Œé…ç½®.
2. **å¢å¼ºç½‘ç»œç¨³å®šæ€§**: å…‰çŒ«åœ¨æ¡¥æ¥æ¨¡å¼ä¸‹, åªéœ€å®Œæˆå…‰ç”µè½¬æ¢, ç®€åŒ–äº†å…¶ä»»åŠ¡, ä»è€Œé™ä½äº†å·¥ä½œå‹åŠ›, æå‡äº†å®¶åº­ç½‘ç»œçš„ç¨³å®šæ€§.
3. **ä¾¿äºæ•…éšœæ’æŸ¥**: ç”±äºè·¯ç”±åŠŸèƒ½ç”±ä¸“é—¨çš„è·¯ç”±å™¨å¤„ç†, ä¸€æ—¦å‡ºç°é—®é¢˜, å¯ä»¥è¿…é€Ÿå®šä½åˆ°è·¯ç”±å™¨å±‚é¢è¿›è¡Œæ’æŸ¥å’Œä¿®å¤. è€Œåœ¨è·¯ç”±æ¨¡å¼ä¸‹, æ•…éšœæ’æŸ¥å¯èƒ½ä¼šæ¶‰åŠåˆ°å…‰çŒ«å’Œè·¯ç”±å™¨ç­‰å¤šä¸ªè®¾å¤‡, å¢åŠ äº†æ•…éšœæ’æŸ¥çš„éš¾åº¦.
4. **æé«˜çµæ´»æ€§**: æ¡¥æ¥æ¨¡å¼å…è®¸ç”¨æˆ·æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©åˆé€‚çš„è·¯ç”±å™¨è®¾å¤‡, å®ç°æ›´çµæ´»çš„ç½‘ç»œé…ç½®. ä¾‹å¦‚, ç”¨æˆ·å¯ä»¥é€‰æ‹©å…·æœ‰æ›´å¼ºè·¯ç”±æ€§èƒ½çš„è·¯ç”±å™¨æ¥æå‡ç½‘ç»œç¨³å®šæ€§, æˆ–è€…é€‰æ‹©å…·æœ‰ç‰¹æ®ŠåŠŸèƒ½çš„è·¯ç”±å™¨æ¥æ»¡è¶³ç‰¹å®šéœ€æ±‚.
5. **å®ç°ç‰¹æ®ŠåŠŸèƒ½**: å…‰çŒ«æ”¹æ¡¥æ¥å, è·¯ç”±å™¨ PPPOE æ‹¨å·, ç”¨æˆ·å¯ä»¥å®ç°æ›´å¤šçš„åŠŸèƒ½. æ¯”å¦‚å¯ä»¥å•çº¿åŒæ‹¨å¢åŠ å¸¦å®½.

æ”¹æ¡¥æ¥çš„æ–¹æ³•å¯ä»¥ç½‘ä¸Šæœç´¢, ä¿é™©èµ·è§ç›´æ¥è®©è¿è¥å•†ä¿®æ”¹å³å¯.

### ç”µè§†æŸœ

ç”µè§†æŸœä¸­çš„ AX9000, å‰©ä¸‹çš„ lan åˆ†åˆ«è¿æ¥äº†å°ç±³å£ç”»ç”µè§†å’Œ Apple TV.

### ä¹¦æˆ¿

ä¹¦æˆ¿æ‰¿è½½äº† 80% çš„ç½‘ç»œè®¾å¤‡, å› ä¸ºè®¾å¤‡æ˜¯æ…¢æ…¢å¢åŠ çš„, æ‰€ä»¥ä¸€å¼€å§‹å¹¶æ²¡æœ‰ç›´æ¥è´­ä¹°å¤ªå¤šç½‘å£çš„äº¤æ¢æœº, åé¢è®¾å¤‡å¢å¤šå, å› ä¸ºäº¤æ¢æœºä½“ç§¯çš„é—®é¢˜, ä¹Ÿæ²¡æœ‰ç›´æ¥æ›´æ¢æˆæ›´å¤šç½‘å£çš„äº¤æ¢æœº, è€Œæ˜¯ç›´æ¥é€šè¿‡å¢åŠ äº¤æ¢æœºæ•°é‡è¿›è¡Œç½‘ç»œæ‰©å±•. è€Œå› ä¸ºæ¥å…¥äº†ç”µä¿¡å’Œè”é€š, æ¯æ¡å®½å¸¦éƒ½éœ€è¦å¢åŠ åŒå€çš„äº¤æ¢æœºæ•°é‡.

![20241229154732_9TrRPpHt.webp](https://cdn.dong4j.site/source/image/20241229154732_9TrRPpHt.webp)

ä¹¦æˆ¿ 2 ä¸ªç½‘å£, åˆ†åˆ«æœ‰çº¿æ¥å…¥ç”µä¿¡å’Œè”é€šç½‘ç»œ(2.5G).

é™¤äº† DS923+ å’Œå•ç‹¬çš„å¼€å‘ç‰ˆ, ä¹¦æˆ¿æ‰€æœ‰ä¾›ç”µå…¨éƒ¨æ¥è‡ªäºæœ€å³è¾¹çš„æ’åº§, å› æ­¤å¢åŠ äº†ä¸€ä¸ªå°ç±³æ™ºèƒ½æ’åº§æ¥ç»Ÿè®¡ä¹¦æˆ¿çš„è€—ç”µé‡.

å› ä¸ºä¹¦æ¡Œä¸Šè®¾å¤‡å¤ªå¤š, æ€»å…±é€šè¿‡ 4 ä¸ª 8 å£ PDU æ’åº§å’Œ 3 ä¸ªå°ç±³æ’åº§æ¥ä¾›ç”µ, æ”¾ä¸€ä¸ªä¹¦æ¡Œä¸‹é¢çš„èµ°çº¿å›¾:

![20241229154732_ZtqbiHUy.webp](https://cdn.dong4j.site/source/image/20241229154732_ZtqbiHUy.webp)

ä¸èƒ½è¯´ä¹±å§, åªèƒ½è¯´éšè”½å·¥ç¨‹åšçš„ä¸å¤ªæ¼‚äº® ğŸ˜.

#### ç½‘ç»œæ‹“æ‰‘å›¾

![network.drawio.svg](https://cdn.dong4j.site/source/image/network.drawio.svg)

1. ç½‘ç»œè®¾å¤‡å…¨éƒ¨é€šè¿‡åŒç½‘å£æ¥å…¥ç”µä¿¡å’Œè”é€šç½‘ç»œ, å¦‚æœæ²¡æœ‰åŒç½‘å£çš„è®¾å¤‡, åˆ™é€šè¿‡ USB æˆ– type-c è½¬ 2.5G ç½‘å£å®ç°;
2. ç°åœ¨è¿˜æ²¡æœ‰æ¡ä»¶å®ç°ä¹¦æˆ¿ä¸»è¦è®¾å¤‡ä¸‡å…†å±€åŸŸç½‘, è¿™å°†æ˜¯ä¸‹ä¸€æ­¥çš„å‡çº§ç›®æ ‡;

ç”±äºæ—©æœŸç”³è¯·äº†ç”µä¿¡å®½å¸¦, å½“æ—¶ç”³è¯·**å…¬ç½‘ IP**ç›¸å¯¹å®¹æ˜“. æ­£æ˜¯å› ä¸ºè¿™ä¸ªå…¬ç½‘ IP, å½“å‰å®½å¸¦æ— æ³•å‡çº§åˆ° 2000M. ç»å’¨è¯¢, å‡çº§å¯èƒ½ä¼šå¯¼è‡´å…¬ç½‘ IP è¢«æ”¶å›. é‰´äºç°æœ‰å¸¦å®½è¶³å¤Ÿä½¿ç”¨, åŠ ä¸Šè¿˜æœ‰ä¸€æ¡åƒå…†è”é€šå®½å¸¦, æš‚æ—¶æ²¡æœ‰å‡çº§çš„è¿«åˆ‡éœ€æ±‚.

**å®½å¸¦é…ç½®å’Œä½¿ç”¨æƒ…å†µ**

1. **ç”µä¿¡å®½å¸¦**:

   - ä¸»è¦æ»¡è¶³æ—¥å¸¸ä¸Šç½‘éœ€æ±‚.
   - æ‰‹æœºç­‰å¸¸ç”¨è®¾å¤‡ä¼˜å…ˆæ¥å…¥ç”µä¿¡ç½‘ç»œ.

2. **è”é€šå®½å¸¦**:

   - æœ€åˆä¸ºå…è´¹èµ é€çš„ 300M å¸¦å®½, åæ¥é€šè¿‡æ´»åŠ¨ä»¥ **æ¯æœˆ 19 å…ƒ**å‡çº§åˆ°åƒå…†.
   - é€šè¿‡åå•†å®‰è£…å¸ˆå‚…, ä¹Ÿè·å–äº†ä¸€ä¸ªå…¬ç½‘ IP.
   - è”é€šå®½å¸¦ä¸»è¦ç”¨äºæ™ºèƒ½è®¾å¤‡è”ç½‘å’Œæ–‡ä»¶ä¸‹è½½, ä½œä¸ºç”µä¿¡å®½å¸¦çš„**å¤‡ç”¨ç½‘ç»œ**.

3. **åŒå®½å¸¦ä¼˜åŠ¿**:
   - ä¸¤æ¡ç‹¬ç«‹å®½å¸¦ç¡®ä¿å½“ä¸€æ¡çº¿è·¯çš„ç½‘ç»œæœåŠ¡å‡ºç°é—®é¢˜ (å¦‚è¿è¥å•†çº¿è·¯æ•…éšœæˆ–å…‰ç¼†è¢«æŒ–æ–­) æ—¶, ä»å¯é€šè¿‡å¦ä¸€æ¡çº¿è·¯è®¿é—®å®¶ä¸­è®¾å¤‡.
   - ä½†éœ€æ³¨æ„, å¦‚æœåœç”µ, ä¸¤ä¸ªç½‘ç»œéƒ½ä¼šä¸­æ–­, ç›®å‰è¿˜ä¸å…·å¤‡éƒ¨ç½²å¤§å‹å¤‡ç”¨ç”µæºçš„è´¢åŠ› ğŸ˜….

**ç½‘ç»œä¼˜åŒ–æ–¹æ¡ˆ**

ä¸ºå‡å°‘ WiFi ä¿¡å·å¹²æ‰°, è¿›è¡Œäº†ä»¥ä¸‹è°ƒæ•´:

1. **WiFi ç®¡ç†**:

   - å…³é—­å…‰çŒ«å’Œéä¸»è¦è·¯ç”±å™¨çš„ WiFi åŠŸèƒ½.
   - ä½¿ç”¨ **AX9000** åŠå…¶ **Mesh è®¾å¤‡(2 å° AX1800)** çš„ WiFi æä¾›å…¨å±‹æ¼«æ¸¸è¦†ç›–.

2. **æ™ºèƒ½è®¾å¤‡ä¸“ç½‘**:
   - é…ç½® **6500Pro** ä½œä¸ºæ™ºèƒ½ç¡¬ä»¶çš„ç½‘ç»œæ¥å…¥ç‚¹, å¯ç”¨ **2.4G å’Œ 5G é¢‘æ®µ**.
   - ä¸ºè®¿å®¢æä¾›ä¸“ç”¨çš„è®¿å®¢ WiFi, ä¿éšœä¸»ç½‘ç»œçš„å®‰å…¨æ€§.

é€šè¿‡è¿™ç§åˆ†å·¥, ä¸ä»…å¯ä»¥ä¼˜åŒ–ç½‘ç»œæ€§èƒ½, è¿˜èƒ½å‡å°‘å¹²æ‰°, ç¡®ä¿å®¶åº­ç½‘ç»œçš„ç¨³å®šæ€§å’Œå¯ç”¨æ€§.

### å…³äºç½‘çº¿

åˆšå¼€å§‹å¹¶æ²¡æœ‰è€ƒè™‘åˆ°å…¨ç½‘å…‰çº¤, è¿™æ˜¯ä¸€å¤§è´¥ç¬”, ç°åœ¨æ¢æˆå…‰çº¤æˆæœ¬æœ‰ç‚¹é«˜, è¿˜å¥½é¢„åŸ‹äº† **å…«ç±»ç½‘çº¿**, ä¸è¿‡å½“æ—¶åŠŸè¯¾æ²¡æœ‰æœ€å¥½, æ„Ÿè§‰ç±»å‹è¶Šé«˜è¶Šå¥½, å®Œå…¨æ²¡æœ‰è€ƒè™‘ä»·æ ¼, å¯¼è‡´å¼±ç”µè£…ä¿®å¢åŠ äº†ä¸å°‘æˆæœ¬. å®¶ç”¨ç½‘çº¿è¶…å…­ç±»å®Œå…¨å¤Ÿç”¨.

ä¸åŒè§„æ ¼ç½‘çº¿é€Ÿç‡å›¾:

| è§„æ ¼            | ç±»å‹               | é€Ÿç‡                                                                                                   | æ¥å£      | å¤‡æ³¨                                                                    |
| --------------- | ------------------ | ------------------------------------------------------------------------------------------------------ | --------- | ----------------------------------------------------------------------- |
| äº”ç±»çº¿ CAT 5    | 100Base-T 10Base-T | 100Mbps                                                                                                | RJ45      | ä¸æ¨è                                                                  |
| è¶…äº”ç±»çº¿ CAT 5E | 100Base-T          | 1000Mbps 2.5Gbps[7](https://icyleaf.com/2023/01/how-to-homelab-part-1-hardware-and-architecture/#fn:7) | RJ45      | 2.5G ç½‘ç»œ[ä»…é™ 100 ç±³ä»¥å†…](https://www.bilibili.com/video/BV1p14y137v3) |
| å…­ç±»çº¿ CAT 6    | 100Base-T          | 1Gbps 10Gbps                                                                                           | RJ45      | ä¸‡å…†ç½‘ç»œä»…é™ 50 ç±³å†…                                                    |
| è¶…å…­ç±»çº¿ CAT 6A | 100Base-T          | 10Gbps                                                                                                 | RJ45      | 200 ç±³å†…å¯è¾¾ä¸‡å…†ç½‘ç»œ æ²¡æœ‰ 6E æ ‡å‡†                                       |
| ä¸ƒç±»çº¿ CAT 7    | 100Base-T          | 10Gbps                                                                                                 | GG45/TERA | å¸¦ç€é®è”½                                                                |
| å…‰çº¤            | -                  | -                                                                                                      | -         | ä¸æ‡‚, è¯¦è§[ç»´åŸºç™¾ç§‘](https://zh.wikipedia.org/zh-cn/å…‰çº–é€šè¨Š)           |

å› ä¸ºä¸ƒç±»ä»¥ä¸Šçš„ç½‘çº¿æœ‰é®è”½ç½©, éœ€è¦æ­£ç¡®æ¥åœ°å¤„ç†, åæ­£æ¥ç»™æˆ‘æ‰“æ°´æ™¶å¤´çš„äººä¸çŸ¥é“æ€ä¹ˆæ¥, ä¸è¿‡å› ä¸ºé€Ÿåº¦è¿˜æ˜¯èƒ½è¾¾åˆ°ä¸‡å…†ç½‘é€Ÿ, æ‰€æœ‰è¿˜æ²¡æœ‰æ·±ç©¶è¿™ä¸ªé—®é¢˜, ç­‰åˆ°æœ‰æ—¶é—´å†å»æŠ˜è…¾å§.

### æ€»ç»“

ä¸Šä¸€ç¯‡è¯´è¿‡ä¸ºä»€ä¹ˆä¸é€šè¿‡åŒçº¿å¤šæ’­å’ŒçŒ«æ£’ç­‰æ‰‹æ®µæ¥æå‡å®½å¸¦é€Ÿåº¦, ä¸»è¦æ˜¯ **ç¨³å®šæ€§å’Œå®¹é”™** è€ƒè™‘, ä¹Ÿå¦å®šäº† **All In One** çš„æ–¹æ¡ˆ, é¿å… **All In Boom** çš„é—®é¢˜, è€Œæ˜¯ä½¿ç”¨å¤šä¸ªç¡¬ä»¶æ‰¿è½½ä¸åŒçš„éœ€æ±‚.

åœ¨ç¡¬ä»¶è®¾å¤‡ä¸Š, æˆ‘ä¹Ÿå®ç°äº†å¤šå°å†—ä½™çš„è®¾è®¡, æ¯”å¦‚å¤šä¸ª R2S è®¾å¤‡, ç½‘ç»œç›¸å…³çš„æœåŠ¡é›†ç¾¤éƒ¨ç½²ç­‰, ä¸»è¦æ˜¯ä¿è¯å¯ç”¨æ€§.

å¤šå¹´äº’è”ç½‘å¼€å‘ç»éªŒå‘Šè¯‰æˆ‘, å¤šå°æœåŠ¡å™¨æ¯”å•å°æ€§èƒ½å¼ºåŠ²çš„æœåŠ¡å™¨æ›´åŠ é è°±å’Œç»æµå®æƒ , æ—¢èƒ½ä¿è¯é«˜å¯èƒ½è¿˜èƒ½æé«˜å¯æ‰©å±•æ€§, å”¯ä¸€çš„ç¼ºç‚¹å°±æ˜¯å¤šæœåŠ¡å™¨çš„ç®¡ç†å’Œé…ç½®éš¾åº¦ä¸Šå‡.

---

## ç½‘é€Ÿ

### å¤–ç½‘

**ç”µä¿¡**:

![20241229154732_Fnvmpxzj.webp](https://cdn.dong4j.site/source/image/20241229154732_Fnvmpxzj.webp)

**è”é€š**:

![20241229154732_gnLMAsbn.webp](https://cdn.dong4j.site/source/image/20241229154732_gnLMAsbn.webp)

### å†…ç½‘

å†…ç½‘ä¸»è¦è®¾å¤‡å…¨éƒ¨å®ç° 2.5G:

![20241229154732_cdFkeuv1.webp](https://cdn.dong4j.site/source/image/20241229154732_cdFkeuv1.webp)

é€šè¿‡é›·é›³ 3 ç›´è¿çš„ 2 å° Mac mini èƒ½è¾¾åˆ° 20G:

![20241229154732_b9rVcsdz.webp](https://cdn.dong4j.site/source/image/20241229154732_b9rVcsdz.webp)

é€šè¿‡ä¸‡å…†äº¤æ¢æœºè¿æ¥çš„ Mac mini 2018 å’Œ DS923+ èƒ½è¾¾åˆ° 10G é€Ÿåº¦:

![20241229154732_yx0Zo8we.webp](https://cdn.dong4j.site/source/image/20241229154732_yx0Zo8we.webp)

### å¤–ç½‘->å®¶

![20241229154732_GedNor8D.webp](https://cdn.dong4j.site/source/image/20241229154732_GedNor8D.webp)

ç»™ä¸€ä¸ªé€†å¤©çš„ç½‘é€Ÿæµ‹è¯•æˆªå›¾, å°±å½“å›¾äº†ä¹ ğŸ¤©:

![20241229154732_CbAogrJy.webp](https://cdn.dong4j.site/source/image/20241229154732_CbAogrJy.webp)

## è®¾å¤‡ IP ç®¡ç†

ä»ä¹¦æˆ¿çš„ç½‘ç»œæ‹“æ‰‘å›¾å¯ä»¥çœ‹å‡º, ä¸»è¦ç¡¬ä»¶è®¾å¤‡çš„ IP åœ°å€åˆ†é…éƒ½ä¿æŒæœ‰åº. è¿™ç§è§„åˆ’æ–¹å¼çš„ä¼˜åŠ¿æ˜¯: **åªéœ€è®°ä½è®¾å¤‡çš„æœ€åä¸€ä½æ•°å­—**, ä¾¿èƒ½å¿«é€Ÿæ‰¾åˆ°å¯¹åº”è®¾å¤‡.

å¦ä¸€ç§å¸¸è§æ–¹å¼æ˜¯é€šè¿‡ä¿®æ”¹ **hosts æ–‡ä»¶**, ä¸ºæ¯ä¸ªè®¾å¤‡è®¾ç½®å¯¹åº”çš„åŸŸå.

æœ€ç†æƒ³çš„è§£å†³æ–¹æ¡ˆæ˜¯**è‡ªå»º DNS æœåŠ¡**, ä»¥é›†ä¸­ç®¡ç†æ‰€æœ‰è®¾å¤‡çš„ DNS è§£æä»»åŠ¡, æ›´é«˜æ•ˆåœ°åº”å¯¹è®¾å¤‡æ•°é‡çš„å¢åŠ å’Œå˜åŒ–.

### IP è®¾ç½®ç­–ç•¥

ç”±äºè®¾å¤‡è¾ƒå¤š, ä¸”æœªæ¥å¯èƒ½å¢åŠ æ–°è®¾å¤‡, å› æ­¤æœªé‡‡ç”¨åœ¨è®¾å¤‡ç«¯æ‰‹åŠ¨è®¾ç½®é™æ€ IP çš„æ–¹å¼.

**åŸå› **:

1. **çµæ´»æ€§**: æŸäº›è®¾å¤‡ (å¦‚å¼€å‘æ¿) å¯èƒ½é¢‘ç¹åˆ‡æ¢ç½‘ç»œæˆ–è¿æ¥ä¸åŒå®½å¸¦.
2. **æ˜“ç®¡ç†**: é€šè¿‡è·¯ç”±å™¨å®ç°é™æ€ IP ç»‘å®šæ—¢ç®€å•åˆé«˜æ•ˆ, å¯ç»Ÿä¸€ç®¡ç†è®¾å¤‡çš„ IP åœ°å€åˆ†é….

è®¾å¤‡ IP åˆ†é…æ–¹æ¡ˆæŒ‰ç…§ç½‘å£æ•°é‡è¿›è¡Œç²—ç•¥åˆ†ç»„, IP åœ°å€åŸºäºå…¶è¿æ¥çš„ç”µä¿¡æˆ–è”é€šå®½å¸¦è¿›è¡Œåˆ’åˆ†. è¿™ç§è§„åˆ’æ—¢ä¾¿äºæ‰©å±•, åˆç¡®ä¿äº†ç½‘ç»œç»“æ„çš„æ¸…æ™°å’Œå¯æ§æ€§.

### IP åˆ†é…

ç²—ç•¥æŒ‰ç…§ç½‘å£å¯¹è®¾å¤‡è¿›è¡Œåˆ†ç±»:

| ç½‘å£æ•°é‡      | è®¾å¤‡                                                                       | æ‰€éœ€ IP æ•°é‡      |
| ------------- | -------------------------------------------------------------------------- | ----------------- |
| WiFi          | `ç§»åŠ¨è®¾å¤‡ * 4`                                                             | 4                 |
| å•ç½‘å£        | Apple TV, å°ç±³ç”µè§†                                                         | 2                 |
| å•ç½‘å£ + WiFi | `å¼€å‘æ¿ * 7`                                                               | 14                |
| åŒç½‘å£        | `R2S * 2`, DS218+, DS923+(2 ä¸ªåƒå…†ç½‘å£é“¾è·¯èšåˆæˆ 1 ä¸ªç½‘å£, å¦ä¸€ä¸ªä¸‡å…†ç½‘å£) | 4(ç”µä¿¡è”é€šå„ä¸€ä¸ª) |
| åŒç½‘å£ + WiFI | MBP, Mac mini M2, Mac mini 2018                                            | 6                 |
| 3 ç½‘å£        | R5S                                                                        | 1                 |
| 4 ç½‘å£        | M920x. ç»„è£…æœº                                                              | 4                 |

ç®—ä¸‹æ¥åªéœ€è¦è®°ä½ 35 ä¸ª IP ğŸ˜…, å½“ç„¶éƒ½æ˜¯æœ‰è§„å¾‹çš„:

æ¯”å¦‚ MBP:

- ç”µä¿¡ RJ45: 192.168.31.8
- è”é€š RJ45: 192.168.21.8
- ç”µä¿¡ WiFi: 192.169.31.88
- è”é€š WiFi: 192.169.21.88

**IP åˆ†é…è§„åˆ™**

ä¸ºäº†ä¾¿äºç®¡ç†å’Œè®°å¿†, ä¸»è¦è®¾å¤‡çš„ IP åœ°å€åˆ†é…éµå¾ªä»¥ä¸‹è§„åˆ™:

1. **å‰ 10 ä½ IP åˆ†é…ç»™ä¸»è¦è®¾å¤‡**:

   - å¦‚è®¾å¤‡éœ€è¦è¿æ¥ WiFi, ç›´æ¥åœ¨æœ‰çº¿ IP çš„åŸºç¡€ä¸Š **double** (ç¿»å€) å³å¯, æ¯”å¦‚ RJ45 IP ä¸º `192.168.31.8`, WiFi IP å°±æ˜¯ `192.168.31.88`.
   - å¦‚æœæŸè®¾å¤‡è¶…è¿‡äº† 10 ä½èŒƒå›´, ä¸”æœ‰é¢å¤–çš„ WiFi è¿æ¥éœ€æ±‚, åˆ™åœ¨æœ‰çº¿ IP åé¢æ·»åŠ ä¸€ä¸ª **0**, æ¯”å¦‚ RJ45 IP ä¸º `192.168.31.11`, WiFi IP å°±æ˜¯ `192.168.31.110`.

2. **è¶…å‡ºè§„åˆ™æ—¶çš„å¤„ç†**:

   - å½“æ·»åŠ  **0** å¯¼è‡´ IP è¶…è¿‡ **254** æ—¶, ç›´æ¥å°†ä¸‹ä¸€ä½ IP åœ°å€é€’å¢, æ¯”å¦‚ RJ45 IP ä¸º `192.168.31.33`, WiFi IP å°±æ˜¯ `192.168.31.34`.
   - ç¡®ä¿åˆ†é…åˆæ³•, é¿å…ä½¿ç”¨éæ³• IP.

3. **å…¶ä»–è®¾å¤‡çš„åˆ†é…**:
   - æ— å…³ç´§è¦çš„è®¾å¤‡ä½¿ç”¨ **200 ä¹‹å**çš„ IP åœ°å€.
   - å½“å‰ **200 æ®µ**çš„ IP æ•°é‡å°šå……è¶³, å¦‚æœ‰éœ€æ±‚å¯ä»¥å†å¼€æ”¾æ›´å¤šçš„ IP æ®µ.

**ä¼˜åŠ¿åˆ†æ**

è¿™ç§åˆ†é…æ–¹å¼ä½¿**ä¸»è¦è®¾å¤‡çš„ IP è§„åˆ’ç®€å•æ˜“è®°**, åŒæ—¶å°†æ— å…³ç´§è¦çš„è®¾å¤‡åˆ’åˆ†è‡³ **200 æ®µ**å, å¯ä»¥å‡å°‘å¯¹ä¸»è¦è®¾å¤‡ IP åœ°å€æ®µçš„å¹²æ‰°, ç¡®ä¿æœªæ¥æ‰©å±•è®¾å¤‡æ—¶çš„çµæ´»æ€§å’Œæœ‰åºæ€§.

---

## è®¾å¤‡åŸŸåç®¡ç†

### Hosts

é€šè¿‡ä¿®æ”¹ **hosts æ–‡ä»¶**, ä¸ºæ¯ä¸ªè®¾å¤‡è®¾ç½®å¯¹åº”çš„åŸŸåæ˜¯ä¸€ç§å¸¸è§çš„æœ¬åœ°è§£ææ–¹æ¡ˆ.

ç„¶è€Œ, è¿™ç§æ–¹å¼å­˜åœ¨ä»¥ä¸‹é—®é¢˜:

1. **æ¯å°ç»ˆç«¯éœ€å•ç‹¬é…ç½®**: æ¯æ¬¡æ–°å¢è®¾å¤‡éƒ½éœ€è¦åœ¨æ‰€æœ‰ç»ˆç«¯çš„ hosts æ–‡ä»¶ä¸­æ‰‹åŠ¨æ·»åŠ é…ç½®.
2. **ä¸æ”¯æŒæ³›åŸŸåè§£æ**: ç³»ç»Ÿè‡ªå¸¦çš„ hosts æ–‡ä»¶æ— æ³•å¤„ç†ç±»ä¼¼ `*.xx.com` çš„æ³›åŸŸå.

å› æ­¤è¿™ç§æ–¹å¼ç®¡ç†æ•ˆç‡è¾ƒä½, æ‰©å±•æ€§å·®, ç‰¹åˆ«æ˜¯è®¾å¤‡æ•°é‡å¤šæˆ–é¢‘ç¹å˜åŠ¨çš„åœºæ™¯, æ˜¾å¾—å°¤ä¸ºä¸é€‚ç”¨.

**æ¨èæ›¿ä»£æ–¹æ¡ˆ**: é€šè¿‡è‡ªå»º DNS æœåŠ¡å®ç°é›†ä¸­ç®¡ç†, ä¸ä»…æ”¯æŒæ³›åŸŸåè§£æ, è¿˜èƒ½å‡å°‘æ¯å°ç»ˆç«¯çš„é…ç½®å·¥ä½œé‡, æå‡ç®¡ç†æ•ˆç‡å’Œçµæ´»æ€§.

### DNS æœåŠ¡

{% folding ğŸª¬ å¸¸è§çš„è‡ªæ‰˜ç®¡ DNS æœåŠ¡æœ‰: %}

1. **[dnsmasq](https://thekelleys.org.uk/dnsmasq/)**

- **åŠŸèƒ½ç‰¹ç‚¹**: è½»é‡çº§ DNS å’Œ DHCP æœåŠ¡å™¨, æ”¯æŒæœ¬åœ°è§£æã€DNS ç¼“å­˜ã€DHCP é™æ€ç»‘å®š.
- **é€‚ç”¨åœºæ™¯**: å®¶åº­å’Œå°å‹å±€åŸŸç½‘ä¸­ä½¿ç”¨, é…ç½®ç®€å•, èµ„æºå ç”¨æä½.
- **ä¼˜ç‚¹**:
  - è½»é‡åŒ–, æ˜“é…ç½®.
  - æ”¯æŒæœ¬åœ°é™æ€ IP å’ŒåŸŸåç»‘å®š.
- **ç¼ºç‚¹**:
  - é«˜çº§åŠŸèƒ½è¾ƒå°‘, ä¸é€‚åˆå¤§å‹ç½‘ç»œæˆ–å¤æ‚è§£æåœºæ™¯.

2. **[CoreDNS](https://coredns.io/)**

- **åŠŸèƒ½ç‰¹ç‚¹**: æ¨¡å—åŒ–ã€æ’ä»¶åŒ–è®¾è®¡çš„ DNS æœåŠ¡, é€‚åˆç°ä»£äº‘ç¯å¢ƒ.
- **é€‚ç”¨åœºæ™¯**: Kubernetes é›†ç¾¤ã€å¾®æœåŠ¡æ¶æ„çš„ DNS ç®¡ç†.
- **ä¼˜ç‚¹**:
  - æ”¯æŒè´Ÿè½½å‡è¡¡ã€ç¼“å­˜ã€DNSSEC ç­‰é«˜çº§åŠŸèƒ½.
  - æ’ä»¶åŒ–æ¶æ„, åŠŸèƒ½å¯æ‰©å±•æ€§å¼º.
- **ç¼ºç‚¹**:
  - é…ç½®å’Œå­¦ä¹ æ›²çº¿ç›¸å¯¹è¾ƒé«˜.
  - å¯¹åˆå­¦è€…å¯èƒ½æ˜¾å¾—è¿‡äºå¤æ‚.

3. **[SmartDNS](https://pymumu.github.io/smartdns/)**

- **åŠŸèƒ½ç‰¹ç‚¹**: é«˜æ€§èƒ½ DNS è§£æå™¨, ä¸“æ³¨äºæå‡è§£æé€Ÿåº¦å’Œå¯é æ€§.
- **é€‚ç”¨åœºæ™¯**: éœ€ä¼˜åŒ– DNS è§£æé€Ÿåº¦çš„ç¯å¢ƒ, å¦‚åŠ é€Ÿæµ·å¤–è§£æã€å½±éŸ³æœåŠ¡.
- **ä¼˜ç‚¹**:
  - æ”¯æŒå¤šçº¿è·¯ã€å¿«é€Ÿ DNS é€‰æ‹©.
  - ä¼˜åŒ–æµ·å¤–è§£ææ€§èƒ½.
- **ç¼ºç‚¹**:
  - åŠŸèƒ½ä¸“æ³¨äºåŠ é€Ÿ, ä¸é€‚åˆå¤æ‚è§£æéœ€æ±‚.
  - é«˜çº§åŠŸèƒ½è¾ƒå°‘, ç”Ÿæ€æ”¯æŒä¸å¦‚å…¶ä»–æ–¹æ¡ˆ.

4. **[AdGuard Home](https://adguard.com/en/adguard-home/overview.html)**

- **åŠŸèƒ½ç‰¹ç‚¹**: é›†æˆå¹¿å‘Šæ‹¦æˆªçš„ DNS æœåŠ¡, æä¾›å‹å¥½çš„ Web ç®¡ç†ç•Œé¢.
- **é€‚ç”¨åœºæ™¯**: å®¶åº­ç½‘ç»œå¹¿å‘Šå±è”½å’ŒåŸºç¡€ DNS ç®¡ç†.
- **ä¼˜ç‚¹**:
  - æ˜“ç”¨çš„ Web ç•Œé¢, é…ç½®ç®€å•ç›´è§‚.
  - é›†æˆå¹¿å‘Šæ‹¦æˆªã€éšç§ä¿æŠ¤åŠŸèƒ½.
- **ç¼ºç‚¹**:
  - çµæ´»æ€§ä¸è¶³, åå‘å®¶åº­ç”¨æˆ·.
  - æ’ä»¶å’Œé«˜çº§æ‰©å±•æ”¯æŒè¾ƒå¼±.

5. **[Pi-hole](https://pi-hole.net/)**

- **åŠŸèƒ½ç‰¹ç‚¹**: ä»¥å¹¿å‘Šæ‹¦æˆªä¸ºæ ¸å¿ƒçš„ DNS æœåŠ¡, å¯è¿è¡Œäº Raspberry Pi æˆ–å…¶ä»–å°å‹è®¾å¤‡ä¸Š.
- **é€‚ç”¨åœºæ™¯**: å®¶åº­æˆ–å°å‹åŠå…¬ç½‘ç»œä¸­çš„å¹¿å‘Šå±è”½å’ŒåŸºç¡€ DNS ç®¡ç†.
- **ä¼˜ç‚¹**:
  - å¼ºå¤§çš„å¹¿å‘Šå±è”½åŠŸèƒ½.
  - é…ç½®ç®€å•, æ”¯æŒè½»é‡çº§éƒ¨ç½².
- **ç¼ºç‚¹**:
  - é«˜çº§ DNS åŠŸèƒ½æ”¯æŒè¾ƒå¼±.
  - æ›´é€‚åˆå¹¿å‘Šå±è”½ç”¨é€”, ä¸é€‚åˆå¤æ‚ç½‘ç»œéœ€æ±‚.

6. **[Unbound](https://github.com/NLnetLabs/unbound)**

- **åŠŸèƒ½ç‰¹ç‚¹**: é«˜æ€§èƒ½é€’å½’ DNS æœåŠ¡å™¨, æ”¯æŒ DNSSEC å’Œéšç§ä¿æŠ¤.
- **é€‚ç”¨åœºæ™¯**: éœ€è¦å®‰å…¨ã€é«˜æ•ˆçš„é€’å½’ DNS æœåŠ¡çš„ç¯å¢ƒ.
- **ä¼˜ç‚¹**:
  - æ”¯æŒ DNSSEC, é€‚åˆéœ€è¦éšç§ä¿æŠ¤çš„åœºæ™¯.
  - é…ç½®çµæ´», æ€§èƒ½å‡ºè‰².
- **ç¼ºç‚¹**:
  - ç¼ºå°‘ Web ç•Œé¢, é…ç½®æ–‡ä»¶å¤æ‚åº¦è¾ƒé«˜.

7. **[BIND 9](https://github.com/isc-projects/bind9)**

- **åŠŸèƒ½ç‰¹ç‚¹**: åŠŸèƒ½å…¨é¢çš„æƒå¨ DNS æœåŠ¡å™¨, å¹¿æ³›ç”¨äºä¼ä¸šç¯å¢ƒ.
- **é€‚ç”¨åœºæ™¯**: ä¼ä¸šçº§ã€å¤æ‚è§£æéœ€æ±‚çš„ DNS æœåŠ¡.
- **ä¼˜ç‚¹**:
  - æ”¯æŒæƒå¨è§£æã€é€’å½’è§£æã€DNSSEC ç­‰åŠŸèƒ½.
  - åŠŸèƒ½å…¨é¢, ä¼ä¸šæ ‡å‡†.
- **ç¼ºç‚¹**:
  - å­¦ä¹ æˆæœ¬é«˜, é€‚åˆæœ‰ç»éªŒçš„ç®¡ç†å‘˜.
  - å¯¹ç³»ç»Ÿèµ„æºçš„éœ€æ±‚è¾ƒé«˜.

**æ€»ç»“å¯¹æ¯”è¡¨**

| å·¥å…·         | è½»é‡åŒ– | é«˜æ€§èƒ½ | æ˜“ç”¨æ€§ | æ’ä»¶æ‰©å±• | é«˜çº§åŠŸèƒ½ | é€‚ç”¨åœºæ™¯                |
| ------------ | ------ | ------ | ------ | -------- | -------- | ----------------------- |
| **dnsmasq**  | â˜…â˜…â˜…â˜…â˜…  | â˜…â˜…â˜…â˜…â˜†  | â˜…â˜…â˜…â˜…â˜…  | â˜…â˜†â˜†â˜†â˜†    | â˜…â˜…â˜†â˜†â˜†    | å®¶åº­ã€å°å‹ç½‘ç»œ          |
| **CoreDNS**  | â˜…â˜…â˜…â˜†â˜†  | â˜…â˜…â˜…â˜…â˜…  | â˜…â˜…â˜†â˜†â˜†  | â˜…â˜…â˜…â˜…â˜…    | â˜…â˜…â˜…â˜…â˜†    | Kubernetesã€å¾®æœåŠ¡ç¯å¢ƒ  |
| **SmartDNS** | â˜…â˜…â˜…â˜…â˜…  | â˜…â˜…â˜…â˜…â˜…  | â˜…â˜…â˜…â˜…â˜†  | â˜…â˜†â˜†â˜†â˜†    | â˜…â˜…â˜†â˜†â˜†    | DNS åŠ é€Ÿã€å½±éŸ³æœåŠ¡      |
| **AdGuard**  | â˜…â˜…â˜…â˜…â˜†  | â˜…â˜…â˜…â˜†â˜†  | â˜…â˜…â˜…â˜…â˜…  | â˜…â˜…â˜†â˜†â˜†    | â˜…â˜…â˜…â˜†â˜†    | å¹¿å‘Šå±è”½ã€å®¶åº­ç½‘ç»œ      |
| **Pi-hole**  | â˜…â˜…â˜…â˜…â˜†  | â˜…â˜…â˜…â˜†â˜†  | â˜…â˜…â˜…â˜…â˜†  | â˜…â˜…â˜†â˜†â˜†    | â˜…â˜…â˜…â˜†â˜†    | å¹¿å‘Šå±è”½ã€åŸºç¡€ DNS ç®¡ç† |
| **Unbound**  | â˜…â˜…â˜…â˜†â˜†  | â˜…â˜…â˜…â˜…â˜…  | â˜…â˜…â˜†â˜†â˜†  | â˜…â˜…â˜†â˜†â˜†    | â˜…â˜…â˜…â˜…â˜…    | å®‰å…¨é€’å½’ DNS æœåŠ¡       |
| **BIND 9**   | â˜…â˜…â˜†â˜†â˜†  | â˜…â˜…â˜…â˜…â˜†  | â˜…â˜…â˜†â˜†â˜†  | â˜…â˜…â˜…â˜†â˜†    | â˜…â˜…â˜…â˜…â˜…    | ä¼ä¸šç¯å¢ƒã€æƒå¨ DNS æœåŠ¡ |

**æ–¹æ¡ˆé€‰æ‹©æ¨è**:

- **è½»é‡åŒ–å’Œä¾¿æ·é…ç½®**: é€‰æ‹© **dnsmasq**.
- **å¹¿å‘Šæ‹¦æˆªå’Œæ˜“ç”¨æ€§**: é€‰æ‹© **AdGuard Home** æˆ– **Pi-hole**.
- **é«˜æ€§èƒ½é€’å½’è§£æ**: é€‰æ‹© **Unbound**.
- **å¤æ‚ä¼ä¸šçº§éœ€æ±‚**: é€‰æ‹© **BIND 9**.
- **äº‘åŸç”Ÿç¯å¢ƒæˆ–å¾®æœåŠ¡æ¶æ„**: é€‰æ‹© **CoreDNS**.
- **è¿½æ±‚è§£æé€Ÿåº¦ä¼˜åŒ–**: é€‰æ‹© **SmartDNS**.

ç›®å‰åœ¨ç”¨çš„æ˜¯è½»é‡çº§çš„ **SmartDNS** å’Œ **AdGuard Home**, R2S çš„å›ºä»¶ä¸­è‡ªå¸¦è¿™ 2 ä¸ªæœåŠ¡, ç¨å¾®é…ç½®å³å¯å®ç°è‡ªå®šä¹‰ DNS, å¹¶å…·å¤‡å¹¿å‘Šæ‹¦æˆªçš„åŠŸèƒ½.

{% endfolding %}

### Surge Hosts

åªéœ€è¦æ»¡è¶³ä¸»è¦è®¾å¤‡èƒ½é€šè¿‡åŸŸåè®¿é—®å…¶ä»–æœåŠ¡å™¨æˆ–æœåŠ¡å³å¯, å› æ­¤æ²¡å¿…è¦å•ç‹¬éƒ¨ç½²ä¸€ä¸ª DNS è§£ææœåŠ¡, **SmartDNS** å’Œ **AdGuard Home** æ›´å¤šçš„æ˜¯ç”¨æ¥æ‹¦æˆªå¹¿å‘Š.

Surge æœ¬èº«å°±å…·å¤‡ hosts ç®¡ç†åŠŸèƒ½, ä¸”æ”¯æŒæ³›åŸŸåè§£æ(å¯ä»¥é€šè¿‡ Synology Drive æˆ– iCloud æœåŠ¡æ¥åŒæ­¥é…ç½®, é¿å…å¤šç«¯é‡å¤é…ç½®):

```
# R2ST çš„ npm ä»£ç†, æ‰€æœ‰çš„ *.npm å…¨éƒ¨è½¬å‘åˆ° R2ST çš„ 80 ç«¯å£, ç„¶åå†é€šè¿‡ NPM è½¬å‘åˆ°å…¶ä»–æœåŠ¡
*.npm = 192.168.31.10
```

### æ–¹æ¡ˆæ€»ç»“

åœ¨å®é™…ä½¿ç”¨ä¸­, æ²¡æœ‰å•ä¸€æ–¹æ¡ˆèƒ½å¤Ÿå®Œå…¨æ»¡è¶³æ‰€æœ‰éœ€æ±‚, å› æ­¤éœ€è¦æ ¹æ®ä¸åŒåœºæ™¯æ­é…å¤šç§æ–¹æ¡ˆ.

æˆ‘æƒ³å®ç°çš„ç›®æ ‡å°±æ˜¯ **æ–¹ä¾¿å¿«æ·çš„è®¿é—®è®¾å¤‡ä¸æœåŠ¡**, é¿å…è®°å¿†å¤§é‡ IP åœ°å€åŠç«¯å£å·, æå‡è®¿é—®æ•ˆç‡.

å…¶å®, ä¸»è¦è®¾å¤‡å°±é‚£ä¹ˆå‡ å°, è®°ä½å‡ ä¸ª IP ä¹Ÿä¸æ˜¯é‚£ä¹ˆéš¾, ä¸”ä¸»è¦è®¾å¤‡çš„ IP è‚¯å®šä¸ä¼šç»å¸¸æ”¹åŠ¨. é—®é¢˜æ˜¯æ¯å°æœåŠ¡å™¨çš„æœåŠ¡éœ€è¦é€šè¿‡ç«¯å£åŒºåˆ†, å¦‚æœæ˜¯ Web æœåŠ¡, ç›´æ¥ç”¨ Dashboard è¿™ç±»æœåŠ¡æ¥ç®¡ç†, å«Œéº»çƒ¦å°±ç”¨ä¹¦ç­¾, æ¨è [Markoob](https://chromewebstore.google.com/detail/markoob-%E4%B9%A6%E7%AD%BE%E5%90%AF%E5%8A%A8%E5%99%A8/lnhnllkaacmnkffnjgcnokifakeckido?hl=zh-CN):

![20241229154732_sTNm93mn.webp](https://cdn.dong4j.site/source/image/20241229154732_sTNm93mn.webp)

<a id="é€šè¿‡è‡ªå®šä¹‰åŸŸåå‡å°‘éœ€è¦è®°å¿†çš„ IP æ•°é‡" style="display:none;"></a> <!--éšè—é”šç‚¹-->

å¦ä¸€ç§åˆ™æ˜¯é€šè¿‡è‡ªå®šä¹‰åŸŸåçš„æ–¹å¼å‡å°‘éœ€è¦è®°ä½çš„ IP æ•°é‡, å‰é¢ [Surge Hosts](#Surge Hosts) å·²ç»ä»‹ç»è¿‡ hosts åŠŸèƒ½, æˆ‘å°†ç»“åˆ [Nginx Proxy Manager](https://nginxproxymanager.com/) å†æ¬¡ç®€åŒ–æ‰ç«¯å£, ç›´æ¥é€šè¿‡è‡ªå®šä¹‰åŸŸåè®¿é—®æ‰€æœ‰æœåŠ¡. [å…·ä½“çš„é…ç½®å°†åœ¨åç»­è¯¦ç»†è¯´æ˜](#ä»£ç†å±€åŸŸç½‘è‡ªå®šä¹‰åŸŸå).

æ‰€ä»¥æ€»ç»“ä¸‹æ¥å°±ä»¥ä¸‹å‡ ç‚¹:

1. ä½¿ç”¨æµè§ˆå™¨ä¹¦ç­¾ç®¡ç†å¸¸ç”¨ Web æœåŠ¡ (åœ¨æœåŠ¡ç¯‡ä¼šä½¿ç”¨å¼€æºçš„ Dashboard æœåŠ¡æ¥ç®¡ç†);
2. [ä½¿ç”¨ NPM + Surge Hosts å®ç° 80 ç«¯å£è®¿é—®è‡ªå®šä¹‰åŸŸå](#ä»£ç†å±€åŸŸç½‘è‡ªå®šä¹‰åŸŸå), ç®€åŒ–åŸŸåå¹¶å‡å°‘ IP è®°å¿†;

---

## è®¾å¤‡è¿æ¥ç®¡ç†

### SSH

èƒ½é€šè¿‡ SSH è¿æ¥çš„è®¾å¤‡æˆ‘è¿™é‡Œç»Ÿç§°ä¸º **æœåŠ¡å™¨**, é‚£ä¹ˆåœ¨ä¸ç®—è™šæ‹Ÿæœºçš„æƒ…å†µä¸‹, æ€»å…±æœ‰ 20 å°è®¾å¤‡, å¦‚æœéœ€è¦åŒæ—¶è®¿é—®å¤šå°è®¾å¤‡, åœ¨ä½¿ç”¨ macOS è‡ªå¸¦çš„ç»ˆç«¯æˆ– iTerm2 ä¸€ä¸ªä¸ªæ‰‹æ•²çš„è¯æ•ˆç‡éå¸¸ä½, ä¸è¿‡æˆ‘ä»¬å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼æå‡æ•ˆç‡.

#### åˆ«åé…ç½®

é¦–å…ˆæƒ³åˆ°çš„æ˜¯ä¸ºæ¯å°æœåŠ¡å™¨è®¾ç½®ä¸€ä¸ªç®€çŸ­å¥½è®°çš„åˆ«å, æˆ‘ä»¬å¯ä»¥ç¼–è¾‘ `.ssh/config` æ–‡ä»¶æ¥å®ç°:

```shell
Host åˆ«å
    HostName æœåŠ¡å™¨ IP
    User username
    Port ssh-port
```

è¿æ¥æ–¹å¼:

```
ssh åˆ«å
```

#### SSH å…å¯†ç™»å½•

ä¸ºäº†é¿å…æ¯æ¬¡éƒ½éœ€è¦è¾“å…¥å¯†ç , æˆ‘ä»¬å¯ä»¥é…ç½® SSH çš„å…å¯†ç™»å½•:

```shell
# å®¢æˆ·ç«¯æ²ˆåŸ SSH å¯†é’¥å¯¹ ()
$ ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
Generating public/private rsa key pair.
Enter file in which to save the key (/Users/dong4j/.ssh/id_rsa): è¿™é‡Œè¾“å…¥æ–°çš„å¯†é’¥ä¿å­˜è·¯å¾„ [æˆ‘æ²¡æœ‰ç›´æ¥ä¿å­˜åˆ°é»˜è®¤çš„ id_rsa ä¸­, åç»­ä¼šå…±äº«è¿™ä¸ªå¯†é’¥]

# ä½¿ç”¨ ssh-copy-id å·¥å…·å°†å…¬é’¥ä¼ è¾“åˆ°ç›®æ ‡æœåŠ¡å™¨
ssh-copy-id user@remote_server
```

å¦‚æœæœªå®‰è£… ssh-copy-id, å¯ä»¥æ‰‹åŠ¨ä¼ è¾“å…¬é’¥:

```shell
# å°†å…¬é’¥å¤åˆ¶åˆ°å‰ªè´´æ¿
cat ~/.ssh/server.pub | pbcopy  # macOS
cat ~/.ssh/server.pub | xclip  # Linux

# ç™»å½•æœåŠ¡å™¨
ssh user@remote_server

# åœ¨æœåŠ¡å™¨ä¸Šå°†å…¬é’¥æ·»åŠ åˆ° authorized_keys
echo "your-public-key" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

éªŒè¯å…å¯†æ˜¯å¦ç”Ÿæ•ˆ:

```shell
# å¦‚æœæ²¡æœ‰æç¤ºè¾“å…¥å¯†ç , åˆ™é…ç½®æˆåŠŸ
ssh user@remote_server
```

æ‹·è´å…¬é’¥åˆ°å…¶ä»–æœåŠ¡å™¨å, ä¸ºäº†å®ç°å±€åŸŸç½‘æœåŠ¡å™¨ä¹‹é—´ SSH å…å¯†ç™»å½•, æˆ‘ä¼šå°†ç¬¬ä¸€æ­¥ç”Ÿæˆçš„ `server` ä¹Ÿæ‹·è´åˆ°å…¶ä»–æ‰€æœ‰æœåŠ¡å™¨.

å€¼å¾—è¯´æ˜çš„æ˜¯, R2S å’Œ R5S å¯ä»¥é€šè¿‡ WebUI è¿›è¡Œé…ç½®:

![20241229154732_SwNzaDIS.webp](https://cdn.dong4j.site/source/image/20241229154732_SwNzaDIS.webp)

#### SSH å¯†é’¥è®¤è¯

ä¸ºäº†å®‰å…¨èµ·è§, å»ºè®®å…³é—­å¯†ç è®¤è¯, åªå¼€å¯å…¬é’¥è®¤è¯.

ç¼–è¾‘æœåŠ¡å™¨ä¸Šçš„ SSH é…ç½®æ–‡ä»¶ /etc/ssh/sshd_config

```shell
# å®Œå…¨ç¦æ­¢ä½¿ç”¨å¯†ç è®¤è¯, å¼ºåˆ¶æ‰€æœ‰ç”¨æˆ·ä½¿ç”¨å…¬é’¥è®¤è¯
PasswordAuthentication no
# å¯ç”¨å…¬é’¥è®¤è¯
PubkeyAuthentication yes
# ç¦ç”¨ç©ºå¯†ç ç™»å½•
PermitEmptyPasswords no
```

é‡å¯ SSH æœåŠ¡ä»¥åº”ç”¨æ›´æ”¹:

```shell
# æ³¨æ„ ä¸åŒçš„ç³»ç»Ÿé‡å¯å‘½ä»¤å¯èƒ½ä¸ä¸€æ ·
sudo systemctl restart sshd
```

é…ç½®æœ¬æœºçš„ `.ssh/config`

```shell
Host åˆ«å
    HostName æœåŠ¡å™¨ IP
    User username
    Port ssh-port
    IdentityFile ~/.ssh/server
```

#### SSH å…è®¸ root ç™»å½•

æ•°æ®ç¯‡ä¸­ä¼šè®²åˆ°å¦‚ä½• **ä½¿ç”¨ Synology NAS å¤‡ä»½æœåŠ¡å™¨ä¸Šçš„é‡è¦æ•°æ®**, å‰ææ˜¯å¿…é¡»ä½¿ç”¨ root è´¦å·ç™»å½•æœåŠ¡å™¨, æ‰€ä»¥è¿™é‡Œé¡ºå¸¦æŠŠ SSH å…è®¸ root ç™»å½•ä¸€èµ·å†™ä¸€ä¸‹ (å¼€å¯ root ç™»å½•ä¼šå¢åŠ æ½œåœ¨çš„å®‰å…¨é£é™©, åŠæ—¶åªæ˜¯åœ¨å†…ç½‘ä½¿ç”¨):

ç¼–è¾‘æœåŠ¡å™¨ä¸Šçš„ SSH é…ç½®æ–‡ä»¶ /etc/ssh/sshd_config

```shell
# å…è®¸ root ç”¨æˆ·ç™»å½•, ä½†ä»…é™å¯†é’¥è®¤è¯, ä¸å…è®¸å¯†ç ç™»å½•
PermitRootLogin prohibit-password
```

ä»¥ä¸‹æ˜¯å¢åŠ  SSH å®‰å…¨æ€§çš„å¸¸è§„æ‰‹æ®µ:

1. é™åˆ¶ root ç™»å½•çš„ IP æ®µ;
2. ä»…å…è®¸å¯†é’¥ç™»å½•;
3. å¯ç”¨ MFA (å¤šå› ç´ è®¤è¯);
4. ä½¿ç”¨ [Fail2Ban](https://github.com/fail2ban/fail2ban) è‡ªåŠ¨å°ç¦å¤šæ¬¡å¤±è´¥çš„ç™»å½•å°è¯•;
5. æ›´æ”¹ SSH é»˜è®¤ç«¯å£;

#### SSH å¤šå› ç´ è®¤è¯

æ›´è¿›ä¸€æ­¥, ä½ å¯ä»¥ä¸º SSH å¼€å¯å¤šå› ç´ è®¤è¯:

```shell
# å®‰è£… Google Authenticator PAM æ¨¡å—:
brew install google-authenticator-libpam

# ä¸ºç™»å½•ç”¨æˆ·ç”Ÿæˆä¸€ä¸ªåŸºäºæ—¶é—´çš„ä¸€æ¬¡æ€§å¯†ç é…ç½®
google-authenticator

# æ‰«æç”Ÿæˆçš„äºŒç»´ç åˆ° Google Authenticatorã€Authy æˆ–å…¶ä»–æ”¯æŒ TOTP çš„åº”ç”¨

# ç¼–è¾‘ PAM æ–‡ä»¶ /etc/pam.d/sshd, åœ¨æ–‡ä»¶çš„é¡¶éƒ¨æ·»åŠ ä»¥ä¸‹å†…å®¹:
auth required /opt/homebrew/lib/security/pam_google_authenticator.so
```

ç¼–è¾‘ SSH é…ç½®æ–‡ä»¶ /etc/ssh/sshd_config, è°ƒæ•´ä»¥ä¸‹å‚æ•°:

```shell
# å¯ç”¨æŒ‘æˆ˜å“åº”è®¤è¯
ChallengeResponseAuthentication yes

# ä¿ç•™æˆ–ç¦ç”¨å¯†ç è®¤è¯ (æ ¹æ®éœ€è¦)
PasswordAuthentication yes
```

macOS ä¸‹é‡å¯ SSH æœåŠ¡

```shell
sudo launchctl unload /System/Library/LaunchDaemons/ssh.plist
sudo launchctl load /System/Library/LaunchDaemons/ssh.plist
```

**æ³¨æ„äº‹é¡¹**

1. **å¤‡ä»½å¯†é’¥ä¸å¤‡ç”¨ä»£ç **:

   ç¡®ä¿ç”Ÿæˆçš„å¯†é’¥å’Œå¤‡ç”¨ä»£ç ä¿å­˜åœ¨å®‰å…¨çš„åœ°æ–¹.

2. **æ’é™¤ç‰¹å®šç”¨æˆ·**:

å¯åœ¨ PAM é…ç½®ä¸­å®šä¹‰ä¾‹å¤–ç”¨æˆ·ç»„, è·³è¿‡ MFA:

```shell
# o_mfa_users æ˜¯æ— éœ€ MFA çš„ç”¨æˆ·ç»„
auth [success=1 default=ignore] pam_succeed_if.so user ingroup no_mfa_users
auth required pam_google_authenticator.so
```

3. **ç»“åˆ SSH å¯†é’¥**:

é…ç½® SSH å¯†é’¥è®¤è¯ä¸ MFA ç»“åˆä½¿ç”¨, æå‡å®‰å…¨æ€§.

#### SSH ä¼šè¯ä¿æŒ

åŒä¸€ä¸»æœºçš„å¤šæ¬¡è¿æ¥å¯ä»¥å¤ç”¨å·²æœ‰è¿æ¥, å‡å°‘ç™»å½•æ—¶é—´:

```shell
Host *
    # æ·»åŠ ç§é’¥åˆ° ssh-agent å¹¶å…è®¸å…¶å­˜å‚¨åœ¨ macOS å¯†é’¥é“¾ä¸­
    AddKeysToAgent yes
    # é€šè¿‡ ssh-agent ç®¡ç†ç§é’¥, UseKeychain ç‰¹åˆ«é€‚ç”¨äº macOS, å°†ç§é’¥å®‰å…¨å­˜å‚¨
    UseKeychain yes
    # æŒ‡å®šç§é’¥è·¯å¾„, å¯¹æ‰€æœ‰ SSH è¿æ¥ç”Ÿæ•ˆ
    IdentityFile ~/.ssh/server

    # å¯ç”¨ SSH å¤šè·¯å¤ç”¨: å…è®¸å¤ç”¨ç°æœ‰çš„ SSH è¿æ¥, æ— éœ€æ¯æ¬¡é‡æ–°è®¤è¯
    ControlMaster auto
    # æŒ‡å®šæ§åˆ¶å¥—æ¥å­—å­˜å‚¨è·¯å¾„, å¯ä½¿ç”¨ /tmp æˆ–ç”¨æˆ·ç›®å½•ä¸‹çš„å­æ–‡ä»¶å¤¹ (å¦‚ ~/.ssh/session)
    ControlPath /tmp/%r@%h:%p

    # å³ä½¿æ²¡æœ‰æ´»åŠ¨ä¼šè¯, ä¸»è¿æ¥ä»ä¿æŒæœ€å¤š 4 å°æ—¶
    ControlPersist 4h

    # å¯ç”¨ SSH æ•°æ®å‹ç¼©, å°¤å…¶é€‚åˆä½å¸¦å®½ç½‘ç»œ
    Compression yes

    # å¿ƒè·³åŒ…è®¾ç½®: é˜²æ­¢è¿æ¥å› ç©ºé—²è¶…æ—¶è¢«æ–­å¼€
    ServerAliveInterval 60  # æ¯ 60 ç§’å‘é€ä¸€æ¬¡å¿ƒè·³åŒ…
    ServerAliveCountMax 5   # å¿ƒè·³å¤±è´¥è¶…è¿‡ 5 æ¬¡åæ–­å¼€è¿æ¥
```

#### SSH ç«¯å£è½¬å‘

ç»å¸¸ä½¿ç”¨åˆ° SSH ä¸”ä¼šç”¨åˆ°ç«¯å£è½¬å‘åŠŸèƒ½, è¿™é‡Œä»…åšä¸ªè®°å½•.

##### 1. æœ¬åœ°è½¬å‘

æœ¬åœ°è½¬å‘æ˜¯ä¸€ç§é€šè¿‡ SSH åˆ›å»ºçš„éš§é“, å®ƒå…è®¸ä½ å°†æœ¬æœºçš„æŸä¸ªç«¯å£ä¸Šçš„é€šä¿¡, é€šè¿‡ SSH æœåŠ¡å™¨è½¬å‘åˆ°å¦ä¸€å°è¿œç¨‹æœåŠ¡å™¨çš„æŒ‡å®šç«¯å£. åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­, SSH æœåŠ¡å™¨å……å½“äº†ä¸€ä¸ªä¸­ç»§çš„è§’è‰², ä½¿å¾—æœ¬åœ°è®¡ç®—æœºèƒ½å¤Ÿè®¿é—®é‚£äº›å®ƒåŸæœ¬æ— æ³•ç›´æ¥è¿æ¥çš„è¿œç¨‹æœåŠ¡. **æœ¬åœ°è½¬å‘æ˜¯åœ¨æœ¬åœ°æœºå™¨ä¸Šè®¾ç½®è½¬å‘è§„åˆ™**.

è¯­æ³•å¦‚ä¸‹, å…¶ä¸­ä¼šæŒ‡å®šæœ¬åœ°ç«¯å£ (local-port) ã€SSH æœåŠ¡å™¨ (tunnel-host) ã€è¿œç¨‹æœåŠ¡å™¨ (target-host) å’Œè¿œç¨‹ç«¯å£ (target-port) .

```shell
ssh -N -f -L local-port:target-host:target-port username@tunnel-host
```

ä¸Šé¢å‘½ä»¤ä¸­, æœ‰ä¸‰ä¸ªé…ç½®å‚æ•°.

`-L`: è½¬å‘æœ¬åœ°ç«¯å£.

`-N`: ä¸å‘é€ä»»ä½•å‘½ä»¤, åªç”¨æ¥å»ºç«‹è¿æ¥. æ²¡æœ‰è¿™ä¸ªå‚æ•°, ä¼šåœ¨ SSH æœåŠ¡å™¨æ‰“å¼€ä¸€ä¸ª Shell.

`-f`: å°† SSH è¿æ¥æ”¾åˆ°åå°. æ²¡æœ‰è¿™ä¸ªå‚æ•°, æš‚æ—¶ä¸ç”¨ SSH è¿æ¥æ—¶, ç»ˆç«¯ä¼šå¤±å»å“åº”.

å‡è®¾æœ¬åœ°å¼€å‘æœºåªèƒ½è®¿é—®è·³æ¿æœº(`192.168.31.x`) ç½‘ç»œ, ä¸”è·³æ¿æœºå› ä¸ºå¤šç½‘å¡èƒ½å¤Ÿè®¿é—® `192.168.21.x` ç½‘ç»œ, æ‹“æ‰‘å›¾å¦‚ä¸‹:

![SSH-LocalForward.drawio.svg](https://cdn.dong4j.site/source/image/SSH-LocalForward.drawio.svg)

```shell
# åœ¨æœ¬åœ°å¼€å‘æœºä¸Šæ‰§è¡Œ
ssh -N -f -L 9876:192.168.21.10:9876 root@192.168.31.33
# å…³é—­æœ¬åœ°ç«¯å£è½¬å‘
ssh -O cancel -L 9876:192.168.21.10:9876 root@192.168.31.33
```

åŒæ—¶å¯ä»¥é…ç½® `.ssh/config` å®ç°:

```shell
Host lddns
    HostName 192.168.31.33
    User root
    Port 22
    IdentityFile ~/.ssh/server
    # LocalForward client-IP:client-port target-host:target-port
    LocalForward 9876 192.168.21.10:9876
```

å½“åœ¨æœ¬åœ°æœºå™¨ä¸Šè®¿é—® localhost:9876 æ—¶, SSH ä¼šå°†æµé‡é€šè¿‡ **åŠ å¯†çš„ SSH è¿æ¥** è½¬å‘åˆ°è¿œç¨‹æœåŠ¡å™¨ 192.168.21.10 çš„ 9876 ç«¯å£.

è¿™é‡Œçš„ **åŠ å¯†çš„ SSH è¿æ¥** æ˜¯æŒ‡ `192.168.31.33` SSH è¿æ¥é€šé“.

![20241229154732_9jBdqLcR.webp](https://cdn.dong4j.site/source/image/20241229154732_9jBdqLcR.webp)

**ä½¿ç”¨åœºæ™¯**:

- **è¿œç¨‹æ•°æ®åº“è®¿é—®**: å°†æœ¬åœ°çš„ 3306 ç«¯å£æ˜ å°„åˆ°è¿œç¨‹æœåŠ¡å™¨çš„ 3306 ç«¯å£, è¿™æ ·å°±å¯ä»¥ä½¿ç”¨æœ¬åœ°çš„æ•°æ®åº“ç®¡ç†å·¥å…·è®¿é—®è¿œç¨‹æ•°æ®åº“.
- **Web æœåŠ¡è®¿é—®**: å¦‚æœä½ æ­£åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šå¼€å‘ Web åº”ç”¨, å¹¶ä¸”éœ€è¦ä»æœ¬åœ°æœºå™¨è®¿é—®è¿™ä¸ªåº”ç”¨, å¯ä»¥é€šè¿‡æœ¬åœ°è½¬å‘å°†è¿œç¨‹æœåŠ¡å™¨çš„ç«¯å£æ˜ å°„åˆ°æœ¬åœ°è®¡ç®—æœºçš„æŸä¸ªç«¯å£.
- **VPN æ›¿ä»£æ–¹æ¡ˆ**: å½“ä½ æ— æ³•ä½¿ç”¨ VPN æ—¶, å¯ä»¥é€šè¿‡ SSH æœ¬åœ°è½¬å‘æ¥å®‰å…¨åœ°è®¿é—®è¿œç¨‹ç½‘ç»œä¸­çš„èµ„æº.

##### 2. è¿œç¨‹è½¬å‘

è¿œç¨‹è½¬å‘æŒ‡çš„æ˜¯åœ¨è¿œç¨‹ SSH æœåŠ¡å™¨å»ºç«‹çš„è½¬å‘è§„åˆ™.

å®ƒè·Ÿæœ¬åœ°è½¬å‘æ­£å¥½åè¿‡æ¥. å»ºç«‹æœ¬åœ°è®¡ç®—æœºåˆ°è¿œç¨‹ SSH æœåŠ¡å™¨çš„éš§é“ä»¥å, æœ¬åœ°è½¬å‘æ˜¯é€šè¿‡æœ¬åœ°è®¡ç®—æœºè®¿é—®è¿œç¨‹ SSH æœåŠ¡å™¨, è€Œè¿œç¨‹è½¬å‘åˆ™æ˜¯é€šè¿‡è¿œç¨‹ SSH æœåŠ¡å™¨è®¿é—®æœ¬åœ°è®¡ç®—æœº. å®ƒçš„å‘½ä»¤æ ¼å¼å¦‚ä¸‹.

```shell
$ ssh -R remote-port:target-host:target-port -N remotehost
```

ä¸Šé¢å‘½ä»¤ä¸­, `-R` å‚æ•°è¡¨ç¤ºè¿œç¨‹ç«¯å£è½¬å‘, `remote-port` æ˜¯è¿œç¨‹ SSH æœåŠ¡å™¨çš„ç«¯å£, `target-host` å’Œ `target-port` æ˜¯ç›®æ ‡æœåŠ¡å™¨åŠå…¶ç«¯å£, `remotehost `æ˜¯è¿œç¨‹ SSH æœåŠ¡å™¨.

è¿œç¨‹è½¬å‘ä¸»è¦é’ˆå¯¹å†…ç½‘çš„æƒ…å†µ. ä¸‹é¢ä¸¾ä¸¤ä¸ªä¾‹å­.

ç¬¬ä¸€ä¸ªä¾‹å­æ˜¯å†…ç½‘æŸå°æœåŠ¡å™¨ `localhost` åœ¨ 80 ç«¯å£å¼€äº†ä¸€ä¸ªæœåŠ¡, å¯ä»¥é€šè¿‡è¿œç¨‹è½¬å‘å°†è¿™ä¸ª 80 ç«¯å£, æ˜ å°„åˆ°å…·æœ‰å…¬ç½‘ IP åœ°å€çš„ `my.public.server` æœåŠ¡å™¨çš„ 8080 ç«¯å£, ä½¿å¾—è®¿é—® `my.public.server:8080` è¿™ä¸ªåœ°å€, å°±å¯ä»¥è®¿é—®åˆ°é‚£å°å†…ç½‘æœåŠ¡å™¨çš„ 80 ç«¯å£.

```shell
$ ssh -R 8080:localhost:80 -N my.public.server
```

ä¸Šé¢å‘½ä»¤æ˜¯åœ¨å†…ç½‘ `localhost` æœåŠ¡å™¨ä¸Šæ‰§è¡Œ, å»ºç«‹ä» `localhost` åˆ° `my.public.server` çš„ SSH éš§é“. è¿è¡Œä»¥å, ç”¨æˆ·è®¿é—® `my.public.server:8080`, å°±ä¼šè‡ªåŠ¨æ˜ å°„åˆ° `localhost:80`.

ç¬¬äºŒä¸ªä¾‹å­æ˜¯æœ¬åœ°è®¡ç®—æœº `local` åœ¨å¤–ç½‘, SSH è·³æ¿æœºå’Œç›®æ ‡æœåŠ¡å™¨ `my.private.server `éƒ½åœ¨å†…ç½‘, å¿…é¡»é€šè¿‡ SSH è·³æ¿æœºæ‰èƒ½è®¿é—®ç›®æ ‡æœåŠ¡å™¨. ä½†æ˜¯, æœ¬åœ°è®¡ç®—æœº `local` æ— æ³•è®¿é—®å†…ç½‘ä¹‹ä¸­çš„ SSH è·³æ¿æœº, è€Œ SSH è·³æ¿æœºå¯ä»¥è®¿é—®æœ¬æœºè®¡ç®—æœº.

ç”±äºæœ¬æœºæ— æ³•è®¿é—®å†…ç½‘ SSH è·³æ¿æœº, å°±æ— æ³•ä»å¤–ç½‘å‘èµ· SSH éš§é“, å»ºç«‹ç«¯å£è½¬å‘. å¿…é¡»åè¿‡æ¥, ä» SSH è·³æ¿æœºå‘èµ·éš§é“, å»ºç«‹ç«¯å£è½¬å‘, è¿™æ—¶å°±å½¢æˆäº†è¿œç¨‹ç«¯å£è½¬å‘. è·³æ¿æœºæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤, ç»‘å®šæœ¬åœ°è®¡ç®—æœº `local` çš„ `2121` ç«¯å£, å»è®¿é—® `my.private.server:80`.

```shell
$ ssh -R 2121:my.private.server:80 -N local
```

ä¸Šé¢å‘½ä»¤æ˜¯åœ¨ SSH è·³æ¿æœºä¸Šæ‰§è¡Œçš„, å»ºç«‹è·³æ¿æœºåˆ° `local` çš„éš§é“, å¹¶ä¸”è¿™æ¡éš§é“çš„å‡ºå£æ˜ å°„åˆ° `my.private.server:80`.

æ˜¾ç„¶, è¿œç¨‹è½¬å‘è¦æ±‚æœ¬åœ°è®¡ç®—æœº `local` ä¹Ÿå®‰è£…äº† SSH æœåŠ¡å™¨, è¿™æ ·æ‰èƒ½æ¥å— SSH è·³æ¿æœºçš„è¿œç¨‹ç™»å½•.

æ‰§è¡Œä¸Šé¢çš„å‘½ä»¤ä»¥å, è·³æ¿æœºåˆ° `local` çš„éš§é“å·²ç»å»ºç«‹äº†. ç„¶å, å°±å¯ä»¥ä»æœ¬åœ°è®¡ç®—æœºè®¿é—®ç›®æ ‡æœåŠ¡å™¨äº†, å³åœ¨æœ¬æœºæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤.

```shell
$ curl http://localhost:2121
```

æœ¬æœºæ‰§è¡Œä¸Šé¢çš„å‘½ä»¤ä»¥å, å°±ä¼šè¾“å‡ºæœåŠ¡å™¨ `my.private.server` çš„ 80 ç«¯å£è¿”å›çš„å†…å®¹.

**ç¤ºä¾‹**:

å‡è®¾æœ¬åœ°å¼€å‘æœº(`192.168.31.8`)ä¸èƒ½è®¿é—®è·³æ¿æœº(`192.168.31.x`) ç½‘ç»œ, ä½†æ˜¯è·³æ¿æœºå¯ä»¥è®¿é—®æœ¬åœ°å¼€å‘æœº, ä¸”è·³æ¿æœºå› ä¸ºå¤šç½‘å¡èƒ½å¤Ÿè®¿é—® `192.168.21.x` ç½‘ç»œ,

è¿™æ—¶æœ¬åœ°å¼€å‘æœºæƒ³è®¿é—® `192.168.21.10:9876` æœåŠ¡.

æ‹“æ‰‘å›¾å¦‚ä¸‹:

![SSH-RemoteForward.drawio.svg](https://cdn.dong4j.site/source/image/SSH-RemoteForward.drawio.svg)

```shell
# åœ¨è·³æ¿æœºä¸Šæ‰§è¡Œ
ssh -R 1111:192.168.21.10:9876 -N dong4j@192.168.31.8
```

åŒæ—¶å¯ä»¥é…ç½® `.ssh/config` å®ç°:

```shell
Host rddns
    HostName 192.168.31.8
    User dong4j
    Port 22
    # RemoteForward remote-port target-host:target-port
    RemoteForward 1111 192.168.21.10:9876
```

![20241229154732_uDiQ0P2q.webp](https://cdn.dong4j.site/source/image/20241229154732_uDiQ0P2q.webp)

**ä½¿ç”¨åœºæ™¯**:

- å°†è¿˜åœ¨å…¬å¸åŠ ç­çš„ä½ æœ¬æœºä¸Šçš„ API æš´éœ²åˆ°å…¬ç½‘, åœ¨å®¶çš„åŒäº‹å°±èƒ½å’Œä½ æ„‰å¿«çš„è°ƒè¯•æ¥å£äº†;
- ä½ æœ¬åœ°çš„è½¯è·¯ç”±å…·å¤‡åˆ†æµèƒ½åŠ›, ä½ å…„å¼Ÿéœ€è¦ä¸´æ—¶ç”¨ä¸€ä¸‹æŸ¥é˜…ç‚¹å­¦ä¹ èµ„æ–™;

##### 3. åŠ¨æ€è½¬å‘

åŠ¨æ€è½¬å‘æŒ‡çš„æ˜¯, æœ¬æœºä¸ SSH æœåŠ¡å™¨ä¹‹é—´åˆ›å»ºäº†ä¸€ä¸ªåŠ å¯†è¿æ¥, ç„¶åæœ¬æœºå†…éƒ¨é’ˆå¯¹æŸä¸ªç«¯å£çš„é€šä¿¡, éƒ½é€šè¿‡è¿™ä¸ªåŠ å¯†è¿æ¥è½¬å‘. å®ƒçš„ä¸€ä¸ªä½¿ç”¨åœºæ™¯å°±æ˜¯, è®¿é—®æ‰€æœ‰å¤–éƒ¨ç½‘ç«™, éƒ½é€šè¿‡ SSH è½¬å‘.

åŠ¨æ€è½¬å‘éœ€è¦æŠŠæœ¬åœ°ç«¯å£ç»‘å®šåˆ° SSH æœåŠ¡å™¨. è‡³äº SSH æœåŠ¡å™¨è¦å»è®¿é—®å“ªä¸€ä¸ªç½‘ç«™, å®Œå…¨æ˜¯åŠ¨æ€çš„, å–å†³äºåŸå§‹é€šä¿¡, æ‰€ä»¥å«åšåŠ¨æ€è½¬å‘.

```shell
$ ssh -D local-port tunnel-host -N
```

ä¸Šé¢å‘½ä»¤ä¸­, `-D `è¡¨ç¤ºåŠ¨æ€è½¬å‘, `local-port `æ˜¯æœ¬åœ°ç«¯å£, `tunnel-host `æ˜¯ SSH æœåŠ¡å™¨, `-N `è¡¨ç¤ºè¿™ä¸ª SSH è¿æ¥åªè¿›è¡Œç«¯å£è½¬å‘, ä¸ç™»å½•è¿œç¨‹ Shell, ä¸èƒ½æ‰§è¡Œè¿œç¨‹å‘½ä»¤, åªèƒ½å……å½“éš§é“.

ä¸¾ä¾‹æ¥è¯´, å¦‚æœæœ¬åœ°ç«¯å£æ˜¯ `2121`, é‚£ä¹ˆåŠ¨æ€è½¬å‘çš„å‘½ä»¤å°±æ˜¯ä¸‹é¢è¿™æ ·.

```shell
$ ssh -D 2121 tunnel-host -N
```

æ³¨æ„, è¿™ç§è½¬å‘é‡‡ç”¨äº† SOCKS5 åè®®. è®¿é—®å¤–éƒ¨ç½‘ç«™æ—¶, éœ€è¦æŠŠ HTTP è¯·æ±‚è½¬æˆ SOCKS5 åè®®, æ‰èƒ½æŠŠæœ¬åœ°ç«¯å£çš„è¯·æ±‚è½¬å‘å‡ºå».

ä¸‹é¢æ˜¯ SSH éš§é“å»ºç«‹åçš„ä¸€ä¸ªä½¿ç”¨å®ä¾‹.

```shell
$ curl -x socks5://localhost:2121 http://www.example.com
```

ä¸Šé¢å‘½ä»¤ä¸­, curl çš„ `-x` å‚æ•°æŒ‡å®šä»£ç†æœåŠ¡å™¨, å³é€šè¿‡ SOCKS5 åè®®çš„æœ¬åœ° `2121` ç«¯å£, è®¿é—® `http://www.example.com`.

**ç¤ºä¾‹**:

```
ssh -D 1234 intel -N
curl -x socks5://localhost:1234 https://google.hk
```

åœ¨ Mac mini 2018 ä¸Šå¯ä»¥çœ‹åˆ°è¯·æ±‚:

![20241229154732_SFzeDyB8.webp](https://cdn.dong4j.site/source/image/20241229154732_SFzeDyB8.webp)

#### SSH è·³æ¿æœº

```shell
# è·³æ¿æœº
Host tjump
    HostName å…¬ç½‘ ip
    User {username}
    Port {port}

Host nas
    HostName 192.168.1.20
    User {username}
    Port {port}

# é€šè¿‡è·³æ¿ç™»å½•åˆ° 192.168.1.20
Host jnas
    HostName 192.168.1.20
    User {username}
    Port {port}
    ProxyJump tjump
```

ä½¿ç”¨æ–¹å¼:

```shell
ssh jnas
# æˆ–è€…
ssh -J tjump nas
```

#### SSH ä¸¤çº§è·³æ¿

é¦–å…ˆ, æˆ‘ä»¬éœ€è¦åœ¨æœ¬æœºè®¾ç½®ç¬¬ä¸€çº§ SSH éš§é“. æ‰§è¡Œä»¥ä¸‹å‘½ä»¤:

```
$ ssh -L 1999:localhost:2999 tunnel1-host
```

è¿™æ¡å‘½ä»¤çš„ä½œç”¨æ˜¯, åœ¨æœ¬åœ°æœºå™¨ä¸Šç›‘å¬ `1999` ç«¯å£, å¹¶å°†æ‰€æœ‰å‘å¾€è¿™ä¸ªç«¯å£çš„è¯·æ±‚, é€šè¿‡ SSH éš§é“è½¬å‘åˆ° `tunnel1-host` è¿™å°æœºå™¨çš„ `2999` ç«¯å£.
æ¥ä¸‹æ¥, åœ¨ç¬¬ä¸€å°è·³æ¿æœº (`tunnel1-host`) ä¸Š, æˆ‘ä»¬éœ€è¦å»ºç«‹ç¬¬äºŒçº§ SSH éš§é“. æ‰§è¡Œä»¥ä¸‹å‘½ä»¤:

```
$ ssh -L 2999:target-host:3999 tunnel2-host -N
```

è¿™æ¡å‘½ä»¤çš„å«ä¹‰æ˜¯, å°† `tunnel1-host` ä¸Šçš„ `2999` ç«¯å£é€šè¿‡ SSH éš§é“è¿æ¥åˆ° `tunnel2-host`, ç„¶åå†ç”± `tunnel2-host` è½¬å‘åˆ°ç›®æ ‡æœåŠ¡å™¨ `target-host` çš„ `3999` ç«¯å£.
è¿™æ ·è®¾ç½®å, å½“æˆ‘ä»¬è®¿é—®æœ¬æœºçš„ `1999` ç«¯å£æ—¶, è¯·æ±‚å®é™…ä¸Šä¼šè¢«è½¬å‘åˆ° `target-host` çš„ `3999` ç«¯å£.

![SSH-multi-stage.drawio.svg](https://cdn.dong4j.site/source/image/SSH-multi-stage.drawio.svg)

**åº”ç”¨åœºæ™¯**:
è¿™ç§å¤šçº§ç«¯å£è½¬å‘çš„è®¾ç½®å¸¸ç”¨äºä»¥ä¸‹æƒ…å†µ:

1. è®¿é—®å†…ç½‘æœåŠ¡å™¨: å½“ç›®æ ‡æœåŠ¡å™¨ä½äºå¤šå±‚å†…ç½‘ä¸­, ç›´æ¥è®¿é—®å—é™æ—¶, å¯ä»¥é€šè¿‡å¤šçº§è·³æ¿æœºè¿›è¡Œè®¿é—®.
2. å®‰å…¨åŠ å›º: é€šè¿‡å¤šçº§è·³æ¿æœº, å¢åŠ æ”»å‡»è€…å…¥ä¾µçš„éš¾åº¦, æé«˜ç³»ç»Ÿçš„å®‰å…¨æ€§.
3. ç½‘ç»œéš”ç¦»: åœ¨éœ€è¦éš”ç¦»ä¸åŒç½‘ç»œç¯å¢ƒçš„æƒ…å†µä¸‹, é€šè¿‡è·³æ¿æœºå®ç°æ•°æ®çš„ä¼ è¾“.

#### SSH é›†ä¸­ç®¡ç†

iTerm2 é€šè¿‡ `Profiles` æ¥ç®¡ç†å¤šä¸ªæœåŠ¡å™¨(ä½¿ç”¨ `âŒ˜ + O` æ‰“å¼€æœåŠ¡å™¨åˆ—è¡¨), ä½†æ˜¯å¹¶æ²¡æœ‰åˆ†ç»„åŠŸèƒ½, ç®¡ç†å¤šä¸ªæœåŠ¡å™¨ä¸æ˜¯ç‰¹åˆ«æ–¹ä¾¿.

è¿™é‡Œæœ‰ä¸€äº›æ¯”è¾ƒçƒ­é—¨çš„ç»ˆç«¯ç®¡ç†å·¥å…·:

- [Termius](https://termius.com/)
- [Warp](https://www.warp.dev/)
- [Tabby](https://tabby.sh/)

ç›®å‰æˆ‘ä½¿ç”¨çš„æ˜¯ [Royal TSX](https://royalapps.com/ts/mac/features), ç›®å‰è§‰å¾—å®Œå…¨æ»¡è¶³æˆ‘çš„å¤§éƒ¨åˆ†éœ€æ±‚, ä¸”éƒ¨åˆ†ç‰¹æ€§è¿˜èƒ½å¸¦æ¥ä¸€äº›å°æƒŠå–œ:

![20241229154732_qJtszN5c.webp](https://cdn.dong4j.site/source/image/20241229154732_qJtszN5c.webp)

**Royal TSX** ä¸­çš„ `document` æ¦‚å¿µæ˜¯å°†æ‰€æœ‰è¢«ç®¡ç†çš„ SSH æœåŠ¡å™¨é›†ä¸­æŒä¹…åŒ–æˆä¸€ä¸ªæ–‡ä»¶(å› ä¸ºè¿™ä¸ªæ–‡ä»¶ä¼šå­˜åœ¨æœåŠ¡å™¨è¿æ¥ä¿¡æ¯, æ‰€ä»¥è¿˜æ”¯æŒåŠ å¯†), æˆ‘å¯ä»¥å°†è¿™ä¸ªæ–‡ä»¶é€šè¿‡ Synology Drive åŒæ­¥åˆ°å…¶ä»– Mac ä¸Š, è¿™å°±å¯ä»¥å®ç° `ä¸€æ¬¡é…ç½®, åˆ°å¤„ä½¿ç”¨`;

å¦å¤–åƒç«¯å£æ˜ å°„, å®‰å…¨ç½‘å…³, å¯†é’¥ç®¡ç†ç­‰è¿™äº›å¸¸è§„åŠŸèƒ½å…¨éƒ¨æ”¯æŒ. å¦å¤–æ¯”è¾ƒæƒŠå–œçš„å°±æ˜¯ **Royal TSX** èƒ½é€šè¿‡æ’ä»¶æœºåˆ¶æ”¯æŒ **Web**, **RDP**, **VNC** ç­‰è¿œç¨‹ç®¡ç†åŠŸèƒ½:

![20241229154732_qPkpKpIh.webp](https://cdn.dong4j.site/source/image/20241229154732_qPkpKpIh.webp)

ä½ ä¸€ä¸ªæ¯”è¾ƒæƒŠå–œçš„åŠŸèƒ½å°±æ˜¯: `Broadcast Input to all Terminal Sessions`, å¼€å¯å¤šä¸ªçª—å£, åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šçš„æ“ä½œä¼šåŒæ­¥è¾“å‡ºåˆ°å…¶ä»–æœåŠ¡å™¨, è¿™ä¸ªå¯ä»¥å¤§å¤§ç®€åŒ–æœåŠ¡å™¨çš„é…ç½®å·¥ä½œ.

**ç®€æ´çš„ SSH è½¬å‘è®¾ç½®**:

![20241229154732_Y4Nd46Ht.webp](https://cdn.dong4j.site/source/image/20241229154732_Y4Nd46Ht.webp)

**ä¸²å£è¿æ¥**:

![20241229154732_wjJjhY4o.webp](https://cdn.dong4j.site/source/image/20241229154732_wjJjhY4o.webp)

ä½†æ˜¯ **Royal TSX** ä¹Ÿæœ‰å®ƒçš„ä¸è¶³, æ¯”å¦‚ **æ–‡ä»¶ç®¡ç†ä¸æ–¹ä¾¿**, RDP è¿æ¥åˆ†è¾¨ç‡æ— æ³•åŠ¨æ€é€‚é…ç­‰, æ‰€ä»¥æˆ‘ä½¿ç”¨äº†å¦ä¸€æ¬¾å·¥å…·: **XTerminal**, å®ƒçš„ä¼˜ç‚¹æ˜¯æ–‡ä»¶ç®¡ç†å’Œç³»ç»Ÿç›‘æ§, äº®ç‚¹æ˜¯åŸºäº AI çš„å‘½ä»¤è¡Œæç¤º.

![20241229154732_ge0CQUf1.webp](https://cdn.dong4j.site/source/image/20241229154732_ge0CQUf1.webp)

- åŒå‡»æ–‡ä»¶å³å¯ç›´æ¥ç¼–è¾‘æ–‡ä»¶
- å¯æ‹–æ‹½ä¸Šä¼ ä¸‹è½½æ–‡ä»¶
- æœåŠ¡å™¨ç›‘æ§é¢æ¿

**AI åŠŸèƒ½**:

![20241229154732_SEqIOKAz.webp](https://cdn.dong4j.site/source/image/20241229154732_SEqIOKAz.webp)

**å¯è§†åŒ–çš„ SSH ç«¯å£è½¬å‘é…ç½®**:

![20241229154732_bduEnWfP.webp](https://cdn.dong4j.site/source/image/20241229154732_bduEnWfP.webp)

---

#### å‚è€ƒ

- [ssh è½¬å‘ä»£ç†ï¼šssh-agent ç”¨æ³•è¯¦è§£](https://www.cnblogs.com/f-ck-need-u/p/10484531.html): é¿å…é‡å¤è¾“å…¥ passphrase
- [SSH agent forwarding çš„æ‡‰ç”¨](https://ihower.tw/blog/archives/7837): åœ¨è¿œç¨‹ä¸»æœºä¸Šä½¿ç”¨æœ¬åœ°çš„ ssh-agent è¿›è¡Œè®¤è¯ï¼Œæ¯”å¦‚åœ¨è¿œç¨‹ä¸»æœºä¸Šè¿›è¡Œ `git` æ“ä½œã€`ssh` åˆ°å¦ä¸€å°ä¸»æœºç­‰ï¼Œé¿å…å°†ç§é’¥ copy åˆ°è¿œç¨‹ä¸»æœºä¸Šã€‚
- [How to Set Up SSH 2fa (Two-Factor Authentication)](https://blog.longwin.com.tw/2014/10/ssh-google-2-factor-authentication-2014/): åœ¨ openssh server ä¸Šé…ç½®å¼ºåˆ¶è¿›è¡Œ 2FA åŒå› ç´ è®¤è¯ï¼Œæ¯æ¬¡ç™»å½•éƒ½éœ€è¦è¾“å…¥ Google Authenticator APP æä¾›çš„ä¸€æ¬¡æ€§åŠ¨æ€å¯†ç ã€‚

### RDP

ä¸Šè¿° 2 æ¬¾å·¥å…·éƒ½ä¸èƒ½å¾ˆå¥½çš„æ”¯æŒå®Œç¾çš„ RDP è¿œç¨‹æ¡Œé¢, æ‰€æœ‰æˆ‘ä½¿ç”¨äº† [Microsoft Remote Desktop](https://apps.apple.com/us/app/windows-app/id1295203466?mt=12),

![20241229154732_mkDD0p2E.webp](https://cdn.dong4j.site/source/image/20241229154732_mkDD0p2E.webp)

{% folding å¦‚ä½•åˆ é™¤ thinclient_drives %}

**ubuntu**ä¸Šå®‰è£… **xrdp** æ­å»ºè¿œç¨‹æ¡Œé¢, åé¢è¿œç¨‹æ¡Œé¢æ˜¯å¯ä»¥äº†, ä½†æ˜¯ç”¨æˆ·ç›®å½•ä¸‹ç”Ÿå‡ºäº†ä¸€ä¸ª thinclient_drives æ–‡ä»¶å¤¹, **æ— è®ºæ˜¯ä¸æ˜¯ root éƒ½ä¸èƒ½åˆ é™¤**, å¦‚æœä½ æœ‰å¼ºè¿«ç—‡, ä½ å°±æ„Ÿè§‰ä¸èˆ’æœ, ä¸€å®šè¦åˆ é™¤, ä¸‹é¢ä»‹ç»å¦‚ä½•åˆ é™¤:

æ‰“å¼€å¹¶ä¿®æ”¹ /etc/xrdp/sesman.ini æ–‡ä»¶

```shell
sudo vim /etc/xrdp/sesman.ini

# å°† FuseMountName=thinclient_drives ä¿®æ”¹ä¸º FuseMountName=.xrdp/thinclient_drives
```

ç”±äº ~/.xrdp ç›®å½•ä¸å­˜åœ¨, æ‰€ä»¥ä¸ä¼šåˆ›å»º **thinclient_drives** æ–‡ä»¶å¤¹.

ä¹Ÿå¯ä»¥å°† **thinclient_drives** æ”¾åˆ° /run ç›®å½•ä¸‹:

```shell
FuseMountName=/run/user/%u/thinclient_drives
```

ç„¶ååˆ é™¤ **thinclient_drives** æ–‡ä»¶å¤¹

```shell
sudo umount thinclient_drives
sudo rm -rf thinclient_drives
```

ä»¥åé‡æ–°ç™»é™†ä¹Ÿä¸ä¼šå†å‡ºç° **thinclient_drives**, å¹¶ä¸”è¿œç¨‹è¿æ¥å…±äº«å‰ªè´´æ¿ä»ç„¶æœ‰æ•ˆ.

{% endfolding %}

### VNC

å¦‚æœåªæ˜¯è¿æ¥ macOS çš„è¯, å®˜æ–¹çš„ **å±å¹•å…±äº«.app** æ›´å€¼å¾—æ¨è.

å› ä¸º **å±å¹•å…±äº«.app** æ— æ³•è¿æ¥åˆ°æ ‘è“æ´¾, æ‰€ä»¥ä½¿ç”¨ **RDP** æˆ– **VNC Viewer**.

![20241229154732_CI6WwtAR.webp](https://cdn.dong4j.site/source/image/20241229154732_CI6WwtAR.webp)

{% folding ğŸª¬ Ubuntu è¿œç¨‹æ¡Œé¢æ¯æ¬¡é‡å¯å VNC å¯†ç æ”¹å˜çš„è§£å†³æ–¹å¼ %}

**é—®é¢˜æè¿°**:

- VNC æœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶å¦‚æœå¯†é’¥ç¯æœªè§£é”, å°†æ— æ³•è®¿é—®å­˜å‚¨çš„åŠ å¯† VNC å¯†ç .
- ç»“æœæ˜¯, **æ¯æ¬¡ VNC æœåŠ¡å™¨å¯åŠ¨æ—¶**, éƒ½ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªæ–°çš„å¯†ç .

**é—®é¢˜åŸå› **:

- Ubuntu 22.04 åœ¨è‡ªåŠ¨å¯åŠ¨æœŸé—´ä¸ä¼šè‡ªåŠ¨è§£é”å¯†é’¥ç¯, è¿™å½±å“äº† VNC æœåŠ¡å™¨çš„æ­£å¸¸ä½¿ç”¨.

**è§£å†³æ–¹æ¡ˆ**:

1. æ‰“å¼€â€œå¯†ç å’Œå¯†é’¥â€å®ç”¨å·¥å…·:
   - è½¬åˆ°**å®ç”¨å·¥å…·**èœå•, é€‰æ‹©**å¯†ç å’Œå¯†é’¥**.
2. ä¿®æ”¹é»˜è®¤å¯†é’¥ç¯çš„å¯†ç :
   - åœ¨**å¯†ç å’Œå¯†é’¥**ç®¡ç†å™¨ä¸­, å³é”®å•å‡»**é»˜è®¤å¯†é’¥ç¯**.
   - é€‰æ‹©**æ›´æ”¹å¯†ç **.
3. è¾“å…¥å¹¶ç¡®è®¤æ“ä½œ:
   - ç³»ç»Ÿå°†è¦æ±‚æ‚¨è¾“å…¥å½“å‰çš„ç”¨æˆ·åå¯†ç .
   - åœ¨**æ–°å¯†ç **å’Œ**ç¡®è®¤å¯†ç **å­—æ®µä¸­, ä¸è¦è¾“å…¥ä»»ä½•å†…å®¹, ä¿æŒç©ºç™½.
4. æ¥å—é£é™©è­¦å‘Š:
   - ç³»ç»Ÿä¼šè­¦å‘Šæ‚¨, å¯†é’¥ç¯ä¸Šå­˜å‚¨çš„æ‰€æœ‰å¯†ç å°†ä¸å†åŠ å¯†, å¹¶å°†ä¿æŒæœªåŠ å¯†çŠ¶æ€.
   - å¦‚æœæ‚¨èƒ½å¤Ÿæ¥å—è¿™ä¸ªå®‰å…¨é£é™©, ç¡®è®¤æ›´æ”¹.

é€šè¿‡ä»¥ä¸Šæ­¥éª¤, å¯ä»¥è§£å†³ Ubuntu 22.04 ä¸­ VNC æœåŠ¡å™¨åœ¨è‡ªåŠ¨å¯åŠ¨æ—¶æ— æ³•è®¿é—®åŠ å¯†å¯†ç çš„é—®é¢˜. ä½†æ˜¯è¿™æ ·åšä¼šé™ä½å¯†ç çš„å®‰å…¨æ€§, å› æ­¤å¯ä»¥é‡‡ç”¨ä¸‹é¢æ¨èçš„æ–¹å¼.

**æ¨èçš„æ–¹å¼**:

åœ¨**å¯†ç å’Œå¯†é’¥**åº”ç”¨ç¨‹åºä¸­æ‰§è¡Œä»¥ä¸‹æ“ä½œ:

1. **åˆ›å»ºä¸€ä¸ªæ–°çš„æ— å¯†ç å¯†é’¥ç¯**:
   - æ‰“å¼€**å¯†ç å’Œå¯†é’¥**åº”ç”¨ç¨‹åº.
   - åˆ›å»ºä¸€ä¸ªæ–°çš„å¯†é’¥ç¯, å¹¶åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­ä¸è®¾ç½®å¯†ç .
   - å°†è¿™ä¸ªæ–°çš„æ— å¯†ç å¯†é’¥ç¯è®¾ç½®ä¸ºé»˜è®¤.
2. **ä»ç™»å½•å¯†é’¥ç¯ä¸­åˆ é™¤ VNC å¯†ç **:
   - åœ¨**å¯†ç å’Œå¯†é’¥**åº”ç”¨ç¨‹åºä¸­, æ‰¾åˆ°ç™»å½•å¯†é’¥ç¯.
   - åˆ é™¤å­˜å‚¨åœ¨ç™»å½•å¯†é’¥ç¯ä¸­çš„ VNC å¯†ç .
3. **é‡æ–°å¯åŠ¨è®¡ç®—æœº**:
   - é‡å¯è®¡ç®—æœºä»¥ç¡®ä¿æ–°çš„æ— å¯†ç å¯†é’¥ç¯æˆä¸ºé»˜è®¤å¯†é’¥ç¯.

é‡å¯å, æ‰§è¡Œä»¥ä¸‹æ­¥éª¤:

1. **é‡æ–°è¾“å…¥ VNC å¯†ç **:
   - åœ¨å±å¹•å…±äº«è®¾ç½®ä¸­é‡æ–°è¾“å…¥ VNC å¯†ç .
   - è¿™å°†æŠŠ VNC å¯†ç å­˜å‚¨åœ¨æ–°çš„ä¸å®‰å…¨å¯†é’¥ç¯ä¸­.
2. **æ¢å¤ç™»å½•å¯†é’¥ç¯ä¸ºé»˜è®¤**:
   - å›åˆ°**å¯†ç å’Œå¯†é’¥**åº”ç”¨ç¨‹åº.
   - å°†ç™»å½•å¯†é’¥ç¯é‡æ–°è®¾ç½®ä¸ºé»˜è®¤å¯†é’¥ç¯.
3. **å†æ¬¡é‡æ–°å¯åŠ¨è®¡ç®—æœº**:

ç°åœ¨ VNC å¯†ç ä¿æŒä¿å­˜, è€Œé»˜è®¤å¯†é’¥ç¯ä¹Ÿæ¢å¤ä¸ºç™»å½•å¯†é’¥ç¯.

è¿™ç§æ–¹æ³•å°†æ‰€æœ‰å¯†ç ä¿å­˜ä¸ºçº¯æ–‡æœ¬çš„ä¸å®‰å…¨æ€§é™ä½åˆ°ä»…å°† VNC å¯†ç ä¿å­˜ä¸ºçº¯æ–‡æœ¬.

{% endfolding %}

---

## æš´éœ²æœåŠ¡åˆ°å…¬ç½‘

### å…³äº IPv4

æˆªè‡³ 2024 å¹´, IPv4 åœ°å€å·²ç»å…¨çƒæ¥è¿‘è€—å°½. è‡ª 2011 å¹´æ­£å¼å®£å¸ƒ IPv4 åœ°å€æ¯ç«­ä»¥æ¥, IPv4 åœ°å€æ± çš„å¯ç”¨æ•°é‡æŒç»­å‡å°‘, å¯¼è‡´å‰©ä½™çš„åœ°å€åœ¨äºŒçº§å¸‚åœºä¸Šçš„ä»·æ ¼ä¸æ–­ä¸Šæ¶¨ .

IPv4 ä½¿ç”¨ 32 ä½åœ°å€ç©ºé—´, å¯ä»¥æä¾›è¶…è¿‡ 40 äº¿ä¸ªå”¯ä¸€åœ°å€. ç„¶è€Œ, éšç€äº’è”ç½‘è¿æ¥è®¾å¤‡æ•°é‡çš„æ¿€å¢, è¿™ä¸€åœ°å€æ± å·²ç»è¢«è€—å°½. åŒ—ç¾ã€äºšæ´²å’Œæ¬§æ´²æ˜¯å‰©ä½™ IPv4 åœ°å€çš„ä¸»è¦æŒæœ‰åœ°åŒº, å…¶ä»–åœ°åŒºçš„ IPv4 åœ°å€èµ„æºç›¸å¯¹åŒ®ä¹ .

ç”±äº IPv4 åœ°å€çŸ­ç¼º, è®¸å¤šç»„ç»‡å’Œç½‘ç»œè¿è¥å•†å¼€å§‹ä¾èµ– NAT (ç½‘ç»œåœ°å€è½¬æ¢) æŠ€æœ¯, å…è®¸å¤šä¸ªè®¾å¤‡å…±äº«ä¸€ä¸ªå…¬å…± IP åœ°å€. æ­¤å¤–, IPv6 çš„æ¨å¹¿ä¹Ÿæˆä¸ºè§£å†³ IPv4 åœ°å€è€—å°½é—®é¢˜çš„é‡è¦æ‰‹æ®µ, ä½†ç”±äºå…¼å®¹æ€§é—®é¢˜ä»¥åŠè¿‡æ¸¡æˆæœ¬è¾ƒé«˜, IPv6 çš„éƒ¨ç½²è¿›å±•è¾ƒæ…¢ .

ç›®å‰, IPv4 åœ°å€çš„ç§Ÿèµå’Œè½¬å”®æˆä¸ºä¸€ç§å¸¸è§çš„åšæ³•, å°¤å…¶æ˜¯åœ¨é¢ä¸´ IPv4 åœ°å€åŒ®ä¹çš„ä¼ä¸šä¸­. å°½ç®¡å¦‚æ­¤, è¿™ç§åšæ³•ä»…æ˜¯ä¸´æ—¶æ€§çš„è§£å†³æ–¹æ¡ˆ, è€Œ IPv6 çš„æ™®åŠæ­£åœ¨å˜å¾—æ„ˆåŠ è¿«åˆ‡ .

### ä¸ºä»€ä¹ˆä½¿ç”¨ DDNS

æˆ‘æ—©æœŸç”³è¯·çš„ç”µä¿¡å’Œè”é€šçš„å…¬ç½‘ IP éƒ½æ˜¯åŠ¨æ€çš„, ä¼šè¢«è¿è¥å•†ä¸å®šæœŸçš„ä¿®æ”¹, ä¸ºäº†é¿å…å› å…¬ç½‘ IP å˜æ›´æ— æ³•è®¿é—®å®¶ä¸­çš„æœåŠ¡çš„é—®é¢˜, ç°åœ¨æœ€å¸¸ç”¨çš„æ–¹æ¡ˆå°±æ˜¯ä½¿ç”¨ DDNS æœåŠ¡.

### ä»€ä¹ˆæ˜¯ DDNS

åŠ¨æ€ DNS (DDNS) æ˜¯ä¸€é¡¹åœ¨ IP åœ°å€å‘ç”Ÿå˜åŒ–æ—¶å¯ä»¥è‡ªåŠ¨æ›´æ–° DNS è®°å½•çš„æœåŠ¡. åŸŸåå°†ç½‘ç»œ IP åœ°å€è½¬æ¢ä¸ºäººç±»å¯è¯»çš„åç§°, ä¾¿äºè¯†åˆ«å’Œä½¿ç”¨. å°†åç§°æ˜ å°„åˆ° IP åœ°å€çš„ä¿¡æ¯ä»¥è¡¨æ ¼å½¢å¼è®°å½•åœ¨ DNS æœåŠ¡å™¨ä¸Š. ä½†æ˜¯, ç½‘ç»œç®¡ç†å‘˜ä¼šåŠ¨æ€åˆ†é… IP åœ°å€å¹¶ç»å¸¸æ›´æ”¹. æ¯å½“ IP åœ°å€å‘ç”Ÿå˜åŒ–æ—¶, DDNS æœåŠ¡éƒ½ä¼šæ›´æ–° DNS æœåŠ¡å™¨è®°å½•. å€ŸåŠ© DDNS, åŸŸåç®¡ç†å˜å¾—æ›´å®¹æ˜“ã€æ›´é«˜æ•ˆ.

### åŠ¨æ€ DNS æ˜¯å¦‚ä½•å·¥ä½œçš„

ä»¥ä¸‹æ˜¯ä¸€èˆ¬æ­¥éª¤:

1. å‘åŠ¨æ€ DNS æœåŠ¡æä¾›å•†æ³¨å†ŒåŸŸåå¹¶é…ç½® DNS è®¾ç½®
2. å‘æä¾›å•†æä¾›åŸŸåçš„åˆå§‹ IP åœ°å€
3. ä½¿ç”¨æ›´æ”¹çš„ IP åœ°å€åœ¨è®¾å¤‡æˆ–æœåŠ¡å™¨å®ä¾‹ä¸Šå®‰è£…åŠ¨æ€ DNS å®¢æˆ·ç«¯

DDNS å®¢æˆ·ç«¯æŒç»­ç›‘æ§ IP åœ°å€å¹¶æ£€æµ‹ä»»ä½•æ›´æ”¹. å®¢æˆ·ç«¯å‘åŠ¨æ€ DNS æä¾›å•†å‘é€ DNS è®°å½•æ›´æ–°é€šçŸ¥, é€šçŸ¥å…¶æ–°çš„ IP åœ°å€. åŠ¨æ€ DNS æä¾›å•†ä¿®æ”¹è®°å½•ä»¥æŒ‡å‘æ–° IP åœ°å€.

åŠ¨æ€ DNS å®¢æˆ·ç«¯ä¼šç»§ç»­ç›‘æ§ IP åœ°å€ä»¥äº†è§£è¿›ä¸€æ­¥çš„æ›´æ”¹. æ¯å½“å‘ç”Ÿæ–°çš„æ›´æ”¹æ—¶, è¯¥è¿‡ç¨‹éƒ½ä¼šé‡å¤.

![20241229154732_h5KgUa28.webp](https://cdn.dong4j.site/source/image/20241229154732_h5KgUa28.webp)

![20241229154732_G1yaNntU.webp](https://cdn.dong4j.site/source/image/20241229154732_G1yaNntU.webp)

ç®€å•æ¥è¯´, å®½å¸¦è¿è¥å•†åªä¼šç»™æˆ‘ä»¬åŠ¨æ€çš„å…¬ç½‘ IP, è¿™ä¸ª IP ä¼šä¸å®šæ—¶å˜åŒ–, ä¸ºäº†èƒ½ä½¿åŸŸåæ˜ å°„åˆ°æ­£ç¡®çš„ IP ä¸Š, éœ€è¦å€ŸåŠ© DDNS å°†å½“å‰æœ€æ–°çš„ IP é€šè¿‡ API é€šçŸ¥åˆ° DNS æœåŠ¡è¿è¥å•†ä»¥ä¿®æ”¹ä¸ºæœ€æ–°çš„ IP.

æˆ‘æ‰€ä½¿ç”¨çš„åŸŸåæœåŠ¡å•†åˆ†åˆ«æ˜¯é˜¿é‡Œäº‘å’Œè…¾è®¯äº‘, ä¸ºäº†æ­£å¸¸ä½¿ç”¨ DDNS æœåŠ¡, éœ€è¦åˆ°å¯¹åº”çš„åŸŸåè¿è¥å•†ç”³è¯· API key, åé¢ä½¿ç”¨ ddns-go ä¼šç”¨åˆ°.

### DDNS æœåŠ¡é…ç½®

æˆ‘ç›®å‰çš„è®¾å¤‡è‡ªå¸¦äº† DDNS æœåŠ¡çš„æœ‰:

- Synology NAS: `å¤–éƒ¨è®¿é—®-DDNS`
- R2S è¿™ç±» OpenWrt ç³»ç»Ÿ: `æœåŠ¡-é˜¿é‡Œäº‘ DDNS` å’Œ `æœåŠ¡-åŠ¨æ€ DNS`

ä½†æ˜¯æˆ‘å¹¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨ä¸Šè¿°çš„æœåŠ¡, è€Œæ˜¯é€‰æ‹©ä½¿ç”¨ docker-compose éƒ¨ç½² [ddns-go](https://github.com/jeessy2/ddns-go), è¿™æ ·å¯ä»¥æ–¹ä¾¿çš„åŒæ­¥é…ç½®ä»¥ä¾¿å¿«é€Ÿåœ¨å…¶ä»–è®¾å¤‡ä¸Šéƒ¨ç½².

#### dons-go é‡åˆ°çš„å‘

![20241229154732_zetykBpn.webp](https://cdn.dong4j.site/source/image/20241229154732_zetykBpn.webp)

1. TTL è®¾ç½®é”™è¯¯å¯¼è‡´ API è°ƒç”¨å¤±è´¥

   DNS è¿è¥å•†çš„ TTL ä¸€èˆ¬éƒ½æ˜¯ 600 ç§’, å†å¿«å°±å¾—åŠ é’±äº†, ddns-go æœ€å¥½è®¾ç½®ä¸ºè‡ªåŠ¨, é¿å… API è°ƒç”¨å¤±è´¥.

2. é€šè¿‡æ¥å£è·å– IPv4 å¤ªé¢‘ç¹è¢«é™æµ

   ddns-go è‡ªå¸¦äº†å‡ ä¸ªç”¨äºè·å– IPv4 çš„ API æœåŠ¡, ä½†æ˜¯å› ä¸º ddns-go é¢‘ç¹è°ƒç”¨è¢« API æ¥å£æœåŠ¡å•†é™æµ;

3. é€šè¿‡æ¥å£è·å–çš„ IPv4 é”™è¯¯

   è¿™æ˜¯å› ä¸ºéƒ¨ç½² ddns-go çš„è®¾å¤‡åŒæ—¶éƒ¨ç½²äº†åˆ†æµæœåŠ¡, éœ€è¦ä¿®æ”¹åˆ†æµè§„åˆ™, æˆ‘é‡‡ç”¨ç¬¬äºŒç§æ–¹å¼: ä¸ä½¿ç”¨æ¥å£è·å–;

4. é€šè¿‡ç½‘å¡è·å–

   è¿™ç§æ–¹å¼åªèƒ½è·å–åˆ°å±€åŸŸç½‘ IP, é€‚ç”¨äº IPv6;

5. é€šè¿‡å‘½ä»¤è·å–

   æœ€ç»ˆé‡‡ç”¨è¿™ç§æ–¹å¼, ä¸”è¿”å› IPv4 åœ°å€çš„æœåŠ¡é€šè¿‡ Nginx åœ¨äº‘æœåŠ¡å™¨è‡ªå»ºäº†ä¸€ä¸ª, è·å– IPv4 çš„å‘½ä»¤å¦‚ä¸‹:

   ```shell
   curl --interface ç½‘å¡å url
   ```

   è¿™ç§æ–¹å¼éœ€è¦å¤„ç†å¤šç½‘å¡çš„æƒ…å†µ, å› æ­¤éœ€è¦ `--interface` å‚æ•°.

6. é€šè¿‡ç½‘å¡è·å– IPv6

   ![20241229154732_oi7eabiD.webp](https://cdn.dong4j.site/source/image/20241229154732_oi7eabiD.webp)

   IPv6 ä¸€èˆ¬ä¼šæœ‰å¤šä¸ªåœ°å€, éœ€è¦é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼ç­›é€‰

   > ç”µä¿¡ä¸º 240e å¼€å¤´ (240e::/20)
   >
   > ç§»åŠ¨ä¸º 2409 å¼€å¤´ (2409:8000::/20)
   >
   > è”é€šä¸º 2408 å¼€å¤´ (2408:8000::/20)

7. ddns-go å¯åŠ¨å‰ 10 åˆ†é’Ÿ(å…·ä½“å‡ åˆ†é’Ÿè®°ä¸å¾—äº†, åæ­£è¶Šå¿«è¶Šå¥½)æ‰èƒ½è®¾ç½®è´¦å·å¯†ç 

   ![20241229154732_XIzLrwv2.webp](https://cdn.dong4j.site/source/image/20241229154732_XIzLrwv2.webp)

æœ€å¥½ç¦ç”¨å…¬ç½‘è®¿é—®, è¿™æ ·åªèƒ½é€šè¿‡å±€åŸŸç½‘ IP è®¿é—®.

8. ddns-go å¯ä»¥é…ç½® IP å˜æ›´é€šçŸ¥, æˆ‘ä½¿ç”¨çš„æ˜¯ [bark](https://bark.day.app/#/) æœåŠ¡, å…¨å¹³å°å¯ç”¨, ä¸”æœåŠ¡ä¹Ÿèƒ½è‡ªæ‰˜ç®¡:

   ![20241229154732_7ajHZeNd.webp](https://cdn.dong4j.site/source/image/20241229154732_7ajHZeNd.webp)

#### è‡ªå»ºè·å–å…¬ç½‘ IP æœåŠ¡

æˆ‘çš„ç›®çš„å¾ˆç®€å•, å°±æ˜¯ä¸“ä¸º ddns-go æä¾›çš„ IP æŸ¥è¯¢æœåŠ¡, å› æ­¤æ²¡æœ‰åŠ  HTTPS è¯ä¹¦, äº‘æœåŠ¡å™¨å®‰è£… Nginx å¹¶æ·»åŠ é…ç½®, å…³é”®çš„é…ç½®å¦‚ä¸‹(è®°å¾—åœ¨å®‰å…¨ç»„å¼€ç«¯å£):

```
server {
    listen ç«¯å£å·;
    listen [::]:ç«¯å£å· ipv6only=on;
    server_name localhost;
    server_tokens off;

    location = /ip {
        add_header Content-Type text/plain;
        access_log off;
        return 200 "$remote_addr\n";
    }
}
```

è®¿é—® `http://ip:port/ip` å³å¯è¿”å›æ–‡æœ¬æ ¼å¼çš„å…¬ç½‘ IP.

å¦‚æœæƒ³è‡ªè¡Œéƒ¨ç½², å¯å‚è€ƒ [åˆ©ç”¨ Nginx å®ç°ç®€æ˜“çš„å…¬ç½‘ IP æŸ¥è¯¢](https://cloud.tencent.com/developer/article/2286395).

#### è·å–æ­£ç¡®çš„ IPv4

å› ä¸ºæˆ‘æœ‰ 2 ä¸ªå…¬ç½‘ IP, åŸŸååˆ†åˆ«å¯¹åº”ä¸åŒçš„ DNS æœåŠ¡å•†:

| å®½å¸¦è¿è¥å•† | åŸŸåæœåŠ¡å•† | åŸŸå(å‡è®¾)  | è·¯ç”±å™¨ IP    |
| ---------- | ---------- | ----------- | ------------ |
| ç”µä¿¡       | é˜¿é‡Œäº‘     | dong4j.tele | 192.168.31.1 |
| è”é€š       | è…¾è®¯äº‘     | dong4j.unic | 192.168.21.1 |

#### å¯¹äºå•ç½‘å¡

æ¯”å¦‚å½“å‰è®¾å¤‡æ˜¯ `192.168.31.1` è¿™å°è·¯ç”±å™¨ä¸‹çš„å­è®¾å¤‡, æŒ‰ç…§ä¸Šè¿°è¡¨æ ¼, åº”è¯¥è·å–åˆ°ç”µä¿¡çš„å…¬ç½‘ IP å¹¶é€šçŸ¥åˆ°é˜¿é‡Œäº‘çš„ DNS å·²å°† dong4j.tele æ˜ å°„åˆ°æ­£ç¡®çš„ IP ä¸Š.

#### å¯¹äºå¤šç½‘å¡

ä¸ºé¿å…å•ç‚¹é—®é¢˜, æˆ‘åŒæ—¶åœ¨ M920x, DS218+å’Œ DS923+ ä¸Šéƒ¨ç½²äº† ddns-go æœåŠ¡, å®ƒä»¬åŒæ—¶å…·å¤‡å¤šå¼ ç½‘å¡.

è¿è¡Œ `route -n` æ˜¾ç¤ºçš„è·¯ç”±è¡¨å¦‚ä¸‹:

| ç›®æ ‡    | ç½‘å…³         | å­ç½‘æ©ç  | æ ‡å¿— | è·ƒç‚¹ | å¼•ç”¨ | ä½¿ç”¨ | æ¥å£            |
| ------- | ------------ | -------- | ---- | ---- | ---- | ---- | --------------- |
| 0.0.0.0 | 192.168.21.1 | 0.0.0.0  | UG   | 100  | 0    | 0    | enx00e04c680012 |
| 0.0.0.0 | 192.168.31.1 | 0.0.0.0  | UG   | 103  | 0    | 0    | eno1            |

**è¡¨å¤´å­—æ®µè§£æ**

- **ç›®æ ‡ (Destination)**: æŒ‡å‘çš„ç›®æ ‡ç½‘ç»œæˆ–ä¸»æœºåœ°å€. `0.0.0.0` è¡¨ç¤ºé»˜è®¤è·¯ç”±, é€‚ç”¨äºæ‰€æœ‰æœªåŒ¹é…å…¶ä»–è·¯ç”±çš„æµé‡.
- **ç½‘å…³ (Gateway)**: æ•°æ®æµé‡éœ€è¦é€šè¿‡çš„ä¸‹ä¸€è·³ IP. å¦‚æœä¸º `0.0.0.0`, è¡¨ç¤ºç›®æ ‡ä¸ºç›´è¿ç½‘ç»œ, ç¬¬ä¸€è¡Œæ˜¯ `192.168.21.1`, è¡¨ç¤ºç»è¿‡è”é€šè·¯ç”±å™¨.
- **å­ç½‘æ©ç  (Genmask)**: å®šä¹‰ç›®æ ‡ç½‘ç»œçš„èŒƒå›´.
- **æ ‡å¿— (Flags)**:
  - `U`: è·¯ç”±æ˜¯æ´»åŠ¨çš„.
  - `G`: æµé‡éœ€è¦é€šè¿‡ç½‘å…³.
- **è·ƒç‚¹ (Metric)**: ä¼˜å…ˆçº§, æ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ (**åé¢ä¿®æ”¹ç½‘å¡ä¼˜å…ˆçº§ä¹Ÿå°±æ˜¯ä¿®æ”¹è¿™ä¸ªå€¼**).
- **å¼•ç”¨ (Ref)**: ä¿ç•™å­—æ®µ, é€šå¸¸ä¸º `0`.
- **ä½¿ç”¨ (Use)**: è¯¥è·¯ç”±è¡¨æ¡ç›®è¢«å‘½ä¸­çš„æ¬¡æ•°.
- **æ¥å£ (Iface)**: æ•°æ®æµé‡é€šè¿‡çš„ç½‘ç»œæ¥å£.

**è·¯ç”±è¡¨å†…å®¹åˆ†æ**

**ç¬¬ä¸€è¡Œ**

| ç›®æ ‡    | ç½‘å…³         | å­ç½‘æ©ç  | æ ‡å¿— | è·ƒç‚¹ | å¼•ç”¨ |
| ------- | ------------ | -------- | ---- | ---- | ---- |
| 0.0.0.0 | 192.168.21.1 | 0.0.0.0  | UG   | 100  | 0    |

- **é»˜è®¤è·¯ç”±**: åŒ¹é…æ‰€æœ‰æµé‡.
- **ç½‘å…³**: `192.168.21.1`.
- **æ¥å£**: `enx00e04c680012`.
- **è·ƒç‚¹**: `100`, ä¼˜å…ˆçº§é«˜äºç¬¬äºŒè¡Œ.

**ç¬¬äºŒè¡Œ**

| ç›®æ ‡    | ç½‘å…³         | å­ç½‘æ©ç  | æ ‡å¿— | è·ƒç‚¹ | å¼•ç”¨ |
| ------- | ------------ | -------- | ---- | ---- | ---- |
| 0.0.0.0 | 192.168.31.1 | 0.0.0.0  | UG   | 103  | 0    |

- **é»˜è®¤è·¯ç”±**: åŒæ ·åŒ¹é…æ‰€æœ‰æµé‡.
- **ç½‘å…³**: `192.168.31.1`.
- **æ¥å£**: `eno1`.
- **è·ƒç‚¹**: `103`, ä¼˜å…ˆçº§ä½äºç¬¬ä¸€è¡Œ.

**æ€»ç»“**

1. **å¤šé»˜è®¤è·¯ç”±**: ä¸¤æ¡é»˜è®¤è·¯ç”±åŒæ—¶å­˜åœ¨, ç³»ç»Ÿä¼šä¼˜å…ˆä½¿ç”¨è·ƒç‚¹è¾ƒä½çš„è·¯ç”± (å³ `192.168.21.1`) .
2. **æ•…éšœè½¬ç§»**: å¦‚æœä¼˜å…ˆè·¯ç”± (`192.168.21.1`) ä¸å¯ç”¨, ç³»ç»Ÿä¼šè‡ªåŠ¨å°è¯•ä½¿ç”¨ä¼˜å…ˆçº§è¾ƒä½çš„è·¯ç”± (`192.168.31.1`) .

ç¬¬ä¸€è¡Œè·ƒç‚¹ä¸º `100`, ä¸”ç½‘å…³ä¸º `192.168.21.1`, è¡¨ç¤º M920x ä¼šä¼˜å…ˆä½¿ç”¨ `enx00e04c680012` è¿™å¼ ç½‘å¡èµ°è”é€šç½‘ç»œ.

åŒç†æˆ‘ä»¬æ•´ç†ä¸€å¼ è¡¨æ ¼:

| æœåŠ¡å™¨ | ç¬¬ä¸€ä¼˜å…ˆçº§                     | ç¬¬äºŒä¼˜å…ˆçº§      |
| ------ | ------------------------------ | --------------- |
| M920x  | **enx00e04c680012** (**è”é€š**) | eno1 (ç”µä¿¡)     |
| DS218+ | **ovs_eth1**(**ç”µä¿¡**)         | ovs_eth0(è”é€š)  |
| DS923+ | **ovs_eth2**(**è”é€š**)         | ovs_bond0(ç”µä¿¡) |

ä¸ºäº†ä¿è¯ ddns-go è·å–æ­£ç¡®çš„ IPv4 åœ°å€, åº”è¯¥è¿™æ ·é…ç½®:

| ddns-go æ‰€åœ¨çš„æœåŠ¡å™¨ | ç”µä¿¡å…¬ç½‘ IP (Domains: `*.dong4j.tele`)         | è”é€šå…¬ç½‘ IP (Domains: `*.dong4j.unic`)               |
| -------------------- | ---------------------------------------------- | ---------------------------------------------------- |
| M920x                | `curl --interface eno1 http://ip:port/ip`      | `curl --interface enx00e04c680012 http://ip:port/ip` |
| DS218+               | `curl --interface ovs_eth1 http://ip:port/ip`  | `curl --interface ovs_eth0 http://ip:port/ip`        |
| DS923+               | `curl --interface ovs_bond0 http://ip:port/ip` | `curl --interface ovs_eth2 http://ip:port/ip`        |

- `http://ip:port/ip` æ˜¯å‰é¢è¯´çš„è‡ªå»ºçš„è·å–å…¬ç½‘ IP çš„æœåŠ¡;
- ä¸€å®šè¦æ³¨æ„ç¬¬ä¸€ä¼˜å…ˆçº§çš„ç½‘å¡å¯¹åº”çš„æ˜¯å“ªä¸ªè·¯ç”±å™¨ä»¥åŠè·¯ç”±å™¨å¯¹åº”çš„å®½å¸¦æœåŠ¡å•†;

### æ³›è§£æ

å‰é¢é€šè¿‡ä½¿ç”¨ **DDNS (åŠ¨æ€åŸŸåè§£ææœåŠ¡) **, æˆ‘ä»¬å°†åŠ¨æ€å…¬ç½‘ IP ä¸ä¸€ä¸ªæ³›åŸŸå (ä¾‹å¦‚ `*.dong4j.tele`) ç»‘å®š. è¿™æ ·ä¸€æ¥:

1. **æ‰€æœ‰ä¸‰çº§åŸŸåå…±äº«åŒä¸€ IP åœ°å€**:

   - æ³›åŸŸåçš„é…ç½®æ„å‘³ç€ `nas.dong4j.tele`ã€`blog.dong4j.tele`ã€`api.dong4j.tele` ç­‰ä¸‰çº§åŸŸåéƒ½ä¼šæŒ‡å‘åŒä¸€ä¸ªåŠ¨æ€å…¬ç½‘ IP.
   - æ— éœ€ä¸ºæ¯ä¸ªå­æœåŠ¡å•ç‹¬åˆ›å»ºåŸŸåè§£æè®°å½•.

2. **å‡å°‘ç®¡ç†å·¥ä½œ**:

   - å½“å…¬ç½‘ IP å˜åŒ–æ—¶, DDNS ä¼šè‡ªåŠ¨æ›´æ–°ä¸è¯¥ IP å…³è”çš„åŸŸåè§£æ.
   - æ— éœ€æ‰‹åŠ¨æ›´æ–°æ¯ä¸ªå­åŸŸåçš„è®°å½•, æé«˜äº†æ•ˆç‡å’Œç»´æŠ¤ä¾¿åˆ©æ€§.

3. **ä¾¿äºæ‰©å±•å’ŒæœåŠ¡ç®¡ç†**:
   - ä¸åŒçš„ä¸‰çº§åŸŸåå¯ä»¥è¢«è·¯ç”±åˆ°ä¸åŒçš„å†…éƒ¨æœåŠ¡æˆ–è®¾å¤‡ (å¦‚ Webã€FTPã€SSH ç­‰) .
   - å®ç°çµæ´»çš„æœåŠ¡éƒ¨ç½², è€Œä¸å¢åŠ åŸŸåç®¡ç†çš„å¤æ‚æ€§.

#### ç¤ºä¾‹

å‡è®¾å…¬ç½‘ IP åŠ¨æ€å˜åŒ–ä¸”é€šè¿‡ DDNS ç»‘å®šåˆ°äº†æ³›åŸŸå `*.dong4j.tele`, ä»¥ä¸‹è¯·æ±‚éƒ½èƒ½è¢«æ­£ç¡®è·¯ç”±:

- `nas.dong4j.tele` â†’ DS218+ WebUI
- `blog.dong4j.tele` â†’ åšå®¢
- `api.dong4j.tele` â†’ æ¥å£æœåŠ¡

é€šè¿‡è¿™ç§é…ç½®, å¤§å¤§ç®€åŒ–äº†åŸŸåç®¡ç†æµç¨‹, åŒæ—¶é€‚é…åŠ¨æ€ IP ç¯å¢ƒ.

### ç«¯å£æ˜ å°„

å‰é¢æˆ‘ä»¬å·²ç»å°†å…¬ç½‘ IP æˆåŠŸç»‘å®šåˆ°äº†æŒ‡å®šåŸŸåä¸Š, æ¯”å¦‚æˆ‘éœ€è¦è®¿é—® DS218+ çš„ WebUI, åªéœ€è¦åœ¨è·¯ç”±å™¨ä¸Šå¼€æ”¾æŒ‡å®šçš„ç«¯å£å¹¶æ˜ å°„åˆ°æ­£ç¡®çš„ IP ä¸Š:

![20241229154732_yTkBViDh.webp](https://cdn.dong4j.site/source/image/20241229154732_yTkBViDh.webp)

**æœ€å¥½ä¿®æ”¹å¤–éƒ¨ç«¯å£å·, ä¸è¦ä¸å†…éƒ¨ç«¯å£å·ä¸€æ ·**

è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ `http://nas.dong4j.tele:5000` è®¿é—®å†…éƒ¨çš„ `http://192.168.31.3:5000`.

ç„¶è€Œéšç€éœ€è¦æš´éœ²çš„æœåŠ¡è¶Šæ¥è¶Šå¤š, é€šè¿‡è·¯ç”±å™¨è¿›è¡Œç«¯å£è½¬å‘ç®¡ç†ä¼šå˜å¾—ç¹ç, å°¤å…¶æ˜¯æ¯ä¸ªæœåŠ¡éœ€è¦ç‹¬å ä¸€ä¸ªç«¯å£. ä¾‹å¦‚:

- æœåŠ¡ A â†’ 8081 ç«¯å£
- æœåŠ¡ B â†’ 8082 ç«¯å£
- æœåŠ¡ C â†’ 8083 ç«¯å£

è¿™ç§æ–¹å¼ä¸ä»…éš¾ä»¥è®°å¿†, è¿˜ä¼šé€ æˆç«¯å£å†²çª, å¹¶ä¸”æåº¦æµªè´¹ç«¯å£èµ„æº.

å¦‚æœç†Ÿæ‚‰ Nginx åå‘ä»£ç†çš„è¯, é™¤äº†é€šè¿‡ç«¯å£åŒºåˆ†æœåŠ¡, è¿˜èƒ½é€šè¿‡åŸŸååŒºåˆ†:

- `nas.dong4j.tele:5000` â†’ æœåŠ¡ A
- `blog.dong4j.tele:5000` â†’ æœåŠ¡ B
- `api.dong4j.tele:5000` â†’ æœåŠ¡ C

è¿™æ ·æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªç«¯å£å³å¯ä»£ç†å¤šä¸ªæœåŠ¡.

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ Nginx é…ç½®, ç”¨äºå°†ä¸åŒçš„åŸŸåè·¯ç”±åˆ°ä¸åŒçš„å†…éƒ¨æœåŠ¡:

```nginx
server {
  listen 5000;
  server_name nas.dong4j.tele;
  location / {
		proxy_pass http://192.168.31.3:5000; # æ˜ å°„åˆ°æœåŠ¡ A
  }
}
server {
  listen 5000;
  server_name blog.dong4j.tele;
  location / {
		proxy_pass http://192.168.31.4:8080; # æ˜ å°„åˆ°æœåŠ¡ B
  }
}
server {
  listen 5000;
  server_name api.dong4j.tele;
  location / {
		proxy_pass http://192.168.31.5:1234; # æ˜ å°„åˆ°æœåŠ¡ C
  }
}
```

### Nginx Proxy Manager

è™½ç„¶ Nginx çš„é…ç½®æ–‡ä»¶è®¾è®¡å¾—éå¸¸ç®€æ´, å¹¶æ”¯æŒçƒ­åŠ è½½ (é€šè¿‡ `nginx -s reload`) , æ— éœ€å®Œå…¨é‡å¯æœåŠ¡, ä½†æ˜¯åœ¨å‘½ä»¤è¡Œä¸‹æ“ä½œç¡®å®æœ‰ç‚¹ä¸æ–¹ä¾¿.

å¯è§†åŒ–æ“ä½œ Nginx é…ç½®ç›®å‰æˆç†Ÿçš„æ–¹æ¡ˆéå¸¸å¤š, æ¯”å¦‚:

- [nginx-proxy-manager]()
- [nginxWebU](https://www.nginxwebui.cn/)
- [NGINX Config](https://do.co/nginxconfig)
- [Nginx Proxy Manager](https://nginxproxymanager.com/)
- 1Panel ä¸­çš„ OpenResty
- å®å¡”é¢æ¿ä¸­çš„ Nginx

è¿™ç±»æœåŠ¡é€‰æ‹©ä¸€ä¸ªé¡ºæ‰‹çš„å°±è¡Œ, ç›®å‰æˆ‘ä½¿ç”¨çš„æ˜¯ [Nginx Proxy Manager](https://nginxproxymanager.com/):

![20241229154732_URyCJuXy.webp](https://cdn.dong4j.site/source/image/20241229154732_URyCJuXy.webp)

**ä¸ºäº†å®‰å…¨èµ·è§, å·²å°†æ‰€æœ‰æœåŠ¡è¿ç§»åˆ° é›·æ±  Safeline**.

#### åå‘ä»£ç†

![20241229154732_D1jHvCKb.webp](https://cdn.dong4j.site/source/image/20241229154732_D1jHvCKb.webp)

åå‘ä»£ç†é…ç½®éå¸¸ç®€å•, åªéœ€è¦é…ç½®:

- åŸŸå
- åè®®: å†…ç½‘ä¸€èˆ¬é€‰æ‹© http, å¤–éƒ¨è®¿é—®å¦‚æœéœ€è¦ HTTPS, åˆ™éœ€è¦åœ¨ SSL é€‰é¡¹å¡ä¸­é…ç½® HTTPS è¯ä¹¦, è¿™ä¸ªåé¢è¯¦ç»†ä»‹ç»;
- è½¬å‘ä¸»æœº: å†…éƒ¨æœåŠ¡æ‰€åœ¨çš„æœåŠ¡å™¨ IP
- è½¬å‘ç«¯å£: æœåŠ¡ç«¯å£

æˆ‘ä»¬ä»¥å¤–ç½‘é€šè¿‡ HTTP è®¿é—® NAS (`192.168.31.3`) ä¸ºä¾‹, å‡è®¾ Nginx Proxy Manager (åé¢ç®€ç§° `NPM` )ç›‘å¬çš„ HTTP ç«¯å£ä¸º `6080`, IP ä¸º `192.168.31.10` , é‚£ä¹ˆé…ç½®æ­¥éª¤å¦‚ä¸‹:

- åœ¨è·¯ç”±å™¨ä¸Šé…ç½®ç«¯å£è½¬å‘: `1020` ç«¯å£æŒ‡å‘ `192.168.168.31.10` çš„ 6080 ç«¯å£;

- åœ¨ `NPM` æ·»åŠ ä»£ç†æœåŠ¡é…ç½®:

  ![20241229154732_xBkppcxh.webp](https://cdn.dong4j.site/source/image/20241229154732_xBkppcxh.webp)

è®¿é—® `nas.dong4j.tele:1020` å³å¯è®¿é—® NAS çš„ WebUI æœåŠ¡.

![NPM-HTTP.drawio.svg](https://cdn.dong4j.site/source/image/NPM-HTTP.drawio.svg)

æ•´ä½“çš„æµç¨‹ä¸º:

1. ddns-go é€šè¿‡å®šæ—¶è°ƒç”¨ API å°†è·å–åˆ°çš„æœ€æ–°å…¬ç½‘ IP æ¨é€ç»™åŸŸåæœåŠ¡å•†;
2. åœ¨è·¯ç”±å™¨å°†ç‰¹å®šç«¯å£ç»‘å®šåˆ° NPM çš„ HTTP ç«¯å£, æ¯”å¦‚ 1020 -> 6080;
3. åœ¨ NPM è¿›è¡Œä»£ç†æœåŠ¡é…ç½®, å°†åŸŸåæ˜ å°„åˆ°æŒ‡å®šæœåŠ¡;

è¿™æ ·æˆ‘ä»¬å°±èƒ½é€šè¿‡ **æŸä¸ªå›ºå®šçš„ç«¯å£ç»“åˆä¸åŒçš„åŸŸåè®¿é—®ä¸åŒçš„æœåŠ¡**, NPM ä¹Ÿæä¾› [REST API](https://github.com/NginxProxyManager/nginx-proxy-manager/blob/develop/backend/schema/swagger.json), ä½ å¯ä»¥ç©ä¸€äº›æ¯”è¾ƒèŠ±çš„æ“ä½œ, æ¯”å¦‚é€šè¿‡è„šæœ¬éšæ—¶å…³é—­/å¼€å¯æŸä¸ªä»£ç†æœåŠ¡.

#### HTTPS è¯ä¹¦ç”³è¯·

NPM è¿˜æä¾› `Let's Encrypt` è¯ä¹¦ç”³è¯·æœåŠ¡, å¯ç”³è¯· 3 ä¸ªæœˆçš„å…è´¹è¯ä¹¦å¹¶èƒ½å¤Ÿè‡ªåŠ¨ç»­æœŸ.

éœ€è¦éªŒè¯ä½ å¯¹è¯ä¹¦ä¸­åŸŸåçš„æ§åˆ¶æƒ, ä¹Ÿå°±æ˜¯è¯´ä½ è¦èƒ½è¯æ˜, è¿™ä¸ªåŸŸåæ˜¯å±äºä½ çš„. æœ‰ä¸¤ç§éªŒè¯æ–¹å¼: ä¸€ç§æ˜¯åŸºäº `HTTP` çš„éªŒè¯æ–¹å¼, å¦ä¸€ç§æ˜¯åŸºäº `DNS` çš„éªŒè¯æ–¹å¼.

å…³äºè¿™æ–¹é¢çš„æ•™ç¨‹éå¸¸å¤š, æ‰€ä»¥è¿™é‡Œå°±ä¸åœ¨èµ˜è¿°äº†, åªè¯´è¯´æˆ‘é‡åˆ°çš„é—®é¢˜:

1. `ModuleNotFoundError: No module named 'zope' #2440`

   [è¿™é‡Œæ˜¯ Issues](https://github.com/NginxProxyManager/nginx-proxy-manager/issues/2440)

   è§£å†³æ–¹æ³•:

   ```shell
   # è¿›å…¥ docker å®¹å™¨
   docker exec -it /bin/bash xxxx
   pip install certbot-dns-dnspod
   pip install zope -i https://pypi.tuna.tsinghua.edu.cn/simple
   ```

2. `Another instance of Certbot is already running`

   ```shell
   find / -type f -name '.certbot.lock' -exec rm {} \;
   ```

åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­, ç¬¬ä¸€æ¬¡ç”³è¯·è¯ä¹¦ä¼šæ¶ˆè€—å¤§é‡æ—¶é—´, å‡ºç°å¤šæ¬¡ç”³è¯·å¤±è´¥çš„æƒ…å†µ, ä¸”è‡ªåŠ¨ç»­æœŸç»å¸¸ä¼šå¤±è´¥, å†å°è¯•äº†é€šè¿‡ `1Panel` çš„è¯ä¹¦ç®¡ç†åŠŸèƒ½å, æœæ–­å¼ƒç”¨äº† NPM çš„ HTTPS è¯ä¹¦ç®¡ç†åŠŸèƒ½, è¿™ä¸ªåœ¨ [ç½‘ç»œå®‰å…¨-HTTPS è¯ä¹¦](#HTTPS è¯ä¹¦) ä¸€èŠ‚ä¸­è¯¦ç»†è¯´æ˜.

**å€¼å¾—æ³¨æ„çš„æ˜¯, å¦‚æœå¯ç”¨äº† HTTPS, åœ¨è·¯ç”±å™¨çš„ç«¯å£è½¬å‘é…ç½®æ—¶, éœ€è¦å°†å¤–éƒ¨ç«¯å£æ˜ å°„åˆ° NPM çš„ HTTPS ç«¯å£.**

#### å¼€å¯ HTTPS è®¿é—®

HTTPS è¯ä¹¦ç”³è¯·åç»™åŸŸåæ·»åŠ  HTTPS, éœ€è¦æ³¨æ„ä½ çš„ NPM çš„ HTTPS ç«¯å£å·, æ¯”å¦‚æ˜¯ `30443`, é‚£ä¹ˆåœ¨è·¯ç”±å™¨é…ç½®ç«¯å£è½¬å‘æ—¶å°±è¦ä½¿ç”¨æ­¤ç«¯å£å·.

![NPM-HTTPS.drawio.svg](https://cdn.dong4j.site/source/image/NPM-HTTPS.drawio.svg)

#### è‡ªå®šä¹‰ä½ç½®

è‡ªå®šä¹‰ä½ç½®æ˜¯åœ¨ç‰¹æ®Šåœºæ™¯ä¸‹æä¾›çš„ä¸€ç§å®šåˆ¶åŒ–é…ç½®, æ¯”å¦‚æˆ‘çš„ `bark` æœåŠ¡, å®ƒçš„å®Œæ•´è·¯å¾„æ˜¯è¿™æ ·çš„:

```
http://192.168.31.20:8088/iphone-uuid/
http://192.168.31.20:8088/mbp-uuid/
# xxx-uuid é€šå¸¸ä¸º 22 ä½éšæœºå­—ç¬¦ä¸²
```

è¿™ä¸ª URL ä¼šä½œä¸º Webhook åœ¨å¤šä¸ªåœ°æ–¹ä½¿ç”¨, ä¸”ä¼šæœ‰å¤šä¸ªå®¢æˆ·ç«¯çš„ uuid, æ¯”å¦‚ä¸Šé¢çš„ `iphone-uuid` å°±æ˜¯å°†æ¶ˆæ¯é€šçŸ¥åˆ°æ‰‹æœº, è€Œ `mbp-uuid` åˆ™æ˜¯é€šçŸ¥åˆ° MBP, ä¸ºäº†æ–¹ä¾¿è®°å¿†, ä¸”åœ¨ `bark` é‡ç½® uuid åä¸éœ€è¦é‡æ–°ä¿®æ”¹è®¾å¤‡ä¸Šçš„ Webhook åœ°å€, å¯ä»¥è¿™æ ·è®¾ç½®:

![20241229154732_Bt3WnONz.webp](https://cdn.dong4j.site/source/image/20241229154732_Bt3WnONz.webp)

Webhook åœ°å€åˆ™å˜æ›´ä¸º:

```
http://bark.dong4j.tele:1020/iphone/
http://bark.dong4j.tele:1020/mbp/
```

[è¿™é‡Œæœ‰ä¸€ä¸ªé€šè¿‡ NPM æ­å»ºè·å–å…¬ç½‘ IP æœåŠ¡çš„è¯´æ˜](obtain_public_ip_address_using_nginx.md)

#### é«˜çº§é…ç½®

å¦‚æœ WebUI ä¸Šæ— æ³•é€šè¿‡å¯è§†åŒ–é…ç½®æ»¡è¶³ä½ çš„éœ€æ±‚, ä½ å¯ä»¥è¿›å…¥ NPM æŒ‚è½½çš„ç›®å½•ç›´æ¥ä¿®æ”¹é…ç½®:

å¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ–¹å¼æ·»åŠ è‡ªå®šä¹‰é…ç½®ç‰‡æ®µæ–‡ä»¶`/data/nginx/custom`:

- `/data/nginx/custom/root_top.conf`: åŒ…å«åœ¨ nginx.conf çš„é¡¶éƒ¨
- `/data/nginx/custom/root.conf`: åŒ…å«åœ¨ nginx.conf çš„æœ€æœ«å°¾
- `/data/nginx/custom/http_top.conf`: åŒ…å«åœ¨ä¸» http å—çš„é¡¶éƒ¨
- `/data/nginx/custom/http.conf`: åŒ…å«åœ¨ä¸» http å—çš„æœ«å°¾
- `/data/nginx/custom/events.conf`: åŒ…å«åœ¨äº‹ä»¶å—çš„æœ«å°¾
- `/data/nginx/custom/stream.conf`: åŒ…å«åœ¨ä¸»æµå—çš„æœ«å°¾
- `/data/nginx/custom/server_proxy.conf`: åŒ…å«åœ¨æ¯ä¸ªä»£ç†æœåŠ¡å™¨å—çš„æœ«å°¾
- `/data/nginx/custom/server_redirect.conf`: åŒ…å«åœ¨æ¯ä¸ªé‡å®šå‘æœåŠ¡å™¨å—çš„æœ«å°¾
- `/data/nginx/custom/server_stream.conf`: åŒ…å«åœ¨æ¯ä¸ªæµæœåŠ¡å™¨å—çš„æœ«å°¾
- `/data/nginx/custom/server_stream_tcp.conf`: åŒ…å«åœ¨æ¯ä¸ª TCP æµæœåŠ¡å™¨å—çš„æœ«å°¾
- `/data/nginx/custom/server_stream_udp.conf`: åŒ…å«åœ¨æ¯ä¸ª UDP æµæœåŠ¡å™¨å—çš„æœ«å°¾

æ›´å¤šçš„é…ç½®è¯´æ˜å¯è‡ªè¡ŒæŸ¥çœ‹ [NPM å®˜æ–¹æ–‡æ¡£](https://nginxproxymanager.com/advanced-config/)

#### ä»£ç†å±€åŸŸç½‘è‡ªå®šä¹‰åŸŸå

##### Surge + NPM

åé¢ä¼šè®²åˆ° [ä½¿ç”¨ é›·æ±  Safeline ä»£æ›¿ NPM](#ç”¨ WAF æ›¿æ¢ NPM), æ‰€æœ‰ä»£ç†æœåŠ¡éƒ½ä¼šè¿ç§»è¿‡å», æ‰€ä»¥ NPM å°±æ²¦ä¸ºäº†å±€åŸŸç½‘è‡ªå®šä¹‰åŸŸåçš„ä»£ç†å·¥å…·, æ¥ä¸‹æ¥ **è®¾å¤‡åŸŸåæ˜ å°„ä¸€èŠ‚** ä¸­å…³äºå¦‚ä½•ä½¿ç”¨ [NPM + Surge æ¥ç®€åŒ–åŸŸåè®¿é—®çš„è¯¦ç»†é…ç½®](#é€šè¿‡è‡ªå®šä¹‰åŸŸåå‡å°‘éœ€è¦è®°å¿†çš„ IP æ•°é‡).

æµç¨‹å¤§è‡´å¦‚ä¸‹:

![NPM_Surge_proxy.drawio.svg](https://cdn.dong4j.site/source/image/NPM_Surge_proxy.drawio.svg)

1. Surge é…ç½®è‡ªå®šä¹‰åŸŸå:

   ```txt
   # æ‰€æœ‰çš„ *.npm å…¨éƒ¨è§£ææˆ 192.168.31.10
   *.npm = 192.168.31.10
   ```

2. é…ç½® NPM:

   ![20241229154732_oWNfAFQJ.webp](https://cdn.dong4j.site/source/image/20241229154732_oWNfAFQJ.webp)

æ„æ€æ˜¯æ¥è‡ª `nas.npm` çš„è¯·æ±‚ä¼šè¢«ä»£ç†åˆ° `http://192.168.31.3:5000` ä¸Š, å³ DS218+ çš„ WebUI æœåŠ¡.

**æ€»ç»“ä¸‹æ¥**:

1. Surge å°† `*.npm` å…¨éƒ¨è§£ææˆ `192.168.31.10`;
2. å½“è¯·æ±‚ `xx.npm` æ—¶è¢«å‘é€åˆ° NPM çš„ `80` ç«¯å£;
3. NPM æ ¹æ® **åŸŸå** åˆ¤æ–­åº”è¯¥ä»£ç†è¯·æ±‚åˆ°å“ªä¸ªæœåŠ¡;

ä¸ºäº†ç®€åŒ–, æˆ‘ä»¬ä½¿ç”¨ NPM çš„ `80` ç«¯å£, æ‰€ä»¥éœ€è¦æ³¨æ„çš„ NPM çš„ç«¯å£é…ç½®:

```yml
services:
  app:
    image: 'chishin/nginx-proxy-manager-zh:latest'
    ports:
      - '80:80'				# HTTP ä»£ç†ç«¯å£
      - '12443:443' 	# HTTPS ä»£ç†ç«¯å£
      - '1281:81' 		# WebUI ç®¡ç†ç«¯å£
		...
```

æ¥ä¸‹æ¥å°±æ˜¯åœ¨ NPM ä¸Šé‡å¤æ·»åŠ ä»£ç†é…ç½®äº†:

![20241229154732_Vc56ORPo.webp](https://cdn.dong4j.site/source/image/20241229154732_Vc56ORPo.webp)

**æˆ‘çš„è‡ªå®šä¹‰åŸŸåè§„åˆ™**:

- `.npm` ä½œä¸ºé¡¶çº§åŸŸå;
- `{æœåŠ¡å™¨}.npm` ä½œä¸ºäºŒçº§åŸŸå, æ¯”å¦‚: `nas.npm`;
- `{æœåŠ¡å}.{æœåŠ¡å™¨}.npm` ä½œä¸ºä¸‰çº§åŸŸå, æ¯”å¦‚: `ddns.nas.npm`

**å€¼å¾—æ³¨æ„çš„æ˜¯, å› ä¸º .npm ä¸æ˜¯æœ‰æ•ˆçš„ TLD**, å› æ­¤åœ¨ Chrome ç¬¬ä¸€æ¬¡ä½¿ç”¨çš„æ—¶å€™, éœ€è¦è¾“å…¥å®Œæ•´çš„ URL: `http://nas.npm`, å¦åˆ™ä¼šè¢«å½“æˆæœç´¢è¯·æ±‚, æˆåŠŸæ‰“å¼€ä¸€æ¬¡åå³å¯, åé¢å°±ä¸éœ€è¦å®Œæ•´è¾“å…¥ URL äº†.

å½“ç„¶ä½ ä¹Ÿå¯ä»¥å°† `.npm` æ”¹æˆå…¶ä»–çš„æ¯”å¦‚: `.local`.

**è¡¥å……è¯´æ˜**:

å› ä¸º **NPM** åªèƒ½ä»£ç† **HTTP** åè®®, å¦‚æœ **TCP/UDP** åè®®ä¹Ÿæƒ³ä½¿ç”¨åŸŸå, ä½ å¯ä»¥åœ¨ Surge æ·»åŠ ä¸€æ¡é…ç½®, æ¯”å¦‚ DS218+ çš„ IP æ˜¯ `192.168.31.3`, æˆ‘æƒ³ä½¿ç”¨ `ssh.nas.npm` è¿æ¥ SSH:

```
ssh.nas.npm = 192.168.31.3
*.npm = 192.168.31.10
```

ä½¿ç”¨æ–¹å¼:

```shell
ssh root@ssh.nas.npm
```

##### Surge + SmartDNS + NPM

å…¶å®è¿˜å¯ä»¥ç»“åˆ SmartDNS æ¥è¾¾æˆåŒæ ·çš„ç›®çš„, ä½†æ˜¯è¿™ç§æ–¹å¼æ¯” **Surge + NPM** å¤šäº†ä¸€å±‚, è¿™æ˜¯æ²¡æœ‰é‡‡ç”¨çš„ **åŸå› ä¹‹ä¸€**.

**Surge** åªæ˜¯ç”¨æ¥è·å–æŒ‡å®šåŸŸåçš„ DNS åœ°å€, **SmartDNS** ç”¨äº DNS è§£æ, NPM çš„ä½œç”¨ä¸å˜.

**å…·ä½“é…ç½®ä¸º**:

1. Surge Hosts é…ç½®ä¿®æ”¹ä¸º:

   ```shell
   *.npm = server:192.168.31.10
   ```

è¡¨ç¤º `*.npm` åŸŸåä½¿ç”¨éƒ¨ç½²åœ¨ `192.168.31.10` ä¸Šçš„ **SmartDNS** æä¾›çš„ DNS æœåŠ¡æ¥è·å–è§£æ.

2. **SmartDNS** é…ç½®å¦‚ä¸‹(å®˜æ–¹æ–‡æ¡£è¯´æ˜¯æ”¯æŒ `*.npm` è¿™ç§é€šé…ç¬¦è§£æçš„, ä½†æ˜¯æœ¬åœ°æµ‹è¯•å¹¶æ²¡æœ‰æˆåŠŸ, è¿™æ˜¯æ²¡æœ‰ä½¿ç”¨çš„ **åŸå› ä¹‹äºŒ** ):

   ```shell
   address /nas.npm/192.168.31.10
   address /tnas.npm/192.168.31.10
   ....
   # å…¶ä»–åŸŸåé…ç½®, åŒæ ·æ˜¯æŒ‡å‘ 192.168.31.10
   ```

**SmartDNS** çš„æ„ä¹‰åœ¨äºä½œä¸ºä¸€ä¸ª DNS æœåŠ¡ä¸ºå±€åŸŸç½‘è®¾å¤‡æä¾›è§£ææœåŠ¡, é—®é¢˜æ˜¯éœ€è¦åœ¨å¤šå°æœåŠ¡å™¨ä¸Šè¿›è¡Œ DNS åœ°å€é…ç½®, æˆ‘çš„ç›®çš„åªæ˜¯åœ¨ä¸»è¦è®¾å¤‡ä¸Šå®ç°åŸŸåè®¿é—®, Surge æ˜¾ç„¶æ›´é€‚åˆ, æ‰€ä»¥è¿™ä¹Ÿæ˜¯æ²¡æœ‰ä½¿ç”¨çš„ **åŸå› ä¹‹ä¸‰**.

### IPv6

#### ä¸­å›½çš„ IPv6 å‘å±•æƒ…å†µ

æˆªè‡³ 2024 å¹´, ä¸­å›½åœ¨ IPv6 çš„å‘å±•æ–¹é¢å–å¾—äº†æ˜¾è‘—è¿›å±•. ä»¥ä¸‹æ˜¯æ ¹æ®ã€Šä¸­å›½ IPv6 å‘å±•çŠ¶å†µç™½çš®ä¹¦ (2024) ã€‹å’Œç›¸å…³æŠ¥é“æ€»ç»“çš„å‡ ä¸ªå…³é”®ç‚¹:

1. **IPv6 ç”¨æˆ·æ•°é‡**: æˆªè‡³ 2024 å¹´ 5 æœˆ, ä¸­å›½çš„ IPv6 æ´»è·ƒç”¨æˆ·æ•°è¾¾åˆ° 7.94 äº¿, å å…¨ä½“ç½‘æ°‘æ€»æ•°çš„ 72.7%. è¿™ä¸ªæ¯”ä¾‹ä» 2017 å¹´åˆçš„ 0.51% æ˜¾è‘—æé«˜. å·²åˆ†é… IPv6 åœ°å€çš„ç»ˆç«¯æ•°è¾¾åˆ° 17.65 äº¿, å…¶ä¸­ç§»åŠ¨ç½‘ç»œç»ˆç«¯ä¸º 13.50 äº¿, å›ºå®šå®½å¸¦æ¥å…¥ç½‘ç»œç»ˆç«¯ä¸º 4.15 äº¿.
2. **å‘å±•é˜¶æ®µ**: ä¸­å›½ IPv6 çš„å‘å±•ç»å†äº†èµ·æ­¥æœŸ (2017 å¹´è‡³ 2018 å¹´ä¸­) ã€çˆ¬å‡æœŸ (2018 å¹´ä¸­è‡³ 2023 å¹´ä¸€å­£åº¦) å’Œç¨³å®šæœŸ (2023 å¹´ä¸€å­£åº¦è‡³ä»Š) ä¸‰ä¸ªé˜¶æ®µ.
3. **ç½‘ç»œæµé‡**: ç§»åŠ¨ç½‘ç»œ IPv6 æµé‡å æ¯”è¾¾åˆ° 64.56%, å›ºå®šç½‘ç»œ IPv6 æµé‡å æ¯”ä¸º 21.21%. åŸåŸŸç½‘ IPv6 æ€»æµé‡å å…¨ç½‘æ€»æµé‡çš„ 21.21%.
4. **ç½‘ç»œæ€§èƒ½**: IPv6 ç½‘ç»œæ€§èƒ½å¾—åˆ°æ˜¾è‘—æå‡, å…¶æ—¶å»¶é™ä½, ä¸¢åŒ…ç‡å‡å°‘, æ˜¾ç¤ºå‡ºåœ¨ç½‘ç»œæ€§èƒ½å’Œç¨³å®šæ€§æ–¹é¢çš„æ½œåŠ›.
5. **åŸºç¡€èµ„æº**: ä¸­å›½åœ¨ IPv6 åœ°å€ç”³è¯·é‡å’Œæ‹¥æœ‰é‡æ–¹é¢å‡ä½å±…ä¸–ç•Œç¬¬äºŒ, IPv6 AS (è‡ªæ²»ç³»ç»Ÿ) æ•°é‡å æ¯”è¾¾åˆ° 70.43%.
6. **æ”¿ç­–æ”¯æŒ**: ä¸­å›½æ”¿åºœé«˜åº¦é‡è§† IPv6 çš„éƒ¨ç½²å’Œåº”ç”¨, è‡ª 2017 å¹´ã€Šæ¨è¿›äº’è”ç½‘åè®®ç¬¬å…­ç‰ˆ (IPv6) è§„æ¨¡éƒ¨ç½²è¡ŒåŠ¨è®¡åˆ’ã€‹å‘å¸ƒä»¥æ¥, å·²å‡ºå°å¤šé¡¹æ”¿ç­–, æ˜ç¡® IPv6 å‘å±•ç›®æ ‡å’Œæ—¶é—´è¡¨.

#### å…¨çƒ IPv6 å‘å±•æƒ…å†µ

å…¨çƒèŒƒå›´å†…, IPv6 çš„éƒ¨ç½²å’Œåº”ç”¨ä¹Ÿåœ¨åŠ é€Ÿæ¨è¿›. ä»¥ä¸‹æ˜¯æ ¹æ®ã€Š2024 å…¨çƒ IPv6 å‘å±•æŒ‡æ•°æŠ¥å‘Šã€‹æ€»ç»“çš„å‡ ä¸ªå…³é”®ç‚¹:

1. **å…¨çƒè¦†ç›–ç‡**: 2023 å¹´, å…¨çƒ IPv6 ç½‘ç»œéƒ¨ç½²æ˜¾è‘—æé€Ÿ, æ€»ä½“è¦†ç›–ç‡é¦–æ¬¡çªç ´ 30%. éƒ¨åˆ†é¢†å…ˆå›½å®¶çš„ IPv6 è¦†ç›–ç‡å·²ç»è¾¾åˆ°æˆ–æ¥è¿‘ 70%, å…¶ IPv6 ç§»åŠ¨æµé‡å æ¯”ä¹Ÿå·²è¶…è¿‡ IPv4.
2. **æŠ€æœ¯å‘å±•**: éšç€ IPv6 ç½‘ç»œçš„åŸºæœ¬å»ºæˆ, é¢†å…ˆå›½å®¶çš„ IPv6 è§„æ¨¡éƒ¨ç½²åŠåº”ç”¨å¼€å§‹è¿›å…¥æ–°çš„é˜¶æ®µ, æ”¿ç­–èšç„¦é€æ¸ä»ç½‘ç»œæ‰©å¼ è½¬å‘ IPv6 Enhanced æŠ€æœ¯çš„äº§å“åŒ–è½åœ°å’Œè§„æ¨¡åŒ–åº”ç”¨.
3. **æ•°å­—ç»æµ**: IPv6 ä½œä¸ºæ•°å­—åŸºå»ºçš„åº•åº§, æ˜¯äº’è”ç½‘å‡çº§å’Œç½‘ç»œæŠ€æœ¯åˆ›æ–°çš„é‡è¦åŸºçŸ³. IPv6 åˆ›æ–°æŠ€æœ¯åº”ç”¨èåˆè¡Œä¸šåº”ç”¨åœºæ™¯åŠ é€Ÿè½åœ°, ä¸ºå„è¡Œä¸šçš„æ•°å­—åŒ–ã€æ™ºèƒ½åŒ–è½¬å‹æä¾›äº†å…³é”®æ”¯æŒ.

IPv6 éƒ½åœ¨è¿…é€Ÿå‘å±•, å·²æˆä¸ºæˆä¸ºæ”¯æ’‘ç°ä»£äº’è”ç½‘å’Œæ•°å­—ç»æµå‘å±•çš„å…³é”®æŠ€æœ¯.

IPv6 å¯¹äºä¸ªäººç”¨æˆ·çš„ä¸€ä¸ªå·¨å¤§ä¼˜åŠ¿åœ¨äº, å³ä½¿å®½å¸¦è¿è¥å•†ä¸æä¾› IPv4 å…¬ç½‘ IP, ä¹Ÿå¯ä»¥é€šè¿‡ IPv6 ç›´æ¥è®¿é—®å®¶ä¸­çš„è®¾å¤‡.

**IPv6 çš„ä¼˜åŠ¿**:

1. **æ—  NAT é™åˆ¶**
   åœ¨ IPv4 ç½‘ç»œä¸­, è¿è¥å•†é€šå¸¸ä½¿ç”¨ NAT (ç½‘ç»œåœ°å€è½¬æ¢) æ¥å°†å¤šä¸ªç”¨æˆ·å…±äº«ä¸€ä¸ªå…¬ç½‘ IP, è¿™é™åˆ¶äº†ç”¨æˆ·é€šè¿‡å…¬ç½‘è®¿é—®å®¶ä¸­è®¾å¤‡çš„èƒ½åŠ›. è€Œ IPv6 æä¾›äº†å‡ ä¹æ— é™çš„åœ°å€ç©ºé—´, æ¯ä¸ªè®¾å¤‡éƒ½å¯ä»¥æ‹¥æœ‰ç‹¬ç«‹çš„å…¬ç½‘ IPv6 åœ°å€.

2. **ç«¯åˆ°ç«¯é€šä¿¡**
   IPv6 æ”¯æŒçœŸæ­£çš„ç«¯åˆ°ç«¯é€šä¿¡, æ¶ˆé™¤äº† NAT å¸¦æ¥çš„å¤æ‚æ€§. è¿™ä½¿å¾—ç”¨æˆ·å¯ä»¥ç›´æ¥é€šè¿‡ IPv6 åœ°å€è¿œç¨‹è®¿é—®å®¶ä¸­çš„è·¯ç”±å™¨ã€NASã€æ‘„åƒå¤´ç­‰è®¾å¤‡, æ— éœ€ä¾èµ– DDNS æˆ–å¤æ‚çš„ç«¯å£æ˜ å°„.

3. **æ›´é«˜çš„å®‰å…¨æ€§**

   IPv6 å†…ç½®äº† IPsec æ”¯æŒ, å¯ä»¥å®ç°æ›´å®‰å…¨çš„é€šä¿¡. åŒæ—¶, IPv6 çš„åˆ†å¸ƒå¼åœ°å€åˆ†é…æ–¹å¼, å‡å°‘äº†æ”»å‡»è€…æ‰«æè®¾å¤‡çš„å¯èƒ½æ€§.

4. **ä¸ 5G å’Œç‰©è”ç½‘ç»“åˆ**

   éšç€ 5G å’Œæ™ºèƒ½å®¶å±…çš„å‘å±•, æ›´å¤šè®¾å¤‡å¼€å§‹æ”¯æŒ IPv6, è¿™å°†è¿›ä¸€æ­¥ç®€åŒ–è”ç½‘è®¾å¤‡çš„é…ç½®å’Œç®¡ç†.

#### å®ç°æ–¹å¼

1. **ç¡®è®¤è¿è¥å•†æ”¯æŒ IPv6**

   ç¡®ä¿å®½å¸¦æä¾›å•†å·²ç»å¼€é€š IPv6 æœåŠ¡. å½“å‰ä¸­å›½ä¸»è¦çš„è¿è¥å•† (å¦‚ä¸­å›½ç”µä¿¡ã€ä¸­å›½è”é€šã€ä¸­å›½ç§»åŠ¨) æ­£åœ¨å¤§åŠ›æ¨è¿› IPv6 éƒ¨ç½².

2. **é…ç½®è·¯ç”±å™¨**

   ç¡®ä¿å®¶åº­è·¯ç”±å™¨æ”¯æŒå¹¶å¯ç”¨äº† IPv6, å¼€å¯åå°†ä¸ºå®¶ä¸­è®¾å¤‡åˆ†é…å…¬ç½‘ IPv6 åœ°å€.

3. **è¿œç¨‹è®¿é—®è®¾å¤‡**

   é€šè¿‡ IPv6 åœ°å€ç›´æ¥è®¿é—®è®¾å¤‡, ä¾‹å¦‚: `http://[your-ipv6-address]:port`. ä¹Ÿå¯ä»¥ä½¿ç”¨ DDNS æœåŠ¡å°†å¤æ‚çš„ IPv6 åœ°å€æ˜ å°„ä¸ºæ˜“è®°çš„åŸŸå.

4. **å…¼å®¹æ€§å¤„ç†**

   å¯¹äºä¸æ”¯æŒ IPv6 çš„åœºæ™¯, å¯ä»¥ä½¿ç”¨ IPv6 åˆ° IPv4 çš„éš§é“æŠ€æœ¯ (å¦‚ 6to4 æˆ– Teredo) æ¥å®ç°å…¼å®¹.

é€šè¿‡è¿™äº›æ–¹å¼, å³ä½¿æ²¡æœ‰ IPv4 å…¬ç½‘åœ°å€, ä¹Ÿèƒ½åˆ©ç”¨ IPv6 æ›´æ–¹ä¾¿åœ°ç®¡ç†å®¶ä¸­çš„è®¾å¤‡, ç‰¹åˆ«æ˜¯åœ¨éœ€è¦å¤šè®¾å¤‡è¿œç¨‹è®¿é—®çš„æƒ…å†µä¸‹.

#### ç°çŠ¶

æˆ‘ç›®å‰å·²ç»å®ç°äº†ä¸»è¦è®¾å¤‡çš„ **IPv6** è®¿é—®, ä¸”é€šè¿‡ DDNS-GO ç»‘å®šäº†åŸŸå, ä½†æ˜¯å› ä¸ºå®‰å…¨æ€§é—®é¢˜(å®‰å…¨è®¤è¯ç™»å½•å¹¶æ²¡æœ‰è¦†ç›–åˆ°æ‰€æœ‰æœåŠ¡, å› ä¸ºç»‘å®šäº†åŸŸå, å¦‚æœè¢«çŒœæµ‹å‡ºç«¯å£å·, å°±ä¼šè¢«éæ³•è®¿é—®), æš‚æ—¶å…³é—­äº†æ‰€æœ‰çš„ **IPv6** è®¿é—®(å¼€å¯è·¯ç”±å™¨çš„ IPv6 é˜²ç«å¢™).

**ä¸ IPv6 ç›¸å…³çš„æœåŠ¡é…ç½®, æ¯”å¦‚ Surge, OpenClash, ShellClash, Pass Wall ç­‰å°±è‡ªè¡Œæœç´¢äº†, æœ¬æ–‡ä¸è¿‡å¤šæè¿°.**

#### IPv6 ç›¸å…³èµ„æº

**IPv6 æµ‹è¯•åœ°å€**:

- [IPv6 è¿æ¥æµ‹è¯•](https://test-ipv6.com/)
- [IPv6 æŸ¥è¯¢ä¸æ£€æµ‹](https://ipw.cn/)
- [ITDOG](https://www.itdog.cn/ping_ipv6/)

**IPv6 æŠ¥å‘Š**:

- [å›½å®¶ IPv6 å‘å±•ç›‘æµ‹å¹³å°](https://www.china-ipv6.cn/)
- [ä¸­å›½ IPv6 å‘å±•çŠ¶å†µ(2019)](http://www.caict.ac.cn/kxyj/qwfb/ztbg/201907/P020190712576587138174.pdf)
- [å…¨çƒ IPv6 å‘å±•æŒ‡æ•°æŠ¥å‘Š 2024](https://www.rolandberger.com/publications/publication_pdf/Global-IPv6-Development-Report-2024_CN.pdf)

---

## ç½‘ç»œå®‰å…¨

ç½‘ç»œå®‰å…¨æ¶‰åŠåˆ°çš„æ–¹é¢éå¸¸å¤š, å¤§ä½“åŒ…æ‹¬:

1. å¼ºå¯†ç ç­–ç•¥ + MFA å¤šå› ç´ è®¤è¯;
2. ä½¿ç”¨ vLAN æˆ–å­ç½‘è¿›è¡Œç½‘ç»œéš”ç¦»;
3. ä½¿ç”¨ HTTPS åŠ å¯†åè®®;
4. éƒ¨ç½²é˜²ç«å¢™;
5. å®šæœŸæ›´æ–°æœåŠ¡, ä¿®å¤å·²çŸ¥æ¼æ´;
6. [èœœç½ç³»ç»Ÿ](https://github.com/paralax/awesome-honeypots);

åœ¨ Homelab ç¯å¢ƒä¸­, éƒ¨ç½²ç‰©ç†é˜²ç«å¢™è™½ç„¶æ˜¯ç†æƒ³çš„å®‰å…¨æ–¹æ¡ˆ, ä½†æˆæœ¬é«˜æ˜‚, å¯¹äºæ™®é€šç”¨æˆ·å¹¶ä¸ç°å®. ç›¸æ¯”ä¹‹ä¸‹, **ä½¿ç”¨ HTTPS åŠ å¯†åè®®** æ˜¯æœ€å®¹æ˜“å®ç°ä¸”é«˜æ•ˆçš„å®‰å…¨æªæ–½ä¹‹ä¸€.

è€Œ `å¼ºå¯†ç ç­–ç•¥ + MFA å¤šå› ç´ è®¤è¯` è¿™ä¸ªåˆ™æ˜¯ä¸ªäººä½¿ç”¨ä¹ æƒ¯, æˆ‘ä¸€èˆ¬éƒ½ä¼šä½¿ç”¨ `Bitwarden` ç”Ÿæˆ **ä¸é‡å¤ä¸”å¤æ‚çš„** å¯†ç , ä¸”å¼€å¯å…·å¤‡ `MFA å¤šå› ç´ è®¤è¯` æœåŠ¡çš„äºŒæ¬¡è®¤è¯, åœ¨ macOS ä½¿ç”¨äº† [Step Two](https://steptwo.app/) æ¥ç®¡ç†ä¸€æ¬¡æ€§å¯†ç , è¿™æ ·çš„ APP è¿˜æœ‰å¾ˆå¤š, æ¯”å¦‚è¿˜æœ‰ [Authenticator](https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&pli=1).

æœ€è¿‘æ‰“ç®—éƒ¨ç½²ä¸€ä¸ª èœœç½ç³»ç»Ÿç©ç©å„¿, å®ƒæ˜¯ä¸€ç§æ”»é˜²å…¼å¤‡çš„å·¥å…·, é€šè¿‡æ¬ºéª—å’Œåˆ†ææ”»å‡»è€…æ¥å¢å¼ºç½‘ç»œé˜²å¾¡, é€šè¿‡ä¸»åŠ¨å¸ƒé˜², ä¸»åŠ¨ç¤ºå¼±æ”»å‡»è€…, å¹¶ä¸”è¿›è¡Œååˆ¶, ä½¿ç½‘ç»œæ”»å‡»ä¸å†æ˜¯ä¸€ä¸ªæ²¡æœ‰æŸå¤±ã€åªæœ‰æ”¶ç›Šçš„äº‹æƒ….

### HTTPS è¯ä¹¦

å‰é¢ä»‹ç»è¿‡ä½¿ç”¨ [Nginx Proxy Manager æ¥ç”³è¯·å¹¶è‡ªåŠ¨ç»­æœŸå…è´¹çš„ HTTPS è¯ä¹¦](#HTTPS è¯ä¹¦ç”³è¯·), ä½†å› ä¸ºä¸ç¨³å®šè€Œè¢«å¼ƒç”¨, è½¬è€Œä½¿ç”¨ 1Panel çš„ HTTPS çš„è¯ä¹¦ç”³è¯·ä¸ç®¡ç†æœåŠ¡:

![20241229154732_SE63DzWC.webp](https://cdn.dong4j.site/source/image/20241229154732_SE63DzWC.webp)

1Panel çš„è¯ä¹¦ç”³è¯·éå¸¸å¿«ä¸”æˆåŠŸç‡ 100%, å¯ä»¥é‡‡ç”¨æ‰‹åŠ¨çš„æ–¹å¼ä¸º **é›·æ±  Safeline** æ·»åŠ è¯ä¹¦, ä¹Ÿå¯ä»¥ [è‡ªåŠ¨åŒ–éƒ¨ç½² HTTPS è¯ä¹¦åˆ° WAF](#è‡ªåŠ¨éƒ¨ç½² 1Panel ç”³è¯·çš„ HTTPS).

![20241229154732_WrtceKg5.webp](https://cdn.dong4j.site/source/image/20241229154732_WrtceKg5.webp)

### é›·æ±  Safeline

[é›·æ± ](https://waf-ce.chaitin.cn/) å·ç§° **ä¸‹ä¸€ä»£ Web åº”ç”¨é˜²ç«å¢™**, ç¤¾åŒºç‰ˆåŠŸèƒ½å®Œå…¨å¤Ÿç”¨(ä¸»è¦å› ä¸ºä¸“ä¸šç‰ˆå¤ªè´µ ğŸ¥²), ä¸“ä¸šç‰ˆå¤šäº†å‘Šè­¦, è´Ÿè½½å‡è¡¡ç­‰åŠŸèƒ½:

![20241229154732_YRcE1Gho.webp](https://cdn.dong4j.site/source/image/20241229154732_YRcE1Gho.webp)

ç”¨ [å®˜æ–¹çš„æµ‹è¯•å·¥å…·](https://github.com/chaitin/blazehttp) ç©äº†ä¸€ä¸‹, æ”»å‡»æ£€æµ‹æ—¥å¿—ä¸­çš„ä¿¡æ¯éå¸¸å…¨é¢:

![20241229154732_VxcQXWa4.webp](https://cdn.dong4j.site/source/image/20241229154732_VxcQXWa4.webp)

ä¸”è¿˜æœ‰ AI æ”»å‡»åˆ†æ:

![20241229154732_iXXaoqbt.webp](https://cdn.dong4j.site/source/image/20241229154732_iXXaoqbt.webp)

åç»­æˆ‘å°†ä½¿ç”¨ **WAF** ä»£æ›¿ **é›·æ±  Safeline**.

#### ç”¨ WAF æ›¿æ¢ NPM

ä¹°ä¸èµ·ç¡¬ä»¶é˜²ç«å¢™, è½¯ä»¶é˜²ç«å¢™æˆ‘ä»¬è¿˜ä¸èƒ½ç™½å«–å—?

æ‰€ä»¥ä¸ºäº†ç©ä¸€ç©è¿™ä¸ªå·ç§°è¿™ä¹ˆç‰›é€¼çš„è½¯é˜²ç«å¢™, å°† NPM çš„ä»£ç†å…¨éƒ¨è¿ç§»åˆ°äº† WAF, ç°åœ¨ NPM åˆ™æ²¦ä¸º [å†…ç½‘è‡ªå®šä¹‰åŸŸåçš„ä»£ç†æœåŠ¡](#ä»£ç†å±€åŸŸç½‘è‡ªå®šä¹‰åŸŸå).

æ‰€ä»¥å°±ç›´æ¥ä½¿ç”¨ 2 å°è™šæ‹Ÿæœºé€šè¿‡ Docker éƒ¨ç½²äº† WAF, åˆ†åˆ«æ›¿ä»£ç”µä¿¡å’Œè”é€šç½‘ç»œçš„ NPM:

![20241229154732_iUHGX8ah.webp](https://cdn.dong4j.site/source/image/20241229154732_iUHGX8ah.webp)

![20241229154732_idtQIkzN.webp](https://cdn.dong4j.site/source/image/20241229154732_idtQIkzN.webp)

é˜²æŠ¤åŠŸèƒ½è¦æ¯” NPM å¤šå‡ ä¸ª, ä¸”æœ‰ Dashboard å±•ç¤ºè®¿é—®ä¸æ‹¦æˆªæƒ…å†µ.

#### é…ç½®åŸŸåä»£ç†

ä¸ NPM ä¸åŒçš„æ˜¯ WAF åœ¨é…ç½®åŸŸåæ—¶ç¡®è®¤ç«¯å£å·, è€Œ NPM åœ¨å¯åŠ¨æ—¶å°±ç¡®è®¤äº† HTTP å’Œ HTTPS ç«¯å£ , æ‰€ä»¥ WAF çš„ä¼˜åŠ¿æ˜¯èƒ½å¤Ÿä¸ºä¸åŒçš„åŸŸåè®¾ç½®ä¸åŒçš„ç«¯å£:

![20241229154732_YMIhiIMR.webp](https://cdn.dong4j.site/source/image/20241229154732_YMIhiIMR.webp)

å¦‚ä¸Šé…ç½®çš„è¯, å°±éœ€è¦åœ¨è·¯ç”±å™¨åˆ†åˆ«ä¸º `1443` å’Œ `2443` é…ç½®ç«¯å£è½¬å‘è§„åˆ™, å±€åŸŸç½‘ IP æ·»åŠ éƒ¨ç½² WAF çš„æœåŠ¡å™¨ IP.

##### NAS åŸŸåä»£ç†

è¡¥å……è¯´æ˜ä¸€ä¸‹å¦‚ä½•ä»£ç† `Synology Drive` æµé‡.

`Synology Drive` å®¢æˆ·ç«¯å…¨å¹³å°æ”¯æŒ, æˆ‘åœ¨æ‰‹æœºå’Œç”µè„‘ä¸Šä½¿ç”¨äº† Drive å®¢æˆ·ç«¯.

å‡è®¾æˆ‘æƒ³ä½¿ç”¨ `nas.dongj4.tele:1443` æ¥è®¿é—® NAS ä¸Š(`192.168.31.3`) çš„ `Synology Drive` æœåŠ¡, é‚£ä¹ˆåªéœ€è¦åœ¨ WAF æ·»åŠ ä¸€ä¸ªåŸŸåé…ç½®:

![20241229154732_KQWn57pG.webp](https://cdn.dong4j.site/source/image/20241229154732_KQWn57pG.webp)

ç†Ÿæ‚‰ Synology çš„æœ‹å‹éƒ½çŸ¥é“ `5000` æ˜¯ NAS çš„ WebUI çš„ HTTP ç«¯å£. æ¥ç€åœ¨è·¯ç”±å™¨ä¸Šé…ç½®ç«¯å£è½¬å‘, å°† `1443` è½¬å‘åˆ° `192.168.31.10:1443`,

ç„¶ååœ¨æ‰‹æœºå®¢æˆ·ç«¯ä¸Šç™»å½•:

![20241229154732_tGBKjnmU.webp](https://cdn.dong4j.site/source/image/20241229154732_tGBKjnmU.webp)

é…ç½®æ²¡é—®é¢˜çš„è¯åº”è¯¥å°±å¯ä»¥æ­£å¸¸ç™»å½•äº†, å¦‚æœç™»å½•å¤±è´¥è¯·è‡ªè¡Œæ£€æŸ¥ç«¯å£è½¬å‘, NAS çš„ç«¯å£å·ç­‰æ˜¯å¦è®¾ç½®æ­£ç¡®.

ç„¶åå¦‚æœä½ å°†ä¸Šè¿°çš„åŸŸåå’Œç«¯å£é…ç½®åˆ°æ¡Œé¢ç‰ˆçš„ Drive client ä¼šå‘ç°è¿æ¥ä¸ä¸Š, è¿™æ˜¯å› ä¸º **PC ç«¯ Drive ç¨‹åºå¼€æ”¾çš„é»˜è®¤è®¿é—®ç«¯å£ä¸º 6690**, å¯¹ç§»åŠ¨ç«¯çš„ App å¼€æ”¾çš„é»˜è®¤è®¿é—®ç«¯å£ä¸º **5000**.

> Synology Drive å®¢æˆ·ç«¯ä¼šæ ¹æ®è¾“å…¥çš„åŸŸåæˆ– IP è‡ªåŠ¨é€‰æ‹©é»˜è®¤ç«¯å£è¿›è¡Œè®¿é—®:
>
> - **PC å®¢æˆ·ç«¯**: å¦‚æœæœªæŒ‡å®šç«¯å£, ä¼šé»˜è®¤ä½¿ç”¨ **6690**
> - **ç§»åŠ¨å®¢æˆ·ç«¯**: é»˜è®¤ä½¿ç”¨ **5000** (HTTP) æˆ– **5001** (HTTPS)
>
> å¦‚æœç”¨æˆ·æ˜ç¡®å¡«å†™äº†ç«¯å£å·, å®¢æˆ·ç«¯ä¼šä¼˜å…ˆä½¿ç”¨æŒ‡å®šçš„ç«¯å£.
>
> åœ¨å±€åŸŸç½‘ä¸­, ç›´æ¥è¾“å…¥ NAS çš„ IP åœ°å€å³å¯è¿æ¥, æ˜¯å¦åŠ ç«¯å£å·å‡å¯ï¼›åœ¨å¤–ç½‘è®¿é—®æ—¶, éœ€è¦å°†å¤–éƒ¨ç«¯å£è½¬å‘åˆ° NAS çš„ç›¸åº”å†…éƒ¨ç«¯å£ (ä¾‹å¦‚ 6690)

[DSM æœåŠ¡ä½¿ç”¨çš„ç½‘ç»œç«¯å£](https://kb.synology.cn/zh-cn/DSM/tutorial/What_network_ports_are_used_by_Synology_services)

![20241229154732_lHY8HjzL.webp](https://cdn.dong4j.site/source/image/20241229154732_lHY8HjzL.webp)

æ‰€ä»¥ä¸ºäº†è®©æ¡Œé¢ç‰ˆçš„ Drive client èƒ½æ­£å¸¸ä½¿ç”¨, æˆ‘ä»¬éœ€è¦åœ¨è·¯ç”±å™¨ä¸Šå¤šé…ç½®ä¸€ä¸ªç«¯å£è½¬å‘è§„åˆ™ ([å› ä¸º WAF å®ƒä¸æ”¯æŒ TCP/UDP è½¬å‘](#WAF çš„ä»£ç†çš„å±€é™æ€§)):

![20241229154732_nlmVvkzT.webp](https://cdn.dong4j.site/source/image/20241229154732_nlmVvkzT.webp)

æ¡Œé¢ç‰ˆ Drive è¿æ¥é…ç½®:

![20241229154732_m3hA6Drx.webp](https://cdn.dong4j.site/source/image/20241229154732_m3hA6Drx.webp)

è¿™é‡Œ **å¯ç”¨ SSL æ•°æ®ä¼ è¾“åŠ å¯†** æœ€å¥½èƒ½å‹¾é€‰ä¸Š, ä½†å› ä¸ºæ²¡æœ‰é€šè¿‡ WAF è½¬å‘, æ‰€æœ‰æ— æ³•ä½¿ç”¨ WAF ä¸­çš„è¯ä¹¦é…ç½®, ä½ éœ€è¦åœ¨ NAS ä¸­é…ç½® HTTPS è¯ä¹¦:

> åé¢ä¼šè®²åˆ°ä¸ºä»€ä¹ˆä½¿ç”¨ 1Panel çš„è¯ä¹¦ç®¡ç†ä»£ç† WAF çš„è¯ä¹¦ç®¡ç†, ä¸”å®ç° 1Panel ç”³è¯·è¯ä¹¦å¹¶è‡ªåŠ¨éƒ¨ç½²åˆ° WAF.
>
> è¿™é‡Œä¼šå…ˆç”¨åˆ° 1Panel çš„ 2 ä¸ªè¯ä¹¦, å¦‚æœæ²¡å•¥å¤´ç»ª, å¯ä»¥å…ˆçœ‹å®Œ [è‡ªåŠ¨éƒ¨ç½² 1Panel ç”³è¯·çš„ HTTPS](#è‡ªåŠ¨éƒ¨ç½² 1Panel ç”³è¯·çš„ HTTPS) å†å›è¿‡æ¥çœ‹è¿™é‡Œ.

NAS æ–°å¢è¯ä¹¦:

1. å…¥å£: æ§åˆ¶é¢æ¿-å®‰å…¨æ€§-è¯ä¹¦

2. æ–°å¢è¯ä¹¦-å¯¼å…¥è¯ä¹¦æˆ–ä» Let's Encrypt è·å–è¯ä¹¦ (å¦‚æœæ˜¯æ›´æ–°è¯ä¹¦å°±é€‰ç¬¬äºŒé¡¹: **æ›¿æ¢å·²æœ‰è¯ä¹¦**)-å¯¼å…¥è¯ä¹¦(ä¸è¦å‹¾é€‰ **è®¾ä¸ºé»˜è®¤è¯ä¹¦**[å¦‚æœä½ çŸ¥é“æ˜¯ä»€ä¹ˆæ“ä½œå¯æ‰§è¡Œé€‰æ‹©]):

   ![20241229154732_8lNaX5kY.webp](https://cdn.dong4j.site/source/image/20241229154732_8lNaX5kY.webp)

ç§é’¥: **privkey.pem**

è¯ä¹¦: **fullchain.pem**

ä¸­é—´è¯ä¹¦: å¯ä¸å¡«

3. ä¸º Drive é…ç½®è‡ªå®šä¹‰è¯ä¹¦:

   ![20241229154732_LtfPm6CP.webp](https://cdn.dong4j.site/source/image/20241229154732_LtfPm6CP.webp)

##### NAS è‡ªåŠ¨éƒ¨ç½² HTTPS è¯ä¹¦

å½“ç„¶è¿™åˆæ˜¯å¦ä¸€ä¸ªè¯é¢˜äº†, æˆ‘ä¼šå•ç‹¬å‡ºä¸€ä¸ªæŒ‡å—, é€šè¿‡ [acme.sh](https://github.com/acmesh-official/acme.sh) å°†è¯ä¹¦è‡ªåŠ¨éƒ¨ç½²åˆ° NAS å’Œ WAF.

ç›¸å…³é“¾æ¥:

- [ä¸¤ä¸ªä¼˜åŒ–ç‚¹ #660](https://github.com/chaitin/SafeLine/issues/660)
- [è¯ä¹¦å¢åŠ ä½¿ç”¨è·¯å¾„å¯¼å…¥æ–¹å¼ #782](https://github.com/chaitin/SafeLine/issues/782)
- [ç¾¤æ™– DSM7.x é€šè¿‡ acme.sh å…¨è‡ªåŠ¨æ›´æ–°å¹¶éƒ¨ç½² SSL è¯ä¹¦](https://blog.zakikun.com/archives/80.html)
- [è®°æˆ‘ç¾¤æ™–ä¸Šçš„ Docker é¡¹ç›®: ddns-go å’Œ acme.sh](https://www.iamlm.com/blog/119.%E8%AE%B0%E6%88%91%E7%BE%A4%E6%99%96%E4%B8%8A%E7%9A%84Docker%E9%A1%B9%E7%9B%AE%EF%BC%9Addns-go%E5%92%8Cacme.sh/)
- [HTTPS certificates for your Synology NAS using acme.sh](https://github.com/acmesh-official/acme.sh/wiki/Synology-NAS-Guide)

#### ä¸ä½¿ç”¨ WAF çš„è¯ä¹¦ç®¡ç†

**WAF** æ— æ³•ç”³è¯·æ³›åŸŸåè¯ä¹¦, æ‰€ä»¥å°±æœ‰ç‚¹å°´å°¬.

![20241229154732_cL5QfgRD.webp](https://cdn.dong4j.site/source/image/20241229154732_cL5QfgRD.webp)

ä¸è¿‡æœ€æ–°çš„æƒ…å†µæ˜¯å®˜æ–¹å·²ç»åœ¨è€ƒè™‘ [é€šè¿‡ DNS éªŒè¯çš„æ–¹å¼æ¥æ”¯æŒæ³›åŸŸåè¯ä¹¦ç”³è¯·äº†](https://github.com/chaitin/SafeLine/issues/563), æ‰€ä»¥è¿˜æ˜¯å¯ä»¥æœŸå¾…ä¸€ä¸‹.

WAF çš„å…¶ä»– [å¼€å‘è®¡åˆ’](https://waf-ce.chaitin.cn/community) ä¹Ÿå¯ä»¥å…³æ³¨ä¸€ä¸‹.

#### WAF çš„ä»£ç†çš„å±€é™æ€§

**åªèƒ½ä»£ç† HTTP æœåŠ¡**, ä¸æ”¯æŒå››å±‚ä»£ç†è½¬å‘. å®˜æ–¹çš„å›ç­”æ˜¯ä¸æ”¯æŒ, æ²¡å¿…è¦: **WAF åªå…³æ³¨ä¸ƒå±‚ç½‘ç»œåè®®, ä¸“æ³¨äº HTTP æµé‡çš„æ£€æµ‹ä¸æ¸…æ´—**.

ä½†æ˜¯ WAF ä¸€èˆ¬éƒ½æ˜¯éƒ¨ç½²åœ¨å…¬ç½‘ä¹‹åçš„é‚£å°æœåŠ¡å™¨, ä½œä¸ºæ‰€æœ‰æµé‡çš„å…¥å£, ç„¶åæ‰æ˜¯è½¬å‘åˆ°åé¢çš„ Nginx æˆ–å…¶ä»–æœåŠ¡, å¦‚æœåªæ”¯æŒä¸ƒå±‚ä»£ç†è½¬å‘çš„è¯, è¯¸å¦‚ SSH è¿™ç±» TCP/UDP å±‚çš„æµé‡è¿˜å¾—å•ç‹¬é…ç½®.

[å¯ä»¥çœ‹çœ‹è¿™é‡Œçš„è®¨è®º](https://github.com/chaitin/SafeLine/issues/123), ä¸çŸ¥é“å®˜æ–¹ä¼šä¸ä¼šæ”¯æŒ.

ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜, æˆ‘ç›®å‰ä½¿ç”¨çš„æ–¹æ¡ˆ:

- å¦‚æœæ˜¯ HTTP æœåŠ¡, å…¨éƒ¨é€šè¿‡è·¯ç”±å™¨è½¬å‘åˆ° WAF æ‰€åœ¨çš„æœåŠ¡å™¨ä¸Š, ç„¶åç”± WAF è¿›è¡Œåç»­çš„è½¬å‘;
- å…¶ä»–æœåŠ¡æ¯”å¦‚ WireGuard, Snell ç­‰å››å±‚åè®®çš„æµé‡åˆ™é€šè¿‡è·¯ç”±å™¨ç›´æ¥è½¬å‘è‡³æŒ‡å®šçš„æœåŠ¡å™¨ (å‰é¢ [NAS åŸŸåä»£ç†](#NAS åŸŸåä»£ç†) å°±æ˜¯ä¸€ä¸ªä¾‹å­);

#### WAF ç¤¾åŒºç‰ˆçš„å±€é™æ€§

å’Œ NPM çš„é…ç½®è‡ªç”±åº¦æ¯”èµ·æ¥, WAF ç¤¾åŒºç‰ˆåˆ™ä¸æ˜¯é‚£ä¹ˆå…·æœ‰å¯ç©æ€§, å› ä¸º WAF ä¼šå®šæ—¶è¦†ç›–æ‰‹åŠ¨ä¿®æ”¹çš„é…ç½®æ–‡ä»¶, ä¸è¿‡ä¹Ÿæœ‰ä¸æ˜¯é‚£ä¹ˆä¼˜é›…çš„è§£å†³æ–¹æ¡ˆ, æ¥ä¸‹æ¥é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ä¸€ä¸‹æ“ä½œæ–¹å¼.

é¦–å…ˆåœ¨ WAF ä¸Šåˆ›å»ºä¸€ä¸ªç«™ç‚¹, ç”¨äºè¿”å› **å½“å‰æ—¶é—´** å’Œ **å®¢æˆ·ç«¯çœŸå® IP**:

![20241229154732_lXVNRKcT.webp](https://cdn.dong4j.site/source/image/20241229154732_lXVNRKcT.webp)

ç‚¹å‡»åˆ›å»ºå¥½çš„ç«™ç‚¹, ç„¶åæ¸ é“ **é™æ€èµ„æº** é€‰é¡¹å¡, æ·»åŠ ä¸€ä¸ª **index.html** é¡µé¢, å†…å®¹å¦‚ä¸‹:

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Current Time</title>
  </head>
  <body>
    <p>
      <script>
        document.write(new Date().toLocaleTimeString());
      </script>
    </p>
  </body>
</html>
```

è®¿é—® `https://test.dong4j.tele:1234` å¯è¿”å›å½“å‰æ—¶é—´.

æ¥ä¸‹æ¥å»æœåŠ¡å™¨æ‰‹åŠ¨ä¿®æ”¹ WAF çš„ nginx é…ç½®æ–‡ä»¶:

åˆšåˆšæ·»åŠ çš„æµ‹è¯•ç«™ç‚¹çš„é…ç½®æ–‡ä»¶ä¸º: `/opt/safeline/resources/nginx/sites-enabled/IF_backend_13`,

æ‰“å¼€å¹¶ç¼–è¾‘, åœ¨ `server` ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®:

```
location = /ip {
    add_header Content-Type text/plain;
    access_log on;
    return 200 "$remote_addr\n";
}
```

ä¿å­˜é€€å‡º, ä¸ºäº†é˜²æ­¢ WAF å®šæœŸè¦†ç›–æ‰‹åŠ¨ä¿®æ”¹åçš„é…ç½®æ–‡ä»¶, æˆ‘ä»¬éœ€è¦ç»™åˆšåˆšçš„é…ç½®æ–‡ä»¶æ·»åŠ  **ä¸å¯å˜å±æ€§**

```shell
chattr +i IF_backend_13
```

é‡æ–°åŠ è½½ Nginx é…ç½®:

```shell
docker exec -it safeline-tengine nginx -t   && \
docker exec -it safeline-tengine nginx -s reload
```

æœ€åè®¿é—® `https://test.dong4j.tele:1234/ip` å¯è·å–åˆ°å®¢æˆ·ç«¯ IP (ä½¿ç”¨èœ‚çªç½‘ç»œçš„æ‰‹æœºè®¿é—®).

å…³é”®ç‚¹æ˜¯ `chattr +i`, é˜²æ­¢ WAF è¦†ç›–æˆ‘ä»¬ä¿®æ”¹è¿‡åçš„æ–‡ä»¶, å¦‚æœéœ€è¦å†æ¬¡ç¼–è¾‘, ä½¿ç”¨ `chattr -i æ–‡ä»¶å` æ¢å¤.

### è‡ªåŠ¨éƒ¨ç½² 1Panel ç”³è¯·çš„ HTTPS

ä½¿ç”¨ WAF ä¸€é”®éƒ¨ç½²è„šæœ¬æ—¶ä¼šè®©ä½ é€‰æ‹©å®‰è£…çš„ç›®å½•, æˆ‘å®‰è£…åœ¨ `/opt` ç›®å½•ä¸‹, æ‰€ä»¥ Nginx çš„ç›®å½•: `/opt/safeline/resources/nginx/sites-enabled/` (ä½ å¯ä»¥æŸ¥çœ‹ `/opt/safeline/conpose.yaml` æ–‡ä»¶, äº†è§£å…¶ä»–æŒ‚åœ¨çš„ç›®å½•çš„ä½ç½®).

**æˆ‘å…ˆæ·»åŠ ä¸€ä¸ªæµ‹è¯•ç«™ç‚¹**:

![20241229154732_1zJBR0CJ.webp](https://cdn.dong4j.site/source/image/20241229154732_1zJBR0CJ.webp)

å¯¹åº”çš„ Nginx é…ç½®æ–‡ä»¶ä¸º **IF_backend_15**:

```
upstream backend_15 {
    server 192.168.31.10:9876;
    keepalive 128;
    keepalive_timeout 75;
}
...
server {
    listen 0.0.0.0:1443 ssl http2;
    server_name test.dong4j.tele;
    ssl_certificate /etc/nginx/certs/cert_1.crt;
    ssl_certificate_key /etc/nginx/certs/cert_1.key;
		...
    if ($host !~* ^(test\.dong4j\.tele)$) {
        rewrite ^ /not_found_page last;
    }
    ....
    location ^~ / {
        proxy_pass http://backend_15;
        ...
    }
```

å¯ä»¥çœ‹åˆ°ç”¨åˆ°çš„å…¬é’¥è¯ä¹¦å’Œç§é’¥åˆ†åˆ«æ˜¯: `/etc/nginx/certs/cert_1.crt`, `/etc/nginx/certs/cert_1.key` (å¦‚æœå·²ç»æœ‰å¤šä¸ª HTTPS è¯ä¹¦, åç¼€å¯èƒ½ä¼šæ˜¯å…¶ä»–çš„æ•°å­—).

ä»–ä»¬å¯¹åº”çš„æŒ‚è½½ç›®å½•ä¸º: `/opt/safeline/resources/nginx/certs`

æ‰€ä»¥æˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯è‡ªåŠ¨æ¢ `certs` ä¸­çš„è¯ä¹¦, æˆ‘ä»¬ä½¿ç”¨è„šæœ¬æ¥å®ç°è¿™ä¸€è‡ªåŠ¨åŒ–è¿‡ç¨‹.

1. åœ¨ 1Panel ä¸Šé…ç½® **æ¨é€è¯ä¹¦åˆ°æœ¬åœ°ç›®å½•**:

   ![20241229154732_f0epxZwE.webp](https://cdn.dong4j.site/source/image/20241229154732_f0epxZwE.webp)

å¦‚æœåŸæ¥æ²¡æœ‰é…ç½®è¯ä¹¦æ¨é€, éœ€è¦é‡æ–°ç”³è¯·ä¸€æ¬¡:

![20241229154732_XqtbWGyP.webp](https://cdn.dong4j.site/source/image/20241229154732_XqtbWGyP.webp)

ç„¶åæŒ‡å®šç›®å½•ä¸‹ä¼šå‡ºç° è¯ä¹¦æ–‡ä»¶`fullchain.pem` å’Œå¯†é’¥æ–‡ä»¶ `privkey.pem`, å› ä¸º `fullchain.pem` åŒ…å«å¤šä¸ªè¯ä¹¦æ–‡ä»¶, è€Œ `openssl x509` é»˜è®¤åªå¤„ç†å•ä¸ªè¯ä¹¦, æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥æ‹·è´ `fullchain.pem` çš„å†…å®¹, æ¥ä¸‹æ¥å°±æ˜¯è„šæœ¬éƒ¨åˆ†(è„šæœ¬åç§°ä¸º: `sync_certs.sh`):

{% folding ğŸª¬ æŸ¥çœ‹ sync_certs.sh è„šæœ¬å†…å®¹ %}

**çœ‹åˆ°è¿™é‡Œå…ˆåˆ«æ€¥ç€ä½¿ç”¨è¿™ä¸ªè„šæœ¬, æ¥ç€å¾€ä¸‹çœ‹, è¿˜æœ‰æ›´å¥½çš„æ–¹å¼, è¿™é‡Œåªæ˜¯è®°å½•ä¸€ä¸‹æŠ˜è…¾è¿‡ç¨‹.**

```python
#!/bin/bash

# ä½¿ç”¨è¯´æ˜
usage() {
    echo "Usage: $0 <WAF_IP>"
    echo "Example: $0 waf.t"
    exit 1
}

# æ£€æŸ¥æ˜¯å¦ä¼ å…¥å‚æ•°
if [ -z "$1" ]; then
    usage
fi

# å®šä¹‰å˜é‡
WAF="$1"
CERT_FILE="fullchain.pem"
KEY_FILE="privkey.pem"
CERT_PATH="/opt/safeline/resources/nginx/certs/cert_1.crt"
KEY_PATH="/opt/safeline/resources/nginx/certs/cert_1.key"
DOCKER_CONTAINER="safeline-tengine"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[INFO] $1"
}

error() {
    echo "[ERROR] $1" >&2
    exit 1
}

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ ! -f "$CERT_FILE" ] || [ ! -f "$KEY_FILE" ]; then
    error "è¯ä¹¦æ–‡ä»¶æˆ–å¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨, è¯·ç¡®ä¿ $CERT_FILE å’Œ $KEY_FILE å­˜åœ¨"
fi

# å¤åˆ¶è¯ä¹¦å’Œå¯†é’¥
log "æ­£åœ¨å¤åˆ¶è¯ä¹¦å’Œå¯†é’¥åˆ° ${WAF}..."
scp "$CERT_FILE" "${WAF}:${CERT_PATH}" || error "æ— æ³•å¤åˆ¶è¯ä¹¦æ–‡ä»¶åˆ° ${WAF}"
scp "$KEY_FILE" "${WAF}:${KEY_PATH}" || error "æ— æ³•å¤åˆ¶å¯†é’¥æ–‡ä»¶åˆ° ${WAF}"
log "è¯ä¹¦å’Œå¯†é’¥æ–‡ä»¶å·²æˆåŠŸå¤åˆ¶åˆ° ${WAF}"

# ä¿®å¤æ–‡ä»¶æƒé™
log "æ­£åœ¨ä¿®å¤æ–‡ä»¶æƒé™..."
ssh "$WAF" "chmod 644 ${CERT_PATH} ${KEY_PATH}" || error "æ— æ³•ä¿®å¤æ–‡ä»¶æƒé™"
log "æ–‡ä»¶æƒé™ä¿®å¤å®Œæˆ"

# é‡å¯ Docker å®¹å™¨
log "æ­£åœ¨é‡å¯ Docker å®¹å™¨ ${DOCKER_CONTAINER}..."
ssh "$WAF" "docker restart ${DOCKER_CONTAINER}" > /dev/null || error "æ— æ³•é‡å¯ Docker å®¹å™¨"
log "Docker å®¹å™¨ ${DOCKER_CONTAINER} å·²æˆåŠŸé‡å¯"

log "è¯ä¹¦åŒæ­¥å’Œæ›´æ–°å®Œæˆï¼"
```

{% endfolding %}

---

æˆ‘çš„ `1Panel` éƒ¨ç½²åœ¨ DS218+ ä¸Š, ä¸”æœ‰ 2 å° WAF æœåŠ¡å™¨åˆ†åˆ«å¯¹åº”ç”µä¿¡å’Œè”é€šç½‘ç»œ, æ‰€ä»¥æˆ‘å°†å…¬å…±å‚æ•°æå‡ºæ¥, ä½¿ç”¨è„šæœ¬ä¼ å‚çš„æ–¹å¼å¤„ç†:

1. `waf.t` å’Œ `waf.u` éœ€è¦åœ¨ `.ssh/config` ä¸­é…ç½®, å¦‚æœä½ çœ‹è¿‡ [SSH åˆ«åé…ç½®](#åˆ«åé…ç½®) åº”è¯¥ä¸éš¾;
2. è¿˜éœ€è¦é…ç½® [SSH å…å¯†ç™»å½•](#SSH å…å¯†ç™»å½•);
3. WAF ä¸Šçš„ `cert_1.crt` å’Œ `cert_1.key` åç§°éœ€è¦æ ¹æ®ä½ è‡ªå·±çš„æƒ…å†µä¿®æ”¹;
4. å¦‚æœä½ ä½¿ç”¨é›·æ± ä¸€é”®å®‰è£…è„šæœ¬, Nginx å®¹å™¨çš„åç§°åº”è¯¥æ˜¯ `safeline-tengine`, å¦‚æœä¸æ˜¯å¯è‡ªè¡Œä¿®æ”¹;

**å€¼å¾—æ³¨æ„çš„æ˜¯, åœ¨æˆ‘çš„ DS218+ ä¸Š 1Panel ä»¥ root è¿è¡Œ, æ‰€ä»¥ `.ssh/config` åº”è¯¥åœ¨ /root/.ssh ç›®å½•ä¸‹è®¾ç½®**.

**è®¾ç½®è„šæœ¬**:

![20241229154732_IeHUcfoG.webp](https://cdn.dong4j.site/source/image/20241229154732_IeHUcfoG.webp)

æœ€ååœ¨ 1Panel ä¸­é‡æ–°ç”³è¯·è¯ä¹¦å³å¯:

![20241229154732_icVOxGzJ.webp](https://cdn.dong4j.site/source/image/20241229154732_icVOxGzJ.webp)

**ç»“æœå¤§æ„äº†æ²¡æœ‰é—ª**, è¿™ç§æ–¹å¼è™½ç„¶èƒ½å¤ŸæˆåŠŸæ›¿æ¢æŒ‚è½½ç›®å½•ä¸‹çš„è¯ä¹¦æ–‡ä»¶, ä½†æ˜¯ **WAF** å®ƒæŠŠ **è¯ä¹¦æ•°æ®å­˜åœ¨æ•°æ®åº“é‡Œé¢çš„** , å¿ƒä¸­ä¸€ä¸‡åªè‰æ³¥é©¬é£˜è¿‡.....

æˆ‘æ˜¯æ€ä¹ˆå‘ç°çš„å‘¢? æˆ‘æ‹¿å…«å€æœ›è¿œé•œå‘ç°çš„.....

é‡æ–°ç”³è¯·è¯ä¹¦ååˆ° WAF ä¸­çš„è¯ä¹¦ç®¡ç†é¡µé¢æŸ¥çœ‹, å‘ç°è¯ä¹¦æ—¶é—´æ²¡æœ‰æ›´æ–°, ä¸”ç¼–è¾‘è¯ä¹¦åä¸æ˜¯æ–°çš„è¯ä¹¦. åœ¨ `/opt/safeline` ç›®å½•ä¸‹æœ‰ä¸ª `reset_tengine.sh` æ–‡ä»¶.

{% folding ğŸª¬ æŸ¥çœ‹ reset_tengine.sh è„šæœ¬å†…å®¹ %}

```shell
#!/bin/bash

set -e

SCRIPT_DIR=$(dirname "$0")

confirm() {
    echo -e -n "\033[34m[SafeLine] $* \033[1;36m(Y/n)\033[0m"
    read -n 1 -s opt

    [[ "$opt" == $'\n' ]] || echo

    case "$opt" in
        'y' | 'Y' ) return 0;;
        'n' | 'N' ) return 1;;
        *) confirm "$1";;
    esac
}

if ! confirm "æ˜¯å¦é‡æ–°ç”Ÿæˆ tengine çš„æ‰€æœ‰é…ç½®"; then
    exit 0
fi

nginx_path="${SCRIPT_DIR}/resources/nginx"
backup_path="${SCRIPT_DIR}"/resources/nginx."$(date +%s)"

if [ ! -d "${nginx_path}" ]; then
    echo "website dir not found"
    exit 1
fi

mv "${nginx_path}" "${backup_path}"

docker restart safeline-tengine > /dev/null

docker exec safeline-mgt gentenginewebsite

if [ -d "${backup_path}/static" ]; then
    cp -r "${backup_path}/static" "${nginx_path}/static"
fi
```

{% endfolding %}

æˆ‘é‡æ–°æ‰§è¡Œäº†é‡Œé¢çš„ `docker exec safeline-mgt gentenginewebsite`, ç»“æœå°†æŒ‚è½½ç›®å½•ä¸‹çš„è¯ä¹¦ç»™è¿˜åŸå›å»äº†, ç¿»éäº†æ‰€æœ‰çš„æŒ‚è½½ç›®å½•éƒ½æ²¡æœ‰å‘ç°å¤‡ä»½çš„è¯ä¹¦æ–‡ä»¶, è¿™æ‰å‘ç°ä¸ç®€å•.....

æ‰€ä»¥çœ‹äº† `compose.yaml` æ–‡ä»¶, å…¶ä¸­å°±å‡ºç°äº† `postgres` æ•°æ®åº“, é‚£ä¹ˆæ˜¯ä¸æ˜¯è¯ä¹¦æ•°æ®è¢«å­˜å‚¨åˆ°æ•°æ®äº†? å¸¦ç€è¿™ä¸ªç–‘é—®, æˆ‘ä»¬å°† `postgres` çš„ç«¯å£æš´éœ²å‡ºæ¥è¿ä¸Šå»çœ‹çœ‹(`postgres` çš„å¯†ç åœ¨ åŒçº§ç›®å½•ä¸‹çš„ `.env` ä¸­).

![20241229154732_a0FdkfT3.webp](https://cdn.dong4j.site/source/image/20241229154732_a0FdkfT3.webp)

å¦‚å›¾æ‰€ç¤º, è¯ä¹¦æ•°æ®è¢«ä¿å­˜åœ¨äº† `mgt_ssl_cert` ä¸­, çœ‹æ¥åªèƒ½é€šè¿‡ Web API æ¥æ“ä½œäº†, ä¸è¿‡ WAF å¹¶æ²¡æœ‰æä¾› API æ–‡æ¡£, ä¹Ÿæ²¡æœ‰æä¾›ç”Ÿæˆ API key çš„æ“ä½œ, æ§åˆ¶å°çœ‹äº†ä¸€ä¸‹, åŸºäº JWT çš„è®¤è¯, ç®€å•çš„å†™äº†è„šæœ¬, æ¨¡æ‹Ÿç™»å½•è·å– JWT, ç„¶åè°ƒç”¨ `POST /api/open/cert` æ›´æ–°è¯ä¹¦:

<!--
å‚è€ƒ:

```python
import requests
import time
import pyotp
import urllib3

# åŸºæœ¬é…ç½®ä¿¡æ¯
BASE_URL = "https://www.iots.vip"     # ç™»å½•åœ°å€
USERNAME = "admin"                    # ç”¨æˆ·å
PASSWORD = "123123123"                # å¯†ç 

OTP_SECRET = "ADXXXXXXWB5S3UIWZCDX"   # åŠ¨æ€éªŒè¯ç çš„å¯†é’¥
CERT_ID = "1"                         # è¯ä¹¦ID, ç”¨äºæ›´æ–°è¯ä¹¦
CERT_FILE_PATH = "www.iots.vip.crt"   # è¯ä¹¦æ–‡ä»¶è·¯å¾„
CERT_KEY_PATH = "www.iots.vip.key"    # ç§é’¥æ–‡ä»¶è·¯å¾„

# è·å–åŠ¨æ€éªŒè¯ç 
def get_passcode(secret):
    totp = pyotp.TOTP(secret)         # åˆå§‹åŒ–TOTPå¯¹è±¡
    return totp.now()                 # è¿”å›å½“å‰æ—¶é—´çª—å£çš„åŠ¨æ€éªŒè¯ç 

# SafeLineç±»ç”¨äºä¸SafeLineæœåŠ¡è¿›è¡Œäº¤äº’
class SafeLine:
    def __init__(self, base_url):
        urllib3.disable_warnings()     # ç¦ç”¨SSLè­¦å‘Š
        self.base_url = base_url       # è®¾ç½®åŸºç¡€URL
        self.csrf_token = None         # åˆå§‹åŒ–CSRFä»¤ç‰Œ
        self.jwt = None                # åˆå§‹åŒ–JWTä»¤ç‰Œ
        self.session = requests.Session()  # åˆ›å»ºè¯·æ±‚ä¼šè¯
        self.session.verify = False    # ç¦ç”¨SSLè¯ä¹¦éªŒè¯

    # è·å–CSRFä»¤ç‰Œ
    def get_csrf_token(self):
        response = self.session.get(f"{self.base_url}/api/open/auth/csrf")
        data = response.json()
        self.csrf_token = data['data']['csrf_token']
        return self.csrf_token

    # ç™»å½•æ–¹æ³•
    def login(self, username, password):
        self.get_csrf_token()          # è·å–CSRFä»¤ç‰Œ
        payload = {                    # æ„å»ºç™»å½•è¯·æ±‚æ•°æ®
            "username": username,
            "password": password,
            "csrf_token": self.csrf_token
        }
        response = self.session.post(f"{self.base_url}/api/open/auth/login", json=payload)
        data = response.json()
        self.jwt = data['data']['jwt'] # ä¿å­˜JWTä»¤ç‰Œ
        return self.jwt

    # éªŒè¯å¤šå› ç´ è®¤è¯
    def validate_mfa(self, code):
        self.get_csrf_token()          # è·å–CSRFä»¤ç‰Œ
        headers = {'authorization': 'Bearer ' + self.jwt}
        payload = {                    # æ„å»ºå¤šå› ç´ è®¤è¯è¯·æ±‚æ•°æ®
            "code": code,
            "timestamp": int(time.time() * 1000),
            "csrf_token": self.csrf_token
        }
        response = self.session.post(f"{self.base_url}/api/open/auth/tfa", headers=headers, json=payload)
        data = response.json()
        if data['err'] is None:
            self.jwt = data['data']['jwt']  # æ›´æ–°JWTä»¤ç‰Œ
            print("login success")         # æ‰“å°ç™»å½•æˆåŠŸä¿¡æ¯
        else:
            self.jwt = None
        return data['data']['jwt']

    # åˆ—å‡ºæ‰€æœ‰è¯ä¹¦
    def list_all_certs(self):
        headers = {'authorization': 'Bearer ' + self.jwt}
        response = self.session.get(f"{self.base_url}/api/open/cert", headers=headers)
        data = response.json()
        return data['data']['nodes']

    # æ›´æ–°è¯ä¹¦
    def update_cert(self, cert_id, crt, key):
        headers = {'authorization': 'Bearer ' + self.jwt}
        payload = {                    # æ„å»ºæ›´æ–°è¯ä¹¦è¯·æ±‚æ•°æ®
            "manual": {
                "crt": crt,
                "key": key
            },
            "type": 2
        }
        response = self.session.put(f"{self.base_url}/api/open/cert/{cert_id}", headers=headers, json=payload)
        data = response.json()
        if data['err'] is None:
            print("update success")     # æ‰“å°æ›´æ–°æˆåŠŸä¿¡æ¯

# ä¸»ç¨‹åºå…¥å£
if __name__ == '__main__':
    safeline = SafeLine(base_url=BASE_URL)  # åˆ›å»ºSafeLineå¯¹è±¡
    safeline.login(USERNAME, PASSWORD)       # ç™»å½•
    safeline.validate_mfa(get_passcode(OTP_SECRET))  # éªŒè¯å¤šå› ç´ è®¤è¯

    # è¯»å–è¯ä¹¦æ–‡ä»¶å’Œç§é’¥æ–‡ä»¶
    with open(CERT_FILE_PATH, 'r') as cert_file:
        cert_str = cert_file.read()
    with open(CERT_KEY_PATH, 'r') as key_file:
        cert_key = key_file.read()
    safeline.update_cert(CERT_ID, cert_str, cert_key)  # æ›´æ–°è¯ä¹¦
```
-->

{% folding ğŸª¬ æŸ¥çœ‹ update_certs.sh è„šæœ¬å†…å®¹ %}

```shell
#!/bin/bash

# === é…ç½®ä¿¡æ¯ ===
BASE_URL="https://ip:port/api"
USERNAME="ç”¨æˆ·å"
PASSWORD="å¯†ç "
# è¯ä¹¦ id
CERT_ID=1
CERT_FILE_PATH="fullchain.pem æ–‡ä»¶è·¯å¾„"
CERT_KEY_PATH="privkey.pem æ–‡ä»¶è·¯å¾„"

# === å‡½æ•°: è¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶é€€å‡º ===
function error_exit {
    echo "[ERROR] $1"
    exit 1
}

# === 1. è·å– CSRF Token ===
csrf_token=$(curl -k -s "${BASE_URL}/open/auth/csrf" | jq -r '.data.csrf_token') || error_exit "æ— æ³•è·å– CSRF Token"
[ -z "$csrf_token" ] && error_exit "CSRF Token ä¸ºç©º"
echo "[INFO] CSRF Token è·å–æˆåŠŸ"

# === 2. è·å– JWT Token ===
JWT=$(curl -k -s -X POST "${BASE_URL}/open/auth/login" \
     -H "Content-Type: application/json" \
     -d "{\"username\":\"${USERNAME}\",\"password\":\"${PASSWORD}\",\"csrf_token\":\"${csrf_token}\"}" | jq -r '.data.jwt') || error_exit "æ— æ³•è·å– JWT"
[ -z "$JWT" ] && error_exit "JWT Token ä¸ºç©º"
echo "[INFO] JWT Token è·å–æˆåŠŸ"

# === 3. è¯»å–è¯ä¹¦æ–‡ä»¶å’Œå¯†é’¥æ–‡ä»¶å†…å®¹ ===
[ -f "$CERT_FILE_PATH" ] || error_exit "è¯ä¹¦æ–‡ä»¶ ${CERT_FILE_PATH} ä¸å­˜åœ¨"
[ -f "$CERT_KEY_PATH" ] || error_exit "å¯†é’¥æ–‡ä»¶ ${CERT_KEY_PATH} ä¸å­˜åœ¨"

CERT_CONTENT=$(jq -sRr '.' < "$CERT_FILE_PATH") || error_exit "è¯»å–è¯ä¹¦æ–‡ä»¶å¤±è´¥"
KEY_CONTENT=$(jq -sRr '.' < "$CERT_KEY_PATH") || error_exit "è¯»å–å¯†é’¥æ–‡ä»¶å¤±è´¥"

echo "[INFO] è¯ä¹¦å’Œå¯†é’¥æ–‡ä»¶å·²è¯»å–"

# === 4. æ›´æ–°è¯ä¹¦ ===
UPDATE_PAYLOAD=$(jq -n \
    --arg cert "$CERT_CONTENT" \
    --arg key "$KEY_CONTENT" \
    --argjson type 2 \
    --argjson id $CERT_ID \
    '{
      manual: {
        crt: $cert,
        key: $key
      },
      type: $type,
      id: $id
    }')

result=$(curl -k -s -X POST "${BASE_URL}/open/cert" \
     -H "Authorization: Bearer ${JWT}" \
     -H "Content-Type: application/json" \
     -d "$UPDATE_PAYLOAD") || error_exit "è¯ä¹¦æ›´æ–°è¯·æ±‚å¤±è´¥"

# è§£æå¹¶åˆ¤æ–­ç»“æœ
err=$(echo "$result" | jq -r '.err')
msg=$(echo "$result" | jq -r '.msg')

if [ "$err" == "null" ]; then
    echo "[INFO] è¯ä¹¦æ›´æ–°æˆåŠŸ"
else
    echo "[ERROR] è¯ä¹¦æ›´æ–°å¤±è´¥: $msg"
fi
```

{% endfolding %}

`update_certs.sh` è„šæœ¬ä¸­åªéœ€è¦ä¿®æ”¹å‰é¢çš„å‚æ•°è¿è¡Œå³å¯.

æˆ‘å³å°† `fullchain.pem`, `privkey.pem` å’Œ `update_certs.sh` 3 ä¸ªæ–‡ä»¶å…¨éƒ¨æ”¾åœ¨äº† 1Panel æ¨é€è¯ä¹¦çš„ç›®å½•ä¸‹, ç°åœ¨åªéœ€è¦åœ¨ä¿®æ”¹ **1Panel** çš„è„šæœ¬å†…å®¹å³å¯:

```shell
./update_certs.sh
```

> **`sync_certs.sh` è„šæœ¬å·²ç»æ²¡ç”¨äº†, å› ä¸ºé€šè¿‡æ¥å£æ›´æ–°è¯ä¹¦å, WAF è‡ªå·±ä¼šå°†æ–°çš„è¯ä¹¦å†™å…¥ `opt/safeline/resources/nginx/certs/` ç›®å½•ä¸‹çš„ `cert_{id}.crt` å’Œ `cert_{id}.key`, æ‰€ä»¥å‰é¢éƒ½æ˜¯è¸©å‘è®°å½•.**

åç»­ä¼šè¾“å‡º [é€šè¿‡ acme.sh å°†è¯ä¹¦è‡ªåŠ¨éƒ¨ç½²åˆ° NAS å’Œ WAF](#NAS è‡ªåŠ¨éƒ¨ç½² HTTPS è¯ä¹¦).

### æ ¹æ®ç¯å¢ƒè‡ªåŠ¨åˆ‡æ¢ Hosts

> **å‰é¢å·²ç»ä½¿ç”¨ NPM å’Œ WAF å¹¶éƒ½å¼€å¯äº† HTTPS, è¿™èŠ‚æ‰€æœ‰çš„æ“ä½œéƒ½åœ¨è¿™ä¸ªå‰æä¸‹è¿›è¡Œ.**

æˆ‘çš„ç›®çš„æ˜¯ **æ ¹æ®ç½‘ç»œç¯å¢ƒè‡ªåŠ¨åˆ‡æ¢æ˜ å°„çš„ IP**, é€‚åº”åŠ¨æ€ç½‘ç»œç¯å¢ƒ, ä¿æŒç¨³å®šçš„è¿æ¥.

è§£å†³çš„é—®é¢˜æ˜¯åœ¨å¤–ç½‘é€šè¿‡å…¬ç½‘è®¿é—®å®¶é‡Œçš„æœåŠ¡, **åœ¨å®¶åˆ™ç›´æ¥æ˜ å°„åˆ°æŒ‡å®šçš„æœåŠ¡å™¨, é¿å…ä»å…¬ç½‘ç»•ä¸€åœˆå›æ¥**.

å…¶å®è¿™ä¸ªéœ€æ±‚åªä¼šç”¨åœ¨éœ€è¦éšèº«æºå¸¦çš„ MBP ä¸Š, æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ DNS æœåŠ¡æ¥å®ç°, ä½†é—®é¢˜æ˜¯éœ€è¦æ‰‹åŠ¨åˆ‡æ¢ DNS æœåŠ¡åœ°å€, å½“ç„¶ä¹Ÿæ˜¯å¯ä»¥å†™è„šæœ¬æ¥å®ç°è‡ªåŠ¨åŒ–çš„.

å¾—ç›Šäº `Surge` è¿™æ¬¾å¼ºå¤§çš„ç½‘ç»œè°ƒè¯•å·¥å…·, ä¸”æ”¯æŒè‡ªå®šä¹‰è„šæœ¬, æ‰€ä»¥æˆ‘ä¼šæ˜¯ç”¨ `Surge ` æ¥å®Œæˆè¿™æ ·å·¥ä½œ.

> å¦‚æœè·¯ç”±å™¨æ”¯æŒé…ç½® Hosts çš„è¯, ä¹Ÿæ˜¯ä¸€ç§æ–¹æ¡ˆ, é—®é¢˜æ˜¯ä¸æ”¯æŒæ³›åŸŸå:
>
> ![20241229154732_KHTUHwzv.webp](https://cdn.dong4j.site/source/image/20241229154732_KHTUHwzv.webp)

æˆ‘ä»¬é¦–å…ˆå¯¹é½ä¸€ä¸‹é¢—ç²’åº¦:

- NAS WebUI å±€åŸŸç½‘çš„åœ°å€ä¸º `http://192.168.31.3:5000`;

- åœ¨å…¬å¸é€šè¿‡ `nas.dong4j.tele:1234` æ¥è®¿é—® NAS çš„ WebUI;
- åœ¨å®¶è¿˜æ˜¯ä½¿ç”¨ `nas.dong4j.tele:1234` è®¿é—® NAS çš„ WebUI;

ä¸€ä¸ªç«™ç‚¹çš„æœåŠ¡å¯ä»¥é€šè¿‡å…¶ IP åœ°å€å’Œç«¯å£å·æ¥è¯†åˆ«, ç«¯å£å·ä¸èƒ½æ”¹çš„æƒ…å†µä¸‹å°±åªèƒ½ä¿®æ”¹åŸŸåæ‰€æ˜ å°„çš„ IP åœ°å€.

å‰é¢è¯´è¿‡æˆ‘ä¸ä¼šå°†æœåŠ¡åŸæœ¬çš„ç«¯å£æš´éœ²åˆ°å…¬ç½‘, ä¸ºäº†ä¿è¯å¤–ç½‘ç«¯å£ä¸æ”¹çš„æƒ…å†µä¸‹é€šè¿‡åŸŸåè®¿é—®å±€åŸŸç½‘å†…å…¶ä»–çš„æœåŠ¡(**ä½†æ˜¯ä¸Šè¿°éœ€æ±‚å¿…é¡»ä¿è¯ NPM æˆ– WAF çš„ HTTPS ç«¯å£ä¸è·¯ç”±å™¨ä¸Šé…ç½®çš„å¤–ç½‘ç«¯å£ä¸€è‡´**), æˆ‘ä»¬å¿…é¡»åœ¨è·¯ç”±å™¨åé¢æ·»åŠ ä¸€å±‚ä»£ç†.

æ¥ä¸‹æ¥æˆ‘ä»¬è¯¦ç»†æè¿°ä¸€ä¸‹ **NPM** å’Œ **WAF** å¦‚æœå®Œæˆä¸Šé¢çš„éœ€æ±‚.

å‡è®¾:

| æœåŠ¡å | IP            | ç«¯å£(HTTPS) |
| ------ | ------------- | ----------- |
| NPM    | 192.168.31.2  | 1234        |
| WAF    | 192.168.31.20 | 1234        |

#### NPM

NPM ç‰¹æ®Šä¸€ç‚¹å°±æ˜¯åœ¨å¯åŠ¨æ—¶å°†å°±å¿…é¡»ç¡®è®¤ HTTPS ç«¯å£å·, æ‰€ä»¥ä¸ºäº†èƒ½åœ¨å®¶ä¹Ÿèƒ½æ˜ å°„åˆ° NPM, å¿…é¡»ä¿è¯ NPM çš„ HTTPS ç«¯å£å’Œè·¯ç”±å™¨çš„è½¬å‘ç«¯å£ä¿æŒä¸€è‡´.

| å¤–ç½‘ç«¯å£ | è½¬å‘çš„ IP    | è½¬å‘çš„ç«¯å£ |
| -------- | ------------ | ---------- |
| 1234     | 192.168.31.2 | 1234       |

NPM ä»£ç†æœåŠ¡é…ç½®:

![20241229154732_rtZuyuZz.webp](https://cdn.dong4j.site/source/image/20241229154732_rtZuyuZz.webp)

ä¸Šè¿°é…ç½®ååº”è¯¥èƒ½é€šè¿‡ `https://nas.dong4j.tele:1234` è®¿é—® NAS çš„ WebUI äº†. è¿™æ˜¯åœ¨å¤–ç½‘çš„æƒ…å†µ, åœ¨å†…ç½‘ç¯å¢ƒä¸‹, æˆ‘ä»¬éœ€è¦ä¸º `*.dong4j.tele` è®¾ç½® Hosts, è®©å®ƒå…¨éƒ¨æ˜ å°„åˆ° NPM çš„ IP åœ°å€:

Surge é…ç½®:

```
*.dong4j.tele = 192.168.31.2
```

ä½¿ç”¨ **dig** æˆ– **ping** æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦ç”Ÿæ•ˆ(Surge éœ€è¦é…ç½®ä¸€ä¸‹æ‰èƒ½è·å–çœŸå®çš„ IP: è®¾ç½®-é€šç”¨-é«˜çº§: Always Real IP Hosts, åœ¨åˆ—è¡¨ä¸­æ·»åŠ  `*.dong4j.tele`, æˆ–è€…ç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶: General åˆ†ç»„ä¸‹çš„ always-real-ip é…ç½®):

```
$ dig nas.dong4j.tele

; <<>> DiG 9.10.6 <<>> nas.dong4j.tele
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 22000
;; flags: qr; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;nas.dong4j.tele.		IN	A

;; ANSWER SECTION:
nas.dong4j.tele.	30	IN	A	192.168.31.2

;; Query time: 1 msec
;; SERVER: 198.18.0.2#53(198.18.0.2)
;; WHEN: Thu Nov 21 14:30:34 CST 2024
;; MSG SIZE  rcvd: 64
```

è¿™æ ·æˆ‘ä»¬å°±å®Œæˆäº†æ•´ä¸ªé“¾è·¯:

![auto-switch-hosts.drawio.svg](https://cdn.dong4j.site/source/image/auto-switch-hosts.drawio.svg)

#### WAF

WAF çš„é…ç½®å¤§åŒå°å¼‚, ä¸ NPM ä¸åŒçš„åœ°æ–¹å°±æ˜¯å¯ä»¥é…ç½®å¤šä¸ªç«¯å£, åŒæ—¶ä¹Ÿéœ€è¦åœ¨è·¯ç”±å™¨ä¸Šé…ç½®å¯¹åº”çš„ç«¯å£è½¬å‘è§„åˆ™.

| å¤–ç½‘ç«¯å£ | è½¬å‘çš„ IP     | è½¬å‘çš„ç«¯å£ |
| -------- | ------------- | ---------- |
| 1234     | 192.168.31.20 | 1234       |

è·¯ç”±å™¨ä¸Šé…ç½®ç«¯å£è½¬å‘è§„åˆ™:

![20241229154732_Nxbk3ukT.webp](https://cdn.dong4j.site/source/image/20241229154732_Nxbk3ukT.webp)

WAF çš„ä»£ç†é…ç½®:

![20241229154732_bre3BT0s.webp](https://cdn.dong4j.site/source/image/20241229154732_bre3BT0s.webp)

ä¿®æ”¹ Surge é…ç½®:

```
*.dong4j.tele = 192.168.31.20
```

WAF çš„é…ç½®å°±å®Œæˆäº†.

#### è‡ªåŠ¨åˆ‡æ¢åŸŸåæ˜ å°„

æœ€åå°±æ˜¯ Surge å¦‚ä½•åŠ¨æ€ä¿®æ”¹ Hosts äº†, è¿™ä¸ªæœ‰å¤šç§å®ç°æ–¹å¼:

1. ä½¿ç”¨è„šæœ¬åŠ¨æ€ä¿®æ”¹ DNS æœåŠ¡å™¨: éœ€è¦æ¶è®¾ DNS æœåŠ¡å™¨, å›ºæ²¡æœ‰é‡‡ç”¨;

2. **ä½¿ç”¨è„šæœ¬åŠ¨æ€ä¿®æ”¹åŸŸåè§£æçš„ IP**: ç›®å‰ä½¿ç”¨çš„æ–¹æ¡ˆ;

3. ä½¿ç”¨æ¨¡å—åŠ¨æ€ä¿®æ”¹ Hosts æ˜ å°„: å¤‡ç”¨æ–¹æ¡ˆ;

   {% folding ğŸª¬ è™½ç„¶ä¸ç”¨, ä½†æ˜¯è®°å½•ä¸‹å¦‚ä½•å®ç° %}

   1. åˆ›å»ºä¸€ä¸ª `override-hosts.sgmodule` æ–‡ä»¶:

      ```
      #!name=Custom Hosts
      #!desc=åœ¨å®¶ä½¿ç”¨ä¸‹é¢çš„ hosts è¦†ç›–é»˜è®¤ hosts, ä¸åœ¨å®¶å°±ä½¿ç”¨é»˜è®¤ hosts (é»˜è®¤çš„ hosts ä¸è¦æ·»åŠ ç›¸å…³çš„æ˜ å°„)

      [Host]
      *.dong4j.tele = 192.168.31.2
      ```

   2. åœ¨ script èŠ‚ç‚¹ä¸‹æ·»åŠ é…ç½®:

      ```
      # æ ¹æ®å½“å‰ç½‘ç»œé‡å†™ Hosts é…ç½®
      network-changed = script-path=network-changed.js,type=event,event-name=network-changed
      ```

   3. åœ¨å½“å‰ç›®å½•ä¸‹æ·»åŠ  `network-changed.js`:

      ```javascript
      const name = "Custom Hosts";
      let home = ["wifi1", "wifi2", "wifi2"].includes($network.wifi.ssid);

      const getModuleStatus = new Promise((resolve) => {
        $httpAPI("GET", "v1/modules", null, (data) =>
          resolve(data.enabled.includes(name))
        );
      });

      getModuleStatus.then((enabled) => {
        if (home && !enabled) {
          //å®¶é‡Œ,æœªå¼€å¯æ¨¡å— => å¼€å¯
          $notification.post("Event", `å¼€å¯${name}æ¨¡å—`, "");
          enableModule(true);
        } else if (!home && enabled) {
          //ä¸æ˜¯å®¶é‡Œ,å¼€å¯äº†æ¨¡å— => å…³é—­
          $notification.post("Event", `å…³é—­${name}æ¨¡å—`, "");
          enableModule(false);
        } else {
          //å…¶ä»–æƒ…å†µ => é‡å¤è§¦å‘ => ç»“æŸè„šæœ¬
          $done();
        }
      });

      function enableModule(status) {
        $httpAPI("POST", "v1/modules", { [name]: status }, () => $done());
      }
      ```

   å…³é—­/å¼€å¯ WiFi å³å¯æŸ¥çœ‹æ•ˆæœ. **éœ€è¦æ³¨æ„çš„æ˜¯è¿™ç§æ–¹å¼ä¼˜å…ˆçº§é«˜äºç¬¬äºŒç§**

   {% endfolding %}

4. ä½¿ç”¨ [Surge ponte](https://community.nssurge.com/d/1612-dns-ssid/12): éœ€è¦é¢å¤–çš„ Mac ç¡¬ä»¶, æœ‰æ—¶é—´å†æŠ˜è…¾ä¸€ä¸‹, åº”è¯¥ä¼šæ˜¯æœ€ç®€å•çš„æ–¹å¼;

æˆ‘æ‰€éœ€è¦çš„å°±æ˜¯ç®€å•çš„ä¿®æ”¹ Hosts çš„æ˜ å°„å…³ç³», æ‰€ä»¥æˆ‘é‡‡ç”¨ç¬¬äºŒç§æ–¹æ¡ˆ, å…·ä½“é…ç½®å¦‚ä¸‹:

1. åœ¨ script èŠ‚ç‚¹ä¸‹æ·»åŠ é…ç½®:

   ```
   # ä½¿ç”¨è„šæœ¬ä»£æ›¿ DNS è§£æ
   dns dnspod script-path=dnspod.js,debug=true
   ```

2. åœ¨å½“å‰ç›®å½•ä¸‹æ·»åŠ  `dnspod.js`:

   ```javascript
   let home =
     $network.wifi.ssid === "wifi ssid1" || $network.wifi.ssid === "wifi ssid2";

   if (home) {
     $done({ address: "192.168.31.2" });
   } else {
     $httpClient.get(
       "http://119.29.29.29/d?dn=" + $domain,
       function (error, response, data) {
         if (error) {
           $done({});
         } else {
           $done({ addresses: data.split(";"), ttl: 600 });
         }
       }
     );
   }
   ```

3. ä¿®æ”¹ Surge Hosts é…ç½®:

   ```
   *.dong4j.tele = script:dnspod
   ```

4. å¼€å¯ WiFi, è®¿é—®ä¸€ä¸‹ `https://nas.dong4j.tele:1234` :

   ![20241229154732_nqMYDA7Y.webp](https://cdn.dong4j.site/source/image/20241229154732_nqMYDA7Y.webp)

`*.dong4j.tele` çš„ DNS æœåŠ¡å™¨å·²è¢«æˆåŠŸä¿®æ”¹ä¸º `dnspod`.

è„±ç¦» Surge, ä½ å¯ä»¥å†™å…¶ä»–è„šæœ¬æ¥å®Œæˆä¸Šè¿°éœ€æ±‚, æ¯”å¦‚:

- å½“ç½‘ç»œå‘ç”Ÿå˜æ›´æ—¶, æ‰§è¡Œè„šæœ¬ç›´æ¥ä¿®æ”¹ Surge Hosts çš„é…ç½®, ç„¶åä½¿ç”¨ [Surge CLI é‡è½½é…ç½®](https://manual.nssurge.com/others/cli.html) (é€šå¸¸ Surge ä¼šåœ¨æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶æ”¹åŠ¨åè‡ªåŠ¨é‡è½½);

### å†…éƒ¨æœåŠ¡ä½¿ç”¨ HTTPS è®¿é—®

ä¸€äº›ç‰¹æ®Šçš„åœºæ™¯ä¸‹éœ€è¦é€šè¿‡ HTTPS è®¿é—®å†…éƒ¨æœåŠ¡, æ¯”å¦‚ Bitwarden, æœ¬åœ°éƒ¨ç½²çš„ LLM æä¾›çš„ OpenAI API ç­‰, å¦ä¸€ä¸ªå°±æ˜¯å¼€å‘åœºæ™¯.

æœ‰ä¸€äº›å¼€æºé¡¹ç›®å¯ä»¥ç›´æ¥ä½¿ç”¨:

- [nip.io](https://nip.io/)
- [localtls](https://github.com/Corollarium/localtls)
- [sslip.io](https://sslip.io/)

è¿™é‡Œé€‰æ‹©ç›¸å¯¹æ¥è¯´æ¯”è¾ƒç®€å•çš„æ–¹å¼æ¥å®ç°å†…ç½‘ HTTPS è®¿é—®.

#### mkcert çš„å®‰è£…ä¸ä½¿ç”¨

```shell
# å®‰è£…
brew install mkcert

# æŒ‡å®šæ ¹è¯ä¹¦å­˜å‚¨è·¯å¾„
export CAROOT=/Users/dong4j/Synology/driver/NAS/Certs/mkcert
# å®‰è£…æœ¬åœ° CA æ ¹è¯ä¹¦
mkcert -install
# ä¸ºåŸŸåç”Ÿæˆè¯ä¹¦
mkcert "*.nas.tele" localhost 127.0.0.1 ::1
```

å› ä¸º HTTPS è¯ä¹¦åªåªæ”¯æŒäºŒçº§ä»¥ä¸Šçš„æ³›åŸŸå, æ‰€ä»¥è¿™é‡Œä½¿ç”¨çš„æ˜¯ `*.nas.tele`.

ç”Ÿæˆçš„è¯ä¹¦åœ¨ `/Users/dong4j/Synology/driver/NAS/Certs/mkcert` ç›®å½•ä¸‹:

```
$ mkcert "*.nas.tele" localhost 127.0.0.1 ::1

Created a new certificate valid for the following names ğŸ“œ
 - "*.nas.tele"
 - "localhost"
 - "127.0.0.1"
 - "::1"

Reminder: X.509 wildcards only go one level deep, so this won't match a.b.nas.tele â„¹ï¸
The certificate is at "./_wildcard.nas.tele+3.pem" and the key at "./_wildcard.nas.tele+3-key.pem" âœ…
It will expire on 21 February 2027 ğŸ—“
```

åœ¨ NPM ä¸Šæ‰‹åŠ¨æ·»åŠ è¯ä¹¦:

![20241229154732_XTrBTuwO.webp](https://cdn.dong4j.site/source/image/20241229154732_XTrBTuwO.webp)

æ·»åŠ ä¸€ä¸ªç«™ç‚¹:

![20241229154732_2Mb1tQ8V.webp](https://cdn.dong4j.site/source/image/20241229154732_2Mb1tQ8V.webp)

é…ç½® HTTPS:

![20241229154732_8bCIWdPO.webp](https://cdn.dong4j.site/source/image/20241229154732_8bCIWdPO.webp)

Surge é…ç½®:

```
*.tele = 192.168.31.10
```

æœ€ç»ˆæ•ˆæœ:

![20241229154732_CAYly5vr.webp](https://cdn.dong4j.site/source/image/20241229154732_CAYly5vr.webp)

å‚è€ƒ:

- [ä¸º Homelab ç¯å¢ƒåˆ›å»ºè‡ªå·±çš„è¯ä¹¦é¢å‘æœºæ„ (CA)](https://support.tools/create-certificate-authority-homelab/)
- [ä½¿ç”¨ mkcert å·¥å…·ç”Ÿæˆå—ä¿¡ä»»çš„ SSL è¯ä¹¦, è§£å†³å±€åŸŸç½‘æœ¬åœ° https è®¿é—®é—®é¢˜](https://cloud.tencent.com/developer/article/2191830)
- [æ•™ä½ ç§’å»ºå—ä¿¡ä»»çš„æœ¬åœ° SSL è¯ä¹¦, å½»åº•è§£å†³å¼€å‘æµ‹è¯•ç¯å¢ƒçš„æ— æ•ˆè¯ä¹¦è­¦å‘Šçƒ¦æ¼ï¼](https://cloud.tencent.com/developer/article/1514003)
- [SSL ä¹‹ mkcert æ„å»ºæœ¬åœ°è‡ªç­¾è¯ä¹¦,æ•´åˆ SpringBoot3](https://cloud.tencent.com/developer/article/2379654)

### ä¸æš´éœ²æœåŠ¡åˆ°å…¬ç½‘

ä¸ºäº†å‡å°‘ç½‘ç»œå®‰å…¨é—®é¢˜, å¯ä»¥ä¸å°†å†…ç½‘æœåŠ¡æš´éœ²åˆ°å…¬ç½‘, åªåœ¨å±€åŸŸç½‘ç¯å¢ƒä½¿ç”¨. é‚£ä¹ˆè¿™ç§æƒ…å†µä¸‹, æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ **VPN** çš„æ–¹å¼è®¿é—®å®¶ä¸­çš„è®¾å¤‡å’ŒæœåŠ¡.

ç›®å‰å®¶ç”¨æ¯”è¾ƒæµè¡Œçš„æœ‰ [Tailscale](https://tailscale.com/) å’Œ [ZeroTier](https://www.zerotier.com/), ç„¶åå¦é€‰äº†å‡ ä¸ªç«å“åšäº†å¯¹æ¯”:

#### åŠŸèƒ½å¯¹æ¯”

| **ç‰¹æ€§**           | [Tailscale](https://tailscale.com/) | [Headscale](https://github.com/juanfont/headscale) | [ZeroTier](https://www.zerotier.com/) | [NetBird](https://netbird.io/) | [Netmaker](https://www.netmaker.io/) |
| ------------------ | ----------------------------------- | -------------------------------------------------- | ------------------------------------- | ------------------------------ | ------------------------------------ |
| **ç±»å‹**           | å•†ä¸šå·¥å…·, å…è´¹è®¡åˆ’å¯ç”¨              | è‡ªæ‰˜ç®¡çš„ Tailscale æ›¿ä»£                            | å•†ä¸šå·¥å…·, ç¤¾åŒºå…è´¹è®¡åˆ’å¯ç”¨            | å¼€æºå·¥å…·, è‡ªæ‰˜ç®¡               | å¼€æºå·¥å…·, è‡ªæ‰˜ç®¡                     |
| **åè®®**           | WireGuard                           | WireGuard                                          | è‡ªå®šä¹‰åè®®                            | WireGuard                      | WireGuard                            |
| **P2P æ”¯æŒ**       | æ˜¯                                  | æ˜¯                                                 | æ˜¯                                    | æ˜¯                             | æ˜¯                                   |
| **éœ€è¦å…¬ç½‘æœåŠ¡å™¨** | å¯é€‰                                | æ˜¯                                                 | å¯é€‰                                  | æ˜¯                             | æ˜¯                                   |
| **å†…ç½‘ç©¿é€èƒ½åŠ›**   | å¼º                                  | å¼º                                                 | å¼º                                    | å¼º                             | å¼º                                   |
| **å¹³å°æ”¯æŒ**       | å…¨å¹³å°                              | å…¨å¹³å° (ä¸ Tailscale ç±»ä¼¼)                         | å…¨å¹³å°                                | å…¨å¹³å°                         | å…¨å¹³å°                               |
| **ç”¨æˆ·ç•Œé¢**       | å›¾å½¢åŒ–                              | CLI                                                | å›¾å½¢åŒ–                                | å›¾å½¢åŒ–                         | å›¾å½¢åŒ–å’Œ CLI                         |
| **å¼€æº**           | éƒ¨åˆ†å¼€æº (å®¢æˆ·ç«¯é—­æº)               | å¼€æº                                               | éƒ¨åˆ†å¼€æº                              | å¼€æº                           | å¼€æº                                 |

{% folding ğŸª¬ ä¼˜åŠ¿ä¸åŠ£åŠ¿ %}

##### Tailscale

- **ä¼˜åŠ¿**:
  - ä½¿ç”¨ WireGuard, æä¾›é«˜æ•ˆã€ä½å»¶è¿Ÿçš„åŠ å¯†é€šä¿¡.
  - ç®€å•æ˜“ç”¨, å‡ ä¹é›¶é…ç½®, é€‚åˆéæŠ€æœ¯ç”¨æˆ·.
  - æ”¯æŒç»†ç²’åº¦è®¿é—®æ§åˆ¶ (ACL) .
  - æä¾›å…è´¹è®¡åˆ’, å¯æ»¡è¶³å°å‹ HomeLab çš„éœ€æ±‚.
  - å†…ç½® NAT ç©¿é€, é€‚ç”¨äºå¤æ‚ç½‘ç»œç¯å¢ƒ.
- **åŠ£åŠ¿**:
  - ä¾èµ– Tailscale å®˜æ–¹æ§åˆ¶æœåŠ¡å™¨ (å¯é€šè¿‡ Headscale æ›¿ä»£) .
  - å®¢æˆ·ç«¯é—­æº, éƒ¨åˆ†ç”¨æˆ·å¯èƒ½æœ‰éšç§é¡¾è™‘.

##### **Headscale**

- **ä¼˜åŠ¿**:
  - å¼€æºçš„è‡ªæ‰˜ç®¡ç‰ˆæœ¬ Tailscale æ§åˆ¶æœåŠ¡å™¨, å®Œå…¨å…è´¹.
  - ä¿ç•™ Tailscale çš„æ ¸å¿ƒåŠŸèƒ½, å¦‚ NAT ç©¿é€å’Œ ACL.
  - æ•°æ®å®Œå…¨æœ¬åœ°æŒæ§, é€‚åˆæ³¨é‡éšç§çš„ç”¨æˆ·.
- **åŠ£åŠ¿**:
  - æ— å›¾å½¢åŒ–ç•Œé¢, éœ€è¦é€šè¿‡ CLI æˆ– API ç®¡ç†.
  - è‡ªæ‰˜ç®¡å’Œè¿ç»´é—¨æ§›è¾ƒé«˜, ä¸é€‚åˆå°ç™½ç”¨æˆ·.

##### **ZeroTier**

- **ä¼˜åŠ¿**:
  - è‡ªå®šä¹‰åè®®, æ€§èƒ½ä¼˜ç§€ä¸”å¯é .
  - æ”¯æŒé«˜çº§ç½‘ç»œåŠŸèƒ½, å¦‚ SD-WAN å’Œå¤šæ’­.
  - å›¾å½¢åŒ–ç•Œé¢å‹å¥½, é€‚åˆå°ç™½å’Œä¸­å°ä¼ä¸š.
  - ç¤¾åŒºå…è´¹è®¡åˆ’å¯æ»¡è¶³ä¸ªäººå’Œå°å‹å›¢é˜Ÿéœ€æ±‚.
- **åŠ£åŠ¿**:
  - éƒ¨åˆ†æ ¸å¿ƒé—­æº.
  - åŠ å¯†æ€§èƒ½ç•¥é€Šäº WireGuard.

##### **NetBird**

- **ä¼˜åŠ¿**:
  - å®Œå…¨å¼€æº, åŸºäº WireGuard æä¾›é«˜æ•ˆåŠ å¯†é€šä¿¡.
  - ç±»ä¼¼ Tailscale, æ›´ä¸“æ³¨äºè‡ªæ‰˜ç®¡å’Œéšç§.
  - æ”¯æŒ NAT ç©¿é€, é€‚åˆè·¨ç½‘ç»œè®¾å¤‡é€šä¿¡.
- **åŠ£åŠ¿**:
  - åŠŸèƒ½ç›¸è¾ƒ Tailscale ç•¥å¼±, ç”¨æˆ·ç¤¾åŒºè¾ƒå°.
  - ç®¡ç†å·¥å…·å’Œæ–‡æ¡£ä¸å¤Ÿæˆç†Ÿ.

##### **Netmaker**

- **ä¼˜åŠ¿**:
  - å®Œå…¨å¼€æº, æ”¯æŒ WireGuard, æ€§èƒ½å¼ºå¤§ä¸”çµæ´».
  - æ”¯æŒè·¨äº‘å’Œè·¨ç½‘ç»œçš„å¤§è§„æ¨¡éƒ¨ç½².
  - æä¾›ä¼ä¸šçº§ VPN æœåŠ¡åŠŸèƒ½.
- **åŠ£åŠ¿**:
  - é…ç½®è¾ƒå¤æ‚, ä¸é€‚åˆéæŠ€æœ¯ç”¨æˆ·.
  - è‡ªåŠ¨ DNS å’ŒæœåŠ¡å‘ç°åŠŸèƒ½éœ€è¦æ‰‹åŠ¨è®¾ç½®.

#### é€‚ç”¨åœºæ™¯

| **åœºæ™¯**               | **æ¨èå·¥å…·**                   | **ç†ç”±**                                                                  |
| ---------------------- | ------------------------------ | ------------------------------------------------------------------------- |
| **HomeLab æˆ–ä¸ªäººä½¿ç”¨** | Tailscale / Headscale          | ç®€å•æ˜“ç”¨, é›¶é…ç½®, æ”¯æŒ ACL, é€‚åˆè·¨è®¾å¤‡ã€è·¨ç½‘ç»œçš„è½»é‡çº§ä½¿ç”¨åœºæ™¯.           |
| **æ³¨é‡éšç§ä¸è‡ªæ‰˜ç®¡**   | Headscale / NetBird / Netmaker | å¼€æºå·¥å…·, æ•°æ®å®Œå…¨æŒæ§åœ¨æœ¬åœ°.                                             |
| **ä¼ä¸šçº§åˆ†å¸ƒå¼ç½‘ç»œ**   | ZeroTier / Netmaker            | ZeroTier æä¾›å¼ºå¤§çš„ä¼ä¸šåŠŸèƒ½, Netmaker é€‚åˆéœ€è¦è‡ªæ‰˜ç®¡å’Œè·¨äº‘ç¯å¢ƒçš„ä¼ä¸šåœºæ™¯. |
| **éœ€è¦å›¾å½¢åŒ–ç®¡ç†**     | Tailscale / ZeroTier / NetBird | å›¾å½¢ç•Œé¢ä¾¿äºç®¡ç†, é€‚åˆç”¨æˆ·è§„æ¨¡ä¸å¤§çš„å›¢é˜Ÿæˆ–ä¸ªäºº.                           |
| **å¼€æºç¤¾åŒºæ”¯æŒ**       | Headscale / NetBird / Netmaker | ä»¥å¼€æºä¸ºä¸», ç¤¾åŒºæ´»è·ƒ, é€‚åˆå¼€å‘è€…å’ŒæŠ€æœ¯çˆ±å¥½è€….                             |
| **è·¨å¤æ‚ç½‘ç»œé€šä¿¡**     | Tailscale / ZeroTier / NetBird | å†…ç½® NAT ç©¿é€, è§£å†³å¤æ‚ç½‘ç»œç¯å¢ƒä¸‹çš„è¿æ¥é—®é¢˜.                              |

#### æ€»ç»“

- **Tailscale** å’Œ **Headscale**: é€‚åˆè½»é‡åŒ–å’Œä¸ªäººä½¿ç”¨, å°¤å…¶æ˜¯ HomeLab ç”¨æˆ·.
- **ZeroTier**: é€‚åˆä¸­å°ä¼ä¸šå’Œå¯¹é«˜çº§ç½‘ç»œåŠŸèƒ½æœ‰éœ€æ±‚çš„ç”¨æˆ·.
- **NetBird** å’Œ **Netmaker**: æ›´é€‚åˆè‡ªæ‰˜ç®¡å’Œéšç§æ•æ„Ÿç”¨æˆ·, Netmaker åœ¨å¤§è§„æ¨¡éƒ¨ç½²åœºæ™¯è¡¨ç°ä¼˜å¼‚.

{% endfolding %}

å°è¯•è¿‡ **ZeroTier** å¹¶è‡ªå»ºæ ¹æœåŠ¡å™¨å, æ„Ÿè§‰è¿˜æ˜¯æ²¡æœ‰ç›´æ¥ä½¿ç”¨ WireGuard æ¥çš„æ–¹ä¾¿, æ‰€ä»¥ä¸Šè¿°æ„å»ºè™šæ‹Ÿå±€åŸŸç½‘çš„æ–¹æ¡ˆå…¨éƒ¨æ”¾å¼ƒäº†, æ”¹ç”¨æœ€åŸå§‹çš„ [WireGuard æ¥å®Œæˆ VPN æ­å»ºå·¥ä½œ](#WireGuard).

å‚è€ƒ:

- [æ›´é€‚åˆå›½å†…çš„è¿œç¨‹è®¿é—®æ–¹æ³•: è‡ªå»ºæ ¹æœåŠ¡å™¨æ‰“é€ åŸºäº ZeroTier è™šæ‹Ÿå†…ç½‘ - å°‘æ•°æ´¾](https://sspai.com/post/85130)
- [GitHub - xubiaolin/docker-zerotier-planet: ä¸€åˆ†é’Ÿç§æœ‰éƒ¨ç½² zerotier-planet æœåŠ¡](https://github.com/xubiaolin/docker-zerotier-planet)

### ä¸´æ—¶æš´éœ²æœåŠ¡åˆ°å…¬ç½‘

æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹å¯èƒ½éœ€è¦å°†æœåŠ¡æš´éœ²ç»™å…¶ä»–äººä½¿ç”¨. æœ‰å¯èƒ½å†…éƒ¨æœåŠ¡ä¸æ˜¯å…¨éƒ¨éƒ½æœ‰è®¤è¯æˆæƒåŠŸèƒ½, å¯ä»¥ä½¿ç”¨ **WAF** çš„ **èº«ä»½è®¤è¯åŠŸèƒ½** (**NPM** ä¹Ÿæœ‰ç›¸å…³åŠŸèƒ½) ä¸ºæœåŠ¡åŠ ä¸Šä¸€å±‚æœ€åŸºç¡€çš„ä¿æŠ¤:

![20241229154732_FjMnMZWz.webp](https://cdn.dong4j.site/source/image/20241229154732_FjMnMZWz.webp)

### æ™ºèƒ½å®¶å±…è®¾å¤‡ç½‘ç»œéš”ç¦»

æ¨èé˜…è¯»ä¸€ä¸‹: [æ™ºèƒ½å®¶å±…è®¾å¤‡ä¼šå¸¦æ¥å“ªäº›å®‰å…¨æ€§é—®é¢˜?](https://sspai.com/post/69223)

æˆ‘æƒ³è¿‡ä½¿ç”¨ VLAN æ¥éš”ç¦»æ™ºèƒ½è®¾å¤‡, ä½†æ˜¯ç›®å‰è¿˜æ²¡æœ‰ç¡¬ä»¶æ¡ä»¶, ä¹Ÿæ²¡æœ‰æ—¶é—´è°ƒæ•´ç›®å‰çš„ç½‘ç»œæ¶æ„, ä¹Ÿè®¸ç­‰åé¢è§„åˆ’å¥½äº† v2.0 ç‰ˆæœ¬å†æ¥æ°´ä¸€ç¯‡æ–‡ç« .

ç†æƒ³ä¸­çš„åº”è¯¥æ˜¯ [UniFi](https://ui.com/us/zh/introduction) å…¨å®¶æ¡¶ + ç‹¬ç«‹æœºæ¶ + ä¸‡å…†å†…ç½‘.

<!--

æ²¡æœ‰æˆåŠŸæ˜¾ç¤ºè§†é¢‘

{% folding ğŸª¬ UniFi è§†é¢‘ %}

{% dplayer "url=/videos/2.mp4" "pic=/videos/UniFi-1.png" %}

{% endfolding %}

{% dplayer "url=/videos/2.mp4" "pic=/videos/UniFi-1.png" %}

-->

---

## å¹¿å‘Šè¿‡æ»¤

### Surge

å› ä¸ºä¸»è¦è®¾å¤‡éƒ½æ˜¯ Apple ç¡¬ä»¶, ä¸”éƒ½å®‰è£…äº† Surge, å¯ä»¥æ–¹ä¾¿çš„é€šè¿‡ Surge å»è¿‡æ»¤ç»å¤§å¤šæ•°å¹¿å‘Š, ä¸”å¹¿å‘Šè§„åˆ™å¯è‡ªåŠ¨æ›´æ–°, æˆ‘ç›®å‰ä½¿ç”¨çš„æ˜¯ [blackmatrix7/ios_rule_script](https://github.com/blackmatrix7/ios_rule_script) è¿™ä¸ªå¼€æºé¡¹ç›®, é‡Œé¢çš„è§„åˆ™é›†éå¸¸å…¨é¢.

### AdGuard Home

å…¶ä»–è®¾å¤‡ä¸Šçš„å¹¿å‘Šåˆ™å¯ä»¥é€šè¿‡å¹¿å‘Šè¿‡æ»¤æœåŠ¡æ¥é›†ä¸­å¤„ç†. æ¯”è¾ƒä¸»æµçš„å¹¿å‘Šè¿‡æ»¤æœåŠ¡æœ‰ [AdGuard Home](https://adguard.com/zh_cn/adguard-home/overview.html) å’Œ [Pi-hole](https://pi-hole.net/) , åè€…åœ¨å›½å¤–æ¯”è¾ƒæµè¡Œ, ç›®å‰æˆ‘åœ¨ 2 å° R2S ä¸Šéƒ¨ç½²äº† **AdGuard Hom**e, åˆ†åˆ«ä¸ºç”µä¿¡å’Œè”é€šç½‘ç»œæä¾›å¹¿å‘Šè¿‡æ»¤æœåŠ¡.

![20241229154732_DQKzhLN1.webp](https://cdn.dong4j.site/source/image/20241229154732_DQKzhLN1.webp)

**AdGuard Home** åŒæ ·æä¾›æ‰‹æœºå®¢æˆ·ç«¯.

å› ä¸ºæ˜¯æ—è·¯ç”±æ¨¡å¼, æ‰€ä»¥éœ€è¦æ‰‹åŠ¨ä¸ºå®¢æˆ·ç«¯è®¾ç½®ç½‘å…³å’Œ DNS:

![20241229154732_h2bCQiKN.webp](https://cdn.dong4j.site/source/image/20241229154732_h2bCQiKN.webp)

å°†è·¯ç”±å™¨å’Œ DNS æœåŠ¡å™¨å…¨éƒ¨è®¾ç½®ä¸º **AdGuard Home** æ‰€åœ¨æœåŠ¡å™¨çš„ IP.

---

## å¤–ç½‘è®¿é—®å®¶åº­ç½‘ç»œ

åœ¨å¼€å§‹è¿™ç« ä¹‹å‰, æœ‰å¿…è¦äº†è§£ä¸€ä¸‹ [[nat-guide|NAT (Network Address Translation)]] <!-- é“¾æ¥ç«™å†…æ–‡ç« , ä½¿ç”¨æ–‡ä»¶å, ä¸è¦åç¼€ -->

### WireGuard VPN

<!--

ç®€å•ä»‹ç»ä¸€ä¸‹, å¹¶è¿›è¡Œå¯¹æ¯”, æœ€å¥½æœ‰ä¸ªè®¨è®ºé“¾æ¥ æˆ‘è®°å¾—
[WireGuard + Surge å¼‚åœ°ç»„ç½‘å®è·µ](https://nxw.name/2023/wireguard)
[WireGuard çš„æ­å»ºä½¿ç”¨ä¸é…ç½®è¯¦è§£](https://icloudnative.io/posts/wireguard-docs-practice/)
[WireGuard æ•™ç¨‹: WireGuard çš„æ­å»ºä½¿ç”¨ä¸é…ç½®è¯¦è§£](https://www.msl.la/archives/248/)
[WireGuardç¬”è®°(ä¸€) èŠ‚ç‚¹å®‰è£…é…ç½®å’Œå‚æ•°è¯´æ˜](https://www.cnblogs.com/milton/p/14178344.html)
[Ubuntu çš„ WireGuard æ•™ç¨‹](https://documentation.ubuntu.com/server/how-to/wireguard-vpn/peer-to-site/)
[Openwrt ä¸‹é…ç½® WireGuard](https://www.ioiox.com/archives/143.html)
[Openwrtä½¿ç”¨wireguardå®ç°å¼‚åœ°ç»„ç½‘](https://blog.xianyu.one/2023/02/08/wireguard-connect/)
[WireGuard VPN æœåŠ¡å™¨è‡ªåŠ¨è®¾ç½®è„šæœ¬](https://github.com/hwdsl2/wireguard-install)
[macOS ä¸Šé…ç½®](https://docs.oakhost.net/tutorials/wireguard-macos-server-vpn/)
[å¦ä¸€ç¯‡å›½å¤–çš„ macOS é…ç½®](https://barrowclift.me/articles/wireguard-server-on-macos)
-->

#### ä¼ ç»Ÿçš„ VPN æ–¹æ¡ˆ

##### OpenVPN

![20241229154732_np8YDoTV.webp](https://cdn.dong4j.site/source/image/20241229154732_np8YDoTV.webp)

**OpenVPN** æ˜¯ä¸€ç§çƒ­é—¨ä¸”é«˜åº¦å®‰å…¨çš„åè®®, è®¸å¤š VPN æä¾›å•†éƒ½ä½¿ç”¨è¿™ç§åè®®. å®ƒè¿è¡Œåœ¨ TCP æˆ– UDP äº’è”ç½‘å®‰å…¨åè®®ä¸Š. TCP èƒ½ç¡®ä¿æ•°æ®ä»¥æ­£ç¡®çš„é¡ºåºå®Œæ•´ä¼ è¾“, è€Œ UDP åˆ™ä¸“æ³¨äºæ›´å¿«çš„é€Ÿåº¦.

**ä¼˜ç‚¹**

- **å¼€æ”¾æºç , **è¿™è¡¨ç¤ºä»£ç æ˜¯å…¬å¼€çš„. ä»»ä½•äººéƒ½å¯ä»¥æ£€æŸ¥ä»£ç ä¸­æ˜¯å¦å­˜åœ¨å¯èƒ½å±åŠ VPN å®‰å…¨çš„éšè—åé—¨æˆ–æ¼æ´;
- **å¤šåŠŸèƒ½æ€§. **è¿™ç§åè®®èƒ½ä¸ä¸€ç³»åˆ—ä¸åŒçš„åŠ å¯†å’Œæµé‡åè®®ä¸€èµ·ä½¿ç”¨, å¯ä»¥é’ˆå¯¹ä¸åŒçš„ç”¨é€”è¿›è¡Œé…ç½®, ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œå®‰å…¨æˆ–è½»é‡çš„é…ç½®;
- **å®‰å…¨æ€§. **èƒ½æ­é…å„ç§åŠ å¯†åè®®, å› æ­¤éå¸¸å®‰å…¨;
- **ç»•è¿‡å¤šæ•°é˜²ç«å¢™**: OpenVPN, å°±èƒ½å¤Ÿè½»æ¾ç»•è¿‡é˜²ç«å¢™;

**ç¼ºç‚¹**

- **è®¾ç½®å¤æ‚**: å¤šåŠŸèƒ½æ€§æ„å‘³ç€å¦‚æœå¤šæ•°ç”¨æˆ·è¯•å›¾å»ºç«‹è‡ªå·±çš„ OpenVPN, ä»–ä»¬å¯èƒ½ä¼šå› ä¸ºå¤æ‚æ€§è€Œéš¾ä»¥è®¾ç½®.

å°†ç”¨æ²¡å¿…è¦ä¸Š **é‡é‡çº§çš„(ç›¸å¯¹ WireGuard æ¥è¯´)** çš„ OpenVPN, ä¸“æ³¨ä¸»è¦åŠŸèƒ½å³å¯.

##### L2TP/IPsec

![20241229154732_cZGNZPoV.webp](https://cdn.dong4j.site/source/image/20241229154732_cZGNZPoV.webp)

L2TP (Layer 2 Tunneling Protocol) å’Œ IPSec (Internet Protocol Security) æ˜¯ä¸¤ç§ç½‘ç»œåè®®, ç»å¸¸ç»„åˆä½¿ç”¨ä»¥æä¾›å®‰å…¨çš„ VPN (è™šæ‹Ÿä¸“ç”¨ç½‘ç»œ) è¿æ¥:

- **L2TP** ç”¨äºå»ºç«‹éš§é“ (Tunneling) , å°†æ•°æ®å°è£…åœ¨ VPN éš§é“ä¸­ä¼ è¾“.
- **IPSec** ç”¨äºåŠ å¯†å’ŒéªŒè¯æ•°æ®åŒ…, ç¡®ä¿æ•°æ®çš„å®‰å…¨æ€§å’Œå®Œæ•´æ€§.

è¿™ç§ç»„åˆæ–¹å¼è¢«ç§°ä¸º **L2TP/IPsec**, æ˜¯ä¸€ç§å¸¸è§çš„ VPN åè®®, ç”¨äºåœ¨å…¬å…±ç½‘ç»œ (ä¾‹å¦‚äº’è”ç½‘) ä¸Šä¼ è¾“æ•æ„Ÿæ•°æ®, éœ€è¦å ç”¨ 3 ä¸ªç«¯å£:

- ä½¿ç”¨ **UDP 500** å’Œ **4500** (NAT ç©¿è¶Š) è¿›è¡Œå¯†é’¥äº¤æ¢ (IKE åè®®) .
- L2TP ä½¿ç”¨ **UDP 1701** ç«¯å£è¿›è¡Œé€šä¿¡.

**ä¼˜ç‚¹**

- **å®‰å…¨æ€§**: L2TP æ ¹æœ¬ä¸æä¾›ä»»ä½•å®‰å…¨æ€§, ä½†å´ç›¸å½“å®‰å…¨. è¿™æ˜¯å› ä¸ºå®ƒèƒ½æ­é…å„ç§åŠ å¯†åè®®, ä½¿åè®®æŒ‰éœ€è¦å˜å¾—æ›´å®‰å…¨æˆ–è½»é‡.
- **å¹¿æ³›å¯ç”¨**: L2TP åœ¨å‡ ä¹é€‚ç”¨äºæ‰€æœ‰æ“ä½œç³»ç»Ÿ, è¿™ä»£è¡¨ç®¡ç†å‘˜èƒ½è½»æ˜“æ‰¾åˆ°æ”¯æŒå¹¶ä½¿å…¶è¿è¡Œ.

**ç¼ºç‚¹**

- **å¯èƒ½å·²è¢«ç¾å›½å›½å®¶å®‰å…¨å±€ (NSA) ç ´è§£**: ä¸ IKEv2 ä¸€æ ·, L2TP é€šå¸¸ä¸ IPsec æ­é…ä½¿ç”¨, å› æ­¤å®ƒä¹Ÿå­˜åœ¨å‰é¢æåˆ°çš„æ¼æ´.
- **é€Ÿåº¦æ…¢**: è¯¥åè®®å°è£…æ•°æ®ä¸¤æ¬¡, è¿™ç§æ–¹æ³•å¯¹æŸäº›åº”ç”¨ç¨‹åºå¾ˆæœ‰ç”¨, ä½†ä¸åªå°è£…æ•°æ®ä¸€æ¬¡çš„å…¶ä»–åè®®ç›¸æ¯”, é€Ÿåº¦è¾ƒæ…¢.
- **æ— æ³•ç»•è¿‡é˜²ç«å¢™**: ä¸å…¶ä»– VPN åè®®ä¸åŒ, L2TP æ²¡æœ‰å…¶ä»–æ–¹æ³•æ¥ç©¿è¿‡é˜²ç«å¢™. é¢å‘ç›‘è§†çš„ç³»ç»Ÿç®¡ç†å‘˜ä½¿ç”¨é˜²ç«å¢™æ¥å°é” VPN, è€Œè‡ªè¡Œè®¾ç½® L2TP çš„äººå¾ˆå®¹æ˜“è¢«å°é”.

##### IKEv2/IPsec

![20241229154732_8IBikwmw.webp](https://cdn.dong4j.site/source/image/20241229154732_8IBikwmw.webp)

**IKEv2 (Internet Key Exchange version 2) ** æ˜¯ä¸€ç§æä¾›å®‰å…¨å¯†é’¥äº¤æ¢ä¼šè¯çš„éš§é“åè®®, è¯¥åè®®æ˜¯å¾®è½¯å’Œæ€ç§‘åˆä½œçš„æˆæœ. ä¸ L2TP ç±»ä¼¼, å®ƒé€šå¸¸ä¸ IPsec é…å¯¹ä½¿ç”¨ä»¥æä¾›èº«ä»½éªŒè¯å’ŒåŠ å¯†åŠŸèƒ½. å®ƒç”± **IETF RFC 7296** å®šä¹‰, æ˜¯ IKE (Internet Key Exchange) åè®®çš„æ”¹è¿›ç‰ˆæœ¬.

IKEv2 çš„ä¸»è¦åŠŸèƒ½æ˜¯åå•†å’Œç®¡ç†åŠ å¯†å¯†é’¥, ç¡®ä¿é€šä¿¡åŒæ–¹èƒ½å¤Ÿä»¥å®‰å…¨å’Œé«˜æ•ˆçš„æ–¹å¼åŠ å¯†æ•°æ®.

é…ç½®ç›¸å¯¹å¤æ‚, ç‰¹åˆ«æ˜¯åœ¨æ‰‹åŠ¨éƒ¨ç½²æœåŠ¡å™¨æ—¶, ä¸”éœ€è¦å ç”¨ 2 ä¸ªç«¯å£:

- **UDP 500**: IKEv2 çš„é»˜è®¤ç«¯å£, ç”¨äºåˆå§‹è¿æ¥å’Œ IKE åå•†.
- **UDP 4500**: å½“ NAT ç©¿è¶Š (NAT-T) è¢«æ£€æµ‹åˆ°æ—¶, IKEv2 åˆ‡æ¢åˆ°æ­¤ç«¯å£.

**ä¼˜ç‚¹**

- **ç¨³å®šæ€§**: IKEv2/IPsec ä½¿ç”¨ä¸€ç§åä¸º Mobility and Multi-homing Protocol (MOBIKE) çš„æŠ€æœ¯, å½“æµé‡åœ¨äº’è”ç½‘ä¼ è¾“æ—¶, è¯¥æŠ€æœ¯å¯ç¡®ä¿å»ºç«‹ VPN è¿æ¥ä¸ä¸­æ–­, ä½¿å¾— IKEv2/IPsec æˆä¸ºç§»åŠ¨è®¾å¤‡æœ€å¯é å’Œç¨³å®šçš„åè®®.
- **å®‰å…¨æ€§**: ä½œä¸º IPsec å¥—ä»¶çš„ä¸€éƒ¨åˆ†, IKEv2/IPsec å¯ä¸å¤§å¤šæ•°åŠ å¯†ç®—æ³•é…åˆä½¿ç”¨, ä½¿å…¶æˆä¸ºæœ€å®‰å…¨çš„ VPN åè®®.
- **é€Ÿåº¦**: è¿è¡Œæ—¶å ç”¨å¾ˆå°‘çš„å®½å¸¦, è€Œä¸”å®ƒçš„ NAT ç©¿é€æŠ€æœ¯, ä½¿å…¶è¿æ¥å’Œé€šä¿¡æ›´å¿«é€Ÿ, ä¹Ÿæœ‰åŠ©äºé€šè¿‡é˜²ç«å¢™.

**ç¼ºç‚¹**

- **å…¼å®¹æ€§æœ‰é™**: IKEv2/IPsec ä¸è®¸å¤šç³»ç»Ÿä¸å…¼å®¹. è¿™å¯¹ Windows ç”¨æˆ·æ¥è¯´ä¸æ˜¯é—®é¢˜, å› ä¸ºå¾®è½¯å‚ä¸åˆ¶å®šæ­¤åè®®, ä½†å…¶ä»–æ“ä½œç³»ç»Ÿåˆ™å¯èƒ½éœ€è¦ç¬¬ä¸‰æ–¹è½¯ä»¶æ‰èƒ½æ”¯æŒ.

å› ä» Wi-Fi åˆ‡æ¢åˆ°ç§»åŠ¨æ•°æ®æ—¶ä¸ä¼šé—å¤± VPN è¿æ¥, **IKEv2/IPsec** å¸¸ç”¨åœ¨ç§»åŠ¨è®¾å¤‡ç«¯.

#### WireGuard æ˜¯ä»€ä¹ˆ

![20241229154732_cKnMu1Wu.webp](https://cdn.dong4j.site/source/image/20241229154732_cKnMu1Wu.webp)

æ˜¯æ•´ä¸ª VPN è¡Œä¸šéƒ½åœ¨è°ˆè®ºçš„æœ€æ–°ã€æœ€å¿«é€Ÿçš„é€šé“åè®®. è¿™ç§åè®®ä½¿ç”¨æœ€å…ˆè¿›çš„åŠ å¯†æŠ€æœ¯, ä½¿å½“å‰çš„é¢†å¯¼è€…â€”â€”OpenVPN å’Œ IKEv2/IPsec é»¯ç„¶å¤±è‰².

[**WireGuard**](https://github.com/pirate/wireguard-docs) æ˜¯ç”± `Jason Donenfeld` ç­‰äººç”¨ `C` è¯­è¨€ç¼–å†™çš„ä¸€ä¸ªå¼€æº VPN åè®®, è¢«è§†ä¸ºä¸‹ä¸€ä»£ VPN åè®®, æ—¨åœ¨è§£å†³è®¸å¤šå›°æ‰° `IPSec/IKEv2`ã€`OpenVPN` æˆ– `L2TP` ç­‰å…¶ä»– VPN åè®®çš„é—®é¢˜.

WireGuard å£°ç§°å…¶æ€§èƒ½æ¯”å¤§å¤šæ•° VPN åè®®æ›´å¥½, [ä½†è¿™ä¸ªäº‹æƒ…æœ‰å¾ˆå¤šäº‰è®®](https://www.ipfire.org/blog/why-not-wireguard).

ä¸åœ¨ç”¨æˆ·ç©ºé—´ä¸­è¿è¡Œçš„ OpenVPN ä¸åŒ, WireGuard çš„ä¼˜åŠ¿åœ¨äºç›´æ¥é›†æˆåˆ° Linux å†…æ ¸(5.6 å¼€å§‹)ä¸­. è¿™ç§é›†æˆä½¿å…¶èƒ½å¤Ÿæ›´é«˜æ•ˆåœ°å¤„ç†æ•°æ®åŒ…, åŒæ—¶æœ€å¤§é™åº¦åœ°å‡å°‘ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢.

![20241229154732_UGdpMK6l.webp](https://cdn.dong4j.site/source/image/20241229154732_UGdpMK6l.webp)

WireGuard ä»…ä½¿ç”¨ UDP, å¹¶ä¸”é€šå¸¸åœ¨ **å•ä¸ªç«¯å£ä¸Š** è¿è¡Œ, ä»è€Œç®€åŒ–äº†å…¶è®¾ç½®å’Œæ“ä½œ. è¿™ä¸ OpenVPN å½¢æˆå¯¹æ¯”, åè€…å¯ä»¥ä½¿ç”¨ TCP æˆ– UDP, å¹¶ä¸”å¯èƒ½éœ€è¦æ ¹æ®é…ç½®ç®¡ç†å¤šä¸ªç«¯å£. WireGuard ä½¿ç”¨å•ä¸€åè®®å’Œç«¯å£, é™ä½äº†ç½‘ç»œé…ç½®å’Œé˜²ç«å¢™è§„åˆ™çš„å¤æ‚æ€§, ä»è€Œæé«˜äº†æ•´ä½“æ€§èƒ½.

ç„¶è€Œç²¾ç®€å°±æ„å‘³ç€åŠŸèƒ½ç¼ºå¤±, [WireGuard çš„å±€é™æ€§](https://www.ipfire.org/blog/why-not-wireguard), åªèƒ½è¯´ç›®å‰ WireGurad æ–¹å¼å¯¹æˆ‘æ¥è¯´å®Œå…¨å¤Ÿç”¨.

**ä¼˜ç‚¹**

- **å…è´¹å’Œå¼€æº**: ä»»ä½•äººéƒ½èƒ½æŸ¥çœ‹ä»£ç , è¿™ä½¿å¾—éƒ¨ç½²ã€ç¨½æ ¸å’Œè°ƒè¯•æ›´åŠ å®¹æ˜“.

- **ç²¾ç®€ä¸”é€Ÿåº¦æå¿«**: ä»…ç”± 4000 è¡Œä»£ç ç»„æˆ, æ˜¯æ‰€æœ‰åè®®ä¸­â€œæœ€ç²¾ç®€â€çš„åè®®. ç›¸è¾ƒä¹‹ä¸‹, OpenVPN ä»£ç è¡Œæ•°æ˜¯å®ƒçš„ 100 å€.

  ![20241229154732_yJfQlqXb.webp](https://cdn.dong4j.site/source/image/20241229154732_yJfQlqXb.webp)

**ç¼ºç‚¹**

- **ä¸å®Œæ•´**: WireGuard æœ‰æœ›æˆä¸ºâ€œä¸‹ä¸€ä¸ªå¤§äº‹ä»¶â€, ä½†å…¶å®æ–½ä»å¤„äºæ—©æœŸé˜¶æ®µ, è¿˜æœ‰å¾ˆå¤§çš„æ”¹è¿›ç©ºé—´. ç›®å‰, å®ƒæ— æ³•ä¸ºç”¨æˆ·æä¾›ä»»ä½•çº§åˆ«çš„åŒ¿åæ€§ (å°½ç®¡å®Œå…¨åŒ¿åæ˜¯ä¸å¯èƒ½çš„) , å› æ­¤ VPN æä¾›å•†éœ€è¦æ‰¾åˆ°å®šåˆ¶çš„è§£å†³æ–¹æ¡ˆ, åœ¨ä¸æŸå¤±é€Ÿåº¦çš„æƒ…å†µä¸‹æä¾›å¿…è¦çš„å®‰å…¨æ€§.

**ä½¿ç”¨æ—¶æœº**: æ¯å½“éœ€è¦é€Ÿåº¦ä¼˜å…ˆæ—¶, éƒ½å¯ä»¥ä½¿ç”¨ WireGuard: æµåª’ä½“ã€åœ¨çº¿æ¸¸æˆæˆ–ä¸‹è½½å¤§å‹æ–‡ä»¶.

##### ç›¸å…³é“¾æ¥

å…³äºæ€§èƒ½æ¯”è¾ƒçš„æ›´å¤šä¿¡æ¯å¯ä»¥å‚è€ƒä¸‹é¢å‡ ç¯‡æ–‡æ¡£:

- [å®˜æ–¹çš„åŸºå‡†æµ‹è¯•](https://www.wireguard.com/performance/)
- [ä¸¤å°å…·æœ‰ 10 Gb ä»¥å¤ªç½‘çš„æœåŠ¡å™¨ä¹‹é—´çš„ WireGuard åŸºå‡†æµ‹è¯•](https://www.reddit.com/r/linux/comments/9bnowo/wireguard_benchmark_between_two_servers_with_10/)

å…³äº WireGuard åŠ å¯†çš„æ›´å¤šèµ„æ–™è¯·å‚è€ƒä¸‹æ–¹é“¾æ¥:

- [WireGuard: ä¸‹ä¸€ä»£å†…æ ¸ç½‘ç»œéš§é“](https://www.wireguard.com/papers/wireguard.pdf)
- [ã€ŠWireGuard åè®®çš„å¯†ç å­¦åˆ†æã€‹](https://eprint.iacr.org/2018/080.pdf)
- [WireGuard çš„å®‰å…¨æ€§åˆ†æ](https://courses.csail.mit.edu/6.857/2018/project/He-Xu-Xu-WireGuard.pdf)
- [WireGuard æŠ€æœ¯åˆ†äº«](https://www.wireguard.com/talks/blackhat2018-slides.pdf)
- [WireGuard è¯„æµ‹: æ–°å‹ VPN å…·æœ‰æ˜¾è‘—ä¼˜åŠ¿](https://arstechnica.com/gadgets/2018/08/wireguard-vpn-review-fast-connections-amaze-but-windows-support-needs-to-happen/)

ä¸‹é¢æ˜¯ä¸€äº›æœ‰åŠ©äºå¯†é’¥åˆ†å‘å’Œéƒ¨ç½²çš„æœåŠ¡:

- [WireGuard ç‚¹å¯¹ç‚¹è¿æ¥çš„å·¥å…·](https://pypi.org/project/wireguard-p2p/)
- [ä¸€ç»„ Ansible è„šæœ¬, ç®€åŒ– WireGuard å’Œ IPsec VPN çš„è®¾ç½®](https://github.com/trailofbits/algo)
- [Streisand](https://github.com/StreisandEffect/streisand)
- [ç”¨ Bash ç¼–å†™çš„ WireGuard è‡ªåŠ¨å®‰è£…ç¨‹åº](https://github.com/its0x08/wg-install)
- [WireGuard é…ç½®ç”Ÿæˆå™¨](https://github.com/brittson/wireguard_config_maker)
- [Web ç«¯ WireGuard é…ç½®ç”Ÿæˆå™¨](https://www.wireguardconfig.com)

---

#### WireGuard ä½¿ç”¨åœºæ™¯

åˆ©ç”¨ WireGuard å¯ä»¥ç»„å»ºéå¸¸å¤æ‚çš„ç½‘ç»œæ‹“æ‰‘, æ ¹æ®ç½‘ç»œç¯å¢ƒçš„ä¸åŒé€šå¸¸æœ‰å¤šç§é…ç½®æ–¹å¼:

##### 1. ç«¯åˆ°ç«¯ç›´æ¥è¿æ¥

è¿™æ˜¯æœ€ç®€å•çš„æ‹“æ‰‘, æ‰€æœ‰çš„èŠ‚ç‚¹è¦ä¹ˆåœ¨åŒä¸€ä¸ªå±€åŸŸç½‘, è¦ä¹ˆç›´æ¥é€šè¿‡å…¬ç½‘è®¿é—®, è¿™æ · `WireGuard` å¯ä»¥ç›´æ¥è¿æ¥åˆ°å¯¹ç«¯, ä¸éœ€è¦ä¸­ç»§è·³è½¬.

##### 2. å±€åŸŸç½‘åˆ°å¤–ç½‘

æ¯”å¦‚åœ¨å®¶è®¿é—®å…¬å¸å±€åŸŸç½‘, æˆ–è€…åœ¨å…¬å¸è®¿é—®å®¶åº­å±€åŸŸç½‘. æœ€ç®€å•çš„æ–¹æ¡ˆæ˜¯é€šè¿‡å…¬ç½‘æš´éœ²çš„ä¸€ç«¯ä½œä¸ºæœåŠ¡ç«¯, å¦ä¸€ç«¯æŒ‡å®šæœåŠ¡ç«¯çš„å…¬ç½‘åœ°å€å’Œç«¯å£, ç„¶åé€šè¿‡ `persistent-keepalive` é€‰é¡¹ç»´æŒé•¿è¿æ¥, è®© NAT è®°å¾—å¯¹åº”çš„æ˜ å°„å…³ç³».

##### 3. ä¸¤ç«¯éƒ½ä½äº NAT ä¹‹å

**3.1 ä½¿ç”¨ä¸­ç»§æœåŠ¡å™¨**

å¤§å¤šæ•°æƒ…å†µä¸‹, å½“é€šä¿¡åŒæ–¹éƒ½åœ¨ NAT åé¢çš„æ—¶å€™, NAT ä¼šåšæºç«¯å£éšæœºåŒ–å¤„ç†, ç›´æ¥è¿æ¥å¯èƒ½æ¯”è¾ƒå›°éš¾. å¯ä»¥åŠ ä¸€ä¸ª **ä¸­ç»§æœåŠ¡å™¨**, é€šä¿¡åŒæ–¹éƒ½å°†ä¸­ç»§æœåŠ¡å™¨ä½œä¸ºå¯¹ç«¯, ç„¶åç»´æŒé•¿è¿æ¥, æµé‡å°±ä¼šé€šè¿‡ä¸­ç»§æœåŠ¡å™¨è¿›è¡Œè½¬å‘.

**3.2 æ‰“æ´**

ä¸Šé¢ä¹Ÿæåˆ°äº†, å½“é€šä¿¡åŒæ–¹éƒ½åœ¨ NAT åé¢çš„æ—¶å€™, ç›´æ¥è¿æ¥ä¸å¤ªç°å®, å› ä¸ºå¤§å¤šæ•° NAT è·¯ç”±å™¨å¯¹æºç«¯å£çš„éšæœºåŒ–ç›¸å½“ä¸¥æ ¼, ä¸å¯èƒ½æå‰ä¸ºåŒæ–¹åè°ƒä¸€ä¸ªå›ºå®šå¼€æ”¾çš„ç«¯å£. å¿…é¡»ä½¿ç”¨ä¸€ä¸ªä¿¡ä»¤æœåŠ¡å™¨ (`STUN `, [[nat-guide|è‡ªå»º STUN Server?]]), å®ƒä¼šåœ¨ä¸­é—´æ²Ÿé€šåˆ†é…ç»™å¯¹æ–¹å“ªäº›éšæœºæºç«¯å£. é€šä¿¡åŒæ–¹éƒ½ä¼šå’Œå…¬å…±ä¿¡ä»¤æœåŠ¡å™¨è¿›è¡Œåˆå§‹è¿æ¥, ç„¶åå®ƒè®°å½•ä¸‹éšæœºçš„æºç«¯å£, å¹¶å°†å…¶è¿”å›ç»™å®¢æˆ·ç«¯.

> è¿™å°±æ˜¯ç°ä»£ P2P ç½‘ç»œä¸­ `WebRTC` çš„å·¥ä½œåŸç†. æœ‰æ—¶å€™, å³ä½¿æœ‰äº†ä¿¡ä»¤æœåŠ¡å™¨å’Œä¸¤ç«¯å·²çŸ¥çš„æºç«¯å£, ä¹Ÿæ— æ³•ç›´æ¥è¿æ¥, å› ä¸º NAT è·¯ç”±å™¨ä¸¥æ ¼è§„å®šåªæ¥å—æ¥è‡ªåŸå§‹ç›®çš„åœ°å€ (ä¿¡ä»¤æœåŠ¡å™¨) çš„æµé‡, ä¼šè¦æ±‚æ–°å¼€ä¸€ä¸ªéšæœºæºç«¯å£æ¥æ¥å—æ¥è‡ªå…¶ä»– IP çš„æµé‡ (æ¯”å¦‚å…¶ä»–å®¢æˆ·ç«¯è¯•å›¾ä½¿ç”¨åŸæ¥çš„é€šä¿¡æºç«¯å£) . è¿è¥å•†çº§åˆ«çš„ NAT å°±æ˜¯è¿™ä¹ˆå¹²çš„, æ¯”å¦‚èœ‚çªç½‘ç»œå’Œä¸€äº›ä¼ä¸šç½‘ç»œ, å®ƒä»¬ä¸“é—¨ç”¨è¿™ç§æ–¹æ³•æ¥é˜²æ­¢æ‰“æ´è¿æ¥.

---

### WireGuard é…ç½®å®ä¾‹

#### ç‚¹å¯¹ç‚¹

å¸¸è§çš„åº”ç”¨åœºæ™¯: å°†ä¸€å°è®¡ç®—æœºè¿æ¥åˆ°è¿œç¨‹ç½‘ç»œ, å¹¶ä½¿å…¶èƒ½å¤Ÿåƒåœ¨æœ¬åœ°ç½‘ç»œä¸­ä¸€æ ·è®¿é—®æ‰€æœ‰èµ„æº. ä¾‹å¦‚è¿æ¥åˆ°å…¬å¸çš„å†…éƒ¨ç½‘ç»œ, è¿œç¨‹æäº¤ä»£ç , è®¿é—®å…¬å¸å†…éƒ¨çš„ Wiki ç­‰; è¿œç¨‹è¿åˆ°å®¶åº­ç½‘ç»œçœ‹ä¸ªå°ç”µå½±, å¬å¬ NAS çš„æ— æŸéŸ³ä¹ä»€ä¹ˆçš„.

è¿œç¨‹ WireGuard ç«¯ç‚¹ä¸­çš„ä½ç½®éå¸¸çµæ´». å®ƒå¯ä»¥ä½äºé˜²ç«å¢™ã€è·¯ç”±å™¨æˆ–å…¶ä»–ä»»ä½•ç½‘ç»œè®¾å¤‡ä¸Š. è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©æœ€åˆé€‚çš„éƒ¨ç½²ä½ç½®.

> ç®€å•è¯´æ˜ä¸€ä¸‹:
>
> **åœ¨ WireGuard é‡Œ, å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åŸºæœ¬æ˜¯å¹³ç­‰çš„, å·®åˆ«åªæ˜¯è°ä¸»åŠ¨è¿æ¥è°è€Œå·²**.
>
> åŒæ–¹éƒ½ä¼šç›‘å¬ä¸€ä¸ª UDP ç«¯å£, è°ä¸»åŠ¨è¿æ¥, è°å°±æ˜¯å®¢æˆ·ç«¯. ä¸»åŠ¨è¿æ¥çš„å®¢æˆ·ç«¯éœ€è¦æŒ‡å®šå¯¹ç«¯çš„å…¬ç½‘åœ°å€å’Œç«¯å£, è¢«åŠ¨è¿æ¥çš„æœåŠ¡ç«¯ä¸éœ€è¦æŒ‡å®šå…¶ä»–å¯¹ç­‰èŠ‚ç‚¹çš„åœ°å€å’Œç«¯å£.
>
> å€¼å¾—å¼ºè°ƒçš„æ˜¯: **å®‰è£…çš„ WireGuard çš„æœåŠ¡å™¨, æ—¢å¯ä»¥ä½œä¸ºæœåŠ¡ç«¯ä¹Ÿå¯ä»¥ä½œä¸ºå®¢æˆ·ç«¯.**
>
> åé¢æˆ‘ä¼šç›´æ¥æ˜¯ç”¨ **æœåŠ¡ç«¯** å’Œ **å®¢æˆ·ç«¯** æ¥ç®€å•åŒºåˆ†ä¸åŒçš„å¯¹ç«¯, æ‰€ä»¥éœ€è¦æå‰è¯´æ˜ä¸€ä¸‹è¿™ä¸ªæ¦‚å¿µ.

**ç½‘ç»œæ‹“æ‰‘å›¾**:

```
                                 å…¬ç½‘
                                xxxxxx             ppp0 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
          â”Œâ”€â”€â”€â”€â”               Xxx   xxxx             â”€â”€â”¤ è·¯ç”±å™¨  â”‚
          â”‚    â”œâ”€ppp0         xxx      xx               â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚    â”‚              xx        x                   â”‚         home 192.168.31.0/24
          â”‚    â”‚               xxx    xxx                   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â””â”€â”€â”€â”€â”˜                 xxxxx                          â”‚         â”‚         â”‚
                                                              â”Œâ”€â”´â”€â”     â”Œâ”€â”´â”€â”     â”Œâ”€â”´â”€â”
                                                              â”‚   â”‚     â”‚   â”‚     â”‚   â”‚
                                                              â”‚pi4â”‚     â”‚NASâ”‚     â”‚...â”‚
                                                              â”‚   â”‚     â”‚   â”‚     â”‚   â”‚
                                                              â””â”€â”€â”€â”˜     â””â”€â”€â”€â”˜     â””â”€â”€â”€â”˜
```

è¿™å¹…å›¾å±•ç¤ºäº†å…¸å‹çš„å®¶åº­/å°å‹å…¬å¸ç½‘ç»œæ‹“æ‰‘ç»“æ„. é€šå¸¸ä¼šæœ‰ä¸€ä¸ªç”± ISP æä¾›çš„å…‰çŒ«, ä¸‹é¢é€šè¿‡è·¯ç”±å™¨æ‹¨å·ä¸Šç½‘, ä»¥åŠä¸€äº›å†…éƒ¨è®¾å¤‡, å¦‚ Raspberry PIã€NAS å’Œå…¶ä»–è®¾å¤‡.

**å®‰è£…æ–¹æ³•**:

å¯ä»¥é€‰æ‹©ä»¥ä¸‹ä¸¤ç§æ–¹æ³•ä¹‹ä¸€æ¥éƒ¨ç½² WireGuard:

1. **åœ¨è·¯ç”±å™¨ä¸Šéƒ¨ç½²**: å¦‚æœä½¿ç”¨ **OpenWrt** ä½œä¸ºä¸»è·¯ç”±ç³»ç»Ÿçš„è¯, è¿™æ˜¯æœ€å¸¸è§ä¸”ç®€å•çš„çš„æ–¹æ³•;
2. **åœ¨å±€åŸŸç½‘ä¸­çš„å¦ä¸€ä¸ªç³»ç»Ÿä¸Šéƒ¨ç½²**: æ¯”å¦‚åœ¨å…¬å¸å¯èƒ½æ²¡æœ‰æƒé™å¯¹è·¯ç”±å™¨åšä»»ä½•é…ç½®(ä½†æ˜¯ç”³è¯· **å¼€æ”¾ä¸€ä¸ªç«¯å£æ˜ å°„** è¿˜æ˜¯å¯ä»¥çš„), æˆ–è€…è·¯ç”±å™¨æ— æ³•å®‰è£… **WireGuard** çš„æ—¶, åªèƒ½ä½¿ç”¨è¿™ç§æ–¹å¼(æ¯”å¦‚æˆ‘åœ¨å…¬å¸éƒ¨ç½²äº†ä¸€å° R2S å°å‹æœåŠ¡å™¨); åœ¨å®¶åº­ç½‘ç»œä¹Ÿé‡‡ç”¨è¿™ç§æ–¹å¼(å› ä¸ºè€ƒè™‘åˆ°ç¨³å®šæ€§, ä½¿ç”¨ AX9000 å’Œ 6500Pro ä½œä¸ºä¸»è·¯ç”±ä¸”æ²¡æœ‰å¼€å¯ root æƒé™, åªä½œä¸ºæ™®é€šè·¯ç”±å™¨ä½¿ç”¨)

**æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯**:

è¯·æ³¨æ„, åœ¨è¿™ç§åœºæ™¯ä¸­éƒ¨ç½²çš„ **WireGuard** æˆ‘ç§°ä¸º **æœåŠ¡ç«¯**, æ„æ€æ˜¯ä¸ä¼šæœ‰ **WireGuard Endpoint** é…ç½®, Endpoint é…ç½®åº”è¯¥åœ¨éœ€è¦è®¿é—®å®¶åº­/å…¬å¸ç½‘ç»œçš„å¤–éƒ¨è®¾å¤‡ä¸Š(ä¸»åŠ¨è¿æ¥å®¶åº­/å…¬å¸ç½‘ç»œä¸­çš„ WireGuard æœåŠ¡, æˆ‘ç§°ä¸º **å®¢æˆ·ç«¯**).

> æˆ‘æ²¡æœ‰ **OpenWrt** ç³»ç»Ÿçš„ä¸»è·¯ç”±å™¨, æ‰€ä»¥éœ€è¦åœ¨ä¸»è·¯ç”±ä¸Šé…ç½®ç«¯å£è½¬å‘è§„åˆ™, å°†æŒ‡å®šæµé‡è½¬å‘åˆ°éƒ¨ç½²äº† **WireGuard** çš„å†…éƒ¨æœåŠ¡å™¨ä¸Š.
>
> å¦‚æœä½ çš„ä¸»è·¯ç”±å™¨æ˜¯ OpenWrt ç³»ç»Ÿ, å¯ä»¥è‡ªè¡ŒæŸ¥é˜…é…ç½®æ–¹å¼, æ–¹å¼éƒ½å¤§åŒå°å¼‚.

ä¸‹é¢æˆ‘å°†åœ¨ **Ubuntu**, **Armbian**, **NAS** å’Œ **R2S** (OpenWrt ç³»ç»Ÿ, ä½œä¸ºäºŒçº§è·¯ç”±å™¨) ä¸Šéƒ¨ç½² **WireGuard** æœåŠ¡, è¿™äº›ç³»ç»Ÿè¦†ç›–äº†å¤§å¤šæ•°å¸¸è§çš„ç³»ç»Ÿç±»å‹, ä»¥æ­¤æ¥è¯´æ˜åœ¨å„ä¸ªç³»ç»Ÿä¸Šå¦‚ä½•éƒ¨ç½², é…ç½®ä¸ä½¿ç”¨ **WireGuard**.

å€¼å¾—æ¨èçš„ **WireGuard** ç®¡ç†å·¥å…·:

- [wg-easy](https://github.com/wg-easy/wg-easy): ç®€å•æ˜“ç”¨çš„ **WireGuard æœåŠ¡ç«¯**;

- [wireguard-ui](https://github.com/ngoduykhanh/wireguard-ui): æ¯”å‰è€…ç¨å¾®å¤æ‚ä¸€ç‚¹, ä¸è¿‡åŠŸèƒ½æ›´å¤š;

---

##### Ubuntu

M920x éƒ¨ç½²äº† Ubuntu Server, æ‰€ä»¥è¿™é‡Œç›´æ¥æ˜¯ç”¨å®ƒæ¥éƒ¨ç½² **WireGuard**.

ç½‘ç»œæ‹“æ‰‘å›¾ 1: åªæ¥å…¥è”é€šç½‘ç»œ

![ubuntu-wireguard.drawio.svg](https://cdn.dong4j.site/source/image/ubuntu-wireguard.drawio.svg)

1. å°† **10.10.1.0/24** ä½œä¸º **WireGuard** çš„ç½‘ç»œ, å’Œç°åœ¨çš„è”é€šç½‘ç»œåˆ†å¼€;
2. M920x æ·»åŠ ä¸€ä¸ª **wg0** ç½‘å¡, å¹¶ä½¿ç”¨ **10.10.1.1/32** (ä¸éœ€è¦è‡ªå·±å»æ‰‹åŠ¨æ·»åŠ  **wg0** ç½‘å¡, **WireGuard** éƒ¨ç½²å¯åŠ¨æˆåŠŸåä¼šè‡ªè¡Œæ·»åŠ );
3. å¤–ç½‘çš„ MBP ä½¿ç”¨ **10.10.1.8/32** ä½œä¸ºå®ƒçš„ **WireGuard** ç½‘ç»œ IP;
4. è”é€šç½‘ç»œçš„ IP æ®µ ä¸º **192.168.21.0/24**;

> æˆ‘ä»¬çš„ç›®çš„æ˜¯è®©åœ¨å¤–ç½‘çš„ MBP èƒ½é€šè¿‡ **WireGuard** æ¥å…¥åˆ° M920x ä¸Šéƒ¨ç½²çš„ **wg0** ç½‘ç»œ, å¹¶ä¸”èƒ½è®¿é—®å®¶ä¸­è”é€šç½‘ç»œä¸‹çš„ä»»æ„è®¾å¤‡.
>
> æ¥ä¸‹æ¥å°±æ˜¯æ— èŠçš„å®‰è£…éƒ¨ç½²ä¸é…ç½®ç¯èŠ‚.
>
> æ€»ä½“æµç¨‹:
>
> 1. å®‰è£… WireGuard;
> 2. ç”Ÿæˆå…¬é’¥å’Œç§é’¥;
> 3. æ·»åŠ  wg0.conf é…ç½®;
> 4. é…ç½®é˜²ç«å¢™å’Œ IP è½¬å‘;
> 5. æ·»åŠ  Peer èŠ‚ç‚¹;
> 6. å®¢æˆ·ç«¯ä½¿ç”¨;

---

**WireGuard** å¯ä»é»˜è®¤çš„ Ubuntu è½¯ä»¶æºä¸­è·å¾—:

```bash
sudo apt update
sudo apt install wireguard
```

è¿™å°†å®‰è£… WireGuard æ¨¡å—å’Œå·¥å…·, WireGuard ä½œä¸ºå†…æ ¸æ¨¡å—è¿è¡Œ.

> ä¸‹é¢çš„æ“ä½œéƒ½æ˜¯ root ç”¨æˆ·.

ä¸º M920x ç”Ÿæˆå¯†é’¥:

```shell
mkdir /etc/wireguard
# ç”Ÿæˆç§é’¥
wg genkey > m920x-private.key
# é€šè¿‡ç§é’¥ç”Ÿæˆå…¬é’¥
wg pubkey < m920x-private.key > m920x-public.key
```

ä¸º MBP ç”Ÿæˆå¯†é’¥:

```shell
wg genkey > mbp-private.key
wg pubkey < mbp-private.key > mbp-public.key
```

åˆ›å»º **wg0.conf** é…ç½®æ–‡ä»¶(æ˜¯ **æ•°å­— 0**, ä¸æ˜¯å­—æ¯ o, æˆ‘æ€•ä½ å­—ä½“æœ‰é—®é¢˜, æ‰€ä»¥æé†’ä¸€ä¸‹):

```shell
[Interface]
Address = 10.10.1.1/32
ListenPort = 51000
PrivateKey = <M920x çš„ç§é’¥: m920x-private.key>

[Peer]
# MBP
PublicKey = <MBP çš„å…¬é’¥: mbp-public.key>
AllowedIPs = 10.10.1.8/32
```

> è¿™é‡Œä¸è¦ææ··äº†, Interface å¡«å†™çš„æ˜¯å½“å‰ä¸»æœºçš„ **ç§é’¥**, å¯¹ç­‰ç‚¹(Peer) å¡«å†™çš„æ˜¯å…¶ä»–è®¾å¤‡çš„ **å…¬é’¥**.

é…ç½®é˜²ç«å¢™å’Œ IP è½¬å‘ (`vim /etc/sysctl.conf`):

```shell
# é˜²ç«å¢™æˆ‘ç›´æ¥å…³é—­, å¦‚æœä¸å…³é—­å°±è¦æ”¾è¡Œ 51000 ç«¯å£
sudo ufw allow 51000/udp
# é…ç½® IPv4 è½¬å‘, ç”¨äºå…è®¸å†…æ ¸åœ¨ç½‘ç»œæ¥å£é—´è½¬å‘æµé‡
net.ipv4.ip_forward = 1
# å¦‚æœéœ€è¦åœ¨ IPv6 ç¯å¢ƒä¸‹å¯ç”¨ WireGuard, è¿˜éœ€è¦æ·»åŠ ä¸‹é¢çš„é…ç½®
net.ipv6.conf.all.forwarding=1
```

> ä½¿ç”¨ `sysctl -p` ä½¿ä¸Šè¿°é…ç½®ç”Ÿæ•ˆ.

æœ€åå¯åŠ¨ **WireGuard**:

```shell
wg-quick up wg0

# åœæ­¢å‘½ä»¤ä¸º:
wg-quick down wg0
```

å¯åŠ¨æˆåŠŸå, åœ¨ **M920x** ä¸Šä½¿ç”¨ `ip a` å¯ä»¥æ‰¾åˆ°ä¸€ä¸ª **wg0** çš„è™šæ‹Ÿç½‘å¡, å¤§æ¦‚æ˜¯è¿™æ ·çš„:

```shell
wg0: <POINTOPOINT,NOARP,UP,LOWER_UP> mtu 1420 qdisc noqueue state UNKNOWN group default qlen 1000
  link/none
  inet 10.10.1.1/24 scope global wg0
     valid_lft forever preferred_lft forever
  inet6 fd45:da8::1/64 scope global
     valid_lft forever preferred_lft forever
```

MBP çš„ **WireGuard** é…ç½® (macOS ä¸‹çš„ WireGuard åœ¨ **éå›½åŒº** App Store å…è´¹ä¸‹è½½):

```shell
[Interface]
PrivateKey = <MBP çš„ç§é’¥: mbp-private.key>
Address = 10.10.1.8/32

[Peer]
PublicKey = <M920x çš„å…¬é’¥: m920x-public.key>
AllowedIPs = 10.10.1.0/24
Endpoint = <M920x çš„å…¬ç½‘åŸŸå, æ¯”å¦‚ m920x.dong4j.tele:51000>
PersistentKeepalive = 25
```

![20241229154732_Z8p68U3k.webp](https://cdn.dong4j.site/source/image/20241229154732_Z8p68U3k.webp)

MBP ä¸Š **WireGuard** åˆ›å»ºçš„ç½‘å¡ä¿¡æ¯:

```
utun6: flags=8051<UP,POINTOPOINT,RUNNING,MULTICAST> mtu 1420
	options=6460<TSO4,TSO6,CHANNEL_IO,PARTIAL_CSUM,ZEROINVERT_CSUM>
	inet 10.10.1.8 --> 10.10.1.8 netmask 0xffffffff
```

ç„¶åæˆ‘ä»¬å¯ä»¥æ˜¯ç”¨ **ping** æ¥éªŒè¯æ˜¯å¦æˆåŠŸ:

![20241229154732_0ZJwRAa3.webp](https://cdn.dong4j.site/source/image/20241229154732_0ZJwRAa3.webp)

ä¹Ÿèƒ½æˆåŠŸè®¿é—® M920x ä¸Šçš„æœåŠ¡:

![20241229154732_CinOUXRU.webp](https://cdn.dong4j.site/source/image/20241229154732_CinOUXRU.webp)

åœ¨ **M920x** ä¸Šä½¿ç”¨ **wg** æŸ¥çœ‹ **WireGuard** ä¿¡æ¯:

![20241229154732_4Yr9870g.webp](https://cdn.dong4j.site/source/image/20241229154732_4Yr9870g.webp)

---

ä¸Šè¿°é…ç½®å°†å±€åŸŸç½‘å†…çš„ M920x å’Œå¤–ç½‘çš„ MBP æˆåŠŸçš„åŠ å…¥åˆ° **10.10.1.0/24** è¿™ä¸ªå±€åŸŸç½‘å†…, ä½†æ˜¯ç›®å‰ä¹Ÿåªèƒ½åœ¨è¿™ä¸ªå­ç½‘å†…é€šä¿¡, å¦‚æœæˆ‘æƒ³è®© MBP è®¿é—® M920x æ‰€åœ¨çš„ **192.168.21.0/24** è¿™ä¸ªå±€åŸŸç½‘, MBP åˆ™éœ€è¦å¦‚ä¸‹é…ç½®:

```shell
[Interface]
PrivateKey = <MBP çš„ç§é’¥: mbp-private.key>
Address = 10.10.1.8/32

[Peer]
PublicKey = <M920x çš„å…¬é’¥: m920x-public.key>
AllowedIPs = 10.10.1.0/24, 192.168.21.0/24
Endpoint = <M920x çš„å…¬ç½‘åŸŸå, æ¯”å¦‚ m920x.dong4j.tele:51000>
PersistentKeepalive = 25
```

`AllowedIPs = 10.10.1.0/24, 192.168.21.0/24` è¡¨ç¤º: æ¥è‡ª `10.10.1.0/24, 192.168.21.0/24` çš„æµé‡å…¨éƒ¨é€šè¿‡ **WireGuard** çš„ç½‘å¡(MBP ä¸Šçš„ utun6 ç½‘å¡)å‘å¾€ **M920x**, æˆ‘ä»¬æ¥è¯¦ç»†äº†è§£ä¸€ä¸‹æ•´ä¸ªé“¾è·¯æ˜¯æ€æ ·çš„:

1. MBP è¯·æ±‚ **http://192.168.21.1** è®¿é—®å°ç±³è·¯ç”±å™¨çš„ WebUI;

2. æµé‡ä» MBP çš„ utun6 ç½‘å¡å‘å¾€ M920x:

   ```shell
   $ netstat -rn
   Routing tables

   Internet:
   Destination        Gateway            Flags               Netif Expire
   ...
   192.168.21         link#34            UCS                 utun6
   192.168.21.1       link#34            UHW3I               utun6     82
   ```

   {% folding ğŸª¬ è§£é‡Šå¦‚ä¸‹: %}

   1. 192.168.21

   - Destination: ç›®æ ‡ç½‘ç»œ (ç½‘æ®µ) , è¿™é‡Œæ˜¯ 192.168.21, é€šå¸¸è¡¨ç¤ºå­ç½‘.
   - Gateway: link#34 è¡¨ç¤ºæ— éœ€é€šè¿‡ç½‘å…³, ç›´æ¥é€šè¿‡æŒ‡å®šæ¥å£è®¿é—®.
   - Flags:
     - U: è·¯ç”±å¯è¾¾ (Up) .
     - C: ç›´æ¥è¿æ¥çš„ç½‘ç»œ (Connected) .
     - S: é™æ€è·¯ç”± (Static route) .
   - Netif: utun6 æ˜¯è™šæ‹Ÿç½‘ç»œæ¥å£, å¸¸è§äº VPN æˆ–éš§é“è¿æ¥.

   2. 192.168.21.1

   - Destination: å•ä¸ªä¸»æœºåœ°å€.
   - Gateway: link#34, è¡¨ç¤ºé€šè¿‡ç‰©ç†æˆ–è™šæ‹Ÿæ¥å£è®¿é—®.
   - Flags:
     - U: è·¯ç”±å¯è¾¾.
     - H: ä¸»æœºè·¯ç”± (Host route) .
     - W3: é€šå¸¸ä¸ VPN ç›¸å…³, è¡¨ç¤ºæ¥å£çŠ¶æ€.
     - I: å¯èƒ½æ˜¯ä¸´æ—¶æˆ–åŠ¨æ€çš„æ¥å£.
   - Netif: ä½¿ç”¨ utun6 æ¥å£.
   - Expire: 82 è¡¨ç¤ºè¯¥è·¯ç”±å°†åœ¨ 82 ç§’åè¿‡æœŸ, é€šå¸¸æ˜¯åŠ¨æ€è·¯ç”±.

   {% endfolding %}

3. æ•°æ®åŒ…è¿›å…¥ä¸»æœºå, å†…æ ¸ä¼šæ£€æŸ¥: å¦‚æœæ•°æ®åŒ…çš„ç›®æ ‡ç«¯å£æ˜¯ **WireGuard** é…ç½®çš„ UDP ç›‘å¬ç«¯å£ (51000) , ç³»ç»Ÿä¼šå°†æµé‡äº¤ç»™ wg0 æ¥å£è¿›è¡Œè§£å¯†, å¦åˆ™å°±ä¼šè¢«ä¸¢å¼ƒ;

4. è§£å¯†åçš„æµé‡ä¼šè¢«ç³»ç»Ÿè·¯ç”±è¡¨æˆ– NAT è¡¨å¤„ç†, å†³å®šæœ€ç»ˆçš„æµé‡å»å‘; è€Œ M920x çš„è·¯ç”±è¡¨æƒ…å†µä¸º:

   ```shell
   $ route -n
   å†…æ ¸ IP è·¯ç”±è¡¨
   ç›®æ ‡            ç½‘å…³            å­ç½‘æ©ç         æ ‡å¿—  è·ƒç‚¹   å¼•ç”¨  ä½¿ç”¨ æ¥å£
   0.0.0.0         192.168.21.1    0.0.0.0         UG    101    0        0 enx00e04c680012
   ...
   10.10.1.8       0.0.0.0         255.255.255.255 UH    0      0        0 wg0
   192.168.21.0    0.0.0.0         255.255.255.0   U     101    0        0 enx00e04c680012
   ...
   ```

   ä¸Šé¢è¡¨ç¤º **192.168.21.0** çš„æµé‡ä¼šé€šè¿‡ M920x çš„ `enx00e04c680012` ç½‘å¡å¤„ç†;

åœ¨ MBP ä¸Šä½¿ç”¨ `traceroute 192.168.21.1` æŸ¥çœ‹ä¸€ä¸‹è¯·æ±‚è·¯å¾„:

```shell
$ traceroute 192.168.21.1
traceroute to 192.168.21.1 (192.168.21.1), 64 hops max, 40 byte packets
 1  10.10.1.1 (10.10.1.1)  35.225 ms  34.738 ms  35.507 ms
 2  192.168.21.1 (192.168.21.1)  37.286 ms  36.622 ms  38.947 ms
```

1. **ç¬¬ä¸€è·³**: `10.10.1.1` æ˜¯ WireGuard éš§é“å¯¹ç«¯çš„è™šæ‹Ÿ IP, é€šå¸¸æ˜¯æœåŠ¡å™¨çš„ WireGuard æ¥å£åœ°å€. è¿™è¯´æ˜æµé‡é€šè¿‡ wg0 æ¥å£æˆåŠŸè¿›å…¥ WireGuard éš§é“.

2. **ç¬¬äºŒè·³**: `192.168.21.1` æ˜¯ç›®æ ‡åœ°å€, è¡¨æ˜ WireGuard éš§é“å¯¹ç«¯ (æœåŠ¡å™¨) æ¥æ”¶äº†æµé‡, å¹¶é€šè¿‡æœåŠ¡å™¨ä¸Šçš„è·¯ç”±è§„åˆ™è½¬å‘åˆ°äº† `192.168.21.0/24` å­ç½‘.

è€Œ M920x çš„è·¯ç”±è§„åˆ™ä¸º:

```shell
$ ip route show 192.168.21.0/24
192.168.21.0/24 dev enx00e04c680012 proto kernel scope link src 192.168.21.7 metric 101
```

å¦‚æœæ•°æ®åŒ…çš„ç›®æ ‡åœ°å€å±äº `192.168.21.0/24` å­ç½‘, å¹¶ä¸”æ²¡æœ‰å…¶ä»–æ›´ä¼˜çš„è·¯ç”±è§„åˆ™, ç³»ç»Ÿå°†é€šè¿‡ `enx00e04c680012` æ¥å£å‘é€è¿™äº›æ•°æ®åŒ….

> å€¼å¾—è¯´æ˜çš„æ˜¯, `net.ipv4.ip_forward = 1` è¿™ä¸ªé…ç½®æ˜¯è½¬å‘æµé‡çš„å…³é”®.

---

å› ä¸ºæˆ‘çš„ M920x åˆ†åˆ«è¿æ¥äº†ç”µä¿¡(192.168.31.0/24) å’Œè”é€š(192.168.21.0/24) ç½‘ç»œ, æˆ‘çš„ç›®çš„æ˜¯é€šè¿‡ M920x çš„ **WireGuard** è®¿é—® 2 ä¸ªç½‘ç»œä¸‹çš„æ‰€æœ‰è®¾å¤‡å’ŒæœåŠ¡,

ç½‘ç»œæ‹“æ‰‘å›¾ 2: æ¥å…¥ç”µä¿¡å’Œè”é€šç½‘ç»œ

![ubuntu-wireguard-double.drawio.svg](https://cdn.dong4j.site/source/image/ubuntu-wireguard-double.drawio.svg)

1. M920x å…·å¤‡åŒç½‘å¡, IP åˆ†åˆ«æ˜¯ `192.168.31.7/32`(ç”µä¿¡) å’Œ `192.168.21.7/32` (è”é€š);
1. MBP çš„ **WireGuard** IP ä¿æŒä¸å˜;

ä¸ºäº†æ»¡è¶³ä¸Šè¿°éœ€æ±‚, æˆ‘ä»¬éœ€è¦ä¿®æ”¹ MBP çš„ WireGuard å®¢æˆ·ç«¯é…ç½®:

```shell
[Interface]
PrivateKey = <MBP çš„ç§é’¥: mbp-private.key>
Address = 10.10.1.8/32

[Peer]
PublicKey = <M920x çš„å…¬é’¥: m920x-public.key>
AllowedIPs = 10.10.1.0/24, 192.168.21.0/24, 192.168.31.0/24
Endpoint = <M920x çš„å…¬ç½‘åŸŸå, æ¯”å¦‚ m920x.dong4j.tele:51000>
PersistentKeepalive = 25
```

é…ç½®å®Œæˆå, å³å¯è®¿é—®å®¶ä¸­ 2 ä¸ªå†…ç½‘ä¸­æ‰€æœ‰çš„è®¾å¤‡.

**ç½‘å¡ä¼˜å…ˆçº§çš„é—®é¢˜** <a id="ç½‘å¡ä¼˜å…ˆçº§çš„é—®é¢˜" style="display:none;"></a>

ä¸Šé¢çš„ç½‘ç»œæ‹“æ‰‘å›¾æˆ‘éšè—äº†ä¸€ä¸ªç»†èŠ‚: åªæœ‰åœ¨æµé‡é€šè¿‡è”é€šå…¬ç½‘è¿›å…¥æ—¶æ‰èƒ½è®¿é—®å®¶ä¸­çš„è®¾å¤‡, å¦‚æœæ˜¯ä»ç”µä¿¡å…¬ç½‘èµ°, ä½ ä¼šå‘ç° **WireGuard** VPN é€šé“éƒ½å»ºç«‹ä¸ä¸Š(è¿™é‡Œçš„æ„æ€æ˜¯æŒ‡ MBP çš„ WireGuard é…ç½®ä¸­çš„ **Endpoint**, è”é€šé…ç½®çš„æ˜¯ ` m920x.dong4j.unic:51000`, ç”µä¿¡é…ç½®çš„æ˜¯ ` m920x.dong4j.tele:51000`).

åŸå› æ˜¯ **å¤šç½‘å¡ä¼˜å…ˆçº§å¯¼è‡´çš„**:

![wireguard-nat1.drawio.svg](https://cdn.dong4j.site/source/image/wireguard-nat1.drawio.svg)

**æµé‡è¿›å…¥ç½‘å¡åçš„å…·ä½“æµç¨‹**:

1. ç”µä¿¡ç½‘ç»œæ¡æ‰‹è¯·æ±‚ï¼š
   - æ•°æ®åŒ…ä»ç”µä¿¡å…¬ç½‘è¿›å…¥è·¯ç”±å™¨ï¼Œæ ¹æ®è·¯ç”±å™¨ä¸Šè®¾ç½®çš„ç«¯å£æ˜ å°„å°†æµé‡è½¬å‘è‡³ `192.168.31.7:51000`;
   - æ•°æ®åŒ…è¿›å…¥ M920x çš„ç”µä¿¡ç½‘å¡ (`192.168.31.7`);
2. WireGuard æœåŠ¡æ¥æ”¶æ•°æ®åŒ…ï¼š
   - WireGuard æ¥æ”¶è¯·æ±‚ï¼Œå‡†å¤‡ç”Ÿæˆæ¡æ‰‹å“åº”åŒ…ã€‚
3. æ•°æ®åŒ…ä»é»˜è®¤è·¯ç”±è¿”å›ï¼š
   - å› ä¸ºè”é€šç½‘å¡ (`192.168.21.7`) çš„ä¼˜å…ˆçº§é«˜ï¼Œæ¡æ‰‹å“åº”åŒ…èµ°è”é€šç½‘å¡å‘å‡ºã€‚
   - å“åº”åŒ…çš„æº IP ä¸ºè”é€šå…¬ç½‘ IP(`40.40.40.40`)ï¼Œè€Œå®¢æˆ·ç«¯æœŸå¾…çš„æ˜¯ç”µä¿¡å…¬ç½‘ IP(`20.20.20.20`)ã€‚
4. å®¢æˆ·ç«¯ä¸¢å¼ƒå“åº”åŒ…ï¼š
   - å®¢æˆ·ç«¯éªŒè¯å“åº”åŒ…çš„æº IP (`40.40.40.40`)ï¼Œå‘ç°ä¸æ¡æ‰‹è¯·æ±‚çš„ç›®æ ‡ IP(`20.20.20.20`) ä¸ä¸€è‡´ï¼Œè®¤ä¸ºè¿™æ˜¯æ— æ•ˆåŒ…ã€‚

WireGuard çš„æ¡æ‰‹è¿‡ç¨‹ä¾èµ– UDP æ•°æ®åŒ…ï¼Œå¹¶ä¸”ä¼šä¸¥æ ¼æ£€æŸ¥å“åº”åŒ…çš„ä»¥ä¸‹å±æ€§ï¼š

1. æº IP å¿…é¡»ä¸ç›®æ ‡ IP åŒ¹é…ï¼š
   - å®¢æˆ·ç«¯å‘é€æ¡æ‰‹è¯·æ±‚æ—¶è®°å½•ç›®æ ‡ IPï¼ˆæ¯”å¦‚ç”µä¿¡å…¬ç½‘ IPï¼‰;
   - å¦‚æœæœåŠ¡ç«¯è¿”å›çš„åŒ…æº IP æ˜¯è”é€šå…¬ç½‘ IPï¼Œå®¢æˆ·ç«¯æ— æ³•å°†å…¶ä¸æœ€åˆçš„è¯·æ±‚åŒ¹é…;
2. UDP å››å…ƒç»„éªŒè¯ï¼š
   - å®¢æˆ·ç«¯ä¼šéªŒè¯è¿”å›åŒ…çš„ UDP å››å…ƒç»„ï¼ˆæº IPã€ç›®æ ‡ IPã€æºç«¯å£ã€ç›®æ ‡ç«¯å£ï¼‰;
   - å¦‚æœæº IP ä¸å¯¹ï¼Œæ•´ä¸ªæ¡æ‰‹æµç¨‹å°±å¤±è´¥;

> **M920x** ç½‘å¡ä¼˜å…ˆçº§: enx00e04c680012(è”é€š) > en01(ç”µä¿¡)
>
> å½“ WireGuard æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯çš„æ¡æ‰‹åŒ…æ—¶, è§£å¯†åéœ€è¦å‘é€å›å®¢æˆ·ç«¯, å› ä¸º enx00e04c680012 (102.168.31.7) ä¼˜å…ˆçº§é«˜äº en01, æ‰€ä»¥ä¼šä½¿ç”¨ enx00e04c680012(192.168.21.7) ç½‘å¡å›å¤å“åº”, æ•°æ®åŒ…ç»è¿‡è”é€šè·¯ç”±å™¨æ—¶, NAT å°†æºåœ°å€ä¿®æ”¹ä¸ºè”é€šå…¬ç½‘ IP, å¯¼è‡´å®¢æˆ·ç«¯æ— æ³•éªŒè¯å“åº”åŒ…çš„æº IP, æœ€ç»ˆæ¡æ‰‹å¤±è´¥.

---

**æ·»åŠ è‡ªå¯åŠ¨**

```shell
systemctl enable wg-quick@{é…ç½®å}
```

ä½ å¯ä»¥åœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šéƒ¨ç½²å¤šä¸ª WireGuard æœåŠ¡, æ‰€ä»¥å¯ä»¥é…ç½®å¤šä¸ªè‡ªå¯åŠ¨, æ¯”å¦‚ç°åœ¨çš„é…ç½®æ˜¯ `wg0.conf`, é‚£ä¹ˆ **é…ç½®å** å°±æ˜¯ `wg0`;

> åœ¨æ¸…æ¥š **WireGuard** çš„åŸºç¡€é…ç½®ä¸ä½¿ç”¨æµç¨‹å , Linux ç¯å¢ƒä¸‹æ¨èç›´æ¥ä½¿ç”¨ [ä¸€é”®éƒ¨ç½²è„šæœ¬](https://github.com/hwdsl2/wireguard-install) æ¥ç®€åŒ–æ“ä½œ, å¦ä¸€ä¸ª [ä¸€é”®éƒ¨ç½²è„šæœ¬](https://github.com/angristan/wireguard-install).

---

##### NAS

NAS éœ€è¦å®‰è£… **WireGuard** SPK åŒ…æ‰èƒ½æ­£å¸¸ä½¿ç”¨, è¿™é‡Œæ˜¯ [å„ä¸ª DMS ç‰ˆæœ¬çš„ SPK åŒ…ä¸‹è½½åœ°å€](https://www.blackvoid.club/wireguard-spk-for-your-synology-nas/), å¦‚æœä½ ä¸æ”¾å¿ƒä¹Ÿå¯ä»¥æŒ‰ç…§æ•™ç¨‹è‡ªè¡Œç¼–è¯‘.

æˆ‘ä½¿ç”¨ç¬¬ä¸‰æ–¹å¥—ä»¶ä»“åº“å®‰è£…çš„æ–¹å¼éƒ¨ç½²:

åœ¨ **å¥—ä»¶ä¸­å¿ƒ** æ–°å¢å¥—ä»¶æ¥æº

1. çŸ¿ç¥: https://spk7.imnks.com/
2. SynoCommunity(åŒæ—¶æ¨èæ·»åŠ ä¸Šè¿™ä¸ª, æœ‰è¾ƒå¤šçš„ç¬¬ä¸‰æ–¹ SPK): https://packages.synocommunity.com/

![20241229154732_LMIScRak.webp](https://cdn.dong4j.site/source/image/20241229154732_LMIScRak.webp)

ä½¿ç”¨ SSH ç™»å½• NAS, ç„¶åæŒ‰ç…§è¦æ±‚æ‰§è¡Œä¸€ä¸‹:

```shell
sed -i 's/package/root/g' /var/packages/WireGuard/conf/privilege
```

ä¿®æ”¹å®Œå¯ä»¥ç¡®å®šä¸€ä¸‹, å¦‚æœæœ‰é—®é¢˜è¿˜å¯ä»¥ç”¨ vi å»ç¼–è¾‘:

```shell
root@DS218:~# cat /var/packages/WireGuard/conf/privilege
{
    "defaults": {
        "run-as": "root"
    }
}
```

ä¸ºäº†èƒ½é€šè¿‡ **WireGuard** è®¿é—®ç”µä¿¡å’Œè”é€šçš„å†…ç½‘, è¿˜éœ€è¦ IP è½¬å‘ (`vim /etc/sysctl.conf`):

```
# é…ç½® IPv4 è½¬å‘, ç”¨äºå…è®¸å†…æ ¸åœ¨ç½‘ç»œæ¥å£é—´è½¬å‘æµé‡
net.ipv4.ip_forward = 1
```

åç»­çš„é…ç½®ä¸åœ¨ Ubuntu ä¸Šä¸€è‡´, æœ€åä½¿ç”¨ `wg-quick up {é…ç½®å}` å¯åŠ¨å³å¯, ä¸éœ€è¦æ˜¾å¼è®¾ç½®è‡ªå¯åŠ¨, DSM ç³»ç»Ÿä¼šè‡ªå·±å¯åŠ¨.

---

##### OpenWrt

**OpenWrt** åŒæ ·æ”¯æŒå¯è§†åŒ– UI æ¥é…ç½® **WireGuard**, ä¸”æ”¯æŒ **å®¢æˆ·ç«¯** æ¨¡å¼.

æ¨èä½ ç›´æ¥åˆ·è‡ªå¸¦ **WireGuard** çš„ **OpenWrt å›ºä»¶**, å¦‚æœæ²¡æœ‰ä½ ä¹Ÿå¯ä»¥æŒ‰ç…§ä¸‹å›¾æ‰€ç¤ºå»å®‰è£…å¿…è¦çš„è½¯ä»¶åŒ…(å¯èƒ½éœ€è¦æ›¿æ¢è½¯ä»¶æº, æˆ–ç›´æ¥é€šè¿‡ pkg å®‰è£…):

![20241229154732_XnylNG0m.webp](https://cdn.dong4j.site/source/image/20241229154732_XnylNG0m.webp)

åœ¨ **ç½‘ç»œ-æ¥å£** é€‰é¡¹å¡ä¸‹æ–°å¢ä¸€ä¸ª **WireGuard** æ¥å£:

![20241229154732_cXBSQwbO.webp](https://cdn.dong4j.site/source/image/20241229154732_cXBSQwbO.webp)

> åœ¨æŸäº› **OpenWrt** ç³»ç»Ÿä¸­, åªèƒ½æ·»åŠ ä¸€ä¸ª **WireGuard** æ¥å£, æ¯”å¦‚ NanoPI çš„ FriendlyWrt, æ¨èä½ æ—©ç‚¹æ¢æ‰, ä¸ç„¶åé¢æ— æ³•ç©å„¿æ›´å¤šçš„åŠŸèƒ½.

![20241229154732_aCOYpRYa.webp](https://cdn.dong4j.site/source/image/20241229154732_aCOYpRYa.webp)

åªéœ€è¦å¡«å†™ **ç§é’¥**, **ç›‘å¬ç«¯å£** å’Œ IP åœ°å€å³å¯.

![20241229154732_bMy4D8kx.webp](https://cdn.dong4j.site/source/image/20241229154732_bMy4D8kx.webp)

åªéœ€è¦å¡«å†™ **å…¬é’¥**, **å…è®¸çš„ IP**, **å‹¾é€‰è·¯ç”±å…è®¸çš„ IP** å³å¯, å…¶ä»– 3 ä¸ªå¯ä»¥åœ¨å®¢æˆ·ç«¯é…ç½®ä¸Šä¿®æ”¹.

æœ€åæ˜¯é…ç½®é˜²ç«å¢™, å…è®¸ **51000** è¿›å‡ºå³å¯(å› ä¸ºæˆ‘æŠŠ **WireGuard_Test** åˆ’åˆ†åˆ° wan åŒºåŸŸäº†, æ‰€ä»¥è¿™é‡Œæ˜¯ **wan**).

![20241229154732_4ZWQaS6z.webp](https://cdn.dong4j.site/source/image/20241229154732_4ZWQaS6z.webp)

é…ç½®å®Œæˆå, æœ€å¥½é‡å¯ä¸€ä¸‹ **WireGuard_Test** æ¥å£, æœ€åé…ç½®å®¢æˆ·ç«¯å³å¯å¯åˆ°çŠ¶æ€:

![20241229154732_jWU0hNzh.webp](https://cdn.dong4j.site/source/image/20241229154732_jWU0hNzh.webp)

---

###### lan æ”¹ wan å£

åƒ R2S, R5S å’Œ H28K è¿™ç±» OpenWrt ç³»ç»Ÿ, ç½‘å£åˆ†åˆ«æ˜¯ä¸€ä¸ª WAN å£ä¸€ä¸ª LAN å£(R5S æœ‰ 2 ä¸ª 2.5G LAN å£, 1 ä¸ªåƒå…† WAN å£, ä½†æ˜¯æˆ‘éœ€è¦ä½¿ç”¨åˆ° 2 ä¸ª 2.5G çš„ç½‘å£ä½œä¸º WAN å£è¿æ¥ç”µä¿¡å’Œè”é€šç½‘ç»œ), ä¸ºäº†æ»¡è¶³é€šè¿‡ä¸€å°è®¾å¤‡å³å¯åŒæ—¶è®¿é—®å®¶ä¸­çš„ 2 ä¸ªå†…ç½‘, éœ€è¦å°† LAN å£æ”¹æˆ WAN å£.

æˆ‘ä»¥ H28K ä¸ºä¾‹, è®°å½•ä¸€ä¸‹ä¿®æ”¹æ–¹å¼:

todo (ç­‰æŠŠ H28K é‡æ–°åˆ·æœºå†å†™)

---

##### wg-easy éƒ¨ç½²

æœ€ç®€å•çš„æ–¹å¼æ˜¯ä½¿ç”¨ [wg-easy](https://github.com/wg-easy/wg-easy), å®ƒæ”¯æŒåœ¨ä»»ä½•å…·æœ‰ WireGuard å†…æ ¸çš„ä¸»æœºä¸Šä½¿ç”¨ **Docker** ä¸€é”®éƒ¨ç½², å¹¶è‡ªå¸¦ WebUI. ä¸è¿‡ç›®å‰ **wg-easy** è¿˜åªèƒ½ä½œä¸º **æœåŠ¡ç«¯** ä½¿ç”¨, å¹¸è¿çš„æ˜¯ [v15.0.0](https://github.com/wg-easy/wg-easy/milestone/4) ç‰ˆæœ¬å°†å¼€å§‹æ”¯æŒ **å®¢æˆ·ç«¯** æ¨¡å¼.

> è¿™é‡Œåªæ˜¯ç®€è¦è¯´æ˜ä¸€ä¸‹ **wg-easy** çš„éƒ¨ç½²æ–¹å¼, ä¸ä¼šè¯¦ç»†å±•å¼€å®¢æˆ·ç«¯çš„ä½¿ç”¨æ–¹å¼, æ‰€ä»¥éœ€è¦ä½ å…·å¤‡ä¸€ç‚¹ **WireGuard** ä½¿ç”¨åŸºç¡€.

```yaml
volumes:
  etc_wireguard:

services:
  wg-easy:
    environment:
      - LANG=chs
      - WG_HOST={ä½ çš„å…¬ç½‘å›ºå®š ip æˆ– DDNS çš„åŸŸå}
      # Optional:
      - PASSWORD_HASH={2 æ¬¡ hash åçš„å¯†ç }
      # - PORT=WebUI ç®¡ç†ç«¯å£, é»˜è®¤ä¸º 51821
      # - WG_PORT=WireGuard çš„ UDP ç«¯å£, é»˜è®¤ä¸º 51820
      # - WG_CONFIG_PORT=92820
      - WG_DEFAULT_ADDRESS=10.10.8.x
      - WG_DEFAULT_DNS=223.5.5.5
      - WG_MTU=1420
      - WG_ALLOWED_IPS=192.168.31.0/24, 192.168.21.0/24, 10.10.8.0/24
      - WG_PERSISTENT_KEEPALIVE=25
      - WG_POST_UP=iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE; iptables -t nat -A POSTROUTING -o eth2 -j MASQUERADE
      - WG_POST_DOWN=iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth1 -j MASQUERADE; iptables -t nat -D POSTROUTING -o eth2 -j MASQUERADE
      - UI_TRAFFIC_STATS=true
      - UI_CHART_TYPE=1 # (0 Charts disabled, 1 # Line chart, 2 # Area chart, 3 # Bar chart)

    image: ghcr.io/wg-easy/wg-easy
    container_name: wg-easy
    volumes:
      - etc_wireguard:/etc/wireguard
    ports:
      - "51820:51820/udp"
      - "51821:51821/tcp"
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
      # - NET_RAW # âš ï¸ Uncomment if using Podman
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
```

> æ›´å¤šçš„é…ç½®è¯´æ˜è¯·æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£.

éœ€è¦è¯´æ˜çš„æœ‰ 2 ç‚¹:

- [å¯†ç ç”Ÿæˆæ–¹å¼](https://github.com/wg-easy/wg-easy/blob/master/How_to_generate_an_bcrypt_hash.md): ç”Ÿæˆå‡ºçš„å¯†ç è®°å¾—å°†æ¯ä¸ª`$`ç¬¦å·æ›¿æ¢ä¸ºä¸¤ä¸ª`$$`ç¬¦å·;
- WG_POST_UP å’Œ WG_POST_DOWN: å› ä¸ºæˆ‘æœ‰ 2 å¼ ç½‘å¡, æ‰€ä»¥è¿™é‡Œé…ç½®äº† 2 ä¸ª iptables;

æ·»åŠ ä¸€ä¸ªå®¢æˆ·ç«¯å¹¶ä¸‹è½½é…ç½®, æˆ–ç›´æ¥ä½¿ç”¨äºŒç»´ç å¯¼å…¥åˆ° WireGuard çš„å®¢æˆ·ç«¯. æœ€åä¸€æ­¥å°±æ˜¯åœ¨è·¯ç”±å™¨ä¸Šé…ç½®ç«¯å£è½¬å‘, å°† **51820** çš„æµé‡è·¯ç”±åˆ° **wg-easy** æ‰€åœ¨çš„æœåŠ¡å™¨.

![20241229154732_lYMPhJNz.webp](https://cdn.dong4j.site/source/image/20241229154732_lYMPhJNz.webp)

å› ä¸ºç›®å‰ **wg-easy** çš„å±€é™æ€§, æ›´æ¨èä½¿ç”¨æ‰‹åŠ¨é…ç½®çš„æ–¹å¼éƒ¨ç½² **WireGuard**, è¿™ç§æ–¹å¼æ›´åŠ çµæ´», èƒ½å¤Ÿæ”¯æŒæ›´å¤æ‚çš„ç½‘ç»œæ‹“æ‰‘æ¶æ„.

---

#### ä¸­ç»§

å¦‚æœå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½ä½äº NAT åé¢, éœ€è¦åŠ ä¸€ä¸ªä¸­ç»§æœåŠ¡å™¨, å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½æŒ‡å®šä¸­ç»§æœåŠ¡å™¨ä½œä¸ºå¯¹ç­‰èŠ‚ç‚¹, å®ƒä»¬çš„é€šä¿¡æµé‡ä¼šå…ˆè¿›å…¥ä¸­ç»§æœåŠ¡å™¨, ç„¶åå†è½¬å‘åˆ°å¯¹ç«¯.

![wireguard_relay.drawio.svg](https://cdn.dong4j.site/source/image/wireguard_relay.drawio.svg)

æ¥ä¸‹æ¥å°†è¦å®ç°ä»¥é˜¿é‡Œäº‘ä½œä¸ºä¸­ç»§æœåŠ¡å™¨, å¹¶å°†æµé‡è½¬å‘åˆ°ç”µä¿¡å’Œè”é€šå†…ç½‘, ä¸‹é¢æ˜¯ä¸€äº›åŸºç¡€æƒ…å†µ:

1. WireGuard çš„è™šæ‹Ÿæˆ‘ä»¬è®¾ç½®ä¸ºå±€åŸŸç½‘ä¸º `10.10.4.0/24`;
2. M920x 2 å¼ ç½‘å¡åˆ†åˆ«æ¥å…¥äº†ç”µä¿¡å’Œè”é€šç½‘ç»œ;
3. å¤–éƒ¨è®¾å¤‡(MBP) èƒ½å¤Ÿåœ¨å¤–éƒ¨è®¿é—® `10.10.4.0/24` å’Œç”µä¿¡è”é€šå†…ç½‘ä¸­çš„æ‰€æœ‰è®¾å¤‡å’ŒæœåŠ¡;

**ä¸­ç»§æœåŠ¡å™¨é…ç½®å¦‚ä¸‹**:

```shell
[Interface]
PrivateKey = <ä¸­ç»§æœåŠ¡å™¨ç§é’¥>
Address = 10.10.4.1/32
ListenPort = <ç«¯å£å·>
PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

# MBP
[Peer]
PublicKey = <MBP å…¬é’¥>
AllowedIPs = 10.10.4.8/32

# M920X
[Peer]
PublicKey = <M920x å…¬é’¥>
AllowedIPs = 10.10.4.7/32, 192.168.31.0/24, 192.168.21.0/24
```

**M920x é…ç½®å¦‚ä¸‹ (å‰é¢å·²ç»æœ‰ä¸€ä¸ªä½œä¸ºæœåŠ¡ç«¯çš„ wg0.conf é…ç½®, ä¸‹é¢æ˜¯æ–°å¢çš„ wg-aliyun.conf ä½œä¸ºå®¢æˆ·ç«¯çš„é…ç½®)**:

```shell
[Interface]
PrivateKey = <M920x ç§é’¥>
Address = 10.10.4.7/32

[Peer]
PublicKey = <ä¸­ç»§æœåŠ¡å™¨å…¬é’¥>
AllowedIPs = 10.10.4.0/24
Endpoint = å…¬ç½‘IP:<ç«¯å£å·>
PersistentKeepalive = 25
```

å¯åŠ¨: `wg-quick up wg-aliyun`

**MBP çš„é…ç½®å¦‚ä¸‹**:

```shell
[Interface]
PrivateKey = <MBP ç§é’¥>
Address = 10.10.4.8/32

[Peer]
PublicKey = <ä¸­ç»§æœåŠ¡å™¨å…¬é’¥>
AllowedIPs = 10.10.4.0/24, 192.168.31.0/24, 192.168.21.0/24
Endpoint = å…¬ç½‘IP:<ç«¯å£å·>
PersistentKeepalive = 25
```

ä¸Šè¿°é…ç½®èƒ½è®©åœ¨å¤–ç½‘çš„ MBP é€šè¿‡ä¸­ç»§æœåŠ¡å™¨, å°† `192.168.31.0/24` å’Œ `192.168.21.0/24` çš„æµé‡è½¬å‘åˆ° M920x, è€Œ M920x æ­£å¥½åœ¨å†…ç½‘, å¯ä»¥é€šè¿‡æœ¬æœºç½‘å¡æµé‡è½¬å‘æ¥è®¿é—® 2 ä¸ªç½‘æ®µ, è¿™é‡Œå°±å®ç°äº†ä¸Šè¿°éœ€æ±‚.

åœ¨ MBP æœ¬åœ°æ‰§è¡Œ `traceroute 192.168.31.1` æ¥çœ‹çœ‹è·ƒç‚¹è·¯å¾„:

```
$ traceroute 192.168.31.1
traceroute to 192.168.31.1 (192.168.31.1), 64 hops max, 40 byte packets
 1  10.10.4.1 (10.10.4.1)  12.971 ms  6.369 ms  6.320 ms
 2  10.10.4.7 (10.10.4.7)  10.887 ms  11.182 ms  11.753 ms
 3  192.168.31.1 (192.168.31.1)  12.963 ms  12.929 ms  17.214 ms
```

1. ç¬¬ä¸€è·³æ¥åˆ°äº†ä¸­ç»§æœåŠ¡å™¨(`10.10.4.1`);
2. ç¬¬äºŒè·³ä¸º M920x (`10.10.4.7`);
3. ç¬¬ä¸‰è·³åˆ™æ˜¯ M920x çš„è”é€šç½‘å…³ (`192.168.31.1`);

æ¥ä¸‹æ¥æ˜¯æ•´ä¸ªæµç¨‹çš„åˆ†æ.

æˆ‘ä»¬çŸ¥é“åœ¨ WireGuard å¯åŠ¨å®Œæˆå, `[Peer]` ä¸­çš„æ¯ä¸ª IP æ®µéƒ½ä¼šè¢«è§£æä¸ºä¸€ä¸ªè·¯ç”±, ä¸‹é¢æ˜¯ **ä¸­ç»§æœåŠ¡å™¨çš„è·¯ç”±è¡¨**:

```
âœ  ~ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
10.10.4.7       0.0.0.0         255.255.255.255 UH    0      0        0 wg0
10.10.4.8       0.0.0.0         255.255.255.255 UH    0      0        0 wg0
...
192.168.21.0    0.0.0.0         255.255.255.0   U     0      0        0 wg0
192.168.31.0    0.0.0.0         255.255.255.0   U     0      0        0 wg0
```

ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæˆ‘ä»¬é…ç½®çš„ IP çš„æµé‡éƒ½ä¼šé€šè¿‡ **wg0** ç½‘å¡å‘å‡º.

è€Œ MBP çš„è·¯ç”±è¡¨å¦‚ä¸‹æ‰€ç¤º:

```
$ netstat -rn
Routing tables

Internet:
Destination        Gateway            Flags               Netif Expire
...
10.10.4.0/24       link#45            UCS                 utun6
10.10.4.7          link#45            UHWIi               utun6
10.10.4.8          10.10.4.8          UH                  utun6
192.168.21         link#45            UCSI                utun6
192.168.31         link#45            UCSI                utun6
...
```

åŒæ ·æ˜¯åˆ›å»ºäº†å¤šæ¡ç›®æ ‡è·¯ç”±, ä¸”ç”± WireGuard ç½‘å¡å¤„ç†æµé‡

è€Œ M920x åªæœ‰ä¸€æ¡:

```
$ route -n
å†…æ ¸ IP è·¯ç”±è¡¨
ç›®æ ‡            ç½‘å…³            å­ç½‘æ©ç         æ ‡å¿—  è·ƒç‚¹   å¼•ç”¨  ä½¿ç”¨ æ¥å£
0.0.0.0        192.168.31.1    0.0.0.0         UG    101    0        0 eno1
10.10.4.0      0.0.0.0         255.255.255.0   U     0      0        0 wg-aliyun
```

æ‰€ä»¥æ•´ä¸ªæµç¨‹å¦‚ä¸‹:

1. **MBP å‘å‡ºæµé‡**:

   - MBP éœ€è¦è®¿é—® 192.168.31.0/24 ç½‘ç»œ, æµé‡çš„æºåœ°å€ä¸º 10.10.4.8, ç›®æ ‡åœ°å€ä¸º 192.168.31.1.

   - æ ¹æ® MBP çš„ WireGuard é…ç½®, 192.168.31.0/24 å±äº AllowedIPs åˆ—è¡¨.

   - è¯¥æµé‡ä¼šè¢«è·¯ç”±åˆ° MBP çš„ WireGuard éš§é“, å‘é€åˆ°ä¸­ç»§æœåŠ¡å™¨.

     ```
     æºåœ°å€: 10.10.4.8
     ç›®æ ‡åœ°å€: 192.168.31.1
     å‡ºå£è®¾å¤‡: utun6
     ```

2. **ä¸­ç»§æœåŠ¡å™¨å¤„ç†æµé‡**:

   - æ ¹æ®ä¸­ç»§æœåŠ¡å™¨çš„é…ç½®:

     - AllowedIPs åŒ…æ‹¬ 192.168.31.0/24, å› æ­¤æµé‡è¢«è½¬å‘åˆ°ä¸ M920x çš„ WireGuard éš§é“.

   - ä¸­ç»§æœåŠ¡å™¨ä¸Šçš„ MASQUERADE è§„åˆ™è¢«è§¦å‘, å°†æºåœ°å€æ”¹ä¸ºä¸­ç»§æœåŠ¡å™¨çš„ WireGuard åœ°å€ 10.10.4.1.

     ```
     æºåœ°å€: 10.10.4.1 (ç»è¿‡ NAT è½¬æ¢)
     ç›®æ ‡åœ°å€: 192.168.31.1
     å‡ºå£è®¾å¤‡: wg0 (åˆ° M920x)
     ```

3. **M920x æ¥æ”¶æµé‡**:

   - M920x æ”¶åˆ°ä»ä¸­ç»§æœåŠ¡å™¨æ¥çš„æµé‡:

     - æºåœ°å€ä¸º 10.10.4.1
     - ç›®æ ‡åœ°å€ä¸º 192.168.31.1

   - æ ¹æ® M920x çš„ WireGuard é…ç½®:

     - AllowedIPs åŒ…å« 192.168.31.0/24, å› æ­¤æµé‡è¢«è·¯ç”±åˆ°æœ¬åœ°ç½‘ç»œ.

   - æµé‡ç¦»å¼€ M920x, è¿›å…¥å…¶å±€åŸŸç½‘æ¥å£ (eno1) , å¹¶æœ€ç»ˆåˆ°è¾¾ç›®æ ‡è®¾å¤‡ 192.168.31.1.

     ```
     æºåœ°å€: 10.10.4.1
     ç›®æ ‡åœ°å€: 192.168.31.1
     å‡ºå£è®¾å¤‡: eno1
     ```

4. **ç›®æ ‡è®¾å¤‡çš„å“åº”**:

   - ç›®æ ‡è®¾å¤‡ (192.168.31.1) å¤„ç†è¯·æ±‚å, å‘é€å“åº”å›åˆ°æºåœ°å€ 10.10.4.1.

   - å“åº”æµé‡è¿”å›åˆ° M920x çš„å±€åŸŸç½‘æ¥å£.

     ```
     æºåœ°å€: 192.168.31.1
     ç›®æ ‡åœ°å€: 10.10.4.1
     å‡ºå£è®¾å¤‡: eno1
     ```

5. **M920x è¿”å›ä¸­ç»§æœåŠ¡å™¨**:

   - æ ¹æ® WireGuard éš§é“è§„åˆ™, æµé‡è¢«å‘é€å›ä¸­ç»§æœåŠ¡å™¨.

     ```
     æºåœ°å€: 192.168.31.1
     ç›®æ ‡åœ°å€: 10.10.4.1
     å‡ºå£è®¾å¤‡: wg-aliyun
     ```

6. **ä¸­ç»§æœåŠ¡å™¨è¿”å› MBP**:

   - æ ¹æ®ä¸­ç»§æœåŠ¡å™¨çš„ NAT è§„åˆ™, æ¢å¤åŸå§‹æºåœ°å€, å°†ç›®æ ‡åœ°å€æ”¹ä¸º 10.10.4.8.

   - å“åº”æµé‡è¢«è½¬å‘å› MBP.

     ```
     æºåœ°å€: 192.168.31.1
     ç›®æ ‡åœ°å€: 10.10.4.8
     å‡ºå£è®¾å¤‡: wg0 (åˆ° MBP)
     ```

7. **MBP æ¥æ”¶å“åº”**
   - MBP æ”¶åˆ°ä» 192.168.31.1 è¿”å›çš„å“åº”æµé‡, å®Œæˆé€šä¿¡.

å¯¹äºè¿™ç§ä¸­ç»§è½¬å‘æ–¹å¼éƒ¨ç½²çš„ **WireGuard** æœåŠ¡, å…¶ä¸­ PostUp æ˜¯å…³é”®:

```
PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
```

ç”¨äºé…ç½®æµé‡è½¬å‘å’Œ NAT:

1. `iptables -A FORWARD -i %i -j ACCEPT`

   - æ·»åŠ ä¸€æ¡è§„åˆ™, å…è®¸ä» WireGuard æ¥å£ (%i ä¼šè¢« WireGuard è‡ªåŠ¨æ›¿æ¢ä¸ºå®é™…æ¥å£å, å¦‚ wg0) è¿›å…¥çš„æµé‡è¢«è½¬å‘.
   - ç›®çš„: ç¡®ä¿æ¥è‡ª VPN å®¢æˆ·ç«¯çš„æµé‡èƒ½å¤Ÿé€šè¿‡æœåŠ¡å™¨è½¬å‘.

2. `iptables -A FORWARD -o %i -j ACCEPT`

   - æ·»åŠ ä¸€æ¡è§„åˆ™, å…è®¸ä»å…¶ä»–ç½‘ç»œæµå‡ºçš„æµé‡è¢«è½¬å‘åˆ° WireGuard æ¥å£.
   - ç›®çš„: å…è®¸å¤–éƒ¨ç½‘ç»œçš„æ•°æ®åŒ…è¿”å›åˆ° VPN å®¢æˆ·ç«¯.

3. `iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE`
   - åœ¨ NAT è¡¨çš„ POSTROUTING é“¾ä¸­æ·»åŠ ä¸€æ¡è§„åˆ™, å¯¹é€šè¿‡ eth0 æ¥å£çš„æµé‡è¿›è¡Œåœ°å€ä¼ªè£….
   - ç›®çš„: å°† VPN å®¢æˆ·ç«¯çš„ç§æœ‰ IP (å¦‚ 10.10.4.0/24) ä¼ªè£…æˆæœåŠ¡å™¨çš„ eth0 å…¬ç½‘ IP, ä¾¿äºè®¿é—®äº’è”ç½‘æˆ–å¤–éƒ¨ç½‘ç»œ.

#### æ‰“æ´

ä¸Šé¢çš„ **ä¸­ç»§æœåŠ¡å™¨** æ˜¯é€šè¿‡è½¬å‘æµé‡çš„æ–¹å¼è¾¾åˆ°å¼‚åœ°è®¿é—®çš„ç›®çš„, æ¯”å¦‚å¯ä»¥å°†å…¬å¸å’Œå®¶åº­ç½‘ç»œæ‰“é€š, ç»„æˆä¸€ä¸ªå¤§çš„å±€åŸŸç½‘, è¾¾åˆ°å¼‚åœ°äº’è®¿çš„æ•ˆæœ.

ä½†æ˜¯æ‰“æ´åˆ™ä¸åŒ, è¿™é‡Œçš„ä¸­ç»§æœåŠ¡å™¨æœ‰ç‚¹åƒ **Dubbo** ä¸­çš„ **Zookeeper**, èµ·åˆ°ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒçš„ä½œç”¨, ä¸è½¬å‘æµé‡, å½“éš§é“æ‰“é€šå, ä¸¤ç«¯æ˜¯é€šè¿‡ **ç›´è¿** è®¿é—®çš„.

çœ‹è¿‡ [[nat-guide|NAT (Network Address Translation)]] ä¹‹åè‚¯å®šæ¸…æ¥šæ‰“æ´çš„åŸç†, åªè¦éš§é“è¢«æ‰“é€šå, åœ¨ NAT è®°å½•å¤±æ•ˆä¹‹å‰(UDP çº¦ 30 ç§’)æ›´æ–° **WireGuard** çš„é…ç½®å¹¶å»ºç«‹è¿æ¥å°±å¯ä»¥ç›´æ¥é€šä¿¡, å®ç°ç»†èŠ‚å¯ä»¥å‚è€ƒè¿™ç¯‡åšå®¢: [WireGuard Endpoint Discovery and NAT Traversal using DNS-SD](https://www.jordanwhited.com/posts/wireguard-endpoint-discovery-nat-traversal/), å¾ˆæœ‰å¯å‘æ„ä¹‰.

<!--
[ä¸Šä¸€ç¯‡çš„ç¿»è¯‘](https://icloudnative.io/posts/wireguard-endpoint-discovery-nat-traversal/)
-->

---

#### WireGuard å®¢æˆ·ç«¯

å„å¤§åº”ç”¨å•†åº—ç›´æ¥æœ **WireGuard** å³å¯, å…è´¹å¥½ç”¨. ä½†æ˜¯ä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜: **åªèƒ½åŒæ—¶å¼€å¯ä¸€ä¸ªå®¢æˆ·ç«¯é…ç½®**, å¯¹æˆ‘æˆ‘è¿™ç§æœ‰å¤šä¸ªæœåŠ¡ç«¯ä¸”éœ€è¦åšå¤æ‚å‡è¡¡çš„éœ€æ±‚å°±æ»¡è¶³ä¸äº†, æ‰€ä»¥å®˜æ–¹çš„å®¢æˆ·ç«¯å°±æ²¡åœ¨ä½¿ç”¨äº†, æ¥ä¸‹æ¥æˆ‘å°†åœ¨ Surge ä¸Šé…ç½®å¤šä¸ª WireGuard æœåŠ¡ç«¯, ä¸”æ ¹æ®ç½‘ç»œæƒ…å†µè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜çš„æœåŠ¡ç«¯.

##### Surge ä¸Šé…ç½® WireGuard

Surge é…ç½® WireGuard éå¸¸ç®€å•:

```
[WireGuard èŠ‚ç‚¹å]
private-key = <å®¢æˆ·ç«¯ç§é’¥>
self-ip = å®¢æˆ·ç«¯ IP (ä¸ç”¨åŠ å­ç½‘æ©ç , æ¯”å¦‚ 10.10.4.8)
dns-server = è‡ªå®šä¹‰
mtu = 1420
peer = (public-key = <æœåŠ¡ç«¯å…¬é’¥>, allowed-ips = "0.0.0.0/0, ::/0", endpoint = <æœåŠ¡ç«¯å…¬ç½‘ IP>:<ç«¯å£>, preshared-key = <é¢„å…±äº«å¯†é’¥, æ²¡æœ‰å°±ä¸åŠ >, keepalive = 45)
```

**allowed-ips** æˆ‘è¿™é‡Œé…ç½®æ˜¯æ‰€æœ‰æµé‡, åç»­ä¼šé€šè¿‡ **Rule** æ¥åˆ†æµç‰¹å®šæµé‡.

ç„¶ååœ¨ **Proxy** èŠ‚ç‚¹ä¸‹ä½¿ç”¨æ­¤èŠ‚ç‚¹:

```
ğŸ§¬ Node = wireguard, section-name=èŠ‚ç‚¹å, test-url=å¯ä»¥æ˜¯ä½ å†…ç½‘çš„ IP(æ¯”å¦‚ http://192.168.31.1), ip-version=v4-only

ğŸ›œ AX9000 = direct, test-url=http://192.168.31.1, test-timeout=1
```

æœ€åé…ç½®ç›¸åº”çš„è§„åˆ™:

```
[Rule]
# æ‰€æœ‰æ¥è‡ª 192.168.31.0/24 çš„è¯·æ±‚å…¨éƒ¨ä½¿ç”¨ WireGuard å¤„ç†
OR,((IP-CIDR,192.168.31.0/24,no-resolve), (DOMAIN-SUFFIX,xxx)),ğŸ§¬ Node
...
```

ä¸Šè¿°æ˜¯ä¸€ä¸ªæœ€åŸºç¡€çš„é…ç½®, å…¶ä»–æ›´å¤šçš„é…ç½®å’Œæ³¨æ„äº‹é¡¹å¯æŸ¥çœ‹ [å®˜æ–¹æ•™ç¨‹](https://manual.nssurge.com/policy/wireguard.html).

æˆ‘çš„é…ç½®ç¨å¾®å¤æ‚ä¸€ç‚¹, éœ€æ±‚å¤§è‡´å¦‚ä¸‹:

1. åœ¨å…¬å¸(å¼‚åœ°)èƒ½è®¿é—®å®¶é‡Œçš„ç”µä¿¡å’Œè”é€šå†…ç½‘;
2. åœ¨å…¬å¸è®¿é—®å…¬å¸å†…ç½‘èµ°ç›´è¿, ä¸èµ° WireGuard;
3. åœ¨å®¶èƒ½è®¿é—®å…¬å¸å†…ç½‘;
4. åœ¨å®¶è®¿é—®ç”µä¿¡å’Œè”é€šå†…ç½‘èµ°ç›´è¿, ä¸èµ° WireGuard;
5. å¦‚æœåªè¿æ¥äº†ç”µä¿¡æˆ–è”é€šå…¶ä¸­æŸä¸€ä¸ªå†…ç½‘, ä¹Ÿèƒ½é€šè¿‡ WireGuard è®¿é—®å¦ä¸€ä¸ªå†…ç½‘;

ä¸ºäº†æ»¡è¶³ä¸Šè¿°éœ€æ±‚, æˆ‘ä»¬éœ€è¦ç»“åˆ Surge çš„ **fallback** å’Œ **subnet** ç›¸å…³çš„ç‰¹æ€§, ä¸‹é¢æ˜¯å…·ä½“é…ç½®.

1. é…ç½® **WireGuard** èŠ‚ç‚¹:

   {% folding ğŸª¬ å¤šèŠ‚ç‚¹é…ç½®: %}

   ```
   [WireGuard H28K]
   private-key = <å®¢æˆ·ç«¯ç§é’¥>
   self-ip = å®¢æˆ·ç«¯ IP (ä¸ç”¨åŠ å­ç½‘æ©ç , æ¯”å¦‚ 10.10.4.8)
   dns-server = è‡ªå®šä¹‰
   mtu = 1420
   peer = (public-key = <æœåŠ¡ç«¯å…¬é’¥>, allowed-ips = "0.0.0.0/0, ::/0", endpoint = <æœåŠ¡ç«¯å…¬ç½‘ IP>:<ç«¯å£>, preshared-key = <é¢„å…±äº«å¯†é’¥, æ²¡æœ‰å°±ä¸åŠ >, keepalive = 25)

   [WireGuard R2S.T]
   private-key = <å®¢æˆ·ç«¯ç§é’¥>
   self-ip = å®¢æˆ·ç«¯ IP (ä¸ç”¨åŠ å­ç½‘æ©ç , æ¯”å¦‚ 10.10.4.8)
   dns-server = è‡ªå®šä¹‰
   mtu = 1420
   peer = (public-key = <æœåŠ¡ç«¯å…¬é’¥>, allowed-ips = "0.0.0.0/0, ::/0", endpoint = <æœåŠ¡ç«¯å…¬ç½‘ IP>:<ç«¯å£>, preshared-key = <é¢„å…±äº«å¯†é’¥, æ²¡æœ‰å°±ä¸åŠ >, keepalive = 25)

   [WireGuard R2S.U]
   private-key = <å®¢æˆ·ç«¯ç§é’¥>
   self-ip = å®¢æˆ·ç«¯ IP (ä¸ç”¨åŠ å­ç½‘æ©ç , æ¯”å¦‚ 10.10.4.8)
   dns-server = è‡ªå®šä¹‰
   mtu = 1420
   peer = (public-key = <æœåŠ¡ç«¯å…¬é’¥>, allowed-ips = "0.0.0.0/0, ::/0", endpoint = <æœåŠ¡ç«¯å…¬ç½‘ IP>:<ç«¯å£>, preshared-key = <é¢„å…±äº«å¯†é’¥, æ²¡æœ‰å°±ä¸åŠ >, keepalive = 25)

   [WireGuard R5S]
   private-key = <å®¢æˆ·ç«¯ç§é’¥>
   self-ip = å®¢æˆ·ç«¯ IP (ä¸ç”¨åŠ å­ç½‘æ©ç , æ¯”å¦‚ 10.10.4.8)
   dns-server = è‡ªå®šä¹‰
   mtu = 1420
   peer = (public-key = <æœåŠ¡ç«¯å…¬é’¥>, allowed-ips = "0.0.0.0/0, ::/0", endpoint = <æœåŠ¡ç«¯å…¬ç½‘ IP>:<ç«¯å£>, preshared-key = <é¢„å…±äº«å¯†é’¥, æ²¡æœ‰å°±ä¸åŠ >, keepalive = 25)

   [WireGuard M920X]
   private-key = <å®¢æˆ·ç«¯ç§é’¥>
   self-ip = å®¢æˆ·ç«¯ IP (ä¸ç”¨åŠ å­ç½‘æ©ç , æ¯”å¦‚ 10.10.4.8)
   dns-server = è‡ªå®šä¹‰
   mtu = 1420
   peer = (public-key = <æœåŠ¡ç«¯å…¬é’¥>, allowed-ips = "0.0.0.0/0, ::/0", endpoint = <æœåŠ¡ç«¯å…¬ç½‘ IP>:<ç«¯å£>, preshared-key = <é¢„å…±äº«å¯†é’¥, æ²¡æœ‰å°±ä¸åŠ >, keepalive = 25)

   [WireGuard DS218+]
   private-key = <å®¢æˆ·ç«¯ç§é’¥>
   self-ip = å®¢æˆ·ç«¯ IP (ä¸ç”¨åŠ å­ç½‘æ©ç , æ¯”å¦‚ 10.10.4.8)
   dns-server = è‡ªå®šä¹‰
   mtu = 1420
   peer = (public-key = <æœåŠ¡ç«¯å…¬é’¥>, allowed-ips = "0.0.0.0/0, ::/0", endpoint = <æœåŠ¡ç«¯å…¬ç½‘ IP>:<ç«¯å£>, preshared-key = <é¢„å…±äº«å¯†é’¥, æ²¡æœ‰å°±ä¸åŠ >, keepalive = 25)

   [WireGuard DS923+]
   private-key = <å®¢æˆ·ç«¯ç§é’¥>
   self-ip = å®¢æˆ·ç«¯ IP (ä¸ç”¨åŠ å­ç½‘æ©ç , æ¯”å¦‚ 10.10.4.8)
   dns-server = è‡ªå®šä¹‰
   mtu = 1420
   peer = (public-key = <æœåŠ¡ç«¯å…¬é’¥>, allowed-ips = "0.0.0.0/0, ::/0", endpoint = <æœåŠ¡ç«¯å…¬ç½‘ IP>:<ç«¯å£>, preshared-key = <é¢„å…±äº«å¯†é’¥, æ²¡æœ‰å°±ä¸åŠ >, keepalive = 25)

   [WireGuard R2S.C]
   private-key = <å®¢æˆ·ç«¯ç§é’¥>
   self-ip = å®¢æˆ·ç«¯ IP (ä¸ç”¨åŠ å­ç½‘æ©ç , æ¯”å¦‚ 10.10.4.8)
   dns-server = è‡ªå®šä¹‰
   mtu = 1420
   peer = (public-key = <æœåŠ¡ç«¯å…¬é’¥>, allowed-ips = "0.0.0.0/0, ::/0", endpoint = <æœåŠ¡ç«¯å…¬ç½‘ IP>:<ç«¯å£>, preshared-key = <é¢„å…±äº«å¯†é’¥, æ²¡æœ‰å°±ä¸åŠ >, keepalive = 25)

   [WireGuard Aliyun]
   private-key = <å®¢æˆ·ç«¯ç§é’¥>
   self-ip = å®¢æˆ·ç«¯ IP (ä¸ç”¨åŠ å­ç½‘æ©ç , æ¯”å¦‚ 10.10.4.8)
   dns-server = è‡ªå®šä¹‰
   mtu = 1420
   peer = (public-key = <æœåŠ¡ç«¯å…¬é’¥>, allowed-ips = "0.0.0.0/0, ::/0", endpoint = <æœåŠ¡ç«¯å…¬ç½‘ IP>:<ç«¯å£>, preshared-key = <é¢„å…±äº«å¯†é’¥, æ²¡æœ‰å°±ä¸åŠ >, keepalive = 25)
   ```

   {% endfolding %}

2. é…ç½® **Proxy** èŠ‚ç‚¹:

   ```
   [Proxy]
   ğŸº é˜¿é‡Œäº‘ = wireguard, section-name=Aliyun ip-version=v4-only
   # ########## home ###########
   ğŸ›œ AX9000 = direct, test-url=http://192.168.31.1, test-timeout=1
   ğŸ›œ 6500 = direct, test-url=http://192.168.21.1, test-timeout=1

   # test-url å’Œ test-udp äº¤é”™, ç”¨äºéªŒè¯åŒç½‘å¡æ˜¯å¦æ­£å¸¸
   # | ğŸŒ¤ï¸ H28K | ğŸ¦  R2S.T | ğŸ§¬ R2S.U | ğŸŠ R5S | ğŸ¤¿ M920X | ğŸ‰ DS218+ | ğŸ‘º DS923+ |
   # |   è”é€š  |    ç”µä¿¡  |    è”é€š   |   ç”µä¿¡  |   è”é€š   |    ç”µä¿¡   |     è”é€š  |
   ğŸŒ¤ï¸ H28K = wireguard, section-name=H28K, test-url=http://192.168.31.1, ip-version=v4-only
   ğŸ¦  R2S.T = wireguard, section-name=R2S.T, test-url=http://192.168.21.1, ip-version=v4-only
   ğŸ§¬ R2S.U = wireguard, section-name=R2S.U, test-url=http://192.168.31.1, ip-version=v4-only
   ğŸŠ R5S = wireguard, section-name=R5S, test-url=http://192.168.21.1, ip-version=v4-only
   ğŸ¤¿ M920X = wireguard, section-name=M920X, test-url=http://192.168.31.1, ip-version=v4-only
   ğŸ‰ DS218+ = wireguard, section-name=DS218+, test-url=http://192.168.21.1, ip-version=v4-only
   ğŸ‘º DS923+ = wireguard, section-name=DS923+, test-url=http://192.168.31.1, ip-version=v4-only
   # ########## home ###########

   # ########## work ###########
   ğŸ›œ H3C = direct, test-url=http://192.168.100.1, test-timeout=1
   ğŸ§© R2S.C = wireguard, section-name=R2S.C, test-url=http://192.168.100.1, test-timeout=1
   # ########## work ###########

   ğŸŒ å…¨çƒç›´è¿ = direct
   ğŸš« æ‹’æ¥è¿æ¥ = reject
   ```

   `test-url` è¡¨ç¤ºé€šè¿‡ WireGuard éš§é“èƒ½è®¿é—®çš„åœ°å€, è¿™é‡Œç›´æ¥è®¿é—®è·¯ç”±å™¨çš„ WebUI æ¥æµ‹è¯•, å¦‚æœæ„¿æ„æŠ˜è…¾çš„è¯, ä¹Ÿå¯ä»¥åœ¨ HomeLab è‡ªå»º CaptivePortal æ£€æµ‹æœåŠ¡.

   ğŸ›œ AX9000 å’Œ ğŸ›œ 6500 éƒ½æ˜¯ç›´è¿, ä¸”æµ‹è¯•åœ°å€æ˜¯è·¯ç”±å™¨ç½‘å…³; åŒç† ğŸ›œ H3C çš„æµ‹è¯•åœ°å€æ˜¯å…¬å¸å†…ç½‘çš„ç½‘å…³.

3. é…ç½® **Proxy Group** èŠ‚ç‚¹:

   ```
   [Proxy Group]
   ğŸ¤¿ Team = fallback, ğŸº é˜¿é‡Œäº‘

   ğŸ¦  ALL.in.One = url-test, ğŸ›œ AX9000, ğŸ›œ 6500, ğŸŒ¤ï¸ H28K, ğŸ¦  R2S.T, ğŸ§¬ R2S.U, ğŸŠ R5S, ğŸ¤¿ M920X, ğŸ‰ DS218+, ğŸ‘º DS923+, ğŸ›œ H3C, ğŸ§© R2S.C, no-alert=true, interval = 600
   ğŸ  iHome = url-test, ğŸŒ¤ï¸ H28K, ğŸ¦  R2S.T, ğŸ§¬ R2S.U, ğŸŠ R5S, ğŸ¤¿ M920X, ğŸ‰ DS218+, ğŸ‘º DS923+, tolerance=30, interval = 600
   ğŸ’¼ Company = url-test, ğŸ§© R2S.C, tolerance=30, interval = 600

   # mini-intel å¼€å¯ surge ponte
   ğŸ–¥ï¸ P.Intel = url-test, DEVICE:MINI-INTEL, hidden=true
   ğŸ–¥ï¸ P.TV = url-test, DEVICE:APPLETV, hidden=true

   ğŸ¤¿ Auto.T = fallback, ğŸ›œ AX9000, ğŸ  iHome, ğŸ–¥ï¸ P.Intel, ğŸ–¥ï¸ P.TV, no-alert=true
   ğŸ¥‹ Auto.U = fallback, ğŸ›œ 6500, ğŸ  iHome, ğŸ–¥ï¸ P.Intel, no-alert=true

   ğŸš™ Work = subnet, default = ğŸ’¼ Company, "192.168.100.1" = ğŸ›œ H3C
   ```

å¯¹äºå®¶åº­ç½‘ç»œç›´æ¥æ˜¯ç”¨ **fallback** æ¥å¤„ç†, è¡¨ç¤ºä¼˜å…ˆæ˜¯ç”¨ ğŸ›œ AX9000 å’Œ ğŸ›œ 6500, å› ä¸ºå‰è€…æ˜¯ç›´è¿æ¨¡å¼, è¿æ¥æµ‹è¯•é€šè¿‡åˆ™è¡¨ç¤ºè¿æ¥äº†å®¶åº­ç½‘ç»œ, åˆ™ç›´æ¥ä½¿ç”¨ç›´è¿ æ¨¡å¼; å¦‚æœæ²¡æœ‰è¿æ¥å®¶åº­å†…ç½‘æµ‹è¯•ä¼šå¤±è´¥, åˆ™å›é€€åˆ°ç¬¬äºŒä¸ªè§„åˆ™:ğŸ  iHome ç»„, è€Œ ğŸ  iHome ç»„ æ˜¯ç”±å¤šä¸ª **WireGuard** èŠ‚ç‚¹ç»„æˆ, ä¼šé€‰æ‹©å»¶è¿Ÿæœ€ä½çš„ä¸€ä¸ªè¿æ¥åˆ° å®¶åº­ç½‘ç»œ.

å…¬å¸ç½‘ç»œåˆ™ä½¿ç”¨ `subnet` å¤„ç†, è¡¨ç¤ºå¦‚æœå½“å‰ç½‘ç»œçš„ç½‘å…³æ˜¯ `192.168.100.1` (å…¬å¸ä¸»è·¯ç”±å™¨), åˆ™ä½¿ç”¨ ğŸ’¼ Company ç»„ä¸­å»¶è¿Ÿæœ€ä½çš„èŠ‚ç‚¹, ç°åœ¨åªæœ‰ 1 ä¸ª, å é¢è¿˜å¯ä»¥æ‰©å±•.

4. é…ç½® **Rule** èŠ‚ç‚¹:

   ```
   [Rule]
   OR,((IP-CIDR,192.168.31.0/24,no-resolve), (DOMAIN-SUFFIX,tele)),ğŸ¤¿ Auto.T
   OR,((IP-CIDR,192.168.21.0/24,no-resolve), (DOMAIN-SUFFIX,unic)),ğŸ¥‹ Auto.U
   # ############################ work #############################
   OR,((IP-CIDR,192.168.100.0/24,no-resolve),(DOMAIN-SUFFIX,yy.xxx.com), (DOMAIN-SUFFIX,xxx.info)),ğŸš™ Work
   ```

   è¿™å°±ç®€å•äº†, æ ¹æ® IP æˆ–åŸŸååˆ†æµ. å…¶ä¸­ **tele** å’Œ **unic** æ˜¯æˆ‘è‡ªå®šä¹‰çš„å†…ç½‘åŸŸå, åˆ†åˆ«å¯¹åº”ç”µä¿¡å’Œè”é€šç½‘ç»œ.

ä¸Šè¿°é…ç½®å, 2 ä¸ªå†…ç½‘åˆ†åˆ«ç”±å¤šå°æœåŠ¡å™¨æä¾› WireGuard èŠ‚ç‚¹, å› ä¸º [ç½‘å¡ä¼˜å…ˆçº§çš„åŸå› ](#ç½‘å¡ä¼˜å…ˆçº§çš„é—®é¢˜) åˆ†åˆ«åˆ’åˆ†åˆ°ç”µä¿¡å’Œè”é€šå®½å¸¦å…¥å£, å› ä¸ºæ¯å°æœåŠ¡å™¨è‡³å°‘å­˜åœ¨ 2 ä¸ªç½‘å£ä¸”åˆ†åˆ«è¿æ¥ç”µä¿¡å’Œè”é€šå†…ç½‘, æ‰€ä»¥æˆ‘åªè¦ä»»æ„è¿æ¥ä¸€å°æœåŠ¡å™¨å°±èƒ½è®¿é—®å®¶ä¸­ 2 ä¸ªç½‘ç»œ, å¤šå°è®¾å¤‡èµ·åˆ°è´Ÿè½½å‡è¡¡çš„ä½œç”¨ä¸”ä¸ä¼šå› ä¸ºå•ç‚¹æ•…éšœè®¿é—®ä¸äº†å®¶åº­ç½‘ç»œ(åœç”µä¸ç®—).

![20241229154732_KDb35qW4.webp](https://cdn.dong4j.site/source/image/20241229154732_KDb35qW4.webp)

> å…³äºæ›´å¤šçš„ Surge é…ç½®, åç»­åº”è¯¥è¿˜ä¼šæœ‰æ–‡æ¡£è¾“å‡º.

---

### WireGuard é…ç½®è¯¦è§£

<!--
çœ‹è¿™ä¸ª https://icloudnative.io/posts/wireguard-docs-practice/
è¿™ä¸ªä¹Ÿçœ‹ä¸€ä¸‹ https://www.msl.la/archives/248/
å®˜æ–¹æ–‡æ¡£ç¿»è¯‘: https://cshihong.github.io/2020/10/11/WireGuard%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/
[WireGuard ç™½çš®ä¹¦è§£è¯»](https://www.zhihu.com/column/c_1498091755665240064)
-->

#### è¯¦ç»†é…ç½®

**æœåŠ¡ç«¯**:

```ini
[Interface]
# [å¯é€‰] æ˜¯å¦å°† Endpoint æŒä¹…åŒ–åˆ°é…ç½®æ–‡ä»¶ä¸­, é»˜è®¤ä¸º false
SaveConfig = false
# [å¿…é¡»] å½“å‰èŠ‚ç‚¹åœ¨ WireGuard è™šæ‹Ÿå±€åŸŸç½‘çš„ IP
Address = 10.10.1.1/32
# [å¿…é¡»] æœåŠ¡ç«¯ç›‘å¬çš„ç«¯å£
ListenPort = 51820
# [å¿…é¡»]
PrivateKey = <æœåŠ¡ç«¯å¯†é’¥>
# [å¯é€‰] å®¢æˆ·ç«¯å°†ä¼šä½¿ç”¨è¿™é‡ŒæŒ‡å®šçš„ DNS æœåŠ¡å™¨æ¥å¤„ç† VPN å­ç½‘ä¸­çš„ DNS è¯·æ±‚, ä½†ä¹Ÿå¯ä»¥åœ¨å®¢æˆ·ç«¯ä¸­è¦†ç›–æ­¤é€‰é¡¹
DNS = 1.1.1.1,8.8.8.8
# [å¯é€‰] å®šä¹‰ VPN å­ç½‘ä½¿ç”¨çš„è·¯ç”±è¡¨, é»˜è®¤ä¸éœ€è¦è®¾ç½®, Table = auto (é»˜è®¤å€¼)
# è¿™é‡Œçš„ Table æ˜¯æŒ‡: /etc/iproute2/rt_tables
# å¯ä»¥ä½¿ç”¨ ip route add default via 10.10.1.1 dev eno1 table 12345 æ¥æ‰‹åŠ¨æ·»åŠ 
Table = 12345
# [å¯é€‰] é»˜è®¤ä¸éœ€è¦è®¾ç½®, ä¸€èˆ¬ç”±ç³»ç»Ÿè‡ªåŠ¨ç¡®å®š
MTU = 1500
# [å¯é€‰] å¯åŠ¨ VPN æ¥å£ä¹‹å‰è¿è¡Œçš„å‘½ä»¤. è¿™ä¸ªé€‰é¡¹å¯ä»¥æŒ‡å®šå¤šæ¬¡, æŒ‰é¡ºåºæ‰§è¡Œ
PreUp = /bin/example arg1 arg2 %i
# [å¯é€‰] å¯åŠ¨ VPN æ¥å£ä¹‹åè¿è¡Œçš„å‘½ä»¤. è¿™ä¸ªé€‰é¡¹å¯ä»¥æŒ‡å®šå¤šæ¬¡, æŒ‰é¡ºåºæ‰§è¡Œ
PostUp = /bin/example arg1 arg2 %i
# [å¯é€‰] åœæ­¢ VPN æ¥å£ä¹‹å‰è¿è¡Œçš„å‘½ä»¤. è¿™ä¸ªé€‰é¡¹å¯ä»¥æŒ‡å®šå¤šæ¬¡, æŒ‰é¡ºåºæ‰§è¡Œ
PreDown = /bin/example arg1 arg2 %i
# [å¯é€‰] åœæ­¢ VPN æ¥å£ä¹‹åè¿è¡Œçš„å‘½ä»¤. è¿™ä¸ªé€‰é¡¹å¯ä»¥æŒ‡å®šå¤šæ¬¡, æŒ‰é¡ºåºæ‰§è¡Œ
PostDown = /bin/example arg1 arg2 %i

# Peer: å®šä¹‰èƒ½å¤Ÿä¸ºä¸€ä¸ªæˆ–å¤šä¸ªåœ°å€è·¯ç”±æµé‡çš„å¯¹ç­‰èŠ‚ç‚¹ (peer) çš„ VPN è®¾ç½®
[Peer]
# [å¿…é¡»] å…è®¸è¯¥å¯¹ç­‰èŠ‚ç‚¹ (peer) å‘é€è¿‡æ¥çš„ VPN æµé‡ä¸­çš„æºåœ°å€èŒƒå›´, åˆ†åˆ«åœ¨æµé‡å‡ºç«™å’Œå…¥ç«™æ—¶åŒ¹é…å¹¶è¿›è¡Œå“åº”çš„å¤„ç†
AllowedIPs = 10.10.1.2/32
# [å¿…é¡»]
PublicKey = <å®¢æˆ·ç«¯å…¬é’¥>
# [å¯é€‰] æ ¹æ®åœºæ™¯é…ç½®
PersistentKeepalive = 25
# [å¯é€‰] é¢„å…±äº«å¯†é’¥, ä½¿ç”¨æ­¤é€‰é¡¹ä¸º VPN æ·»åŠ å¦ä¸€å±‚åŠ å¯†ä¿æŠ¤
# ä½¿ç”¨ wg genpsk ç”Ÿæˆé¢„å…±äº«å¯†é’¥, å®¢æˆ·ç«¯çš„ Peer èŠ‚ç‚¹éœ€è¦é…ç½®ç›¸åŒçš„å¯†é’¥
PresharedKey = xxxx
```

**å®¢æˆ·ç«¯**:

```ini
[Interface]
# [å¿…é¡»]
PrivateKey = +AbVMFfuV/b6WbZub9mxaza+YY7qHXA8QhW1wjouZng=
# [å¿…é¡»]
Address = 10.10.1.2/32
# [å¯é€‰] è¦†ç›–æœåŠ¡ç«¯ DNS é…ç½®
DNS = 1.1.1.1,8.8.8.8
# [å¯é€‰] é…ç½®åå°†ä½¿ç”¨å›ºå®šç«¯å£, ä¸åœ¨éšæœº
ListenPort = 51820
# å…¶ä»–çš„å¯é€‰å­—æ®µå‚è€ƒ æœåŠ¡ç«¯é…ç½®

[Peer]
# [å¿…é¡»]
PublicKey = p4U7Q+tz0brH/RFUU+4yFVL7LcrxNFfMBe+NgYiOYj8=
# [å¿…é¡»]
AllowedIPs = 10.10.1.0/24, 192.168.21.0/24, 192.168.31.0/24
# [å¿…é¡»]
Endpoint = <homelab.site:port>
# [å¯é€‰] æ ¹æ®åœºæ™¯é…ç½®
PersistentKeepalive = 25
```

#### Address: 24 vs 32

<!--

è¿™ä¸ªè§£é‡Šäº†: https://ubuntu.com/server/docs/introduction-to-wireguard-vpn

-->

æˆ‘çœ‹ç½‘ä¸Šå…¶ä»–åšå®¢è¯´ **å¦‚æœæ˜¯ä¸­ç»§æœåŠ¡å™¨, å°±éœ€è¦å°†æœåŠ¡ç«¯çš„ Address é…ç½®æˆ /24 å­ç½‘**, ä½†æ˜¯æˆ‘æµ‹è¯•è¿‡ **/32** å­ç½‘ä¹Ÿä¸ä¼šå‡ºç°é—®é¢˜, é‚£ä¹ˆ **Address** ç©¶ç«Ÿå®šä¹‰çš„æ˜¯ä»€ä¹ˆ, å¸¦ç€è¿™ä¸ªç–‘é—®, æˆ‘ä»¬æ¥çœ‹çœ‹ä¸åŒé…ç½®ä¸‹è·¯ç”±çš„å…·ä½“æƒ…å†µ:

**Address = 10.10.1.1/32 æ—¶**:

```shell
$ wg-quick up wg1
[#] ip link add wg1 type wireguard
[#] wg setconf wg1 /dev/fd/63
[#] ip -4 address add 10.10.1.1/32 dev wg1
[#] ip link set mtu 1420 up dev wg1
[#] ip -4 route add 10.10.1.9/32 dev wg1
[#] ip -4 route add 10.10.1.8/32 dev wg1
```

å¯åŠ¨ WireGuard å, è‡ªåŠ¨æ‰§è¡Œçš„æ“ä½œå¦‚ä¸‹:

1. åˆ›å»ºåä¸º wg1 çš„ WireGuard æ¥å£;
2. ä»é…ç½®æ–‡ä»¶åŠ è½½ WireGuard çš„ peer ä¿¡æ¯å’Œå¯†é’¥é…ç½®;
3. ç»™æ¥å£ wg1 åˆ†é… 10.10.1.1/32 çš„ IP åœ°å€;
4. è®¡ç®—é€‚å½“çš„ MTU (å¦‚æœéœ€è¦, å¯ä»¥åœ¨é…ç½®ä¸­è¦†ç›–, WireGuard æ¨è 1420) ;
5. é…ç½®é™æ€è·¯ç”±, ä½¿ 10.10.1.9 å’Œ 10.10.1.8 çš„æµé‡é€šè¿‡ wg1 æ¥å£;

æ·»åŠ çš„è·¯ç”±ä¸º:

```shell
$ ip route show
...
10.10.1.8 dev wg1 scope link
10.10.1.9 dev wg1 scope link
...
```

æ„æ€æ˜¯: **ä»»ä½•æŒ‡å‘ 10.10.1.8 æˆ– 10.10.1.9 çš„æµé‡å°†ç›´æ¥é€šè¿‡ wg1 æ¥å£å‘é€, æ— éœ€ç»è¿‡ç½‘å…³**.

**Address = 10.10.1.1/24 æ—¶**:

```shell
$ wg-quick up wg1
[#] ip link add wg1 type wireguard
[#] wg setconf wg1 /dev/fd/63
[#] ip -4 address add 10.10.1.1/24 dev wg1
[#] ip link set mtu 1420 up dev wg1
```

æ·»åŠ çš„è·¯ç”±ä¸º:

```shell
$ ip route show
...
10.10.1.0/24 dev wg1 proto kernel scope link src 10.10.1.1
...
```

è¿™æ¡è·¯ç”±è¡¨ç¤º: **æ‰€æœ‰æŒ‡å‘ 10.10.1.0/24 ç½‘ç»œçš„æµé‡å°†é€šè¿‡ wg1 æ¥å£ç›´æ¥å‘é€, ä¸”æ•°æ®åŒ…çš„æºåœ°å€ä¸º 10.10.1.1.**

å’Œé…ç½® **/24** å­ç½‘çš„å”¯ä¸€åŒºåˆ«å°±æ˜¯ä½¿ç”¨ `10.10.1.0/24` ä»£æ›¿äº†å•ç‹¬é…ç½®çš„ `10.10.1.8`å’Œ `10.10.1.9`, ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹ **10.10.1.1** å¦‚ä½•è·¯ç”±:

```shell
$ ip route get 10.10.1.1
local 10.10.1.1 dev lo table local src 10.10.1.1 uid 0
    cache <local>

$ ip route show table local

# /32 å­ç½‘è¾“å‡ºå¦‚ä¸‹
local 10.10.1.1 dev wg1 proto kernel scope host src 10.10.1.1

# /24 å­ç½‘è¾“å‡ºå¦‚ä¸‹
local 10.10.1.1 dev wg1 proto kernel scope host src 10.10.1.1
broadcast 10.10.1.255 dev wg1 proto kernel scope link src 10.10.1.1
```

ä¸ç®¡å¦‚ä½•é…ç½®, éƒ½æ˜¯ä½¿ç”¨ local è·¯ç”±è¡¨, ä¸åŒçš„æ˜¯ **/24** å¤šäº†ä¸€æ¡å¹¿æ’­é…ç½®, æ„æ€æ˜¯å½“è¦å‘å¹¿æ’­åœ°å€ 10.10.1.255 å‘é€æ•°æ®åŒ…æ—¶, æµé‡ä¼šç›´æ¥é€šè¿‡ wg1 æ¥å£å¹¿æ’­åˆ°åŒä¸€å­ç½‘å†…çš„å…¶ä»–è®¾å¤‡.

**æ‰€ä»¥æˆ‘åªæ˜¯æƒ³ç¡®è®¤ä¸€ä¸ªé—®é¢˜: /32 å’Œ /24 å­ç½‘åˆ†åˆ«åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ä½¿ç”¨**:

| **åœºæ™¯**                   | **æ¨èå­ç½‘** | **ç†ç”±**                                  |
| -------------------------- | ------------ | ----------------------------------------- |
| ç‚¹å¯¹ç‚¹ä¸­ç»§                 | `/32`        | ç²¾ç¡®æ§åˆ¶ç›®æ ‡è·¯ç”±, å‡å°‘å¹¿æ’­, æå‡å®‰å…¨æ€§.   |
| å¤šç‚¹æˆ–å­ç½‘ä¸­ç»§             | `/24`        | é€‚åˆå¤šä¸ªè®¾å¤‡åœ¨åŒä¸€å­ç½‘é€šä¿¡, ç®€åŒ–è·¯ç”±ç®¡ç†. |
| éœ€è¦èŠ‚çœè·¯ç”±è¡¨èµ„æº         | `/32`        | åªå¤„ç†ç‰¹å®š IP, é¿å…å¤§èŒƒå›´å¹¿æ’­.            |
| éœ€è¦å…¨ç½‘è‡ªåŠ¨å‘ç°å’Œå¹¿æ’­é€šä¿¡ | `/24`        | å…è®¸æ‰€æœ‰åŒä¸€å­ç½‘çš„è®¾å¤‡è‡ªåŠ¨äº’è”.           |

ç»¼ä¸Šæ‰€è¿°, **æœåŠ¡ç«¯çš„ Address é…ç½®åªæ˜¯ä»£è¡¨å½“å‰èŠ‚ç‚¹åœ¨å±€åŸŸç½‘ä¸­çš„è®¾å¤‡ IP. å¦‚æœéè¦è¯´å½±å“, æˆ‘è§‰å¾—åªèƒ½æ˜¯åˆ›å»ºçš„è·¯ç”±æ•°é‡ä¸åŒå¯¼è‡´çš„å ç”¨ç³»ç»Ÿèµ„æºä¸åŒç½¢äº†.**

> æ‰€ä»¥ä¸ªäººå»ºè®®å¦‚æœåªæ˜¯å°‘é‡è®¾å¤‡, ç›´æ¥é…ç½®æˆ /32 å­ç½‘å³å¯, è‡³äºä»€ä¹ˆæ‰æ˜¯ **å°‘é‡è®¾å¤‡** å°±éœ€è¦è‡ªå·±å»å®šå¤ºäº†, åæ­£æˆ‘ 10+ èŠ‚ç‚¹å…¨éƒ¨é…ç½®æˆäº† /32 å­ç½‘.

---

#### AllowedIPs çš„ä½œç”¨

<!--

è¯´ä¸€ä¸‹è¯·æ±‚ä¸å“åº”çš„ç»†èŠ‚ https://zh-wireguard.com/#conceptual-overview

-->

ç®€å•æ¥è¯´: **å½“å‘é€æ•°æ®åŒ…æ—¶, AllowedIPs åˆ—è¡¨è¡¨ç°ä¸ºä¸€ç§è·¯ç”±è¡¨, è€Œå½“æ¥æ”¶æ•°æ®åŒ…æ—¶, å…è®¸çš„ IP åˆ—è¡¨è¡¨ç°ä¸ºä¸€ç§è®¿é—®æ§åˆ¶åˆ—è¡¨**:

å‰é¢æˆ‘ä»¬å·²ç»çŸ¥é“å¯åŠ¨ WireGuard å, ä¼šå°† AllowedIPs IP åˆ—è¡¨æ·»åŠ åˆ°è·¯ç”±è¡¨;

1. å‘é€æ•°æ®æ—¶æ ¹æ®è¿™ä¸ªè·¯ç”±è¡¨é€‰æ‹©åˆé€‚çš„èŠ‚ç‚¹åŠ å¯†æ•°æ®å¹¶å‘é€;
2. æ¥å—åˆ°æ•°æ®æ—¶å…ˆè§£å¯†, æˆåŠŸåè¿˜éœ€è¦å¯¹æ¯”æŒ‡å®šèŠ‚ç‚¹çš„ AllowedIPs IP åˆ—è¡¨ä¸æ•°æ®è¡¨çš„æºåœ°å€æ˜¯å¦åŒ¹é…;

ä¸ºäº†æ›´å¥½åœ°ç†è§£ **WireGuard** å¦‚ä½•å¤„ç†æ•°æ®åŒ…çš„ä¼ è¾“å’Œå®‰å…¨æ€§, æˆ‘ä»¬å°†è¯¦ç»†ä»‹ç»å…¶åŠ è§£å¯†è¿‡ç¨‹, è¿™å°†å¸®åŠ©æˆ‘ä»¬æ·±å…¥ç†è§£ `AllowedIPs` å‚æ•°çš„é‡è¦æ€§.

**å‘é€æ•°æ®(åŠ å¯†è¿‡ç¨‹)**:

1.  **ç”Ÿæˆä¼šè¯å¯†é’¥**:

    - æ¯ä¸ª WireGuard å¯¹ç­‰æ–¹ (å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯) åœ¨å»ºç«‹è¿æ¥æ—¶ä¼šä½¿ç”¨ **Curve25519** ç®—æ³•ç”Ÿæˆ **å…±äº«å¯†é’¥** (Diffie-Hellman å¯†é’¥äº¤æ¢) .
    - è¿™ä¸ªå¯†é’¥äº¤æ¢åŸºäºåŒæ–¹çš„å…¬é’¥å’Œç§é’¥æ¥ç”Ÿæˆä¼šè¯å¯†é’¥, è¯¥å¯†é’¥æ˜¯å¯¹ç§°çš„, æ„å‘³ç€åŒæ–¹éƒ½èƒ½ç”¨å®ƒåŠ å¯†å’Œè§£å¯†æ•°æ®.
    - å‡è®¾å®¢æˆ·ç«¯çš„ç§é’¥ä¸º sk_c, å…¬é’¥ä¸º pk_c, æœåŠ¡ç«¯çš„ç§é’¥ä¸º sk_s, å…¬é’¥ä¸º pk_s. åŒæ–¹ä¼šé€šè¿‡äº¤æ¢å…¬é’¥å¹¶ç”¨å¯¹æ–¹çš„å…¬é’¥ä¸è‡ªå·±ç§é’¥ç”Ÿæˆä¸€ä¸ªå…±äº«çš„ä¼šè¯å¯†é’¥.

2.  **åŠ å¯†æ•°æ®**:

    - æ•°æ®åŒ…ä¼šä½¿ç”¨ **ChaCha20** ç®—æ³•è¿›è¡ŒåŠ å¯†. ä½¿ç”¨å…±äº«çš„ä¼šè¯å¯†é’¥æ¥åŠ å¯†å‘é€çš„æ•°æ®.
    - **Poly1305** ç”¨äºæ•°æ®åŒ…çš„è®¤è¯, ç¡®ä¿æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æœªè¢«ç¯¡æ”¹. å®ƒä¼šç”Ÿæˆä¸€ä¸ªæ¶ˆæ¯éªŒè¯ç  (MAC) , å¹¶é™„åŠ åˆ°åŠ å¯†æ•°æ®ä¸Š.
    - åŠ å¯†çš„è¿‡ç¨‹ä½¿ç”¨çš„æ˜¯æµåŠ å¯†çš„æ–¹å¼, é€šè¿‡ä¼šè¯å¯†é’¥ç”Ÿæˆçš„ä¼ªéšæœºæµæ¥åŠ å¯†æ•°æ®.

3.  **å°è£…æ•°æ®åŒ…**:

    - åŠ å¯†åçš„æ•°æ®ä¼šè¢«å°è£…æˆ WireGuard æ•°æ®åŒ…, å…¶ä¸­åŒ…æ‹¬:

      - ç›®æ ‡åœ°å€
      - åŠ å¯†åçš„æœ‰æ•ˆè´Ÿè½½
      - æ¶ˆæ¯è®¤è¯ç  (MAC)
      - å‘é€è€…çš„èº«ä»½æ ‡è¯†

4.  **å‘é€æ•°æ®åŒ…**:
    - æ•°æ®åŒ…ä¼šé€šè¿‡ UDP å‘é€åˆ°ç›®æ ‡çš„è¿œç¨‹ç«¯ç‚¹ (ä¾‹å¦‚, IP åœ°å€å’Œç«¯å£) .

**æ¥æ”¶æ•°æ®(è§£å¯†è¿‡ç¨‹)**:

1. **æ¥æ”¶æ•°æ®åŒ…**:

   - æ¥æ”¶æ–¹é€šè¿‡ UDP æ”¶åˆ°ä¸€ä¸ªæ•°æ®åŒ…, è¿™ä¸ªæ•°æ®åŒ…å¯èƒ½æ˜¯åŠ å¯†çš„.

2. **éªŒè¯æ¶ˆæ¯è®¤è¯ç (MAC)**:

   - è§£å¯†å‰, æ¥æ”¶æ–¹ä¼šå…ˆä½¿ç”¨ **Poly1305** ç®—æ³•æ£€æŸ¥æ•°æ®çš„å®Œæ•´æ€§, ç¡®ä¿æ•°æ®åŒ…åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æœªè¢«ç¯¡æ”¹.
   - å¦‚æœéªŒè¯å¤±è´¥, æ•°æ®åŒ…ä¼šè¢«ä¸¢å¼ƒ.

3. **è§£å¯†æ•°æ®**:

   - å¦‚æœæ¶ˆæ¯éªŒè¯é€šè¿‡, æ¥æ”¶æ–¹ä½¿ç”¨ **ChaCha20** ç®—æ³•ä¸å…±äº«å¯†é’¥è§£å¯†æ•°æ®.
   - å…±äº«å¯†é’¥æ˜¯é€šè¿‡åŒæ–¹çš„å…¬é’¥å’Œç§é’¥ç”Ÿæˆçš„ Diffie-Hellman ä¼šè¯å¯†é’¥æ¥è§£å¯†æ•°æ®.
   - è§£å¯†å, æ¢å¤å‡ºåŸå§‹çš„æ˜æ–‡æ•°æ®.

4. **æ£€æŸ¥æ•°æ®åŒ…çš„æ¥æº**:
   - è§£å¯†å, æ¥æ”¶æ–¹è¿˜éœ€è¦æ£€æŸ¥æ•°æ®åŒ…çš„æ¥æº. å¦‚æœæ•°æ®åŒ…æ˜¯æ¥è‡ªä¸€ä¸ªæœªè¢«æˆæƒçš„æº, æˆ–è€…ä¸ç¬¦åˆæ¥æ”¶æ–¹çš„å®‰å…¨ç­–ç•¥, æ•°æ®åŒ…å°†è¢«ä¸¢å¼ƒ.

---

å®¢æˆ·ç«¯åœ¨å‘é€æ•°æ®æ—¶, ä¼šé€šè¿‡ **AllowedIPs** é€‰æ‹© Peer èŠ‚ç‚¹(æºåœ°å€ IP å’Œ AoolwedIPs åŒ¹é…), ç„¶åä½¿ç”¨ç¡®å®šçš„ Peer **ä¼šè¯å¯†é’¥**(æœåŠ¡ç«¯çš„å…¬é’¥å’Œ Peer çš„ç§é’¥é€šè¿‡ **Curve25519** ç”Ÿæˆ)å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†;

å½“æ•°æ®åˆ°è¾¾æœåŠ¡ç«¯æ—¶, ä¼šç”¨æ‰€æœ‰å·²çŸ¥å®¢æˆ·ç«¯çš„ä¼šè¯å¯†é’¥é€ä¸€å°è§£å¯†å¹¶è¯•éªŒè¯æ¶ˆæ¯å®Œæ•´æ€§,ä¸€æ—¦åŒ¹é…åˆ°æœ‰æ•ˆçš„ä¼šè¯å¯†é’¥, å³å¯ç¡®è®¤æ•°æ®åŒ…æ˜¯ç”±å¯¹åº”çš„å®¢æˆ·ç«¯å‘é€, è§£å¯†åçš„æ•°æ®åŒ…ä¸­æœ‰æºåœ°å€(IP Header) ä¸­, è¿™æ—¶æœåŠ¡ç«¯çš„ WireGuard å°±ä¼šå°†æºåœ°å€å’Œå®¢æˆ·ç«¯çš„ **AllowedIPs** è¿›è¡ŒåŒ¹é…, å¦‚æœç›¸åŒæˆ–åœ¨å…è®¸çš„å­ç½‘å†…, åˆ™æ¥å—æ•°æ®åŒ…;

å½“æœåŠ¡ç«¯å¤„ç†å®Œåéœ€è¦å‘å®¢æˆ·ç«¯å‘é€å“åº”æ•°æ®æ—¶, æœåŠ¡ç«¯ä¼šæŸ¥çœ‹å“åº”æ•°æ®çš„ç›®æ ‡ IP, å¹¶å°†å…¶ä¸æ¯ä¸ªå®¢æˆ·ç«¯çš„ **AllowedIPs** åˆ—è¡¨è¿›è¡Œæ¯”è¾ƒ, ä»¥ç¡®å®šå°†å…¶å‘é€åˆ°å“ªä¸ªå®¢æˆ·ç«¯.

ä»¥ä¸Šå°±æ˜¯ WireGuard çš„åŠ è§£å¯†è¿‡ç¨‹, ä»ä¸­æˆ‘ä»¬å¯ä»¥æ˜ç¡® **AllowedIPs** çš„ä½œç”¨.

é‚£ä¹ˆé—®é¢˜æ¥äº†:

1. ä¸åŒçš„ Peer å¯ä»¥æœ‰ç›¸åŒçš„ **AllowedIPs** å—ï¼Ÿå³ Peer1 å’Œ Peer2 çš„ **AllowedIPs** éƒ½ä¸º `1.1.1.1/32` æˆ–è€…éƒ½ä¸º `1.1.1.0/24`;
2. å¦‚æœä¸€ä¸ª Peer çš„ **AllowedIPs** åŒ…å«äº†å¦å¤–ä¸€ä¸ª Peer çš„ **AllowedIPs**, é‚£ä¹ˆä¼šè½åˆ°å“ªä¸ª Peer ä¸Šï¼Ÿå³ Peer1 çš„ **AllowedIPs** ä¸º `1.1.1.0/24`, Peer2 çš„ **AllowedIPs** ä¸º `1.1.1.1/32`, ç›®çš„ IP ä¸º `1.1.1.1/32` çš„åŒ…ä¼šå‘é€ç»™ Peer1 è¿˜æ˜¯ Peer2 å‘¢ï¼Ÿ

ä¸ºäº†è§£é‡Šä¸Šé¢çš„é—®é¢˜, æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ **AllowedIPs** çš„å…·ä½“å®ç°: WireGuard ä½¿ç”¨å‰ç¼€æ ‘æ¥ç»´æŠ¤ **AllowedIPs**, ä¸‹é¢æ˜¯å®ç°é€»è¾‘:

```go
func (node *trieEntry) lookup(ip []byte) *Peer {
  // ç”¨æ¥å­˜å‚¨æ‰¾åˆ°çš„æœ€è¿‘åŒ¹é…çš„ Peer
	var found *Peer
  // IP åœ°å€çš„é•¿åº¦, é€šå¸¸æ˜¯ 4 (IPv4) æˆ– 16 (IPv6)
	size := uint8(len(ip))
  // å¦‚æœç›®æ ‡ IP ä¸å½“å‰èŠ‚ç‚¹çš„å‰ç¼€åŒ¹é…é•¿åº¦å¤§äºç­‰äºå½“å‰èŠ‚ç‚¹çš„ CIDR, ç»§ç»­å¾€ä¸‹èµ°
	for node != nil && commonBits(node.bits, ip) >= node.cidr {
    // å¦‚æœå½“å‰èŠ‚ç‚¹å…³è”äº†ä¸€ä¸ª Peer, æ›´æ–° found, è¡¨ç¤ºæ‰¾åˆ°äº†ä¸€ä¸ªæ›´åŒ¹é…çš„ Peer.
		if node.peer != nil {
			found = node.peer
		}
    // å¦‚æœå·²æ£€æŸ¥å®Œç›®æ ‡ IP çš„æ‰€æœ‰å­—èŠ‚, ç»“æŸæŸ¥æ‰¾
		if node.bitAtByte == size {
			break
		}
    // æ ¹æ®å½“å‰ IP åœ°å€çš„æŸä¸€ä½å†³å®šå¾€å·¦å­æ ‘ (0) è¿˜æ˜¯å³å­æ ‘ (1) ç»§ç»­æŸ¥æ‰¾
		bit := node.choose(ip)
    // è·³åˆ°å­æ ‘èŠ‚ç‚¹
		node = node.child[bit]
	}
	return found
}
```

**æ•´ä½“æµç¨‹**:

1. **é€å±‚æ¯”è¾ƒå‰ç¼€**: ä»æ ¹èŠ‚ç‚¹å¼€å§‹, é€å±‚æ¯”è¾ƒ IP åœ°å€çš„å‰ç¼€éƒ¨åˆ†, ç¡®è®¤æ˜¯å¦åŒ¹é…å½“å‰èŠ‚ç‚¹.
2. **æ›´æ–°åŒ¹é…çš„** Peer: å¦‚æœå½“å‰èŠ‚ç‚¹åŒ¹é…ç›®æ ‡ IP ä¸”å…³è” Peer, å°† Peer è®°å½•ä¸‹æ¥.
3. **é€‰æ‹©å­æ ‘ç»§ç»­åŒ¹é…**: æ ¹æ® IP åœ°å€çš„ä½ä¿¡æ¯, é€‰æ‹©å·¦å­æ ‘æˆ–å³å­æ ‘.
4. **è¿”å›æœ€ç»ˆåŒ¹é…**: è¿”å›æœ€é•¿å‰ç¼€åŒ¹é…çš„ Peer.

---

å¦‚æœ Peer1 çš„ **AllowedIPs** ä¸º 10.10.1.0/24, Peer2 çš„ **AllowedIPs** ä¸º 10.10.1.2/32, Peer3 çš„ **AllowedIPs** ä¸º 192.168.31.0/24, ç›®çš„ IP ä¸º 10.10.1.2/32, å®ƒçš„å‰ç¼€æ ‘çœ‹èµ·æ¥æ˜¯è¿™æ ·å­çš„:

```
                                         [root]
                                         /    \
                                  10.* ( )   192.* ( )
                                    |             \
                                 10.10.* ( )    168.*
                                    |               \
                              10.10.1.* (Peer1)    31.* (Peer3)
                                    |
                              10.10.1.2/32 (Peer2)
```

æ‰€ä»¥å¯¹äºä¸Šé¢ 2 ä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯:

1. ä¸èƒ½, æœ€åæ·»åŠ çš„ Peer ä¼šè¦†ç›–å‰é¢çš„ Peer;
2. ç¬¬ä¸€æ¬¡åŒ¹é…åˆ° `10.10.1.*`, æ‰¾åˆ° `10.10.1.0/24`(Peer1), ç„¶åå†æ¬¡åŒ¹é…åˆ° `10.10.1.2/32`(Peer2), æ‰€ä»¥æœ€ååº”è¯¥ä½¿ç”¨ **Peer2** èŠ‚ç‚¹.

---

#### æŒä¹…åŒ– Endpoint

åœ¨æœåŠ¡ç«¯æœ‰è¿™ä¹ˆä¸€ä¸ªé…ç½®:

```
[Interface]
# [å¯é€‰] æ˜¯å¦å°† Endpoint æŒä¹…åŒ–åˆ°é…ç½®æ–‡ä»¶ä¸­, é»˜è®¤ä¸º false
SaveConfig = false
```

å¦‚æœè®¾ç½®ä¸º true, åˆ™ä¼šåœ¨å¿…è¦æ—¶å°†æœ€æ–°çš„ Peer çš„å…¬ç½‘ IP å’Œç«¯å£å†™å…¥åˆ°é…ç½®æ–‡ä»¶ä¸­:

1. æ­£å¸¸æ–­å¼€è¿æ¥æ—¶:

   å½“ WireGuard æ¥å£è¢«å…³é—­ (ä¾‹å¦‚ä½¿ç”¨ wg-quick down å‘½ä»¤æ—¶) , WireGuard ä¼šè‡ªåŠ¨å°†å½“å‰è¿æ¥çš„çŠ¶æ€, åŒ…æ‹¬å¯¹ç­‰ç«¯çš„ **Endpoint** ä¿¡æ¯, å†™å…¥åˆ°é…ç½®æ–‡ä»¶ä¸­.

2. ç³»ç»Ÿé‡å¯æˆ–æœåŠ¡é‡å¯æ—¶:

   å¦‚æœç³»ç»Ÿé‡å¯æˆ– wg-quick æœåŠ¡é‡å¯, WireGuard ä¼šåœ¨é‡å¯å‰ä¿å­˜å½“å‰è¿æ¥çš„çŠ¶æ€, åŒ…æ‹¬ **Endpoint** ä¿¡æ¯.

3. åŠ¨æ€æ›´æ”¹æ—¶:

   å¦‚æœ WireGuard é€šè¿‡æ¥æ”¶åˆ°çš„æ•°æ®åŒ…è‡ªåŠ¨æ›´æ–°äº†å¯¹ç­‰ç«¯çš„ **Endpoint** (ä¾‹å¦‚, é€šè¿‡ NAT ç©¿è¶Šæ—¶å‘ç”Ÿè¿œç¨‹ç«¯ç‚¹ IP æˆ–ç«¯å£çš„å˜åŒ–) , å¹¶ä¸”æ­¤æ—¶è¿æ¥è¢«æ‰‹åŠ¨æ–­å¼€æˆ–æ¥å£è¢«é‡å¯, æœ€æ–°çš„ç«¯ç‚¹ä¿¡æ¯å°†è¢«å†™å…¥é…ç½®æ–‡ä»¶.

æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šç›´æ¥å»é…ç½®æœåŠ¡ç«¯é…ç½®èŠ‚ç‚¹ä¸­çš„ EndPoint, è€Œå®¢æˆ·ç«¯å¿…é¡»é…ç½®, è¿™æ ·æ‰èƒ½çŸ¥é“æ•°æ®åŒ…åº”è¯¥å‘é€åˆ°å“ªé‡Œ, è€Œ WireGuard éœ€è¦çŸ¥é“å›å¤çš„æ•°æ®åŒ…åº”è¯¥å‘é€ç»™è°, æ‰€ä»¥éœ€è¦å°†æ¥å—åˆ°çš„æ•°æ®åŒ…ä¸­çš„æºåœ°å€ IP å’Œç«¯å£è®°ä¸‹æ¥, è€Œå¦‚æœå®¢æˆ·ç«¯çš„å‡ºå£å…¬ç½‘ IP ç«¯ç«¯å£å˜åŒ–äº†, åˆ™æœåŠ¡ç«¯å°±ä¼šåŠ¨æ€å»æ›´æ–°æŒ‡å®šèŠ‚ç‚¹çš„ Endpoint.

---

#### DDNS é—®é¢˜

WireGuard åªä¼šåœ¨å¯åŠ¨æ—¶è§£æåŸŸå, å¦‚æœä½ ä½¿ç”¨ `DDNS` æ¥åŠ¨æ€æ›´æ–°åŸŸåè§£æ, é‚£ä¹ˆæ¯å½“ IP å‘ç”Ÿå˜åŒ–æ—¶, å°±éœ€è¦é‡æ–°å¯åŠ¨ WireGuard. ç²—æš´ç‚¹çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ `PostUp` é’©å­æ¯éš”å‡ åˆ†é’Ÿæˆ–å‡ å°æ—¶é‡æ–°å¯åŠ¨ WireGuard æ¥å¼ºåˆ¶è§£æåŸŸå.

> Linux ä¸Šå†…æ ¸å®ç°çš„ WireGuard , å†…æ ¸ API åªæ¥å— AF_INET æˆ– AF_INET6 çš„ endpoint åœ°å€, æ‰€ä»¥åŸŸåæ˜¯åœ¨ç”¨æˆ·æ€ç”± wg é…ç½®å·¥å…·åœ¨é…ç½®æ—¶åˆ»è§£æçš„, é‚£ä¹ˆ DDNS çš„è¯, è§£æè®°å½•æ›´æ–°å†…æ ¸ä¹Ÿæ— æ³•æ„ŸçŸ¥. è¿˜éœ€è¦ç”¨æˆ·æ€çš„ daemon ç›‘æµ‹å¹¶æ›´æ–°é…ç½®.

å¹¸è¿çš„æ˜¯, wireguard-tools æä¾›äº†ä¸€ä¸ªç¤ºä¾‹è„šæœ¬ `reresolve-dns.sh`, å®ƒå¯ä»¥è§£æ WG é…ç½®æ–‡ä»¶å¹¶è‡ªåŠ¨é‡ç½®ç«¯ç‚¹åœ°å€. éœ€è¦å®šæœŸè¿è¡Œ `reresolve-dns.sh /etc/wireguard/wg.conf` ä»¥ä»å·²æ›´æ”¹å…¶ IP çš„ç«¯ç‚¹ä¸­æ¢å¤. ä¸€ç§æ–¹æ³•æ˜¯é€šè¿‡ systemd è®¡æ—¶å™¨æ¯ä¸‰åç§’æ›´æ–°ä¸€æ¬¡æ‰€æœ‰ WireGuard ç«¯ç‚¹:

{% folding ğŸª¬ reresolve-dns.sh è„šæœ¬: %}

```shell
#!/bin/bash
# SPDX-License-Identifier: GPL-2.0
# Copyright (C) 2015-2020 Jason A. Donenfeld <Jason@zx2c4.com>. All Rights Reserved.

# å¯ç”¨é”™è¯¯æ•è·, ä¸€æ—¦å‡ºé”™, è„šæœ¬å°†ç«‹å³é€€å‡º
set -e

# å¯ç”¨æ— å¤§å°å†™åŒ¹é…å’Œæ‰©å±•æ¨¡å¼
shopt -s nocasematch
shopt -s extglob

# è®¾ç½®è¯­è¨€ç¯å¢ƒä¸º C, ç¡®ä¿è„šæœ¬åœ¨ä¸åŒè¯­è¨€ç¯å¢ƒä¸‹è¡Œä¸ºä¸€è‡´
export LC_ALL=C

# è·å–ç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸ºé…ç½®æ–‡ä»¶å
CONFIG_FILE="$1"

# å¦‚æœå‚æ•°æ˜¯åˆæ³•çš„æ–‡ä»¶å, åˆ™ä½¿ç”¨ /etc/wireguard è·¯å¾„ä¸‹çš„é…ç½®æ–‡ä»¶
[[ $CONFIG_FILE =~ ^[a-zA-Z0-9_=+.-]{1,15}$ ]] && CONFIG_FILE="/etc/wireguard/$CONFIG_FILE.conf"

# ä½¿ç”¨æ­£åˆ™æå–æ¥å£åç§° (ä»æ–‡ä»¶åä¸­æå–)
[[ $CONFIG_FILE =~ /?([a-zA-Z0-9_=+.-]{1,15})\.conf$ ]]
INTERFACE="${BASH_REMATCH[1]}"

# å¤„ç†æ¯ä¸ª Peer çš„å‡½æ•°
process_peer() {
	# åªæœ‰å½“å¤„äº [Peer] æ®µä¸” PublicKey å’Œ Endpoint ä¸ä¸ºç©ºæ—¶æ‰å¤„ç†
	[[ $PEER_SECTION -ne 1 || -z $PUBLIC_KEY || -z $ENDPOINT ]] && return 0

	# æ£€æŸ¥ WireGuard æœ€æ–°æ¡æ‰‹æ—¶é—´æ˜¯å¦è¶…è¿‡ 135 ç§’
	[[ $(wg show "$INTERFACE" latest-handshakes) =~ ${PUBLIC_KEY//+/\\+}\	([0-9]+) ]] || return 0
	(( ($EPOCHSECONDS - ${BASH_REMATCH[1]}) > 135 )) || return 0

	# æ›´æ–° Peer çš„ endpoint (wg set wg0 peer "å…¬é’¥" endpoint "æœ€æ–° IP")
	wg set "$INTERFACE" peer "$PUBLIC_KEY" endpoint "$ENDPOINT"
	reset_peer_section
}

# é‡ç½® Peer æ®µä¿¡æ¯
reset_peer_section() {
	PEER_SECTION=0
	PUBLIC_KEY=""
	ENDPOINT=""
}

# åˆå§‹åŒ– Peer æ®µ
reset_peer_section

# é€è¡Œè¯»å–é…ç½®æ–‡ä»¶
while read -r line || [[ -n $line ]]; do
	# å»é™¤æ³¨é‡Šéƒ¨åˆ†
	stripped="${line%%\#*}"

	# æå–é”®å’Œå€¼, å¹¶å»é™¤é¦–å°¾ç©ºæ ¼
	key="${stripped%%=*}"; key="${key##*([[:space:]])}"; key="${key%%*([[:space:]])}"
	value="${stripped#*=}"; value="${value##*([[:space:]])}"; value="${value%%*([[:space:]])}"

	# å¦‚æœæ˜¯æ–°çš„æ®µè½, å¤„ç†å½“å‰ Peer å¹¶é‡ç½®æ®µè½çŠ¶æ€
	[[ $key == "["* ]] && { process_peer; reset_peer_section; }

	# å¦‚æœè¿›å…¥ [Peer] æ®µ, è®¾ç½®æ ‡å¿—
	[[ $key == "[Peer]" ]] && PEER_SECTION=1

	# å¦‚æœå¤„äº [Peer] æ®µ, æå– PublicKey å’Œ Endpoint ä¿¡æ¯
	if [[ $PEER_SECTION -eq 1 ]]; then
		case "$key" in
		PublicKey) PUBLIC_KEY="$value"; continue ;;
		Endpoint) ENDPOINT="$value"; continue ;;
		esac
	fi
done < "$CONFIG_FILE"

# å¤„ç†æœ€åä¸€ä¸ª Peer
process_peer
```

è¿™ä¸ªè„šæœ¬ç”¨äºè‡ªåŠ¨æ›´æ–° WireGuard ä¸­ç»§æœåŠ¡å™¨é…ç½®æ–‡ä»¶ä¸­çš„ Peer çš„ Endpoint, å½“æœ€æ–°æ¡æ‰‹æ—¶é—´è¶…è¿‡ 135 ç§’æ—¶, é€šè¿‡ wg set æ›´æ–° Peer çš„ Endpoint ä¿¡æ¯.

**ä¸»è¦æ­¥éª¤**:

1. è¯»å–é…ç½®æ–‡ä»¶è·¯å¾„, å¹¶æ ¹æ®è¾“å…¥å‚æ•°ç¡®å®šå…·ä½“è·¯å¾„å’Œæ¥å£åç§°;
2. ä½¿ç”¨ process_peer å‡½æ•°æ£€æŸ¥æ¯ä¸ª Peer, æ ¹æ®æ¡æ‰‹æ—¶é—´åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°;
3. é€šè¿‡æ­£åˆ™åŒ¹é…æå– PublicKey å’Œ Endpoint, ç„¶ååŠ¨æ€è°ƒæ•´ WireGuard é…ç½®;

{% endfolding %}

**ä¸‹é¢æ˜¯ä½¿ç”¨å®˜æ–¹è„šæœ¬çš„æ–¹å¼**:

```shell
git clone https://git.zx2c4.com/wireguard-tools /usr/share/wireguard-tools
```

```shell
# sudo vim /etc/systemd/system/wireguard_reresolve-dns.timer
[Unit]
Description=Periodically reresolve DNS of all WireGuard endpoints
[Timer]
OnCalendar=*:*:0/30
[Install]
WantedBy=timers.target
```

```bash
# sudo vim /etc/systemd/system/wireguard_reresolve-dns.service
[Unit]
Description=Reresolve DNS of all WireGuard endpoints
Wants=network-online.target
After=network-online.target

[Service]
Type=oneshot
ExecStart=/bin/sh -c 'for i in /etc/wireguard/*.conf; do /usr/share/wireguard-tools/contrib/reresolve-dns/reresolve-dns.sh "$i"; done'
```

```bash
sudo systemctl enable wireguard_reresolve-dns.service wireguard_reresolve-dns.timer --now
```

å¦‚æœæ˜¯ **OpenWrt** ç³»ç»Ÿå®‰è£…çš„ **WireGuard** ä¸”ä½œä¸ºå®¢æˆ·ç«¯ä½¿ç”¨çš„è¯, å¯ä»¥ç›´æ¥ä½¿ç”¨è‡ªå¸¦çš„ **DDNS çœ‹é—¨ç‹—è„šæœ¬**, å®šæ—¶ä»»åŠ¡æ·»åŠ ä»¥ä¸‹ **cron** å³å¯:

```shell
* * * * * /usr/bin/wireguard_watchdog
```

---

#### PostUP å’Œ PostDown

**PostUP**: å¯åŠ¨ VPN æ¥å£ä¹‹åè¿è¡Œçš„å‘½ä»¤, è¿™ä¸ªé€‰é¡¹å¯ä»¥æŒ‡å®šå¤šæ¬¡, æŒ‰é¡ºåºæ‰§è¡Œ.

ä¾‹å¦‚:

- ä»æ–‡ä»¶æˆ–æŸä¸ªå‘½ä»¤çš„è¾“å‡ºä¸­è¯»å–é…ç½®å€¼:

  ```ini
  PostUp = wg set %i private-key /etc/wireguard/wg0.key <(some command here)
  ```

- æ·»åŠ ä¸€è¡Œæ—¥å¿—åˆ°æ–‡ä»¶ä¸­:

  ```ini
  PostUp = echo "$(date +%s) WireGuard Started" >> /var/log/wireguard.log
  ```

- è°ƒç”¨ WebHook:

  ```ini
  PostUp = curl https://events.example.dev/wireguard/started/?key=abcdefg
  ```

- æ·»åŠ è·¯ç”±:

  ```ini
  PostUp = ip rule add ipproto tcp dport 22 table 1234
  ```

- æ·»åŠ  iptables è§„åˆ™, å¯ç”¨æ•°æ®åŒ…è½¬å‘:

  ```ini
  PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
  ```

- å¼ºåˆ¶ WireGuard é‡æ–°è§£æå¯¹ç«¯åŸŸåçš„ IP åœ°å€:

  ```ini
  PostUp = resolvectl domain %i "~."; resolvectl dns %i 192.0.2.1; resolvectl dnssec %i yes
  ```

**PostDown**: åœæ­¢ VPN æ¥å£ä¹‹åè¿è¡Œçš„å‘½ä»¤. è¿™ä¸ªé€‰é¡¹å¯ä»¥æŒ‡å®šå¤šæ¬¡, æŒ‰é¡ºåºæ‰§è¡Œ.

- åˆ é™¤ iptables è§„åˆ™, å…³é—­æ•°æ®åŒ…è½¬å‘:

  ```ini
  PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
  ```

---

#### PersistentKeepalive

å¦‚æœè¿æ¥æ˜¯ä»ä¸€ä¸ªä½äº NAT åé¢çš„å¯¹ç­‰èŠ‚ç‚¹ (peer) åˆ°ä¸€ä¸ªå…¬ç½‘å¯è¾¾çš„å¯¹ç­‰èŠ‚ç‚¹ (peer) , é‚£ä¹ˆ NAT åé¢çš„å¯¹ç­‰èŠ‚ç‚¹ (peer) å¿…é¡»å®šæœŸå‘é€ä¸€ä¸ªå‡ºç«™ ping åŒ…æ¥æ£€æŸ¥è¿é€šæ€§, å¦‚æœ IP æœ‰å˜åŒ–, å°±ä¼šè‡ªåŠ¨æ›´æ–°`Endpoint`.

ä¾‹å¦‚:

- æœ¬åœ°èŠ‚ç‚¹ä¸å¯¹ç­‰èŠ‚ç‚¹ (peer) å¯ç›´è¿: è¯¥å­—æ®µä¸éœ€è¦æŒ‡å®š, å› ä¸ºä¸éœ€è¦è¿æ¥æ£€æŸ¥.
- å¯¹ç­‰èŠ‚ç‚¹ (peer) ä½äº NAT åé¢: è¯¥å­—æ®µä¸éœ€è¦æŒ‡å®š, å› ä¸ºç»´æŒè¿æ¥æ˜¯å®¢æˆ·ç«¯ (è¿æ¥çš„å‘èµ·æ–¹) çš„è´£ä»».
- æœ¬åœ°èŠ‚ç‚¹ä½äº NAT åé¢, å¯¹ç­‰èŠ‚ç‚¹ (peer) å…¬ç½‘å¯è¾¾: éœ€è¦æŒ‡å®šè¯¥å­—æ®µ `PersistentKeepalive = 25`, è¡¨ç¤ºæ¯éš” `25` ç§’å‘é€ä¸€æ¬¡ ping æ¥æ£€æŸ¥è¿æ¥.

#### å…±äº« Peer é…ç½®

å¦‚æœæŸä¸ª `peer` çš„å…¬é’¥ä¸æœ¬åœ°æ¥å£çš„ç§é’¥èƒ½å¤Ÿé…å¯¹, é‚£ä¹ˆ WireGuard ä¼šå¿½ç•¥è¯¥ `peer`.

åˆ©ç”¨è¿™ä¸ªç‰¹æ€§, æˆ‘ä»¬å¯ä»¥åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šå…±ç”¨åŒä¸€ä¸ª peer åˆ—è¡¨, æ¯ä¸ªèŠ‚ç‚¹åªéœ€è¦å•ç‹¬å®šä¹‰ä¸€ä¸ª `[Interface]` å°±è¡Œäº†, å³ä½¿åˆ—è¡¨ä¸­æœ‰æœ¬èŠ‚ç‚¹, ä¹Ÿä¼šè¢«å¿½ç•¥.

å…·ä½“æ–¹å¼å¦‚ä¸‹:

- æ¯ä¸ªå¯¹ç­‰èŠ‚ç‚¹ (peer) éƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„ `/etc/wireguard/wg0.conf` æ–‡ä»¶, åªåŒ…å« `[Interface]` éƒ¨åˆ†çš„é…ç½®.
- æ¯ä¸ªå¯¹ç­‰èŠ‚ç‚¹ (peer) å…±ç”¨åŒä¸€ä¸ª `/etc/wireguard/peers.conf` æ–‡ä»¶, å…¶ä¸­åŒ…å«äº†æ‰€æœ‰çš„ peer.
- Wg0.conf æ–‡ä»¶ä¸­éœ€è¦é…ç½®ä¸€ä¸ª PostUp é’©å­, å†…å®¹ä¸º `PostUp = wg addconf /etc/wireguard/peers.conf`.

---

#### è·¯ç”±å…¨éƒ¨æµé‡

å¦‚æœä½ æƒ³é€šè¿‡ VPN è½¬å‘æ‰€æœ‰çš„æµé‡, åŒ…æ‹¬ VPN å­ç½‘å’Œå…¬ç½‘æµé‡, éœ€è¦åœ¨å®¢æˆ·ç«¯çš„ `[Peer]` çš„ `AllowedIPs` ä¸­æ·»åŠ  `0.0.0.0/0, ::/0`.

å³ä¾¿åªè½¬å‘ `IPv4` æµé‡, ä¹Ÿè¦æŒ‡å®šä¸€ä¸ª `IPv6` ç½‘æ®µ, ä»¥é¿å…å°† `IPv6` æ•°æ®åŒ…æ³„éœ²åˆ° VPN ä¹‹å¤–.

è¯¦æƒ…å‚è€ƒ: [reddit.com/r/WireGuard/comments/b0m5g2/ipv6_leaks_psa_for_anyone_here_using_wireguard_to](https://icloudnative.io/go/?target=aHR0cHM6Ly93d3cucmVkZGl0LmNvbS9yL1dpcmVHdWFyZC9jb21tZW50cy9iMG01ZzIvaXB2Nl9sZWFrc19wc2FfZm9yX2FueW9uZV9oZXJlX3VzaW5nX3dpcmVndWFyZF90by8%3d)

ä¾‹å¦‚:

```
[Interface]
Address = 10.10.1.1/32
ListenPort = 44000
PrivateKey = <ç§é’¥>

[Peer]
PublicKey = <å…¬é’¥>
AllowedIPs = 0.0.0.0/0
```

å¦‚æœæŸä¸€ä¸ª peer çš„ allowed ip é…ç½®æˆ 0.0.0.0/0, åˆ™ wireguard ä¼š

- æŠŠ 0.0.0.0/0 è·¯ç”±åŠ å…¥åˆ°è·¯ç”±è¡¨ 51820 ä¸­
- æ‰€æœ‰ç»è¿‡ wg0 ç½‘å¡çš„æµé‡åŒ…éƒ½æ‰“ä¸Š 51820 æ ‡å¿—
- åŠ ä¸€æ¡ç­–ç•¥è·¯ç”±è§„å®šä¸å¸¦ 51820 æ ‡å¿—çš„æ•°æ®åŒ…æ‰å»æŸ¥è¯¢è·¯ç”±è¡¨ 51820

```
$ wg-quick up wg2
[#] ip link add wg2 type wireguard
[#] wg setconf wg2 /dev/fd/63
[#] ip -4 address add 10.10.1.1/32 dev wg2
[#] ip link set mtu 1420 up dev wg2
[#] wg set wg2 fwmark 51820
[#] ip -4 rule add not fwmark 51820 table 51820
[#] ip -4 rule add table main suppress_prefixlength 0
[#] ip -4 route add 0.0.0.0/0 dev wg2 table 51820
[#] sysctl -q net.ipv4.conf.all.src_valid_mark=1
[#] nft -f /dev/fd/63
```

å› ä¸º 0.0.0.0/0 æ˜¯é»˜è®¤è·¯ç”±, è€Œ main è¡¨ä¸­è‚¯å®šå·²ç»å­˜åœ¨é»˜è®¤è·¯ç”±äº†, æ‰€ä»¥å¿…é¡»æ’å…¥åˆ°ä¸€ä¸ªæ–°çš„è·¯ç”±è¡¨ä¸­(`ip -4 rule add not fwmark 51820 table 51820`);

æ¯”å¦‚ä»æµè§ˆå™¨å‘èµ·ä¸€ä¸ªè¿œç«¯è®¿é—®, æµç¨‹ä¸º:

1. chrome å‘å‡ºçš„æ•°æ®åŒ…åˆ°è¾¾å¯¹åº”çš„ socketï¼›
2. è¯¥æ•°æ®åŒ…ç»è¿‡å†…æ ¸åè®®æ ˆæ—¶, ä¼šé¦–å…ˆåš route decision, æœ¬æ¬¡ routing decision ä¼šå‘½ä¸­ 51820 è·¯ç”±è¡¨, æ‰€ä»¥åŒ…ä¼šè¢«å‘é€åˆ° wg0 ç½‘å¡ï¼›
3. è¯¥æ•°æ®åŒ…é€šè¿‡å­—ç¬¦é©±åŠ¨ç›´æ¥å‘é€åˆ°äº†åº”ç”¨å±‚åº”ç”¨ wireguard, wireguard- ä¼šå°†è¯¥æ™®é€šæ•°æ®åŒ…å°è£…æˆ wireguard æ•°æ®åŒ…, å¹¶æ‰“ä¸Š fwmark 0xca6cï¼›
4. wireguard å‘å‡ºçš„ wireguard æ•°æ®åŒ…åˆ°è¾¾å¯¹åº”çš„ socketï¼›
5. è¯¥ wireguard æ•°æ®åŒ…ç»è¿‡å†…æ ¸åè®®æ ˆæ—¶, ä¼šé¦–å…ˆåš routing decision, ç”±äºè¯¥åŒ…å¸¦äº† fwmark, æ‰€ä»¥ä¸ä¼šå‘½ä¸­ 51820 è·¯ç”±è¡¨, è€Œæ˜¯å‘½ä¸­é»˜è®¤è·¯ç”±ç­–ç•¥, è¢«å‘é€åˆ°äº† eth0 ç½‘å¡ï¼›
6. eth0 ç½‘å¡å°†è¯¥ wireguard æ•°æ®åŒ…å‘é€å‡ºå».

å¯ä»¥çœ‹å‡ºæ¥, å¦‚æœä¸ä¸ºæ•°æ®åŒ…æ‰“ä¸Š fwmark 0xca6c, ä¸æ·»åŠ ç­–ç•¥è·¯ç”±è€Œæ˜¯å°†è·¯ç”±æ·»åŠ åˆ° main è¡¨, åˆ™æ­¥éª¤ 5 ä¸­çš„ routing decision ä¼šå†æ¬¡æŠŠåŒ…é€å›åˆ° wg0 ç½‘å¡, å½¢æˆè·¯ç”±ç¯è·¯.

å¦‚æœé…ç½® `SaveConfig = tue`, å¯åŠ¨å®Œæˆåé…ç½®æ–‡ä»¶ä¼šå˜æ›´ä¸º:

```
[Interface]
Address = 10.10.1.1/32
SaveConfig = true
ListenPort = 44000
FwMark = 0xca6c
PrivateKey = <ç§é’¥>

[Peer]
PublicKey = <å…¬é’¥>
AllowedIPs = 0.0.0.0/0
```

ä¼šå¤šå‡ºä¸€ä¸ª **FwMark = 0xca6c** é…ç½®é¡¹, å› ä¸ºè¿˜æ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥, Peer ä¸‹è¿˜ä¸ä¼šæŒä¹…åŒ– Endpoint.

---

#### IPv6

å‰é¢çš„ä¾‹å­ä¸»è¦ä½¿ç”¨ `IPv4`, WireGuard ä¹Ÿæ”¯æŒ `IPv6`. ä¾‹å¦‚:

```ini
[Interface]
AllowedIps = 10.10.1.1/32, fd45:da8::1/128

[Peer]
...
AllowedIPs = 0.0.0.0/0, ::/0
```

#### å¸¸ç”¨å‘½ä»¤æ±‡æ€»

**ç”Ÿæˆå¯†é’¥**

```bash
#ç”Ÿæˆç§é’¥
$ wg genkey > example.key

# ç”Ÿæˆå…¬é’¥
$ wg pubkey < example.key > example.key.pub
```

**å¯åŠ¨ä¸åœæ­¢**

```bash
$ wg-quick up /full/path/to/wg0.conf
$ wg-quick down /full/path/to/wg0.conf

# è·å–åœ¨é…ç½®ç›®å½•ä¸‹
$ wg-quick up wg0
$ wg-quick down wg0
```

```bash
# å¯åŠ¨/åœæ­¢ VPN ç½‘ç»œæ¥å£
$ ip link set wg0 up
$ ip link set wg0 down

# æ³¨å†Œ/æ³¨é”€ VPN ç½‘ç»œæ¥å£
$ ip link add dev wg0 type wireguard
$ ip link delete dev wg0

# æ³¨å†Œ/æ³¨é”€ æœ¬åœ° VPN åœ°å€
$ ip address add dev wg0 10.10.4.8/32
$ ip address delete dev wg0 10.10.4.8/32

# æ·»åŠ /åˆ é™¤ VPN è·¯ç”±
$ ip route add 10.10.4.8/32 dev wg0
$ ip route delete 10.10.4.8/32 dev wg0
```

**æŸ¥çœ‹ä¿¡æ¯**

æ¥å£:

```bash
# æŸ¥çœ‹ç³»ç»Ÿ VPN æ¥å£ä¿¡æ¯
$ ip link show wg0

# æŸ¥çœ‹ VPN æ¥å£è¯¦ç»†ä¿¡æ¯
$ wg show all
$ wg show wg0
```

åœ°å€:

```bash
# æŸ¥çœ‹ VPN æ¥å£åœ°å€
$ ip address show wg0
```

è·¯ç”±:

```bash
# æŸ¥çœ‹ç³»ç»Ÿè·¯ç”±è¡¨
$ ip route show table main
$ ip route show table local

# è·å–åˆ°ç‰¹å®š IP çš„è·¯ç”±
$ ip route get 10.10.4.1
```

å‚è€ƒ:

- [Linux ä¸Šçš„ WireGuard ç½‘ç»œåˆ†æï¼ˆä¸€ï¼‰](https://thiscute.world/posts/wireguard-on-linux/)
- [wireguard protocol](https://www.wireguard.com/protocol/)
- [WireGuard åˆ°åº•å¥½åœ¨å“ªï¼Ÿ](https://zhuanlan.zhihu.com/p/404402933)
- [Understanding modern Linux routing (and wg-quick)](https://ro-che.info/articles/2021-02-27-linux-routing)
  - å®ƒçš„ä¸­æ–‡ç¿»è¯‘ï¼š[WireGuard åŸºç¡€æ•™ç¨‹ï¼šwg-quick è·¯ç”±ç­–ç•¥è§£è¯» - ç±³å¼€æœ—åŸºæ‰¬](https://icloudnative.io/posts/linux-routing-of-wireguard/)

---

### å›å®¶æ–¹æ¡ˆæ€»ç»“

å‰é¢ç”¨å¤§é‡ç¯‡å¹…ä»‹ç»äº†æˆ‘çš„ HomeLab çš„ç½‘ç»œæ¶æ„, é‡ç‚¹å…³æ³¨ç¨³å®šæ€§ä¸å¯ç”¨æ€§, ç›®çš„æ˜¯ä¿è¯éšæ—¶éšåœ°éƒ½èƒ½å¼‚åœ°è®¿é—®å®¶åº­ç½‘ç»œ, æ€»ç»“èµ·æ¥å°±æ˜¯ä¸‹é¢å‡ ç‚¹:

- å¤šå®½å¸¦é¿å…è¿è¥å•†æ•…éšœ: ç¾å¤‡å†—ä½™;
- å¤šè®¾å¤‡é¿å…å•ç‚¹æ•…éšœ: è´Ÿè½½å‡è¡¡;

å¦‚æœæ²¡æœ‰å…¬ç½‘ IP, æˆ‘ä»¬è¿˜æœ‰å¾ˆå¤šæ–¹å¼å®ç°å¼‚åœ°è®¿é—®:

- å…¬ç½‘è¢«å›æ”¶åˆ™å¯ç”¨ IPv6;
- å…¬ç½‘ä¸­ç»§;
- å†…ç½‘ç©¿é€;

[è¿™é‡Œè¿˜æœ‰å¦ä¸€ç§æ–¹å¼](https://chi.miantiao.me/posts/without-ipv4/), æœ‰æœºä¼šå¯ä»¥å°è¯•ä¸€ä¸‹.

<!--
https://chi.miantiao.me/posts/sink/

-->

---

## åˆ†æµ

{% folding ğŸª¬ åˆ†æµ %}

åˆ†æµæœ‰ 2 ç§æ–¹æ¡ˆ:

1. ç»ˆç«¯è®¾å¤‡å®‰è£…åˆ†æµæœåŠ¡, åªæœåŠ¡äºå½“å‰è®¾å¤‡:
   - ä¼˜ç‚¹:
     - **è‡ªä¸»å¯æ§**: æ¯ä¸ªè®¾å¤‡ç‹¬ç«‹è¿è¡Œåˆ†æµæœåŠ¡, é…ç½®çµæ´»ä¸”ä¸å½±å“å…¶ä»–è®¾å¤‡;
     - **æ— éœ€æ›´æ”¹ç½‘ç»œåŸºç¡€è®¾æ–½**: å¯¹è·¯ç”±å™¨ç­‰ç½‘ç»œè®¾å¤‡æ— ä¾èµ–, é¿å…å¤æ‚çš„ç½‘ç»œé…ç½®;
     - **ç¨³å®šæ€§é«˜**: åˆ†æµä»…é™äºå½“å‰è®¾å¤‡, ä¸ä¼šå› å…¶ä»–è®¾å¤‡æˆ–é›†ä¸­æœåŠ¡çš„æ•…éšœè€Œå—å½±å“;
   - ç¼ºç‚¹:
     - **ç»´æŠ¤æˆæœ¬é«˜**: éœ€è¦åœ¨æ¯å°è®¾å¤‡ä¸Šæ‰‹åŠ¨å®‰è£…ã€é…ç½®å’Œç»´æŠ¤åˆ†æµæœåŠ¡, å°¤å…¶å½“è®¾å¤‡æ•°é‡è¾ƒå¤šæ—¶å·¥ä½œé‡å¢åŠ ;
     - **ç»Ÿä¸€ç®¡ç†å›°éš¾**: åˆ†æµè§„åˆ™æ— æ³•é›†ä¸­ç®¡ç†, è®¾å¤‡é—´çš„é…ç½®å¯èƒ½ä¸ä¸€è‡´ (**å·²é€šè¿‡è§„åˆ™æœåŠ¡å®ç°åˆ†æµè§„åˆ™é›†ä¸­åŒ–ç®¡ç†**);
     - **æ€§èƒ½å—é™äºç»ˆç«¯è®¾å¤‡**: æŸäº›è®¾å¤‡æ€§èƒ½ä¸è¶³æ—¶, åˆ†æµå¯èƒ½ä¼šé™ä½ç½‘ç»œæ•ˆç‡;
2. éƒ¨ç½²é›†ä¸­å¼çš„åˆ†æµæœåŠ¡, æœåŠ¡äºæ•´ä¸ªç½‘ç»œ;
   - ä¼˜ç‚¹:
     - **é›†ä¸­ç®¡ç†**: æ‰€æœ‰è®¾å¤‡å…±äº«ä¸€å¥—åˆ†æµè§„åˆ™, é…ç½®ç»Ÿä¸€ä¸”ç»´æŠ¤æ–¹ä¾¿;
     - **è®¾å¤‡æ¥å…¥ç®€å•**: ç»ˆç«¯è®¾å¤‡æ— éœ€é¢å¤–é…ç½®, åªéœ€è®¾ç½®ç½‘å…³æˆ– DNS;
     - **é«˜æ•ˆçš„ç½‘ç»œæµé‡åˆ†é…**: å¯å……åˆ†åˆ©ç”¨é«˜æ€§èƒ½è®¾å¤‡ (å¦‚ä¸“ç”¨æœåŠ¡å™¨) å¤„ç†å¤æ‚çš„åˆ†æµä»»åŠ¡;
     - **ä¾¿äºæ‰©å±•**: æ–°å¢è®¾å¤‡æ—¶æ— éœ€é‡å¤é…ç½®åˆ†æµæœåŠ¡;
   - ç¼ºç‚¹:
     - **å•ç‚¹æ•…éšœé£é™©**: é›†ä¸­æœåŠ¡å‡ºç°æ•…éšœä¼šå¯¼è‡´æ‰€æœ‰è®¾å¤‡åˆ†æµå¤±æ•ˆ;
     - **ç½‘ç»œä¾èµ–æ€§é«˜**: å¯¹è·¯ç”±å™¨æˆ–ç½‘å…³çš„ç½‘ç»œé…ç½®ä¾èµ–è¾ƒå¤§, å¤æ‚ç½‘ç»œç¯å¢ƒä¸­å¯èƒ½éš¾ä»¥éƒ¨ç½²;
     - **å¯¹ç¡¬ä»¶æ€§èƒ½è¦æ±‚é«˜**: éœ€è¦é«˜æ€§èƒ½è®¾å¤‡æ”¯æ’‘, å¤„ç†æ‰€æœ‰è®¾å¤‡çš„åˆ†æµæµé‡;

---

### åŸºäº Surge é›†ä¸­å¼çš„åˆ†æµæ–¹æ¡ˆ

#### æ–¹å¼ä¸€

Surge éƒ¨ç½²åœ¨ Mac mini M2 ä¸Š, é…ç½®ä¹Ÿéå¸¸ç®€å•(ç±»ä¼¼çš„è¿˜æœ‰ R2S çš„æ—è·¯ç”±è®¾ç½®, ä¸åŒçš„æ˜¯ DNS ä¹Ÿéœ€è¦å¡«å†™ R2S çš„ IP åœ°å€):

- å¼€å¯ Surge çš„å¢å¼ºæ¨¡å¼

- åœ¨å…¶ä»–è®¾å¤‡ä¸Šè®¾ç½®:

  | é…ç½®å   | é…ç½®å€¼                 |
  | :------- | :--------------------- |
  | ç½‘å…³     | Mac mini M2 çš„ IP åœ°å€ |
  | DNS      | **198.18.0.2** (é‡ç‚¹)  |
  | å­ç½‘æ©ç  | 255.255.255.0          |
  | IP       | ä¿æŒä¸å˜               |

è™½ç„¶è¿™ç§æ–¹å¼éœ€è¦æ‰‹åŠ¨åœ¨æ¯å°ç»ˆç«¯ä¸Šè¿›è¡Œé…ç½®, ä½†åˆ†æµè¿™ç§æ“ä½œæœ¬èº«æ¯”è¾ƒç‰¹æ®Š, å°½é‡åœ¨è®¾å¤‡æœ¬åœ°å¤„ç†æ›´ä¸ºç¨³å¦¥.

æ­¤å¤–, åƒ R2S è¿™æ ·çš„æ—è·¯ç”±è®¾å¤‡è™½ç„¶ä¹Ÿèƒ½æä¾›ç±»ä¼¼åŠŸèƒ½, ç‹¬ç«‹é…ç½®æ¯å°éœ€è¦åˆ†æµçš„è®¾å¤‡å¯ä»¥ç¡®ä¿æ›´é«˜çš„è‡ªä¸»æ€§å’Œç¨³å®šæ€§.

**æœ€æ€•çš„å°±æ˜¯å› ä¸ºè§„åˆ™çš„é—®é¢˜æŠŠæµé‡ç”¨å®Œçš„æƒ…å†µ, å› æ­¤æœ€å¥½åœ¨éœ€è¦åˆ†æµçš„è®¾å¤‡ä¸Šæ‰‹åŠ¨å¼€å¯åˆ†æµæœåŠ¡.**

#### æ–¹å¼äºŒ

**ä½¿ç”¨ Surge æä¾› DHCP æœåŠ¡**

å¯ä»¥è®© Surge æ¥ç®¡è·¯ç”±å™¨çš„ **DHCP å’Œ DNS æœåŠ¡**, å…·ä½“æ“ä½œå¦‚ä¸‹:

1.  å…³é—­è·¯ç”±å™¨çš„ DHCP åŠŸèƒ½.
2.  åœ¨ Surge ä¸­å¯ç”¨ DHCP åŠŸèƒ½.
3.  åœ¨ç»ˆç«¯è®¾å¤‡ä¸Šæ‰‹åŠ¨è®¾ç½®ç½‘å…³å’Œ DNS (åŒä¸Šè¿°é…ç½®) .

**æœªé‡‡ç”¨åŸå› **:

- å…³é—­è·¯ç”±å™¨ DHCP åŠŸèƒ½å, ä¸ç¡®å®šé™æ€ IP ç»‘å®šè®°å½•æ˜¯å¦ä¼šä¿ç•™.
- æˆ‘å¯èƒ½ä¼šåœ¨å°†æ¥åˆ‡æ¢å›ç”±è·¯ç”±å™¨æä¾› DHCP æœåŠ¡, å› æ­¤ä¸å¸Œæœ›å›  Surge é€€å‡ºä½¿ç”¨è€Œå¼•å‘é¢å¤–é…ç½®é—®é¢˜.
- ä¸»è¦è®¾å¤‡ä¸Šå…¨éƒ¨å®‰è£…äº† Surge, é macOS çš„ç³»ç»Ÿåˆ™ä¼šæ˜¯ç”¨ R2S çš„æ—è·¯ç”±æ¨¡å¼, å› æ­¤æ²¡å¿…è¦é‡‡ç”¨è¿™ç§é›†ä¸­å¼çš„æ–¹æ¡ˆ.

### ç»éªŒæ€»ç»“

æ­¤å‰æ›¾å°†åˆ†æµæœåŠ¡éƒ¨ç½²åœ¨ root è¿‡çš„ AX9000 è·¯ç”±å™¨ä¸Š, æ¥ç®¡å…¨å±‹è®¾å¤‡çš„ä¸Šç½‘éœ€æ±‚, ä»¥å®ç°å…¨å±‹è®¾å¤‡æ— æ„ŸçŸ¥çš„åˆ†æµ, ä½†é¢‘ç¹çš„ç½‘ç»œæ–­çº¿å’Œéƒ¨åˆ†ç½‘ç»œä¸å¯ç”¨ (éœ€è¦é‡å¯è·¯ç”±å™¨) è¿èƒŒäº†æˆ‘è¿½æ±‚ç¨³å®šæ€§çš„åŸåˆ™. æœ€ç»ˆ, æˆ‘å°† AX9000 æ¢å¤ä¸ºæ™®é€šè·¯ç”±å™¨, ä»…ç”¨æ¥æä¾›é™æ€ IP ç»‘å®šã€ç«¯å£æ˜ å°„ç­‰å¸¸è§„åŠŸèƒ½.

ç›®å‰å¯¹åˆ†æµå°±ä¸€ä¸ªåŸåˆ™: **æ‰‹åŠ¨å¼€å¯åˆ†æµåŠŸèƒ½**.

æ¯æ¬¡æ‰‹åŠ¨å¼€å¯è™½ç„¶éº»çƒ¦, ä½†æ˜¯å¯ä»¥æ˜ç¡®çŸ¥é“è‡ªå·±çš„æ“ä½œä¼šå¸¦æ¥ä»€ä¹ˆå½±å“, æˆ‘è§‰å¾—è¿˜æ˜¯å€¼å¾—çš„.

å¯¹äº Apple è®¾å¤‡å¼€å§‹ Surge è¿˜æ¯”è¾ƒç®€å•, å¯¹äºé Apple è®¾å¤‡, åˆ™æä¾›äº†è„šæœ¬ä»¥ç®€åŒ–æ“ä½œ:

```shell
proxy(){
  export https_proxy=http://ip:port http_proxy=http://ip:port all_proxy=socks5://ip:port
  echo "HTTP Proxy on"
}

noproxy(){
  unset http_proxy
  unset https_proxy
  unset all_proxy
  echo "HTTP Proxy off"
}
```

éœ€è¦æ—¶æ‰§è¡Œ `proxy` æ–¹æ³•å³å¯.

### æœ€ç»ˆæ–¹æ¡ˆ

ç›®å‰åˆ†æµéœ€æ±‚ä»…é™äºå°‘æ•°ç‰¹å®šè®¾å¤‡, æˆ‘çš„æ–¹æ¡ˆæ˜¯è¿™æ˜¯ç»“åˆè®¾å¤‡ç‹¬ç«‹åˆ†æµå’Œæ—è·¯ç”±æ¨¡å¼:

1. **Apple è®¾å¤‡ç›´æ¥å®‰è£… Surge**, é‡‡ç”¨è®¾å¤‡ç‹¬ç«‹åˆ†æµæ–¹æ¡ˆ, é…ç½®é€šè¿‡ iCloud æˆ– Synology Drive åŒæ­¥;
2. é Apple è®¾å¤‡åˆ™ä½¿ç”¨ R2S æ—è·¯ç”±æ¨¡å¼æˆ–è€…è®¾ç½® `http_proxy`, ç¡®ä¿åˆ†æµæœåŠ¡çš„ **ç‹¬ç«‹æ€§å’Œå¯æ§æ€§**;

{% endfolding %}

---

## æ€»ç»“

æˆ‘ä»¬å·²ç»åŸºæœ¬ä»‹ç»äº†å®¶åº­ç½‘ç»œçš„é…ç½®ï¼ŒåŒ…æ‹¬ç½‘ç»œæ¶æ„ã€å®‰å…¨æ€§ã€å¼‚åœ°ç»„ç½‘ç­‰æ–¹é¢ã€‚æ¯ä¸ªç« èŠ‚éƒ½å¯ä»¥å•ç‹¬æ‹¿å‡ºæ¥æ’°å†™ä¸€ç¯‡åšå®¢ï¼Œä½†ç”±äºä¿æŒè¿è´¯æ€§ï¼Œæˆ‘ä»¬é€‰æ‹©å°†å®ƒä»¬åˆå¹¶ä¸ºä¸€ç¯‡æ–‡ç« ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è½¬å‘æœåŠ¡ç›¸å…³çš„å†…å®¹ã€‚ä½œä¸ºè½¯ä»¶å¼€å‘è€…ï¼Œæˆ‘æ·±çŸ¥å·¥å…·å¯¹äºå·¥ä½œæ•ˆç‡çš„é‡è¦æ€§ã€‚å› æ­¤ï¼Œåœ¨æ¥ä¸‹æ¥çš„å†…å®¹ä¸­ï¼Œæˆ‘å°†é‡ç‚¹å…³æ³¨å„ç§å·¥å…·ç±»çš„è‡ªæ‰˜ç®¡æœåŠ¡ã€‚è¿™äº›æœåŠ¡å¯èƒ½ä¼šåŒ…æ‹¬ä»£ç ç®¡ç†ã€æŒç»­é›†æˆå’ŒæŒç»­éƒ¨ç½²ï¼ˆCI/CDï¼‰å·¥å…·ã€ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿã€æ—¥å¿—ç®¡ç†ã€ç›‘æ§å·¥å…·ç­‰ã€‚

è™½ç„¶ç°åœ¨åªæ˜¯ç”»å‡ºäº†ä¸€ä¸ªå¤§è‡´çš„è“å›¾ï¼Œä½†æˆ‘ç›¸ä¿¡éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæˆ‘ä¼šä¸æ–­æ¢ç´¢å’Œå®è·µï¼Œå°†è¿™äº›æœåŠ¡é€æ­¥åº”ç”¨åˆ°æˆ‘çš„ä¸ªäººäº‘ç«¯å®éªŒå®¤ä¸­ã€‚æˆ‘æœŸå¾…ç€ä¸å¤§å®¶åˆ†äº«æˆ‘åœ¨è¿™ä¸ªé¢†åŸŸçš„ç»éªŒã€æŒ‘æˆ˜å’Œè§£å†³æ–¹æ¡ˆã€‚

æ„Ÿè°¢å¤§å®¶çš„å…³æ³¨å’Œæ”¯æŒï¼Œå¸Œæœ›è¿™äº›å†…å®¹èƒ½å¤Ÿå¯¹æ‚¨çš„è‡ªæ‰˜ç®¡ä¹‹æ—…æœ‰æ‰€å¸®åŠ©ã€‚å¦‚æœæ‚¨æœ‰ä»»ä½•å»ºè®®æˆ–é—®é¢˜ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ¢è®¨å’Œå­¦ä¹ ã€‚è®©æˆ‘ä»¬ç»§ç»­å‰è¿›ï¼Œå…±åŒæ‰“é€ å±äºæˆ‘ä»¬çš„é«˜æ•ˆã€ç¨³å®šä¸”å®‰å…¨çš„ä¸ªäººäº‘ç«¯å®éªŒå®¤ï¼

**ç›¸å…³æ–‡ç« :**

1. [[homelab-guide|å…ˆå¯¼ç¯‡]]ï¼šæˆ‘çš„ HomeLab æ¦‚è¦;
2. [[homelab-hardware|ç¡¬ä»¶ç¯‡]]ï¼šä»‹ç»æˆ‘æ‰€æ‹¥æœ‰çš„ç¡¬ä»¶è®¾å¤‡;
3. [[homelab-network|ç½‘ç»œç¯‡]]ï¼šåŒ…æ‹¬ç½‘ç»œç¯å¢ƒã€å¼‚åœ°ç»„ç½‘ä¸ç½‘ç»œå®‰å…¨;
4. [[homelab-service|æœåŠ¡ç¯‡]]ï¼šä½¿ç”¨ Docker æ­å»ºçš„å„ç±»æœåŠ¡;
5. [[homelab-data|æ•°æ®ç¯‡]]ï¼šåŒ…æ‹¬æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆ;
6. [[homelab-data-sync|HomeLabæ•°æ®åŒæ­¥ï¼šæ„å»ºé«˜æ•ˆçš„æ•°æ®åŒæ­¥ç½‘ç»œ]]
7. [[homelab-data-backup|HomeLabæ•°æ®å¤‡ä»½ï¼šæ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿]]
8. [[homelab-upgrade-to-10g|HomeLab ç½‘ç»œç»­é›†ï¼šå‡çº§ 10G ç½‘ç»œ-å†æˆ˜ 10 å¹´]]
9. [[homelab-guide|NAT å†…ç½‘ç©¿é€è¯¦è§£ï¼šæ­ç§˜ç½‘ç»œè¿æ¥èƒŒåçš„å¥¥ç§˜]]

## [HomeLab ç¡¬ä»¶ç¯‡ï¼šæ„å»ºåŸºçŸ³-è‡ªæ‰˜ç®¡ç¡¬ä»¶çš„é€‰è´­ä¸å®è·µ](https://blog.dong4j.site/posts/1c3b04a.md)

![/images/cover/20241229154732_REDUUGSE.webp](https://cdn.dong4j.site/source/image/20241229154732_REDUUGSE.webp)

## ç®€ä»‹

åœ¨æ‰“é€ ä¸ªäººäº‘ç«¯å®éªŒå®¤ï¼ˆHomeLabï¼‰çš„è¿‡ç¨‹ä¸­ï¼Œç¡¬ä»¶é€‰æ‹©æ˜¯è‡³å…³é‡è¦çš„ç¬¬ä¸€æ­¥ã€‚å®ƒä»¬ä¸ä»…æ˜¯å®éªŒçš„åŸºç¡€è®¾æ–½ï¼Œä¹Ÿæ˜¯æ•´ä¸ªç³»ç»Ÿç¨³å®šæ€§å’Œæ€§èƒ½çš„ä¿è¯ã€‚æœ¬ç¯‡å°†é‡ç‚¹æ¢è®¨å¦‚ä½•åœ¨é¢„ç®—èŒƒå›´å†…ï¼Œé€‰æ‹©å…·æœ‰é«˜ç¨³å®šæ€§ã€è‰¯å¥½æ€§ä»·æ¯”ã€å¯æ‰©å±•æ€§ä»¥åŠå…¼å®¹æ€§çš„ç¡¬ä»¶ã€‚

ä»¥ä¸‹æ˜¯æˆ‘åœ¨æŒ‘é€‰ç¡¬ä»¶æ—¶éœ€è¦è€ƒè™‘çš„å…³é”®å› ç´ ï¼š

1. **ç¨³å®šæ€§**ï¼šæˆ‘å°†ä¼˜å…ˆè€ƒè™‘é‚£äº›å¯é æ€§é«˜çš„ç¡¬ä»¶äº§å“ï¼Œé¿å…å› é¢‘ç¹æ•…éšœè€Œå¯¼è‡´çš„ç»´æŠ¤æˆæœ¬å’Œå·¥ä½œä¸­æ–­ã€‚
2. **æ€§ä»·æ¯”**ï¼šåœ¨ç¡®ä¿ç¡¬ä»¶èƒ½æ»¡è¶³åŸºæœ¬éœ€æ±‚çš„å‰æä¸‹ï¼Œæˆ‘ä¼šå¯»æ‰¾æ€§ä»·æ¯”æœ€é«˜çš„é€‰é¡¹ã€‚æ¯•ç«Ÿï¼Œèµ„é‡‘æ˜¯æœ‰é™çš„èµ„æºï¼Œéœ€è¦åˆç†åˆ†é…ã€‚
3. **å¯æ‰©å±•æ€§**ï¼šä¸ºäº†æœªæ¥çš„å‘å±•å’Œå¯èƒ½çš„å‡çº§ï¼Œæˆ‘å€¾å‘äºé€‰æ‹©é‚£äº›èƒ½å¤Ÿè½»æ¾æ‰©å±•çš„ç¡¬ä»¶è§£å†³æ–¹æ¡ˆã€‚
4. **å…¼å®¹æ€§**ï¼šä¸ºäº†é¿å…åæœŸä½¿ç”¨ä¸­çš„ä¸å…¼å®¹é—®é¢˜ï¼Œæˆ‘å°†é€‰æ‹©é‚£äº›åœ¨å¸‚åœºä¸Šå¾—åˆ°å¹¿æ³›è®¤å¯çš„ã€å…·æœ‰è‰¯å¥½å…¼å®¹æ€§çš„ç»„ä»¶ã€‚

åœ¨é€‰æ‹©ç¡¬ä»¶æ—¶ï¼Œæˆ‘ç‰¹åˆ«çœ‹é‡ç¨³å®šæ€§ã€‚æˆ‘ä¸æƒ³é¢‘ç¹åœ°å¤„ç†å„ç§ç¡¬ä»¶æ•…éšœï¼Œè¿™ä¸ä»…å½±å“å·¥ä½œæ•ˆç‡ï¼Œä¹Ÿå¯èƒ½å¯¼è‡´å®è´µçš„æ•°æ®ä¸¢å¤±ã€‚å› æ­¤ï¼Œæˆ‘æ’é™¤äº†é›†æˆæ‰€æœ‰åŠŸèƒ½çš„â€œå…¨åŠŸèƒ½ä¸€ä½“æœºâ€ï¼ˆAll In Oneï¼‰æ–¹æ¡ˆ(è¿™ç±»æ–¹æ¡ˆåˆå« **All In Boom**)ã€‚è¿™ç±»äº§å“è™½ç„¶åœ¨æŸäº›æ–¹é¢å¯èƒ½çœ‹èµ·æ¥å¾ˆæœ‰å¸å¼•åŠ›ï¼Œä½†å®ƒä»¬å¾€å¾€ç‰ºç‰²äº†æ€§èƒ½å’Œå‡çº§çš„å¯èƒ½æ€§ã€‚

ç›¸åï¼Œæˆ‘ä¼šå°†æœåŠ¡éƒ¨ç½²åˆ°å¤šä¸ªç‹¬ç«‹çš„æœåŠ¡å™¨ä¸Šã€‚è¿™ç§åˆ†å¸ƒå¼æ¶æ„æ„å‘³ç€å³ä½¿ä¸€å°æœåŠ¡å™¨å‡ºç°æ•…éšœï¼Œä¹Ÿä¸ä¼šå½±å“åˆ°å…¶ä»–æœåŠ¡çš„æ­£å¸¸è¿è¡Œã€‚è¿™ç§æ–¹æ³•ä¸ä»…æé«˜äº†ç³»ç»Ÿçš„å¯é æ€§ï¼Œä¹Ÿç¡®ä¿äº†æ•°æ®çš„å®‰å…¨å’Œè¿ç»­æ€§ã€‚

åœ¨æ¥ä¸‹æ¥çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬å°†è¯¦ç»†æ¢è®¨å¦‚ä½•åœ¨å®é™…æ“ä½œä¸­é€‰æ‹©åˆé€‚çš„ç¡¬ä»¶ç»„ä»¶ï¼Œå¹¶åˆ†äº«ä¸€äº›å®é™…æ“ä½œçš„æ¡ˆä¾‹å’Œå®è·µç»éªŒã€‚è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢è‡ªæ‰˜ç®¡ç¡¬ä»¶é€‰è´­çš„å¥¥ç§˜ï¼Œä¸ºæ„å»ºä¸€ä¸ªç¨³å®šã€é«˜æ•ˆçš„ä¸ªäººäº‘ç«¯å®éªŒå®¤æ‰“ä¸‹åšå®çš„åŸºç¡€ã€‚

**ç›¸å…³æ–‡ç« :**

1. [[homelab-guide|å…ˆå¯¼ç¯‡]]ï¼šæˆ‘çš„ HomeLab æ¦‚è¦;
2. [[homelab-hardware|ç¡¬ä»¶ç¯‡]]ï¼šä»‹ç»æˆ‘æ‰€æ‹¥æœ‰çš„ç¡¬ä»¶è®¾å¤‡;
3. [[homelab-network|ç½‘ç»œç¯‡]]ï¼šåŒ…æ‹¬ç½‘ç»œç¯å¢ƒã€å¼‚åœ°ç»„ç½‘ä¸ç½‘ç»œå®‰å…¨;
4. [[homelab-service|æœåŠ¡ç¯‡]]ï¼šä½¿ç”¨ Docker æ­å»ºçš„å„ç±»æœåŠ¡;
5. [[homelab-data|æ•°æ®ç¯‡]]ï¼šåŒ…æ‹¬æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆ;
6. [[homelab-data-sync|HomeLabæ•°æ®åŒæ­¥ï¼šæ„å»ºé«˜æ•ˆçš„æ•°æ®åŒæ­¥ç½‘ç»œ]]
7. [[homelab-data-backup|HomeLabæ•°æ®å¤‡ä»½ï¼šæ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿]]
8. [[homelab-upgrade-to-10g|HomeLab ç½‘ç»œç»­é›†ï¼šå‡çº§ 10G ç½‘ç»œ-å†æˆ˜ 10 å¹´]]
9. [[homelab-guide|NAT å†…ç½‘ç©¿é€è¯¦è§£ï¼šæ­ç§˜ç½‘ç»œè¿æ¥èƒŒåçš„å¥¥ç§˜]]

## ç¡¬ä»¶æ¸…å•

### ä¸»æœº

|          ç¡¬ä»¶           |                      å‹å·                       | æ•°é‡ |                     å¤‡æ³¨                     |
| :---------------------: | :---------------------------------------------: | :--: | :------------------------------------------: |
|           MBP           |             16 å¯¸/M1 Pro Max 64G/4T             |  1   |                    ä¸»åŠ›æœº                    |
|      Mac mini 2018      |             i7/64G å†…å­˜/1T/ä¸‡å…†ç”µå£             |  1   |     åŸæ¥çš„ä¸»åŠ›æœº, ç°åœ¨æ²¦ä¸ºä¸‹è½½æœºä¸æœåŠ¡å™¨     |
|      Mac mini 2023      |            M2/16G å†…å­˜/256G/ä¸‡å…†ç”µå£            |  1   |          ç¼“å­˜æœåŠ¡å™¨, å°æ¨¡å‹çš„è¯•éªŒæœº          |
| ThinkStation M920x Tiny |           i7/64G å†…å­˜/4.5T/åŒä¸‡å…†å…‰å£           |  1   | ä¸»è¦çš„æœåŠ¡å™¨, å¤§éƒ¨åˆ† Docker å’Œè™šæ‹Ÿæœºçš„å¯„ä¸»æœº |
|       å°å¼ç»„è£…æœº        | åŒè·¯ E5 2680V4/256G å†…å­˜/2T/ä¸‡å…†ç”µå£/2080Ti+P40 |  1   |                    ç‚¼ä¸¹ç‚‰                    |

å› ä¸ºå·¥ä½œçš„åŸå› , ä» 2015 è´­ä¹°ç¬¬ä¸€å° MBP å¼€å§‹ä¾¿ä¸€å‘ä¸å¯æ”¶æ‹¾, é™†é™†ç»­ç»­è´­ä¹°äº† Apple å…¨å®¶æ¡¶, ä¸€æ˜¯å› ä¸º macOS éå¸¸é€‚åˆå¼€å‘, äºŒæ˜¯ç®€çº¦çš„ç³»ç»Ÿå’Œå®Œç¾çš„å·¥ä¸šè®¾è®¡.
åæ¥å› ä¸ºç»„å»º HomeLab å’Œ AI çš„çˆ†ç«, å¼€å§‹è´­ä¹° X86 ç¡¬ä»¶ä¸æ˜¾å¡, ç»„è£…äº†ç¬¬ä¸€å°å®¶ç”¨æœåŠ¡å™¨, ä½†æ˜¯å› ä¸ºè€—ç”µé‡å·¨å¤§, ä¸æ˜¯ 24 å°æ—¶å¼€æœºè¿è¡Œ.
åç»­å…¥æ‰‹äº†è”æƒ³çš„ M920X å‡†ç³»ç»Ÿ, åç»­æŒç»­å‡çº§åˆ°ç°åœ¨çš„é…ç½®, å®‰è£…äº† Ubuntu Server, ä¸»è¦ç”¨äºè·‘ä¸€äº›å¤§å‹æœåŠ¡ä¸é‡è¦æ•°æ®çš„å®¹ç¾å¤‡ä»½.

#### MackBook Pro

![20241229154732_psTBnior.webp](https://cdn.dong4j.site/source/image/20241229154732_psTBnior.webp)

è¿™æ˜¯æˆ‘çš„ç¬¬äºŒå° MBP, åœ¨å¦‚ä»Š LLM çˆ†å‘çš„ AI å…ƒå¹´, å¾ˆåº†å¹¸ä¹°äº† 64G å†…å­˜çš„ç‰ˆæœ¬, å¾—ç›Šäº [llama.cpp](https://github.com/ggerganov/llama.cpp) è¿™æ ·çš„ä¼˜ç§€æ¡†æ¶ï¼Œå³ä½¿åœ¨ CPU ä¸Šä¹Ÿèƒ½ç›¸å¯¹æµç•…åœ°è¿è¡Œå¤§å‹æ¨¡å‹ã€‚

ä¸å¾—ä¸è¯´ Apple ä» Intel CPU å‡çº§åˆ° Apple Silicon, ç»™æˆ‘æœ€ç›´è§‚çš„æ„Ÿå—å°±æ˜¯åŸºæœ¬ä¸Šåªæœ‰åœ¨è·‘ LLM æ—¶æ‰ä¼šç¨å¾®æ„Ÿå—åˆ°ä¸€ç‚¹æ¸©åº¦, å…¶ä»–æ—¶å€™éƒ½å†·æ‰‹.

ç›®å‰ï¼ŒLLMï¼ˆå¤§å‹è¯­è¨€æ¨¡å‹ï¼‰æ­£å¤„äºç™¾èŠ±é½æ”¾çš„é˜¶æ®µï¼Œä»è‡ªç„¶è¯­è¨€äº¤äº’åˆ°å›¾åƒå’Œè¯­éŸ³ç”Ÿæˆï¼Œå†åˆ°å¤šæ¨¡æ€å¤„ç†ï¼Œå„é¢†åŸŸçš„ LLM åº”ç”¨å±‚å‡ºä¸ç©·ã€‚ç„¶è€Œï¼Œå¯¹äºä¸ªäººç”¨æˆ·æ¥è¯´ï¼Œéƒ¨ç½² LLM ä»éœ€è¦ä¸å°çš„ç¡¬ä»¶æŠ•å…¥ï¼Œå°¤å…¶æ˜¯åœ¨ç«¯ä¾§ï¼Œéšç§é—®é¢˜å’Œè®¡ç®—èµ„æºçš„é«˜è¦æ±‚éƒ½æœªèƒ½å¾ˆå¥½åœ°è§£å†³ã€‚å¦‚æœæœªæ¥èƒ½åœ¨æ ‘è“æ´¾è¿™æ ·çš„å¼€å‘æ¿ä¸Šé¡ºç•…è¿è¡Œ LLMï¼Œé‚£å°†æ˜¯ä¸€ä¸ªè®©æ¯ä¸ªäººéƒ½å¯ä»¥è½»æ¾æ‹¥æœ‰ã€ç§å¯†ä¸”ä½æˆæœ¬çš„ä¸ªäººåŒ– LLM æ—¶ä»£ç¾å¥½æ—¶ä»£ã€‚

#### Mac mini 2018

Mac mini 2018 æ˜¯æˆ‘ç¬¬ä¸€å° Mac ä¸»æœº, ä¸»è¦çœ‹é‡å®ƒèƒ½å¤Ÿæ›´æ¢å†…å­˜, å› æ­¤ä¹°äº†æœ€å°çš„ 8G ç‰ˆæœ¬, ç„¶åå‡çº§åˆ°äº† 64G å†…å­˜, ä¸å¾—ä¸è¯´ä½†æ˜¯çš„å†…å­˜æ¡è·³æ°´çœŸçš„å¤ªå¤¸å¼ äº†, ç¬¬ä¸€æ¡ 32G å†…å­˜ä¹°æˆæ¥è¿‘ 3000, éš”äº† 3 ä¸ªæœˆè´­ä¹°ç¬¬äºŒå¼  32G å†…å­˜æ—¶, é™ä»·åˆ° 1000+, æˆ‘åªèƒ½ç”¨ "æ—©ä¹°æ—©äº«å—" æ¥å®‰æ…°è‡ªå·±äº†.

![20241229154732_96bJUcoX.webp](https://cdn.dong4j.site/source/image/20241229154732_96bJUcoX.webp)

å†…éƒ¨ç»“æ„, çœ‹ç€èµå¿ƒæ‚¦ç›®

![20241229154732_5onTic5f.webp](https://cdn.dong4j.site/source/image/20241229154732_5onTic5f.webp)

![20241229154732_9hC64AcE.webp](https://cdn.dong4j.site/source/image/20241229154732_9hC64AcE.webp)

ä¸€æ¡è¶…è´µçš„ 32G å†…å­˜æ¡.

åç»­å†æ¬¡å…¥æ‰‹äº†ä¸€å°åŒå‹å·çš„ Mac mini 2018, æ”¾åœ¨å…¬å¸ä½œä¸ºå¼€å‘ä¸»åŠ›æœº, è¿˜è´­ä¹°äº† Blackmagic eGPU, å› ä¸ºå½“æ—¶ Mac mini 2018 å¸¦ 2 å° 4K æ˜¾ç¤ºå™¨ç•¥å¾®åƒåŠ›, åœ¨ Blackmagic eGPU çš„åŠ æŒä¸‹, IDEA çš„æµç•…åº¦å¤§å¤§å¢åŠ .

![20241229154732_ChkVaXC2.webp](https://cdn.dong4j.site/source/image/20241229154732_ChkVaXC2.webp)

æˆ‘åªèƒ½è¯´ Intel èŠ¯ç‰‡å‘çƒ­å¤ªä¸¥é‡äº†, é™†é™†ç»­ç»­æ›´æ¢äº†å¤šä¸ªå¤–ç½®æ•£çƒ­, æœ€ç¦»è°±çš„æ˜¯è¿˜ç”¨è¿‡åŠå¯¼ä½“æ•£çƒ­æ–¹æ¡ˆ, ä¸å¼€æ•£çƒ­ä¸€ä¼šå°±å¼€å§‹çƒ«æ‰‹, Apple Silicon YYDS...

![20241229154732_AGWL0V74.webp](https://cdn.dong4j.site/source/image/20241229154732_AGWL0V74.webp)

å½“ Mac mini M1 ä¸Šå¸‚å, è¿˜åœ¨è§‚æœ›, æŸ¥çœ‹äº†å¤§é‡æµ‹è¯•è§†é¢‘å, å†³å®šåæœŸè´­ä¹° M2 èŠ¯ç‰‡çš„ Mac mini, å› æ­¤å‡ºæ‰äº†ä¸€å° Mac mini 2018, Blackmagic eGPU åˆ™å–ç»™äº†æœ‹å‹, å‰©ä¸‹çš„ Mac mini 2018 å°±å½“ç•™ä½œ Apple Intel CPU çš„æœ€åä¸€ä»£çš„è§è¯(å…¶å®æ˜¯ M ç³»åˆ—èŠ¯ç‰‡ä¸Šå¸‚å, Intel ç³»åˆ—çš„ Mac mini é™ä»·å¤ªä¸¥é‡, çŠ¹è±«ä¹‹åè¿˜æ˜¯ç•™ä¸‹æ¥å½“æœåŠ¡å™¨ç”¨).

#### Mac mini M2

Mac mini M2 çš„é…ç½®æ˜¯: 16G å†…å­˜ + 256G SSD + ä¸‡å…†ç”µå£, ä½†æ˜¯åº”è¯¥æ˜¯æœ€å…·æ€§ä»·æ¯”çš„ M ç³»åˆ—å°ä¸»æœº, å¯¹äºå¼€å‘è€…æ¥è¯´, å†…å­˜æ¯”é—ªå­˜æ›´é‡è¦, ä¸”å½“æ—¶ä¹Ÿæœ‰æ›´æ¢é—ªå­˜çš„æˆåŠŸæ¡ˆä¾‹, å› æ­¤æƒ³ç€åæœŸèƒ½å¤Ÿç›´æ¥æ›´æ¢æ›´å¤§çš„é—ªå­˜ä¸”æ¯”å®˜ç½‘ä¾¿å®œå¤ªå¤š, å°±è´­ä¹°äº† 256G çš„ç‰ˆæœ¬.

![20241229154732_1FRBAwoW.webp](https://cdn.dong4j.site/source/image/20241229154732_1FRBAwoW.webp)

å¿½ç•¥æ‚ä¹±çš„çº¿, å‰é¢æ˜¾ç¤ºå™¨ä¸€ç›–å°±ä»€ä¹ˆéƒ½çœ‹ä¸åˆ°äº†(æ›´ä¹±çš„çº¿è¿˜åœ¨åé¢ ğŸ˜‚, æ¡Œæ­çš„åšå®¢å®‰æ’ä¸Š)

ç›®å‰ Mac mini M2 ä¸»è¦ç”¨ä½œç¼“å­˜æœåŠ¡å™¨, ä¸”å› ä¸ºç»Ÿä¸€å†…å­˜çš„æ¶æ„, è¿˜èƒ½è·‘ä¸€è·‘ GGUF æ ¼å¼çš„å°æ¨¡å‹. ç›®å‰è¿˜æ²¡æœ‰å®Œå…¨ç”¨èµ·æ¥, ç­‰æ›´æ¢äº†é—ªå­˜åå†å¼€å§‹é‡åº¦ä½¿ç”¨(256G é—ªå­˜è¢«é˜‰å‰²ä¸”çœŸçš„å¤ªå°äº†, ç›®å‰éƒ½ä¸æ•¢å®‰è£…å¤ªå¤šçš„ APP, ä¸” LLM çš„æ¨¡å‹æ–‡ä»¶è¿˜å¾—æ”¾åˆ° NAS ä¸Šæ‰æ•¢è·‘ä¸€ä¸‹).

#### ThinkStation M920x Tiny

![20241229154732_VUOwmbbQ.webp](https://cdn.dong4j.site/source/image/20241229154732_VUOwmbbQ.webp)

å…·ä½“ç¡¬ä»¶å‚æ•°:

- CPU: i7-8700
- å†…å­˜: `32G *2`
- ç£ç›˜: M.2 512G ç³»ç»Ÿç›˜ + 1T `SSD * 4`
- ç½‘å¡: Intel X520-DA2 åŒä¸‡å…† 10G å…‰å£ç½‘å¡ + æ¿è½½åƒå…† I219 ç”µå£ç½‘å¡ + USB è½¬ 2.5G ç”µå£ç½‘å¡ + USB è“ç‰™ & WiFi æ¨¡å—

ç³»ç»Ÿé€‰æ‹©äº† Ubuntu Server, è€Œä¸æ˜¯ PVE æˆ–è€… ESXi çš„åŸå› æ˜¯ ThinkStation M920x Tiny å®šä½æ˜¯å•æœºæœåŠ¡å™¨, ä¸»è¦æ»¡è¶³ä¸ªäººéœ€æ±‚:

- å‡ ä¹æ‰€æœ‰æœåŠ¡éƒ½å¯ä»¥ä½¿ç”¨ Docker è¿è¡Œï¼Œå¼€é”€å°;
- å®¹å™¨è°ƒç”¨æ˜¾å¡æ¯”è™šæ‹Ÿæœºè°ƒç”¨æ˜¾å¡å®¹æ˜“å¾ˆå¤š; æ›´ä½•å†µè¿™å° M920x æ²¡è£…æ˜¾å¡;
- è™šæ‹ŸåŒ–æ”¯æŒæ˜¯é›†æˆåœ¨ Linux å†…æ ¸ä¸­çš„ï¼Œä»»ä½•å‘è¡Œç‰ˆéƒ½å¯ä»¥å®‰è£… KVM/QEMU æ¥è·‘è™šæ‹Ÿæœº;
- éšç€ä½¿ç”¨æ—¶é—´çš„å¢åŠ ï¼Œè™šæ‹Ÿæœºçš„èµ„æºæ€»æ˜¯éœ€è¦é‡æ–°è°ƒæ•´ï¼Œè€Œåƒæ–‡ä»¶ç³»ç»Ÿè¿™ç±»çš„èµ„æºè°ƒæ•´èµ·æ¥å¾ˆéº»çƒ¦;
- ä¸éœ€è¦è™šæ‹Ÿè¯¸å¦‚ OpenWrt, NAS ç­‰ç³»ç»Ÿ, æˆ‘æ›´å€¾å‘äºè´­ä¹°ä¸“é—¨çš„ç¡¬ä»¶æ¥è·‘è¿™ç±»ç‹¬ç«‹ç³»ç»Ÿ;

æ‰€ä»¥æˆ‘ç›®å‰å°±æ˜¯ Ubuntu + Docker + KVM/QEMUï¼ŒDocker é‡Œè·‘ç€å››åå¤šä¸ªæœåŠ¡ï¼Œå…±ç”¨æ–‡ä»¶ç³»ç»Ÿå’Œæ˜¾å¡ï¼Œå¶å°”æœ‰è·‘å…¶ä»–å†…æ ¸ç³»ç»Ÿçš„éœ€æ±‚å°±åœ¨ KVM/QEMU é‡Œå¼€ä¸ªè™šæ‹Ÿæœº, ç®€å•è€Œä¸å¤±ä¼˜é›….

![20241229154732_iYf5ZAWP.webp](https://cdn.dong4j.site/source/image/20241229154732_iYf5ZAWP.webp)

ç›®å‰åªè·‘äº† 4 ä¸ªè™šæ‹Ÿæœº, WAF ä½œä¸ºé˜²ç«å¢™æ˜¯æ‰€æœ‰å¤–ç½‘æµé‡çš„ç¬¬äºŒå±‚å…¥å£, è´Ÿè´£ä»£ç†å±€åŸŸç½‘çš„å…¶ä»–æœåŠ¡, å¦‚æœå‡ºç°é—®é¢˜å¯ä»¥å¿«é€Ÿç†”æ–­.

å…¶ä»– 2 ä¸ªè™šæ‹Ÿæœºä½œä¸ºå®éªŒæœº, ä½¿ç”¨çº¯å‡€çš„ç³»ç»Ÿé¿å…å› ä¸ºç«¯å£å†²çªå¯¼è‡´å¯åŠ¨å¤±è´¥ç­‰é—®é¢˜å‡ºç°(å¯„ä¸»æœºå·²ç»å¯åŠ¨äº†å¤ªå¤šçš„ Docker å®¹å™¨, ç®¡ç†ç«¯å£ç¡®å®æœ‰ç‚¹éº»çƒ¦, ç”¨æ–°çš„è™šæ‹Ÿæœºç›´æ¥ docker-compose å¯åŠ¨å³å¯, é¿å…å‡çº§æ—¶ git pull çš„å†²çª).

#### å°å¼ç»„è£…æœº

![20241229154732_9NJuNO46.webp](https://cdn.dong4j.site/source/image/20241229154732_9NJuNO46.webp)

ä¸¥é‡å…‰æ±¡æŸ“è­¦å‘Š!!!

å…·ä½“ç¡¬ä»¶å‚æ•°:

- CPU: åŒè·¯ E5 2680V4;
- å†…å­˜: 256G ECC å†…å­˜(å…¨éƒ¨æ’æ»¡, è¦çš„å°±æ˜¯è¿™ç§æ»¡è¶³æ„Ÿ);
- ç£ç›˜: `1T SSD * 2` (åæœŸä¼šè€ƒè™‘æ‰©å…… HDD ç¡¬ç›˜);
- æ˜¾å¡: 2080Ti + P40;
- ç½‘å¡: æ¿è½½åŒåƒå…†ç”µå£ç½‘å¡ + PCIe è½¬ä¸‡å…†ç”µå£ç½‘å¡ + PCIe è½¬ 2.5G ç”µå£ç½‘å¡ + USB è“ç‰™ & WiFi æ¨¡å—;

æ—©æœŸæ˜¯çœŸçš„æƒ³ç»„è£…ä¸€å°å±äºè‡ªå·±çš„æœåŠ¡å™¨, è€ƒè™‘è¿‡æœºæ¶æœåŠ¡å™¨, ä¾¿å®œæ˜¯çœŸä¾¿å®œ, å¥ˆä½•å™ªéŸ³æœºå™¨ä½“ç§¯éƒ½æ— æ³•æ¥å—, æ”¾å®¶é‡Œè‚¯å®šä¸åˆé€‚.

æ‰€ä»¥é€‰æ‹©äº†æ”¯æŒåŒè·¯çš„åå—ä¸»æ¿, æ­é… 2 é¢— E5 2680V4, æ€§ä»·æ¯”è¿˜æ˜¯æŒºé«˜çš„.

åç»­ç»§ç»­æ¡åƒåœ¾, å†…å­˜æ¡å…¨éƒ¨æ’æ»¡, ç³»ç»Ÿä¹Ÿä» Windows 11 æ¢æˆäº† Ubuntu Server 22.04(E5 è·‘ Windows 11 å¡çš„æˆ‘æ€€ç–‘äººç”Ÿ).

å­˜å‚¨å€’æ˜¯æ²¡æœ‰å¤ªå¤šçš„è¦æ±‚, æ‰€ä»¥ç›´æ¥æ­é…äº† 2 æ¡ 1T SSD, åæœŸåœ¨è€ƒè™‘æ‰©å±•å§.

ä¼ ç»Ÿçš„å°é—­å¼æœºç®±æ²¡æœ‰æ‰¾åˆ°æ»¡æ„çš„, ç´¢æ€§å°±å»å’¸é±¼å®šåˆ¶äº†ä¸€æ¬¾å¼€æ”¾å‹æœºç®±, çœ‹ç€è¿˜ä¸é”™, å°±æ˜¯ç°å°˜ä¸å¥½æ‰“ç†.

å› ä¸ºæ’äº† 2 å¼ æ˜¾å¡, è¿™ä¸ªè€—ç”µé‡ç€å®æœ‰ç‚¹åƒä¸æ¶ˆ, ç›®å‰ä¹Ÿåªä¼šåœ¨æµ‹è¯•æœ€æ–°æ¨¡å‹æ—¶æ‰ä¼šå¼€æœº, å…¶ä»–æ—¶é—´éƒ½åœ¨åƒç°.

2080Ti å’¸é±¼äºŒæ‰‹è´­å…¥, ä½†æ˜¯ 1800, ç°åœ¨æœ‰é­”æ”¹ 22G çš„ç‰ˆæœ¬, åç»­å¯ä»¥å°è¯•ä¸€ä¸‹.
è·‘æ¨¡å‹éå¸¸åƒæ˜¾å­˜, å› æ­¤åç»­åˆè´­å…¥äº† Tesla P40, 24G æ˜¾å­˜å¯ä»¥è‡ªå·±è®­ç»ƒ Lora æ¨¡å‹äº†.

å› ä¸ºæ•£çƒ­é—®é¢˜å¯¼è‡´å®•æœºè¿‡å‡ æ¬¡, å› æ­¤å¯¹ 2080Ti è¿›è¡Œäº†é­”æ”¹, åŠ è£…äº†æ•£çƒ­é’¢æ¿å¹¶æ”¹æˆäº†æ°´å†·, ç›®å‰è·‘æ¨¡å‹è¿˜èƒ½å‹å¾—ä½.

Tesla P40 å› ä¸ºæ˜¯æœåŠ¡å™¨ä¸Šä½¿ç”¨çš„ä¸å…·å¤‡ä¸»åŠ¨æ•£çƒ­, å› æ­¤å»å’¸é±¼ä¸Šæ”¹äº†ä¸ªæ•£çƒ­, ç›®å‰ç”¨ä¸‹æ¥è¿˜å‹‰å¼ºå¤Ÿç”¨, ä¸è¿‡ä¸æ˜¯ç‰¹åˆ«æ¨è, ä¸€æ˜¯é€Ÿåº¦å¤ªæ…¢äº†, äºŒæ˜¯æœ‰å¯èƒ½ä¸è¢«æ¨¡å‹æ”¯æŒ.

##### æ¥å…¥ç±³å®¶

ä¸ºäº†æ–¹ä¾¿çš„å¼€å…³æœº, åŠ è£…äº†ä¸€å¼  WiFi å¼€æœºå¡, æ¥å…¥ç±³å®¶åå¯ç›´æ¥è¯­éŸ³å¼€å…³æœº.

![20241229154732_ekHpddvV.webp](https://cdn.dong4j.site/source/image/20241229154732_ekHpddvV.webp)

### ç¾¤æ™– NAS

|  ç¡¬ä»¶  |                                å‹å·                                 | æ•°é‡ |                  å¤‡æ³¨                  |
| :----: | :-----------------------------------------------------------------: | :--: | :------------------------------------: |
| DS218+ |             10G å†…å­˜/2T SSD ç»„ Raid1/åƒå…†ç”µå£+2.5G ç”µå£             |  1   | ä¸»è¦ç”¨äº Drive æ•°æ®åŒæ­¥, è·‘è½»é‡ Docker |
| DS923+ | 36G å†…å­˜/2T SSD ç»„ Raid1 ä½œä¸ºç³»ç»Ÿç›˜/ 6T + 8T + `10T*2` HDD/ä¸‡å…†ç”µå£ |  1   |  é‡è¦æ•°æ®å¤‡ä»½,å½±éŸ³æœåŠ¡, Docker å¯„ä¸»æœº  |

#### DS218+

![20241229154732_CHgbTUwq.webp](https://cdn.dong4j.site/source/image/20241229154732_CHgbTUwq.webp)

ä» 2019 å¹´å…¥æ‰‹ç¬¬ä¸€å° DS218+ å¼€å§‹, ä¾¿å…¥äº† NAS çš„å‘, åŸæ¥ NAS è¿˜èƒ½è¿™ä¹ˆå¥½ç©, æœ€å¼€å§‹è´­ä¹°çš„ `6*6` T HDD ç¡¬ç›˜å› ä¸ºæ–­ç”µæŸåäº†ä¸€å—, å¯¼è‡´ç°åœ¨å¯¹ HDD çš„é€‰æ‹©éå¸¸è°¨æ….

ç›®å‰ DS218+ ä¸»è¦é€šè¿‡ Synology Drive æ¥åŒæ­¥æ–‡ä»¶, å› ä¸ºæœ‰å…¬ç½‘ IP çš„åŠ æŒ, å›´ç»• Drive æ­å»ºäº†å…¨å¹³å°çš„æ•°æ®åŒæ­¥æ–¹æ¡ˆ, ç›®å‰ä½¿ç”¨ä¸‹æ¥éå¸¸çœå¿ƒ.

ä¸ºäº†æé«˜ DS218+ çš„æ•°æ®åŒæ­¥æ•ˆç‡, ä¸”æˆ‘ä¹Ÿä¸éœ€è¦ç‰¹åˆ«å¤§çš„ HHD, å› æ­¤ç´¢æ€§å°† HDD å…¨éƒ¨æ›´æ¢ä¸º SSD, å¹¶ç»„äº† Raid1 æ¥ä¿è¯æ•°æ®å®‰å…¨.

#### USB 2.5G ç½‘å¡

DS218+ ä½¿ç”¨äº† USB è½¬ 2.5G ç½‘å¡å°†ç½‘ç»œå‡çº§åˆ°äº† 2.5G, [è¿™é‡Œ](https://www.iplaysoft.com/synology-nas-25g.html) æ˜¯è¯¦ç»†çš„æ•™ç¨‹, ä¸è¿‡ç°åœ¨é€šè¿‡ç¬¬ä¸‰æ–¹çš„å¥—ä»¶æ›´åŠ æ–¹ä¾¿:

![20241229154732_pXRy1ms9.webp](https://cdn.dong4j.site/source/image/20241229154732_pXRy1ms9.webp)

éœ€è¦åœ¨å¥—ä»¶ä¸­å¿ƒæ·»åŠ ç¬¬ä¸‰æ–¹å¥—ä»¶æ¥æº:

![20241229154732_zNrxABRp.webp](https://cdn.dong4j.site/source/image/20241229154732_zNrxABRp.webp)

å¥—ä»¶åœ°å€æ±‡æ€»:

- spk7: spk7.imnks.com
- synocommunity: https://packages.synocommunity.com/
- äº‘æ¢¦: https://spk.520810.xyz:666
- 4sag: https://spk.4sag.ru/

#### DS923+

![20241229154732_DO0n6x0e.webp](https://cdn.dong4j.site/source/image/20241229154732_DO0n6x0e.webp)

è€Œ DS923+ ä½œä¸ºé‡è¦æ•°æ®çš„å¤‡ä»½ä»æœº, ä¼šå¯¹ DS218+ è¿›è¡Œå…¨ç›˜å¤‡ä»½, åŒæ—¶è·‘ä¸€äº›å½±éŸ³æœåŠ¡, Docker å¯„ä¸»æœº. å€¼å¾—è¯´æ˜çš„æ˜¯, DS923+ å®˜ç½‘è¯´åªæ”¯æŒ 32G å†…å­˜, è¯•æµ‹æ˜¯å¯ä»¥æœ€å¤§æ”¯æŒåˆ° 64G çš„, ç›®å‰åªè´­ä¹°äº†ä¸€å¼  32G ECC å†…å­˜, åŠ ä¸ŠåŸæ¥çš„ 4G ä¸€å…± 36G.

[DS923+ æ”¯æŒ SSD ä½œä¸ºå­˜å‚¨ç›˜](https://post.smzdm.com/p/all3nvl8/), å¯æ˜¯å‘çˆ¹çš„æ˜¯åªèƒ½ä½¿ç”¨å®˜ç½‘çš„ M.2, ä¸è¿‡å¼€æºçš„ [Synology HDD db](https://github.com/007revad/Synology_HDD_db) å¯ä»¥å®Œç¾çš„ç»•è¿‡è¿™ä¸ªé—®é¢˜,

éœ€è¦åœ¨ DSM æ›´æ–°åé‡æ–°è¿è¡Œè¯¥è„šæœ¬ã€‚å¦‚æœ DSM è®¾ç½®ä¸ºè‡ªåŠ¨æ›´æ–°ï¼Œåˆ™æœ€ä½³é€‰é¡¹æ˜¯åœ¨ Synology æ¯æ¬¡å¯åŠ¨æ—¶è¿è¡Œè¯¥è„šæœ¬ï¼Œè€Œæœ€ä½³æ–¹æ³•æ˜¯è®¾ç½®è®¡åˆ’ä»»åŠ¡ä»¥åœ¨å¯åŠ¨æ—¶è¿è¡Œè¯¥è„šæœ¬:

![20241229154732_3bSAtDBM.webp](https://cdn.dong4j.site/source/image/20241229154732_3bSAtDBM.webp)

è¿˜æœ‰å…¶ä»–å‡ ä¸ªé¡¹ç›®å¯ä»¥å°è¯•:

- [Synology enable M2 volume](https://github.com/007revad/Synology_enable_M2_volume)
- [Synology M2 volume](https://github.com/007revad/Synology_M2_volume)

#### ä¸‡å…†ç½‘å¡

DS923+ å®˜ç½‘ 10G ç½‘å¡:

![20241229154732_oFOXXxgS.webp](https://cdn.dong4j.site/source/image/20241229154732_oFOXXxgS.webp)

æˆ‘é€‰æ‹© DS923+ çš„åŸå› å°±æ˜¯æ”¯æŒä¸‡å…†ç½‘å¡, ä¸ºåæœŸå…¨å±‹ä¸‡å…†æ‰“ä¸‹åŸºç¡€, ä½†æ˜¯å®˜æ–¹çš„ç½‘å¡å®åœ¨å¤ªè´µ, æŠµå¾—ä¸Š `1/5` çš„ DS923+ çš„ä»·æ ¼äº†, ç›´åˆ°å…¼å®¹çš„ç½‘å¡å‡ºç°, 400+ çš„ä»·æ ¼æœæ–­ä¸‹æ‰‹:

![20241229154732_rfOI8I5O.webp](https://cdn.dong4j.site/source/image/20241229154732_rfOI8I5O.webp)

ç°åœ¨ DS923+ ä¸ Mac mini 2018 é€šè¿‡ `HYWS-SGT0204S` ä¸‡å…†äº¤æ¢æœºç›´è¿, æ‹·è´é€Ÿåº¦éå¸¸æ»¡æ„, åæœŸè€ƒè™‘å°†ä¹¦æˆ¿çš„ä¸»è¦è®¾å¤‡å…¨éƒ¨å‡çº§åˆ°ä¸‡å…†(ç°åœ¨å°±å·®å…¨å£ä¸‡å…†äº¤æ¢æœºå’Œé›·ç”µ 4 è½¬ä¸‡å…†æ‰©å±•åäº†, è¿˜åœ¨çŠ¹è±«å…¨å…‰å£è¿˜æ˜¯ç”µå£, å¤§æ¦‚ç‡ä¼šå…¨å…‰å£, å‘çƒ­é‡æ¯”ç”µå£å°çš„å¤š, ä½†æ˜¯éƒ¨åˆ†è®¾å¤‡åªèƒ½ç”¨ç”µå£, å› æ­¤è¿˜è¦å¢åŠ å…‰è½¬ç”µæ¥å£çš„æˆæœ¬).

![20241229154732_aUnLVbI4.webp](https://cdn.dong4j.site/source/image/20241229154732_aUnLVbI4.webp)

è·‘æ»¡äº†ç†è®ºé€Ÿåº¦.

![20241229154732_rMPeFABT.webp](https://cdn.dong4j.site/source/image/20241229154732_rMPeFABT.webp)

`HYWS-SGT0204S` äº¤æ¢æœºåªæœ‰ 2 ä¸ªä¸‡å…†å…‰å£, åˆ†åˆ«é€šè¿‡ä¸‡å…†å…‰è½¬ç”µæ¨¡å—è¿æ¥ DS923+ å’Œ Mac mini 2018, å‘çƒ­é‡ä¹Ÿæ˜¯ä¸å°, å› æ­¤é¢å¤–å¢åŠ äº†æ•£çƒ­é£æ‰‡å’Œæ•£çƒ­ç‰‡, æ•ˆæœéå¸¸å¥½.

#### é“¾è·¯èšåˆ

![20241229154732_vLCqG6GH.webp](https://cdn.dong4j.site/source/image/20241229154732_vLCqG6GH.webp)

å› ä¸ºè´­ä¹°äº†ç‹¬ç«‹çš„ä¸‡å…†ç½‘å¡, è‡ªå¸¦çš„ 2 ä¸ªåƒå…†ç½‘å¡å°±å¯ä»¥ç©ç©é“¾è·¯èšåˆäº†, ä¸è¿‡å› ä¸ºæ²¡æœ‰è¿æ¥åˆ°å…·å¤‡ç½‘ç®¡åŠŸèƒ½çš„äº¤æ¢æœºä¸Š, ç›®å‰ä¹Ÿå°±åªèƒ½ç®—ä¸ªè‡ªå¨±è‡ªä¹, è¿˜ä¸å…·å¤‡å¸¦å®½ç¿»å€çš„æ•ˆæœ.

å¯ä»¥å‚è€ƒä»¥ä¸‹é“¾æ¥æ¥å­¦ä¹ ç›¸å…³çŸ¥è¯†:

- [SMB3 å¤šé€šé“å’Œé“¾è·¯èšåˆçš„åŒºåˆ«](https://kb.synology.cn/zh-cn/DSM/tutorial/smb3_multichannel_link_aggregation)
- [nas å¼€å¯é“¾è·¯èšåˆï¼Œæå‡å¤šè®¾å¤‡è®¿é—®å¸¦å®½](https://post.smzdm.com/p/apm8p5mw/)

æˆ‘çš„ç›®çš„æ˜¯å®ç°æå‡å¤šè®¾å¤‡å¹¶å‘è®¿é—®çš„æ•ˆç‡, ç†è®ºä¸Šåªéœ€è¦æ·»åŠ ä¸€å°å…·å¤‡ç½‘ç®¡åŠŸèƒ½çš„äº¤æ¢æœºå³å¯(ç›®å‰ç¡¬ä»¶å·²ç»æœ‰äº†, ä½†æ˜¯éœ€è¦æ”¹é€ çº¿è·¯, åé¢å†æŠ˜è…¾å§).

### ç¡¬è·¯ç”±

|          ç¡¬ä»¶           |        å‹å·        | æ•°é‡ |                    å¤‡æ³¨                    |
| :---------------------: | :----------------: | :--: | :----------------------------------------: |
|       å°ç±³ AX9000       | ç”µä¿¡æ‹¨å·, ä¸»è·¯ç”±å™¨ |  1   |      1G å®½å¸¦æ¥å…¥, 2.5G ç½‘å£ç”¨ä½œå±€åŸŸç½‘      |
|       å°ç±³ AX1800       | AX9000 Mesh è·¯ç”±å™¨ |  2   |    ä¹¦æˆ¿å’Œä¸»å§å„ä¸€ä¸ª, å¢åŠ  WiFi è¦†ç›–é¢ç§¯    |
|      å°ç±³ 6500Pro       | è”é€šæ‹¨å·, ä¸»è·¯ç”±å™¨ |  1   |      1G å®½å¸¦æ¥å…¥, 2.5G ç½‘å£ç”¨ä½œå±€åŸŸç½‘      |
|     å°ç±³è·¯ç”±å™¨ R3D      | 6500Pro äºŒçº§è·¯ç”±å™¨ |  1   |       æ·˜æ±°ä¸‹æ¥çš„, 1T ç¡¬ç›˜å½“ä¸‹è½½æœºç”¨        |
|     å°ç±³è·¯ç”±å™¨ R1D      | 6500Pro äºŒçº§è·¯ç”±å™¨ |  1   |       æ·˜æ±°ä¸‹æ¥çš„, 1T ç¡¬ç›˜å½“ä¸‹è½½æœºç”¨        |
| AirPort Time Capsule 2T |   AX9000 å­è·¯ç”±    |  1   | å…³é—­äº† WiFi, ç”¨ä½œ macOS ç³»ç»Ÿå¤‡ä»½, ç½‘å£æ‹“å±• |
|     Airport Express     |   AX9000 å­è·¯ç”±    |  1   |     å…³é—­äº† WiFi, åªç”¨ä½œ AirPlay2 æ”¾æ­Œ      |

å®¶é‡Œæ˜¯ç”µä¿¡è”é€šåŒåƒå…†å®½å¸¦å…¥æˆ·, ç”µä¿¡ä½œä¸ºä¸»ç½‘, ç”¨ä½œå®¶åº­ä¸»è¦ä¸Šç½‘å®½å¸¦; è”é€šä½œä¸ºè¾…ç½‘, ç”¨ä½œä¸‹è½½ä¸ç‰©è”è®¾å¤‡è”ç½‘, äº’ä¸å¹²æ¶‰, å†—ä½™è®¾è®¡.

#### AX9000

![20241229154732_NNLkCikg.webp](https://cdn.dong4j.site/source/image/20241229154732_NNLkCikg.webp)

AX9000 æ˜¯å¯ä»¥è·‘ Docker çš„, ä¸”èƒ½å¤Ÿé€šè¿‡ Docker è·å– root æƒé™, ä½†æ˜¯å°è¯•è¿‡åå‘ç°ä¸æ˜¯ç‰¹åˆ«ç¨³å®š, æ‰€ä»¥è¿˜åŸæˆäº†. ä¸“ä¸šçš„äº‹æƒ…è¿˜æ˜¯è®©ä¸“ä¸šçš„è®¾å¤‡æ¥å¹²å§.

![20241229154732_NadeAzr8.webp](https://cdn.dong4j.site/source/image/20241229154732_NadeAzr8.webp)

ç›®å‰å¸¦äº†å·®ä¸å¤šå¿« 40 ä¸ªç»ˆç«¯è®¾å¤‡, ç¨³å®šæ€§è¿˜æ˜¯å¯ä»¥çš„.

#### AX1800

AX1800 é€šè¿‡æœ‰çº¿ä¸ AX9000 è¿›è¡Œ Mesh ç»„ç½‘, ä¸€ä¸ªæ”¾åœ¨ä¸»å§, å¦ä¸€ä¸ªæ”¾åœ¨ä¹¦æˆ¿, ä¸€æ˜¯ä½œä¸º WiFi çƒ­ç‚¹, äºŒæ˜¯ä½œä¸º Lan æ‰©å±•, ä¸‹çº§å†è¿æ¥äº¤æ¢æœºä¸ºå¼€å‘æ¿æä¾›æœ‰çº¿æ¥å…¥.

#### 6500Pro

![20241229154732_LjKBfdVw.webp](https://cdn.dong4j.site/source/image/20241229154732_LjKBfdVw.webp)

è´­ä¹° 6500Pro æ˜¯çœ‹ä¸Šäº†å®ƒå†…ç½®çš„ä¸­æ¢ç½‘å…³, å®¶é‡Œå¤§éƒ¨åˆ†æ™ºèƒ½è®¾å¤‡æ˜¯å°ç±³æ——ä¸‹çš„, åŸºæœ¬ä¸ŠèŠ‚çœäº†ä¸€å°ç½‘å…³çš„é’±, ä½†æ˜¯æ€§èƒ½æœ‰ç‚¹å·®å¼ºäººæ„, ä¸€æ˜¯å»¶è¿Ÿè¾ƒé«˜, äºŒæ˜¯æ•£çƒ­è®¾è®¡éå¸¸ä¸åˆç†, å¦‚æœæœ‰æ„è´­ä¹° 6500Pro çš„æœ‹å‹, å¯ä»¥å…ˆçœ‹çœ‹è¿™ä¸ª [æµ‹è¯„](https://www.bilibili.com/video/BV1zx4y147WQ?t=339.8), åé¢å¯èƒ½ä¼šè€ƒè™‘è¿›è¡Œæ”¹é€ .

![20241229154732_fgAIfLaz.webp](https://cdn.dong4j.site/source/image/20241229154732_fgAIfLaz.webp)

6500Pro ä¸»è¦ä½œä¸ºæ™ºèƒ½å®¶å±…è®¾å¤‡æ¥å…¥, å› æ­¤ä¸“é—¨å¼€äº†ä¸€ä¸ª `ihome.device` çš„ 2.4GHz çš„é¢‘æ®µ, å¹¶ä¸”å¦å¤–å¼€è®¾äº†ä¸€ä¸ªè®¿å®¢ç½‘ç»œ, ä¾›æ¥è®¿çš„æœ‹å‹ä½¿ç”¨.

#### å°ç±³è·¯ç”±å™¨ R3D && R1D

![20241229154732_VELGdZq6.webp](https://cdn.dong4j.site/source/image/20241229154732_VELGdZq6.webp)

![20241229154732_Dw4yHaXG.webp](https://cdn.dong4j.site/source/image/20241229154732_Dw4yHaXG.webp)

2 æ¬¾è·¯ç”±å™¨éƒ½æ¯”è¾ƒç»å…¸, è‡ªå¸¦ 1T HDD ä¸”å…·æœ‰ SMBA åŠŸèƒ½, å®Œå…¨å¯ä»¥å½“è½» NAS æ˜¯ç”¨, æœŸé—´è·å–è¿‡ root æƒé™, ä½†æ˜¯ç¡¬ä»¶ç´ è´¨å¤ªå·®, ä¸å…·å¤‡å¤ªå¤§çš„å¯ç©æ€§.

ä¸çŸ¥é“ä»ä½•å¼€å§‹, å–œæ¬¢ä¸ŠæŠ˜è…¾æ•£çƒ­äº†, èƒ½åŠ è£…æ•£çƒ­çš„è®¾å¤‡é€šé€šä¸æ”¾è¿‡, å®ƒä¸¤æœ¬èº«çš„æ•£çƒ­ä¸€èˆ¬, å¤å¤©ç¨æœ‰ç‚¹çƒ­, ç°åœ¨çš„å¤–åŠ æ•£çƒ­è¿˜æ˜¯æœ‰ç‚¹ç”¨, ä½†ä¸æ˜¯å¤ªå¤š.

#### AirPort Time Capsule 2T & Airport Express

![20241229154732_Ln4zBPrS.webp](https://cdn.dong4j.site/source/image/20241229154732_Ln4zBPrS.webp)
![20241229154732_uePyCTQR.webp](https://cdn.dong4j.site/source/image/20241229154732_uePyCTQR.webp)

2 æ¬¾åœäº§è®¸ä¹…çš„äº§å“, AirPort Time Capsule 2T è¿˜æ˜¯å¤šå¹´å‰å»ä¸‡è±¡åŸäººè‚‰æå›æ¥çš„, 2T çš„å¤‡ä»½å¤‡ä»½ 3 å° macOS, å‹‰å¼ºå¤Ÿç”¨å§, å¦å¤–ä½œä¸ºåƒå…†ç½‘å£çš„æ‰©å±•.

Airport Express åé¢å’¸é±¼å…¥æ‰‹çš„, ä¹Ÿå°±æ‹¿æ¥ AirPlay2 æ”¾æ­Œç”¨, æ²¡æœ‰å…¶ä»–ç”¨é€”äº†.

![20241229154732_1zzg0yZM.webp](https://cdn.dong4j.site/source/image/20241229154732_1zzg0yZM.webp)

æ„Ÿè§‰ Apple è·¯ç”±å™¨è®¾ç½®è¿˜æ˜¯è›®æ–¹ä¾¿çš„.

#### IPV6

ä¸¤æ¬¾ä¸»è·¯ç”±å™¨éƒ½æ”¯æŒå¼€å¯ IPV6, ä¸”åœ¨å¤–ç½‘èƒ½å¤Ÿæ­£å¸¸é€šè¿‡ IPV6 è®¿é—®å®¶é‡Œçš„è®¾å¤‡, ä½†æ˜¯ç›®å‰æ˜¯å…³é—­çŠ¶æ€, å› ä¸ºæœ‰éƒ¨åˆ†æœåŠ¡è¿˜æ²¡æœ‰æ¥å¾—åŠè®¾ç½®å®‰å…¨è®¤è¯, æ€»è§‰å¾—ç›´æ¥æš´éœ²åˆ°å…¬ç½‘ä¼šæœ‰å®‰å…¨é—®é¢˜(IPV6 å› ä¸ºé•¿åº¦çš„é—®é¢˜æƒ³è¦æš´åŠ›çŒœæµ‹å¯èƒ½æ²¡é‚£ä¹ˆå®¹æ˜“, å¥ˆä½•æˆ‘ç»‘å®šäº†åŸŸå, è¿™ä¸ä¸€ Ping å°±çŸ¥é“è®¾å¤‡çš„å”¯ä¸€åœ°å€äº†, è¿˜æ˜¯å…ˆç”¨ IPV4 å§, è‡³å°‘èƒ½é€šè¿‡ç«¯å£è½¬å‘æ§åˆ¶æš´éœ²å‡ºå»çš„æœåŠ¡).

#### ä¸ºä»€ä¹ˆä¸ç”¨çŒ«æ£’ä»£æ›¿å…‰çŒ«

ç»å¸¸çœ‹åˆ°æœ‰è§†é¢‘ä»‹ç» `çŒ«æ£’+ 2.5G è·¯ç”±å™¨` ä»£æ›¿å…‰çŒ«çªç ´åƒå…†, æˆ‘å¹¶æ²¡æœ‰é‡‡ç”¨è¿™ç§æ–¹æ¡ˆ, ä¸»è¦åŸå› æ˜¯:

- çŒ«æ£’å‘çƒ­é‡å·¨å¤§, é™ä½äº†ç¨³å®šæ€§;
- ä¸ºäº†ä» 930Mbps çªç ´åˆ° 1100Mbps+, é¢å¤–è´­ä¹°çŒ«æ£’å’Œå…¶ä»–ç¡¬ä»¶, æˆ‘è§‰å¾—æ€§ä»·æ¯”ä¸æ˜¯ç‰¹åˆ«é«˜;

#### ä¸ºä»€ä¹ˆä¸è€ƒè™‘å¤šçº¿å¤šæ‹¨ã€è´Ÿè½½å‡è¡¡ã€å®½å¸¦å åŠ 

åŒæ ·ä¼šæœ‰å¤§é‡è§†é¢‘æ¨èå¤šçº¿å¤šæ‹¨ã€è´Ÿè½½å‡è¡¡ã€å®½å¸¦å åŠ ç­‰å®ç° 1+1 = 2 çš„ç½‘é€Ÿ, ä½†æ˜¯è¿™äº›æ–¹æ¡ˆæˆ‘æ²¡æœ‰è€ƒè™‘çš„åŸå› æ˜¯:

- å¤§å¤šæ•°è¿è¥å•†ä¸æ”¯æŒå¤šæ‹¨, æˆ–è€…å¤šæ‹¨ä¹Ÿä¸ä¼šå åŠ ç½‘é€Ÿ, æˆ‘ä¸»è¦è€ƒè™‘ç¨³å®šæ€§;
- ç½‘é€Ÿå¿«ä¸ä»£è¡¨ä½“éªŒå¥½, è”é€šå®½å¸¦å»¶è¿Ÿæ¯”ç”µä¿¡å®½å¸¦å»¶è¿Ÿé«˜, æˆ‘å¯ä»¥æŒ‰éœ€ä½¿ç”¨ä¸åŒçš„å®½å¸¦, é¿å…å»¶è¿Ÿä¸å¯æ§;
- IP ä¹±è·³: æˆ‘çš„ç”µä¿¡å’Œè”é€šå®½å¸¦éƒ½æœ‰å…¬ç½‘ IP, ç”¨ä¸Šè¿°æ–¹æ³•è‚¯å®šä¼šå¯¼è‡´å‡ºå£ IP éšæœºå˜åŒ–, å½“ç„¶å¯ä»¥é€šè¿‡é…ç½®è§£å†³, ä½†æ˜¯ä¼šå¢åŠ é¢å¤–çš„ç¡¬ä»¶æˆæœ¬å’Œé…ç½®å¤æ‚åº¦;
- æˆ‘ç›®å‰æ ¹æœ¬ç”¨ä¸åˆ°è¿™ä¹ˆå¿«çš„ç½‘é€Ÿ, ä¸Šè¿°æ–¹å¼ç›®å‰åªåœç•™åœ¨æµ‹é€Ÿä¸Š, å¯¹æˆ‘æ¥è¯´æ²¡æœ‰å®é™…åº”ç”¨åœºæ™¯;
- å› ä¸ºä¼šå­˜åœ¨å•ç‚¹é—®é¢˜, å¹¶ä¸æƒ³ä½¿ç”¨ä¸€ä¸ªè®¾å¤‡å»æ‰¿è½½ 2 æ¡å®½å¸¦;

ç›®å‰è€ƒè™‘çš„æ˜¯åŒå®½å¸¦ä¸»ä»å†—ä½™, å„å¸å…¶èŒ, ä¸”å¦ä¸€ä¸ªå…³é”®çš„åŸå› æ˜¯éœ€è¦é€šè¿‡ Wireguard è¿›è¡Œå¼‚åœ°ç»„ç½‘, ä¼šåˆ†åˆ«é€šè¿‡ä¸åŒçš„å®½å¸¦æ¥å…¥åˆ°å®¶ä¸­çš„å±€åŸŸç½‘, å› æ­¤ä¸æƒ³æ›´æ”¹ç›®å‰çš„ç½‘ç»œæ¶æ„.

### è½¯è·¯ç”±

| ç¡¬ä»¶ |       å‹å·       | æ•°é‡ |                 å¤‡æ³¨                 |
| :--: | :--------------: | :--: | :----------------------------------: |
| R2S  | ç”µä¿¡&è”é€š æ—è·¯ç”± |  3   | è½»é‡ Docker å®¹å™¨, å¹¿å‘Šè¿‡æ»¤, å¼‚åœ°ç»„ç½‘ |
| R5S  | ç”µä¿¡&è”é€š æ—è·¯ç”± |  1   | è½»é‡ Docker å®¹å™¨, å¹¿å‘Šè¿‡æ»¤, å¼‚åœ°ç»„ç½‘ |
| H28K | ç”µä¿¡&è”é€š æ—è·¯ç”± |  1   | è½»é‡ Docker å®¹å™¨, å¹¿å‘Šè¿‡æ»¤, å¼‚åœ°ç»„ç½‘ |

OpenWrt åˆæ˜¯ä¸€ä¸ªæ‰“å¼€æ–°ä¸–ç•Œå¤§é—¨çš„ä¼Ÿå¤§å¼€æºé¡¹ç›®, ä»æœªæƒ³è¿‡è¿˜èƒ½éšå¿ƒæ‰€æ¬²çš„é…ç½®ç½‘ç»œ, ä¸è¿‡åœ¨é…ç½®çš„è¿‡ç¨‹ä¸­ä¹Ÿé‡åˆ°äº†ä¸å°‘å‘.

è´­ä¹°è½¯è·¯ç”±çš„æœ‹å‹, æ€ä¹ˆä½¿ç”¨åº”è¯¥éƒ½çŸ¥é“å§, æ‰€ä»¥è¿™éƒ¨åˆ†å°±ä¸å±•å¼€è¯´äº†.

#### R2S

æœ€å¼€å§‹å…¥æ‰‹çš„ R2S, å°å·§çš„å¤–å½¢åŠ é“åˆé‡‘æè´¨, æ€ä¹ˆçœ‹æ€ä¹ˆå–œæ¬¢, åæ¥åŠ ä¸Šäº†é£æ‰‡, é€šè¿‡æ¸©æ§è„šæœ¬æ§åˆ¶é£æ‰‡è½¬é€Ÿ.

åˆšå¼€å§‹å› ä¸ºå¯¹ OpenWtr ä¸æ˜¯ç‰¹åˆ«ç†Ÿæ‚‰, ä¸çŸ¥é“ Lan å£è¿˜èƒ½æ”¹æˆ Wan å£, å°±åªä½œä¸ºç”µä¿¡å®½å¸¦çš„å­è·¯ç”±ä½¿ç”¨, éƒ¨ç½² Wireguard ååªèƒ½è®¿é—®ç”µä¿¡çš„å±€åŸŸç½‘, å› æ­¤åé¢æ¡æ¼è´­ä¹°äº†å¦ä¸€ä¸ª R2S, ä½œä¸ºè”é€šå®½å¸¦çš„ Wireguard æœåŠ¡å™¨.

éšç€æŠ˜è…¾çš„ä¸æ–­æ·±å…¥, å°è¯•å°† Lan å£ä¿®æ”¹ä¸º Wan å£, ç°åœ¨ R2S èƒ½å¤ŸåŒæ—¶æ¥å…¥ç”µä¿¡å’Œè”é€šå®½å¸¦, æƒå½“ä½œä¸ºå†—ä½™å§, ä¹Ÿæ²¡æœ‰å‡ºæ‰å¤šä½™çš„ R2S.

![20241229154732_kwknvZTL.webp](https://cdn.dong4j.site/source/image/20241229154732_kwknvZTL.webp)

æ”¾åœ¨ä¹¦æˆ¿æ¡Œé¢ä¸Š, ä½œä¸ºç”µä¿¡çš„äºŒçº§è·¯ç”±, è”é€šä½œä¸ºå†—ä½™å®½å¸¦æ¥å…¥.

![20241229154732_qhHqVaPO.webp](https://cdn.dong4j.site/source/image/20241229154732_qhHqVaPO.webp)

æ”¾åœ¨å¼±ç”µç®±, ä½œä¸ºè”é€šçš„äºŒçº§è·¯ç”±, ç”µä¿¡ä½œä¸ºå†—ä½™å®½å¸¦æ¥å…¥.

![20241229154732_27qy1AB3.webp](https://cdn.dong4j.site/source/image/20241229154732_27qy1AB3.webp)

ç¬¬ä¸‰å° R2S æ”¾åœ¨å…¬å¸ä½¿ç”¨, ä¸»è¦ä¹Ÿæ˜¯ä½œä¸º Wireguard æœåŠ¡å™¨, ä¸å®¶é‡Œçš„è®¾å¤‡è¿›è¡Œå¼‚åœ°ç»„ç½‘.

å€¼å¾—è¯´æ˜çš„æ˜¯, R2S çš„ Wan å£æ˜¯é€šè¿‡ USB3.0 è½¬æ¢çš„, æµ‹è¯•è¿‡æœ€å¤šè·‘åˆ° 600M+, ä½†æ˜¯å› ä¸ºä½¿ç”¨åœºæ™¯çš„ä¸åŒ, æˆ‘ç›®å‰å¯¹è¿™ä¸ªé€Ÿç‡è¿˜ä¸æ˜¯é‚£ä¹ˆæ•æ„Ÿ, æ‰€ä»¥ä¹Ÿæ²¡æœ‰å‡çº§çš„å¿…è¦.

##### å°† Lan æ”¹æˆ Wan æ¥å£

R2S ä¸»è¦ä½œä¸ºæ—è·¯ç”±ä½¿ç”¨, å› æ­¤å¹¶ä¸éœ€è¦è®¾å¤‡ä¸ Lan ç›´æ¥, æ‰€ä»¥å¤šå‡ºæ¥çš„ Lan å£å¯ä»¥ç”¨æ¥åš Wan å£, è¿™æ ·å°±å¯ä»¥åŒæ—¶æ¥å…¥ç”µä¿¡å’Œè”é€šå®½å¸¦äº†.

ä½†æ˜¯ä¼šå­˜åœ¨ç½‘å¡ä¼˜å…ˆçº§çš„é—®é¢˜, å¯ä»¥é€šè¿‡ç½‘å…³è·ƒç‚¹è§£å†³:

![20241229154732_HVQ66tyu.webp](https://cdn.dong4j.site/source/image/20241229154732_HVQ66tyu.webp)

å…·ä½“çš„é…ç½®æ–¹å¼ä¼šåœ¨ç½‘ç»œç¯‡ä¸­è¯¦ç»†è¯´æ˜.

##### æ¸©æ§è„šæœ¬

æˆ‘å®‰è£…çš„å›ºä»¶å¹¶æ²¡æœ‰å®˜æ–¹çš„æ¸©æ§è„šæœ¬, ä¸è¿‡æŒ‰ç…§ [æ•™ç¨‹](https://github.com/coolsnowwolf/lede/issues/5681) å®Œç¾å®ç°äº†æ¸©æ§.

```shell
curl -o /usr/bin/start-rk3328-pwm-fan.sh https://github.com/friendlyarm/friendlywrt/blob/master-v19.07.1/target/linux/rockchip-rk3328/base-files/usr/bin/start-rk3328-pwm-fan.sh \
curl -o /etc/init.d/fa-rk3328-pwmfan https://github.com/friendlyarm/friendlywrt/blob/master-v19.07.1/target/linux/rockchip-rk3328/base-files/etc/init.d/fa-rk3328-pwmfan \
chmod +x /usr/bin/start-rk3328-pwm-fan.sh  /etc/init.d/fa-rk3328-pwmfan \
/etc/init.d/fa-rk3328-pwmfan enable \
/etc/init.d/fa-rk3328-pwmfan start
```

#### R5S

![20241229154732_BJuukFNQ.webp](https://cdn.dong4j.site/source/image/20241229154732_BJuukFNQ.webp)

åŠ ä¸Šäº†æ•£çƒ­é£æ‰‡, ä½†æ˜¯æ¸©æ§è¿˜æ²¡æœ‰æå®š, ä¸è¿‡å¼•å‡ºäº† PWM æ¥å£, åç»­æŠ˜è…¾çš„æ—¶å€™ä¸ç”¨å†æ‹†æœºå™¨äº†, ç›´æ¥é€šè¿‡ PWM å–ç”µ, æ›¿æ¢ç°åœ¨çš„ USB.

è¿˜ä¸º R5S æ·»åŠ äº† 256G çš„ M.2 SSD, ä½œç”¨è½»é‡æœåŠ¡å™¨, 4G çš„å†…å­˜ä¸èƒ½ç™½ç™½æµªè´¹äº†.

#### H28K

éå¸¸å–œæ¬¢è¿™ç§å°å·§çš„é“åˆé‡‘æœºèº«, å› æ­¤å¿ä¸ä½åˆä¹°äº† H28K 4G ç‰ˆæœ¬, ä¸è¿‡ç›®å‰ä¹Ÿä»…ä»…æ˜¯ä½œä¸º Wireguard æœåŠ¡å™¨, è¿ Docker å®¹å™¨éƒ½è¿˜æ²¡æœ‰ ğŸ¤£.

![20241229154732_2dNPRgDy.webp](https://cdn.dong4j.site/source/image/20241229154732_2dNPRgDy.webp)

![20241229154732_pYC2RuuP.webp](https://cdn.dong4j.site/source/image/20241229154732_pYC2RuuP.webp)

å› ä¸º H28K æ²¡æœ‰ PWM æ¥å£, å°±è‡ªå·±ç„Šæ¥äº†ä¸€ä¸ª USB æ¥é©±åŠ¨é£æ‰‡, æ„Ÿè§‰è¿˜è¡Œ ğŸ˜.

### äº¤æ¢æœº

|         ç¡¬ä»¶         |               å‹å·               | æ•°é‡ |               å¤‡æ³¨               |
| :------------------: | :------------------------------: | :--: | :------------------------------: |
|  TP-Link TL-SH1005   |   ç”µä¿¡&è”é€š `2.5G*5å£ äº¤æ¢æœº`    |  2   |         å¼±ç”µç®±å‡ºå£äº¤æ¢æœº         |
| å…®å…‹ SKS1200-8GPY1XF | ç”µä¿¡ `2.5G*8å£ + 1ä¸‡å…†å£ äº¤æ¢æœº` |  1   |          ä¹¦æˆ¿å…¥å£äº¤æ¢æœº          |
|       DX-1009N       | è”é€š `2.5G*8å£ + 1ä¸‡å…†å£ äº¤æ¢æœº` |  1   |          ä¹¦æˆ¿å…¥å£äº¤æ¢æœº          |
|  TP-Link TL-SG2008D  |      ç”µä¿¡ `åƒå…†*8å£ äº¤æ¢æœº`      |  1   |  äºŒçº§äº¤æ¢æœº, ä¸»è¦ç”¨äºè¿æ¥å¼€å‘æ¿  |
|  TP-Link TL-SG1008D  |      è”é€š `åƒå…†*8å£ äº¤æ¢æœº`      |  1   |  äºŒçº§äº¤æ¢æœº, ä¸»è¦ç”¨äºè¿æ¥å¼€å‘æ¿  |
|   iKuai IK-J3005D    |   ç”µä¿¡&è”é€š `åƒå…†*5å£ äº¤æ¢æœº`    |  2   |          ä¹¦æˆ¿ä¸´æ—¶äº¤æ¢æœº          |
|    HYWS-SGT0204S     | è”é€š `2.5G*4å£ + ä¸‡å…†*2å£äº¤æ¢æœº` |  1   | mac mini 2018 å’Œ DS923+ ä¸‡å…†ç›´è¿ |

äº¤æ¢æœºé™†é™†ç»­ç»­æ¢äº†å¥½å¤šæ¬¾, ä¸»è¦æ˜¯ä» åƒå…†å‡çº§åˆ° 2.5G, åˆ°ç°åœ¨çš„ 2.5G æ··åˆä¸‡å…†ç½‘å£. åç»­ä¼šè€ƒè™‘ä¸ºä¹¦æˆ¿æ·»åŠ è”é€šä¸‡å…†äº¤æ¢æœº, å°†ä¸»è¦è®¾å¤‡è¿›è¡Œä¸‡å…†ç›´è¿, ä¸»è¦åŒ…æ‹¬:

- MBP: é€šè¿‡é›·ç”µ 4 è½¬ä¸‡å…†å…‰å£;
- Mac mini 2018: è‡ªå¸¦ä¸‡å…†ç”µå£;
- Mac mini M2: è‡ªå¸¦ä¸‡å…†ç”µå£;
- DS923+: å·²å‡çº§åˆ°ä¸‡å…†ç”µå£;
- M920X: è‡ªå¸¦ 2 ä¸ªä¸‡å…†å…‰å£;
- ç»„è£…æœº: è‡ªå¸¦ 1 ä¸ªä¸‡å…†ç”µå£;

å› æ­¤è´­ä¹°ä¸€ä¸ª 8 å…‰å£çš„ä¸‡å…†äº¤æ¢æœºç»°ç»°æœ‰ä½™, ç„¶åæ ¹æ®éœ€è¦è´­ä¹°ä¸‡å…†å…‰è½¬ç”µæ¨¡å—ç›´è¿.

#### TL-SH1005

![20241229154732_A5NMXTPo.webp](https://cdn.dong4j.site/source/image/20241229154732_A5NMXTPo.webp)

å¼±ç”µç®±ç”µä¿¡ç©å…‰çŒ«å…‰çº¤æ¥å…¥, é€šè¿‡é¢„åŸ‹çš„ç½‘çº¿ä¸å¯¹é¢ç”µè§†æŸœä¸­çš„ AX9000 è¿æ¥å¹¶æ‹¨å·ä¸Šç½‘, åœ¨é€šè¿‡å¦ä¸€æ ¹é¢„åŸ‹çš„ç½‘çº¿æ¥å›åˆ° `TL-SH1005` äº¤æ¢æœº, ç„¶åå†æ¥å…¥åˆ°å…¶ä»–æˆ¿é—´.

è”é€šå®½å¸¦æ¥å…¥å°±ç›¸å¯¹ç®€å•è®¸å¤š, å› ä¸ºå…‰çŒ«, 6500Pro è¿˜æœ‰äº¤æ¢æœºéƒ½åœ¨å¼±ç”µç®±é™„è¿‘, ç›´æ¥é€šè¿‡çŸ­è·ç¦»æœ‰çº¿è¿æ¥å³å¯, åŒæ ·æ˜¯å…‰çº¤å…¥æˆ·, è·¯ç”±å™¨æ‹¨å·.

è¿˜å¥½è£…ä¿®æ—¶é¢„åŸ‹äº†å¤šæ¡ç½‘çº¿: å®¢å…ç”µè§†æŸœ 3 æ ¹, ä¸»å§å’Œä¹¦æˆ¿ 2 æ ¹, æ¬¡å§ 1 æ ¹.

å¦‚æœåŸ‹å°‘äº†ææ€•æ•´ä¸ª HomeLab åˆæ˜¯å¦ä¸€ç§æ¶æ„äº†.

#### SKS1200-8GPY1XF & DX-1009N

![20241229154732_eWULXP1G.webp](https://cdn.dong4j.site/source/image/20241229154732_eWULXP1G.webp)

![20241229154732_DNx5FYKP.webp](https://cdn.dong4j.site/source/image/20241229154732_DNx5FYKP.webp)

2 ä¸ªäº¤æ¢æœºå…ˆåä»å’¸é±¼è´­ä¹°, æ²¡æœ‰å»ç»†ç©¶å…·ä½“å‚æ•°, æœ¬ç€æ¡åƒåœ¾çš„åŸåˆ™, æ¡ä¾¿å®œçš„ä¹°å°±è¡Œ.

ä»ä¹¦æˆ¿çš„ 2 ä¸ªç½‘å£åˆ†åˆ«æ¥å…¥ç”µä¿¡å’Œè”é€šç½‘ç»œ, ä¸ºä¹¦æˆ¿å…¶ä»–è®¾å¤‡æä¾›æœ‰çº¿ç½‘ç»œæ¥å…¥ (åŸºæœ¬ä¸Šæ¯å°è®¾å¤‡éƒ½å…·å¤‡åŒç½‘å£, ä¸ºäº†å°†å†—ä½™åšåˆ°æè‡´, å•ç½‘å£çš„ä¹Ÿè¦æ•´ä¸ª USB è½¬ 2.5G ç½‘å¡).

#### IK-J3005D

![20241229154732_SrWEV0Zf.webp](https://cdn.dong4j.site/source/image/20241229154732_SrWEV0Zf.webp)

å…ˆåä¹°äº† 2 ä¸ª, æ”¾åœ¨æ¡Œé¢ä¸Šåšä¸´æ—¶çš„äº¤æ¢æœº, å°å·§å åœ°æ–¹.

![20241229154732_nIZrJBLi.webp](https://cdn.dong4j.site/source/image/20241229154732_nIZrJBLi.webp)

#### HYWS-SGT0204S

![20241229154732_ILxjbwLr.webp](https://cdn.dong4j.site/source/image/20241229154732_ILxjbwLr.webp)

åæ¥ 2.5G ç½‘å£ä¸å¤Ÿäº†, ä¸”ä¸ºäº†å°† Mac mini 2018 ä¸ DS923+ è¿›è¡Œä¸‡å…†ç›´è¿, æ–°å¢äº†è¿™ä¸ªäº¤æ¢æœº.

åç»­è€ƒè™‘æ¢æˆå…¨ä¸‡å…†äº¤æ¢æœº, æŠŠä¸»è¦è®¾å¤‡å…¨éƒ¨å‡çº§åˆ°ä¸‡å…†äº’è”.

### å½±éŸ³ç¡¬ä»¶

|     ç¡¬ä»¶     |      å‹å·      | æ•°é‡ |         å¤‡æ³¨         |
| :----------: | :------------: | :--: | :------------------: |
| Apple TV 4K  |      64G       |  1   |       å®¢å…ç”µè§†       |
|   HomePod    |     ç¬¬ä¸€ä»£     |  1   |       ä¹¦æˆ¿éŸ³ç®±       |
| HomePod mini |     ç¬¬äºŒä»£     |  2   |       å®¢å…éŸ³ç®±       |
|   æ— æºéŸ³ç®±   |      ç»„è£…      |  2   | å®‰è£…åœ¨ä¹¦æ¡Œä¸‹, å¬ä¸ªå“ |
| é£å‚² K5 Pro  |   K5Pro ESS    |  1   |     æ­é…è€³æœºä½¿ç”¨     |
|   æ–è®¯ T1    | 2G RAM+16G ROM |  1   |      Android TV      |

#### Apple TV 4K

![20241229154732_ElyFwp0H.webp](https://cdn.dong4j.site/source/image/20241229154732_ElyFwp0H.webp)

é…åˆ VidHub æ’­æ”¾ NAS ç”µå½±, æœ€æ–°æ”¯æŒ Surge TV ç‰ˆæœ¬, å¶å°”çœ‹è§ Youtube, ç”¨çš„ä¸æ˜¯ç‰¹åˆ«å¤š.

![20241229154732_VsMwHGx7.webp](https://cdn.dong4j.site/source/image/20241229154732_VsMwHGx7.webp)

#### HomePod & HomePod mini

![20241229154732_YSzmu4lT.webp](https://cdn.dong4j.site/source/image/20241229154732_YSzmu4lT.webp)

ç¬¬ä¸€ä»£çš„ HomePod, å¬è¯´ç¬¬äºŒä»£é˜‰å‰²äº†, æ‰€ä»¥ä¸€ç›´æ²¡æœ‰æ‰“ç®—æ¢äºŒä»£, ç›®å‰é…åˆæ¡Œä¸‹çš„æ— æºéŸ³ç®±, æ¡Œä¸Šæ¡Œä¸‹é½å“, ç¯ç»•æ„Ÿè¿˜æ˜¯æŒºå¼ºçš„.

![20241229154732_c89rF33q.webp](https://cdn.dong4j.site/source/image/20241229154732_c89rF33q.webp)
![20241229154732_DROEGZoZ.webp](https://cdn.dong4j.site/source/image/20241229154732_DROEGZoZ.webp)

HomePod Mini æ”¾åœ¨å®¢å…æ²™å‘åé¢å½“ Apple TV 4K çš„éŸ³æºè¾“å‡º, å¶å°”å…¨å±‹ Airplay æ’­æ”¾, æ„Ÿè§‰è¿˜æ˜¯æŒºä¸é”™çš„.

#### æ— æºéŸ³ç®±

![20241229154732_IFntOP3X.webp](https://cdn.dong4j.site/source/image/20241229154732_IFntOP3X.webp)

![20241229154732_uVOqbKwb.webp](https://cdn.dong4j.site/source/image/20241229154732_uVOqbKwb.webp)

å…¨å¥—å’¸é±¼è´­ä¹°, è‡ªå·±ç»„è£…

#### é£å‚² K5 Pro

![20241229154732_585f3N3G.webp](https://cdn.dong4j.site/source/image/20241229154732_585f3N3G.webp)

çƒ§è¿‡ä¸€æ®µæ—¶é—´ Hi-Fi, åé¢å‡ºæ‰äº†éšæ—¶è®¾å¤‡, å°±ç•™ä¸‹äº†è¿™ä¸ªå’Œ WH-1000XM4 é…åˆä½¿ç”¨.

#### æ–è®¯ T1

![20241229154732_1FRBAwoW.webp](https://cdn.dong4j.site/source/image/20241229154732_1FRBAwoW.webp)

ä¸­é—´é‚£ä¸ªé»‘è‰²é»‘å­å°±æ˜¯ T1, åˆ·äº†ç¬¬ä¸‰æ–¹ YYF å›ºä»¶. å±å¹•å’Œ Mac mini M2 å…±ç”¨, ä½¿ç”¨ç»¿è”çš„ KVM åˆ‡æ¢è§†é¢‘è¾“å…¥.

![20241229154732_BrlibYQG.webp](https://cdn.dong4j.site/source/image/20241229154732_BrlibYQG.webp)

å‘çš„åœ°æ–¹æ˜¯æ²¡æœ‰é€‚é… Apple Silicon çš„ macOS ç³»ç»Ÿ, å› ä¸ºæˆ‘ä¹°äº† 2 ä¸ª, Apple Intel CPU å°±èƒ½å¾ˆå¥½çš„é€‚é….

ç°åœ¨ä¹Ÿåœ¨åƒç°, åé¢çœ‹èƒ½ä¸èƒ½æŠ˜è…¾ä¸‹åˆ·æˆ Armbian ç³»ç»Ÿç©ç©.

### äº‘æœåŠ¡å™¨

|  ç¡¬ä»¶  |  å‹å·   | æ•°é‡ |              å¤‡æ³¨               |
| :----: | :-----: | :--: | :-----------------------------: |
| é˜¿é‡Œäº‘ | 2 æ ¸ 2G |  1   | å›ºå®šå…¬ç½‘ ip, åšå®¢æœåŠ¡, å¼‚åœ°ç»„ç½‘ |

å¾ˆå¤šæŠ˜è…¾çš„å‰æçš„è¦æœ‰ä¸€ä¸ªå›ºå®šå…¬ç½‘ IP, è™½ç„¶ç°åœ¨ä¹Ÿèƒ½é€šè¿‡ DDNS æ¥å®ç°é€šè¿‡åŸŸåè®¿é—®å®¶ä¸­çš„æœåŠ¡, ä½†æ˜¯ç»ä¸èµ·ä¾¿å®œå•Š, 99 å…ƒ/å¹´çš„ä»·æ ¼, æ€ä¹ˆçœ‹æ€ä¹ˆåˆ’ç®—, ä¸€å£æ°”ä¹°äº† 2 å¹´.

### å…¶ä»–ç¡¬ä»¶

|         ç¡¬ä»¶          |       å‹å·        | æ•°é‡ |              å¤‡æ³¨              |
| :-------------------: | :---------------: | :--: | :----------------------------: |
|    æ ‘è“æ´¾ Zero 2W     |     512M å†…å­˜     |  1   |             å¼€å‘æ¿             |
|       æ ‘è“æ´¾ 4B       |      8G å†…å­˜      |  1   |             å¼€å‘æ¿             |
|       æ ‘è“æ´¾ 5B       |      8G å†…å­˜      |  2   |             å¼€å‘æ¿             |
|      NanoPI NEO4      | 1G å†…å­˜/ 32G eMMC |  2   |             å¼€å‘æ¿             |
|        HK1 Box        | 32GB é—ªå­˜/4G å†…å­˜ |  1   |         Home Assistant         |
| LaCie d2 Professional |        8T         |  1   |              å†·å¤‡              |
|          UPS          | APC Back-UPS 650  |  1   | ä½œä¸º DS923+ å’Œå¼€å‘æ¿çš„å¤‡ç”¨ç”µæº |

#### æ ‘è“æ´¾

![20241229154732_hGLITh7m.webp](https://cdn.dong4j.site/source/image/20241229154732_hGLITh7m.webp)

![20241229154732_V3BDovDE.webp](https://cdn.dong4j.site/source/image/20241229154732_V3BDovDE.webp)

æ„Ÿè§‰åˆ°äº†æŸä¸ªé˜¶æ®µ, ç¼–å†™è½¯ä»¶å·²ç»æ— æ³•æ»¡è¶³å¥½å¥‡å¿ƒäº†, æ‰€ä»¥é™†ç»­ä¹°äº†å‡ ä¸ªæ ‘è“æ´¾ç©ä¸€äº›æ–°å¥‡çš„ä¸œè¥¿, é€šè¿‡è½¯ä»¶æ§åˆ¶ç¡¬ä»¶æ„Ÿè§‰éå¸¸é…·, ç›®å‰ä¸»è¦ç©å„¿çš„æ˜¯å·¥ä½œç›¸å…³çš„, æ¯”å¦‚æµåª’ä½“æœåŠ¡.

#### NanoPI NEO4

![20241229154732_LTBOWvRm.webp](https://cdn.dong4j.site/source/image/20241229154732_LTBOWvRm.webp)

![20241229154732_6zOsKEwl.webp](https://cdn.dong4j.site/source/image/20241229154732_6zOsKEwl.webp)

RK3399 çš„å‘çƒ­é‡æ˜¯çœŸçš„å¤§, æ‰€ä»¥ä¹°äº†å‡ ä¸ªæ ‘è“æ´¾å°é£æ‰‡å¹¶åŠ è£…äº†æ•£çƒ­ç‰‡. å¼€å‘æ¿å°±ä¹°è¿‡ NanoPi å’Œæ ‘è“æ´¾, å…¶ä»–å®¶çš„è¿˜æ²¡å°è¯•è¿‡, ä½†æ˜¯ç°åœ¨è¿˜æ˜¯æ›´å–œæ¬¢æ ‘è“æ´¾(èµ„æ–™å¤š, ç¤¾åŒºæ´»è·ƒ).

åº”è¯¥èƒ½çœ‹åˆ°å…¶ä¸­ä¸€å°è¿æ¥äº†æ‘„åƒå¤´, å› ä¸ºèµ„æ–™çš„é—®é¢˜è¿˜æ²¡é©±åŠ¨èµ·æ¥.

#### HK1 Box

![20241229154732_mrLkUdXc.webp](https://cdn.dong4j.site/source/image/20241229154732_mrLkUdXc.webp)

![20241229154732_49Ty7sy8.webp](https://cdn.dong4j.site/source/image/20241229154732_49Ty7sy8.webp)

å’¸é±¼è´­ä¹°, åˆ·äº† Armbian, é€šè¿‡ Docker å®‰è£… Home Assistant, ä»¥å‰ç»å¸¸æ­»æœº, åæ¥åœ¨ UART æ¥å£ç„Šæ¥äº†æ’çº¿å¹¶å®‰è£…äº†æ•£çƒ­é£æ‰‡, ç°åœ¨ç¨³å®šè¿è¡Œ.

#### LaCie d2 Professional

![20241229154732_7INVu9M2.webp](https://cdn.dong4j.site/source/image/20241229154732_7INVu9M2.webp)

é€šè¿‡ é›·é›³ 3 å’Œ Mac mini 2018 è¿æ¥, é€šè¿‡ rsync å®šæ—¶å¤‡ä»½ DS923+ çš„é‡è¦æ•°æ®.

#### UPS

![20241229154732_CkcTZ6A7.webp](https://cdn.dong4j.site/source/image/20241229154732_CkcTZ6A7.webp)

æœå½¹äº†å‡ å¹´, ä¸»è¦æ˜¯ä¿æŠ¤ DS923+, æœ€è¿‘æ›´æ¢è¿‡ä¸€æ¬¡ç”µæ± , åŠ è£…äº†ç”µå‹æ˜¾ç¤ºæ¨¡å—.

## æ€»ç»“

æœ¬ç¯‡æ–‡ç« ç½—åˆ—äº†ä¸ªäººæ‹¥æœ‰çš„ç¡¬ä»¶è®¾å¤‡, å› ä¸ºç¨³å®šæ€§è€ƒè™‘, æ›´å€¾å‘æ˜¯ç”¨ç‹¬ç«‹ç¡¬ä»¶è¿è¡Œç‰¹å®šçš„ç³»ç»Ÿ, å–ä»£ **All in One** çš„æ–¹æ¡ˆ, ç½‘ç»œæ–¹é¢ä¹Ÿæ˜¯ç‹¬ç«‹åˆ†å¼€, äº’ç›¸å†—ä½™.

è¿™ä¸ªè¿˜æ˜¯è¦çœ‹å®é™…éœ€æ±‚, æˆ‘éœ€è¦é‡åº¦ä¾èµ–å®¶ä¸­çš„ NAS å’Œå…¶ä»–æœåŠ¡, èŠ±äº†å¤§é‡å»è®¾è®¡å®¹é”™æ–¹æ¡ˆ.

æœ€åè´´ä¸€ä¸‹ä¹¦æˆ¿çš„æ€»è€—ç”µé‡(è®¾å¤‡åº”è¯¥å¯åŠ¨äº† 80% å·¦å³çš„æƒ…å†µä¸‹):

![20241229154732_6KeYfJoJ.webp](https://cdn.dong4j.site/source/image/20241229154732_6KeYfJoJ.webp)

æ›´å¤šå†…å®¹æ•¬è¯·æœŸå¾…...

<!--
https://nerdyarticles.com/my-homelab-a-general-overview/
https://chriskirby.net/setting-up-and-leveling-up-your-homelab-a-comprehensive-guide/
-->

**ç›¸å…³æ–‡ç« :**

1. [[homelab-guide|å…ˆå¯¼ç¯‡]]ï¼šæˆ‘çš„ HomeLab æ¦‚è¦;
2. [[homelab-hardware|ç¡¬ä»¶ç¯‡]]ï¼šä»‹ç»æˆ‘æ‰€æ‹¥æœ‰çš„ç¡¬ä»¶è®¾å¤‡;
3. [[homelab-network|ç½‘ç»œç¯‡]]ï¼šåŒ…æ‹¬ç½‘ç»œç¯å¢ƒã€å¼‚åœ°ç»„ç½‘ä¸ç½‘ç»œå®‰å…¨;
4. [[homelab-service|æœåŠ¡ç¯‡]]ï¼šä½¿ç”¨ Docker æ­å»ºçš„å„ç±»æœåŠ¡;
5. [[homelab-data|æ•°æ®ç¯‡]]ï¼šåŒ…æ‹¬æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆ;
6. [[homelab-data-sync|HomeLabæ•°æ®åŒæ­¥ï¼šæ„å»ºé«˜æ•ˆçš„æ•°æ®åŒæ­¥ç½‘ç»œ]]
7. [[homelab-data-backup|HomeLabæ•°æ®å¤‡ä»½ï¼šæ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿]]
8. [[homelab-upgrade-to-10g|HomeLab ç½‘ç»œç»­é›†ï¼šå‡çº§ 10G ç½‘ç»œ-å†æˆ˜ 10 å¹´]]
9. [[homelab-guide|NAT å†…ç½‘ç©¿é€è¯¦è§£ï¼šæ­ç§˜ç½‘ç»œè¿æ¥èƒŒåçš„å¥¥ç§˜]]

## [HomeLab å…ˆå¯¼ç¯‡ï¼šå…¥é—¨æŒ‡å—-å¼€å¯ä½ çš„ä¸ªäººäº‘ç«¯å®éªŒå®¤ä¹‹æ—…](https://blog.dong4j.site/posts/15433dee.md)

![/images/cover/20241229154732_dJYxL1SG.webp](https://cdn.dong4j.site/source/image/20241229154732_dJYxL1SG.webp)

ä¸­å¹´ç”·äººçš„ä¸‰å¤§çˆ±å¥½ï¼šå……ç”µå¤´ã€NASã€è½¯è·¯ç”±ã€‚è¿™ä¸‰å¤§çˆ±å¥½ä¸ä»…ä¸ºæˆ‘ä»¬çš„ç”Ÿæ´»å¸¦æ¥äº†ä¾¿åˆ©ï¼Œä¹Ÿæˆä¸ºäº†æˆ‘ä»¬ç”Ÿæ´»çš„ä¸€éƒ¨åˆ†(ğŸ¤¡)ã€‚

ä½œä¸ºä¸€ä¸ªè½¯ä»¶å¼€å‘è€…ï¼Œæˆ‘ä¸€ç›´æ¢¦æƒ³ç€æ‹¥æœ‰è‡ªå·±çš„æœåŠ¡å™¨ï¼Œè€Œ NAS å’Œè½¯è·¯ç”±åˆ™æ˜¯æˆ‘é€šå¾€è¿™ä¸ªæ¢¦æƒ³çš„æ¡¥æ¢ã€‚

è‡ªä»è´­ä¹°äº†æˆ‘çš„ç¬¬ä¸€å° NAS ä»¥æ¥ï¼Œä¾¿æ‰“å¼€äº†ä¸€æ‰‡æ–°ä¸–ç•Œçš„å¤§é—¨ã€‚NASï¼Œå³ç½‘ç»œé™„åŠ å­˜å‚¨ï¼ˆNetwork Attached Storageï¼‰ï¼Œå®ƒä¸ä»…æä¾›äº†ä¸€ä¸ªå®‰å…¨çš„æ•°æ®å­˜å‚¨è§£å†³æ–¹æ¡ˆï¼Œè¿˜è®©æˆ‘èƒ½å¤Ÿå®ç°æ•°æ®çš„å¤‡ä»½å’Œå…±äº«ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæˆ‘é™†ç»­è´­ä¹°äº†å…¶ä»–ç¡¬ä»¶äº§å“ï¼Œå¦‚è½¯è·¯ç”±å™¨ã€æœåŠ¡å™¨ç­‰ï¼Œé€æ­¥æ­å»ºèµ·äº†å±äºæˆ‘çš„ HomeLabã€‚

ä»Šå¤©ï¼Œæˆ‘æƒ³å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹æˆ‘æ­å»º HomeLab çš„è¿‡ç¨‹ï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©åˆ°é‚£äº›åŒæ ·æœ‰å¿—äºæ­å»º HomeLab çš„æœ‹å‹ã€‚åœ¨æ¥ä¸‹æ¥çš„åšå®¢æ–‡ç« ä¸­ï¼Œæˆ‘å°†è¯¦ç»†ä»‹ç»å¦‚ä½•é€‰è´­åˆé€‚çš„ NAS è®¾å¤‡ã€è½¯è·¯ç”±å™¨ä»¥åŠæœåŠ¡å™¨ï¼Œå¹¶åˆ†äº«æˆ‘åœ¨æ­å»ºè¿‡ç¨‹ä¸­é‡åˆ°çš„æŒ‘æˆ˜å’Œè§£å†³æ–¹æ¡ˆã€‚

HomeLab å¹¶éé¥ä¸å¯åŠï¼Œåªè¦æˆ‘ä»¬ç”¨å¿ƒå»æ¢ç´¢å’Œå®è·µï¼Œå°±èƒ½å¼€å¯å±äºè‡ªå·±çš„ä¸ªäººäº‘ç«¯å®éªŒå®¤ä¹‹æ—…ã€‚è®©æˆ‘ä»¬ä¸€èµ·å­¦ä¹ ã€äº¤æµå’Œæˆé•¿ï¼Œå…±åŒæ‰“é€ ä¸€ä¸ªå±äºæˆ‘ä»¬çš„æ•°å­—ç‹å›½ã€‚

## å‰æè¯´æ˜

è™½ç„¶å…³äº HomeLab çš„æ–‡ç« å·²ç»å¾ˆå¤šäº†ï¼Œä½†æˆ‘è¿˜æ˜¯æƒ³è®°å½•ä¸‹è‡ªå·±æ­å»º HomeLab çš„ç»å†å’Œé‡åˆ°çš„é—®é¢˜ï¼Œä»¥åŠå¦‚ä½•è§£å†³è¿™äº›é—®é¢˜ã€‚ä¸»è¦ä¼šæ¶‰åŠåˆ°ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1. [[homelab-guide|å…ˆå¯¼ç¯‡]]ï¼šæˆ‘çš„ HomeLab æ¦‚è¦;
2. [[homelab-hardware|ç¡¬ä»¶ç¯‡]]ï¼šä»‹ç»æˆ‘æ‰€æ‹¥æœ‰çš„ç¡¬ä»¶è®¾å¤‡;
3. [[homelab-network|ç½‘ç»œç¯‡]]ï¼šåŒ…æ‹¬ç½‘ç»œç¯å¢ƒã€å¼‚åœ°ç»„ç½‘ä¸ç½‘ç»œå®‰å…¨;
4. [[homelab-service|æœåŠ¡ç¯‡]]ï¼šä½¿ç”¨ Docker æ­å»ºçš„å„ç±»æœåŠ¡;
5. [[homelab-data|æ•°æ®ç¯‡]]ï¼šåŒ…æ‹¬æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆ;
6. [[homelab-data-sync|HomeLabæ•°æ®åŒæ­¥ï¼šæ„å»ºé«˜æ•ˆçš„æ•°æ®åŒæ­¥ç½‘ç»œ]]
7. [[homelab-data-backup|HomeLabæ•°æ®å¤‡ä»½ï¼šæ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿]]
8. [[homelab-upgrade-to-10g|HomeLab ç½‘ç»œç»­é›†ï¼šå‡çº§ 10G ç½‘ç»œ-å†æˆ˜ 10 å¹´]]
9. [[homelab-guide|NAT å†…ç½‘ç©¿é€è¯¦è§£ï¼šæ­ç§˜ç½‘ç»œè¿æ¥èƒŒåçš„å¥¥ç§˜]]

## ä»€ä¹ˆæ˜¯ HomeLab

HomeLabï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å®¶åº­å®éªŒå®¤ã€‚å®ƒå¯ä»¥ç†è§£ä¸ºå®¶åº­ç‰ˆçš„äº‘æœåŠ¡å™¨ï¼Œç”¨æ¥æ­å»ºå„ç§æœåŠ¡ï¼Œæ¯”å¦‚ä¸ªäººç½‘ç›˜ã€åª’ä½“æœåŠ¡å™¨ç­‰ç­‰ã€‚HomeLab çš„ç¡¬ä»¶è®¾å¤‡é€šå¸¸åŒ…æ‹¬ï¼š

1. æœåŠ¡å™¨ï¼šå¯ä»¥æ˜¯ç‰©ç†æœåŠ¡å™¨æˆ–è™šæ‹Ÿæœºï¼Œç”¨äºæ­å»ºå„ç±»æœåŠ¡ã€‚
2. å­˜å‚¨è®¾å¤‡ï¼šå¦‚ NAS å’Œç¡¬ç›˜ï¼Œç”¨äºå­˜å‚¨æ•°æ®ã€‚
3. ç½‘ç»œè®¾å¤‡ï¼šå¦‚è½¯è·¯ç”±å’Œç¡¬è·¯ç”±ï¼Œç”¨äºç®¡ç†ç½‘ç»œã€‚
4. å…¶ä»–è®¾å¤‡ï¼šå¦‚æ‘„åƒå¤´ã€ä¼ æ„Ÿå™¨ç­‰ï¼Œç”¨äºæ”¶é›†æ•°æ®ã€‚

## ä¸ºä»€ä¹ˆé€‰æ‹©è‡ªå»º HomeLab

å¯¹äºæˆ‘æ¥è¯´ï¼Œæ­å»º HomeLab æ˜¯ä¸€ç§æµªæ¼«çš„â€œæŠ˜è…¾â€ã€‚æˆ‘çš„ç›®æ ‡æ˜¯ï¼š

1. æ­å»ºå„ç§æ„Ÿå…´è¶£çš„æœåŠ¡çš„å®éªŒå®¤ï¼šä½œä¸ºä¸€ä¸ªå–œæ¬¢å°è¯•æ–°æŠ€æœ¯çš„äººæ¥è¯´ï¼Œæ­å»ºå„ç±»æœåŠ¡éå¸¸æœ‰è¶£ã€‚æˆ‘å¯ä»¥å¿«é€Ÿå°è¯•å’ŒéªŒè¯æ–°çš„æŠ€æœ¯å’Œæ–¹æ¡ˆï¼Œæ‹¥æœ‰ä¸€å¥—è‡ªå·±çš„å®éªŒå®¤å¯ä»¥è®©æˆ‘æ›´åŠ è‡ªç”±åœ°æ¢ç´¢ã€‚
2. ä¿è¯æ•°æ®å®‰å…¨ï¼šæˆ‘å¯¹æ•°æ®å®‰å…¨éå¸¸é‡è§†ï¼Œæ‰€ä»¥æˆ‘ä¼šæŠŠæ‰€æœ‰çš„æ•°æ®éƒ½å­˜å‚¨åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šï¼Œè€Œä¸æ˜¯ä½¿ç”¨äº‘å­˜å‚¨æœåŠ¡ã€‚è¿™æ ·å¯ä»¥ä¿è¯æˆ‘çš„æ•°æ®ä¸ä¼šè¢«ç¬¬ä¸‰æ–¹æ§åˆ¶ï¼Œæˆ‘å·²ç»å—å¤Ÿäº†ä¸ƒç‰›äº‘çš„ OSSï¼ŒåŸŸåå˜æ›´å¯¼è‡´æˆ‘å¤§é‡å›¾ç‰‡æ— æ³•è®¿é—®ã€‚
3. æ›´å¥½çš„éšç§ä¿æŠ¤ï¼šå®¶äººçš„ç…§ç‰‡ã€å„¿å­çš„æˆé•¿è®°å½•ç­‰ç§å¯†æ•°æ®æœ¬åœ°ç§æœ‰åŒ–å­˜å‚¨å¯ä»¥è®©æˆ‘æ›´åŠ æ”¾å¿ƒï¼Œä¸ä¼šæ‹…å¿ƒæ•°æ®æ³„éœ²çš„é—®é¢˜ã€‚

## HomeLab çš„åŸåˆ™

**KISS åŸåˆ™** : Keep It Simple, Stupid

HomeLab æ­å»ºæ˜¯ä¸€ä»¶è´¹æ—¶è´¹åŠ›çš„è¿‡ç¨‹, ä¸ºäº†é¿å…å ç”¨å¤§é‡ä¸ªäººæ—¶é—´, æˆ‘ä¼šå°½é‡é€‰æ‹©ä¸€äº›ç®€å•æ˜“ç”¨çš„æ–¹æ¡ˆ, é¿å…å¤æ‚çš„é…ç½®å’Œæ“ä½œã€‚

æœ¬ç€å¤Ÿç”¨çš„åŸåˆ™, ä¸ä¼šé€‰æ‹©è¾ƒä¸ºå¤æ‚çš„è½¯ä»¶æ¶æ„.

### ç¡¬ä»¶æˆæœ¬

å¯¹äºé‡è¦çš„æ•°æ®ï¼Œæˆ‘ä¼šç›´æ¥é€‰æ‹©æˆå“ NASï¼Œé¿å…æ•°æ®ä¸¢å¤±ã€‚è€Œå¯¹äºå…¶ä»–ä¸æ˜¯ç‰¹åˆ«é‡è¦çš„æœåŠ¡ï¼Œæˆ‘ä¼šä½¿ç”¨ Docker æ­å»ºï¼Œè¿™æ ·å¯ä»¥æ›´åŠ çµæ´»åœ°ç®¡ç†æ•°æ®ï¼Œä¹Ÿå¯ä»¥æ›´å¥½åœ°æ§åˆ¶æˆæœ¬ã€‚å› æ­¤æ•´ä¸ª HomeLab çš„æ­å»ºå›´ç»•ç€ NAS å±•å¼€ï¼Œè€Œå…¶ä»–ä¸€äº›ä¸é‡è¦çš„æœåŠ¡å°±ç›´æ¥å»å’¸é±¼æ¡åƒåœ¾ã€‚

### è½¯ä»¶æˆæœ¬

å¯¹äº HomeLab æ¥è¯´ï¼Œæœ€å¤§çš„æŠ•å…¥æ˜¯ç¡¬ä»¶æˆæœ¬å’Œæ—¶é—´ã€‚ä¸ºäº†é™ä½æ—¶é—´æˆæœ¬ï¼Œæœ¬ç€ KISS åŸåˆ™, æˆ‘ä¼šç›´æ¥é€‰æ‹©ä½¿ç”¨ Dockerï¼Œè€Œä¸”ä¸ä¼šæ­å»º K8S è¿™ç±»æ¯”è¾ƒæŠ˜è…¾çš„æœåŠ¡ï¼Œå› ä¸ºç›®å‰çš„æœåŠ¡æ•°é‡å’ŒæœåŠ¡è´¨é‡è¿˜ä¸è‡³äºç”¨ä¸Š K8Sï¼ˆä¹Ÿè®¸åœ¨ä¸‹æ¬¡å‡çº§çš„æ—¶å€™ä¼šè€ƒè™‘ï¼‰ã€‚

## HomeLab çš„ç¡¬ä»¶

![20241229154732_lXrWkJfN.webp](https://cdn.dong4j.site/source/image/20241229154732_lXrWkJfN.webp)

![20241229154732_cxOH3POn.webp](https://cdn.dong4j.site/source/image/20241229154732_cxOH3POn.webp)

ç¡¬ä»¶ä»‹ç»å°†åœ¨åç»­æ–‡ç« ä¸­è¯¦ç»†ä»‹ç»ã€‚

## ç½‘ç»œæ¶æ„

![network.drawio.svg](https://cdn.dong4j.site/source/image/network.drawio.svg)

å‡çº§è¿‡ç¨‹ï¼š

1. ç”µä¿¡å®½å¸¦å…¥æˆ·, å…¬ç½‘ IP, å…¨å±‹åƒå…†;
2. ä¸»è¦è®¾å¤‡æ·»åŠ  2.5G ç½‘å£, æ·»åŠ  2.5G ç½‘å£äº¤æ¢æœº;
3. æ·»åŠ ç¬¬äºŒæ¡å®½å¸¦, å…¬ç½‘ IP, å…¨å±‹ 2.5G å‡çº§æ”¹é€ ;
4. æ·»åŠ ä¸‡å…†äº¤æ¢æœº, ä¸»è¦è®¾å¤‡å‡çº§ä¸‡å…†ç½‘å£;

## è‡ªæ‰˜ç®¡æœåŠ¡

Dashboard å¯¹äºæˆ‘æ¥è¯´, å°±æ˜¯ä¸€ä¸ªå±•ç¤ºæˆ‘æ‰€æœ‰æœåŠ¡çš„é¢æ¿, ä¸éœ€è¦æ¯ä¸ªæœåŠ¡å™¨çš„çŠ¶æ€ç›‘æ§, å› æ­¤ä¸€ä¸ªä¹¦ç­¾ç®¡ç†å™¨å°±è¶³å¤Ÿäº†, ç›®å‰æ¯”è¾ƒæ»¡æ„çš„å°±æ˜¯ Chrome çš„æ’ä»¶: [Markoob](https://chromewebstore.google.com/detail/markoob-%E4%B9%A6%E7%AD%BE%E5%90%AF%E5%8A%A8%E5%99%A8/lnhnllkaacmnkffnjgcnokifakeckido?hl=zh-CN), ç®€çº¦ä¸”ä¸å¤æ‚.

![20241229154732_fEzFCGJj.webp](https://cdn.dong4j.site/source/image/20241229154732_fEzFCGJj.webp)

å¤§éƒ¨åˆ†æœåŠ¡ä½¿ç”¨ Docker æ­å»ºï¼Œå› æ­¤é€‰æ‹©è®¾å¤‡çš„åˆšæ€§æ¡ä»¶å°±æ˜¯ï¼šæ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ–ã€‚

## æ•°æ®å­˜å‚¨ä¸å¤‡ä»½

![20241229154732_9HV3mUqg.webp](https://cdn.dong4j.site/source/image/20241229154732_9HV3mUqg.webp)

ä¸»è¦å›´ç»• NAS æ­å»ºï¼ŒåŒ…æ‹¬å®¶åº­ç…§ç‰‡å¤‡ä»½å’ŒæœåŠ¡å™¨é‡è¦æ–‡ä»¶å¤‡ä»½ã€‚

## æ€»ç»“

åœ¨æ­å»ºè¿‡ç¨‹ä¸­é‡åˆ°è¿‡éå¸¸å¤šçš„é—®é¢˜ï¼Œæ­¤ç³»åˆ—æ–‡ç« çš„ä¸»è¦ç›®çš„ä¹Ÿæ˜¯è®°å½•ä¸‹è¿™äº›é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆã€‚å› æ­¤ä¸ä¼šè¯¦ç»†ä»‹ç»è¾ƒä¸ºåŸºç¡€çš„çŸ¥è¯†ï¼Œå¦‚æœéœ€è¦å¯ä»¥å‚è€ƒå…¶ä»–æ–‡ç« ã€‚

{% link å¦‚ä½•æ­å»ºå®¶ç”¨ homelab: å…ˆå¯¼ç¯‡,icyleaf,https://icyleaf.com/2022/02/how-to-homelab-part-0/, https://icyleaf.com/tutorials/how-to-homelab/part-0/cover.png %}
{% link å¦‚ä½•æ­å»ºå®¶ç”¨ homelab: ç¡¬ä»¶å’Œæ¶æ„,icyleaf,https://icyleaf.com/2023/01/how-to-homelab-part-1-hardware-and-architecture/, https://images.unsplash.com/photo-1549319114-d67887c51aed?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=2874&q=80 %}
{% link å¦‚ä½•æ­å»ºå®¶ç”¨ homelab: Openwrt è½¯è·¯ç”±,icyleaf,https://icyleaf.com/2023/04/how-to-homelab-part-2-openwrt-soft-router/, https://images.unsplash.com/photo-1521542464131-cb30f7398bc6?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=2673&q=80 %}
{% link å¦‚ä½•æ­å»ºå®¶ç”¨ homelab: æ•°æ®å­˜å‚¨,icyleaf,https://icyleaf.com/2023/07/how-to-homelab-part-3-storages/, https://images.unsplash.com/photo-1686705562930-4f3e46f620d8?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=3000&q=80 %}

**ç›¸å…³æ–‡ç« :**

1. [[homelab-guide|å…ˆå¯¼ç¯‡]]ï¼šæˆ‘çš„ HomeLab æ¦‚è¦;
2. [[homelab-hardware|ç¡¬ä»¶ç¯‡]]ï¼šä»‹ç»æˆ‘æ‰€æ‹¥æœ‰çš„ç¡¬ä»¶è®¾å¤‡;
3. [[homelab-network|ç½‘ç»œç¯‡]]ï¼šåŒ…æ‹¬ç½‘ç»œç¯å¢ƒã€å¼‚åœ°ç»„ç½‘ä¸ç½‘ç»œå®‰å…¨;
4. [[homelab-service|æœåŠ¡ç¯‡]]ï¼šä½¿ç”¨ Docker æ­å»ºçš„å„ç±»æœåŠ¡;
5. [[homelab-data|æ•°æ®ç¯‡]]ï¼šåŒ…æ‹¬æ•°æ®å­˜å‚¨æ–¹æ¡ˆã€å¤‡ä»½æ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æ–¹æ¡ˆ;
6. [[homelab-data-sync|HomeLabæ•°æ®åŒæ­¥ï¼šæ„å»ºé«˜æ•ˆçš„æ•°æ®åŒæ­¥ç½‘ç»œ]]
7. [[homelab-data-backup|HomeLabæ•°æ®å¤‡ä»½ï¼šæ‰“é€ åšå®çš„æ•°æ®å®‰å…¨é˜²çº¿]]
8. [[homelab-upgrade-to-10g|HomeLab ç½‘ç»œç»­é›†ï¼šå‡çº§ 10G ç½‘ç»œ-å†æˆ˜ 10 å¹´]]
9. [[homelab-guide|NAT å†…ç½‘ç©¿é€è¯¦è§£ï¼šæ­ç§˜ç½‘ç»œè¿æ¥èƒŒåçš„å¥¥ç§˜]]

## [ç§æœ‰äº‘æ—¶ä»£ï¼ŒNASå¦‚ä½•å¸®åŠ©ä¼ä¸šå®ç°é«˜æ•ˆåä½œ?](https://blog.dong4j.site/posts/f5f7afe2.md)

<!-- https://unsplash.com/photos/a-close-up-of-a-cable-with-a-black-background-zqnfqFYaIhE -->

![/images/cover/20241229154732_KKA3Ghw8.webp](https://cdn.dong4j.site/source/image/20241229154732_KKA3Ghw8.webp)

ç›®å‰å…¬å¸çš„æ•°æ®å­˜å‚¨æ¨¡å¼æ¯”è¾ƒè½å, ä¸»è¦é—®é¢˜åœ¨äº**æ•°æ®å®‰å…¨æ€§å·®**ï¼›æ•´ä½“æ•°æ®é‡å¤§ä»¥åŠåŸæœ‰å¤§é‡é™ˆæ—§çš„æ•°æ®éš¾ä»¥å­˜å‚¨ï¼›å­˜åœ¨å¤šæ“ä½œç³»ç»Ÿå¹³å°ï¼Œè®¾å¤‡ç¹æ‚å¯¼è‡´å­˜æ”¾çš„æ•°æ®éš¾ä»¥å…±äº«åä½œå’Œç®¡ç†ï¼Œé€ æˆæ•ˆç‡ä½ä¸‹ï¼›å‘˜å·¥çš„ç¦»èŒé€ æˆèµ„æ–™ä¸¢å¤±ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ»¡è¶³éœ€æ±‚åˆå®‰å…¨çš„æ–¹æ¡ˆæ¥è§£å†³è¿™æ ·çš„æ™®ééš¾é¢˜ã€‚

NAS å­˜å‚¨å…±äº«è§£å†³æ–¹æ¡ˆåŒ…å«ï¼š**ç¾¤æ™– NAS æœåŠ¡å™¨**ã€Backup æ’ä»¶ã€‚

**åº”ç”¨åœºæ™¯ï¼š**
ä¼ä¸šæ•°æ®é›†ä¸­å­˜å‚¨/å…±äº«/å¤‡ä»½ï¼Œä¼ä¸šç§æœ‰äº‘æ–‡ä»¶ç®¡ç†å™¨æ­å»ºã€‚

## æ–¹æ¡ˆèƒŒæ™¯

éšç€ä¼ä¸šä¿¡æ¯åŒ–çš„å‘å±•ï¼Œä¼ä¸šä¿¡æ¯åŒ–å¸¦æ¥çš„æ•°æ®çˆ†ç‚¸å¼å¢é•¿å‘ä¼ä¸šçš„æ•°æ®ç®¡ç†æ–¹å¼æå‡ºäº†æŒ‘æˆ˜ï¼Œ**ä¸€æ–¹é¢è¦åº”å¯¹æ•°æ®å®¹é‡çš„ä¸æ–­æ‰©å……ï¼Œå¦ä¸€æ–¹é¢éœ€è¦ç¡®ä¿æ‰€æœ‰æœ‰æ•ˆæ•°æ®çš„é«˜å®‰å…¨æ€§å’Œå¯ç®¡ç†æ€§**ã€‚ç›®å‰æ¥çœ‹ï¼Œä¼ä¸šçš„æ•°æ®å„è‡ªå­˜æ”¾ã€åˆ†æ•£ç®¡ç†ï¼Œå…³è”æ€§ä¸å¼ºï¼Œæ— æ³•å¾ˆå¥½çš„é’ˆå¯¹ä¸åŒçš„ä¸šåŠ¡æ•°æ®è¿›è¡Œç»Ÿä¸€ã€æœ‰æ•ˆçš„ç®¡ç†ã€‚

ä¼ä¸šçš„æ•°æ®å­˜å‚¨æ¨¡å¼æ¯”è¾ƒè½åï¼Œæˆæœ¬è¾ƒé«˜ä¸”æ•ˆç‡ä½ä¸‹ï¼Œä¸»è¦é—®é¢˜åœ¨äºæ•°æ®å®‰å…¨æ€§å·®ï¼›æ•´ä½“æ•°æ®é‡å¤§ä»¥åŠåŸæœ‰å¤§é‡é™ˆæ—§çš„æ•°æ®éš¾ä»¥å­˜å‚¨ï¼›å­˜åœ¨å¤šæ“ä½œç³»ç»Ÿå¹³å°ï¼Œè®¾å¤‡ç¹æ‚å¯¼è‡´å­˜æ”¾çš„æ•°æ®éš¾ä»¥å…±äº«åä½œå’Œç®¡ç†ï¼Œé€ æˆæ•ˆç‡ä½ä¸‹ï¼›å‘˜å·¥çš„ç¦»èŒé€ æˆèµ„æ–™ä¸¢å¤±ã€‚

ä»å¯¹ä¼ä¸šå•ä½æ•°æ®å­˜å‚¨çš„åˆ†æä¸­å¯ä»¥çœ‹å‡ºï¼Œè¦ä½¿æ•´ä¸ªä¼ä¸šå†…éƒ¨çš„æ•°æ®å¾—åˆ°ç»Ÿä¸€ç®¡ç†å’Œå®‰å…¨åº”ç”¨ï¼Œå°±å¿…é¡»æœ‰ä¸€ä¸ªå®‰å…¨ã€æ€§ä»·æ¯”å¥½ã€åº”ç”¨æ–¹ä¾¿ã€ç®¡ç†ç®€å•çš„ç‰©ç†ä»‹è´¨æ¥å­˜å‚¨å’Œç®¡ç†ä¼ä¸šå†…éƒ¨çš„æ•°æ®èµ„æ–™ã€‚æŠŠæ‰€æœ‰é›¶æ•£çš„æ•°æ®å’Œä¸šåŠ¡ç³»ç»Ÿä¸­çš„é‡è¦æ•°æ®è¿›è¡Œç®¡ç†ï¼Œé¿å…åœ¨å¼‚å¸¸æƒ…å†µä¸‹æ•°æ®çš„ä¸¢å¤±ã€‚

## æ–¹æ¡ˆè®¾è®¡æ¦‚è¿°

NAS ç½‘ç»œå­˜å‚¨è®¾å¤‡æ˜¯ä¸€æ¬¾ç‰¹æ®Šè®¾è®¡çš„æ–‡ä»¶å­˜å‚¨æœåŠ¡å™¨ï¼Œå®ƒèƒ½å¤Ÿå°†ç½‘ç»œä¸­çš„æ•°æ®èµ„æ–™åˆç†æœ‰æ•ˆã€å®‰å…¨åœ°å­˜æ”¾å’Œç®¡ç†èµ·æ¥ã€‚ å¯¹äºä¼ä¸šé›†ä¸­æ•°æ®ä¸­å¿ƒè§£å†³æ–¹æ¡ˆè€Œè¨€ï¼Œä¸»è¦çš„å»ºè®¾ç›®æ ‡æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š

- å®ç°ç½‘ç»œåŠå…¬ç¯å¢ƒä¸‹çš„é›†ä¸­èµ„æ–™å…±äº«ã€äº¤äº’ï¼Œæ”¹å˜ä»¥å¾€å•ä¸€çš„ä¸ªäººå…±äº«è¡Œä¸ºã€‚
- å®Œæˆå…¬å¸ã€ä¸ªäººã€å®¢æˆ·èµ„æ–™çš„å®‰å…¨å­˜æ”¾ï¼Œå¢å¼ºæ•°æ®çš„å¯é æ€§ï¼Œå®ç°é•¿æœŸä¿å­˜ã€‚
- å¸¦åŠ¨å…¬å¸å†…éƒ¨çš„æ•°æ®æµç¨‹ï¼Œå®ç°æ•°æ®çš„çŸ¥è¯†å…±äº«å’Œè®¿é—®æƒé™æ§åˆ¶ã€‚

## NAS æ˜¯ä»€ä¹ˆ

NASï¼ˆNetwork Attached Storageï¼‰ï¼Œç›´è¯‘æ˜¯ç½‘ç»œé™„åŠ å­˜å‚¨ï¼Œç®€å•æ¥è¯´æ˜¯è¿æ¥åœ¨ç½‘ç»œä¸Šï¼Œå…·æœ‰èµ„æ–™å­˜å‚¨åŠŸèƒ½çš„è®¾å¤‡ï¼Œä¹Ÿå«åšç½‘ç»œå­˜å‚¨æœåŠ¡å™¨ã€‚å®é™…ä¸Šï¼ŒNAS çš„åŠŸèƒ½ä¸å•å•å±€é™äºå­˜å‚¨ï¼Œç¾¤æ™– NAS å·²ç»æˆåŠŸæ‰“é€ äº†**ä¸°å¯Œçš„è½¯ä»¶ç”Ÿæ€**ã€‚

ä¸ä»…æ˜¯ä¸ªäººï¼Œå·¥ä½œå®¤ã€ä¸­å°ä¼ä¸šã€500 å¼ºä¼ä¸šéƒ½åœ¨ä½¿ç”¨ NASã€‚éšç€ä¼ä¸šçš„å‘å±•ï¼Œæ•°æ®é‡ä¸æ–­å¢é•¿ï¼Œä¼ ç»Ÿæ–‡ä»¶æœåŠ¡å™¨åŠŸèƒ½æœ‰é™ï¼Œè½¯ä»¶éœ€è¦è®¢é˜…ä»˜è´¹ï¼Œè€Œä½¿ç”¨å…¬æœ‰äº‘ï¼Œè´¹ç”¨éšäººå‘˜é‡ã€æ•°æ®é‡çš„å¢é•¿è€Œå¢åŠ ã€‚ä¼ä¸šå¯ä»¥ä½¿ç”¨ç¾¤æ™–åœ¨ä»¥ä¸‹åœºæ™¯ä¸­ï¼š

1. ä½¿ç”¨ç¾¤æ™– NAS æ­å»º**ä¼ä¸šæ–‡ä»¶æœåŠ¡å™¨**ï¼Œå¯ä»¥é›†ä¸­å­˜å‚¨å„éƒ¨é—¨æ–‡ä»¶ï¼Œæƒé™è®¾ç½®ç®€å•ï¼Œå‘˜å·¥å¯åœ¨ Windowsã€macOS å’Œ Linux å¹³å°ä¹‹é—´å®ç°æ–‡ä»¶æ— ç¼å…±äº«ã€‚
2. é™¤äº†å¯ä»¥ç”¨ä½œæ–‡ä»¶æœåŠ¡å™¨ï¼Œç¾¤æ™– NAS è¿˜ä¸ºä¸šåŠ¡æ•°æ®æä¾›ä¸€ä½“åŒ–å¤‡ä»½å¹³å°ï¼Œæ•´æœºä¿æŠ¤å‘˜å·¥ç”µè„‘ã€ç‰©ç†æœåŠ¡å™¨ã€è™šæ‹Ÿæœºã€å…¬æœ‰äº‘æ•°æ®ï¼Œé€šè¿‡ç›´è§‚çš„å›¾å½¢åŒ–ç•Œé¢ï¼Œåœ¨ä¸€ä¸ªå¹³å°ä¸Šå°±å¯ä»¥ç®¡ç†æ‰€æœ‰å¤‡ä»½ä»»åŠ¡ï¼Œæœ‰æ•ˆä¿æŠ¤ä¼ä¸šå…³é”®ä¸šåŠ¡æ•°æ®ï¼Œé¿å…è¯¯åˆ ã€æ³„éœ²ã€å‹’ç´¢ç—…æ¯’ç­‰æ„å¤–å¯¼è‡´çš„åˆ©ç›ŠæŸå¤±ã€‚

## ä¸»è¦åŠŸèƒ½

### 1. æ–‡ä»¶ç®¡ç†

Synology NAS æ•´åˆæ•°æ®å­˜å‚¨ã€å­˜å–å’Œå…±äº«ç­‰ä¸€ä½“åŒ–æ–‡ä»¶ç®¡ç†åº”ç”¨ï¼Œé€šè¿‡ DSM ç›´è§‚æ˜“ç”¨çš„ç®¡ç†ç•Œé¢ï¼Œæ— è®ºå®¶åº­ç”¨æˆ·ï¼Œæˆ–æ˜¯å·¥ä½œç¹é‡çš„ IT ç®¡ç†äººå‘˜ï¼Œéƒ½èƒ½è½»æ¾å®Œæˆæ‰€æœ‰æ–‡ä»¶åŒæ­¥ã€å®‰å…¨è®¾ç½®ï¼Œå…¨æƒæŒæ§æ•°æ®ã€‚

#### 1.1 å­˜å–ä¸å…±äº«

æ–‡ä»¶å­˜å–å’Œå…±äº«ï¼Œæ˜¯ Synology NAS çš„æ ¸å¿ƒåº”ç”¨ã€‚DSM æ”¯æŒå¤šç§ä¸»æµé€šè®¯åè®®å’Œå¤šè®¾å¤‡å­˜å–åŠŸèƒ½ï¼Œä¸ºæ‚¨æ‰“é€ é¡ºç•…çš„å®æ—¶æ•°æ®åº”ç”¨ä½“éªŒï¼ŒåŒæ—¶ä¸ºæ‚¨çš„æ•°æ®æä¾›é«˜å®‰å…¨å±‚çº§ä¿æŠ¤ã€‚

**æ”¯æŒä¸»æµé€šä¿¡åè®®å’Œæ“ä½œç³»ç»Ÿ:**

æ”¯æŒä¸»æµæµè§ˆå™¨ã€ç§»åŠ¨å¹³å°å’Œæ“ä½œç³»ç»Ÿï¼Œå¯çµæ´»èå…¥å®¶åº­æˆ–ä¼ä¸šåŠå…¬ç¯å¢ƒï¼Œæ•°æ®å­˜å–ç•…é€šæ— é˜»ã€‚

![20241229154732_Wp8tXDs8.webp](https://cdn.dong4j.site/source/image/20241229154732_Wp8tXDs8.webp)

**æ–‡ä»¶å’Œæ–‡ä»¶å¤¹å…±äº«:**

é€šè¿‡åˆ†äº«é“¾æ¥æˆ–äºŒç»´ç ï¼Œå¯å¿«é€Ÿåˆ†äº«æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ï¼Œå¹¶æä¾›å¤šé‡å®‰å…¨ä¿æŠ¤å’Œå­˜å–æƒé™é€‰é¡¹ï¼Œä¸ºæ‚¨çš„æ•°æ®å®‰å…¨ä¿é©¾æŠ¤èˆªã€‚

![20241229154732_JpGaf9hq.webp](https://cdn.dong4j.site/source/image/20241229154732_JpGaf9hq.webp)

#### 1.2 åŒæ­¥ä¸ç®¡ç†

![20241229154732_rWYt4kYU.webp](https://cdn.dong4j.site/source/image/20241229154732_rWYt4kYU.webp)

![20241229154732_HPuSVats.webp](https://cdn.dong4j.site/source/image/20241229154732_HPuSVats.webp)

### 2. ç”¨æˆ·ç®¡ç†

![20241229154732_Koc3L4MW.webp](https://cdn.dong4j.site/source/image/20241229154732_Koc3L4MW.webp)

![20241229154732_nATaGC12.webp](https://cdn.dong4j.site/source/image/20241229154732_nATaGC12.webp)

### 3. åŠå…¬æ•ˆç‡

#### 3.1 Office

å›¢é˜Ÿæˆå‘˜å¯ä»¥éšæ—¶é€šè¿‡ Web ç•Œé¢åŒæ—¶ç¼–è¾‘åŒä¸€ä»½æ–‡æ¡£ã€ç”µå­è¡¨æ ¼æˆ–å¹»ç¯ç‰‡ï¼Œå¹¶æ”¯æŒ Microsoft Office æ–‡ä»¶å¯¼å…¥ç¼–è¾‘ä¸å¯¼å‡ºåˆ†äº«ï¼Œé€šè¿‡æµç•…ã€å®æ—¶çš„çº¿ä¸Šåä½œï¼Œè§£å†³è¿œç¨‹åä½œçš„æ²Ÿé€šéš¾é¢˜ï¼Œä»è€Œå¤§å¹…æå‡åŠå…¬æ•ˆç‡ã€‚

##### 3.1.1 æ–‡æ¡£

![20241229154732_Y2PzUj4U.webp](https://cdn.dong4j.site/source/image/20241229154732_Y2PzUj4U.webp)

##### 3.1.2 ç”µå­è¡¨æ ¼

![20241229154732_fft2Uxbs.webp](https://cdn.dong4j.site/source/image/20241229154732_fft2Uxbs.webp)

##### 3.1.3 å¹»ç¯ç‰‡

![20241229154732_gOu0x64d.webp](https://cdn.dong4j.site/source/image/20241229154732_gOu0x64d.webp)

#### 3.2 ååŒåŠå…¬

![20241229154732_3QIzKP9l.webp](https://cdn.dong4j.site/source/image/20241229154732_3QIzKP9l.webp)

### 4. æ•°æ®å¤‡ä»½

![20241229154732_5s7mHwWs.webp](https://cdn.dong4j.site/source/image/20241229154732_5s7mHwWs.webp)

![20241229154732_p9936ya2.webp](https://cdn.dong4j.site/source/image/20241229154732_p9936ya2.webp)

### 5. å®‰å…¨æ€§

![20241229154732_7TOwpgwk.webp](https://cdn.dong4j.site/source/image/20241229154732_7TOwpgwk.webp)

![20241229154732_ntLmuG7o.webp](https://cdn.dong4j.site/source/image/20241229154732_ntLmuG7o.webp)

### 6. ç³»ç»Ÿç®¡ç†

![20241229154732_trkcLymW.webp](https://cdn.dong4j.site/source/image/20241229154732_trkcLymW.webp)

![20241229154732_DMBlNWnx.webp](https://cdn.dong4j.site/source/image/20241229154732_DMBlNWnx.webp)

## ä½¿ç”¨åœºæ™¯

### 1. éšæ—¶éšåœ°å­˜å–æ•°æ®

![20241229154732_DvOAAfzU.webp](https://cdn.dong4j.site/source/image/20241229154732_DvOAAfzU.webp)

![20241229154732_ORH181Ul.webp](https://cdn.dong4j.site/source/image/20241229154732_ORH181Ul.webp)

![20241229154732_5k4uQ7BU.webp](https://cdn.dong4j.site/source/image/20241229154732_5k4uQ7BU.webp)

### 2. æ–‡ä»¶æœåŠ¡å™¨

#### 2.1 è·¨å¹³å°å³æ—¶å…±äº«

æ”¯æŒ SMB / NFS / FTP ç­‰å¤šç§ä¼ è¾“åè®®ï¼Œå±€åŸŸç½‘å†…å…±äº«ã€‚æ— éœ€è‡ªå»º FTPï¼Œå³å¯è·¨å¹³å°ã€å¤šç»ˆç«¯éšæ—¶å­˜å–ï¼›æ€»éƒ¨å’Œåˆ†æ”¯æœºæ„é—´ä¹Ÿèƒ½ä¾¿æ·ä¸‹å‘å’Œä¸Šæ”¶æ–‡ä»¶ã€‚

![20241229154732_FfAg6Fj8.webp](https://cdn.dong4j.site/source/image/20241229154732_FfAg6Fj8.webp)

#### 2.2 å›¾å½¢åŒ–çš„æƒé™å®‰å…¨ç®¡ç†

å›¾å½¢åŒ–ç•Œé¢ï¼Œæ“ä½œç›´è§‚ç®€ä¾¿ï¼Œæ— éœ€è¾“å…¥æŒ‡ä»¤æˆ–å¯¼å…¥è¡¨æ ¼ã€‚æ”¯æŒå§”æ´¾ä¸“äººç®¡ç†æƒé™ï¼Œå¹¶ä¸”å¯è®¾ç½®å¯†ç ã€æœ‰æ•ˆæœŸå®ç°å®‰å…¨åˆ†äº«ï¼Œé€šè¿‡å¯¼å‡ºæƒé™æŠ¥å‘Šå®ç°æƒé™å®¡æ ¸ã€‚

![20241229154732_GtPer2AH.webp](https://cdn.dong4j.site/source/image/20241229154732_GtPer2AH.webp)

#### 2.3 ä¸å—åœ°åŸŸé™åˆ¶çš„åœ¨çº¿åŠå…¬

é€šè¿‡ç½‘é¡µæˆ–ç§»åŠ¨ç«¯ Appï¼Œä¸å—åœ°åŸŸé™åˆ¶ï¼Œå³å¯å®ç°ç§»åŠ¨åŠå…¬ï¼Œè¿˜å¯è®¾ç½®æ–‡ä»¶ç¦»çº¿è®¿é—®ã€‚å¹¶ä¸”æ”¯æŒåœ¨çº¿ Officeï¼Œå¤šäººåä½œæå‡å›¢é˜ŸåŠå…¬æ•ˆç‡ã€‚

**ç¾¤æ™–è·¨ç”µè„‘ã€è·¨åœ°åŸŸåŒæ­¥åŠå…±äº«æ–¹æ¡ˆæ‰“é€šæ•°æ®å­¤å²›,å®ç°è‡ªåŠ¨åŒæ­¥å’Œå³æ—¶å…±äº«,å»ºç«‹ä¼ä¸šæ–‡ä»¶ä¸­å¿ƒã€‚åŒæ—¶æ”¯æŒå¤šç‰ˆæœ¬å¤‡ä»½,é¿å…å› è¯¯åˆ ã€å‹’ç´¢ç—…æ¯’ç­‰å¯¼è‡´æ–‡ä»¶ä¸¢å¤±ã€‚**

![20241229154732_7wYwXGdO.webp](https://cdn.dong4j.site/source/image/20241229154732_7wYwXGdO.webp)

![20241229154732_VOIsJvSX.webp](https://cdn.dong4j.site/source/image/20241229154732_VOIsJvSX.webp)

![20241229154732_MzQHfGV2.webp](https://cdn.dong4j.site/source/image/20241229154732_MzQHfGV2.webp)

![20241229154732_KFwZCGSl.webp](https://cdn.dong4j.site/source/image/20241229154732_KFwZCGSl.webp)

#### 2.4 æ–‡ä»¶ç®¡ç†ä¸åŒæ­¥

![20241229154732_0l8VaHxH.webp](https://cdn.dong4j.site/source/image/20241229154732_0l8VaHxH.webp)

![20241229154732_OpERLBVc.webp](https://cdn.dong4j.site/source/image/20241229154732_OpERLBVc.webp)

![20241229154732_8QQWajmE.webp](https://cdn.dong4j.site/source/image/20241229154732_8QQWajmE.webp)

![20241229154732_rvZ94CMa.webp](https://cdn.dong4j.site/source/image/20241229154732_rvZ94CMa.webp)

![20241229154732_Hd4dsvyx.webp](https://cdn.dong4j.site/source/image/20241229154732_Hd4dsvyx.webp)

![20241229154732_LiFfAnvn.webp](https://cdn.dong4j.site/source/image/20241229154732_LiFfAnvn.webp)

#### 2.5 PB çº§å­˜å‚¨å®¹é‡çš„åœ¨çº¿æ‰©å®¹

æ·»åŠ æ‰©å±•æŸœè¿›è¡Œåœ¨çº¿æ‰©å®¹ï¼Œå¯æ”¯æŒå¤šè¾¾ 180 ä¸ªç¡¬ç›˜ï¼Œæä¾› PB çº§å‡€å­˜å‚¨å®¹é‡ï¼Œè½»æ¾æ»¡è¶³å½±è§†åæœŸåˆ¶ä½œã€å¤§è§„æ¨¡ç›‘æ§éƒ¨ç½²ç­‰å¤§å®¹é‡å­˜å‚¨éœ€æ±‚ã€‚

#### 2.6 å®¹ç¾å¤‡ä»½

ä¸ºæ–‡ä»¶å¤¹å’Œ iSCSI LUN å»ºç«‹å¿«ç…§ä¿æŠ¤ï¼Œå¯å¿«é€Ÿæ¢å¤è¢«ç—…æ¯’é”å®šçš„æ–‡ä»¶ï¼Œé˜²æ­¢ä¼ä¸šæ•°æ®ä¸¢å¤±ã€‚åŒæ—¶å¯ä¸ºæœåŠ¡å™¨ã€è™šæ‹Ÿæœºå’Œ PC å®ç°å…è®¸å¯è¯çš„æ•´æœºå¤‡ä»½æ–¹æ¡ˆã€‚

![20241229154732_nUf2ln5g.webp](https://cdn.dong4j.site/source/image/20241229154732_nUf2ln5g.webp)

### 3. æ–‡ä»¶åŒæ­¥ä¸å…±äº«

![20241229154732_yKeXtvgW.webp](https://cdn.dong4j.site/source/image/20241229154732_yKeXtvgW.webp)

### 4. ç§æœ‰äº‘ä¼ä¸šç½‘ç›˜

![20241229154732_kSNQKTiq.webp](https://cdn.dong4j.site/source/image/20241229154732_kSNQKTiq.webp)

![20241229154732_XrVyLXft.webp](https://cdn.dong4j.site/source/image/20241229154732_XrVyLXft.webp)

## ç³»ç»Ÿå±•ç¤º

![20241229154732_XZqADQCq.webp](https://cdn.dong4j.site/source/image/20241229154732_XZqADQCq.webp)

![20241229154732_rPqOZbFH.webp](https://cdn.dong4j.site/source/image/20241229154732_rPqOZbFH.webp)

![20241229154732_QwWnhMmq.webp](https://cdn.dong4j.site/source/image/20241229154732_QwWnhMmq.webp)

![20241229154732_cooNFI9g.webp](https://cdn.dong4j.site/source/image/20241229154732_cooNFI9g.webp)

![20241229154732_CIu37ozq.webp](https://cdn.dong4j.site/source/image/20241229154732_CIu37ozq.webp)

![20241229154732_ezwtG796.webp](https://cdn.dong4j.site/source/image/20241229154732_ezwtG796.webp)

![20241229154732_hGMqv6Er.webp](https://cdn.dong4j.site/source/image/20241229154732_hGMqv6Er.webp)

![20241229154732_JaIdkVM5.webp](https://cdn.dong4j.site/source/image/20241229154732_JaIdkVM5.webp)

## [æŒæ¡HexoåŠ å¯†ï¼Œæ„å»ºæ›´å®‰å…¨çš„ä¸ªäººåšå®¢](https://blog.dong4j.site/posts/4633c2df.md)

![/images/cover/20241229132734_VH9upmpx.webp](https://cdn.dong4j.site/source/image/20241229132734_VH9upmpx.webp)

## ç®€ä»‹

åŠ å¯†æµ‹è¯•

## [KVM è™šæ‹Ÿæœºç£ç›˜å®¹é‡æ‰©å±•æŒ‡å—ï¼šä»æ–‡ä»¶åˆ°æ–‡ä»¶ç³»ç»Ÿçš„å…¨é¢è§£æ](https://blog.dong4j.site/posts/107e2c9.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## å¢åŠ  KVM è™šæ‹Ÿæœºç£ç›˜å®¹é‡

åœ¨ KVM ä¸­æ‰©å±•è™šæ‹Ÿæœºç£ç›˜å®¹é‡åˆ†ä¸ºä¸¤æ­¥ï¼š**æ‰©å±•è™šæ‹Ÿç£ç›˜æ–‡ä»¶** å’Œ **æ‰©å±•è™šæ‹Ÿæœºå†…çš„åˆ†åŒºå’Œæ–‡ä»¶ç³»ç»Ÿ**ã€‚

---

### ç¬¬ä¸€æ­¥ï¼šæ‰©å±•è™šæ‹Ÿç£ç›˜æ–‡ä»¶

#### 1. ç¡®è®¤è™šæ‹Ÿç£ç›˜æ–‡ä»¶è·¯å¾„

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥æ‰¾è™šæ‹Ÿæœºç£ç›˜æ–‡ä»¶çš„ä½ç½®ï¼š

```bash
virsh domblklist <è™šæ‹Ÿæœºåç§°>
```

ç¤ºä¾‹è¾“å‡ºï¼š

```
Target     Source
------------------------------------------------
vda        /var/lib/libvirt/images/vm-disk.qcow2
```

è®°ä¸‹ç£ç›˜æ–‡ä»¶è·¯å¾„ï¼ˆä¾‹å¦‚ /var/lib/libvirt/images/vm-disk.qcow2ï¼‰ã€‚

#### 2. æ‰©å±•ç£ç›˜æ–‡ä»¶

å‡è®¾éœ€è¦å°†ç£ç›˜æ‰©å±•ä¸º 50 GBï¼Œæ ¹æ®ç£ç›˜æ ¼å¼é€‰æ‹©ä»¥ä¸‹å‘½ä»¤ï¼š

QCOW2 æ ¼å¼ç£ç›˜æ‰©å±•

```bash
qemu-img resize /var/lib/libvirt/images/vm-disk.qcow2 50G
```

RAW æ ¼å¼ç£ç›˜æ‰©å±•

```bash
qemu-img resize /var/lib/libvirt/images/vm-disk.raw 50G
```

éªŒè¯ç£ç›˜æ‰©å±•ç»“æœ

```bash
qemu-img info /var/lib/libvirt/images/vm-disk.qcow2
```

### ç¬¬äºŒæ­¥ï¼šæ‰©å±•è™šæ‹Ÿæœºå†…çš„åˆ†åŒºå’Œæ–‡ä»¶ç³»ç»Ÿ

#### 1. å¯åŠ¨è™šæ‹Ÿæœºå¹¶ç™»å½•

å¯åŠ¨è™šæ‹Ÿæœºï¼š

```bash
virsh start <è™šæ‹Ÿæœºåç§°>
```

é€šè¿‡æ§åˆ¶å°æˆ– SSH ç™»å½•è™šæ‹Ÿæœºï¼š

```bash
virsh console <è™šæ‹Ÿæœºåç§°>
```

#### 2. æ£€æŸ¥æ–°å¢ç£ç›˜ç©ºé—´

ç™»å½•è™šæ‹Ÿæœºåï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ç£ç›˜å¤§å°æ˜¯å¦æ›´æ–°ï¼š

```bash
lsblk
```

ç¤ºä¾‹è¾“å‡ºï¼š

```bash
NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
vda    254:0    0   50G  0 disk
â””â”€vda1 254:1    0   20G  0 part /
```

- vda æ˜¯æ•´ä¸ªç£ç›˜ï¼Œvda1 æ˜¯å½“å‰åˆ†åŒºã€‚

#### 3. è°ƒæ•´åˆ†åŒº

æ¯”å¦‚æˆ‘ç°åœ¨çš„åˆ†åŒº:

```bash
âœ  ~ fdisk -l
Disk /dev/vda: 100 GiB, 107374182400 bytes, 209715200 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x2d23b3e0

Device     Boot    Start      End  Sectors  Size Id Type
/dev/vda1           2048 39942143 39940096   19G 83 Linux
/dev/vda2       39944190 41940991  1996802  975M  5 Extended
/dev/vda5       39944192 41940991  1996800  975M 82 Linux swap / Solaris
```


ä½¿ç”¨ fdisk æ‰©å±•åˆ†åŒº

1. å¯åŠ¨ fdiskï¼š

    ```bash
    fdisk /dev/vda
    ```

2. åˆ é™¤åŸåˆ†åŒºï¼ˆä¸ä¼šä¸¢å¤±æ•°æ®ï¼‰ï¼š
   - è¾“å…¥ d åˆ é™¤åˆ†åŒºï¼Œä¾æ¬¡åˆ é™¤ /dev/vda2 å’Œ /dev/vda1ã€‚
3. é‡æ–°åˆ›å»ºæ–°åˆ†åŒºï¼š
   - è¾“å…¥ nï¼Œé€‰æ‹©åˆ†åŒºç±»å‹ï¼ˆé»˜è®¤ primaryï¼‰ã€‚
   - åˆ†åŒºå·ï¼ˆå¦‚ 1ï¼‰ã€‚
   - èµ·å§‹æ‰‡åŒºå’Œç»ˆæ­¢æ‰‡åŒºï¼ˆé»˜è®¤ä½¿ç”¨æ•´ä¸ªç£ç›˜ç©ºé—´ï¼‰ã€‚
4. ä¿å­˜åˆ†åŒºè¡¨å¹¶é€€å‡ºï¼š
   - è¾“å…¥ wã€‚
5. é‡æ–°åŠ è½½åˆ†åŒºè¡¨ï¼š

```bash
partprobe /dev/vda
```

#### 4. æ‰©å±•æ–‡ä»¶ç³»ç»Ÿ

æ ¹æ®åˆ†åŒºçš„æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤æ‰©å±•æ–‡ä»¶ç³»ç»Ÿï¼š

EXT4 æ–‡ä»¶ç³»ç»Ÿ

```bash
resize2fs /dev/vda1
```

è¾“å‡º:

```bash
resize2fs 1.47.0 (5-Feb-2023)
Filesystem at /dev/vda1 is mounted on /; on-line resizing required
old_desc_blocks = 3, new_desc_blocks = 13
The filesystem on /dev/vda1 is now 26214144 (4k) blocks long.
```

#### 5. éªŒè¯æ‰©å±•ç»“æœ

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥æ‰©å±•åçš„æ–‡ä»¶ç³»ç»Ÿå¤§å°ï¼š

```bash
df -h
```

è¾“å‡ºï¼š

```bash
æ–‡ä»¶ç³»ç»Ÿ        å¤§å°  å·²ç”¨  å¯ç”¨ å·²ç”¨% æŒ‚è½½ç‚¹
udev            1.9G     0  1.9G    0% /dev
tmpfs           392M  1.8M  390M    1% /run
/dev/vda1        99G   16G   79G   17% /
tmpfs           2.0G     0  2.0G    0% /dev/shm
tmpfs           5.0M     0  5.0M    0% /run/lock
overlay          99G   16G   79G   17% /var/lib/docker/overlay2...
...
tmpfs           392M     0  392M    0% /run/user/0
```

### é—®é¢˜

å› ä¸ºåŸæ¥çš„ SWAP åˆ†åŒºè¢«åˆ é™¤äº†, éœ€è¦è°ƒæ•´ fstab æ–‡ä»¶ã€‚

```bash
# <file system> <mount point>   <type>  <options>       <dump>  <pass>
# / was on /dev/vda1 during installation
UUID=1a373f29-fa77-43dd-8d01-e8d848b35b11 /               ext4    errors=remount-ro 0       1
# swap was on /dev/vda5 during installation
#UUID=efbc7849-ed9c-44ef-b34a-c5b8d7e8bab0 none            swap    sw              0       0
/dev/sr0        /media/cdrom0   udf,iso9660 user,noauto     0       0
```

å°† `swap` çš„æŒ‚åœ¨é…ç½®æ³¨é‡Šæ‰, å› ä¸ºæˆ‘ä¹Ÿä¸æ‰“ç®—ä½¿ç”¨ swap.


## æ³¨æ„äº‹é¡¹

1. å¤‡ä»½æ•°æ®ï¼šæ‰©å±•ç£ç›˜å‰ï¼Œè¯·ç¡®ä¿è™šæ‹Ÿæœºæ•°æ®å·²å¤‡ä»½ã€‚
2. LVM æƒ…å†µï¼š
    å¦‚æœè™šæ‹Ÿæœºä½¿ç”¨ LVMï¼Œéœ€é¢å¤–æ‰©å±•é€»è¾‘å·å’Œç‰©ç†å·ï¼š - æ‰©å±•ç‰©ç†å·ï¼š

    ```bash
    pvresize /dev/vda1
    ```

    - æ‰©å±•é€»è¾‘å·ï¼š

    ```bash
    lvextend -l +100%FREE /dev/mapper/volume-group-logical-volume
    ```

    - æ‰©å±•æ–‡ä»¶ç³»ç»Ÿï¼š

    ```bash
    resize2fs /dev/mapper/volume-group-logical-volume
    ```

3. ç¡®è®¤æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼šä¸åŒæ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ EXT4ã€XFSï¼‰ä½¿ç”¨ä¸åŒçš„æ‰©å±•å‘½ä»¤ã€‚

## KVM å¸¸ç”¨å‘½ä»¤



## æ€»ç»“

æ‰©å±• KVM è™šæ‹Ÿæœºç£ç›˜å®¹é‡æ¶‰åŠä¸¤ä¸ªå…³é”®æ­¥éª¤ï¼š

1. ä½¿ç”¨ qemu-img æ‰©å±•ç£ç›˜æ–‡ä»¶ã€‚
2. ç™»å½•è™šæ‹Ÿæœºï¼Œè°ƒæ•´åˆ†åŒºå’Œæ–‡ä»¶ç³»ç»Ÿã€‚

## [VuePress æ­å»ºæŒ‡å—ï¼šä»åŸºç¡€åˆ°éƒ¨ç½²](https://blog.dong4j.site/posts/71182928.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

ä½¿ç”¨ vuepress æ­å»ºè‡ªå·±çš„åšå®¢

<!-- more-->

## Vuepress ä»‹ç»

å®˜ç½‘: [https://vuepress.vuejs.org/](https://vuepress.vuejs.org/)

ç±»ä¼¼ hexo ä¸€ä¸ªæç®€çš„é™æ€ç½‘ç«™ç”Ÿæˆå™¨, ç”¨æ¥å†™æŠ€æœ¯æ–‡æ¡£ä¸èƒ½åœ¨çˆ½. å½“ç„¶æ­å»ºæˆåšå®¢ä¹Ÿä¸æˆé—®é¢˜.

## Vuepress ç‰¹ç‚¹

- å“åº”å¼, ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ä¸»é¢˜ä¸ hexo ç±»ä¼¼
- å†…ç½® markdown (è¿˜å¢åŠ äº†ä¸€äº›æ‰©å±•), å¹¶ä¸”å¯ä»¥åœ¨å…¶ä½¿ç”¨ Vue ç»„ä»¶
- Google Analytics é›†æˆ
- PWA è‡ªåŠ¨ç”Ÿæˆ Service Worker

## å¿«é€Ÿä¸Šæ‰‹

### å®‰è£…

åˆå§‹åŒ–é¡¹ç›®

```bash
yarn init -y
# æˆ–è€… npm init -y
```

å®‰è£… vuepress

```bash
yarn add -D vuepress
# æˆ–è€… npm install -D vuepress
```

å…¨å±€å®‰è£… vuepress

```bash
yarn global add vuepress
# æˆ–è€… npm install -g vuepress
```

æ–°å»ºä¸€ä¸ª docs æ–‡ä»¶å¤¹

```bash
mkdir docs
```

è®¾ç½®ä¸‹ package.json

```bash
{
  "scripts": {
    "docs:dev": "vuepress dev docs",
    "docs:build": "vuepress build docs"
  }
}
```

### å†™ä½œ

```bash
yarn docs:dev # æˆ–è€…: npm run docs:dev
```

ä¹Ÿå°±æ˜¯è¿è¡Œå¼€å‘ç¯å¢ƒ, ç›´æ¥å» docs æ–‡ä»¶ä¸‹ä¹¦å†™æ–‡ç« å°±å¯ä»¥, æ‰“å¼€ `http://localhost:8080/` å¯ä»¥é¢„è§ˆ

### æ„å»º

build ç”Ÿæˆé™æ€çš„ HTML æ–‡ä»¶, é»˜è®¤ä¼šåœ¨ `.vuepress/dist` æ–‡ä»¶å¤¹ä¸‹

```bash
yarn docs:build # æˆ–è€…: npm run docs:build
```

## åŸºæœ¬é…ç½®

åœ¨ `.vuepress` ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª `config.js`, ä»–å¯¼å‡ºä¸€ä¸ªå¯¹è±¡

ä¸€äº›é…ç½®å¯ä»¥å‚è€ƒ [å®˜æ–¹æ–‡æ¡£](https://vuepress.vuejs.org/config/#base) , è¿™é‡Œæˆ‘é…ç½®å¸¸ç”¨åŠå¿…é¡»é…ç½®çš„

### ç½‘ç«™ä¿¡æ¯

```bash
module.exports = {
  title: 'æ¸¸é­‚çš„æ–‡æ¡£',
  description: 'Document library',
  head: [
    ['link', { rel: 'icon', href: `/favicon.ico` }],
  ],
}
```

### å¯¼èˆªæ é…ç½®

```javascript
module.exports = {
  themeConfig: {
    nav: [
      { text: "ä¸»é¡µ", link: "/" },
      { text: "å‰ç«¯è§„èŒƒ", link: "/frontEnd/" },
      { text: "å¼€å‘ç¯å¢ƒ", link: "/development/" },
      { text: "å­¦ä¹ æ–‡æ¡£", link: "/notes/" },
      { text: "æ¸¸é­‚åšå®¢", link: "https://www.iyouhun.com" },
      // ä¸‹æ‹‰åˆ—è¡¨çš„é…ç½®
      {
        text: "Languages",
        items: [
          { text: "Chinese", link: "/language/chinese" },
          { text: "English", link: "/language/English" },
        ],
      },
    ],
  },
};
```

### ä¾§è¾¹æ é…ç½®

å¯ä»¥çœç•¥ `.md` æ‰©å±•å, åŒæ—¶ä»¥ `/` ç»“å°¾çš„è·¯å¾„å°†ä¼šè¢«è§†ä¸º `*/README.md`

```javascript
module.exports = {
  themeConfig: {
    sidebar: {
      "/frontEnd/": genSidebarConfig("å‰ç«¯å¼€å‘è§„èŒƒ"),
    },
  },
};
```

ä¸Šé¢å°è£…çš„ `genSidebarConfig` å‡½æ•°

```javascript
function genSidebarConfig(title) {
  return [
    {
      title,
      collapsable: false,
      children: [
        "",
        "html-standard",
        "css-standard",
        "js-standard",
        "git-standard",
      ],
    },
  ];
}
```

æ”¯æŒä¾§è¾¹æ åˆ†ç»„ (å¯ä»¥ç”¨æ¥åšåšå®¢æ–‡ç« åˆ†ç±») collapsable æ˜¯å½“å‰åˆ†ç»„æ˜¯å¦å±•å¼€

```javascript
module.exports = {
  themeConfig: {
    sidebar: {
      "/note": [
        {
          title: "å‰ç«¯",
          collapsable: true,
          children: [
            "/notes/frontEnd/VueJSç»„ä»¶ç¼–ç è§„èŒƒ",
            "/notes/frontEnd/vue-cliè„šæ‰‹æ¶å¿«é€Ÿæ­å»ºé¡¹ç›®",
            "/notes/frontEnd/æ·±å…¥ç†è§£vueä¸­çš„slotä¸slot-scope",
            "/notes/frontEnd/webpackå…¥é—¨",
            "/notes/frontEnd/PWAä»‹ç»åŠå¿«é€Ÿä¸Šæ‰‹æ­å»ºä¸€ä¸ªPWAåº”ç”¨",
          ],
        },
        {
          title: "åç«¯",
          collapsable: true,
          children: [
            "notes/backEnd/nginxå…¥é—¨",
            "notes/backEnd/CentOSå¦‚ä½•æŒ‚è½½ç£ç›˜",
          ],
        },
      ],
    },
  },
};
```

## é»˜è®¤ä¸»é¢˜ä¿®æ”¹

### ä¸»é¢˜è‰²ä¿®æ”¹

åœ¨ `.vuepress` ç›®å½•ä¸‹çš„åˆ›å»ºä¸€ä¸ª `override.styl` æ–‡ä»¶

```javascript
$accentColor = #3eaf7c // ä¸»é¢˜è‰²
$textColor = #2c3e50 // æ–‡å­—é¢œè‰²
$borderColor = #eaecef // è¾¹æ¡†é¢œè‰²
$codeBgColor = #282c34 // ä»£ç èƒŒæ™¯é¢œè‰²
```

### è‡ªå®šä¹‰é¡µé¢ç±»

æœ‰æ—¶éœ€è¦åœ¨ä¸åŒçš„é¡µé¢åº”ç”¨ä¸åŒçš„ css, å¯ä»¥å…ˆåœ¨è¯¥é¡µé¢ä¸­å£°æ˜

```javascript
---
pageClass: custom-page-class
---
```

ç„¶ååœ¨ `override.styl` ä¸­ä¹¦å†™

```javascript
.theme-container.custom-page-class {
  /* ç‰¹å®šé¡µé¢çš„ CSS */
}
```

## PWA è®¾ç½®

è®¾ç½® serviceWorker ä¸º true, ç„¶åæä¾› Manifest å’Œ icons,
å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„ [ã€ŠPWA ä»‹ç»åŠå¿«é€Ÿä¸Šæ‰‹æ­å»ºä¸€ä¸ª PWA åº”ç”¨ã€‹](https://www.shen.ee/article/27276.html)

```javascript
module.exports = {
  head: [
    ["link", { rel: "icon", href: `/favicon.ico` }],
    // å¢åŠ  manifest.json
    ["link", { rel: "manifest", href: "/manifest.json" }],
  ],
  serviceWorker: true,
};
```

## éƒ¨ç½²ä¸Šçº¿

### è®¾ç½®åŸºç¡€è·¯å¾„

åœ¨ `config.js` è®¾ç½® base
ä¾‹å¦‚: ä½ æƒ³è¦éƒ¨ç½²åœ¨ [https://foo.github.io](https://foo.github.io) é‚£ä¹ˆè®¾ç½® base ä¸º `/`
,base é»˜è®¤å°±ä¸º `/`, æ‰€ä»¥å¯ä»¥ä¸ç”¨è®¾ç½®
æƒ³è¦éƒ¨ç½²åœ¨ [https://foo.github.io/bar/,](https://foo.github.io/bar/,) é‚£ä¹ˆ `base`
åº”è¯¥è¢«è®¾ç½®æˆ `"/bar/"`

```javascript
module.exports = {
  base: "/documents/",
};
```

`base` å°†ä¼šè‡ªåŠ¨åœ°ä½œä¸ºå‰ç¼€æ’å…¥åˆ°æ‰€æœ‰ä»¥ `/` å¼€å§‹çš„å…¶ä»–é€‰é¡¹çš„é“¾æ¥ä¸­, æ‰€ä»¥ä½ åªéœ€è¦æŒ‡å®šä¸€æ¬¡.

### æ„å»ºä¸è‡ªåŠ¨éƒ¨ç½²

ç”¨ [gitHub](https://github.com) çš„ pages
æˆ–è€… [coding](https://coding.net/r/O5YOFA) çš„ pages éƒ½å¯ä»¥, ä¹Ÿå¯ä»¥æ­å»ºåœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Š.
å°† `dist` æ–‡ä»¶å¤¹ä¸­çš„å†…å®¹æäº¤åˆ° git ä¸Šæˆ–è€…ä¸Šä¼ åˆ°æœåŠ¡å™¨å°±å¥½

```javascript
yarn docs:build # æˆ–è€…: npm run docs:build
```

> å¦å¤–å¯ä»¥å¼„ä¸€ä¸ªè„šæœ¬, è®¾ç½®æŒç»­é›†æˆ, åœ¨æ¯æ¬¡ push ä»£ç æ—¶è‡ªåŠ¨è¿è¡Œè„šæœ¬

deploy.sh

```bash
#!/usr/bin/env sh

# ç¡®ä¿è„šæœ¬æŠ›å‡ºé‡åˆ°çš„é”™è¯¯
set -e

# ç”Ÿæˆé™æ€æ–‡ä»¶
npm run docs:build

# è¿›å…¥ç”Ÿæˆçš„æ–‡ä»¶å¤¹
cd docs/.vuepress/dist

# å¦‚æœæ˜¯å‘å¸ƒåˆ°è‡ªå®šä¹‰åŸŸå
# echo 'www.example.com' > CNAME

git init
git add -A
git commit -m 'deploy'

# å¦‚æœå‘å¸ƒåˆ° https://<USERNAME>.github.io
# git push -f git@github.com:<USERNAME>/<USERNAME>.github.io.git master

# å¦‚æœå‘å¸ƒåˆ° https://<USERNAME>.github.io/<REPO>
git push -f git@github.com:<USERNAME>/<REPO>.git master:gh-pages

cd -
```

## æ³¨æ„äº‹é¡¹ (å‘)

- æŠŠä½ æƒ³å¼•ç”¨çš„èµ„æºéƒ½æ”¾åœ¨ `.vuepress` ç›®å½•ä¸‹çš„ `public` æ–‡ä»¶å¤¹
- ç»™ git ä»“åº“ç»‘å®šäº†ç‹¬ç«‹åŸŸåå, è®°å¾—ä¿®æ”¹ `base` è·¯å¾„
- è®¾ç½®ä¾§è¾¹æ åˆ†ç»„åé»˜è®¤ä¼šè‡ªåŠ¨ç”Ÿæˆ ä¸Š / ä¸‹ä¸€ç¯‡é“¾æ¥
- è®¾ç½®äº†è‡ªåŠ¨ç”Ÿæˆä¾§è¾¹æ ä¼šæŠŠä¾§è¾¹æ åˆ†ç»„è¦†ç›–æ‰
- è®¾ç½® PWA è®°å¾—å¼€å¯ SSL

## [vuepress-theme-reco](https://vuepress-theme-reco.recoluan.com/)

è¯¥ä¸»é¢˜å‡ ä¹ç»§æ‰¿ `VuePress` é»˜è®¤ä¸»é¢˜çš„ä¸€åˆ‡åŠŸèƒ½, æ‰€ä»¥æœ¬æ–‡æ¡£åªè´Ÿè´£ä»‹ç»è¯¥ä¸»é¢˜æ‰©å±•çš„åŠŸèƒ½, å¦‚æœæ‚¨æƒ³è¦äº†è§£é»˜è®¤ä¸»é¢˜çš„ä¸€äº›åŠŸèƒ½,
è¯·ç§»æ­¥ [å®˜æ–¹æ–‡æ¡£](https://v1.vuepress.vuejs.org/zh/theme/default-theme-config.html).

### Branch

| branch   | vuepress | vuepress-theme-reco |
| -------- | :------: | :-----------------: |
| demo/0.x |   0.x    |         0.x         |
| demo/1.x |   1.x    |         1.x         |

### å®‰è£…

```bash
npm install vuepress-theme-reco -dev--save

# or

yarn add vuepress-theme-reco
```

### ä½¿ç”¨

```bash
// ä¿®æ”¹ /docs/.vuepress/config.js

module.exports = {
  theme: 'reco'
}
```

### åˆ†ç±»å’Œæ ‡ç­¾

#### æ·»åŠ åšå®¢é…ç½®

```javascript
// change /docs/.vuepress/config.js

module.exports = {
  theme: "reco",
  themeConfig: {
    // åšå®¢è®¾ç½®
    blogConfig: {
      category: {
        location: 2, // åœ¨å¯¼èˆªæ èœå•ä¸­æ‰€å çš„ä½ç½®, é»˜è®¤ 2
        text: "Category", // é»˜è®¤æ–‡æ¡ˆ â€œåˆ†ç±»â€
      },
      tag: {
        location: 3, // åœ¨å¯¼èˆªæ èœå•ä¸­æ‰€å çš„ä½ç½®, é»˜è®¤ 3
        text: "Tag", // é»˜è®¤æ–‡æ¡ˆ â€œæ ‡ç­¾â€
      },
    },
  },
};
```

#### å†™æ–‡ç« æ—¶æ·»åŠ åˆ†ç±»å’Œæ ‡ç­¾

```javascript
---
title: ã€vueã€‘è·¨åŸŸè§£å†³æ–¹æ¡ˆä¹‹ proxyTable
date: 2019-12-28
categories:
 - frontEnd
tags:
 - vue
---
```

> è¯·æ³¨æ„, `categories` å’Œ `categories` è¦ä»¥æ•°ç»„çš„æ–¹å¼å¡«å†™.

æŸäº›é¡µé¢çš„ä¾§è¾¹æ ä¸º `false` å‘¢ï¼Ÿå› ä¸ºæ‚¨å¯ç”¨äº†åˆ†ç±», è¿™ä¸è‡ªå®šä¹‰ä¾§è¾¹æ åŠŸèƒ½æœ‰ç‚¹å†²çª, æ‰€ä»¥æ‚¨å…¨å±€æ‰“å¼€è‡ªåŠ¨ä¾§è¾¹æ åŠŸèƒ½, ç„¶ååœ¨ä¸éœ€è¦ä¾§æ ‡è®°çš„åœ°æ–¹å…³é—­å®ƒ.

### æ·»åŠ æ—¶é—´è½´

#### æ·»åŠ å¯¼èˆªæŒ‰é’®

```javascript
// change /docs/.vuepress/config.js

module.exports = {
  theme: "reco",
  themeConfig: {
    nav: [{ text: "TimeLine", link: "/timeLine/", icon: "reco-date" }],
  },
};
```

#### æ·»åŠ æ‰€éœ€çš„æ–‡ä»¶

**/docs/timeLine/README.md**

```javascript
---
isTimeLine: true
sidebar: false
isComment: false
---

## Time Line
```

#### å†™æ–‡ç« æ—¶æ·»åŠ æ—¥æœŸ

```javascript
---
title: ã€vueã€‘è·¨åŸŸè§£å†³æ–¹æ¡ˆä¹‹ proxyTable
date: 2019-12-28
tags:
- vue
- webpack
---
```

### è¯„è®º (valine)

å¸¦æœ‰å†…ç½®äº† valine è¯„è®ºåŠŸèƒ½, å¦‚æœè¦æ‰“å¼€æ­¤åŠŸèƒ½, åªéœ€é…ç½®ä½ çš„ `config.js`

```javascript
// æ›´æ”¹ /docs/.vuepress/config.js

module.exports = {
  theme: "reco",
  themeConfig: {
    // valine
    valineConfig: {
      appId: "...", // your appId
      appKey: "...", // your appKey
    },
  },
};
```

**å‚æ•°**

|    å‚æ•°     | åŠŸèƒ½                                                                                                  |   é»˜è®¤å€¼   | æ˜¯å¦å¿…å¡« |
| :---------: | ----------------------------------------------------------------------------------------------------- | :--------: | :------: |
|    appId    | ä» LeanCloud çš„åº”ç”¨ä¸­å¾—åˆ°çš„ appId                                                                     |     æ—      |   yes    |
|   appKey    | ä» LeanCloud çš„åº”ç”¨ä¸­å¾—åˆ°çš„ APP Key                                                                   |     æ—      |   yes    |
| placeholder | è¯„è®ºæ¡†å ä½æç¤ºç¬¦                                                                                      | just go go |    no    |
|   notify    | è¯„è®ºå›å¤é‚®ä»¶æé†’, è¯·å‚è€ƒ [é…ç½®](https://github.com/xCss/Valine/wiki/Valine- è¯„è®ºç³»ç»Ÿä¸­çš„é‚®ä»¶æé†’è®¾ç½®) |   false    |    no    |
|   verify    | éªŒè¯ç æœåŠ¡                                                                                            |   false    |    no    |
|   avatar    | Gravatar å¤´åƒå±•ç¤ºæ–¹å¼, æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ [å¤´åƒé…ç½®](https://valine.js.org/avatar.html)                   |   retro    |    no    |
|   visitor   | æ–‡ç« è®¿é—®é‡ç»Ÿè®¡                                                                                        |    true    |    no    |
|  recordIP   | recordIP                                                                                              |   false    |    no    |

å¦‚æœ valine çš„è·å–è¯„è®ºçš„æ¥å£æŠ¥ `404` é”™è¯¯çš„è¯, ä¸ç”¨æ‹…å¿ƒ, è¿™æ˜¯å› ä¸ºä½ è¿˜æ²¡æœ‰æ·»åŠ è¯„è®º, åªè¦å­˜åœ¨ 1 æ¡è¯„è®º, å°±ä¸ä¼šæŠ¥é”™äº†, è¿™æ˜¯ `leanCloud`
çš„è¯·æ±‚å¤„ç†æ“ä½œè€Œå·².

### åŠ å¯†åŠŸèƒ½

#### é¡¹ç›®åŠ å¯†

å¦‚æœé¡¹ç›®å…·æœ‰ç§å¯†æ€§, ä¸å¸Œæœ›è¢«å…¬å¼€, åªæœ‰å¡«å…¥å¯†é’¥ç™»å½•åï¼ˆå…³é—­æ ‡ç­¾åç™»å½•å¤±æ•ˆï¼‰, æ‰èƒ½è¿›å…¥å†…å®¹é¡µé¢. ä»¥æ•°ç»„çš„æ ¼å¼è®¾ç½® `keys`, å¯ä»¥è®¾ç½®å¤šä¸ªå¯†ç ,
æ•°ç»„çš„å€¼å¿…é¡»æ˜¯å­—ç¬¦ä¸².

```javascript
// æ›´æ”¹ /docs/.vuepress/config.js

module.exports = {
  theme: "reco",
  themeConfig: {
    // å¯†é’¥
    keyPage: {
      keys: ["123456"],
      color: "#42b983", // ç™»å½•é¡µåŠ¨ç”»çƒçš„é¢œè‰²
      lineColor: "#42b983", // ç™»å½•é¡µåŠ¨ç”»çº¿çš„é¢œè‰²
    },
  },
};
```

#### æ–‡ç« åŠ å¯†

å¦‚æœé¡¹ç›®æ˜¯å…¬å¼€çš„, è€ŒæŸäº›æ–‡ç« å¯èƒ½éœ€è¦åŠ å¯†, éœ€è¦åœ¨ `frontmatter` ä»¥æ•°ç»„çš„æ ¼å¼è®¾ç½® `keys`, å¯ä»¥è®¾ç½®å¤šä¸ªå¯†ç , æ•°ç»„çš„å€¼å¿…é¡»æ˜¯å­—ç¬¦ä¸².

```javascript
---
title: vuepress-theme-reco
date: 2019-04-09
author: reco_luan
keys:
 - '123456'
---
```

### Config.js é…ç½®

#### ç§»åŠ¨ç«¯ä¼˜åŒ–

åœ¨ç§»åŠ¨ç«¯, æœç´¢æ¡†åœ¨è·å¾—ç„¦ç‚¹æ—¶ä¼šæ”¾å¤§, å¹¶ä¸”åœ¨å¤±å»ç„¦ç‚¹åå¯ä»¥å·¦å³æ»šåŠ¨, è¿™å¯ä»¥é€šè¿‡è®¾ç½®å…ƒæ¥ä¼˜åŒ–.

```javascript
module.exports = {
  head: [
    [
      "meta",
      {
        name: "viewport",
        content: "width=device-width,initial-scale=1,user-scalable=no",
      },
    ],
  ],
};
```

#### å›¾æ ‡

æ‚¨å¯ä»¥åœ¨å¯¼èˆªèœå•ä¸­æ·»åŠ å›¾æ ‡, å¦‚ä¸‹æ‰€ç¤º:

```javascript
{ text: 'Tags', link: '/tags/', icon: 'reco-tag' }
```

#### å¤‡æ¡ˆä¿¡æ¯å’Œé¡¹ç›®å¼€å§‹æ—¶é—´

```javascript
module.exports = {
  themeConfig: {
    // å¤‡æ¡ˆå·
    record: "äº¬ICPå¤‡17067634å·-1",
    // é¡¹ç›®å¼€å§‹æ—¶é—´, åªå¡«å†™å¹´ä»½
    startYear: "2017",
  },
};
```

#### è®¾ç½®ä½œè€…å§“å

- è®¾ç½®å…¨å±€ä½œè€…å§“å

```javascript
module.exports = {
  themeConfig: {
    // author
    author: "reco_luan",
  },
};
```

- ä¸ºå•ç¯‡æ–‡ç« è®¾ç½®ä½œè€…å§“å

```bash
---
title: ä½ è¿˜æ²¡çœŸçš„åŠªåŠ›è¿‡, å°±è½»æ˜“è¾“ç»™äº†æ‡’æƒ°
date: 2019-04-23
categories: article
author: æ¸¡æ¸¡
---
```

#### åä¸ºæ–‡æ¡ˆ

å¦‚æœä¸å¸Œæœ›æ˜¾ç¤º â€œåä¸ºâ€ æ–‡æ¡ˆ, å¯ä»¥è¿™æ ·å…³é—­.

```javascript
module.exports = {
  themeConfig: {
    huawei: false,
  },
};
```

### é¦–é¡µé…ç½®

ä¸»é¢˜çš„ä¸»é¡µçš„é»˜è®¤é£æ ¼åæ–‡æ¡£, å¹¶ä¸åƒä¸€ä¸ªåšå®¢, æ‰€ä»¥ä» `vuepress-theme-reco@1.0.0-alpha.25` å¼€å§‹, å¢åŠ åšå®¢é£æ ¼é¦–é¡µå¸ƒå±€.

#### é»˜è®¤é¦–é¡µé…ç½®

##### heroImage

- å¦‚æœæ‚¨çš„ heroImage å…·æœ‰æ‚¨çš„ç½‘ç«™æ ‡é¢˜, åˆ™å¯èƒ½éœ€è¦è®¾ç½®å€¼ `isShowTitleInHome` `false` ä»¥ä½¿æ ‡é¢˜ä¸æ˜¾ç¤º.

```bash
# this is your homepage

---
home: true
heroImage: /hero.png
isShowTitleInHome: false
---
```

- å¦‚æœä½ æƒ³æ”¹å˜ heroImage çš„é£æ ¼, ä½ å¯ä»¥è®¾ç½®å€¼ `heroImageStyle` æ¥å®ç°ä½ æƒ³è¦çš„æ•ˆæœ

```bash
# è¿™æ˜¯ä½ çš„ä¸»é¡µ

---
home: true
heroImage: /hero.png
heroImageStyle: {
  maxHeight: '200px',
  display: block,
  margin: '6rem auto 1.5rem',
  borderRadius: '50%',
  boxShadow: '0 5px 18px rgba(0,0,0,0.2)'
}
---
```

##### åšå®¢é£æ ¼é¦–é¡µè®¾ç½®

- æŒ‡å®š `type: 'blog'`

```js
// change /docs/.vuepress/config.js

module.exports = {
  theme: "reco",
  themeConfig: {
    type: "blog",
  },
};
```

- è®¾ç½®é¦–é¡µçš„èƒŒæ™¯å›¾ç‰‡å’Œå¤´åƒ

```bash
# è¿™æ˜¯ä½ çš„ä¸»é¡µ

---
home: true
bgImage: '/bg.png'
faceImage: '/head.png'
---
```

### æ·»åŠ æ‘˜è¦

åœ¨ markdown ä»£ç ä¸­, æ‚¨å°†çœ‹åˆ°æ³¨é‡Š, æ³¨é‡Šå‰é¢çš„ä»£ç å°†æ˜¾ç¤ºåœ¨åˆ—è¡¨é¡µé¢ä¸Šçš„æ–‡ç« æ‘˜è¦ä¸­.

### vuepress-theme-reco-cli

```bash
npm install vuepress-theme-reco-cli

reco-cli init my-blog

cd my-blog
npm install

npm run dev
```

if yarn, you can do this way:

```bash
yarn add vuepress-theme-reco-cli

reco-cli init my-blog

cd my-blog
yarn install

yarn dev
```

## Github Pages

github pages åˆ†ä¸º 2 ä¸­

- ä¸ªäººç«™ç‚¹
- é¡¹ç›®ç«™ç‚¹

2 ç§ç«™ç‚¹çš„ url æœ‰ç‚¹åŒºåˆ«, åœ¨ä½¿ç”¨ vuepress éƒ¨ç½²æ—¶é‡åˆ°ç‚¹å‘, è¿™é‡Œè®°å½•ä¸€ä¸‹

### ä¸ªäººç«™ç‚¹

ä¸ªäººç«™ç‚¹åœ¨åˆ›å»ºæ—¶, å¿…é¡»ä½¿ç”¨ `username.github.io` ä½œä¸ºé¡¹ç›®å, è¿™æ ·ä¸éœ€è¦å…¶ä»–è®¾ç½®, åªéœ€è¦ push html ä»£ç å³å¯ç›´æ¥éƒ¨ç½²

ä½¿ç”¨ vuepress æ—¶, ä¸å†éœ€è¦è®¾ç½® `base`

```javascript
title: "Black House",
  description: 'ä»£ç åƒä¸‡è¡Œ, æ³¨é‡Šç¬¬ä¸€è¡Œ, ç¼–ç ä¸è§„èŒƒ, åŒäº‹ä¸¤è¡Œæ³ª.',
  dest: './docs/dist',
  // å¦‚æœä½¿ç”¨ä¸ªäººç«™ç‚¹, ä¸éœ€è¦é…ç½® base
  // base: '/vue-blog/',
  head: [
    ['link', { rel: 'icon', href: '/favicon.ico' }],
    // åœ¨ç§»åŠ¨ç«¯, æœç´¢æ¡†åœ¨è·å¾—ç„¦ç‚¹æ—¶ä¼šæ”¾å¤§, å¹¶ä¸”åœ¨å¤±å»ç„¦ç‚¹åå¯ä»¥å·¦å³æ»šåŠ¨, è¿™å¯ä»¥é€šè¿‡è®¾ç½®å…ƒæ¥ä¼˜åŒ–
    ['meta', { name: 'viewport', content: 'width=device-width,initial-scale=1,user-scalable=no' }]
  ],
```

### é¡¹ç›®ç«™ç‚¹

é¡¹ç›®ç«™ç‚¹ push éœ€è¦é…ç½® github pages, url ä¸º `https://username.github.io/projectname/`

è¿™æ—¶å¿…é¡»é…ç½® `base`, ä¸ç„¶å°†å¯¼è‡´é¡µé¢æ ·å¼é”™è¯¯

## [å¼€æºé¡¹ç›®æ±‡æ€»ï¼šSpring Cloudç”Ÿæ€åœˆ](https://blog.dong4j.site/posts/44d3ec9b.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## [zuihou-admin-cloud](https://github.com/zuihou/zuihou-admin-cloud)

åŸºäº Â `SpringCloud(Hoxton.SR1)`Â +Â `SpringBoot(2.2.2.RELEASE)`Â  çš„ SaaS å‹å¾®æœåŠ¡è„šæ‰‹æ¶ï¼Œå…·å¤‡ç”¨æˆ·ç®¡ç†ã€èµ„æºæƒé™ç®¡ç†ã€ç½‘å…³ç»Ÿä¸€é‰´æƒã€Xss é˜²è·¨ç«™æ”»å‡»ã€è‡ªåŠ¨ä»£ç ç”Ÿæˆã€å¤šå­˜å‚¨ç³»ç»Ÿã€åˆ†å¸ƒå¼äº‹åŠ¡ã€åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç­‰å¤šä¸ªæ¨¡å—ï¼Œæ”¯æŒå¤šä¸šåŠ¡ç³»ç»Ÿå¹¶è¡Œå¼€å‘ï¼Œ æ”¯æŒå¤šæœåŠ¡å¹¶è¡Œå¼€å‘ï¼Œå¯ä»¥ä½œä¸ºåç«¯æœåŠ¡çš„å¼€å‘è„šæ‰‹æ¶ã€‚ä»£ç ç®€æ´ï¼Œæ¶æ„æ¸…æ™°ï¼Œéå¸¸é€‚åˆå­¦ä¹ ä½¿ç”¨ã€‚æ ¸å¿ƒæŠ€æœ¯é‡‡ç”¨ Nacosã€Feginã€Ribbonã€Zuulã€Hystrixã€JWT Tokenã€Mybatisã€SpringBootã€Seataã€Nacosã€Sentinelã€ RabbitMQã€FastDFS ç­‰ä¸»è¦æ¡†æ¶å’Œä¸­é—´ä»¶ã€‚

å¸Œæœ›èƒ½åŠªåŠ›æ‰“é€ ä¸€å¥—ä» Â `SaaSåŸºç¡€æ¡†æ¶`Â -Â `åˆ†å¸ƒå¼å¾®æœåŠ¡æ¶æ„`Â -Â `æŒç»­é›†æˆ`Â -Â `ç³»ç»Ÿç›‘æµ‹`Â  çš„è§£å†³æ–¹æ¡ˆã€‚`æœ¬é¡¹ç›®æ—¨åœ¨å®ç°åŸºç¡€èƒ½åŠ›ï¼Œä¸æ¶‰åŠå…·ä½“ä¸šåŠ¡ã€‚`

éƒ¨ç½²æ–¹é¢ï¼Œå¯ä»¥é‡‡ç”¨ä»¥ä¸‹ 4 ç§æ–¹å¼ï¼Œå¹¶ä¼šé™†ç»­å…¬å¸ƒ jenkins é›†åˆä»¥ä¸‹ 3 ç§éƒ¨ç½²æ–¹å¼çš„è„šæœ¬å’Œé…ç½®æ–‡ä»¶ï¼š

- IDEA å¯åŠ¨
- jar éƒ¨ç½²
- docker éƒ¨ç½²
- k8s éƒ¨ç½²

### ç§Ÿæˆ·åå° å’Œ å¼€å‘&è¿è¥åå° 2 è€…ä¹‹é—´çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ

A å…¬å¸ ä½¿ç”¨è¿™å¥— SaaS è„šæ‰‹æ¶äºŒæ¬¡å¼€å‘äº†ä¸€ä¸ª OA æˆ–è€…å•†åŸï¼Œ B å’Œ C å…¬å¸æƒ³ä½¿ç”¨ A å…¬å¸å¼€å‘çš„è¿™å¥—ç³»ç»Ÿï¼Œä½†åœŸè±ªå…¬å¸ B æœ‰é’±æƒ³è¦ä¸ªæ€§åŒ–åŠŸèƒ½ï¼ŒC å…¬å¸æ˜¯ä¸ªç©·é€¼ï¼Œä¸æ„¿æ„å¤šèŠ±é’±  
äºæ˜¯ï¼ŒA å…¬å¸å°±åœ¨ zuihou-admin-uiï¼ˆå¼€å‘&è¿è¥åå°ï¼‰ ä¸Šæ–°å»ºäº† ç§Ÿæˆ· B å’Œç§Ÿæˆ· Cï¼Œ å¹¶å„è‡ªæ–°å»ºäº†è´¦å· b1 å’Œè´¦å· c1ï¼Œ åˆ†åˆ«ç»™ B å…¬å¸å’Œ C å…¬å¸ è¯•ç”¨ï¼Œ  
B å…¬å¸å’Œ C å…¬å¸åˆ†åˆ«æ‹¿ç€è´¦å·ï¼Œ åœ¨ zuihou-ui(ç§Ÿæˆ·åå°) ä¸Šè¯•ç”¨ï¼Œ è¯•ç”¨å¾ˆæ»¡æ„ï¼Œä½†åœŸè±ª B å…¬å¸å…ˆè¦å®šåˆ¶åŠŸèƒ½ï¼Œ å°±è·Ÿ A å…¬å¸ç­¾äº†ä¸€ä¸ª 500W çš„å®šåˆ¶å¤§å•ï¼Œå¹¶è¦æ±‚ç‹¬ç«‹éƒ¨ç½²åœ¨ä»–ä»¬è‡ªå·±çš„æœåŠ¡å™¨  
ç©·é€¼ C å…¬å¸æ²¡é’±ï¼Œ å°±èŠ±äº† 20W ä½¿ç”¨ A å…¬å¸éƒ¨ç½²çš„äº‘ç¯å¢ƒï¼Œ æœåŠ¡å™¨å’Œæ•°æ®ç­‰éƒ½å­˜åœ¨ A å…¬å¸çš„äº‘æœåŠ¡å™¨ä¸Šã€‚

### zuihou-admin-boot æ¼”ç¤ºåœ°å€

| é¡¹ç›®            | æ¼”ç¤ºåœ°å€                                                                                         | ç®¡ç†å‘˜è´¦å·       | æ™®é€šè´¦å·   |
| --------------- | ------------------------------------------------------------------------------------------------ | ---------------- | ---------- |
| ç§Ÿæˆ·åå°        | [http://42.202.130.216:10000/zuihou-ui](http://42.202.130.216:10000/zuihou-ui)                   | zuihou/zuihou    | test/zuiou |
| å¼€å‘ & è¿è¥åå° | [http://42.202.130.216:10000/zuihou-admin-ui](http://42.202.130.216:10000/zuihou-admin-ui)       | demoAdmin/zuihou | æ—          |
| swagger æ–‡æ¡£    | [http://42.202.130.216:10000/api/gate/doc.html](http://42.202.130.216:10000/api/gate/doc.html)   | æ—                | æ—          |
| å®šæ—¶ä»»åŠ¡        | [http://42.202.130.216:10000/zuihou-jobs-server](http://42.202.130.216:10000/zuihou-jobs-server) | zuihou/zuihou    | æ—          |

### åŠŸèƒ½ç‚¹ä»‹ç»

1. **æœåŠ¡æ³¨å†Œ & å‘ç°ä¸è°ƒç”¨ï¼š**

   åŸºäº Nacos æ¥å®ç°çš„æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼Œä½¿ç”¨ä½¿ç”¨ Feign æ¥å®ç°æœåŠ¡äº’è°ƒï¼Œå¯ä»¥åšåˆ°ä½¿ç”¨ HTTP è¯·æ±‚è¿œç¨‹è°ƒç”¨æ—¶èƒ½ä¸è°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·çš„ç¼–ç ä½“éªŒï¼Œå¼€å‘è€…å®Œå…¨æ„ŸçŸ¥ä¸åˆ°è¿™æ˜¯è¿œç¨‹æ–¹æ³•ï¼Œæ›´æ„ŸçŸ¥ä¸åˆ°è¿™æ˜¯ä¸ª HTTP è¯·æ±‚ã€‚

2. **æœåŠ¡é‰´æƒ:**

   é€šè¿‡ JWT çš„æ–¹å¼æ¥åŠ å¼ºæœåŠ¡ä¹‹é—´è°ƒåº¦çš„æƒé™éªŒè¯ï¼Œä¿è¯å†…éƒ¨æœåŠ¡çš„å®‰å…¨æ€§ã€‚

3. **è´Ÿè½½å‡è¡¡ï¼š**

   å°†æœåŠ¡ä¿ç•™çš„ rest è¿›è¡Œä»£ç†å’Œç½‘å…³æ§åˆ¶ï¼Œé™¤äº†å¹³å¸¸ç»å¸¸ä½¿ç”¨çš„ node.jsã€nginx å¤–ï¼ŒSpring Cloud ç³»åˆ—çš„ zuul å’Œ ribbonï¼Œå¯ä»¥å¸®æˆ‘ä»¬è¿›è¡Œæ­£å¸¸çš„ç½‘å…³ç®¡æ§å’Œè´Ÿè½½å‡è¡¡ã€‚å…¶ä¸­æ‰©å±•å’Œå€Ÿé‰´å›½å¤–é¡¹ç›®çš„æ‰©å±•åŸºäº JWT çš„ Zuul é™æµæ’ä»¶ï¼Œæ–¹é¢è¿›è¡Œé™æµã€‚

4. **ç†”æ–­æœºåˆ¶ï¼š**

   å› ä¸ºé‡‡å–äº†æœåŠ¡çš„åˆ†å¸ƒï¼Œä¸ºäº†é¿å…æœåŠ¡ä¹‹é—´çš„è°ƒç”¨ â€œé›ªå´©â€ï¼Œé‡‡ç”¨äº† Hystrix çš„ä½œä¸ºç†”æ–­å™¨ï¼Œé¿å…äº†æœåŠ¡ä¹‹é—´çš„ â€œé›ªå´©â€ã€‚

5. **ç›‘æ§ï¼š**

   åˆ©ç”¨ Spring Boot Admin æ¥ç›‘æ§å„ä¸ªç‹¬ç«‹ Service çš„è¿è¡ŒçŠ¶æ€ï¼›åˆ©ç”¨ turbine æ¥å®æ—¶æŸ¥çœ‹æ¥å£çš„è¿è¡ŒçŠ¶æ€å’Œè°ƒç”¨é¢‘ç‡ï¼›é€šè¿‡ Zipkin æ¥æŸ¥çœ‹å„ä¸ªæœåŠ¡ä¹‹é—´çš„è°ƒç”¨é“¾ç­‰ã€‚

6. **é“¾è·¯è°ƒç”¨ç›‘æ§ï¼š**

   åˆ©ç”¨ Zipkin å®ç°å¾®æœåŠ¡çš„å…¨é“¾è·¯æ€§èƒ½ç›‘æ§ï¼Œ ä»æ•´ä½“ç»´åº¦åˆ°å±€éƒ¨ç»´åº¦å±•ç¤ºå„é¡¹æŒ‡æ ‡ï¼Œå°†è·¨åº”ç”¨çš„æ‰€æœ‰è°ƒç”¨é“¾æ€§èƒ½ä¿¡æ¯é›†ä¸­å±•ç°ï¼Œå¯æ–¹ä¾¿åº¦é‡æ•´ä½“å’Œå±€éƒ¨æ€§èƒ½ï¼Œå¹¶ä¸”æ–¹ä¾¿æ‰¾åˆ°æ•…éšœäº§ç”Ÿçš„æºå¤´ï¼Œç”Ÿäº§ä¸Šå¯æå¤§ç¼©çŸ­æ•…éšœæ’é™¤æ—¶é—´ã€‚æœ‰äº†å®ƒï¼Œæˆ‘ä»¬èƒ½åšåˆ°ï¼š

   > è¯·æ±‚é“¾è·¯è¿½è¸ªï¼Œæ•…éšœå¿«é€Ÿå®šä½ï¼šå¯ä»¥é€šè¿‡è°ƒç”¨é“¾ç»“åˆä¸šåŠ¡æ—¥å¿—å¿«é€Ÿå®šä½é”™è¯¯ä¿¡æ¯ã€‚ å¯è§†åŒ–ï¼šå„ä¸ªé˜¶æ®µè€—æ—¶ï¼Œè¿›è¡Œæ€§èƒ½åˆ†æã€‚ ä¾èµ–ä¼˜åŒ–ï¼šå„ä¸ªè°ƒç”¨ç¯èŠ‚çš„å¯ç”¨æ€§ã€æ¢³ç†æœåŠ¡ä¾èµ–å…³ç³»ä»¥åŠä¼˜åŒ–ã€‚ æ•°æ®åˆ†æï¼Œä¼˜åŒ–é“¾è·¯ï¼šå¯ä»¥å¾—åˆ°ç”¨æˆ·çš„è¡Œä¸ºè·¯å¾„ï¼Œæ±‡æ€»åˆ†æåº”ç”¨åœ¨å¾ˆå¤šä¸šåŠ¡åœºæ™¯ã€‚

7. **æ•°æ®æƒé™**

   åˆ©ç”¨åŸºäº Mybatis çš„ DataScopeInterceptor æ‹¦æˆªå™¨å®ç°äº†ç®€å•çš„æ•°æ®æƒé™

8. **SaaSï¼ˆå¤šç§Ÿæˆ·ï¼‰çš„æ— æ„Ÿè§£å†³æ–¹æ¡ˆ**

   ä½¿ç”¨ Mybatis æ‹¦æˆªå™¨å®ç°å¯¹æ‰€æœ‰ SQL çš„æ‹¦æˆªï¼Œä¿®æ”¹é»˜è®¤çš„ Schemaï¼Œä»è€Œå®ç°å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»çš„ç›®çš„ã€‚ å¹¶ä¸”æ”¯æŒå¯æ’æ‹”ã€‚

9. **äºŒçº§ç¼“å­˜**

   é‡‡ç”¨ J2Cache æ“ä½œç¼“å­˜ï¼Œç¬¬ä¸€çº§ç¼“å­˜ä½¿ç”¨å†…å­˜ (Caffeine)ï¼Œç¬¬äºŒçº§ç¼“å­˜ä½¿ç”¨ Redisã€‚ ç”±äºå¤§é‡çš„ç¼“å­˜è¯»å–ä¼šå¯¼è‡´ L2 çš„ç½‘ç»œæˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆï¼Œå› æ­¤ L1 çš„ç›®æ ‡æ˜¯é™ä½å¯¹ L2 çš„è¯»å–æ¬¡æ•°ã€‚ è¯¥ç¼“å­˜æ¡†æ¶ä¸»è¦ç”¨äºé›†ç¾¤ç¯å¢ƒä¸­ã€‚å•æœºä¹Ÿå¯ä½¿ç”¨ï¼Œç”¨äºé¿å…åº”ç”¨é‡å¯å¯¼è‡´çš„ç¼“å­˜å†·å¯åŠ¨åå¯¹åç«¯ä¸šåŠ¡çš„å†²å‡»ã€‚

10. **ä¼˜é›…çš„ Bean è½¬æ¢**

    é‡‡ç”¨ Dozer ç»„ä»¶æ¥å¯¹ DTOã€DOã€PO ç­‰å¯¹è±¡çš„ä¼˜åŒ–è½¬æ¢

11. **å‰åç«¯ç»Ÿä¸€è¡¨å•éªŒè¯**

    ä¸¥è°¨çš„è¡¨å•éªŒè¯é€šå¸¸éœ€è¦ å‰ç«¯ + åç«¯åŒæ—¶éªŒè¯ï¼Œ ä½†ä¼ ç»Ÿçš„é¡¹ç›®ï¼Œå‡åªèƒ½å‰åç«¯å„åšä¸€æ¬¡æ£€éªŒï¼Œ åæœŸè§„åˆ™å˜æ›´ï¼Œåˆå¾—å‰åç«¯åŒæ—¶ä¿®æ”¹ã€‚ æ•…åœ¨ Â `hibernate-validator`Â  çš„åŸºç¡€ä¸Šå°è£…äº† Â `zuihou-validator-starter`Â  èµ·æ­¥ä¾èµ–ï¼Œæä¾›ä¸€ä¸ªé€šç”¨æ¥å£ï¼Œå¯ä»¥è·å–éœ€è¦æ ¡éªŒè¡¨å•çš„è§„åˆ™ï¼Œç„¶åå‰ç«¯ä½¿ç”¨åç«¯è¿”å›çš„è§„åˆ™ï¼Œ ä»¥åè‹¥è§„åˆ™æ”¹å˜ï¼Œåªéœ€è¦åç«¯ä¿®æ”¹å³å¯ã€‚

12. **é˜²è·¨ç«™è„šæœ¬æ”»å‡»ï¼ˆXSSï¼‰**

    - é€šè¿‡è¿‡æ»¤å™¨å¯¹æ‰€æœ‰è¯·æ±‚ä¸­çš„ è¡¨å•å‚æ•° è¿›è¡Œè¿‡æ»¤
    - é€šè¿‡ Json ååºåˆ—åŒ–å™¨å®ç°å¯¹æ‰€æœ‰ application/json ç±»å‹çš„å‚æ•° è¿›è¡Œè¿‡æ»¤

13. **å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯æ³¨å…¥å™¨**

    - é€šè¿‡æ³¨è§£å®ç°ç”¨æˆ·èº«ä»½æ³¨å…¥

14. **åœ¨çº¿ API**

    ç”±äºåŸç”Ÿ swagger-ui æŸäº›åŠŸèƒ½æ”¯æŒä¸å¤Ÿå‹å¥½ï¼Œæ•…é‡‡ç”¨äº†å›½å†…å¼€æºçš„ Â `swagger-bootstrap-ui`ï¼Œå¹¶åˆ¶ä½œäº† staterï¼Œæ–¹ä¾¿ springboot ç”¨æˆ·ä½¿ç”¨ã€‚

15. **ä»£ç ç”Ÿæˆå™¨**

    åŸºäº Mybatis-plus-generator è‡ªå®šä¹‰äº†ä¸€å¥—ä»£ç ç”Ÿæˆå™¨ï¼Œ é€šè¿‡é…ç½®æ•°æ®åº“å­—æ®µçš„æ³¨é‡Šï¼Œè‡ªåŠ¨ç”Ÿæˆæšä¸¾ç±»ã€æ•°æ®å­—å…¸æ³¨è§£ã€SaveDTOã€UpdateDTOã€è¡¨å•éªŒè¯è§„åˆ™æ³¨è§£ã€Swagger æ³¨è§£ç­‰ã€‚

16. **å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨**ï¼š

    åŸºäº xxl-jobs è¿›è¡Œäº†åŠŸèƒ½å¢å¼ºã€‚ï¼ˆå¦‚ï¼šæŒ‡å®šæ—¶é—´å‘é€ä»»åŠ¡ã€æ‰§è¡Œå™¨å’Œè°ƒåº¦å™¨åˆå¹¶é¡¹ç›®ã€å¤šæ•°æ®æºï¼‰

17. **å¤§æ–‡ä»¶ / æ–­ç‚¹ / åˆ†ç‰‡ç»­ä¼ **

    å‰ç«¯é‡‡ç”¨ webupload.jsã€åç«¯é‡‡ç”¨ NIO å®ç°äº†å¤§æ–‡ä»¶æ–­ç‚¹åˆ†ç‰‡ç»­ä¼ ï¼Œå¯åŠ¨ Eurekaã€Zuulã€File æœåŠ¡åï¼Œç›´æ¥æ‰“å¼€ docs/chunkUploadDemo/demo.html å³å¯è¿›è¡Œæµ‹è¯•ã€‚ ç»æµ‹è¯•ï¼Œæœ¬åœ°é™åˆ¶å †æ ˆæœ€å¤§å†…å­˜ 128M å¯åŠ¨ File æœåŠ¡ï¼Œ5 åˆ†é’Ÿå†…èƒ½æˆåŠŸä¸Šä¼  4.6G + çš„å¤§æ–‡ä»¶ï¼Œæ­£å¼æœè€—æ—¶åˆ™ä¼šå—åˆ°ç”¨æˆ·å¸¦å®½å’ŒæœåŠ¡å™¨å¸¦å®½çš„å½±å“ï¼Œæ—¶é—´æ¯”è¾ƒé•¿ã€‚

18. **åˆ†å¸ƒå¼äº‹åŠ¡**

    é›†æˆäº†é˜¿é‡Œçš„åˆ†å¸ƒå¼äº‹åŠ¡ä¸­é—´ä»¶ï¼šseataï¼Œä»¥ Â **é«˜æ•ˆ**Â  å¹¶ä¸”å¯¹ä¸šåŠ¡ Â **0 ä¾µå…¥**Â  çš„æ–¹å¼ï¼Œè§£å†³ å¾®æœåŠ¡ åœºæ™¯ä¸‹é¢ä¸´çš„åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ã€‚

### é¡¹ç›®æ¶æ„å›¾

![20241229154732_sgdUPRIO.webp](https://cdn.dong4j.site/source/image/20241229154732_sgdUPRIO.webp)

### æŠ€æœ¯æ ˆ / ç‰ˆæœ¬ä»‹ç»

- æ‰€æ¶‰åŠçš„ç›¸å…³çš„æŠ€æœ¯æœ‰ï¼š
  - JSON åºåˆ—åŒ–ï¼šJackson
  - æ¶ˆæ¯é˜Ÿåˆ—ï¼šRabbitMQ
  - ç¼“å­˜ï¼šRedis
  - ç¼“å­˜æ¡†æ¶ï¼šJ2Cache
  - æ•°æ®åº“ï¼š MySQL 5.7.9 (é©±åŠ¨ 6.0.6)
  - å®šæ—¶å™¨ï¼šé‡‡ç”¨ xxl-jobs é¡¹ç›®è¿›è¡ŒäºŒæ¬¡æ”¹é€ 
  - å‰ç«¯ï¼švue
  - æŒä¹…å±‚æ¡†æ¶ï¼š Mybatis-plus
  - ä»£ç ç”Ÿæˆå™¨ï¼šåŸºäº Mybatis-plus-generator è‡ªå®šä¹‰ [[https://github.com/zuihou/zuihou-generator.git](https://github.com/zuihou/zuihou-generator.git)]
  - API ç½‘å…³ï¼šZuul
  - æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼šEureka -> Nacos
  - æœåŠ¡æ¶ˆè´¹ï¼šOpenFeign
  - è´Ÿè½½å‡è¡¡ï¼šRibbon
  - é…ç½®ä¸­å¿ƒï¼šNacos
  - æœåŠ¡ç†”æ–­ï¼šHystrix
  - é¡¹ç›®æ„å»ºï¼šMaven 3.3
  - åˆ†å¸ƒå¼äº‹åŠ¡ï¼š seata
  - åˆ†å¸ƒå¼ç³»ç»Ÿçš„æµé‡é˜²å«å…µï¼š Sentinel
  - ç›‘æ§ï¼š spring-boot-admin 2.x
  - é“¾è·¯è°ƒç”¨è·Ÿè¸ªï¼š zipkin 2.x
  - æ–‡ä»¶æœåŠ¡å™¨ï¼šFastDFS 5.0.5 / é˜¿é‡Œäº‘ OSS / æœ¬åœ°å­˜å‚¨
  - Nginx
- éƒ¨ç½²æ–¹é¢ï¼š
  - æœåŠ¡å™¨ï¼šCentOS
  - Jenkins
  - Docker 18.09
  - Kubernetes 1.12

æœ¬ä»£ç é‡‡ç”¨ Intellij IDEA (2018.1 EAP) æ¥ç¼–å†™ï¼Œä½†æºç ä¸å…·ä½“çš„ IDE æ— å…³ã€‚

PS: Lombok ç‰ˆæœ¬è¿‡ä½ä¼šå¯¼è‡´æšä¸¾ç±»å‹çš„å‚æ•°æ— æ³•æ­£ç¡®è·å–å‚æ•°ï¼Œç»è¿‡è°ƒè¯•å‘ç°å› ä¸ºç‰ˆæœ¬å¤šä½åï¼Œå¯¼è‡´ EnumDeserializer çš„ Object obj = p.getCurrentValue (); å–çš„å€¼ä¸ºç©ºã€‚

## [microservices-platform](https://github.com/zlt2000/microservices-platform)

### é¡¹ç›®æ€»ä½“æ¶æ„å›¾

![20241229154732_lCCGFgoH.webp](https://cdn.dong4j.site/source/image/20241229154732_lCCGFgoH.webp)

### åŠŸèƒ½ä»‹ç»

![20241229154732_NdaIh5EJ.webp](https://cdn.dong4j.site/source/image/20241229154732_NdaIh5EJ.webp)

### æ¨¡å—è¯´æ˜

```
central-platform -- çˆ¶é¡¹ç›®ï¼Œå…¬å…±ä¾èµ–
â”‚  â”œâ”€zlt-business -- ä¸šåŠ¡æ¨¡å—ä¸€çº§å·¥ç¨‹
â”‚  â”‚  â”œâ”€user-center -- ç”¨æˆ·ä¸­å¿ƒ[7000]
â”‚  â”‚  â”œâ”€file-center -- æ–‡ä»¶ä¸­å¿ƒ[5000]
â”‚  â”‚  â”œâ”€code-generator -- ä»£ç ç”Ÿæˆå™¨[7300]
â”‚  â”‚  â”œâ”€search-center -- æœç´¢ä¸­å¿ƒ
â”‚  â”‚  â”‚  â”œâ”€search-client -- æœç´¢ä¸­å¿ƒå®¢æˆ·ç«¯
â”‚  â”‚  â”‚  â”œâ”€search-server -- æœç´¢ä¸­å¿ƒæœåŠ¡ç«¯[7100]
â”‚  â”‚â”€zlt-commons -- é€šç”¨å·¥å…·ä¸€çº§å·¥ç¨‹
â”‚  â”‚  â”œâ”€zlt-auth-client-spring-boot-starter -- å°è£…spring security clientç«¯çš„é€šç”¨æ“ä½œé€»è¾‘
â”‚  â”‚  â”œâ”€zlt-common-core -- å°è£…é€šç”¨æ“ä½œé€»è¾‘
â”‚  â”‚  â”œâ”€zlt-common-spring-boot-starter -- å°è£…é€šç”¨æ“ä½œé€»è¾‘
â”‚  â”‚  â”œâ”€zlt-db-spring-boot-starter -- å°è£…æ•°æ®åº“é€šç”¨æ“ä½œé€»è¾‘
â”‚  â”‚  â”œâ”€zlt-log-spring-boot-starter -- å°è£…logé€šç”¨æ“ä½œé€»è¾‘
â”‚  â”‚  â”œâ”€zlt-redis-spring-boot-starter -- å°è£…Redisé€šç”¨æ“ä½œé€»è¾‘
â”‚  â”‚  â”œâ”€zlt-ribbon-spring-boot-starter -- å°è£…Ribbonå’ŒFeignçš„é€šç”¨æ“ä½œé€»è¾‘
â”‚  â”‚  â”œâ”€zlt-sentinel-spring-boot-starter -- å°è£…Sentinelçš„é€šç”¨æ“ä½œé€»è¾‘
â”‚  â”‚  â”œâ”€zlt-swagger2-spring-boot-starter -- å°è£…Swaggeré€šç”¨æ“ä½œé€»è¾‘
â”‚  â”œâ”€zlt-config -- é…ç½®ä¸­å¿ƒ
â”‚  â”œâ”€zlt-doc -- é¡¹ç›®æ–‡æ¡£
â”‚  â”œâ”€zlt-gateway -- apiç½‘å…³ä¸€çº§å·¥ç¨‹
â”‚  â”‚  â”œâ”€sc-gateway -- spring-cloud-gateway[9900]
â”‚  â”‚  â”œâ”€zuul-gateway -- netflix-zuul[9900]
â”‚  â”œâ”€zlt-job -- åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ä¸€çº§å·¥ç¨‹
â”‚  â”‚  â”œâ”€job-admin -- ä»»åŠ¡ç®¡ç†å™¨[8081]
â”‚  â”‚  â”œâ”€job-core -- ä»»åŠ¡è°ƒåº¦æ ¸å¿ƒä»£ç 
â”‚  â”‚  â”œâ”€job-executor-samples -- ä»»åŠ¡æ‰§è¡Œè€…executoræ ·ä¾‹[8082]
â”‚  â”œâ”€zlt-monitor -- ç›‘æ§ä¸€çº§å·¥ç¨‹
â”‚  â”‚  â”œâ”€sc-admin -- åº”ç”¨ç›‘æ§[6500]
â”‚  â”‚  â”œâ”€log-center -- æ—¥å¿—ä¸­å¿ƒ[6200]
â”‚  â”œâ”€zlt-uaa -- spring-securityè®¤è¯ä¸­å¿ƒ[8000]
â”‚  â”œâ”€zlt-register -- æ³¨å†Œä¸­å¿ƒNacos[8848]
â”‚  â”œâ”€zlt-web -- å‰ç«¯ä¸€çº§å·¥ç¨‹
â”‚  â”‚  â”œâ”€back-web -- åå°å‰ç«¯[8066]
â”‚  â”œâ”€zlt-transaction -- äº‹åŠ¡ä¸€çº§å·¥ç¨‹
â”‚  â”‚  â”œâ”€txlcn-tm -- tx-lcnäº‹åŠ¡ç®¡ç†å™¨[7970]
â”‚  â”œâ”€zlt-demo -- demoä¸€çº§å·¥ç¨‹
â”‚  â”‚  â”œâ”€txlcn-demo -- txlcnåˆ†å¸ƒå¼äº‹åŠ¡demo
â”‚  â”‚  â”œâ”€seata-demo -- seataåˆ†å¸ƒå¼äº‹åŠ¡demo
â”‚  â”‚  â”œâ”€sharding-jdbc-demo -- sharding-jdbcåˆ†åº“åˆ†è¡¨demo
â”‚  â”‚  â”œâ”€rocketmq-demo -- rocketmqå’Œmqäº‹åŠ¡demo
```

## (open-capacity-platform)[https://gitee.com/owenwangwen/open-capacity-platform]

### **åŠŸèƒ½ä»‹ç»**

- ç»Ÿä¸€å®‰å…¨è®¤è¯ä¸­å¿ƒ
  - æ”¯æŒ oauth çš„å››ç§æ¨¡å¼ç™»å½•
  - æ”¯æŒç”¨æˆ·åã€å¯†ç åŠ å›¾å½¢éªŒè¯ç ç™»å½•
  - æ”¯æŒç¬¬ä¸‰æ–¹ç³»ç»Ÿå•ç‚¹ç™»å½•
- å¾®æœåŠ¡æ¶æ„åŸºç¡€æ”¯æ’‘
  - æœåŠ¡æ³¨å†Œå‘ç°ã€è·¯ç”±ä¸è´Ÿè½½å‡è¡¡
  - æœåŠ¡ç†”æ–­ä¸é™æµ
  - ç»Ÿä¸€é…ç½®ä¸­å¿ƒ
  - ç»Ÿä¸€æ—¥å¿—ä¸­å¿ƒ
  - åˆ†å¸ƒå¼é”
  - åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å™¨
- ç³»ç»ŸæœåŠ¡ç›‘æ§ä¸­å¿ƒ
  - æœåŠ¡è°ƒç”¨é“¾ç›‘æ§
  - åº”ç”¨ååé‡ç›‘æ§
  - æœåŠ¡é™çº§ã€ç†”æ–­ç›‘æ§
  - å¾®æœåŠ¡æœåŠ¡ç›‘æ§
- èƒ½åŠ›å¼€æ”¾å¹³å°ä¸šåŠ¡æ”¯æ’‘
  - ç½‘å…³åŸºäºåº”ç”¨æ–¹å¼ API æ¥å£éš”ç¦»
  - ç½‘å…³åŸºäºåº”ç”¨é™åˆ¶è°ƒç”¨æ¬¡æ•°
  - ä¸‹æ¸¸æœåŠ¡åŸºäº RBAC æƒé™ç®¡ç†ï¼Œå®ç°ç»†ç²’åº¦æ§åˆ¶
  - ä»£ç ç”Ÿæˆå™¨ä¸­å¿ƒ
  - ç½‘å…³èšåˆæœåŠ¡å†…éƒ¨ Swagger æ¥å£æ–‡æ¡£
  - ç»Ÿä¸€è·¨åŸŸå¤„ç†
  - ç»Ÿä¸€å¼‚å¸¸å¤„ç†
- docker å®¹å™¨åŒ–éƒ¨ç½²
  - åŸºäº rancher çš„å®¹å™¨åŒ–éƒ¨ç½²
  - åŸºäº docker çš„ elk æ—¥å¿—ç›‘æ§
  - åŸºäº docker çš„æœåŠ¡åŠ¨æ€æ‰©å®¹

### ä»£ç ç»“æ„

![20241229154732_6fabptft.webp](https://cdn.dong4j.site/source/image/20241229154732_6fabptft.webp)

## [mall](https://github.com/macrozheng/mall)

### é¡¹ç›®ä»‹ç»

mall é¡¹ç›®æ˜¯ä¸€å¥—ç”µå•†ç³»ç»Ÿï¼ŒåŒ…æ‹¬å‰å°å•†åŸç³»ç»ŸåŠåå°ç®¡ç†ç³»ç»Ÿï¼ŒåŸºäº SpringBoot+MyBatis å®ç°ï¼Œé‡‡ç”¨ Docker å®¹å™¨åŒ–éƒ¨ç½²ã€‚å‰å°å•†åŸç³»ç»ŸåŒ…å«é¦–é¡µé—¨æˆ·ã€å•†å“æ¨èã€å•†å“æœç´¢ã€å•†å“å±•ç¤ºã€è´­ç‰©è½¦ã€è®¢å•æµç¨‹ã€ä¼šå‘˜ä¸­å¿ƒã€å®¢æˆ·æœåŠ¡ã€å¸®åŠ©ä¸­å¿ƒç­‰æ¨¡å—ã€‚åå°ç®¡ç†ç³»ç»ŸåŒ…å«å•†å“ç®¡ç†ã€è®¢å•ç®¡ç†ã€ä¼šå‘˜ç®¡ç†ã€ä¿ƒé”€ç®¡ç†ã€è¿è¥ç®¡ç†ã€å†…å®¹ç®¡ç†ã€ç»Ÿè®¡æŠ¥è¡¨ã€è´¢åŠ¡ç®¡ç†ã€æƒé™ç®¡ç†ã€è®¾ç½®ç­‰æ¨¡å—ã€‚

### ç³»ç»Ÿæ¶æ„å›¾

![20241229154732_I6pbMYqL.webp](https://cdn.dong4j.site/source/image/20241229154732_I6pbMYqL.webp)

## [spring-boot-plus](https://github.com/geekidea/spring-boot-plus)

### ä¸»è¦ç‰¹æ€§

1. é›†æˆ spring boot å¸¸ç”¨å¼€å‘ç»„ä»¶é›†ã€å…¬å…±é…ç½®ã€AOP æ—¥å¿—ç­‰
2. é›†æˆ mybatis plus å¿«é€Ÿ dao æ“ä½œ
3. å¿«é€Ÿç”Ÿæˆåå°ä»£ç : entity/param/vo/controller/service/mapper/xml
4. é›†æˆ swagger2ï¼Œå¯è‡ªåŠ¨ç”Ÿæˆ api æ–‡æ¡£
5. é›†æˆ jwtã€shiro/spring security æƒé™æ§åˆ¶
6. é›†æˆ redisã€spring cacheã€ehcache ç¼“å­˜
7. é›†æˆ rabbit/rocket/kafka mq æ¶ˆæ¯é˜Ÿåˆ—
8. é›†æˆ druid è¿æ¥æ± ï¼ŒJDBC æ€§èƒ½å’Œæ…¢æŸ¥è¯¢æ£€æµ‹
9. é›†æˆ spring boot adminï¼Œå®æ—¶æ£€æµ‹é¡¹ç›®è¿è¡Œæƒ…å†µ
10. ä½¿ç”¨ assembly maven æ’ä»¶è¿›è¡Œä¸åŒç¯å¢ƒæ‰“åŒ…éƒ¨ç½²,åŒ…å«å¯åŠ¨ã€é‡å¯å‘½ä»¤ï¼Œé…ç½®æ–‡ä»¶æå–åˆ°å¤–éƒ¨ config ç›®å½•

### é¡¹ç›®æ¶æ„

![20241229154732_ghNYKhGb.webp](https://cdn.dong4j.site/source/image/20241229154732_ghNYKhGb.webp)

## [carefree-mongodb-spring-boot-starter](https://github.com/kweny/carefree-mongodb-spring-boot-starter)

<https://zhuanlan.zhihu.com/p/45033950>

## [Micro-Service-Skeleton](https://github.com/babylikebird/Micro-Service-Skeleton)

<https://blog.csdn.net/w1054993544/article/details/78932614>

## [pig](https://gitee.com/log4j/pig)

### ç‰¹æ€§

- åŸºäº Spring Cloud Hoxton ã€Spring Boot 2.2ã€ OAuth2 çš„ RBAC æƒé™ç®¡ç†ç³»ç»Ÿ
- åŸºäºæ•°æ®é©±åŠ¨è§†å›¾çš„ç†å¿µå°è£… element-uiï¼Œå³ä½¿æ²¡æœ‰ vue çš„ä½¿ç”¨ç»éªŒä¹Ÿèƒ½å¿«é€Ÿä¸Šæ‰‹
- æä¾›å¯¹å¸¸è§å®¹å™¨åŒ–æ”¯æŒ Dockerã€Kubernetesã€Rancher2 æ”¯æŒ
- æä¾› lambda ã€stream api ã€webflux çš„ç”Ÿäº§å®è·µ

### ç»“æ„

```
pig-ui  -- https://gitee.com/log4j/pig-ui

pig
â”œâ”€â”€ pig-auth -- æˆæƒæœåŠ¡æä¾›[3000]
â”œâ”€â”€ pig-codegen -- å›¾å½¢åŒ–ä»£ç ç”Ÿæˆ[5002]
â””â”€â”€ pig-common -- ç³»ç»Ÿå…¬å…±æ¨¡å—
     â”œâ”€â”€ pig-common-core -- å…¬å…±å·¥å…·ç±»æ ¸å¿ƒåŒ…
     â”œâ”€â”€ pig-common-log -- æ—¥å¿—æœåŠ¡
     â”œâ”€â”€ pig-common-security -- å®‰å…¨å·¥å…·ç±»
     â””â”€â”€ pig-common-swagger -- æ¥å£æ–‡æ¡£
â”œâ”€â”€ pig-register -- Nacos Server[8848]
â”œâ”€â”€ pig-gateway -- Spring Cloud Gatewayç½‘å…³[9999]
â”œâ”€â”€ pig-monitor -- Spring Boot Adminç›‘æ§ [5001]
â””â”€â”€ pig-upms -- é€šç”¨ç”¨æˆ·æƒé™ç®¡ç†æ¨¡å—
     â””â”€â”€ pig-upms-api -- é€šç”¨ç”¨æˆ·æƒé™ç®¡ç†ç³»ç»Ÿå…¬å…±apiæ¨¡å—
     â””â”€â”€ pig-upms-biz -- é€šç”¨ç”¨æˆ·æƒé™ç®¡ç†ç³»ç»Ÿä¸šåŠ¡å¤„ç†æ¨¡å—[4000]

```

## [prex](https://gitee.com/kaiyuantuandui/prex)

Prex åŸºäº Spring Boot 2.1.8 ã€Spring Cloud Greenwich.SR3ã€Spring Cloud Alibabaã€Spring Security ã€Spring cloud Oauth2 ã€Vue çš„å‰åç«¯åˆ†ç¦»çš„çš„ RBAC æƒé™ç®¡ç†ç³»ç»Ÿï¼Œé¡¹ç›®æ”¯æŒæ•°æ®æƒé™ç®¡ç†ï¼Œæ”¯æŒåç«¯é…ç½®èœå•åŠ¨æ€è·¯ç”±ï¼Œç¬¬ä¸‰æ–¹ç¤¾äº¤ç™»å½•ï¼ŒåŠªåŠ›åšæœ€ç®€æ´çš„åå°ç®¡ç†ç³»ç»Ÿ

### æŠ€æœ¯æ ˆ

- åŸºäº Spring Boot 2.1.8 ã€Spring Cloudã€Spring Cloud Alibabaã€Spring Securityã€OAuth2 çš„ RBAC æƒé™ç®¡ç†ç³»ç»Ÿã€‚
- åŸºäº Nacos åšæ³¨å†Œä¸­å¿ƒå’Œé…ç½®ä¸­å¿ƒã€‚
- åŸºäº Sentinel åšæ–¹æ³•é™æµå’Œé˜»å¡å¤„ç†ã€‚
- åŸºäº Vue å‰ç«¯æ¡†æ¶ å’Œæœ€æ–° Ant Design ç•Œé¢ã€‚
- åŸºäº Mybatis Plus ç®€åŒ–å¼€å‘ã€æ•°æ®éš”ç¦»ç­‰ã€‚
- é¡¹ç›®å‡ä½¿ç”¨ Lambda ã€Stream Api çš„é£æ ¼ç¼–ç ã€‚
- ä½¿ç”¨ Spring Social ä¸‰æ–¹ç™»å½•ã€‚
- æä¾› Spring Cloud Admin åšé¡¹ç›®å¯è§†åŒ–ç›‘æ§ã€‚
- åŸºäº Swagger æä¾›ç»Ÿä¸€ Api ç®¡ç†ã€‚

### åŸºæœ¬åŠŸèƒ½

- ç”¨æˆ·ç®¡ç†ï¼šè¯¥åŠŸèƒ½ä¸»è¦å®Œæˆç³»ç»Ÿç”¨æˆ·é…ç½®ï¼Œæä¾›ç”¨æˆ·åŸºç¡€é…ç½® (ç”¨æˆ·åã€æ‰‹æœºå·é‚®ç®±ç­‰) ä»¥åŠéƒ¨é—¨è§’è‰²ç­‰ã€‚
- è§’è‰²ç®¡ç†ï¼šæƒé™èœå•åˆ†é…ï¼Œä»¥éƒ¨é—¨åŸºç¡€è®¾ç½®è§’è‰²çš„æ•°æ®æƒé™èŒƒå›´ã€‚
- èœå•ç®¡ç†ï¼šåç«¯é…ç½®å®ç°èœå•åŠ¨æ€è·¯ç”±ï¼Œæ”¯æŒå¤šçº§èœå•ï¼Œæ“ä½œæƒé™ï¼ŒæŒ‰é’®æƒé™æ ‡è¯†ç­‰ã€‚
- éƒ¨é—¨ç®¡ç†ï¼šé…ç½®ç³»ç»Ÿç»„ç»‡æ¶æ„ï¼Œæ ‘å½¢è¡¨æ ¼å±•ç¤ºï¼Œå¯éšæ„è°ƒæ•´ä¸Šä¸‹çº§ã€‚
- å²—ä½ç®¡ç†ï¼šæ ¹æ®éƒ¨é—¨é…ç½®æ‰€å±èŒä½
- ç§Ÿæˆ·ç®¡ç†ï¼šæä¾›ç»Ÿä¸€è®¤è¯å¯¹æƒé™ç®¡ç†å¹³å°ï¼ŒæŒ‰ç…§ç§Ÿæˆ·è¿›è¡Œæ•°æ®éš”ç¦» (å¾®æœåŠ¡ç‰ˆæš‚ä¸å¼€æ”¾)ã€‚
- ç¤¾äº¤è´¦å·ç®¡ç†ï¼šå¯ä»¥å¯¹ç»‘å®š Prex ç³»ç»Ÿå¯¹ç¤¾äº¤è´¦å·è¿›è¡ŒæŸ¥çœ‹å’Œè§£ç»‘ã€‚
- å­—å…¸ç®¡ç†ï¼šå¯¹ç³»ç»Ÿä¸­ç»å¸¸ä½¿ç”¨çš„ä¸€äº›è¾ƒä¸ºå›ºå®šçš„æ•°æ®è¿›è¡Œç»´æŠ¤ï¼Œå¦‚ï¼šçŠ¶æ€ (æ­£å¸¸ / å¼‚å¸¸)ï¼Œæ€§åˆ« (ç”· / å¥³) ç­‰ã€‚
- æ—¥å¿—ç®¡ç†ï¼šå¯ä»¥åˆ é™¤å’ŒæŸ¥çœ‹ç”¨æˆ·æ“ä½œçš„æ—¥å¿—ã€‚
- å¼‚å¸¸æ—¥å¿—ï¼šè®°å½•å¼‚å¸¸æ—¥å¿—ï¼Œæ–¹ä¾¿å¼€å‘äººå‘˜å®šä½é”™è¯¯ã€‚

### é¡¹ç›®ç‰¹ç‚¹

- å‰åç«¯åˆ†ç¦»çš„å¾®æœåŠ¡æ¶æ„
- ä½¿ç”¨ Nacosã€Sentinelã€SpringCloud ç­‰æœ€æ–°æµè¡Œç»„ä»¶å’Œ UI
- å¯ç›´æ¥é›†æˆåˆ°ä¼ä¸šå¾®æœåŠ¡é¡¹ç›®ä¸­
- ä½¿ç”¨ Gateway è¿›è¡Œé«˜æ€§èƒ½çš„ç½‘å…³è·¯ç”±
- ç‹¬ç«‹çš„ UPMS ç³»ç»Ÿ
- ä½¿ç”¨ JWT è¿›è¡Œ Token ç®¡ç†
- æä¾›æ’æ‹”å¼å¯†ç å’Œå®¢æˆ·ç«¯ä¸¤ç§æ¨¡å¼åˆ°æˆæƒæ–¹å¼
- å¯¹æ—¥å¿—æ“ä½œã€çŸ­ä¿¡ã€é‚®ä»¶ã€Redisã€èµ„æºæœåŠ¡ã€Swagger å‡æä¾›æ’æ‹”å¼ä½¿ç”¨
- ä»£ç å¤§é‡é‡‡ç”¨ä¸­æ–‡æ³¨é‡Šï¼Œæå…¶ç®€æ´é£æ ¼ï¼Œä¸Šæ‰‹å¿«ã€æ˜“ç†è§£
- é‡‡ç”¨ RESTFul API è§„èŒƒå¼€å‘
- ç»Ÿä¸€å¼‚å¸¸æ‹¦æˆªï¼Œå‹å¥½çš„é”™è¯¯æç¤º
- åŸºäºæ³¨è§£ + Aop åˆ‡é¢å®ç°å…¨æ–¹ä½æ—¥è®°è®°å½•ç³»ç»Ÿ
- åŸºäº Mybatis æ‹¦æˆªå™¨ + ç­–ç•¥æ¨¡å¼å®ç°æ•°æ®æƒé™æ§åˆ¶
- æä¾›è§£å†³å‰ååˆ†ç¦»ç¬¬ä¸‰æ–¹ç¤¾äº¤ç™»å½•æ–¹æ¡ˆ
- Spring Social é›†æˆ Security å®ç°ç¬¬ä¸‰æ–¹ç¤¾äº¤ç™»å½•
- åŸºäº Mybatis-Plus å®ç° SaaS å¤šç§Ÿæˆ·åŠŸèƒ½ (å¾®æœåŠ¡ç‰ˆæš‚ä¸å¼€æ”¾)

## [Nepxion](https://github.com/Nepxion)

## [FEBS-Cloud](https://github.com/wuyouzhuguli/FEBS-Cloud)

FEBS Cloud æ˜¯ä¸€æ¬¾ä½¿ç”¨ Spring Cloud Hoxton.RELEASEã€Spring Cloud OAuth2 & Spring Cloud Alibaba æ„å»ºçš„ä½è€¦åˆæƒé™ç®¡ç†ç³»ç»Ÿï¼Œå‰ç«¯ï¼ˆFEBS Cloud Webï¼‰é‡‡ç”¨ vue element admin æ„å»ºã€‚FEBS æ„æŒ‡ï¼š**F**astï¼Œ**E**asy useï¼Œ**B**eautiful å’Œ Â **S**afeã€‚è¯¥ç³»ç»Ÿå…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š

1. å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çº¯ Token äº¤äº’ï¼›
2. è®¤è¯æœåŠ¡å™¨ä¸èµ„æºæœåŠ¡å™¨åˆ†ç¦»ï¼Œæ–¹ä¾¿æ¥å…¥è‡ªå·±çš„å¾®æœåŠ¡ç³»ç»Ÿï¼›
3. å¾®æœåŠ¡é˜²æŠ¤ï¼Œå®¢æˆ·ç«¯è¯·æ±‚èµ„æºåªèƒ½é€šè¿‡å¾®æœåŠ¡ç½‘å…³è·å–ï¼›
4. é›†æˆ Prometheusï¼ŒSpringBootAdminï¼Œå¤šç»´åº¦ç›‘æ§å¾®æœåŠ¡ï¼›
5. é›†æˆ Spring Cloud Alibaba Nacos æœåŠ¡æ²»ç†å’Œé›†ä¸­é…ç½®ç®¡ç†ï¼›
6. ç½‘å…³é™æµï¼Œç½‘å…³é»‘åå•é™åˆ¶ï¼Œç½‘å…³æ—¥å¿—ï¼ˆWebFlux ç¼–ç¨‹å®è·µï¼‰ï¼›
7. ~~é›†æˆ Zipkinï¼Œæ–¹ä¾¿è·Ÿè¸ª Feign è°ƒç”¨é“¾~~ï¼Œé›†æˆ Skywalking APMï¼›
8. é›†æˆ ELKï¼Œé›†ä¸­ç®¡ç†æ—¥å¿—ï¼Œä¾¿äºé—®é¢˜åˆ†æï¼›
9. å¾®æœåŠ¡ Docker åŒ–ï¼Œä½¿ç”¨ Docker Compose ä¸€é”®éƒ¨ç½²ï¼›
10. æ”¯æŒ Kubernetes é›†ç¾¤éƒ¨ç½²ï¼›
11. æä¾›è¯¦ç»†çš„ä½¿ç”¨æ–‡æ¡£å’Œæ­å»ºæ•™ç¨‹ï¼›
12. å‰åç«¯è¯·æ±‚å‚æ•°æ ¡éªŒï¼ŒExcel å¯¼å…¥å¯¼å‡ºï¼Œä»£ç ç”Ÿæˆç­‰ã€‚

### æ–‡æ¡£ä¸æ•™ç¨‹

é¡¹ç›®å¯¼å…¥åŠä½¿ç”¨æ–‡æ¡£ï¼š[https://www.kancloud.cn/mrbird/spring-cloud/1263681](https://www.kancloud.cn/mrbird/spring-cloud/1263681)ã€‚  
é¡¹ç›®ä»é›¶æ­å»ºåˆ°éƒ¨ç½²æ•™ç¨‹ï¼š[https://www.kancloud.cn/mrbird/spring-cloud/1263685](https://www.kancloud.cn/mrbird/spring-cloud/1263685)ã€‚  
Kubernetes é›†ç¾¤éƒ¨ç½²è„šæœ¬ï¼š[https://github.com/wuyouzhuguli/FEBS-Cloud-K8S](https://github.com/wuyouzhuguli/FEBS-Cloud-K8S)ã€‚  
åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆï¼ˆRocketMQã€TX-LCNã€Seataï¼‰ï¼š[https://www.kancloud.cn/mrbird/spring-cloud/1456142](https://www.kancloud.cn/mrbird/spring-cloud/1456142)ã€‚

## [Spring Cloud Alibaba ç»„ä»¶ä½¿ç”¨](https://github.com/helloworlde/spring-cloud-alibaba-component)

### Nacos

> Nacos æ˜¯ä¸€ä¸ªé…ç½®å’Œæ³¨å†Œä¸­å¿ƒï¼Œç±»ä¼¼ Spring Cloud Config å’Œ Eurekaã€ZooKeeperã€Consul

- [Spring Boot ä½¿ç”¨ Nacos ä½œä¸ºé…ç½®ä¸­å¿ƒ](https://github.com/helloworlde/spring-cloud-alibaba-component/blob/master/boot-config/README.md)
- [Spring Cloud ä½¿ç”¨ Nacos ä½œä¸ºé…ç½®ä¸­å¿ƒ](https://github.com/helloworlde/spring-cloud-alibaba-component/blob/master/cloud-config/README.md)
- [Spring Cloud ä½¿ç”¨ Nacos ä½œä¸ºæœåŠ¡æ³¨å†Œä¸­å¿ƒ](https://github.com/helloworlde/spring-cloud-alibaba-component/blob/master/cloud-discovery/README.md)

### Sentinel

> Sentinel æ˜¯ä¸€ä¸ªæµé‡æ§åˆ¶æ¡†æ¶ï¼Œæ”¯æŒæµé‡æ§åˆ¶ï¼Œç†”æ–­é™çº§ï¼Œç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ï¼Œç±»ä¼¼ Hystrixã€resilience4j

- [Spring Cloud ä½¿ç”¨ Sentinel ä½œä¸ºé™æµé™çº§å·¥å…·](https://github.com/helloworlde/spring-cloud-alibaba-component/blob/master/sentinel-nacos-config/README.md)

### OSS

> spring-cloud-starter-alicloud-oss æ˜¯ç”¨äºé˜¿é‡Œäº‘ OSS çš„ SpringBoot Starterï¼Œé€šè¿‡å°è£… SDK å®ç°å¯¹ OSS çš„æ“ä½œ

- [Spring Cloud ä½¿ç”¨é˜¿é‡Œäº‘ OSS](https://github.com/helloworlde/spring-cloud-alibaba-component/blob/master/cloud-oss/README.md)

### Dubbo

> Dubbo æ˜¯ä¸€ä¸ªè¿œç¨‹è°ƒç”¨æ¡†æ¶ï¼Œç”¨äºå®ç°æ–¹æ³•çš„è¿œç¨‹è°ƒç”¨

æ¨èä½¿ç”¨ ZooKeeper ä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œå½“å‰ä½¿ç”¨ Nacos ä¼šæœ‰å„ç§é—®é¢˜

- [Spring Cloud ä½¿ç”¨ Dubbo å®ç°è¿œç¨‹è°ƒç”¨ï¼ŒNacos ä½œä¸ºæ³¨å†Œä¸­å¿ƒ](https://github.com/helloworlde/spring-cloud-alibaba-component/blob/master/cloud-dubbo-nacos/README.md)
- [Spring Cloud ä½¿ç”¨ Dubbo å®ç°è¿œç¨‹è°ƒç”¨ï¼ŒZooKeeper ä½œä¸ºæ³¨å†Œä¸­å¿ƒ](https://github.com/helloworlde/spring-cloud-alibaba-component/blob/master/cloud-dubbo-zk/README.md)

### Seata

> Seata æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ï¼Œå¯ä»¥é€šè¿‡ Seata æ¡†æ¶çš„æ³¨è§£å®ç°éä¾µå…¥æ€§çš„åˆ†å¸ƒå¼äº‹åŠ¡

- [Spring Cloud ä½¿ç”¨ Seata å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ - MyBatis](https://github.com/helloworlde/spring-cloud-alibaba-component/blob/master/cloud-seata-mybatis/README.md)
- [Spring Cloud ä½¿ç”¨ Seata å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ - JPA](https://github.com/helloworlde/spring-cloud-alibaba-component/blob/master/cloud-seata-jpa/README.md)
- [Spring Cloud ä½¿ç”¨ Seata å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ - Mybatis/Nacos](https://github.com/helloworlde/spring-cloud-alibaba-component/blob/master/cloud-seata-nacos/README.md)
- [Spring Cloud ä½¿ç”¨ Seata å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ - Mybatis/Nacos/Dubbo](https://github.com/helloworlde/spring-cloud-alibaba-component/blob/master/cloud-seata-dubbo-nacos/README.md)
- [Spring Cloud ä½¿ç”¨ Seata å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ - Mybatis/Eureka/Feign](https://github.com/helloworlde/spring-cloud-alibaba-component/blob/master/cloud-seata-eureka/README.md)
- [Spring Cloud ä½¿ç”¨ Seata å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ - Mybatis å¤šæ•°æ®æº](https://github.com/helloworlde/spring-cloud-alibaba-component/blob/master/cloud-seata-multi-datasource/README.md)
- [Spring Cloud ä½¿ç”¨ Seata å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ - Mybatis å¤šæ•°æ®æº & MyBatisPlus](https://github.com/helloworlde/spring-cloud-alibaba-component/blob/master/cloud-seata-multi-datasource-mybatis-plus/README.md)

MyBatis å’Œ JPA é€šè¿‡ Seata å®ç°åˆ†å¸ƒå¼äº‹åŠ¡éƒ½éœ€è¦æ³¨å…¥ Â `io.seata.rm.datasource.DataSourceProxy`, ä¸åŒçš„æ˜¯ï¼ŒMyBatis è¿˜éœ€è¦é¢å¤–æ³¨å…¥ Â `org.apache.ibatis.session.SqlSessionFactory`

## [cloud-platform](https://gitee.com/geek_qi/cloud-platform)

### æ¶æ„æ‘˜è¦

1. æœåŠ¡é‰´æƒ  
   é€šè¿‡ JWT çš„æ–¹å¼æ¥åŠ å¼ºæœåŠ¡ä¹‹é—´è°ƒåº¦çš„æƒé™éªŒè¯ï¼Œä¿è¯å†…éƒ¨æœåŠ¡çš„å®‰å…¨æ€§ã€‚
2. ç›‘æ§  
   åˆ©ç”¨ Spring Boot Admin æ¥ç›‘æ§å„ä¸ªç‹¬ç«‹ Service çš„è¿è¡ŒçŠ¶æ€ï¼›åˆ©ç”¨ Hystrix Dashboard æ¥å®æ—¶æŸ¥çœ‹æ¥å£çš„è¿è¡ŒçŠ¶æ€å’Œè°ƒç”¨é¢‘ç‡ç­‰ã€‚
3. è´Ÿè½½å‡è¡¡  
   å°†æœåŠ¡ä¿ç•™çš„ rest è¿›è¡Œä»£ç†å’Œç½‘å…³æ§åˆ¶ï¼Œé™¤äº†å¹³å¸¸ç»å¸¸ä½¿ç”¨çš„ node.jsã€nginx å¤–ï¼ŒSpring Cloud ç³»åˆ—çš„ zuul å’Œ ribbonï¼Œå¯ä»¥å¸®æˆ‘ä»¬è¿›è¡Œæ­£å¸¸çš„ç½‘å…³ç®¡æ§å’Œè´Ÿè½½å‡è¡¡ã€‚å…¶ä¸­æ‰©å±•å’Œå€Ÿé‰´å›½å¤–é¡¹ç›®çš„æ‰©å±•åŸºäº JWT çš„ Zuul é™æµæ’ä»¶ï¼Œæ–¹é¢è¿›è¡Œé™æµã€‚
4. æœåŠ¡æ³¨å†Œä¸è°ƒç”¨  
   åŸºäº Nacos æ¥å®ç°çš„æœåŠ¡æ³¨å†Œä¸è°ƒç”¨ï¼Œåœ¨ Spring Cloud ä¸­ä½¿ç”¨ Feign, æˆ‘ä»¬å¯ä»¥åšåˆ°ä½¿ç”¨ HTTP è¯·æ±‚è¿œç¨‹æœåŠ¡æ—¶èƒ½ä¸è°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·çš„ç¼–ç ä½“éªŒï¼Œå¼€å‘è€…å®Œå…¨æ„ŸçŸ¥ä¸åˆ°è¿™æ˜¯è¿œç¨‹æ–¹æ³•ï¼Œæ›´æ„ŸçŸ¥ä¸åˆ°è¿™æ˜¯ä¸ª HTTP è¯·æ±‚ã€‚
5. ç†”æ–­æœºåˆ¶  
   å› ä¸ºé‡‡å–äº†æœåŠ¡çš„åˆ†å¸ƒï¼Œä¸ºäº†é¿å…æœåŠ¡ä¹‹é—´çš„è°ƒç”¨ â€œé›ªå´©â€ï¼Œé‡‡ç”¨äº† Hystrix çš„ä½œä¸ºç†”æ–­å™¨ï¼Œé¿å…äº†æœåŠ¡ä¹‹é—´çš„ â€œé›ªå´©â€ã€‚

## [open-cloud](https://github.com/liuyadu/open-cloud)

### ç®€ä»‹

æ­å»ºåŸºäº OAuth2 çš„å¼€æ”¾å¹³å°ã€ä¸º APP ç«¯ã€åº”ç”¨æœåŠ¡æä¾›ç»Ÿä¸€æ¥å£ç®¡æ§å¹³å°ã€ä¸ºç¬¬ä¸‰æ–¹åˆä½œä¼™ä¼´çš„ä¸šåŠ¡å¯¹æ¥æä¾›æˆä¿¡å¯æ§çš„æŠ€æœ¯å¯¹æ¥å¹³å°

- åˆ†å¸ƒå¼æ¶æ„ï¼ŒNacos (æœåŠ¡æ³¨å†Œ + é…ç½®ä¸­å¿ƒ) ç»Ÿä¸€ç®¡ç†
- ç»Ÿä¸€ API ç½‘å…³ï¼ˆå‚æ•°éªŒç­¾ã€èº«ä»½è®¤è¯ã€æ¥å£é‰´æƒã€æ¥å£è°ƒè¯•ã€æ¥å£é™æµã€æ¥å£çŠ¶æ€ã€æ¥å£å¤–ç½‘è®¿é—®ï¼‰
- ç»Ÿä¸€ oauth2 è®¤è¯åè®®

## [api-boot](https://gitee.com/minbox-projects/api-boot)

## [Moss](https://github.com/SpringCloud/Moss)

[é›†æˆ jetcache](https://www.jianshu.com/p/c3a3a2aee709)  
<https://github.com/bounce5733/eagle-gateway>  
<https://github.com/zhoutaoo/SpringCloud>  
<https://gitee.com/wugou/springcloud-gateway-nacos>  
<https://github.com/alibaba/sca-best-practice>  
<https://github.com/chillzhuang/SpringBlade>  
<https://github.com/chillzhuang/blade-tool>  
<https://github.com/lets-mica/mica>  
<https://github.com/xkcoding/scaffold>  
<https://github.com/xiiiblue/zen-scaffold>  
<https://github.com/MyHerux/spring-boot-2.x-scaffold>  
<https://github.com/sofastack/sofa-tracer>

## [æ·±å…¥ç†è§£Spring Profilesï¼šå®šåˆ¶åŒ–é…ç½®çš„è‰ºæœ¯](https://blog.dong4j.site/posts/278e3e03.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## 1. æ¦‚è¿°

è¿™ç¯‡æ–‡ç« å°†é˜è¿°æ€ä¹ˆåœ¨ Spring ä¸­ä½¿ç”¨ Profile

ä» Spring 3.1 å¼€å§‹ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå°† bean æ˜ å°„åˆ°ä¸åŒçš„ profile ä¸Šï¼Œå¦‚ dev, test, prod ç­‰ã€‚

æˆ‘ä»¬ä¹Ÿèƒ½å¤Ÿæ ¹æ®ç¯å¢ƒ (environment) æ¥æ¿€æ´»ä¸åŒçš„ profileï¼Œä»è€ŒåŠ è½½æˆ‘ä»¬éœ€è¦çš„ beanã€‚

## 2. åœ¨ Bean ä¸Šä½¿ç”¨ Â `@Profile`

æˆ‘ä»¬å…ˆä»ç®€å•çš„ä¾‹å­å¼€å§‹ï¼Œçœ‹çœ‹æ€ä¹ˆæŠŠ bean ç»‘å®šåˆ°ä¸åŒçš„ profile ä¸Šã€‚

ä½¿ç”¨ Â `@Profile`Â  æ³¨è§£ï¼Œæˆ‘ä»¬å¯ä»¥å°† bean ç»‘å®šåˆ°æŒ‡å®šçš„ profile ä¸Šã€‚è¿™ä¸ªæ³¨è§£æ”¯æŒç»‘å®šä¸€ä¸ªæˆ–å¤šä¸ª profileã€‚

è¯•æƒ³è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šæˆ‘ä»¬æœ‰ä¸€ä¸ª beanï¼Œåªåœ¨å¼€å‘ç¯å¢ƒéœ€è¦ï¼Œçº¿ä¸Šç¯å¢ƒä¸éœ€è¦ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡æ³¨è§£å°†è¿™ä¸ª bean ç»‘å®šåˆ° Â `dev profile`Â  ä¸Šã€‚è¿™æ ·ï¼Œè¿™ä¸ª bean åªä¼šå­˜åœ¨äºå¼€å‘ç¯å¢ƒï¼Œè€Œåœ¨å…¶ä»–ç¯å¢ƒä¸­ä¸ä¼šè¢«åŠ è½½ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
@Component
@Profile("dev")
public class DevDatasourceConfig

```

ä¸Šé¢çš„å†™æ³•æ˜¯æŒ‡ç»‘å®š bean åˆ° Â `dev profile`ã€‚å¦‚æœæƒ³ç»‘å®š bean åˆ°é™¤ Â `dev`Â  ä»¥å¤–çš„ profile å‘¢ã€‚å¯ä»¥ä½¿ç”¨ Â **NOT æ“ä½œç¬¦**ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
@Component
@Profile("!dev")
public class DevDatasourceConfig
```

> è¯‘è€…æ³¨ï¼š  
> `@Profile`Â  çš„å£°æ˜å¦‚ä¸‹ï¼š
>
> ```
> public @interface Profile {
>    String[] value();
> }
>
> ```
>
> `value`Â  æ˜¯ä¸ªæ•°ç»„ï¼Œæ”¯æŒå¤šä¸ªå€¼ã€‚ç»‘å®šå¤šä¸ª profileï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
>
> ```
> @Profile(value = {"dev", "test"})
>
> ```

## 3. åœ¨ XML ä¸­å£°æ˜ Profile

é™¤äº†ä½¿ç”¨ Â `@Profile`Â  æ³¨è§£ï¼Œè¿˜å¯ä»¥åœ¨ XML ä¸­ç»‘å®š profileã€‚

`<bean>`Â  æ ‡ç­¾æœ‰ä¸ª Â `profiles`Â  å±æ€§ã€‚å¤šä¸ª profile ä¹‹é—´ä½¿ç”¨é€—å·åˆ†éš”ï¼š

`profileè¿˜æ˜¯profilesï¼Ÿï¼Ÿï¼Ÿ`

```xml
<beans profile="dev">
    <bean id="devDatasourceConfig"
      class="org.baeldung.profiles.DevDatasourceConfig" />
</beans>

```

## 4. è®¾ç½® profile

ä¸Šé¢åªæ˜¯å°† bean å’Œ profile è¿›è¡Œäº†ç»‘å®šï¼Œä¸‹ä¸€æ­¥éœ€è¦è®¾ç½®å’Œæ¿€æ´» profileï¼Œæ‰èƒ½ä½¿ä¸åŒçš„ bean è¢«æ³¨å†Œåˆ°å®¹å™¨ä¸­ã€‚æ–¹æ³•æœ‰å¾ˆå¤šç§ï¼Œä¸‹é¢æ˜¯ä¸€äº›ä¾‹å­ï¼š

### 4.1 ä½¿ç”¨ Â `WebApplicationInitializer`Â interface

è¿™æ˜¯ä¸€ç§ç¼–ç¨‹çš„æ–¹å¼ (ä¸ä¹‹å¯¹åº”æ˜¯é…ç½®æ–¹å¼)

åœ¨ web åº”ç”¨ä¸­ï¼Œ`WebApplicationInitializer`Â  å¯ä»¥è¢«ç”¨æ¥é…ç½® Â `ServletContext`ã€‚

> è¯‘è€…æ³¨ï¼š  
> `WebApplicationInitializer`Â  åœ¨ spring-web ä¸­

æ–¹æ³•å¦‚ä¸‹ï¼š

```java
@Configuration
public class MyWebApplicationInitializer
  implements WebApplicationInitializer {

    @Override
    public void onStartup(ServletContext servletContext) throws ServletException {

        servletContext.setInitParameter(
          "spring.profiles.active", "dev");
    }
}

```

> è¯‘è€…æ³¨ï¼š  
> è¿™ç§æ–¹å¼ï¼Œç›´æ¥æŠŠè¦ç»‘å®šçš„ profile ç¡¬ç¼–ç åˆ°ä»£ç ä¸­ï¼Œæ˜¯éå¸¸ä¸ä¼˜é›…ï¼Œä¹Ÿä¸æ–¹ä¾¿çš„ã€‚

### 4.2 ä½¿ç”¨ Â `ConfigurableEnvironment`

ä½ ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ç¯å¢ƒä¸­è®¾ç½® profile:

```java
@Autowired
private ConfigurableEnvironment env;
...
env.setActiveProfiles("someProfile");
```

> è¯‘è€…æ³¨ï¼š  
> é—®é¢˜åŒ 4.1

### 4.3 åœ¨ Â `web.xml`Â  ä¸­é…ç½®

```xml
<context-param>
    <param-name>contextConfigLocation</param-name>
    <param-value>/WEB-INF/app-config.xml</param-value>
</context-param>
<context-param>
    <param-name>spring.profiles.active</param-name>
    <param-value>dev</param-value>
</context-param>
```

> è¯‘è€…æ³¨ï¼š  
> é—®é¢˜åŒ 4.1ï¼Œ4.2ã€‚ æœ¬äººä¸èµæˆä»»ä½•ç¡¬ç¼–ç çš„æ–¹å¼

### 4.4 é€šè¿‡ JVM å‚æ•°è®¾ç½®

profile çš„åå­—è¿˜å¯ä»¥é€šè¿‡ JVM å‚æ•°çš„æ–¹å¼è®¾ç½®ã€‚åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œæ·»åŠ ç±»ä¼¼å¦‚ä¸‹å‚æ•°ï¼š

`-Dspring.profiles.active=dev`

> è¯‘è€…æ³¨ï¼š  
> å¦‚ Â `java -jar xxx.jar -Dspring.profiles.active=dev`

### 4.5 é€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®

é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ï¼š

`export spring_profiles_active=dev`

### 4.6 Maven Profile

Spring profile ä¹Ÿå¯ä»¥ç»“åˆ maven profile ä½¿ç”¨ï¼Œé€šè¿‡è®¾ç½® Â `spring.profiles.active`Â  å±æ€§ï¼š

```xml
<profiles>
    <profile>
        <id>dev</id>
        <activation>
            <activeByDefault>true</activeByDefault>
        </activation>
        <properties>
            <spring.profiles.active>dev</spring.profiles.active>
        </properties>
    </profile>
    <profile>
        <id>prod</id>
        <properties>
            <spring.profiles.active>prod</spring.profiles.active>
        </properties>
    </profile>
</profiles>
```

åŒæ—¶ï¼Œè¿˜éœ€è¦åœ¨ Â `application.properties`(å¦‚æœä½¿ç”¨ spring boot çš„è¯) ä¸­æ·»åŠ å¦‚ä¸‹è®¾ç½®ï¼š

```java
spring.profiles.active=@spring.profiles.active@

```

å¦å¤–ï¼Œè¿˜éœ€è¦å† Â `pom.xml`Â  æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š

```xml
<build>
    <resources>
        <resource>
            <directory>src/main/resources</directory>
            <filtering>true</filtering>
        </resource>
    </resources>
    ...
</build>
```

> è¯‘è€…æ³¨ï¼š  
> åœ¨ Â `pom.xml`Â  ä¸­æ·»åŠ çš„é…ç½®ï¼Œæ„æ€æ˜¯å¼€å¯å ä½ç¬¦æ›¿æ¢ã€‚å¯å‚è€ƒï¼š[Maven Filtering](https://maven.apache.org/plugins/maven-resources-plugin/examples/filter.html)

ç»“åˆä½¿ç”¨ maven profile åï¼Œå°±å¯ä»¥åœ¨æ‰“åŒ…çš„æ—¶å€™æ¿€æ´»æŸä¸ª profile:

```shell
mvn clean package -Pprod
```

> è¯‘è€…æ³¨ï¼š  
> ä¸ªäººè®¤ä¸ºï¼Œç»“åˆ maven profile çš„è¿™ç§åŠæ³•ï¼Œçµæ´»åº¦æœ€é«˜ï¼Œä¹Ÿæœ€æ–¹ä¾¿ï¼Œæ¨èã€‚

### 4.7 Test ä¸­ä½¿ç”¨ Â `@ActiveProfiles`

åœ¨ test æ—¶ï¼Œå¦‚ä½•æŒ‡å®š profile å‘¢ï¼Ÿä¹Ÿå¾ˆç®€å•ï¼Œé€šè¿‡ Â `@ActiveProfiles`Â  æ³¨è§£å°±å¯ä»¥äº†ã€‚

> @ActiveProfiles("dev")

## 5. é»˜è®¤ profile

å¦‚æœä¸æŒ‡å®šä»»ä½• profileï¼Œé‚£ä¹ˆè¿™ä¸ª bean å°±å±äº Â `default`Â profile

å½“æ²¡æœ‰ä»»ä½• profile è¢«æ¿€æ´»æ—¶ï¼Œspring ä¹Ÿæ”¯æŒè®¾ç½®é»˜è®¤ profileã€‚å°±æ˜¯é€šè¿‡ Â `spring.profiles.default`Â  å‚æ•°ã€‚

## 6. è·å–è¢«æ¿€æ´»çš„ profile

ä¸€æ—¦ profile è¢«æ¿€æ´»ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ Â `Environment`ï¼Œåœ¨è¿è¡Œæ—¶è·å–è¿™äº› profile çš„ä¿¡æ¯ï¼š

```java
public class ProfileManager {
    @Autowired
    Environment environment;

    public void getActiveProfiles() {
        for (final String profileName : environment.getActiveProfiles()) {
            System.out.println("Currently active profile - " + profileName);
        }
    }
}
```

## 7. ä½¿ç”¨ Profile çš„ä¾‹å­

ç†è®ºæ€»æ˜¯æŠ½è±¡çš„ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€äº›ä¾‹å­æ¥æ·±å…¥ç†è§£ã€‚

è¯•æƒ³è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šæˆ‘ä»¬è¦åˆ†åˆ«é’ˆå¯¹å¼€å‘ç¯å¢ƒå’Œçº¿ä¸Šç¯å¢ƒï¼Œå¯¹ datasource è¿›è¡Œè®¾ç½®ã€‚æˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ª Â `DatasourceConfig`Â  æ¥å£ã€‚è¿™ä¸ªæ¥å£éœ€è¦åœ¨ä¸¤ä¸ªç¯å¢ƒä¸­éƒ½è¢«å®ç°ã€‚

```java
public interface DatasourceConfig {
    public void setup();
}
```

å¼€å‘ç¯å¢ƒçš„å®ç°ï¼š

```java
@Component
@Profile("dev")
public class DevDatasourceConfig implements DatasourceConfig {
    @Override
    public void setup() {
        System.out.println("Setting up datasource for DEV environment. ");
    }
}
```

çº¿ä¸Šç¯å¢ƒçš„å®ç°ï¼š

```java
@Component
@Profile("production")
public class ProductionDatasourceConfig implements DatasourceConfig {
    @Override
    public void setup() {
       System.out.println("Setting up datasource for PRODUCTION environment. ");
    }
}
```

ä¸‹é¢æˆ‘ä»¬å†™ä¸ªå•å…ƒæµ‹è¯•ï¼Œå¹¶æ³¨å…¥ Â `DatasourceConfig`ã€‚é‚£ä¹ˆæˆ‘ä»¬é€šè¿‡è®¾ç½®ä¸åŒçš„ profileï¼Œå°±ä¼šåˆ†åˆ«æ³¨å…¥ Â `DevDatasourceConfig`Â bean å’Œ Â `ProductionDatasourceConfig`Â beanã€‚

```java
public class SpringProfilesTest {
    @Autowired
    DatasourceConfig datasourceConfig;

    public void setupDatasource() {
        datasourceConfig.setup();
    }
}
```

å½“ Â `dev`Â profile è¢«æ¿€æ´»çš„æ—¶å€™ï¼Œä¼šæœ‰å¦‚ä¸‹è¾“å‡ºï¼š

> Setting up datasource for DEV environment.

## 8. åœ¨ Spring Boot ä¸­ä½¿ç”¨ Profile

Spring Boot é™¤äº†æ”¯æŒæ‰€æœ‰çš„ profile é…ç½®ï¼Œè¿˜æœ‰æä¾›ä¸€äº›é¢å¤–åŠŸèƒ½ã€‚

`spring.profiles.active`Â  çš„åˆå§‹åŒ–å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾å®š:

```java
spring.profiles.active=dev
```

å½“ç„¶ä¹Ÿå¯ä»¥åœ¨ç¨‹åºä¸­è®¾å®šï¼š

```java
SpringApplication.setAdditionalProfiles("dev");
```

è¿˜å¯ä»¥åœ¨ pom.xml æ–‡ä»¶ä¸­çš„ Â `spring-boot-maven-plugin`Â  ä¸­é…ç½®ï¼š

```xml
<plugins>
    <plugin>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-maven-plugin</artifactId>
        <configuration>
            <profiles>
                <profile>dev</profile>
            </profiles>
        </configuration>
    </plugin>
    ...
</plugins>
```

ç”¨ maven å¯åŠ¨ï¼Œå¯æ‰§è¡Œå‘½ä»¤:

```shell
mvn spring-boot:run
```

ä½†æ˜¯ Spring Boot å¸¦æ¥çš„æœ€é‡è¦çš„ç‰¹æ€§æ˜¯ Â **profile-specific profiles**Â  æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶çš„å‘½åæ–¹å¼éœ€è¦éµå¾ª Â `applications-{profile}.properties`Â  çš„æ ¼å¼ã€‚

ä¸¾ä¸ªä¾‹å­ï¼šæˆ‘ä»¬å¯ä»¥åœ¨å¼€å‘ç¯å¢ƒå’Œçº¿ä¸Šç¯å¢ƒä½¿ç”¨ä¸åŒçš„æ•°æ®åº“ã€‚å¦‚å¼€å‘ç¯å¢ƒä½¿ç”¨ h2ï¼Œçº¿ä¸Šç¯å¢ƒä½¿ç”¨ mysqlã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬åˆ†åˆ«éœ€è¦åˆ›å»ºå¦‚ä¸‹ä¸¤ä¸ªæ–‡ä»¶ï¼š

**application-production.properties**

```java
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/db
spring.datasource.username=root
spring.datasource.password=root
```

**application-dev.properties**

```java
spring.datasource.driver-class-name=org.h2.Driver
spring.datasource.url=jdbc:h2:mem:db;DB_CLOSE_DELAY=-1
spring.datasource.username=sa
spring.datasource.password=sa
```

å¦‚æœæ¿€æ´»çš„ profile æ˜¯ Â `dev`ï¼Œåˆ™ Â **application-dev.properties**Â  é…ç½®æ–‡ä»¶ä¼šè¢«è‡ªåŠ¨åŠ è½½ã€‚å¦‚æœæ¿€æ´»çš„ profile æ˜¯ Â `production`ï¼Œåˆ™ Â **application-production.properties**Â  é…ç½®æ–‡ä»¶ä¼šè¢«åŠ è½½ã€‚

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å°±å¾ˆå®¹æ˜“åœ°é’ˆå¯¹ä¸åŒç¯å¢ƒï¼Œé…ç½®ä¸åŒçš„é…ç½®æ–‡ä»¶ã€‚

## [APIå®‰å…¨ä¹‹é“ï¼šæ·±å…¥è§£æè®¤è¯ã€æˆæƒä¸å‡­è¯](https://blog.dong4j.site/posts/f50183c1.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

äº’è”ç½‘æ˜¯åŸºäº HTTP åè®®æ„å»ºçš„ï¼Œè€Œ HTTP åè®®å› ä¸ºç®€å•æµè¡Œå¼€æ¥ï¼Œä½†æ˜¯ HTTP åè®®æ˜¯æ— çŠ¶æ€ï¼ˆé€šä¿¡å±‚é¢ä¸Šè™šç”µè·¯æ¯”æ•°æ®æŠ¥æ˜‚è´µå¤ªå¤šï¼‰çš„ï¼Œä¸ºæ­¤äººä»¬ä¸ºäº†è¿½è¸ªç”¨æˆ·æƒ³å‡ºäº†å„ç§åŠæ³•ï¼ŒåŒ…æ‹¬ cookie/session æœºåˆ¶ã€tokenã€flash è·¨æµè§ˆå™¨ cookie ç”šè‡³æµè§ˆå™¨æŒ‡çº¹ç­‰ã€‚

![20241229154732_huSD45E2.webp](https://cdn.dong4j.site/source/image/20241229154732_huSD45E2.webp)

æŠŠç”¨æˆ·èº«ä»½è—åœ¨æ¯ä¸€ä¸ªåœ°æ–¹ï¼ˆæµè§ˆå™¨æŒ‡çº¹æŠ€æœ¯ç”šè‡³ä¸éœ€è¦å­˜å‚¨ä»‹è´¨ï¼‰

è®²ä½¿ç”¨ spring security ç­‰å…·ä½“æŠ€æœ¯çš„èµ„æ–™å·²ç»å¾ˆå¤šäº†ï¼Œè¿™ç¯‡æ–‡ç« ä¸æ‰“ç®—å†™æ¡†æ¶å’Œä»£ç çš„å…·ä½“å®ç°ã€‚æˆ‘ä»¬ä¼šè®¨è®ºè®¤è¯å’Œæˆæƒçš„åŒºåˆ«ï¼Œç„¶åä¼šä»‹ç»ä¸€äº›è¢«ä¸šç•Œå¹¿æ³›é‡‡ç”¨çš„æŠ€æœ¯ï¼Œæœ€åä¼šèŠèŠæ€ä¹ˆä¸º API æ„å»ºé€‰æ‹©åˆé€‚çš„è®¤è¯æ–¹å¼ã€‚

### è®¤è¯ã€æˆæƒã€å‡­è¯

é¦–å…ˆï¼Œè®¤è¯å’Œæˆæƒæ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µï¼Œä¸ºäº†è®©æˆ‘ä»¬çš„ API æ›´åŠ å®‰å…¨å’Œå…·æœ‰æ¸…æ™°çš„è®¾è®¡ï¼Œç†è§£è®¤è¯å’Œæˆæƒçš„ä¸åŒå°±éå¸¸æœ‰å¿…è¦äº†ï¼Œå®ƒä»¬åœ¨è‹±æ–‡ä¸­ä¹Ÿæ˜¯ä¸åŒçš„å•è¯ã€‚

![20241229154732_D8H6UYj7.webp](https://cdn.dong4j.site/source/image/20241229154732_D8H6UYj7.webp)

è®¤è¯æ˜¯ authenticationï¼ŒæŒ‡çš„æ˜¯å½“å‰ç”¨æˆ·çš„èº«ä»½ï¼Œå½“ç”¨æˆ·ç™»é™†è¿‡åç³»ç»Ÿä¾¿èƒ½è¿½è¸ªåˆ°ä»–çš„èº«ä»½åšå‡ºç¬¦åˆç›¸åº”ä¸šåŠ¡é€»è¾‘çš„æ“ä½œã€‚å³ä½¿ç”¨æˆ·æ²¡æœ‰ç™»å½•ï¼Œå¤§å¤šæ•°ç³»ç»Ÿä¹Ÿä¼šè¿½è¸ªä»–çš„èº«ä»½ï¼Œåªæ˜¯å½“åšæ¥å®¾æˆ–è€…åŒ¿åç”¨æˆ·æ¥å¤„ç†ã€‚è®¤è¯æŠ€æœ¯è§£å†³çš„æ˜¯ â€œæˆ‘æ˜¯è°ï¼Ÿâ€ çš„é—®é¢˜ã€‚

æˆæƒåˆ™ä¸åŒï¼Œæˆæƒæ˜¯ authorizationï¼ŒæŒ‡çš„æ˜¯ä»€ä¹ˆæ ·çš„èº«ä»½è¢«å…è®¸è®¿é—®æŸäº›èµ„æºï¼Œåœ¨è·å–åˆ°ç”¨æˆ·èº«ä»½åç»§ç»­æ£€æŸ¥ç”¨æˆ·çš„æƒé™ã€‚å•ä¸€çš„ç³»ç»Ÿæˆæƒå¾€å¾€æ˜¯ä¼´éšè®¤è¯æ¥å®Œæˆçš„ï¼Œä½†æ˜¯åœ¨å¼€æ”¾ API çš„å¤šç³»ç»Ÿç»“æ„ä¸‹ï¼Œæˆæƒå¯ä»¥ç”±ä¸åŒçš„ç³»ç»Ÿæ¥å®Œæˆï¼Œä¾‹å¦‚ OAuthã€‚æˆæƒæŠ€æœ¯æ˜¯è§£å†³ â€œæˆ‘èƒ½åšä»€ä¹ˆï¼Ÿâ€ çš„é—®é¢˜ã€‚

å®ç°è®¤è¯å’Œæˆæƒçš„åŸºç¡€æ˜¯éœ€è¦ä¸€ç§åª’ä»‹ï¼ˆcredentialsï¼‰æ¥æ ‡è®°è®¿é—®è€…çš„èº«ä»½æˆ–æƒåˆ©ï¼Œåœ¨ç°å®ç”Ÿæ´»ä¸­æ¯ä¸ªäººéƒ½éœ€è¦ä¸€å¼ èº«ä»½è¯æ‰èƒ½è®¿é—®è‡ªå·±çš„é“¶è¡Œè´¦æˆ·ã€ç»“å©šå’ŒåŠç†å…»è€ä¿é™©ç­‰ï¼Œè¿™å°±æ˜¯è®¤è¯çš„å‡­è¯ï¼›åœ¨å¤ä»£å†›äº‹æ´»åŠ¨ä¸­ï¼Œçš‡å¸ä¼šç»™å‡ºæˆ˜çš„å°†å†›é¢å‘å…µç¬¦ï¼Œä¸‹çº§å°†é¢†ä¸å…³å¿ƒæŒæœ‰å…µç¬¦çš„äººï¼Œåªéœ€è¦æ‰§è¡Œå…µç¬¦å¯¹åº”çš„å‘½ä»¤å³å¯ã€‚åœ¨äº’è”ç½‘ä¸–ç•Œä¸­ï¼ŒæœåŠ¡å™¨ä¸ºæ¯ä¸€ä¸ªè®¿é—®è€…é¢å‘ session ID å­˜æ”¾åˆ° cookieï¼Œè¿™å°±æ˜¯ä¸€ç§å‡­è¯æŠ€æœ¯ã€‚æ•°å­—å‡­è¯è¿˜è¡¨ç°åœ¨æ–¹æ–¹é¢é¢ï¼ŒSSH ç™»å½•çš„å¯†åŒ™ã€JWT ä»¤ç‰Œã€ä¸€æ¬¡æ€§å¯†ç ç­‰ã€‚

ç”¨æˆ·è´¦æˆ·ä¹Ÿä¸ä¸€å®šæ˜¯å­˜æ”¾åœ¨æ•°æ®åº“ä¸­çš„ä¸€å¼ è¡¨ï¼Œåœ¨ä¸€äº›ä¼ä¸š IT ç³»ç»Ÿä¸­ï¼Œå¯¹è´¦æˆ·ç®¡ç†å’Œæƒé™æœ‰äº†æ›´å¤šçš„è¦æ±‚ã€‚æ‰€ä»¥è´¦æˆ·æŠ€æœ¯ ï¼ˆaccountingï¼‰å¯ä»¥å¸®åŠ©æˆ‘ä»¬ä½¿ç”¨ä¸åŒçš„æ–¹å¼ç®¡ç†ç”¨æˆ·è´¦æˆ·ï¼ŒåŒæ—¶å…·æœ‰ä¸åŒç³»ç»Ÿä¹‹é—´å…±äº«è´¦æˆ·çš„èƒ½åŠ›ã€‚ä¾‹å¦‚å¾®è½¯çš„æ´»åŠ¨ç›®å½•ï¼ˆADï¼‰ï¼Œä»¥åŠç®€å•ç›®å½•è®¿é—®åè®®ï¼ˆLDAPï¼‰ï¼Œç”šè‡³åŒºå—é“¾æŠ€æœ¯ã€‚

è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µæ˜¯è®¿é—®æ§åˆ¶ç­–ç•¥ï¼ˆACï¼‰ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦æŠŠèµ„æºçš„æƒé™åˆ’åˆ†åˆ°ä¸€ä¸ªå¾ˆç»†çš„ç²’åº¦ï¼Œå°±ä¸å¾—ä¸è€ƒè™‘ç”¨æˆ·ä»¥ä½•ç§èº«ä»½æ¥è®¿é—®å—é™çš„èµ„æºï¼Œé€‰æ‹©åŸºäºè®¿é—®æ§åˆ¶åˆ—è¡¨ï¼ˆACLï¼‰è¿˜æ˜¯åŸºäºç”¨æˆ·è§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰æˆ–è€…å…¶ä»–è®¿é—®æ§åˆ¶ç­–ç•¥ã€‚

åœ¨æµè¡Œçš„æŠ€æœ¯å’Œæ¡†æ¶ä¸­ï¼Œè¿™äº›æ¦‚å¿µéƒ½æ— æ³•å­¤ç«‹çš„è¢«å®ç°ï¼Œå› æ­¤åœ¨ç°å®ä¸­ä½¿ç”¨è¿™äº›æŠ€æœ¯æ—¶ï¼Œå¤§å®¶å¾€å¾€ä¸ºä¸€ä¸ª OAuth2 æ˜¯è®¤è¯è¿˜æ˜¯æˆæƒè¿™ç§æ¦‚å¿µäº‰è®ºä¸ä¼‘ã€‚ä¸ºäº†å®¹æ˜“ç†è§£ï¼Œæˆ‘åœ¨æ–‡æœ«é™„ä¸Šäº†ä¸€ä»½å¸¸è§æŠ€æœ¯å’Œæ¦‚å¿µçš„æœ¯è¯­è¡¨ã€‚ä¸‹é¢æˆ‘ä¼šä»‹ç»åœ¨ API å¼€å‘ä¸­å¸¸å¸¸ä½¿ç”¨çš„å‡ ç§è®¤è¯å’ŒæˆæƒæŠ€æœ¯ï¼šHTTP Basic AUthenticationã€HAMCã€OAuth2ï¼Œä»¥åŠå‡­è¯æŠ€æœ¯ JWT tokenã€‚

### HTTP Basic Authentication

ä½ ä¸€å®šç”¨è¿‡è¿™ç§æ–¹å¼ï¼Œä½†ä¸ä¸€å®šçŸ¥é“å®ƒæ˜¯ä»€ä¹ˆï¼Œåœ¨ä¸ä¹…ä¹‹å‰ï¼Œå½“ä½ è®¿é—®ä¸€å°å®¶ç”¨è·¯ç”±å™¨çš„ç®¡ç†ç•Œé¢ï¼Œå¾€å¾€ä¼šçœ‹åˆ°ä¸€ä¸ªæµè§ˆå™¨å¼¹å‡ºè¡¨å•ï¼Œè¦æ±‚ä½ è¾“å…¥ç”¨æˆ·å¯†ç ã€‚

![20241229154732_bErP0pMh.webp](https://cdn.dong4j.site/source/image/20241229154732_bErP0pMh.webp)

åœ¨è¿™èƒŒåï¼Œå½“ç”¨æˆ·è¾“å…¥å®Œç”¨æˆ·åå¯†ç åï¼Œæµè§ˆå™¨å¸®ä½ åšäº†ä¸€ä¸ªéå¸¸ç®€å•çš„æ“ä½œ:

1. ç»„åˆç”¨æˆ·åå’Œå¯†ç ç„¶å Base64 ç¼–ç 
2. ç»™ç¼–ç åçš„å­—ç¬¦ä¸²æ·»åŠ  Basic å‰ç¼€ï¼Œç„¶åè®¾ç½®åç§°ä¸º Authorization çš„ header å¤´éƒ¨

![20241229154732_C3NFqgST.webp](https://cdn.dong4j.site/source/image/20241229154732_C3NFqgST.webp)

API ä¹Ÿå¯ä»¥éå¸¸ç®€å•çš„æä¾› HTTP Basic Authentication è®¤è¯æ–¹å¼ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å¯ä»¥å¾ˆç®€å•é€šè¿‡ Base64 ä¼ è¾“ç”¨æˆ·åå’Œå¯†ç å³å¯:

1. å°†ç”¨æˆ·åå’Œå¯†ç ä½¿ç”¨å†’å·è¿æ¥ï¼Œä¾‹å¦‚ username:abc123456
2. ä¸ºäº†é˜²æ­¢ç”¨æˆ·åæˆ–è€…å¯†ç ä¸­å­˜åœ¨è¶…å‡º ASCII ç èŒƒå›´çš„å­—ç¬¦ï¼Œæ¨èä½¿ç”¨ UTF-8 ç¼–ç 
3. å°†ä¸Šé¢çš„å­—ç¬¦ä¸²ä½¿ç”¨ Base 64 ç¼–ç ï¼Œä¾‹å¦‚ dXNlcm5hbWU6YWJjMTIzNDU2
4. åœ¨ HTTP è¯·æ±‚å¤´ä¸­åŠ å…¥ â€œBasic + ç¼–ç åçš„å­—ç¬¦ä¸²â€ï¼Œå³ï¼šAuthorization: Basic QWxhZGRpbjpPcGVuU2VzYW1l

è¿™ç§æ–¹å¼å®ç°èµ·æ¥éå¸¸ç®€å•ï¼Œåœ¨å¤§é‡åœºæ™¯ä¸‹è¢«é‡‡ç”¨ã€‚å½“ç„¶ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼ŒBase64 åªèƒ½ç§°ä¸ºç¼–ç ï¼Œè€Œä¸æ˜¯åŠ å¯† (å®é™…ä¸Šæ— éœ€é…ç½®å¯†åŒ™çš„å®¢æˆ·ç«¯å¹¶æ²¡æœ‰ä»»ä½•å¯é åœ°åŠ å¯†æ–¹å¼ï¼Œæˆ‘ä»¬éƒ½ä¾èµ– TSL åè®®)ã€‚è¿™ç§æ–¹å¼çš„è‡´å‘½å¼±ç‚¹æ˜¯ç¼–ç åçš„å¯†ç å¦‚æœæ˜æ–‡ä¼ è¾“åˆ™å®¹æ˜“åœ¨ç½‘ç»œä¼ è¾“ä¸­æ³„éœ²ï¼Œåœ¨å¯†ç ä¸ä¼šè¿‡æœŸçš„æƒ…å†µä¸‹ï¼Œå¯†ç ä¸€æ—¦æ³„éœ²ï¼Œåªèƒ½é€šè¿‡ä¿®æ”¹å¯†ç çš„æ–¹å¼ã€‚

### HMACï¼ˆAK/SKï¼‰è®¤è¯

åœ¨æˆ‘ä»¬å¯¹æ¥ä¸€äº› PASS å¹³å°å’Œæ”¯ä»˜å¹³å°æ—¶ï¼Œä¼šè¦æ±‚æˆ‘ä»¬é¢„å…ˆç”Ÿæˆä¸€ä¸ª access keyï¼ˆAKï¼‰ å’Œ secure keyï¼ˆSKï¼‰ï¼Œç„¶åé€šè¿‡ç­¾åçš„æ–¹å¼å®Œæˆè®¤è¯è¯·æ±‚ï¼Œè¿™ç§æ–¹å¼å¯ä»¥é¿å…ä¼ è¾“ secure keyï¼Œä¸”å¤§å¤šæ•°æƒ…å†µä¸‹ç­¾ååªå…è®¸ä½¿ç”¨ä¸€æ¬¡ï¼Œé¿å…äº†é‡æ”¾æ”»å‡»ã€‚

è¿™ç§åŸºäº AK/SK çš„è®¤è¯æ–¹å¼ä¸»è¦æ˜¯åˆ©ç”¨æ•£åˆ—çš„æ¶ˆæ¯è®¤è¯ç  (Hash-based MessageAuthentication Code) æ¥å®ç°çš„ï¼Œå› æ­¤æœ‰å¾ˆå¤šåœ°æ–¹å« HMAC è®¤è¯ï¼Œå®é™…ä¸Šä¸æ˜¯éå¸¸å‡†ç¡®ã€‚HMAC åªæ˜¯åˆ©ç”¨å¸¦æœ‰ key å€¼çš„å“ˆå¸Œç®—æ³•ç”Ÿæˆæ¶ˆæ¯æ‘˜è¦ï¼Œåœ¨è®¾è®¡ API æ—¶æœ‰å…·ä½“ä¸åŒçš„å®ç°ã€‚

![20241229154732_PQgm77Vd.webp](https://cdn.dong4j.site/source/image/20241229154732_PQgm77Vd.webp)

HMAC åœ¨ä½œä¸ºç½‘ç»œé€šä¿¡çš„è®¤è¯è®¾è®¡ä¸­ä½œä¸ºå‡­è¯ç”Ÿæˆç®—æ³•ä½¿ç”¨ï¼Œé¿å…äº†å£ä»¤ç­‰æ•æ„Ÿä¿¡æ¯åœ¨ç½‘ç»œä¸­ä¼ è¾“ã€‚åŸºæœ¬è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. å®¢æˆ·ç«¯éœ€è¦åœ¨è®¤è¯æœåŠ¡å™¨ä¸­é¢„å…ˆè®¾ç½® access keyï¼ˆAK æˆ–å« app IDï¼‰ å’Œ secure keyï¼ˆSKï¼‰
2. åœ¨è°ƒç”¨ API æ—¶ï¼Œå®¢æˆ·ç«¯éœ€è¦å¯¹å‚æ•°å’Œ access key è¿›è¡Œè‡ªç„¶æ’åºåå¹¶ä½¿ç”¨ secure key è¿›è¡Œç­¾åç”Ÿæˆä¸€ä¸ªé¢å¤–çš„å‚æ•° digest
3. æœåŠ¡å™¨æ ¹æ®é¢„å…ˆè®¾ç½®çš„ secure key è¿›è¡ŒåŒæ ·çš„æ‘˜è¦è®¡ç®—ï¼Œå¹¶è¦æ±‚ç»“æœå®Œå…¨ä¸€è‡´
4. **æ³¨æ„ secure key ä¸èƒ½åœ¨ç½‘ç»œä¸­ä¼ è¾“ï¼Œä»¥åŠåœ¨ä¸å—ä¿¡ä»»çš„ä½ç½®å­˜æ”¾ï¼ˆæµè§ˆå™¨ç­‰ï¼‰**

ä¸ºäº†è®©æ¯ä¸€æ¬¡è¯·æ±‚çš„ç­¾åå˜å¾—ç‹¬ä¸€æ— äºŒï¼Œä»è€Œå®ç°é‡æ”¾æ”»å‡»ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç­¾åæ—¶æ”¾å…¥ä¸€äº›å¹²æ‰°ä¿¡æ¯ã€‚

åœ¨ä¸šç•Œæ ‡å‡†ä¸­æœ‰ä¸¤ç§å…¸å‹çš„åšæ³•ï¼Œè´¨ç–‘ / åº”ç­”ç®—æ³•ï¼ˆOCRA: OATH Challenge-Response Algorithmï¼‰ã€åŸºäºæ—¶é—´çš„ä¸€æ¬¡æ€§å¯†ç ç®—æ³•ï¼ˆTOTPï¼šTime-based One-time Password Algorithmï¼‰ã€‚

#### è´¨ç–‘ / åº”ç­”ç®—æ³•

è´¨ç–‘ / åº”ç­”ç®—æ³•éœ€è¦å®¢æˆ·ç«¯å…ˆè¯·æ±‚ä¸€æ¬¡æœåŠ¡å™¨ï¼Œè·å¾—ä¸€ä¸ª 401 æœªè®¤è¯çš„è¿”å›ï¼Œå¹¶å¾—åˆ°ä¸€ä¸ªéšæœºå­—ç¬¦ä¸²ï¼ˆnonceï¼‰ã€‚å°† nonce é™„åŠ åˆ°æŒ‰ç…§ä¸Šé¢è¯´åˆ°çš„æ–¹æ³•è¿›è¡Œ HMAC ç­¾åï¼ŒæœåŠ¡å™¨ä½¿ç”¨é¢„å…ˆåˆ†é…çš„ nonce åŒæ ·è¿›è¡Œç­¾åæ ¡éªŒï¼Œè¿™ä¸ª nonce åœ¨æœåŠ¡å™¨åªä¼šè¢«ä½¿ç”¨ä¸€æ¬¡ï¼Œå› æ­¤å¯ä»¥æä¾›å”¯ä¸€çš„æ‘˜è¦ã€‚

![20241229154732_fdBO55EI.webp](https://cdn.dong4j.site/source/image/20241229154732_fdBO55EI.webp)

#### åŸºäºæ—¶é—´çš„ä¸€æ¬¡æ€§å¯†ç è®¤è¯

ä¸ºäº†é¿å…é¢å¤–çš„è¯·æ±‚æ¥è·å– nonceï¼Œè¿˜æœ‰ä¸€ç§ç®—æ³•æ˜¯ä½¿ç”¨æ—¶é—´æˆ³ï¼Œå¹¶ä¸”é€šè¿‡åŒæ­¥æ—¶é—´çš„æ–¹å¼åå•†åˆ°ä¸€è‡´ï¼Œåœ¨ä¸€å®šçš„æ—¶é—´çª—å£å†…æœ‰æ•ˆï¼ˆ1 åˆ†é’Ÿå·¦å³ï¼‰ã€‚

![20241229154732_izhcSRpQ.webp](https://cdn.dong4j.site/source/image/20241229154732_izhcSRpQ.webp)

è¿™é‡Œçš„åªæ˜¯åˆ©ç”¨æ—¶é—´æˆ³ä½œä¸ºéªŒè¯çš„æ—¶é—´çª—å£ï¼Œå¹¶ä¸èƒ½ä¸¥æ ¼çš„ç®—ä½œåŸºäºæ—¶é—´çš„ä¸€æ¬¡æ€§å¯†ç ç®—æ³•ã€‚æ ‡å‡†çš„åŸºäºæ—¶é—´çš„ä¸€æ¬¡æ€§å¯†ç ç®—æ³•åœ¨ä¸¤æ­¥éªŒè¯ä¸­è¢«å¤§é‡ä½¿ç”¨ï¼Œä¾‹å¦‚ Google èº«ä»½éªŒè¯å™¨ä¸éœ€è¦ç½‘ç»œé€šä¿¡ä¹Ÿèƒ½å®ç°éªŒè¯ï¼ˆä½†ä¾èµ–å‡†ç¡®çš„æˆæ—¶æœåŠ¡ï¼‰ã€‚åŸç†æ˜¯å®¢æˆ·ç«¯æœåŠ¡å™¨å…±äº«å¯†é’¥ç„¶åæ ¹æ®æ—¶é—´çª—å£èƒ½é€šè¿‡ HMAC ç®—æ³•è®¡ç®—å‡ºä¸€ä¸ªç›¸åŒçš„éªŒè¯ç ã€‚

![20241229154732_vtsJa0Ul.webp](https://cdn.dong4j.site/source/image/20241229154732_vtsJa0Ul.webp)

TOTP åŸºæœ¬åŸç†å’Œå¸¸è§å‚å•†

### OAuth2 å’Œ Open ID

OAuthï¼ˆå¼€æ”¾æˆæƒï¼‰æ˜¯ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œå…è®¸ç”¨æˆ·æˆæƒç¬¬ä¸‰æ–¹ç½‘ç«™è®¿é—®ä»–ä»¬å­˜å‚¨åœ¨å¦å¤–çš„æœåŠ¡æä¾›è€…ä¸Šçš„ä¿¡æ¯ï¼Œè€Œä¸éœ€è¦å°†ç”¨æˆ·åå’Œå¯†ç æä¾›ç»™ç¬¬ä¸‰æ–¹ç½‘ç«™æˆ–åˆ†äº«ä»–ä»¬æ•°æ®çš„æ‰€æœ‰å†…å®¹ã€‚

OAuth æ˜¯ä¸€ä¸ªæˆæƒæ ‡å‡†ï¼Œè€Œä¸æ˜¯è®¤è¯æ ‡å‡†ã€‚æä¾›èµ„æºçš„æœåŠ¡å™¨ä¸éœ€è¦çŸ¥é“ç¡®åˆ‡çš„ç”¨æˆ·èº«ä»½ï¼ˆsessionï¼‰ï¼Œåªéœ€è¦éªŒè¯æˆæƒæœåŠ¡å™¨æˆäºˆçš„æƒé™ï¼ˆtokenï¼‰å³å¯ã€‚

![20241229154732_odCaq0n1.webp](https://cdn.dong4j.site/source/image/20241229154732_odCaq0n1.webp)

ä¸Šå›¾åªæ˜¯ OAuth çš„ä¸€ä¸ªç®€åŒ–æµç¨‹ï¼ŒOAuth çš„åŸºæœ¬æ€è·¯å°±æ˜¯é€šè¿‡æˆæƒæœåŠ¡å™¨è·å– access token å’Œ refresh tokenï¼ˆrefresh token ç”¨äºé‡æ–°åˆ·æ–° access tokenï¼‰ï¼Œç„¶åé€šè¿‡ access token ä»èµ„æºæœåŠ¡å™¨è·å–æ•°æ® ã€‚åœ¨ç‰¹å®šçš„åœºæ™¯ä¸‹è¿˜æœ‰ä¸‹é¢å‡ ç§æ¨¡å¼ï¼š

1. æˆæƒç æ¨¡å¼ï¼ˆauthorization codeï¼‰
2. ç®€åŒ–æ¨¡å¼ï¼ˆimplicitï¼‰
3. å¯†ç æ¨¡å¼ï¼ˆresource owner password credentialsï¼‰
4. å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆclient credentialsï¼‰

å¦‚æœéœ€è¦è·å–ç”¨æˆ·çš„è®¤è¯ä¿¡æ¯ï¼ŒOAuth æœ¬èº«æ²¡æœ‰å®šä¹‰è¿™éƒ¨åˆ†å†…å®¹ï¼Œå¦‚æœéœ€è¦è¯†åˆ«ç”¨æˆ·ä¿¡æ¯ï¼Œåˆ™éœ€è¦å€ŸåŠ©å¦å¤–çš„è®¤è¯å±‚ï¼Œä¾‹å¦‚ OpenID Connectã€‚

#### éªŒè¯ access token

åœ¨ä¸€äº›ä»‹ç» OAuth çš„åšå®¢ä¸­å¾ˆå°‘è®²åˆ°èµ„æºæœåŠ¡å™¨æ˜¯æ€ä¹ˆéªŒè¯ access token çš„ã€‚OAuth core æ ‡å‡†å¹¶æ²¡æœ‰å®šä¹‰è¿™éƒ¨åˆ†ï¼Œä¸è¿‡åœ¨ OAuth å…¶ä»–æ ‡å‡†æ–‡ä»¶ä¸­æåˆ°ä¸¤ç§éªŒè¯ access token çš„æ–¹å¼ã€‚

1. åœ¨å®Œæˆæˆæƒæµç¨‹åï¼Œèµ„æºæœåŠ¡å™¨å¯ä»¥ä½¿ç”¨ OAuth æœåŠ¡å™¨æä¾›çš„ Introspection æ¥å£æ¥éªŒè¯ access tokenï¼ŒOAuth æœåŠ¡å™¨ä¼šè¿”å› access token çš„çŠ¶æ€ä»¥åŠè¿‡æœŸæ—¶é—´ã€‚åœ¨ OAuth æ ‡å‡†ä¸­éªŒè¯ token çš„æœ¯è¯­æ˜¯ Introspectionã€‚åŒæ—¶ä¹Ÿéœ€è¦æ³¨æ„ access token æ˜¯ç”¨æˆ·å’Œèµ„æºæœåŠ¡å™¨ä¹‹é—´çš„å‡­è¯ï¼Œä¸æ˜¯èµ„æºæœåŠ¡å™¨å’ŒæˆæƒæœåŠ¡å™¨ä¹‹é—´çš„å‡­è¯ã€‚èµ„æºæœåŠ¡å™¨å’ŒæˆæƒæœåŠ¡å™¨ä¹‹é—´åº”è¯¥ä½¿ç”¨é¢å¤–çš„è®¤è¯ï¼ˆä¾‹å¦‚ Basic è®¤è¯ï¼‰ã€‚
2. ä½¿ç”¨ JWT éªŒè¯ã€‚æˆæƒæœåŠ¡å™¨ä½¿ç”¨ç§é’¥ç­¾å‘ JWT å½¢å¼çš„ access tokenï¼Œèµ„æºæœåŠ¡å™¨éœ€è¦ä½¿ç”¨é¢„å…ˆé…ç½®çš„å…¬é’¥æ ¡éªŒ JWT tokenï¼Œå¹¶å¾—åˆ° token çŠ¶æ€å’Œä¸€äº›è¢«åŒ…å«åœ¨ access token ä¸­ä¿¡æ¯ã€‚å› æ­¤åœ¨ JWT çš„æ–¹æ¡ˆä¸‹ï¼Œèµ„æºæœåŠ¡å™¨å’ŒæˆæƒæœåŠ¡å™¨ä¸å†éœ€è¦é€šä¿¡ï¼Œåœ¨ä¸€äº›åœºæ™¯ä¸‹å¸¦æ¥å·¨å¤§çš„ä¼˜åŠ¿ã€‚åŒæ—¶ JWT ä¹Ÿæœ‰ä¸€äº›å¼±ç‚¹ï¼Œæˆ‘ä¼šåœ¨ JWT çš„éƒ¨åˆ†è§£é‡Šã€‚

#### refresh token å’Œ access token

å‡ ä¹æ‰€æœ‰äººåˆšå¼€å§‹äº†è§£ OAuth æ—¶éƒ½æœ‰ä¸€ä¸ªä¸€ç–‘é—®ï¼Œä¸ºä»€ä¹ˆå·²ç»æœ‰äº† access token è¿˜éœ€è¦ refresh token å‘¢ï¼Ÿ

æˆæƒæœåŠ¡å™¨ä¼šåœ¨ç¬¬ä¸€æ¬¡æˆæƒè¯·æ±‚æ—¶ä¸€èµ·è¿”å› access token å’Œ refresh tokenï¼Œåœ¨åé¢åˆ·æ–° access token æ—¶åªéœ€è¦ refresh tokenã€‚ access token å’Œ refresh token çš„è®¾è®¡æ„å›¾æ˜¯ä¸ä¸€æ ·çš„ï¼Œaccess token è¢«è®¾è®¡ç”¨æ¥å®¢æˆ·ç«¯å’Œèµ„æºæœåŠ¡å™¨ä¹‹é—´äº¤äº’ï¼Œè€Œ refresh token æ˜¯è¢«è®¾è®¡ç”¨æ¥å®¢æˆ·ç«¯å’ŒæˆæƒæœåŠ¡å™¨ä¹‹é—´äº¤äº’ã€‚

æŸäº›æˆæƒæ¨¡å¼ä¸‹ access token éœ€è¦æš´éœ²ç»™æµè§ˆå™¨ï¼Œå……å½“ä¸€ä¸ªèµ„æºæœåŠ¡å™¨å’Œæµè§ˆå™¨ä¹‹é—´çš„ä¸´æ—¶ä¼šè¯ï¼Œæµè§ˆå™¨å’Œèµ„æºæœåŠ¡å™¨ä¹‹é—´ä¸å­˜åœ¨ç­¾åæœºåˆ¶ï¼Œaccess token æˆä¸ºå”¯ä¸€å‡­è¯ï¼Œå› æ­¤ access token çš„è¿‡æœŸæ—¶é—´ï¼ˆTTLï¼‰åº”è¯¥å°½é‡çŸ­ï¼Œä»è€Œé¿å…ç”¨æˆ·çš„ access token è¢«å—…æ¢æ”»å‡»ã€‚

ç”±äºè¦æ±‚ access token æ—¶é—´å¾ˆçŸ­ï¼Œrefresh token å¯ä»¥å¸®åŠ©ç”¨æˆ·ç»´æŠ¤ä¸€ä¸ªè¾ƒé•¿æ—¶é—´çš„çŠ¶æ€ï¼Œé¿å…é¢‘ç¹é‡æ–°æˆæƒã€‚å¤§å®¶ä¼šè§‰å¾—è®© access token ä¿æŒä¸€ä¸ªé•¿çš„è¿‡æœŸæ—¶é—´ä¸å°±å¯ä»¥äº†å—ï¼Ÿå®é™…ä¸Š refresh token å’Œ access token çš„ä¸åŒä¹‹å¤„åœ¨äºå³ä½¿ refresh token è¢«æˆªè·ï¼Œç³»ç»Ÿä¾ç„¶æ˜¯å®‰å…¨çš„ï¼Œå®¢æˆ·ç«¯æ‹¿ç€ refresh token å»è·å– access token æ—¶åŒæ—¶éœ€è¦é¢„å…ˆé…ç½®çš„ secure keyï¼Œå®¢æˆ·ç«¯å’ŒæˆæƒæœåŠ¡å™¨ä¹‹å‰å§‹ç»ˆå­˜åœ¨å®‰å…¨çš„è®¤è¯ã€‚

#### OAuthã€Open IDã€OpenID Connect

è®¤è¯æ–¹é¢çš„æœ¯è¯­å®åœ¨å¤ªå¤šï¼Œæˆ‘åœ¨æ­å»ºè‡ªå·±çš„è®¤è¯æœåŠ¡å™¨æˆ–æ¥å…¥ç¬¬ä¸‰æ–¹è®¤è¯å¹³å°æ—¶ï¼Œæœ‰æ—¶å€™åˆ°å®Œæˆå¼€å‘å·¥ä½œçš„æœ€åä¸€åˆ»éƒ½æ— æ³•ç†è§£è¿™äº›æœ¯è¯­ã€‚

OAuth è´Ÿè´£è§£å†³åˆ†å¸ƒå¼ç³»ç»Ÿä¹‹é—´çš„æˆæƒé—®é¢˜ï¼Œå³ä½¿æœ‰æ—¶å€™å®¢æˆ·ç«¯å’Œèµ„æºæœåŠ¡å™¨æˆ–è€…è®¤è¯æœåŠ¡å™¨å­˜åœ¨åŒä¸€å°æœºå™¨ä¸Šã€‚OAuth æ²¡æœ‰è§£å†³è®¤è¯çš„é—®é¢˜ï¼Œä½†æä¾›äº†è‰¯å¥½çš„è®¾è®¡åˆ©äºå’Œç°æœ‰çš„è®¤è¯ç³»ç»Ÿå¯¹æ¥ã€‚

Open ID è§£å†³çš„é—®é¢˜æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¹‹é—´èº«ä»½è®¤è¯é—®é¢˜ï¼Œä½¿ç”¨ Open ID token èƒ½åœ¨å¤šä¸ªç³»ç»Ÿä¹‹é—´éªŒè¯ç”¨æˆ·ï¼Œä»¥åŠè¿”å›ç”¨æˆ·ä¿¡æ¯ï¼Œå¯ä»¥ç‹¬ç«‹ä½¿ç”¨ï¼Œä¸ OAuth æ²¡æœ‰å…³è”ã€‚

OpenID Connect è§£å†³çš„æ˜¯åœ¨ OAuth è¿™å¥—ä½“ç³»ä¸‹çš„ç”¨æˆ·è®¤è¯é—®é¢˜ï¼Œå®ç°çš„åŸºæœ¬åŸç†æ˜¯å°†ç”¨æˆ·çš„è®¤è¯ä¿¡æ¯ï¼ˆID tokenï¼‰å½“åšèµ„æºå¤„ç†ã€‚åœ¨ OAuth æ¡†æ¶ä¸‹å®Œæˆæˆæƒåï¼Œå†é€šè¿‡ access token è·å–ç”¨æˆ·çš„èº«ä»½ã€‚

è¿™ä¸‰ä¸ªæ¦‚å¿µä¹‹é—´çš„å…³ç³»æœ‰ç‚¹éš¾ä»¥ç†è§£ï¼Œç”¨ç°å®åœºæ™¯æ¥è¯´ï¼Œå¦‚æœç³»ç»Ÿä¸­éœ€è¦ä¸€å¥—ç‹¬ç«‹çš„è®¤è¯ç³»ç»Ÿï¼Œå¹¶ä¸éœ€è¦å¤šç³»ç»Ÿä¹‹é—´çš„æˆæƒå¯ä»¥ç›´æ¥é‡‡ç”¨ Open IDã€‚å¦‚æœä½¿ç”¨äº† OAuth ä½œä¸ºæˆæƒæ ‡å‡†ï¼Œå¯ä»¥å†é€šè¿‡ OpenID Connect æ¥å®Œæˆç”¨æˆ·çš„è®¤è¯ã€‚

### JWT

åœ¨ OAuth ç­‰åˆ†å¸ƒå¼çš„è®¤è¯ã€æˆæƒä½“ç³»ä¸‹ï¼Œå¯¹å‡­è¯æŠ€æœ¯æœ‰äº†æ›´å¤šçš„è¦æ±‚ï¼Œæ¯”å¦‚åŒ…å«ç”¨æˆ· IDã€è¿‡æœŸç­‰ä¿¡æ¯ï¼Œä¸éœ€è¦å†å¤–éƒ¨å­˜å‚¨ä¸­å…³è”ã€‚å› æ­¤ä¸šç•Œå¯¹ token åšäº†è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œè®¾è®¡äº†ä¸€ç§è‡ªåŒ…å«ä»¤ç‰Œï¼Œä»¤ç‰Œç­¾å‘åæ— éœ€ä»æœåŠ¡å™¨å­˜å‚¨ä¸­æ£€æŸ¥æ˜¯å¦åˆæ³•ï¼Œé€šè¿‡è§£æä»¤ç‰Œå°±èƒ½è·å–ä»¤ç‰Œçš„è¿‡æœŸã€æœ‰æ•ˆç­‰ä¿¡æ¯ï¼Œè¿™å°±æ˜¯ JWT ï¼ˆJSON Web Tokenï¼‰ã€‚

JWT æ˜¯ä¸€ç§åŒ…å«ä»¤ç‰Œï¼ˆself-contained tokenï¼‰ï¼Œæˆ–è€…å«å€¼ä»¤ç‰Œ ï¼ˆvalue tokenï¼‰ï¼Œæˆ‘ä»¬ä»¥å‰ä½¿ç”¨å…³è”åˆ° session ä¸Šçš„ hash å€¼è¢«å«åšå¼•ç”¨ä»¤ç‰Œï¼ˆreference tokenï¼‰ã€‚

![20241229154732_VHELIyKJ.webp](https://cdn.dong4j.site/source/image/20241229154732_VHELIyKJ.webp)

ç®€è€Œè¨€ä¹‹ï¼Œä¸€ä¸ªåŸºæœ¬çš„ JWT ä»¤ç‰Œä¸ºä¸€æ®µç‚¹åˆ† 3 æ®µå¼ç»“æ„ã€‚

eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ

ç”Ÿæˆ JWT ä»¤ç‰Œçš„æµç¨‹ä¸º

![20241229154732_toxO8k5v.webp](https://cdn.dong4j.site/source/image/20241229154732_toxO8k5v.webp)

1. header json çš„ base64 ç¼–ç ä¸ºä»¤ç‰Œç¬¬ä¸€éƒ¨åˆ†
2. payload json çš„ base64 ç¼–ç ä¸ºä»¤ç‰Œç¬¬äºŒéƒ¨åˆ†
3. æ‹¼è£…ç¬¬ä¸€ã€ç¬¬äºŒéƒ¨åˆ†ç¼–ç åçš„ json ä»¥åŠ secret è¿›è¡Œç­¾åçš„ä»¤ç‰Œçš„ç¬¬ä¸‰éƒ¨åˆ†

å› æ­¤åªéœ€è¦ç­¾åçš„ secret key å°±èƒ½æ ¡éªŒ JWT ä»¤ç‰Œï¼Œå¦‚æœåœ¨æ¶ˆæ¯ä½“ä¸­åŠ å…¥ç”¨æˆ· IDã€è¿‡æœŸä¿¡æ¯å°±å¯ä»¥å®ç°éªŒè¯ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆã€è¿‡æœŸäº†ï¼Œæ— éœ€ä»æ•°æ®åº“ / ç¼“å­˜ä¸­è¯»å–ä¿¡æ¯ã€‚å› ä¸ºä½¿ç”¨äº†åŠ å¯†ç®—æ³•ï¼Œæ‰€ä»¥ç¬¬ä¸€ã€äºŒéƒ¨åˆ†å³ä½¿è¢«ä¿®æ”¹ï¼ˆåŒ…æ‹¬è¿‡æœŸä¿¡æ¯ï¼‰ä¹Ÿæ— æ³•é€šè¿‡éªŒè¯ã€‚JWT ä¼˜ç‚¹æ˜¯ä¸ä»…å¯ä»¥ä½œä¸º token ä½¿ç”¨ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æ‰¿è½½ä¸€äº›å¿…è¦ä¿¡æ¯ï¼Œçœå»å¤šæ¬¡æŸ¥è¯¢ã€‚

æ³¨æ„ï¼š

1. JWT token çš„ç¬¬ä¸€ã€äºŒéƒ¨åˆ†åªæ˜¯ base64 ç¼–ç ï¼Œè‚‰çœ¼ä¸å¯è¯»ï¼Œä¸åº”å½“å­˜æ”¾æ•æ„Ÿä¿¡æ¯
2. JWT token çš„è‡ªåŒ…å«ç‰¹æ€§ï¼Œå¯¼è‡´äº†æ— æ³•è¢«æ’¤å›
3. JWT çš„ç­¾åç®—æ³•å¯ä»¥è‡ªå·±æ‹Ÿå®šï¼Œä¸ºäº†ä¾¿äºè°ƒè¯•ï¼Œæœ¬åœ°ç¯å¢ƒå¯ä»¥ä½¿ç”¨å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨éå¯¹ç§°åŠ å¯†ç®—æ³•

JWT token åœ¨å¾®æœåŠ¡çš„ç³»ç»Ÿä¸­ä¼˜åŠ¿ç‰¹åˆ«çªå‡ºã€‚å¤šå±‚è°ƒç”¨çš„ API ä¸­å¯ä»¥ç›´æ¥ä¼ é€’ JWT tokenï¼Œåˆ©ç”¨è‡ªåŒ…å«çš„èƒ½åŠ›ï¼Œå¯ä»¥å‡å°‘ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢æ¬¡æ•°ï¼›æ›´é‡è¦çš„æ˜¯ï¼Œä½¿ç”¨éå¯¹ç§°çš„åŠ å¯†æ–¹å¼å¯ä»¥é€šè¿‡åœ¨ç³»ç»Ÿä¸­åˆ†å‘å¯†åŒ™çš„æ–¹å¼éªŒè¯ JWT tokenã€‚

å½“ç„¶ OAuth å¯¹ access token ç­‰å‡­è¯æ‰€é€‰ç”¨çš„æŠ€æœ¯å¹¶æ²¡æœ‰åšå‡ºé™åˆ¶ï¼ŒOAuth å¹¶ä¸å¼ºåˆ¶ä½¿ç”¨ JWTï¼Œåœ¨ä½¿ç”¨ JWT è‡ªåŒ…å«ç‰¹æ€§çš„ä¼˜åŠ¿æ—¶ï¼Œå¿…é¡»è€ƒè™‘åˆ° JWT æ’¤å›å›°éš¾çš„é—®é¢˜ã€‚åœ¨ä¸€äº›å¯¹æ’¤å› token è¦æ±‚å¾ˆé«˜çš„é¡¹ç›®ä¸­ä¸é€‚åˆä½¿ç”¨ JWTï¼Œå³ä½¿é‡‡ç”¨äº†ä¸€äº›æ–¹æ¡ˆå®ç°ï¼ˆwhitelist å’Œ blacklistï¼‰ä¹Ÿè¿èƒŒäº†è®¾è®¡ JWT çš„åˆè¡·ã€‚

### Cookie ã€Token in Cookieã€Session Token ä¾ç„¶è¢«ä½¿ç”¨

åœ¨æ„å»º API æ—¶ï¼Œå¼€å‘è€…ä¼šå‘ç°æˆ‘ä»¬çš„è®¤è¯æ–¹å¼å’Œç½‘é¡µåº”ç”¨æœ‰ä¸€äº›ä¸åŒï¼Œé™¤äº†åƒ ajax è¿™ç§å…¸å‹çš„ web æŠ€æœ¯å¤–ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ› API æ˜¯æ— çŠ¶æ€çš„ï¼Œä¸æ¨èä½¿ç”¨ Cookieã€‚

ä½¿ç”¨ Cookie çš„æœ¬è´¨æ˜¯ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®æ—¶æœåŠ¡å™¨ä¼šåˆ†é…ä¸€ä¸ª Session IDï¼Œåé¢çš„è¯·æ±‚ä¸­å®¢æˆ·ç«¯éƒ½ä¼šå¸¦ä¸Šè¿™ä¸ª ID ä½œä¸ºå½“å‰ç”¨æˆ·çš„æ ‡å¿—ï¼Œå› ä¸º HTTP æœ¬èº«æ˜¯æ— çŠ¶æ€çš„ï¼ŒCookie å±äºä¸€ç§å†…å»ºäºæµè§ˆå™¨ä¸­å®ç°çŠ¶æ€çš„æ–¹å¼ã€‚å¦‚æœæˆ‘ä»¬çš„ API æ˜¯ç”¨æ¥ç»™å®¢æˆ·ç«¯ä½¿ç”¨çš„ï¼Œå¼ºè¡Œè¦æ±‚ API çš„è°ƒç”¨è€…ç®¡ç† Cookie ä¹Ÿå¯ä»¥å®Œæˆä»»åŠ¡ã€‚

åœ¨ä¸€äº›é—ç•™æˆ–è€…ä¸æ˜¯æ ‡å‡†çš„è®¤è¯å®ç°çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥çœ‹åˆ°è¿™äº›åšæ³•ï¼Œå¿«é€Ÿåœ°å®ç°è®¤è¯ã€‚

1. ä½¿ç”¨ cookieï¼Œä¾‹å¦‚ web é¡¹ç›®ä¸­ ajax çš„æ–¹å¼
2. ä½¿ç”¨ session ID æˆ– hash ä½œä¸º tokenï¼Œä½†å°† token æ”¾å…¥ header ä¸­ä¼ é€’
3. å°†ç”Ÿæˆçš„ token ï¼ˆå¯èƒ½æ˜¯ JWTï¼‰æ”¾å…¥ cookie ä¼ é€’ï¼Œåˆ©ç”¨ HTTPonly å’Œ Secure æ ‡ç­¾ä¿æŠ¤ token

### é€‰æ‹©åˆé€‚çš„è®¤è¯æ–¹å¼

éšç€å¾®æœåŠ¡çš„å‘å±•ï¼ŒAPI çš„è®¾è®¡ä¸ä»…ä»…æ˜¯é¢å‘ WEB æˆ–è€… Mobile APPï¼Œè¿˜æœ‰ BFFï¼ˆBackend for Frontendï¼‰å’Œ Domain API çš„è®¤è¯ï¼Œä»¥åŠç¬¬ä¸‰æ–¹æœåŠ¡çš„é›†æˆã€‚

å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨ä¹‹é—´è®¤è¯å’ŒæœåŠ¡å™¨åˆ°æœåŠ¡å™¨ä¹‹é—´è®¤è¯æ˜¯ä¸åŒçš„ã€‚

æˆ‘ä»¬æŠŠç»ˆç«¯ç”¨æˆ·ï¼ˆHumanï¼‰å‚ä¸çš„é€šä¿¡ï¼Œå«åš Human-to-machine (H2M)ï¼ŒæœåŠ¡å™¨ä¸æœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡å«åš Machine-to-machine (M2M)ã€‚

H2M çš„é€šä¿¡éœ€è¦æ›´é«˜çš„å®‰å…¨æ€§ï¼ŒM2M çš„é€šä¿¡å¤©ç„¶æ¯” H2M å®‰å…¨ï¼Œå› æ­¤æ›´å¤šçš„å¼ºè°ƒæ€§èƒ½ï¼Œåœ¨ä¸åŒçš„åœºåˆä¸‹é€‰æ‹©åˆé€‚çš„è®¤è¯æŠ€æœ¯å°±æ˜¾å¾—ç‰¹åˆ«é‡è¦ã€‚ä¾‹å¦‚ HTTP Basic Authentication ç”¨æ¥ä½œä¸º H2M è®¤è¯æ˜¾å¾—æœ‰äº›è½åï¼Œä½†æ˜¯åœ¨ M2M ä¸­è¢«å¤§é‡ä½¿ç”¨ã€‚

**å¦å¤–å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒH2M è¿™ç§é€šä¿¡æ–¹å¼ä¸‹ï¼Œå®¢æˆ·ç«¯ä¸å—æ§åˆ¶ï¼Œç”±äºæ— æ³•è‡ªä¸»åˆ†å‘å¯†åŒ™ï¼Œè®¤è¯é€šä¿¡çš„å®‰å…¨é«˜åº¦ä¾èµ– HTTPSã€‚**

ä»ä¸€ä¸ªå®è§‚çš„è§’åº¦çœ‹å¾…ä»–ä»¬çš„å…³ç³»ï¼Œå¯¹æˆ‘ä»¬æŠ€æœ¯é€‰å‹éå¸¸æœ‰å¸®åŠ©ã€‚

![20241229154732_uUfYDY8S.webp](https://cdn.dong4j.site/source/image/20241229154732_uUfYDY8S.webp)

### æœ¯è¯­è¡¨

1. Browser fingerprinting é€šè¿‡æŸ¥è¯¢æµè§ˆå™¨çš„ä»£ç†å­—ç¬¦ä¸²ï¼Œå±å¹•è‰²æ·±ï¼Œè¯­è¨€ç­‰ï¼Œç„¶åè¿™äº›å€¼é€šè¿‡æ•£åˆ—å‡½æ•°ä¼ é€’äº§ç”ŸæŒ‡çº¹ï¼Œä¸éœ€è¦é€šè¿‡ Cookie å°±å¯ä»¥è¯†åˆ«æµè§ˆå™¨
2. MACï¼ˆMessage authentication codeï¼‰ åœ¨å¯†ç å­¦ä¸­ï¼Œè®¯æ¯é‰´åˆ«ç ï¼Œæ˜¯ç»è¿‡ç‰¹å®šç®—æ³•åäº§ç”Ÿçš„ä¸€å°æ®µèµ„è®¯ï¼Œæ£€æŸ¥æŸæ®µè®¯æ¯çš„å®Œæ•´æ€§
3. HOTPï¼ˆHMAC-based One-time Password algorithmï¼‰åŸºäºæ•£åˆ—æ¶ˆæ¯éªŒè¯ç çš„ä¸€æ¬¡æ€§å¯†ç ç®—æ³•
4. Two-step verification æ˜¯ä¸€ç§è®¤è¯æ–¹æ³•ï¼Œä½¿ç”¨ä¸¤ç§ä¸åŒçš„å…ƒç´ ï¼Œåˆå¹¶åœ¨ä¸€èµ·ï¼Œæ¥ç¡®è®¤ä½¿ç”¨è€…çš„èº«ä»½ï¼Œæ˜¯å¤šå› ç´ éªŒè¯ä¸­çš„ä¸€ä¸ªç‰¹ä¾‹
5. OTP ï¼ˆOne time password ï¼‰ä¸€æ¬¡æ€§å¯†ç ï¼Œä¾‹å¦‚æ³¨å†Œé‚®ä»¶å’ŒçŸ­ä¿¡ä¸­çš„è®¤è¯ç 

## [Javaå¼€å‘ä¸­é‡åˆ°çš„ä¸€äº›å¸¸è§é—®é¢˜](https://blog.dong4j.site/posts/6dc04ed2.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

### Maven ç›¸å…³é—®é¢˜

> ç”±äºæœªç»Ÿä¸€ç®¡ç†å¤šä¸ªæ¨¡å—çš„ jar ä¾èµ–, æ¯ä¸ªæ¨¡å—éƒ½å„è‡ªä¸ºæ”¿;  
> æ¨¡å—ä¹‹é—´çš„é…ç½®ç›¸äº’æ‹·è´, æœ‰ç”¨çš„æ²¡ç”¨çš„éƒ½æ‹·äº†;  
> å‡çº§ç‰ˆæœ¬éº»çƒ¦, æ¯ä¸ªç›¸å…³æ¨¡å—éƒ½å¾—æ”¹ç‰ˆæœ¬.

![20241229154732_FDHGxHtL.webp](https://cdn.dong4j.site/source/image/20241229154732_FDHGxHtL.webp)

**1. é‡å¤çš„ä¾èµ–**

redis-cache æ¨¡å—çš„ pom.xml

![20241229154732_ugonm1Ts.webp](https://cdn.dong4j.site/source/image/20241229154732_ugonm1Ts.webp)

![20241229154732_1fVuV7vs.webp](https://cdn.dong4j.site/source/image/20241229154732_1fVuV7vs.webp)

**2. é‡å¤çš„æ’ä»¶**

mamagesystem æ¨¡å—çš„ pom.xml

![20241229154732_0GDyIBF8.webp](https://cdn.dong4j.site/source/image/20241229154732_0GDyIBF8.webp)

**3. ä¾èµ–å†²çª**

mamagesystem æ¨¡å—çš„ pom.xml

![20241229154732_lWO9h9OG.webp](https://cdn.dong4j.site/source/image/20241229154732_lWO9h9OG.webp)  
**4. é‡å¤çš„é…ç½®**

![20241229154732_h4IF53kV.webp](https://cdn.dong4j.site/source/image/20241229154732_h4IF53kV.webp)

#### å¯¼è‡´çš„é—®é¢˜

æœ‰å¯èƒ½å¯¼è‡´å‡ºç°ä»¥ä¸‹å‡ ç§å¼‚å¸¸:

1. java.lang.ClassNotFoundException
2. java.lang.NoSuchMethodError
3. java.lang.NoClassDefFoundError

#### è§£å†³æ–¹æ¡ˆ

> æ‰€æœ‰æ¨¡å—ä½¿ç”¨ä¸€ä¸ªçˆ¶æ¨¡å—æ¥ç®¡ç†  
> å°†é‡å¤é…ç½®è¿ç§»åˆ° parent pom.xml ä¸­;  
> ä½¿ç”¨ `dependencyManagement` æ¥ç»Ÿä¸€ç®¡ç† jar ä¾èµ–;  
> ä½¿ç”¨ `pluginManagement` ç»Ÿä¸€ç®¡ç†æ’ä»¶ä¾èµ–;  
> æ‰€æœ‰ jar ä¾èµ–çš„ç‰ˆæœ¬å…¨éƒ¨ä½¿ç”¨ `properties` ç®¡ç†;  
> ä½¿ç”¨ `excludes` æ’é™¤å†²çªçš„ jar åŒ…;

## ä»£ç é—®é¢˜

### 1. ä»£ç ä¸è§„èŒƒ

<!-- æ²¡æœ‰è§„çŸ©ä¸æˆæ–¹åœ†, æ²¡æœ‰è§„èŒƒå†™ä¸å‡ºæ¼‚äº®çš„ä»£ç  -->

1. æ ¼å¼åŒ–é£æ ¼ä¸ç»Ÿä¸€

   _ä¼šé€ æˆå¤§é‡ä»£ç å†²çª_

   ä¸€ä¸ªé¡¹ç›®ç»„åº”è¯¥ä½¿ç”¨ç»Ÿä¸€çš„æ ¼å¼åŒ–é£æ ¼ (google-java-style)

2. ç¼–ç ä¸ç»Ÿä¸€

   _é€ æˆä¸åŒå¼€å‘å¹³å°çš„åŒå­¦ä¹±ç _

3. å‘½åä¸è§„èŒƒ;

   _ä¸ç¬¦åˆ Javaer çš„æ ¸å¿ƒä»·å€¼è§‚, å®¡ç¾è§‚_

   **å˜é‡å:** æ–¹æ³•åä½ ä¸ç”¨é©¼å³°å‘½åæ³•, ä½ ç”¨ä¸‹åˆ’çº¿åˆ†éš”, ä½ å’‹ä¸å»å†™ Python å‘¢

### 2. ä»£ç æ— æ³¨é‡Š

<!-- ä»£ç åŠæ³¨é‡Š, å¥½çš„ä»£ç ä¸éœ€è¦æ³¨é‡Š, å†™äº†ä¸€æ®µå¾ˆå¥½çš„ä»£ç , å‘½åä¹Ÿå¾ˆå®¹æ˜“ç†è§£ä¹Ÿå¾ˆè§„èŒƒ, é€»è¾‘æ¸…æ¥š, å°±æ˜¯å¾ˆç‰›é€¼çš„ä¸€æ®µä»£ç , ä¸€æ®µæ—¶é—´å, å†æ¥çœ‹, æ©, è¿™æ˜¯ä¸€æ®µå¾ˆç‰›é€¼çš„ä»£ç , å°±æ˜¯çœ‹ä¸æ‡‚â€¦. -->

1. ç±»æ³¨é‡Š

å¯¹å·²æœ‰çš„ç±»æ·»åŠ æ³¨é‡Š

    ```java
    /**
     * <p>Company: xxxxå…¬å¸ </p>
     * <p>Description: callout å·ç è§£æå¤„ç†ç±»</p>
     *
     * @author xxx
     * @date 2018-05-31  21:40
     */
     ```

æ–°å»ºç±»æ—¶è‡ªåŠ¨æ·»åŠ 

    ```java
    /**
     * <p>Company: xxxxå…¬å¸ </p>
     * <p>Description: ${description}</p>
     *
     * @author     dong4j
     * @date       ${YEAR}-${MONTH}-${DAY} ${HOUR}:${MINUTE}
     * @email      dong4j@gmail.com
     */
     ```

2. æ–¹æ³•æ³¨é‡Š

   ```java
   /**
    * æ ¹æ®è§„åˆ™å°†æ•°æ®æ’å…¥ç›¸åº”çš„è¡¨
    *
    * @param batchOfTask the batch of task		                æ‰¹æ¬¡ä»»åŠ¡è¯¦æƒ…
    * @param telNos      the tel nos			                zip åŒ…ä¸­å¤„ç†åçš„å·ç 
    * @throws InterruptedException the interrupted exception   sleep å¤±è´¥æ—¶æŠ›å‡ºæ­¤å¼‚å¸¸
    */
   ```

3. ä»£ç æ³¨é‡Š

   æˆå‘˜å˜é‡ç”¨ `/** æ³¨é‡Š */`
   è¡Œæ³¨é‡Šæ”¾åœ¨ä»£ç ä¸Šä¸€è¡Œ, ä¸è¦ä½¿ç”¨è¡Œå°¾æ³¨é‡Š
   å¤§æ®µä»£ç æ³¨é‡Šå å»ºè®®ä½¿ç”¨

   ```java
   //<editor-fold desc="Description">
   å¤šè¡Œæ³¨é‡Šä»£ç 
   //</editor-fold>
   ```

   æˆ–è€…

   ```java
   //region Description
   å¤šè¡Œæ³¨é‡Šä»£ç 
   //endregion
   ```

### 3. å¼€å‘æ–‡æ¡£ä¸å…¨

åº”è¯¥ä¸ºæ¯ä¸ªæ¨¡å—æ·»åŠ ä¸€ä¸ª `readme.md` å’Œ `changelog.md` æ–‡ä»¶  
`readme.md` ç”¨äºè®°å½•è¯¥æ¨¡å—çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯, æ¯”å¦‚ç”¨åˆ°çš„æŠ€æœ¯, åŠŸèƒ½, ä½¿ç”¨æ–¹æ³•, éƒ¨ç½²æ–¹å¼ç­‰;  
`changelog.md` ç”¨äºè®°å½•è¯¥æ¨¡å—çš„æ›´æ–°è®°å½•;

**ä¾¿äºç»´æŠ¤ä¸äº¤æ¥**

### 4. ä»£ç çš„ä¼˜åŒ–

**1. String æ‹¼æ¥**

```java
List<CoreSong> listSong = coreSongService.findTopicRingBoxByParam(params);
if (listSong != null && listSong.size() > 0) {
    for (CoreSong c : listSong) {
        taskSongIds += c.getId() + "|";
    }
    model.addAttribute("listSong", listSong);
}
```

<!--JDK1.5 ä¹‹å‰-->

<!--JDK1.5 ä¹‹å-->

**2. æ—¥å¿—ç›¸å…³**

**logger.error çš„é”™è¯¯ç”¨æ³•**

![20241229154732_kGZ5xPz5.webp](https://cdn.dong4j.site/source/image/20241229154732_kGZ5xPz5.webp)

**logger.error çš„æ­£ç¡®ä½¿ç”¨å§¿åŠ¿**

![20241229154732_45ESzjrR.webp](https://cdn.dong4j.site/source/image/20241229154732_45ESzjrR.webp)

**ä½¿ç”¨ printStackTrace()**

![20241229154732_mSA1vWPz.webp](https://cdn.dong4j.site/source/image/20241229154732_mSA1vWPz.webp)  
**ä¸ä½¿ç”¨ printStackTrace()**

![20241229154732_sAgeQ39m.webp](https://cdn.dong4j.site/source/image/20241229154732_sAgeQ39m.webp)

> åº”ç”¨ä¸­ä¸å¯ç›´æ¥ä½¿ç”¨æ—¥å¿—ç³»ç»Ÿï¼ˆLog4j, Logbackï¼‰ä¸­çš„ API  
> è€Œæ˜¯ä½¿ç”¨ SLF4J ä¸­çš„ APIï¼Œä½¿ç”¨é—¨é¢æ¨¡å¼çš„æ—¥å¿—æ¡†æ¶ï¼Œæœ‰åˆ©äºç»´æŠ¤å’Œå„ä¸ªç±»çš„æ—¥å¿—å¤„ç†æ–¹å¼ç»Ÿä¸€

```java
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

...
private static final Logger logger = LoggerFactory.getLogger(Abc.class);
```

**å»ºè®®ä½¿ç”¨ log4j2 æ—¥å¿—ä»£æ›¿ log4j**

æ—¥å¿—æ‹¼æ¥çš„è€—æ—¶å¯¹æ¯”

```java
@Test
public void testLog1() {
    String[]  traceIds  = {"å¤©ç‹ç›–åœ°è™", "å°é¸¡ç‚–è˜‘è‡"};
    StopWatch stopwatch = new StopWatch();
    stopwatch.start();
    for (int i = 0; i < 10000000; i++) {
        log.info("traceId[1] = " + traceIds[0] +
                 "traceId[1] = " + traceIds[1] +
                 "traceId[1] = " + traceIds[0] +
                 "traceId[1] = " + traceIds[1]);
    }
    stopwatch.stop();
    System.out.println(stopwatch.prettyPrint());
}

@Test
public void testLog2() {
    String[]  traceIds  = {"å¤©ç‹ç›–åœ°è™", "å°é¸¡ç‚–è˜‘è‡"};
    StopWatch stopwatch = new StopWatch();
    stopwatch.start();
    for (int i = 0; i < 10000000; i++) {
        if (log.isInfoEnabled()) {
            log.info("traceId[1] = " + traceIds[0] +
                     "traceId[1] = " + traceIds[1] +
                     "traceId[1] = " + traceIds[0] +
                     "traceId[1] = " + traceIds[1]);
        }
    }
    stopwatch.stop();
    System.out.println(stopwatch.prettyPrint());
}

@Test
public void testLog3() {
    String[]  traceIds  = {"å¤©ç‹ç›–åœ°è™", "å°é¸¡ç‚–è˜‘è‡"};
    StopWatch stopwatch = new StopWatch();
    stopwatch.start();
    for (int i = 0; i < 10000000; i++) {
        log.info("traceId[1] = {}, traceId[1] = {}, traceId[1] = {}, traceId[1] = {}",
                 traceIds[0], traceIds[1],
                 traceIds[0], traceIds[1]);
    }
    stopwatch.stop();
    System.out.println(stopwatch.prettyPrint());
}
```

```java
StopWatch '': running time (millis) = 1268
-----------------------------------------
ms     %     Task name
-----------------------------------------
01268  100%

StopWatch '': running time (millis) = 22
-----------------------------------------
ms     %     Task name
-----------------------------------------
00022  100%

StopWatch '': running time (millis) = 38
-----------------------------------------
ms     %     Task name
-----------------------------------------
00038  100%
```

## æ¨èçš„å·¥å…·

### Markdown å·¥å…·

Mac ä¸‹æœ‰å¾ˆå¤šè¿™ç§å·¥å…·, ç›®å‰ä½¿ç”¨ MWeb;

Windowns çš„è¯, å»ºè®®ä½¿ç”¨ Typora, é…åˆ PicGo ä¸Šä¼ å›¾ç‰‡;

### Chrome æ’ä»¶

**1. æµç¨‹å›¾åˆ¶ä½œå·¥å…·**

![20241229154732_UO1YJr9v.webp](https://cdn.dong4j.site/source/image/20241229154732_UO1YJr9v.webp)  
**2. Imagus**

é¼ æ ‡æ‚¬æµ®åœç•™åœ¨å›¾ç‰‡ä¸Šï¼Œè‡ªåŠ¨å¼¹å‡ºæ”¾å¤§å›¾ç‰‡ï¼Œä¸ç”¨å†åœ¨æ–°é“¾æ¥ä¸­æ‰“å¼€çœ‹å¤§å›¾äº†ã€‚

**3. SimpleExtManager**

![20241229154732_EiDncgsn.webp](https://cdn.dong4j.site/source/image/20241229154732_EiDncgsn.webp)  
**4. Octotree**

åŒç±»æ’ä»¶ `GitCodeTree`

![20241229154732_RUf9YYSd.webp](https://cdn.dong4j.site/source/image/20241229154732_RUf9YYSd.webp)

**5. Session Buddy**

ä¸‹ç­äº†, èµ„æ–™æ²¡çœ‹å®Œ, å¯ä»¥ä¿å­˜ä¸‹æ¥

![20241229154732_HVHOpUjd.webp](https://cdn.dong4j.site/source/image/20241229154732_HVHOpUjd.webp)

### Intellij IDEA æ’ä»¶

**1. JRebel for IntelliJ**

çƒ­éƒ¨ç½²æ’ä»¶ï¼ŒJava WEB å¼€å‘å¿…å¤‡ï¼ŒèŠ‚çœç”Ÿå‘½ã€‚**å¢™è£‚æ¨è**

**2. Lombok Plugin**

ä½¿ç”¨æ³¨è§£è‡ªåŠ¨ç”Ÿæˆä»£ç ï¼Œå·æ‡’è€…å¿…å¤‡ã€‚

**3. RestfulToolkit**

Java WEB å¼€å‘å¿…å¤‡ï¼Œå†ä¹Ÿä¸ç”¨å…¨å±€æœç´¢ RequestMapping äº†

![20241229154732_hp123tER.webp](https://cdn.dong4j.site/source/image/20241229154732_hp123tER.webp)

ç›´æ¥æœç´¢ RequestMapping

![20241229154732_dWncftDM.webp](https://cdn.dong4j.site/source/image/20241229154732_dWncftDM.webp)

**4. Translation**

ç¿»è¯‘æ’ä»¶ï¼Œå¾ˆå¥½ç”¨ã€‚ **å¢™è£‚æ¨è**

![20241229154732_GcBDf7PW.webp](https://cdn.dong4j.site/source/image/20241229154732_GcBDf7PW.webp)

**5. Grep Console**

é«˜äº® log ä¸åŒçº§åˆ«æ—¥å¿—ï¼Œçœ‹æ—¥å¿—çš„æ—¶å€™ä¸€ç›®äº†ç„¶ã€‚

![20241229154732_kTuQuaqO.webp](https://cdn.dong4j.site/source/image/20241229154732_kTuQuaqO.webp)

**6. GenerateSerialVersionUID**

Alt + Insert ç”Ÿæˆ serialVersionUID

**7. Alibaba Java Coding Guidelines**

é˜¿é‡Œå·´å·´è§„èŒƒ

**8. Rainbow Brackets**

å½©è™¹æ‹¬å·ã€‚è‡ªåŠ¨ç»™ä»£ç å—å†…èŠ±æ‹¬å·å’Œæ‹¬å·åŠ è‰²ï¼Œè®©è§†é‡æ›´åŠ æ³¨æ„åœ¨ä»£ç ä¸Šã€‚

![20241229154732_EOEuuP5M.webp](https://cdn.dong4j.site/source/image/20241229154732_EOEuuP5M.webp)

**9. Maven Helper**

Maven æ’ä»¶ï¼Œå®‰è£…åå¯æŸ¥çœ‹ä¾èµ–ä»¥åŠå†²çªï¼Œä¸€ç›®äº†ç„¶ã€‚

![20241229154732_l9LObZVr.webp](https://cdn.dong4j.site/source/image/20241229154732_l9LObZVr.webp)

**12. zookeeper**

å°±æ˜¯å¤ªæ…¢äº†, æ²¡æœ‰ç”¨å¼‚æ­¥æ¥å£, ç»å¸¸å¡ä½

![20241229154732_SEm37MkN.webp](https://cdn.dong4j.site/source/image/20241229154732_SEm37MkN.webp)

**13. GenerateAllSetter**

new POJO ç±»çš„å¿«é€Ÿç”Ÿæˆ set æ–¹æ³•

```java
User user = new User();
// then alt+enter on User
// will generate following
user.setName("");
user.setPassword("");
```

### ç»ˆç«¯å·¥å…·

**1. zsh**

1. å¤§å°å†™å­—æ¯è‡ªåŠ¨æ›´æ­£
2. æ›´å¼ºå¤§çš„ tab è¡¥å…¨
3. æ™ºèƒ½çš„åˆ‡æ¢ç›®å½•
4. å‘½ä»¤é€‰é¡¹è¡¥é½
5. kill è¿›ç¨‹å·è¡¥é½

**2. oh my zsh**

1. ä¸»é¢˜
2. æ’ä»¶

## [Springæä¾›çš„ä¸åŒåºåˆ—åŒ–æ–¹å¼å¤§å¯¹æ¯”](https://blog.dong4j.site/posts/ea742350.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

ç¼“å­˜æœåŠ¡ç»„ä»¶

ä¾èµ–äº:

1. jedis
2. spring-data-redis
3. spring-session-data-redis

redis é›†ç¾¤ä½¿ç”¨çš„æ˜¯ ShardedJedisPool, redis 3.x åè‡ªå¸¦é›†ç¾¤è´Ÿè½½

## jar ä¸­é‡è¦çš„ç±»

1. JedisConnectionFactory
   ç”¨äºè·å– jedis å®ä¾‹,ä»è€Œæ“ä½œ redis

2. ShardedJedisPool
   ç”¨äºè¿æ¥ redis é›†ç¾¤

## cache é‡è¦çš„ç±»

1. RedisDataSource
   ä½¿ç”¨ JedisConnectionFactory ä» ShardedJedisPool è¿æ¥æ± ä¸­è·å– jedis

2. RedisClientTemplate
   ä¾èµ– RedisDataSource æ“ä½œ redis çš„å…·ä½“æ¨¡æ¿æ–¹æ³•

3. RedisCacheServiceImpl
   å¯¹ RedisClientTemplate å†æ¬¡å°è£…

## JedisPool(éåˆ‡ç‰‡é“¾æ¥æ± ) å’Œ ShardedJedisPool(åˆ‡ç‰‡é“¾æ¥æ± ) æœ‰ä»€ä¹ˆåŒºåˆ«

JedisPool è¿ä¸€å° Redisï¼ŒShardedJedisPool è¿ Redis é›†ç¾¤ï¼Œ
é€šè¿‡ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å†³å®šæŠŠæ•°æ®å­˜åˆ°å“ªå°ä¸Šï¼Œç®—æ˜¯ä¸€ç§å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼Œ
æ‰€ä»¥æ·»åŠ æ˜¯ç”¨è¿™ä¸ªï¼ˆRedis 3.0 ä¹‹åæ”¯æŒæœåŠ¡ç«¯è´Ÿè½½å‡è¡¡ï¼‰
åˆ é™¤é‚£ä¸ªé—®é¢˜çš„ç­”æ¡ˆå°±æ˜¾è€Œæ˜“è§äº†ï¼Œæ€»ä¸å¯èƒ½éšæœºæ‰¾ä¸€ä¸ª Redis æœåŠ¡ç«¯å»åˆ å§

## é›†ç¾¤ session å…±äº«æœºåˆ¶

ç°åœ¨é›†ç¾¤ä¸­ä½¿ç”¨çš„ Session å…±äº«æœºåˆ¶æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯ session å¤åˆ¶å’Œ session ç²˜æ€§ã€‚

**Session å¤åˆ¶**

è¯¥ç§æ–¹å¼ä¸‹ï¼Œè´Ÿè½½å‡è¡¡å™¨ä¼šæ ¹æ®å„ä¸ª node çš„çŠ¶æ€ï¼ŒæŠŠæ¯ä¸ª request è¿›è¡Œåˆ†å‘ï¼Œä½¿ç”¨è¿™æ ·çš„æµ‹è¯•ï¼Œå¿…é¡»åœ¨å¤šä¸ª node ä¹‹é—´å¤åˆ¶ç”¨æˆ·çš„ sessionï¼Œå®æ—¶ä¿æŒæ•´ä¸ªé›†ç¾¤ä¸­ç”¨æˆ·çš„çŠ¶æ€åŒæ­¥ã€‚
å…¶ä¸­ jboss çš„å®ç°åŸç†æ˜¯ä½¿ç”¨æ‹¦æˆªå™¨ï¼Œæ ¹æ®ç”¨æˆ·çš„åŒæ­¥ç­–ç•¥æ‹¦æˆª requestï¼Œåšå®ŒåŒæ­¥å¤„ç†åå†äº¤ç»™ server äº§ç”Ÿå“åº”ã€‚

ä¼˜ç‚¹ï¼šsession ä¸ä¼šè¢«ç»‘å®šåˆ°å…·ä½“çš„ nodeï¼Œåªè¦æœ‰ä¸€ä¸ª node å­˜æ´»ï¼Œç”¨æˆ·çŠ¶æ€å°±ä¸ä¼šä¸¢å¤±ï¼Œé›†ç¾¤èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚

ç¼ºç‚¹ï¼šnode ä¹‹é—´é€šä¿¡é¢‘ç¹ï¼Œå“åº”é€Ÿåº¦æœ‰å½±å“ï¼Œé«˜å¹¶å‘æƒ…å†µä¸‹æ€§èƒ½ä¸‹é™æ¯”è¾ƒå‰å®³ã€‚

**Session ç²˜æ€§**

è¯¥ç§æ–¹å¼ä¸‹ï¼Œå½“ç”¨æˆ·å‘å‡ºç¬¬ä¸€ä¸ª request åï¼Œè´Ÿè½½å‡è¡¡å™¨åŠ¨æ€çš„æŠŠè¯¥ç”¨æˆ·åˆ†é…è‡³åˆ°æŸä¸ªèŠ‚ç‚¹ï¼Œå¹¶è®°å½•è¯¥èŠ‚ç‚¹çš„ jvm è·¯ç”±ï¼Œä»¥åè¯¥ç”¨æˆ·çš„æ‰€æœ‰çš„ request éƒ½ä¼šç»‘å®šåˆ°è¿™ä¸ª jvm è·¯ç”±ï¼Œç”¨æˆ·åªä¼šå’Œè¯¥ server äº¤äº’ã€‚

ä¼˜ç‚¹ï¼šå“åº”é€Ÿåº¦å¿«ï¼Œå¤šä¸ªèŠ‚ç‚¹ä¹‹é—´æ— éœ€é€šä¿¡

ç¼ºç‚¹ï¼šæŸä¸ª node æ­»æ‰ä¹‹åï¼Œå®ƒè´Ÿè´£çš„æ‰€æœ‰ç”¨æˆ·éƒ½ä¼šä¸¢å¤± sessionã€‚

æ”¹è¿›ï¼šservlet å®¹å™¨åœ¨æ–°å»ºã€æ›´æ–°æˆ–ç»´æŠ¤ session æ—¶ï¼Œå‘å…¶å®ƒ no de æ¨é€ä¿®æ”¹ä¿¡æ¯ã€‚è¿™ç§æ–¹å¼åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹åŒæ ·ä¼šå½±å“æ•ˆç‡ã€‚

ä»¥ä¸Šè¿™ä¸¤ç§æ–¹å¼éƒ½éœ€è¦è´Ÿè½½å‡è¡¡å™¨å’Œ Servlet å®¹å™¨çš„æ”¯æŒï¼Œåœ¨éƒ¨ç½²æ—¶éœ€è¦å•ç‹¬é…ç½®è´Ÿè½½å‡è¡¡å™¨å’Œ Servelt å®¹å™¨ã€‚

**åŸºäºåˆ†å¸ƒå¼ç¼“å­˜çš„ session å…±äº«æœºåˆ¶**

å°†ä¼šè¯ Session ç»Ÿä¸€å­˜å‚¨åœ¨åˆ†å¸ƒå¼ç¼“å­˜ä¸­ï¼Œå¹¶ä½¿ç”¨ Cookie ä¿æŒå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„è”ç³»ï¼Œ
æ¯ä¸€æ¬¡ä¼šè¯å¼€å§‹å°±ç”Ÿæˆä¸€ä¸ª GUID ä½œä¸º SessionIDï¼Œä¿å­˜åœ¨å®¢æˆ·ç«¯çš„ Cookie ä¸­ï¼Œåœ¨æœåŠ¡ç«¯é€šè¿‡ SessionID å‘åˆ†å¸ƒå¼ç¼“å­˜ä¸­è·å– sessionã€‚

å®ç°æ€è·¯ï¼šé€šè¿‡ä¸€ä¸ª Filter è¿‡æ»¤æ‰€æœ‰çš„ request è¯·æ±‚ï¼Œåœ¨ Filter åˆ›å»º request å’Œ session çš„ä»£ç†ï¼Œé€šè¿‡ä»£ç†ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜å¯¹ session è¿›è¡Œæ“ä½œã€‚è¿™æ ·å®ç°å¯¹ç°æœ‰åº”ç”¨ä¸­å¯¹ request å¯¹è±¡çš„æ“ä½œé€æ˜
æ‰©å±•æŒ‡å®š server åˆ©ç”¨ Servlet å®¹å™¨æä¾›çš„æ’ä»¶åŠŸèƒ½ï¼Œè‡ªå®šä¹‰ HttpSession çš„åˆ›å»ºå’Œç®¡ç†ç­–ç•¥ï¼Œå¹¶é€šè¿‡é…ç½®çš„æ–¹å¼æ›¿æ¢æ‰é»˜è®¤çš„ç­–ç•¥ã€‚

ä¸è¿‡è¿™ç§æ–¹å¼æœ‰ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯éœ€è¦è€¦åˆ Tomcat/Jetty ç­‰ Servlet å®¹å™¨çš„ä»£ç ã€‚
è¿™æ–¹é¢å…¶å®æ—©å°±æœ‰å¼€æºé¡¹ç›®äº†ï¼Œä¾‹å¦‚ memcached-session-manager ï¼Œä»¥åŠ tomcat-redis-session-manager ã€‚æš‚æ—¶éƒ½åªæ”¯æŒ Tomcat6/Tomcat7ã€‚

è®¾è®¡ä¸€ä¸ª Filter åˆ©ç”¨ HttpServletRequestWrapperï¼Œå®ç°è‡ªå·±çš„ getSession() æ–¹æ³•ï¼Œæ¥ç®¡åˆ›å»ºå’Œç®¡ç† Session æ•°æ®çš„å·¥ä½œã€‚spring-session å°±æ˜¯é€šè¿‡è¿™æ ·çš„æ€è·¯å®ç°çš„ã€‚

**spring-session**
SpringSession çš„å‡ ä¸ªå…³é”®ç±»

1. SessionRepositoryFilter(order æ˜¯ Integer.MIN_VALUE + 50)
2. SessionRepositoryRequestWrapper ä¸ SessionRepositoryResponseWrapperï¼Œé€šè¿‡ SessionRepository å»æ“çºµ session
3. SessionRepository
4. CookieHttpSessionStrategy

## redis è¿‡æœŸæ•°æ®çš„åˆ é™¤æ–¹å¼

1. å®šæ—¶åˆ é™¤ï¼šåœ¨è®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´çš„åŒæ—¶ï¼Œåˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ (timer)ï¼Œè®©å®šæ—¶å™¨åœ¨é”®çš„è¿‡æœŸæ—¶é—´æ¥ä¸´æ—¶ï¼Œç«‹å³æ‰§è¡Œå¯¹é”®çš„åˆ é™¤æ“ä½œã€‚
2. æƒ°æ€§åˆ é™¤ï¼šæ”¾ä»»é”®è¿‡æœŸä¸ç®¡ï¼Œä½†æ˜¯æ¯æ¬¡ä»é”®ç©ºé—´ä¸­è·å–é”®æ—¶ï¼Œéƒ½æ£€æŸ¥å–å¾—çš„é”®æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸçš„è¯ï¼Œå°±åˆ é™¤è¯¥é”®ï¼›å¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œå°±è¿”å›è¯¥é”®ã€‚
3. å®šæœŸåˆ é™¤ï¼šæ¯éš”ä¸€æ®µæ—¶é—´ï¼Œç¨‹åºå°±å¯¹æ•°æ®åº“è¿›è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œåˆ é™¤é‡Œé¢çš„è¿‡æœŸé”®ã€‚è‡³äºè¦åˆ é™¤å¤šå°‘è¿‡æœŸé”®ï¼Œä»¥åŠè¦æ£€æŸ¥å¤šå°‘ä¸ªæ•°æ®åº“ï¼Œåˆ™ç”±ç®—æ³•å†³å®šã€‚

redis å®é™…æ˜¯ä»¥æ‡’æ€§åˆ é™¤ + å®šæœŸåˆ é™¤è¿™ç§ç­–ç•¥ç»„åˆæ¥å®ç°è¿‡æœŸé”®åˆ é™¤çš„ï¼Œ
å¯¼è‡´ Spring éœ€è¦é‡‡ç”¨åŠæ—¶åˆ é™¤çš„ç­–ç•¥ï¼ˆå®šæ—¶è½®è¯¢ï¼‰ï¼Œåœ¨è¿‡æœŸçš„æ—¶å€™ï¼Œè®¿é—®ä¸€ä¸‹è¯¥ keyï¼Œç„¶ååŠæ—¶è§¦å‘æƒ°æ€§åˆ é™¤
Spring çš„è½®è¯¢å¦‚ä½•ä¿è¯æ—¶æ•ˆæ€§

```java
@Scheduled(cron = "0 * * * * *")
//æ¯åˆ†é’Ÿè·‘ä¸€æ¬¡ï¼Œæ¯æ¬¡æ¸…é™¤å‰ä¸€åˆ†é’Ÿçš„è¿‡æœŸé”®
public void cleanExpiredSessions() {
    long now = system.currentTimeMillis();
    long prevMin = roundDownMinute(now);

    if (logger.isDebugEnabled()) {
        logger.debug("Cleaning up sessions expiring at " + new Date(prevMin));
    }

    String expirationKey = getExpirationKey(prevMin);
    Set < String > sessionsToExpire = expirationRedisOperations.boundSetOps(expirationKey).members();
    expirationRedisOperations.delete(expirationKey);
    for (String session: sessionsToExpire) {
        String sessionKey = getSessionKey(session);
        touch(sessionKey);
    }
}
```

è¿™é‡Œçš„ touch æ“ä½œå°±æ˜¯è®¿é—®è¯¥ keyï¼Œç„¶åè§¦å‘ redis åˆ é™¤ã€‚

```java
/**
 * By trying to access the session we only trigger a deletion if it the TTL is expired. This is done to handle
 * https://github.com/spring-projects/spring-session/issues/93
 *
 * @param key
 */
private void touch(String key) {
    sessionRedisOperations.hasKey(key);
}
```

ä¸»åŠ¨åˆ é™¤ session

```java
public void onDelete(ExpiringSession session) {
    long toExpire = roundUpToNextMinute(expiresInMillis(session));
    String expireKey = getExpirationKey(toExpire);
    expirationRedisOperations.boundSetOps(expireKey).remove(session.getId());
}
```

å»¶é•¿ session è¿‡æœŸæ—¶é—´

```java
public void onExpirationupdated(Long originalExpirationTimeInMilli, ExpiringSession session) {
    if (originalExpirationTimeInMilli != null) {
        long originalRoundedUp = roundUpToNextMinute(originalExpirationTimeInMilli);
        String expireKey = getExpirationKey(originalRoundedUp);
        expirationRedisOperations.boundSetOps(expireKey).remove(session.getId());
    }

    long toExpire = roundUpToNextMinute(expiresInMillis(session));

    String expireKey = getExpirationKey(toExpire);
    BoundSetOperations < String,
    String > expireOperations = expirationRedisOperations.boundSetOps(expireKey);
    expireOperations.add(session.getId());

    long sessionExpireInSeconds = session.getMaxInactiveIntervalInSeconds();
    String sessionKey = getSessionKey(session.getId());

    expireOperations.expire(sessionExpireInSeconds + 60, TimeUnit.SECONDS);
    sessionRedisOperations.boundHashOps(sessionKey).expire(sessionExpireInSeconds, TimeUnit.SECONDS);
}
```

## æ›¿æ¢åºåˆ—åŒ–æ–¹å¼

ä½¿ç”¨ GenericJackson2JsonRedisSerializer æ›¿æ¢ JdkSerializationRedisSerializer
ä½¿å¾—å­˜å…¥ redis çš„æ•°æ®æ˜¾ç¤ºæ›´å‹å¥½

å­˜åœ¨çš„é—®é¢˜

æ•°æ®è¿ç§»
åŸæ¥å­˜åœ¨äº redis ä¸­çš„æ•°æ® ä¸èƒ½ä½¿ç”¨ GenericJackson2JsonRedisSerializer ååºåˆ—åŒ–

## jedisPool ä¸ RedisTemplate çš„åŒºåˆ«

jedisPool æ˜¯ç›´æ¥é€šè¿‡è·å– jedis æ¥æ“ä½œ redis
è€Œ RedisTemplate æ˜¯é€šè¿‡ spring ç”± IOC æ¥é…ç½®ä¾èµ–å…³ç³»

## Spring æä¾›çš„ redis åºåˆ—åŒ–æ–¹å¼çš„åŒºåˆ«

1. JdkSerializationRedisSerializer
2. GenericJackson2JsonRedisSerializer

## [JDK ä»5 åˆ° 10 çš„æ–°ç‰¹æ€§ä»‹ç»](https://blog.dong4j.site/posts/9c7f49a2.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## JDK5 æ–°ç‰¹æ€§

Java5 å¼€å‘ä»£å·ä¸º Tiger(è€è™),äº 2004-09-30 å‘è¡Œ

### 1ã€æ³›å‹

æ‰€è°“ç±»å‹æ“¦é™¤æŒ‡çš„å°±æ˜¯ Java æºç ä¸­çš„èŒƒå‹ä¿¡æ¯åªå…è®¸åœç•™åœ¨ç¼–è¯‘å‰æœŸï¼Œè€Œç¼–è¯‘åçš„å­—èŠ‚ç æ–‡ä»¶ä¸­å°†ä¸å†ä¿ç•™ä»»ä½•çš„èŒƒå‹ä¿¡æ¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒèŒƒå‹ä¿¡æ¯åœ¨ç¼–è¯‘æ—¶å°†ä¼šè¢«å…¨éƒ¨åˆ é™¤ï¼Œå…¶ä¸­èŒƒå‹ç±»å‹çš„ç±»å‹å‚æ•°åˆ™ä¼šè¢«æ›¿æ¢ä¸º Object ç±»å‹ï¼Œå¹¶åœ¨å®é™…ä½¿ç”¨æ—¶å¼ºåˆ¶è½¬æ¢ä¸ºæŒ‡å®šçš„ç›®æ ‡æ•°æ®ç±»å‹ã€‚è€Œ C++ä¸­çš„æ¨¡æ¿åˆ™ä¼šåœ¨ç¼–è¯‘æ—¶å°†æ¨¡æ¿ç±»å‹ä¸­çš„ç±»å‹å‚æ•°æ ¹æ®æ‰€ä¼ é€’çš„æŒ‡å®šæ•°æ®ç±»å‹ç”Ÿæˆç›¸å¯¹åº”çš„ç›®æ ‡ä»£ç ã€‚

```java
Map<Integer, Integer> squares = new HashMap<Integer, Integer>();
```

- é€šé…ç¬¦ç±»å‹ï¼šé¿å… unchecked è­¦å‘Šï¼Œé—®å·è¡¨ç¤ºä»»ä½•ç±»å‹éƒ½å¯ä»¥æ¥å—

```java
public void printList(List<?> list, PrintStream out) throws IOException {
    for (Iterator<?> i = list.iterator(); i.hasNext(); ) {
      out.println(i.next().toString());
    }
  }
```

- é™åˆ¶ç±»å‹

```java
public static <A extends Number> double sum(Box<A> box1,Box<A> box2){
    double total = 0;
    for (Iterator<A> i = box1.contents.iterator(); i.hasNext(); ) {
      total = total + i.next().doubleValue();
    }
    for (Iterator<A> i = box2.contents.iterator(); i.hasNext(); ) {
      total = total + i.next().doubleValue();
    }
    return total;
  }
```

### 2ã€æšä¸¾

- EnumMap

```java
public void testEnumMap(PrintStream out) throws IOException {
    // Create a map with the key and a String message
    EnumMap<AntStatus, String> antMessages =
      new EnumMap<AntStatus, String>(AntStatus.class);
    // Initialize the map
    antMessages.put(AntStatus.INITIALIZING, "Initializing Ant...");
    antMessages.put(AntStatus.COMPILING,    "Compiling Java classes...");
    antMessages.put(AntStatus.COPYING,      "Copying files...");
    antMessages.put(AntStatus.JARRING,      "JARring up files...");
    antMessages.put(AntStatus.ZIPPING,      "ZIPping up files...");
    antMessages.put(AntStatus.DONE,         "Build complete.");
    antMessages.put(AntStatus.ERROR,        "Error occurred.");
    // Iterate and print messages
    for (AntStatus status : AntStatus.values() ) {
      out.println("For status " + status + ", message is: " +
                  antMessages.get(status));
    }
  }

```

- switch æšä¸¾

```java
public String getDescription() {
    switch(this) {
      case ROSEWOOD:      return "Rosewood back and sides";
      case MAHOGANY:      return "Mahogany back and sides";
      case ZIRICOTE:      return "Ziricote back and sides";
      case SPRUCE:        return "Sitka Spruce top";
      case CEDAR:         return "Wester Red Cedar top";
      case AB_ROSETTE:    return "Abalone rosette";
      case AB_TOP_BORDER: return "Abalone top border";
      case IL_DIAMONDS:
        return "Diamonds and squares fretboard inlay";
      case IL_DOTS:
        return "Small dots fretboard inlay";
      default: return "Unknown feature";
    }
  }

```

## 3ã€è‡ªåŠ¨æ‹†ç®±/è£…ç®±

å°† primitive ç±»å‹è½¬æ¢æˆå¯¹åº”çš„ wrapper ç±»å‹ï¼šBooleanã€Byteã€Shortã€Characterã€Integerã€Longã€Floatã€Double

## 4ã€å¯å˜å‚æ•°

```java
private String print(Object... values) {
    StringBuilder sb = new StringBuilder();
    for (Object o : values) {
      sb.append(o.toString())
        .append(" ");
    }
    return sb.toString();
  }

```

## 5ã€æ³¨è§£

- Inherited è¡¨ç¤ºè¯¥æ³¨è§£æ˜¯å¦å¯¹ç±»çš„å­ç±»ç»§æ‰¿çš„æ–¹æ³•ç­‰èµ·ä½œç”¨
- Target ç±»å‹
- Rentation è¡¨ç¤º annotation æ˜¯å¦ä¿ç•™åœ¨ç¼–è¯‘è¿‡çš„ class æ–‡ä»¶ä¸­è¿˜æ˜¯åœ¨è¿è¡Œæ—¶å¯è¯»ã€‚

```java
@Documented
@Inherited
@Retention(RetentionPolicy.RUNTIME)
public @interface InProgress { }

```

## 6ã€å¢å¼º for å¾ªç¯ for/in

for/in å¾ªç¯åŠä¸åˆ°çš„äº‹æƒ…ï¼š
ï¼ˆ1ï¼‰éå†åŒæ—¶è·å– index
ï¼ˆ2ï¼‰é›†åˆé€—å·æ‹¼æ¥æ—¶å»æ‰æœ€åä¸€ä¸ª
ï¼ˆ3ï¼‰éå†çš„åŒæ—¶åˆ é™¤å…ƒç´ 

## 7. é™æ€å¯¼å…¥

```java
import static java.lang.System.err;
import static java.lang.System.out;

err.println(msg);

```

## 8. print è¾“å‡ºæ ¼å¼åŒ–

```java
System.out.println("Line %d: %s%n", i++, line);

```

## 9. å¹¶å‘æ”¯æŒï¼ˆJUCï¼‰

- çº¿ç¨‹æ± 
- uncaught exceptionï¼ˆå¯ä»¥æŠ“ä½å¤šçº¿ç¨‹å†…çš„å¼‚å¸¸ï¼‰

```java
class SimpleThreadExceptionHandler implements
    Thread.UncaughtExceptionHandler {
  public void uncaughtException(Thread t, Throwable e) {
    System.err.printf("%s: %s at line %d of %s%n",
        t.getName(),
        e.toString(),
        e.getStackTrace()[0].getLineNumber(),
        e.getStackTrace()[0].getFileName());
  }

```

- blocking queue(BlockingQueue)
- JUC ç±»åº“

## 10. Arraysã€Queueã€çº¿ç¨‹å®‰å…¨ StringBuilder

- Arrays å·¥å…·ç±»

```java
Arrays.sort(myArray);
Arrays.toString(myArray)
Arrays.binarySearch(myArray, 98)
Arrays.deepToString(ticTacToe)
Arrays.deepEquals(ticTacToe, ticTacToe3)

```

- Queue(Queue æ¥å£ä¸ Listã€Set åŒä¸€çº§åˆ«ï¼Œéƒ½æ˜¯ç»§æ‰¿äº† Collection æ¥å£ã€‚LinkedList å®ç°äº† Deque æ¥ å£ã€‚)
  é¿å¼€é›†åˆçš„ add/remove æ“ä½œï¼Œä½¿ç”¨ offerã€poll æ“ä½œï¼ˆä¸æŠ›å¼‚å¸¸ï¼‰

```java
Queue q = new LinkedList(); //é‡‡ç”¨å®ƒæ¥å®ç°queue
```

- Override è¿”å›ç±»å‹
- å•çº¿ç¨‹ StringBuilder
- java.lang.instrument

JDK5 æ˜¯ java å²ä¸Šæœ€é‡è¦çš„å‡çº§ä¹‹ä¸€ï¼Œå…·æœ‰éå¸¸é‡è¦çš„æ„ä¹‰ï¼Œè™½ç„¶è¯­æ³•ç³–éå¸¸å¤šã€‚ä½†å¯ä»¥ä½¿å¾—æˆ‘ä»¬çš„ä»£ç æ›´åŠ å¥å£®ï¼Œæ›´åŠ ä¼˜é›…ã€‚

## JDK6 æ–°ç‰¹æ€§

Java6 å¼€å‘ä»£å·ä¸º Mustang(é‡é©¬),äº 2006-12-11 å‘è¡Œ.

1ã€Web Services
ä¼˜å…ˆæ”¯æŒç¼–å†™ XML web service å®¢æˆ·ç«¯ç¨‹åºã€‚ä½ å¯ä»¥ç”¨è¿‡ç®€å•çš„ annotaion å°†ä½ çš„ API å‘å¸ƒæˆ.NET äº¤äº’çš„ web services. Mustang æ·»åŠ äº†æ–°çš„è§£æå’Œ XML åœ¨ Java object-mapping APIs ä¸­, ä¹‹å‰åªåœ¨ Java EE å¹³å°å®ç°æˆ–è€… Java Web Services Pack ä¸­æä¾›.

2ã€Scriptingï¼ˆå¼€å¯ JS çš„æ”¯æŒï¼Œç®—æ˜¯æ¯”è¾ƒæœ‰ç”¨çš„ï¼‰
ç°åœ¨ä½ å¯ä»¥åœ¨ Java æºä»£ç ä¸­æ··å…¥ JavaScript äº†ï¼Œè¿™å¯¹å¼€å‘åŸå‹å¾ˆæœ‰æœ‰ç”¨ï¼Œä½ ä¹Ÿå¯ä»¥æ’å…¥è‡ªå·±çš„è„šæœ¬å¼•æ“ã€‚

3ã€Database
Mustang å°†è”åˆç»‘å®š Java DB (Apache Derby). JDBC 4.0 å¢åŠ äº†è®¸å¤šç‰¹æ€§ä¾‹å¦‚æ”¯æŒ XML ä½œä¸º SQL æ•°æ®ç±»å‹ï¼Œæ›´å¥½çš„é›†æˆ Binary Large OBjects (BLOBs) å’Œ Character Large OBjects (CLOBs) .

4ã€More Desktop APIs
GUI å¼€å‘è€…å¯ä»¥æœ‰æ›´å¤šçš„æŠ€å·§æ¥ä½¿ç”¨ SwingWorker utility ï¼Œä»¥å¸®åŠ© GUI åº”ç”¨ä¸­çš„å¤šçº¿ç¨‹ã€‚, JTable åˆ†ç±»å’Œè¿‡æ»¤ï¼Œä»¥åŠæ·»åŠ  splash é—ªå±ã€‚

å¾ˆæ˜¾ç„¶ï¼Œè¿™å¯¹äºä¸»æ”»æœåŠ¡å™¨å¼€å‘çš„ Java æ¥è¯´ï¼Œå¹¶æ²¡æœ‰å¤ªå¤šå¸å¼•åŠ›

5ã€Monitoring and Management.
ç»‘å®šäº†ä¸æ˜¯å¾ˆçŸ¥åçš„ memory-heap åˆ†æå·¥å…· Jhat æ¥æŸ¥çœ‹å†…æ ¸å¯¼å‡ºã€‚

6ã€Compiler Accessï¼ˆè¿™ä¸ªå¾ˆå‰å®³ï¼‰
compiler API æä¾›ç¼–ç¨‹è®¿é—® javacï¼Œå¯ä»¥å®ç°è¿›ç¨‹å†…ç¼–è¯‘ï¼ŒåŠ¨æ€äº§ç”Ÿ Java ä»£ç ã€‚

7ã€Pluggable Annotation
8ã€Desktop Deployment.
Swing æ‹¥æœ‰æ›´å¥½çš„ look-and-feel , LCD æ–‡æœ¬å‘ˆç°, æ•´ä½“ GUI æ€§èƒ½çš„æå‡ã€‚Java åº”ç”¨ç¨‹åºå¯ä»¥å’Œæœ¬åœ°å¹³å°æ›´å¥½çš„é›†æˆï¼Œä¾‹å¦‚è®¿é—®å¹³å°çš„ç³»ç»Ÿæ‰˜ç›˜å’Œå¼€å§‹èœå•ã€‚Mustang å°† Java æ’ä»¶æŠ€æœ¯å’Œ Java Web Start å¼•æ“ç»Ÿä¸€äº†èµ·æ¥ã€‚

9ã€Security
XML-æ•°å­—ç­¾å(XML-DSIG) APIs ç”¨äºåˆ›å»ºå’Œæ“çºµæ•°å­—ç­¾å); æ–°çš„æ–¹æ³•æ¥è®¿é—®æœ¬åœ°å¹³å°çš„å®‰å…¨æœåŠ¡

10ã€The -ilitiesï¼ˆå¾ˆå¥½çš„ä¹ æƒ¯ï¼‰
è´¨é‡ï¼Œå…¼å®¹æ€§ï¼Œç¨³å®šæ€§ã€‚ 80,000 test cases å’Œæ•°ç™¾ä¸‡è¡Œæµ‹è¯•ä»£ç (åªæ˜¯æµ‹è¯•æ´»åŠ¨ä¸­çš„ä¸€ä¸ªæ–¹é¢). Mustang çš„å¿«ç…§å‘å¸ƒå·²ç»è¢«ä¸‹è½½ 15 ä¸ªæœˆäº†ï¼Œæ¯ä¸€æ­¥ä¸­çš„ Bug éƒ½è¢«ä¿®å¤äº†ï¼Œè¡¨ç°æ¯” J2SE 5 è¿˜è¦å¥½ã€‚

## JDK7 æ–°ç‰¹æ€§

Java7 å¼€å‘ä»£å·æ˜¯ Dolphin(æµ·è±š),äº 2011-07-28 å‘è¡Œ.

### 1. switch ä¸­æ·»åŠ å¯¹ String ç±»å‹çš„æ”¯æŒ

```java
public String generate(String name, String gender) {
       String title = "";
       switch (gender) {
           case "ç”·":
               title = name + " å…ˆç”Ÿ";
               break;
           case "å¥³":
               title = name + " å¥³å£«";
               break;
           default:
               title = name;
       }
       return title;
}

```

ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶å…ˆåšå¤„ç†ï¼š
â‘ case ä»…ä»…æœ‰ä¸€ç§æƒ…å†µã€‚ç›´æ¥è½¬æˆ ifã€‚
â‘¡ å‡è®¾ä»…ä»…æœ‰ä¸€ä¸ª case å’Œ defaultï¼Œåˆ™ç›´æ¥è½¬æ¢ä¸º ifâ€¦elseâ€¦ã€‚
â‘¢ æœ‰å¤šä¸ª caseã€‚å…ˆå°† String è½¬æ¢ä¸º hashCodeï¼Œç„¶åç›¸åº”çš„è¿›è¡Œå¤„ç†ï¼ŒJavaCode åœ¨åº•å±‚å…¼å®¹ Java7 æ›¾ç»ç‰ˆæœ¬å·ã€‚

### 2. æ•°å­—å­—é¢é‡çš„æ”¹è¿›

Java7 å‰æ”¯æŒåè¿›åˆ¶ï¼ˆ123ï¼‰ã€å…«è¿›åˆ¶ï¼ˆ0123ï¼‰ã€åå…­è¿›åˆ¶ï¼ˆ0X12ABï¼‰
Java7 æ·»åŠ äºŒè¿›åˆ¶è¡¨ç¤ºï¼ˆ0B11110001ã€0b11110001ï¼‰
æ•°å­—ä¸­å¯åŠ å…¥åˆ†éš”ç¬¦
Java7 ä¸­æ”¯æŒåœ¨æ•°å­—é‡ä¸­é—´æ·»åŠ  `_` ä½œä¸ºåˆ†éš”ç¬¦ã€‚æ›´ç›´è§‚ï¼Œå¦‚ï¼ˆ12_123_456ï¼‰ã€‚ä¸‹åˆ’çº¿ä»…ä»…èƒ½åœ¨æ•°å­—ä¸­é—´ã€‚ç¼–è¯‘æ—¶ç¼–è¯‘å™¨è‡ªå·±ä¸»åŠ¨åˆ é™¤æ•°å­—ä¸­çš„ä¸‹åˆ’çº¿ã€‚

```java
int one_million = 1_000_000;
```

### 3. å¼‚å¸¸å¤„ç†ï¼ˆæ•è·å¤šä¸ªå¼‚å¸¸ï¼‰ try-with-resources

#### catch å­å¥èƒ½å¤ŸåŒä¸€æ—¶å€™æ•è·å¤šä¸ªå¼‚å¸¸

```java
public void testSequence() {
    try {
        Integer.parseInt("Hello");
    }
    catch (NumberFormatException | RuntimeException e) {  //ä½¿ç”¨'|'åˆ‡å‰²ï¼Œå¤šä¸ªç±»å‹ï¼Œä¸€ä¸ªå¯¹è±¡e

    }
}
```

#### try-with-resources è¯­å¥

Java7 ä¹‹å‰é¡»è¦åœ¨ finally ä¸­å…³é—­ socketã€æ–‡ä»¶ã€æ•°æ®åº“è¿æ¥ç­‰èµ„æºï¼›
Java7 ä¸­åœ¨ try è¯­å¥ä¸­ç”³è¯·èµ„æºï¼Œå®ç°èµ„æºçš„è‡ªå·±ä¸»åŠ¨é‡Šæ”¾ï¼ˆèµ„æºç±»å¿…é¡»å®ç° java.lang.AutoCloseable æ¥å£ï¼Œä¸€èˆ¬çš„æ–‡ä»¶ã€æ•°æ®åº“è¿æ¥ç­‰å‡å·²å®ç°è¯¥æ¥å£ï¼Œclose æ–¹æ³•å°†è¢«è‡ªå·±ä¸»åŠ¨è°ƒç”¨ï¼‰

```java
public void read(String filename) throws IOException {
     try (BufferedReader reader = new BufferedReader(new FileReader(filename))) {
         StringBuilder builder = new StringBuilder();
String line = null;
while((line=reader.readLine())!=null){
    builder.append(line);
    builder.append(String.format("%n"));
}
return builder.toString();
     }
 }

```

### 4. å¢å¼ºæ³›å‹æ¨æ–­

```java
// ä¹‹å‰
Map<String, List<String>> map = new HashMap<String, List<String>>();
// ä¹‹å
Map<String, List<String>> anagrams = new HashMap<>();

```

### 5. NIO2.0ï¼ˆAIOï¼‰æ–° IO çš„æ”¯æŒ

- bytebuffer

```java
public class ByteBufferUsage {
    public void useByteBuffer() {
        ByteBuffer buffer = ByteBuffer.allocate(32);
        buffer.put((byte)1);
        buffer.put(new byte[3]);
        buffer.putChar('A');
        buffer.putFloat(0.0f);
        buffer.putLong(10, 100L);
        System.out.println(buffer.getChar(4));
        System.out.println(buffer.remaining());
    }
    public void byteOrder() {
        ByteBuffer buffer = ByteBuffer.allocate(4);
        buffer.putInt(1);
        buffer.order(ByteOrder.LITTLE_ENDIAN);
        buffer.getInt(0); //å€¼ä¸º16777216
    }
    public void compact() {
        ByteBuffer buffer = ByteBuffer.allocate(32);
        buffer.put(new byte[16]);
        buffer.flip();
        buffer.getInt();
        buffer.compact();
        int pos = buffer.position();
    }
    public void viewBuffer() {
        ByteBuffer buffer = ByteBuffer.allocate(32);
        buffer.putInt(1);
        IntBuffer intBuffer = buffer.asIntBuffer();
        intBuffer.put(2);
        int value = buffer.getInt(); //å€¼ä¸º2
    }
    /**
     * @param args the command line arguments
     */
    public static void main(String[] args) {
        ByteBufferUsage bbu = new ByteBufferUsage();
        bbu.useByteBuffer();
        bbu.byteOrder();
        bbu.compact();
        bbu.viewBuffer();
    }
}

```

- filechannel

```java
public class FileChannelUsage {
    public void openAndWrite() throws IOException {
        FileChannel channel = FileChannel.open(Paths.get("my.txt"), StandardOpenOption.CREATE, StandardOpenOption.WRITE);
        ByteBuffer buffer = ByteBuffer.allocate(64);
        buffer.putChar('A').flip();
        channel.write(buffer);
    }
    public void readWriteAbsolute() throws IOException {
        FileChannel channel = FileChannel.open(Paths.get("absolute.txt"), StandardOpenOption.READ, StandardOpenOption.CREATE, StandardOpenOption.WRITE);
        ByteBuffer writeBuffer = ByteBuffer.allocate(4).putChar('A').putChar('B');
        writeBuffer.flip();
        channel.write(writeBuffer, 1024);
        ByteBuffer readBuffer = ByteBuffer.allocate(2);
        channel.read(readBuffer, 1026);
        readBuffer.flip();
        char result = readBuffer.getChar(); //å€¼ä¸º'B'
    }
    /**
     * @param args the command line arguments
     */
    public static void main(String[] args) throws IOException {
        FileChannelUsage fcu = new FileChannelUsage();
        fcu.openAndWrite();
        fcu.readWriteAbsolute();
    }
}

```

### 6. JSR292 ä¸ InvokeDynamic

JSR 292: Supporting Dynamically Typed Languages on the JavaTM Platformï¼Œæ”¯æŒåœ¨ JVM ä¸Šè¿è¡ŒåŠ¨æ€ç±»å‹è¯­è¨€ã€‚åœ¨å­—èŠ‚ç å±‚é¢æ”¯æŒäº† InvokeDynamicã€‚

- æ–¹æ³•å¥æŸ„ MethodHandle

```java
public class ThreadPoolManager {
    private final ScheduledExecutorService stpe = Executors
            .newScheduledThreadPool(2);
    private final BlockingQueue<WorkUnit<String>> lbq;
    public ThreadPoolManager(BlockingQueue<WorkUnit<String>> lbq_) {
        lbq = lbq_;
    }
    public ScheduledFuture<?> run(QueueReaderTask msgReader) {
        msgReader.setQueue(lbq);
        return stpe.scheduleAtFixedRate(msgReader, 10, 10, TimeUnit.MILLISECONDS);
    }
    private void cancel(final ScheduledFuture<?> hndl) {
        stpe.schedule(new Runnable() {
            public void run() {
                hndl.cancel(true);
            }
        }, 10, TimeUnit.MILLISECONDS);
    }
    /**
     * ä½¿ç”¨ä¼ ç»Ÿçš„åå°„api
     */
    public Method makeReflective() {
        Method meth = null;
        try {
            Class<?>[] argTypes = new Class[]{ScheduledFuture.class};
            meth = ThreadPoolManager.class.getDeclaredMethod("cancel", argTypes);
            meth.setAccessible(true);
        } catch (IllegalArgumentException | NoSuchMethodException
                | SecurityException e) {
            e.printStackTrace();
        }
        return meth;
    }
    /**
     * ä½¿ç”¨ä»£ç†ç±»
     * @return
     */
    public CancelProxy makeProxy() {
        return new CancelProxy();
    }
    /**
     * ä½¿ç”¨Java7çš„æ–°apiï¼ŒMethodHandle
     * invoke virtual åŠ¨æ€ç»‘å®šåè°ƒç”¨ obj.xxx
     * invoke special é™æ€ç»‘å®šåè°ƒç”¨ super.xxx
     * @return
     */
    public MethodHandle makeMh() {
        MethodHandle mh;
        MethodType desc = MethodType.methodType(void.class, ScheduledFuture.class);
        try {
            mh = MethodHandles.lookup().findVirtual(ThreadPoolManager.class,
                    "cancel", desc);
        } catch (NoSuchMethodException | IllegalAccessException e) {
            throw (AssertionError) new AssertionError().initCause(e);
        }
        return mh;
    }
    public static class CancelProxy {
        private CancelProxy() {
        }
        public void invoke(ThreadPoolManager mae_, ScheduledFuture<?> hndl_) {
            mae_.cancel(hndl_);
        }
    }
}

```

- è°ƒç”¨ invoke

```java
public class ThreadPoolMain {
    /**
     * å¦‚æœè¢«ç»§æ‰¿ï¼Œè¿˜èƒ½åœ¨é™æ€ä¸Šä¸‹æ–‡å¯»æ‰¾æ­£ç¡®çš„class
     */
    private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());
    private ThreadPoolManager manager;
    public static void main(String[] args) {
        ThreadPoolMain main = new ThreadPoolMain();
        main.run();
    }
    private void cancelUsingReflection(ScheduledFuture<?> hndl) {
        Method meth = manager.makeReflective();
        try {
            System.out.println("With Reflection");
            meth.invoke(hndl);
        } catch (IllegalAccessException | IllegalArgumentException
                | InvocationTargetException e) {
            e.printStackTrace();
        }
    }
    private void cancelUsingProxy(ScheduledFuture<?> hndl) {
        CancelProxy proxy = manager.makeProxy();
        System.out.println("With Proxy");
        proxy.invoke(manager, hndl);
    }
    private void cancelUsingMH(ScheduledFuture<?> hndl) {
        MethodHandle mh = manager.makeMh();
        try {
            System.out.println("With Method Handle");
            mh.invokeExact(manager, hndl);
        } catch (Throwable e) {
            e.printStackTrace();
        }
    }
    private void run() {
        BlockingQueue<WorkUnit<String>> lbq = new LinkedBlockingQueue<>();
        manager = new ThreadPoolManager(lbq);
        final QueueReaderTask msgReader = new QueueReaderTask(100) {
            @Override
            public void doAction(String msg_) {
                if (msg_ != null)
                    System.out.println("Msg recvd: " + msg_);
            }
        };
        ScheduledFuture<?> hndl = manager.run(msgReader);
        cancelUsingMH(hndl);
        // cancelUsingProxy(hndl);
        // cancelUsingReflection(hndl);
    }
}

```

### 7. Path æ¥å£(é‡è¦æ¥å£æ›´æ–°)

- Path

```java
public class PathUsage {
    public void usePath() {
        Path path1 = Paths.get("folder1", "sub1");
        Path path2 = Paths.get("folder2", "sub2");
        path1.resolve(path2); //folder1\sub1\folder2\sub2
        path1.resolveSibling(path2); //folder1\folder2\sub2
        path1.relativize(path2); //..\..\folder2\sub2
        path1.subpath(0, 1); //folder1
        path1.startsWith(path2); //false
        path1.endsWith(path2); //false
        Paths.get("folder1/./../folder2/my.text").normalize(); //folder2\my.text
    }
    /**
     * @param args the command line arguments
     */
    public static void main(String[] args) {
        PathUsage usage = new PathUsage();
        usage.usePath();
    }
}

```

- DirectoryStream

```java
public class ListFile {
    public void listFiles() throws IOException {
        Path path = Paths.get("");
        try (DirectoryStream<Path> stream = Files.newDirectoryStream(path, "*.*")) {
            for (Path entry: stream) {
                //ä½¿ç”¨entry
                System.out.println(entry);
            }
        }
    }
    /**
     * @param args the command line arguments
     */
    public static void main(String[] args) throws IOException {
        ListFile listFile = new ListFile();
        listFile.listFiles();
    }
}

```

- Files

```java
public class FilesUtils {
    public void manipulateFiles() throws IOException {
        Path newFile = Files.createFile(Paths.get("new.txt").toAbsolutePath());
        List<String> content = new ArrayList<String>();
        content.add("Hello");
        content.add("World");
        Files.write(newFile, content, Charset.forName("UTF-8"));
        Files.size(newFile);
        byte[] bytes = Files.readAllBytes(newFile);
        ByteArrayOutputStream output = new ByteArrayOutputStream();
        Files.copy(newFile, output);
        Files.delete(newFile);
    }
    /**
     * @param args the command line arguments
     */
    public static void main(String[] args) throws IOException {
        FilesUtils fu = new FilesUtils();
        fu.manipulateFiles();
    }
}

```

- WatchService

```java
public class WatchAndCalculate {
    public void calculate() throws IOException, InterruptedException {
        WatchService service = FileSystems.getDefault().newWatchService();
        Path path = Paths.get("").toAbsolutePath();
        path.register(service, StandardWatchEventKinds.ENTRY_CREATE);
        while (true) {
            WatchKey key = service.take();
            for (WatchEvent<?> event : key.pollEvents()) {
                Path createdPath = (Path) event.context();
                createdPath = path.resolve(createdPath);
                long size = Files.size(createdPath);
                System.out.println(createdPath + " ==> " + size);
            }
            key.reset();
        }
    }
    /**
     * @param args the command line arguments
     */
    public static void main(String[] args) throws Throwable {
        WatchAndCalculate wc = new WatchAndCalculate();
        wc.calculate();
    }
}

```

### 8. fork/join è®¡ç®—æ¡†æ¶

Java7 æä¾›çš„ä¸€ä¸ªç”¨äºå¹¶è¡Œæ‰§è¡Œä»»åŠ¡çš„æ¡†æ¶ï¼Œæ˜¯ä¸€ä¸ªæŠŠå¤§ä»»åŠ¡åˆ†å‰²æˆè‹¥å¹²ä¸ªå°ä»»åŠ¡ï¼Œæœ€ç»ˆæ±‡æ€»æ¯ä¸ªå°ä»»åŠ¡ç»“æœåå¾—åˆ°å¤§ä»»åŠ¡ç»“æœçš„æ¡†æ¶ã€‚

è¯¥æ¡†æ¶ä¸º Java8 çš„å¹¶è¡Œæµæ‰“ä¸‹äº†åšå®çš„åŸºç¡€

## JDK8 æ–°ç‰¹æ€§

Java5 å¼€å‘ä»£å·ä¸º Tiger(è€è™),äº 2004-09-30 å‘è¡Œ

### 1. Lambda è¡¨è¾¾å¼

Lambda è¡¨è¾¾å¼ï¼Œä¹Ÿå¯ç§°ä¸ºé—­åŒ…ï¼Œå®ƒæ˜¯æ¨åŠ¨ Java 8 å‘å¸ƒçš„æœ€é‡è¦æ–°ç‰¹æ€§ã€‚
Lambda å…è®¸æŠŠå‡½æ•°ä½œä¸ºä¸€ä¸ªæ–¹æ³•çš„å‚æ•°ï¼ˆå‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’è¿›æ–¹æ³•ä¸­ï¼‰ã€‚
ä½¿ç”¨ Lambda è¡¨è¾¾å¼å¯ä»¥ä½¿ä»£ç å˜çš„æ›´åŠ ç®€æ´ç´§å‡‘ã€‚

Lambda è¡¨è¾¾å¼å¯ä»¥è¯´æ˜¯ Java 8 æœ€å¤§çš„å–ç‚¹ï¼Œå¥¹å°†å‡½æ•°å¼ç¼–ç¨‹å¼•å…¥äº† Javaã€‚Lambda å…è®¸æŠŠå‡½æ•°ä½œä¸ºä¸€ä¸ªæ–¹æ³•çš„å‚æ•°ï¼Œæˆ–è€…æŠŠä»£ç çœ‹æˆæ•°æ®ã€‚

ä¸€ä¸ª Lambda è¡¨è¾¾å¼å¯ä»¥ç”±ç”¨é€—å·åˆ†éš”çš„å‚æ•°åˆ—è¡¨ã€â€“>ç¬¦å·ä¸å‡½æ•°ä½“ä¸‰éƒ¨åˆ†è¡¨ç¤ºã€‚ä¾‹å¦‚ï¼š

```java
Arrays.asList( "p", "k", "u","f", "o", "r","k").forEach( e -> System.out.println( e ) );
```

ä¸ºäº†ä½¿ç°æœ‰å‡½æ•°æ›´å¥½çš„æ”¯æŒ Lambda è¡¨è¾¾å¼ï¼ŒJava 8 å¼•å…¥äº†å‡½æ•°å¼æ¥å£çš„æ¦‚å¿µã€‚å‡½æ•°å¼æ¥å£å°±æ˜¯åªæœ‰ä¸€ä¸ªæ–¹æ³•çš„æ™®é€šæ¥å£ã€‚java.lang.Runnable ä¸ java.util.concurrent.Callable æ˜¯å‡½æ•°å¼æ¥å£æœ€å…¸å‹çš„ä¾‹å­ã€‚ä¸ºæ­¤ï¼ŒJava 8 å¢åŠ äº†ä¸€ç§ç‰¹æ®Šçš„æ³¨è§£@FunctionalInterface

### 2. æ¥å£çš„é»˜è®¤æ–¹æ³•ä¸é™æ€æ–¹æ³•

æˆ‘ä»¬å¯ä»¥åœ¨æ¥å£ä¸­å®šä¹‰é»˜è®¤æ–¹æ³•ï¼Œä½¿ç”¨ default å…³é”®å­—ï¼Œå¹¶æä¾›é»˜è®¤çš„å®ç°ã€‚æ‰€æœ‰å®ç°è¿™ä¸ªæ¥å£çš„ç±»éƒ½ä¼šæ¥å—é»˜è®¤æ–¹æ³•çš„å®ç°ï¼Œé™¤éå­ç±»æä¾›çš„è‡ªå·±çš„å®ç°ã€‚ä¾‹å¦‚ï¼š

```java
 public interface DefaultFunctionInterface {
     default String defaultFunction() {
         return "default function";
     }
 }
```

æˆ‘ä»¬è¿˜å¯ä»¥åœ¨æ¥å£ä¸­å®šä¹‰é™æ€æ–¹æ³•ï¼Œä½¿ç”¨ static å…³é”®å­—ï¼Œä¹Ÿå¯ä»¥æä¾›å®ç°ã€‚ä¾‹å¦‚ï¼š

```java
 public interface StaticFunctionInterface {
     static String staticFunction() {
         return "static function";
     }
 }

```

æ¥å£çš„é»˜è®¤æ–¹æ³•å’Œé™æ€æ–¹æ³•çš„å¼•å…¥ï¼Œå…¶å®å¯ä»¥è®¤ä¸ºå¼•å…¥äº† C ï¼‹ï¼‹ä¸­æŠ½è±¡ç±»çš„ç†å¿µï¼Œä»¥åæˆ‘ä»¬å†ä¹Ÿä¸ç”¨åœ¨æ¯ä¸ªå®ç°ç±»ä¸­éƒ½å†™é‡å¤çš„ä»£ç äº†ã€‚

### 3. æ–¹æ³•å¼•ç”¨ï¼ˆå«æ„é€ æ–¹æ³•å¼•ç”¨ï¼‰

é€šå¸¸ä¸ Lambda è¡¨è¾¾å¼è”åˆä½¿ç”¨ï¼Œå¯ä»¥ç›´æ¥å¼•ç”¨å·²æœ‰ Java ç±»æˆ–å¯¹è±¡çš„æ–¹æ³•ã€‚ä¸€èˆ¬æœ‰å››ç§ä¸åŒçš„æ–¹æ³•å¼•ç”¨ï¼š

1. æ„é€ å™¨å¼•ç”¨ã€‚è¯­æ³•æ˜¯ Class::newï¼Œæˆ–è€…æ›´ä¸€èˆ¬çš„ Class< T >::newï¼Œè¦æ±‚æ„é€ å™¨æ–¹æ³•æ˜¯æ²¡æœ‰å‚æ•°ï¼›
2. é™æ€æ–¹æ³•å¼•ç”¨ã€‚è¯­æ³•æ˜¯ Class::static_methodï¼Œè¦æ±‚æ¥å—ä¸€ä¸ª Class ç±»å‹çš„å‚æ•°ï¼›
3. ç‰¹å®šç±»çš„ä»»æ„å¯¹è±¡æ–¹æ³•å¼•ç”¨ã€‚å®ƒçš„è¯­æ³•æ˜¯ Class::methodã€‚è¦æ±‚æ–¹æ³•æ˜¯æ²¡æœ‰å‚æ•°çš„ï¼›
4. ç‰¹å®šå¯¹è±¡çš„æ–¹æ³•å¼•ç”¨ï¼Œå®ƒçš„è¯­æ³•æ˜¯ instance::methodã€‚è¦æ±‚æ–¹æ³•æ¥å—ä¸€ä¸ªå‚æ•°ï¼Œä¸ 3 ä¸åŒçš„åœ°æ–¹åœ¨äºï¼Œ3 æ˜¯åœ¨åˆ—è¡¨å…ƒç´ ä¸Šåˆ†åˆ«è°ƒç”¨æ–¹æ³•ï¼Œè€Œ 4 æ˜¯åœ¨æŸä¸ªå¯¹è±¡ä¸Šè°ƒç”¨æ–¹æ³•ï¼Œå°†åˆ—è¡¨å…ƒç´ ä½œä¸ºå‚æ•°ä¼ å…¥ï¼›

### 4. é‡å¤æ³¨è§£

åœ¨ Java 5 ä¸­ä½¿ç”¨æ³¨è§£æœ‰ä¸€ä¸ªé™åˆ¶ï¼Œå³ç›¸åŒçš„æ³¨è§£åœ¨åŒä¸€ä½ç½®åªèƒ½å£°æ˜ä¸€æ¬¡ã€‚Java 8 å¼•å…¥é‡å¤æ³¨è§£ï¼Œè¿™æ ·ç›¸åŒçš„æ³¨è§£åœ¨åŒä¸€åœ°æ–¹ä¹Ÿå¯ä»¥å£°æ˜å¤šæ¬¡ã€‚é‡å¤æ³¨è§£æœºåˆ¶æœ¬èº«éœ€è¦ç”¨@Repeatable æ³¨è§£ã€‚Java 8 åœ¨ç¼–è¯‘å™¨å±‚åšäº†ä¼˜åŒ–ï¼Œç›¸åŒæ³¨è§£ä¼šä»¥é›†åˆçš„æ–¹å¼ä¿å­˜ï¼Œå› æ­¤åº•å±‚çš„åŸç†å¹¶æ²¡æœ‰å˜åŒ–ã€‚

### 5. æ‰©å±•æ³¨è§£çš„æ”¯æŒï¼ˆç±»å‹æ³¨è§£ï¼‰

Java 8 æ‰©å±•äº†æ³¨è§£çš„ä¸Šä¸‹æ–‡ï¼Œå‡ ä¹å¯ä»¥ä¸ºä»»ä½•ä¸œè¥¿æ·»åŠ æ³¨è§£ï¼ŒåŒ…æ‹¬å±€éƒ¨å˜é‡ã€æ³›å‹ç±»ã€çˆ¶ç±»ä¸æ¥å£çš„å®ç°ï¼Œè¿æ–¹æ³•çš„å¼‚å¸¸ä¹Ÿèƒ½æ·»åŠ æ³¨è§£

```java
private @NotNull String name;

```

### 6. Optional

Java 8 å¼•å…¥ Optional ç±»æ¥é˜²æ­¢ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼ŒOptional ç±»æœ€å…ˆæ˜¯ç”± Google çš„ Guava é¡¹ç›®å¼•å…¥çš„ã€‚Optional ç±»å®é™…ä¸Šæ˜¯ä¸ªå®¹å™¨ï¼šå®ƒå¯ä»¥ä¿å­˜ç±»å‹ T çš„å€¼ï¼Œæˆ–è€…ä¿å­˜ nullã€‚ä½¿ç”¨ Optional ç±»æˆ‘ä»¬å°±ä¸ç”¨æ˜¾å¼è¿›è¡Œç©ºæŒ‡é’ˆæ£€æŸ¥äº†

å¯ä»¥é€šè¿‡ä»¥ä¸‹å®ä¾‹æ¥æ›´å¥½çš„äº†è§£ Optional ç±»çš„ä½¿ç”¨ï¼š

```java
public static void main(String args[]) {
    Integer value1 = null;
    Integer value2 = new Integer(10);
    // å…è®¸ä¼ é€’ä¸ºnullå‚æ•°
    Optional<Integer> a = Optional.ofNullable(value1);
    // å¦‚æœä¼ é€’çš„å‚æ•°æ˜¯nullï¼ŒæŠ›å‡ºå¼‚å¸¸NullPointerException
    Optional<Integer> b = Optional.of(value2);
    System.out.println(sum(a, b));
}
public Integer sum(Optional<Integer>a, Optional<Integer>b) {
    // åˆ¤æ–­å€¼æ˜¯å¦å­˜åœ¨
    System.out.println("ç¬¬ä¸€ä¸ªå‚æ•°å€¼å­˜åœ¨:" + a.isPresent());
    System.out.println("ç¬¬äºŒä¸ªå‚æ•°å€¼å­˜åœ¨:" + b.isPresent());
    // å¦‚æœå€¼å­˜åœ¨ï¼Œè¿”å›å®ƒï¼Œå¦åˆ™è¿”å›é»˜è®¤å€¼
    Integer value1 = a.orElse(new Integer(0));
    // è·å–å€¼ï¼Œå€¼éœ€è¦å­˜åœ¨
    Integer value2 = b.get();
    return value1 + value2;
}
```

è¾“å‡º

```
ç¬¬ä¸€ä¸ªå‚æ•°å€¼å­˜åœ¨: false
ç¬¬äºŒä¸ªå‚æ•°å€¼å­˜åœ¨: true
10
```

### 7. Stream

Stream API æ˜¯æŠŠçœŸæ­£çš„å‡½æ•°å¼ç¼–ç¨‹é£æ ¼å¼•å…¥åˆ° Java ä¸­ã€‚å…¶å®ç®€å•æ¥è¯´å¯ä»¥æŠŠ Stream ç†è§£ä¸º MapReduceï¼Œå½“ç„¶ Google çš„ MapReduce çš„çµæ„Ÿä¹Ÿæ˜¯æ¥è‡ªå‡½æ•°å¼ç¼–ç¨‹ã€‚å¥¹å…¶å®æ˜¯ä¸€è¿ä¸²æ”¯æŒè¿ç»­ã€å¹¶è¡Œèšé›†æ“ä½œçš„å…ƒç´ ã€‚ä»è¯­æ³•ä¸Šçœ‹ï¼Œä¹Ÿå¾ˆåƒ linux çš„ç®¡é“ã€æˆ–è€…é“¾å¼ç¼–ç¨‹ï¼Œä»£ç å†™èµ·æ¥ç®€æ´æ˜äº†ï¼Œéå¸¸é…·å¸…ï¼

### 8. Date/Time API (JSR 310)

Java 8 æ–°çš„ Date-Time API (JSR 310)å— Joda-Time çš„å½±å“ï¼Œæä¾›äº†æ–°çš„ java.time åŒ…ï¼Œå¯ä»¥ç”¨æ¥æ›¿ä»£ java.util.Date å’Œ java.util.Calendarã€‚ä¸€èˆ¬ä¼šç”¨åˆ° Clockã€LocaleDateã€LocalTimeã€LocaleDateTimeã€ZonedDateTimeã€Duration è¿™äº›ç±»ï¼Œå¯¹äºæ—¶é—´æ—¥æœŸçš„æ”¹è¿›è¿˜æ˜¯éå¸¸ä¸é”™çš„ã€‚

### 9. JavaScript å¼•æ“ Nashorn

Nashorn å…è®¸åœ¨ JVM ä¸Šå¼€å‘è¿è¡Œ JavaScript åº”ç”¨ï¼Œå…è®¸ Java ä¸ JavaScript ç›¸äº’è°ƒç”¨ã€‚

### 10. Base64

åœ¨ Java 8 ä¸­ï¼ŒBase64 ç¼–ç æˆä¸ºäº† Java ç±»åº“çš„æ ‡å‡†ã€‚Base64 ç±»åŒæ—¶è¿˜æä¾›äº†å¯¹ URLã€MIME å‹å¥½çš„ç¼–ç å™¨ä¸è§£ç å™¨ã€‚

ä»¥ä¸‹å®ä¾‹æ¼”ç¤ºäº† Base64 çš„ä½¿ç”¨:

```java
@Test
public void base64Test() throws UnsupportedEncodingException {
    // ä½¿ç”¨åŸºæœ¬ç¼–ç 
    String base64encodedString = Base64.getEncoder().encodeToString("java@crankz".getBytes("utf-8"));
    System.out.println("Base64 ç¼–ç å­—ç¬¦ä¸² (åŸºæœ¬) :" + base64encodedString);
    // è§£ç 
    byte[] base64decodedBytes = Base64.getDecoder().decode(base64encodedString);
    System.out.println("åŸå§‹å­—ç¬¦ä¸²: " + new String(base64decodedBytes, "utf-8"));
}
```

è¾“å‡º

```
Base64 ç¼–ç å­—ç¬¦ä¸² (åŸºæœ¬) :amF2YUBjcmFua3o=
åŸå§‹å­—ç¬¦ä¸²: java@crankz
```

### 11. JVM çš„ PermGen ç©ºé—´è¢«ç§»é™¤

å–ä»£å®ƒçš„æ˜¯ [Metaspace(JEP 122)](../jvm/metaspace.md)

Java 8 æ˜¯ä¸€æ¬¡å˜åŒ–å·¨å¤§çš„æ›´æ–°ï¼Œè€—è´¹äº†å·¥ç¨‹å¸ˆå¤§é‡çš„æ—¶é—´ï¼Œè¿˜å€Ÿé‰´äº†å¾ˆå¤šå…¶å®ƒè¯­è¨€å’Œç±»åº“ã€‚æˆ‘ä»¬æ— æ³•åœ¨è¿™é‡Œä¸€ä¸€è¯¦ç»†åˆ—ä¸¾ï¼Œä»¥åæœ‰æœºä¼šä¸€å®šç»™å¤§å®¶è¯¦ç»†è§£è¯»ä¸€ä¸‹ã€‚

### 12. HashMap æ”¹è¿›

## JDK9 æ–°ç‰¹æ€§

# 1 Java å¹³å°æ¨¡å—åŒ–ç³»ç»Ÿ

è¯¥ç‰¹æ€§æ˜¯ Java 9 æœ€å¤§çš„ä¸€ä¸ªç‰¹æ€§ï¼ŒJava 9 èµ·åˆçš„ä»£å·å°±å« Jigsawï¼Œæœ€è¿‘è¢«æ›´æ”¹ä¸º Modularityï¼ŒModularity æä¾›äº†ç±»ä¼¼äº OSGI æ¡†æ¶çš„åŠŸèƒ½ï¼Œæ¨¡å—ä¹‹é—´å­˜åœ¨ç›¸äº’çš„ä¾èµ–å…³ç³»ï¼Œå¯ä»¥å¯¼å‡ºä¸€ä¸ªå…¬å…±çš„ APIï¼Œå¹¶ä¸”éšè—å®ç°çš„ç»†èŠ‚ï¼ŒJava æä¾›è¯¥åŠŸèƒ½çš„ä¸»è¦çš„åŠ¨æœºåœ¨äºï¼Œå‡å°‘å†…å­˜çš„å¼€é”€ï¼Œæˆ‘ä»¬å¤§å®¶éƒ½çŸ¥é“ï¼Œåœ¨ JVM å¯åŠ¨çš„æ—¶å€™ï¼Œè‡³å°‘ä¼šæœ‰ 30 ï½ 60MB çš„å†…å­˜åŠ è½½ï¼Œä¸»è¦åŸå› æ˜¯ JVM éœ€è¦åŠ è½½ rt.jarï¼Œä¸ç®¡å…¶ä¸­çš„ç±»æ˜¯å¦è¢« classloader åŠ è½½ï¼Œç¬¬ä¸€æ­¥æ•´ä¸ª jar éƒ½ä¼šè¢« JVM åŠ è½½åˆ°å†…å­˜å½“ä¸­å»ï¼Œæ¨¡å—åŒ–å¯ä»¥æ ¹æ®æ¨¡å—çš„éœ€è¦åŠ è½½ç¨‹åºè¿è¡Œéœ€è¦çš„ classï¼Œé‚£ä¹ˆ JVM æ˜¯å¦‚ä½•çŸ¥é“éœ€è¦åŠ è½½é‚£äº› class çš„å‘¢ï¼Ÿè¿™å°±æ˜¯åœ¨ Java 9 ä¸­å¼•å…¥çš„ä¸€ä¸ªæ–°çš„æ–‡ä»¶ module.java æˆ‘ä»¬å¤§è‡´æ¥çœ‹ä¸€ä¸‹ä¸€ä¸ªä¾‹å­ï¼ˆmodule-info.javaï¼‰

## æ¨¡å—æè¿°å™¨

æ¨¡å—åŒ–çš„ JAR æ–‡ä»¶éƒ½åŒ…å«ä¸€ä¸ªé¢å¤–çš„æ¨¡å—æè¿°å™¨ã€‚åœ¨è¿™ä¸ªæ¨¡å—æè¿°å™¨ä¸­, å¯¹å…¶å®ƒæ¨¡å—çš„ä¾èµ–æ˜¯é€šè¿‡ â€œrequiresâ€ æ¥è¡¨ç¤ºçš„ã€‚å¦å¤–, â€œexportsâ€ è¯­å¥æ§åˆ¶ç€å†…éƒ¨çš„å“ªäº›åŒ…æ˜¯å¯ä»¥è¢«å…¶å®ƒæ¨¡å—è®¿é—®åˆ°çš„ã€‚æ‰€æœ‰ä¸è¢«å¯¼å‡ºçš„åŒ…é»˜è®¤éƒ½å°è£…åœ¨æ¨¡å—çš„é‡Œé¢ã€‚å¦‚ä¸‹æ˜¯ä¸€ä¸ªæ¨¡å—æè¿°å™¨çš„ç¤ºä¾‹ï¼Œå­˜åœ¨äº â€œmodule-info.javaâ€ æ–‡ä»¶ä¸­

```
module blog {
 exports com.pluralsight.blog;

 requires cms;
}

```

![20241229154732_TMNcVlSD.webp](https://cdn.dong4j.site/source/image/20241229154732_TMNcVlSD.webp)

## jlink:Java è¿æ¥å™¨

# 2 æ–°å·¥å…·

## 2.1 JShell

Java 9 é¦–æ¬¡ä¸º Java è¯­è¨€æä¾›äº† REPL å·¥å…·ï¼Œåä¸º JShellã€‚æˆ‘ä»¬å¯ä»¥åœ¨å‘½ä»¤è¡Œæˆ–è€…åœ¨ IntelliJ IDEA çš„ç»ˆç«¯ä¸­è¿è¡Œè¯¥ REPLã€‚

![20241229154732_ixluTsKJ.webp](https://cdn.dong4j.site/source/image/20241229154732_ixluTsKJ.webp)

115-1506508766622.gif

åœ¨ Java 8 å‡ºæ¥çš„æ—¶å€™ï¼Œå¾ˆå¤šäººéƒ½å–Šç€ï¼Œè¿™æ˜¯è¦æŠ¢å¤º Scala ç­‰åŸºäº JVM åŠ¨æ€è¯­è¨€çš„å¸‚åœºå•Šï¼Œå…¶ä¸­æœ‰äººç»™å‡ºäº†ä¸€ä¸ª Java åšä¸åˆ°çš„æ–¹å‘ï¼Œé‚£å°±æ˜¯ Scala å¯ä»¥å½“ä½œè„šæœ¬è¯­è¨€ï¼ŒJava å¯ä»¥ä¹ˆï¼Ÿå¾ˆæ˜æ˜¾åœ¨æ­¤ä¹‹å‰ Java ä¸è¡Œï¼Œta ä¹Ÿä¸å…·å¤‡åŠ¨æ€æ€§ï¼Œä½†æ˜¯æ­¤æ¬¡ Java 9 å´è®© Java ä¹Ÿå¯ä»¥åƒè„šæœ¬è¯­è¨€ä¸€æ ·æ¥è¿è¡Œäº†ï¼Œä¸»è¦å¾—ç›Šäº JShellï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ¼”ç¤º

```
jdk-9\bin>jshell.exe
|  Welcome to JShell -- Version 9
|  For an introduction type: /help intro
jshell> "This is my long string. I want a part of it".substring(8,19);
$5 ==> "my long string"

```

è¿™æ˜¯æˆ‘ä»¬åœ¨ Jshell è¿™ä¸ªæ§åˆ¶å°ä¸‹è¿è¡Œï¼Œæˆ‘ä»¬å¦‚ä½•è¿è¡Œè„šæœ¬æ–‡ä»¶å‘¢ï¼Ÿ

```
jshell> /save c:\develop\JShell_hello_world.txt
jshell> /open c:\develop\JShell_hello_world.txt
Hello JShell!

```

## 2.2 æ›´å¤šçš„è¯Šæ–­å‘½ä»¤

è®°å¾—åœ¨ Java 8 ä¸­ï¼Œæ”¾å¼ƒäº† Jhat è¿™ä¸ªå‘½ä»¤ï¼Œä½†æ˜¯å¾ˆå¿«åœ¨ Java 9 ä¸­å¢åŠ äº†ä¸€äº›æ–°çš„å‘½ä»¤ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦ä»‹ç»åˆ°çš„ jcmd,å€ŸåŠ©å®ƒä½ å¯ä»¥å¾ˆå¥½çš„çœ‹åˆ°ç±»ä¹‹é—´çš„ä¾èµ–å…³ç³»

```
jdk-9\bin>jcmd 14056 VM.class_hierarchy -i -s java.net.Socket
14056:
java.lang.Object/null
|--java.net.Socket/null
|  implements java.io.Closeable/null (declared intf)
|  implements java.lang.AutoCloseable/null (inherited intf)
|  |--org.eclipse.ecf.internal.provider.filetransfer.httpclient4.CloseMonitoringSocket
|  |  implements java.lang.AutoCloseable/null (inherited intf)
|  |  implements java.io.Closeable/null (inherited intf)
|  |--javax.net.ssl.SSLSocket/null
|  |  implements java.lang.AutoCloseable/null (inherited intf)
|  |  implements java.io.Closeable/null (inherited intf)

```

# 3 å¤šç‰ˆæœ¬å…¼å®¹ Jar

æˆ‘ä»¬æœ€åè¦æ¥ç€é‡ä»‹ç»çš„è¿™ä¸ªç‰¹æ€§å¯¹äºåº“çš„ç»´æŠ¤è€…è€Œè¨€æ˜¯ä¸ªç‰¹åˆ«å¥½çš„æ¶ˆæ¯ã€‚å½“ä¸€ä¸ªæ–°ç‰ˆæœ¬çš„ Java å‡ºç°çš„æ—¶å€™ï¼Œä½ çš„åº“ç”¨æˆ·è¦èŠ±è´¹æ•°å¹´æ—¶é—´æ‰ä¼šåˆ‡æ¢åˆ°è¿™ä¸ªæ–°çš„ç‰ˆæœ¬ã€‚è¿™å°±æ„å‘³ç€åº“å¾—å»å‘åå…¼å®¹ä½ æƒ³è¦æ”¯æŒçš„æœ€è€çš„ Java ç‰ˆæœ¬ (è®¸å¤šæƒ…å†µä¸‹å°±æ˜¯ Java 6 æˆ–è€… 7)ã€‚è¿™å®é™…ä¸Šæ„å‘³ç€æœªæ¥çš„å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œä½ éƒ½ä¸èƒ½åœ¨åº“ä¸­è¿ç”¨ Java 9 æ‰€æä¾›çš„æ–°ç‰¹æ€§ã€‚å¹¸è¿çš„æ˜¯ï¼Œå¤šç‰ˆæœ¬å…¼å®¹ JAR åŠŸèƒ½èƒ½è®©ä½ åˆ›å»ºä»…åœ¨ç‰¹å®šç‰ˆæœ¬çš„ Java ç¯å¢ƒä¸­è¿è¡Œåº“ç¨‹åºæ—¶é€‰æ‹©ä½¿ç”¨çš„ class ç‰ˆæœ¬ï¼š

```
multirelease.jar
â”œâ”€â”€ META-INF
â”‚  â””â”€â”€ versions
â”‚    â””â”€â”€ 9
â”‚      â””â”€â”€ multirelease
â”‚        â””â”€â”€ Helper.class
â”œâ”€â”€ multirelease
  â”œâ”€â”€ Helper.class
  â””â”€â”€ Main.class

```

åœ¨ä¸Šè¿°åœºæ™¯ä¸­ï¼Œ multirelease.jar å¯ä»¥åœ¨ Java 9 ä¸­ä½¿ç”¨, ä¸è¿‡ Helper è¿™ä¸ªç±»ä½¿ç”¨çš„ä¸æ˜¯é¡¶å±‚çš„ multirelease.Helper è¿™ä¸ª class, è€Œæ˜¯å¤„åœ¨â€œMETA-INF/versions/9â€ä¸‹é¢çš„è¿™ä¸ªã€‚è¿™æ˜¯ç‰¹åˆ«ä¸º Java 9 å‡†å¤‡çš„ class ç‰ˆæœ¬ï¼Œå¯ä»¥è¿ç”¨ Java 9 æ‰€æä¾›çš„ç‰¹æ€§å’Œåº“ã€‚åŒæ—¶ï¼Œåœ¨æ—©æœŸçš„ Java è¯¸ç‰ˆæœ¬ä¸­ä½¿ç”¨è¿™ä¸ª JAR ä¹Ÿæ˜¯èƒ½è¿è¡Œçš„ï¼Œå› ä¸ºè¾ƒè€ç‰ˆæœ¬çš„ Java åªä¼šçœ‹åˆ°é¡¶å±‚çš„è¿™ä¸ª Helper ç±»ã€‚

# 4 æ–°çš„å®‰å…¨æ€§

## 4.1 æ•°æ®æŠ¥ä¼ è¾“å±‚å®‰å…¨æ€§(DTLSï¼‰

## 4.2 ç¦ç”¨ sha - 1 è¯ä¹¦

å¼•å…¥äº† SHA-3 çš„ hash ç®—æ³•

# 5 æ ¸å¿ƒåº“æ–°å†…å®¹

## 5.1 è½»é‡çº§çš„ json æ–‡æœ¬å¤„ç† api

## 5.2 å¤šçº¿ç¨‹æ–°å†…å®¹

æ–°å¢ ProcessHandle ç±»ï¼Œè¯¥ç±»æä¾›è¿›ç¨‹çš„æœ¬åœ°è¿›ç¨‹ IDã€å‚æ•°ã€å‘½ä»¤ã€å¯åŠ¨æ—¶é—´ã€ç´¯è®¡ CPU æ—¶é—´ã€ç”¨æˆ·ã€çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ã€‚è¿™ä¸ªç±»è¿˜å¯ä»¥ç›‘æ§è¿›ç¨‹çš„æ´»åŠ›å’Œç ´åè¿›ç¨‹ã€‚ProcessHandleã€‚onExit æ–¹æ³•ï¼Œå½“è¿›ç¨‹é€€å‡ºæ—¶ï¼Œå¤æ‚æœªæ¥ç±»çš„å¼‚æ­¥æœºåˆ¶å¯ä»¥æ‰§è¡Œä¸€ä¸ªæ“ä½œã€‚
åŒ…æ‹¬ä¸€ä¸ªå¯äº’æ“ä½œçš„å‘å¸ƒ-è®¢é˜…æ¡†æ¶ï¼Œä»¥åŠå¯¹ CompletableFuture API çš„å¢å¼ºã€‚
åœ¨ Java å¾ˆæ—©çš„ç‰ˆæœ¬ä¸­ï¼Œæä¾›äº† Process è¿™æ ·çš„ API å¯ä»¥è·å¾—è¿›ç¨‹çš„ä¸€äº›ä¿¡æ¯ï¼ŒåŒ…æ‹¬ runtimeï¼Œç”šè‡³æ˜¯ç”¨å®ƒæ¥æ‰§è¡Œå½“å‰ä¸»æœºçš„ä¸€äº›å‘½ä»¤ï¼Œä½†æ˜¯è¯·å¤§å®¶æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œä½ å¦‚ä½•è·å¾—ä½ å½“å‰ Java è¿è¡Œç¨‹åºçš„ PIDï¼Ÿå¾ˆæ˜¾ç„¶é€šè¿‡ Process æ˜¯æ— æ³•è·å¾—çš„ï¼Œéœ€è¦å€ŸåŠ©äº JMX æ‰èƒ½å¾—åˆ°ï¼Œä½†æ˜¯åœ¨è¿™ä¸€æ¬¡çš„å¢å¼ºä¸­ï¼Œä½ å°†ä¼šå¾ˆè½»æ¾çš„å¾—åˆ°è¿™æ ·çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­

```
ProcessHandle self = ProcessHandle.current();
long PID = self.getPid();
ProcessHandle.Info procInfo = self.info();

Optional<String[]> args = procInfo.arguments();
Optional<String> cmd =  procInfo.commandLine();
Optional<Instant> startTime = procInfo.startInstant();
Optional<Duration> cpuUsage = procInfo.totalCpuDuration();

```

å·²ç»è·å–åˆ°äº† JVM çš„è¿›ç¨‹ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å°†è¯¥è¿›ç¨‹ä¼˜é›…çš„åœæ‰å‘¢ï¼Ÿä¸‹é¢çš„ä»£ç ç»™å‡ºäº†ç­”æ¡ˆ

```
childProc = ProcessHandle.current().children();
childProc.forEach(procHandle -> {
    assertTrue("Could not kill process " + procHandle.getPid(), procHandle.destroy());
});

```

é€šè¿‡ä¸Šé¢çš„ä¸€å°æ®µä»£ç ï¼Œæˆ‘ä»¬ä¹Ÿå‘ç°äº† Java 9 å¯¹æ–­è¨€æœºåˆ¶åŒæ ·å¢åŠ äº†ä¸€äº›å¢å¼ºï¼Œå¤šè¯´ä¸€äº›é¢˜å¤–è¯ï¼Œæˆ‘ä»¬ç›®å‰çš„ç³»ç»Ÿä¸­è¿è¡Œä¸€ä¸ªä¸¥é‡ä¾èµ–äº Hive beelineServer çš„ç¨‹åºï¼Œbeeline server ä¸æ˜¯å¾ˆç¨³å®šï¼Œç»å¸¸å‡ºç°å¡é¡¿ï¼Œç”šè‡³å‡æ­»ï¼Œå‡æ­»åä¹Ÿä¸å›å¤çš„é—®é¢˜ï¼Œè¿™æ ·å°±å¯¼è‡´æˆ‘ä»¬çš„ç¨‹åºä¹Ÿä¼šå‡ºç°å¡é¡¿ï¼Œå¦‚æœè¿ç»´äººå‘˜ä¸å¯¹å…¶è¿›è¡Œæ¸…ç†ï¼Œç³»ç»Ÿè¿è¡Œå‡ ä¸ªæœˆä¹‹åä¼šå‘ç°å¾ˆå¤šåƒµå°¸è¿›ç¨‹ï¼Œäºæ˜¯å¢åŠ ä¸€ä¸ªè·å–å½“å‰ JVM PID çš„åŠŸèƒ½ï¼Œç„¶ååˆ¤æ–­åˆ°è¶…è¿‡ç»™å®šçš„æ—¶é—´å¯¹å…¶è¿›è¡Œä¸»åŠ¨æ€æ­»ï¼Œå®Œå…¨æ˜¯ç¨‹åºå†…éƒ¨çš„è¡Œä¸ºï¼Œä½†æ˜¯è·å– PID å°±å¿…é¡»å€ŸåŠ©äº JMX çš„åŠ¨ä½œï¼Œå¦å¤–æ€æ­»å®ƒä¹Ÿå¿…é¡»å€ŸåŠ©äºæ“ä½œç³»ç»Ÿçš„å‘½ä»¤ï¼Œè¯¸å¦‚ kill è¿™æ ·çš„å‘½ä»¤ï¼Œæ˜¾å¾—éå¸¸çš„éº»çƒ¦ï¼Œä½†æ˜¯ Java 9 çš„æ–¹å¼æ˜æ˜¾è¦ä¼˜é›…æ–¹ä¾¿è®¸å¤šã€‚

### Publish-Subscribe Framework

åœ¨æ–°ç‰ˆçš„ JDK 9 ä¸­æä¾›äº†æ¶ˆæ¯å‘å¸ƒè®¢é˜…çš„æ¡†æ¶ï¼Œè¯¥æ¡†æ¶ä¸»è¦æ˜¯ç”± Flow è¿™ä¸ªç±»æä¾›çš„ï¼Œä»–åŒæ ·ä¼šåœ¨ java.util.concurrent ä¸­å‡ºç°ï¼Œå¹¶ä¸”æä¾›äº† Reactive ç¼–ç¨‹æ¨¡å¼ã€‚

## 5.3 åŸºç¡€ç±»æ–°å†…å®¹

ç”¨å°‘é‡çš„å…ƒç´ åˆ›å»ºé›†åˆå’Œæ˜ å°„çš„å®ä¾‹æ›´å®¹æ˜“ã€‚åœ¨åˆ—è¡¨ã€è®¾ç½®å’Œæ˜ å°„æ¥å£ä¸Šçš„æ–°é™æ€å·¥å‚æ–¹æ³•ä½¿åˆ›å»ºè¿™äº›é›†åˆçš„ä¸å¯å˜å®ä¾‹å˜å¾—æ›´åŠ ç®€å• ä¾‹å­ï¼š

```
Set<String> alphabet = Set.of("a", "b", "c");
List<String> strings = List.of("first", "second");

```

é•¿æœŸä»¥æ¥ï¼ŒStream API éƒ½æ˜¯ Java æ ‡å‡†åº“æœ€å¥½çš„æ”¹è¿›ä¹‹ä¸€ã€‚é€šè¿‡è¿™å¥— API å¯ä»¥åœ¨é›†åˆä¸Šå»ºç«‹ç”¨äºè½¬æ¢çš„ç”³æ˜ç®¡é“ã€‚åœ¨ Java 9 ä¸­å®ƒä¼šå˜å¾—æ›´å¥½ã€‚Stream æ¥å£ä¸­æ·»åŠ äº† 4 ä¸ªæ–°çš„æ–¹æ³•ï¼šdropWhile, takeWhile, ofNullableã€‚è¿˜æœ‰ä¸ª iterate æ–¹æ³•çš„æ–°é‡è½½æ–¹æ³•ï¼Œå¯ä»¥è®©ä½ æä¾›ä¸€ä¸ª Predicate (åˆ¤æ–­æ¡ä»¶)æ¥æŒ‡å®šä»€ä¹ˆæ—¶å€™ç»“æŸè¿­ä»£ï¼š

```
IntStream.iterate(1, i -> i < 100, i -> i + 1).forEach(System.out::println);

```

ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ª Lambdaï¼Œå®ƒä¼šåœ¨å½“å‰ IntStream ä¸­çš„å…ƒç´ åˆ°è¾¾ 100 çš„æ—¶å€™è¿”å› trueã€‚å› æ­¤è¿™ä¸ªç®€å•çš„ç¤ºä¾‹æ˜¯å‘æ§åˆ¶å°æ‰“å° 1 åˆ° 99ã€‚
é™¤äº†å¯¹ Stream æœ¬èº«çš„æ‰©å±•ï¼ŒOptional å’Œ Stream ä¹‹é—´çš„ç»“åˆä¹Ÿå¾—åˆ°äº†æ”¹è¿›ã€‚ç°åœ¨å¯ä»¥é€šè¿‡ Optional çš„æ–°æ–¹æ³• `stram` å°†ä¸€ä¸ª Optional å¯¹è±¡è½¬æ¢ä¸ºä¸€ä¸ª(å¯èƒ½æ˜¯ç©ºçš„) Stream å¯¹è±¡ï¼š

```
Stream<Integer> s = Optional.of(1).stream();

```

åœ¨ç»„åˆå¤æ‚çš„ Stream ç®¡é“æ—¶ï¼Œå°† Optional è½¬æ¢ä¸º Stream éå¸¸æœ‰ç”¨ã€‚

### å¢å¼ºçš„å¼ƒç”¨æ ‡è®°

Java 9 æä¾›äº†å¦å¤–ä¸€ä¸ªçœ‹èµ·æ¥å¾ˆå°çš„ç‰¹æ€§ï¼Œé‚£å°±æ˜¯å¢å¼ºçš„å¼ƒç”¨æ ‡è®°ï¼Œèƒ½å¤Ÿè®©å¼€å‘äººå‘˜æ›´å¥½åœ°ç†è§£ä»£ç çš„å½±å“ã€‚ä»¥å‰ï¼Œæˆ‘ä»¬åªèƒ½å°†ä»£ç æ ‡è®°ä¸º deprecated å¹¶åœ¨ Javadoc ä¸­æ·»åŠ ä¸€äº›åŸå› è¯´æ˜çš„æ–‡æ¡£ï¼Œç°åœ¨@Deprecated æ–°å¢äº†ä¸¤ä¸ªæœ‰ç”¨çš„å±æ€§ï¼šsince å’Œ orRemovalã€‚

### Thread.onSpinWait

Java 9 å…è®¸æˆ‘ä»¬ä¸º JVM æä¾›ä¸€äº›æç¤ºä¿¡æ¯ï¼Œä¾¿äºå®ç°æ€§èƒ½çš„æå‡ã€‚å…·ä½“æ¥è®²ï¼Œå¦‚æœä½ çš„ä»£ç éœ€è¦åœ¨ä¸€ä¸ªå¾ªç¯ä¸­ç­‰å¾…æŸä¸ªæ¡ä»¶å‘ç”Ÿçš„è¯ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨[Thread.onSpinWait](https://link.jianshu.com?t=http%3A%2F%2Fdownload.java.net%2Fjava%2Fjdk9%2Fdocs%2Fapi%2Fjava%2Flang%2FThread.html%23onSpinWait--)è®©è¿è¡Œæ—¶ç¯å¢ƒäº†è§£åˆ°è¿™ä¸€ç‚¹ã€‚

# 6 ç§æœ‰æ¥å£æ–¹æ³•

Java 8 ä¸ºæˆ‘ä»¬å¸¦æ¥äº†æ¥å£çš„é»˜è®¤æ–¹æ³•ã€‚ æ¥å£ç°åœ¨ä¹Ÿå¯ä»¥åŒ…å«è¡Œä¸ºï¼Œè€Œä¸ä»…ä»…æ˜¯æ–¹æ³•ç­¾åã€‚ ä½†æ˜¯ï¼Œå¦‚æœåœ¨æ¥å£ä¸Šæœ‰å‡ ä¸ªé»˜è®¤æ–¹æ³•ï¼Œä»£ç å‡ ä¹ç›¸åŒï¼Œä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿ é€šå¸¸ï¼Œæ‚¨å°†é‡æ„è¿™äº›æ–¹æ³•ï¼Œè°ƒç”¨ä¸€ä¸ªå¯å¤ç”¨çš„ç§æœ‰æ–¹æ³•ã€‚ ä½†é»˜è®¤æ–¹æ³•ä¸èƒ½æ˜¯ç§æœ‰çš„ã€‚ å°†å¤ç”¨ä»£ç åˆ›å»ºä¸ºä¸€ä¸ªé»˜è®¤æ–¹æ³•ä¸æ˜¯ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºè¯¥è¾…åŠ©æ–¹æ³•ä¼šæˆä¸ºå…¬å…± API çš„ä¸€éƒ¨åˆ†ã€‚ ä½¿ç”¨ Java 9ï¼Œæ‚¨å¯ä»¥å‘æ¥å£æ·»åŠ ç§æœ‰è¾…åŠ©æ–¹æ³•æ¥è§£å†³æ­¤é—®é¢˜ï¼š

```java
public interface MyInterface {

  void normalInterfaceMethod();

  default void interfaceMethodWithDefault() { init(); }

  default void anotherDefaultMethod() { init(); }

  // This method is not part of the public API exposed by MyInterface
  private void init() { System.out.println("Initializing"); }
}

```

å¦‚æœæ‚¨ä½¿ç”¨é»˜è®¤æ–¹æ³•å¼€å‘ API ï¼Œé‚£ä¹ˆç§æœ‰æ¥å£æ–¹æ³•å¯èƒ½æœ‰åŠ©äºæ„å»ºå…¶å®ç°ã€‚

```java
interface InterfaceWithPrivateMethods {

    private static String staticPrivate() {
        return "static private";
    }

    private String instancePrivate() {
        return "instance private";
    }

    default void check() {
        String result = staticPrivate();
        InterfaceWithPrivateMethods pvt = new InterfaceWithPrivateMethods() {
            // anonymous class
        };
        result = pvt.instancePrivate();
    }
}}

```

è¯¥ç‰¹æ€§å®Œå…¨æ˜¯ä¸ºäº† Java 8 ä¸­ default æ–¹æ³•å’Œ static æ–¹æ³•æœåŠ¡çš„ã€‚

# 7 java.net æ–°å†…å®¹

å°±ç›®å‰è€Œè¨€ï¼ŒJDK æä¾›çš„ Http è®¿é—®åŠŸèƒ½ï¼Œå‡ ä¹éƒ½éœ€è¦ä¾èµ–äº HttpURLConnectionï¼Œä½†æ˜¯è¿™ä¸ªç±»å¤§å®¶åœ¨å†™ä»£ç çš„æ—¶å€™å¾ˆå°‘ä½¿ç”¨ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šé€‰æ‹© Apache çš„ Http Clientï¼Œæ­¤æ¬¡åœ¨ Java 9 çš„ç‰ˆæœ¬ä¸­å¼•å…¥äº†ä¸€ä¸ªæ–°çš„ package:java.net.httpï¼Œé‡Œé¢æä¾›äº†å¯¹ Http è®¿é—®å¾ˆå¥½çš„æ”¯æŒï¼Œä¸ä»…æ”¯æŒ Http1.1 è€Œä¸”è¿˜æ”¯æŒ HTTP2ï¼Œä»¥åŠ WebSocketï¼Œæ®è¯´æ€§èƒ½å¯ä»¥è¶…è¿‡ Apache HttpClientï¼ŒNettyï¼ŒJetty

```
URI httpURI = new URI("http://www.94jiankang.com");
HttpRequest request = HttpRequest.create(httpURI).GET();
HttpResponse response = request.response();
String responseBody = response.body(HttpResponse.asString());

```

## http/2

Java 9 ä¸­æœ‰æ–°çš„æ–¹å¼æ¥å¤„ç† HTTP è°ƒç”¨ã€‚è¿™ä¸ªè¿Ÿåˆ°çš„ç‰¹æ€§ç”¨äºä»£æ›¿è€æ—§çš„ `HttpURLConnection` APIï¼Œå¹¶æä¾›å¯¹ WebSocket å’Œ HTTP/2 çš„æ”¯æŒã€‚æ³¨æ„ï¼šæ–°çš„ HttpClient API åœ¨ Java 9 ä¸­ä»¥æ‰€è°“çš„å­µåŒ–å™¨æ¨¡å—äº¤ä»˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™å¥— API ä¸èƒ½ä¿è¯ 100% å®Œæˆã€‚ä¸è¿‡ä½ å¯ä»¥åœ¨ Java 9 ä¸­å¼€å§‹ä½¿ç”¨è¿™å¥— APIï¼š

```java
HttpClient client = HttpClient.newHttpClient();

HttpRequest req = HttpRequest.newBuilder(URI.create(``"[http://www.google.com](http://www.google.com/)"``)).header(``"User-Agent"``,``"Java"``)
.GET().build();

HttpResponse<String> resp = client.send(req, HttpResponse.BodyHandler.asString());
```

é™¤äº†è¿™ä¸ªç®€å•çš„è¯·æ±‚/å“åº”æ¨¡å‹ä¹‹å¤–ï¼ŒHttpClient è¿˜æä¾›äº†æ–°çš„ API æ¥å¤„ç† HTTP/2 çš„ç‰¹æ€§ï¼Œæ¯”å¦‚æµå’ŒæœåŠ¡ç«¯æ¨é€ã€‚

# 8 å…¶ä»–

## 8.1 Try-With-Resources çš„æ”¹å˜

æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒTry-With-Resources æ˜¯ä» JDK 7 ä¸­å¼•å…¥çš„ä¸€é¡¹é‡è¦ç‰¹å¾ï¼Œåªè¦æ¥å£ç»§æ‰¿äº† Closable å°±å¯ä»¥ä½¿ç”¨ Try-With-Resourcesï¼Œå‡å°‘ finally è¯­å¥å—çš„ç¼–å†™ï¼Œåœ¨ Java 9 ä¸­ä¼šæ›´åŠ çš„æ–¹ä¾¿è¿™ä¸€ç‰¹å¾

```
MyAutoCloseable mac = new MyAutoCloseable();
try (mac) {
    // do some stuff with mac
}

try (new MyAutoCloseable() { }.finalWrapper.finalCloseable) {
   // do some stuff with finalCloseable
} catch (Exception ex) { }

```

æˆ‘ä»¬çš„ Closeable å®Œå…¨ä¸ç”¨å†™åœ¨ tryï¼ˆï¼‰ä¸­ã€‚

## 8.2 Unsafe ç±»çš„å‘½è¿

å¾ˆæ—©ä¹‹å‰å°±ä¼ è¨€ Java ä¼šå°† unsafe è¿™ä¸€ä¸ªç±»å±è”½æ‰ï¼Œä¸ç»™å¤§å®¶ä½¿ç”¨ï¼Œè¿™æ¬¡çœ‹ä»–çš„å®˜æ–¹æ–‡æ¡£ï¼Œè²Œä¼¼æ‰€æœ‰å·² sun å¼€å¤´çš„åŒ…éƒ½å°†ä¸èƒ½åœ¨ application ä¸­ä½¿ç”¨ï¼Œä½†æ˜¯ java 9 æä¾›äº†æ–°çš„ API ä¾›å¤§å®¶ä½¿ç”¨ã€‚
åœ¨ JDK 9 ä¸­æä¾›äº†ä¸€ä¸ªæ–°çš„åŒ…ï¼Œå«åš java.lang.invoke é‡Œé¢æœ‰ä¸€ç³»åˆ—å¾ˆé‡è¦çš„ç±»æ¯”å¦‚ VarHandler å’Œ MethodHandlesï¼Œæä¾›äº†ç±»ä¼¼äºåŸå­æ“ä½œä»¥åŠ Unsafe æ“ä½œçš„åŠŸèƒ½ã€‚

## 8.3 Ğœulti-Resolution Image API

æ¥å£ java.awt.image.MultiResolutionImage å°è£…äº†ä¸€ç³»åˆ—çš„ä¸åŒåˆ†è¾¨ç‡å›¾åƒåˆ°ä¸€ä¸ªå•ç‹¬å¯¹è±¡çš„ APIï¼Œæˆ‘ä¹ˆå¯ä»¥æ ¹æ®ç»™å®šçš„ DPI çŸ©é˜µè·å– resolution-specificã€‚
å…³äº AWT çš„ä¸œè¥¿ï¼Œæœ¬äººå‡ ä¹ä¸æ€ä¹ˆæ¥è§¦ï¼Œå¦‚æœæœ‰ç”¨åˆ°çš„æœ‹å‹ï¼Œç­‰ JDK 9 å‡ºæ¥ä¹‹åï¼Œè‡ªå·±ä½“ä¼šä½¿ç”¨ä¸€ä¸‹å§ã€‚

# 9 JVM ä¼˜åŒ–

## 9.1 ä½¿ç”¨ G1 åƒåœ¾å›æ”¶å™¨ä½œä¸ºé»˜è®¤çš„åƒåœ¾å›æ”¶å™¨

ç§»é™¤å¾ˆå¤šå·²ç»è¢«è¿‡æœŸçš„ GCC å›æ”¶å™¨ï¼ˆæ˜¯ç§»é™¤å“¦ï¼Œå› ä¸ºåœ¨ Jdk 8 ä¸­åªæ˜¯åŠ äº†è¿‡æœŸçš„æ ‡è®°ï¼‰

### 1. æœ¬åœ°å˜é‡ç±»å‹æ¨æ–­

ä»€ä¹ˆæ˜¯å±€éƒ¨å˜é‡ç±»å‹æ¨æ–­ï¼Ÿ

```java
var javastack = "javastack";
System.out.println(javastack);

```

å¤§å®¶çœ‹å‡ºæ¥äº†ï¼Œå±€éƒ¨å˜é‡ç±»å‹æ¨æ–­å°±æ˜¯å·¦è¾¹çš„ç±»å‹ç›´æ¥ä½¿ç”¨ var å®šä¹‰ï¼Œè€Œä¸ç”¨å†™å…·ä½“çš„ç±»å‹ï¼Œç¼–è¯‘å™¨èƒ½æ ¹æ®å³è¾¹çš„è¡¨è¾¾å¼è‡ªåŠ¨æ¨æ–­ç±»å‹ï¼Œå¦‚ä¸Šé¢çš„ String ã€‚

```java
var javastack = "javastack";
å°±ç­‰äºï¼š
String javastack = "javastack";

```

### 2. å­—ç¬¦ä¸²åŠ å¼º

Java 11 å¢åŠ äº†ä¸€ç³»åˆ—çš„å­—ç¬¦ä¸²å¤„ç†æ–¹æ³•ï¼Œå¦‚ä»¥ä¸‹æ‰€ç¤ºã€‚

```java
// åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©ºç™½
" ".isBlank(); // true
// å»é™¤é¦–å°¾ç©ºæ ¼
" Javastack ".strip(); // "Javastack"
// å»é™¤å°¾éƒ¨ç©ºæ ¼
" Javastack ".stripTrailing(); // " Javastack"
// å»é™¤é¦–éƒ¨ç©ºæ ¼
" Javastack ".stripLeading(); // "Javastack "
// å¤åˆ¶å­—ç¬¦ä¸²
"Java".repeat(3);// "JavaJavaJava"
// è¡Œæ•°ç»Ÿè®¡
"A\nB\nC".lines().count(); // 3

```

### 3. é›†åˆåŠ å¼º

è‡ª Java 9 å¼€å§‹ï¼ŒJdk é‡Œé¢ä¸ºé›†åˆï¼ˆList/ Set/ Mapï¼‰éƒ½æ·»åŠ äº† of å’Œ copyOf æ–¹æ³•ï¼Œå®ƒä»¬ä¸¤ä¸ªéƒ½ç”¨æ¥åˆ›å»ºä¸å¯å˜çš„é›†åˆï¼Œæ¥çœ‹ä¸‹å®ƒä»¬çš„ä½¿ç”¨å’ŒåŒºåˆ«ã€‚
ç¤ºä¾‹ 1ï¼š

```java
var list = List.of("Java", "Python", "C");
var copy = List.copyOf(list);
System.out.println(list == copy); // true

```

ç¤ºä¾‹ 2:

```java
var list = new ArrayList<String>();
var copy = List.copyOf(list);
System.out.println(list == copy); // false

```

ç¤ºä¾‹ 1 å’Œ 2 ä»£ç å·®ä¸å¤šï¼Œä¸ºä»€ä¹ˆä¸€ä¸ªä¸º true,ä¸€ä¸ªä¸º false?
æ¥çœ‹ä¸‹å®ƒä»¬çš„æºç ï¼š

```java
static <E> List<E> of(E... elements) {
  switch (elements.length) { // implicit null check of elements
    case 0:
        return ImmutableCollections.emptyList();
    case 1:
        return new ImmutableCollections.List12<>(elements[0]);
    case 2:
        return new ImmutableCollections.List12<>(elements[0], elements[1]);
    default:
        return new ImmutableCollections.ListN<>(elements);
  }
}
static <E> List<E> copyOf(Collection<? extends E> coll) {
    return ImmutableCollections.listCopy(coll);
}
static <E> List<E> listCopy(Collection<? extends E> coll) {
    if (coll instanceof AbstractImmutableList && coll.getClass() != SubList.class) {
        return (List<E>)coll;
    } else {
        return (List<E>)List.of(coll.toArray());
    }
}

```

å¯ä»¥çœ‹å‡º copyOf æ–¹æ³•ä¼šå…ˆåˆ¤æ–­æ¥æºé›†åˆæ˜¯ä¸æ˜¯ AbstractImmutableList ç±»å‹çš„ï¼Œå¦‚æœæ˜¯ï¼Œå°±ç›´æ¥è¿”å›ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™è°ƒç”¨ of åˆ›å»ºä¸€ä¸ªæ–°çš„é›†åˆã€‚

ç¤ºä¾‹ 2 å› ä¸ºç”¨çš„ new åˆ›å»ºçš„é›†åˆï¼Œä¸å±äºä¸å¯å˜ AbstractImmutableList ç±»çš„å­ç±»ï¼Œæ‰€ä»¥ copyOf æ–¹æ³•åˆåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œæ‰€ä»¥ä¸º false.

ä½¿ç”¨ of å’Œ copyOf åˆ›å»ºçš„é›†åˆä¸ºä¸å¯å˜é›†åˆï¼Œä¸èƒ½è¿›è¡Œæ·»åŠ ã€åˆ é™¤ã€æ›¿æ¢ã€æ’åºç­‰æ“ä½œï¼Œä¸ç„¶ä¼šæŠ¥ java.lang.UnsupportedOperationException å¼‚å¸¸ã€‚

ä¸Šé¢æ¼”ç¤ºäº† List çš„ of å’Œ copyOf æ–¹æ³•ï¼ŒSet å’Œ Map æ¥å£éƒ½æœ‰ã€‚

```java
public static void main(String[] args) {
    Set<String> names = Set.of("Fred", "Wilma", "Barney", "Betty");
    //JDK11ä¹‹å‰æˆ‘ä»¬åªèƒ½è¿™ä¹ˆå†™
    System.out.println(Arrays.toString(names.toArray(new String[names.size()])));
    //JDK11ä¹‹å  å¯ä»¥ç›´æ¥è¿™ä¹ˆå†™äº†
    System.out.println(Arrays.toString(names.toArray(size -> new String[size])));
    System.out.println(Arrays.toString(names.toArray(String[]::new)));
}

```

**Collection.toArray(IntFunction)**

åœ¨ java.util.Collection æ¥å£ä¸­æ·»åŠ äº†ä¸€ä¸ªæ–°çš„é»˜è®¤æ–¹æ³• toArrayï¼ˆIntFunctionï¼‰ã€‚æ­¤æ–¹æ³•å…è®¸å°†é›†åˆçš„å…ƒç´ ä¼ è¾“åˆ°æ–°åˆ›å»ºçš„æ‰€éœ€è¿è¡Œæ—¶ç±»å‹çš„æ•°ç»„

```java
 public static void main(String[] args) {
        Set<String> names = Set.of("Fred", "Wilma", "Barney", "Betty");
        //JDK11ä¹‹å‰æˆ‘ä»¬åªèƒ½è¿™ä¹ˆå†™
        System.out.println(Arrays.toString(names.toArray(new String[names.size()])));
        //JDK11ä¹‹å  å¯ä»¥ç›´æ¥è¿™ä¹ˆå†™äº†
        System.out.println(Arrays.toString(names.toArray(size -> new String[size])));
        System.out.println(Arrays.toString(names.toArray(String[]::new)));
    }

```

æ–°æ–¹æ³•æ˜¯ç°æœ‰ toArrayï¼ˆT []ï¼‰æ–¹æ³•çš„é‡è½½ï¼Œè¯¥æ–¹æ³•å°†æ•°ç»„å®ä¾‹ä½œä¸ºå‚æ•°ã€‚æ·»åŠ é‡è½½æ–¹æ³•ä¼šå¯¼è‡´æ¬¡è¦æºä¸å…¼å®¹ã€‚ä»¥å‰ï¼Œå½¢å¼ä¸º coll.toArrayï¼ˆnullï¼‰çš„ä»£ç å°†å§‹ç»ˆè§£æä¸ºç°æœ‰çš„ toArray æ–¹æ³•ã€‚ä½¿ç”¨æ–°çš„é‡è½½æ–¹æ³•ï¼Œæ­¤ä»£ç ç°åœ¨ä¸æ˜ç¡®ï¼Œå°†å¯¼è‡´ç¼–è¯‘æ—¶é”™è¯¯ã€‚ ï¼ˆè¿™åªæ˜¯æºä¸å…¼å®¹ã€‚ç°æœ‰çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸å—å½±å“ã€‚ï¼‰åº”è¯¥æ›´æ”¹æ¨¡ç³Šä»£ç ä»¥å°† null è½¬æ¢ä¸ºæ‰€éœ€çš„æ•°ç»„ç±»å‹ï¼Œä¾‹å¦‚ toArrayï¼ˆï¼ˆObject []ï¼‰nullï¼‰æˆ–å…¶ä»–ä¸€äº›æ•°ç»„ç±»å‹ã€‚è¯·æ³¨æ„ï¼Œå°† null ä¼ é€’ç»™ toArray æ–¹æ³•æŒ‡å®šä¸ºæŠ›å‡º NullPointerException

### 4. Stream åŠ å¼º

Stream æ˜¯ Java 8 ä¸­çš„æ–°ç‰¹æ€§ï¼ŒJava 9 å¼€å§‹å¯¹ Stream å¢åŠ äº†ä»¥ä¸‹ 4 ä¸ªæ–°æ–¹æ³•ã€‚

1. å¢åŠ å•ä¸ªå‚æ•°æ„é€ æ–¹æ³•ï¼Œå¯ä¸º null

```java
Stream.ofNullable(null).count(); // 0
//JDK8æœ¨æœ‰ofNullableæ–¹æ³•å“¦

```

æºç å¯çœ‹çœ‹ï¼š

```java
/**
 * @since 9
 */
 public static<T> Stream<T> ofNullable(T t) {
     return t == null ? Stream.empty()
                      : StreamSupport.stream(new Streams.StreamBuilderImpl<>(t), false);
 }

```

2. å¢åŠ  takeWhile å’Œ dropWhile æ–¹æ³•

```java
Stream.of(1, 2, 3, 2, 1)
    .takeWhile(n -> n < 3)
    .collect(Collectors.toList()); // [1, 2]

```

takeWhile è¡¨ç¤ºä»å¼€å§‹è®¡ç®—ï¼Œå½“ n < 3 æ—¶å°±æˆªæ­¢ã€‚

```java
Stream.of(1, 2, 3, 2, 1)
    .dropWhile(n -> n < 3)
    .collect(Collectors.toList()); // [3, 2, 1]

```

dropWhile è¿™ä¸ªå’Œä¸Šé¢çš„ç›¸åï¼Œä¸€æ—¦ n < 3 ä¸æˆç«‹å°±å¼€å§‹è®¡ç®—

3. iterate é‡è½½

è¿™ä¸ª iterate æ–¹æ³•çš„æ–°é‡è½½æ–¹æ³•ï¼Œå¯ä»¥è®©ä½ æä¾›ä¸€ä¸ª Predicate (åˆ¤æ–­æ¡ä»¶)æ¥æŒ‡å®šä»€ä¹ˆæ—¶å€™ç»“æŸè¿­ä»£ã€‚

```java
    public static void main(String[] args) {
        // è¿™æ„é€ çš„æ˜¯æ— é™æµ  JDK8å¼€å§‹
        Stream.iterate(0, (x) -> x + 1);
        // è¿™æ„é€ çš„æ˜¯å°äº10å°±ç»“æŸçš„æµ  JDK9å¼€å§‹
        Stream.iterate(0, x -> x < 10, x -> x + 1);
    }

```

### 5. Optional åŠ å¼º

Opthonal ä¹Ÿå¢åŠ äº†å‡ ä¸ªéå¸¸é…·çš„æ–¹æ³•ï¼Œç°åœ¨å¯ä»¥å¾ˆæ–¹ä¾¿çš„å°†ä¸€ä¸ª Optional è½¬æ¢æˆä¸€ä¸ª Stream, æˆ–è€…å½“ä¸€ä¸ªç©º Optional æ—¶ç»™å®ƒä¸€ä¸ªæ›¿ä»£çš„ã€‚

```java
Optional.of("javastack").orElseThrow(); // javastack
Optional.of("javastack").stream().count(); // 1
Optional.ofNullable(null)
.or(() -> Optional.of("javastack"))
.get(); // javastack

```

or æ–¹æ³•å’Œ stream æ–¹æ³•æ˜¾ç„¶éƒ½æ˜¯æ–°å¢çš„

### 6. InputStream åŠ å¼º

InputStream ç»ˆäºæœ‰äº†ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æ–¹æ³•ï¼štransferToï¼Œå¯ä»¥ç”¨æ¥å°†æ•°æ®ç›´æ¥ä¼ è¾“åˆ° OutputStreamï¼Œè¿™æ˜¯åœ¨å¤„ç†åŸå§‹æ•°æ®æµæ—¶éå¸¸å¸¸è§çš„ä¸€ç§ç”¨æ³•ï¼Œå¦‚ä¸‹ç¤ºä¾‹ã€‚

```java
var classLoader = ClassLoader.getSystemClassLoader();
var inputStream = classLoader.getResourceAsStream("javastack.txt");
var javastack = File.createTempFile("javastack2", "txt");
try (var outputStream = new FileOutputStream(javastack)) {
    inputStream.transferTo(outputStream);
}

```

### 7. HTTP Client API(é‡ç£…)

åœ¨ java9 åŠ 10 è¢«æ ‡è®° incubator çš„æ¨¡å— jdk.incubator.httpclientï¼Œåœ¨ java11 è¢«æ ‡è®°ä¸ºæ­£å¼ï¼Œæ”¹ä¸º java.net.http æ¨¡å—ã€‚
è¿™æ˜¯ Java 9 å¼€å§‹å¼•å…¥çš„ä¸€ä¸ªå¤„ç† HTTP è¯·æ±‚çš„çš„å­µåŒ– HTTP Client APIï¼Œè¯¥ API æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥ï¼Œè€Œåœ¨ Java 11 ä¸­å·²ç»ä¸ºæ­£å¼å¯ç”¨çŠ¶æ€ï¼Œä½ å¯ä»¥åœ¨ java.net åŒ…ä¸­æ‰¾åˆ°è¿™ä¸ª APIã€‚

æ¥çœ‹ä¸€ä¸‹ HTTP Client çš„ç”¨æ³•ï¼š

```java
var request = HttpRequest.newBuilder()
.uri(URI.create("https://javastack.cn"))
.GET()
.build();
var client = HttpClient.newHttpClient();
// åŒæ­¥
HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());
System.out.println(response.body());
// å¼‚æ­¥
client.sendAsync(request, HttpResponse.BodyHandlers.ofString())
.thenApply(HttpResponse::body)
.thenAccept(System.out::println);

```

ä¸Šé¢çš„ .GET() å¯ä»¥çœç•¥ï¼Œé»˜è®¤è¯·æ±‚æ–¹å¼ä¸º Getï¼

æ›´å¤šä½¿ç”¨ç¤ºä¾‹å¯ä»¥çœ‹è¿™ä¸ª APIï¼Œåç»­æœ‰æœºä¼šå†åšæ¼”ç¤ºã€‚

ç°åœ¨ Java è‡ªå¸¦äº†è¿™ä¸ª HTTP Client APIï¼Œæˆ‘ä»¬ä»¥åè¿˜æœ‰å¿…è¦ç”¨ Apache çš„ HttpClient å·¥å…·åŒ…å—ï¼Ÿæˆ‘è§‰å¾—æ²¡å•¥å¿…è¦äº†

### 8. åŒ–ç¹ä¸ºç®€ï¼Œä¸€ä¸ªå‘½ä»¤ç¼–è¯‘è¿è¡Œæºä»£ç 

çœ‹ä¸‹é¢ä»£ç 

```
// ç¼–è¯‘
javac Javastack.java
// è¿è¡Œ
java Javastack
```

åœ¨æˆ‘ä»¬çš„è®¤çŸ¥é‡Œé¢ï¼Œè¦è¿è¡Œä¸€ä¸ª Java æºä»£ç å¿…é¡»å…ˆç¼–è¯‘ï¼Œå†è¿è¡Œï¼Œä¸¤æ­¥æ‰§è¡ŒåŠ¨ä½œã€‚è€Œåœ¨æœªæ¥çš„ Java 11 ç‰ˆæœ¬ä¸­ï¼Œé€šè¿‡ä¸€ä¸ª java å‘½ä»¤å°±ç›´æ¥æå®šäº†ï¼Œå¦‚ä»¥ä¸‹æ‰€ç¤ºã€‚

```
java Javastack.java
```

### 9. ç§»é™¤é¡¹

1. ç§»é™¤äº† com.sun.awt.AWTUtilities
2. ç§»é™¤äº† sun.misc.Unsafe.defineClassï¼Œä½¿ç”¨ java.lang.invoke.MethodHandles.Lookup.defineClass æ¥æ›¿ä»£
3. ç§»é™¤äº† Thread.destroy()ä»¥åŠ Thread.stop(Throwable)æ–¹æ³•
4. ç§»é™¤äº†sun.nio.ch.disableSystarraydsj@163.comWideOverlappingFileLockCheckã€sun.locale.formatasdefault å±æ€§
5. ç§»é™¤äº† jdk.snmp æ¨¡å—
6. ç§»é™¤äº† javafxï¼Œopenjdk ä¼°è®¡æ˜¯ä» java10 ç‰ˆæœ¬å°±ç§»é™¤äº†ï¼Œoracle jdk10 è¿˜å°šæœªç§»é™¤ javafxï¼Œè€Œ java11 ç‰ˆæœ¬åˆ™ oracle çš„ jdk ç‰ˆæœ¬ä¹Ÿç§»é™¤äº† javafx
7. ç§»é™¤äº† Java Mission Controlï¼Œä» JDK ä¸­ç§»é™¤ä¹‹åï¼Œéœ€è¦è‡ªå·±å•ç‹¬ä¸‹è½½
8. ç§»é™¤äº†è¿™äº› Root Certificates ï¼šBaltimore Cybertrust Code Signing CAï¼ŒSECOM ï¼ŒAOL and Swisscom

### 10. åºŸå¼ƒé¡¹

1. åºŸå¼ƒäº† Nashorn JavaScript Engine
2. åºŸå¼ƒäº†-XX+AggressiveOpts é€‰é¡¹
3. -XX:+UnlockCommercialFeatures ä»¥åŠ-XX:+LogCommercialFeatures é€‰é¡¹ä¹Ÿä¸- å†éœ€è¦
4. åºŸå¼ƒäº† Pack200 å·¥å…·åŠå…¶ API

## [JetBrains IDEAæ’ä»¶å¼€å‘ï¼šæ ¸å¿ƒAPIä¸å·¥å…·è¯¦è§£](https://blog.dong4j.site/posts/8366ec74.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

IDEA Plugin API

## æ–‡ä»¶æ“ä½œ

### Virtual File System

`Virtual File System` æ˜¯å¤„ç†æ–‡ä»¶çš„ä¸€å¥—æœºåˆ¶, ç”¨äºå¤„ç†å¦‚ä½•åŠ è½½æ–‡ä»¶, å¦‚æœä¿å­˜æ–‡ä»¶, å½“æ–‡ä»¶å˜åŒ–æ—¶å¦‚ä½•æ›´æ–°ç¼“å­˜ç­‰.

IntelliJ Platform å°†æ“ä½œæ–‡ä»¶å°è£…æˆäº† `Virtual File System`, æä¾›äº†ä»¥ä¸‹å‡ ç‚¹ä¸»è¦åŠŸèƒ½:

1. å°è£…å¤„ç†æ–‡ä»¶çš„é€šç”¨ API, ä¸è®ºæ–‡ä»¶åœ¨ç£ç›˜, å­˜æ¡£, HTTP æœåŠ¡å™¨æˆ–è€…å…¶ä»–åœ°æ–¹, éƒ½ä½¿ç”¨åŒä¸€å¥— API;
2. æä¾›å¿«ç…§åŠŸèƒ½, èƒ½è·Ÿè¸ªæ–‡ä»¶çš„ä¿®æ”¹;
3. æä¾›å°†é™„åŠ æŒä¹…æ•°æ®ä¸ VFS ä¸­çš„æ–‡ä»¶ç›¸å…³è”;

ä¸ºäº†æä¾›æœ€åä¸¤ä¸ªåŠŸèƒ½ï¼ŒVFS ç®¡ç†ç”¨æˆ·ç¡¬ç›˜çš„æŸäº›å†…å®¹çš„æŒä¹…å¿«ç…§ã€‚å¿«ç…§ä»…å­˜å‚¨é€šè¿‡ VFS API è‡³å°‘è¯·æ±‚è¿‡ä¸€æ¬¡çš„æ–‡ä»¶ï¼Œå¹¶ä¸”å¼‚æ­¥æ›´æ–°ä»¥åŒ¹é…ç£ç›˜ä¸Šå‘ç”Ÿçš„æ›´æ”¹ã€‚

å¿«ç…§æ˜¯åº”ç”¨ç¨‹åºçº§åˆ«ï¼Œè€Œä¸æ˜¯é¡¹ç›®çº§åˆ« - å› æ­¤ï¼Œå¦‚æœæŸä¸ªæ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼ŒJDK ä¸­çš„æŸä¸ªç±»ï¼‰è¢«å¤šä¸ªé¡¹ç›®å¼•ç”¨ï¼Œåˆ™å…¶å†…å®¹çš„ä¸€ä¸ªå‰¯æœ¬å°†å­˜å‚¨åœ¨ VFS ä¸­ã€‚

æ‰€æœ‰ VFS è®¿é—®æ“ä½œéƒ½é€šè¿‡å¿«ç…§ã€‚

å¦‚æœé€šè¿‡ VFS API
è¯·æ±‚æŸäº›ä¿¡æ¯ä½†å¿«ç…§ä¸­æ²¡æœ‰è¿™äº›ä¿¡æ¯ï¼Œåˆ™ä¼šä»ç£ç›˜åŠ è½½å¹¶å­˜å‚¨åˆ°å¿«ç…§ä¸­ã€‚å¦‚æœå¿«ç…§ä¸­æœ‰å¯ç”¨ä¿¡æ¯ï¼Œåˆ™è¿”å›å¿«ç…§æ•°æ®ã€‚ä»…å½“è®¿é—®äº†ç‰¹å®šä¿¡æ¯æ—¶ï¼Œæ–‡ä»¶çš„å†…å®¹å’Œç›®å½•ä¸­çš„æ–‡ä»¶åˆ—è¡¨æ‰å­˜å‚¨åœ¨å¿«ç…§ä¸­ -
å¦åˆ™ï¼Œä»…å­˜å‚¨åç§°ï¼Œé•¿åº¦ï¼Œæ—¶é—´æˆ³ï¼Œå±æ€§ç­‰æ–‡ä»¶å…ƒæ•°æ®ã€‚

> è¿™æ„å‘³ç€ IntelliJ Platform UI ä¸­æ˜¾ç¤ºçš„æ–‡ä»¶ç³»ç»ŸçŠ¶æ€å’Œæ–‡ä»¶å†…å®¹æ¥è‡ªå¿«ç…§ï¼Œå¿«ç…§å¯èƒ½å¹¶ä¸æ€»æ˜¯ä¸ç£ç›˜çš„å®é™…å†…å®¹ç›¸åŒ¹é…ã€‚
> ä¾‹å¦‚, åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œåœ¨ IntelliJ å¹³å°é€‰æ‹©åˆ é™¤ä¹‹å‰ï¼Œå·²åˆ é™¤çš„æ–‡ä»¶ä»å¯åœ¨ UI ä¸­æ˜¾ç¤ºä¸€æ®µæ—¶é—´ã€‚

åœ¨åˆ·æ–°æ“ä½œæœŸé—´ä»ç£ç›˜æ›´æ–°å¿«ç…§ï¼Œè¿™é€šå¸¸æ˜¯å¼‚æ­¥å‘ç”Ÿçš„ã€‚é€šè¿‡ VFS è¿›è¡Œçš„æ‰€æœ‰å†™æ“ä½œéƒ½æ˜¯åŒæ­¥çš„ - å³å†…å®¹ç«‹å³ä¿å­˜åˆ°ç£ç›˜ã€‚

åˆ·æ–°æ“ä½œå°† VFS çš„ä¸€éƒ¨åˆ†çŠ¶æ€ä¸å®é™…ç£ç›˜å†…å®¹åŒæ­¥ã€‚IntelliJ å¹³å°æˆ–æ’ä»¶ä»£ç æ˜¾å¼è°ƒç”¨åˆ·æ–°æ“ä½œ - å³åœ¨ IDE è¿è¡Œæ—¶åœ¨ç£ç›˜ä¸Šæ›´æ”¹æ–‡ä»¶æ—¶ï¼ŒVFS ä¸ä¼šç«‹å³è·å–æ›´æ”¹ã€‚VFS
å°†åœ¨ä¸‹ä¸€æ¬¡åˆ·æ–°æ“ä½œæœŸé—´æ›´æ–°ï¼Œå…¶ä¸­åŒ…æ‹¬å…¶èŒƒå›´å†…çš„æ–‡ä»¶ã€‚

### Virtual File

ç”¨äºè¡¨ç¤º `Virtual File System` ä¸­çš„ä¸€ä¸ªå…·ä½“æ–‡ä»¶, ç›¸å½“äºæœ¬åœ°ç³»ç»Ÿæ–‡ä»¶, ä¹Ÿç”¨äºè¡¨ç¤º jar åŒ…ä¸­çš„æ–‡ä»¶ä¸­çš„ç±», è¿˜å¯ä»¥è¡¨ç¤ºç‰ˆæœ¬ç®¡ç†ä¸­çš„æ—§æ–‡ä»¶.

**`VFS` ä»…å¤„ç†äºŒè¿›åˆ¶å†…å®¹**

#### è·å– VirtualFile

```java
private void getVirtualFile(AnActionEvent e) {
    // è·å– VirtualFile æ–¹å¼ä¸€:
    VirtualFile virtualFile = e.getData(PlatformDataKeys.VIRTUAL_FILE);
    // è·å–å¤šä¸ª VirtualFile
    VirtualFile[] virtualFiles = e.getData(PlatformDataKeys.VIRTUAL_FILE_ARRAY);
    // æ–¹å¼äºŒ: ä»æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿè·¯å¾„è·å–
    VirtualFile virtualFileFromLocalFileSystem = LocalFileSystem.getInstance().findFileByIoFile(new File("path"));
    // æ–¹å¼ä¸‰: ä» PSI æ–‡ä»¶ (å¦‚æœ PSI æ–‡ä»¶ä»…å­˜åœ¨å†…å­˜ä¸­, åˆ™å¯èƒ½è¿”å› null)
    PsiFile psiFile = e.getData(CommonDataKeys.PSI_FILE);
    if (psiFile != null) {
        psiFile.getVirtualFile();
    }
    // æ–¹å¼å››: ä» document ä¸­è·å–
    Document document = Objects.requireNonNull(e.getData(PlatformDataKeys.EDITOR)).getDocument();
    VirtualFile virtualFileFromDocument = FileDocumentManager.getInstance().getFile(document);
}
```

![20241229154732_TaWCxR2c.webp](https://cdn.dong4j.site/source/image/20241229154732_TaWCxR2c.webp)

#### éå†æ–‡ä»¶ç³»ç»Ÿ

éå†æ–‡ä»¶å¯ä»¥ä½¿ç”¨ File çš„ API, æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ `VFS` æä¾›çš„ API æ¥å®ç°

```java
private void iterateChildrenRecursively(VirtualFile virtualFile) {
    /**
     * é€’å½’éå†å­æ–‡ä»¶
     *
     * @param root     the root         çˆ¶æ–‡ä»¶
     * @param filter   the filter       è¿‡æ»¤å™¨
     * @param iterator the iterator     å¤„ç†æ–¹å¼
     * @return the boolean
     */
    VfsUtilCore.iterateChildrenRecursively(virtualFile,
                                           new VirtualFileFilter() {
                                               @Override
                                               public boolean accept(VirtualFile file) {
                                                   // todo-dong4j : (2019 å¹´ 03 æœˆ 15 æ—¥ 13:02) [ä» .gitignore ä¸­è·å–å¿½ç•¥çš„æ–‡ä»¶]
                                                   boolean allowAccept = file.isDirectory()&& !file.getName().equals(NODE_MODULES_FILE);
                                                   if(allowAccept || file.getName().endsWith(MARKDOWN_FILE_TYPE)){
                                                       log.trace("accept = {}", file.getPath());
                                                       return true;
                                                   }
                                                   return false;
                                               }
                                           },
                                           new ContentIterator() {
                                               @Override
                                               public boolean processFile(@NotNull VirtualFile fileOrDir) {
                                                   // todo-dong4j : (2019 å¹´ 03 æœˆ 15 æ—¥ 13:04) [å¤„ç† markdown é€»è¾‘å®ç°]
                                                   if(!fileOrDir.isDirectory()){
                                                       log.trace("processFile = {}", fileOrDir.getName());
                                                   }
                                                   return true;
                                               }
                                           });
}
```

`ContentIterator` æ¥å£è¡¨ç¤ºå¤„ç†æ–‡ä»¶çš„å…·ä½“æ–¹å¼, éœ€è¦è‡ªå·±å®ç°.

ç”±äºåœ¨è¿‡æ»¤å™¨ä¸­å·²ç»å°†é markdown æ–‡ä»¶è¿‡æ»¤æ‰, å› æ­¤æ­¤å¤„åªéœ€è¦å®ç°å¤„ç† markdown æ–‡ä»¶çš„é€»è¾‘å³å¯.

![20241229154732_qtx1O6IU.webp](https://cdn.dong4j.site/source/image/20241229154732_qtx1O6IU.webp)

### Document

Document æ˜¯å¯ç¼–è¾‘çš„ Unicode å­—ç¬¦åºåˆ—, å¯¹åº”çš„æ˜¯ `VirtualFile` ä¸­çš„æ–‡æœ¬å†…å®¹.

æ–‡æ¡£ä¸­çš„æ¢è¡Œç¬¦ **å§‹ç»ˆ** ä¸º `\n`.

å¯ä»¥é€šè¿‡ Document å¯¹æ–‡ä»¶åšä»»ä½•æ“ä½œ.

#### è·å– Document

```java
private void getDocument(AnActionEvent e){
    // ä»å½“å‰ç¼–è¾‘å™¨ä¸­è·å–
    Document documentFromEditor = Objects.requireNonNull(e.getData(PlatformDataKeys.EDITOR)).getDocument();
    // ä» VirtualFile è·å– (å¦‚æœä¹‹å‰æœªåŠ è½½æ–‡æ¡£å†…å®¹ï¼Œåˆ™æ­¤è°ƒç”¨ä¼šå¼ºåˆ¶ä»ç£ç›˜åŠ è½½æ–‡æ¡£å†…å®¹)
    VirtualFile virtualFile = e.getData(PlatformDataKeys.VIRTUAL_FILE);
    if (virtualFile != null) {
        Document documentFromVirtualFile = FileDocumentManager.getInstance().getDocument(virtualFile);
        // ä»ç¼“å­˜ä¸­è·å–
        Document documentFromVirtualFileCache = FileDocumentManager.getInstance().getCachedDocument(virtualFile);

        // ä» PSI ä¸­è·å–
        Project project = e.getProject();
        if (project != null) {
            // è·å– PSI (ä¸€)
            PsiFile psiFile = PsiManager.getInstance(project).findFile(virtualFile);
            // è·å– PSI (äºŒ)
            psiFile = e.getData(CommonDataKeys.PSI_FILE);
            if (psiFile != null) {
                Document documentFromPsi = PsiDocumentManager.getInstance(project).getDocument(psiFile);
                // ä»ç¼“å­˜ä¸­è·å–
                Document documentFromPsiCache = PsiDocumentManager.getInstance(project).getCachedDocument(psiFile);
            }
        }
    }
}
```

![20241229154732_QSKPhUZG.webp](https://cdn.dong4j.site/source/image/20241229154732_QSKPhUZG.webp)

å¯¹ Document æ“ä½œæ—¶ä¸€å®šè¦æ³¨æ„å†…å­˜æ³„æ¼çš„é—®é¢˜, å› ä¸ºæ¯æ¬¡è®¿é—®æ–‡ä»¶çš„ Document å¯¹è±¡æ˜¯, éƒ½æ˜¯ä¸€ä¸ªæ–°çš„å®ä¾‹, ä½¿ç”¨å®Œæˆåä¸€å®šè¦è®°å¾—é‡Šæ”¾å¼•ç”¨.

#### åˆ›å»º Document

å¦‚æœéœ€è¦åœ¨ç£ç›˜ä¸Šåˆ›å»ºæ–°æ–‡ä»¶, ä¸è¦ç›´æ¥åˆ›å»º `Document`, è€Œæ˜¯å…ˆåˆ›å»º `PSI` æ–‡ä»¶,
ç„¶åè·å–å®ƒçš„ `Document`.

å¦‚æœéœ€è¦åˆ›å»ºä¸€ä¸ªæ²¡æœ‰ç»‘å®šçš„ `Document` çš„å®ä¾‹, å¯ä»¥ä½¿ç”¨ `EditorFactory.createDocument`.

#### Document Listener

- æ¥æ”¶æœ‰å…³ç‰¹å®š `Document` å®ä¾‹ä¸­çš„æ›´æ”¹çš„é€šçŸ¥

```java
Document.addDocumentListener
```

- æ¥æ”¶æœ‰å…³æ‰€æœ‰æ‰“å¼€æ–‡æ¡£ä¸­çš„æ›´æ”¹çš„é€šçŸ¥

```java
EditorFactory.getEventMulticaster().addDocumentListener
```

#### write Document

SDK è§„å®šæ‰€æœ‰å†™æ“ä½œå¿…é¡»é€šè¿‡å¼‚æ­¥æ‰§è¡Œ, å› æ­¤éœ€è¦å°†å†™æ“ä½œåŒ…è£…åˆ° command ä¸­

```java
CommandProcessor.getInstance().executeCommand()
```

æ¯”å¦‚:

```java
WriteCommandAction.runWriteCommandAction(project, () -> {
    document.setText(string);
    psiDocumentManager.doPostponedOperationsAndUnblockDocument(document);
    psiDocumentManager.commitDocument(document);
    FileDocumentManager.getInstance().saveDocument(document);
});
```

### Editor

Editor ç›¸å…³ API

[editor-ui-api package](https://upsource.jetbrains.com/idea-ce/file/idea-ce-a7b3d4e9e48efbd4ac75105e9737cea25324f11e/platform/editor-ui-api),[Editor.java](https://upsource.jetbrains.com/idea-ce/file/idea-ce-a7b3d4e9e48efbd4ac75105e9737cea25324f11e/platform/editor-ui-api/src/com/intellij/openapi/editor/Editor.java),[EditorImpl.java](https://upsource.jetbrains.com/idea-ce/file/idea-ce-a7b3d4e9e48efbd4ac75105e9737cea25324f11e/platform/platform-impl/src/com/intellij/openapi/editor/impl/EditorImpl.java).[CommonDataKeys.java](https://upsource.jetbrains.com/idea-ce/file/idea-ce-a7b3d4e9e48efbd4ac75105e9737cea25324f11e/platform/editor-ui-api/src/com/intellij/openapi/actionSystem/CommonDataKeys.java),[DataKey.java](https://upsource.jetbrains.com/idea-ce/file/idea-ce-a7b3d4e9e48efbd4ac75105e9737cea25324f11e/platform/editor-ui-api/src/com/intellij/openapi/actionSystem/DataKey.java),[AnActionEvent](https://upsource.jetbrains.com/idea-ce/file/idea-ce-a7b3d4e9e48efbd4ac75105e9737cea25324f11e/platform/editor-ui-api/src/com/intellij/openapi/actionSystem/AnActionEvent.java),[DataContext](https://upsource.jetbrains.com/idea-ce/file/idea-ce-a7b3d4e9e48efbd4ac75105e9737cea25324f11e/platform/editor-ui-api/src/com/intellij/openapi/actionSystem/DataContext.java)

### PSI

#### è·å– PSI

```java
private void getPsiFile(AnActionEvent e){
    // ä» action ä¸­è·å–
    PsiFile psiFileFromAction = e.getData(LangDataKeys.PSI_FILE);
    Project project = e.getProject();
    if (project != null) {
        VirtualFile virtualFile = e.getData(PlatformDataKeys.VIRTUAL_FILE);
        if (virtualFile != null) {
            // ä» VirtualFile è·å–
            PsiFile psiFileFromVirtualFile = PsiManager.getInstance(project).findFile(virtualFile);

            // ä» document
            Document documentFromEditor = Objects.requireNonNull(e.getData(PlatformDataKeys.EDITOR)).getDocument();
            PsiFile psiFileFromDocument = PsiDocumentManager.getInstance(project).getPsiFile(documentFromEditor);

            // åœ¨ project èŒƒå›´å†…æŸ¥æ‰¾ç‰¹å®š PsiFile
            FilenameIndex.getFilesByName(project, "fileName", GlobalSearchScope.projectScope(project));
        }
    }
}
```

#### å¦‚æœæˆ‘çŸ¥é“å®ƒçš„åå­—ä½†ä¸çŸ¥é“è·¯å¾„ï¼Œæˆ‘å¦‚ä½•æ‰¾åˆ°æ–‡ä»¶ï¼Ÿ

`FilenameIndex.getFilesByName()`

#### å¦‚ä½•æ‰¾åˆ°ç‰¹å®š PSI å…ƒç´ çš„ä½¿ç”¨ä½ç½®ï¼Ÿ

`ReferencesSearch.search()`

#### å¦‚ä½•é‡å‘½å PSI å…ƒç´ ï¼Ÿ

`RefactoringFactory.createRename()`

#### å¦‚ä½•é‡å»ºè™šæ‹Ÿæ–‡ä»¶çš„ PSIï¼Ÿ

`FileContentUtil.reparseFiles()`

### Java ç‰¹å®š

#### å¦‚ä½•æ‰¾åˆ°ç±»çš„æ‰€æœ‰ç»§æ‰¿è€…ï¼Ÿ

`ClassInheritorsSearch.search()`

#### å¦‚ä½•é€šè¿‡é™å®šåç§°æŸ¥æ‰¾è¯¾ç¨‹ï¼Ÿ

`JavaPsiFacade.findClass()`

#### å¦‚ä½•é€šè¿‡çŸ­åç§°æ‰¾åˆ°ä¸€ä¸ªç­çº§ï¼Ÿ

`PsiShortNamesCache.getInstance().getClassesByName()`

#### å¦‚ä½•æ‰¾åˆ° Java ç±»çš„è¶…ç±»ï¼Ÿ

`PsiClass.getSuperClass()`

#### å¦‚ä½•è·å–å¯¹ Java ç±»çš„åŒ…å«çš„å¼•ç”¨ï¼Ÿ

```java
PsiJavaFile javaFile = (PsiJavaFile) psiClass.getContaningFile();
PsiPackage pkg = JavaPsiFacade.getInstance(project).findPackage(javaFile.getPackageName());
```

#### å¦‚ä½•æ‰¾åˆ°è¦†ç›–ç‰¹å®šæ–¹æ³•çš„æ–¹æ³•

`OverridingMethodsSearch.search()`

## [IDEAæ’ä»¶å¼€å‘æŒ‡å—ï¼ˆå…«ï¼‰ï¼šæŒä¹…åŒ–é…ç½®ä¸è®¾ç½®é¢æ¿](https://blog.dong4j.site/posts/9fb70690.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

IDEA Plugin é…ç½®æŒä¹…åŒ–

## æŒä¹…åŒ–ä¸è®¾ç½®é¢æ¿

ä¸Šä¼ åˆ° Aliyun OSS éœ€è¦å‡ ä¸ªå‚æ•°:

1. endpoint
2. accessKeyId
3. accessKeySecret
4. bucketName
5. filedir (æ­¤å‚æ•°å¯ä¸å¡«)

![20241229154732_kTcuDeWY.webp](https://cdn.dong4j.site/source/image/20241229154732_kTcuDeWY.webp)
![20241229154732_o9WJRBVY.webp](https://cdn.dong4j.site/source/image/20241229154732_o9WJRBVY.webp)

æœ¬ç« èŠ‚å°†ä»‹ç»æ€æ ·åˆ›å»ºè®¾ç½®é¢æ¿å’ŒæŒä¹…åŒ–é…ç½®

### è®¾ç½®é¢æ¿

ç›´æ¥ä½¿ç”¨ IDEA è‡ªå¸¦çš„ GUI æ’ä»¶æ¥ç”»å›¾, éœ€è¦å¼€å¯ `UI Designer` æ’ä»¶

![20241229154732_BriAzGij.webp](https://cdn.dong4j.site/source/image/20241229154732_BriAzGij.webp)

### æŒä¹…åŒ– `PersistentStateComponent`

## [IDEAæ’ä»¶å¼€å‘ï¼ˆä¸ƒï¼‰ï¼šå¦‚ä½•åˆ›å»ºå³é”®èœå•æ“ä½œ](https://blog.dong4j.site/posts/56e5b99c.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

ä»‹ç» IDEA Plugin å¼€å‘å…¥å£

æ¥ä¸‹çš„æ–‡æ¡£éƒ½ä¼šæ ¹æ®å‰ä¸€ç¯‡çš„éœ€æ±‚æ¥æ‰¾åˆ°è§£å†³æ–¹æ¡ˆ, å¯¹äºä¸ç†Ÿæ‚‰ IDEA æ’ä»¶å¼€å‘çš„åŒå­¦ (è¯´çš„å°±æ˜¯æˆ‘), å¯èƒ½ä¸€æ—¶æ‰¾ä¸åˆ°å„ä¸ªå…¬å…±çš„å…¥å£, è¿™ä¸ªæ˜¯å¦å°±è¦çœ‹ä¸€äº›å¼€æºçš„æ’ä»¶,
ä»ä¸­æ‰¾åˆ°åŠŸèƒ½å…¥å£.

## å³é”®èœå•å…¥å£

éœ€æ±‚ä¸­æåˆ° **ã€Œåœ¨ç¼–è¾‘è§†å›¾ä¸­ç›´æ¥å³é”® --> `upload to Aliyun OSS`ã€**

å› æ­¤æˆ‘ä»¬éœ€è¦æ‰©å±•å³é”®èœå•, æ¥æ·»åŠ æˆ‘ä»¬è‡ªå·±çš„åŠŸèƒ½å…¥å£.

ç°åœ¨ä»‹ç»ä¸€ç§æ–°çš„æ·»åŠ  AnAction çš„æ–¹å¼:

![20241229154732_CEGFQZTP.webp](https://cdn.dong4j.site/source/image/20241229154732_CEGFQZTP.webp)
![20241229154732_C6YLzipL.webp](https://cdn.dong4j.site/source/image/20241229154732_C6YLzipL.webp)
è¿™ä¹ˆå¤š Group. å¥½äº†, æ‡µé€¼äº†....

é‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆæ¥æ‰¾æˆ‘ä»¬éœ€è¦çš„ Group å‘¢?
æˆ‘è¿™é‡Œç”¨ä¸ªç¬¨åŠæ³•, çœ‹åˆ«äººçš„æ’ä»¶é…ç½®å‘—, è¿™é‡Œé€šè¿‡çœ‹ `Alibaba Java Coding Guidelines` è¿™ä¸ªæ’ä»¶çš„é…ç½®, å¯ä»¥ç¡®å®šçš„æœ‰:

**MainToolBar**

![20241229154732_OJGdzbLl.webp](https://cdn.dong4j.site/source/image/20241229154732_OJGdzbLl.webp)

**ProjectViewPopupMenu**

![20241229154732_8APSpRb1.webp](https://cdn.dong4j.site/source/image/20241229154732_8APSpRb1.webp)

**ChangesViewPopupMenu**

![20241229154732_DJgUdu85.webp](https://cdn.dong4j.site/source/image/20241229154732_DJgUdu85.webp)

**EditorPopupMenu**

![20241229154732_FJ1uMI4G.webp](https://cdn.dong4j.site/source/image/20241229154732_FJ1uMI4G.webp)

å…ˆæ¥ç¬¬ä¸€ä¸ª, åœ¨ç¼–è¾‘å™¨å³é”®èœå•ä¸­æ·»åŠ æˆ‘ä»¬çš„ action, å¾ˆæ˜æ˜¾æ˜¯ç”¨ `EditorPopupMenu`

```xml
<action id="info.dong4j.aliyun-oss-upload" class="info.dong4j.test.AliyunOssUpload" text="upload aliyun oss"
        description="ä¸Šä¼ æ–‡ä»¶åˆ° aliyun OSS">
    <add-to-group group-id="GenerateGroup" anchor="last"/>
</action>

<action id="AliObjectStorageServiceAction" class="info.dong4j.idea.plugin.action.AliObjectStorageServiceAction"
        popup="true" text="upload to Aliyun OSS">
    <add-to-group group-id="MainToolBar" anchor="last"/>
    <add-to-group group-id="ProjectViewPopupMenu" anchor="last"/>
    <add-to-group group-id="ChangesViewPopupMenu" anchor="last"/>
    <add-to-group group-id="EditorPopupMenu" anchor="last"/>
</action>

<group popup="true" id="com.alibaba.p3c.analytics.action_group" text="Aliyun OSS">
    <reference ref="AliObjectStorageServiceAction"/>
    <add-to-group group-id="ToolsMenu" anchor="last"/>
</group>
```

ä¸å‡ºæ„å¤–çš„è¯:

**MainToolBar**

![20241229154732_vhGD8UND.webp](https://cdn.dong4j.site/source/image/20241229154732_vhGD8UND.webp)

**ProjectViewPopupMenu**

![20241229154732_67JQ03Yk.webp](https://cdn.dong4j.site/source/image/20241229154732_67JQ03Yk.webp)
**ChangesViewPopupMenu**

![20241229154732_5HHFQPy2.webp](https://cdn.dong4j.site/source/image/20241229154732_5HHFQPy2.webp)

**EditorPopupMenu**

![20241229154732_z6tbRhUZ.webp](https://cdn.dong4j.site/source/image/20241229154732_z6tbRhUZ.webp)

## åŠŸèƒ½å®ç°

ç”±äºéœ€æ±‚å®ç°ä¸æ˜¯æœ¬æ•™ç¨‹çš„é‡ç‚¹, æ‰€ä»¥ä¼šé€‰å–æ’ä»¶å¼€å‘æœ‰å…³çš„é—®é¢˜ä½œå‡ºè¯´æ˜.

### æ€ä¹ˆåˆ¤æ–­é€‰ä¸­çš„å¯¹è±¡æ˜¯ Markdown æ–‡ä»¶

é¦–å…ˆæˆ‘ä»¬å¾—çŸ¥é“å½“å‰å…‰æ ‡é€‰ä¸­çš„æ˜¯ä»€ä¹ˆä¸œè¥¿

```java
// è·å–å½“å‰æ“ä½œçš„æ–‡ä»¶
PsiFile psiFile = anActionEvent.getData(CommonDataKeys.PSI_FILE);
if (psiFile != null) {
    log.info("language = {}", psiFile.getOriginalFile().getLanguage());
    log.info("name = {}", psiFile.getOriginalFile().getName());
    Messages.showMessageDialog(project, psiFile.getFileType().getName(), "File Type", null);
}
// è·å–å½“å‰äº‹ä»¶è§¦å‘æ—¶ï¼Œå…‰æ ‡æ‰€åœ¨çš„å…ƒç´ 
PsiElement psiElement = anActionEvent.getData(LangDataKeys.PSI_ELEMENT);
// å¦‚æœå…‰æ ‡é€‰æ‹©çš„ä¸æ˜¯ç±»ï¼Œå¼¹å‡ºå¯¹è¯æ¡†æé†’
if (psiElement == null || !(psiElement instanceof PsiClass)) {
    Messages.showMessageDialog(project, "Please focus on a class", "Generate Failed", null);
    return;
}
```

```
2019-03-12 18:16:00,899 [44799]   INFO - .AliObjectStorageServiceAction - language = Language: JAVA
2019-03-12 18:16:00,899 [44799]   INFO - .AliObjectStorageServiceAction - name = HelloOSS.java
2019-03-12 18:16:10,423 [54323]   INFO - .AliObjectStorageServiceAction - project's base path = /Users/dong4j/Develop/codes/alibaba/aliyun-oss-java-sdk-demo-mvn
2019-03-12 18:16:14,372 [58272]   INFO - .AliObjectStorageServiceAction - language = Language: TEXT
2019-03-12 18:16:14,372 [58272]   INFO - .AliObjectStorageServiceAction - name = maven-demo.iml
2019-03-12 18:18:06,392 [170292]   INFO - .AliObjectStorageServiceAction - language = Language: TEXT
2019-03-12 18:18:06,392 [170292]   INFO - .AliObjectStorageServiceAction - name = 3-2-data-grip.md
2019-03-12 18:18:08,586 [172486]   INFO - .AliObjectStorageServiceAction - project's base path = /Users/dong4j/Develop/knowledge
```

psiFile è¿˜æœ‰å…¶ä»–çš„ä¸€äº›å±æ€§, è¿™ä¸ªå°± debug çœ‹å§.

ä»ä¸Šé¢æˆ‘ä»¬çŸ¥é“äº†, å¦‚æœæ˜¯ `Markdown` æ–‡ä»¶, Language ä¸º TEXT, name æ˜¯æ–‡ä»¶å.
å¦‚æœæ˜¯ç±»æ–‡ä»¶, åˆ™æ˜¯ JAVA. å¯ä»¥ä½¿ç”¨ `PsiJavaFile` æ¥æ“ä½œ.

![20241229154732_rDOXCSLd.webp](https://cdn.dong4j.site/source/image/20241229154732_rDOXCSLd.webp)

![20241229154732_uShmvBHD.webp](https://cdn.dong4j.site/source/image/20241229154732_uShmvBHD.webp)

### è·å– Markdown æ–‡ä»¶çš„æ‰€æœ‰å†…å®¹

```java
String text = Objects.requireNonNull(psiFile.getViewProvider().getDocument()).getText();
```

![20241229154732_ISFOzO2Z.webp](https://cdn.dong4j.site/source/image/20241229154732_ISFOzO2Z.webp)

## update

[ğŸ‘‰ åˆ¤æ–­æŒ‰é’®ä»€ä¹ˆæ—¶å€™å¯ç”¨](https://github.com/dong4j/aliyun-oss-upload/tree/2.update)

## [IntelliJ IDEA æ’ä»¶å¼€å‘æ”»ç•¥ï¼šMarkdown å›¾ç‰‡ä¸Šä¼ è‡³ Aliyun OSS](https://blog.dong4j.site/posts/c9eda116.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

æ’ä»¶éœ€æ±‚åˆ†æ

<!-- more -->

å…ˆæ¥æ¢³ç†ä¸‹éœ€æ±‚:

å¼€å‘ä¸€æ¬¾æ’ä»¶å°† `Markdown` æ–‡æ¡£ä¸­çš„å›¾ç‰‡ä¸Šä¼ åˆ° `Aliyun OSS`.

å…·ä½“éœ€æ±‚å…¥ä¸‹:

## ä¸Šä¼ éœ€æ±‚

è§£ææ‰€æœ‰ `![]()` å›¾ç‰‡æ ‡ç­¾:

1. å¦‚æœå›¾ç‰‡åœ¨æœ¬åœ°, åˆ™ä¸Šä¼ åˆ° Aliyun OSS;
2. å¦‚æœä»¥ `http://` æˆ–è€… `https://` å¼€å¤´, åˆ™æ ¹æ®è®¾ç½®åˆ¤æ–­æ˜¯å¦ä¸Šä¼  (è¿ç§»å›¾ç‰‡åˆ° Aliyun OSS)

ä¸Šä¼ å®Œæˆå:

1. æ ¹æ®è®¾ç½®å°† `![](./03161253/xxx)` æ ‡ç­¾è½¬æ¢æˆ `<a data-fancybox title="" href="http://xxxx" >![](./03161253/xxx)</a>` æ ‡ç­¾

è¿™é‡Œæœ‰ 2 ä¸ªè®¾ç½®:

1. æ˜¯å¦è½¬æ¢ä¸º `<a>` æ ‡ç­¾:
   1. å¦‚æœå¼€å¯, åœ¨åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºå¤§å›¾ (è¿™ä¸ªä¸»è¦é’ˆå¯¹ vuepress æ„å»ºçš„åšå®¢)

```html
<a data-fancybox title="" href="http://xxxx">![](http://xxxx)</a>
```

ä¸”è¦ä¿®æ”¹ `config.js` æ–‡ä»¶, æ·»åŠ å¦‚ä¸‹:

```JavaScript
// è®© Vuepress æ”¯æŒå›¾ç‰‡æ”¾å¤§åŠŸèƒ½
['script', { src: 'https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js' }],
['script', { src: 'https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js' }],
['link', { rel: 'stylesheet', type: 'text/css', href: 'https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css' }]
```

1. å¦‚æœä¸å¼€å¯, åˆ™åªè½¬ä¸ºæ™®é€šçš„ `<a>` æ ‡ç­¾, è¿™æ ·ç‚¹å‡»å›¾ç‰‡å, èƒ½æ–°å¼€æ ‡ç­¾æŸ¥çœ‹å¤§å›¾;

```html
<a title="" href="http://xxxx">![](http://xxxx)</a>
```

## å›¾ç‰‡å‹ç¼©

æ ¹æ®è®¾ç½®åˆ¤æ–­ä¸Šä¼ å›¾ç‰‡æ˜¯å¦å‹ç¼©, ç»™å‡ºç™¾åˆ†æ¯”.

è·å–å›¾ç‰‡æ—¶æ˜¯å¦å‹ç¼©, è¿™ä¸ªéœ€è¦åœ¨ Aliyun OSS ç«¯è®¾ç½®, è®¾ç½®å¥½åå¡«å…¥å¯¹åº”çš„ `styleName`

## ç›´æ¥æä¾›å›¾ç‰‡å‹ç¼©çš„åŠŸèƒ½

ä½œç”¨èŒƒå›´:

1. å½“å‰é€‰ä¸­çš„å›¾ç‰‡;
2. é€‰ä¸­çš„ç›®å½•ä¸­çš„æ‰€æœ‰å›¾ç‰‡;
3. æ•´ä¸ªé¡¹ç›®ä¸­çš„å›¾ç‰‡;

## å¤‡ä»½å›¾ç‰‡

å›¾ç‰‡ä¸Šä¼ å®Œæˆå, å°†å·²ä¸Šä¼ çš„å›¾ç‰‡æŒ‰ç…§ç›®å½•å¤‡ä»½åˆ° **å½“å‰é¡¹ç›®çš„ä¸»ç›®å½•** ä¸­

## æ’ä»¶ä½œç”¨èŒƒå›´

åªä¼šè§£æ `Markdown` æ–‡æ¡£.
å¦‚æœæ˜¯å•ä¸ªæ–‡ä»¶, åªæœ‰æ˜¯ `Markdown` æ–‡æ¡£æ‰ä¼šæ˜¾ç¤º `upload to Aliyun OSS`, å…¶ä»–æ—¶å€™ä¸å¯ç”¨;

**æ³¨æ„:**

æ–‡ä»¶æ ‘å¯ä»¥å¤šé€‰æ–‡ä»¶

### å½“å‰é€‰ä¸­ / æ­£åœ¨ç¼–è¾‘çš„æ–‡ä»¶

1. åœ¨ç¼–è¾‘è§†å›¾ä¸­ç›´æ¥å³é”® --> `upload to Aliyun OSS` ;
2. åœ¨ Tools èœå•ä¸­ --> `upload to Aliyun OSS` ;
3. åœ¨æ–‡ä»¶æ ‘é€‰ä¸­æ–‡ä»¶åå³é”® --> `upload to Aliyun OSS` ;

### ç›®å½•

1. åœ¨æ–‡ä»¶æ ‘ç›®å½•ä¸Šç‚¹å‡»å³é”® --> `upload to Aliyun OSS` ;

### é¡¹ç›®

1. åœ¨æ•´ä¸ªé¡¹ç›®ä¸Šç‚¹å‡»å³é”® --> `upload to Aliyun OSS` ;

## æç¤ºå’Œæ—¥å¿—

æ¯ä¸€æ­¥ç»™å‡ºæ—¥å¿—

1. è§£ææ ‡ç­¾æ—¶;
2. æ‹¿åˆ°å›¾ç‰‡è·¯å¾„;
3. ä¸Šä¼ ;
4. ä¸Šä¼ æˆåŠŸåå¤‡ä»½å›¾ç‰‡, ä¸æˆåŠŸä¸å¤‡ä»½;
5. æ›¿æ¢æ ‡ç­¾;

ä¸Šä¼ è¿‡ç¨‹ä¸­ç»™å‡ºè¿›åº¦æ¡

æ‰€æœ‰æ“ä½œå®Œæˆåç»™å‡ºæç¤º!

## è®¾ç½®é¡µ

1. Aliyun OSS è®¾ç½®;

![20241229154732_lQw5m47z.webp](https://cdn.dong4j.site/source/image/20241229154732_lQw5m47z.webp)
![20241229154732_mtyVTw4c.webp](https://cdn.dong4j.site/source/image/20241229154732_mtyVTw4c.webp)

1. æ ‡ç­¾æ›¿æ¢é€‰é¡¹è®¾ç½®;
2. å›¾ç‰‡å‹ç¼©è®¾ç½® (ä¸Šä¼ å‰åä¸Šä¼ å);
3. å›¾åºŠè¿ç§»è®¾ç½®;

## Aliyun OSS æ§åˆ¶å°

1. å½“å‰å­˜å‚¨æ€»é‡
2. æœ¬æœˆ Put ç±»è¯·æ±‚
3. æœ¬æœˆ Get ç±»è¯·æ±‚
4. SLA

### åˆ·æ–°æ¬¡æ•°

1. 5 åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡;
2. æ‰“å¼€æ—¶åˆ·æ–°ä¸€æ¬¡;
3. åˆ·æ–°æŒ‰é’®;
4. å…³é—­ååœæ­¢åˆ·æ–°ä»»åŠ¡;

## [ä»åŸºç¡€åˆ°é«˜çº§ï¼šIntelliJ IDEA æ’ä»¶çš„å››å¤§åˆ†ç±»](https://blog.dong4j.site/posts/50e2e964.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

è¿™ç¯‡å¤§è‡´ä»‹ç»ä¸€ä¸‹ IDEA æ’ä»¶çš„å‡ ç§ç±»å‹

<!-- more -->

## æ’ä»¶çš„ä¸»è¦ç±»å‹

IntelliJ IDEA çš„å¼ºå¤§ä¹‹ä¸€å°±æ˜¯æœ‰ä¸€ä¸ªæ˜“äºæ‰©å±•çš„æ’ä»¶ç³»ç»Ÿ, æ‰€æœ‰æ’ä»¶éƒ½å¯åœ¨ [JetBrains æ’ä»¶åº“](https://plugins.jetbrains.com/) æ‰¾åˆ°.

æœ€å¸¸è§çš„æ’ä»¶ç±»å‹åŒ…æ‹¬:

- è‡ªå®šä¹‰è¯­è¨€æ”¯æŒ
- æ¡†æ¶é›†æˆ
- å·¥å…·é›†æˆ
- ç”¨æˆ·ç•Œé¢é™„åŠ ç»„ä»¶

## è‡ªå®šä¹‰è¯­è¨€æ”¯æŒ

è‡ªå®šä¹‰è¯­è¨€æ”¯æŒæä¾›äº†ä½¿ç”¨ç‰¹å®šç¼–ç¨‹è¯­è¨€çš„åŸºæœ¬åŠŸèƒ½, åŒ…æ‹¬:

- æ–‡ä»¶ç±»å‹è¯†åˆ«
- è¯æ±‡åˆ†æ
- è¯­æ³•çªå‡ºæ˜¾ç¤º
- æ ¼å¼åŒ–
- ä»£ç æ´å¯Ÿå’Œä»£ç å®Œæˆ
- æ£€æŸ¥å’Œå¿«é€Ÿä¿®å¤
- æ„å›¾è¡ŒåŠ¨

## æ¡†æ¶é›†æˆ

æ¡†æ¶é›†æˆåŒ…æ‹¬æ”¹è¿›çš„ä»£ç æ´å¯ŸåŠŸèƒ½, è¿™äº›åŠŸèƒ½å¯¹äºç»™å®šçš„æ¡†æ¶æ˜¯å…¸å‹çš„, ä»¥åŠç›´æ¥ä» IDE ä½¿ç”¨æ¡†æ¶ç‰¹å®šåŠŸèƒ½çš„é€‰é¡¹. æœ‰æ—¶å®ƒè¿˜åŒ…æ‹¬è‡ªå®šä¹‰è¯­æ³•æˆ– DSL çš„è¯­è¨€æ”¯æŒå…ƒç´ .

- å…·ä½“çš„ä»£ç è§è§£
- ç›´æ¥è®¿é—®ç‰¹å®šäºæ¡†æ¶çš„åŠŸèƒ½

## å·¥å…·é›†æˆ

é€šè¿‡å·¥å…·é›†æˆ, å¯ä»¥ç›´æ¥ä» IDE æ“ä½œç¬¬ä¸‰æ–¹å·¥å…·å’Œç»„ä»¶, è€Œæ— éœ€åˆ‡æ¢ä¸Šä¸‹æ–‡.

æ¯”å¦‚:

- å®æ–½å…¶ä»–è¡ŒåŠ¨
- ç›¸å…³çš„ UI ç»„ä»¶
- è®¿é—®å¤–éƒ¨èµ„æº

## ç”¨æˆ·ç•Œé¢é™„åŠ ç»„ä»¶

æ­¤ç±»åˆ«ä¸­çš„æ’ä»¶ä¼šå¯¹ IDE çš„æ ‡å‡†ç”¨æˆ·ç•Œé¢åº”ç”¨å„ç§æ›´æ”¹.
ä¸€äº›æ–°æ·»åŠ çš„ç»„ä»¶æ˜¯äº¤äº’å¼çš„å¹¶æä¾›æ–°åŠŸèƒ½, è€Œå…¶ä»–ç»„ä»¶ä»…é™äºè§†è§‰ä¿®æ”¹. æ‰€è¿° [èƒŒæ™¯å›¾åƒ](https://plugins.jetbrains.com/plugin/72) çš„æ’ä»¶å¯ä»¥ä½œä¸ºä¸€ä¸ªä¾‹å­.

[ğŸ‘‰ æ¨èä¸€æ¬¾ä¸»é¢˜](https://plugins.jetbrains.com/plugin/8006-material-theme-ui)

![20241229154732_KI8B9GrW.webp](https://cdn.dong4j.site/source/image/20241229154732_KI8B9GrW.webp))

## [ä»0åˆ°1ï¼šå­¦ä¹ å¦‚ä½•åœ¨IntelliJ IDEAä¸­æŸ¥çœ‹å’Œç®¡ç†æ’ä»¶æ—¥å¿—](https://blog.dong4j.site/posts/5649be19.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

æŸ¥çœ‹ IDEA Plugin å¼€å‘æ—¥å¿—

ä¸Šä¸€èŠ‚å·²ç»è¯´è¿‡, IntelliJ IDEA SDK ä¸­å·²ç»æœ‰äº†æ—¥å¿—æ¡†æ¶, ç”¨äºè¾“å‡ºæ—¥å¿—, ä½†æ˜¯åœ¨å“ªé‡Œçœ‹æ—¥å¿—å‘¢.

æˆ‘ä»¬å¯ä»¥è¿™æ ·æŸ¥çœ‹:

![20241229154732_NPAbokXw.webp](https://cdn.dong4j.site/source/image/20241229154732_NPAbokXw.webp)
æœ€ç»ˆæˆ‘ä»¬çŸ¥é“ idea.log ä¼šåœ¨ `.sandbox/system/log/idea.log`.

ç„¶åæˆ‘ä»¬å¯ä»¥é€šè¿‡ `Grep Console` è¿™ä¸ªæ’ä»¶çš„ `Tail File in Console` æˆ–è€… `Tail Current File in Console` æ¥å®æ—¶æŸ¥çœ‹æ—¥å¿—.

![20241229154732_N9KspG77.webp](https://cdn.dong4j.site/source/image/20241229154732_N9KspG77.webp)

![20241229154732_Y25A0nYO.webp](https://cdn.dong4j.site/source/image/20241229154732_Y25A0nYO.webp)

ç„¶åæˆ‘ä»¬ä¼šå‘ç°æ‰€æœ‰çš„æ—¥å¿—ç­‰çº§éƒ½æ˜¯ INFO, åœ¨æˆ‘ä»¬è°ƒè¯•çš„æ—¶å€™ DEBUG æ—¥å¿—çœ‹ä¸åˆ°, å¦‚æœå…¨éƒ¨è®¾ç½®æˆ INFO çº§åˆ«è°ƒè¯•çš„æ—¶å€™å¾ˆæ–¹ä¾¿, ä½†æ˜¯å¤§é‡æ‰“å°æ—¥å¿—æœ‰æ€§èƒ½æŸè€—,
å› æ­¤æˆ‘ä»¬éœ€è¦å°†æ—¥å¿—ç­‰çº§é™ä½, åˆèƒ½æ‰“å°åˆ°æ–‡ä»¶ä¸­.

ä½ å¯ä»¥è¿™æ ·è®¾ç½®:

![20241229154732_ScfYkmtI.webp](https://cdn.dong4j.site/source/image/20241229154732_ScfYkmtI.webp)
![20241229154732_6ACs81L3.webp](https://cdn.dong4j.site/source/image/20241229154732_6ACs81L3.webp)

è¯´æ˜å·²ç»å†™å¾—å¾ˆè¯¦ç»†äº†, æŒ‰ç…§ä¸Šé¢çš„æ¥, ç„¶åå°†è°ƒè¯•æ—¥å¿—ç­‰çº§è®¾ç½®ä¸º TRACE å³å¯çœ‹è§æ—¥å¿—.

![20241229154732_mKVA2Ar3.webp](https://cdn.dong4j.site/source/image/20241229154732_mKVA2Ar3.webp)

å…¶ä»–ä½ ä¹Ÿå¯ä»¥ç›´æ¥ä¿®æ”¹ä¸‹é¢è¿™ä¸ªæ–‡ä»¶

![20241229154732_KDnfNDP9.webp](https://cdn.dong4j.site/source/image/20241229154732_KDnfNDP9.webp)

[ğŸ‘‰ æ‰©å±•é˜…è¯» - æ€ä¹ˆå°†è€çš„ plugin é¡¹ç›®è½¬æ¢æˆ gradle é¡¹ç›®]

ç”±äºå®˜æ–¹å¼€å‘æ–‡æ¡£å†™å¾—å¾ˆçƒ‚, æœ‰å¤šä¸œè¥¿éƒ½æ²¡æœ‰å†™åˆ°, æ‰€æœ‰æˆ‘ä»¬åªæœ‰çœ‹åˆ«äººçš„ä»£ç æ¥äº†è§£æœªçŸ¥çš„ API çš„åŠŸèƒ½.

è¿™é‡Œå…ˆæ¨èä¸€æ¬¾æ’ä»¶ `PsiViewer`, èƒ½ä¿è¯æˆ‘ä»¬æ›´åŠ å®¹æ˜“ç†è§£ `PSI`

![20241229154732_xxh4nkBm.webp](https://cdn.dong4j.site/source/image/20241229154732_xxh4nkBm.webp)

å‡†å¤‡å·¥ä½œåšå¥½äº†, æ¥ä¸‹æ¥è¿›å…¥ä¸»é¢˜äº†.

## [ä½¿ç”¨ Gradle å¿«é€Ÿå…¥é—¨ IntelliJ IDEA æ’ä»¶å¼€å‘](https://blog.dong4j.site/posts/ac0a5116.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

ä½¿ç”¨å®˜æ–¹æ¨èçš„ Gradle æ’ä»¶å¼€å‘

è¿™æ˜¯ IDEA æ’ä»¶å¼€å‘ç¬¬ä¸€ç¯‡, æ•´ä¸ªç³»åˆ—è®°å½•äº†å¼€å‘ `aliyun-oss-upload` çš„æ•´ä¸ªç»†èŠ‚, å°†ä¼šæŠŠé‡åˆ°çš„é—®é¢˜æ•´ç†æˆæ–‡, æœ€ç»ˆå‘å¸ƒåœ¨ `idea-plugin-dev` ä¸­.

## å‰è¨€

IDEA æ’ä»¶å¼€å‘åˆ†ä¸º 2 ç§æ–¹å¼:

1. ç›´æ¥ä½¿ç”¨ IDEA æä¾›çš„ `IntelliJ Platform Plugin`

![20241229154732_4tizyBBP.webp](https://cdn.dong4j.site/source/image/20241229154732_4tizyBBP.webp)2. ä½¿ç”¨ Gradle

![20241229154732_DJPYrLBy.webp](https://cdn.dong4j.site/source/image/20241229154732_DJPYrLBy.webp)

å®˜æ–¹æ¨èä½¿ç”¨ Gradle æ–¹å¼, å› æ­¤é€‰ç”¨ç¬¬äºŒç§æ–¹å¼.

å› ä¸ºæœªä½¿ç”¨è¿‡ Gradle, è‚¯å®šä¼šé‡åˆ°å¾ˆå¤šå‘, ä¸ºäº†å‡å°‘å¤§å®¶çˆ¬å‘çš„æ—¶é—´, æˆ‘ä¼šå°½é‡æŠŠæ³¨é‡Šå†™è¯¦ç»†ç‚¹, å¦‚æœå‘ç°é”™è¯¯çš„åœ°æ–¹, è¯·å‘ŠçŸ¥æˆ‘.

## é…ç½®

ä½¿ç”¨ Gradle åˆ›å»ºå¥½æ’ä»¶é¡¹ç›®å, ç›´æ¥æ‹·è´ä»¥ä¸‹é…ç½®åˆ° `build.gradle`

```java
// mavenCentral() æ˜¯ä¸€ä¸ªæ’ä»¶ä»“åº“, å¯¼å…¥çš„æ’ä»¶å°†ä¼šåœ¨ä»“åº“ä¸­å¯»æ‰¾å¹¶ä¸‹è½½
buildscript {
    repositories {
        mavenCentral()
        maven { url "http://maven.aliyun.com/nexus/content/groups/public/" }
        maven { url "https://oss.sonatype.org/content/repositories/snapshots/" }
        maven { url 'http://dl.bintray.com/jetbrains/intellij-plugin-service' }
    }
}

plugins {
    id 'org.jetbrains.intellij' version '0.4.4'
}

repositories {
    mavenCentral()
}

tasks.withType(JavaCompile) {
    options.encoding = "UTF-8"
}

// å¯¼å…¥æ’ä»¶
// 1. ç¼–è¯‘, æµ‹è¯•æ’ä»¶ (Java, Groovy,Scala, War ç­‰)
// 2. ä»£ç åˆ†ææ’ä»¶ (Checkstyle, FindBugs, Sonar ç­‰)
// 3. IDE æ’ä»¶ (Eclipse, IDEA ç­‰)
// Java æ˜¯ Gradle çš„æ ¸å¿ƒæ’ä»¶, æ˜¯å†…ç½®çš„, å†…ç½®æ’ä»¶ä¸éœ€è¦é…ç½®ä¾èµ–è·¯å¾„
apply plugin: 'java'
apply plugin: 'idea'
apply plugin: 'org.jetbrains.intellij'

sourceCompatibility = 1.8

intellij {
    version '2018.3.5'
    sandboxDirectory = project.rootDir.canonicalPath + "/.sandbox" // æ’ä»¶ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶çš„åœ°å€ï¼Œå¯ä»¥çœç•¥
}

// å£°æ˜ä¾èµ–ä½¿ç”¨ä¸‹é¢çš„é—­åŒ…
dependencies {
    // è§£å†³ gradle ä½¿ç”¨ lombok çš„é—®é¢˜
    annotationProcessor 'org.projectlombok:lombok:1.18.2'
    compileOnly 'org.projectlombok:lombok:1.18.2'
    testAnnotationProcessor 'org.projectlombok:lombok:1.18.2'
    testCompileOnly 'org.projectlombok:lombok:1.18.2'
    // å•å…ƒæµ‹è¯•
    testCompile group: 'junit', name: 'junit' , version: '4.12'
}
```

**å‘ 1:**

`lombok` ç”¨ä¹ æƒ¯äº†, å› æ­¤è¿™é‡Œä¹Ÿä½¿ç”¨äº†.
ä½†æ˜¯æœ‰ä¸ªå‘, å¿…é¡»æŒ‰ç…§ä¸Šé¢çš„æ–¹å¼ä¾èµ– `lombok`, ä¸ç„¶ä¼šæŠ¥æ‰¾ä¸åˆ°ç¬¦å·çš„é”™è¯¯, è¿˜æœ‰ç¬¬äºŒç§é…ç½®æ–¹å¼:

```java
repositories {
    mavenCentral()
}

plugins {
    id 'net.ltgt.apt' version '0.10'
}

dependencies {
    compileOnly 'org.projectlombok:lombok:1.18.2'
    apt "org.projectlombok:lombok:1.18.2"
}
```

é€‰æ‹©å…¶ä¸­ä¸€ç§å³å¯.

**å‘ 2:**

ä¹ æƒ¯åœ¨é¡¹ç›®ä¸­ä½¿ç”¨æ—¥å¿—ä»£æ›¿ `System.out.println();` æ‰“å°æ—¥å¿—, å› æ­¤è€ƒè™‘åœ¨æ­¤é¡¹ç›®ä½¿ç”¨ `slf4j2 + log4j2` æ—¥å¿—æ¡†æ¶, ä½†æ˜¯å´å¤±è´¥äº†.

æ·»åŠ  `slf4j2 + log4j2` ä¾èµ–

```java
compile group: 'org.apache.logging.log4j', name: 'log4j-slf4j-impl', version: '2.11.0'
compile group: 'org.apache.logging.log4j', name: 'log4j-core', version: '2.11.0'
compile group: 'com.lmax', name: 'disruptor', version: '3.4.2'
```

é”™è¯¯ä¿¡æ¯:

```txt
SLF4J: No SLF4J providers were found.
SLF4J: Defaulting to no-operation (NOP) logger implementation
SLF4J: See http://www.slf4j.org/codes.html#noProviders for further details.
SLF4J: Class path contains SLF4J bindings targeting slf4j-api versions prior to 1.8.
```

è¿™æ˜¯ç”±äº `slf4j-api` 1.8.x çš„ç»‘å®šæœºåˆ¶çš„å˜åŒ–å¯¼è‡´, æ„æ€å°±æ˜¯ç‰ˆæœ¬å¤ªé«˜äº†, è¿™é‡Œä¿®æ”¹ä¸º 1.7.x ç‰ˆæœ¬å¯ä»¥æ¶ˆé™¤è¿™ä¸ªé”™è¯¯. è”ç³»ä¸€ä¸‹ gradle æ€ä¹ˆæ’é™¤ä¾èµ–

```java
compile (group: 'org.apache.logging.log4j', name: 'log4j-slf4j-impl', version: '2.11.0') {
    // æ’é™¤é«˜ç‰ˆæœ¬ä¾èµ–
    exclude group: 'org.slf4j', module: 'slf4j-api'
}
// ä½¿ç”¨ä½ç‰ˆæœ¬
compile group: 'org.slf4j', name: 'slf4j-api', version: '1.7.25'
```

è¿˜æ²¡è§£å†³å®Œ:

```
SLF4J: Class path contains multiple SLF4J bindings.
SLF4J: Found binding in [jar:file:/Users/dong4j/Develop/codes/idea-plugin/aliyun-oss-upload/.sandbox/plugins/aliyun-oss-upload/lib/log4j-slf4j-impl-2.11.0.jar!/org/slf4j/impl/StaticLoggerBinder.class]
SLF4J: Found binding in [jar:file:/Users/dong4j/.gradle/caches/modules-2/files-2.1/com.jetbrains.intellij.idea/ideaIC/2018.3.5/2465ddbc4af3619128cada78e216ffbb93e8b173/ideaIC-2018.3.5/lib/slf4j-log4j12-1.7.25.jar!/org/slf4j/impl/StaticLoggerBinder.class]
SLF4J: See http://www.slf4j.org/codes.html#multiple_bindings for an explanation.
```

åŸæ¥ IntelliJ IDEA SDK å·²ç»æœ‰äº† `slf4j-log4j12`, å› æ­¤æˆ‘ä»¬å¯ä»¥ä¸ç”¨é…ç½®äº†....ğŸ˜‚ (æåŠå¤©, æ˜¯è‡ªå·±ç»™è‡ªå·±æŒ–å‘).

å› æ­¤æœ€ç»ˆçš„é…ç½®å°±æ˜¯æœ€ä¸Šé¢ç»™å‡ºçš„é‚£ç§, å¦‚æœå¯¹ gradle ä¸ç†Ÿ, åˆæƒ³å¿«é€Ÿä¸Šæ‰‹çš„, ç›´æ¥å¤åˆ¶å°±å¯ä»¥äº†, å…ˆä¸å»æŠ˜è…¾ gradle çš„é…ç½®äº†, ä¸ç„¶å¼€å‘ idea
æ’ä»¶çš„çƒ­æƒ…å°±ä¼šåœ¨ä¸æ–­çš„å¡«å‘è¿‡ç¨‹ä¸­æ…¢æ…¢æ•£å»....

**ä¸‹è½½ intellij SDK å¾ˆæ…¢, å‡†å¤‡å¥½æ¢¯å­å§**

## Hello world

```
äººä¹‹åˆ, æ€§æœ¬å–„;
å†™ä»£ç , hello world.
```

### AnAction

`AnAction` æ˜¯ä»€ä¹ˆå…ˆä¸ç®¡, ä¸å°±æŠŠå®ƒç†è§£æˆ JavaScript é‡Œé¢çš„ `onclick` äº‹ä»¶å¤„ç†å§

```java
@Slf4j
public class HelloAction extends AnAction {
    public HelloAction() {
        super("Hello");
    }

    /**
     * å“åº”ç”¨æˆ·çš„ç‚¹å‡»äº‹ä»¶
     *
     * @param event the event
     */
    @Override
    public void actionPerformed(@NotNull AnActionEvent event) {
        log.info(event.toString());
        Project project = event.getProject();
        Messages.showMessageDialog(project,
                                   "Hello world!",
                                   "Greeting",
                                   Messages.getInformationIcon());
    }
}
```

å†æ¥ä¸€ä¸ª

```java
public class AliyunOssUpload extends AnAction {

    @Override
    public void actionPerformed(@NotNull AnActionEvent actionEvent) {
        // è·å–å½“å‰åœ¨æ“ä½œçš„å·¥ç¨‹ä¸Šä¸‹æ–‡
        Project project1 = actionEvent.getProject();
        // è·å–å½“å‰æ“ä½œçš„ç±»æ–‡ä»¶
        PsiFile psiFile = actionEvent.getData(CommonDataKeys.PSI_FILE);
        // è·å–å½“å‰ç±»æ–‡ä»¶è·¯å¾„
        String classPath = "";
        if (psiFile != null) {
            classPath = psiFile.getVirtualFile().getPath();
        }
        String title = "hello world";

        // æ˜¾ç¤ºå¯¹è¯æ¡†
        Messages.showMessageDialog(project1, classPath, title, Messages.getInformationIcon());
    }
}
```

### æ³¨å†Œ

åœ¨ `plugin.xml` ä¸­æ³¨å†Œä¸Šé¢çš„ç±», å¯åŠ¨åä¼šé€šè¿‡åå°„æ¥è°ƒç”¨æˆ‘ä»¬çš„å¤„ç†é€»è¾‘.

```xml
<idea-plugin>
    <!-- æ’ä»¶åŸºæœ¬ä¿¡æ¯ -->
    <id>info.dong4j.aliyun-oss-upload</id>
    <name>Aliyun OSS upload</name>
    <version>0.0.1</version>
    <vendor email="dong4j@gmail.com" url="http://www.dong4j.info">dong4j</vendor>

    <depends>com.intellij.modules.lang</depends>
    <description>
        Aliyun OSS upload, xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
    </description>

    <!-- please see http://www.jetbrains.org/intellij/sdk/docs/basics/getting_started/plugin_compatibility.html
         on how to target different products -->
    <!-- uncomment to enable plugin in all products
    <depends>com.intellij.modules.lang</depends>
    -->

    <!-- æ’ä»¶æ‰©å±•æ ‡ç­¾ -->
    <extensions defaultExtensionNs="com.intellij">
        <!-- Add your extensions here -->
        <applicationService serviceInterface="info.dong4j.test.HelloApplicationText"
                            serviceImplementation="info.dong4j.test.impl.HelloApplicationTextImpl"/>
    </extensions>

    <!-- action æ³¨å†Œæ ‡ç­¾ -->
    <actions>
        <!-- åˆ›å»ºä¸€ä¸ªæ–°çš„ group, ä¹Ÿå¯ä»¥æ·»åŠ åˆ°å·²æœ‰çš„ group ä¸Š -->
        <group id="MyPlugin.SampleMenu" text="Greeting" description="Greeting menu">
            <!-- æ·»åŠ åˆ° MainMenu group ä¸‹, ä½ç½®ä¸º `last` -->
            <add-to-group group-id="MainMenu" anchor="last"/>
            <!-- id å”¯ä¸€, class å°±æ˜¯æˆ‘ä»¬çš„å¤„ç†ç±» -->
            <action id="Myplugin.Textboxes" class="info.dong4j.test.HelloAction" text="Hello"  description="Says hello" />
        </group>
        <!-- å¦ä¸€ä¸ª action -->
        <action id="info.dong4j.aliyun-oss-upload" class="info.dong4j.test.AliyunOssUpload" text="upload aliyun oss"
                description="ä¸Šä¼ æ–‡ä»¶åˆ° aliyun OSS">
            <!-- æ·»åŠ åˆ° GenerateGroup group ä¸‹, ä½ç½®ä¸º `last` -->
            <add-to-group group-id="GenerateGroup" anchor="last"/>
        </action>
    </actions>
</idea-plugin>
```

### è¿è¡Œ

![20241229154732_kLdFErTd.webp](https://cdn.dong4j.site/source/image/20241229154732_kLdFErTd.webp)

### æ•ˆæœ

![20241229154732_YXuvDDzQ.webp](https://cdn.dong4j.site/source/image/20241229154732_YXuvDDzQ.webp)

ç‚¹å‡» 'Hello' ä¹‹å:

![20241229154732_BXw3O7QS.webp](https://cdn.dong4j.site/source/image/20241229154732_BXw3O7QS.webp)

## æ€»ç»“

å…¥é—¨å¾ˆå¿«, å› æ­¤å†™å¾—ä¸æ˜¯éå¸¸è¯¦ç»†, å› ä¸ºå…¥é—¨ç›¸å…³çš„æ•™ç¨‹å·²ç»éå¸¸å¤šäº†,
å¯å‚è§ [ğŸ‘‰ å®˜æ–¹å…¥é—¨æ•™ç¨‹](https://www.jetbrains.org/intellij/sdk/docs/basics/getting_started.html).

è¿˜æœ‰å¾ˆå¤šæ‰‹æŠŠæ‰‹æ•™çš„å…¥é—¨æ•™ç¨‹, ä¸€æœä¸€å¤§æŠŠ, å› æ­¤æ­¤ç³»åˆ—æ–‡ç« åªä¼šè®°å½•å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜å’Œç»éªŒæ€»ç»“.

ä¸ºäº†å¤§å®¶å¿«é€Ÿå…¥æ‰‹, è¿™é‡Œç»™å‡ºæ­¤é¡¹ç›®çš„ [ğŸ‘‰ github åœ°å€](), æ„¿æœ‰ç¼˜äººèµ¶ç´§å…¥å‘, ä¸€èµ·æ¥å­¦ä¹ å¼€å‘ idea æ’ä»¶.

å‘Šè¯‰ä½ ä¸€ä¸ªå¥½æ¶ˆæ¯, Intellij idea å¼€å¯äº†ä¸€ä¸ªæ’ä»¶æ”¶è´¹å¹³å°, æ¥è®©æ›´å¤šçš„æ’ä»¶å¼€å‘ä¸­ä»ä¸­è·åˆ©.

![20241229154732_jPBRqQCs.webp](https://cdn.dong4j.site/source/image/20241229154732_jPBRqQCs.webp)

è¯¦æƒ…å¯è§ [ğŸ‘‰ Marketplace](https://plugins.jetbrains.com/marketplace)

æ­¤ç¯‡æ–‡æ¡£æ¶‰åŠåˆ°çš„å…¨éƒ¨ä»£ç è¯·çœ‹ [ğŸ‘‰ Github](https://github.com/dong4j/aliyun-oss-upload/tree/1.hello-world). ç»™ä¸ª star å‘—.

## [æ‹ä¸€æ‹ async-tool çš„é—®é¢˜](https://blog.dong4j.site/posts/a42dfdd6.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})


æ˜¨å¤©åšå®Œç²¾å‡†è¥é”€çš„éœ€æ±‚å, ææµ‹ç‰ˆæœ¬ä¸€ç›´è¿ä¸ä¸Š MQ, ç„¶ååœ¨æœ¬åœ°å¯åŠ¨åä¹Ÿæœªå‘ç°é—®é¢˜, ç›´åˆ°ç›‘å¬çš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰æ¶ˆæ¯è€Œä¸”æ˜¯**å¤§é‡æ¶ˆæ¯**æ—¶æ‰ä¼šå‡ºç°çš„é”™è¯¯:

```java
javax.jms.JMSException: Cannot send, channel has already failed: tcp://172.31.205.58:61616
	at org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:62)
	at org.apache.activemq.ActiveMQConnection.syncSendPacket(ActiveMQConnection.java:1409)
	at org.apache.activemq.ActiveMQConnection.ensureConnectionInfoSent(ActiveMQConnection.java:1496)
	at org.apache.activemq.ActiveMQConnection.createSession(ActiveMQConnection.java:325)
	at org.apache.activemq.pool.ConnectionPool$2.makeObject(ConnectionPool.java:105)
	at org.apache.activemq.pool.ConnectionPool$2.makeObject(ConnectionPool.java:90)
	at org.apache.commons.pool.impl.GenericKeyedObjectPool.borrowObject(GenericKeyedObjectPool.java:1179)
	at org.apache.activemq.pool.ConnectionPool.createSession(ConnectionPool.java:142)
	at org.apache.activemq.pool.PooledConnection.createSession(PooledConnection.java:174)
	at com.xxxx.msearch.core.support.activemq.producer.JmsProducer.sendMsg(JmsProducer.java:137)
	at com.xxxx.msearch.core.support.activemq.producer.JmsProducer.access$100(JmsProducer.java:19)
	at com.xxxx.msearch.core.support.activemq.producer.JmsProducer$2.run(JmsProducer.java:114)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.Thread.run(Thread.java:748)
Caused by: org.apache.activemq.transport.InactivityIOException: Cannot send, channel has already failed: tcp://172.31.205.58:61616
	at org.apache.activemq.transport.AbstractInactivityMonitor.doOnewaySend(AbstractInactivityMonitor.java:315)
	at org.apache.activemq.transport.AbstractInactivityMonitor.oneway(AbstractInactivityMonitor.java:304)
	at org.apache.activemq.transport.TransportFilter.oneway(TransportFilter.java:85)
	at org.apache.activemq.transport.WireFormatNegotiator.oneway(WireFormatNegotiator.java:104)
	at org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:68)
	at org.apache.activemq.transport.ResponseCorrelator.asyncRequest(ResponseCorrelator.java:81)
	at org.apache.activemq.transport.ResponseCorrelator.request(ResponseCorrelator.java:86)
	at org.apache.activemq.ActiveMQConnection.syncSendPacket(ActiveMQConnection.java:1380)
	... 13 more
```

å› æ­¤å¼€å§‹èµ°ä¸Š debug è¿™æ¡ä¸å½’è·¯...

## å®šä½é—®é¢˜

ä¸Šé¢æŠ¥çš„é”™è¯¯, ä¸€å¼€å§‹æ€€ç–‘æ˜¯ ActiveMQ æ¶ˆè´¹è€…è¿æ¥æ–­å¼€, å¯¼è‡´å‘é€ä¸äº†æ¶ˆæ¯, å› æ­¤ä¸€æ¥å°±å¼€å§‹ debug `sendMsg()` è¿™ä¸ªæœ€ç»ˆå‘é€æ¶ˆæ¯çš„æ–¹æ³•.

```java
private void sendMsg(String queue, String jsonStr) throws Exception {
    Connection connection = null;
    Session session = null;
    MessageProducer producer = null;
    try {
        //ä»è¿æ¥æ± å·¥å‚ä¸­è·å–ä¸€ä¸ªè¿æ¥
        connection = this.connectionFactory.createConnection();
        //false å‚æ•°è¡¨ç¤º ä¸ºéäº‹åŠ¡å‹æ¶ˆæ¯ï¼Œåé¢çš„å‚æ•°è¡¨ç¤ºæ¶ˆæ¯çš„ç¡®è®¤ç±»å‹
        session = connection.createSession(Boolean.FALSE, Session.AUTO_ACKNOWLEDGE);
        //PTPæ¶ˆæ¯æ–¹å¼
        Destination destination = session.createQueue(queue);
        //Destination is superinterface of Queue
        producer = createProducer(producer, session, destination);
        //map convert to javax message
        Message message = getMessage(session, jsonStr);
        producer.send(message);
        log.info("send message, producer = {}", producer.getClass());
    } finally {
        closeSession(session);
        closeConnection(connection);
    }
}
```

å…ˆè¯´è¿™ä¸ªæ–¹æ³•çš„é—®é¢˜:

å½“æ¯æ¬¡å‘é€æ¶ˆæ¯æ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ª ActiveMQ è¿æ¥, ç„¶ååˆ›å»ºä¸€ä¸ª session, æœ€ååˆ›å»ºä¸€ä¸ª producer, æ¶ˆæ¯å‘é€å®Œæˆåå…³é—­è¿æ¥.
é¢‘ç¹çš„åˆ›å»ºå…³é—­è¿æ¥å°†æ¶ˆè€—å¤§é‡ç³»ç»Ÿèµ„æº, é™ä½æ€§èƒ½, å› æ­¤ä¸€èˆ¬ä½¿ç”¨è¿æ¥æ± æ¥ä¿å­˜è¿æ¥.

![20241229154732_5j5D0l4d.webp](https://cdn.dong4j.site/source/image/20241229154732_5j5D0l4d.webp)
![20241229154732_7JQ0LlKY.webp](https://cdn.dong4j.site/source/image/20241229154732_7JQ0LlKY.webp)

ä» debug æ—¥å¿—ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥, è¿æ¥ååˆ close äº†.

å› æ­¤å°† Connection, Session, Producer è¿›è¡Œå¤ç”¨. (è¿™ä¹Ÿæ˜¯ ActiveMQ å®˜æ–¹æ¨èçš„åšæ³•).

å°†åˆ›å»º producer çš„æ•´ä¸ªæ“ä½œæ”¾åˆ° init() ä¸­, åªæ‰§è¡Œä¸€æ¬¡.

```java
private MessageProducer producer = null;

private void init() throws Exception {
    //è®¾ç½®JAVAçº¿ç¨‹æ± 
    this.threadPool = Executors.newFixedThreadPool(this.threadPoolSize);
    //ActiveMQçš„è¿æ¥å·¥å‚
    ActiveMQConnectionFactory actualConnectionFactory = new ActiveMQConnectionFactory(this.userName, this.password, this.brokerUrl);
    actualConnectionFactory.setUseAsyncSend(this.useAsyncSendForJMS);
    //Activeä¸­çš„è¿æ¥æ± å·¥å‚
    this.connectionFactory = new PooledConnectionFactory(actualConnectionFactory);
    this.connectionFactory.setCreateConnectionOnStartup(true);
    this.connectionFactory.setMaxConnections(this.maxConnections);
    this.connectionFactory.setMaximumActiveSessionPerConnection(this.maximumActiveSessionPerConnection);

    Connection connection;
    Session session;
    //ä»è¿æ¥æ± å·¥å‚ä¸­è·å–ä¸€ä¸ªè¿æ¥
    connection = this.connectionFactory.createConnection();
    //false å‚æ•°è¡¨ç¤º ä¸ºéäº‹åŠ¡å‹æ¶ˆæ¯ï¼Œåé¢çš„å‚æ•°è¡¨ç¤ºæ¶ˆæ¯çš„ç¡®è®¤ç±»å‹
    session = connection.createSession(Boolean.FALSE, Session.AUTO_ACKNOWLEDGE);
    //PTPæ¶ˆæ¯æ–¹å¼
    Destination destination = session.createQueue("BiUserStatusSignal");
    //Destination is superinterface of Queue
    producer = createProducer(producer, session, destination);
}
```

é‡å†™ `sendMsg()`

```java
private void sendMsg(String jsonStr) throws Exception {
    ActiveMQTextMessage message = new ActiveMQTextMessage();
    message.setText(jsonStr);
    producer.send(message);
    log.info("send");
}
```

å½“æˆ‘ä»¥ä¸ºå°±è¿™ä¹ˆå®¹æ˜“çš„æŠŠé—®é¢˜è§£å†³çš„æ—¶å€™, æ–°çš„é”™è¯¯åˆæ¥äº†(å¦‚æœé—®é¢˜å°±è¿™ä¹ˆè§£å†³äº†, æˆ‘ä¹Ÿä¸ä¼šå†™è¿™ä¸ªæ–‡æ¡£äº†).

```java
Caused by: org.apache.activemq.transport.InactivityIOException: Cannot send, channel has already failed: tcp://172.31.205.58:61616
	at org.apache.activemq.transport.AbstractInactivityMonitor.doOnewaySend(AbstractInactivityMonitor.java:315)
	at org.apache.activemq.transport.AbstractInactivityMonitor.oneway(AbstractInactivityMonitor.java:304)
	at org.apache.activemq.transport.WireFormatNegotiator.sendWireFormat(WireFormatNegotiator.java:168)
	at org.apache.activemq.transport.WireFormatNegotiator.sendWireFormat(WireFormatNegotiator.java:84)
	at org.apache.activemq.transport.WireFormatNegotiator.start(WireFormatNegotiator.java:74)
	at org.apache.activemq.transport.TransportFilter.start(TransportFilter.java:58)
	at org.apache.activemq.transport.TransportFilter.start(TransportFilter.java:58)
	at org.apache.activemq.ActiveMQConnectionFactory.createActiveMQConnection(ActiveMQConnectionFactory.java:273)
	... 25 more
java.lang.NullPointerException
	at com.xxxx.msearch.core.support.activemq.producer.JmsProducer.sendMsg(JmsProducer.java:155)
	at com.xxxx.msearch.core.support.activemq.producer.JmsProducer.access$100(JmsProducer.java:24)
	at com.xxxx.msearch.core.support.activemq.producer.JmsProducer$2.run(JmsProducer.java:137)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.Thread.run(Thread.java:748)
```

è¿™æ¬¡ä¸ä»…å‡ºç°äº† `NullPointerException`, ä»¥å‰çš„å¼‚å¸¸è¿˜æ˜¯å­˜åœ¨, ActiveMQ çš„è¿æ¥ä¾ç„¶å¾ˆå¤š

![20241229154732_37jKEmDb.webp](https://cdn.dong4j.site/source/image/20241229154732_37jKEmDb.webp)

å”¯ä¸€æ”¹å–„çš„å°±æ˜¯**å¼‚å¸¸å‡ºç°çš„é¢‘ç‡é™ä½äº†**. å› æ­¤è¿™ä¸ªä¸æ˜¯æœ€æ ¹æœ¬çš„åŸå› .

é‚£ä¹ˆæ€è€ƒä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šå‡ºç° `NullPointerException`.

ä¸Šé¢çš„ä»£ç è‚¯å®šæ˜¯æ²¡æœ‰é—®é¢˜çš„, é™¤éæ˜¯åœ¨**å¤šçº¿ç¨‹ç¯å¢ƒ**ä¸‹.

å¦ä¸€ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜:

![20241229154732_JHWp8RuI.webp](https://cdn.dong4j.site/source/image/20241229154732_JHWp8RuI.webp)

ğŸ˜³ğŸ˜³ å±…ç„¶èƒ½æœ‰ 40 å¤šä¸ªçº¿ç¨‹æ± ......
å¥½äº†, åŸºæœ¬çŸ¥é“ä»€ä¹ˆåŸå› å¯¼è‡´çš„äº†, **å¹¶å‘ + çº¿ç¨‹æ± **é—®é¢˜.

çœ‹çœ‹è¿è¡Œæ—¶çš„çº¿ç¨‹:

![20241229154732_3MHihWXd.webp](https://cdn.dong4j.site/source/image/20241229154732_3MHihWXd.webp)

åƒåœ¾å›æ”¶é¢‘ç¹, çº¿ç¨‹æ•°è¿˜åœ¨ä¸æ–­å¢é•¿.....

## è¿½è¸ªä»£ç 

åˆå§‹åŒ– producer çš„è¿æ¥æ± å°±æ˜¯ `init()` çš„è¿™æ®µä»£ç 

```java
//è®¾ç½®JAVAçº¿ç¨‹æ± 
this.threadPool = Executors.newFixedThreadPool(this.threadPoolSize);
```

èƒ½åˆå§‹åŒ–å¤šä¸ªè¿æ¥æ± , `init()` è‚¯å®šè¢«é”™è¯¯çš„æ‰§è¡Œäº†å¤šæ¬¡. é€šè¿‡æŸ¥çœ‹ `BiUserStatusTask` è¿™ä¸ªç±»,èƒ½æ‰§è¡Œ `init()` çš„ä¹Ÿåªæœ‰ä¸‹é¢çš„ä»£ç äº†.

```java
JmsProducerFactory jmsProducerFactory = new JmsProducerFactory(producerJmsConfig);

...
jmsProducerFactory.start();
```

`start()` æ–¹æ³•ä¼šåˆ¤æ–­ JmsProducer æ˜¯å¦ null, ä¸º null æ‰ä¼šè°ƒç”¨ `init()` æ¥åˆ›å»ºçº¿ç¨‹æ± 

```java
public synchronized void start() {
    if(started.get()) {
        return;
    }
    //é…ç½®ä¸‹å‘åˆ°ç›¸å…³ç»„ä»¶
    deliverConfig();
    started.set(true);
}

private void deliverConfig(){
    if (jmsProducer == null) {
        jmsProducer = new JmsProducer(jmsConfig.getBrokerURL(), jmsConfig.getUserName(), jmsConfig.getPassword());
    }
}
```

æ•´ä¸ª `BiUserStatusTask` ç±»çš„ä»£ç ä¹Ÿæ²¡æœ‰çœ‹å‡ºå“ªä¸ªåœ°æ–¹ä¼šå¤šæ¬¡åˆ›å»ºçº¿ç¨‹æ± . æ²¡åŠæ³•åªæœ‰åŠ æ—¥å¿—.

![20241229154732_NirD1EBV.webp](https://cdn.dong4j.site/source/image/20241229154732_NirD1EBV.webp)

é—®é¢˜æ‰¾åˆ°äº†, æ˜¯è¿›å…¥ catch äº† ğŸ˜¥.

![20241229154732_o2lyOx1X.webp](https://cdn.dong4j.site/source/image/20241229154732_o2lyOx1X.webp)

åŸæ¥æ˜¯ `JsonUtil.jsonToMap(text)` è§£ææŠ›å¼‚å¸¸äº† ğŸ˜°. (ä¸ºä»€ä¹ˆæˆ‘æ²¡æœ‰åœ¨ `BiUserStatusTask` ä¸­æ‰“æ–­ç‚¹, å› ä¸ºä¸€ç›´ä»¥ä¸ºæ˜¯ producer
å‘é€æ¶ˆæ¯çš„ä»£ç æœ‰é—®é¢˜).

æœ€å¥½çš„ debug æ–¹å¼å°±æ˜¯**æ—¥å¿—**, å› ä¸º debug å¾ˆæ…¢, è€Œä¸”å¤šçº¿ç¨‹çš„æ—¶å€™å¹¶ä¸å¥½ debug. ä¸Šé¢çš„ä»£ç åœ¨ catch ä¸­ç›´æ¥å°±å‘é€å¼‚å¸¸æ¶ˆæ¯ç„¶åå…¥åº“, å¯¼è‡´æ—¥å¿—ä¸­æ²¡æœ‰é”™è¯¯ä¿¡æ¯.

catch ä¸­ä¸€å®šè¦æ‰“å°æ—¥å¿—, å› ä¸ºè¿™ä¸ªå±äºç³»ç»Ÿå¼‚å¸¸æ—¥å¿—, æ˜¯ç»™å¼€å‘çš„äººçœ‹çš„, è€Œéœ€è¦å…¥åº“çš„æ—¥å¿—ä¸€èˆ¬éƒ½æ˜¯ä¸šåŠ¡æ—¥å¿—æˆ–è€…ä¸šåŠ¡å¼‚å¸¸æ—¥å¿—,
å¼€å‘çš„æ—¶å€™è°å†å»æŸ¥ä¸€ä¸‹æ•°æ®åº“æœ‰æ²¡æœ‰å¼‚å¸¸æ—¥å¿—å•Š! ç›´æ¥æ‰“å°åˆ°æ—¥å¿—ä¸æ˜¯æ›´å¥½å—? **æ•ˆç‡å°±æ˜¯ç”Ÿå‘½**!

ä¹Ÿè¯·ä¸è¦æŠŠæ‰€æœ‰ä»£ç éƒ½åŒ…è£¹åœ¨ try-catch é‡Œé¢, æœ€å¥½æŠŠå¼‚å¸¸åˆ†ç±»å¤„ç†, ä¸€ä¸ª catch å°±æŠŠæ‰€æœ‰å¼‚å¸¸æ•è·äº†å€’æ˜¯ç®€å•, ä½†æ˜¯ä¸å¥½æ’æŸ¥é—®é¢˜, ä¹Ÿä¼šå½±å“æ‰§è¡Œæ•ˆç‡.

å†™ä»£ç çš„æ—¶å€™, å°½é‡æŠŠå¼‚å¸¸æš´éœ²å‡ºæ¥, ä¸è¦å¿½ç•¥ catch. åœ¨ç¼–ç é˜¶æ®µå°±å°½å¯èƒ½å¤šçš„å¤„ç†å¼‚å¸¸, è€Œä¸æ˜¯ä¸Šçº¿äº†å†™åˆ°æ•°æ®åº“, ç„¶åç»Ÿè®¡å¼‚å¸¸æ•°æ®æ¥æŠ¥è­¦.

ä»¥å‰å†™è¿‡äº›æ–¹é¢çš„é—®é¢˜, ä¼°è®¡ä¹Ÿæ²¡äººåœ¨æ„å§.

## è¿›å…¥ä¸»é¢˜

å¥½äº†, é‡ç‚¹æ¥äº†.

catch é‡Œé¢ä¹Ÿä¼šå‘é€ MQ æ¶ˆæ¯, ä¼šä¸ä¼šæ˜¯è¿™é‡Œé¢çš„é—®é¢˜å‘¢? é‚£æˆ‘ä»¬å…ˆæ¥æ‹ä¸€æ‹ `LogSupportException.writeFuncExceptionLog()` è¿™ä¸ªæ–¹æ³•

```java
public class LogSupportException {
    private static LogService logService = LogServiceFactory.getLogService();

    /**
     * å°è£…é”™è¯¯ä¿¡æ¯
     */
    public static void writeSupportExceptionLog(Exception e, String componentName, String methodName, String className, String inputParams, String logDesc, LogSupportException.ErrorLevel errorLevel) {
        ...
        saveException(logField);
    }
    ...
}
```

`writeSupportExceptionLog()` æ˜¯å°è£…å¤„ç†ä¿¡æ¯çš„å¤„ç† (æ€§èƒ½å¾ˆä½, å°±ä¸åæ§½äº†, è‡ªå·±å»çœ‹å§). ä¼šè°ƒç”¨ `logService.saveLog()` å‘é€å¼‚æ­¥æ¶ˆæ¯.

é‚£ä¹ˆ `logService` æ˜¯å“ªé‡Œæ¥çš„å‘¢?

```java
private static LogService logService = LogServiceFactory.getLogService();
```

æ˜¯ä¸€ä¸ªé™æ€å±æ€§, è¿™é‡Œå¤ä¹ ä¸€ä¸‹ç±»çš„åˆå§‹åŒ–é¡ºåº.

.java è¢«ç¼–è¯‘æˆ .class è¢« Classloader åŠ è½½åˆ° JVM çš„æ—¶å€™, é¦–å…ˆä¼šè°ƒç”¨ **static
ä»£ç å— **å’Œåˆå§‹åŒ– **é™æ€å±æ€§** (è¿™ä¸ªçœ‹ 2 è€…ä»£ç çš„é¡ºåº), å¦‚æœæ–°åˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™, ä¼šå…ˆæ‰§è¡Œ**ä»£ç å—**, ç„¶åæ‰æ˜¯**æ„é€ æ–¹æ³•**. é‚£ä¹ˆé—®é¢˜æ¥äº†,
å­ç±»çˆ¶ç±»åˆå§‹åŒ–çš„é¡ºåºæ˜¯ä»€ä¹ˆå‘¢?

`logService` æ˜¯ä¸€ä¸ªé™æ€å±æ€§, ä¼šåœ¨è¢« JVM åŠ è½½çš„æ—¶å€™å°±åˆå§‹åŒ–, ä¸ç®¡æœ‰æ²¡æœ‰åˆ›å»ºè¿™ä¸ªç±»çš„å®ä¾‹.
å› æ­¤æˆ‘ä»¬è¿›å…¥åˆ° `LogServiceFactory.getLogService()`

```java
public class LogServiceFactory {
    private static ApplicationContext context = null;
    private static LogService logService = null;
    private static LogService logServiceB = null;
    private static boolean initFlag = false;

    synchronized static void init() {
        if (!initFlag) {
            context = new ClassPathXmlApplicationContext(
                    "classpath*:applicationContext-jms.xml");
            initFlag = true;
        }
    }

    synchronized static void initLogService() {
        if (initFlag && logService == null) {
            logService = (LogService) context.getBean("logServiceConcurrent");
            logServiceB = (LogService) context.getBean("logServiceConcurrentB");

            initFlag = true;
        }
    }



    public static LogService getLogService() {
        if (!initFlag) {
            init();
        }

        if (initFlag && logService == null) {
            initLogService();
        }

        return logService;
    }

    public static LogService getLogServiceB() {
        if (!initFlag) {
            init();
        }

        if (initFlag && logServiceB == null) {
            initLogService();
        }

        return logServiceB;
    }

    public static <T> T getBean(String name) throws BeansException {
        return (T) context.getBean(name);
    }
}
```

å“ˆå“ˆå“ˆ ç†Ÿæ‚‰å§, ä½¿ç”¨é™æ€ä»£ç å—æ¥åˆå§‹åŒ– Spring å®¹å™¨

```java
synchronized static void init() {
    if (!initFlag) {
        context = new ClassPathXmlApplicationContext(
                "classpath*:applicationContext-jms.xml");
        initFlag = true;
    }
}
```

å…¶å®è¿™é‡Œä½¿ç”¨ `synchronized` æ˜¯å¤šä½™çš„, å› ä¸º Classloader ä» JVM åº•å±‚ä¸Šå°±ä¿è¯äº†åŠ è½½ä¸€ä¸ªç±»çš„åŒæ­¥æ€§, é¿å…äº†å¹¶å‘é—®é¢˜.

è®°ä½å“¦, è¿™é‡Œæ˜¯**ç¬¬ä¸€æ¬¡**ä½¿ç”¨ `new ClassPathXmlApplicationContext()` æ¥åˆå§‹åŒ– Spring å®¹å™¨, é…ç½®æ–‡ä»¶æ˜¯ `applicationContext-jms.xml`, åœ¨**ç¬¬äºŒæ¬¡
**çš„æ—¶å€™å†è¯´è¿™ä¹ˆåšå­˜åœ¨çš„é—®é¢˜.

é‚£ä¹ˆ `logService` ä» Spring å®¹å™¨ä¸­è·å–åˆ°äº†, ç„¶åè°ƒç”¨ `saveLog()`, ä¸‹é¢æ˜¯ `saveLog()` çš„å®ç°:

```java
@Override
public boolean saveLog(String key, Object logMessage) {
    String queueName = JmsTemplateFacotry.getJmsConfig().getQueue();
    ObjectEvent objectEvent = new ObjectEvent(key, logMessage);
    return sendToMq(queueName, objectEvent);
}
```

æ²¡ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„, å°±æ˜¯ä»é…ç½®ä¸­è·å–é˜Ÿåˆ—å, ç„¶åè°ƒç”¨ `sendToMq()`, ä½†æ˜¯å¾—ä¸€æ­¥ä¸€æ­¥è·Ÿä»£ç å‘€, ä¸ç„¶æ€ä¹ˆçŸ¥é“æœ‰ä»€ä¹ˆé—®é¢˜.

```java
String queueName = JmsTemplateFacotry.getJmsConfig().getQueue();
```

é‚£æˆ‘ä»¬å°±çœ‹çœ‹ `JmsTemplateFacotry` è¿™ä¸ªç±»,

```java
public class JmsTemplateFacotry {
    private static JmsProducer jmsProducer;
    private static JmsConsumer jmsConsumer;
    private static JmsConfig jmsConfig;

    static {
        ApplicationContext context = new ClassPathXmlApplicationContext(
                "classpath*:applicationContext-jms.xml");
        jmsConfig =  (JmsConfig) context.getBean("jmsTemplateConfig");
    }

    public static void initProducer(){
        if (jmsProducer == null) {
            jmsProducer = new JmsProducer(jmsConfig.getBrokerURL(), jmsConfig.getUserName(), jmsConfig.getPassword());
        }
    }

    public static void initConsumer(){
        if(jmsConsumer == null){
            jmsConsumer = new JmsConsumer(jmsConfig.getBrokerURL(),jmsConfig.getUserName(),jmsConfig.getPassword());
        }
    }

    public static void messageSender(String queue,String jsonStr){
        initProducer();
        jmsProducer.send(queue, jsonStr);
    }

    public static JmsConsumer getJmsConsumer(){
        initConsumer();
        return jmsConsumer;
    }

    public static JmsConfig getJmsConfig(){
        return jmsConfig;
    }
}

```

ğŸ˜ çœ‹è§æ²¡,åˆæ˜¯ä¸ªé™æ€ä»£ç å—, **ç¬¬äºŒæ¬¡**é€šè¿‡ `new ClassPathXmlApplicationContext()` åˆå§‹åŒ– Spring å®¹å™¨äº†å“¦,
é…ç½®æ–‡ä»¶è¿˜æ˜¯ `applicationContext-jms.xml`.

### Spring åˆå§‹åŒ–é—®é¢˜

é‚£æˆ‘ä»¬æ¥è¯´è¯´ä¸¤æ¬¡åˆå§‹åŒ– Spring å®¹å™¨çš„é—®é¢˜.

```java
ApplicationContext context = new ClassPathXmlApplicationContext("classpath*:applicationContext-jms.xml");
```

å¦‚æœè°ƒç”¨å¤šæ¬¡ä¸Šé¢çš„æ–¹æ³•, å°†å¯¼è‡´åˆå§‹åŒ–å¤šä¸ª Spring å®¹å™¨

ç¬¬ä¸€ä¸ª:

![20241229154732_Vb1Unnl6.webp](https://cdn.dong4j.site/source/image/20241229154732_Vb1Unnl6.webp)
![20241229154732_BnXpQpfk.webp](https://cdn.dong4j.site/source/image/20241229154732_BnXpQpfk.webp)

ç¬¬äºŒä¸ª:

![20241229154732_71YaDYHx.webp](https://cdn.dong4j.site/source/image/20241229154732_71YaDYHx.webp)
![20241229154732_can7KSuN.webp](https://cdn.dong4j.site/source/image/20241229154732_can7KSuN.webp)

ä¹Ÿå°±æ˜¯è¯´åŒä¸€ä¸ª bean ä¼šè¢«åˆå§‹åŒ– 2 æ¬¡.

**Spring å®¹å™¨ä¸­çš„ bean é»˜è®¤æ˜¯å•ä¾‹çš„**, è¯´çš„æ˜¯**åŒä¸€ä¸ª Spring å®¹å™¨**åªèƒ½å­˜åœ¨ä¸€ä¸ªç›¸åŒçš„ bean.

å¦‚æœæ˜¯ Spring + Spring MVC ç›¸åŒçš„ bean è¢«åˆå§‹åŒ– 2 æ¬¡, ä¼šå¯¼è‡´äº‹åŠ¡ä¸ç”Ÿæ•ˆ, @Value ä¸ç”Ÿæ•ˆç­‰å„ç§å„æ ·çš„é—®é¢˜, å› æ­¤æœ€ä½³å®è·µæ˜¯æŠŠ Spring å®¹å™¨å’Œ Spring
MVC å®¹å™¨åˆ†å¼€åŠ è½½, æ¯ä¸ªå®¹å™¨åªåˆå§‹åŒ–å¯¹åº”çš„ bean.

é‡å¤çš„åˆå§‹åŒ–é€ æˆèµ„æºæµªè´¹, è€Œä¸”è¿˜ä¼šå¯¼è‡´ä¸ç¡®å®šæ€§é—®é¢˜å‡ºç°, æ‰€ä»¥ä»¥å‰è€çš„åˆå§‹åŒ–æ–¹å¼ä¸å¯å–, æ­£ç¡®çš„åšæ³•:

å­åŒ…åªéœ€è¦æä¾›åŠŸèƒ½å³å¯, **ä¸è¦è‡ªä½œä¸»å¼ çš„åˆå§‹åŒ–**. åˆå§‹åŒ–çš„å·¥ä½œç»Ÿä¸€ç”±éƒ¨ç½²åŒ…(éœ€è¦è¿è¡Œçš„ä¸»ç±»æˆ– Web)æ¥åš, é€šè¿‡ import å­åŒ…çš„ xml é…ç½®,
ç»Ÿä¸€ç”±çˆ¶å®¹å™¨æ¥ç®¡ç†æ‰€æœ‰ bean. è¿™æ ·å¯ä»¥ç»Ÿä¸€ç®¡æ§, é¿å…éšæ„åˆå§‹åŒ–. å¯¹äºé…ç½®æ–‡ä»¶ä¹Ÿæ˜¯è¿™ä¸ªé“ç†.

### å¹¶å‘é—®é¢˜

è¯´äº†è¿™ä¹ˆå¤š, ç»ˆäºè¦è¯´æ ¹æœ¬çš„é—®é¢˜äº†.

LogServiceAsyncJmsImpl å¼‚æ­¥å‘ mq ä¸­å‘é€å¼‚å¸¸æ—¥å¿—çš„æ–¹æ³•

```java
private boolean sendToMq(String queue, ObjectEvent objectEvent) {
    try {
        String jsonEvent = objectEvent.getKey()
                + "-"
                + JsonUtil.objectToJson(objectEvent
                .getMsg());
        // æ³¨æ„é‡ç‚¹ä»£ç 
        JmsTemplateFacotry.messageSender(queue, jsonEvent);
        return true;
    } catch (Exception ex) {
        log.error("JmsTemplateFacotry messageSender Error : {}", ex.getMessage());
    }
    return false;
}
```

messageSender() çš„å®ç°

```java
public static void messageSender(String queue,String jsonStr){
		initProducer();
		jmsProducer.send(queue, jsonStr);
}

public static void initProducer(){
	if (jmsProducer == null) {
		jmsProducer = new JmsProducer(jmsConfig.getBrokerURL(), jmsConfig.getUserName(), jmsConfig.getPassword());
	}
}
```

`messageSender()` ä¼šå…ˆåˆ¤æ–­ jmsProducer æ˜¯å¦ä¸º null, ä¸º null å°±å®ä¾‹åŒ–ä¸€ä¸ª `JmsProducer` å¯¹è±¡, å®ä¾‹åŒ– `JmsProducer` å¯¹è±¡æ—¶,
ä¼šè°ƒç”¨ä¸Šé¢åˆ›å»ºçº¿ç¨‹æ± çš„ `init()`.

çœ‹ç€æ˜¯ä¸ªå¾ˆåˆç†çš„é€»è¾‘, ä½†æ˜¯å´æ²¡æœ‰è€ƒè™‘**å¹¶å‘**çš„é—®é¢˜. å¦‚æœæ˜¯å¤šçº¿ç¨‹, ä¼šå‡ºç°ä¸Šé¢æƒ…å†µ?
åœ¨åˆ†æä¹‹å‰, å…ˆæ¥å¤ä¹ ä¸‹ä½¿ç”¨ new åˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„è¿‡ç¨‹:

![20241229154732_iZvvDu57.webp](https://cdn.dong4j.site/source/image/20241229154732_iZvvDu57.webp)

ä¸€ä¸ªç±»è¢« JVM åŠ è½½çš„æ—¶æœº:

1. ä½¿ç”¨ new å…³é”®å­—å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™;
2. è¯»å–æˆ–è®¾ç½®è¿™ä¸ªç±»çš„é™æ€å­—æ®µ(è¢« final ä¿®é¥°ï¼Œå·²åœ¨ç¼–è¯‘å™¨æŠŠç»“æœæ”¾å…¥å¸¸é‡æ± çš„é™æ€å­—æ®µé™¤å¤–)çš„æ—¶å€™;
3. è°ƒç”¨è¿™ä¸ªç±»çš„é™æ€æ–¹æ³•çš„æ—¶å€™;
4. ä½¿ç”¨ java.lang.reflect åŒ…å¯¹è¿™ä¸ªç±»è¿›è¡Œåå°„è°ƒç”¨çš„æ—¶å€™;
5. å½“è™šæ‹Ÿæœºå¯åŠ¨, ç›´æ¥æŒ‡å®šä¸€ä¸ªè¦æ‰§è¡Œçš„ç±»(ä¹Ÿå°±æ˜¯åŒ…å« main() çš„ä¸»ç±»);

ä¸Šé¢æ˜¯ç±»çš„åˆå§‹åŒ–çš„ 5 ç§æƒ…å†µ, é€šè¿‡é˜…è¯» `JmsProducer` ç±»çš„ä»£ç , æˆ‘ä»¬å¯ä»¥ç¡®å®š**ç¬¬ä¸€æ¬¡åˆå§‹åŒ–** `JmsProducer` æ—¶, å°±æ˜¯é€šè¿‡ new å…³é”®å­—.
å› æ­¤å…ˆæ‰§è¡Œ `JmsProducer` çš„åˆå§‹åŒ–æµç¨‹, æœ€ç»ˆåˆ›å»º `JmsProducer` ç±»çš„ class å¯¹è±¡.
æ³¨æ„å“¦, å¦‚æœä¸€å¼€å§‹ JVM æ²¡æœ‰åŠ è½½è¿‡ `JmsProducer` è¿™ä¸ªç±», ä¼šå…ˆå¯¹ç±»è¿›è¡ŒåŠ è½½ä»è€Œç”Ÿæˆå½“å‰ç±»çš„ class å¯¹è±¡, å¹¶ä¸ä¼šç”Ÿæˆ `JmsProducer` ç±»çš„å®ä¾‹å¯¹è±¡.

ä»¥ä¸Šæµç¨‹, JVM éƒ½èƒ½ä¿è¯æ˜¯åŒæ­¥çš„, å› æ­¤åŒä¸€ä¸ªç±»å‹åªèƒ½è¢«**åŒä¸€ä¸ªç±»åŠ è½½å™¨**åŠ è½½ä¸€æ¬¡.

> å…·ä½“å¯è§ ã€Œæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€ç¬¬ 7 ç« 

åªæœ‰å½“ä½¿ç”¨ `new` å…³é”®å­—æ—¶, å¦‚æœæ²¡æœ‰è¢« JVM åˆå§‹åŒ–å°±èµ°ä¸Šé¢çš„æµç¨‹, å¦‚æœå·²è¢«åˆå§‹åŒ–äº†, æ‰å¼€å§‹èµ°**ç±»çš„å®ä¾‹åŒ–æµç¨‹**,

![20241229154732_Zv0CZLC5.webp](https://cdn.dong4j.site/source/image/20241229154732_Zv0CZLC5.webp)

é‚£æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¿™æ®µä»£ç åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ä¼šå‡ºç°ä¸Šé¢é—®é¢˜:

```java
public static void initProducer(){
	if (jmsProducer == null) {
		jmsProducer = new JmsProducer(jmsConfig.getBrokerURL(),
                                  jmsConfig.getUserName(),
                                  jmsConfig.getPassword());
	}
}
```

**å…ˆè¯´ç¬¬ä¸€ä¸ªå¥½ç†è§£çš„æƒ…å†µ:**

å› ä¸ºæ˜¯å¤šçº¿ç¨‹ç¯å¢ƒ, å¯èƒ½åŒæ—¶å¤šä¸ªçº¿ç¨‹ä¸€èµ·è¿›å…¥ if åˆ¤æ–­é€»è¾‘, å› ä¸º `jmsProducer == null` ä¸º true, ä¼šæ‰§è¡Œå¤šæ¬¡å®ä¾‹åŒ–æµç¨‹.

**å…ˆæ¥è¯´è¯´å¦ä¸€ä¸ªå¤æ‚ç‚¹çš„æƒ…å†µ:**

å½“ç¬¬ä¸€æ¬¡æ‰§è¡Œ `JmsTemplateFacotry.initProducer()` æ—¶, `jmsProducer == null` .
å½“ **çº¿ç¨‹ 1** è¿›å…¥ if åˆ¤æ–­, ç”±äº `jmsProducer == null` ä¸º true, ä¼šæ‰§è¡Œå®ä¾‹åŒ–æµç¨‹.
è¿™ä¸ªæ—¶å€™ **çº¿ç¨‹ 2** è¿›å…¥ if åˆ¤æ–­é€»è¾‘, ç”±äºå®ä¾‹åŒ–æµç¨‹ä¹Ÿéœ€è¦æ—¶é—´, åœ¨è¿˜æ²¡æœ‰å®ä¾‹åŒ–å®Œæˆä¹‹å‰, `jmsProducer == null` ä¸º true, å› æ­¤ **çº¿ç¨‹ 2**
ä¼šå†æ¬¡å®ä¾‹åŒ–ä¸€ä¸ª `jmsProducer`.

æ€»ç»“ä¸€ä¸‹å®ä¾‹åŒ–å¯¹è±¡çš„è¿‡ç¨‹:

1. åˆ†é…å†…å­˜
2. åˆå§‹åŒ–å¯¹è±¡ï¼ˆå†…å­˜èµ‹å€¼ï¼‰
3. å†…å­˜åœ°å€èµ‹ç»™ instance ï¼ˆinstance != nullï¼‰

ä»¥ä¸ŠåŸå› ä¹Ÿå°±ç›´æ¥**å¯¼è‡´äº†åˆ›å»ºå¤šä¸ªçº¿ç¨‹æ± ** !!!

å°±è¿™ä¹ˆç®€å•, ç”±äºå¤šçº¿ç¨‹å¹¶å‘æ‰§è¡ŒåŒä¸€æ®µä»£ç . åšäº‹è¦éªŒè¯, é‚£æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹

```java
@Test
public void test1() throws InterruptedException {

    for (int index = 0; index < 1000; index++) {
        new Thread(new Runnable() {
            public void run() {
                try {
                    log.info("jsmProducer = {}", JmsTemplateFacotry.getJmsProducer());
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }).start();

    }

    Thread.currentThread().join();
}
```

è¾“å‡º:

```
com.xxxx.msearch.core.support.activemq.producer.JmsProducer@546dd457
com.xxxx.msearch.core.support.activemq.producer.JmsProducer@63666aa6
com.xxxx.msearch.core.support.activemq.producer.JmsProducer@63a9e6ce
com.xxxx.msearch.core.support.activemq.producer.JmsProducer@65da9f79
com.xxxx.msearch.core.support.activemq.producer.JmsProducer@3c657f0b
com.xxxx.msearch.core.support.activemq.producer.JmsProducer@679c614
com.xxxx.msearch.core.support.activemq.producer.JmsProducer@619ef7cf
com.xxxx.msearch.core.support.activemq.producer.JmsProducer@27081999
com.xxxx.msearch.core.support.activemq.producer.JmsProducer@1e4acc1c
com.xxxx.msearch.core.support.activemq.producer.JmsProducer@52370b34
com.xxxx.msearch.core.support.activemq.producer.JmsProducer@e8a0743
com.xxxx.msearch.core.support.activemq.producer.JmsProducer@d882d64
....
```

å¯¹å§, å®ä¾‹åŒ–äº†å¥½å¤šæ¬¡å§

## è§£å†³é—®é¢˜

çŸ¥é“äº†é—®é¢˜æ‰€åœ¨, è§£å†³é—®é¢˜å°±å¾ˆå®¹æ˜“äº†, æˆ‘ä»¬åªéœ€è¦ä¿è¯ `JmsProducer` æ˜¯å•ä¾‹çš„å°±å¯ä»¥äº†

[**å•ä¾‹çš„æ‰€æœ‰å†™æ³•ä¼šäº†å—?**](http://interview.dong4j.info/design-patterns/singleton.html)

è¿™é‡Œåªä½¿ç”¨æœ€å¯é æœ€ç®€å•çš„ä¸€ç§æ–¹å¼: **æšä¸¾** (ç¬¬äºŒä¸ªæ¨èé™æ€å†…éƒ¨ç±», ä¸æ¨è DCL, å› ä¸º DCL å¹¶ä¸å®Œå…¨å¯é )

```java
/**
 * <p>Company: xxxxå…¬å¸ </p>
 * <p>Description: æšä¸¾å•ä¾‹è·å– JmsProducer, ä¿è¯åªæœ‰ä¸€ä¸ªå®ä¾‹</p>
 *
 * @author dong4j
 * @date 2019-03-08 11:04
 * @email dong4j@gmail.com
 */
public enum JmsProducerEnum {
    INSTANCE;

    private JmsProducer instance;

    private JmsConfig jmsConfig;

    public void setJmsConfig(JmsConfig jmsConfig){
        this.jmsConfig = jmsConfig;
    }

    public JmsProducer getInstance() {
        if(instance == null){
            instance = new JmsProducer(jmsConfig.getBrokerURL(), jmsConfig.getUserName(), jmsConfig.getPassword());
        }
        return instance;
    }
}
```

æµ‹è¯•ä¸€ä¸‹:

```java
@Test
public void test2() throws InterruptedException {

    for (int index = 0; index < 1000; index++) {
        new Thread(new Runnable() {
            public void run() {
                try {
                    JmsProducerEnum instance = JmsProducerEnum.INSTANCE;
                    instance.setJmsConfig(JmsTemplateFacotry.getJmsConfig());
                    log.info("jsmProducer = {}", instance.getInstance());
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }).start();
    }
    Thread.currentThread().join();
}
```

è¾“å‡º:

```
com.xxxx.msearch.core.support.activemq.producer.JmsProducer@6aa6a851
com.xxxx.msearch.core.support.activemq.producer.JmsProducer@6aa6a851
com.xxxx.msearch.core.support.activemq.producer.JmsProducer@6aa6a851
com.xxxx.msearch.core.support.activemq.producer.JmsProducer@6aa6a851
com.xxxx.msearch.core.support.activemq.producer.JmsProducer@6aa6a851
com.xxxx.msearch.core.support.activemq.producer.JmsProducer@6aa6a851
...
```

æœ€ç»ˆçš„ä¿®æ”¹æ–¹æ¡ˆ

```java
public class JmsTemplateFacotry {
	private static JmsProducer jmsProducer;
	private static JmsConsumer jmsConsumer;
	private static JmsConfig jmsConfig;

	static {
		ApplicationContext context = new ClassPathXmlApplicationContext(
				"classpath*:applicationContext-jms.xml");
		jmsConfig =  (JmsConfig) context.getBean("jmsTemplateConfig");

		JmsProducerEnum instance = JmsProducerEnum.INSTANCE;
		instance.setJmsConfig(jmsConfig);
		jmsProducer = instance.getInstance();
	}

    ...
}
```

è¿™é‡Œè¿˜ç”¨äº†åŒé‡ä¿è¯, JVM ä¿è¯ static ä»£ç å—åªæ‰§è¡Œä¸€æ¬¡, æšä¸¾å•ä¾‹å†ä¿è¯å”¯ä¸€å®ä¾‹.

## ä¸ºä»€ä¹ˆä¼šå‡ºç°å¹¶å‘é—®é¢˜

`BiUserStatusTask` ç±»ä¸­çš„åˆå§‹åŒ–ä»£ç 

```java
@Override
public void init() {
    ringAdapter = (RingAdapter) DataCache.getContext().getBean("ringAdapter");
    JmsConfig producerJmsConfig = new JmsConfig();
    producerJmsConfig.setBrokerURL(MQ_URL);
    producerJmsConfig.setUserName(MQ_USER_NAME);
    producerJmsConfig.setPassword(MQ_USER_PASSWORD);
    jmsProducerFactory = new JmsProducerFactory(producerJmsConfig);
    JmsConfig consumerJmsConfig = new JmsConfig();
    consumerJmsConfig.setBrokerURL(MQ_URL);
    JmsConsumerFactory jmsConsumerFactory = new JmsConsumerFactory(consumerJmsConfig);
    jmsConsumerFactory.getJmsConsumer().setQueue(MQ_SIGNAL_NAME);
    jmsConsumerFactory.getJmsConsumer().setQueuePrefetch(Integer.valueOf(QUEUE_SIZE));
    jmsConsumerFactory.getJmsConsumer().setMessageListener(new MultiThreadMessageListener(Integer.parseInt(MQ_THREAD), new MessageHandler() {
        @Override
        public void handle(Message message) {
            try {
                logger.debug("æ‰§è¡Œä»»åŠ¡ï¼š" + taskName + "ä¼‘çœ ï¼");
                Thread.sleep(Integer.parseInt(MQ_SLEEP));
                getUserStatusData(message);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }));
    try {
        jmsConsumerFactory.getJmsConsumer().start();
    } catch (Exception e) {
        logger.error(CommonFunc.getExceptionStack(e));
        LogSupportException.writeFuncExceptionLog(e, "å¼‚æ­¥å·¥å…·", "run-BiUserStatusTask", this.getClass().getSimpleName(), LogSupportException.ErrorLevel.ERROR);
    }
}
```

ç”¨äºæ¥æ”¶ `BiUserStatusSignal` é˜Ÿåˆ—æ¶ˆæ¯çš„æ¶ˆè´¹è€…ä¹Ÿç»´æŠ¤äº†ä¸€ä¸ªçº¿ç¨‹æ± , åœ¨ `MessageListener` é‡Œé¢, å½“æ‹¿åˆ°ä¸€æ‰¹æ¶ˆæ¯å, ä¼šé€šè¿‡**å¤šçº¿ç¨‹**æ¥å¤„ç†,
ä¹Ÿå°±æ˜¯ `getUserStatusData()` æ–¹æ³•, å½“è¿™ä¸ªæ–¹æ³•è¿›å…¥ catch æ—¶, æœ€ç»ˆä¼šé€šè¿‡ `JmsTemplateFacotry` æ¥å‘é€æ¶ˆæ¯, ç„¶ååœ¨å®ä¾‹åŒ– `JmsProducer`
æ—¶æ²¡æœ‰è€ƒè™‘åˆ°å¤šçº¿ç¨‹é—®é¢˜, å¯¼è‡´åˆ›å»ºå¤šä¸ªçº¿ç¨‹æ± .

## å¯é çš„å•å…ƒæµ‹è¯•

`iconmons-mq` è¿™ä¸ªç»„ä»¶åªæµ‹è¯•äº† `JMSProducer` å’Œ `JMSConsumer`, å´æ²¡æœ‰æµ‹è¯•å‡ ä¸ª Factory ç±», è€Œä¸”å•å…ƒæµ‹è¯•åº”è¯¥ä½¿ç”¨ Junit, **ä¸è¦ä½¿ç”¨ main()**,
æ›´ä¸è¦ä½¿ç”¨ `System.out.println`.
å°½é‡åšåˆ°è§„èŒƒåŒ–, å¯æµ‹è¯•åŒ–.

ä¸ºä»€ä¹ˆ `JMSProducer` æµ‹è¯•äº† 100w æ¬¡ä¹Ÿæ²¡é—®é¢˜, å› ä¸ºæ˜¯é€šè¿‡æ‰‹åŠ¨ new çš„æ–¹å¼åˆ›å»º, è€Œä¸”åªæœ‰ä¸€æ¬¡, è¿™æ ·å°±ä¿è¯äº† JMSProducer å•ä¾‹.

æœ€åè¿›è¡Œé›†æˆæµ‹è¯•

![20241229154732_RW96blZf.webp](https://cdn.dong4j.site/source/image/20241229154732_RW96blZf.webp)

æ²¡å†å‡ºç°é”™è¯¯æ—¥å¿—

è¿è¡Œæ—¶æ•°æ®:

![20241229154732_IM7GfOOx.webp](https://cdn.dong4j.site/source/image/20241229154732_IM7GfOOx.webp)

é•¿æ—¶é—´è¿è¡Œ, GC æ¬¡æ•°å°‘, çº¿ç¨‹æ•°ä¿æŒåœ¨ 117.

## é—®é¢˜æ€»ç»“

![20241229154732_bZVrlIir.webp](https://cdn.dong4j.site/source/image/20241229154732_bZVrlIir.webp)

é€šè¿‡è¿™æ¬¡çš„é—®é¢˜ä¿®å¤, æˆ‘ä»¬æ¶‰åŠåˆ°äº†, å¹¶å‘, çº¿ç¨‹æ± , ç±»çš„åˆå§‹åŒ–, ç±»çš„å®ä¾‹åŒ–, Spring å®¹å™¨çš„åˆå§‹åŒ–ç­‰ç›¸å…³çŸ¥è¯†ç‚¹, ä¹Ÿæ¸…æ¥šäº†è¯´æ˜äº†è€ä»£ç ä¸­å­˜åœ¨çš„ä¸€äº›æ¡†æ¶é—®é¢˜.

## å¯¹äº 12530 é‡æ„çš„æƒ³æ³•

ä¸ªäººè§‰å¾—è€æ¡†æ¶ä¸éœ€è¦æ”¹äº†, çœŸæ”¹ä¸åŠ¨äº†, å¦‚æœæ²¡æœ‰æ”¹å®Œæˆ–è€…æ²¡æœ‰ç»è¿‡å¤§é‡çš„æµ‹è¯•, æ˜¯å¾ˆå®¹æ˜“å‡ºç°é—®é¢˜çš„.

ä¸»è¦æ˜¯ä»¥å‰çš„ä»£ç ç»“æ„å¤ªçƒ‚, æ¡†æ¶ç»“æ„ä¹Ÿä¸åˆç†, æœ€é‡è¦çš„æ˜¯ç›¸å…³ä¾èµ–ç®¡ç†å¤ªéšæ„äº†, æ ¹æœ¬å°±æ²¡æœ‰**ç®¡ç†**.å„ç»„ä»¶çš„ç‰ˆæœ¬ç®¡ç†ä¹Ÿä¸è§„èŒƒ, å¯¼è‡´åæœŸç»´æŠ¤æ€§å¤§æ‰“æŠ˜æ‰£.
ç°åœ¨èƒ½åšçš„å°±æ˜¯åœ¨ä¸åŠ¨ä¸»ä½“æ¡†æ¶çš„æƒ…å†µä¸‹, å°½é‡é‡æ„ä»£ç .

å½“ç„¶æˆ‘ä»¬ä¹Ÿåšè¿‡è¿™æ–¹é¢çš„åŠªåŠ›, é‡æ„é¡¹ç›®ä¾èµ–ç®¡ç†, é‡æ„æ—¥å¿—, é‡æ„é…ç½®, é‡æ„ç»„ä»¶, ä½†æ˜¯æ”¹å‡ºæ¥çš„ä¸œè¥¿å´ä¸å°½äººæ„, ç»™å…¶ä»–åŒäº‹é€ æˆäº†å·¥ä½œä¸Šçš„è´Ÿæ‹….
ä¸è¿‡è¿™æ˜¯é‡æ„é˜¶æ®µå¿…é¡»è¦ç»å†çš„æƒ…å†µ.

12530 ä¸šåŠ¡å¤š, ä»£ç å¤š, ç»„ä»¶å¤š, åŸºæœ¬ä¸Šæ˜¯ç‰µä¸€å‘è€ŒåŠ¨å…¨èº«, å› æ­¤åœ¨æ²¡æœ‰å¤§é‡æµ‹è¯•çš„æƒ…å†µä¸‹, å¾ˆéš¾ä¿è¯é‡æ„åçš„æ­£ç¡®æ€§ä¸ç¨³å®šæ€§.

å› æ­¤æŒ‰ç…§æˆ‘çš„å»ºè®®å°±æ˜¯ä¸è¦æ”¹è€ä»£ç äº†, æŠŠä¸šåŠ¡è¿ç§»åˆ° `ms-project` ä¸Šæ¥, è‡³å°‘ä¾èµ–ç®¡ç†, é…ç½®ç®¡ç†, æ—¥å¿—ç®¡ç†è¿™äº›åšçš„æ¯”è€æ¡†æ¶å¥½, ä»£ç ä¹Ÿæ›´è§„èŒƒ.

æ€ä¹ˆé‡æ„ä»£ç ä»¥å‰æˆ–å¤šæˆ–å°‘è¯´è¿‡ä¸€ç‚¹, è¿™é‡Œå†é‡ç”³ä¸€ä¸‹:

**åªè¦æŠŠ IDEA æç¤ºçš„è­¦å‘Šæ”¹å®Œå°±å¯ä»¥äº†**, è¿™ç§é‡æ„æ˜¯å¯¹ä¸šåŠ¡å’Œæµ‹è¯•å½±å“æœ€å°çš„æ–¹å¼. ä»¥å‰ä¹Ÿè¯´è¿‡æ€ä¹ˆé€šè¿‡ä¿®æ”¹è­¦å‘Šæ¥å­¦ä¹ åº•å±‚çš„çŸ¥è¯†, ä¸ºä»€ä¹ˆ IDEA
å¯¹è¿™æ®µä»£ç æå‡ºè­¦å‘Š, æœ‰æ²¡æœ‰æ›´å¥½çš„æ›´è§„èŒƒçš„ä»£ç å®ç°è¿™æ®µé€»è¾‘?

åœ¨å†™ä¸šåŠ¡é€»è¾‘çš„æ—¶å€™æ˜¯ä¸æ˜¯æ²¿ç”¨ä»¥å‰çš„ä»£ç è§„èŒƒå’Œæ€è€ƒé€»è¾‘? ä»¥å‰çš„ä»£ç å°±ä¸€å®šæ­£ç¡®å—? æœ‰æ²¡æœ‰ä¼˜åŒ–çš„ç©ºé—´å‘¢?

ä¸¾ä¸ªä¾‹å­:

åœ¨åšç²¾å‡†è¥é”€çš„æ—¶å€™, å…ˆæŠŠç›¸å…³ä»£ç æ‹ä¸€é, æ¸…æ¥šä¸ªå¤§æ¦‚é€»è¾‘, ä¸éœ€è¦æ·±å…¥çœ‹ä»£ç .

**ç¬¬ä¸€é: æŠŠé‡åˆ°çš„æ‰€æœ‰è­¦å‘Šæç¤ºçœ‹ä¸€é**

```java
Map<String, String> inputStrings = new HashMap<String, String>();
```

è¿™æ®µä»£ç æœ‰é—®é¢˜å—? IDEA å·²ç»ç»™å‡ºäº†æç¤º

1. `new HashMap<String, String>` å¯ä»¥ç®€åŒ–ä¸º `new HashMap<>`;
2. åˆå§‹åŒ– HashMap æ—¶è®¾ç½®åˆå§‹å¤§å°;

å¦‚æœä½ çœ‹åˆ°è¿™ä¸ªæç¤º, ä½ ä¼šä¸ä¼šæƒ³ä¸ºä»€ä¹ˆèƒ½ç®€åŒ–æˆ `new HashMap<>`?
ä¸ºä»€ä¹ˆæœ€å¥½ä¸º HashMap è®¾ç½®åˆå§‹å€¼?

ä½ å°±ä¼šå»æŸ¥èµ„æ–™, å› ä¸º JDK7 çš„æ–°ç‰¹æ€§, å«é’»çŸ³è¯­æ³•, é‚£ä¹ˆä½ è¿˜å¯ä»¥æŸ¥ä¸€ä¸‹ JDK7 å…¶ä»–æ–°çš„è¯­æ³•, çœ‹æ˜¯å¦èƒ½ç”¨åˆ°é¡¹ç›®ä¸­.
ç»™ HashMap è®¾ç½®åˆå§‹å€¼æ˜¯ä¸ºäº†åˆç†åˆ†é…å†…å­˜, å‡å°‘ resize çš„æ¬¡æ•°, ä»è€Œæé«˜æ•ˆç‡.
é‚£ä½ å°±ä¼šå»çœ‹ HashMap æºç , ä½ å°±ä¼šçŸ¥é“:

1. ä»€ä¹ˆæƒ…å†µä¸‹å› resize;
2. resize åçš„å®¹é‡æ˜¯å¤šå°‘;
3. è´Ÿè½½å› å­åˆæ˜¯ä»€ä¹ˆ;
4. ä¸ºä»€ä¹ˆ HashMap ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„;
5. æœ‰æ²¡æœ‰çº¿ç¨‹å®‰å…¨çš„ HashMap, æœ‰å“ªäº›;
6. HashMap çš„å­˜å‚¨æ–¹å¼æ˜¯æ€æ ·çš„; JDK7 å’Œ JDK8 çš„å®ç°æ–¹å¼æœ‰ä»€ä¹ˆä¸åŒ;
7. å¦‚æœ key æ˜¯å¯¹è±¡ä¸ºä»€ä¹ˆè¦é‡å†™ hashCode() å’Œ equals()æ–¹æ³•;
8. ä¸ºä»€ä¹ˆ HashMap ä¸€èˆ¬ä½¿ç”¨ String åš key;
9. ....

ç„¶åå†æ·±å…¥ä¸€äº›:

1. åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹, ä½¿ç”¨ HashMap å­˜åœ¨çš„é—®é¢˜;
2. HashMap ä¸ ConcurrentHashMap çš„åŒºåˆ«; ConcurrentHashMap åˆæ˜¯æ€ä¹ˆå®ç°çš„;
3. èƒ½ä¸èƒ½è¯´å‡º put() çš„é€»è¾‘;
4. æ›´æ·±å…¥çš„äº†è§£ hashCode() çš„ä½œç”¨;
5. è‡ªå·±è®¾è®¡ä¸€ä¸ª hash æ–¹æ³•, å‡å°‘ hash ç¢°æ’;
6. èƒ½é€šè¿‡ä»€ä¹ˆæ–¹å¼æé«˜ HashMap çš„æŸ¥è¯¢æ•ˆç‡;
7. ....

é‚£è¯´åˆ° String, åˆå¯ä»¥å»çœ‹ String çš„æºç äº†, ç„¶åä½ å°±ä¼šæ˜ç™½:

1. ä¸ºä»€ä¹ˆ String æ˜¯ä¸å¯å˜ç±»; è‡ªå·±æ€ä¹ˆè®¾è®¡ä¸€ä¸ªä¸å¯å˜ç±»;
2. ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨å¾ªç¯é‡Œé¢ä¸ä½¿ç”¨ `+` æ¥æ‹¼æ¥å­—ç¬¦ä¸²;
3. ä¸ StringBuffer, StringBuilder çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ;
4. ...

ç„¶åå†æ·±å…¥ä¸€äº›:

1. String çš„åœ¨å†…å­˜ä¸­çš„å­˜å‚¨ä½ç½®;
2. ä» JDK6 å¼€å§‹, æ˜¯æ€ä¹ˆä¼˜åŒ– String çš„;
3. String çš„ä¸å¯å˜æ€§æ˜¯ç»å¯¹çš„å—? å¯ä¸å¯ä»¥ä½¿ç”¨ä¸€äº›æ‰‹æ®µä¿®æ”¹ String;
4. ....

**å°±çœ‹ 1 è¡Œä»£ç , ä½ èƒ½è”æƒ³åˆ°è¿™äº›é—®é¢˜å—?**

ä¸æ˜¯è¯´åªå†™ä¸šåŠ¡ä»£ç å°±ä¸èƒ½å­¦åˆ°ä¸œè¥¿, å­¦ä¸œè¥¿åœ¨å“ªå„¿éƒ½å¯ä»¥å­¦åˆ°, åªè¦æœ‰è¿™ä¸ªå¿ƒå°±è¡Œ.

å…ˆæŠŠåŸºç¡€çŸ¥è¯†å­¦å¥½äº†, æ¡†æ¶è¿™äº›éƒ½æ˜¯é”¦ä¸Šæ·»èŠ±çš„äº‹.

**ç¬¬äºŒé: æŠŠä»£ç ç»“æ„æ¢³ç†ä¸€é**

ç®€å•çš„é‡æ„ä»ç¬¬äºŒéå¼€å§‹, ä¸€ä¸ªæ–¹æ³•è¶…è¿‡ **80** è¡Œ, å°±è¯¥æ‹†åˆ†äº†.

1. æœ‰æ²¡æœ‰ä»£ç æ˜¯å…±ç”¨çš„?
2. èƒ½ä¸èƒ½æŠ½ç¦»æˆå·¥å…·ç±»?
3. æ³¨é‡Šå†™å¥½äº†å—?
4. ä»£ç é€»è¾‘æ¸…æ™°äº†å—?
5. æ³¨é‡Šæ‰çš„ä»£ç åˆ æ²¡åˆ ? ç•™ç€å¹²å˜›? ç®—ä»£ç è¡Œæ•°? æˆ‘ä»¬æœ‰ç‰ˆæœ¬ç®¡ç†, ä¸è¦çš„è¯·ç›´æ¥åˆ é™¤.
6. å­—æ®µå, æ–¹æ³•åå‘½åè§„èŒƒå—?
7. æœ‰é­”æ³•å€¼å—?
8. tay-catch åˆç†åŒ…è£¹åˆç†å—? å¼‚å¸¸å¤„ç†æ–¹å¼åˆç†å—? æœ‰æ²¡å¤„ç†åˆ°çš„å¼‚å¸¸å—?
9. å¿…è¦çš„æ—¥å¿—æ‰“å°äº†å—? æ—¥å¿—ç­‰çº§è®¾ç½®åˆç†å—?
10. é‡è½½çš„æ–¹æ³•å†™ `@Override` æ³¨é‡Šäº†å—?
11. æ–¹æ³•çš„è®¿é—®ä¿®é¥°ç¬¦åˆç†å—? è¿”å›å€¼åˆç†å—? å…¥å‚åˆç†å—?
12. switch case åˆ°äº†å…¨éƒ¨æƒ…å†µå—?
13. if åˆ¤æ–­åˆç†å—?
14. return çš„åœ°æ–¹åˆç†å—?
15. ...

æŠŠä½ çœ‹åˆ°çš„ä¸åˆç†çš„åœ°æ–¹å…¨éƒ¨é‡æ„äº†, è¿™ä¸€æ­¥ä¹Ÿå…¨éƒ¨æ˜¯å€ŸåŠ© IDEA å¼ºå¤§çš„é‡æ„åŠŸèƒ½, æ¯”å¦‚é€‰ä¸­ä½ æƒ³æŠ½ç¦»ä¸ºæ–¹æ³•çš„ä»£ç , `ctl + shift + m` (windows çš„å¿«æ·é”®ä¸æ¸…æ¥š,
å¥½åƒæ˜¯è¿™ä¸ª)è‡ªåŠ¨é‡æ„, åªéœ€è¦å‘½åå°±å¯ä»¥äº†

![20241229154732_7VgzmY90.webp](https://cdn.dong4j.site/source/image/20241229154732_7VgzmY90.webp)

å…¶ä»–çš„é‡æ„å¿«æ·é”®å’ŒåŠŸèƒ½è‡ªå·±å»äº†è§£å’Œä½¿ç”¨.

**æŠŠåƒé¥­çš„å·¥å…·ä½¿ç”¨ç†Ÿç»ƒæ˜¯æœ€åŸºæœ¬çš„è¦æ±‚**, ç„¶åå°±æ˜¯æ•ˆç‡é—®é¢˜, **èƒ½è‡ªåŠ¨åŒ–ç»ä¸æ‰‹åŠ¨, èƒ½èŠ‚çº¦ 1 ç§’ æ—¶é—´çš„äº‹, æˆ‘å®æ„¿è¯ 1 ä¸ªå°æ—¶æ¥å­¦ä¹ .**

ç°åœ¨ä½¿ç”¨çš„å·¥å…·æœ‰æ²¡æœ‰æ›´å¥½çš„å·¥å…·å¯ä»¥æ›¿ä»£? æœ‰æ²¡æœ‰å»äº†è§£è¿‡åŒç±»å·¥å…·?
è¯·è®°ä½, **å·¥å…·å°±æ˜¯ä½ çš„å…µå™¨**, ä¸€æŠŠè¶æ‰‹çš„å…µå™¨æ¯”æ‰‹æ— å¯¸é“å¥½å¾—å¤š

**ç¬¬ä¸‰é: æ¢³ç†ä¸šåŠ¡é€»è¾‘**

è¿™ä¸€éå°±å¯ä»¥å¼€å§‹å¼€å‘ä¸šåŠ¡äº†.
äº†è§£éœ€æ±‚, å…ˆæƒ³æ€ä¹ˆå†™, ä¸è¦ä¸€ä¸Šæ¥å°±å¼€å§‹å†™ä»£ç , æƒ³ä¸€ä¸ªæ–¹æ¡ˆå‡ºæ¥, ç›¸å…³çš„å•å…ƒæµ‹è¯•å†™å‡ºæ¥, å†æƒ³æƒ³:

1. è¿˜æœ‰æ²¡æœ‰æ›´å¥½çš„å®ç°æ–¹å¼?
2. ä»¥å‰çš„ä»£ç å­˜åœ¨çš„é—®é¢˜?
3. ä»¥å‰çš„é€»è¾‘è¿˜èƒ½æ€æ ·ä¼˜åŒ–?
4. ä»¥å‰çš„æ¥å£å®šä¹‰åˆç†å—?
5. èƒ½ä¸èƒ½è¿ç”¨åˆ°è®¾è®¡æ¨¡å¼æŠŠä¸šåŠ¡æŠ½ç¦»å‡ºæ¥? æé«˜ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§?
6. ....

è¿™éƒ¨åˆ†æ²¡æœ‰å¤ªå¤šè¯è¯­æƒ, æ¯•ç«Ÿåšçš„å°‘. ä¸¾ä¸ªä¾‹å­å§:

![20241229154732_Ow8tJ5Na.webp](https://cdn.dong4j.site/source/image/20241229154732_Ow8tJ5Na.webp)

ä¸æ˜¯ä»£ç å†™å¾—è¶Šå¤šå°±è¶Šå¥½, ä¸æ˜¯æ–¹æ³•è¶Šå¤šä»£ç ç»“æ„å°±æ¸…æ™°.

![20241229154732_amOis5Tf.webp](https://cdn.dong4j.site/source/image/20241229154732_amOis5Tf.webp)

ä¸è¦æŒ‰ç…§ä»¥å‰è€çš„æ€è·¯æ¥å†™ä»£ç , è¦æœ‰è‡ªå·±çš„æ€è€ƒ.
ä»¥å‰çš„é€»è¾‘åˆç†å—? æ¥å£è§„èŒƒåˆç†å—? è¿”å›ç»“æœåˆç†å—?

![20241229154732_Jqtt2ttF.webp](https://cdn.dong4j.site/source/image/20241229154732_Jqtt2ttF.webp)

ä¸šåŠ¡ç«¯ä¼ å…¥ servicedId æ¥æŸ¥æŒ‡å®šçš„ä¸šåŠ¡çš„è®¢è´­çŠ¶æ€, ä¸ºä»€ä¹ˆè¿˜è¦é€šè¿‡æ¥å£çš„ serviceId è¿”å›ç±»å‹æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯æŸ¥è¯¢çš„å½“å‰ä¸šåŠ¡? éš¾é“æˆ‘æŸ¥è¯¢çš„ä»€ä¹ˆä¸šåŠ¡è¿˜è¦é€šè¿‡æ¥å£æ¥å‘Šè¯‰æˆ‘å—?

é‚£ä¼ ä¸ª serviceId è¿˜æœ‰ä»€ä¹ˆæ„ä¹‰?

å½“ç„¶è¿™é‡Œä¹Ÿæœ‰å†å²åŸå› , æˆ–è€…éƒ½å¯ä»¥è¯´å…¨éƒ¨æ˜¯å†å²åŸå› , ä½†æ˜¯æˆ‘ä»¬ç°åœ¨å¯ä»¥æ”¹å˜, å¯ä»¥é‡æ„, ä¸ºäº†æ›´å¥½çš„å°†æ¥, ä¸ºäº†ä¸‹ä¸€æ‰¹ç»´æŠ¤è€…å°‘æ‰å‘é‡Œé¢, è¿™äº›éƒ½å¯ä»¥æ”¹....

å†™å¾—ä»£ç ä¸æ˜¯**èƒ½è·‘é€š**å°±å¯ä»¥äº†(ã€Œåˆä¸æ˜¯ä¸èƒ½è·‘ã€ ğŸ˜³), éœ€è¦æ€è€ƒå’Œåæ€.

æœ€åå¤šå›é¡¾è‡ªå·±çš„ä»£ç , éšç€è‡ªå·±çŸ¥è¯†é¢çš„æ‰©å±•, çŸ¥è¯†ç‚¹çš„åŠ æ·±, å†çœ‹çœ‹ä»¥å‰çš„ä»£ç æ˜¯ä¸æ˜¯åˆæœ‰æ›´å¥½çš„å®ç°æ–¹å¼, å†æ¬¡é‡æ„å•Š.

## [Mac mini å¼€å‘ç¯å¢ƒæ­å»ºå…¨æ”»ç•¥](https://blog.dong4j.site/posts/345a28fd.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

è®°å½• mac mini å¼€å‘ç¯å¢ƒçš„æ­å»ºè¿‡ç¨‹

<!-- more -->

## ç³»ç»Ÿè®¾ç½®

### ä¿®æ”¹ Launchpad å›¾æ ‡å¤§å°

```
è¡Œ:
defaults write com.apple.dock.springboard-rows -int 7

åˆ—:
defaults write com.apple.dock.springboard-columns -int 9

é‡å¯ dock

æ¢å¤:
defaults write com.apple.dock.springboard-rows default
defaults write com.apple.dock.springboard-columns default
killall dock

defaults write com.apple.dock springboard-columns -int 11;defaults write com.apple.dock springboard-rows -int 7;defaults write com.apple.dock ResetLaunchPad -bool TRUE;killall Dock
```

### xxx.app å·²æŸå, æ‰“ä¸å¼€. ä½ åº”è¯¥å°†å®ƒç§»åˆ°åºŸçº¸ç¯“

```
sudo spctl --master-disable
```

### Mac ä¸‰æŒ‡æ‹–åŠ¨è®¾ç½®

1. æ‰¾åˆ°ç³»ç»Ÿåå¥½è®¾ç½® ä¸­çš„è¾…åŠ©åŠŸèƒ½

2. é€‰ä¸­é¼ æ ‡å’Œæ§åˆ¶æ¿ -> è§¦æ§æ¿é€‰é¡¹

3. å‹¾é€‰å¯ç”¨æ‹–ç§» -> å¥½

è®¾ç½®ä»¥ä¸Šæ­¥éª¤å°±å¯ä»¥ç”¨ä¸‰æŒ‡è‡ªç”±æ‹–åŠ¨çª—å£äº†.

## JDK

## ssh

## brew

```
/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
```

## zsh

## oh-my-zsh

## IDEA

## Docker

## surge

```
brew install libfaketime
```

```
FAKETIME_STOP_AFTER_SECONDS=30 faketime '2007-01-01 00:00:00' /Applications/Surge.app/Contents/MacOS/Surge &

export https_proxy=http://127.0.0.1:6152;export http_proxy=http://127.0.0.1:6152;export all_proxy=socks5://127.0.0.1:6153
```

## å®‰è£… code å‘½ä»¤

åœ¨ vscode ä¸‹é€šè¿‡å¿«æ·é”® shift + command + p è¿è¡Œå‘½ä»¤ shell code

## å®‰è£… zsh-syntax-highlighting è¯­æ³•é«˜äº®æ’ä»¶

å®‰è£… zsh-syntax-highlighting è¯­æ³•é«˜äº®æ’ä»¶

å®˜ç½‘: [https://github.com/zsh-users/zsh-syntax-highlighting](https://github.com/zsh-users/zsh-syntax-highlighting)

å®‰è£…:

```
git clone https://github.com/zsh-users/zsh-syntax-highlighting.git
echo "source ${(q-)PWD}/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" >> ${ZDOTDIR:-$HOME}/.zshrc
```

ç”Ÿæ•ˆ:

```
source ~/.zshrc
```

## å®‰è£… Powerlevel9k --- ä¸€ä¸ªç¾è§‚è€Œåˆå®ç”¨çš„ ZSH ä¸»é¢˜

[https://www.jianshu.com/p/f84cf6132d1e](https://www.jianshu.com/p/f84cf6132d1e)

[https://mp.weixin.qq.com/s/tWrxxrRyKAGohJfq8LUAGQ](https://mp.weixin.qq.com/s/tWrxxrRyKAGohJfq8LUAGQ)

```
git clone https://github.com/bhilburn/powerlevel9k.git ~/.oh-my-zsh/custom/themes/powerlevel9k
```

```
ZSH_THEME="powerlevel9k/powerlevel9k"
```

å®‰è£…å­—ä½“

```
# clone
git clone https://github.com/powerline/fonts.git
# install
cd fonts
./install.sh
# clean-up a bit
cd ..
rm -rf fonts
```

## å¯¼å‡º iterm é…ç½®

[https://www.jianshu.com/p/c251d26374c5](https://www.jianshu.com/p/c251d26374c5)

## è‡ªåŠ¨æç¤ºæ’ä»¶

zsh-autosuggestions

## [Java å¸¸ç”¨å››å¤§çº¿ç¨‹æ± ç”¨æ³•ä»¥åŠ ThreadPoolExecutor è¯¦è§£](https://blog.dong4j.site/posts/3b7cca00.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

ä¸ºä»€ä¹ˆç”¨çº¿ç¨‹æ± 

1. åˆ›å»º / é”€æ¯çº¿ç¨‹ä¼´éšç€ç³»ç»Ÿå¼€é”€, è¿‡äºé¢‘ç¹çš„åˆ›å»º / é”€æ¯çº¿ç¨‹, ä¼šå¾ˆå¤§ç¨‹åº¦ä¸Šå½±å“å¤„ - ç†æ•ˆç‡
2. çº¿ç¨‹å¹¶å‘æ•°é‡è¿‡å¤š, æŠ¢å ç³»ç»Ÿèµ„æºä»è€Œå¯¼è‡´é˜»å¡
3. å¯¹çº¿ç¨‹è¿›è¡Œä¸€äº›ç®€å•çš„ç®¡ç†

<!-- more-->

åœ¨ Java ä¸­, çº¿ç¨‹æ± çš„æ¦‚å¿µæ˜¯ Executor è¿™ä¸ªæ¥å£, å…·ä½“å®ç°ä¸º ThreadPoolExecutor ç±», å­¦ä¹  Java ä¸­çš„çº¿ç¨‹æ± , å°±å¯ä»¥ç›´æ¥å­¦ä¹ ä»–äº†å¯¹çº¿ç¨‹æ± çš„é…ç½®, å°±æ˜¯å¯¹
ThreadPoolExecutor æ„é€ å‡½æ•°çš„å‚æ•°çš„é…ç½®

## æ„é€ å‡½æ•°:

```java
// äº”ä¸ªå‚æ•°çš„æ„é€ å‡½æ•°
public ThreadPoolExecutor(int corePoolSize,
                          int maximumPoolSize,
                          long keepAliveTime,
                          TimeUnit unit,
                          BlockingQueue<Runnable> workQueue)

// å…­ä¸ªå‚æ•°çš„æ„é€ å‡½æ•° -1
public ThreadPoolExecutor(int corePoolSize,
                          int maximumPoolSize,
                          long keepAliveTime,
                          TimeUnit unit,
                          BlockingQueue<Runnable> workQueue,
                          ThreadFactory threadFactory)

// å…­ä¸ªå‚æ•°çš„æ„é€ å‡½æ•° -2
public ThreadPoolExecutor(int corePoolSize,
                          int maximumPoolSize,
                          long keepAliveTime,
                          TimeUnit unit,
                          BlockingQueue<Runnable> workQueue,
                          RejectedExecutionHandler handler)

// ä¸ƒä¸ªå‚æ•°çš„æ„é€ å‡½æ•°
public ThreadPoolExecutor(int corePoolSize,
                          int maximumPoolSize,
                          long keepAliveTime,
                          TimeUnit unit,
                          BlockingQueue<Runnable> workQueue,
                          ThreadFactory threadFactory,
                          RejectedExecutionHandler handler)

```

ä¸‹é¢æ¥è§£é‡Šä¸‹å„ä¸ªå‚æ•°:

- **int corePoolSize**: è¯¥çº¿ç¨‹æ± ä¸­ **æ ¸å¿ƒçº¿ç¨‹æ•°æœ€å¤§å€¼**

**æ ¸å¿ƒçº¿ç¨‹**: çº¿ç¨‹æ± æ–°å»ºçº¿ç¨‹çš„æ—¶å€™, å¦‚æœå½“å‰çº¿ç¨‹æ€»æ•°å°äº corePoolSize, åˆ™æ–°å»ºçš„æ˜¯æ ¸å¿ƒçº¿ç¨‹, å¦‚æœè¶…è¿‡ corePoolSize,
åˆ™æ–°å»ºçš„æ˜¯éæ ¸å¿ƒçº¿ç¨‹æ ¸å¿ƒçº¿ç¨‹é»˜è®¤æƒ…å†µä¸‹ä¼šä¸€ç›´å­˜æ´»åœ¨çº¿ç¨‹æ± ä¸­, å³ä½¿è¿™ä¸ªæ ¸å¿ƒçº¿ç¨‹å•¥ä¹Ÿä¸å¹² (é—²ç½®çŠ¶æ€).

å¦‚æœæŒ‡å®š ThreadPoolExecutor çš„ allowCoreThreadTimeOut è¿™ä¸ªå±æ€§ä¸º true, é‚£ä¹ˆæ ¸å¿ƒçº¿ç¨‹å¦‚æœä¸å¹²æ´» (é—²ç½®çŠ¶æ€) çš„è¯, è¶…è¿‡ä¸€å®šæ—¶é—´(
æ—¶é•¿ä¸‹é¢å‚æ•°å†³å®š), å°±ä¼šè¢«é”€æ¯æ‰.

- **int maximumPoolSize**: è¯¥çº¿ç¨‹æ± ä¸­ **çº¿ç¨‹æ€»æ•°æœ€å¤§å€¼**

çº¿ç¨‹æ€»æ•° = æ ¸å¿ƒçº¿ç¨‹æ•° + éæ ¸å¿ƒçº¿ç¨‹æ•°.

- **long keepAliveTime**: è¯¥çº¿ç¨‹æ± ä¸­ **éæ ¸å¿ƒçº¿ç¨‹é—²ç½®è¶…æ—¶æ—¶é•¿**

ä¸€ä¸ªéæ ¸å¿ƒçº¿ç¨‹, å¦‚æœä¸å¹²æ´» (é—²ç½®çŠ¶æ€) çš„æ—¶é•¿è¶…è¿‡è¿™ä¸ªå‚æ•°æ‰€è®¾å®šçš„æ—¶é•¿, å°±ä¼šè¢«é”€æ¯æ‰, å¦‚æœè®¾ç½® allowCoreThreadTimeOut = true, åˆ™ä¼šä½œç”¨äºæ ¸å¿ƒçº¿ç¨‹.

- **TimeUnit unit**: keepAliveTime çš„å•ä½

TimeUnit æ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹, å…¶åŒ…æ‹¬:
NANOSECONDS : 1 å¾®æ¯«ç§’ = 1 å¾®ç§’ / 1000
MICROSECONDS : 1 å¾®ç§’ = 1 æ¯«ç§’ / 1000
MILLISECONDS : 1 æ¯«ç§’ = 1 ç§’ /1000
SECONDS : ç§’
MINUTES : åˆ†
HOURS : å°æ—¶
DAYS : å¤©

- **BlockingQueue workQueue**: è¯¥çº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡é˜Ÿåˆ—: ç»´æŠ¤ç€ç­‰å¾…æ‰§è¡Œçš„ Runnable å¯¹è±¡

å½“æ‰€æœ‰çš„æ ¸å¿ƒçº¿ç¨‹éƒ½åœ¨å¹²æ´»æ—¶, æ–°æ·»åŠ çš„ä»»åŠ¡ä¼šè¢«æ·»åŠ åˆ°è¿™ä¸ªé˜Ÿåˆ—ä¸­ç­‰å¾…å¤„ç†, å¦‚æœé˜Ÿåˆ—æ»¡äº†, åˆ™æ–°å»ºéæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œä»»åŠ¡.

å¸¸ç”¨çš„ workQueue ç±»å‹:

- **SynchronousQueue**: è¿™ä¸ªé˜Ÿåˆ—æ¥æ”¶åˆ°ä»»åŠ¡çš„æ—¶å€™, ä¼šç›´æ¥æäº¤ç»™çº¿ç¨‹å¤„ç†, è€Œä¸ä¿ç•™å®ƒ, å¦‚æœæ‰€æœ‰çº¿ç¨‹éƒ½åœ¨å·¥ä½œæ€ä¹ˆåŠï¼Ÿé‚£å°±æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†è¿™ä¸ªä»»åŠ¡ï¼æ‰€ä»¥ä¸ºäº†ä¿è¯ä¸å‡ºç°çš„é”™è¯¯,
  ä½¿ç”¨è¿™ä¸ªç±»å‹é˜Ÿåˆ—çš„æ—¶å€™, maximumPoolSize ä¸€èˆ¬æŒ‡å®šæˆ Integer.MAX_VALUE, å³æ— é™å¤§
- **LinkedBlockingQueue**: è¿™ä¸ªé˜Ÿåˆ—æ¥æ”¶åˆ°ä»»åŠ¡çš„æ—¶å€™, å¦‚æœå½“å‰çº¿ç¨‹æ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ•°, åˆ™æ–°å»ºçº¿ç¨‹ (æ ¸å¿ƒçº¿ç¨‹) å¤„ç†ä»»åŠ¡ï¼›å¦‚æœå½“å‰çº¿ç¨‹æ•°ç­‰äºæ ¸å¿ƒçº¿ç¨‹æ•°,
  åˆ™è¿›å…¥é˜Ÿåˆ—ç­‰å¾…. ç”±äºè¿™ä¸ªé˜Ÿåˆ—æ²¡æœ‰æœ€å¤§å€¼é™åˆ¶, å³æ‰€æœ‰è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°çš„ä»»åŠ¡éƒ½å°†è¢«æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­, è¿™ä¹Ÿå°±å¯¼è‡´äº† maximumPoolSize çš„è®¾å®šå¤±æ•ˆ,
  å› ä¸ºæ€»çº¿ç¨‹æ•°æ°¸è¿œä¸ä¼šè¶…è¿‡ corePoolSize
- **ArrayBlockingQueue**: å¯ä»¥é™å®šé˜Ÿåˆ—çš„é•¿åº¦, æ¥æ”¶åˆ°ä»»åŠ¡çš„æ—¶å€™, å¦‚æœæ²¡æœ‰è¾¾åˆ° corePoolSize çš„å€¼, åˆ™æ–°å»ºçº¿ç¨‹ (æ ¸å¿ƒçº¿ç¨‹) æ‰§è¡Œä»»åŠ¡, å¦‚æœè¾¾åˆ°äº†,
  åˆ™å…¥é˜Ÿç­‰å€™, å¦‚æœé˜Ÿåˆ—å·²æ»¡, åˆ™æ–°å»ºçº¿ç¨‹ (éæ ¸å¿ƒçº¿ç¨‹) æ‰§è¡Œä»»åŠ¡, åˆå¦‚æœæ€»çº¿ç¨‹æ•°åˆ°äº† maximumPoolSize, å¹¶ä¸”é˜Ÿåˆ—ä¹Ÿæ»¡äº†, åˆ™å‘ç”Ÿé”™è¯¯
- **DelayQueue**: é˜Ÿåˆ—å†…å…ƒç´ å¿…é¡»å®ç° Delayed æ¥å£, è¿™å°±æ„å‘³ç€ä½ ä¼ è¿›å»çš„ä»»åŠ¡å¿…é¡»å…ˆå®ç° Delayed æ¥å£. è¿™ä¸ªé˜Ÿåˆ—æ¥æ”¶åˆ°ä»»åŠ¡æ—¶, é¦–å…ˆå…ˆå…¥é˜Ÿ,
  åªæœ‰è¾¾åˆ°äº†æŒ‡å®šçš„å»¶æ—¶æ—¶é—´, æ‰ä¼šæ‰§è¡Œä»»åŠ¡
- **ThreadFactory threadFactory**: åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼, è¿™æ˜¯ä¸€ä¸ªæ¥å£, ä½  new ä»–çš„æ—¶å€™éœ€è¦å®ç°ä»–çš„ Thread newThread(Runnable r) æ–¹æ³•, ä¸€èˆ¬ç”¨ä¸ä¸Š.
- **RejectedExecutionHandler handler**: è¿™ç©æ„å„¿å°±æ˜¯æŠ›å‡ºå¼‚å¸¸ä¸“ç”¨çš„, æ¯”å¦‚ä¸Šé¢æåˆ°çš„ä¸¤ä¸ªé”™è¯¯å‘ç”Ÿäº†, å°±ä¼šç”±è¿™ä¸ª handler æŠ›å‡ºå¼‚å¸¸, æ ¹æœ¬ç”¨ä¸ä¸Š.

## å‘ ThreadPoolExecutor æ·»åŠ ä»»åŠ¡

æˆ‘ä»¬æ€ä¹ˆçŸ¥é“ new ä¸€ä¸ª ThreadPoolExecutor, å¤§æ¦‚çŸ¥é“å„ä¸ªå‚æ•°æ˜¯å¹²å˜›çš„, å¯æ˜¯æˆ‘ new å®Œäº†, æ€ä¹ˆå‘çº¿ç¨‹æ± æäº¤ä¸€ä¸ªè¦æ‰§è¡Œçš„ä»»åŠ¡å•Šï¼Ÿ

```java
ThreadPoolExecutor.execute(Runnable command)

```

é€šè¿‡ ThreadPoolExecutor.execute(Runnable command) æ–¹æ³•å³å¯å‘çº¿ç¨‹æ± å†…æ·»åŠ ä¸€ä¸ªä»»åŠ¡.

## ThreadPoolExecutor çš„ç­–ç•¥

è¿™é‡Œç»™æ€»ç»“ä¸€ä¸‹, å½“ä¸€ä¸ªä»»åŠ¡è¢«æ·»åŠ è¿›çº¿ç¨‹æ± æ—¶, æ‰§è¡Œç­–ç•¥:

- 1. çº¿ç¨‹æ•°é‡æœªè¾¾åˆ° corePoolSize, åˆ™æ–°å»ºä¸€ä¸ªçº¿ç¨‹ (æ ¸å¿ƒçº¿ç¨‹) æ‰§è¡Œä»»åŠ¡
- 2. çº¿ç¨‹æ•°é‡è¾¾åˆ°äº† corePools, åˆ™å°†ä»»åŠ¡ç§»å…¥é˜Ÿåˆ—ç­‰å¾…
- 3. é˜Ÿåˆ—å·²æ»¡, æ–°å»ºçº¿ç¨‹ (éæ ¸å¿ƒçº¿ç¨‹) æ‰§è¡Œä»»åŠ¡
- 4. é˜Ÿåˆ—å·²æ»¡, æ€»çº¿ç¨‹æ•°åˆè¾¾åˆ°äº† maximumPoolSize, å°±ä¼šç”± (RejectedExecutionHandler) æŠ›å‡ºå¼‚å¸¸

## å¸¸è§å››ç§çº¿ç¨‹æ± :

å¦‚æœä½ ä¸æƒ³è‡ªå·±å†™ä¸€ä¸ªçº¿ç¨‹æ± , Java é€šè¿‡ Executors æä¾›äº†å››ç§çº¿ç¨‹æ± , è¿™å››ç§çº¿ç¨‹æ± éƒ½æ˜¯ç›´æ¥æˆ–é—´æ¥é…ç½® ThreadPoolExecutor çš„å‚æ•°å®ç°çš„.

### 1. å¯ç¼“å­˜çº¿ç¨‹æ±  CachedThreadPool()

æºç :

```java
public static ExecutorService newCachedThreadPool() {
        return new ThreadPoolExecutor(0, Integer.MAX_VALUE,
                                      60L, TimeUnit.SECONDS,
                                      new SynchronousQueue<Runnable>());
    }

```

æ ¹æ®æºç å¯ä»¥çœ‹å‡º:

1. è¿™ç§çº¿ç¨‹æ± å†…éƒ¨æ²¡æœ‰æ ¸å¿ƒçº¿ç¨‹, çº¿ç¨‹çš„æ•°é‡æ˜¯æœ‰æ²¡é™åˆ¶çš„.
2. åœ¨åˆ›å»ºä»»åŠ¡æ—¶, è‹¥æœ‰ç©ºé—²çš„çº¿ç¨‹æ—¶åˆ™å¤ç”¨ç©ºé—²çš„çº¿ç¨‹, è‹¥æ²¡æœ‰åˆ™æ–°å»ºçº¿ç¨‹.
3. æ²¡æœ‰å·¥ä½œçš„çº¿ç¨‹ï¼ˆé—²ç½®çŠ¶æ€ï¼‰åœ¨è¶…è¿‡äº† 60S è¿˜ä¸åšäº‹, å°±ä¼šé”€æ¯.

åˆ›å»ºæ–¹æ³•:

```java
ExecutorService mCachedThreadPool = Executors.newCachedThreadPool();

```

ç”¨æ³•:

```java
// å¼€å§‹ä¸‹è½½
private void startDownload(final ProgressBar progressBar, final int i) {
        mCachedThreadPool.execute(new Runnable() {
            @Override
            public void run() {
                int p = 0;
                progressBar.setMax(10);// æ¯ä¸ªä¸‹è½½ä»»åŠ¡ 10 ç§’
                while (p < 10) {
                    p++;
                    progressBar.setProgress(p);
                    Bundle bundle = new Bundle();
                    Message message = new Message();
                    bundle.putInt("p", p);
                    // æŠŠå½“å‰çº¿ç¨‹çš„åå­—ç”¨ handler è®© textview æ˜¾ç¤ºå‡ºæ¥
                    bundle.putString("ThreadName", Thread.currentThread().getName());
                    message.what = i;
                    message.setData(bundle);
                    mHandler.sendMessage(message);
                    try {
                        Thread.sleep(1000);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
            }
        });
    }

```

### 2.FixedThreadPool å®šé•¿çº¿ç¨‹æ± 

æºç :

```java
public static ExecutorService newFixedThreadPool(int nThreads) {
    return new ThreadPoolExecutor(nThreads, nThreads,
                                  0L, TimeUnit.MILLISECONDS,
                                  new LinkedBlockingQueue<Runnable>());
}

```

æ ¹æ®æºç å¯ä»¥çœ‹å‡º:

1. è¯¥çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°ç­‰äºæ ¸å¿ƒçº¿ç¨‹æ•°, æ‰€ä»¥åœ¨é»˜è®¤æƒ…å†µä¸‹, è¯¥çº¿ç¨‹æ± çš„çº¿ç¨‹ä¸ä¼šå› ä¸ºé—²ç½®çŠ¶æ€è¶…æ—¶è€Œè¢«é”€æ¯.
2. å¦‚æœå½“å‰çº¿ç¨‹æ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ•°, å¹¶ä¸”ä¹Ÿæœ‰é—²ç½®çº¿ç¨‹çš„æ—¶å€™æäº¤äº†ä»»åŠ¡, è¿™æ—¶ä¹Ÿä¸ä¼šå»å¤ç”¨ä¹‹å‰çš„é—²ç½®çº¿ç¨‹, ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡.
   å¦‚æœå½“å‰æ‰§è¡Œä»»åŠ¡æ•°å¤§äºäº†æ ¸å¿ƒçº¿ç¨‹æ•°, å¤§äºçš„éƒ¨åˆ†å°±ä¼šè¿›å…¥é˜Ÿåˆ—ç­‰å¾…. ç­‰ç€æœ‰é—²ç½®çš„çº¿ç¨‹æ¥æ‰§è¡Œè¿™ä¸ªä»»åŠ¡.

åˆ›å»ºæ–¹æ³•:

```java
// nThreads => æœ€å¤§çº¿ç¨‹æ•°å³ maximumPoolSize
ExecutorService mFixedThreadPool= Executors.newFixedThreadPool(int nThreads);

// threadFactory => åˆ›å»ºçº¿ç¨‹çš„æ–¹æ³•, ç”¨å¾—å°‘
ExecutorService mFixedThreadPool= Executors.newFixedThreadPool(int nThreads, ThreadFactory threadFactory);

```

ç”¨æ³•:

```java
private void startDownload(final ProgressBar progressBar, final int i) {
        mFixedThreadPool.execute(new Runnable() {
            @Override
            public void run() {
               // .... é€»è¾‘ä»£ç è‡ªå·±æ§åˆ¶
            }
        });
    }

```

### 3.SingleThreadPool

æºç :

```java
public static ExecutorService newSingleThreadExecutor() {
    return new FinalizableDelegatedExecutorService
        (new ThreadPoolExecutor(1, 1,
                                0L, TimeUnit.MILLISECONDS,
                                new LinkedBlockingQueue<Runnable>()));
}

```

æ ¹æ®æºç å¯ä»¥çœ‹å‡º:

1. æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ‰§è¡Œä»»åŠ¡
2. æ‰€æœ‰ä»»åŠ¡æŒ‰ç…§æŒ‡å®šé¡ºåºæ‰§è¡Œ, å³éµå¾ªé˜Ÿåˆ—çš„å…¥é˜Ÿå‡ºé˜Ÿè§„åˆ™

åˆ›å»ºæ–¹æ³•:
ExecutorService mSingleThreadPool = Executors.newSingleThreadPool();

ç”¨æ³•åŒä¸Š.

### 4.ScheduledThreadPool

æºç :

```java
public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize) {
    return new ScheduledThreadPoolExecutor(corePoolSize);
}

// ScheduledThreadPoolExecutor():
public ScheduledThreadPoolExecutor(int corePoolSize) {
    super(corePoolSize, Integer.MAX_VALUE,
          DEFAULT_KEEPALIVE_MILLIS, MILLISECONDS,
          new DelayedWorkQueue());
}

```

æ ¹æ®æºç å¯ä»¥çœ‹å‡º:
DEFAULT_KEEPALIVE_MILLIS å°±æ˜¯é»˜è®¤ 10L, è¿™é‡Œå°±æ˜¯ 10 ç§’. è¿™ä¸ªçº¿ç¨‹æ± æœ‰ç‚¹åƒæ˜¯å§ CachedThreadPool å’Œ FixedThreadPool ç»“åˆäº†ä¸€ä¸‹.

1. ä¸ä»…è®¾ç½®äº†æ ¸å¿ƒçº¿ç¨‹æ•°, æœ€å¤§çº¿ç¨‹æ•°ä¹Ÿæ˜¯ Integer.MAX_VALUE.
2. è¿™ä¸ªçº¿ç¨‹æ± æ˜¯ä¸Šè¿° 4 ä¸ªä¸­ä¸ºå”¯ä¸€ä¸ªæœ‰å»¶è¿Ÿæ‰§è¡Œå’Œå‘¨æœŸæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± .

åˆ›å»º:

```java
// nThreads => æœ€å¤§çº¿ç¨‹æ•°å³ maximumPoolSize
ExecutorService mScheduledThreadPool = Executors.newScheduledThreadPool(int corePoolSize);

```

ä¸€èˆ¬çš„æ‰§è¡Œä»»åŠ¡æ–¹æ³•å’Œä¸Šé¢çš„éƒ½å¤§åŒå°å¼‚, æˆ‘ä»¬ä¸»è¦çœ‹çœ‹å»¶æ—¶æ‰§è¡Œä»»åŠ¡å’Œå‘¨æœŸæ‰§è¡Œä»»åŠ¡çš„æ–¹æ³•.

```java
// è¡¨ç¤ºåœ¨ 3 ç§’ä¹‹åå¼€å§‹æ‰§è¡Œæˆ‘ä»¬çš„ä»»åŠ¡.
mScheduledThreadPool.schedule(new Runnable() {
            @Override
            public void run() {
            // ....
            }
        }, 3, TimeUnit.SECONDS);

```

```java
// å»¶è¿Ÿ 3 ç§’åæ‰§è¡Œä»»åŠ¡, ä»å¼€å§‹æ‰§è¡Œä»»åŠ¡è¿™ä¸ªæ—¶å€™å¼€å§‹è®¡æ—¶, æ¯ 7 ç§’æ‰§è¡Œä¸€æ¬¡ä¸ç®¡æ‰§è¡Œä»»åŠ¡éœ€è¦å¤šé•¿çš„æ—¶é—´.
mScheduledThreadPool.scheduleAtFixedRate(new Runnable() {
            @Override
            public void run() {
             // ....
            }
        },3, 7, TimeUnit.SECONDS);

```

```java
/** å»¶è¿Ÿ 3 ç§’åæ‰§è¡Œä»»åŠ¡, ä»ä»»åŠ¡å®Œæˆæ—¶è¿™ä¸ªæ—¶å€™å¼€å§‹è®¡æ—¶, 7 ç§’åå†æ‰§è¡Œ,
  * å†ç­‰å®Œæˆåè®¡æ—¶ 7 ç§’å†æ‰§è¡Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œçš„å¾ªç¯æ‰§è¡Œä»»åŠ¡çš„æ—¶é—´ç‚¹æ˜¯
  * ä»ä¸Šä¸€ä¸ªä»»åŠ¡å®Œæˆçš„æ—¶å€™.
  */
mScheduledThreadPool.scheduleWithFixedDelay(new Runnable() {
            @Override
            public void run() {
             // ....
            }
        },3, 7, TimeUnit.SECONDS);

```

## [Apolloé…ç½®ä¸­å¿ƒçš„ä½¿ç”¨å¿ƒå¾—åˆ†äº«ï¼šä»å…¥é—¨åˆ°è¿›é˜¶](https://blog.dong4j.site/posts/a2959ba3.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

ä¹‹å‰ä¸€ç›´å­¦ä¹  SpringCloud, å¯¹äºé…ç½®ä¸­å¿ƒï¼Œä¸€ç›´ä¹Ÿæ˜¯é‡‡ç”¨çš„ Spring Cloud Config,ä½†æ˜¯ç”¨ä¹…äº†ï¼Œå‘ç°å¾ˆå¤šåœ°æ–¹æ»¡è¶³ä¸äº†è¦æ±‚ï¼ŒåŒæ—¶ä¹Ÿæ„Ÿè§‰å¾ˆ low(ä¸ªäººçœ‹æ³•å‹¿å–·)ã€‚åœ¨å­¦ä¹  Spring cloud configÂ  çš„æ—¶å€™ä¹Ÿæœ‰å¬åˆ°è¿‡æºç¨‹çš„ apolloï¼Œä½†ä¸€ç›´æ²¡æ—¶é—´å»å¼„ã€‚ç›´åˆ°æ˜¨å¤©çœ‹äº†ä¸€å¼ å›¾ï¼Œå¦‚ä¸‹ï¼šä½¿æˆ‘ä¸‹å®šå†³å¿ƒå»çœ‹çœ‹æºç¨‹çš„ apollo é…ç½®ä¸­å¿ƒã€‚

è¿™å¼ å›¾ä¹Ÿç®—æ˜¯ç»¼åˆå¯¹æ¯”äº† spring cloud config,netflix archaius, ctrip apollo, disconf, hawk ç­‰é…ç½®ä¸­å¿ƒçš„åŠŸèƒ½ç‚¹ã€‚ç»¼åˆæ¯”è¾ƒä¸‹æ¥æºç¨‹ apollo æ›´å…·æœ‰ä¼˜åŠ¿ã€‚

# äºŒã€ç®€å•ä»‹ç»æºç¨‹ Apollo é…ç½®ä¸­å¿ƒ

# 1ã€What is Apollo

## 1.1 èƒŒæ™¯

éšç€ç¨‹åºåŠŸèƒ½çš„æ—¥ç›Šå¤æ‚ï¼Œç¨‹åºçš„é…ç½®æ—¥ç›Šå¢å¤šï¼šå„ç§åŠŸèƒ½çš„å¼€å…³ã€å‚æ•°çš„é…ç½®ã€æœåŠ¡å™¨çš„åœ°å€â€¦â€¦

å¯¹ç¨‹åºé…ç½®çš„æœŸæœ›å€¼ä¹Ÿè¶Šæ¥è¶Šé«˜ï¼šé…ç½®ä¿®æ”¹åå®æ—¶ç”Ÿæ•ˆï¼Œç°åº¦å‘å¸ƒï¼Œåˆ†ç¯å¢ƒã€åˆ†é›†ç¾¤ç®¡ç†é…ç½®ï¼Œå®Œå–„çš„æƒé™ã€å®¡æ ¸æœºåˆ¶â€¦â€¦

åœ¨è¿™æ ·çš„å¤§ç¯å¢ƒä¸‹ï¼Œä¼ ç»Ÿçš„é€šè¿‡é…ç½®æ–‡ä»¶ã€æ•°æ®åº“ç­‰æ–¹å¼å·²ç»è¶Šæ¥è¶Šæ— æ³•æ»¡è¶³å¼€å‘äººå‘˜å¯¹é…ç½®ç®¡ç†çš„éœ€æ±‚ã€‚

Apollo é…ç½®ä¸­å¿ƒåº”è¿è€Œç”Ÿï¼

## 1.2 Apollo ç®€ä»‹

Apolloï¼ˆé˜¿æ³¢ç½—ï¼‰æ˜¯æºç¨‹æ¡†æ¶éƒ¨é—¨ç ”å‘çš„å¼€æºé…ç½®ç®¡ç†ä¸­å¿ƒï¼Œèƒ½å¤Ÿé›†ä¸­åŒ–ç®¡ç†åº”ç”¨ä¸åŒç¯å¢ƒã€ä¸åŒé›†ç¾¤çš„é…ç½®ï¼Œé…ç½®ä¿®æ”¹åèƒ½å¤Ÿå®æ—¶æ¨é€åˆ°åº”ç”¨ç«¯ï¼Œå¹¶ä¸”å…·å¤‡è§„èŒƒçš„æƒé™ã€æµç¨‹æ²»ç†ç­‰ç‰¹æ€§ã€‚

Apollo æ”¯æŒ 4 ä¸ªç»´åº¦ç®¡ç† Key-Value æ ¼å¼çš„é…ç½®ï¼š

1. application (åº”ç”¨)
2. environment (ç¯å¢ƒ)
3. cluster (é›†ç¾¤)
4. namespace (å‘½åç©ºé—´)

åŒæ—¶ï¼ŒApollo åŸºäºå¼€æºæ¨¡å¼å¼€å‘ï¼Œå¼€æºåœ°å€ï¼š[https://github.com/ctripcorp/apollo](https://github.com/ctripcorp/apollo)

## 1.3 é…ç½®åŸºæœ¬æ¦‚å¿µ

æ—¢ç„¶ Apollo å®šä½äºé…ç½®ä¸­å¿ƒï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œæœ‰å¿…è¦å…ˆç®€å•ä»‹ç»ä¸€ä¸‹ä»€ä¹ˆæ˜¯é…ç½®ã€‚

æŒ‰ç…§æˆ‘ä»¬çš„ç†è§£ï¼Œé…ç½®æœ‰ä»¥ä¸‹å‡ ä¸ªå±æ€§ï¼š

- **é…ç½®æ˜¯ç‹¬ç«‹äºç¨‹åºçš„åªè¯»å˜é‡**
  - é…ç½®é¦–å…ˆæ˜¯ç‹¬ç«‹äºç¨‹åºçš„ï¼ŒåŒä¸€ä»½ç¨‹åºåœ¨ä¸åŒçš„é…ç½®ä¸‹ä¼šæœ‰ä¸åŒçš„è¡Œä¸ºã€‚
  - å…¶æ¬¡ï¼Œé…ç½®å¯¹äºç¨‹åºæ˜¯åªè¯»çš„ï¼Œç¨‹åºé€šè¿‡è¯»å–é…ç½®æ¥æ”¹å˜è‡ªå·±çš„è¡Œä¸ºï¼Œä½†æ˜¯ç¨‹åºä¸åº”è¯¥å»æ”¹å˜é…ç½®ã€‚
  - å¸¸è§çš„é…ç½®æœ‰ï¼šDB Connection Strã€Thread Pool Sizeã€Buffer Sizeã€Request Timeoutã€Feature Switchã€Server Urls ç­‰ã€‚
- **é…ç½®ä¼´éšåº”ç”¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ**
  - é…ç½®è´¯ç©¿äºåº”ç”¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œåº”ç”¨åœ¨å¯åŠ¨æ—¶é€šè¿‡è¯»å–é…ç½®æ¥åˆå§‹åŒ–ï¼Œåœ¨è¿è¡Œæ—¶æ ¹æ®é…ç½®è°ƒæ•´è¡Œä¸ºã€‚
- **é…ç½®å¯ä»¥æœ‰å¤šç§åŠ è½½æ–¹å¼**
  - é…ç½®ä¹Ÿæœ‰å¾ˆå¤šç§åŠ è½½æ–¹å¼ï¼Œå¸¸è§çš„æœ‰ç¨‹åºå†…éƒ¨ hard codeï¼Œé…ç½®æ–‡ä»¶ï¼Œç¯å¢ƒå˜é‡ï¼Œå¯åŠ¨å‚æ•°ï¼ŒåŸºäºæ•°æ®åº“ç­‰
- **é…ç½®éœ€è¦æ²»ç†**
  - æƒé™æ§åˆ¶
    - ç”±äºé…ç½®èƒ½æ”¹å˜ç¨‹åºçš„è¡Œä¸ºï¼Œä¸æ­£ç¡®çš„é…ç½®ç”šè‡³èƒ½å¼•èµ·ç¾éš¾ï¼Œæ‰€ä»¥å¯¹é…ç½®çš„ä¿®æ”¹å¿…é¡»æœ‰æ¯”è¾ƒå®Œå–„çš„æƒé™æ§åˆ¶
  - ä¸åŒç¯å¢ƒã€é›†ç¾¤é…ç½®ç®¡ç†
    - åŒä¸€ä»½ç¨‹åºåœ¨ä¸åŒçš„ç¯å¢ƒï¼ˆå¼€å‘ï¼Œæµ‹è¯•ï¼Œç”Ÿäº§ï¼‰ã€ä¸åŒçš„é›†ç¾¤ï¼ˆå¦‚ä¸åŒçš„æ•°æ®ä¸­å¿ƒï¼‰ç»å¸¸éœ€è¦æœ‰ä¸åŒçš„é…ç½®ï¼Œæ‰€ä»¥éœ€è¦æœ‰å®Œå–„çš„ç¯å¢ƒã€é›†ç¾¤é…ç½®ç®¡ç†
  - æ¡†æ¶ç±»ç»„ä»¶é…ç½®ç®¡ç†
    - è¿˜æœ‰ä¸€ç±»æ¯”è¾ƒç‰¹æ®Šçš„é…ç½® - æ¡†æ¶ç±»ç»„ä»¶é…ç½®ï¼Œæ¯”å¦‚ CAT å®¢æˆ·ç«¯çš„é…ç½®ã€‚
    - è™½ç„¶è¿™ç±»æ¡†æ¶ç±»ç»„ä»¶æ˜¯ç”±å…¶ä»–å›¢é˜Ÿå¼€å‘ã€ç»´æŠ¤ï¼Œä½†æ˜¯è¿è¡Œæ—¶æ˜¯åœ¨ä¸šåŠ¡å®é™…åº”ç”¨å†…çš„ï¼Œæ‰€ä»¥æœ¬è´¨ä¸Šå¯ä»¥è®¤ä¸ºæ¡†æ¶ç±»ç»„ä»¶ä¹Ÿæ˜¯åº”ç”¨çš„ä¸€éƒ¨åˆ†ã€‚
    - è¿™ç±»ç»„ä»¶å¯¹åº”çš„é…ç½®ä¹Ÿéœ€è¦æœ‰æ¯”è¾ƒå®Œå–„çš„ç®¡ç†æ–¹å¼ã€‚

# 2ã€Why Apollo

æ­£æ˜¯åŸºäºé…ç½®çš„ç‰¹æ®Šæ€§ï¼Œæ‰€ä»¥ Apollo ä»è®¾è®¡ä¹‹åˆå°±ç«‹å¿—äºæˆä¸ºä¸€ä¸ªæœ‰æ²»ç†èƒ½åŠ›çš„é…ç½®ç®¡ç†å¹³å°ï¼Œç›®å‰æä¾›äº†ä»¥ä¸‹çš„ç‰¹æ€§ï¼š

- **ç»Ÿä¸€ç®¡ç†ä¸åŒç¯å¢ƒã€ä¸åŒé›†ç¾¤çš„é…ç½®**
  - Apollo æä¾›äº†ä¸€ä¸ªç»Ÿä¸€ç•Œé¢é›†ä¸­å¼ç®¡ç†ä¸åŒç¯å¢ƒï¼ˆenvironmentï¼‰ã€ä¸åŒé›†ç¾¤ï¼ˆclusterï¼‰ã€ä¸åŒå‘½åç©ºé—´ï¼ˆnamespaceï¼‰çš„é…ç½®ã€‚
  - åŒä¸€ä»½ä»£ç éƒ¨ç½²åœ¨ä¸åŒçš„é›†ç¾¤ï¼Œå¯ä»¥æœ‰ä¸åŒçš„é…ç½®ï¼Œæ¯”å¦‚ zk çš„åœ°å€ç­‰
  - é€šè¿‡å‘½åç©ºé—´ï¼ˆnamespaceï¼‰å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ”¯æŒå¤šä¸ªä¸åŒåº”ç”¨å…±äº«åŒä¸€ä»½é…ç½®ï¼ŒåŒæ—¶è¿˜å…è®¸åº”ç”¨å¯¹å…±äº«çš„é…ç½®è¿›è¡Œè¦†ç›–
- **é…ç½®ä¿®æ”¹å®æ—¶ç”Ÿæ•ˆï¼ˆçƒ­å‘å¸ƒï¼‰**
  - ç”¨æˆ·åœ¨ Apollo ä¿®æ”¹å®Œé…ç½®å¹¶å‘å¸ƒåï¼Œå®¢æˆ·ç«¯èƒ½å®æ—¶ï¼ˆ1 ç§’ï¼‰æ¥æ”¶åˆ°æœ€æ–°çš„é…ç½®ï¼Œå¹¶é€šçŸ¥åˆ°åº”ç”¨ç¨‹åº
- **ç‰ˆæœ¬å‘å¸ƒç®¡ç†**
  - æ‰€æœ‰çš„é…ç½®å‘å¸ƒéƒ½æœ‰ç‰ˆæœ¬æ¦‚å¿µï¼Œä»è€Œå¯ä»¥æ–¹ä¾¿åœ°æ”¯æŒé…ç½®çš„å›æ»š
- **ç°åº¦å‘å¸ƒ**
  - æ”¯æŒé…ç½®çš„ç°åº¦å‘å¸ƒï¼Œæ¯”å¦‚ç‚¹äº†å‘å¸ƒåï¼Œåªå¯¹éƒ¨åˆ†åº”ç”¨å®ä¾‹ç”Ÿæ•ˆï¼Œç­‰è§‚å¯Ÿä¸€æ®µæ—¶é—´æ²¡é—®é¢˜åå†æ¨ç»™æ‰€æœ‰åº”ç”¨å®ä¾‹
- **æƒé™ç®¡ç†ã€å‘å¸ƒå®¡æ ¸ã€æ“ä½œå®¡è®¡**
  - åº”ç”¨å’Œé…ç½®çš„ç®¡ç†éƒ½æœ‰å®Œå–„çš„æƒé™ç®¡ç†æœºåˆ¶ï¼Œå¯¹é…ç½®çš„ç®¡ç†è¿˜åˆ†ä¸ºäº†ç¼–è¾‘å’Œå‘å¸ƒä¸¤ä¸ªç¯èŠ‚ï¼Œä»è€Œå‡å°‘äººä¸ºçš„é”™è¯¯ã€‚
  - æ‰€æœ‰çš„æ“ä½œéƒ½æœ‰å®¡è®¡æ—¥å¿—ï¼Œå¯ä»¥æ–¹ä¾¿çš„è¿½è¸ªé—®é¢˜
- **å®¢æˆ·ç«¯é…ç½®ä¿¡æ¯ç›‘æ§**
  - å¯ä»¥åœ¨ç•Œé¢ä¸Šæ–¹ä¾¿åœ°çœ‹åˆ°é…ç½®åœ¨è¢«å“ªäº›å®ä¾‹ä½¿ç”¨
- **æä¾› Java å’Œ.Net åŸç”Ÿå®¢æˆ·ç«¯**
  - æä¾›äº† Java å’Œ.Net çš„åŸç”Ÿå®¢æˆ·ç«¯ï¼Œæ–¹ä¾¿åº”ç”¨é›†æˆ
  - æ”¯æŒ Spring Placeholder, Annotation å’Œ Spring Boot çš„ ConfigurationPropertiesï¼Œæ–¹ä¾¿åº”ç”¨ä½¿ç”¨ï¼ˆéœ€è¦ Spring 3.1.1+ï¼‰
  - åŒæ—¶æä¾›äº† Http æ¥å£ï¼Œé Java å’Œ.Net åº”ç”¨ä¹Ÿå¯ä»¥æ–¹ä¾¿çš„ä½¿ç”¨
- **æä¾›å¼€æ”¾å¹³å° API**
  - Apollo è‡ªèº«æä¾›äº†æ¯”è¾ƒå®Œå–„çš„ç»Ÿä¸€é…ç½®ç®¡ç†ç•Œé¢ï¼Œæ”¯æŒå¤šç¯å¢ƒã€å¤šæ•°æ®ä¸­å¿ƒé…ç½®ç®¡ç†ã€æƒé™ã€æµç¨‹æ²»ç†ç­‰ç‰¹æ€§ã€‚
  - ä¸è¿‡ Apollo å‡ºäºé€šç”¨æ€§è€ƒè™‘ï¼Œå¯¹é…ç½®çš„ä¿®æ”¹ä¸ä¼šåšè¿‡å¤šé™åˆ¶ï¼Œåªè¦ç¬¦åˆåŸºæœ¬çš„æ ¼å¼å°±èƒ½å¤Ÿä¿å­˜ã€‚
  - åœ¨æˆ‘ä»¬çš„è°ƒç ”ä¸­å‘ç°ï¼Œå¯¹äºæœ‰äº›ä½¿ç”¨æ–¹ï¼Œå®ƒä»¬çš„é…ç½®å¯èƒ½ä¼šæœ‰æ¯”è¾ƒå¤æ‚çš„æ ¼å¼ï¼Œè€Œä¸”å¯¹è¾“å…¥çš„å€¼ä¹Ÿéœ€è¦è¿›è¡Œæ ¡éªŒåæ–¹å¯ä¿å­˜ï¼Œå¦‚æ£€æŸ¥æ•°æ®åº“ã€ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦åŒ¹é…ã€‚
  - å¯¹äºè¿™ç±»åº”ç”¨ï¼ŒApollo æ”¯æŒåº”ç”¨æ–¹é€šè¿‡å¼€æ”¾æ¥å£åœ¨ Apollo è¿›è¡Œé…ç½®çš„ä¿®æ”¹å’Œå‘å¸ƒï¼Œå¹¶ä¸”å…·å¤‡å®Œå–„çš„æˆæƒå’Œæƒé™æ§åˆ¶
- **éƒ¨ç½²ç®€å•**
  - é…ç½®ä¸­å¿ƒä½œä¸ºåŸºç¡€æœåŠ¡ï¼Œå¯ç”¨æ€§è¦æ±‚éå¸¸é«˜ï¼Œè¿™å°±è¦æ±‚ Apollo å¯¹å¤–éƒ¨ä¾èµ–å°½å¯èƒ½åœ°å°‘
  - ç›®å‰å”¯ä¸€çš„å¤–éƒ¨ä¾èµ–æ˜¯ MySQLï¼Œæ‰€ä»¥éƒ¨ç½²éå¸¸ç®€å•ï¼Œåªè¦å®‰è£…å¥½ Java å’Œ MySQL å°±å¯ä»¥è®© Apollo è·‘èµ·æ¥
  - Apollo è¿˜æä¾›äº†æ‰“åŒ…è„šæœ¬ï¼Œä¸€é”®å°±å¯ä»¥ç”Ÿæˆæ‰€æœ‰éœ€è¦çš„å®‰è£…åŒ…ï¼Œå¹¶ä¸”æ”¯æŒè‡ªå®šä¹‰è¿è¡Œæ—¶å‚æ•°

# 3ã€Apollo at a glance

## 3.1 åŸºç¡€æ¨¡å‹

å¦‚ä¸‹å³æ˜¯ Apollo çš„åŸºç¡€æ¨¡å‹ï¼š

1. ç”¨æˆ·åœ¨é…ç½®ä¸­å¿ƒå¯¹é…ç½®è¿›è¡Œä¿®æ”¹å¹¶å‘å¸ƒ
2. é…ç½®ä¸­å¿ƒé€šçŸ¥ Apollo å®¢æˆ·ç«¯æœ‰é…ç½®æ›´æ–°
3. Apollo å®¢æˆ·ç«¯ä»é…ç½®ä¸­å¿ƒæ‹‰å–æœ€æ–°çš„é…ç½®ã€æ›´æ–°æœ¬åœ°é…ç½®å¹¶é€šçŸ¥åˆ°åº”ç”¨

![20241229154732_DkK2ypQG.webp](https://cdn.dong4j.site/source/image/20241229154732_DkK2ypQG.webp)

## 3.2 ç•Œé¢æ¦‚è§ˆ

![20241229154732_a2KZU0KU.webp](https://cdn.dong4j.site/source/image/20241229154732_a2KZU0KU.webp)

ä¸Šå›¾æ˜¯ Apollo é…ç½®ä¸­å¿ƒä¸­ä¸€ä¸ªé¡¹ç›®çš„é…ç½®é¦–é¡µ

- åœ¨é¡µé¢å·¦ä¸Šæ–¹çš„ç¯å¢ƒåˆ—è¡¨æ¨¡å—å±•ç¤ºäº†æ‰€æœ‰çš„ç¯å¢ƒå’Œé›†ç¾¤ï¼Œç”¨æˆ·å¯ä»¥éšæ—¶åˆ‡æ¢ã€‚
- é¡µé¢ä¸­å¤®å±•ç¤ºäº†ä¸¤ä¸ª namespace(application å’Œ FX.apollo) çš„é…ç½®ä¿¡æ¯ï¼Œé»˜è®¤æŒ‰ç…§è¡¨æ ¼æ¨¡å¼å±•ç¤ºã€ç¼–è¾‘ã€‚ç”¨æˆ·ä¹Ÿå¯ä»¥åˆ‡æ¢åˆ°æ–‡æœ¬æ¨¡å¼ï¼Œä»¥æ–‡ä»¶å½¢å¼æŸ¥çœ‹ã€ç¼–è¾‘ã€‚
- é¡µé¢ä¸Šå¯ä»¥æ–¹ä¾¿åœ°è¿›è¡Œå‘å¸ƒã€å›æ»šã€ç°åº¦ã€æˆæƒã€æŸ¥çœ‹æ›´æ”¹å†å²å’Œå‘å¸ƒå†å²ç­‰æ“ä½œ

## 3.3 æ·»åŠ /ä¿®æ”¹é…ç½®é¡¹

ç”¨æˆ·å¯ä»¥é€šè¿‡é…ç½®ä¸­å¿ƒç•Œé¢æ–¹ä¾¿çš„æ·»åŠ /ä¿®æ”¹é…ç½®é¡¹ï¼š

![20241229154732_qPwTCUq9.webp](https://cdn.dong4j.site/source/image/20241229154732_qPwTCUq9.webp)

è¾“å…¥é…ç½®ä¿¡æ¯ï¼š

![20241229154732_AJURlBSS.webp](https://cdn.dong4j.site/source/image/20241229154732_AJURlBSS.webp)

## 3.4 å‘å¸ƒé…ç½®

é€šè¿‡é…ç½®ä¸­å¿ƒå‘å¸ƒé…ç½®ï¼š

![20241229154732_l6UchSjE.webp](https://cdn.dong4j.site/source/image/20241229154732_l6UchSjE.webp)

å¡«å†™å‘å¸ƒä¿¡æ¯ï¼š

![20241229154732_S2vDJqCJ.webp](https://cdn.dong4j.site/source/image/20241229154732_S2vDJqCJ.webp)

## 3.5 å®¢æˆ·ç«¯è·å–é…ç½®ï¼ˆJava API æ ·ä¾‹ï¼‰

é…ç½®å‘å¸ƒåï¼Œå°±èƒ½åœ¨å®¢æˆ·ç«¯è·å–åˆ°äº†ï¼Œä»¥ Java API æ–¹å¼ä¸ºä¾‹ï¼Œè·å–é…ç½®çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚æ›´å¤šå®¢æˆ·ç«¯ä½¿ç”¨è¯´æ˜è¯·å‚è§ [Java å®¢æˆ·ç«¯ä½¿ç”¨æŒ‡å—](https://github.com/ctripcorp/apollo/wiki/Java%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97)ã€‚

```
Config config = ConfigService.getAppConfig();
Integer defaultRequestTimeout = 200;
Integer requestTimeout =
         config.getIntProperty("request.timeout",defaultRequestTimeout);

```

## 3.6 å®¢æˆ·ç«¯ç›‘å¬é…ç½®å˜åŒ–ï¼ˆJava API æ ·ä¾‹ï¼‰

é€šè¿‡ä¸Šè¿°è·å–é…ç½®ä»£ç ï¼Œåº”ç”¨å°±èƒ½å®æ—¶è·å–åˆ°æœ€æ–°çš„é…ç½®äº†ã€‚

ä¸è¿‡åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œåº”ç”¨è¿˜éœ€è¦åœ¨é…ç½®å˜åŒ–æ—¶è·å¾—é€šçŸ¥ï¼Œæ¯”å¦‚æ•°æ®åº“è¿æ¥çš„åˆ‡æ¢ç­‰ï¼Œæ‰€ä»¥ Apollo è¿˜æä¾›äº†ç›‘å¬é…ç½®å˜åŒ–çš„åŠŸèƒ½ï¼ŒJava ç¤ºä¾‹å¦‚ä¸‹ï¼š

```
Config config = ConfigService.getAppConfig();
config.addChangeListener(new ConfigChangeListener() {
    @Override
    public void onChange(ConfigChangeEvent changeEvent) {
        for (String key : changeEvent.changedKeys()) {
            ConfigChange change = changeEvent.getChange(key);
            System.out.println(String.format(
                "Found change - key: %s, oldValue: %s, newValue: %s, changeType: %s",
                change.getPropertyName(), change.getOldValue(),
                change.getNewValue(), change.getChangeType()));
        }
    }
});

```

## 3.7 Spring é›†æˆæ ·ä¾‹

Apollo å’Œ Spring ä¹Ÿå¯ä»¥å¾ˆæ–¹ä¾¿åœ°é›†æˆï¼Œåªéœ€è¦æ ‡æ³¨ `@EnableApolloConfig` åå°±å¯ä»¥é€šè¿‡ `@Value` è·å–é…ç½®ä¿¡æ¯ï¼š

```
@Configuration
@EnableApolloConfig
public class AppConfig {}

```

```
@Component
public class SomeBean {
    @Value("${request.timeout:200}")
    private int timeout;

    @ApolloConfigChangeListener
    private void someChangeHandler(ConfigChangeEvent changeEvent) {
        if (changeEvent.isChanged("request.timeout")) {
            refreshTimeout();
        }
    }
}

```

# 4ã€Apollo in depth

é€šè¿‡ä¸Šé¢çš„ä»‹ç»ï¼Œç›¸ä¿¡å¤§å®¶å·²ç»å¯¹ Apollo æœ‰äº†ä¸€ä¸ªåˆæ­¥çš„äº†è§£ï¼Œå¹¶ä¸”ç›¸ä¿¡å·²ç»è¦†ç›–åˆ°äº†å¤§éƒ¨åˆ†çš„ä½¿ç”¨åœºæ™¯ã€‚

æ¥ä¸‹æ¥ä¼šä¸»è¦ä»‹ç» Apollo çš„ cluster ç®¡ç†ï¼ˆé›†ç¾¤ï¼‰ã€namespace ç®¡ç†ï¼ˆå‘½åç©ºé—´ï¼‰å’Œå¯¹åº”çš„é…ç½®è·å–è§„åˆ™ã€‚

## 4.1 Core Concepts

åœ¨ä»‹ç»é«˜çº§ç‰¹æ€§å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å…ˆæ¥äº†è§£ä¸€ä¸‹ Apollo ä¸­çš„å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š

1. **application (åº”ç”¨)**

   - è¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯å®é™…ä½¿ç”¨é…ç½®çš„åº”ç”¨ï¼ŒApollo å®¢æˆ·ç«¯åœ¨è¿è¡Œæ—¶éœ€è¦çŸ¥é“å½“å‰åº”ç”¨æ˜¯è°ï¼Œä»è€Œå¯ä»¥å»è·å–å¯¹åº”çš„é…ç½®
   - æ¯ä¸ªåº”ç”¨éƒ½éœ€è¦æœ‰å”¯ä¸€çš„èº«ä»½æ ‡è¯† - appIdï¼Œæˆ‘ä»¬è®¤ä¸ºåº”ç”¨èº«ä»½æ˜¯è·Ÿç€ä»£ç èµ°çš„ï¼Œæ‰€ä»¥éœ€è¦åœ¨ä»£ç ä¸­é…ç½®ï¼Œå…·ä½“ä¿¡æ¯è¯·å‚è§ [Java å®¢æˆ·ç«¯ä½¿ç”¨æŒ‡å—](https://github.com/ctripcorp/apollo/wiki/Java%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97)ã€‚

2. **environment (ç¯å¢ƒ)**

   - é…ç½®å¯¹åº”çš„ç¯å¢ƒï¼ŒApollo å®¢æˆ·ç«¯åœ¨è¿è¡Œæ—¶éœ€è¦çŸ¥é“å½“å‰åº”ç”¨å¤„äºå“ªä¸ªç¯å¢ƒï¼Œä»è€Œå¯ä»¥å»è·å–åº”ç”¨çš„é…ç½®
   - æˆ‘ä»¬è®¤ä¸ºç¯å¢ƒå’Œä»£ç æ— å…³ï¼ŒåŒä¸€ä»½ä»£ç éƒ¨ç½²åœ¨ä¸åŒçš„ç¯å¢ƒå°±åº”è¯¥èƒ½å¤Ÿè·å–åˆ°ä¸åŒç¯å¢ƒçš„é…ç½®
   - æ‰€ä»¥ç¯å¢ƒé»˜è®¤æ˜¯é€šè¿‡è¯»å–æœºå™¨ä¸Šçš„é…ç½®ï¼ˆserver.properties ä¸­çš„ env å±æ€§ï¼‰æŒ‡å®šçš„ï¼Œä¸è¿‡ä¸ºäº†å¼€å‘æ–¹ä¾¿ï¼Œæˆ‘ä»¬ä¹Ÿæ”¯æŒè¿è¡Œæ—¶é€šè¿‡ System Property ç­‰æŒ‡å®šï¼Œå…·ä½“ä¿¡æ¯è¯·å‚è§ [Java å®¢æˆ·ç«¯ä½¿ç”¨æŒ‡å—](https://github.com/ctripcorp/apollo/wiki/Java%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97)ã€‚

3. **cluster (é›†ç¾¤)**

   - ä¸€ä¸ªåº”ç”¨ä¸‹ä¸åŒå®ä¾‹çš„åˆ†ç»„ï¼Œæ¯”å¦‚å…¸å‹çš„å¯ä»¥æŒ‰ç…§æ•°æ®ä¸­å¿ƒåˆ†ï¼ŒæŠŠä¸Šæµ·æœºæˆ¿çš„åº”ç”¨å®ä¾‹åˆ†ä¸ºä¸€ä¸ªé›†ç¾¤ï¼ŒæŠŠåŒ—äº¬æœºæˆ¿çš„åº”ç”¨å®ä¾‹åˆ†ä¸ºå¦ä¸€ä¸ªé›†ç¾¤ã€‚
   - å¯¹ä¸åŒçš„ clusterï¼ŒåŒä¸€ä¸ªé…ç½®å¯ä»¥æœ‰ä¸ä¸€æ ·çš„å€¼ï¼Œå¦‚ zookeeper åœ°å€ã€‚
   - é›†ç¾¤é»˜è®¤æ˜¯é€šè¿‡è¯»å–æœºå™¨ä¸Šçš„é…ç½®ï¼ˆserver.properties ä¸­çš„ idc å±æ€§ï¼‰æŒ‡å®šçš„ï¼Œä¸è¿‡ä¹Ÿæ”¯æŒè¿è¡Œæ—¶é€šè¿‡ System Property æŒ‡å®šï¼Œå…·ä½“ä¿¡æ¯è¯·å‚è§ [Java å®¢æˆ·ç«¯ä½¿ç”¨æŒ‡å—](https://github.com/ctripcorp/apollo/wiki/Java%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97)ã€‚

4. **namespace (å‘½åç©ºé—´)**

   - ä¸€ä¸ªåº”ç”¨ä¸‹ä¸åŒé…ç½®çš„åˆ†ç»„ï¼Œå¯ä»¥ç®€å•åœ°æŠŠ namespace ç±»æ¯”ä¸ºæ–‡ä»¶ï¼Œä¸åŒç±»å‹çš„é…ç½®å­˜æ”¾åœ¨ä¸åŒçš„æ–‡ä»¶ä¸­ï¼Œå¦‚æ•°æ®åº“é…ç½®æ–‡ä»¶ï¼Œrpc é…ç½®æ–‡ä»¶ï¼Œåº”ç”¨è‡ªèº«çš„é…ç½®æ–‡ä»¶ç­‰
   - åº”ç”¨å¯ä»¥ç›´æ¥è¯»å–åˆ°å…¬å…±ç»„ä»¶çš„é…ç½® namespaceï¼Œå¦‚ DALï¼ŒRPC ç­‰
   - åº”ç”¨ä¹Ÿå¯ä»¥é€šè¿‡ç»§æ‰¿å…¬å…±ç»„ä»¶çš„é…ç½® namespace æ¥å¯¹å…¬å…±ç»„ä»¶çš„é…ç½®åšè°ƒæ•´ï¼Œå¦‚ DAL çš„åˆå§‹æ•°æ®åº“è¿æ¥æ•°

## 4.2 è‡ªå®šä¹‰ Cluster

> ã€æœ¬èŠ‚å†…å®¹ä»…å¯¹åº”ç”¨éœ€è¦å¯¹ä¸åŒé›†ç¾¤åº”ç”¨ä¸åŒé…ç½®æ‰éœ€è¦ï¼Œå¦‚æ²¡æœ‰ç›¸å…³éœ€æ±‚ï¼Œå¯ä»¥è·³è¿‡æœ¬èŠ‚ã€‘

æ¯”å¦‚æˆ‘ä»¬æœ‰åº”ç”¨åœ¨ A æ•°æ®ä¸­å¿ƒå’Œ B æ•°æ®ä¸­å¿ƒéƒ½æœ‰éƒ¨ç½²ï¼Œé‚£ä¹ˆå¦‚æœå¸Œæœ›ä¸¤ä¸ªæ•°æ®ä¸­å¿ƒçš„é…ç½®ä¸ä¸€æ ·çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ–°å»º cluster æ¥è§£å†³ã€‚

### 4.2.1 æ–°å»º Cluster

æ–°å»º Cluster åªæœ‰é¡¹ç›®çš„ç®¡ç†å‘˜æ‰æœ‰æƒé™ï¼Œç®¡ç†å‘˜å¯ä»¥åœ¨é¡µé¢å·¦ä¾§çœ‹åˆ°â€œæ·»åŠ é›†ç¾¤â€æŒ‰é’®ã€‚

![20241229154732_KiFCrigs.webp](https://cdn.dong4j.site/source/image/20241229154732_KiFCrigs.webp)

ç‚¹å‡»åå°±è¿›å…¥åˆ°é›†ç¾¤æ·»åŠ é¡µé¢ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å¯ä»¥æŒ‰ç…§æ•°æ®ä¸­å¿ƒæ¥åˆ’åˆ†é›†ç¾¤ï¼Œå¦‚ SHAJQã€SHAOY ç­‰ã€‚

ä¸è¿‡ä¹Ÿæ”¯æŒè‡ªå®šä¹‰é›†ç¾¤ï¼Œæ¯”å¦‚å¯ä»¥ä¸º A æœºæˆ¿çš„æŸä¸€å°æœºå™¨å’Œ B æœºæˆ¿çš„æŸä¸€å°æœºåˆ›å»ºä¸€ä¸ªé›†ç¾¤ï¼Œä½¿ç”¨ä¸€å¥—é…ç½®ã€‚

![20241229154732_D5ZfQpSc.webp](https://cdn.dong4j.site/source/image/20241229154732_D5ZfQpSc.webp)

### 4.2.2 åœ¨ Cluster ä¸­æ·»åŠ é…ç½®å¹¶å‘å¸ƒ

é›†ç¾¤æ·»åŠ æˆåŠŸåï¼Œå°±å¯ä»¥ä¸ºè¯¥é›†ç¾¤æ·»åŠ é…ç½®äº†ï¼Œé¦–é€‰éœ€è¦æŒ‰ç…§ä¸‹å›¾æ‰€ç¤ºåˆ‡æ¢åˆ° SHAJQ é›†ç¾¤ï¼Œä¹‹åé…ç½®æ·»åŠ æµç¨‹å’Œ [3.2 æ·»åŠ /ä¿®æ”¹é…ç½®é¡¹](http://nobodyiam.com/2016/07/09/introduction-to-apollo/#section-2) ä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚

![20241229154732_c01v9OMS.webp](https://cdn.dong4j.site/source/image/20241229154732_c01v9OMS.webp)

### 4.2.3 æŒ‡å®šåº”ç”¨å®ä¾‹æ‰€å±çš„ Cluster

Apollo ä¼šé»˜è®¤ä½¿ç”¨åº”ç”¨å®ä¾‹æ‰€åœ¨çš„æ•°æ®ä¸­å¿ƒä½œä¸º clusterï¼Œæ‰€ä»¥å¦‚æœä¸¤è€…ä¸€è‡´çš„è¯ï¼Œä¸éœ€è¦é¢å¤–é…ç½®ã€‚

å¦‚æœ cluster å’Œæ•°æ®ä¸­å¿ƒä¸ä¸€è‡´çš„è¯ï¼Œé‚£ä¹ˆå°±éœ€è¦é€šè¿‡ System Property æ–¹å¼æ¥æŒ‡å®šè¿è¡Œæ—¶ clusterï¼š

- -Dapollo.cluster=SomeCluster
- è¿™é‡Œæ³¨æ„ `apollo.cluster` ä¸ºå…¨å°å†™

## 4.3 è‡ªå®šä¹‰ Namespace

> ã€æœ¬èŠ‚ä»…å¯¹å…¬å…±ç»„ä»¶é…ç½®æˆ–éœ€è¦å¤šä¸ªåº”ç”¨å…±äº«é…ç½®æ‰éœ€è¦ï¼Œå¦‚æ²¡æœ‰ç›¸å…³éœ€æ±‚ï¼Œå¯ä»¥è·³è¿‡æœ¬èŠ‚ã€‘

å¦‚æœåº”ç”¨æœ‰å…¬å…±ç»„ä»¶ï¼ˆå¦‚ hermes-producerï¼Œcat-client ç­‰ï¼‰ä¾›å…¶å®ƒåº”ç”¨ä½¿ç”¨ï¼Œå°±éœ€è¦é€šè¿‡è‡ªå®šä¹‰ namespace æ¥å®ç°å…¬å…±ç»„ä»¶çš„é…ç½®ã€‚

### 4.3.1 æ–°å»º Namespace

ä»¥ hermes-producer ä¸ºä¾‹ï¼Œéœ€è¦å…ˆæ–°å»ºä¸€ä¸ª namespaceï¼Œæ–°å»º namespace åªæœ‰é¡¹ç›®çš„ç®¡ç†å‘˜æ‰æœ‰æƒé™ï¼Œç®¡ç†å‘˜å¯ä»¥åœ¨é¡µé¢å·¦ä¾§çœ‹åˆ°â€œæ·»åŠ  Namespaceâ€æŒ‰é’®ã€‚

![20241229154732_HkmfFyMH.webp](https://cdn.dong4j.site/source/image/20241229154732_HkmfFyMH.webp)

ç‚¹å‡»åå°±è¿›å…¥ namespace æ·»åŠ é¡µé¢ï¼ŒApollo ä¼šæŠŠåº”ç”¨æ‰€å±çš„éƒ¨é—¨ä½œä¸º namespace çš„å‰ç¼€ï¼Œå¦‚ FXã€‚

![20241229154732_Kpuh1aBK.webp](https://cdn.dong4j.site/source/image/20241229154732_Kpuh1aBK.webp)

### 4.3.2 å…³è”åˆ°ç¯å¢ƒå’Œé›†ç¾¤

Namespace åˆ›å»ºå®Œï¼Œéœ€è¦é€‰æ‹©åœ¨å“ªäº›ç¯å¢ƒå’Œé›†ç¾¤ä¸‹ä½¿ç”¨

![20241229154732_JT15Rl8C.webp](https://cdn.dong4j.site/source/image/20241229154732_JT15Rl8C.webp)

### 4.3.3 åœ¨ Namespace ä¸­æ·»åŠ é…ç½®é¡¹

æ¥ä¸‹æ¥åœ¨è¿™ä¸ªæ–°å»ºçš„ namespace ä¸‹æ·»åŠ é…ç½®é¡¹

![20241229154732_5Q0Vo9yD.webp](https://cdn.dong4j.site/source/image/20241229154732_5Q0Vo9yD.webp)

æ·»åŠ å®Œæˆåå°±èƒ½åœ¨ FX.Hermes.Producer çš„ namespace ä¸­çœ‹åˆ°é…ç½®ã€‚

![20241229154732_ii3xtcBo.webp](https://cdn.dong4j.site/source/image/20241229154732_ii3xtcBo.webp)

### 4.3.4 å‘å¸ƒ namespace çš„é…ç½®

![20241229154732_FOxrOgXT.webp](https://cdn.dong4j.site/source/image/20241229154732_FOxrOgXT.webp)

### 4.3.5 å®¢æˆ·ç«¯è·å– Namespace é…ç½®

å¯¹è‡ªå®šä¹‰ namespace çš„é…ç½®è·å–ï¼Œç¨æœ‰ä¸åŒï¼Œéœ€è¦ç¨‹åºä¼ å…¥ namespace çš„åå­—ã€‚æ›´å¤šå®¢æˆ·ç«¯ä½¿ç”¨è¯´æ˜è¯·å‚è§ [Java å®¢æˆ·ç«¯ä½¿ç”¨æŒ‡å—](https://github.com/ctripcorp/apollo/wiki/Java%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97)ã€‚

```
Config config = ConfigService.getConfig("FX.Hermes.Producer");
Integer defaultSenderBatchSize = 200;
Integer senderBatchSize = config.getIntProperty("sender.batchsize", defaultSenderBatchSize);

```

### 4.3.6 å®¢æˆ·ç«¯ç›‘å¬ Namespace é…ç½®å˜åŒ–

```
Config config = ConfigService.getConfig("FX.Hermes.Producer");
config.addChangeListener(new ConfigChangeListener() {
  @Override
  public void onChange(ConfigChangeEvent changeEvent) {
    System.out.println("Changes for namespace " + changeEvent.getNamespace());
    for (String key : changeEvent.changedKeys()) {
      ConfigChange change = changeEvent.getChange(key);
      System.out.println(String.format(
        "Found change - key: %s, oldValue: %s, newValue: %s, changeType: %s",
        change.getPropertyName(), change.getOldValue(),
        change.getNewValue(), change.getChangeType()));
     }
  }
});

```

### 4.3.7 Spring é›†æˆæ ·ä¾‹

```
@Configuration
@EnableApolloConfig("FX.Hermes.Producer")
public class AppConfig {}

```

```
@Component
public class SomeBean {
    @Value("${request.timeout:200}")
    private int timeout;

    @ApolloConfigChangeListener("FX.Hermes.Producer")
    private void someChangeHandler(ConfigChangeEvent changeEvent) {
        if (changeEvent.isChanged("request.timeout")) {
            refreshTimeout();
        }
    }
}

```

## 4.4 é…ç½®è·å–è§„åˆ™

> ã€æœ¬èŠ‚ä»…å½“åº”ç”¨è‡ªå®šä¹‰äº†é›†ç¾¤æˆ– namespace æ‰éœ€è¦ï¼Œå¦‚æ— ç›¸å…³éœ€æ±‚ï¼Œå¯ä»¥è·³è¿‡æœ¬èŠ‚ã€‘

åœ¨æœ‰äº† cluster æ¦‚å¿µåï¼Œé…ç½®çš„è§„åˆ™å°±æ˜¾å¾—é‡è¦äº†ã€‚

æ¯”å¦‚åº”ç”¨éƒ¨ç½²åœ¨ A æœºæˆ¿ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰åœ¨ Apollo æ–°å»º clusterï¼Œè¿™ä¸ªæ—¶å€™ Apollo çš„è¡Œä¸ºæ˜¯æ€æ ·çš„ï¼Ÿ

æˆ–è€…åœ¨è¿è¡Œæ—¶æŒ‡å®šäº† cluster=SomeClusterï¼Œä½†æ˜¯å¹¶æ²¡æœ‰åœ¨ Apollo æ–°å»º clusterï¼Œè¿™ä¸ªæ—¶å€™ Apollo çš„è¡Œä¸ºæ˜¯æ€æ ·çš„ï¼Ÿ

æ¥ä¸‹æ¥å°±æ¥ä»‹ç»ä¸€ä¸‹é…ç½®è·å–çš„è§„åˆ™ã€‚

### 4.4.1 åº”ç”¨è‡ªèº«é…ç½®çš„è·å–è§„åˆ™

å½“åº”ç”¨ä½¿ç”¨ä¸‹é¢çš„è¯­å¥è·å–é…ç½®æ—¶ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºè·å–åº”ç”¨è‡ªèº«çš„é…ç½®ï¼Œä¹Ÿå°±æ˜¯åº”ç”¨è‡ªèº«çš„ application namespace çš„é…ç½®ã€‚

```
Config config = ConfigService.getAppConfig();

```

å¯¹è¿™ç§æƒ…å†µçš„é…ç½®è·å–è§„åˆ™ï¼Œç®€è€Œè¨€ä¹‹å¦‚ä¸‹ï¼š

1. é¦–å…ˆæŸ¥æ‰¾è¿è¡Œæ—¶ cluster çš„é…ç½®ï¼ˆé€šè¿‡ apollo.cluster æŒ‡å®šï¼‰
2. å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™æŸ¥æ‰¾æ•°æ®ä¸­å¿ƒ cluster çš„é…ç½®
3. å¦‚æœè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™è¿”å›é»˜è®¤ cluster çš„é…ç½®

å›¾ç¤ºå¦‚ä¸‹ï¼š

![20241229154732_BMEnbzMK.webp](https://cdn.dong4j.site/source/image/20241229154732_BMEnbzMK.webp)

æ‰€ä»¥å¦‚æœåº”ç”¨éƒ¨ç½²åœ¨ A æ•°æ®ä¸­å¿ƒï¼Œä½†æ˜¯ç”¨æˆ·æ²¡æœ‰åœ¨ Apollo åˆ›å»º clusterï¼Œé‚£ä¹ˆè·å–çš„é…ç½®å°±æ˜¯é»˜è®¤ clusterï¼ˆdefaultï¼‰çš„ã€‚

å¦‚æœåº”ç”¨éƒ¨ç½²åœ¨ A æ•°æ®ä¸­å¿ƒï¼ŒåŒæ—¶åœ¨è¿è¡Œæ—¶æŒ‡å®šäº† SomeClusterï¼Œä½†æ˜¯æ²¡æœ‰åœ¨ Apollo åˆ›å»º clusterï¼Œé‚£ä¹ˆè·å–çš„é…ç½®å°±æ˜¯ A æ•°æ®ä¸­å¿ƒ cluster çš„é…ç½®ï¼Œå¦‚æœ A æ•°æ®ä¸­å¿ƒ cluster æ²¡æœ‰é…ç½®çš„è¯ï¼Œé‚£ä¹ˆè·å–çš„é…ç½®å°±æ˜¯é»˜è®¤ clusterï¼ˆdefaultï¼‰çš„ã€‚

### 4.4.2 å…¬å…±ç»„ä»¶é…ç½®çš„è·å–è§„åˆ™

ä»¥**_FX.Hermes.Producer_**ä¸ºä¾‹ï¼Œhermes producer æ˜¯ hermes å‘å¸ƒçš„å…¬å…±ç»„ä»¶ã€‚å½“ä½¿ç”¨ä¸‹é¢çš„è¯­å¥è·å–é…ç½®æ—¶ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºè·å–å…¬å…±ç»„ä»¶çš„é…ç½®ã€‚

```
Config config = ConfigService.getConfig("FX.Hermes.Producer");

```

å¯¹è¿™ç§æƒ…å†µçš„é…ç½®è·å–è§„åˆ™ï¼Œç®€è€Œè¨€ä¹‹å¦‚ä¸‹ï¼š

1. é¦–å…ˆè·å–å½“å‰åº”ç”¨ä¸‹çš„**_FX.Hermes.Producer_**Â namespace çš„é…ç½®
2. ç„¶åè·å– hermes åº”ç”¨ä¸‹**_FX.Hermes.Producer_**Â namespace çš„é…ç½®
3. ä¸Šé¢ä¸¤éƒ¨åˆ†é…ç½®çš„å¹¶é›†å°±æ˜¯æœ€ç»ˆä½¿ç”¨çš„é…ç½®ï¼Œå¦‚æœ‰ key ä¸€æ ·çš„éƒ¨åˆ†ï¼Œä»¥å½“å‰åº”ç”¨ä¼˜å…ˆ

å›¾ç¤ºå¦‚ä¸‹ï¼š

![20241229154732_eZawyyZs.webp](https://cdn.dong4j.site/source/image/20241229154732_eZawyyZs.webp)

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå°±å®ç°äº†å¯¹æ¡†æ¶ç±»ç»„ä»¶çš„é…ç½®ç®¡ç†ï¼Œæ¡†æ¶ç»„ä»¶æä¾›æ–¹æä¾›é…ç½®çš„é»˜è®¤å€¼ï¼Œåº”ç”¨å¦‚æœæœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œå¯ä»¥è‡ªè¡Œè¦†ç›–ã€‚

## 4.5 æ€»ä½“è®¾è®¡

![20241229154732_ePfZQkEn.webp](https://cdn.dong4j.site/source/image/20241229154732_ePfZQkEn.webp)

ä¸Šå›¾ç®€è¦æè¿°äº† Apollo çš„æ€»ä½“è®¾è®¡ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸‹å¾€ä¸Šçœ‹ï¼š

- Config Service æä¾›é…ç½®çš„è¯»å–ã€æ¨é€ç­‰åŠŸèƒ½ï¼ŒæœåŠ¡å¯¹è±¡æ˜¯ Apollo å®¢æˆ·ç«¯
- Admin Service æä¾›é…ç½®çš„ä¿®æ”¹ã€å‘å¸ƒç­‰åŠŸèƒ½ï¼ŒæœåŠ¡å¯¹è±¡æ˜¯ Apollo Portalï¼ˆç®¡ç†ç•Œé¢ï¼‰
- Config Service å’Œ Admin Service éƒ½æ˜¯å¤šå®ä¾‹ã€æ— çŠ¶æ€éƒ¨ç½²ï¼Œæ‰€ä»¥éœ€è¦å°†è‡ªå·±æ³¨å†Œåˆ° Eureka ä¸­å¹¶ä¿æŒå¿ƒè·³
- åœ¨ Eureka ä¹‹ä¸Šæˆ‘ä»¬æ¶äº†ä¸€å±‚ Meta Server ç”¨äºå°è£… Eureka çš„æœåŠ¡å‘ç°æ¥å£
- Client é€šè¿‡åŸŸåè®¿é—® Meta Server è·å– Config Service æœåŠ¡åˆ—è¡¨ï¼ˆIP+Portï¼‰ï¼Œè€Œåç›´æ¥é€šè¿‡ IP+Port è®¿é—®æœåŠ¡ï¼ŒåŒæ—¶åœ¨ Client ä¾§ä¼šåš load balanceã€é”™è¯¯é‡è¯•
- Portal é€šè¿‡åŸŸåè®¿é—® Meta Server è·å– Admin Service æœåŠ¡åˆ—è¡¨ï¼ˆIP+Portï¼‰ï¼Œè€Œåç›´æ¥é€šè¿‡ IP+Port è®¿é—®æœåŠ¡ï¼ŒåŒæ—¶åœ¨ Portal ä¾§ä¼šåš load balanceã€é”™è¯¯é‡è¯•
- ä¸ºäº†ç®€åŒ–éƒ¨ç½²ï¼Œæˆ‘ä»¬å®é™…ä¸Šä¼šæŠŠ Config Serviceã€Eureka å’Œ Meta Server ä¸‰ä¸ªé€»è¾‘è§’è‰²éƒ¨ç½²åœ¨åŒä¸€ä¸ª JVM è¿›ç¨‹ä¸­

### 4.5.1 Why Eureka

ä¸ºä»€ä¹ˆæˆ‘ä»¬é‡‡ç”¨ Eureka ä½œä¸ºæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œè€Œä¸æ˜¯ä½¿ç”¨ä¼ ç»Ÿçš„ zkã€etcd å‘¢ï¼Ÿæˆ‘å¤§è‡´æ€»ç»“äº†ä¸€ä¸‹ï¼Œæœ‰ä»¥ä¸‹å‡ æ–¹é¢çš„åŸå› ï¼š

- å®ƒæä¾›äº†å®Œæ•´çš„ Service Registry å’Œ Service Discovery å®ç°
  - é¦–å…ˆæ˜¯æä¾›äº†å®Œæ•´çš„å®ç°ï¼Œå¹¶ä¸”ä¹Ÿç»å—ä½äº† Netflix è‡ªå·±çš„ç”Ÿäº§ç¯å¢ƒè€ƒéªŒï¼Œç›¸å¯¹ä½¿ç”¨èµ·æ¥ä¼šæ¯”è¾ƒçœå¿ƒã€‚
- å’Œ Spring Cloud æ— ç¼é›†æˆ
  - æˆ‘ä»¬çš„é¡¹ç›®æœ¬èº«å°±ä½¿ç”¨äº† Spring Cloud å’Œ Spring Bootï¼ŒåŒæ—¶ Spring Cloud è¿˜æœ‰ä¸€å¥—éå¸¸å®Œå–„çš„å¼€æºä»£ç æ¥æ•´åˆ Eurekaï¼Œæ‰€ä»¥ä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚
  - å¦å¤–ï¼ŒEureka è¿˜æ”¯æŒåœ¨æˆ‘ä»¬åº”ç”¨è‡ªèº«çš„å®¹å™¨ä¸­å¯åŠ¨ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„åº”ç”¨å¯åŠ¨å®Œä¹‹åï¼Œæ—¢å……å½“äº† Eureka çš„è§’è‰²ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æœåŠ¡çš„æä¾›è€…ã€‚è¿™æ ·å°±æå¤§çš„æé«˜äº†æœåŠ¡çš„å¯ç”¨æ€§ã€‚
  - **è¿™ä¸€ç‚¹æ˜¯æˆ‘ä»¬é€‰æ‹© Eureka è€Œä¸æ˜¯ zkã€etcd ç­‰çš„ä¸»è¦åŸå› ï¼Œä¸ºäº†æé«˜é…ç½®ä¸­å¿ƒçš„å¯ç”¨æ€§å’Œé™ä½éƒ¨ç½²å¤æ‚åº¦ï¼Œæˆ‘ä»¬éœ€è¦å°½å¯èƒ½åœ°å‡å°‘å¤–éƒ¨ä¾èµ–ã€‚**
- Open Source
  - æœ€åä¸€ç‚¹æ˜¯å¼€æºï¼Œç”±äºä»£ç æ˜¯å¼€æºçš„ï¼Œæ‰€ä»¥éå¸¸ä¾¿äºæˆ‘ä»¬äº†è§£å®ƒçš„å®ç°åŸç†å’Œæ’æŸ¥é—®é¢˜ã€‚

## 4.6 å®¢æˆ·ç«¯è®¾è®¡

![20241229154732_KmL6Rzxj.webp](https://cdn.dong4j.site/source/image/20241229154732_KmL6Rzxj.webp)

ä¸Šå›¾ç®€è¦æè¿°äº† Apollo å®¢æˆ·ç«¯çš„å®ç°åŸç†ï¼š

1. å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¿æŒäº†ä¸€ä¸ªé•¿è¿æ¥ï¼Œä»è€Œèƒ½ç¬¬ä¸€æ—¶é—´è·å¾—é…ç½®æ›´æ–°çš„æ¨é€ã€‚
2. å®¢æˆ·ç«¯è¿˜ä¼šå®šæ—¶ä» Apollo é…ç½®ä¸­å¿ƒæœåŠ¡ç«¯æ‹‰å–åº”ç”¨çš„æœ€æ–°é…ç½®ã€‚

   - è¿™æ˜¯ä¸€ä¸ª fallback æœºåˆ¶ï¼Œä¸ºäº†é˜²æ­¢æ¨é€æœºåˆ¶å¤±æ•ˆå¯¼è‡´é…ç½®ä¸æ›´æ–°
   - å®¢æˆ·ç«¯å®šæ—¶æ‹‰å–ä¼šä¸ŠæŠ¥æœ¬åœ°ç‰ˆæœ¬ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¯¹äºå®šæ—¶æ‹‰å–çš„æ“ä½œï¼ŒæœåŠ¡ç«¯éƒ½ä¼šè¿”å› 304 - Not Modified
   - å®šæ—¶é¢‘ç‡é»˜è®¤ä¸ºæ¯ 5 åˆ†é’Ÿæ‹‰å–ä¸€æ¬¡ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥é€šè¿‡åœ¨è¿è¡Œæ—¶æŒ‡å®š System Property:Â `apollo.refreshInterval` æ¥è¦†ç›–ï¼Œå•ä½ä¸ºåˆ†é’Ÿã€‚

3. å®¢æˆ·ç«¯ä» Apollo é…ç½®ä¸­å¿ƒæœåŠ¡ç«¯è·å–åˆ°åº”ç”¨çš„æœ€æ–°é…ç½®åï¼Œä¼šä¿å­˜åœ¨å†…å­˜ä¸­
4. å®¢æˆ·ç«¯ä¼šæŠŠä»æœåŠ¡ç«¯è·å–åˆ°çš„é…ç½®åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ä¸€ä»½

   - åœ¨é‡åˆ°æœåŠ¡ä¸å¯ç”¨ï¼Œæˆ–ç½‘ç»œä¸é€šçš„æ—¶å€™ï¼Œä¾ç„¶èƒ½ä»æœ¬åœ°æ¢å¤é…ç½®

5. åº”ç”¨ç¨‹åºå¯ä»¥ä» Apollo å®¢æˆ·ç«¯è·å–æœ€æ–°çš„é…ç½®ã€è®¢é˜…é…ç½®æ›´æ–°é€šçŸ¥

### 4.6.1 é…ç½®æ›´æ–°æ¨é€å®ç°

å‰é¢æåˆ°äº† Apollo å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¿æŒäº†ä¸€ä¸ªé•¿è¿æ¥ï¼Œä»è€Œèƒ½ç¬¬ä¸€æ—¶é—´è·å¾—é…ç½®æ›´æ–°çš„æ¨é€ã€‚

é•¿è¿æ¥å®é™…ä¸Šæˆ‘ä»¬æ˜¯é€šè¿‡ Http Long Polling å®ç°çš„ï¼Œå…·ä½“è€Œè¨€ï¼š

- å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ª Http è¯·æ±‚åˆ°æœåŠ¡ç«¯
- æœåŠ¡ç«¯ä¼šä¿æŒä½è¿™ä¸ªè¿æ¥ 30 ç§’
- å¦‚æœåœ¨ 30 ç§’å†…æœ‰å®¢æˆ·ç«¯å…³å¿ƒçš„é…ç½®å˜åŒ–ï¼Œè¢«ä¿æŒä½çš„å®¢æˆ·ç«¯è¯·æ±‚ä¼šç«‹å³è¿”å›ï¼Œå¹¶å‘ŠçŸ¥å®¢æˆ·ç«¯æœ‰é…ç½®å˜åŒ–çš„ namespace ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯ä¼šæ®æ­¤æ‹‰å–å¯¹åº” namespace çš„æœ€æ–°é…ç½®
- å¦‚æœåœ¨ 30 ç§’å†…æ²¡æœ‰å®¢æˆ·ç«¯å…³å¿ƒçš„é…ç½®å˜åŒ–ï¼Œé‚£ä¹ˆä¼šè¿”å› Http çŠ¶æ€ç  304 ç»™å®¢æˆ·ç«¯
- å®¢æˆ·ç«¯åœ¨æœåŠ¡ç«¯è¯·æ±‚è¿”å›åä¼šè‡ªåŠ¨é‡è¿

è€ƒè™‘åˆ°ä¼šæœ‰æ•°ä¸‡å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ·é•¿è¿ï¼Œåœ¨æœåŠ¡ç«¯æˆ‘ä»¬ä½¿ç”¨äº† async servlet(Spring DeferredResult) æ¥æœåŠ¡ Http Long Polling è¯·æ±‚ã€‚

## 4.7 å¯ç”¨æ€§è€ƒè™‘

é…ç½®ä¸­å¿ƒä½œä¸ºåŸºç¡€æœåŠ¡ï¼Œå¯ç”¨æ€§è¦æ±‚éå¸¸é«˜ï¼Œä¸‹é¢çš„è¡¨æ ¼æè¿°äº†ä¸åŒåœºæ™¯ä¸‹ Apollo çš„å¯ç”¨æ€§ï¼š

| åœºæ™¯                     | å½±å“                                  | é™çº§                                  | åŸå›                                                                                        |
| :----------------------- | :------------------------------------ | :------------------------------------ | :----------------------------------------------------------------------------------------- |
| æŸå° config service ä¸‹çº¿ | æ— å½±å“                                | Â                                      | Config service æ— çŠ¶æ€ï¼Œå®¢æˆ·ç«¯é‡è¿å…¶å®ƒ config service                                       |
| æ‰€æœ‰ config service ä¸‹çº¿ | å®¢æˆ·ç«¯æ— æ³•è¯»å–æœ€æ–°é…ç½®ï¼ŒPortal æ— å½±å“ | å®¢æˆ·ç«¯é‡å¯æ—¶,å¯ä»¥è¯»å–æœ¬åœ°ç¼“å­˜é…ç½®æ–‡ä»¶ | Â                                                                                           |
| æŸå° admin service ä¸‹çº¿  | æ— å½±å“                                | Â                                      | Admin service æ— çŠ¶æ€ï¼ŒPortal é‡è¿å…¶å®ƒ admin service                                        |
| æ‰€æœ‰ admin service ä¸‹çº¿  | å®¢æˆ·ç«¯æ— å½±å“ï¼Œportal æ— æ³•æ›´æ–°é…ç½®     | Â                                      | Â                                                                                           |
| æŸå° portal ä¸‹çº¿         | æ— å½±å“                                | Â                                      | Portal åŸŸåé€šè¿‡ slb ç»‘å®šå¤šå°æœåŠ¡å™¨ï¼Œé‡è¯•åæŒ‡å‘å¯ç”¨çš„æœåŠ¡å™¨                                 |
| å…¨éƒ¨ portal ä¸‹çº¿         | å®¢æˆ·ç«¯æ— å½±å“ï¼Œportal æ— æ³•æ›´æ–°é…ç½®     | Â                                      | Â                                                                                           |
| æŸä¸ªæ•°æ®ä¸­å¿ƒä¸‹çº¿         | æ— å½±å“                                | Â                                      | å¤šæ•°æ®ä¸­å¿ƒéƒ¨ç½²ï¼Œæ•°æ®å®Œå…¨åŒæ­¥ï¼ŒMeta Server/Portal åŸŸåé€šè¿‡ slb è‡ªåŠ¨åˆ‡æ¢åˆ°å…¶å®ƒå­˜æ´»çš„æ•°æ®ä¸­å¿ƒ |

# 5ã€Contribute to Apollo

Apollo ä»å¼€å‘ä¹‹åˆå°±æ˜¯ä»¥å¼€æºæ¨¡å¼å¼€å‘çš„ï¼Œæ‰€ä»¥ä¹Ÿéå¸¸æ¬¢è¿æœ‰å…´è¶£ã€æœ‰ä½™åŠ›çš„æœ‹å‹ä¸€èµ·åŠ å…¥è¿›æ¥ã€‚

æœåŠ¡ç«¯å¼€å‘ä½¿ç”¨çš„æ˜¯ Javaï¼ŒåŸºäº Spring Cloud å’Œ Spring Boot æ¡†æ¶ã€‚å®¢æˆ·ç«¯ç›®å‰æä¾›äº† Java å’Œ.Net ä¸¤ç§å®ç°ã€‚

## [æ—¥å¿—ç¼–ç è§„èŒƒï¼šç¼–å†™é«˜æ•ˆå¯ç»´æŠ¤çš„æ—¥å¿—ä»£ç ](https://blog.dong4j.site/posts/b3fe09a9.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

> ç°æœ‰æ¶æ„æ—¥å¿—å­˜åœ¨çš„é—®é¢˜

1. å…³é”®é€»è¾‘æ— æ—¥å¿—åŸ‹ç‚¹
2. æ—¥å¿—çº§åˆ«è§„èŒƒ
3. ç”Ÿäº§ç¯å¢ƒæ—¥å¿—çº§åˆ«ä¸æ­£ç¡®, ä¸è§„èŒƒ
4. æ—¥å¿—é…ç½®ä¸ç»Ÿä¸€
5. æ—¥å¿—æ¡†æ¶ä¸ç»Ÿä¸€
6. æ—¥å¿—æ‰“è¯­å¥ä¸è§„èŒƒ

å› æ­¤é’ˆå¯¹ä»¥ä¸Šé—®é¢˜, å¯¹æ•´ä¸ªé¡¹ç›®ä¸­çš„æ—¥å¿—è¿›è¡Œè§„èŒƒç®¡ç†

## ç»Ÿä¸€æ—¥å¿—é…ç½®

æ–°æ¡†æ¶ä¸­ç»Ÿä¸€ä½¿ç”¨ `log4j2` æ—¥å¿—æ¡†æ¶æ¥è¿›è¡Œæ—¥å¿—ç®¡ç†

å…·æœ‰çš„åŠŸèƒ½:

1. æ ¹æ®ä¸åŒçš„ç¯å¢ƒè¾“å‡ºä¸åŒçš„æ—¥å¿—çº§åˆ«
   1. å¼€å‘ç¯å¢ƒ, è¾“å‡ºç­‰çº§ä¸º debug
   2. æµ‹è¯•å’Œç”Ÿæˆç¯å¢ƒ, è¾“å‡ºç­‰çº§ä¸º info
2. å¼€å‘ç¯å¢ƒ, åªè¾“å‡ºåˆ° console
3. æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒ, è¾“å‡ºåˆ° /usr/logs/app_name/port/all.log, å…³é—­ console è¾“å‡º
4. æŒ‰å¤©å‹ç¼©æ—¥å¿—
5. è‡ªåŠ¨åˆ é™¤ 30 å¤©ä»¥å‰çš„æ—¥å¿—
6. ç»Ÿä¸€è¾“å‡ºæ ¼å¼
7. åŠ¨æ€ä¿®æ”¹æ—¥å¿—ç­‰çº§

## ç°æœ‰æ—¥å¿—ä¿®æ”¹

ç°åœ¨çš„ä»£ç æš‚æ—¶ä¸èƒ½å…¨éƒ¨è¿ç§»åˆ°æ–°æ¡†æ¶, è€ƒè™‘åˆ°ç°åœ¨å„ä¸ªæ¨¡å—ä½¿ç”¨çš„æ—¥å¿—é…ç½®ä¸ç»Ÿä¸€, æ—¥å¿—é…ç½®ä¸åˆç†, è¿™é‡Œè§„èŒƒä¸€ä¸‹æ—¥å¿—ç›¸å…³çš„é…ç½®

### ç»Ÿä¸€é…ç½®æ ¼å¼

ç”±äºè€é¡¹ç›®ä¸­ä¸€éƒ¨åˆ†ä½¿ç”¨ log4j, å¦ä¸€éƒ¨åˆ†åˆä½¿ç”¨äº† log4j2 æ—¥å¿—æ¡†æ¶,  
é…ç½®æ–‡ä»¶ä¸€éƒ¨åˆ†æ˜¯ xml, å¦ä¸€éƒ¨åˆ†åˆæ˜¯ properties.

ä¸ºäº†ä»¥åè¿ç§»æ–¹ä¾¿, è¿™é‡Œç»Ÿä¸€å…¨éƒ¨æ”¹æˆ xml çš„é…ç½®å½¢å¼.

æ—¥å¿—æ¡†æ¶æš‚æ—¶ä¸éœ€è¦æ”¹åŠ¨, å› ä¸ºéœ€è¦æ”¹åŠ¨çš„ä¾èµ–å¤ªå¤š, å› æ­¤è¿™é‡Œä¼šåˆ† log4j.xml å’Œ log4j2.xml 2 ç§é…ç½®åˆ†åˆ«è¯´æ˜.

å·²ä¿®æ”¹çš„æ—¥å¿—é…ç½®çš„æ¨¡å—æœ‰:

| æ¨¡å—å            | åŸæ—¥å¿—é…ç½®       | ç°æ—¥å¿—é…ç½® |
| ----------------- | ---------------- | ---------- |
| migu-game-service | log4j2.xml       | log4j2.xml |
| callout-tool      | log4j.xml        | log4j.xml  |
| redis-cache       | log4j.properties | log4j.xml  |
| IavpProxy         | log4j.properties | log4j.xml  |
| async-tool        | log4j.xml        | log4j.xml  |

log4j.xml å’Œ log4j2.xml çš„é…ç½®æ–¹å¼ä¸ç›¸åŒ, å¯ä»¥å‚è€ƒå·²ä¿®æ”¹çš„é…ç½®å°†è¿˜æœªä¿®æ”¹çš„æ¨¡å—ä¿®æ”¹.

### ç»Ÿä¸€è¾“å‡ºæ ¼å¼

log4j.xml é…ç½®

```xml
<param name="ConversionPattern" value="%d{yyyy-MM-dd HH:mm:ss.SSS} [%5p] - [%t] %c :: %m%n"/>
```

log4j2.xml é…ç½®

```xml
<Property name="FILE_LOG_PATTERN">%date{yyyy-MM-dd HH:mm:ss.SSS} ${LOG_LEVEL_PATTERN} - [%t] %c{1.} :: %m%n
```

å¤§æ¦‚æ˜¯è¿™ä¸ªæ ·å­

```java
2018-08-21 17:12:10.651 [ INFO] - [main] com.xxxx.msearch.toolsframework.main.Main :: å¼€å§‹è¯»å–é…ç½®æ–‡ä»¶
2018-08-21 17:12:11.276 [ INFO] - [main] com.xxxx.msearch.toolsframework.main.Main :: org.quartz.threadPool.class=org.quartz.simpl.SimpleThreadPool
2018-08-21 17:12:11.277 [ INFO] - [main] com.xxxx.msearch.toolsframework.main.Main :: org.quartz.threadPool.threadCount=2
2018-08-21 17:12:11.277 [ INFO] - [main] com.xxxx.msearch.toolsframework.main.Main :: org.quartz.threadPool.threadPriority=5
```

> æ—¥å¿—å¿…é¡»æ˜¾ç¤º `æ—¥å¿—ç­‰çº§`, æ—¶é—´ç²¾ç¡®åˆ°æ¯«ç§’

ä»¥å‰ä¹Ÿè¯´è¿‡, æ˜¾ç¤ºæ—¥å¿—ç­‰çº§,å¯ä»¥é…åˆæ’ä»¶æ¥é«˜äº®ä¸åŒæ—¥å¿—ç­‰çº§, è¿˜å¯ä»¥è®¾ç½®å£°éŸ³æç¤º.  
æ˜¾ç¤ºæ—¥å¿—ç­‰çº§ä¹Ÿæœ‰åˆ©äºåœ¨ç°ç½‘æœç´¢ç‰¹å®šçº§åˆ«çš„æ—¥å¿—.

ä»¥åç›´æ¥ç»™è¿ç»´è¯´éœ€è¦æŸæ®µæ—¶é—´ç‰¹å®šç­‰çº§æˆ–å…³é”®å­—çš„æ—¥å¿—, è¦æ˜¯è¿ç»´ç›´æ¥æ‰”å…¨éƒ¨çš„æ—¥å¿—è¿‡æ¥, éº»çƒ¦æŠŠä¸‹é¢çš„è„šæœ¬å‘ç»™ä»–

```shell
# sed -n '/å¼€å§‹æ—¶é—´/,/ç»“æŸæ—¶é—´/p' all.log |grep 'å…³é”®å­—' | > snippet.log
sed -n '/2018-08-21 16:27:57.569/,/2018-08-21 16:36:14.604/p' all.log |grep 'INFO' | > snippet.log
```

## ç»Ÿä¸€è¾“å‡ºè·¯å¾„

å…·ä½“é…ç½®éœ€è¦æŸ¥çœ‹å·²ä¿®æ”¹çš„æ¨¡å—

log4j.xml

```xml
<param name="File" value="/usr/logs/callout-tool/all.log" />
```

log4j2.xml

```xml
<property name="LOG_DEFAULT_FOLDER">/usr/logs</property>
```

æµ‹è¯•ç¯å¢ƒå’Œç”Ÿæˆç¯å¢ƒæ—¥å¿—é…ç½®ç»Ÿä¸€è¾“å‡ºåˆ°æ–‡ä»¶, ä¸”æ–‡ä»¶ç»Ÿä¸€ä¿å­˜åœ¨ä¸€ä¸ªæ—¥å¿—ç›®å½•ä¸‹

ä»¥å‰çš„æ–¹å¼æ˜¯å°†æ—¥å¿—ä¿å­˜åœ¨ tomcat çš„ log ç›®å½•ä¸‹æˆ–è€…é€šè¿‡ JVM å¯åŠ¨çš„æ—¥å¿—ä¿å­˜åœ¨å¯åŠ¨ç›®å½•ä¸‹  
è¿™æ ·ä¸å¥½ç»Ÿä¸€ç®¡ç†æ—¥å¿—, æ¯æ¬¡æŸ¥çœ‹æ—¥å¿—æ—¶, è¿˜å¾—è®°ä½å“ªä¸ª tomcat ä¸‹æ˜¯å“ªä¸ªåº”ç”¨.  
å› æ­¤è€ƒè™‘å°†æ—¥å¿—å…¨éƒ¨ç»Ÿä¸€ç®¡ç†åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹, é€šè¿‡åº”ç”¨ååŒºåˆ†æ—¥å¿—.

> 1.åº”ç”¨åé…ç½®ä½¿ç”¨ '-' åˆ†éš”, å…¨éƒ¨é‡‡ç”¨å°å†™

ä¸è¦ç”¨å¤§å†™, linux ä¸‹è¿˜å¾—æŒ‰ä¸ªå¤§å°å†™åˆ‡æ¢é”®, éº»çƒ¦

```java
async-tool
iavp-proxy
migu-game-service
redis-cache
service-meeting
```

**è¯·æŒ‰ç…§ä¸Šé¢çš„å‘½åæ–¹å¼å‘½ååº”ç”¨å**

> 2.æœ¬åœ°å¼€å‘æ—¶éœ€è¦ä¿®æ”¹ä¸ºè‡ªå·±ç”µè„‘çš„ä¸€ä¸ªä¿å­˜è·¯å¾„

log4j.xml

```xml
<param name="File" value="ä½ çš„æœ¬æœºè·¯å¾„/åº”ç”¨å/all.log" />
```

log4j2.xml

```xml
<property name="LOG_DEFAULT_FOLDER">ä½ çš„æœ¬æœºè·¯å¾„</property>
```

æ–°æ¡†æ¶ä¸­ä¸éœ€è¦è¿™æ ·ä¿®æ”¹, èƒ½æ ¹æ®ä¸åŒçš„ç¯å¢ƒé€‰æ‹©è¾“å‡ºè·¯å¾„;

å·²ä¿®æ”¹çš„æ¨¡å—æ—¥å¿—é…ç½®é»˜è®¤å…¨éƒ¨è¾“å‡ºåˆ° `/usr/logs/` ç›®å½•ä¸‹, å¦‚æœæ˜¯æœ¬åœ°å¼€å‘æ—¶, æ²¡æœ‰è¿™ä¸ªç›®å½•è‚¯å®šä¼šæŠ¥é”™. å› æ­¤éœ€è¦ä¿®æ”¹ä¸ºä½ æœ¬åœ°çš„ä¸€ä¸ªç›®å½•

**å¦‚æœæ˜¯ windows, è·¯å¾„éœ€è¦è½¬ä¹‰**

æ¯”å¦‚æˆ‘ä¼šå»ºç«‹ä¸€ä¸ªä¸“é—¨çš„æ—¥å¿—ç›®å½•, å°†æ‰€æœ‰çš„è½¯ä»¶æ—¥å¿—, å¼€å‘æ—¥å¿—éƒ½è¾“å‡ºåˆ°è¿™ä¸ªç›®å½•ä¸‹, èƒ½æ–¹ä¾¿çš„ç®¡ç†æ—¥å¿—

![20241229154732_GNaVfMic.webp](https://cdn.dong4j.site/source/image/20241229154732_GNaVfMic.webp)

æ¨èå¤§å®¶ä¹Ÿé‡‡ç”¨è¿™ç§æ–¹å¼

> 3.æœ¬åœ°å¼€å‘æ—¶, éœ€è¦ä¿®æ”¹æ—¥å¿—ç­‰çº§

ç°åœ¨çš„æ—¥å¿—é…ç½®é’ˆå¯¹ 2 ç§ç¯å¢ƒ

**æœ¬åœ°å¼€å‘ç¯å¢ƒ**

æœ¬åœ°å¼€å‘æ—¶, éœ€è¦æŸ¥çœ‹ DEBUG ä¿¡æ¯, ä¸”åªç”¨è¾“å‡ºåˆ° console

**ç°ç½‘ç¯å¢ƒ**

ç°ç½‘éƒ¨ç½²æ—¶, æœ€ä½æ—¥å¿—ç­‰çº§ä¸º INFO å°±å¥½, ä¸éœ€è¦è¾“å‡º debug çº§åˆ«æ—¥å¿—, ä¸”åªéœ€è¦è¾“å‡ºåˆ°æ–‡ä»¶

log4j.xml

```xml
<log4j:configuration>

    <!-- æ—¥å¿—è¾“å‡ºåˆ°æ§åˆ¶å° -->
    <appender name="console" class="org.apache.log4j.ConsoleAppender">
        <!-- æ—¥å¿—è¾“å‡ºæ ¼å¼ -->
        <layout class="org.apache.log4j.PatternLayout">
            <param name="ConversionPattern" value="%d{yyyy-MM-dd HH:mm:ss.SSS} [%5p] - [%t] %c :: %m%n"/>
        </layout>

        <!--è¿‡æ»¤å™¨è®¾ç½®è¾“å‡ºçš„çº§åˆ«-->
        <filter class="org.apache.log4j.varia.LevelRangeFilter">
            <!-- è®¾ç½®æ—¥å¿—è¾“å‡ºçš„æœ€å°çº§åˆ« æœ¬åœ°å¼€å‘æ—¶ è®¾ç½®ä¸º DEBUG, é»˜è®¤ä¸º INFO-->
            <param name="levelMin" value="INFO"/>
            <!-- è®¾ç½®æ—¥å¿—è¾“å‡ºçš„æœ€å¤§çº§åˆ« -->
            <param name="levelMax" value="ERROR"/>
        </filter>
    </appender>

    ...

    <!-- è‡ªå®šä¹‰ç¬¬ä¸‰æ–¹ç±»çš„æ—¥å¿—ç­‰çº§, æ·»åŠ ä¸éœ€è¦è¾“å‡ºçš„æ—¥å¿— -->
    <log name="org.apache.zookeeper.ClientCnxn">
        <level value="ERROR"/>
    </log>
    <!-- æœ¬åœ°å¼€å‘æ—¶, ä¿®æ”¹ä¸º DEBUG é»˜è®¤ä¸º INFO -->
    <log name="com.xxx">
        <level value ="INFO"/>
    </log>

    <!-- æ ¹logçš„è®¾ç½®ï¼Œè‹¥ä»£ç ä¸­æœªæ‰¾åˆ°æŒ‡å®šçš„logï¼Œåˆ™ä¼šæ ¹æ®ç»§æ‰¿æœºåˆ¶ï¼Œä½¿ç”¨æ ¹log-->
    <root>
        <appender-ref ref="console"/>
        <!-- æœ¬åœ°å¼€å‘æ—¶, ä¸éœ€è¦è¾“å‡ºåˆ°æ–‡ä»¶ -->
        <!-- <appender-ref ref="dailyRollingAppender"/> -->
    </root>

</log4j:configuration>
```

log4j2.xml

```xml
<!-- å¯¹åŒ…è¿›è¡Œæ›´è¯¦ç»†çš„é…ç½® -->
<Asynclog name="com.xxx" level="INFO">
    <!-- å¼€å‘æ—¶, æ³¨é‡Šæ‰ RollingFile , åªéœ€è¦è¾“å‡ºåˆ° Console, ä¸”ä¿®æ”¹ä¸º DEBUG çº§åˆ« -->
    <appender-ref ref="Console"/>
    <appender-ref ref="RollingFile"/>
</Asynclog>

<asyncRoot level="INFO">
    <!-- å„åº”ç”¨è‡ªè¡Œè°ƒæ•´ï¼Œæ—¥å¿—è¾“å‡ºè‡³æ–‡ä»¶ï¼Œè‡ªåŠ¨æŒ‰æ—¶é—´ã€æŒ‰æ–‡ä»¶å¤§å°è¿›è¡Œå½’æ¡£ ,ç”Ÿäº§ç¯å¢ƒè°ƒé»˜è®¤ä¸ºINFO -->
    <appender-ref level="INFO" ref="RollingFile"/>
    <!-- æ—¥å¿—è¾“å‡ºè‡³Consoleï¼Œä»…åœ¨IDEå¼€å‘æ—¶æ‰“å¼€æ–¹ä¾¿å¼€å‘äººå‘˜ï¼Œéƒ¨ç½²åˆ°æœåŠ¡å™¨ä¹‹åå¿…é¡»ç½®ä¸ºOFFï¼Œlevelè®¾ç½®ä¸ºOFFè¡¨ç¤ºç¦ç”¨Consoleæ§åˆ¶å°æ—¥å¿—è¾“å‡º -->
    <appender-ref level="INFO" ref="Console"/>
</asyncRoot>
```

ä»¥ä¸Šéœ€è¦ä¿®æ”¹çš„é…ç½®, åœ¨æ–°æ¡†æ¶ä¸­éƒ½ä¸éœ€è¦æ‰‹åŠ¨ä¿®æ”¹

### æ—¥å¿—é…ç½®ä¿®æ”¹æ–¹å¼

å…¶ä»–æœªä¿®æ”¹çš„æ¨¡å—, åªéœ€è¦å‚è€ƒå·²ä¿®æ”¹çš„æ¨¡å—é…ç½®, ç›´æ¥æ‹·è´å, éœ€è¦ä¿®æ”¹çš„åœ°æ–¹:

1. åº”ç”¨å
2. æ—¥å¿—è¾“å‡ºè·¯å¾„, ç»Ÿä¸€ä¸º /usr/logs/åº”ç”¨å
3. start.sh

start.sh ä¸­ä¼šæ ¹æ® properties ä¸­çš„æ—¥å¿—é…ç½®ä¿å­˜æ—¥å¿—æ–‡ä»¶, è¿™é‡Œç»Ÿä¸€å, ä¸ä½¿ç”¨è¿™ç§æ–¹å¼, å°†æ—¥å¿—ç›¸å…³é…ç½®å…¨éƒ¨è¿ç§»åˆ° log4j.xml/log4j2.xml ä¸­, å› æ­¤éœ€è¦æ³¨é‡Šæ‰ start.sh å¯¹æ—¥å¿—çš„ç›¸å…³é…ç½®, å…·ä½“å¯å‚è€ƒå·²ä¿®æ”¹çš„æ¨¡å—

## æ—¥å¿—æœ€ä½³å®è·µ

ç°æœ‰ä»£ç å­˜åœ¨çš„æœ€å¤§é—®é¢˜å°±æ˜¯æ’æŸ¥é—®é¢˜æ—¶, æ²¡æœ‰æ—¥å¿—å¯çœ‹, ä¸å¾—ä¸åŠ å…¥æ—¥å¿—åå†éƒ¨ç½²å†çœ‹é—®é¢˜, è¿™æ ·å°±å¾ˆå°´å°¬

**åˆç†çš„æ—¥å¿—ç­‰çº§ä»¥åŠæ—¥å¿—åŸ‹ç‚¹èƒ½å¤Ÿå¿«é€Ÿå®šä½é—®é¢˜**

é’ˆå¯¹ç°åœ¨ä»£ç ä¸­å­˜åœ¨çš„é—®é¢˜å’Œä»¥åçš„è¿ç§»å·¥ä½œ, åœ¨åšéœ€æ±‚å¼€å‘æ—¶, å°½é‡æŒ‰ç…§ä»¥ä¸‹æ–¹å¼ä¿®æ”¹æ—¥å¿—ç›¸å…³çš„ä»£ç .

### åˆ é™¤ printStackTrace()

**åˆ é™¤æ‰€æœ‰çš„ printStackTrace() æ–¹æ³• , æ”¹ç”¨æ—¥å¿—è¾“å‡º**

e.printStackTrace ä¼šç›´æ¥è¾“å‡ºåˆ° System.err (å¦‚æœæ˜¯ tomcat éƒ¨ç½², å°±ä¼šè¾“å‡ºåˆ° catalina.out)

æˆ‘ä»¬çš„æ‰€æœ‰æ—¥å¿—é…ç½®å…¨éƒ¨é€šè¿‡ log4j.xml æˆ–è€… log4j2.xml æ§åˆ¶,

```java
try {
	// do something
} catch (Exception e) {
   // todo åˆ é™¤ printStackTrace(), æ”¹ç”¨ log.error è¾“å‡º
	e.printStackTrace();
}
```

### ä½¿ç”¨ slf4j api

### æ­£ç¡®ä½¿ç”¨ error æ—¥å¿—çº§åˆ«

```java
public void error(String msg, Throwable t);
```

é”™è¯¯çš„åšæ³•:

```java
# æ¡†æ¶ä¼šå‘ç°æœ€åä¸€ä¸ªå‚æ•°æ˜¯å¤šä½™çš„ï¼Œå¹¶æŸ¥çœ‹å…¶æ˜¯å¦æ˜¯ä¸€ä¸ªå¼‚å¸¸å¯¹è±¡ï¼Œå¦‚æœæ˜¯åˆ™è¾“å‡ºå †æ ˆï¼Œå¦åˆ™å¿½ç•¥
log.error("Failed to format {}", s, e);
```

### ä½¿ç”¨ å ä½ç¬¦ ä»£æ›¿ è¿æ¥ç¬¦, æé«˜æ•ˆç‡

```java
log.info("è§£æé”™è¯¯,é”™è¯¯ç :" + status);
```

æ›¿æ¢ä¸º

```java
log.info("è§£æé”™è¯¯,é”™è¯¯ç : {}", status);
```

## åŸºæœ¬çš„æ—¥å¿—ç¼–ç è§„èŒƒ

> ä»¥ä¸‹æ˜¯è§„èŒƒçš„æ—¥å¿—å†™æ³•, å¸Œæœ›ä»¥åå¼€å‘æ—¶, æ³¨æ„ä»¥ä¸‹å‡ ç‚¹

1. è·å– log, æ—¥å¿—å¯¹è±¡åç»Ÿä¸€ä½¿ç”¨ **log**  
   å¦‚æœæœ‰çˆ¶ç±», ç»Ÿä¸€åœ¨çˆ¶ç±»ä¸­è·å– log

```java
protected log log = logFactory.getlog(getClass());
```

    å¦‚æœæ²¡æœ‰çˆ¶ç±», åœ¨å½“å‰ç±»ä¸­è·å– log

```java
private static final log log = logFactory.getlog(ç±»å.class);
```

å¯ä»¥ä½¿ç”¨ live templates å¿«é€Ÿè¾“å…¥, éœ€è¦è‡ªå·±è®¾ç½®

![20241229154732_orhs0nZm.webp](https://cdn.dong4j.site/source/image/20241229154732_orhs0nZm.webp)

ä»¥ä¸Šæ–¹å¼æ˜¯æ²¡æœ‰ä½¿ç”¨ lombok æ’ä»¶çš„æƒ…å†µ, å¦‚æœä½¿ç”¨, ç›´æ¥åœ¨ç±»ä¸ŠåŠ  `@Slf4j` å³å¯, ç„¶åä½¿ç”¨ `log` å¯¹è±¡æ‰“å°æ—¥å¿—

> å¦‚æœä½¿ç”¨æ–°æ¡†æ¶, å¯ä»¥ä½¿ç”¨ `Logs` å·¥å…·ç±»æ‰“å°æ—¥å¿—

2. è¾“å‡º Exceptions çš„å…¨éƒ¨ Throwable ä¿¡æ¯ï¼Œå› ä¸º log.error(msg) å’Œ log.error(msg,e.getMessage()) è¿™æ ·çš„æ—¥å¿—è¾“å‡ºæ–¹æ³•ä¼šä¸¢å¤±æ‰æœ€é‡è¦çš„ StackTrace ä¿¡æ¯ã€‚

```java
void foo(){
        try{
            // do something
        } catch (Exception e) {
            log.error(e.getMessage()); // é”™è¯¯
            log.error("Bad things", e.getMessage()); // é”™è¯¯
            log.error("Bad things", e); // æ­£ç¡®
            // error å…è®¸æ‹¼æ¥å­—ç¬¦ä¸², å› ä¸º error æ¯•ç«Ÿæ²¡æœ‰ info å’Œ debug å¤š, è€Œä¸”éœ€è¦è¾“å‡ºå‚æ•°ä¿¡æ¯æ—¶, ä¹Ÿåªæœ‰è¿™ç§æ–¹å¼
            log.error("Bad things " + user, e);
        }
}
```

3. **ä¸å…è®¸**è®°å½•æ—¥å¿—ååˆæŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸ºè¿™æ ·ä¼šå¤šæ¬¡è®°å½•æ—¥å¿—ï¼Œåªå…è®¸è®°å½•ä¸€æ¬¡æ—¥å¿—.

```java
void foo() throw LogException {
        try{
            // do something
        } catch (NoUserException e) {
             log.error("No user available", e);
             // è¿™é‡ŒæŠ›å‡ºå¼‚å¸¸å, ä¸Šçº§åˆä¼šå¤„ç†ä¸€æ¬¡å¼‚å¸¸
             throw new UserServiceException("Nouseravailable", e);
        }
}
```

4. **ä¸å…è®¸**å‡ºç° System print(åŒ…æ‹¬ System.out.println å’Œ System.error.println) è¯­å¥
5. **ä¸å…è®¸**å‡ºç° printStackTrace

```java
void foo() throw LogException {
        try{
            // do something
        } catch (NoUserException e) {
            e.printStackTrace(); // é”™è¯¯
            log.error("No user available", e);
        }
}
```

6. ä½¿ç”¨ slf4j ä»£æ›¿ log4j

   **slf4j ä¸­çš„å ä½ç¬¦â€”ä¸å†éœ€è¦å†—é•¿çš„çº§åˆ«åˆ¤æ–­**

   åœ¨ log4j ä¸­ï¼Œä¸ºäº†æé«˜è¿è¡Œæ•ˆç‡ï¼Œå¾€å¾€åœ¨è¾“å‡ºä¿¡æ¯ä¹‹å‰ï¼Œè¿˜è¦è¿›è¡Œçº§åˆ«åˆ¤æ–­ï¼Œä»¥é¿å…æ— æ•ˆçš„å­—ç¬¦ä¸²è¿æ¥æ“ä½œã€‚å¦‚ä¸‹ï¼š

```java
if (log.isDebugEnabled()){
        log.debug("debugï¼š" + name);
}
```

    slf4j å·§å¦™çš„è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼šå…ˆä¼ å…¥å¸¦æœ‰å ä½ç¬¦çš„å­—ç¬¦ä¸²ï¼ŒåŒæ—¶æŠŠå…¶ä»–å‚æ•°ä¼ å…¥ï¼Œåœ¨ slf4j çš„å†…å®¹éƒ¨å®ç°ä¸­ï¼Œå¦‚æœçº§åˆ«åˆé€‚å†å»ç”¨ä¼ å…¥çš„å‚æ•°å»æ›¿æ¢å­—ç¬¦ä¸²ä¸­çš„å ä½ç¬¦ï¼Œå¦åˆ™ä¸ç”¨æ‰§è¡Œã€‚

```java
log.info("{} is {}", new String[]{â€œx",â€œy"});
```

7. ä¸åœ¨å¾ªç¯ä¸­æ‰“å°æ—¥å¿—

```java
void read() {
        while (hasNext()) {
            try {
                readData();
            } catch {Exception e) {
                // this isnâ€™t recommend
                log.error("error reading data", e);
            }
        }
}
```

å¦‚æœ readData() æŠ›å‡ºå¼‚å¸¸å¹¶ä¸” hasNext() è¿”å› trueï¼Œè¿™æ®µä»£ç å°±ä¼šä¸åœåœ¨æ‰“å°æ—¥å¿—

```java
void read() {
        int exceptionsThrown = 0;
        while (hasNext()) {
            try {
                readData();
            } catch {Exception e) {
                    if (exceptionsThrown < THRESHOLD) {
                        log.error(â€œerror reading data", e);
                        exceptionsThrown++;
                    } else {
                        // Now the error wonâ€™t choke the system.
                    }
            }
        }
}
```

è¿˜æœ‰ä¸€ä¸ªæ–¹æ³•å°±æ˜¯æŠŠæ—¥å¿—æ“ä½œä»å¾ªç¯ä¸­å»æ‰ï¼Œåœ¨å¦å¤–çš„åœ°æ–¹è¿›è¡Œæ‰“å°ï¼Œåªè®°å½•ç¬¬ä¸€ä¸ªæˆ–è€…æœ€åä¸€ä¸ªå¼‚å¸¸å°±å¥½äº†

## [é¿å…è°ƒè¯•é™·é˜±ï¼šä¾èµ–æ—¥å¿—çš„ç¼–ç¨‹ä¹ æƒ¯](https://blog.dong4j.site/posts/286572f8.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

å¼€å‘ä¸­æ—¥å¿—è¿™ä¸ªé—®é¢˜ï¼Œæ¯ä¸ªå…¬å¸éƒ½å¼ºè°ƒï¼Œä¹Ÿåˆ¶å®šäº†ä¸€å¤§å †è§„èŒƒï¼Œä½†æ ¹æ®å®é™…æƒ…å†µçœ‹ï¼Œæ•ˆæœä¸æ˜¯å¾ˆæ˜æ˜¾ï¼Œä¸»è¦æ˜¯è¿™ä¸ªä¸œè¥¿ä¸å¥½æµ‹è¯•å’Œè€ƒæ ¸ï¼Œæ²¡æœ‰æ—¥å¿—åŠŸèƒ½ä¸€æ ·è·‘å•Šã€‚

ä½†æ˜¯æ²¡æœ‰æ—¥å¿—, ä¸€æ—¦ç³»ç»Ÿå‡ºç°é—®é¢˜, å°†å¯¼è‡´æ’æŸ¥é—®é¢˜æ—¶å›°éš¾é‡é‡.
å› æ­¤å¥½çš„æ—¥å¿—è¾“å‡ºæœ‰åˆ©äºå¿«é€Ÿå®šä½é—®é¢˜

ä½†æ˜¯æˆ‘ä»¬åœ¨ä»€ä¹ˆæ—¶å€™æ‰“å°æ—¥å¿—? éœ€è¦æ‰“å°ä»€ä¹ˆä¿¡æ¯? ç”¨ä»€ä¹ˆæ—¥å¿—çº§åˆ«?
è¿™äº›é—®é¢˜éƒ½å°†åº”ç”¨æˆ‘ä»¬æ’æŸ¥é—®é¢˜æ—¶çš„é€Ÿåº¦

å› æ­¤è¿™é‡Œåˆ¶å®šä¸€ä¸ªæ—¥å¿—è§„èŒƒ, å°†æ—¥å¿—ç›¸å…³çš„å¸¸è¯†æ€§é—®é¢˜åšä¸€ä¸ªæ€»ç»“.

<!-- more -->

## æ—¥å¿—ç­‰çº§è¯´æ˜

1. trace, debug: ç†è®ºä¸Š "ä¸å±äºé”™è¯¯", åªæ˜¯æ‰“å°ä¸€äº›çŠ¶æ€, æç¤ºä¿¡æ¯, ä»¥ä¾¿ `å¼€å‘è¿‡ç¨‹` ä¸­è§‚å¯Ÿ.
2. info: ç†è®ºä¸Š "ä¸å±äºé”™è¯¯", åªæ˜¯ä¸€äº›æç¤ºæ€§çš„ä¿¡æ¯, ä½†æ˜¯å³ä½¿åœ¨å¼€å‘å®Œæˆ, æ­£å¼ä¸Šçº¿çš„ç³»ç»Ÿä¸­, ä¹Ÿæœ‰ä¿ç•™çš„ä»·å€¼.
3. warn: å±äºè½»å¾®çš„ "è­¦å‘Š", ç¨‹åºä¸­å‡ºç°äº†ä¸€äº›å¼‚å¸¸æƒ…å†µ, ä½†æ˜¯å½±å“ä¸å¤§, è¿˜å¯ä»¥æ­£å¸¸ä½¿ç”¨.
4. error: å±äº "æ™®é€šçš„é”™è¯¯", åœ¨ç¨‹åºå¯ä»¥æ§åˆ¶çš„èŒƒå›´å†…, ä¸ä¼šé€ æˆè¿é”å½±å“æˆ–å·¨å¤§å½±å“.
5. fatal: å±äº "è‡´å‘½é”™è¯¯", å¯å¯¼è‡´æ•´ä¸ªç³»ç»Ÿæˆ–è€…ä¸€ç³»åˆ—åŠŸèƒ½æ— æ³•ä½¿ç”¨, ç”šè‡³å¯¼è‡´ç³»ç»Ÿç˜«ç—ª, å…³é—­.

## è§„èŒƒ

> 1. æ—¥å¿—å¿…é¡»æ˜¾ç¤º `æ—¥å¿—ç­‰çº§`, æ—¶é—´ç²¾ç¡®åˆ°æ¯«ç§’

ä»¥å‰ä¹Ÿè¯´è¿‡, æ˜¾ç¤ºæ—¥å¿—ç­‰çº§, å¯ä»¥é…åˆæ’ä»¶æ¥é«˜äº®ä¸åŒæ—¥å¿—ç­‰çº§, è¿˜å¯ä»¥è®¾ç½®å£°éŸ³æç¤º.
æ˜¾ç¤ºæ—¥å¿—ç­‰çº§ä¹Ÿæœ‰åˆ©äºåœ¨ç°ç½‘æœç´¢ç‰¹å®šçº§åˆ«çš„æ—¥å¿—.

ä»¥ä¸‹æ˜¯åˆ©ç”¨ `Grep Console` æ’ä»¶æ˜¾ç¤ºçš„æ•ˆæœ, èƒ½åŒºåˆ†ä¸åŒçš„æ—¥å¿—ç­‰çº§

ç”¨ä»¥ä¸‹å‘½ä»¤è·å–æŸæ®µæ—¶é—´ç‰¹å®šç­‰çº§æˆ–å…³é”®å­—çš„æ—¥å¿—

```bash
# sed -n '/å¼€å§‹æ—¶é—´/,/ç»“æŸæ—¶é—´/p' all.log | grep 'å…³é”®å­—' | > snippet.log
sed -n '/2018-08-21 16:27:57.569/,/2018-08-21 16:36:14.604/p' all.log | grep 'INFO' | > snippet.log
```

> 2. ä¿®æ”¹ï¼ˆåŒ…æ‹¬æ–°å¢ï¼‰æ“ä½œå¿…é¡»æ‰“å°æ—¥å¿—

å¤§éƒ¨åˆ†é—®é¢˜éƒ½æ˜¯ä¿®æ”¹å¯¼è‡´çš„ã€‚æ•°æ®ä¿®æ”¹å¿…é¡»æœ‰æ®å¯æŸ¥

> 3. æ¡ä»¶åˆ†æ”¯å¿…é¡»æ‰“å°æ¡ä»¶å€¼ï¼Œé‡è¦å‚æ•°å¿…é¡»æ‰“å°

å°¤å…¶æ˜¯åˆ†æ”¯æ¡ä»¶çš„å‚æ•°ï¼Œæ‰“å°åå°±ä¸ç”¨åˆ†æå’ŒçŒœæµ‹èµ°é‚£ä¸ªåˆ†æ”¯äº†ï¼Œå¾ˆé‡è¦ï¼å¦‚ä¸‹é¢ä»£ç é‡Œé¢çš„ messageTypeï¼Œä¸€å®šè¦æ‰“å°å€¼ï¼Œå› ä¸ºä»–å†³å®šäº†ä»£ç èµ°é‚£ä¸ªåˆ†æ”¯

```java
/**
 * Instance rocket mq handler.
 * æ ¹æ®æ¶ˆæ¯ç±»å‹é€‰æ‹©å¤„ç†å™¨å¤„ç†æ¶ˆæ¯
 *
 * @param messageType the message type
 * @return the rocket mq handler
 */
@Override
public MessageHandler instance(String messageType) {
    Class<? extends MessageHandler> cls = null;
    log.info("message type = {}", messageType);
    switch (MessageType.valueOf(messageType)) {
        case BUSINESS_LOG:
            cls = BusinessLogHandler.class;
            break;
        case WORD_ANALYSIS:
            cls = WordAnalysisHandler.class;
            break;
        default:
            log.error("Unknown MessageType, messageType = {} ", messageType);
            break;
    }
    return SpringContext.getInstance(cls);
}
```

> 4. æ•°æ®é‡å¤§çš„æ—¶å€™éœ€è¦æ‰“å°æ•°æ®é‡

å‰åæ‰“å°æ—¥å¿—å’Œæœ€åçš„æ•°æ®é‡ï¼Œä¸»è¦ç”¨äºåˆ†ææ€§èƒ½ï¼Œèƒ½ä»æ—¥å¿—ä¸­çŸ¥é“æŸ¥è¯¢äº†å¤šå°‘æ•°æ®ç”¨äº†å¤šä¹….
è‡ªå·±è§†æƒ…å†µè€Œå†³å®šæ˜¯å¦æ‰“å°ï¼Œæˆ‘ä¸€èˆ¬å»ºè®®æ‰“å°.

> 5. ä¸è¦ä½¿ç”¨ System.out.println() æ¥è®°å½•æ—¥å¿—

ä½¿ç”¨ System.out.println() ä¸ä¼šè¾“å‡ºåˆ°æ—¥å¿—æ–‡ä»¶.

æœ¬åœ°å¼€å‘æ—¶, è§‰å¾—æ–¹ä¾¿å°±ç›´æ¥ä½¿ç”¨ System.out.println()è¾“å‡º, æœ¬åœ°æ˜¯çœ‹å¾—åˆ°ä¿¡æ¯, ä½†æ˜¯ä¸€åˆ°çº¿ä¸Šç¯å¢ƒ, æ—¥å¿—å…¨éƒ¨è¾“å‡ºåˆ°æ–‡ä»¶ä¸­, ä½¿ç”¨ System.out.println()
è¾“å‡ºçš„ä¿¡æ¯å°±å…¨éƒ¨æ²¡æœ‰äº†.

System.out.println() ä¸€èˆ¬æ˜¯å¼€å‘æ—¶è¾“å‡ºä¸é‡è¦çš„ä¿¡æ¯, å»ºè®®ä½¿ç”¨ log.debug ä»£æ›¿.

ä½¿ç”¨ lombok, åº”è¯¥æ¯” System.out.println() æ›´æ–¹ä¾¿å§!

## å»ºè®®

æ—¥å¿—è¿™ä¸ªä¸œè¥¿ï¼Œæ›´å¤šæ˜¯é è‡ªè§‰ï¼Œé¡¹ç›®ç»„è¿™ä¹ˆå¤šäººï¼Œä¸å¯èƒ½ä¸€ä¸ªä¸€ä¸ªçœ‹ä»£ç ï¼Œç„¶ååŠ æ—¥å¿—.
æ‰“å°æ—¥å¿—æ›´å¤šçš„æ˜¯ä¸€ç§ä¹ æƒ¯, éœ€è¦æœ‰æ„è¯†çš„å»åŸ¹å…»è¿™ç§ä¹ æƒ¯.

1. ä¸è¦ä¾èµ– debugï¼Œå¤šä¾èµ–æ—¥å¿—ã€‚

åˆ«äººé¢å¯¹å¯¹è±¡ç¼–ç¨‹ï¼Œä½ é¢å¯¹ debug ç¼–ç¨‹. æœ‰äº›äººæ— è®ºä»€ä¹ˆè¯­è¨€ï¼Œæœ€åéƒ½å˜æˆäº†é¢å¯¹ debug ç¼–ç¨‹....
è¿™ä¸ªä¹ æƒ¯éå¸¸éå¸¸ä¸å¥½ï¼debug ä¼šè®©ä½ å†™ä»£ç çš„æ—¶å€™å·æ‡’ä¸æ‰“æ—¥å¿—ï¼Œè€Œä¸”å¾ˆæµªè´¹æ—¶é—´. æ”¹æ‰è¿™ä¸ªæ¶ä¹ .

åªæœ‰åœ¨å¿…è¦çš„æƒ…å†µä¸‹æ‰ä¼š debug, æ›´å¤šçš„æ˜¯é€šè¿‡æ—¥å¿—æ¥åˆ†ææµç¨‹, å› ä¸ºåœ¨ç”Ÿäº§ç¯å¢ƒ, å°¤å…¶æ˜¯ç°å…¬å¸çš„ç”Ÿäº§ç¯å¢ƒ, è¿œç¨‹ debug æ˜¯ä¸å¯èƒ½çš„, åªèƒ½ä¾èµ–æ—¥å¿—.

ä»£ç å¼€å‘æµ‹è¯•å®Œæˆä¹‹åä¸è¦æ€¥ç€æäº¤ï¼Œå…ˆè·‘ä¸€éçœ‹çœ‹æ—¥å¿—æ˜¯å¦çœ‹å¾—æ‡‚.
æ—¥å¿—æ˜¯ç»™äººçœ‹çš„ï¼Œåªè¦çƒ­çˆ±ç¼–ç¨‹çš„äººæ‰èƒ½æˆä¸ºåˆæ ¼ç¨‹åºå‘˜, ä¸è¦åŒ†åŒ†å¿™å¿™å†™å®ŒåŠŸèƒ½æµ‹è¯• ok å°±æäº¤ä»£ç ï¼Œæ—¥å¿—ä¹Ÿæ˜¯åŠŸèƒ½çš„ä¸€éƒ¨åˆ†. è¦æœ‰ç²¾ç›Šæ±‚ç²¾çš„å·¥åŒ ç²¾ç¥ï¼

## æ—¥å¿—æœ€ä½³å®è·µ

ç°æœ‰ä»£ç å­˜åœ¨çš„æœ€å¤§é—®é¢˜å°±æ˜¯æ’æŸ¥é—®é¢˜æ—¶, æ²¡æœ‰æ—¥å¿—å¯çœ‹, ä¸å¾—ä¸åŠ å…¥æ—¥å¿—åå†éƒ¨ç½²å†çœ‹é—®é¢˜, è¿™æ ·å°±å¾ˆå°´å°¬

**åˆç†çš„æ—¥å¿—ç­‰çº§ä»¥åŠæ—¥å¿—åŸ‹ç‚¹èƒ½å¤Ÿå¿«é€Ÿå®šä½é—®é¢˜**

é’ˆå¯¹ç°åœ¨ä»£ç ä¸­å­˜åœ¨çš„é—®é¢˜å’Œä»¥åçš„è¿ç§»å·¥ä½œ, åœ¨åšéœ€æ±‚å¼€å‘æ—¶, å°½é‡æŒ‰ç…§ä»¥ä¸‹æ–¹å¼ä¿®æ”¹æ—¥å¿—ç›¸å…³çš„ä»£ç .

### åˆ é™¤ printStackTrace()

**åˆ é™¤æ‰€æœ‰çš„ printStackTrace() æ–¹æ³• , æ”¹ç”¨æ—¥å¿—è¾“å‡º**

e.printStackTrace ä¼šç›´æ¥è¾“å‡ºåˆ° System.err (å¦‚æœæ˜¯ tomcat éƒ¨ç½², å°±ä¼šè¾“å‡ºåˆ° catalina.out)

æˆ‘ä»¬çš„æ‰€æœ‰æ—¥å¿—é…ç½®å…¨éƒ¨é€šè¿‡ log4j.xml æˆ–è€… log4j2.xml æ§åˆ¶,

```java
try {
	// do something
} catch (Exception e) {
   // todo åˆ é™¤ printStackTrace(), æ”¹ç”¨ log.error è¾“å‡º
	e.printStackTrace();
}
```

### ä½¿ç”¨ slf4j api

### æ­£ç¡®ä½¿ç”¨ error æ—¥å¿—çº§åˆ«

```java
public void error(String msg, Throwable t);
```

é”™è¯¯çš„åšæ³•:

```java
# æ¡†æ¶ä¼šå‘ç°æœ€åä¸€ä¸ªå‚æ•°æ˜¯å¤šä½™çš„ï¼Œå¹¶æŸ¥çœ‹å…¶æ˜¯å¦æ˜¯ä¸€ä¸ªå¼‚å¸¸å¯¹è±¡ï¼Œå¦‚æœæ˜¯åˆ™è¾“å‡ºå †æ ˆï¼Œå¦åˆ™å¿½ç•¥
log.error("Failed to format {}", s, e);
```

### ä½¿ç”¨ å ä½ç¬¦ ä»£æ›¿ è¿æ¥ç¬¦, æé«˜æ•ˆç‡

```java
log.info("è§£æé”™è¯¯,é”™è¯¯ç :" + status);
```

æ›¿æ¢ä¸º

```java
log.info("è§£æé”™è¯¯,é”™è¯¯ç : {}", status);
```

## åŸºæœ¬çš„æ—¥å¿—ç¼–ç è§„èŒƒ

> ä»¥ä¸‹æ˜¯è§„èŒƒçš„æ—¥å¿—å†™æ³•, å¸Œæœ›ä»¥åå¼€å‘æ—¶, æ³¨æ„ä»¥ä¸‹å‡ ç‚¹

1. è·å– log, æ—¥å¿—å¯¹è±¡åç»Ÿä¸€ä½¿ç”¨ **log**
   å¦‚æœæœ‰çˆ¶ç±», ç»Ÿä¸€åœ¨çˆ¶ç±»ä¸­è·å– log

   ```java
   protected log log = logFactory.getlog(getClass());
   ```

   å¦‚æœæ²¡æœ‰çˆ¶ç±», åœ¨å½“å‰ç±»ä¸­è·å– log

   ```java
   private static final log log = logFactory.getlog(ç±»å.class);
   ```

   å¯ä»¥ä½¿ç”¨ live templates å¿«é€Ÿè¾“å…¥, éœ€è¦è‡ªå·±è®¾ç½®

   ä»¥ä¸Šæ–¹å¼æ˜¯æ²¡æœ‰ä½¿ç”¨ lombok æ’ä»¶çš„æƒ…å†µ, å¦‚æœä½¿ç”¨, ç›´æ¥åœ¨ç±»ä¸ŠåŠ  `@Slf4j` å³å¯, ç„¶åä½¿ç”¨ `log` å¯¹è±¡æ‰“å°æ—¥å¿—

   > å¦‚æœä½¿ç”¨æ–°æ¡†æ¶, å¯ä»¥ä½¿ç”¨ `Logs` å·¥å…·ç±»æ‰“å°æ—¥å¿—

2. è¾“å‡º Exceptions çš„å…¨éƒ¨ Throwable ä¿¡æ¯ï¼Œå› ä¸º log.error(msg) å’Œ log.error(msg,e.getMessage()) è¿™æ ·çš„æ—¥å¿—è¾“å‡ºæ–¹æ³•ä¼šä¸¢å¤±æ‰æœ€é‡è¦çš„ StackTrace
   ä¿¡æ¯ã€‚

   ```java
   void foo(){
       try{
           // do something
       } catch (Exception e) {
           log.error(e.getMessage()); // é”™è¯¯
           log.error("Bad things", e.getMessage()); // é”™è¯¯
           log.error("Bad things", e); // æ­£ç¡®
           // error å…è®¸æ‹¼æ¥å­—ç¬¦ä¸², å› ä¸º error æ¯•ç«Ÿæ²¡æœ‰ info å’Œ debug å¤š, è€Œä¸”éœ€è¦è¾“å‡ºå‚æ•°ä¿¡æ¯æ—¶, ä¹Ÿåªæœ‰è¿™ç§æ–¹å¼
           log.error("Bad things " + user, e);
       }
   }
   ```

3. **ä¸å…è®¸** è®°å½•æ—¥å¿—ååˆæŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸ºè¿™æ ·ä¼šå¤šæ¬¡è®°å½•æ—¥å¿—ï¼Œåªå…è®¸è®°å½•ä¸€æ¬¡æ—¥å¿—.

   ```java
   void foo() throw LogException {
       try{
           // do something
       } catch (NoUserException e) {
            log.error("No user available", e);
            // è¿™é‡ŒæŠ›å‡ºå¼‚å¸¸å, ä¸Šçº§åˆä¼šå¤„ç†ä¸€æ¬¡å¼‚å¸¸
            throw new UserServiceException("Nouseravailable", e);
       }
   }
   ```

4. **ä¸å…è®¸** å‡ºç° System print(åŒ…æ‹¬ System.out.println å’Œ System.error.println) è¯­å¥
5. **ä¸å…è®¸** å‡ºç° printStackTrace

   ```java
   void foo() throw LogException {
       try{
           // do something
       } catch (NoUserException e) {
           e.printStackTrace(); // é”™è¯¯
           log.error("No user available", e);
       }
   }
   ```

6. ä½¿ç”¨ slf4j ä»£æ›¿ log4j

   **slf4j ä¸­çš„å ä½ç¬¦â€”ä¸å†éœ€è¦å†—é•¿çš„çº§åˆ«åˆ¤æ–­**

   åœ¨ log4j ä¸­ï¼Œä¸ºäº†æé«˜è¿è¡Œæ•ˆç‡ï¼Œå¾€å¾€åœ¨è¾“å‡ºä¿¡æ¯ä¹‹å‰ï¼Œè¿˜è¦è¿›è¡Œçº§åˆ«åˆ¤æ–­ï¼Œä»¥é¿å…æ— æ•ˆçš„å­—ç¬¦ä¸²è¿æ¥æ“ä½œã€‚å¦‚ä¸‹ï¼š

   ```java
   if (log.isDebugEnabled()){
       log.debug("debugï¼š" + name);
   }
   ```

   slf4j å·§å¦™çš„è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼šå…ˆä¼ å…¥å¸¦æœ‰å ä½ç¬¦çš„å­—ç¬¦ä¸²ï¼ŒåŒæ—¶æŠŠå…¶ä»–å‚æ•°ä¼ å…¥ï¼Œåœ¨ slf4j çš„å†…å®¹éƒ¨å®ç°ä¸­ï¼Œå¦‚æœçº§åˆ«åˆé€‚å†å»ç”¨ä¼ å…¥çš„å‚æ•°å»æ›¿æ¢å­—ç¬¦ä¸²ä¸­çš„å ä½ç¬¦ï¼Œå¦åˆ™ä¸ç”¨æ‰§è¡Œã€‚

   ```java
   log.info("{} is {}", new String[]{â€œx",â€œy"});
   ```

7. ä¸åœ¨å¾ªç¯ä¸­æ‰“å°æ—¥å¿—

   ```java
   void read() {
       while (hasNext()) {
           try {
               readData();
           } catch {Exception e) {
               // this isnâ€™t recommend
               log.error("error reading data", e);
           }
       }
   }
   ```

   å¦‚æœ readData()æŠ›å‡ºå¼‚å¸¸å¹¶ä¸” hasNext() è¿”å› trueï¼Œè¿™æ®µä»£ç å°±ä¼šä¸åœåœ¨æ‰“å°æ—¥å¿—

   ```java
   void read() {
       int exceptionsThrown = 0;
       while (hasNext()) {
           try {
               readData();
           } catch {Exception e) {
                   if (exceptionsThrown < THRESHOLD) {
                       log.error(â€œerror reading data", e);
                       exceptionsThrown++;
                   } else {
                       // Now the error wonâ€™t choke the system.
                   }
           }
       }
   }
   ```

   è¿˜æœ‰ä¸€ä¸ªæ–¹æ³•å°±æ˜¯æŠŠæ—¥å¿—æ“ä½œä»å¾ªç¯ä¸­å»æ‰ï¼Œåœ¨å¦å¤–çš„åœ°æ–¹è¿›è¡Œæ‰“å°ï¼Œåªè®°å½•ç¬¬ä¸€ä¸ªæˆ–è€…æœ€åä¸€ä¸ªå¼‚å¸¸å°±å¥½äº†

## æ—¥å¿—è¿½è¸ªç³»ç»Ÿ

ä»…ä»…ä¾èµ–ä»¥ä¸Šæ—¥å¿—è§„èŒƒåªèƒ½åšåˆ°å•ä¸ªåº”ç”¨çš„æ—¥å¿—è§„èŒƒè®°å½•, ä½†æ˜¯è¿™äº›åˆ†æ•£çš„æ•°æ®å¯¹äºé—®é¢˜æ’æŸ¥ï¼Œæˆ–æ˜¯æµç¨‹ä¼˜åŒ–éƒ½
å¸®åŠ©æœ‰é™.

å¯¹äºä¸€ä¸ªè·¨è¿›ç¨‹ / è·¨çº¿ç¨‹çš„åœºæ™¯, æ±‡æ€»æ”¶é›†å¹¶åˆ†ææµ·é‡æ—¥å¿—å°±æ˜¾å¾—å°¤ä¸ºé‡è¦.
è¦èƒ½åšåˆ°è¿½è¸ªæ¯ä¸ªè¯·æ±‚çš„å®Œæ•´è°ƒç”¨é“¾è·¯, æ”¶é›†è°ƒç”¨é“¾è·¯ä¸Šæ¯ä¸ªæœåŠ¡çš„æ€§èƒ½æ•°æ®, è®¡ç®—æ€§èƒ½æ•°æ®å’Œæ¯”å¯¹æ€§èƒ½æŒ‡æ ‡ç­‰èƒ½æœ‰æ•ˆæ’æŸ¥é—®é¢˜, åˆ†æç³»ç»Ÿç“¶é¢ˆ.
æœ€åè¿˜èƒ½å¯¹æ—¥å¿—è¿›è¡Œå¤§æ•°æ®åˆ†æ, å¸¦æ¥æ›´é«˜çš„åˆ©æ¶¦.

å› æ­¤ä»¥åä¼šè€ƒè™‘åšæ—¥å¿—è¿½æº¯ç³»ç»Ÿ

è¿™é‡Œæœ‰ä¸€ç¯‡ä»¥å‰å†™çš„ [æ—¥å¿—è¿½è¸ªç³»ç»Ÿè®¾è®¡](/nodes/log-trace-design.md) å’Œ [æ—¥å¿—è¿½è¸ªç³»ç»Ÿå®ç°](/nodes/log-trace-implement.md)

## [SSOå•ç‚¹ç™»å½•ä¼˜åŒ–ï¼šShiroè®¤è¯è¿‡ç¨‹è¯¦è§£ä¸ä»£ç å°è£…æŠ€å·§](https://blog.dong4j.site/posts/205ef910.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

å¤šä¸ªæ¨¡å—æœ‰ç™»å½•éœ€æ±‚, ä½†æ˜¯ä»£ç éƒ½æ˜¯ç›¸äº’æ‹·è´, æ²¡æœ‰åšç»Ÿä¸€å¤„ç†

## ä¼˜åŒ–æ–¹æ¡ˆ

å°†ç™»å½•é€»è¾‘å°è£…æˆæ¨¡å—, ä½œä¸ºæ’ä»¶æä¾›æœåŠ¡

## shiro è®¤è¯è¿‡ç¨‹

### 1. æ”¶é›†å®ä½“/å‡­æ®ä¿¡æ¯

```java
UsernamePasswordToken token = new UsernamePasswordToken(username, password, true);
```

UsernamePasswordToken æ”¯æŒæœ€å¸¸è§çš„ç”¨æˆ·å/å¯†ç çš„è®¤è¯æœºåˆ¶ã€‚åŒæ—¶ï¼Œç”±äºå®ƒå®ç°äº† Rarraydsj@163.comemberMeAuthenticationToken æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¤ç‰Œè®¾ç½®â€œè®°ä½æˆ‘â€çš„åŠŸèƒ½ã€‚  
ä½†æ˜¯ï¼Œâ€œå·²è®°ä½â€å’Œâ€œå·²è®¤è¯â€æ˜¯æœ‰åŒºåˆ«çš„ï¼š  
 å·²è®°ä½çš„ç”¨æˆ·ä»…ä»…æ˜¯éåŒ¿åç”¨æˆ·ï¼Œä½ å¯ä»¥é€šè¿‡ subject.getPrincipals() è·å–ç”¨æˆ·ä¿¡æ¯ã€‚ä½†æ˜¯å®ƒå¹¶éæ˜¯è®¤è¯é€šè¿‡çš„ç”¨æˆ·ï¼Œå½“ä½ è®¿é—®éœ€è¦è®¤è¯ç”¨æˆ·çš„åŠŸèƒ½æ—¶ï¼Œä½ ä»ç„¶éœ€è¦é‡æ–°æäº¤è®¤è¯ä¿¡æ¯ã€‚  
 è¿™ä¸€åŒºåˆ«å¯ä»¥å‚è€ƒæ·˜å®ç½‘ç«™ï¼Œç½‘ç«™ä¼šé»˜è®¤è®°ä½ç™»å½•çš„ç”¨æˆ·ï¼Œå†æ¬¡è®¿é—®ç½‘ç«™æ—¶ï¼Œå¯¹äºéæ•æ„Ÿçš„é¡µé¢åŠŸèƒ½ï¼Œé¡µé¢ä¸Šä¼šæ˜¾ç¤ºè®°ä½çš„ç”¨æˆ·ä¿¡æ¯ï¼Œä½†æ˜¯å½“ä½ è®¿é—®ç½‘ç«™è´¦æˆ·ä¿¡æ¯æ—¶ä»ç„¶éœ€è¦å†æ¬¡è¿›è¡Œç™»å½•è®¤è¯

### 2. æäº¤å®ä½“/å‡­æ®æ¶ˆæ¯

```java
SecurityUtils.getSubject().login(token);
```

### 3. è®¤è¯

å¦‚æœè‡ªå®šä¹‰ Realm å®ç°, ä½†æ‰§è¡Œç¬¬äºŒæ­¥ä¸­çš„ login() æ—¶, ä¼šå›è°ƒ `doGetAuthenticationInfo()`

```java
protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authcToken) throws AuthenticationException {
	// è·å–åŸºäºç”¨æˆ·åå’Œå¯†ç çš„ä»¤ç‰Œ
	// å®é™…ä¸Šè¿™ä¸ª token æ˜¯ä» LoginController é‡Œé¢ SecurityUtils.getSubject().login(token) ä¼ è¿‡æ¥çš„
	UsernamePasswordToken token = (UsernamePasswordToken) authcToken;
	String username = token.getUsername();
	if (!StringUtils.isEmpty(username)) {
		// ä»æ•°æ®åº“ä¸­æŸ¥è¯¢ç”¨æˆ·ç”¨ä¿¡æ¯
		LoginModel model = authorityService.getLoginModel(username);
		// åŸæ¥æ²¡æœ‰åˆ¤æ–­ model æ˜¯å¦ä¸º null çš„è¯­å¥, ä¼šé€ æˆ model.getPassword() è¯­å¥ ç©ºæŒ‡é’ˆå¼‚å¸¸
		if(model != null){
			// æ­¤å¤„æ— éœ€æ¯”å¯¹,æ¯”å¯¹çš„é€»è¾‘ Shiro ä¼šåš, æˆ‘ä»¬åªéœ€è¿”å›ä¸€ä¸ªå’Œä»¤ç‰Œç›¸å…³çš„æ­£ç¡®çš„éªŒè¯ä¿¡æ¯
			return new SimpleAuthenticationInfo(StringUtils.upperCase(username), model.getPassword(), getName());
		}
	}
	return null;
}
```

### 4. è®¤è¯å¤„ç†

```java
try {
		SecurityUtils.getSubject().login(token);
} catch (AuthenticationException e) {
	model.addAttribute("message", "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯æˆ–ç”¨æˆ·å·²è¢«ç¦ç”¨");
	return "login";
}
```

å‘ç”Ÿå¼‚å¸¸æ—¶, ç»™å‡ºæç¤ºä¿¡æ¯, è¿”å›åˆ°ç™»å½•é¡µé¢

å¦‚æœ login æ–¹æ³•æ‰§è¡Œå®Œæ¯•ä¸”æ²¡æœ‰æŠ›å‡ºä»»ä½•å¼‚å¸¸ä¿¡æ¯ï¼Œé‚£ä¹ˆä¾¿è®¤ä¸ºç”¨æˆ·è®¤è¯é€šè¿‡ã€‚ä¹‹ååœ¨åº”ç”¨ç¨‹åºä»»æ„åœ°æ–¹è°ƒç”¨ SecurityUtils.getSubject() éƒ½å¯ä»¥è·å–åˆ°å½“å‰è®¤è¯é€šè¿‡çš„ç”¨æˆ·å®ä¾‹ï¼Œä½¿ç”¨ subject.isAuthenticated() åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²éªŒè¯éƒ½å°†è¿”å› true.  
ç›¸åï¼Œå¦‚æœ login æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆå°†è®¤ä¸ºè®¤è¯å¤±è´¥

### 4. ç™»å‡ºæ“ä½œ

ç™»å‡ºæ“ä½œå¯ä»¥é€šè¿‡è°ƒç”¨ subject.logout() æ¥åˆ é™¤ä½ çš„ç™»å½•ä¿¡æ¯ï¼Œå¦‚ï¼š

```
SecurityUtils.getSubject().logout();
```

### SimpleAuthenticationInfo

SimpleAuthenticationInfo è¿™é‡ŒåŸç†å¾ˆç®€å•ï¼Œåˆæœ‰ä¸€äº›å€¼å¾—æŒ–æ˜çš„ä¸œè¥¿ã€‚

```java
//æ­¤å¤„ä½¿ç”¨çš„æ˜¯userå¯¹è±¡ï¼Œä¸æ˜¯username
SimpleAuthenticationInfo authenticationInfo = new SimpleAuthenticationInfo(
        user,
        user.getPassword(),
        getName()
);
```

è¿™ä¸ªä¸œè¥¿æ˜¯åœ¨ realm ä¸­çš„ï¼Œç¬¬ä¸€ä¸ªå‚æ•° userï¼Œè¿™é‡Œå¥½å¤šåœ°æ–¹ä¼ çš„æ—¶å€™éƒ½æ˜¯ user å¯¹è±¡ï¼Œä½†æ˜¯éƒ½åœ¨å¤‡æ³¨ç”¨æˆ·åã€‚å¯æ˜¯æˆ‘å¦‚æœä¼ å…¥ usernameï¼Œå°±ä¼šæŠ¥ç±»å‹è½¬æ¢é—®é¢˜ã€‚

ä½†æ˜¯åœ¨å¼€æ¶›å¤§ç¥çš„åšå®¢ä¸­ï¼Œæ— çŠ¶æ€çš„ shiro é‡Œï¼Œé‚£è¾¹ç»™å‡ºçš„ä¾‹å­æ˜¯ä¼  usernameã€‚æˆ‘è‡ªå·±æµ‹è¯•çš„ï¼Œå¯ä»¥ä¼  usernameï¼Œä¹Ÿå¯ä»¥ä¼  user å¯¹è±¡ï¼Œä»…é™ä»–é‚£è¾¹ä¸€æ®µä»£ç ã€‚ç½‘ä¸Šæœ‰æ–‡ç« è¯´ï¼Œè¿™é‡Œå…¶å®æ˜¯ user å’Œ username çš„é›†åˆï¼Œåç«¯æ˜¯åˆ†ä¸¤ä¸ªå­—æ®µæ¥æ”¶çš„ã€‚ç”±äºæ—¶é—´çš„é—®é¢˜ï¼Œæ²¡æœ‰æ·±å…¥é‡Œäº†è§£è¿™å—ï¼Œä¼  user å¯¹è±¡æ˜¯ OK çš„ã€‚

ç¬¬äºŒä¸ªå­—æ®µæ˜¯ user.getPassword()ï¼Œæ³¨æ„è¿™é‡Œæ˜¯æŒ‡ä»æ•°æ®åº“ä¸­è·å–çš„ passwordã€‚

ç¬¬ä¸‰ä¸ªå­—æ®µæ˜¯ realmï¼Œå³å½“å‰ realm çš„åç§°ã€‚

çœ‹äº†å‡ ç¯‡æ–‡ç« ä»‹ç»è¯´ï¼Œè¿™å—å¯¹æ¯”é€»è¾‘æ˜¯å…ˆå¯¹æ¯” usernameï¼Œä½†æ˜¯ username è‚¯å®šæ˜¯ç›¸ç­‰çš„ï¼Œæ‰€ä»¥çœŸæ­£å¯¹æ¯”çš„æ˜¯ passwordã€‚ä»è¿™é‡Œä¼ å…¥çš„ passwordï¼ˆè¿™é‡Œæ˜¯ä»æ•°æ®åº“è·å–çš„ï¼‰å’Œ tokenï¼ˆfilter ä¸­ç™»å½•æ—¶ç”Ÿæˆçš„ï¼‰ä¸­çš„ password åšå¯¹æ¯”ï¼Œå¦‚æœç›¸åŒå°±å…è®¸ç™»å½•ï¼Œä¸ç›¸åŒå°±æŠ›å‡ºå¼‚å¸¸ã€‚

å¦‚æœéªŒè¯æˆåŠŸï¼Œæœ€ç»ˆè¿™é‡Œè¿”å›çš„ä¿¡æ¯ authenticationInfo çš„å€¼ä¸ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå­—æ®µçš„å€¼ç›¸åŒï¼ˆæˆ‘è¿™é‡Œä¼ çš„æ˜¯ user å¯¹è±¡ï¼‰ã€‚

## [ä»é›¶å¼€å§‹ï¼šlanproxyä¸nginxé…ç½®æ”»ç•¥](https://blog.dong4j.site/posts/81cae783.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

éœ€è¦çš„ç¯å¢ƒ:

1. å…·æœ‰å…¬ç½‘ IP çš„æœåŠ¡å™¨, è¿è¡Œ proxy-server
2. ä¸€å°å†…ç½‘ pc æˆ–æœåŠ¡å™¨, è¿è¡Œ proxy-client
3. lanproxy
4. nginx
5. JDK

## å‡†å¤‡å·¥ä½œ

ä½¿ç”¨ é˜¿é‡Œäº‘ æœåŠ¡å™¨, ip ä¸º `111.111.111.111`, å·²ç»å®‰è£…å¥½äº† nginx å’Œ JDK8

ä¸‹è½½ proxy-server å’Œ proxy-client

https://github.com/ffay/lanproxy/releases

ä¿®æ”¹ hosts æ–‡ä»¶

```
111.111.111.111 ivr.wechat.com
111.111.111.111 local.ivr.wechat.com
```

## proxy-server æ­å»º

1. è§£å‹ proxy-server.zip
2. ä¿®æ”¹é…ç½®æ–‡ä»¶ `conf/config.properties`, ä¿®æ”¹ç”¨æˆ·åå’Œå¯†ç 
3. å¯åŠ¨æœåŠ¡ `/usr/local/proxy-server/bin/startup.sh`

config.properties

```lua
server.bind=0.0.0.0
# æ™®é€šç«¯å£
server.port=4900

server.ssl.enable=true
server.ssl.bind=0.0.0.0
# ssl ç«¯å£
server.ssl.port=4993
server.ssl.jksPath=test.jks
server.ssl.keyStorePassword=123456
server.ssl.keyManagerPassword=123456
server.ssl.needsClientAuth=false

config.server.bind=0.0.0.0
# server åå°ç«¯å£
config.server.port=8090
# ç”¨æˆ·å
config.admin.username=admin
# å¯†ç 
config.admin.password=admin
```

4. ä½¿ç”¨ nginx åå‘ä»£ç†

è®¿é—® `http://ivr.wechat.com/` ä»£ç†åˆ° `http://127.0.0.1:8090`

```lua
server {
    listen 80;
    server_name ivr.wechat.com;
    charset utf-8;
    location / {
            proxy_set_header   Host             $host;
            proxy_set_header   X-Real-IP        $remote_addr;
            proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;
            client_max_body_size       1024m;
            client_body_buffer_size    128k;
            client_body_temp_path      data/client_body_temp;
            proxy_connect_timeout      90;
            proxy_send_timeout         90;
            proxy_read_timeout         90;
            proxy_buffer_size          4k;
            proxy_buffers              4 32k;
            proxy_busy_buffers_size    64k;
            proxy_temp_file_write_size 64k;
            proxy_temp_path            data/proxy_temp;
            proxy_pass http://127.0.0.1:8090;
    }
}
```

è®¿é—® http://ivr.wechat.com/

![20241229154732_eWVWuj5D.webp](https://cdn.dong4j.site/source/image/20241229154732_eWVWuj5D.webp)

## proxy-server é…ç½®

1. ç™»å½• proxy-serverï¼Œæ·»åŠ å®¢æˆ·ç«¯ï¼Œè¾“å…¥å®¢æˆ·ç«¯å¤‡æ³¨åç§°ï¼Œç”Ÿæˆéšæœºå¯†é’¥ï¼Œæäº¤æ·»åŠ 
   ![20241229154732_fr4EBIOa.webp](https://cdn.dong4j.site/source/image/20241229154732_fr4EBIOa.webp)

2. å®¢æˆ·ç«¯åˆ—è¡¨ä¸­ï¼Œé…ç½®ç®¡ç†ä¸­ï¼Œéƒ½ä¼šå‡ºç°æ–°æ·»åŠ çš„å®¢æˆ·ç«¯
   ![20241229154732_TQkmxEDb.webp](https://cdn.dong4j.site/source/image/20241229154732_TQkmxEDb.webp)

3. å•å‡»é…ç½®ç®¡ç†ä¸­çš„å®¢æˆ·ç«¯ï¼Œæ·»åŠ é…ç½®ï¼ˆæ¯ä¸ªå®¢æˆ·ç«¯å¯ä»¥æ·»åŠ å¤šä¸ªé…ç½®ï¼‰
   ![20241229154732_FnzKC41D.webp](https://cdn.dong4j.site/source/image/20241229154732_FnzKC41D.webp)

- ä»£ç†åç§°ï¼Œæ¨èè¾“å…¥å®¢æˆ·ç«¯è¦ä»£ç†å‡ºå»çš„ç«¯å£ï¼Œæˆ–è€…æ˜¯å®¢æˆ·ç«¯æƒ³è¦å‘å¸ƒåˆ°å…¬ç½‘çš„é¡¹ç›®åç§°
- å…¬ç½‘ç«¯å£ï¼Œå¡«å…¥ä¸€ä¸ªæœåŠ¡å™¨ç©ºé—²ç«¯å£ï¼Œç”¨æ¥è½¬å‘è¯·æ±‚ç»™å®¢æˆ·ç«¯
- ä»£ç† IP ç«¯å£ï¼Œå¡«å…¥å®¢æˆ·ç«¯ç«¯å£ï¼Œå…¬ç½‘ä¼šè½¬å‘è¯·æ±‚ç»™è¯¥å®¢æˆ·ç«¯ç«¯å£

## proxy-client æ­å»º

1. è§£å‹ proxy-client
2. ä¿®æ”¹é…ç½®æ–‡ä»¶

```lua
# ä¸åœ¨proxy-serveré…ç½®åå°åˆ›å»ºå®¢æˆ·ç«¯æ—¶å¡«å†™çš„ç§˜é’¥ä¿æŒä¸€è‡´
client.key=0b1bad2253f945a28a2ea7d3e8f35545
ssl.enable=true
ssl.jksPath=test.jks
ssl.keyStorePassword=123456
# è¿™é‡Œå¡«å†™å®é™…çš„proxy-serveråœ°å€ï¼›æ²¡æœ‰æœåŠ¡å™¨é»˜è®¤å³å¯ï¼Œè‡ªå·±æœ‰æœåŠ¡å™¨çš„æ›´æ¢ä¸ºè‡ªå·±çš„proxy-serverï¼ˆIPï¼‰åœ°å€
server.host=ivr.wechat.com
#default ssl port is 4993
#proxy-server sslé»˜è®¤ç«¯å£4993ï¼Œé»˜è®¤æ™®é€šç«¯å£4900
#ssl.enable=trueæ—¶è¿™é‡Œå¡«å†™sslç«¯å£ï¼Œssl.enable=falseæ—¶è¿™é‡Œå¡«å†™æ™®é€šç«¯å£
server.port=4993
```

1. æ‰§è¡Œ `bin/startup.sh` å¯åŠ¨ client

å¯åŠ¨æˆåŠŸå, ä¼šæ˜¾ç¤º `åœ¨çº¿` æ ‡è¯†
![20241229154732_reJKuvzx.webp](https://cdn.dong4j.site/source/image/20241229154732_reJKuvzx.webp)

æœ€åç›´æ¥è®¿é—® `http://ivr.wechat.com:50002` å°†ä¼šè½¬å‘è¯·æ±‚åˆ° 127.0.0.1:8080

## ä¼˜åŒ–

nginx å†æ·»åŠ ä¸€æ¬¡è½¬å‘

```lua
server {
    listen 80;
    server_name local.ivr.wechat.com;
    charset utf-8;
    location /{
        proxy_set_header   Host             $host;
        proxy_set_header   X-Real-IP        $remote_addr;
        proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;
        client_max_body_size       1024m;
        client_body_buffer_size    128k;
        client_body_temp_path      data/client_body_temp;
        proxy_connect_timeout      90;
        proxy_send_timeout         90;
        proxy_read_timeout         90;
        proxy_buffer_size          4k;
        proxy_buffers              4 32k;
        proxy_busy_buffers_size    64k;
        proxy_temp_file_write_size 64k;
        proxy_temp_path            data/proxy_temp;
        proxy_pass http://127.0.0.1:50002;
    }
}
```

ç›´æ¥è®¿é—® `http://local.ivr.wechat.com` å°†ä¼šè½¬å‘åˆ° proxy-server çš„ 50002 ç«¯å£, ç›¸å½“äºç›´æ¥è®¿é—® `http://ivr.wechat.com:50002`,
æœ€åä¼šè½¬å‘åˆ°å†…ç½‘çš„ `127.0.0.1:8080`

## [åŠ¨æ€è°ƒæ•´æ—¥å¿—ï¼šJMXä¸Zookeeperçš„å¼ºå¤§ç»„åˆ](https://blog.dong4j.site/posts/8872e19a.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})


## why

ä¸ºäº†å‡å°‘æ—¥å¿—æ–‡ä»¶çš„æ•°é‡, ç”Ÿäº§ç¯å¢ƒçš„æ—¥å¿—ç­‰çº§éƒ½æ˜¯ Error, ä½†æ˜¯å½“é‡åˆ°é—®é¢˜æ—¶, é”™è¯¯æ—¥å¿—å¯èƒ½ä¸èƒ½å¿«é€Ÿå‡†ç¡®çš„å®šä½å‡ºé”™çš„åœ°æ–¹, å¦‚æœèƒ½åœ¨ä¸é‡å¯åº”ç”¨çš„æƒ…å†µä¸‹,
ä¿®æ”¹æ—¥å¿—çº§åˆ«å¹¶ä¸”ç”Ÿæ•ˆ, èƒ½æ›´å¿«çš„å‘ç°å‡ºé”™çš„åœ°æ–¹.

## what

è¿™é‡Œé€‰æ‹©ä½¿ç”¨ JMX æ¥å®ç°æ—¥å¿—çº§åˆ«åŠ¨æ€ä¿®æ”¹.

JMX (Java Management Extensions) æ˜¯ç®¡ç† Java çš„ä¸€ç§æ‰©å±•. è¿™ç§æœºåˆ¶å¯ä»¥æ–¹ä¾¿çš„ç®¡ç†, ç›‘æ§æ­£åœ¨è¿è¡Œä¸­çš„ Java ç¨‹åº. å¸¸ç”¨äºç®¡ç†çº¿ç¨‹, å†…å­˜, æ—¥å¿—
Level, æœåŠ¡é‡å¯, ç³»ç»Ÿç¯å¢ƒç­‰.

å®ç°ä¸€ä¸ªè¢« JMX æ‰˜ç®¡çš„ MBean çš„æ–¹å¼:

1. MBean çš„æ¥å£å¿…é¡»ä»¥ MBean ç»“å°¾, æ¯”å¦‚ XxxxMBean
2. å®ç°å¿…é¡»ä»¥ Xxxx å‘½åå› ä¸ºæ¥å£å®šä¹‰æ˜¯ XxxxMBean

logback å®šä¹‰çš„ MBean

![20241229154732_UPs9YUUI.webp](https://cdn.dong4j.site/source/image/20241229154732_UPs9YUUI.webp)

jconsole æŸ¥çœ‹ MBean

![20241229154732_kefuJoBn.webp](https://cdn.dong4j.site/source/image/20241229154732_kefuJoBn.webp)

## how

åŠ¨æ€ä¿®æ”¹æ—¥å¿—çº§åˆ«çš„æ€è·¯:

![20241229154732_WaZ9o14Z.webp](https://cdn.dong4j.site/source/image/20241229154732_WaZ9o14Z.webp)

1. API è°ƒç”¨ DynamicChangeLogLevel ä¿®æ”¹æ—¥å¿—çº§åˆ«
2. DynamicChangeLogLevel é€šè¿‡ LogBackMBean ä¿®æ”¹æ—¥å¿—çº§åˆ«
3. ä½¿ç”¨è´£ä»»é“¾, ä¿®æ”¹ xxx-api å, åé¢ç›¸å…³çš„æœåŠ¡éƒ½ä¼šè¢«ä¿®æ”¹

### å­˜åœ¨çš„é—®é¢˜

**1. åœ¨é›†ç¾¤ç¯å¢ƒ, å› ä¸ºæœ‰è´Ÿå€ºå‡è¡¡, ä¸åŒçš„è¯·æ±‚è¢«è´Ÿè½½åˆ°ä¸åŒçš„æœºå™¨ä¸Šé¢, å‰é¢ä¿®æ”¹äº†æ—¥å¿—çº§åˆ«, ä¸‹ä¸€æ¬¡æœ‰å¯èƒ½ä¸ä¼šç”Ÿæ•ˆ**

![20241229154732_zSuSD7Y6.webp](https://cdn.dong4j.site/source/image/20241229154732_zSuSD7Y6.webp)

**2. ä¸èƒ½å•ç‹¬ä¿®æ”¹å…·ä½“åº”ç”¨çš„æ—¥å¿—çº§åˆ«**

### è§£å†³æ–¹æ¡ˆ

ä½¿ç”¨ Zookeeper Watcher.

1. æ¯ä¸ªåº”ç”¨çœ‹åšä¸€ä¸ªå•ç‹¬çš„èŠ‚ç‚¹, å¯åŠ¨çš„æ—¶å€™å‘ Zookeeper æ³¨å†Œä»¥é¡¹ç›®æœåŠ¡åå‘½åçš„èŠ‚ç‚¹, å¹¶æŠŠ logback.xml ä¸­è®¾ç½®çš„æ—¥å¿—çº§åˆ«å†™å…¥èŠ‚ç‚¹, æœ€åå¯¹è¿™ä¸ªèŠ‚ç‚¹ç›‘å¬.
2. API è°ƒç”¨æ—¶, ä¼ å…¥ applicationName å’Œ level, ä¿®æ”¹å…·ä½“èŠ‚ç‚¹ä¸‹çš„æ•°æ®
3. èŠ‚ç‚¹æ•°æ®è¢«ä¿®æ”¹, è§¦å‘ watcher, è°ƒç”¨ LogBackMBean ä¿®æ”¹æ—¥å¿—çº§åˆ«

å…·ä½“æµç¨‹å¦‚ä¸‹:

![20241229154732_pbG4MaHS.webp](https://cdn.dong4j.site/source/image/20241229154732_pbG4MaHS.webp)

### å…·ä½“æ­¥éª¤

1. ä¿®æ”¹ logback.xml é…ç½®, æ·»åŠ  `<jmxConfigurator />` å¼€å¯ JMX, æ·»åŠ  com.xxx çš„æ—¥å¿—çº§åˆ«

```xml
<jmxConfigurator />
...
<root level="ERROR">
	<appender-ref ref="FILE" />
</root>
<logger name="com.xxx" level="ERROR"/>
```

è®¾ç½®ä¸€ä¸ª `<logger name="com.xxx" level="ERROR"/>` çš„åŸå› åœ¨äº, å½“éœ€è¦æŸ¥æ‰¾æ‰§è¡Œæµç¨‹æ—¶, åªéœ€è¦å°† com.xxx è®¾ç½®ä¸º INFO,
è¿™æ ·åªä¼šè¾“å‡º `com.xxx` åŒ…åŠå­åŒ…ä¸­çš„ INFO ä¿¡æ¯.
å¦‚æœæ²¡æœ‰ `com.xxx`, æˆ‘ä»¬åªæœ‰è®¾ç½® ROOT ä¸º INFO, è¿™æ ·ä¼šè¾“å‡ºè¯¸å¦‚ dubbo, zookeeper ç­‰ç¬¬ä¸‰æ–¹åŒ…ä¸­çš„æ‰€æœ‰ INFO ä¿¡æ¯.

2. æ·»åŠ ä¸€ä¸ª `ServerListener`, ä¸€æ˜¯è§£å†³ [åŠ¨æ€ä¿®æ”¹æ—¥å¿—çº§åˆ«æ—¶å†…å­˜æº¢å‡º](https://logback.qos.ch/manual/jmxConfig.html), äºŒæ˜¯åº”ç”¨å¯åŠ¨å®Œæˆåå‘
   Zookeeper åˆ›å»ºèŠ‚ç‚¹

```java
public class ServerListener implements ServletContextListener {
	private final Logger log = LoggerFactory.getLogger(this.getClass());

	public void contextDestroyed(ServletContextEvent contextEvent) {
	    // é˜²æ­¢åŠ¨æ€ä¿®æ”¹æ—¥å¿—çº§åˆ«æ—¶å†…å­˜æº¢å‡º
        LoggerContext loggerContext = (LoggerContext) LoggerFactory.getILoggerFactory();
        loggerContext.stop();
	}

	public void contextInitialized(ServletContextEvent contextEvent) {
        String applicationName = contextEvent.getServletContext().getServletContextName();
        log.info("=================================");
        log.info("system [{}] start finish!!!", applicationName);
        log.info("=================================");
        log.info("servlet path [{}]", System.getProperty(contextEvent.getServletContext().getServletContextName()));

        log.info("create zookeeper node start");
        String host = "127.0.0.1:2181";
        String defaultLogLevel = DynamicChangeLogLevel.getCurrentlyLevel(new LogNode());
        new LogNodeOperation(host, applicationName, defaultLogLevel);
	}
}
```

3. å®ç° ChangeLogLevel API

### éƒ¨ç½²é—®é¢˜

å› ä¸º MBean æ˜¯é€šè¿‡ ObjectName æ¥è·å–å¯¹è±¡, logback çš„é»˜è®¤ OBjectName
ä¸º `ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator`

å½“åœ¨åŒä¸€ä¸ª Tomcat ä¸­éƒ¨ç½²å¤šä¸ªåº”ç”¨æ—¶, æ¯ä¸ª Web åº”ç”¨ç¨‹åºä¸­çš„è®°å½•å™¨ä¸Šä¸‹æ–‡ç›¸å…³è”çš„å„ç§å®ä¾‹å°†ä¼šç›¸äº’å†²çª

**è§£å†³æ–¹æ³•**

åœ¨ logback.xml è®¾ç½® contextName

```xml
<configuration>
    <!-- è®¾ç½®åˆ«å å¿…é¡»åœ¨ <jmxConfigurator/> ä¹‹å‰è®¾ç½® -->
    <contextName>${project.artifactId}</contextName>
    <!--JMX ç›‘æ§ -->
    <jmxConfigurator />
    ...
 </configuration>
```

![20241229154732_vmTKfeym.webp](https://cdn.dong4j.site/source/image/20241229154732_vmTKfeym.webp)

è¿™æ ·å°±èƒ½åŒºåˆ†ä¸åŒçš„åº”ç”¨

![20241229154732_30Clgp3H.webp](https://cdn.dong4j.site/source/image/20241229154732_30Clgp3H.webp)

# æ–°éœ€æ±‚

è¦æ˜ç¡®ä¸åŒæœåŠ¡å™¨ä¸Šçš„ä¸åŒåº”ç”¨, èƒ½å…·ä½“ä¿®æ”¹æŸä¸€å°æœåŠ¡å™¨ä¸Šçš„æŸä¸€ä¸ªåº”ç”¨çš„æ—¥å¿—çº§åˆ«

## [Spring AOP åŠ¨æ€ä»£ç†æ·±åº¦è§£æï¼šLTW æŠ€æœ¯æ­ç§˜](https://blog.dong4j.site/posts/95aea2e1.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})


ä»£ç ç»‡å…¥å®ç°æ–¹å¼:

1. é™æ€ä»£ç†
   1. AspectJ ç»‡å…¥å™¨ weaver)
      1. compile-time weaving ä½¿ç”¨ aspectj ç¼–è¯‘å™¨è¿›è¡Œç¼–è¯‘æºç 
      2. post-compile weaving å¯¹ class æ–‡ä»¶è¿›è¡Œç»‡å…¥
      3. load-time weaving(LTW) å½“ class loader åŠ è½½ç±»çš„æ—¶å€™ï¼Œè¿›è¡Œç»‡å…¥
2. åŠ¨æ€ä»£ç†
   1. JDK åŠ¨æ€ä»£ç† (æ¥å£)
   2. CGlib(ç±»)

è¿™é‡Œä½¿ç”¨ [AspectJ LTW](http://www.eclipse.org/aspectj/doc/next/devguide/ltw-configuration.html) å®ç°, è¿™ç§æ–¹å¼åœ¨ç±»åŠ è½½å™¨ç»‡å…¥ä»£ç .

- **ç¼–è¯‘å™¨ç»‡å…¥** ä¼šé€ æˆç¼–è¯‘é€Ÿåº¦å˜æ…¢, è€Œä¸”å¿…é¡»ä½¿ç”¨ ajc ç¼–è¯‘å™¨
- **åŠ¨æ€ä»£ç†** ä¼šç”Ÿæˆå¤§é‡ä»£ç†ç±», åŠ é€Ÿå†…å­˜æ¶ˆè€—

å› æ­¤ä½¿ç”¨ **ç±»åŠ è½½æœŸç»‡å…¥** ç›¸å¯¹äºå…¶ä»–ä¸¤ç§æ–¹å¼, æ›´åŠ è½»ä¾¿.

LTWï¼ˆLoad Time Weaverï¼‰ï¼Œå³åŠ è½½æœŸåˆ‡é¢ç»‡å…¥ï¼Œæ˜¯ ApsectJ åˆ‡é¢ç»‡å…¥çš„ä¸€ç§æ–¹å¼ï¼Œå®ƒé€šè¿‡ JVM ä»£ç†åœ¨ç±»åŠ è½½æœŸæ›¿æ¢å­—èŠ‚ç åˆ°è¾¾ç»‡å…¥åˆ‡é¢çš„ç›®çš„ã€‚

## å…·ä½“å®ç°

é¦–å…ˆå®šä¹‰ä¸ªåˆ‡é¢ç±»ï¼Œè¯¥åˆ‡é¢åŠŸèƒ½éå¸¸ç®€å•ï¼Œå°±æ˜¯åœ¨ `com.xxx.server.rest.resource.impl` åŠå…¶æ‰€æœ‰å­åŒ…ä¸‹æ‰€æœ‰çš„ç±»çš„ public æ–¹æ³•è°ƒç”¨åæ‰“å°æ‰§è¡Œæ—¶é—´

```java
@Slf4j
@Aspect
public class ProfilingAspect {
    @Pointcut("execution(* com.xxx.server.rest.resource.impl..*.*(..))")
    public void api() {
    }

    @Around("api()")
    public Object profile(ProceedingJoinPoint pjp) throws Throwable {
        StopWatch sw = new StopWatch(getClass().getSimpleName());
        try {
            sw.start(pjp.getSignature().getName());
            return pjp.proceed();
        } finally {
            sw.stop();
            log.debug("AOP --> {} ms", sw.getTotalTimeMillis());
        }
    }
}
```

ä½¿ç”¨äº† AspectJ æ³¨è§£ï¼Œæƒ³è¦äº†è§£æ›´å¤šçš„ Aspect æ³¨è§£ä½¿ç”¨å¯ä»¥æŸ¥çœ‹ AspectJ ç›¸å…³çš„æ–‡æ¡£ï¼Œåœ¨ `https://github.com/eclipse/org.aspectj/tree/master/docs`
ä¸‹é¢æœ‰ä¸ª quick5.doc æ–‡æ¡£åˆ—å‡ºäº†æ‰€æœ‰çš„æ³¨è§£ï¼Œä¹Ÿå¯ä»¥æŸ¥çœ‹æºä»£ç æˆ–è€…åç¼–è¯‘ aspectweaver.jarï¼ŒæŸ¥çœ‹é‡Œé¢æœ‰å“ªäº›æ³¨è§£ï¼Œåœ¨ org.aspectj.lang.annotation è¿™ä¸ªåŒ…ä¸‹é¢
ç¼–å†™ç›®æ ‡æµ‹è¯• beanï¼š

```java
public class LTWBean {
    public void run() {
        System.out.println("LTWBean run...");
    }
}
```

ç¼–å†™ä¸€ä¸ª XML æ–‡ä»¶å®šä¹‰åˆ‡é¢ï¼Œè¯¥æ–‡ä»¶ååŠå…¶æ‰€åœ¨è·¯å¾„åªèƒ½å›ºå®šçš„å‡ ç§ï¼šMETA-INF/aop.xmlã€META-INF/aop-ajc.xmlã€org/aspectj/aop.xmlï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<aspectj>
    <weaver>
        <!-- only weave classes in your application-specific packages -->
        <include within="com.xxx.server.rest.resource.impl.*"/>
        <include within="com.xxx.trace.client.aspect.*"/>
    </weaver>
    <aspects>
        <!-- weave in just these aspects -->
        <aspect name="com.xxx.trace.client.aspect.ProfilingAspect"/>
    </aspects>
</aspectj>>
```

**å­˜åœ¨çš„å‘**

æŒ‰ç…§å®˜æ–¹æ–‡æ¡£é…ç½® aop.xml, ä¸€ç›´ä¸ç”Ÿæ•ˆ, æ˜¯å› ä¸ºæ²¡æœ‰å°†åˆ‡é¢ç±» include

æ–‡ä»¶å®šä¹‰äº†åˆ‡é¢ä»¥åŠåˆ‡é¢ç¼–ç»‡å™¨ï¼Œè¿™é‡Œçš„åˆ‡é¢ä¼šè¢«ç»‡å…¥ `com.xxx.server.rest.resource.impl` åŠå…¶å­åŒ…ä¸‹çš„æ‰€æœ‰ç±»ã€‚
ç¼–ç»‡å™¨æ³¨å…¥ Spring å®¹å™¨ä¸­ï¼Œå¹¶ä¸”å®šä¹‰ç›®æ ‡æµ‹è¯• beanï¼š

```xml
<bean id="loadTimeWeaver" class="org.springframework.context.weaving.DefaultContextLoadTimeWeaver"/>
<bean class="org.springframework.context.weaving.AspectJWeavingEnabler"/>
<bean id="ltwBean" class="spring.beans.ltw.LTWBean" lazy-init="true"/>
```

ä¸Šé¢çš„ç¼–ç»‡å™¨ bean çš„åç§°å¿…é¡»æ˜¯ loadTimeWeaverï¼Œæ­¤å¤–è¿˜æœ‰ä¸€ç§æ›´ç®€å•çš„é…ç½®æ–¹å¼ï¼Œä½¿ç”¨ context åç§°ç©ºé—´ä¸‹çš„æ ‡ç­¾ï¼š

```xml
<context:load-time-weaver aspectj-weaving="autodetect" />
<bean id="ltwBean" class="spring.beans.ltw.LTWBean"></bean>
```

ä¸Šé¢ä¸¤æ®µé…ç½®èµ·åˆ°çš„æ•ˆæœå®Œå…¨æ˜¯ä¸€æ ·çš„ï¼Œbean è§£æå™¨åœ¨è§£æåˆ° `context:load-time-weaver` æ ‡ç­¾æ—¶ï¼Œ
ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªåç§°ä¸º `loadTimeWeaver` ç±»å‹ `org.springframework.context.weaving.DefaultContextLoadTimeWeaver` çš„ bean
ä»¥åŠä¸€ä¸ªç±»å‹ `org.springframework.context.weaving.AspectJWeavingEnabler` çš„åŒ¿å beanï¼Œè¿™æ®µä»£ç åœ¨ `LoadTimeWeaverBeanDefinitionParser` ç±»ä¸­.

aspectj-weaving å±æ€§æœ‰ä¸‰ä¸ªæšä¸¾å€¼ï¼š

- on
- off
- autodetect

åˆ†åˆ«æ˜¯æ‰“å¼€ã€å…³é—­ã€è‡ªåŠ¨æ£€æµ‹

è¿™é‡Œè®¾ç½®æˆ autodetectï¼Œå®¹å™¨ä¼šæ£€æŸ¥ç¨‹åºæ˜¯å¦å®šä¹‰äº†åˆ‡é¢å®šä¹‰æ–‡ä»¶ï¼ˆå³ä¸Šé¢æåˆ°çš„ aop.xml æ–‡ä»¶ï¼‰
ä»£ç åœ¨ `LoadTimeWeaverBeanDefinitionParser` çš„ `isAspectJWeavingEnabled` æ–¹æ³•ã€‚

ç¼–å†™æµ‹è¯•ä»£ç ï¼š

```java
BeanFactory context = new ClassPathXmlApplicationContext("spring/beans/ltw/ltw.xml");
LTWBean ltwBean = (LTWBean) context.getBean("ltwBean");
ltwBean.run();
```

è¿è¡Œæµ‹è¯•ä»£ç ï¼Œåœ¨è¿è¡Œæ—¶éœ€è¦å¯åŠ¨ä¸€ä¸ª JVM ä»£ç†ï¼Œé¦–å…ˆéœ€è¦ä¸‹è½½ spring-instrument-xxx.jar åŒ…ï¼Œåœ¨è™šæ‹Ÿæœºå‚æ•°ä¸­æ·»åŠ 

```bash
-javaagent:/path/to/spring-instrument-4.3.10.RELEASE.jar
-javaagent:/path/to/aspectjweaver-1.8.10.jar
```

æ‰§è¡Œæµ‹è¯•ä»£ç ï¼Œæ‰“å°ä¸‹é¢æ—¥å¿—ï¼Œè¯´æ˜åˆ‡é¢ç»‡å…¥æˆåŠŸï¼š

```bash
LTWBean run...
AOP --> xx ms
```

# å­—èŠ‚ç è½¬æ¢å’Œè™šæ‹Ÿæœºä»£ç†

è¦äº†è§£ LTW çš„åŸç†ï¼Œé¦–å…ˆè¦å¯¹ JDK çš„å­—èŠ‚ç è½¬æ¢æ¡†æ¶å’Œ JVM ä»£ç†æœ‰ä¸€å®šçš„äº†è§£ï¼š

ä» JAVA5 å¼€å§‹ï¼Œåœ¨ JDK ä¸­æ·»åŠ äº†ä¸€ä¸ªæ–°åŒ… java.lang.instrumentï¼Œè¿™ä¸ªåŒ…å°±æ˜¯å­—èŠ‚ç è½¬æ¢æ¡†æ¶çš„åŸºç¡€ã€‚å­—èŠ‚ç è½¬æ¢æ¡†æ¶æ˜¯ä¸€é¡¹éå¸¸é‡è¦çš„æŠ€æœ¯ï¼Œè®¸å¤šç¨‹åºç›‘æ§å’Œè°ƒè¯•å·¥å…·æ¯”å¦‚
BTrace éƒ½æ˜¯åœ¨è¿™ä¸ªæ¡†æ¶çš„åŸºç¡€ä¸Šå®ç°çš„ã€‚è¿™ä¸ªåŒ…ä¸‹é¢æœ‰ä¸¤ä¸ªå…³é”®æ¥å£ï¼š

- ClassFileTransformerï¼šç±»å­—èŠ‚ç è½¬æ¢å™¨ï¼Œæä¾›äº†ä¸€ä¸ª transform æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ç”¨æ¥è½¬æ¢æä¾›çš„ç±»å­—èŠ‚ç ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„æ›¿æ¢å­—èŠ‚ç ã€‚ä¸åŒäº CGLIBã€JDK
  åŠ¨æ€ä»£ç†ç­‰å­—èŠ‚ç æ“ä½œæŠ€æœ¯ï¼ŒClassFileTransformer æ˜¯å½»åº•çš„æ›¿æ¢æ‰åŸç±»ï¼Œè€Œ CGLIB å’Œ JDK åŠ¨æ€ä»£ç†æ˜¯ç”Ÿæˆä¸€ä¸ªæ–°å­ç±»æˆ–æ¥å£å®ç°ã€‚
- Instrumentationï¼šè¿™ä¸ªç±»æä¾›æ£€æµ‹ Java
  ç¼–ç¨‹è¯­è¨€ä»£ç æ‰€éœ€çš„æœåŠ¡ã€‚æ£€æµ‹æ˜¯å‘æ–¹æ³•ä¸­æ·»åŠ å­—èŠ‚ç ï¼Œä»¥æœé›†å„ç§å·¥å…·æ‰€ä½¿ç”¨çš„æ•°æ®ã€‚ç”±äºæ›´æ”¹å®Œå…¨æ˜¯è¿›è¡Œæ·»åŠ ï¼Œæ‰€ä»¥è¿™äº›å·¥å…·ä¸ä¿®æ”¹åº”ç”¨ç¨‹åºçš„çŠ¶æ€æˆ–è¡Œä¸ºã€‚è¿™ç§æ— å®³å·¥å…·çš„ä¾‹å­åŒ…æ‹¬é•œåƒä»£ç†ã€åˆ†æå™¨ã€è¦†ç›–åˆ†æå™¨å’Œäº‹ä»¶è®°å½•å™¨ã€‚å¯ä»¥é€šè¿‡å®ƒçš„
  addTransformer æ–¹æ³•æŠŠå®ç°å¥½çš„å­—èŠ‚ç è½¬æ¢å™¨ï¼ˆClassFileTransformerï¼‰æ³¨å†Œåˆ° JVM ä¸­ã€‚

åœ¨æ™®é€šä»£ç ä¸­æ— éœ€å®ç° Instrumentation å¹¶ä¸”åˆ›å»º Instrumentation å®ä¾‹ï¼Œè¦è·å– Instrumentation å®ä¾‹ï¼Œå¯ä»¥é€šè¿‡ JVM ä»£ç†ï¼ŒJVM ä»£ç†å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼å¯åŠ¨ï¼š

## ç¨‹åºå¯åŠ¨æ—¶å¯åŠ¨ä»£ç†

åœ¨ç¨‹åºå¯åŠ¨æ—¶æŒ‡å®šä»£ç†ï¼Œè¿™æ—¶å€™è™šæ‹Ÿæœºä¼šåˆ›å»ºä¸€ä¸ª Instrumentation å®ä¾‹å®ä¾‹ä¼ é€’ç»™ä»£ç†ç±»çš„ premain æ–¹æ³•ã€‚éœ€è¦åœ¨ META-INF/MANIFEST.MF ä¸­é€šè¿‡
Premain-Class æŒ‡å®šä»£ç†å…¥å£ç±»ï¼Œå¹¶ä¸”ä»£ç†å…¥å£ç±»ä¸­å¿…é¡»å®šä¹‰ premain æ–¹æ³•ï¼Œåƒä¸Šé¢æåˆ°çš„åœ¨è¿è¡Œç¨‹åºæ—¶åœ¨è™šæ‹Ÿæœºå‚æ•°æ·»åŠ  -javaagent å°±æ˜¯åœ¨ç¨‹åºå¯åŠ¨æ—¶æŒ‡å®šäº†ä»£ç†ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹
spring-instrument-3.2.9.RELEASE.jar åŒ…ä¸­ MANIFEST.MF æ–‡ä»¶çš„å†…å®¹ï¼š

```bash
Manifest-Version: 1.0
Created-By: 1.7.0_55 (Oracle Corporation)
Implementation-Title: spring-instrument
Implementation-Version: 3.2.9.RELEASE
Premain-Class: org.springframework.instrument.InstrumentationSavingAgent
Can-Redefine-Classes: true
Can-Retransform-Classes: true
Can-Set-Native-Method-Prefix: false
```

çœ‹ä»¥çœ‹åˆ°é€šè¿‡ Premain-Class æŒ‡å®šäº† org.springframework.instrument.InstrumentationSavingAge ä½œä¸ºä»£ç†å…¥å£ç±»ï¼Œçœ‹çœ‹ InstrumentationSavingAge
è¿™ä¸ªç±»çš„ä»£ç ï¼Œæœ‰ä¸€ä¸ª premain æ–¹æ³•å¹¶ä¸”æœ‰ä¸€ä¸ª Instrumentation å‚æ•°ï¼š

```java
public class InstrumentationSavingAgent {
	private static volatile Instrumentation instrumentation;
	/**
	 * Save the {@link Instrumentation} interface exposed by the JVM.
	 */
	public static void premain(String agentArgs, Instrumentation inst) {
		instrumentation = inst;
	}


	/**
	 * Return the {@link Instrumentation} interface exposed by the JVM.
	 * <p>Note that this agent class will typically not be available in the classpath
	 * unless the agent is actually specified on JVM startup. If you intend to do
	 * conditional checking with respect to agent availability, consider using
	 * {@link org.springframework.instrument.classloading.InstrumentationLoadTimeWeaver#getInstrumentation()}
	 * instead - which will work without the agent class in the classpath as well.
	 * @return the {@code Instrumentation} instance previously saved when
	 * the {@link #premain} method was called by the JVM; will be {@code null}
	 * if this class was not used as Java agent when this JVM was started.
	 * @see org.springframework.instrument.classloading.InstrumentationLoadTimeWeaver#getInstrumentation()
	 */
	public static Instrumentation getInstrumentation() {
		return instrumentation;
	}

}
```

# ç¨‹åºè¿è¡Œæ—¶å¯åŠ¨ä»£ç†

è¿˜æœ‰ä¸€ç§æ–¹å¼æ˜¯åœ¨ç¨‹åºå¯åŠ¨ä¹‹åå¯åŠ¨ä»£ç†ï¼Œè¿™ç§æƒ…å†µä¸‹å¯ä»¥åœ¨ä¸æš‚åœåº”ç”¨ç¨‹åºçš„æƒ…å†µä¸‹åŠ¨æ€å‘æ³¨å†Œç±»è½¬æ¢å™¨å¯¹å·²åŠ è½½çš„ç±»è¿›è¡Œé‡å®šä¹‰ã€‚è¿™ç§æ–¹å¼éœ€è¦åœ¨
META-INF/MANIFEST.MF æ–‡ä»¶ä¸­é€šè¿‡ Agent-Class æŒ‡å®šä»£ç†å…¥å£ç±»ï¼Œå¹¶ä¸”å…¥å£ä»£ç†ç±»ä¸­å®šä¹‰ agentmain æ–¹æ³•ï¼Œè™šæ‹ŸæœºæŠŠ Instrumentation å®ä¾‹ä¼ é€’ç»™è¿™ä¸ª
agentmain æ–¹æ³•ï¼Œä¸‹é¢ä»£ç æ˜¯ Druid æ¡†æ¶ï¼ˆDruid æ˜¯é˜¿é‡Œå·´å·´ä¸€ä¸ªå¼€æºçš„è¿æ¥æ± æ¡†æ¶ï¼‰ä¸­æ‹·è´è¿‡æ¥çš„ä¸€æ®µä»£ç ï¼Œæ¼”ç¤ºäº†å¦‚ä½•åœ¨åº”ç”¨è¿è¡Œæ—¶å¯åŠ¨ä¸€ä¸ª JMX ä»£ç†ï¼š

```java
private static String loadManagementAgentAndGetAddress(int vmid) throws IOException {
    VirtualMachine vm = null;
    String name = String.valueOf(vmid);
    try {
        vm = VirtualMachine.attach(name);
    } catch (AttachNotSupportedException x) {
        throw new IOException(x.getMessage(), x);
    }

    String home = vm.getSystemProperties().getProperty("java.home");

    // Normally in ${java.home}/jre/lib/management-agent.jar but might
    // be in ${java.home}/lib in build environments.

    String agent = home + File.separator + "jre" + File.separator + "lib" + File.separator + "management-agent.jar";
    File f = new File(agent);
    if (!f.exists()) {
        agent = home + File.separator + "lib" + File.separator + "management-agent.jar";
        f = new File(agent);
        if (!f.exists()) {
            throw new IOException("Management agent not found");
        }
    }

    agent = f.getCanonicalPath();
    try {
        vm.loadAgent(agent, "com.sun.management.jmxremote");
    } catch (AgentLoadException x) {
        throw new IOException(x.getMessage(), x);
    } catch (AgentInitializationException x) {
        throw new IOException(x.getMessage(), x);
    }

    // get the connector address
    Properties agentProps = vm.getAgentProperties();
    String address = (String) agentProps.get(LOCAL_CONNECTOR_ADDRESS_PROP);
    vm.detach();

    return address;
}
```

è¿è¡Œ management-agent.jar ä½œä¸ºä»£ç†ï¼Œæ¥çœ‹çœ‹ management-agent.jar ä¸­çš„ META-INF/MANIFEST.MF æ–‡ä»¶ï¼ŒåŒæ—¶æŒ‡å®šäº† Premain-Class å’Œ
Agent-Classï¼Œä»£ç†å¯åŠ¨ä¹‹åè™šæ‹Ÿæœºä¼šè°ƒç”¨ä»£ç†å…¥å£ç±»çš„ agentmain æ–¹æ³•ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ Agent ç±»åªæœ‰ä¸€ä¸ª String å‚æ•°çš„ agentmain å¹¶æ²¡æœ‰å®šä¹‰å¸¦
Instrumentation å‚æ•°çš„ agentmainï¼Œå› ä¸º JMX ä»£ç†å¹¶ä¸éœ€è¦ Instrumentation å®ä¾‹ï¼š

```bash
Manifest-Version: 1.0
Premain-Class: sun.management.Agent
Created-By: 1.5.0 (Sun Microsystems Inc.)
Agent-Class: sun.management.Agent
```

# å®ç°åŸç†

äº†è§£äº† JDK å­—èŠ‚ç æ¡†æ¶å’Œè™šæ‹Ÿæœºä»£ç†ä¹‹åï¼Œåˆ†æ LTW çš„å®ç°åŸç†å°±ç®€å•å¾—å¤šäº†ã€‚
å½“å®¹å™¨æ£€æŸ¥åˆ°å®šä¹‰äº†åç§°ä¸º loadTimeWeaver çš„ bean æ—¶ï¼Œä¼šæ³¨å†Œä¸€ä¸ª LoadTimeWeaverAwareProcessor åˆ°å®¹å™¨ä¸­ï¼Œä»£ç åœ¨ AbstractApplicationContext çš„
prepareBeanFactory æ–¹æ³•ä¸­ï¼š

```java
protected void prepareBeanFactory(ConfigurableListableBeanFactory beanFactory) {

	...

	if (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) {
		beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory));
		// Set a temporary ClassLoader for type matching.
		beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));
	}

	...
}
```

LoadTimeWeaverAwareProcessor æ˜¯ä¸€ä¸ª BPPï¼ˆBeanPostProcessorï¼‰ï¼Œè¿™ä¸ª BPP ç”¨æ¥å¤„ç† LoadTimeWeaverAware æ¥å£çš„ï¼ŒæŠŠ LTW å®ä¾‹è®¾ç½®åˆ°å®ç°äº†
LoadTimeWeaverAware æ¥å£çš„ bean ä¸­ï¼Œä» LoadTimeWeaverAwareProcessor çš„ postProcessBeforeInitialization æ–¹æ³•å¯ä»¥çœ‹å‡ºæ¥ï¼š

```java
public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
	if (bean instanceof LoadTimeWeaverAware) {
		LoadTimeWeaver ltw = this.loadTimeWeaver;
		if (ltw == null) {
			Assert.state(this.beanFactory != null,
					"BeanFactory required if no LoadTimeWeaver explicitly specified");
			ltw = this.beanFactory.getBean(
					ConfigurableApplicationContext.LOAD_TIME_WEAVER_BEAN_NAME, LoadTimeWeaver.class);
		}
		((LoadTimeWeaverAware) bean).setLoadTimeWeaver(ltw);
	}
	return bean;
}
```

å†æ¥çœ‹ä¸‹ AspectJWeavingEnabler è¿™ä¸ªç±»çš„ä»£ç ï¼Œå®ƒæ˜¯ä¸€ä¸ª BFPPï¼ŒåŒæ—¶ä¹Ÿå®ç°äº† LoadTimeWeaverAware æ¥å£ï¼Œé€šè¿‡ä¸Šé¢çš„åˆ†æï¼ŒloadTimeWeaver è¿™ä¸ª bean
ä¼šè‡ªåŠ¨æ³¨å…¥åˆ° AspectJWeavingEnabler ç±»å‹ bean ä¸­ã€‚AspectJWeavingEnabler çš„ postProcessBeanFactory æ–¹æ³•ç›´æ¥è°ƒç”¨ enableAspectJWeaving
æ–¹æ³•ï¼Œæ¥çœ‹çœ‹è¿™ä¸ªæ–¹æ³•çš„ä»£ç ï¼š

```java
public static void enableAspectJWeaving(LoadTimeWeaver weaverToUse, ClassLoader beanClassLoader) {
	if (weaverToUse == null) {
		if (InstrumentationLoadTimeWeaver.isInstrumentationAvailable()) {
			weaverToUse = new InstrumentationLoadTimeWeaver(beanClassLoader);
		}
		else {
			throw new IllegalStateException("No LoadTimeWeaver available");
		}
	}
	weaverToUse.addTransformer(new AspectJClassBypassingClassFileTransformer(
				new ClassPreProcessorAgentAdapter()));
}
```

weaverToUse è¿™ä¸ªå‚æ•°å°±æ˜¯è¢«å®¹å™¨è‡ªåŠ¨æ³¨å…¥çš„ loadTimeWeaver beanï¼Œä» bean å®šä¹‰ XML ä¸­å¯ä»¥çŸ¥é“è¿™ä¸ª bean æ˜¯ DefaultContextLoadTimeWeaver ç±»å‹çš„ï¼Œå®ƒçš„
addTransformer æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š

```java
public void addTransformer(ClassFileTransformer transformer) {
	this.loadTimeWeaver.addTransformer(transformer);
}
```

DefaultContextLoadTimeWeaver ç±»ä¹Ÿæœ‰ä¸ª loadTimeWeaver å±æ€§ï¼Œè¿™ä¸ªå±æ€§æ˜¯åœ¨ setBeanClassLoader æ–¹æ³•ä¸­è®¾ç½®è¿›å»çš„ï¼š

```java
public void setBeanClassLoader(ClassLoader classLoader) {
	LoadTimeWeaver serverSpecificLoadTimeWeaver = createServerSpecificLoadTimeWeaver(classLoader);
	if (serverSpecificLoadTimeWeaver != null) {
		if (logger.isInfoEnabled()) {
			logger.info("Determined server-specific load-time weaver: " +
					serverSpecificLoadTimeWeaver.getClass().getName());
		}
		this.loadTimeWeaver = serverSpecificLoadTimeWeaver;
	}
	else if (InstrumentationLoadTimeWeaver.isInstrumentationAvailable()) {
		logger.info("Found Spring's JVM agent for instrumentation");
		this.loadTimeWeaver = new InstrumentationLoadTimeWeaver(classLoader);
	}
	else {
		try {
			this.loadTimeWeaver = new ReflectiveLoadTimeWeaver(classLoader);
			logger.info("Using a reflective load-time weaver for class loader: " +
					this.loadTimeWeaver.getInstrumentableClassLoader().getClass().getName());
		}
		catch (IllegalStateException ex) {
			throw new IllegalStateException(ex.getMessage() + " Specify a custom LoadTimeWeaver or start your " +
					"Java virtual machine with Spring's agent: -javaagent:org.springframework.instrument.jar");
		}
	}
}
```

åœ¨æ–¹æ³•é‡Œé¢åˆ¤æ–­äº†å½“å‰æ˜¯å¦å­˜åœ¨ Instrumentation å®ä¾‹ï¼Œæœ€ç»ˆä¼šå– InstrumentationSavingAgent ç±»ä¸­çš„ instrumentation çš„é™æ€å±æ€§ï¼Œåˆ¤æ–­è¿™ä¸ªå±æ€§æ˜¯å¦æ˜¯
nullï¼Œä»å‰é¢çš„åˆ†æå¯ä»¥çŸ¥é“ InstrumentationSavingAgent è¿™ä¸ªç±»æ˜¯ spring-instrument-3.2.9.RELEASE.jar çš„ä»£ç†å…¥å£ç±»ï¼Œå½“åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶å¯åŠ¨äº†
spring-instrument-3.2.9.RELEASE.jar ä»£ç†æ—¶ï¼Œå³åœ¨è™šæ‹Ÿæœºå‚æ•°ä¸­è®¾ç½®äº† -javaagent å‚æ•°ï¼Œè™šæ‹Ÿæœºä¼šåˆ›å»º Instrumentation å®ä¾‹å¹¶ä¼ é€’ç»™ premain
æ–¹æ³•ï¼ŒInstrumentationSavingAgent ä¼šæŠŠè¿™ä¸ªç±»ä¿å­˜åœ¨ instrumentation é™æ€å±æ€§ä¸­ã€‚æ‰€ä»¥åœ¨ç¨‹åºå¯åŠ¨æ—¶å¯åŠ¨äº†ä»£ç†æ—¶
InstrumentationLoadTimeWeaver.isInstrumentationAvailable() è¿™ä¸ªæ–¹æ³•æ˜¯è¿”å› true çš„ï¼Œæ‰€ä»¥ loadTimeWeaver å±æ€§ä¼šè®¾ç½®æˆ
InstrumentationLoadTimeWeaver å¯¹è±¡ã€‚
æ¥ä¸‹æ¥å°±çœ‹çœ‹ InstrumentationLoadTimeWeaver ç±»çš„ addTransformer æ–¹æ³•ä»£ç ï¼š

```java
public void addTransformer(ClassFileTransformer transformer) {
	Assert.notNull(transformer, "Transformer must not be null");
	FilteringClassFileTransformer actualTransformer =
			new FilteringClassFileTransformer(transformer, this.classLoader);
	synchronized (this.transformers) {
		if (this.instrumentation == null) {
			throw new IllegalStateException(
					"Must start with Java agent to use InstrumentationLoadTimeWeaver. See Spring documentation.");
		}
		this.instrumentation.addTransformer(actualTransformer);
		this.transformers.add(actualTransformer);
	}
}
```

ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­ï¼ŒæŠŠç±»è½¬æ¢å™¨ actualTransformer é€šè¿‡ instrumentation å®ä¾‹æ³¨å†Œç»™äº†è™šæ‹Ÿæœºã€‚è¿™é‡Œé‡‡ç”¨äº†ä¿®é¥°å™¨æ¨¡å¼ï¼ŒactualTransformer å¯¹
transformer è¿›è¡Œä¿®æ”¹å°è£…ï¼Œä¸‹é¢æ˜¯ FilteringClassFileTransformer è¿™ä¸ªå†…éƒ¨ç±»çš„ä»£ç ï¼š

```java
private static class FilteringClassFileTransformer implements ClassFileTransformer {

	private final ClassFileTransformer targetTransformer;

	private final ClassLoader targetClassLoader;

	public FilteringClassFileTransformer(ClassFileTransformer targetTransformer, ClassLoader targetClassLoader) {
		this.targetTransformer = targetTransformer;
		this.targetClassLoader = targetClassLoader;
	}

	public byte[] transform(ClassLoader loader, String className, Class<?> classBeingRedefined,
			ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {

		if (!this.targetClassLoader.equals(loader)) {
			return null;
		}
		return this.targetTransformer.transform(
				loader, className, classBeingRedefined, protectionDomain, classfileBuffer);
	}

	@Override
	public String toString() {
		return "FilteringClassFileTransformer for: " + this.targetTransformer.toString();
	}
}
```

è¿™é‡Œé¢çš„ targetClassLoader å°±æ˜¯å®¹å™¨çš„ bean ç±»åŠ è½½ï¼Œåœ¨è¿›è¡Œç±»å­—èŠ‚ç è½¬æ¢ä¹‹å‰å…ˆåˆ¤æ–­æ‰§è¡Œç±»åŠ è½½çš„åŠ è½½å™¨æ˜¯å¦æ˜¯ bean ç±»åŠ è½½å™¨ï¼Œå¦‚æœä¸æ˜¯çš„è¯è·³è¿‡ç±»è£…æ¢é€»è¾‘ç›´æ¥è¿”å›
nullï¼Œè¿”å› null çš„æ„æ€å°±æ˜¯ä¸æ‰§è¡Œç±»è½¬æ¢è¿˜æ˜¯ä½¿ç”¨åŸå§‹çš„ç±»å­—èŠ‚ç ã€‚ä»€ä¹ˆæƒ…å†µä¸‹ä¼šæœ‰ç±»åŠ è½½ä¸æ˜¯ bean çš„ç±»åŠ è½½å™¨çš„æƒ…å†µï¼Ÿåœ¨æˆ‘ä»¬ä¸Šé¢åˆ—å‡ºçš„
AbstractApplicationContext çš„ prepareBeanFactory æ–¹æ³•ä¸­æœ‰ä¸€è¡Œä»£ç ï¼š

```java
beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));
```

å½“å®¹å™¨ä¸­æ³¨å†Œäº† loadTimeWeaver ä¹‹åä¼šç»™å®¹å™¨è®¾ç½®ä¸€ä¸ª ContextTypeMatchClassLoader ç±»å‹çš„ä¸´æ—¶ç±»åŠ è½½å™¨ï¼Œåœ¨ç»‡å…¥åˆ‡é¢æ—¶åªæœ‰åœ¨ bean
å®ä¾‹åŒ–æ—¶ç»‡å…¥åˆ‡é¢æ‰æœ‰æ„ä¹‰ï¼Œåœ¨è¿›è¡Œä¸€äº›ç±»å‹æ¯”è¾ƒæˆ–è€…æ ¡éªŒçš„æ—¶å€™ï¼Œæ¯”å¦‚åˆ¤æ–­ä¸€ä¸ª bean æ˜¯å¦æ˜¯
FactoryBeanã€BPPã€BFPPï¼Œè¿™æ—¶å€™ä¸æ¶‰åŠåˆ°å®ä¾‹åŒ–ï¼Œæ‰€ä»¥åšå­—èŠ‚ç è½¬æ¢æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œè€Œä¸”è¿˜ä¼šå¢åŠ æ— è°“çš„æ€§èƒ½æ¶ˆè€—ï¼Œæ‰€ä»¥åœ¨è¿›è¡Œè¿™äº›ç±»å‹æ¯”è¾ƒæ—¶ä½¿ç”¨è¿™ä¸ªä¸´æ—¶çš„ç±»åŠ è½½å™¨æ‰§è¡Œç±»åŠ è½½ï¼Œè¿™æ ·åœ¨ä¸Šé¢çš„
transform æ–¹æ³•å°±ä¼šå› ä¸ºç±»åŠ è½½ä¸åŒ¹é…è€Œè·³è¿‡å­—èŠ‚ç è½¬æ¢ï¼Œè¿™é‡Œæœ‰ä¸€ç‚¹éå¸¸å…³é”®çš„æ˜¯ï¼ŒContextTypeMatchClassLoader çš„çˆ¶ç±»åŠ è½½å°±æ˜¯å®¹å™¨ bean ç±»åŠ è½½å™¨ï¼Œæ‰€ä»¥
ContextTypeMatchClassLoader ç±»åŠ è½½å™¨æ˜¯ä¸éµå¾ªâ€œåŒäº²å§”æ´¾â€çš„ï¼Œå› ä¸ºå¦‚æœå®ƒéµå¾ªäº†â€œåŒäº²å§”æ´¾â€ï¼Œé‚£ä¹ˆå®ƒçš„ç±»åŠ è½½å·¥ä½œè¿˜æ˜¯ä¼šå§”æ‰˜ç»™ bean ç±»åŠ è½½å™¨ï¼Œè¿™æ ·çš„è¯ if
é‡Œé¢çš„æ¡ä»¶å°±ä¸ä¼šåŒ¹é…ï¼Œè¿˜æ˜¯ä¼šæ‰§è¡Œç±»è½¬æ¢ã€‚ContextTypeMatchClassLoader çš„ç±»åŠ è½½å·¥ä½œä¼šå§”æ‰˜ç»™ ContextOverridingClassLoader ç±»å¯¹è±¡ï¼Œæœ‰å…´è¶£å¯ä»¥çœ‹çœ‹
ContextOverridingClassLoader å’Œ OverridingClassLoader è¿™ä¸¤ä¸ªç±»çš„ä»£ç ã€‚
è¿™ä¸ªä¸´æ—¶çš„ç±»åŠ è½½å™¨ä¼šåœ¨å®¹å™¨åˆå§‹åŒ–å¿«ç»“æŸæ—¶ï¼Œå®¹å™¨ bean å®ä¾‹åŒ–ä¹‹å‰è¢«æ¸…æ‰ï¼Œä»£ç åœ¨ AbstractApplicationContext ç±»çš„ finishBeanFactoryInitialization
æ–¹æ³•ï¼š

```java
protected void finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) {

	...

	beanFactory.setTempClassLoader(null);

	// Allow for caching all bean definition metadata, not expecting further changes.
	beanFactory.freezeConfiguration();

	// Instantiate all remaining (non-lazy-init) singletons.
	beanFactory.preInstantiateSingletons();
}
```

å†å›å¤´æ¥çœ‹ FilteringClassFileTransformer ç±»çš„ transform æ–¹æ³•ï¼Œè°ƒç”¨ targetTransformer æ‰§è¡Œå­—èŠ‚ç è½¬æ¢ã€‚æ¥çœ‹çœ‹ targetTransformer
è¿™ä¸ªç±»è½¬æ¢å™¨æ˜¯åœ¨å“ªåˆ›å»ºçš„ï¼Œå›å¤´å†çœ‹ä¸‹ AspectJWeavingEnabler ç±»çš„ enableAspectJWeaving æ–¹æ³•ï¼Œæœ‰ä¸‹é¢è¿™è¡Œä»£ç ï¼š

```java
weaverToUse.addTransformer(new AspectJClassBypassingClassFileTransformer(
					new ClassPreProcessorAgentAdapter()));
```

AspectJClassBypassingClassFileTransformer ç±»å’Œ ClassPreProcessorAgentAdapter ç±»éƒ½å®ç°äº†å­—èŠ‚ç è½¬æ¢æ¥å£ ClassFileTransformerï¼š

```java
private static class AspectJClassBypassingClassFileTransformer implements ClassFileTransformer {

	private final ClassFileTransformer delegate;

	public AspectJClassBypassingClassFileTransformer(ClassFileTransformer delegate) {
		this.delegate = delegate;
	}

	public byte[] transform(ClassLoader loader, String className, Class<?> classBeingRedefined,
			ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {

		if (className.startsWith("org.aspectj") || className.startsWith("org/aspectj")) {
			return classfileBuffer;
		}
		return this.delegate.transform(loader, className, classBeingRedefined, protectionDomain, classfileBuffer);
	}
}
```

è¿™ä¹Ÿæ˜¯ä¸€ä¸ªä¿®é¥°å™¨æ¨¡å¼ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ ClassPreProcessorAgentAdapter çš„ transform æ–¹æ³•æ‰§è¡Œå­—èŠ‚ç è½¬æ¢é€»è¾‘ï¼Œåœ¨ç±»åŠ è½½å™¨å®šä¹‰ç±»æ—¶ï¼ˆå³è°ƒç”¨ defineClass
æ–¹æ³•ï¼‰ä¼šè°ƒç”¨æ­¤ç±»çš„ transform æ–¹æ³•æ¥è¿›è¡Œå­—èŠ‚ç è½¬æ¢æ›¿æ¢åŸå§‹ç±»ã€‚ClassPreProcessorAgentAdapter ç±»ä¸­çš„ä»£ç æ¯”è¾ƒå¤šï¼Œè¿™é‡Œå°±ä¸åˆ—å‡ºæ¥äº†ï¼Œå®ƒçš„ä¸»è¦å·¥ä½œæ˜¯è§£æ
aop.xml æ–‡ä»¶ï¼Œè§£æç±»ä¸­çš„ Aspect æ³¨è§£ï¼Œå¹¶ä¸”æ ¹æ®è§£æç»“æœæ¥ç”Ÿæˆè½¬æ¢åçš„å­—èŠ‚ç ã€‚
åœ¨ä¸Šé¢ä¾‹å­é‡Œé¢æåˆ°çš„é€šè¿‡ context åç§°ç©ºé—´ä¸‹çš„ load-time-weaver æ ‡ç­¾æ¥é…ç½®ï¼Œå…¶æœ¬è´¨åŸç†æ˜¯ä¸€è‡´çš„ã€‚é€šè¿‡åœ¨ context çš„åç§°ç©ºé—´å¤„ç†å™¨
ContextNamespaceHandler ä¸­å¯ä»¥çœ‹åˆ° load-time-weaver æ ‡ç­¾çš„è§£æå™¨æ˜¯ LoadTimeWeaverBeanDefinitionParser ç±»ï¼Œçœ‹ä¸‹è¿™ä¸ªç±»çš„ä»£ç ï¼š

```java
class LoadTimeWeaverBeanDefinitionParser extends AbstractSingleBeanDefinitionParser {

	private static final String WEAVER_CLASS_ATTRIBUTE = "weaver-class";

	private static final String ASPECTJ_WEAVING_ATTRIBUTE = "aspectj-weaving";

	private static final String DEFAULT_LOAD_TIME_WEAVER_CLASS_NAME =
			"org.springframework.context.weaving.DefaultContextLoadTimeWeaver";

	private static final String ASPECTJ_WEAVING_ENABLER_CLASS_NAME =
			"org.springframework.context.weaving.AspectJWeavingEnabler";


	@Override
	protected String getBeanClassName(Element element) {
		if (element.hasAttribute(WEAVER_CLASS_ATTRIBUTE)) {
			return element.getAttribute(WEAVER_CLASS_ATTRIBUTE);
		}
		return DEFAULT_LOAD_TIME_WEAVER_CLASS_NAME;
	}

	@Override
	protected String resolveId(Element element, AbstractBeanDefinition definition, ParserContext parserContext) {
		return ConfigurableApplicationContext.LOAD_TIME_WEAVER_BEAN_NAME;
	}

	@Override
	protected void doParse(Element element, ParserContext parserContext, BeanDefinitionBuilder builder) {
		builder.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);

		if (isAspectJWeavingEnabled(element.getAttribute(ASPECTJ_WEAVING_ATTRIBUTE), parserContext)) {
			RootBeanDefinition weavingEnablerDef = new RootBeanDefinition();
			weavingEnablerDef.setBeanClassName(ASPECTJ_WEAVING_ENABLER_CLASS_NAME);
			parserContext.getReaderContext().registerWithGeneratedName(weavingEnablerDef);

			if (isBeanConfigurerAspectEnabled(parserContext.getReaderContext().getBeanClassLoader())) {
				new SpringConfiguredBeanDefinitionParser().parse(element, parserContext);
			}
		}
	}

	protected boolean isAspectJWeavingEnabled(String value, ParserContext parserContext) {
		if ("on".equals(value)) {
			return true;
		}
		else if ("off".equals(value)) {
			return false;
		}
		else {
			// Determine default...
			ClassLoader cl = parserContext.getReaderContext().getResourceLoader().getClassLoader();
			return (cl.getResource(AspectJWeavingEnabler.ASPECTJ_AOP_XML_RESOURCE) != null);
		}
	}

	protected boolean isBeanConfigurerAspectEnabled(ClassLoader beanClassLoader) {
		return ClassUtils.isPresent(SpringConfiguredBeanDefinitionParser.BEAN_CONFIGURER_ASPECT_CLASS_NAME,
				beanClassLoader);
	}

}
```

ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºåœ¨è§£æ load-time-weaver æ ‡ç­¾æ—¶ï¼Œä» getBeanClassName æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®š weaver-class å±æ€§ï¼Œä¼šè‡ªåŠ¨ç»™å®¹å™¨ä¸­æ³¨å…¥ä¸€ä¸ª
org.springframework.context.weaving.DefaultContextLoadTimeWeaver ç±»å‹çš„ beanï¼Œä» resolveId æ–¹æ³•ä¸­çœ‹åˆ°ï¼Œè¯¥ bean çš„åç§°ä¸º loadTimeWeaverã€‚åœ¨
doParse æ–¹æ³•ä¸­ï¼Œè¿˜ä¼šæ³¨å†Œä¸€ä¸ªç±»å‹ä¸º org.springframework.context.weaving.AspectJWeavingEnabler çš„åŒ¿å beanã€‚ä»æ­¤å¯ä»¥çœ‹å‡ºä¸‹é¢ä¸¤æ®µé…ç½®å®Œå…¨æ˜¯ç­‰ä»·çš„ï¼š

```xml
<bean id="loadTimeWeaver"
	class="org.springframework.context.weaving.DefaultContextLoadTimeWeaver"></bean>
<bean class="org.springframework.context.weaving.AspectJWeavingEnabler"></bean>
```

```xml
<context:load-time-weaver aspectj-weaving="autodetect" />
```

## [Redis Sentinelï¼šå®ç°é«˜å¯ç”¨æ€§ä¸æ•…éšœè½¬ç§»](https://blog.dong4j.site/posts/a87e6e25.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

ä½¿ç”¨ Redis Sentinel é‡æ„ç°æœ‰æ¶æ„

> å¯¹äºæ­å»ºé«˜å¯ç”¨ Redis æœåŠ¡ï¼Œç½‘ä¸Šå·²æœ‰äº†å¾ˆå¤šæ–¹æ¡ˆï¼Œä¾‹å¦‚ Keepalivedï¼ŒCodisï¼ŒTwemproxyï¼ŒRedis Sentinelã€‚
> å…¶ä¸­ Codis å’Œ Twemproxy ä¸»è¦æ˜¯ç”¨äºå¤§è§„æ¨¡çš„ Redis é›†ç¾¤ä¸­ï¼Œä¹Ÿæ˜¯åœ¨ Redis å®˜æ–¹å‘å¸ƒ Redis Sentinel ä¹‹å‰ è±Œè±†èš å’Œ twitter æä¾›çš„å¼€æºè§£å†³æ–¹æ¡ˆã€‚
> Redis Sentinel å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªç›‘æ§ Redis Server æœåŠ¡æ˜¯å¦æ­£å¸¸çš„è¿›ç¨‹ï¼Œå¹¶ä¸”ä¸€æ—¦æ£€æµ‹åˆ°ä¸æ­£å¸¸ï¼Œå¯ä»¥è‡ªåŠ¨åœ°å°†å¤‡ä»½ (slave)Redis Server å¯ç”¨ï¼Œä½¿å¾—å¤–éƒ¨ç”¨æˆ·å¯¹
> Redis æœåŠ¡å†…éƒ¨å‡ºç°çš„å¼‚å¸¸æ— æ„ŸçŸ¥ã€‚

## åŸæœ‰æ¶æ„

![20241229154732_wkmt6CrY.webp](https://cdn.dong4j.site/source/image/20241229154732_wkmt6CrY.webp)

### å­˜åœ¨çš„é—®é¢˜

1. é…ç½®éƒ¨ç½²å¤æ‚
2. ä¸ç¨³å®š

## Redis Sentinel é«˜å¯ç”¨

![20241229154732_g8KXigVF.webp](https://cdn.dong4j.site/source/image/20241229154732_g8KXigVF.webp)

ä¸‹é¢ä»¥ 1 ä¸ªä¸»èŠ‚ç‚¹ã€2 ä¸ªä»èŠ‚ç‚¹ã€3 ä¸ª Sentinel èŠ‚ç‚¹ç»„æˆçš„ Redis Sentinel ä¸ºä¾‹å­

**æ•…éšœè½¬ç§»å¤„ç†é€»è¾‘:**

1. ä¸»èŠ‚ç‚¹å‡ºç°æ•…éšœ, æ­¤æ—¶ä¸¤ä¸ªä»èŠ‚ç‚¹ä¸ä¸»èŠ‚ç‚¹æ—¶åŒºè¿æ¥, ä¸»ä»å¤åˆ¶å¤±è´¥;

   ![20241229154732_yV32SN5g.webp](https://cdn.dong4j.site/source/image/20241229154732_yV32SN5g.webp)

2. æ¯ä¸ª Sentinel èŠ‚ç‚¹é€šè¿‡å®šæœŸç›‘æ§å‘ç°ä¸»èŠ‚ç‚¹å‡ºç°æ•…éšœ;

   ![20241229154732_dmt2MfIR.webp](https://cdn.dong4j.site/source/image/20241229154732_dmt2MfIR.webp)

3. å¤šä¸ª Sentinel èŠ‚ç‚¹å¯¹ä¸»èŠ‚ç‚¹çš„æ•…éšœè¾¾æˆä¸€è‡´, é€‰ä¸¾å‡º sentinel-3 èŠ‚ç‚¹ä½œä¸ºé¢†å¯¼è€…è´Ÿè´£æ•…éšœè½¬ç§»;

   ![20241229154732_ypMc084g.webp](https://cdn.dong4j.site/source/image/20241229154732_ypMc084g.webp)

   1. åŸæ¥çš„ä»èŠ‚ç‚¹ slave-1 æˆä¸ºæ–°çš„ä¸»èŠ‚ç‚¹å, æ›´æ–°åº”ç”¨æ–¹çš„ä¸»èŠ‚ç‚¹ä¿¡æ¯;
   2. å®¢æˆ·ç«¯å‘½ä»¤å¦ä¸€ä¸ªä»èŠ‚ç‚¹ slave-2 å»å¤åˆ¶æ–°çš„ä¸»èŠ‚ç‚¹;
   3. å¾…åŸæ¥çš„ä¸»èŠ‚ç‚¹æ¢å¤å, è®©å®ƒå»å¤åˆ¶æ–°çš„ä¸»èŠ‚ç‚¹;

   ![20241229154732_ZvDNSolX.webp](https://cdn.dong4j.site/source/image/20241229154732_ZvDNSolX.webp)

4. æ•…éšœè½¬ç§»åçš„ç»“æ„å›¾

   ![20241229154732_8ZiZco7l.webp](https://cdn.dong4j.site/source/image/20241229154732_8ZiZco7l.webp)

### Redis Sentinel åŠŸèƒ½

1. **ç›‘æ§:** Sentinel èŠ‚ç‚¹ä¼šå®šæœŸæ£€æµ‹ Redis æ•°æ®èŠ‚ç‚¹å’Œå…¶ä½™ Sentinel èŠ‚ç‚¹æ˜¯å¦å¯è¾¾;
2. **é€šçŸ¥:** Sentinel èŠ‚ç‚¹ä¼šå°†æ•…éšœè½¬ç§»çš„ç»“æœé€šçŸ¥ç»™åº”ç”¨æ–¹;
3. **ä¸»èŠ‚ç‚¹æ•…éšœè½¬ç§»:** å®ç°ä»èŠ‚ç‚¹æ™‹å‡ä¸ºä¸»èŠ‚ç‚¹å¹¶ç»´æŠ¤åç»­æ­£ç¡®çš„ä¸»ä»å…³ç³»;
4. **é…ç½®æä¾›è€…:** å®¢æˆ·ç«¯åœ¨åˆå§‹åŒ–æ—¶, è¿æ¥ Sentinel èŠ‚ç‚¹é›†ç¾¤, ä»ä¸­è·å–ä¸»èŠ‚ç‚¹ä¿¡æ¯;

é‡‡ç”¨å¤šä¸ª Sentinel èŠ‚ç‚¹çš„ä¼˜ç‚¹:

1. å¯¹äºèŠ‚ç‚¹æ•…éšœåˆ¤æ–­ç”±å¤šä¸ª Sentinel èŠ‚ç‚¹å…±åŒå®Œæˆ, æœ‰æ•ˆé˜²æ­¢è¯¯åˆ¤;
2. é¿å…å•ç‚¹æ•…éšœ;

### å‡ ä¸ªæ¦‚å¿µ

#### ä¸‰ä¸ªå®šæ—¶ç›‘æ§ä»»åŠ¡

1. æ¯éš” 10 ç§’. æ¯ä¸ª Sentinel èŠ‚ç‚¹ä¼šå‘ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹å‘é€ info å‘½ä»¤è·å–æœ€æ–°çš„æ‹“æ‰‘ç»“æ„;
   ![20241229154732_g9I5S7TW.webp](https://cdn.dong4j.site/source/image/20241229154732_g9I5S7TW.webp)

2. æ¯éš” 2 ç§’, æ¯ä¸ª Sentinel èŠ‚ç‚¹å‘ _sentinel_:hello é¢‘é“ä¸Šå‘é€è¯¥ Sentinel èŠ‚ç‚¹å¯¹äºä¸»èŠ‚ç‚¹çš„åˆ¤æ–­ä¸€çº§å½“å‰ Sentinel èŠ‚ç‚¹çš„ä¿¡æ¯, åŒæ—¶æ¯ä¸ª
   Sentinel èŠ‚ç‚¹ä¹Ÿä¼šè®¢é˜…è¯¥é¢‘é“;
   ![20241229154732_ug9RgBvu.webp](https://cdn.dong4j.site/source/image/20241229154732_ug9RgBvu.webp)

3. æ¯éš” 1 ç§’, æ¯ä¸ª Sentine ä¼šå‘ä¸»ä»èŠ‚ç‚¹, å…¶ä»– Sentinel èŠ‚ç‚¹å‘é€ ping å‘½ä»¤åšå¿ƒè·³æ£€æµ‹, æ¥ç¡®ä¿èŠ‚ç‚¹å½“å‰æ˜¯å¦å¯è¾¾
   ![20241229154732_OuXnSfQM.webp](https://cdn.dong4j.site/source/image/20241229154732_OuXnSfQM.webp)

#### ä¸»è§‚ä¸‹çº¿ï¼ˆSubjectively Downï¼Œ ç®€ç§° SDOWNï¼‰

> æŒ‡çš„æ˜¯å•ä¸ª Sentinel å®ä¾‹å¯¹æœåŠ¡å™¨åšå‡ºçš„ä¸‹çº¿åˆ¤æ–­ã€‚

æ¯ä¸ª Sentinel èŠ‚ç‚¹ä¼šæ¯éš” 1 ç§’å¯¹ä¸»èŠ‚ ç‚¹ã€ä»èŠ‚ç‚¹ã€å…¶ä»– Sentinel èŠ‚ç‚¹å‘é€ ping å‘½ä»¤åšå¿ƒè·³æ£€æµ‹ï¼Œå½“è¿™äº›èŠ‚ç‚¹è¶…è¿‡ down-after-milliseconds
æ²¡æœ‰è¿›è¡Œæœ‰æ•ˆå›å¤ï¼ŒSentinel èŠ‚ç‚¹å°±ä¼šå¯¹è¯¥èŠ‚ç‚¹åšå¤±è´¥ åˆ¤å®šï¼Œè¿™ä¸ªè¡Œä¸ºå«åšä¸»è§‚ä¸‹çº¿

![20241229154732_7Uguxxes.webp](https://cdn.dong4j.site/source/image/20241229154732_7Uguxxes.webp)

#### å®¢è§‚ä¸‹çº¿ï¼ˆObjectively Downï¼Œ ç®€ç§° ODOWNï¼‰

> æŒ‡çš„æ˜¯å¤šä¸ª Sentinel å®ä¾‹åœ¨å¯¹åŒä¸€ä¸ªæœåŠ¡å™¨åšå‡º SDOWN åˆ¤æ–­ï¼Œ å¹¶ä¸”é€šè¿‡ SENTINEL is-master-down-by-addr å‘½ä»¤äº’ç›¸äº¤æµä¹‹åï¼Œ å¾—å‡ºçš„æœåŠ¡å™¨ä¸‹çº¿åˆ¤æ–­ã€‚
> ï¼ˆä¸€ä¸ª Sentinel å¯ä»¥é€šè¿‡å‘å¦ä¸€ä¸ª Sentinel å‘é€ SENTINEL is-master-down-by-addr å‘½ä»¤æ¥è¯¢é—®å¯¹æ–¹æ˜¯å¦è®¤ä¸ºç»™å®šçš„æœåŠ¡å™¨å·²ä¸‹çº¿ã€‚ï¼‰

## Redis Sentinel å®‰è£…ä¸éƒ¨ç½²

ä¸‹é¢å°†ä»¥ 3 ä¸ª Sentinel èŠ‚ç‚¹ã€1 ä¸ªä¸»èŠ‚ç‚¹ã€2 ä¸ªä»èŠ‚ç‚¹ç»„æˆä¸€ä¸ª Redis Sentinel è¿›è¡Œè¯´æ˜

![20241229154732_ZsDsOhqv.webp](https://cdn.dong4j.site/source/image/20241229154732_ZsDsOhqv.webp)

å…·ä½“çš„ç‰©ç†éƒ¨ç½²:

| è§’è‰²       | ip        | port  | åˆ«å       |
| :--------- | :-------- | :---- | :--------- |
| master     | 127.0.0.1 | 6379  | ä¸»èŠ‚ç‚¹     |
| slave-1    | 127.0.0.1 | 6380  | slave-1    |
| slave-2    | 127.0.0.1 | 6381  | slave-2    |
| sentinel-1 | 127.0.0.1 | 26379 | sentinel-1 |
| sentinel-2 | 127.0.0.1 | 26380 | sentinel-2 |
| sentinel-3 | 127.0.0.1 | 26381 | sentinel-3 |

**1. master é…ç½®**

```lua
daemonize yes
dbfilename "6379.db"
dir "/Users/codeai/Develop/logs/redis/db/"
logfile "/Users/codeai/Develop/logs/redis/log/6379.log"
port 6379
requirepass 1234
```

**2. slave-1 é…ç½®**

```lua
daemonize yes
dbfilename "6380.db"
dir "/Users/codeai/Develop/logs/redis/db/"
logfile "/Users/codeai/Develop/logs/redis/log/6380.log"
port 6380
slaveof 127.0.0.1 6379
# è®¾ç½® master éªŒè¯å¯†ç 
masterauth 1234
# è®¾ç½® slave å¯†ç 
requirepass 1234
```

**3. slave-2 é…ç½®**

```lua
daemonize yes
dbfilename "6381.db"
dir "/Users/codeai/Develop/logs/redis/db/"
logfile "/Users/codeai/Develop/logs/redis/log/6381.log"
port 6381
slaveof 127.0.0.1 6379
# è®¾ç½® master éªŒè¯å¯†ç 
masterauth 1234
# è®¾ç½® slave å¯†ç 
requirepass 1234
```

**4. å¯åŠ¨ redis æœåŠ¡**

```lua
redis-server redis-6379.conf; redis-server redis-6380.conf; redis-server redis-6381.conf
```

![20241229154732_MofUCgDd.webp](https://cdn.dong4j.site/source/image/20241229154732_MofUCgDd.webp)

**5. ç¡®è®¤ä¸»ä»å…³ç³»**

ä¸»èŠ‚ç‚¹è§†è§’

```lua
redis-cli -h 127.0.0.1 -p 6379 info replication
# Replication
# ä¸»èŠ‚ç‚¹
role:master
# æœ‰ 2 ä¸ª ä»èŠ‚ç‚¹
connected_slaves:2
# ä»èŠ‚ç‚¹ 1 ä¿¡æ¯
slave0:ip=127.0.0.1,port=6380,state=online,offset=112,lag=0
# ä»èŠ‚ç‚¹ 2 ä¿¡æ¯
slave1:ip=127.0.0.1,port=6381,state=online,offset=112,lag=0
master_replid:8f43dc48cca779f46fa1516a38e24fb8c5423d94
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:112
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:112
```

ä»èŠ‚ç‚¹è§†è§’

```lua
redis-cli -h 127.0.0.1 -p 6380 info replication
# Replication
# ä»èŠ‚ç‚¹
role:slave
# ä¸»èŠ‚ç‚¹ä¿¡æ¯
master_host:127.0.0.1
master_port:6379
master_link_status:up
master_last_io_seconds_ago:2
master_sync_in_progress:0
slave_repl_offset:238
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:8f43dc48cca779f46fa1516a38e24fb8c5423d94
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:238
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:238
```

**6. éƒ¨ç½² Sentinel èŠ‚ç‚¹**

```lua
port 26379
daemonize yes
logfile "/Users/codeai/Develop/logs/redis/log/26379.log"
dir "/Users/codeai/Develop/logs/redis/db/"
# ç›‘æ§ 127.0.0.1:6379 ä¸»èŠ‚ç‚¹; 2 è¡¨ç¤ºåˆ¤æ–­ä¸»èŠ‚ç‚¹å¤±è´¥è‡³å°‘éœ€è¦ 2 ä¸ª sentinel èŠ‚ç‚¹åŒæ„
sentinel monitor mymaster 127.0.0.1 6379 2
# è®¾ç½®ç›‘å¬çš„ master å¯†ç 
sentinel auth-pass mymaster 1234
# 30 ç§’å†… ping å¤±è´¥, sentinel åˆ™è®¤ä¸º master ä¸å¯ç”¨
sentinel down-after-milliseconds mymaster 30000
# åœ¨å‘ç”Ÿ failover ä¸»å¤‡åˆ‡æ¢æ—¶ï¼Œè¿™ä¸ªé€‰é¡¹æŒ‡å®šäº†æœ€å¤šå¯ä»¥æœ‰å¤šå°‘ä¸ª slave åŒæ—¶å¯¹æ–°çš„ master è¿›è¡ŒåŒæ­¥
sentinel parallel-syncs mymaster 1
# å¦‚æœåœ¨è¯¥æ—¶é—´ï¼ˆmsï¼‰å†…æœªèƒ½å®Œæˆ failover æ“ä½œï¼Œåˆ™è®¤ä¸ºè¯¥ failover å¤±è´¥
sentinel failover-timeout mymaster 180000
```

å…¶ä»–èŠ‚ç‚¹åªæ˜¯ç«¯å£ä¸åŒ

**7. å¯åŠ¨ sentinel èŠ‚ç‚¹**

```lua
# æ–¹å¼ä¸€
redis-sentinel redis-sentinel-26379.conf; redis-sentinel redis-sentinel-26380.conf; redis-sentinel redis-sentinel-26381.conf
# æ–¹å¼äºŒ
redis-server redis-sentinel-26379.conf --sentinel; redis-server redis-sentinel-26380.conf --sentinel; redis-server redis-sentinel-26381.conf --sentinel;
```

![20241229154732_zCpl5IS6.webp](https://cdn.dong4j.site/source/image/20241229154732_zCpl5IS6.webp)

**8. ç¡®è®¤å…³ç³»**

```lua
redis-cli -h 127.0.0.1 -p 26379 info sentinel
# Sentinel
sentinel_masters:1
sentinel_tilt:0
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
sentinel_simulate_failure_flags:0
master0:name=mymaster,status=ok,address=127.0.0.1:6379,slaves=2,sentinels=3
```

## éƒ¨ç½²æ–¹æ¡ˆ

1. Sentinel éƒ¨ç½²åœ¨ä¸åŒç‰©ç†æœºä¸Š;
2. éƒ¨ç½²è‡³å°‘ä¸‰ä¸ªä¸”å¥‡æ•°ä¸ªçš„ Sentinel èŠ‚ç‚¹;

### ä¸€å¥— Sentinel ç›‘æ§æ‰€æœ‰ä¸»èŠ‚ç‚¹

![20241229154732_iGgNGxWd.webp](https://cdn.dong4j.site/source/image/20241229154732_iGgNGxWd.webp)

ä¼˜ç‚¹:

1. ç»´æŠ¤æˆæœ¬ä½

ç¼ºç‚¹:

1. é›†ç¾¤å‡ºç°å¼‚å¸¸, å°†å¯¼è‡´æœåŠ¡ä¸å¯ç”¨
2. è¿‡å¤šçš„ç½‘ç»œè¿æ¥

### æ¯ä¸ªä¸»èŠ‚ç‚¹å„ä¸€å¥— Sentinel

![20241229154732_Co7PVXld.webp](https://cdn.dong4j.site/source/image/20241229154732_Co7PVXld.webp)

ä¼˜ç‚¹:

1. æŸä¸ª Sentinel é›†ç¾¤å‡ºç°æ•…éšœ, ä¸ä¼šå½±å“å…¶ä»–ä¸šåŠ¡
2. ç½‘ç»œè¿æ¥å°‘

ç¼ºç‚¹:

1. ç»´æŠ¤æˆæœ¬é«˜

> å¦‚æœç›‘æ§åŒä¸€ä¸ªä¸šåŠ¡çš„å¤šä¸ªä¸»èŠ‚ç‚¹é›†åˆ, æ¨èä½¿ç”¨æ–¹æ¡ˆä¸€
> å¦‚æœæ˜¯å¤šä¸ªä¸šåŠ¡ä¸åŒä¸»èŠ‚ç‚¹é›†åˆ, æ¨èæ–¹æ¡ˆäºŒ (æ¨è)

## Redis è¿æ¥æ•°å¤ªå¤šå¯¼è‡´

### åŸå› åˆ†æ

Redis é»˜è®¤æœ€å¤§è¿æ¥æ•°ä¸º 10000 ä¸ª

1. ç½‘ç»œé€šä¿¡å·®, æŒ‰ç…§ TCP åè®®ï¼Œå®¢æˆ·ç«¯æ–­å¼€è¿æ¥æ—¶ï¼Œå‘æœåŠ¡å™¨ç«¯å‘é€ FIN ä¿¡å·ï¼Œä½†æ˜¯æœåŠ¡ç«¯æœªæ¥æ”¶åˆ°ï¼Œå®¢æˆ·ç«¯è¶…æ—¶åæ”¾å¼ƒç­‰å¾…ï¼Œç›´æ¥æ–­å¼€ï¼ŒæœåŠ¡ç«¯ç”±äºé€šä¿¡æ•…éšœï¼Œä¿æŒäº†
   ESTABLISHED çŠ¶æ€;
2. å®¢æˆ·ç«¯å¼‚å¸¸, å®¢æˆ·ç«¯è¿æ¥ä¹‹åï¼Œç”±äºä»£ç è¿è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿå¼‚å¸¸ï¼Œå¯¼è‡´æœªæ­£å¸¸é‡Šæ”¾æˆ–è€…å…³é—­è¿æ¥;
3. client è®¾ç½®ä¸åˆç† (`client æ•° * maxTotal` æ˜¯ä¸èƒ½è¶…è¿‡ redis çš„æœ€å¤§è¿æ¥æ•°)

### è§£å†³æ–¹æ¡ˆ

**1. ä¿®æ”¹ redis.config é…ç½®**

```
# è¿æ¥çš„ç©ºé—²å®ç°è¶…è¿‡ 360s, åˆ™ä¸»åŠ¨å…³é—­è¿æ¥; é»˜è®¤é…ç½®ä¸º 0 , å¯¼è‡´æ‰€æœ‰ç©ºé—² idle è¿æ¥æœªè¢«é‡Šæ”¾, æœåŠ¡ç«¯è¿æ¥æ³„æ¼
timeout 360
# é»˜è®¤å…³é—­, å¯¼è‡´æœåŠ¡ç«¯ä¸çŸ¥å®¢æˆ·ç«¯è¿æ¥çŠ¶æ€; å¼€å¯é•¿è¿æ¥, æœåŠ¡ç«¯ä¸»åŠ¨ (60s) æ¢æµ‹å®¢æˆ·ç«¯ socket çŠ¶æ€
tcp-keeplive 60
```

**2. å®Œå–„ä»£ç **

> å®¢æˆ·ç«¯æ¯æ¬¡æ‰§è¡Œå®Œ jedis é‡Œé¢çš„æ–¹æ³•ä¹‹åå¿…é¡»å…³é—­é“¾æ¥ï¼Œé‡Šæ”¾èµ„æº

**3. redis-proxy æœåŠ¡åŒ–**

---

## é‡æ„æ–¹æ¡ˆ

> ä½¿ç”¨ Redis Sentinel ä»£æ›¿ Redis + Keepalived

### æ¶æ„

é‡æ„ redis-proxy

æä¾› 6 ç§ è¿æ¥æ¨¡å¼

![20241229154732_smjFqOxg.webp](https://cdn.dong4j.site/source/image/20241229154732_smjFqOxg.webp)

### component-redis ä»‹ç»

é¡¹ç›®ä¸­æœ‰å•ç‹¬ä½¿ç”¨ Redis çš„, ä¹Ÿæœ‰ä½¿ç”¨åˆ†ç‰‡æ–¹å¼è¿æ¥çš„, ä¹Ÿæœ‰ä½¿ç”¨ redis-proxy ç»„ä»¶æ¥è¿æ¥ Redis çš„.
é€ æˆä»£ç ä¸å¥½ç®¡ç†, å› æ­¤ä½¿ç”¨ component-redis ç»„ä»¶ä¸ºå…¶ä»–æ¨¡å—æä¾›è¿æ¥ Redis çš„åŠŸèƒ½, ç»Ÿä¸€ç®¡ç† Redis ç›¸å…³ä»£ç .

ä½œä¸ºè¿æ¥ Redis çš„å·¥å…·æ¨¡å—, ä¸ºå…¶ä»–æ¨¡å—æä¾›æ“ä½œ Redis çš„åŠŸèƒ½, å…·æœ‰å¤šç§æ¨¡å¼é€‰æ‹©.
å®¢æˆ·ç«¯ä¸éœ€è¦å†å†™è¿æ¥ Redis ç›¸å…³ä»£ç , åªéœ€è¦æŒ‰ç…§è¦æ±‚é…ç½®å³å¯, å‡å°‘äº†å†—ä½™ä»£ç ;

å…¼å®¹åŸæœ‰ä»£ç , åªéœ€è¦å°† redis-proxy ä¾èµ–æ›¿æ¢æˆ component-redis å³å¯ä½¿ç”¨.

#### åŠŸèƒ½

1. å¤šç§æ¨¡å¼ä»»å›é€‰æ‹© (standalone, sentinel, shard, shard-sentinel, cluster, hybrid);
2. ä½¿ç”¨ç®€å•, å¼•å…¥ jar å³å¯ä½¿ç”¨;
3. æ‰©å±•æ–¹ä¾¿, å¦‚æœ `RedisService` æ»¡è¶³ä¸äº†ç°æœ‰ä¸šåŠ¡éœ€è¦, å¯ç›´æ¥ä½¿ç”¨å„ç§ Pool è·å– jedis, shardedJedis, jedisCluster è‡ªç”±å‘æŒ¥;

#### ä½¿ç”¨æ–¹å¼

##### 1. å¼•å…¥ä¾èµ–

```xml
<dependency>
    <groupId>com.xxxx.msearch</groupId>
    <artifactId>component-redis</artifactId>
    <version> æœ€æ–°ç‰ˆæœ¬ </version>
</dependency>
```

##### 2. é…ç½®

```lua
# jedis pool é…ç½®
# è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
redis.connectionTimeout=2000
# ç­‰å¾… Response è¶…æ—¶æ—¶é—´ (æ–°å¢)
redis.soTimeout=5000
redis.pool.maxActive=5000
redis.pool.maxWait=5000
redis.pool.maxIdle=200
redis.pool.minIdleTime=120
redis.pool.testOnBorrow=true
redis.pool.testOnReturn=false
# Redis é…ç½®
redis.model=standalone
redis.node=redis://127.0.0.1:6379
```

##### 3. æ³¨å…¥ service

```java
@Autowired
private RedisService redisService;
@Test
public void testRedisService() throws Exception {
    redisService.set("redisServiceTest", "redisServiceTest");
}
```

### component-redis é…ç½®è§„èŒƒ

> ç”±äº component-redis ç»„ä»¶éœ€è¦æ”¯æŒå¤šç§æ¨¡å¼, é…ç½®éœ€è¦è§„èŒƒçš„æ ¼å¼æ‰èƒ½é¿å…å‡ºé”™.

1. èŠ‚ç‚¹ä½¿ç”¨ `,` åˆ†éš”, æ¨¡å¼åˆ†ç»„ä½¿ç”¨ `;` åˆ†éš”;
2. ä½¿ç”¨æŸä¸ª Redis æ—¶, ä¸è¦æŠŠæ‰€æœ‰é…ç½®å…¨éƒ¨åŠ ä¸Š;

jedisPool é…ç½®æ˜¯å›ºå®šé…ç½®, æ¯ç§æ¨¡å¼éƒ½ä¼šä½¿ç”¨åˆ°, åªéœ€è¦æ ¹æ®ä¸šåŠ¡è°ƒæ•´å³å¯.

```lua
## è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
redis.connectionTimeout=2000
# ç­‰å¾… Response è¶…æ—¶æ—¶é—´ (æ–°å¢)
redis.soTimeout=5000
# è¿æ¥æ± æœ€å¤§è¿æ¥æ•°ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰
redis.pool.maxActive=5000
# è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰
redis.pool.maxWait=5000
# è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥
redis.pool.maxIdle=200
# è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥
redis.pool.minIdleTime=120
# å½“è°ƒç”¨ borrow Object æ–¹æ³•æ—¶ï¼Œæ˜¯å¦è¿›è¡Œæœ‰æ•ˆæ€§æ£€æŸ¥
redis.pool.testOnBorrow=true
# è°ƒç”¨ return ä¸€ä¸ªå¯¹è±¡æ–¹æ³•æ—¶ï¼Œæ˜¯å¦æ£€æŸ¥å…¶æœ‰æ•ˆæ€§
redis.pool.testOnReturn=false
```

```lua
redis.model= æ¨¡å¼å
redis.node= ä¸šåŠ¡å #æ¨¡å¼å://[:password@]ip:port[/database];...
```

è¿™é‡Œä»¥ç°æœ‰ä¸šåŠ¡ä¸ºä¾‹å­:

```lua
redis.model=hybrid
# callout ä½¿ç”¨å•æœºæ¨¡å¼, biz ä½¿ç”¨å“¨å…µæ¨¡å¼
redis.node=callout#standalone://:1234@127.0.0.1:6382;biz#sentinel://:5678@127.0.0.1:26379,sentinel://127.0.0.1:26380,sentinel://127.0.0.1:26381
```

#### é…ç½®ä¼˜åŒ–

**ä½¿ç”¨æ ‡å‡†çš„ uri åè®®ä»£æ›¿ host å’Œ port**

é¿å…æ‰‹åŠ¨è§£æå‡ºé”™

æ ¼å¼å¦‚ä¸‹:

```lua
# å®Œæ•´æ ¼å¼
redis://user:password@ip:port/database
# ä¸éœ€è¦ç”¨æˆ·åçš„æ ¼å¼
redis://:password@ip:port/database
# ä¸éœ€è¦å¯†ç çš„æ ¼å¼
redis://ip:port/database
# ä¸éœ€è¦ database çš„é…ç½®, å°†é»˜è®¤ä½¿ç”¨ 0 db
redis://ip:port
```

**å¯†ç è®¾ç½®**

redis çš„æŸ¥è¯¢é€Ÿåº¦æ˜¯éå¸¸å¿«çš„ï¼Œå¤–éƒ¨ç”¨æˆ·ä¸€ç§’å†…å¯ä»¥å°è¯•å¤šå¤§ 150K ä¸ªå¯†ç ï¼›æ‰€ä»¥å¯†ç è¦å°½é‡é•¿;

å»ºè®®è®¾ç½®ä¸º 64 ä½é•¿åº¦å¯†ç 

##### standalone (å•æœº) æ¨¡å¼é…ç½®

```lua
redis.model=standalone
# password å‰é¢çš„ : ä¸èƒ½å°‘
redis.node=redis://:password@127.0.0.1:6382
```

demo:

```lua
redis.model=standalone
redis.node=redis://127.0.0.1:6379
```

##### sentinel

å“¨å…µæ¨¡å¼æ˜¯å¯¹å•æœºæ¨¡å¼é«˜å¯ç”¨çš„ä¸€ç§å®ç°æ–¹å¼, å¯ä»¥å®ç°æ•…éšœä¸»ä»è‡ªåŠ¨åˆ‡æ¢

å“¨å…µæ¨¡å¼éœ€è¦é…ç½® master name, å’Œ `redis-sentinel`.conf ä¸­çš„ `sentinel monitor masterName xxx` ä¿æŒä¸€è‡´

å“¨å…µæ¨¡å¼åªèƒ½æ¥æ”¶ä¸€ä¸ªå¯†ç , å¯†ç è®¾ç½®åœ¨ä»»æ„èŠ‚ç‚¹å³å¯ (ç¬¬ä¸€ä¸ªæœ€å¥½äº†)

```properties
redis.model=sentinel
redis.node=mymaster#redis://:1234@127.0.0.1:26379,redis://127.0.0.1:26380,redis://127.0.0.1:26381
```

å“¨å…µæ¨¡å¼å°±æ˜¯å•æœºæ¨¡å¼çš„å¢å¼ºç‰ˆ, éœ€è¦é…ç½®å¤šä¸ªå“¨å…µèŠ‚ç‚¹ (é¿å…é€ æˆä¸»ä»åˆ‡æ¢å¤±è´¥, æœ€å°‘ 3 ç»„å“¨å…µ), èŠ‚ç‚¹ä¹‹é—´ä½¿ç”¨ `,` åˆ†éš”

demo:

```lua
redis.model=sentinel
redis.node=mymaster#redis://:s4jRcLhAcUdKrNmqv9XQxwbEUZ6p4sK3kTFE4k9ts3PLahnswEzE4aPgXEQ6QdMa@127.0.0.1:26379,redis://127.0.0.1:26380,redis://127.0.0.1:26381
```

##### sharding (åˆ†ç‰‡) æ¨¡å¼é…ç½®

**æ¯ç»„ redis å®ä¾‹å¯ä»¥è®¾ç½®ä¸åŒçš„å¯†ç **

åˆ†ç‰‡å®ä¾‹ä¹‹é—´ä½¿ç”¨ `,` åˆ†éš”

```lua
redis.model=sharding
redis.node=redis://:1234@127.0.0.1:6382,redis://:5678@127.0.0.1:6382
```

demo:

```lua
# redis://:password@ip:port/database æ²¡æœ‰å¯†ç åˆ™ä½¿ç”¨ redis://ip:port/database
redis.model=sharding
redis.node=redis://:1234@127.0.0.1:6382,redis://:s4jRcLhAcUdKrNmqv9XQxwbEUZ6p4sK3kTFE4k9ts3PLahnswEzE4aPgXEQ6QdMa@127.0.0.1:6379
```

##### sharding-sentinel

åˆ†ç‰‡å“¨å…µæ¨¡å¼æ˜¯å¯¹åˆ†ç‰‡æ¨¡å¼é«˜å¯ç”¨çš„ä¸€ç§å®ç°æ–¹å¼, å¯ä»¥å®ç°åˆ†ç‰‡æ¨¡å¼ä¸‹, æ•…éšœä¸»ä»è‡ªåŠ¨åˆ‡æ¢

åˆ†ç‰‡å“¨å…µæ¨¡å¼æ˜¯å“¨å…µæ¨¡å¼å’Œåˆ†ç‰‡æ¨¡å¼çš„ç»“åˆ, é…ç½®å¯

demo:

```lua
redis.model=sharding-sentinel
redis.node=mymaster#redis://127.0.0.1:26379,redis://127.0.0.1:26380,redis://127.0.0.1:26381;mymaster1#redis://127.0.0.1:26379,redis://127.0.0.1:26380,redis://127.0.0.1:26381
```

##### cluster

redis 3.x è¿œç¨‹é›†ç¾¤æ¨¡å¼

demo:

```lua
redis.model=cluster
redis.node=redis://127.0.0.1:6379,redis://127.0.0.1:6380,redis://127.0.0.1:6381
```

##### hybrid

æ··åˆæ¨¡å¼, ä¸ºäº†å…¼å®¹ç°æœ‰ Redis ç¯å¢ƒ, ä¸€ç§ä¸´æ—¶çš„è§£å†³æ–¹æ¡ˆ, æ”¹é€ å®Œæˆå, å°†é…ç½®ä¿®æ”¹ä¸º `sentinel` å³å¯

demo:

```lua
redis.model=hybrid
redis.node=callout#standalone://:1234@127.0.0.1:6382;mymaster#sentinel://:s4jRcLhAcUdKrNmqv9XQxwbEUZ6p4sK3kTFE4k9ts3PLahnswEzE4aPgXEQ6QdMa@127.0.0.1:26379,sentinel://127.0.0.1:26380,sentinel://127.0.0.1:26381
```

æ··åˆæ¨¡å¼å®ç°äº† `standalone`, `sentinel`, `sharding` æ¨¡å¼çš„æ··åˆä½¿ç”¨

### ä»£ç é‡æ„

1. ä½¿ç”¨ `@Value` å®ç°è‡ªåŠ¨é…ç½®, ä»£æ›¿ xml ä¸­çš„ bean æ ‡ç­¾;
2. ä½¿ç”¨ logbok ç®€åŒ–ä»£ç ;
3. ä¸åœ¨ä½¿ç”¨ RedisServiceFacotry è·å– redisService, æŸä¸ªæ¨¡å—éœ€è¦ä½¿ç”¨è¯¥ç»„ä»¶æ—¶, import xml å³å¯ (å¤šå®¹å™¨é—®é¢˜);
4. ä½¿ç”¨ log4j2 ä»£æ›¿ log4j;
5. ç¼–è¯‘ç‰ˆæœ¬ç”± jdk1.6 æ”¹ä¸º jdk1.7;
6. ä½¿ç”¨ä»£ç†ç±»é‡æ„å®‰å…¨å…³é—­ jedis è¿æ¥çš„æ–¹å¼;

é‡æ„å‰:

```java
@Override
public String set(String flag, final String key, final String value) throws Exception {
	return new RedisCallBack<String>() {
		@Override
		public String doCallback(Jedis jedis) {
			return jedis.set(key, value);
		}
	}.callback(getJedisPoolByFlag(flag));
}
```

é‡æ„å:

```java
@Override
public String set(String flag, final String key, final String value) {
    return RedisUtil.jedisProxy(model, flag).set(key, value);
}
```

## [Javaå¼€å‘è€…çš„ç—›ï¼šå¦‚ä½•é¿å…å’Œè§£å†³å¸¸è§çš„JaråŒ…å†²çªé—®é¢˜](https://blog.dong4j.site/posts/a65dfb13.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

Jar åŒ…å†²çªæ˜¯è€ç”Ÿå¸¸è°ˆçš„é—®é¢˜ï¼Œå‡ ä¹æ¯ä¸€ä¸ª Java ç¨‹åºçŒ¿éƒ½ä¸å¯é¿å…åœ°é‡åˆ°è¿‡ï¼Œå¹¶ä¸”ä¹Ÿéƒ½èƒ½æƒ³åˆ°é€šå¸¸çš„åŸå› ä¸€èˆ¬æ˜¯åŒä¸€ä¸ª Jar åŒ…ç”±äº maven ä¼ é€’ä¾èµ–ç­‰åŸå› è¢«å¼•è¿›äº†å¤šä¸ªä¸åŒçš„ç‰ˆæœ¬è€Œå¯¼è‡´ï¼Œå¯é‡‡ç”¨ä¾èµ–æ’é™¤ã€ä¾èµ–ç®¡ç†ç­‰å¸¸è§„æ–¹å¼æ¥å°è¯•è§£å†³è¯¥é—®é¢˜ï¼Œä½†è¿™äº›æ–¹å¼çœŸæ­£èƒ½å½»åº•è§£å†³è¯¥å†²çªé—®é¢˜å—ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚ç¬”è€…ä¹‹æ‰€ä»¥å°†æ–‡ç« é¢˜ç›®èµ·ä¸º â€œé‡æ–°çœ‹å¾…â€ï¼Œæ˜¯å› ä¸ºä¹‹å‰å¯¹äº Jar åŒ…å†²çªé—®é¢˜çš„ç†è§£ä»…ä»…åœç•™åœ¨å‰é¢æ‰€è¯´çš„é‚£äº›ï¼Œç›´åˆ°åœ¨å·¥ä½œä¸­é‡åˆ°çš„ä¸€ç³»åˆ— Jar åŒ…å†²çªé—®é¢˜åï¼Œæ‰å‘ç°å¹¶ä¸æ˜¯é‚£ä¹ˆç®€å•ï¼Œå¯¹è¯¥é—®é¢˜æœ‰äº†é‡æ–°çš„è®¤è¯†ï¼Œæ¥ä¸‹æ¥æœ¬æ–‡å°†å›´ç»• Jar åŒ…å†²çªçš„é—®é¢˜æœ¬è´¨å’Œç›¸å…³çš„è§£å†³æ–¹æ¡ˆè¿™ä¸¤ä¸ªç‚¹è¿›è¡Œé˜è¿°ã€‚

# Jar åŒ…å†²çªé—®é¢˜

## ä¸€ã€å†²çªçš„æœ¬è´¨

Jar åŒ…å†²çªçš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼ŸGoogle äº†åŠå¤©ä¹Ÿæ²¡æ‰¾åˆ°ä¸€ä¸ªè®©äººæ»¡æ„çš„å®Œæ•´å®šä¹‰ã€‚å…¶å®ï¼Œæˆ‘ä»¬å¯ä»¥ä» Jar åŒ…å†²çªäº§ç”Ÿçš„ç»“æœæ¥æ€»ç»“ï¼Œåœ¨è¿™é‡Œç»™å‡ºå¦‚ä¸‹å®šä¹‰ï¼ˆæ­¤å¤„å¦‚æœ‰ä¸å¦¥ï¼Œæ¬¢è¿æ‹ç – Â -ï¼‰ï¼š

> **Java åº”ç”¨ç¨‹åºå› æŸç§å› ç´ ï¼ŒåŠ è½½ä¸åˆ°æ­£ç¡®çš„ç±»è€Œå¯¼è‡´å…¶è¡Œä¸ºè·Ÿé¢„æœŸä¸ä¸€è‡´ã€‚**

å…·ä½“æ¥è¯´å¯åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š1ï¼‰åº”ç”¨ç¨‹åºä¾èµ–çš„åŒä¸€ä¸ª Jar åŒ…å‡ºç°äº†å¤šä¸ªä¸åŒç‰ˆæœ¬ï¼Œå¹¶é€‰æ‹©äº†é”™è¯¯çš„ç‰ˆæœ¬è€Œå¯¼è‡´ JVM åŠ è½½ä¸åˆ°éœ€è¦çš„ç±»æˆ–åŠ è½½äº†é”™è¯¯ç‰ˆæœ¬çš„ç±»ï¼Œä¸ºäº†å™è¿°çš„æ–¹ä¾¿ï¼Œç¬”è€…ç§°ä¹‹ä¸º**ç¬¬ä¸€ç±» Jar åŒ…å†²çªé—®é¢˜**ï¼›2ï¼‰åŒæ ·çš„ç±»ï¼ˆç±»çš„å…¨é™å®šåå®Œå…¨ä¸€æ ·ï¼‰å‡ºç°åœ¨å¤šä¸ªä¸åŒçš„ä¾èµ– Jar åŒ…ä¸­ï¼Œå³è¯¥ç±»æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œå¹¶ç”±äº Jar åŒ…åŠ è½½çš„å…ˆåé¡ºåºå¯¼è‡´ JVM åŠ è½½äº†é”™è¯¯ç‰ˆæœ¬çš„ç±»ï¼Œç§°ä¹‹ä¸º**ç¬¬äºŒç±» Jar åŒ…é—®é¢˜**ã€‚è¿™ä¸¤ç§æƒ…å†µæ‰€å¯¼è‡´çš„ç»“æœå…¶å®æ˜¯ä¸€æ ·çš„ï¼Œéƒ½ä¼šä½¿åº”ç”¨ç¨‹åºåŠ è½½ä¸åˆ°æ­£ç¡®çš„ç±»ï¼Œé‚£å…¶è¡Œä¸ºè‡ªç„¶ä¼šè·Ÿé¢„æœŸä¸ä¸€è‡´äº†ï¼Œä»¥ä¸‹å¯¹è¿™ä¸¤ç§ç±»å‹è¿›è¡Œè¯¦ç»†åˆ†æã€‚

### 1.1 åŒä¸€ä¸ª Jar åŒ…å‡ºç°äº†å¤šä¸ªä¸åŒç‰ˆæœ¬

éšç€ Jar åŒ…è¿­ä»£å‡çº§ï¼Œæˆ‘ä»¬æ‰€ä¾èµ–çš„å¼€æºçš„æˆ–å…¬å¸å†…éƒ¨çš„ Jar åŒ…å·¥å…·éƒ½ä¼šå­˜åœ¨è‹¥å¹²ä¸åŒçš„ç‰ˆæœ¬ï¼Œè€Œç‰ˆæœ¬å‡çº§è‡ªç„¶å°±é¿å…ä¸äº†ç±»çš„æ–¹æ³•ç­¾åå˜æ›´ï¼Œç”šè‡³äºç±»åçš„æ›´æ›¿ï¼Œè€Œæˆ‘ä»¬å½“å‰çš„åº”ç”¨ç¨‹åºå¾€å¾€ä¾èµ–ç‰¹å®šç‰ˆæœ¬çš„æŸä¸ªç±» Â **M**Â ï¼Œç”±äº maven çš„ä¼ é€’ä¾èµ–è€Œå¯¼è‡´åŒä¸€ä¸ª Jar åŒ…å‡ºç°äº†å¤šä¸ªç‰ˆæœ¬ï¼Œå½“ maven çš„ä»²è£æœºåˆ¶é€‰æ‹©äº†é”™è¯¯çš„ç‰ˆæœ¬æ—¶ï¼Œè€Œæ°å¥½ç±» Â **M**Â  åœ¨è¯¥ç‰ˆæœ¬ä¸­è¢«å»æ‰äº†ï¼Œæˆ–è€…æ–¹æ³•ç­¾åæ”¹äº†ï¼Œå¯¼è‡´åº”ç”¨ç¨‹åºå› æ‰¾ä¸åˆ°æ‰€éœ€çš„ç±» Â **M**Â  æˆ–æ‰¾ä¸åˆ°ç±» Â **M**Â  ä¸­çš„ç‰¹å®šæ–¹æ³•ï¼Œå°±ä¼šå‡ºç°ç¬¬ä¸€ç±» Jar å†²çªé—®é¢˜ã€‚å¯æ€»ç»“å‡ºè¯¥ç±»å†²çªé—®é¢˜å‘ç”Ÿçš„ä»¥ä¸‹ä¸‰ä¸ªå¿…è¦æ¡ä»¶ï¼š

- ç”±äº maven çš„ä¼ é€’ä¾èµ–å¯¼è‡´ä¾èµ–æ ‘ä¸­å‡ºç°äº†åŒä¸€ä¸ª Jar åŒ…çš„å¤šä¸ªç‰ˆæœ¬
- è¯¥ Jar åŒ…çš„å¤šä¸ªç‰ˆæœ¬ä¹‹é—´å­˜åœ¨æ¥å£å·®å¼‚ï¼Œå¦‚ç±»åæ›´æ›¿ï¼Œæ–¹æ³•ç­¾åæ›´æ›¿ç­‰ï¼Œä¸”åº”ç”¨ç¨‹åºä¾èµ–äº†å…¶ä¸­æœ‰å˜æ›´çš„ç±»æˆ–æ–¹æ³•
- maven çš„ä»²è£æœºåˆ¶é€‰æ‹©äº†é”™è¯¯çš„ç‰ˆæœ¬

### 1.2 åŒä¸€ä¸ªç±»å‡ºç°åœ¨å¤šä¸ªä¸åŒ Jar åŒ…ä¸­

åŒæ ·çš„ç±»å‡ºç°åœ¨äº†åº”ç”¨ç¨‹åºæ‰€ä¾èµ–çš„ä¸¤ä¸ªåŠä»¥ä¸Šçš„ä¸åŒ Jar åŒ…ä¸­ï¼Œè¿™ä¼šå¯¼è‡´ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼ŒåŒä¸€ä¸ªç±»åŠ è½½å™¨å¯¹äºåŒä¸€ä¸ªç±»åªä¼šåŠ è½½ä¸€æ¬¡ï¼ˆå¤šä¸ªä¸åŒç±»åŠ è½½å™¨å°±å¦è¯´äº†ï¼Œè¿™ä¹Ÿæ˜¯è§£å†³ Jar åŒ…å†²çªçš„ä¸€ä¸ªæ€è·¯ï¼Œåé¢ä¼šè°ˆåˆ°ï¼‰ï¼Œé‚£ä¹ˆå½“ä¸€ä¸ªç±»å‡ºç°åœ¨äº†å¤šä¸ª Jar åŒ…ä¸­ï¼Œå‡è®¾æœ‰ Â **A**Â ã€Â **B**Â ã€Â **C**Â  ç­‰ï¼Œç”±äº Jar åŒ…ä¾èµ–çš„è·¯å¾„é•¿çŸ­ã€å£°æ˜çš„å…ˆåé¡ºåºæˆ–æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶åŠ è½½é¡ºåºç­‰åŸå› ï¼Œç±»åŠ è½½å™¨é¦–å…ˆä» Jar åŒ… Â **A**Â  ä¸­åŠ è½½äº†è¯¥ç±»åï¼Œå°±ä¸ä¼šåŠ è½½å…¶ä½™ Jar åŒ…ä¸­çš„è¿™ä¸ªç±»äº†ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šå¦‚æœåº”ç”¨ç¨‹åºæ­¤æ—¶éœ€è¦çš„æ˜¯ Jar åŒ… Â **B**Â  ä¸­çš„ç±»ç‰ˆæœ¬ï¼Œå¹¶ä¸”è¯¥ç±»åœ¨ Jar åŒ… Â **A**Â  å’Œ Â **B**Â  ä¸­æœ‰å·®å¼‚ï¼ˆæ–¹æ³•ä¸åŒã€æˆå‘˜ä¸åŒç­‰ç­‰ï¼‰ï¼Œè€Œ JVM å´åŠ è½½äº† Jar åŒ… Â **A**Â  çš„ä¸­çš„ç±»ç‰ˆæœ¬ï¼Œä¸æœŸæœ›ä¸ä¸€è‡´ï¼Œè‡ªç„¶å°±ä¼šå‡ºç°å„ç§è¯¡å¼‚çš„é—®é¢˜ã€‚

ä»ä¸Šé¢çš„æè¿°ä¸­ï¼Œå¯ä»¥å‘ç°å‡ºç°ä¸åŒ Jar åŒ…çš„å†²çªé—®é¢˜æœ‰ä»¥ä¸‹ä¸‰ä¸ªå¿…è¦æ¡ä»¶ï¼š

- åŒä¸€ä¸ªç±» Â **M**Â  å‡ºç°åœ¨äº†å¤šä¸ªä¾èµ–çš„ Jar åŒ…ä¸­ï¼Œä¸ºäº†å™è¿°æ–¹ä¾¿ï¼Œå‡è®¾è¿˜æ˜¯ä¸¤ä¸ªï¼šÂ **A**Â  å’Œ Â **B**
- Jar åŒ… Â **A**Â  å’Œ Â **B**Â  ä¸­çš„è¯¥ç±» Â **M**Â  æœ‰å·®å¼‚ï¼Œæ— è®ºæ˜¯æ–¹æ³•ç­¾åä¸åŒä¹Ÿå¥½ï¼Œæˆå‘˜å˜é‡ä¸åŒä¹Ÿå¥½ï¼Œåªè¦å¯ä»¥é€ æˆå®é™…åŠ è½½çš„ç±»çš„è¡Œä¸ºå’ŒæœŸæœ›ä¸ä¸€è‡´éƒ½è¡Œã€‚å¦‚æœè¯´ Jar åŒ… Â **A**Â  å’Œ Â **B**Â  ä¸­çš„è¯¥ç±»å®Œå…¨ä¸€æ ·ï¼Œé‚£ä¹ˆç±»åŠ è½½å™¨æ— è®ºå…ˆåŠ è½½å“ªä¸ª Jar åŒ…ï¼Œå¾—åˆ°çš„éƒ½æ˜¯åŒæ ·ç‰ˆæœ¬çš„ç±» Â **M**Â ï¼Œä¸ä¼šæœ‰ä»»ä½•å½±å“ï¼Œä¹Ÿå°±ä¸ä¼šå‡ºç° Jar åŒ…å†²çªå¸¦æ¥çš„è¯¡å¼‚é—®é¢˜ã€‚
- åŠ è½½çš„ç±» Â **M**Â  ä¸æ˜¯æ‰€æœŸæœ›çš„ç‰ˆæœ¬ï¼Œå³åŠ è½½äº†é”™è¯¯çš„ Jar åŒ…

## äºŒã€å†²çªçš„äº§ç”ŸåŸå› 

### 2.1 maven ä»²è£æœºåˆ¶

å½“å‰ maven å¤§è¡Œå…¶é“ï¼Œè¯´åˆ°ç¬¬ä¸€ç±» Jar åŒ…å†²çªé—®é¢˜çš„äº§ç”ŸåŸå› ï¼Œå°±ä¸å¾—ä¸æ Â [maven çš„ä¾èµ–æœºåˆ¶](https://link.jianshu.com/?t=https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html)äº†ã€‚ä¼ é€’æ€§ä¾èµ–æ˜¯ Maven2.0 å¼•å…¥çš„æ–°ç‰¹æ€§ï¼Œè®©æˆ‘ä»¬åªéœ€å…³æ³¨ç›´æ¥ä¾èµ–çš„ Jar åŒ…ï¼Œå¯¹äºé—´æ¥ä¾èµ–çš„ Jar åŒ…ï¼ŒMaven ä¼šé€šè¿‡è§£æä»è¿œç¨‹ä»“åº“è·å–çš„ä¾èµ–åŒ…çš„ pom æ–‡ä»¶æ¥éšå¼åœ°å°†å…¶å¼•å…¥ï¼Œè¿™ä¸ºæˆ‘ä»¬å¼€å‘å¸¦æ¥äº†æå¤§çš„ä¾¿åˆ©ï¼Œä½†ä¸æ­¤åŒæ—¶ï¼Œä¹Ÿå¸¦æ¥äº†å¸¸è§çš„é—®é¢˜â€”â€”ç‰ˆæœ¬å†²çªï¼Œå³åŒä¸€ä¸ª Jar åŒ…å‡ºç°äº†å¤šä¸ªä¸åŒçš„ç‰ˆæœ¬ï¼Œé’ˆå¯¹è¯¥é—®é¢˜ Maven ä¹Ÿæœ‰ä¸€å¥—ä»²è£æœºåˆ¶æ¥å†³å®šæœ€ç»ˆé€‰ç”¨å“ªä¸ªç‰ˆæœ¬ï¼Œä½†**Â Maven çš„é€‰æ‹©å¾€å¾€ä¸ä¸€å®šæ˜¯æˆ‘ä»¬æ‰€æœŸæœ›çš„**ï¼Œè¿™ä¹Ÿæ˜¯äº§ç”Ÿ Jar åŒ…å†²çªæœ€å¸¸è§çš„åŸå› ä¹‹ä¸€ã€‚å…ˆæ¥çœ‹ä¸‹ Maven çš„ä»²è£æœºåˆ¶ï¼š

- ä¼˜å…ˆæŒ‰ç…§ä¾èµ–ç®¡ç†å…ƒç´ ä¸­æŒ‡å®šçš„ç‰ˆæœ¬å£°æ˜è¿›è¡Œä»²è£ï¼Œæ­¤æ—¶ä¸‹é¢çš„ä¸¤ä¸ªåŸåˆ™éƒ½æ— æ•ˆäº†
- è‹¥æ— ç‰ˆæœ¬å£°æ˜ï¼Œåˆ™æŒ‰ç…§ â€œçŸ­è·¯å¾„ä¼˜å…ˆâ€ çš„åŸåˆ™ï¼ˆMaven2.0ï¼‰è¿›è¡Œä»²è£ï¼Œå³é€‰æ‹©ä¾èµ–æ ‘ä¸­è·¯å¾„æœ€çŸ­çš„ç‰ˆæœ¬
- è‹¥è·¯å¾„é•¿åº¦ä¸€è‡´ï¼Œåˆ™æŒ‰ç…§ â€œç¬¬ä¸€å£°æ˜ä¼˜å…ˆâ€ çš„åŸåˆ™è¿›è¡Œä»²è£ï¼Œå³é€‰æ‹© POM ä¸­æœ€å…ˆå£°æ˜çš„ç‰ˆæœ¬

ä» maven çš„ä»²è£æœºåˆ¶ä¸­å¯ä»¥å‘ç°ï¼Œé™¤äº†ç¬¬ä¸€æ¡ä»²è£è§„åˆ™ï¼ˆè¿™ä¹Ÿæ˜¯è§£å†³ Jar åŒ…å†²çªçš„å¸¸ç”¨æ‰‹æ®µä¹‹ä¸€ï¼‰å¤–ï¼Œåé¢çš„ä¸¤æ¡åŸåˆ™ï¼Œå¯¹äºåŒä¸€ä¸ª Jar åŒ…ä¸åŒç‰ˆæœ¬çš„é€‰æ‹©ï¼Œmaven çš„é€‰æ‹©æœ‰ç‚¹ â€œä¸€å¢æƒ…æ„¿â€ äº†ï¼Œä¹Ÿè®¸è¿™æ˜¯ maven ç ”å‘å›¢é˜Ÿåœ¨æ€»ç»“äº†å¤§é‡çš„é¡¹ç›®ä¾èµ–ç®¡ç†ç»éªŒåå¾—å‡ºçš„ä¸¤æ¡ç»“è®ºï¼Œåˆæˆ–è€…æ˜¯å‘ç°æ ¹æœ¬æ‰¾ä¸åˆ°ä¸€ç§ç»Ÿä¸€çš„æ–¹å¼æ¥æ»¡è¶³æ‰€æœ‰åœºæ™¯ä¹‹åçš„æ— å¥ˆä¹‹ä¸¾ï¼Œå¯èƒ½è¿™å¯¹äºå¤šæ•°åœºæ™¯æ˜¯é€‚ç”¨çš„ï¼Œä½†æ˜¯**å®ƒä¸ä¸€å®šé€‚åˆæˆ‘â€”â€”å½“å‰çš„åº”ç”¨**ï¼Œå› ä¸ºæ¯ä¸ªåº”ç”¨éƒ½æœ‰å…¶ç‰¹æ®Šæ€§ï¼Œè¯¥ä¾èµ–å“ªä¸ªç‰ˆæœ¬ï¼Œmaven æ²¡åŠæ³•å¸®ä½ å®Œå…¨æå®šï¼Œå¦‚æœä½ æ²¡æœ‰è§„è§„çŸ©çŸ©åœ°ä½¿ç”¨æ¥è¿›è¡Œä¾èµ–ç®¡ç†ï¼Œå°±æ³¨å®šäº†é€ƒè„±ä¸äº†ç¬¬ä¸€ç±» Jar åŒ…å†²çªé—®é¢˜ã€‚

### 2.1 Jar åŒ…çš„åŠ è½½é¡ºåº

å¯¹äºç¬¬äºŒç±» Jar åŒ…å†²çªé—®é¢˜ï¼Œå³å¤šä¸ªä¸åŒçš„ Jar åŒ…æœ‰ç±»å†²çªï¼Œè¿™ç›¸å¯¹äºç¬¬ä¸€ç±»é—®é¢˜å°±æ˜¾å¾—æ›´ä¸ºæ£˜æ‰‹ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸¤ä¸ªä¸åŒçš„ Jar åŒ…ï¼Œå‡è®¾ä¸º Â **A**ã€Â **B**ï¼Œå®ƒä»¬çš„åç§°äº’ä¸ç›¸åŒï¼Œç”šè‡³å¯èƒ½å®Œå…¨ä¸æ²¾è¾¹ï¼Œå¦‚æœä¸æ˜¯å‡ºç°å†²çªé—®é¢˜ï¼Œä½ å¯èƒ½éƒ½ä¸ä¼šå‘ç°å®ƒä»¬æœ‰å…±æœ‰çš„ç±»ï¼å¯¹äº Aã€B è¿™ä¸¤ä¸ª Jar åŒ…ï¼Œmaven å°±æ˜¾å¾—æ— èƒ½ä¸ºåŠ›äº†ï¼Œå› ä¸º maven åªä¼šä¸ºä½ é’ˆå¯¹åŒä¸€ä¸ª Jar åŒ…çš„ä¸åŒç‰ˆæœ¬è¿›è¡Œä»²è£ï¼Œè€Œè¿™ä¿©æ˜¯å±äºä¸åŒçš„ Jar åŒ…ï¼Œè¶…å‡ºäº† maven çš„ä¾èµ–ç®¡ç†èŒƒç•´ã€‚æ­¤æ—¶ï¼Œå½“ Aã€B éƒ½å‡ºç°åœ¨åº”ç”¨ç¨‹åºçš„ç±»è·¯å¾„ä¸‹æ—¶ï¼Œå°±ä¼šå­˜åœ¨æ½œåœ¨çš„å†²çªé£é™©ï¼Œå³ Aã€B çš„åŠ è½½å…ˆåé¡ºåºå°±å†³å®šç€ JVM æœ€ç»ˆé€‰æ‹©çš„ç±»ç‰ˆæœ¬ï¼Œå¦‚æœé€‰é”™äº†ï¼Œå°±ä¼šå‡ºç°è¯¡å¼‚çš„ç¬¬äºŒç±»å†²çªé—®é¢˜ã€‚

é‚£ä¹ˆ Jar åŒ…çš„åŠ è½½é¡ºåºéƒ½ç”±å“ªäº›å› ç´ å†³å®šçš„å‘¢ï¼Ÿå…·ä½“å¦‚ä¸‹ï¼š

- Jar åŒ…æ‰€å¤„çš„åŠ è½½è·¯å¾„ï¼Œæˆ–è€…æ¢ä¸ªè¯´æ³•å°±æ˜¯åŠ è½½è¯¥ Jar åŒ…çš„ç±»åŠ è½½å™¨åœ¨ JVM ç±»åŠ è½½å™¨æ ‘ç»“æ„ä¸­æ‰€å¤„å±‚çº§ã€‚ç”±äº JVM ç±»åŠ è½½çš„åŒäº²å§”æ´¾æœºåˆ¶ï¼Œå±‚çº§è¶Šé«˜çš„ç±»åŠ è½½å™¨è¶Šå…ˆåŠ è½½å…¶åŠ è½½è·¯å¾„ä¸‹çš„ç±»ï¼Œé¡¾åæ€ä¹‰ï¼Œå¼•å¯¼ç±»åŠ è½½å™¨ï¼ˆbootstrap ClassLoaderï¼Œä¹Ÿå«å¯åŠ¨ç±»åŠ è½½å™¨ï¼‰æ˜¯æœ€å…ˆåŠ è½½å…¶è·¯å¾„ä¸‹ Jar åŒ…çš„ï¼Œå…¶æ¬¡æ˜¯æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆextension ClassLoaderï¼‰ï¼Œå†æ¬¡æ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨ï¼ˆsystem ClassLoaderï¼Œä¹Ÿå°±æ˜¯åº”ç”¨åŠ è½½å™¨ appClassLoaderï¼‰ï¼ŒJar åŒ…æ‰€å¤„åŠ è½½è·¯å¾„çš„ä¸åŒï¼Œå°±å†³å®šäº†å®ƒçš„åŠ è½½é¡ºåºçš„ä¸åŒã€‚æ¯”å¦‚æˆ‘ä»¬åœ¨ eclipse ä¸­é…ç½® web åº”ç”¨çš„ resin ç¯å¢ƒæ—¶ï¼Œå¯¹äºä¾èµ–çš„ Jar åŒ…æ˜¯æ·»åŠ åˆ°`Bootstrap Entries`ä¸­è¿˜æ˜¯`User Entries`ä¸­å‘¢ï¼Œåˆ™éœ€è¦ä»”ç»†æ–Ÿé…Œä¸‹å’¯ã€‚
- æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶åŠ è½½é¡ºåºã€‚è¿™ä¸ªå› ç´ å¾ˆå®¹æ˜“è¢«å¿½ç•¥ï¼Œè€Œå¾€å¾€åˆæ˜¯å› ç¯å¢ƒä¸ä¸€è‡´è€Œå¯¼è‡´å„ç§è¯¡å¼‚å†²çªé—®é¢˜çš„ç½ªé­ç¥¸é¦–ã€‚å›  tomcatã€resin ç­‰å®¹å™¨çš„ ClassLoader è·å–åŠ è½½è·¯å¾„ä¸‹çš„æ–‡ä»¶åˆ—è¡¨æ—¶æ˜¯ä¸æ’åºçš„ï¼Œè¿™å°±ä¾èµ–äºåº•å±‚æ–‡ä»¶ç³»ç»Ÿè¿”å›çš„é¡ºåºï¼Œé‚£ä¹ˆå½“ä¸åŒç¯å¢ƒä¹‹é—´çš„æ–‡ä»¶ç³»ç»Ÿä¸ä¸€è‡´æ—¶ï¼Œå°±ä¼šå‡ºç°æœ‰çš„ç¯å¢ƒæ²¡é—®é¢˜ï¼Œæœ‰çš„ç¯å¢ƒå‡ºç°å†²çªã€‚ä¾‹å¦‚ï¼Œå¯¹äº Linux æ“ä½œç³»ç»Ÿï¼Œè¿”å›é¡ºåºåˆ™æ˜¯ç”± iNode çš„é¡ºåºæ¥å†³å®šçš„ï¼Œå¦‚æœè¯´æµ‹è¯•ç¯å¢ƒçš„ Linux ç³»ç»Ÿä¸çº¿ä¸Šç¯å¢ƒä¸ä¸€è‡´æ—¶ï¼Œå°±ææœ‰å¯èƒ½å‡ºç°å…¸å‹æ¡ˆä¾‹ï¼šæµ‹è¯•ç¯å¢ƒæ€ä¹ˆæµ‹éƒ½æ²¡é—®é¢˜ï¼Œä½†ä¸€ä¸Šçº¿å°±å‡ºç°å†²çªé—®é¢˜ï¼Œè§„é¿è¿™ç§é—®é¢˜çš„æœ€ä½³åŠæ³•å°±æ˜¯å°½é‡ä¿è¯æµ‹è¯•ç¯å¢ƒä¸çº¿ä¸Šä¸€è‡´ã€‚

## ä¸‰ã€å†²çªçš„è¡¨è±¡

Jar åŒ…å†²çªå¯èƒ½ä¼šå¯¼è‡´å“ªäº›é—®é¢˜ï¼Ÿé€šå¸¸å‘ç”Ÿåœ¨ç¼–è¯‘æˆ–è¿è¡Œæ—¶ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ç±»é—®é¢˜ï¼šä¸€ç±»æ˜¯æ¯”è¾ƒç›´è§‚çš„ä¹Ÿæ˜¯æœ€ä¸ºå¸¸è§çš„é”™è¯¯æ˜¯æŠ›å‡ºå„ç§è¿è¡Œæ—¶å¼‚å¸¸ï¼Œè¿˜æœ‰ä¸€ç±»å°±æ˜¯æ¯”è¾ƒéšæ™¦çš„é—®é¢˜ï¼Œå®ƒä¸ä¼šæŠ¥é”™ï¼Œå…¶è¡¨ç°å½¢å¼æ˜¯åº”ç”¨ç¨‹åºçš„è¡Œä¸ºè·Ÿé¢„æœŸä¸ä¸€è‡´ï¼Œåˆ†æ¡ç½—åˆ—å¦‚ä¸‹ï¼š

- **java.lang.ClassNotFoundException**ï¼Œå³ java ç±»æ‰¾ä¸åˆ°ã€‚è¿™ç±»å…¸å‹å¼‚å¸¸é€šå¸¸æ˜¯ç”±äºï¼Œæ²¡æœ‰åœ¨ä¾èµ–ç®¡ç†ä¸­å£°æ˜ç‰ˆæœ¬ï¼Œmaven çš„ä»²è£çš„æ—¶å€™é€‰å–äº†é”™è¯¯çš„ç‰ˆæœ¬ï¼Œè€Œè¿™ä¸ªç‰ˆæœ¬ç¼ºå°‘æˆ‘ä»¬éœ€è¦çš„æŸä¸ª class è€Œå¯¼è‡´è¯¥é”™è¯¯ã€‚ä¾‹å¦‚ httpclient-4.4.jar å‡çº§åˆ° httpclient-4.36.jar æ—¶ï¼Œç±» org.apache.http.conn.ssl.NoopHostnameVerifier è¢«å»æ‰äº†ï¼Œå¦‚æœæ­¤æ—¶æˆ‘ä»¬æœ¬æ¥éœ€è¦çš„æ˜¯ 4.4 ç‰ˆæœ¬ï¼Œä¸”ç”¨åˆ°äº† NoopHostnameVerifier è¿™ä¸ªç±»ï¼Œè€Œ maven ä»²è£æ—¶é€‰æ‹©äº† 4.6ï¼Œåˆ™ä¼šå¯¼è‡´ ClassNotFoundException å¼‚å¸¸ã€‚
- **java.lang.NoSuchMethodError**ï¼Œå³æ‰¾ä¸åˆ°ç‰¹å®šæ–¹æ³•ï¼Œç¬¬ä¸€ç±»å†²çªå’Œç¬¬äºŒç±»å†²çªéƒ½å¯èƒ½å¯¼è‡´è¯¥é—®é¢˜â€”â€”åŠ è½½çš„ç±»ä¸æ­£ç¡®ã€‚è‹¥æ˜¯ç¬¬ä¸€ç±»å†²çªï¼Œåˆ™æ˜¯ç”±äºé”™è¯¯ç‰ˆæœ¬çš„ Jar åŒ…ä¸æ‰€éœ€è¦ç‰ˆæœ¬çš„ Jar åŒ…ä¸­çš„ç±»æ¥å£ä¸ä¸€è‡´å¯¼è‡´ï¼Œä¾‹å¦‚ antlr-2.7.2.jar å‡çº§åˆ° antlr-2.7.6.Jar æ—¶ï¼Œæ¥å£ antlr.collections.AST.getLine() å‘ç”Ÿå˜åŠ¨ï¼Œå½“ maven ä»²è£é€‰æ‹©äº†é”™è¯¯ç‰ˆæœ¬è€ŒåŠ è½½äº†é”™è¯¯ç‰ˆæœ¬çš„ç±» ASTï¼Œåˆ™ä¼šå¯¼è‡´è¯¥å¼‚å¸¸ï¼›è‹¥æ˜¯ç¬¬äºŒç±»å†²çªï¼Œåˆ™æ˜¯ç”±äºä¸åŒ Jar åŒ…å«æœ‰çš„åŒåç±»æ¥å£ä¸ä¸€è‡´å¯¼è‡´ï¼Œ**å…¸å‹çš„æ¡ˆä¾‹**ï¼šApache çš„ commons-lang åŒ…ï¼Œ2.x å‡çº§åˆ° 3.x æ—¶ï¼ŒåŒ…åç›´æ¥ä» commons-lang æ”¹ä¸º commons-lang3ï¼Œéƒ¨åˆ†æ¥å£ä¹Ÿæœ‰æ‰€æ”¹åŠ¨ï¼Œç”±äºåŒ…åä¸åŒå’Œä¼ é€’æ€§ä¾èµ–ï¼Œç»å¸¸ä¼šå‡ºç°ä¸¤ç§ Jar åŒ…åŒæ—¶åœ¨ classpath ä¸‹ï¼Œorg.apache.commons.lang.StringUtils.isBlank å°±æ˜¯å…¶ä¸­æœ‰å·®å¼‚çš„æ¥å£ä¹‹ä¸€ï¼Œç”±äº Jar åŒ…çš„åŠ è½½é¡ºåºï¼Œå¯¼è‡´åŠ è½½äº†é”™è¯¯ç‰ˆæœ¬çš„ StringUtils ç±»ï¼Œå°±å¯èƒ½å‡ºç° NoSuchMethodError å¼‚å¸¸ã€‚
- **java.lang.NoClassDefFoundError**ï¼Œ**java.lang.LinkageError**Â  ç­‰ï¼ŒåŸå› å’Œä¸Šè¿°é›·åŒï¼Œå°±ä¸ä½œå…·ä½“æ¡ˆä¾‹åˆ†æäº†ã€‚
- **æ²¡æœ‰æŠ¥é”™å¼‚å¸¸ï¼Œä½†åº”ç”¨çš„è¡Œä¸ºè·Ÿé¢„æœŸä¸ä¸€è‡´**ã€‚è¿™ç±»é—®é¢˜åŒæ ·ä¹Ÿæ˜¯ç”±äºè¿è¡Œæ—¶åŠ è½½äº†é”™è¯¯ç‰ˆæœ¬çš„ç±»å¯¼è‡´ï¼Œä½†è·Ÿå‰é¢ä¸åŒçš„æ˜¯ï¼Œå†²çªçš„ç±»æ¥å£éƒ½æ˜¯ä¸€è‡´çš„ï¼Œä½†å…·ä½“å®ç°é€»è¾‘æœ‰å·®å¼‚ï¼Œå½“æˆ‘ä»¬åŠ è½½çš„ç±»ç‰ˆæœ¬ä¸æ˜¯æˆ‘ä»¬éœ€è¦çš„å®ç°é€»è¾‘ï¼Œå°±ä¼šå‡ºç°è¡Œä¸ºè·Ÿé¢„æœŸä¸ä¸€è‡´é—®é¢˜ã€‚è¿™ç±»é—®é¢˜é€šå¸¸å‘ç”Ÿåœ¨æˆ‘ä»¬è‡ªå·±å†…éƒ¨å®ç°çš„å¤šä¸ª Jar åŒ…ä¸­ï¼Œç”±äºåŒ…è·¯å¾„å’Œç±»åå‘½åä¸è§„èŒƒç­‰é—®é¢˜ï¼Œå¯¼è‡´ä¸¤ä¸ªä¸åŒçš„ Jar åŒ…å‡ºç°äº†æ¥å£ä¸€è‡´ä½†å®ç°é€»è¾‘åˆå„ä¸ç›¸åŒçš„åŒåç±»ï¼Œä»è€Œå¼•å‘æ­¤é—®é¢˜ã€‚

# è§£å†³æ–¹æ¡ˆ

## ä¸€ã€é—®é¢˜æ’æŸ¥å’Œè§£å†³

1. å¦‚æœæœ‰å¼‚å¸¸å †æ ˆä¿¡æ¯ï¼Œæ ¹æ®é”™è¯¯ä¿¡æ¯å³å¯å®šä½å¯¼è‡´å†²çªçš„ç±»åï¼Œç„¶ååœ¨ eclipse ä¸­`CTRL+SHIFT+T`æˆ–è€…åœ¨ idea ä¸­`CTRL+N`å°±å¯å‘ç°è¯¥ç±»å­˜åœ¨äºå¤šä¸ªä¾èµ– Jar åŒ…ä¸­
2. è‹¥æ­¥éª¤ 1 æ— æ³•å®šä½å†²çªçš„ç±»æ¥è‡ªå“ªä¸ª Jar åŒ…ï¼Œå¯åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶åŠ ä¸Š JVM å‚æ•°`-verbose:class`æˆ–è€…`-XX:+TraceClassLoading`ï¼Œæ—¥å¿—é‡Œä¼šæ‰“å°å‡ºæ¯ä¸ªç±»çš„åŠ è½½ä¿¡æ¯ï¼Œå¦‚æ¥è‡ªå“ªä¸ª Jar åŒ…
3. å®šä½äº†å†²çªç±»çš„ Jar åŒ…ä¹‹åï¼Œé€šè¿‡`mvn dependency:tree -Dverbose -Dincludes=<groupId>:<artifactId>`æŸ¥çœ‹æ˜¯å“ªäº›åœ°æ–¹å¼•å…¥çš„ Jar åŒ…çš„è¿™ä¸ªç‰ˆæœ¬
4. ç¡®å®š Jar åŒ…æ¥æºä¹‹åï¼Œå¦‚æœæ˜¯ç¬¬ä¸€ç±» Jar åŒ…å†²çªï¼Œåˆ™å¯ç”¨ **æ’é™¤ä¸éœ€è¦çš„ Jar åŒ…ç‰ˆæœ¬æˆ–è€…åœ¨ä¾èµ–ç®¡ç†**Â  ä¸­ç”³æ˜ç‰ˆæœ¬ï¼›è‹¥æ˜¯ç¬¬äºŒç±» Jar åŒ…å†²çªï¼Œå¦‚æœå¯æ’é™¤ï¼Œåˆ™ç”¨æ’æ‰ä¸éœ€è¦çš„é‚£ä¸ª Jar åŒ…ï¼Œè‹¥ä¸èƒ½æ’ï¼Œåˆ™éœ€è€ƒè™‘ Jar åŒ…çš„å‡çº§æˆ–æ¢ä¸ªåˆ«çš„ Jar åŒ…ã€‚å½“ç„¶ï¼Œé™¤äº†è¿™äº›æ–¹æ³•ï¼Œè¿˜å¯ä»¥ä»ç±»åŠ è½½å™¨çš„è§’åº¦æ¥è§£å†³è¯¥é—®é¢˜ï¼Œå¯å‚è€ƒåšæ–‡â€”â€”[å¦‚æœ jar åŒ…å†²çªä¸å¯é¿å…ï¼Œå¦‚ä½•å®ç° jar åŒ…éš”ç¦»](https://www.shop988.com/blog/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0jar%E5%8C%85%E9%9A%94%E7%A6%BB.html)ï¼Œå…¶æ€è·¯å€¼å¾—å€Ÿé‰´ã€‚

## äºŒã€æœ‰æ•ˆé¿å…

ä»ä¸Šä¸€èŠ‚çš„è§£å†³æ–¹æ¡ˆå¯ä»¥å‘ç°ï¼Œå½“å‡ºç°ç¬¬äºŒç±» Jar åŒ…å†²çªï¼Œä¸”å†²çªçš„ Jar åŒ…åˆæ— æ³•æ’é™¤æ—¶ï¼Œé—®é¢˜å˜å¾—ç›¸å½“æ£˜æ‰‹ï¼Œè¿™æ—¶å€™è¦å¤„ç†è¯¥å†²çªé—®é¢˜å°±éœ€è¦è¾ƒå¤§æˆæœ¬äº†ï¼Œæ‰€ä»¥ï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯**åœ¨å†²çªå‘ç”Ÿä¹‹å‰èƒ½æœ‰æ•ˆåœ°è§„é¿ä¹‹**ï¼å°±å¥½æ¯”æ•°æ®åº“æ­»é”é—®é¢˜ï¼Œæ­»é”é¿å…å’Œæ­»é”é¢„é˜²å°±æ˜¾å¾—ç›¸å½“é‡è¦ï¼Œè‹¥æ˜¯ç­‰åˆ°çœŸæ­£å‘ç”Ÿæ­»é”äº†ï¼Œå¸¸è§„çš„åšæ³•ä¹Ÿåªèƒ½æ˜¯å›æ»šå¹¶é‡å¯éƒ¨åˆ†äº‹åŠ¡ï¼Œè¿™å°±æ‰è¥Ÿè§è‚˜äº†ã€‚é‚£ä¹ˆæ€æ ·æ‰èƒ½æœ‰æ•ˆåœ°è§„é¿ Jar åŒ…å†²çªå‘¢ï¼Ÿ

### 2.1 è‰¯å¥½çš„ä¹ æƒ¯ï¼šä¾èµ–ç®¡ç†

å¯¹äºç¬¬ä¸€ç±» Jar åŒ…å†²çªé—®é¢˜ï¼Œé€šå¸¸çš„åšæ³•æ˜¯ç”¨æ’é™¤ä¸éœ€è¦çš„ç‰ˆæœ¬ï¼Œä½†è¿™ç§åšæ³•å¸¦æ¥çš„é—®é¢˜æ˜¯æ¯æ¬¡å¼•å…¥å¸¦æœ‰ä¼ é€’æ€§ä¾èµ–çš„ Jar åŒ…æ—¶ï¼Œéƒ½éœ€è¦ä¸€ä¸€è¿›è¡Œæ’é™¤ï¼Œéå¸¸éº»çƒ¦ã€‚maven ä¸ºæ­¤æä¾›äº†é›†ä¸­ç®¡ç†ä¾èµ–ä¿¡æ¯çš„æœºåˆ¶ï¼Œå³ä¾èµ–ç®¡ç†å…ƒç´ ï¼Œå¯¹ä¾èµ– Jar åŒ…è¿›è¡Œç»Ÿä¸€ç‰ˆæœ¬ç®¡ç†ï¼Œä¸€åŠ³æ°¸é€¸ã€‚é€šå¸¸çš„åšæ³•æ˜¯ï¼Œåœ¨ parent æ¨¡å—çš„ pom æ–‡ä»¶ä¸­å°½å¯èƒ½åœ°å£°æ˜æ‰€æœ‰ç›¸å…³ä¾èµ– Jar åŒ…çš„ç‰ˆæœ¬ï¼Œå¹¶åœ¨å­ pom ä¸­ç®€å•å¼•ç”¨è¯¥æ„ä»¶å³å¯ã€‚

æ¥çœ‹ä¸ªç¤ºä¾‹ï¼Œå½“å¼€å‘æ—¶ç¡®å®šä½¿ç”¨çš„ httpclient ç‰ˆæœ¬ä¸º 4.5.1 æ—¶ï¼Œå¯åœ¨çˆ¶ pom ä¸­é…ç½®å¦‚ä¸‹ï¼š

```
<properties>
  <httpclient.version>4.5.1</httpclient.version>
</properties>
<dependencyManagement>
  <dependencies>
    <dependency>
      <groupId>org.apache.httpcomponents</groupId>
      <artifactId>httpclient</artifactId>
      <version>${httpclient.version}</version>
    </dependency>
  </dependencies>
</dependencyManagement>

```

ç„¶åå„ä¸ªéœ€è¦ä¾èµ–è¯¥ Jar åŒ…çš„å­ pom ä¸­é…ç½®å¦‚ä¸‹ä¾èµ–ï¼š

```xml
dependencies>
  <dependency>
    <groupId>org.apache.httpcomponents</groupId>
    <artifactId>httpclient</artifactId>
  </dependency>
</dependencies>
```

### 2.2 å†²çªæ£€æµ‹æ’ä»¶

å¯¹äºç¬¬äºŒç±» Jar åŒ…å†²çªé—®é¢˜ï¼Œå‰é¢ä¹Ÿæåˆ°è¿‡ï¼Œå…¶æ ¸å¿ƒåœ¨äºåŒåç±»å‡ºç°åœ¨äº†å¤šä¸ªä¸åŒçš„ Jar åŒ…ä¸­ï¼Œå¦‚æœäººå·¥æ¥æ’æŸ¥è¯¥é—®é¢˜ï¼Œåˆ™éœ€è¦é€ä¸ªç‚¹å¼€æ¯ä¸ª Jar åŒ…ï¼Œç„¶åç›¸äº’å¯¹æ¯”çœ‹æœ‰æ²¡åŒåçš„ç±»ï¼Œé‚£å¾—å¤šä¹ˆæµªè´¹ç²¾åŠ›å•Šï¼Ÿï¼å¥½åœ¨è¿™ç§è´¹æ—¶è´¹åŠ›çš„ä½“åŠ›æ´»èƒ½äº¤ç»™ç¨‹åºå»å¹²ã€‚**maven-enforcer-plugin**ï¼Œè¿™ä¸ªå¼ºå¤§çš„ maven æ’ä»¶ï¼Œé…åˆ**Â extra-enforcer-rules**Â  å·¥å…·ï¼Œèƒ½è‡ªåŠ¨æ‰«æ Jar åŒ…å°†å†²çªæ£€æµ‹å¹¶æ‰“å°å‡ºæ¥ï¼Œæ±—é¢œçš„æ˜¯ï¼Œç¬”è€…å·¥ä½œä¹‹å‰å±…ç„¶éƒ½æ²¡å¬è¿‡æœ‰è¿™æ ·ä¸€ä¸ªæ’ä»¶çš„å­˜åœ¨ï¼Œä¹Ÿè®¸æ˜¯æ²¡é‡åˆ°åƒå·¥ä½œä¸­è¿™æ ·çš„å†²çªé—®é¢˜ï¼Œç®—æ˜¯æ¶¨å§¿åŠ¿äº†ã€‚å…¶åŸç†å…¶å®ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œé€šè¿‡æ‰«æ Jar åŒ…ä¸­çš„ classï¼Œè®°å½•æ¯ä¸ª class å¯¹åº”çš„ Jar åŒ…åˆ—è¡¨ï¼Œå¦‚æœæœ‰å¤šä¸ªå³æ˜¯å†²çªäº†ï¼Œæ•…ä¸å¿…æ·±ç©¶ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨å¦‚ä½•ç”¨å®ƒå³å¯ã€‚

åœ¨**æœ€ç»ˆéœ€è¦æ‰“åŒ…è¿è¡Œçš„åº”ç”¨æ¨¡å— pom**Â  ä¸­ï¼Œå¼•å…¥ maven-enforcer-plugin çš„ä¾èµ–ï¼Œåœ¨ build é˜¶æ®µå³å¯å‘ç°é—®é¢˜ï¼Œå¹¶è§£å†³å®ƒã€‚æ¯”å¦‚å¯¹äºå…·æœ‰ parent pom çš„å¤šæ¨¡å—é¡¹ç›®ï¼Œéœ€è¦å°†æ’ä»¶ä¾èµ–å£°æ˜åœ¨åº”ç”¨æ¨¡å—çš„ pom ä¸­ã€‚è¿™é‡Œæœ‰ç«¥é‹å¯èƒ½ä¼šç–‘é—®ï¼Œä¸ºä»€ä¹ˆä¸æŠŠæ’ä»¶ä¾èµ–å£°æ˜åœ¨ parent pom ä¸­å‘¢ï¼Ÿé‚£æ ·ä¾èµ–å®ƒçš„åº”ç”¨å­æ¨¡å—å²‚ä¸æ˜¯éƒ½èƒ½å¤ç”¨äº†ï¼Ÿè¿™é‡Œä¹‹æ‰€ä»¥å¼ºè°ƒ â€œæ‰“åŒ…è¿è¡Œçš„åº”ç”¨æ¨¡å— pomâ€ï¼Œæ˜¯å› ä¸ºå†²çªæ£€æµ‹é’ˆå¯¹çš„æ˜¯æœ€ç»ˆé›†æˆçš„åº”ç”¨ï¼Œå…³æ³¨çš„æ˜¯åº”ç”¨è¿è¡Œæ—¶æ˜¯å¦ä¼šå‡ºç°å†²çªé—®é¢˜ï¼Œè€Œæ¯ä¸ªä¸åŒçš„åº”ç”¨æ¨¡å—ï¼Œå„è‡ªä¾èµ–çš„ Jar åŒ…é›†åˆæ˜¯ä¸åŒçš„ï¼Œç”±æ­¤è€Œäº§ç”Ÿçš„åˆ—è¡¨ä¹Ÿæ˜¯æœ‰å·®å¼‚çš„ï¼Œå› æ­¤åªèƒ½é’ˆå¯¹åº”ç”¨æ¨¡å— pom åˆ†åˆ«å¼•å…¥è¯¥æ’ä»¶ã€‚

å…ˆçœ‹ç¤ºä¾‹ç”¨æ³•å¦‚ä¸‹ï¼š

```xml
<plugin>
  <groupId>org.apache.maven.plugins</groupId>
  <artifactId>maven-enforcer-plugin</artifactId>
  <version>1.4.1</version>
  <executions>
    <execution>
      <id>enforce</id>
      <configuration>
        <rules>
          <dependencyConvergence/>
        </rules>
      </configuration>
      <goals>
        <goal>enforce</goal>
      </goals>
    </execution>
    <execution>
      <id>enforce-ban-duplicate-classes</id>
      <goals>
        <goal>enforce</goal>
      </goals>
      <configuration>
        <rules>
          <banDuplicateClasses>
            <ignoreClasses>
              <ignoreClass>javax.*</ignoreClass>
              <ignoreClass>org.junit.*</ignoreClass>
              <ignoreClass>net.sf.cglib.*</ignoreClass>
              <ignoreClass>org.apache.commons.logging.*</ignoreClass>
              <ignoreClass>org.springframework.remoting.rmi.RmiInvocationHandler</ignoreClass>
            </ignoreClasses>
            <findAllDuplicates>true</findAllDuplicates>
          </banDuplicateClasses>
        </rules>
        <fail>true</fail>
      </configuration>
    </execution>
  </executions>
  <dependencies>
    <dependency>
      <groupId>org.codehaus.mojo</groupId>
      <artifactId>extra-enforcer-rules</artifactId>
      <version>1.0-beta-6</version>
    </dependency>
  </dependencies>
</plugin>
```

maven-enforcer-plugin æ˜¯é€šè¿‡å¾ˆå¤šé¢„å®šä¹‰çš„æ ‡å‡†è§„åˆ™ï¼ˆ[standard rules](https://link.jianshu.com/?t=http://maven.apache.org/enforcer/enforcer-rules/index.html)ï¼‰å’Œç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™ï¼Œæ¥çº¦æŸ maven çš„ç¯å¢ƒå› ç´ ï¼Œå¦‚ maven ç‰ˆæœ¬ã€JDK ç‰ˆæœ¬ç­‰ç­‰ï¼Œå®ƒæœ‰å¾ˆå¤šå¥½ç”¨çš„ç‰¹æ€§ï¼Œå…·ä½“å¯å‚è§[å®˜ç½‘](https://link.jianshu.com/?t=http://maven.apache.org/enforcer/maven-enforcer-plugin/)ã€‚è€Œ Extra Enforcer Rules åˆ™æ˜¯*Â MojoHaus*Â  é¡¹ç›®ä¸‹çš„é’ˆå¯¹ maven-enforcer-plugin è€Œå¼€å‘çš„æä¾›é¢å¤–è§„åˆ™çš„æ’ä»¶ï¼Œè¿™å…¶ä¸­å°±åŒ…å«å‰é¢æ‰€æçš„é‡å¤ç±»æ£€æµ‹åŠŸèƒ½ï¼Œå…·ä½“ç”¨æ³•å¯å‚è§[å®˜ç½‘](https://link.jianshu.com/?t=http://www.mojohaus.org/extra-enforcer-rules/)ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†å™è¿°äº†ã€‚

# å…¸å‹æ¡ˆä¾‹

## ç¬¬ä¸€ç±» Jar åŒ…å†²çª

è¿™ç±» Jar åŒ…å†²çªæ˜¯æœ€å¸¸è§çš„ä¹Ÿæ˜¯ç›¸å¯¹æ¯”è¾ƒå¥½è§£å†³çš„ï¼Œå·²ç»åœ¨[ä¸‰ã€å†²çªçš„è¡¨è±¡](https://www.jianshu.com/p/100439269148#%E4%B8%89%E3%80%81%E5%86%B2%E7%AA%81%E7%9A%84%E8%A1%A8%E8%B1%A1)è¿™èŠ‚ä¸­åˆ—ä¸¾äº†éƒ¨åˆ†æ¡ˆä¾‹ï¼Œè¿™é‡Œå°±ä¸é‡å¤åˆ—ä¸¾äº†ã€‚

## ç¬¬äºŒç±» Jar åŒ…å†²çª

### Spring2.5.6 ä¸ Spring3.x

Spring2.5.6 ä¸ Spring3.xï¼Œä»å•æ¨¡å—æ‹†åˆ†ä¸ºå¤šæ¨¡å—ï¼ŒJar åŒ…åç§°ï¼ˆartifactIdï¼‰ä¹Ÿä» spring å˜ä¸º spring-submoduleNameï¼Œå¦‚
spring-contextã€spring-aop ç­‰ç­‰ï¼Œå¹¶ä¸”ä¹Ÿæœ‰å°‘éƒ¨åˆ†æ¥å£æ”¹åŠ¨ï¼ˆJar åŒ…å‡çº§çš„è¿‡ç¨‹ä¸­ï¼Œè¿™ä¹Ÿæ˜¯åœ¨æ‰€éš¾å…çš„ï¼‰ã€‚ç”±äºæ˜¯ä¸åŒçš„ Jar åŒ…ï¼Œç» maven çš„ä¼ é€’ä¾èµ–æœºåˆ¶ï¼Œå°±ä¼šç»å¸¸æ€§çš„å­˜åœ¨è¿™ä¿©ç‰ˆæœ¬çš„ Spring éƒ½åœ¨ classpath ä¸­ï¼Œä»è€Œå¼•å‘æ½œåœ¨çš„å†²çªé—®é¢˜ã€‚

## [Javaä»£ç å®¡æŸ¥ï¼šå¸¸è§é”™è¯¯åŠæ”¹è¿›æŒ‡å—](https://blog.dong4j.site/posts/c43d4ea4.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

æ•´ç†ä¸€ä¸‹é¡¹ç›®ä¸­ä¸å¥½çš„ä»£ç å†™æ³•

![20241229154732_ZA3tXTde.webp](https://cdn.dong4j.site/source/image/20241229154732_ZA3tXTde.webp)

ä»¥ä¸‹æ˜¯ä¸€äº›å…·æœ‰ä»£è¡¨æ€§çš„é—®é¢˜, éƒ½æ˜¯ä¸€äº›ä¸€çœ‹å°±æ˜ç™½çš„é—®é¢˜, è¿˜æœ‰ä¸€äº›ä»£ç çš„å‘, æ…¢æ…¢å¡«å§.

åªé’ˆå¯¹ä»£ç , ä¸é’ˆå¯¹è°, å¦‚æœå†™çš„ä¸å¯¹çš„å¯¹æ–¹, ä½ å’¬æˆ‘å•Š

## ä»£ç é—®é¢˜

### è¿˜å¤±è´¥é‡è¯•? å¤±è´¥é‡è¯•ä¸ªå•¥? ç›´æ¥è¿”å›äº† è€é“!!

ä»£ç  1 åé¢, è·å–äº† batchResult, ä¸åº”è¯¥é‡æ–°èµ‹å€¼ code å˜›?

ä»£ç  2 ä¸ºä¿®æ”¹å

![20241229154732_GNL6YDkH.webp](https://cdn.dong4j.site/source/image/20241229154732_GNL6YDkH.webp)

### Intellij idea æ˜¯ä¸ªå¥½ä¸œè¥¿

![20241229154732_l9cqCugh.webp](https://cdn.dong4j.site/source/image/20241229154732_l9cqCugh.webp)
![20241229154732_mOz94KIb.webp](https://cdn.dong4j.site/source/image/20241229154732_mOz94KIb.webp)

ä¿®æ”¹ä¸º:

![20241229154732_R03cnTDt.webp](https://cdn.dong4j.site/source/image/20241229154732_R03cnTDt.webp)

catch é‡Œé¢ä½¿ç”¨ printStackTrace(), é”™è¯¯æ—¥å¿—å…¨éƒ¨è¾“å‡ºåˆ° `catalina.out`, ä½ è€ƒè™‘è¿‡ catalina çš„æ„Ÿå—å—?

**æ—¥å¿—é—®é¢˜åé¢è¯´**

### è¿™æ˜¯å…ˆæ–©åå¥å—?

å‰é¢éƒ½è°ƒç”¨äº† list çš„ size æ–¹æ³•, åé¢å†æ¥åˆ¤æ–­ list æ˜¯å¦ä¸º null?

è¿™ç§ä»£ç æˆ‘çœ‹è§èµ·ç ä¸ä¸‹ 10 å¤„, ç³»ç»Ÿèƒ½ç¨³å®šå—è€é“?

![20241229154732_poqachWZ.webp](https://cdn.dong4j.site/source/image/20241229154732_poqachWZ.webp)

idea éƒ½çŸ¥é“çš„é—®é¢˜, ä½ ä¸åº”è¯¥ä¸çŸ¥é“

![20241229154732_pk5YyTrv.webp](https://cdn.dong4j.site/source/image/20241229154732_pk5YyTrv.webp)

logger.info è¾“å‡ºé—®é¢˜:

ç”¨ `log.info("{}", xxxx)`, ä¸è¦è‡ªå·±æ‹¼æ¥å­—ç¬¦ä¸²

### è€é“, ä½ å¯é•¿ç‚¹å¿ƒå§

![20241229154732_mQUneZBa.webp](https://cdn.dong4j.site/source/image/20241229154732_mQUneZBa.webp)

### è€é“, æˆ‘å°±æœä½ 

![20241229154732_CjuLa8Xz.webp](https://cdn.dong4j.site/source/image/20241229154732_CjuLa8Xz.webp)

google : logger.error() æ­£ç¡®ä½¿ç”¨å§¿åŠ¿

![20241229154732_EXMYUxyi.webp](https://cdn.dong4j.site/source/image/20241229154732_EXMYUxyi.webp)

### JDK7 ä¹‹åçš„å˜åŒ–

JDK7 ä¹‹ é’»çŸ³è¯­æ³•

![20241229154732_2D69JJJC.webp](https://cdn.dong4j.site/source/image/20241229154732_2D69JJJC.webp)
![20241229154732_IgcfD8YG.webp](https://cdn.dong4j.site/source/image/20241229154732_IgcfD8YG.webp)

### ç”»è›‡æ·»è¶³

value å°±æ˜¯ String ç±»å‹äº†, å†™ toString() æ˜¯ä¸ºäº†ç»ƒæ‰“å­—å—?

![20241229154732_sSB4f0pj.webp](https://cdn.dong4j.site/source/image/20241229154732_sSB4f0pj.webp)

### å¼ºè¿«ç—‡å¯èƒ½è¦æ€¥æ­»

çœ‹è§é»„è‰²è­¦å‘Šäº†å—? çŸ¥é“æ€ä¹ˆæ”¹å—?

![20241229154732_2EOmbK8I.webp](https://cdn.dong4j.site/source/image/20241229154732_2EOmbK8I.webp)

![20241229154732_Yl0GTxks.webp](https://cdn.dong4j.site/source/image/20241229154732_Yl0GTxks.webp)

### ä½ å°±å‘Šè¯‰æˆ‘éœ€è¦å¤šå®½çš„æ˜¾ç¤ºå™¨?

è€é“, å…¬å¸æ²¡ç»™é…è¿™ä¹ˆå®½çš„æ˜¾ç¤ºå™¨å•Š... å•Š, 27 å¯¸çš„ä¹Ÿçœ‹ä¸è¿‡æ¥å•Š

**è¶…è¿‡ 120 åˆ—å®½å¿…é¡»éœ€è¦æ¢è¡Œ**

![20241229154732_Mi5SqZ8G.webp](https://cdn.dong4j.site/source/image/20241229154732_Mi5SqZ8G.webp)

![20241229154732_d4IxIPHI.webp](https://cdn.dong4j.site/source/image/20241229154732_d4IxIPHI.webp)

**è¶…è¿‡ 5 ä¸ªå‚æ•°, æ¨èä½¿ç”¨å®ä½“ç±»**

### ä½ è¿˜æ˜¯å»å†™ python å§

![20241229154732_D7RhYdaO.webp](https://cdn.dong4j.site/source/image/20241229154732_D7RhYdaO.webp)

### çŸ¥é“ä»€ä¹ˆå« util å—?

![20241229154732_Q99tRBQJ.webp](https://cdn.dong4j.site/source/image/20241229154732_Q99tRBQJ.webp)

### Intellij IDEA éƒ½çŸ¥é“ä¼šæœ‰ç©ºæŒ‡é’ˆ, ä½ è¿˜è¿™ä¹ˆå†™?

![20241229154732_uckFF7xE.webp](https://cdn.dong4j.site/source/image/20241229154732_uckFF7xE.webp)

### ä¸èƒ½ç›´æ¥ return å—? ç»ƒæ‰“å­—å—?

![20241229154732_s6WPNs6L.webp](https://cdn.dong4j.site/source/image/20241229154732_s6WPNs6L.webp)

### é¢è¯•é¢˜ä¹‹ String, StringBuilder, StringBuffer

> JDK 5 ä»¥å JVM å¯¹å­—ç¬¦ä¸²å¾ªç¯æ‹¼æ¥çš„å¤„ç†æ–¹å¼

![20241229154732_RDocgeHo.webp](https://cdn.dong4j.site/source/image/20241229154732_RDocgeHo.webp)

### è€é“, ç±»æ³¨é‡Š, æ–¹æ³•æ³¨é‡Šå‘¢

**ç±»æ³¨é‡Šå‘¢?**

**æ–¹æ³•æ³¨é‡Šè™½ç„¶æœ‰, ä½†æ˜¯ä¸æ ‡å‡†å•Š, è€é“**

æ²¡çœ‹è§é‚£ä¹ˆå¤šé»„è‰²è­¦å‘Šå—?

![20241229154732_nuQzSQA9.webp](https://cdn.dong4j.site/source/image/20241229154732_nuQzSQA9.webp)

**ä»£ç è§„èŒƒæˆ‘ä»¬åé¢è¯´**

![20241229154732_9wGwkuIH.webp](https://cdn.dong4j.site/source/image/20241229154732_9wGwkuIH.webp)

æ¯ä¸ªæ¨¡å—éƒ½æœ‰ä¸€ä¸ª StringUtil, è¿˜æœ‰å« StringUtils çš„

è€é“, å†™ä¹‹å‰å…ˆçœ‹çœ‹èƒ½ä¸èƒ½å¤ç”¨å•Š, æˆ–è€…å¤åˆ¶ä¹‹å‰, çœ‹æ˜¯ä¸æ˜¯å·²ç»æœ‰äº†å•Š.

### ä½ ä»¥ä¸ºæŠŠ DDL è¯­å¥æ‹·è´è¿‡æ¥å°±ä¸ç”¨å†™å­—æ®µæ³¨é‡Šäº†å—?

è€é“, ä½ è¿™æ ·éªšæ“ä½œæˆ‘å¾ˆä¸ºéš¾å•Š

![20241229154732_1R7jMR50.webp](https://cdn.dong4j.site/source/image/20241229154732_1R7jMR50.webp)

åœ¨ç±»ä¸ŠæŒ‰ F1 çœ‹ä¸åˆ°ç±»æ³¨é‡Šå•Š

![20241229154732_C6AqFxhb.webp](https://cdn.dong4j.site/source/image/20241229154732_C6AqFxhb.webp)

è¿™æ ·æ”¹å•Š

![20241229154732_524c0JBV.webp](https://cdn.dong4j.site/source/image/20241229154732_524c0JBV.webp)

F1 ç›´æ¥çœ‹ç±»æ³¨é‡Šå•Š, ä¸ç”¨è·³è½¬äº†å•Š

![20241229154732_H2KhddkH.webp](https://cdn.dong4j.site/source/image/20241229154732_H2KhddkH.webp)

F1 ç›´æ¥çœ‹å­—æ®µæ³¨é‡Šå•Š, ä¸ç”¨å†å»æŸ¥ DDL äº†å•Š, ä¸ä¼šåœ¨è’™åœˆäº†å•Š

![20241229154732_guzkIspg.webp](https://cdn.dong4j.site/source/image/20241229154732_guzkIspg.webp)

### è€é“, ä¸æ˜¯ä¸­æ–‡çœ‹ä¸æ‡‚å•Š

é¢, è¿™ä¸ªè¦æ€ª idea äº†, å±…ç„¶æ²¡æœ‰é»˜è®¤è½¬æ¢

![20241229154732_QtY0zZE5.webp](https://cdn.dong4j.site/source/image/20241229154732_QtY0zZE5.webp)

![20241229154732_mByeIzng.webp](https://cdn.dong4j.site/source/image/20241229154732_mByeIzng.webp)

è€é“, æŠŠ transpartent æ‰“å¼€, ä½ å°±è®¤è¯†ä¸­æ–‡äº†

![20241229154732_IvrhpyQY.webp](https://cdn.dong4j.site/source/image/20241229154732_IvrhpyQY.webp)

è€é“, çœ‹è§é»„è‰²è­¦å‘Šäº†? å¦‚æœæ˜¯è‡ªå·±è§£æé…ç½®, æ²¡æœ‰å¤„ç†ç©ºç™½ç¬¦çš„è¯, åˆå‡º bug äº†å•Š.. å•Š.

### è€é“, ä»£ç ç”¨ UTF-8 å•Š, ä¸ç„¶è¦ä¹±ç å•Š

![20241229154732_iqEm4YvC.webp](https://cdn.dong4j.site/source/image/20241229154732_iqEm4YvC.webp)

å…¨éƒ½è¦ UTF-8 å•Š, è¦è·Ÿå›½é™…æ¥è½¨å•Š

![20241229154732_IY0UEuKK.webp](https://cdn.dong4j.site/source/image/20241229154732_IY0UEuKK.webp)

### è€é“, 0 æ˜¯å•¥, 1 æ˜¯å•¥, 2 åˆæ˜¯å•¥å•Š? è„‘å£³éƒ½å¤§äº†å•Š...

å®šä¹‰ä¸ªå¸¸é‡å•Š, å¸¸é‡åç”¨æ‹¼éŸ³ä¹Ÿæ¯”æ²¡æœ‰å¥½å•Š, è€é“

![20241229154732_5g7sLkNB.webp](https://cdn.dong4j.site/source/image/20241229154732_5g7sLkNB.webp)

![20241229154732_isLnyliN.webp](https://cdn.dong4j.site/source/image/20241229154732_isLnyliN.webp)

### è®º MVC æ¶æ„çš„èŒè´£

dao å°±æ˜¯å¯¹è¡¨çš„æ“ä½œ, ä¸€ä¸ª dao å¯¹åº”ä¸€å¼ è¡¨;
service ç»„åˆå¤šä¸ª dao è¿›è¡Œä¸šåŠ¡å¤„ç†;
controller åšå‚æ•°æ£€æŸ¥, ç»“æœå°è£…, è·³è½¬é¡µé¢;

![20241229154732_MUIpQN0h.webp](https://cdn.dong4j.site/source/image/20241229154732_MUIpQN0h.webp)

### ä½ å’‹ä¸æŠŠæ‰€æœ‰çš„ sql éƒ½å†™åœ¨ä¸€ä¸ª xml é‡Œé¢å‘¢?

![20241229154732_e35X2mlx.webp](https://cdn.dong4j.site/source/image/20241229154732_e35X2mlx.webp)

### è¿™ä¸ªä¹Ÿè¦æ³¨å…¥? ä¹Ÿèƒ½æ³¨å…¥?

ğŸ˜…ğŸ˜‚ğŸ¤£

![20241229154732_CpUOdFER.webp](https://cdn.dong4j.site/source/image/20241229154732_CpUOdFER.webp)

### å¤šä½™çš„ finally

> redis-proxy å·²ç»å¯¹ jedis èµ„æºçš„å®‰å…¨é‡Šæ”¾åšäº†å¤„ç†, ä¸ç”¨è‡ªå·±åœ¨å†™è¿™äº›å†—ä½™çš„ä»£ç 

![20241229154732_0ggLpsRN.webp](https://cdn.dong4j.site/source/image/20241229154732_0ggLpsRN.webp)

### catch é‡Œé¢ä¸è¦åšæµç¨‹æ§åˆ¶, OK?

![20241229154732_mUgmSDPp.webp](https://cdn.dong4j.site/source/image/20241229154732_mUgmSDPp.webp)

æ”¹ä¸º

![20241229154732_KxMkMlP9.webp](https://cdn.dong4j.site/source/image/20241229154732_KxMkMlP9.webp)

### log è¾“å‡ºé”™è¯¯

> æ—¥å¿—çš„æ­£ç¡®ä½¿ç”¨å§¿åŠ¿, ä½ å€¼å¾—äº†è§£ä¸€ä¸‹

æ¨èå»æœä¸€ä¸‹ log çš„æ­£ç¡®è¾“å‡ºæ–¹å¼.

![20241229154732_HE2fZKMw.webp](https://cdn.dong4j.site/source/image/20241229154732_HE2fZKMw.webp)

```java
log.error("è®¿é—® redis å¼‚å¸¸", e);
```

### åšäººèƒ½ä¸èƒ½çœŸè¯šä¸€ç‚¹, å†™ä»£ç èƒ½ä¸èƒ½ç®€å•ä¸€ç‚¹

![20241229154732_VwXgkaNB.webp](https://cdn.dong4j.site/source/image/20241229154732_VwXgkaNB.webp)

æ”¹ä¸º:

```java
IavpResponse iavpResponse = HttpUtil.sendPost(inputParams, "gatherkey", Integer.parseInt(timeOut));
if(iavpResponse.getStatusCode() == HttpStatus.SC_OK){
    return XmlConverUtil.readGatherKeyXmlOut(iavpResponse.getContent());
}
```

XmlConverUtil.java

```java
public static List<GatherKeyInfo> readGatherKeyXmlOut(String xml) {
        if(StringUtils.isBlank(xml)){
            return null;
        }
        ...
}
```

### isNotEmpty å’Œ isNotBlank çš„åŒºåˆ«çŸ¥é“å—?

![20241229154732_3A8gDJsY.webp](https://cdn.dong4j.site/source/image/20241229154732_3A8gDJsY.webp)

æ”¹ä¸º:

![20241229154732_Aub2kvRm.webp](https://cdn.dong4j.site/source/image/20241229154732_Aub2kvRm.webp)

### 3 è¡Œä»£ç æå®šçš„äº‹, éè¦å†™å‡ åè¡Œ, ç»ƒæ‰“å­—å—?

**åŸå§‹ä»£ç **

ç”¨äºæ£€æŸ¥æ˜¯å¦æ˜¯ä¼šå‘˜

```java
public boolean judgeMiguSuperVIP(String caller) {
        boolean VIPReturn = false;
        // isMiguGameMothMember è¡¨ç¤ºæ¸¸æˆä¼šå‘˜çŠ¶æ€ï¼Œ1 è¡¨ç¤ºæ˜¯åŒ…æœˆä¼šå‘˜ï¼Œ0 è¡¨ç¤ºä¸æ˜¯åŒ…æœˆä¼šå‘˜
        String isMiguGameMothMember = "0";
        try {
            GameAccount gameAccount = miguGameProvider.queryUserInfo(caller);
            if (gameAccount != null) {
                isMiguGameMothMember = gameAccount.getMiguSupperMember();
            } else {
                isMiguGameMothMember = "0";
            }
            if ("1".equals(isMiguGameMothMember)) {
                // æ˜¯å’ªå’•è¶…çº§ä¼šå‘˜
                VIPReturn = true;
                return VIPReturn;
            } else {
                // ä¸æ˜¯å’ªå’•è¶…çº§ä¼šå‘˜
                VIPReturn = false;
                return VIPReturn;
            }
        } catch (Exception e) {
            // æŸ¥è¯¢æ¸¸æˆè´¦å·çŠ¶æ€å¼‚å¸¸
            VIPReturn = false;
            return VIPReturn;
        }
    }
```

**é‡æ„ 1**

åˆ é™¤ boolean VIPReturn

```java
    public boolean judgeMiguSuperVIP(String caller, String type) {
        // isMiguGameMothMember è¡¨ç¤ºæ¸¸æˆä¼šå‘˜çŠ¶æ€ï¼Œ1 è¡¨ç¤ºæ˜¯åŒ…æœˆä¼šå‘˜ï¼Œ0 è¡¨ç¤ºä¸æ˜¯åŒ…æœˆä¼šå‘˜
        String isMiguGameMothMember = "0";
        try {
            GameAccount gameAccount = miguGameProvider.queryUserInfo(caller, type);
            if (gameAccount != null) {
                isMiguGameMothMember = gameAccount.getMiguSupperMember();
            } else {
                isMiguGameMothMember = "0";
            }
            return "1".equals(isMiguGameMothMember);
        } catch (Exception e) {
            return false;
        }
    }
```

**é‡æ„ 2**

åˆ é™¤ isMiguGameMothMember

```java
public boolean judgeMiguSuperVIP(String caller, String type) {
        // isMiguGameMothMember è¡¨ç¤ºæ¸¸æˆä¼šå‘˜çŠ¶æ€ï¼Œ1 è¡¨ç¤ºæ˜¯åŒ…æœˆä¼šå‘˜ï¼Œ0 è¡¨ç¤ºä¸æ˜¯åŒ…æœˆä¼šå‘˜
        try {
            GameAccount gameAccount = miguGameProvider.queryUserInfo(caller, type);
            return gameAccount != null && "1".equals(gameAccount.getMiguSupperMember());
        } catch (Exception e) {
            return false;
        }
    }
```

**é‡æ„ 3**

queryUserInfo å·²ç»å¤„ç†çš„ä¸‹å±‚æŠ›å‡ºçš„å¼‚å¸¸, è¿™é‡Œä¸éœ€è¦å†å¤„ç†

```java
public boolean judgeMiguSuperVIP(String caller, String type) {
        // isMiguGameMothMember è¡¨ç¤ºæ¸¸æˆä¼šå‘˜çŠ¶æ€ï¼Œ1 è¡¨ç¤ºæ˜¯åŒ…æœˆä¼šå‘˜ï¼Œ0 è¡¨ç¤ºä¸æ˜¯åŒ…æœˆä¼šå‘˜
        GameAccount gameAccount = miguGameProvider.queryUserInfo(caller, type);
        return gameAccount != null && "1".equals(gameAccount.getMiguSupperMember());
    }
```

## æ—¥å¿—é—®é¢˜

![20241229154732_TUqT6zHK.webp](https://cdn.dong4j.site/source/image/20241229154732_TUqT6zHK.webp)

### è€é“, æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶è¦ç”¨ UTF-8 å•Š

ä¸ç„¶ä¹±ç çœ‹ä¸æ‡‚å•Š

![20241229154732_7KCouGBj.webp](https://cdn.dong4j.site/source/image/20241229154732_7KCouGBj.webp)

### è€é“, æ—¥å¿—è¾“å‡ºèƒ½ä¸èƒ½ç»Ÿä¸€æ ¼å¼å•Š?

### è€é“, æ—¥å¿—è¾“å‡ºèƒ½ä¸èƒ½åˆ†çº§åˆ«å•Š?

### è€é“, æ—¥å¿—æ¡†æ¶èƒ½ä¸èƒ½ç»Ÿä¸€ä½¿ç”¨ä¸€ä¸ªå•Š?

ä¸€ä¼š log4j, ä¸€ä¼š log4j2 çš„
åšäººå–œæ–°åŒæ—§å¯ä»¥ (log4j2 æ›´æ–°, æ•ˆç‡æ›´å¥½)
ä½†ä¹Ÿè¦ä¸“ä¸€, è¯´å¥½æ”¾å­¦åˆ«èµ°å°±ä¸èƒ½èµ°, è¦è·‘...
è¯´å¥½ç”¨ log4j2 + slf4j, å°±ä¸è¦ç”¨ System.out.println() OK?

## Maven é—®é¢˜

### è€é“, ä¸€ä¸ªæ¨¡å—è¿™ä¹ˆå¤šç‰ˆæœ¬å•Š, æ€ä¹ˆç®¡ç†å•Š

maven ç”¨æ¥ç®¡ç†é¡¹ç›®ä¸­çš„ä¾èµ–å…³ç³»çš„, è¿™ä¸ªæ²¡ä½¿ç”¨ maven æœ‰ä»€ä¹ˆåŒºåˆ«?

![20241229154732_1JS1jb0y.webp](https://cdn.dong4j.site/source/image/20241229154732_1JS1jb0y.webp)

### æ‹·è´ä¾èµ–çš„æ—¶å€™çœ‹æ²¡çœ‹æ˜¯ä¸æ˜¯å­˜åœ¨äº†?

![20241229154732_uvcka7Fo.webp](https://cdn.dong4j.site/source/image/20241229154732_uvcka7Fo.webp)

### è€é“, ä¸è¦åªæ™“å¾—æ‹·è´ä¾èµ–, ä¸çœ‹çœ‹ä¾èµ–å†²çªå•Š

![20241229154732_T2zcOs2y.webp](https://cdn.dong4j.site/source/image/20241229154732_T2zcOs2y.webp)

## é¡¹ç›®ç»“æ„é—®é¢˜

### 1000 ä¸ªäººçœ¼é‡Œ, æœ‰ 1000 ä¸ªå“ˆå§†é›·ç‰¹, 1000 ä¸ªäººå†™ä»£ç , å°±æœ‰ 1000 ç§ä»£ç é£æ ¼

![20241229154732_Mz06nD0Q.webp](https://cdn.dong4j.site/source/image/20241229154732_Mz06nD0Q.webp)

## ä¸‹ä¸€ç¯‡ musearch-project ä»‹ç»

å·²ç»é‡æ„çš„æ¨¡å—

![20241229154732_6WMOlgqE.webp](https://cdn.dong4j.site/source/image/20241229154732_6WMOlgqE.webp)

```lua
.
â”œâ”€â”€ musicsearch-business            # ä¸šåŠ¡ä¸»æ¨¡å—
â”‚     â”œâ”€â”€ business-common             # ä¸šåŠ¡å…¬å…±ç±»åº“
â”‚     â”œâ”€â”€ mservice-migu-game          # migu-game ä¸šåŠ¡
â”‚     â””â”€â”€ service-meeting             # meeting æœåŠ¡æ¨¡å—
â”œâ”€â”€ musicsearch-common              # musicsearch é¡¹ç›® å…¬å…±æ¨¡å—
â”œâ”€â”€ musicsearch-component           # ç»„ä»¶ä¸»æ¨¡å—
â”‚     â”œâ”€â”€ component-iavp              # iavp æ¨¡å—, å°è£… iavp ç›¸å…³å®ä½“å’Œæ¥å£, ç›´æ¥æ³¨å…¥å³å¯
â”‚     â”œâ”€â”€ component-mybatis           # mybatis æ¨¡å—, æä¾›ä»£ç ç”Ÿæˆå’Œ mybatis ç›¸å…³åŠŸèƒ½
â”‚     â”œâ”€â”€ component-redis             # redis æ¨¡å—, æ³¨å…¥ RedisService å³å¯, æä¾›å¤šç§æ¨¡å¼
â”‚     â””â”€â”€ component-websocket         # websocket æ¨¡å— netty-socket.io å°è£…
â”œâ”€â”€ musicsearch-demo                # demo ä¸»æ¨¡å—
â”‚     â”œâ”€â”€ component-mybatis-demo
â”‚     â””â”€â”€ component-redis-demo
â”œâ”€â”€ musicsearch-dependencies-bom    # ç®¡ç†ç¬¬ä¸‰æ–¹ jar ç‰ˆæœ¬å’Œä¾èµ–å…³ç³»
â”œâ”€â”€ musicsearch-monitor             # æš‚å®š
â”œâ”€â”€ musicsearch-parent              # musicsearch å·¥ç¨‹ä¸»æ¨¡å—, ç®¡ç†æ•´ä¸ªåŠŸèƒ½çš„ç‰ˆæœ¬åŠä¾èµ–
â”‚     â””â”€â”€ docs                        # æ”¾å·¥ç¨‹ç›¸å…³æ–‡æ¡£
â””â”€â”€ musicsearch-support             # æ”¯æ’‘æ¨¡å—ä¸»æ¨¡å—
    â”œâ”€â”€ musicsearch-code-generator
    â”œâ”€â”€ musicsearch-management-system
    â””â”€â”€ musicsearch-timer-task

```

## [æ‰“é€ é«˜æ•ˆå›¢é˜Ÿï¼šç»Ÿä¸€ç¼–ç é£æ ¼çš„é‡è¦æ€§](https://blog.dong4j.site/posts/a29c1a98.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

é¡¹ç›®é‡æ„æ•´ç†

<!-- more-->

## åºŸè¯

æ­¤ç¯‡æ˜¯ 12530 æ¶æ„é‡æ„ç¬¬äºŒç¯‡, ä»¥ [é˜¿é‡Œå·´å·´å¼€å‘æ‰‹å†Œ](https://github.com/alibaba/p3c/) ä¸ºåŸºç¡€, ç»“åˆè‡ªå·±å·¥ä½œç»éªŒ, ä½œä¸º `musicsearch-project`
é‡æ„æ–¹æ¡ˆçš„åŸºç¡€éƒ¨åˆ†.
ä»¥æ­¤ä¸ºçº¦æŸ, å¸Œæœ›æ„å»ºä¸€ä¸ª `ç¨³å®š`, `æ˜“äºç»´æŠ¤`, `å¯æ‰©å±•` çš„é‡æ„æ–¹æ¡ˆ.

ä¸€ä¸ªé¡¹ç›®æœ€æ€•å¤šç§ç¼–ç é£æ ¼, å®ä½“åä¸€ä¼š entity, ä¸€ä¼š model, è®©ç»´æŠ¤çš„äººèº«å¿ƒç–²æƒ«, å› æ­¤åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­ä¿æŒå”¯ä¸€ä¸€ç§ç¼–ç ä¹ æƒ¯, æœ‰åˆ©äºä»£ç ç»´æŠ¤ (æ¯”å¦‚é€šè¿‡å‘½å,
å°±çŸ¥é“ä½œç”¨ä»¥åŠæ‰€åœ¨çš„åŒ…å).

**è§åçŸ¥æ„, æ­¤ä¹ƒå‘½åçš„æœ€é«˜å¢ƒç•Œ (ä½“ä¼šä¸€ä¸‹ `å–å 10 åˆ†é’Ÿ, ç¼–ç  1 åˆ†é’Ÿ` çš„å¢ƒç•Œ ğŸ˜‚).**

> ä»£ç è§„èŒƒçœ‹èµ·æ¥æ¯”è¾ƒæ¯ç‡¥, çœ‹å®Œä¸€éå¯èƒ½åªæœ‰ä¸€ç‚¹ç‚¹å°è±¡, å› æ­¤æˆ‘é‡‡ç”¨æ¯”è¾ƒé€—æ¯”çš„æ–¹å¼, å°½é‡è®©å¤§å®¶ä¸€éå°±è®°ä½.
> ä»£ç è§„èŒƒæ¯”è¾ƒåå‘ä¸ªäººä¸»ä¹‰, æ¯ä¸ªäººçš„ç¼–ç ä¹ æƒ¯éƒ½ä¸ä¸€æ ·, æ‰€ä»¥å¸Œæœ›å¤šæå‡ºè‡ªå·±çš„å»ºè®®, ä¸€èµ·æ”¹è¿› (æ²¡æœ‰æœ€å¥½çš„è§„èŒƒ, åªæœ‰æœ€åˆé€‚çš„. ğŸ™ƒ)

## Let's go

### å¼€ç¯‡

è¯è¯´ç›˜å¤å¼€å¤©è¾Ÿåœ°ä¹‹æ—¶... äºšå½“å’Œå¤å¨ƒè¯ç”Ÿæ··æ²Œä¹‹é—´, ä»–ä»¬ä»å°é’æ¢…ç«¹é©¬, ä¸€ä¸ªä¼šå”± 200 é¦–æ­Œ, ä¸€ä¸ªä¼šè·³ 200 æ”¯èˆ, åäººç§°ä»–ä»¬ä¸€ä¸ªä¸º äºŒç™¾æ­Œ, ä¸€ä¸ªä¸º
äºŒç™¾èˆ ..... (ç”¨å¿ƒå»ä½“ä¼š ğŸ˜‚)

### è¿™ä¸ªæ‰æ˜¯å¼€ç¯‡

æ±Ÿæ¹–å››åˆ†äº”è£‚, ä¸€äººä¸€æ±Ÿæ¹–...

ä½†æˆ‘ä»¬æ˜¯ä¸€ä¸ªå›¢é˜Ÿï¼Œä¸ºäº†ä¾¿äºç®¡ç†å’Œç»´æŠ¤ï¼Œæ€¥éœ€ä¸€ä»½ä»£ç è§„èŒƒ, æ¥çº¦æŸæˆ‘ä»¬çš„ç¼–ç è§„åˆ™å’Œä¹ æƒ¯, å°±åƒä¿®ç‚¼ä¸€é—¨æ­¦æ—ç»å­¦, éœ€è¦ç§˜ç±çš„æŒ‡å¼• (è‘µèŠ±å®å…¸?)ã€‚

è¯·å„ä½è‹±é›„å¥½æ±‰ä»”ç»†é˜…è¯» ä¸¥æ ¼éµå®ˆ
å¦‚æœ‰ä¸è¶³ä¹‹å¤„ å¸Œæœ›æå‡ºæ„è§ å…±å•†æ­¦æ—ç»Ÿä¸€éœ¸ä¸š

ä» 1000 ä¸ªå“ˆå§†é›·ç‰¹è½¬å˜ä¸ºåŒä¸€ä¸ª **æ—å¿—ç²**, ä»£ç é£æ ¼ä¿æŒç»Ÿä¸€æœ‰åˆ©äºæé«˜å·¥ä½œæ•ˆç‡, ä¾¿äºç®¡ç†.

æ¯”å¦‚:

1. ä¸€çœ‹åˆ°ä»¥ Controller ç»“å°¾çš„ç±», å°±åº”è¯¥çŸ¥é“è¿™ä¸ªæ˜¯æ¥å£, ç”¨äºå‚æ•°éªŒè¯, è°ƒç”¨ä¸šåŠ¡ç±»è¿›è¡Œå¤„ç†ä¸šåŠ¡é€»è¾‘, ç»„è£…ç»“æœ, è¿”å›æ•°æ®æˆ–è€…è·³è½¬é¡µé¢;
2. ä¸€çœ‹åˆ°ä»¥ Service ç»“å°¾çš„ç±», å°±çŸ¥é“è¿™ä¸ªæ˜¯ä¸šåŠ¡æ¥å£ç±», ç”¨äºå®šä¹‰ä¸šåŠ¡æ¥å£;
3. ä¸€çœ‹åˆ°ä»¥ Impl ç»“å°¾çš„ç±», å°±åº”è¯¥çŸ¥é“è¿™ä¸ªæ˜¯ä¸šåŠ¡å®ç°ç±», ç»„åˆä¸åŒçš„ Dao, å®ç°ä¸šåŠ¡é€»è¾‘;
4. ä¸€çœ‹åˆ°ä»¥ Dao ç»“å°¾çš„ç±», å°±åº”è¯¥çŸ¥é“è¿™ä¸ªæ˜¯ DB æ“ä½œç±», å¯¹æ•°æ®è¿›è¡Œ CRUD æ“ä½œ;
5. ä¸€çœ‹åˆ°ä»¥ Dto ç»“å°¾çš„ç±», å°±åº”è¯¥çŸ¥é“è¿™ä¸ªæ˜¯æ•°æ®ä¼ è¾“å¯¹è±¡, ç”¨äºå±•ç¤ºå±‚å’ŒæœåŠ¡å±‚ä¹‹é—´çš„æ•°æ®ä¼ è¾“;
6. ....

## çº¦å®š

ä¸ºäº†é¿å…æ­§ä¹‰, æ–‡æ¡£å¤§é‡ä½¿ç”¨ä»¥ä¸‹è¯æ±‡, è§£é‡Šå¦‚ä¸‹:

1. `å¿…é¡»` (must): ç»å¯¹ï¼Œä¸¥æ ¼éµå¾ªï¼Œè¯·ç…§åšï¼Œæ— æ¡ä»¶éµå®ˆï¼›
2. `ä¸€å®šä¸å¯` (must not): ç¦ä»¤ï¼Œä¸¥ä»¤ç¦æ­¢ï¼›
3. `åº”è¯¥` (should): å¼ºçƒˆå»ºè®®è¿™æ ·åšï¼Œä½†æ˜¯ä¸å¼ºæ±‚ï¼›
4. `ä¸è¯¥` (should not): å¼ºçƒˆä¸å»ºè®®è¿™æ ·åšï¼Œä½†æ˜¯ä¸å¼ºæ±‚ï¼›
5. `å¯ä»¥` (may) å’Œ å¯é€‰ (optional): é€‰æ‹©æ€§é«˜ä¸€ç‚¹ï¼Œåœ¨è¿™ä¸ªæ–‡æ¡£å†…ï¼Œæ­¤è¯è¯­ä½¿ç”¨è¾ƒå°‘ï¼›
6. `æ¨è` (recommend): ä¸ªäººæ¨èçš„åšæ³•, ä¸å¼ºæ±‚;

## å‡†å¤‡å·¥ä½œ

> è¡Œèµ°æ±Ÿæ¹–, æ²¡æœ‰ä¸€ä»¶è¶æ‰‹çš„å…µå™¨æ€ä¹ˆèƒ½åœ¨æ±Ÿæ¹–ä¸­ç«‹è¶³, è¿˜åœ¨ç”¨ `eclipse` çš„å°‘ä¾ ä»¬, å¸Œæœ›å¼ƒæš—æŠ•æ˜, æ‹¥æŠ± Intellij IDEA, ä½ ä¼šå‘ç°ç¼–ç æ•ˆç‡æå‡ä¸æ˜¯
> **ç‚¹å·´ç‚¹å„¿**, è€Œæ˜¯ **è¹­è¹­è¹­** çš„å¾€ä¸Šæ¶¨ ğŸ˜.

**æˆ‘ä¸æ˜¯å¯ŒäºŒä»£, æˆ‘æ²¡æœ‰èµ¢åœ¨äººç”Ÿçš„èµ·è·‘çº¿ä¸Š, ä½†æ˜¯æˆ‘ç”¨ Intellij IDEA, æˆ‘èµ¢åœ¨äº†å·¥ä½œçš„èµ·è·‘çº¿ä¸Š!**

æ¨èä¸€ä¸ªæ¯”è¾ƒå…¨é¢çš„ [Intellij IDEA æ•™ç¨‹](https://github.com/judasn/IntelliJ-IDEA-Tutorial)

**å·¥æ¬²å–„å…¶äº‹, å¿…å…ˆåˆ©å…¶å™¨. ä¸€ä»¶è¶æ‰‹çš„å…µå™¨å¸¦ä½ è¿å¨¶ç™½å¯Œç¾, èµ°ä¸Šäººç”Ÿå·…å³°, ç»Ÿä¸€æ±Ÿæ¹–, æŒ‡æ—¥å¯å¾…**

![20241229154732_uHJneu7y.webp](https://cdn.dong4j.site_uHJneu7y.webp)

ä¸ºäº†ç®€åŒ–æ‰‹åŠ¨æ“ä½œå’Œæé«˜ç¼–ç æ•ˆç‡, è¦æ±‚å®‰è£…å‡ ä¸ªå¿…è¦çš„æ’ä»¶, ä»¥åŠå¯¹ IDEA è¿›è¡Œå¿…è¦çš„ä¼˜åŒ–é…ç½®

### Intellij IDEA æ’ä»¶

#### Alibaba Java Coding Guidelines

> `å¿…é¡»` å®‰è£…, ä»£ç è§„èŒƒæ£€æŸ¥çš„åŸºç¡€

**ä½œç”¨: ä»£ç è§„åˆ™æ£€æŸ¥**

æ­¤æ’ä»¶æ˜¯ é˜¿é‡Œå·´å·´æ ¹æ® [é˜¿é‡Œå·´å·´å¼€å‘æ‰‹å†Œ](https://github.com/alibaba/p3c/) å¼€å‘çš„ä¸€ä¸ªé™æ€ä»£ç è§„èŒƒæ£€æŸ¥æ’ä»¶, æ¯ä¸ªè­¦å‘Šéƒ½æä¾›äº†ä¸€ä¸ª demo,

![20241229154732_Hs7lxRAM.webp](https://cdn.dong4j.site_Hs7lxRAM.webp)
æ­¤ç¯‡ä»¥ [é˜¿é‡Œå·´å·´å¼€å‘æ‰‹å†Œ](https://github.com/alibaba/p3c/) ä¸ºåŸºç¡€, ä½†æ˜¯å¹¶ä¸ä¼šä¸€ä¸€ç½—åˆ—æ¯æ¡è§„èŒƒ, å› ä¸ºæ­¤æ’ä»¶å·²ç»èƒ½å¾ˆå¥½çš„æ£€æŸ¥äº†.

**æ­¤ç¯‡é‡ç‚¹åœ¨äºè¿™ä¸ªæ’ä»¶ä¸èƒ½æ£€æŸ¥çš„è§„èŒƒ.**

#### lombok

> `å¿…é¡»` å®‰è£…, ä¸ç„¶ä»£ç è·‘ä¸èµ·æ¥å°±å°´å°¬äº†

**ä½œç”¨: åŒ–ç¹ä¸ºç®€. [å®˜ç½‘](<[http://projectlombok.org/](http://projectlombok.org/)>)**

ä½¿ç”¨ `@Data` ä»£æ›¿çƒ¦äººçš„ get/set æ–¹æ³•

![20241229154732_0RVNjOoe.webp](https://cdn.dong4j.site_0RVNjOoe.webp)

ä½¿ç”¨ `@Slf4j` ä»£æ›¿è·å– log å®ä¾‹çš„ä»£ç 

```java
private static final Logger log = LoggerFactory.getLogger(ApplicationTest.class);
```

![20241229154732_FeOsPGD7.webp](https://cdn.dong4j.site_FeOsPGD7.webp)

**ä½¿ç”¨æ–¹å¼**ï¼š

1. åœ¨ pom æ–‡ä»¶ä¸­æ·»åŠ ï¼š

   ```xml
   <!-- lombok-->
   <dependency>
       <groupId>org.projectlombok</groupId>
       <artifactId>lombok</artifactId>
       <version>${lombok.version}</version>
   </dependency>
   ```

2. åœ¨ IDEA ä¸­æ·»åŠ æ’ä»¶ `lombok` ï¼ˆfile->setting->pluginsï¼‰

3. IDEA è®¾ç½®

   ![20241229154732_izw0KAnS.webp](https://cdn.dong4j.site_izw0KAnS.webp)

#### Maven Helper

> `å¿…é¡»` å®‰è£…, ä¸ç„¶ä¾èµ–å†²çªäº†å°±ä¸å¥½äº†

**ä½œç”¨: æ£€æŸ¥ä¾èµ–å†²çª**

æ–°åŠ å…¥ä¸€ä¸ª jar åŒ…, è°æ·»åŠ è°è´Ÿè´£, ä½¿ç”¨æ­¤æ’ä»¶æ£€æŸ¥æ˜¯å¦æœ‰ä¾èµ–å†²çª.

ä¾èµ–å†²çªå¯èƒ½ä¼šå¯¼è‡´:

1. java.lang.ClassNotFoundException
2. java.lang.NoSuchMethodError
3. java.lang.NoClassDefFoundError
4. å¼€å‘ç¯å¢ƒæ­£å¸¸, æµ‹è¯•æˆ–è€…ç”Ÿäº§ç¯å¢ƒä¸æ­£å¸¸....

![20241229154732_TxMWYfwd.webp](https://cdn.dong4j.site_TxMWYfwd.webp)

#### JavaDoc

> `å¿…é¡»` å®‰è£…

**ä½œç”¨: å¿«é€Ÿç”Ÿæˆæ ‡å‡†çš„ javadoc**

![1111.gif](https://cdn.dong4j.site

#### JRebel

> `æ¨è` å®‰è£…, æé«˜å·¥ä½œæ•ˆç‡çš„æ’ä»¶.

**ä½œç”¨: ä»£ç çƒ­éƒ¨ç½²æ’ä»¶, æ”¹äº†ä»£ç å, é‡æ–°ç¼–è¯‘, ä¸ç”¨é‡å¯åº”ç”¨å°±å¯æŸ¥çœ‹æ•ˆæœ.**

çƒ­éƒ¨ç½²æ’ä»¶, è°ç”¨è°çŸ¥é“;

[ç§‘å­¦ä½¿ç”¨æ–¹æ³•](http://blog.lanyus.com/search/JRebel/) (ä½è°ƒç‚¹)

#### Mybatis Plugin

> `æ¨è` å®‰è£…, æé«˜å·¥ä½œæ•ˆç‡çš„æ’ä»¶.

**ä½œç”¨: xml å’Œ dao å¿«é€Ÿè·³è½¬; å¿«é€Ÿç”Ÿæˆ xml; xml æ£€æŸ¥**

![222.gif](https://cdn.dong4j.site

#### GenerateSerialVersionUID

> `æ¨è` å®‰è£…, æé«˜å·¥ä½œæ•ˆç‡çš„æ’ä»¶

**ä½œç”¨: ä¸ºå®ç°äº† Serializable æ¥å£çš„å®ä½“å¿«é€Ÿæ·»åŠ  serialVersionUID, æé«˜æ•ˆç‡**

å› ä¸ºè¦æ±‚å®ä½“ `å¿…é¡»` å®ç° `Serializable` æ¥å£, è€Œä¸” `å¿…é¡»` æ·»åŠ  `serialVersionUID` å­—æ®µ.

![333.gif](https://cdn.dong4j.site

#### GenerateAllSetter

> `æ¨è` å®‰è£…, æé«˜å·¥ä½œæ•ˆç‡çš„æ’ä»¶

**ä½œç”¨: å¿«é€Ÿç”Ÿæˆ set æ–¹æ³•**

![444.gif](https://cdn.dong4j.site

#### Translation

> `æ¨è` å®‰è£…, æé«˜å·¥ä½œæ•ˆç‡çš„æ’ä»¶

**ä½œç”¨: ç¿»è¯‘æ’ä»¶, æä¾› ç™¾åº¦, æœ‰é“, Google ç¿»è¯‘**

ä¸€æ¬¾ä¸ºåƒæˆ‘è¿™ç§è‹±è¯­æ¸£çš„ç å†œé‡èº«å®šåšçš„æ’ä»¶ ğŸ˜‚

![555.gif](https://cdn.dong4j.site

#### Grep Console

> `æ¨è` å®‰è£…

**ä½œç”¨: é«˜äº®æ˜¾ç¤º log ä¸åŒçº§åˆ«æ—¥å¿—ï¼Œçœ‹æ—¥å¿—çš„æ—¶å€™ä¸€ç›®äº†ç„¶; å…·æœ‰ error çº§åˆ«å£°éŸ³æé†’åŠŸèƒ½ (å¯è®¾ç½®)**

æ•ˆæœ:

![20241229154732_NW1Z8dTj.webp](https://cdn.dong4j.site_NW1Z8dTj.webp)

æ’ä»¶è®¾ç½®:

![20241229154732_CExDSzg1.webp](https://cdn.dong4j.site_CExDSzg1.webp)
æ­¤æ’ä»¶é€šè¿‡ log è¾“å‡ºä¸­çš„ info/debug/warn/error æ¥åŒ¹é…å¯¹åº”çš„é¢œè‰². å› æ­¤ log è¾“å‡ºä¸­å¿…é¡»åŒ…å« **æ—¥å¿—çº§åˆ«**, è¿™ä¸ª **æ—¥å¿—è§„èŒƒ** ä¸­å†è¯´.

#### RestfulToolkit

> `æ¨è` å®‰è£…

**ä½œç”¨: å¿«é€Ÿå®šä½æ¥å£, Rest è¯·æ±‚æ¨¡æ‹Ÿ **

![666.gif](https://cdn.dong4j.site

#### Restore Sql for iBatis/Mybatis

> `æ¨è` å®‰è£…

**ä½œç”¨: æŸ¥çœ‹è¯·æ±‚ sql, å¯ç›´æ¥è¿è¡Œ **

æ•ˆæœ:

`meeting-service` è°ƒç”¨ `/login` æ¥å£åéœ€è¦æ‰§è¡Œçš„ sql

![20241229154732_dUkaaD0g.webp](https://cdn.dong4j.site_dUkaaD0g.webp)

### Intellij IDEA è®¾ç½®

#### ç¼–ç è®¾ç½®

> ç¼–ç  `å¿…é¡»` ä½¿ç”¨ `UTF-8`, ä¸” `å¿…é¡»` è®¾ç½®ä¸º `with NO BOM`

![20241229154732_cNmFzTvf.webp](https://cdn.dong4j.site_cNmFzTvf.webp)

`è¸©å‘`

**Windows ä¸‹è¯·ä¸è¦ç”¨è®°äº‹æœ¬æ‰“å¼€ UFT-8 ç¼–ç çš„æ–‡æœ¬æ–‡ä»¶, æ›´ä¸è¦ä¿å­˜ **

Windows å‘çš„å¾ˆ, UTF-8 ç¼–ç çš„æ–‡æœ¬æ–‡ä»¶æœ€å‰é¢ä¼šç»™ä½ åŠ ä¸Šä¸€ä¸ª BOM, å…¶ä»–ç³»ç»Ÿæ‰“å¼€æ˜¯æ­£å¸¸æ˜¾ç¤º, ä½†æ˜¯ä¸ä¼šæ˜¾ç¤ºè¿™ä¸ª BOM, é€ æˆæ–‡ä»¶è§£æå‡ºé”™.

##### html è®¾ç½®ç¼–ç ä¸º UTF-8

```html
<meta charset="UTF-8" />
```

> html æˆ–è€…æ¨¡æ¿ `åº”è¯¥` ä½¿ç”¨ html5

html4 å‡çº§ä¸º html5 éå¸¸ç®€å•

```html
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <link type="text/css" rel="stylesheet" href="css.css" />
    <script type="text/javascript" src="jquery.js"></script>
    <title>Document</title>
  </head>
  <body></body>
</html>
```

ä¿®æ”¹ä¸º:

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="css.css" />
    <script src="jquery.js"></script>
    <title>Document</title>
  </head>
  <body></body>
</html>
```

ç®€å•çš„å‡çº§, å°±èƒ½äº«å— 30 å¤šä¸ªæ–°æ ‡ç­¾å¸¦æ¥çš„ä¾¿æ·, ä½•ä¹è€Œä¸ä¸ºå‘¢?

å°±è·Ÿè¶…å¸‚æ‰“æŠ˜ä¸€æ ·, è¿˜å€’é€ä½  30 å—, è·³å¹¿åœºèˆçš„å¤§å¦ˆæ’ç€é˜Ÿå», ä½ è¿˜ä¸å»?

##### Tomcat è®¾ç½®ç¼–ç ä¸º UTF-8

```xml
<Connector port="8080" protocol="HTTP/1.1"
                connectionTimeout="20000"
                redirectPort="8443"  />
```

æ”¹ä¸º:

```xml
<Connector port="8080" protocol="HTTP/1.1"
                connectionTimeout="20000"
                redirectPort="8443"
                URIEncoding="UTF-8" />
```

Tomcat7 é»˜è®¤ç¼–ç ä¸º ISO-8859-1, åˆ°äº† Tomcat8 å, é»˜è®¤ç¼–ç æ”¹ä¸º UTF-8
å› æ­¤ä»¥ä¸Šä¿®æ”¹åªé’ˆå¯¹äº Tomcat7.

#### todo æ ‡è¯†

> `å¿…é¡»`

**ä½œç”¨: æ–¹ä¾¿æœç´¢, æ˜ç¡®è´Ÿè´£äºº, è¯´æ˜ todo åŸå›  **

è¿™é‡Œæ‰©å±•äº† IDEA è‡ªå¸¦çš„ todo æ ‡è¯†, ä½¿ç”¨ `todo- è´Ÿè´£äºº: (æ—¶é—´) [åŸå› ]` æ¥è§„èŒƒ `todo` ç”¨æ³•

![20241229154732_2ZRdEKBJ.webp](https://cdn.dong4j.site_2ZRdEKBJ.webp)

```lua
todo- è´Ÿè´£äºº: ($date$ $time$) [$SELECTION$]
```

**date time è®¾ç½®è§ ç±»æ³¨é‡Šä¸€èŠ‚ **

æ•ˆæœ:

![777.gif](https://cdn.dong4j.site

#### fixme æ ‡è¯†

> `å¿…é¡»`

```lua
fixme- è´Ÿè´£äºº: ($date$ $time$ [$SELECTION$])
```

è®¾ç½®å’Œæ•ˆæœåŒä¸Š

#### ç±»æ³¨é‡Š

> `å¿…é¡»` ä¸ºæ¯ä¸ªç±»æ·»åŠ å¿…è¦çš„æ³¨é‡Š

è¿™é‡Œæœ‰ 2 ä¸­æ–¹å¼:

**1. æ–°å»ºç±»æ—¶æ·»åŠ æ³¨é‡Š **

![888.gif](https://cdn.dong4j.site

è®¾ç½®æ–¹å¼:

![20241229154732_xjBq89Wf.webp](https://cdn.dong4j.site_xjBq89Wf.webp)

```java
#if (${PACKAGE_NAME} && ${PACKAGE_NAME} != "")package ${PACKAGE_NAME};#end
##parse("File Header.java")

/**
 * <p>Company: xxxxå…¬å¸ </p>
 * <p>Description: ${description}</p>
 Â¶*
 * @author ä½ çš„æ˜µç§°
 * @date ${YEAR}-${MONTH}-${DAY} ${HOUR}:${MINUTE}
 * @email ç”¨æˆ·å@xxxx.com
 */
public class ${NAME} {
}
```

**2. ä¸ºå·²å­˜åœ¨çš„ç±»æ·»åŠ æ³¨é‡Š **

![999.gif](https://cdn.dong4j.site

è®¾ç½®æ–¹å¼:

![20241229154732_FMVEAJ28.webp](https://cdn.dong4j.site_FMVEAJ28.webp)

```java
/**
 * <p>Company: xxxxå…¬å¸ </p>
 * <p>Description: $END$</p>
 *
 * @author ä½ çš„æ˜µç§°
 * @date $date$ $time$
 * @email ç”¨æˆ·å@xxxx.com
 */
```

#### æ–¹æ³•æ³¨é‡Š

> `æ¨è` ä½¿ç”¨ JavaDoc æ’ä»¶è‡ªåŠ¨ç”Ÿæˆ

JavaDoc åªèƒ½è‡ªåŠ¨ç”Ÿæˆé `private` æ–¹æ³•å’Œå±æ€§çš„æ³¨é‡Š, å¦‚æœéœ€è¦ç”Ÿæˆ `private` çº§çš„æ³¨é‡Š, å¯ä»¥é€šè¿‡ä¿®æ”¹ `public`, ç”Ÿæˆå®Œæˆå, å†ä¿®æ”¹å›æ¥

#### ä»£ç æ³¨é‡Š

> `ä¸è¯¥` ä½¿ç”¨è¡Œå°¾æ³¨é‡Š;
> `æ¨è` ä½¿ç”¨ // ä»£æ›¿ `/*...*/` å¤šè¡Œæ³¨é‡Š;
> `æ¨è` ä½¿ç”¨ `/**..*/` å¯¹å­—æ®µè¿›è¡Œæ³¨é‡Š (å•è¡Œ);
> æ‰€æœ‰å­—æ®µå, æ–¹æ³•å, ç±»å éƒ½ `åº”è¯¥` ä½¿ç”¨ç®€å•, ä¸šç•Œå¸¸ç”¨çš„å•è¯å‘½å, ä¸è¦ä¸ºäº†æ³¨é‡Šè€Œæ³¨é‡Š, è®²ç©¶ä¸ªä»£ç ä¹‹ç¾.

åœ¨æŸ¥çœ‹å¤§æ®µä»£ç æ—¶, `æ¨è` ä½¿ç”¨

```java
// region æ®µæ³¨é‡Š
....
// endregion
```

**æ­¤æ³¨é‡Šèƒ½å¢åŠ ä»£ç æŠ˜å åŠŸèƒ½, ä¾¿äºå¿«é€Ÿæ¢³ç†ä»£ç  **

![11111.gif](https://cdn.dong4j.site

### Version Control è®¾ç½®

> `å¿…é¡»` å¿½ç•¥ target ç›®å½•
> `å¿…é¡»` å¿½ç•¥ .idea
> `å¿…é¡»` å¿½ç•¥ `*.iml`
> `å¿…é¡»` æ·»åŠ  .ignore æ–‡ä»¶

**å¦‚æœä½¿ç”¨ git, æ‰€æœ‰å¿½ç•¥æ–‡ä»¶éƒ½å¯ä»¥æ·»åŠ åˆ° .ignore å³å¯ **

**æäº¤ä»£ç æ—¶çš„è®¾ç½® **

![20241229154732_RjJbNzVS.webp](https://cdn.dong4j.site_RjJbNzVS.webp)

> `å¿…é¡»` å‹¾é€‰ Optimize imports; (æäº¤ä»£ç æ—¶, è‡ªåŠ¨åˆ é™¤ä¸è¢«ä½¿ç”¨çš„ import)
> `æ¨è` å–æ¶ˆæ‰é»˜è®¤å‹¾é€‰çš„ Perform code analysis å’Œ Check TODO, ä¼šå¢åŠ æäº¤ä»£ç çš„æ—¶é—´;
> `ä¸è¯¥` å‹¾é€‰ Reformat code, ä¼šæ ¼å¼åŒ–æ‰€æœ‰æäº¤çš„ä»£ç , æ ¼å¼åŒ–ä»£ç åº”è¯¥è‡ªå·±æ‰‹åŠ¨æ ¼å¼åŒ–, è¿™æ ·èƒ½å‡å°‘ä»£ç å†²çªçš„å¯èƒ½;

## ä»£ç æ ·å¼

ä»¥ intellij-java-google-style.xml ä¸ºåŸºç¡€, åšäº†ä¸€éƒ¨åˆ†ä¿®æ”¹.

> musicsearch-project `å¿…é¡»çš„å¿…é¡»` ä½¿ç”¨æ­¤ä»£ç æ ·å¼, ä¸ºäº†å‡å°‘ä»£ç å†²çª, åŒä¸€ä»£ç æ ·å¼ (åŒä¸€é—¨æ´¾, ä½ å»ä¿®ç‚¼å…¶ä»–é—¨æ´¾æ­¦åŠŸ, ä¼šè¢«é€å‡ºå¸ˆé—¨çš„!).

æ¯”å¦‚:

1. ä¸€è¡Œçš„ä»£ç é•¿åº¦ä¸èƒ½è¶…è¿‡ 140 å®½;
2. ç­‰å·å¯¹é½;
3. if è¯­å¥åªæœ‰ä¸€è¡Œä¹Ÿ `å¿…é¡»` åŠ å¤§æ‹¬å·;
4. æ‰€æœ‰æ“ä½œç¬¦ä¸¤è¾¹ `å¿…é¡»` æœ‰ç©ºæ ¼;
5. ç±»å, æ–¹æ³•å `å¿…é¡»` åŠ ç©ºæ ¼åæ‰è·Ÿ ä¸€ä¸ª `{`;
6. ä½¿ç”¨ 4 ä¸ªç©ºæ ¼ä»£æ›¿åˆ¶è¡¨ç¬¦ (æˆ‘ä»¬è¿™é‡Œä¸è®¨è®ºç©ºæ ¼å¥½è¿˜æ˜¯åˆ¶è¡¨ç¬¦å¥½, ç»Ÿä¸€ä½¿ç”¨ä¸€ç§æ˜¯æœ€æœ€å¥½çš„);
7. ....

**ä»¥ä¸Šåˆ—ä¸¾çš„éƒ¨åˆ†è§„èŒƒéƒ½å¯ä»¥ä½¿ç”¨æ ¼å¼åŒ–è§£å†³;**

æœ¬äººå¯¹ä»£ç æœ‰ç€ä¸¥ (å˜) æ ¼(æ€)çš„è¦æ±‚, ä¸¥ (å˜) æ ¼(æ€)åˆ°ä½¿ç”¨ `//` åé¢ `å¿…é¡»` è·Ÿä¸€ä¸ªç©ºæ ¼, ç„¶åæ‰æ˜¯æ³¨é‡Šå†…å®¹; è‹±æ–‡å’Œä¸­æ–‡ä¹‹é—´ `å¿…é¡»` å¢åŠ ä¸€ä¸ªç©ºæ ¼;
æ‰€æœ‰æ ‡ç‚¹å…¨éƒ¨ä½¿ç”¨è‹±æ–‡æ ‡ç‚¹; æ²¡æœ‰è¢«ä½¿ç”¨çš„ç±», å˜é‡éƒ½ `å¿…é¡»` åˆ é™¤; é‡åˆ°çš„è­¦å‘Š `å¿…é¡»` å°½æœ€å¤§åŠªåŠ›æ”¹æ­£;

å·¦è¾¹ä¸ºé‡æ„ä¹‹å‰çš„è­¦å‘Šæ•°é‡ (é»„è‰²), å³è¾¹ä¸ºé‡æ„ä¹‹åçš„

![20241229154732_b8RAQPH9.webp](https://cdn.dong4j.site_b8RAQPH9.webp)

1. è‹±æ–‡å’Œä¸­æ–‡ä¹‹é—´å¢åŠ ç©ºæ ¼æ˜¯ä¸ºäº†ä¾¿äºé˜…è¯», æ–¹ä¾¿æ‹·è´ (åŒå‡»è‹±æ–‡å³å¯å…¨é€‰, å¦‚æœä¸å¢åŠ ç©ºæ ¼, ä¸­æ–‡è‹±æ–‡åˆ™ä¼šå…¨è¢«é€‰ä¸­. æˆ‘å˜æ€åˆ° chrome
   éƒ½è¦å®‰è£…ä¸€ä¸ªå« `ç©ºæ ¼ä¹‹ç¥` çš„æ’ä»¶, ç”¨äºåœ¨ä¸­è‹±æ–‡ä¹‹é—´è¿½åŠ ç©ºæ ¼);
2. å…¨éƒ¨ä½¿ç”¨è‹±æ–‡æ ‡ç‚¹çš„å¥½å¤„ä¸è¨€è€Œå–», Java ä¹ƒè‡³æ‰€æœ‰çš„ç¼–ç¨‹è¯­è¨€éƒ½ä¸æ”¯æŒä¸­æ–‡æ ‡ç‚¹, æ‰“ä¸ªåˆ†å·è¿˜å¾—åˆ‡æ¢è¾“å…¥æ³•, æƒ³æƒ³éƒ½å¿§ä¼¤; æœ‰æ—¶å€™å°±æ˜¯å› ä¸ºä¸­æ–‡æ ‡ç‚¹çš„é—®é¢˜,
   ä¸€ç›´æŠ¥é”™ (è¾“å…¥æ³•å¯ä»¥è®¾ç½®ä¸­æ–‡æ—¶ä½¿ç”¨è‹±æ–‡æ ‡ç‚¹, `æ¨è` è¿™ç§è®¾ç½®);
3. ç¬¦å·åé¢å–œæ¬¢è¿½åŠ ä¸€ä¸ªç©ºæ ¼, æ˜¯å— Markdown è¯­æ³•çš„å½±å“, ä»¥å‰ç”¨è¿‡å¾ˆå¤š Markdown ç¼–è¾‘å·¥å…·, ç”±äºè§£æè¯­æ³•ä¸ä¸€æ ·, è¿ç§»æ—¶æ¸²æŸ“ä¸ç”Ÿæ•ˆ, åŠ ä¸ªç©ºæ ¼æˆ–è€…æ¢è¡Œå°±
   Ok äº†; ğŸ˜‚
4. åŠæ—¶åˆ é™¤ä¸éœ€è¦çš„ä»£ç , æ—¶åˆ»ä¿æŒä»£ç å¹²å‡€ (IDEA ä¼šå¸®æˆ‘ä»¬æ£€æŸ¥æœªä½¿ç”¨çš„ä»£ç ).
5. **è­¦å‘Šæ˜¯ bug çš„æ¸©åºŠ, ä¿®å¤è­¦å‘Š, å°±æ˜¯ä¿®å¤æ½œåœ¨çš„ bug**. ä¿®å¤è­¦å‘Š, ä¹Ÿèƒ½å­¦åˆ°å¾ˆå¤šä¸œè¥¿çš„ (ğŸ˜)

## musicsearch-project è§„èŒƒ

ä»¥ä¸‹ä½œä¸º `musicsearch-project` è§„èŒƒ, åˆ¶å®šäº†å¤§éƒ¨åˆ†è¦æ±‚.

å…·ä½“è®¾è®¡å°†åœ¨ ç¬¬ä¸‰ç¯‡ ä»‹ç»

### é¡¹ç›®ç»“æ„è§„èŒƒ

```lua
.
â”œâ”€â”€ musicsearch-business            # ä¸šåŠ¡ä¸»æ¨¡å—
â”‚     â”œâ”€â”€ business-common             # ä¸šåŠ¡å…¬å…±ç±»åº“
â”‚     â”œâ”€â”€ mservice-migu-game          # migu-game ä¸šåŠ¡
â”‚     â””â”€â”€ service-meeting             # meeting æœåŠ¡æ¨¡å—
â”œâ”€â”€ musicsearch-common              # musicsearch é¡¹ç›® å…¬å…±æ¨¡å—
â”œâ”€â”€ musicsearch-component           # ç»„ä»¶ä¸»æ¨¡å—
â”‚     â”œâ”€â”€ component-iavp              # iavp æ¨¡å—, å°è£… iavp ç›¸å…³å®ä½“å’Œæ¥å£, ç›´æ¥æ³¨å…¥å³å¯
â”‚     â”œâ”€â”€ component-mybatis           # mybatis æ¨¡å—, æä¾›ä»£ç ç”Ÿæˆå’Œ mybatis ç›¸å…³åŠŸèƒ½
â”‚     â”œâ”€â”€ component-redis             # redis æ¨¡å—, æ³¨å…¥ RedisService å³å¯, æä¾›å¤šç§æ¨¡å¼
â”‚     â””â”€â”€ component-websocket         # websocket æ¨¡å— netty-socket.io å°è£…
â”œâ”€â”€ musicsearch-demo                # demo ä¸»æ¨¡å—
â”‚     â”œâ”€â”€ component-mybatis-demo
â”‚     â””â”€â”€ component-redis-demo
â”œâ”€â”€ musicsearch-dependencies        # ç®¡ç†ç¬¬ä¸‰æ–¹ jar ç‰ˆæœ¬å’Œä¾èµ–å…³ç³»
â”œâ”€â”€ musicsearch-monitor             # ç›‘æ§ä¸»æ¨¡å—
â”œâ”€â”€ musicsearch-parent              # musicsearch å·¥ç¨‹ä¸»æ¨¡å—, ç®¡ç†æ•´ä¸ªåŠŸèƒ½çš„ç‰ˆæœ¬åŠä¾èµ–
â”‚     â””â”€â”€ docs                        # æ”¾å·¥ç¨‹ç›¸å…³æ–‡æ¡£
â”‚     â””â”€â”€ database                    # æ”¾å·¥ç¨‹ sql
â””â”€â”€ musicsearch-support             # æ”¯æ’‘æ¨¡å—ä¸»æ¨¡å—
    â”œâ”€â”€ musicsearch-code-generator
    â”œâ”€â”€ musicsearch-management-system
    â””â”€â”€ musicsearch-timer-task
```

ç›®å‰é‡æ„åçš„æ¨¡å—, å¯èƒ½è¿˜ä¼šæœ‰ä¿®æ”¹.
ä½†æ˜¯å‡ ä¸ªä¸»è¦æ¨¡å—ä¸ä¼šå†ä¿®æ”¹äº†.

> æ•´ä¸ªé¡¹ç›®ç»“æ„é‡‡ç”¨ `Maven` å¤šæ¨¡å—çš„æ–¹å¼å¼€å‘.
> ç›®çš„æ˜¯ä¸ºäº†è§£å†³ jar ä¾èµ–æ··ä¹±é—®é¢˜.

**ç»“æ„è§„èŒƒ:**

> æ‰€æœ‰ä¸»æ¨¡å— `å¿…é¡»` ä»¥ `musicsearch-` å¼€å§‹.

ä¸ä¸ºåˆ«çš„, çº¯å±ç»Ÿä¸€å‰ç¼€, å¥½çœ‹è€Œå·²

> æ¨¡å—å `å¿…é¡»` å…¨éƒ¨ä½¿ç”¨å°å†™, å•è¯ä¹‹é—´ä½œç”¨ `-` åˆ†éš”;

#### musicsearch-parent

ä½œä¸ºæ•´ä¸ªé¡¹ç›®çš„ çµé­‚ æ¨¡å—, ç®¡ç†æ‰€æœ‰è‡ªæœ‰æ¨¡å—çš„ç‰ˆæœ¬å’Œä¾èµ–å…³ç³», ä»¥åŠæ•´ä¸ªé¡¹ç›®éƒ½ä¼šä½¿ç”¨åˆ°çš„ä¾èµ–, æ¯”å¦‚ `lombok`, `junit` ç­‰.

![20241229154732_FNQjsndy.webp](https://cdn.dong4j.site_FNQjsndy.webp)
`dependencyManagement` æ ‡ç­¾åªæ˜¯ç”¨äºå£°æ˜å¯èƒ½ä¼šè¢«ä½¿ç”¨åˆ°çš„ä¾èµ– (å°±åƒå®šä¹‰å˜é‡), ä¸ä¼šçœŸæ­£æ·»åŠ ä¾èµ–
`dependency` æ‰ä¼šçœŸæ­£çœŸæ­£å¼•å…¥ä¾èµ–

è¿™é‡Œå…¨éƒ¨ä¸º `musicsearch-project` è‡ªæœ‰æ¨¡å—, ä»¥åæ–°å¢çš„æ¨¡å—ä¹Ÿ `å¿…é¡»` å°†å£°æ˜æ·»åŠ åˆ°æ­¤æ ‡ç­¾ä¸‹
è‡ªæœ‰æ¨¡å—ä¹‹é—´ä¾èµ–å°±å¯ç›´æ¥ä½¿ç”¨.

![20241229154732_vXVvcVaj.webp](https://cdn.dong4j.site_vXVvcVaj.webp)
ä½¿ç”¨æ—¶, `ä¸€å®šä¸å¯` æ·»åŠ  version æ ‡ç­¾, ä¸ç„¶å°±ä¼šä½¿ç”¨ä¿®æ”¹åçš„ç‰ˆæœ¬, å¯èƒ½ä¼šé€ æˆä¾èµ–å†²çª.

---

`musicsearch-project` æ¨¡å—ä¸‹æœ‰ä¸€ä¸ª doc ç›®å½•, ç”¨äºä¿å­˜æ–‡æœ¬æ–‡æ¡£

ä¸ªäººè®¤ä¸º, é¡¹ç›®çš„ `æŠ€æœ¯æ–‡æ¡£` è·Ÿç€ä»£ç èµ°æ‰æ˜¯æœ€æ­£ç¡®çš„åšæ³•.
éšæ—¶ä¿®æ”¹, éšæ—¶æŸ¥çœ‹, ä»£ç å’Œæ–‡æ¡£ä¸€èµ·æ›´æ–°æäº¤, æ‰æ˜¯æœ€ä½³å®è·µ.

![20241229154732_Sc2zPY5K.webp](https://cdn.dong4j.site_Sc2zPY5K.webp)
æŠ€æœ¯æ–‡æ¡£ `æ¨è` ä½¿ç”¨ `Markdown` è¯­æ³•ç¼–å†™, æœ€å¥½æ˜¯ [GitHub Markdown è¯­æ³•](https://guides.github.com/features/mastering-markdown/).

è¿™é‡Œç»™å‡ºæ¨¡å—è¯´æ˜æ¨¡æ¿, æ¯ä¸ªæ¨¡å—éƒ½ `å¿…é¡»` æœ‰æ­¤æ–‡æ¡£

```markdown
# æ¨¡å—å

## ç®€ä»‹

xxx

## æ‰“åŒ…æ–¹å¼

xxx

## éƒ¨ç½²æ–¹å¼

xxx

## ä½¿ç”¨è¯´æ˜

1. xxx
2. xxx
3. xxx

## æ³¨æ„äº‹é¡¹

xxx

## æ›´æ–°å†å²

**æ›´æ–°æ—¶é—´ æ›´æ–°äºº **

1. xxx
2. xxx
```

---

`database` ç”¨äºä¿å­˜éœ€æ±‚éœ€è¦æ›´æ–°çš„ sql æ–‡ä»¶, `å¿…é¡»` ä»¥ `.sql` ä¸ºåç¼€, `å¿…é¡»` æ˜¯ UTF-8 ç¼–ç .

#### musicsearch-dependencies

æ­¤æ¨¡å—æ˜¯ä¸ºäº†æ–¹ä¾¿ç®¡ç†ç¬¬ä¸‰æ–¹ jar ä¾èµ–è€Œç‰¹æ„æ·»åŠ çš„, å¦‚æœæ²¡æœ‰æ­¤æ¨¡å—, ç¬¬ä¸‰æ–¹ä¾èµ–ä¹Ÿå¯ä»¥æ·»åŠ åˆ° `musicsearch-project` ä¸­, ä½†æ˜¯ä¼šé€ æˆè¿‡åº¦è‡ƒè‚¿,
å› æ­¤å°†ç¬¬ä¸‰æ–¹ä¾èµ–æ‹†åˆ†åˆ°æ­¤æ¨¡å—ä¸­è¿›è¡Œç»Ÿä¸€ç®¡ç†.

> ç¬¬ä¸‰æ–¹ä¾èµ– `å¿…é¡»` æ·»åŠ åˆ°æ­¤æ¨¡å—, ä¸” `å¿…é¡»` å°†ç‰ˆæœ¬å·è®¾ç½®åˆ° properties æ ‡ç­¾ä¸‹.
> ç¬¬ä¸‰æ–¹ä¾èµ–è¾ƒå¤§å¯èƒ½å­˜åœ¨ç‰ˆæœ¬å†²çª, å› æ­¤æ­¤æ¨¡å—çš„ç‰ˆæœ¬ä» `0.0.1` å¼€å§‹, ä¸å’Œ `musicsearch-parent` ç›¸åŒ, å¦‚æœæ­¤æ¨¡å—å­˜åœ¨ä¾èµ–é—®é¢˜, ä¿®å¤å, éœ€è¦æå‡ç‰ˆæœ¬å·,
> å¹¶ä¸” `å¿…é¡»` å†™æ›´æ–°è®°å½•.

æ­¤æ¨¡å—æ¯”è¾ƒç‰¹æ®Š, ä¿®æ”¹ä¼šæ¯”è¾ƒé¢‘ç¹, ä¾èµ–å‡ºé”™å¤§éƒ¨åˆ†å‡ºç°åœ¨æ­¤æ¨¡å—, å› æ­¤å•ç‹¬å†™ä¸€ä¸ª `changes.md`, ç”¨äºè®°å½•æ›´æ–°æ—¥å¿—.

![20241229154732_mPHwivSa.webp](https://cdn.dong4j.site_mPHwivSa.webp)

**å¼•å…¥æ–°ä¾èµ–æ­¥éª¤ **

1. åœ¨ `musicsearch-dependencies` æ·»åŠ æ–°ä¾èµ–;
2. å°†ç‰ˆæœ¬ä¿¡æ¯å†™å…¥åˆ° pom çš„ properties æ ‡ç­¾å†…, è¿›è¡Œç»Ÿä¸€ç®¡ç†;
3. åœ¨éœ€è¦çš„æ¨¡å—ä¸­, å¼•å…¥ä¾èµ–;
4. æœ€åä½¿ç”¨ `Maven Helper` æ’æŸ¥æ˜¯å¦å­˜åœ¨ä¾èµ–å†²çª;
5. å¦‚æœå­˜åœ¨å†²çª éœ€è¦ä½¿ç”¨ `<exclusions>` æ’é™¤ç›¸åº”çš„ä¾èµ–;

#### musicsearch-common

`musicsearch-project` é¡¹ç›®çš„å­æ¨¡å—, ä½œä¸ºæœ€åº•å±‚çš„ä¾èµ–, æä¾›äº†å…¬å…± util åŒ…, core åŒ…, base åŒ…ç­‰åŸºç¡€ä»£ç .

> å¦‚æœè¢«æ•´ä¸ªé¡¹ç›®ä½¿ç”¨åˆ°çš„ä»£ç , éƒ½ `å¿…é¡»` æ”¾å…¥æ­¤æ¨¡å—, æ¯”å¦‚ StringUtils å·¥å…·ç±», ä¸€äº›åŠ å¯†ç±», æ•´ä¸ªé¡¹ç›®éƒ½èƒ½ä½¿ç”¨åˆ°çš„å¸¸é‡ç±», æšä¸¾ç±»ç­‰;

**å¿…é¡»è¦æå‡ºçš„æ˜¯:**

ä¸è¦å¤šä¸ªæ¨¡å—å¤šä¸ª StringUtils å·¥å…·ç±», æœ€ä½³å®è·µ `åº”è¯¥` æ˜¯ `musicsearch-common` ä¸­ç¼–å†™ä¸€ä¸ªé€šç”¨çš„ `StringUtils` ç±»,
ç»§æ‰¿è‡ª `org.apache.commons.lang3.StringUtils` ç±», ä¸šåŠ¡æ¨¡å—ç»§æ‰¿ `musicsearch-common` æ¨¡å—ä¸­çš„ `StringUtils` ç±»,
å®ç°ä¸šåŠ¡ç›¸å…³çš„å­—ç¬¦ä¸²å¤„ç†å·¥å…·ç±».(è¿™ç§æ–¹å¼åŒæ ·é€‚ç”¨äºå…¶ä»–ç±»)

#### musicsearch-business

ä¸šåŠ¡æ¨¡å—çš„çˆ¶æ¨¡å—, `musicsearch-parent` æ¨¡å—çš„å­æ¨¡å—.
ç”¨äºç®¡ç†ä¸šåŠ¡æ¨¡å—å…±ç”¨çš„ jar ä¾èµ–.

> æ‰€æœ‰ä¸šåŠ¡æ¨¡å— `å¿…é¡»` æ˜¯ `musicsearch-business` çš„å­æ¨¡å—

å°†ä¸šåŠ¡ä»£ç å…¨éƒ¨æ•´åˆåœ¨ä¸€ä¸ªæ¨¡å—ä¸­, ä½¿ç”¨ä¸šåŠ¡åè¿›è¡Œå†åˆ†å­æ¨¡å—çš„æ–¹å¼, ç®¡ç†æ•´ä¸ªä¸šåŠ¡ä»£ç .
å…¶ä»–å…±ç”¨æ¨¡å—ä½œä¸ºæ¡†æ¶åŸºç¡€æ¨¡å—, ä»¥åæ–°é¡¹ç›®è¿˜å¯ä»¥å¤ç”¨.

> ä¸æä¾› `dubbo service` çš„æ¨¡å—, `å¿…é¡»` ä»¥ `service-` å¼€å§‹.
> æä¾› `dubbo service` çš„æ¨¡å—, `å¿…é¡»` ä»¥ `mservice-` å¼€å§‹.

`mservice` çš„æ„æ€æ˜¯ `micro-service`. è¿™æ ·ä¾¿äºåŒºåˆ†ä¸åŒçš„æœåŠ¡ç±»å‹, ä¹Ÿæ–¹ä¾¿åˆ†ç»„.

æˆ‘ä»¬ç°åœ¨ä½¿ç”¨ `dubbo` æœåŠ¡æ²»ç†æ¡†æ¶, å¦‚æœä»¥åæœ‰å¯èƒ½è¯, å¯ä»¥å¾ˆæ–¹ä¾¿çš„è¿ç§»åˆ° `SOFA` æˆ–è€… `Spring Cloud` (æˆ‘å°±è¯´è¯´, åº”è¯¥æ˜¯ä¸å¯èƒ½çš„äº‹äº†).

ä¸šåŠ¡å­æ¨¡å—é™¤äº† `business-common` æ¨¡å—, å…¶ä»–å­æ¨¡å—éƒ½ä»¥ Web åº”ç”¨ æˆ–è€… JVM è¿›ç¨‹ç›´æ¥æä¾›æœåŠ¡.

#### business-common

`musicsearch-business` æ¨¡å—çš„å­æ¨¡å—, ä¾èµ–äº `musicsearch-common`.

> ä¸šåŠ¡æ¨¡å—å…±ç”¨çš„ä»£ç  `å¿…é¡»` æ”¾å…¥ `business-common` æ¨¡å—.

æ¯”å¦‚æ‰€æœ‰ä¸šåŠ¡éƒ½ä¼šç”¨åˆ°çš„ redis key å¸¸é‡ç±», åˆ™ `å¿…é¡»` æ”¾åœ¨ `business-common` æ¨¡å—ä¸­;
è€Œ `service-meeting` è¿™ä¸ªæ¨¡å—çš„ä¸šåŠ¡ç”¨åˆ°çš„ redis key å¸¸é‡åˆ™ `å¿…é¡»` æ”¾åˆ° `service-meeting` æ¨¡å—ä¸­.

è®²ç©¶èŒè´£åˆ†ç¦», å±‚çº§åˆ†æ˜, äº’ä¸å¹²æ¶‰; ä½ èµ°ä½ çš„é˜³å…³é“, æˆ‘çœ‹æˆ‘çš„ è¥¿è™¹å¸‚é¦–å¯Œ.

### æ¨¡å—å

> `å¿…é¡»` å…¨éƒ¨ä¸ºå°å†™, å•è¯ä¹‹é—´ `å¿…é¡»` ä½¿ç”¨ `-` åˆ†éš”.

ä¸è¦éšå¿ƒæ‰€æ¬²çš„å‘½å, è¦è®²ç©¶çš„è§„åˆ™, ä¸ç„¶ä¼šèµ°ç«å…¥é­”çš„.

> provider æ¨¡å—å `å¿…é¡»` ä»¥ `mservice-` å¼€å¤´;

provider æ¨¡å—ä¹Ÿæœ‰å¯èƒ½æ˜¯æœåŠ¡æ¶ˆè´¹è€…, è¿™ç±»çš„æ¨¡å—, è¿˜æ˜¯ `åº”è¯¥` ä½¿ç”¨ `mservice-` å¼€å¤´

å¯¹äº provider æ¨¡å—, è‡³å°‘åº”è¯¥åˆ†ä¸º 2 å±‚;

1. æœåŠ¡å -interface , æä¾›ç»™ consumer çš„ä¾èµ–æ¨¡å—
2. æœåŠ¡å -service , ä¸šåŠ¡å¤„ç†æ¨¡å—

> æœåŠ¡å -interface æ¨¡å— `å¿…é¡»` åŒ…å«ç”¨åˆ°çš„å®ä½“ç±», æ¥å£å®šä¹‰, dubbo-consumer- æœåŠ¡å.xml, å…±ç”¨çš„ util ç±», æšä¸¾ç±»ç­‰;

**å¿…é¡»è¦æå‡ºçš„æ˜¯:**

`dubbo-consumer- æœåŠ¡å.xml` é…ç½®æ–‡ä»¶ `åº”è¯¥` ç”± provider æ¥ç»´æŠ¤, è€Œ consumer åªéœ€è¦ import æ­¤é…ç½®æ–‡ä»¶å³å¯, è€Œä¸æ˜¯åœ¨è‡ªå·±çš„ Spring
é…ç½®æ–‡ä»¶æˆ–è€…è‡ªå®šä¹‰ä¸€ä¸ª dubbo é…ç½®æ–‡ä»¶å†æ¥å†™å¼•å…¥çš„æ¥å£.

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ `dubbo-consumer- æœåŠ¡å.xml` `åº”è¯¥` åœ¨ interface æ¨¡å—çš„åŸå› .

è¿™é‡Œçœ‹çœ‹ migu-game é‡æ„ä¹‹å‰çš„ç»“æ„ (æœ‰ä¸€äº›å°æ”¹åŠ¨)

**é…ç½®å…³ç³»:**

![20241229154732_Fx0TE6bY.webp](https://cdn.dong4j.site_Fx0TE6bY.webp)

è¿™é‡Œçš„ dubbo.xml å³ provider é…ç½®, å‰é¢ä¹Ÿè¯´äº†, è¿™æ ·çš„å‘½åæ–¹å¼ä¸å¤Ÿç›´è§‚, å› æ­¤ `åº”è¯¥` é‡‡ç”¨ `dubbo-provider- æœåŠ¡å ` çš„æ–¹å¼å‘½å;

Spring-config.xml æ˜¯ä¸»é…ç½®, å¯¼å…¥äº†å…¶ä»– 5 ä¸ªé…ç½®;

```xml
<import resource="spring/dubbo.xml"/>
<import resource="spring/mybatis.xml"/>
<import resource="spring/dataSource.xml"/>
<import resource="classpath*:applicationContext-jms.xml"/>
<import resource="classpath*:applicationContext-redis.xml"/>
```

`applicationContext-jms.xml` å’Œ `applicationContext-redis.xml` è¿™ 2 ä¸ªé…ç½®åŸæ¥æ˜¯æ”¾åœ¨ web.xml ä¸­çš„.
è¿™é‡Œè¿å…¥åˆ° Spring-config.xml ä¸­, å› ä¸º web.xml åªéœ€è¦è´Ÿè´£åŠ è½½ Spring-config.xml å³å¯, web.xml å†™å¥½ä¹‹å, åŸºæœ¬ä¸éœ€è¦ä¿®æ”¹, æ‰€æœ‰é…ç½®å…³ç³»å…¨éƒ¨åœ¨
Spring-config.xml ä¸­ç®¡ç†.

é‚£ä¹ˆé—®é¢˜æ¥äº†
**dubbo çš„ consumer é…ç½®åœ¨å“ªé‡Œå‘¢?**

æ‰¾äº†åŠå¤©, åŸæ¥åœ¨ funclib æ¨¡å—çš„ `applicationContext-mainflowfunc.xml` é…ç½®ä¸­...

![20241229154732_F89Aye00.webp](https://cdn.dong4j.site_F89Aye00.webp)

é‚£ä¹ˆé—®é¢˜åˆæ¥äº†

å¦‚æœ migu-game ç”±åˆè‚¥çš„åŒäº‹å¼€å‘, éœ€è¦å¢åŠ å‡ ä¸ªæ¥å£, ä½¿ç”¨ migu-game æœåŠ¡çš„æ˜¯æˆéƒ½çš„å°æ˜åŒå­¦, æ­£åœ¨å¼€å‘ funclib, è¿™ä¸ªæ—¶å€™è¯·é—®....

**å°æ˜ä¸­åˆåƒäº†å•¥?**

![20241229154732_YSkFqKZ8.webp](https://cdn.dong4j.site_YSkFqKZ8.webp)

> å¦‚æœ dubbo consumer é…ç½®ç”± funclib ç»´æŠ¤, é‚£ä¹ˆå°±è¦ä¿®æ”¹ funclib æ¨¡å—çš„é…ç½®;
> å¦‚æœ dubbo consumer é…ç½®ç”± migu-game ç»´æŠ¤, åˆè‚¥çš„åŒäº‹åªéœ€è¦æä¾› migu-game-interface, funclib åªéœ€å¼•å…¥ `dubbo-consumer-migugame.xml`;

` æœåŠ¡å -interface` è¿˜åº”è¯¥ä¾èµ– `dubbo` ç›¸å…³ jar ä¾èµ–, è¿™æ · consumer å°±ä¸éœ€è¦è‡ªå·±å¼•å…¥ `dubbo` ç›¸å…³ä¾èµ–äº†;

æœåŠ¡è¡Œä¸šå˜›, è¦åšå°±åšå…¨å¥—

**æœ€ä½³å®è·µ **

ä¸ªäººè®¤ä¸º, ä¸€ä¸ª `mservice` æœ€å¥½åˆ†ä¸º 3 å±‚;

1. interface å±‚;
2. service å±‚;
3. dao å±‚;

interface å·²ç»è¯´è¿‡äº†;
service å±‚, ä½œä¸ºä¸šåŠ¡å±‚, ä¾èµ–äº dao å±‚å’Œ interface å±‚;

å„å±‚çš„ pom ä¸­åªä¾èµ–æ¯å±‚éœ€è¦çš„ jar ä¾èµ–. æ¯”å¦‚ duubo çš„ä¾èµ– `åº”è¯¥` å†™åœ¨ interface å±‚, `mybatis` å’Œæ•°æ®åº“é©±åŠ¨ä¾èµ– `åº”è¯¥` å†™åœ¨ dao å±‚, è€Œ
service å±‚ä¾èµ–ä¸šåŠ¡ç›¸å…³çš„ jar.

è¿™æ ·å°†æ‰€æœ‰ä¾èµ–ä¸‹æ”¾åˆ°ä¸åŒå±‚ä¸­, ä»¥ä¸€ç§æ’ä»¶åŒ–çš„æ–¹å¼æä¾›æœåŠ¡, å¯¼å…¥æŸå±‚ä¾èµ–, è¿å¸¦å¼•å…¥äº†è¿™å±‚éœ€è¦çš„ä¾èµ–. è¿™æ · jar ä¾èµ–å…³ç³»æ˜ç¡®, ä¹Ÿå¾ˆå¥½ç®¡ç†.

`musicsearch-project` çš„æ€æƒ³å°±æ˜¯è¿™æ ·, ä»¥ `åˆ†è€Œæ²»ä¹‹` çš„æ–¹å¼ç®¡ç†ä»£ç å’Œä¾èµ–å…³ç³», ä¹Ÿå°±æ˜¯ä¸ªè§£è€¦çš„æ€æƒ³.
è€Œä¸æ˜¯å°†æ‰€æœ‰ä¾èµ–å…¨éƒ¨æ‰”åˆ° common æˆ–è€… service ä¸­, æ–¹ä¾¿æ˜¯æ–¹ä¾¿, ç»´æŠ¤èµ·æ¥æƒ³æ­»çš„å¿ƒéƒ½æœ‰äº†.

interface æ¨¡å—, å°±æ˜¯ä¸€ä¸ªæä¾›ç»™ consumer çš„è¯´æ˜, å‘Šè¯‰ consumer, æˆ‘è¿™ä¸ª interface æä¾›äº†å“ªäº›åŠŸèƒ½, æ²¡æœ‰å…·ä½“å®ç°.

è€Œ API å…¨ç§° Application Program Interface, å³åº”ç”¨ç¨‹åºæ¥å£, æ˜¯ä¸€ç»„å®šä¹‰, ç¨‹åºåŠåè®®çš„é›†åˆ.
å› æ­¤æˆ‘å°† æœåŠ¡å -api ç”¨äºå‘å¤–æä¾› rest api çš„æ¨¡å—.

ç›¸å…³çš„åŒ…åä¹Ÿæ˜¯å¦‚æ­¤.

### åŒ…å

> æ‰€æœ‰åŒ…å `å¿…é¡»` ä»¥ `com.xxxx.msearch` å¼€å§‹

å…¶ä»–è§„åˆ™:

- ç»„ä»¶æ¨¡å—: `com.xxxx.msearch.component. ç»„ä»¶å `
- å…¬å…±ç±»åº“: `com.xxxx.msearch.common`
- æœåŠ¡æ¨¡å—: `com.xxxx.msearch. æœåŠ¡å `

`æ¨è` å‡ ä¸ªå¸¸ç”¨çš„åŒ…å

- `config` ç”¨æ¥æ”¾é…ç½®ç±»
- `util` å·¥å…·ç±»åŒ…
- `enums` æšä¸¾ç±»åŒ…
- `constant` å¸¸é‡ç±»åŒ… (`æ¨è` å°†å¸¸é‡æŒ‰ç±»åˆ«å®šä¹‰åœ¨ä¸åŒçš„å¸¸é‡ç±»ä¸­)
- `service` service æ¥å£åŒ…
- `service.impl` service æ¥å£å®ç°ç±»åŒ…
- `dao` dao æ¥å£åŒ…
- `interfaces` ç‰¹æŒ‡ provider æä¾›çš„æ¥å£ç±»
- `api` ç‰¹æŒ‡ rest api

### ç±»å

ç±»å `å¿…é¡»` ä½¿ç”¨ UpperCamelCase é£æ ¼ (é¦–å­—æ¯éƒ½å¤§å†™)ï¼Œå¿…é¡»éµä»é©¼å³°å½¢å¼. ä¾‹å¦‚: StringUtils

> æŠ½è±¡ç±»å‘½å `å¿…é¡»` ä½¿ç”¨ Abstract æˆ– Base å¼€å¤´;
> å¼‚å¸¸ç±»å‘½å `å¿…é¡»` ä½¿ç”¨ Exception ç»“å°¾;
> æµ‹è¯•ç±»å‘½å `å¿…é¡»` ä»¥å®ƒè¦æµ‹è¯•çš„ç±»çš„åç§°å¼€å§‹ï¼Œä»¥ Test ç»“å°¾;
> æ¥å£å®ç°ç±» `å¿…é¡»` ä»¥ Impl ç»“å°¾;
> API æ¥å£ç±»å¿…é¡»ä»¥ `Controller` ç»“å°¾;
> ORM æ¥å£å¿…é¡»ä»¥ `Dao` ç»“å°¾;

### æ–¹æ³•å

Dao æ¥å£å `æ¨è` ä½¿ç”¨ä»¥ä¸‹å‘½åæ–¹å¼

æ–°å¢:

- add(Entity entity)
- insert(Entity entity)
- save(Entity entity)

æŸ¥è¯¢:

- get(Long id)
- getByXxx
- findByXxx
- selectByXxx

æ›´æ–°:

- update(Entity entity)
- updateByXxx

åˆ é™¤:

- delete(Long id)
- deleteByXxx

### å±æ€§å

è¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„, æŒ‰ç…§ Java æ¨èå‘½åæ–¹å¼å³å¯.

> å¸¸é‡å‘½å `å¿…é¡»` å…¨éƒ¨å¤§å†™, å•è¯é—´ç”¨ä¸‹åˆ’çº¿åˆ†éš”;

## æ•°æ®åº“è§„èŒƒ

æ¨è 3 ç¯‡æ–‡ç« , è™½ç„¶æ˜¯ mysql çš„, ä½†æ˜¯éƒ½æ˜¯æ•°æ®åº“å•Š

[èµ¶é›† mysql å†›è§„](https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651960775&idx=1&sn=1a9c9f4b94dfe71ad2528fb2c84f5ec7&chksm=bd2d001b8a5a890d302d139ea42e9ffde44407738a618865934e40b8e35486b13cafca2933f6&mpshare=1&scene=1&srcid=1228MzgFw9KLVzaHtjHvpb2p%23rd)
[58 åˆ°å®¶æ•°æ®åº“ 30 æ¡å†›è§„è§£è¯»](https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651959906&idx=1&sn=2cbdc66cfb5b53cf4327a1e0d18d9b4a&chksm=bd2d07be8a5a8ea86dc3c04eced3f411ee5ec207f73d317245e1fefea1628feb037ad71531bc&scene=21#wechat_redirect)
[å†è®®æ•°æ®åº“å†›è§„](https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651959910&idx=1&sn=6b6853b70dbbe6d689a12a4a60b84d8b&chksm=bd2d07ba8a5a8eac6783bac951dba345d865d875538755fe665a5daaf142efe670e2c02b7c71&scene=21#wechat_redirect)

## é…ç½®è§„èŒƒ

ä¸ºäº†è§£å†³å¼€å‘, æµ‹è¯•, ç°ç½‘éƒ¨ç½²æ—¶æ‰‹åŠ¨å¯¹æ¯”é…ç½®, æ‰‹åŠ¨åˆ‡æ¢é…ç½®, å‡å°‘äººå·¥ä»‹å…¥å‡ºé”™çš„å‡ ç‡, èŠ‚çº¦æ—¶é—´ç­‰é—®é¢˜, `musicsearch-project` é‡‡ç”¨å¤šç¯å¢ƒé…ç½®.
ä¸€æ¬¡æ‰“åŒ…, å¯éƒ¨ç½²åˆ°å¤šä¸ªç¯å¢ƒ.

æ„æ€å°±æ˜¯: ä¸€æ¬¡æ‰“åŒ…, åˆ°å¤„è¿è¡Œ.

### é…ç½®åˆ†ç±»

**ä»æ•°æ®æ¥æºå¯åˆ†ä¸º:**

- æ•°æ®åº“
- NoSQL
- æ–‡ä»¶
- ç½‘ç»œ

**ä»åŠ è½½é¡ºåºä¸Šè¯¾åˆ†ä¸º:**

- å¯åŠ¨æ—¶åŠ è½½çš„é…ç½®
  - dataSource è¿æ¥é…ç½®
  - Redis è¿æ¥é…ç½®
  - MQ è¿æ¥é…ç½®
  - æ—¥å¿—é…ç½®
  - ...
- è¿è¡ŒæœŸé—´åŠ¨æ€è·å–
  - å­—å…¸æ•°æ®

å…¶å®æœ€å®¹æ˜“å‡ºé”™çš„ä¸”å½±å“æœ€å¤§çš„å°±æ˜¯è¿è¡ŒæœŸé—´åŠ¨æ€è·å–çš„é…ç½®, å­—å…¸æ•°æ®æ”¹é”™äº†å°±ä¼šå½±å“ç°ç½‘ä¸šåŠ¡, è€Œä¸”ä¸å¥½æ’æŸ¥.
è¿æ¥é…ç½®å¯åŠ¨æ—¶å°±éœ€è¦, å¦‚æœé”™è¯¯å¯èƒ½ä¼šå¯¼è‡´å¯åŠ¨å¤±è´¥, è¿™ç±»é—®é¢˜æ¯”è¾ƒå®¹æ˜“æ’æŸ¥.

### local ç¯å¢ƒ

ä»¥å‰åœ¨å¼€å‘æ—¶, ä½¿ç”¨çš„ dev ç¯å¢ƒ. å¯èƒ½ä¼šå°†æŸå‡ ä¸ªé…ç½®ä¿®æ”¹æˆæœ¬åœ°ç¯å¢ƒæˆ–è€… test ç¯å¢ƒè¿›è¡Œå¼€å‘, å¼€å‘å®Œæˆå, åˆ `éœ€è¦é€ä¸ªæ”¹å›æ¥`;
æ”¹åŠ¨çš„é…ç½®å¤ªå¤š, éƒ¨åˆ†é…ç½® `å¿˜è®°æ”¹å›æ¥` è¿˜æäº¤äº†, æ‚²å‰§äº†;

local ç¯å¢ƒä¸“é—¨è§£å†³ä»¥ä¸Šé—®é¢˜.
æœ€åˆæ˜¯ä¸€ä¸ªç©ºé…ç½®, æˆ‘ä»¬æ‹‰å–ä»£ç åæ ¹æ®è‡ªå·±çš„ç¯å¢ƒä¿®æ”¹ local é…ç½®, ç„¶åä½¿ç”¨ idea `å¿½ç•¥æäº¤` åŠŸèƒ½, å¿½ç•¥æ­¤æ–‡ä»¶.
æ¯ä¸ªå¼€å‘è€…äº’ä¸å½±å“, å¼€å‘æ—¶åªéœ€è¦ä¿®æ”¹ local ç¯å¢ƒå³å¯, `ä¸è¯¥` ç›´æ¥ä¿®æ”¹å…¶ä»–ç¯å¢ƒé…ç½®ï¼Œé¿å…ç¯å¢ƒé—®é¢˜é€ æˆçº¿ä¸Šé—®é¢˜

### dev ç¯å¢ƒ

ç°åœ¨çš„æœåŠ¡å¤ªå¤š, æˆ‘ä»¬å¼€å‘æ—¶ä¸å¯èƒ½æ¯ä¸ªéƒ½å¯åŠ¨èµ·æ¥, è¿™æ—¶æˆ‘ä»¬å¯ä»¥å°†ä¸€äº›å…¬å…±çš„æœåŠ¡éƒ¨ç½²åˆ° dev æœåŠ¡å™¨, è¿™ä¸ªé…ç½®å°±æ˜¯ dev ç¯å¢ƒçš„é…ç½®äº†,
ä¸€æ—¦é…ç½®å¥½, `ä¸è¯¥` è½»æ˜“ä¿®æ”¹.

### test ç¯å¢ƒ

å’Œ dev ç¯å¢ƒå·®ä¸å¤š, åªæ˜¯ä¸€äº›è¿æ¥é…ç½®ä¸ä¸€æ ·, `ä¸è¯¥` è½»æ˜“ä¿®æ”¹.

### prod ç¯å¢ƒ

ç”Ÿäº§ç¯å¢ƒç»å¸¸æ”¹åŠ¨çš„å°±æ˜¯å­—å…¸æ•°æ®, ç°åœ¨çš„å­—æ®µæ•°æ®å¤ªå¤æ‚äº†.

æœ€å¥½çš„æ–¹å¼æ˜¯é€šè¿‡ kv é”®å€¼å¯¹, value åªæ˜¯ç®€å•çš„å­—ç¬¦ä¸²è€Œå·², ä¸è¦æ˜¯ä¸€ä¸ªå¤æ‚çš„ json, è¿™æ ·èƒ½éå¸¸å‹å¥½çš„ç®¡ç†æ‰€æœ‰é…ç½®, ä¿®æ”¹é…ç½®ä¹Ÿä¸å®¹æ˜“å‡ºé”™.

redis æ„å»ºå·¥å…·æˆ‘äº†è§£å½“çš„ä¸€ä¸ªä½œç”¨æ˜¯ä¸ºäº†é˜²æ­¢ä¿®æ”¹å‡ºé”™, åšäº†ä¸€ä¸ªä¿æŠ¤æªæ–½.
å…ˆä¿å­˜åˆ°æ•°æ®åº“ä¸­, æ£€æŸ¥ä¸€ä¸‹, ç¡®ä¿æ²¡å‡ºé”™åä½¿ç”¨æ„å»ºå·¥å…·åŒæ­¥åˆ° redis.

å¦‚æœæ˜¯è¿™ä¸ªåŸå› çš„è¯, æˆ‘æƒ³èƒ½ä¸èƒ½ä½¿ç”¨ä¸€ä¸ªå¼¹å‡ºæ¡†æ˜¾ç¤ºä¿®æ”¹å‰ä¸ä¿®æ”¹åçš„å€¼, ç„¶åäºŒæ¬¡ç¡®è®¤?
ç¡®è®¤åä¿®æ”¹æ•°æ®åº“, åŒæ—¶æ›´æ–° redis.

è·å–åŠ¨æ€æ•°æ®çš„æ–¹å¼:

é¦–å…ˆä» redis ä¸­è·å–, å¦‚æœæ²¡æœ‰åˆ™ä»æ•°æ®åº“ä¸­è·å–, ç„¶åæ›´æ–°åˆ° redis;
å¦‚æœæœ‰åˆ™ç›´æ¥è¿”å›.

åå°ç³»ç»Ÿä¿®æ”¹å­—å…¸æ•°æ®ä¸”äºŒæ¬¡ç¡®è®¤å, æ›´æ–°æ•°æ®åº“å’Œ redis.

è¿™é‡Œæœ‰ä¸€ä¸ªäº‹åŠ¡é—®é¢˜.
æ¯”å¦‚åå°ç³»ç»Ÿä¿®æ”¹å®Œå­—æ®µæ•°æ®å, æ›´æ–°æ•°æ®åº“æˆåŠŸ, ä½†æ˜¯æ›´æ–° redis å¤±è´¥, è¿™ä¸ªæ—¶å€™ redis ä¸­å°±æ˜¯æ—§æ•°æ®.

**è§£å†³æ–¹æ¡ˆ:**

1. åå°ç³»ç»ŸäºŒæ¬¡ç¡®è®¤ä¿®æ”¹;
2. æ›´æ–°æ•°æ®åº“;
3. å°† redis ç›¸åº”çš„ key è®¾ç½®ä¸ºå¤±æ•ˆ;

**åˆ†æ:**

1. ç¬¬ 2 æ­¥å¤±è´¥, ç›´æ¥è¿”å›ä¿®æ”¹å¤±è´¥, ä¸ä¼šå‘ç”Ÿäº‹åŠ¡é—®é¢˜, æ•°æ®ä¹Ÿä¸ä¼šè¢«ä¿®æ”¹;
2. ç¬¬ 2 æ­¥æˆåŠŸ, ç¬¬ 3 æ­¥å¤±è´¥;
   1. æ­¤æ—¶åº”ç”¨æŸ¥è¯¢å­—å…¸æ•°æ®æ—¶, redis ä¸ºæ—§æ•°æ® (å¯ä»¥ä½¿ç”¨é‡è¯•æ¥è§£å†³)
3. ç¬¬ 2 æ­¥æˆåŠŸ, ç¬¬ 3 æ­¥æˆåŠŸ;
   1. æ­¤æ—¶åº”ç”¨æŸ¥è¯¢å­—å…¸æ•°æ®æ—¶, redis æ²¡æœ‰, åˆ™å»æ•°æ®åº“ä¸­æŸ¥è¯¢æœ€æ–°, ç„¶åå†æ›´æ–°åˆ° redis ä¸­.

### Dubbo é…ç½®æ–‡ä»¶

> æ¶ˆè´¹è€…é…ç½®æ–‡ä»¶å `å¿…é¡»` ä»¥ `dubbo-consumer- æœåŠ¡å.xml` å‘½å.
> æœåŠ¡æä¾›è€…é…ç½®æ–‡ä»¶å `å¿…é¡»` ä»¥ `dubbo-provider- æœåŠ¡å.xml` å‘½å.

é…ç½®ååŒºåˆ†æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…, è¿™æ ·èŒè´£æ˜ç¡®, æ–¹ä¾¿æœç´¢æŸ¥çœ‹. æœ€æ“è›‹çš„æ˜¯æœç´¢å‡ºå‡ åä¸ª dubbo.xml é…ç½®, è¿˜å¾—ä¸€ä¸ªä¸ªç‚¹è¿›å…¥çœ‹æ˜¯æ¶ˆè´¹è€…è¿˜æ˜¯ç”Ÿäº§è€…é…ç½®.

> æ¶ˆè´¹è€…é…ç½® `å¿…é¡»` å•ç‹¬å†™åœ¨ `dubbo-consumer- æœåŠ¡å.xml` ä¸­, ä¸è¦å†™åœ¨ Spring é…ç½®ä¸­.

é…ç½®å°½é‡åˆ†å¼€åˆ°ä¸åŒåˆ°é…ç½®æ–‡ä»¶ä¸­, æœ€åä½¿ç”¨ import èšåˆèµ·æ¥. éœ€è¦ä¿®æ”¹é…ç½®æ—¶, èƒ½æ˜ç¡®çŸ¥é“å»å“ªä¸ªé…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹.
ä½ è§ `è‘µèŠ±å®å…¸` é‡Œé¢å†™äº†æ€ä¹ˆè‡ªå®«çš„è¯¦ç»†æ•™ç¨‹å—? æœ€å¤šä¹Ÿå°±å¼•ç”¨ä¸€ä¸‹, `æ¬²ç»ƒæ­¤åŠŸ, å¿…å…ˆè‡ªå®«`.

> å¼•å…¥é…ç½®ä¸è¦å†™åœ¨ web.xml, `å¿…é¡»` ä½¿ç”¨ import åœ¨ Spring ä¸»é…ç½®æ–‡ä»¶ä¸­å¼•å…¥.

`musicsearch-project` ä¸éœ€è¦æ‹…å¿ƒè¿™ä¸ªé—®é¢˜, å› ä¸º web.xml å·²ç»è¢«å¹²æ‰äº† ğŸ¤£

### Spring é…ç½®æ–‡ä»¶

- SpringMVC é…ç½®æ–‡ä»¶ç»Ÿä¸€å‘½å: `spring-mvc.xml`
- Web åº”ç”¨çš„ Spring é…ç½®æ–‡ä»¶ç»Ÿä¸€å‘½å: `spring-context.xml`
- å…¶ä»–ç»„ä»¶çš„ Spring é…ç½®æ–‡ä»¶ç»Ÿä¸€å‘½å: æ¨¡å—å.xml
- Spring Boot åº”ç”¨çš„é…ç½®æ–‡ä»¶ç»Ÿä¸€ä½¿ç”¨ application.properties

`musicsearch-project` ä½¿ç”¨ Spring Boot ä¸ºåŸºç¡€æ¡†æ¶, å› æ­¤ `spring-mvc.xml` å’Œ `spring-context.xml` å·²ç»ä½¿ç”¨ Java Config çš„æ–¹å¼ä»£æ›¿.

**è‡ªåŠ¨é…ç½®ç±» `å¿…é¡»` ä»¥ æœåŠ¡å +Configuration æ–¹å¼å‘½å **
**å¯åŠ¨ç±» `å¿…é¡»` ä»¥ æœåŠ¡å +Application æ–¹å¼å‘½å **
**å•å…ƒæµ‹è¯•ä¸»ç±» `å¿…é¡»` ä»¥ æœåŠ¡å +ApplicationTest æ–¹å¼å‘½å **

## Maven

åŸæ¥çš„é¡¹ç›®æ˜¯ç”±å¤šä¸ªæ¨¡å—ç”±ä¸åŒçš„ Maven ç®¡ç†, é€ æˆç¼–è¯‘, æ‰“åŒ…,debug éº»çƒ¦, ä¾èµ–å…³ç³»å¤æ‚, ç‰ˆæœ¬éšæ„, åŒä¸€ä¸ªæ¨¡å—å¤šä¸ªä¸åŒç‰ˆæœ¬, ç»´æŠ¤å›°éš¾.

ä¸ºäº†è§£å†³ä»¥ä¸Šé—®é¢˜, ç°åœ¨å°†æ‰€æœ‰æ¨¡å—é€šè¿‡ä¸€ä¸ª ä¸» pom è¿›è¡Œç®¡ç†, æ‰€æœ‰æ¨¡å—å…¨éƒ¨åœ¨ `musicsearch-porject` ç›®å½•ä¸‹.

ä¼˜ç‚¹å¦‚ä¸‹:

- debug æ—¶æ–¹ä¾¿, æƒ³åœ¨å“ªå„¿æ‰“æ–­ç‚¹å°±åœ¨å“ªå„¿æ‰“æ–­ç‚¹. éšå¤„ debug;
- èƒ½å€ŸåŠ© IDEA è¿›è¡Œå…¨å±€é‡æ„;
- jar ç‰ˆæœ¬ç»Ÿä¸€ç®¡ç†
- ç»å¯¹ä¸ä¼šå‡ºç°ç›¸åŒ jar å¤šä¸ªç›¸åŒç‰ˆæœ¬çš„é—®é¢˜.

### pom è§„èŒƒ

> groupId `å¿…é¡»` ä¸º `com.xxx`
> artifactId `å¿…é¡»` ä¸ æ¨¡å—åç›¸åŒ
> version `å¿…é¡»` ä¸ çˆ¶ pom version ç›¸åŒ
> `å¿…é¡»` æ˜¾å¼æŒ‡å®š `packaging`

å¦‚æœæ²¡æœ‰è®¾ç½® packaging æ ‡ç­¾, é»˜è®¤æ‰“åŒ…ä¸º jar æ ¼å¼, è¿™é‡Œ `å¿…é¡»` è®¾ç½®æ­¤æ ‡ç­¾, æ˜ç¡®æŒ‡å®šæ‰“åŒ…æ ¼å¼.

> `å¿…é¡»` å†™ `description` æ ‡ç­¾

ä¸ºæ­¤ pom æ·»åŠ å¿…è¦çš„æè¿°ä¿¡æ¯

> ç¬¬ä¸‰æ–¹ä¾èµ– `å¿…é¡»` æ·»åŠ åˆ° `musicsearch-dependencies` pom ä¸­;
> å¦‚æœ Maven ä¸­å¤®ä»“åº“æ²¡æœ‰çš„ jar åŒ…, ä»ç½‘ä¸Šä¸‹è½½å, `å¿…é¡»` ä¸Šä¼ åˆ°å…¬å¸çš„ Maven, ä¸èƒ½ç›´æ¥ä½¿ç”¨ jar åŒ…

1. æœç´¢ Maven ä¸­å¤®ä»“åº“, å…³é”®å­— + maven;
2. æœç´¢ä¸åˆ°åˆ™æ‰¾åˆ° jar ä¸Šä¼ åˆ°å…¬å¸ Maven ä»“åº“

   ```
   # å®‰è£…åˆ°ç§æœ
   # DgroupId å’Œ DartifactId æ„æˆäº†è¯¥ jar åŒ…åœ¨ pom.xml çš„åæ ‡ï¼Œé¡¹ç›®å°±æ˜¯ä¾é è¿™ä¸¤ä¸ªå±æ€§å®šä½ã€‚è‡ªå·±èµ·åå­—ä¹Ÿè¡Œã€‚
   # Dfile è¡¨ç¤ºéœ€è¦ä¸Šä¼ çš„ jar åŒ…çš„ç»å¯¹è·¯å¾„ã€‚
   # Durl ç§æœä¸Šä»“åº“çš„ä½ç½®ï¼Œæ‰“å¼€ nexusâ€”â€”>repositories èœå•ï¼Œå¯ä»¥çœ‹åˆ°è¯¥è·¯å¾„ã€‚
   # DrepositoryId æœåŠ¡å™¨çš„è¡¨ç¤º idï¼Œåœ¨ nexus çš„ configuration å¯ä»¥çœ‹åˆ°ã€‚ è¦ä¸ setting.xml ä¸­çš„æƒé™ id ä¸€è‡´
   # Dversion è¡¨ç¤ºç‰ˆæœ¬ä¿¡æ¯
   mvn deploy:deploy-file -DgroupId=com.xxx -DartifactId=yyy -Dversion=x.x.x -Dpackaging=jar -Dfile=jar-path -Durl= ä¸Šä¼ åœ°å€ -DrepositoryId=thirdparty
   ```

> ç¬¬ä¸‰æ–¹ä¾èµ– `å¿…é¡»` å°†ç‰ˆæœ¬è¿å…¥ `musicsearch-dependencies` åˆ° properties æ ‡ç­¾ä¸‹;
> version `å¿…é¡»` ä»¥ `artifactId.version` çš„æ–¹å¼å‘½å;

```xml
<properties>
    ...
    <socket.io-client.version>1.0.0</socket.io-client.version>
</properties>
<dependencyManagement>
    <dependencies>
        ...
        <dependency>
            <groupId>io.socket</groupId>
            <artifactId>socket.io-client</artifactId>
            <version>${socket.io-client.version}</version>
        </dependency>
    </dependencies>
</dependencyManagement>
```

ç”±äº `musicsearch-project` ä½¿ç”¨ Spring Boot å¼€å‘, ç‰ˆæœ¬ä¸º 1.5.8.RELEASE.
Spring Boot æ¯ä¸ªç‰ˆæœ¬éƒ½æœ‰ä¸€ä¸ª `spring-boot-dependencies` é¡¹ç›®ç”¨æ¥ç»´æŠ¤æ‰€æœ‰ç¬¬ä¸‰æ–¹ jar ç‰ˆæœ¬å’Œ Maven æ’ä»¶ç‰ˆæœ¬.

![20241229154732_HijijtDI.webp](https://cdn.dong4j.site_HijijtDI.webp)

æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ `spring-boot-dependencies` ä¸­ç›¸å…³ä¾èµ–çš„ç‰ˆæœ¬, èƒ½æœ‰æ•ˆå‡å°‘ç‰ˆæœ¬å†²çª.

> å¦‚æœæˆ‘ä»¬æ–°å¢çš„ç¬¬ä¸‰æ–¹åŒ…å·²ç»åœ¨ `spring-boot-dependencies` å£°æ˜, åˆ™ `å¿…é¡»` ä½¿ç”¨ `spring-boot-dependencies` è§„å®šçš„ç‰ˆæœ¬, å³åˆ é™¤ version æ ‡ç­¾.

æ€ä¹ˆæŸ¥çœ‹æ–°å¼•å…¥çš„ä¾èµ–æ˜¯å¦åœ¨ `spring-boot-dependencies` è¢«å£°æ˜äº†å‘¢, å¾ˆç®€å•

æ¯”å¦‚æˆ‘éœ€è¦æ·»åŠ å¦‚ä¸‹ä¾èµ–åˆ°æ¨¡å—ä¸­

```xml
<dependency>
    <groupId>org.projectlombok</groupId>
    <artifactId>lombok</artifactId>
    <version>1.16.14</version>
</dependency>
```

æ•´ä¸ªæ“ä½œå¦‚ä¸‹å›¾æ‰€ç¤º:

![2222.gif](https://cdn.dong4j.site

æˆ‘ä»¬æ–°å¢çš„ lombok ç‰ˆæœ¬ä¸º 1.16.14
ä½†æ˜¯å½“åŠ å…¥ pom ä¹‹å, å·¦è¾¹å‡ºç°äº†ä¸€ä¸ªå‘ä¸Šçš„ç®­å¤´, ç‚¹è¿‡å»ä¹‹å, å‘ç°æ­¤ä¾èµ–å·²ç»åœ¨ `spring-boot-dependencies` è¢«å£°æ˜äº†, å¹¶ä¸”ç‰ˆæœ¬ä¸º 1.16.18, å› æ­¤åˆ é™¤
version å°±å¯ä»¥äº†.

**æ·»åŠ æ–°ä¾èµ–çš„æ­¥éª¤:**

1. é€‰æ‹©åˆé€‚çš„æ¨¡å—, ç›´æ¥ç²˜è´´ maven ä¾èµ–é…ç½®åˆ° pom ä¸­,
2. å¦‚æœå·¦è¾¹å‡ºç°äº†å‘ä¸Šçš„ç®­å¤´, åˆ™åˆ é™¤ version æ ‡ç­¾, æå®š;
3. å¦‚æœæ²¡æœ‰, åˆ™å°†æ­¤ä¾èµ–é…ç½®ç²˜è´´åˆ° `musicsearch-dependencies` ä¸­, å°† version æ·»åŠ åˆ° properties æ ‡ç­¾ä¸­;
4. æœ€ååˆ é™¤æœ€å¼€å§‹é‚£ä¸ªé…ç½®çš„ version;

`spring-boot-dependencies` ä¸å¯èƒ½å®šä¹‰åˆ°æ‰€æœ‰çš„ä¾èµ–, å› æ­¤è¿™é‡Œå°±æœ‰äº† `musicsearch-dependencies` è¿™ä¸ªæ¨¡å—,
ç”¨æ¥ç®¡ç†é¡¹ç›®éœ€è¦ä½†æ˜¯æ²¡æœ‰åœ¨ `spring-boot-dependencies` ä¸­å®šä¹‰çš„ jar ä¾èµ–.

## æ—¥å¿—è§„èŒƒ

> `æ¨è` ä½¿ç”¨ `@Slf4j` è·å– `log` å®ä¾‹

ä½¿ç”¨ `lombok` æ’ä»¶, ç›´æ¥ä½¿ç”¨ @Slf4j ä»£æ›¿è·å– log å®ä¾‹çš„å†—ä½™ä»£ç .

```java
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

...
private static final Logger log = LoggerFactory.getLogger(Xxx.class);
```

> `å¿…é¡»` ä½¿ç”¨ `log4j2` æ—¥å¿—æ¡†æ¶

ç»Ÿä¸€ä½¿ç”¨æ•ˆç‡æ›´é«˜çš„ log4j2 æ—¥å¿—æ¡†æ¶

> æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶çš„ç¼–ç  `å¿…é¡»` ä¸º UTF-8

### æ—¥å¿—é…ç½®å

> Web åº”ç”¨æˆ–è€…é€šè¿‡ JVM è¿›ç¨‹æä¾›æœåŠ¡çš„åº”ç”¨, `å¿…é¡»` ä½¿ç”¨ `log4j2-spring.xml` å‘½å

Spring Boot å®˜æ–¹æ¨èä¼˜å…ˆä½¿ç”¨å¸¦æœ‰ -spring çš„æ–‡ä»¶åä½œä¸ºæ—¥å¿—é…ç½®ï¼ˆå¦‚ä½¿ç”¨ log4j2-spring.xmlï¼Œè€Œä¸æ˜¯ log4j2.xmlï¼‰

åŸç†å¯ä»¥æŸ¥çœ‹
`Log4J2LoggingSystem.getCurrentlySupportedConfigLocations()`
`AbstractLoggingSystem.getSpringConfigLocations()`

### è¾“å‡ºæ ·å¼

```
env: %d{yyyy.MM.dd HH:mm:ss.SSS} [%5p] ${sys:PID} -- [%15.15t] %-40.40c{1.} : %m%n%xwEx
```

è¾“å‡ºå†…å®¹å…ƒç´ å…·ä½“å¦‚ä¸‹ï¼š

- ç¯å¢ƒå
- æ—¶é—´æ—¥æœŸ â€” ç²¾ç¡®åˆ°æ¯«ç§’
- æ—¥å¿—çº§åˆ« â€” ERROR, WARN, INFO, DEBUG or TRACE
- è¿›ç¨‹ ID
- åˆ†éš”ç¬¦ â€”`--`æ ‡è¯†å®é™…æ—¥å¿—çš„å¼€å§‹
- çº¿ç¨‹å â€” æ–¹æ‹¬å·æ‹¬èµ·æ¥ï¼ˆå¯èƒ½ä¼šæˆªæ–­æ§åˆ¶å°è¾“å‡ºï¼‰
- Logger å â€” é€šå¸¸ä½¿ç”¨æºä»£ç çš„ç±»å
- æ—¥å¿—å†…å®¹

æ•ˆæœ :

```
dev: 2018.08.01 15:02:25.153  INFO 75012 -- [restartedMain] c.i.m.m.MeetingApplication : Starting MeetingApplication on dong4j with PID 75012 (/Users/codeai/Develop/work/ifly/musicsearch-project/musicsearch-business/service-meeting/target/classes started by codeai in /Users/codeai/Develop/work/ifly/musicsearch-project)
dev: 2018.08.01 15:02:25.154 DEBUG 75012 -- [restartedMain] c.i.m.m.MeetingApplication : Running with Spring Boot v1.5.8.RELEASE, Spring v4.3.12.RELEASE
dev: 2018.08.01 15:02:25.155  INFO 75012 -- [restartedMain] c.i.m.m.MeetingApplication : The following profiles are active: oracle
```

### æ—¥å¿—ä¿å­˜è·¯å¾„

æ—¥å¿—è·¯å¾„ç»Ÿä¸€ç®¡ç†, ç¡®ä¿æ¯å°æœåŠ¡å™¨ä¸Šçš„æ—¥å¿—éƒ½åœ¨åŒä¸€ç›®å½•ä¸‹

```
<property name="LOG_BASE_FOLDER">/path/to/logs/${APP_NAME}</property>
```

`/path/to/logs/` å†è®®, åªè¦æ˜¯ä¸€ä¸ªæœ‰è¯»å†™æƒé™çš„ç›®å½•ä¸”å¥½è®°å°±å¯ä»¥äº†, å…³é”®æ˜¯ä¿æŒç»Ÿä¸€.

> æœ€å `å¿…é¡»` é€šè¿‡ APP_NAME å‚æ•°åŒºåˆ†åº”ç”¨.

### æ—¥å¿—å½’æ¡£

> æ—¥å¿—æ–‡ä»¶ `å¿…é¡»` 1 å¤©å½’æ¡£ä¸€æ¬¡ï¼Œå‹ç¼©æ–‡ä»¶ä¸Šé™ `å»ºè®®` ä¸º 200MB

æ¯å¤©å½’æ¡£æ—¥å¿—, æ–¹ä¾¿æŒ‰æ—¥å¿—æŸ¥è¯¢æ—¥å¿—

## å•å…ƒæµ‹è¯•è§„èŒƒ

> æ‰€æœ‰æ¨¡å—éƒ½ `å¿…é¡»` æœ‰å•å…ƒæµ‹è¯•, è€Œä¸æ˜¯ä½¿ç”¨ `main()` æ¥è¿›è¡Œæµ‹è¯•;

IDEA æ·»åŠ å•å…ƒæµ‹è¯•ç±»éå¸¸ç®€å•

![3333.gif](https://cdn.dong4j.site

ç›´æ¥é€šè¿‡å¿«æ·é”®è‡ªåŠ¨ç”Ÿæˆå•å…ƒæµ‹è¯•ç±».

> é›†æˆæµ‹è¯•æ—¶, `å¿…é¡»` ç»§æ‰¿ä¸»æµ‹è¯•ç±»;

åœ¨æ¯ä¸ª Web æ¨¡å—ä¸­, éƒ½ä¼šæœ‰ä¸€ä¸ª XxxApplicationTest æµ‹è¯•çˆ¶ç±», ç”¨äºæ•´åˆé…ç½®ç±», æµ‹è¯•ç«¯å£éšæœºç­‰åŠŸèƒ½.

![20241229154732_JacCQkxj.webp](https://cdn.dong4j.site_JacCQkxj.webp)

å…¶ä»–é›†æˆæµ‹è¯•ç±»åªéœ€è¦ç»§æ‰¿æ­¤çˆ¶ç±»å³å¯, ä¸éœ€è¦å†™é‡å¤çš„æ³¨è§£

![20241229154732_8Sa4oiU5.webp](https://cdn.dong4j.site_8Sa4oiU5.webp)
é»˜è®¤æ˜¯å•å…ƒæµ‹è¯• `å¿…é¡»` å…¨éƒ¨é€šè¿‡æ‰èƒ½æ‰“åŒ…, å½“å¾€å¾€ç”±äºå•å…ƒæµ‹è¯•ç¼–å†™ä¸è§„èŒƒé€ æˆæ‰“åŒ…å¤±è´¥, ç¼–å†™å¥½çš„å•å…ƒæµ‹è¯•éš¾åº¦ä¹Ÿéå¸¸å¤§, å› æ­¤è¿™é‡Œä¸å¼ºåˆ¶è¦æ±‚.

ä½¿ç”¨ 3 ç§æ–¹å¼å¿½ç•¥å•å…ƒæµ‹è¯•

**æ–¹å¼ 1:**

`æ¨è` è¿™ç§

ä½¿ç”¨å˜é‡

```xml
<properties>
    <maven.test.skip>true</maven.test.skip>
</properties>
```

æˆ–è€…

```xml
<properties>
    <skipTests>true</skipTests>
</properties>
```

**æ–¹å¼ 2:**

ä½¿ç”¨ mvn å‘½ä»¤

```lua
mvn package -Dmaven.test.skip=true
```

**æ–¹å¼ 3:**

ä½¿ç”¨æ’ä»¶

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-surefire-plugin</artifactId>
    <version>${maven-surefire-plugin.version}</version>
    <configuration>
        <skipTests>true</skipTests>
    </configuration>
</plugin>
```

æ–¹å¼ 1 ä¸æ–¹å¼ 2 çš„åŒºåˆ«åœ¨äº:

`skipTests` ä¸æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ï¼Œä½†ç¼–è¯‘æµ‹è¯•ç”¨ä¾‹ç±»ç”Ÿæˆç›¸åº”çš„ class æ–‡ä»¶è‡³ target/test-classes ä¸‹
`maven.test.skip` ä¸ä½†è·³è¿‡å•å…ƒæµ‹è¯•çš„è¿è¡Œï¼Œä¹Ÿè·³è¿‡æµ‹è¯•ä»£ç çš„ç¼–è¯‘

## [Redis Sentinel æ­å»ºæŒ‡å—ï¼šä»å…¥é—¨åˆ°ç²¾é€š](https://blog.dong4j.site/posts/70b9e46a.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

è®°å½• Redis Sentinel çš„æ­å»ºè¿‡ç¨‹

## ç°æœ‰æ¶æ„çš„é—®é¢˜

1. master æŒ‚æ‰ä¹‹å, éœ€è¦æ‰‹åŠ¨åˆ‡æ¢, è¿ç»´å¤æ‚

## Redis Sentinel é«˜å¯ç”¨

![20241229154732_8Zk7xKho.webp](https://cdn.dong4j.site/source/image/20241229154732_8Zk7xKho.webp)

ä¸‹é¢ä»¥ 1 ä¸ªä¸»èŠ‚ç‚¹ã€2 ä¸ªä»èŠ‚ç‚¹ã€3 ä¸ª Sentinel èŠ‚ç‚¹ç»„æˆçš„ Redis Sentinel ä¸ºä¾‹å­

æ•…éšœè½¬ç§»å¤„ç†é€»è¾‘:

1. ä¸»èŠ‚ç‚¹å‡ºç°æ•…éšœ, æ­¤æ—¶ä¸¤ä¸ªä»èŠ‚ç‚¹ä¸ä¸»èŠ‚ç‚¹æ—¶åŒºè¿æ¥, ä¸»ä»å¤åˆ¶å¤±è´¥;

   ![20241229154732_HwvXcbfZ.webp](https://cdn.dong4j.site/source/image/20241229154732_HwvXcbfZ.webp)

2. æ¯ä¸ª Sentinel èŠ‚ç‚¹é€šè¿‡å®šæœŸç›‘æ§å‘ç°ä¸»èŠ‚ç‚¹å‡ºç°æ•…éšœ;

   ![20241229154732_aQBkbupn.webp](https://cdn.dong4j.site/source/image/20241229154732_aQBkbupn.webp)

3. å¤šä¸ª Sentinel èŠ‚ç‚¹å¯¹ä¸»èŠ‚ç‚¹çš„æ•…éšœè¾¾æˆä¸€è‡´, é€‰ä¸¾å‡º sentinel-3 èŠ‚ç‚¹ä½œä¸ºé¢†å¯¼è€…è´Ÿè´£æ•…éšœè½¬ç§»;

   ![20241229154732_s7YZQex5.webp](https://cdn.dong4j.site/source/image/20241229154732_s7YZQex5.webp)

   1. åŸæ¥çš„ä»èŠ‚ç‚¹ slave-1 ç§°ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹å, æ›´æ–°åº”ç”¨æ–¹çš„ä¸»èŠ‚ç‚¹ä¿¡æ¯, é‡æ–°å¯åŠ¨åº”ç”¨æ–¹;
   2. å®¢æˆ·ç«¯å‘½ä»¤å¦ä¸€ä¸ªä»èŠ‚ç‚¹ slave-2 å»å¤åˆ¶æ€§çš„ä¸»èŠ‚ç‚¹;
   3. å¾…åŸæ¥çš„ä¸»èŠ‚ç‚¹æ¢å¤å, è®©å®ƒå»å¤åˆ¶æ–°çš„ä¸»èŠ‚ç‚¹;

   ![20241229154732_FUe3W94T.webp](https://cdn.dong4j.site/source/image/20241229154732_FUe3W94T.webp)

4. æ•…éšœè½¬ç§»åçš„ç»“æ„å›¾

   ![20241229154732_znOFqeq4.webp](https://cdn.dong4j.site/source/image/20241229154732_znOFqeq4.webp)

   ## Redis Sentinel åŠŸèƒ½

   1. **ç›‘æ§:** Sentinel èŠ‚ç‚¹ä¼šå®šæœŸæ£€æµ‹ Redis æ•°æ®èŠ‚ç‚¹å’Œå…¶ä½™ Sentinel èŠ‚ç‚¹æ˜¯å¦å¯è¾¾;
   2. **é€šçŸ¥:** Sentinel èŠ‚ç‚¹ä¼šå°†æ•…éšœè½¬ç§»çš„ç»“æœé€šçŸ¥ç»™åº”ç”¨æ–¹;
   3. **ä¸»èŠ‚ç‚¹æ•…éšœè½¬ç§»:** å®ç°ä»èŠ‚ç‚¹æ™‹å‡ä¸ºä¸»èŠ‚ç‚¹å¹¶ç»´æŠ¤åç»­æ­£ç¡®çš„ä¸»ä»å…³ç³»;
   4. **é…ç½®æä¾›è€…:** å®¢æˆ·ç«¯åœ¨åˆå§‹åŒ–æ—¶, è¿æ¥ Sentinel èŠ‚ç‚¹é›†ç¾¤, ä»ä¸­è·å–ä¸»èŠ‚ç‚¹ä¿¡æ¯;

## Redis Sentinel å®‰è£…ä¸éƒ¨ç½²

ä¸‹é¢å°†ä»¥ 3 ä¸ª Sentinel èŠ‚ç‚¹ã€1 ä¸ªä¸»èŠ‚ç‚¹ã€2 ä¸ªä»èŠ‚ç‚¹ç»„æˆä¸€ä¸ª Redis Sentinel è¿›è¡Œè¯´æ˜

![20241229154732_2SRjp4lI.webp](https://cdn.dong4j.site/source/image/20241229154732_2SRjp4lI.webp)

å…·ä½“çš„ç‰©ç†éƒ¨ç½²:

| è§’è‰²       | ip        | port  | åˆ«å       |
| :--------- | :-------- | :---- | :--------- |
| master     | 127.0.0.1 | 6379  | ä¸»èŠ‚ç‚¹     |
| slave-1    | 127.0.0.1 | 6380  | slave-1    |
| slave-2    | 127.0.0.1 | 6381  | slave-2    |
| sentinel-1 | 127.0.0.1 | 26379 | sentinel-1 |
| sentinel-2 | 127.0.0.1 | 26380 | sentinel-2 |
| sentinel-3 | 127.0.0.1 | 26381 | sentinel-3 |

**1. master é…ç½®**

```
daemonize yes
dbfilename "6379.db"
dir "/Users/codeai/Develop/logs/redis/db/"
logfile "/Users/codeai/Develop/logs/redis/log/6379.log"
port 6379
requirepass 1234
```

**2. slave-1 é…ç½®**

```
daemonize yes
dbfilename "6380.db"
dir "/Users/codeai/Develop/logs/redis/db/"
logfile "/Users/codeai/Develop/logs/redis/log/6380.log"
port 6380
slaveof 127.0.0.1 6379
# è®¾ç½® master éªŒè¯å¯†ç 
masterauth 1234
# è®¾ç½® slave å¯†ç 
requirepass 1234
```

**3. slave-2 é…ç½®**

```
daemonize yes
dbfilename "6381.db"
dir "/Users/codeai/Develop/logs/redis/db/"
logfile "/Users/codeai/Develop/logs/redis/log/6381.log"
port 6381
slaveof 127.0.0.1 6379
# è®¾ç½® master éªŒè¯å¯†ç 
masterauth 1234
# è®¾ç½® slave å¯†ç 
requirepass 1234
```

**4. å¯åŠ¨ redis æœåŠ¡**

```
redis-server redis-6379.conf; redis-server redis-6380.conf; redis-server redis-6381.conf
```

![20241229154732_gq307pmS.webp](https://cdn.dong4j.site/source/image/20241229154732_gq307pmS.webp)

**5. ç¡®è®¤ä¸»ä»å…³ç³»**

ä¸»èŠ‚ç‚¹è§†è§’

```
redis-cli -h 127.0.0.1 -p 6379 info replication
# Replication
# ä¸»èŠ‚ç‚¹
role:master
# æœ‰ 2 ä¸ª ä»èŠ‚ç‚¹
connected_slaves:2
# ä»èŠ‚ç‚¹ 1 ä¿¡æ¯
slave0:ip=127.0.0.1,port=6380,state=online,offset=112,lag=0
# ä»èŠ‚ç‚¹ 2 ä¿¡æ¯
slave1:ip=127.0.0.1,port=6381,state=online,offset=112,lag=0
master_replid:8f43dc48cca779f46fa1516a38e24fb8c5423d94
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:112
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:112
```

ä»èŠ‚ç‚¹è§†è§’

```
redis-cli -h 127.0.0.1 -p 6380 info replication
# Replication
# ä»èŠ‚ç‚¹
role:slave
# ä¸»èŠ‚ç‚¹ä¿¡æ¯
master_host:127.0.0.1
master_port:6379
master_link_status:up
master_last_io_seconds_ago:2
master_sync_in_progress:0
slave_repl_offset:238
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:8f43dc48cca779f46fa1516a38e24fb8c5423d94
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:238
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:238
```

**6. éƒ¨ç½² Sentinel èŠ‚ç‚¹**

```
port 26379
daemonize yes
logfile "/Users/codeai/Develop/logs/redis/log/26379.log"
dir "/Users/codeai/Develop/logs/redis/db/"
# ç›‘æ§ 127.0.0.1:6379 ä¸»èŠ‚ç‚¹; 2 è¡¨ç¤ºåˆ¤æ–­ä¸»èŠ‚ç‚¹å¤±è´¥è‡³å°‘éœ€è¦ 2 ä¸ª sentinel èŠ‚ç‚¹åŒæ„
sentinel monitor mymaster 127.0.0.1 6379 2
# è®¾ç½®ç›‘å¬çš„ master å¯†ç 
sentinel auth-pass mymaster 1234
# 30 ç§’å†… ping å¤±è´¥, sentinel åˆ™è®¤ä¸º master ä¸å¯ç”¨
sentinel down-after-milliseconds mymaster 30000
# åœ¨å‘ç”Ÿ failover ä¸»å¤‡åˆ‡æ¢æ—¶ï¼Œè¿™ä¸ªé€‰é¡¹æŒ‡å®šäº†æœ€å¤šå¯ä»¥æœ‰å¤šå°‘ä¸ª slave åŒæ—¶å¯¹æ–°çš„ master è¿›è¡ŒåŒæ­¥
sentinel parallel-syncs mymaster 1
# å¦‚æœåœ¨è¯¥æ—¶é—´ï¼ˆmsï¼‰å†…æœªèƒ½å®Œæˆ failover æ“ä½œï¼Œåˆ™è®¤ä¸ºè¯¥ failover å¤±è´¥
sentinel failover-timeout mymaster 180000
```

å…¶ä»–èŠ‚ç‚¹åªæ˜¯ç«¯å£ä¸åŒ

**7. å¯åŠ¨ sentinel èŠ‚ç‚¹**

```
# æ–¹å¼ä¸€
redis-sentinel redis-sentinel-26379.conf; redis-sentinel redis-sentinel-26380.conf; redis-sentinel redis-sentinel-26381.conf
# æ–¹å¼äºŒ
redis-server redis-sentinel-26379.conf --sentinel; redis-server redis-sentinel-26380.conf --sentinel; redis-server redis-sentinel-26381.conf --sentinel;
```

![20241229154732_5ay2F1RC.webp](https://cdn.dong4j.site/source/image/20241229154732_5ay2F1RC.webp)

**8. ç¡®è®¤å…³ç³»**

```
redis-cli -h 127.0.0.1 -p 26379 info sentinel
# Sentinel
sentinel_masters:1
sentinel_tilt:0
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
sentinel_simulate_failure_flags:0
master0:name=mymaster,status=ok,address=127.0.0.1:6379,slaves=2,sentinels=3
```

## é€šè¿‡ Jedis æ“ä½œ Redis

[https://github.com/dong4j/redis-toolkit](https://github.com/dong4j/redis-toolkit)

åŒ…å« redis é…ç½®æ–‡ä»¶, æ­å»ºæ–¹å¼ä¸å•å…ƒæµ‹è¯•

### Jedis æ“ä½œ Redis çš„ ä¸‰ç§æ–¹å¼

#### å•æœºæ¨¡å¼

ç›´æ¥é€šè¿‡ JedisPool æ“ä½œ Redis

```java
Jedis jedis = null;
try {
    // ä»è¿æ¥æ± è·å–ä¸€ä¸ª Jedis å®ä¾‹
    jedis = jedisPool.getResource();
    jedis.set(key, value);
    log.info(jedis.get(key));
} catch (Exception e) {
    log.error("set error", e);
} finally {
    if (null != jedis) {
        // é‡Šæ”¾èµ„æºè¿˜ç»™è¿æ¥æ± 
        jedis.close();
    }
}
```

```java
try(Jedis jedis = jedisPool.getResource()) {
    jedis.set(key, value);
    log.info(jedis.get(key));
} catch (Exception e) {
    log.error("set error", e);
}
```

#### åˆ†ç‰‡æ¨¡å¼ï¼ˆShardedJedisï¼‰

ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•, å°† key å­˜å‚¨åœ¨å¯¹åº”å®ä¾‹ä¸­

```java
try(ShardedJedis jedis = shardedJedisPool.getResource();) {
    jedis.set(key, value);
    log.info(jedis.get(key));
} catch (Exception e) {
    log.error("set error", e);
}
```

#### é›†ç¾¤æ¨¡å¼ï¼ˆBinaryJedisClusterï¼‰

éœ€è¦ Redis 3.0 ä»¥ä¸Šæ‰è‡ªå¸¦é›†ç¾¤åŠŸèƒ½

### é›†æˆ Jedis çš„ä¸¤ç§æ–¹å¼

1. ä½¿ç”¨ spring-data-redis é›†æˆ redis, ä½¿ç”¨ RedisTemplate æˆ–è€… JedisConnectionFactory è·å– jedis æ“ä½œ Redis
2. ç›´æ¥ä½¿ç”¨ JedisPool , ShardedJedisPool, ShardedJedisPool, ShardedJedisSentinelPool è·å– jedis æ“ä½œ Redis

#### spring-data-redis

#### åŸç”Ÿ jedis

##### JedisPool

##### ShardedJedisPool

#### é«˜å¯ç”¨çš„ Redis

##### JedisSentinelPool

##### ShardedJedisSentinelPool

ä»£ç è¯¦è§: [https://github.com/dong4j/redis-toolkit](https://github.com/dong4j/redis-toolkit)

### é—®é¢˜

```
 All sentinels down, cannot determine where is mymaster master is running...
```

sentinel å®‰å…¨æ¨¡å¼é»˜è®¤æ˜¯æ‰“å¼€çš„, åˆå› ä¸ºæ²¡æœ‰ç»‘å®šå¯ä»¥è®¿é—®çš„ ip å’Œè®¾ç½®è®¿é—®å¯†ç ï¼Œå°±ä¸å…è®¸ä»å¤–éƒ¨è®¿é—®;
redis å†…éƒ¨æŠŠ 127 çš„åœ°å€è½¬æ¢æˆäº† 192.168.2.101 äº†ï¼Œä¹Ÿå°±æ˜¯ä½ çš„æœ¬æœºçš„ ip åœ°å€ã€‚æ‰€ä»¥è®¿é—® 192 çš„åœ°å€å°±ç›¸å½“äºä»å¤–éƒ¨è®¿é—®å“¨å…µ;

```
Cannot get master address from sentinel running @ 192.168.2.101:26379.
Reason: redis.clients.jedis.exceptions.JedisDataException: DENIED Redis is running in protected mode because protected mode is enabled, no bind address was specified, no authentication password is requested to clients. In this mode connections are only accepted from the loopback interface. If you want to connect from external computers to Redis you may adopt one of the following solutions:
1) Just disable protected mode sending the command 'CONFIG SET protected-mode no' from the loopback interface by connecting to Redis from the same host the server is running, however MAKE SURE Redis is not publicly accessible from internet if you do so. Use CONFIG REWRITE to make this change permanent.
2) Alternatively you can just disable the protected mode by editing the Redis configuration file, and setting the protected mode option to 'no', and then restarting the server.
3) If you started the server manually just for testing, restart it with the '--protected-mode no' option.
4) Setup a bind address or an authentication password. NOTE: You only need to do one of the above things in order for the server to start accepting connections from the outside.. Trying next one
```

## [Shiro å¼•å…¥å Springboot é¡¹ç›®çš„å¾ªç¯ä¾èµ–è§£å†³æ–¹æ¡ˆ](https://blog.dong4j.site/posts/62ae7a01.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

æœ€è¿‘åœ¨ä½¿ç”¨ Spingboot åšé¡¹ç›®çš„æ—¶å€™ï¼Œåœ¨å¼•å…¥ shiro åï¼Œå¯åŠ¨é¡¹ç›®ä¸€ç›´æŠ¥é”™

```lua
Error creating bean with name 'debtServiceImpl': Bean with name 'debtServiceImpl' has been injected into other beans [repayBillServiceImpl,investServiceImpl,receiveBillServiceImpl] in its raw version as part of a circular reference, but has eventually been wrapped. This means that said other beans do not use the final version of the bean. This is often the result of over-eager type matching - consider using 'getBeanNamesOfType' with the 'allowEagerInit' flag turned off, for example.
```

åæ¥åœ¨ç½‘ä¸Šæ‰¾äº†åŠå¤©è¯´æ˜¯ä¾èµ–å¾ªç¯ï¼Œæ£€æŸ¥äº†ä¸€ä¸‹ä»£ç ï¼Œç¡®å®å­˜åœ¨å¾ªç¯ä¾èµ–çš„ç°è±¡ï¼Œä½†æ˜¯é¡¹ç›®å¿«è¦ä¸Šçº¿ï¼Œå†å»æ”¹ä»£ç é€»è¾‘æ˜¯æ¥ä¸åŠäº†ï¼Œäºæ˜¯å„ç§æ‰¾è§£å†³æ–¹æ¡ˆï¼Œç»ˆäºç®—æ˜¯æ‰¾åˆ°äº†ã€‚

é¦–å…ˆè¯´ä¸€ä¸‹ä»€ä¹ˆæ˜¯ä¾èµ–å¾ªç¯ï¼Œæ¯”å¦‚ï¼šæˆ‘ç°åœ¨æœ‰ä¸€ä¸ª ServiceA éœ€è¦è°ƒç”¨ ServiceB çš„æ–¹æ³•ï¼Œé‚£ä¹ˆ ServiceA å°±ä¾èµ–äº ServiceBï¼Œé‚£åœ¨ ServiceB ä¸­å†è°ƒç”¨ ServiceA çš„æ–¹æ³•ï¼Œå°±å½¢æˆäº†å¾ªç¯ä¾èµ–ã€‚Spring åœ¨åˆå§‹åŒ– bean çš„æ—¶å€™å°±ä¸çŸ¥é“å…ˆåˆå§‹åŒ–å“ªä¸ª bean å°±ä¼šæŠ¥é”™ã€‚

```
public class ClassA {
    @Autowired
    ClassB classB;
}
public class ClassB {
    @Autowired
    ClassA classA;
}
```

é‚£å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–ï¼Œå½“ç„¶æœ€å¥½çš„æ–¹æ³•æ˜¯é‡æ„ä½ çš„ä»£ç ï¼Œè¿›è¡Œè§£è€¦ï¼Œä½†æ˜¯é‡æ„ä¸æ˜¯ä¸€æ—¶çš„äº‹æƒ…ï¼Œé‚£å°±ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•ï¼š

ç¬¬ä¸€ç§ï¼š

```xml
<bean id="ServiceDependent1" class="org.xyz.ServiceDependent1" lazy-init="true">
    <constructor-arg ref="Service"/>
</bean>
<bean id="ServiceDependent2" class="org.xyz.ServiceDependent2" lazy-init="true">
    <constructor-arg ref="Service"/>
</bean>
```

åœ¨ä½ çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œåœ¨äº’ç›¸ä¾èµ–çš„ä¸¤ä¸ª bean çš„ä»»æ„ä¸€ä¸ªåŠ ä¸Š lazy-init å±æ€§ã€‚

ç¬¬äºŒç§ï¼š

```java
@Autowired
@Lazy
private ClassA classA;
@Autowired
@Lazy
private ClassB classB;
```

åœ¨ä½ æ³¨å…¥ bean æ—¶ï¼Œåœ¨äº’ç›¸ä¾èµ–çš„ä¸¤ä¸ª bean ä¸ŠåŠ ä¸Š@Lazy æ³¨è§£ä¹Ÿå¯ä»¥ã€‚

ä»¥ä¸Šä¸¤ç§æ–¹æ³•éƒ½èƒ½å»¶è¿Ÿäº’ç›¸ä¾èµ–çš„å…¶ä¸­ä¸€ä¸ª bean çš„åŠ è½½ï¼Œä»è€Œè§£å†³å¾ªç¯ä¾èµ–çš„é—®é¢˜ã€‚

## [SSH Config é‚£äº›ä½ æ‰€çŸ¥é“å’Œä¸çŸ¥é“çš„äº‹](https://blog.dong4j.site/posts/ff561974.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

SSHï¼ˆSecure Shellï¼‰æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯ä¸€é¡¹åˆ›å»ºåœ¨åº”ç”¨å±‚å’Œä¼ è¾“å±‚åŸºç¡€ä¸Šçš„å®‰å…¨åè®®, ä¸ºè®¡ç®—æœºä¸Šçš„ Shellï¼ˆå£³å±‚ï¼‰æä¾›å®‰å…¨çš„ä¼ è¾“å’Œä½¿ç”¨ç¯å¢ƒ.
ä¹Ÿæ˜¯ä¸“ä¸ºè¿œç¨‹ç™»å½•ä¼šè¯å’Œå…¶ä»–ç½‘ç»œæœåŠ¡æä¾›å®‰å…¨æ€§çš„åè®®.
å®ƒèƒ½å¤Ÿæœ‰æ•ˆé˜²æ­¢è¿œç¨‹ç®¡ç†è¿‡ç¨‹ä¸­çš„ä¿¡æ¯æ³„éœ²é—®é¢˜.
é€šè¿‡ SSH å¯ä»¥å¯¹æ‰€æœ‰ä¼ è¾“çš„æ•°æ®è¿›è¡ŒåŠ å¯†, ä¹Ÿèƒ½å¤Ÿé˜²æ­¢ DNS æ¬ºéª—å’Œ IP æ¬ºéª—.

<!-- more -->

å…·ä½“ç”Ÿæˆ SSH Key æ–¹å¼è¯·å‚è€ƒ: [Github ssh key ç”Ÿæˆ, å…å¯†ç™»å½•æœåŠ¡å™¨æ–¹æ³•](https://deepzz.com/post/github-generate-ssh-key.html).
è¿™é‡Œä»¥ `id_ecdsa`ï¼ˆç§é’¥ï¼‰ å’Œ `id_ecdsa.pub`ï¼ˆå…¬é’¥ï¼‰ ä¸ºä¾‹.

æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç» SSH ç›¸å…³çš„ä½¿ç”¨æŠ€å·§. é€šè¿‡å¯¹ `~/.ssh/config` æ–‡ä»¶çš„é…ç½®ä½ å¯ä»¥å¤§å¤§ç®€åŒ– SSH ç›¸å…³çš„æ“ä½œ, å¦‚:

```bash
Host example                       # å…³é”®è¯
    HostName example.com           # ä¸»æœºåœ°å€
    User root                      # ç”¨æˆ·å
    # IdentityFile ~/.ssh/id_ecdsa # è®¤è¯æ–‡ä»¶
    # Port 22                      # æŒ‡å®šç«¯å£
```

é€šè¿‡æ‰§è¡Œ `$ ssh example` æˆ‘å°±å¯ä»¥ç™»å½•æˆ‘çš„æœåŠ¡å™¨. è€Œä¸éœ€è¦æ•²æ›´å¤šçš„å‘½ä»¤ `$ ssh root@example.com`.
åˆå¦‚æˆ‘ä»¬æƒ³è¦å‘æœåŠ¡å™¨ä¼ æ–‡ä»¶ `$ scp a.txt example:/home/user_name`. æ¯”ä»¥å‰æ–¹ä¾¿å¤šäº†.

æ›´è¿‡ç›¸å…³å¸®åŠ©æ–‡æ¡£è¯·å‚è€ƒ `$ man ssh_config 5`.

### é…ç½®é¡¹è¯´æ˜

SSH çš„é…ç½®æ–‡ä»¶æœ‰ä¸¤ä¸ª:

```bash
$ ~/.ssh/config            # ç”¨æˆ·é…ç½®æ–‡ä»¶
$ /etc/ssh/ssh_config      # ç³»ç»Ÿé…ç½®æ–‡ä»¶

```

ä¸‹é¢æ¥çœ‹çœ‹å¸¸ç”¨çš„é…ç½®å‚æ•°.

**Host**
ç”¨äºæˆ‘ä»¬æ‰§è¡Œ SSH å‘½ä»¤çš„æ—¶å€™å¦‚ä½•åŒ¹é…åˆ°è¯¥é…ç½®.

- `*`, åŒ¹é…æ‰€æœ‰ä¸»æœºå.
- `*.example.com`, åŒ¹é…ä»¥ .example.com ç»“å°¾.
- `!*.dialup.example.com,*.example.com`, ä»¥ ! å¼€å¤´æ˜¯æ’é™¤çš„æ„æ€.
- `192.168.0.?`, åŒ¹é… 192.168.0.[0-9] çš„ IP.

**AddKeysToAgent**

æ˜¯å¦è‡ªåŠ¨å°† key åŠ å…¥åˆ° `ssh-agent`, å€¼å¯ä»¥ä¸º no(default)/confirm/ask/yes.

å¦‚æœæ˜¯ yes, key å’Œå¯†ç éƒ½å°†è¯»å–æ–‡ä»¶å¹¶ä»¥åŠ å…¥åˆ° agent , å°±åƒ `ssh-add`. å…¶ä»–åˆ†åˆ«æ˜¯è¯¢é—®ã€ç¡®è®¤ã€ä¸åŠ å…¥çš„æ„æ€. æ·»åŠ åˆ° ssh-agent æ„å‘³ç€å°†ç§é’¥å’Œå¯†ç äº¤ç»™å®ƒç®¡ç†,
è®©å®ƒæ¥è¿›è¡Œèº«ä»½è®¤è¯.

**AddressFamily**

æŒ‡å®šè¿æ¥çš„æ—¶å€™ä½¿ç”¨çš„åœ°å€æ—, å€¼å¯ä»¥ä¸º any(default)/inet(IPv4)/inet6(IPv6).

**BindAddress**

æŒ‡å®šè¿æ¥çš„æ—¶å€™ä½¿ç”¨çš„æœ¬åœ°ä¸»æœºåœ°å€, åªåœ¨ç³»ç»Ÿæœ‰å¤šä¸ªåœ°å€çš„æ—¶å€™æœ‰ç”¨. åœ¨ UsePrivilegedPort å€¼ä¸º yes çš„æ—¶å€™æ— æ•ˆ.

**ChallengeResponseAuthentication**

æ˜¯å¦å“åº”æ”¯æŒçš„èº«ä»½éªŒè¯ chanllenge, yes(default)/no.

**Compression**

æ˜¯å¦å‹ç¼©, å€¼å¯ä»¥ä¸º no(default)/yes.

**CompressionLevel**

å‹ç¼©ç­‰çº§, å€¼å¯ä»¥ä¸º 1(fast)-9(slow). 6(default), ç›¸å½“äº gzip.

**ConnectionAttempts**

é€€å‡ºå‰å°è¯•è¿æ¥çš„æ¬¡æ•°, å€¼å¿…é¡»ä¸ºæ•´æ•°, 1(default).

**ConnectTimeout**

è¿æ¥ SSH æœåŠ¡å™¨è¶…æ—¶æ—¶é—´, å•ä½ s, é»˜è®¤ç³»ç»Ÿ TCP è¶…æ—¶æ—¶é—´.

**ControlMaster**

æ˜¯å¦å¼€å¯å•ä¸€ç½‘ç»œå…±äº«å¤šä¸ª session, å€¼å¯ä»¥ä¸º no(default)/yes/ask/auto. éœ€è¦å’Œ ControlPath é…åˆä½¿ç”¨, å½“å€¼ä¸º yes æ—¶, ssh ä¼šç›‘å¬è¯¥è·¯å¾„ä¸‹çš„
control socket, å¤šä¸ª session ä¼šå»è¿æ¥è¯¥ socket, å®ƒä»¬ä¼šå°½å¯èƒ½çš„å¤ç”¨è¯¥ç½‘ç»œè¿æ¥è€Œä¸æ˜¯é‡æ–°å»ºç«‹æ–°çš„.

**ControlPath**

æŒ‡å®š control socket çš„è·¯å¾„, å€¼å¯ä»¥ç›´æ¥æŒ‡å®šä¹Ÿå¯ä»¥ç”¨ä¸€ä¸‹å‚æ•°ä»£æ›¿:

- %L æœ¬åœ°ä¸»æœºåçš„ç¬¬ä¸€ä¸ªç»„ä»¶
- %l æœ¬åœ°ä¸»æœºåï¼ˆåŒ…æ‹¬åŸŸåï¼‰
- %h è¿œç¨‹ä¸»æœºåï¼ˆå‘½ä»¤è¡Œè¾“å…¥ï¼‰
- %n è¿œç¨‹åŸå§‹ä¸»æœºå
- %p è¿œç¨‹ä¸»æœºç«¯å£
- %r è¿œç¨‹ç™»å½•ç”¨æˆ·å
- %u æœ¬åœ° ssh æ­£åœ¨ä½¿ç”¨çš„ç”¨æˆ·å
- %i æœ¬åœ° ssh æ­£åœ¨ä½¿ç”¨ uid
- %C å€¼ä¸º %l%h%p%r çš„ hash

è¯·æœ€å¤§é™åº¦çš„ä¿æŒ ControlPath çš„å”¯ä¸€. è‡³å°‘åŒ…å« %h, %p, %rï¼ˆæˆ–è€… %Cï¼‰.

**ControlPersist**

ç»“åˆ ControlMaster ä½¿ç”¨, æŒ‡å®šè¿æ¥æ‰“å¼€ååå°ä¿æŒçš„æ—¶é—´. å€¼å¯ä»¥ä¸º no/yes / æ•´æ•°, å•ä½ s. å¦‚æœä¸º no, æœ€åˆçš„å®¢æˆ·ç«¯å…³é—­å°±å…³é—­. å¦‚æœ yes/0, æ— é™æœŸçš„,
ç›´åˆ°æ€æ­»æˆ–é€šè¿‡å…¶å®ƒæœºåˆ¶, å¦‚: ssh -O exit.

**GatewayPorts**

æŒ‡å®šæ˜¯å¦å…è®¸è¿œç¨‹ä¸»æœºè¿æ¥åˆ°æœ¬åœ°è½¬å‘ç«¯å£, å€¼å¯ä»¥ä¸º no(default)/yes. é»˜è®¤æƒ…å†µ, ssh ä¸ºæœ¬åœ°å›ç¯åœ°å€ç»‘å®šäº†ç«¯å£è½¬å‘å™¨.

**HostName**

çœŸå®çš„ä¸»æœºå, é»˜è®¤å€¼ä¸ºå‘½ä»¤è¡Œè¾“å…¥çš„å€¼ï¼ˆå…è®¸ IPï¼‰. ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ %h, å®ƒå°†è‡ªåŠ¨æ›¿æ¢, åªè¦æ›¿æ¢åçš„åœ°å€æ˜¯å®Œæ•´çš„å°± ok.

**IdentitiesOnly**

æŒ‡å®š ssh åªèƒ½ä½¿ç”¨é…ç½®æ–‡ä»¶æŒ‡å®šçš„ identity å’Œ certificate æ–‡ä»¶æˆ–é€šè¿‡ ssh å‘½ä»¤è¡Œé€šè¿‡èº«ä»½éªŒè¯, å³ä½¿ ssh-agent æˆ– PKCS11Provider æä¾›äº†å¤šä¸ª
identities. å€¼å¯ä»¥ä¸º no(default)/yes.

**IdentityFile**

æŒ‡å®šè¯»å–çš„è®¤è¯æ–‡ä»¶è·¯å¾„, å…è®¸ DSA, ECDSA, Ed25519 æˆ– RSA. å€¼å¯ä»¥ç›´æ¥æŒ‡å®šä¹Ÿå¯ä»¥ç”¨ä¸€ä¸‹å‚æ•°ä»£æ›¿:

- %d, æœ¬åœ°ç”¨æˆ·ç›®å½• ~
- %u, æœ¬åœ°ç”¨æˆ·
- %l, æœ¬åœ°ä¸»æœºå
- %h, è¿œç¨‹ä¸»æœºå
- %r, è¿œç¨‹ç”¨æˆ·å

**LocalCommand**

æŒ‡å®šåœ¨è¿æ¥æˆåŠŸå, æœ¬åœ°ä¸»æœºæ‰§è¡Œçš„å‘½ä»¤ï¼ˆå•çº¯çš„æœ¬åœ°å‘½ä»¤ï¼‰. å¯ä½¿ç”¨ %d, %h, %l, %n, %p, %r, %u, %C æ›¿æ¢éƒ¨åˆ†å‚æ•°. åªåœ¨ PermitLocalCommand å¼€å¯çš„æƒ…å†µä¸‹æœ‰æ•ˆ.

**LocalForward**

æŒ‡å®šæœ¬åœ°ä¸»æœºçš„ç«¯å£é€šè¿‡ ssh è½¬å‘åˆ°æŒ‡å®šè¿œç¨‹ä¸»æœº. æ ¼å¼: LocalForward [bind_address:]post host:hostport, æ”¯æŒ IPv6.

**PasswordAuthentication**

æ˜¯å¦ä½¿ç”¨å¯†ç è¿›è¡Œèº«ä»½éªŒè¯, yes(default)/no.

**PermitLocalCommand**

æ˜¯å¦å…è®¸æŒ‡å®š LocalCommand, å€¼å¯ä»¥ä¸º no(default)/yes.

**Port**

æŒ‡å®šè¿æ¥è¿œç¨‹ä¸»æœºçš„å“ªä¸ªç«¯å£, 22(default).

**ProxyCommand**

æŒ‡å®šè¿æ¥çš„æœåŠ¡å™¨éœ€è¦æ‰§è¡Œçš„å‘½ä»¤. %h, %p, %r

å¦‚: ProxyCommand /usr/bin/nc -X connect -x 192.0.2.0:8080 %h %p

**User**

ç™»å½•ç”¨æˆ·å

### ç›¸å…³æŠ€å·§

#### ç®¡ç†å¤šç»„å¯†é’¥å¯¹

æœ‰æ—¶å€™ä½ ä¼šé’ˆå¯¹å¤šä¸ªæœåŠ¡å™¨æœ‰ä¸åŒçš„å¯†é’¥å¯¹, æ¯æ¬¡é€šè¿‡æŒ‡å®š `-i` å‚æ•°ä¹Ÿæ˜¯éå¸¸çš„ä¸æ–¹ä¾¿. æ¯”å¦‚ä½ ä½¿ç”¨ github å’Œ coding.
é‚£ä¹ˆä½ éœ€è¦æ·»åŠ å¦‚ä¸‹é…ç½®åˆ° `~/.ssh/config`:

```bash
Host github
    HostName %h.com
    IdentityFile ~/.ssh/id_ecdsa_github
    User git
Host coding
    HostName git.coding.net
    IdentityFile ~/.ssh/id_rsa_coding
    User git

```

å½“ä½ å…‹éš† coding ä¸Šçš„æŸä¸ªä»“åº“æ—¶:

```bash
# åŸæ¥
$ git clone git@git.coding.net:deepzz/test.git

# ç°åœ¨
$ git clone coding:deepzz/test.git

```

#### vim è®¿é—®è¿œç¨‹æ–‡ä»¶

vim å¯ä»¥ç›´æ¥ç¼–è¾‘è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶:

```bash
$ vim scp://root@example.com//home/centos/docker-compose.yml
$ vim scp://example//home/centos/docker-compose.yml

```

#### è¿œç¨‹æœåŠ¡å½“æœ¬åœ°ç”¨

é€šè¿‡ LocalForward å°†æœ¬åœ°ç«¯å£ä¸Šçš„æ•°æ®æµé‡é€šè¿‡ ssh è½¬å‘åˆ°è¿œç¨‹ä¸»æœºçš„æŒ‡å®šç«¯å£. æ„Ÿè§‰ä½ æ˜¯ä½¿ç”¨çš„æœ¬åœ°æœåŠ¡, å…¶å®ä½ ä½¿ç”¨çš„è¿œç¨‹æœåŠ¡. å¦‚è¿œç¨‹æœåŠ¡å™¨ä¸Šè¿è¡Œç€
Postgres, ç«¯å£ 5432ï¼ˆæœªæš´éœ²ç«¯å£ç»™å¤–éƒ¨ï¼‰. é‚£ä¹ˆ, ä½ å¯ä»¥:

```bash
Host db
    HostName db.example.com
    LocalForward 5433 localhost:5432
```

å½“ä½ è¿æ¥è¿œç¨‹ä¸»æœºæ—¶, å®ƒä¼šåœ¨æœ¬åœ°æ‰“å¼€ä¸€ä¸ª 5433 ç«¯å£, å¹¶å°†è¯¥ç«¯å£çš„æµé‡é€šè¿‡ ssh è½¬å‘åˆ°è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„ 5432 ç«¯å£.

é¦–å…ˆ, å»ºç«‹è¿æ¥:

```bash
$ ssh db
```

ä¹‹å, å°±å¯ä»¥é€šè¿‡ Postgres å®¢æˆ·ç«¯è¿æ¥æœ¬åœ° 5433 ç«¯å£:

```bash
$ psql -h localhost -p 5433 orders
```

#### å¤šè¿æ¥å…±äº«

ä»€ä¹ˆæ˜¯å¤šè¿æ¥å…±äº«ï¼Ÿåœ¨ä½ æ‰“å¼€å¤šä¸ª shell çª—å£æ—¶éœ€è¦è¿æ¥åŒä¸€å°æœåŠ¡å™¨, å¦‚æœä½ ä¸æƒ³æ¯æ¬¡éƒ½è¾“å…¥ç”¨æˆ·å, å¯†ç , æˆ–æ˜¯ç­‰å¾…è¿æ¥å»ºç«‹,
é‚£ä¹ˆä½ éœ€è¦æ·»åŠ å¦‚ä¸‹é…ç½®åˆ° `~/.ssh/config`:

```bash
ControlMaster auto
ControlPath /tmp/%r@%h:%p
```

#### ç¦ç”¨å¯†ç ç™»å½•

å¦‚æœä½ å¯¹æœåŠ¡å™¨å®‰å…¨è¦æ±‚å¾ˆé«˜, é‚£ä¹ˆç¦ç”¨å¯†ç ç™»å½•æ˜¯å¿…é¡»çš„. å› ä¸ºä½¿ç”¨å¯†ç ç™»å½•æœåŠ¡å™¨å®¹æ˜“å—åˆ°æš´åŠ›ç ´è§£çš„æ”»å‡», æœ‰ä¸€å®šçš„å®‰å…¨éšæ‚£.
é‚£ä¹ˆä½ éœ€è¦ç¼–è¾‘æœåŠ¡å™¨çš„ç³»ç»Ÿé…ç½®æ–‡ä»¶ `/etc/ssh/sshd_config`:

```bash
PasswordAuthentication no
ChallengeResponseAuthentication no
```

#### å…³é”®è¯ç™»å½•

ä¸ºäº†æ›´æ–¹ä¾¿çš„ç™»å½•æœåŠ¡å™¨, æˆ‘ä»¬ä¹Ÿå¯ä»¥çœç•¥ç”¨æˆ·åå’Œä¸»æœºå, é‡‡ç”¨å…³é”®è¯ç™»å½•. é‚£ä¹ˆä½ éœ€è¦æ·»åŠ å¦‚ä¸‹é…ç½®åˆ° `~/.ssh/config`:

```bash
Host deepzz                        # åˆ«å
    HostName deepzz.com            # ä¸»æœºåœ°å€
    User root                      # ç”¨æˆ·å
    # IdentityFile ~/.ssh/id_ecdsa # è®¤è¯æ–‡ä»¶
    # Port 22                      # æŒ‡å®šç«¯å£
```

é‚£ä¹ˆä½¿ç”¨ `$ ssh deepzz` å°±å¯ä»¥ç›´æ¥ç™»å½•æœåŠ¡å™¨äº†.

#### ä»£ç†ç™»å½•

æœ‰çš„æ—¶å€™ä½ å¯èƒ½æ²¡æ³•ç›´æ¥ç™»å½•åˆ°æŸå°æœåŠ¡å™¨, è€Œéœ€è¦ä½¿ç”¨ä¸€å°ä¸­é—´æœåŠ¡å™¨è¿›è¡Œä¸­è½¬, å¦‚å…¬å¸å†…ç½‘æœåŠ¡å™¨. é¦–å…ˆç¡®ä¿ä½ å·²ç»ä¸ºæœåŠ¡å™¨é…ç½®äº†å…¬é’¥è®¿é—®, å¹¶å¼€å¯äº†
agent forwarding, é‚£ä¹ˆä½ éœ€è¦æ·»åŠ å¦‚ä¸‹é…ç½®åˆ° `~/.ssh/config`:

```bash
Host gateway
    HostName proxy.example.com
    User root
Host db
    HostName db.internal.example.com                  # ç›®æ ‡æœåŠ¡å™¨åœ°å€
    User root                                         # ç”¨æˆ·å
    # IdentityFile ~/.ssh/id_ecdsa                    # è®¤è¯æ–‡ä»¶
    ProxyCommand ssh gateway netcat -q 600 %h %p      # ä»£ç†å‘½ä»¤
```

é‚£ä¹ˆä½ ç°åœ¨å¯ä»¥ä½¿ç”¨ `$ ssh db` è¿æ¥äº†.

## [å†…å­˜ä¼˜åŒ–å®æˆ˜ï¼šä»æ•°æ®ç»“æ„é€‰æ‹©åˆ°GCç­–ç•¥](https://blog.dong4j.site/posts/b2f99cee.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})


### å†…å­˜ä¼˜åŒ–å¯¹æ¯”

**æ•°æ®é‡**

> å¤–å‘¼åå• 10 ä¸‡
> ç™½åå• 100 ä¸‡
> é»‘åå• 500 ä¸‡

**JVM å‚æ•°**

```
-verbose:gc
-XX:+HeapDumpOnOutOfMemoryError
-server
-Xms1g
-Xmx1g
-XX:PermSize=512m
-XX:SurvivorRatio=2
-XX:+UseParallelGC
```

#### ä¼˜åŒ–ä¹‹å‰

**å¯¹æ¯”è€—æ—¶**

```
2018-05-31 15:29:49 [INFO]] [pool-1-thread-1] [parseRegulation] ç™½åå•åŒ¹é…ä¸ªæ•° = 25
2018-05-31 15:29:50 [INFO]] [pool-1-thread-1] [parseRegulation] é»‘åå•åŒ¹é…ä¸ªæ•° = 189
StopWatch '': running time (millis) = 906
-----------------------------------------
ms     %     Task name
-----------------------------------------
00906  100%  å¯¹æ¯”

...

diffList.size = 99810
telNos.size = 99810
```

**å†…å­˜æ¶ˆè€—**

å¯åŠ¨æ—¶ç¬¬ä¸€æ¬¡è¿è¡Œè§£æä»»åŠ¡, å¹¶ä¸”ç¬¦åˆæ¡ä»¶çš„ calloutList ä¸º 99810;

æœ€é«˜ä½¿ç”¨ `762.5` M

![20241229154732_ky3i189B.webp](https://cdn.dong4j.site/source/image/20241229154732_ky3i189B.webp)

æŒç»­è¿è¡Œä¸€æ®µæ—¶é—´, å¹¶ä¸”ä½¿ç”¨ç›¸åŒçš„å·ç åŒ…è¿›è¡Œæµ‹è¯•çš„ç»“æœ

å‘ç”Ÿäº† OOM

![20241229154732_jpeRRWzH.webp](https://cdn.dong4j.site/source/image/20241229154732_jpeRRWzH.webp)

#### ä¼˜åŒ–ä¹‹å

**å¯¹æ¯”è€—æ—¶**

```
2018-05-31 15:46:45 [INFO]] [pool-1-thread-1] [dealWhiteAndBlackList] ç™½åå•åŒ¹é…ä¸ªæ•° = 25
2018-05-31 15:46:45 [INFO]] [pool-1-thread-1] [dealWhiteAndBlackList] ç™½åå•åŒ¹é…ä¸ªæ•° = 189
StopWatch '': running time (millis) = 109
-----------------------------------------
ms     %     Task name
-----------------------------------------
00109  100%  å¯¹æ¯”

...

diffList.size = 99810
telNos.size = 99810
```

**å†…å­˜æ¶ˆè€—**

å¯åŠ¨æ—¶ç¬¬ä¸€æ¬¡è¿è¡Œè§£æä»»åŠ¡, å¹¶ä¸”ç¬¦åˆæ¡ä»¶çš„ calloutList ä¸º 99810;

æœ€é«˜ `728` M

![20241229154732_898V9sAS.webp](https://cdn.dong4j.site/source/image/20241229154732_898V9sAS.webp)

æŒç»­è¿è¡Œä¸€æ®µæ—¶é—´, å¹¶ä¸”ä½¿ç”¨ç›¸åŒçš„å·ç åŒ…è¿›è¡Œæµ‹è¯•çš„ç»“æœ

![20241229154732_sb34vgzR.webp](https://cdn.dong4j.site/source/image/20241229154732_sb34vgzR.webp)

#### ä¼˜åŒ–æ–¹æ¡ˆ

1. ä½¿ç”¨ BloomFilter ä»£æ›¿ DataCache æ¥å­˜å‚¨é»‘ç™½åå•;
2. åŠæ—¶æ¸…ç†å ç”¨å¤§å†…å­˜çš„ä¸´æ—¶å˜é‡;

##### å¸ƒéš†è¿‡æ»¤å™¨

![20241229154732_PYx6qUxn.webp](https://cdn.dong4j.site/source/image/20241229154732_PYx6qUxn.webp)

**ç®€ä»‹:**

æ˜¯ä¸€ä¸ªå¾ˆé•¿çš„äºŒè¿›åˆ¶å‘é‡å’Œä¸€ç³»åˆ—éšæœºæ˜ å°„å‡½æ•°. å¸ƒéš†è¿‡æ»¤å™¨å¯ä»¥ç”¨äºæ£€ç´¢ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨ä¸€ä¸ªé›†åˆä¸­. å®ƒçš„ä¼˜ç‚¹æ˜¯ç©ºé—´æ•ˆç‡å’ŒæŸ¥è¯¢æ—¶é—´éƒ½è¿œè¿œè¶…è¿‡ä¸€èˆ¬çš„ç®—æ³•,
ç¼ºç‚¹æ˜¯æœ‰ä¸€å®šçš„è¯¯è¯†åˆ«ç‡å’Œåˆ é™¤å›°éš¾.

**åŸç†:**

å½“ä¸€ä¸ªå…ƒç´ è¢«åŠ å…¥é›†åˆæ—¶, é€šè¿‡ K ä¸ªæ•£åˆ—å‡½æ•°å°†è¿™ä¸ªå…ƒç´ æ˜ å°„æˆä¸€ä¸ªä½æ•°ç»„ä¸­çš„ K ä¸ªç‚¹, æŠŠå®ƒä»¬ç½®ä¸º 1. æ£€ç´¢æ—¶,
æˆ‘ä»¬åªè¦çœ‹çœ‹è¿™äº›ç‚¹æ˜¯ä¸æ˜¯éƒ½æ˜¯ 1 å°±ï¼ˆå¤§çº¦ï¼‰çŸ¥é“é›†åˆä¸­æœ‰æ²¡æœ‰å®ƒäº†: å¦‚æœè¿™äº›ç‚¹æœ‰ä»»ä½•ä¸€ä¸ª 0, åˆ™è¢«æ£€å…ƒç´ ä¸€å®šä¸åœ¨ï¼›å¦‚æœéƒ½æ˜¯ 1, åˆ™è¢«æ£€å…ƒç´ å¾ˆå¯èƒ½åœ¨.

**ä¼˜ç‚¹:**

ç›¸æ¯”äºå…¶å®ƒçš„æ•°æ®ç»“æ„, å¸ƒéš†è¿‡æ»¤å™¨åœ¨ç©ºé—´å’Œæ—¶é—´æ–¹é¢éƒ½æœ‰å·¨å¤§çš„ä¼˜åŠ¿. å¸ƒéš†è¿‡æ»¤å™¨å­˜å‚¨ç©ºé—´å’Œæ’å…¥/æŸ¥è¯¢æ—¶é—´éƒ½æ˜¯å¸¸æ•°ï¼ˆO(k)ï¼‰. è€Œä¸”å®ƒä¸å­˜å‚¨å…ƒç´ æœ¬èº«,
åœ¨æŸäº›å¯¹ä¿å¯†è¦æ±‚éå¸¸ä¸¥æ ¼çš„åœºåˆæœ‰ä¼˜åŠ¿.

**ç¼ºç‚¹**:

ä¸€å®šçš„è¯¯è¯†åˆ«ç‡å’Œåˆ é™¤å›°éš¾.

#### å¼€å‘å»ºè®®

ç¨‹åºçš„è¿è¡Œä¼šç›´æ¥å½±å“ç³»ç»Ÿç¯å¢ƒçš„å˜åŒ–, ä»è€Œå½±å“ GC çš„è§¦å‘. è‹¥ä¸é’ˆå¯¹ GC çš„ç‰¹ç‚¹è¿›è¡Œè®¾è®¡å’Œç¼–ç , å°±ä¼šå‡ºç°å†…å­˜é©»ç•™ç­‰ä¸€ç³»åˆ—è´Ÿé¢å½±å“.
ä¸ºäº†é¿å…è¿™äº›å½±å“, åŸºæœ¬çš„åŸåˆ™å°±æ˜¯å°½å¯èƒ½åœ°å‡å°‘åƒåœ¾å’Œå‡å°‘ GC è¿‡ç¨‹ä¸­çš„å¼€é”€. å…·ä½“æªæ–½åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢:

1. ä¸è¦æ˜¾å¼è°ƒç”¨ `System.gc()`

   æ­¤å‡½æ•°å»ºè®® JVM è¿›è¡Œä¸» GC, è™½ç„¶åªæ˜¯å»ºè®®è€Œéä¸€å®š, ä½†å¾ˆå¤šæƒ…å†µä¸‹å®ƒä¼šè§¦å‘ä¸» GC, ä»è€Œå¢åŠ ä¸» GC çš„é¢‘ç‡, ä¹Ÿå³å¢åŠ äº†é—´æ­‡æ€§åœé¡¿çš„æ¬¡æ•°.

2. å°½é‡å‡å°‘ä¸´æ—¶å¯¹è±¡çš„ä½¿ç”¨

   ä¸´æ—¶å¯¹è±¡åœ¨è·³å‡ºå‡½æ•°è°ƒç”¨å, ä¼šæˆä¸ºåƒåœ¾, å°‘ç”¨ä¸´æ—¶å˜é‡å°±ç›¸å½“äºå‡å°‘äº†åƒåœ¾çš„äº§ç”Ÿ.

3. å¯¹è±¡ä¸ç”¨æ—¶æœ€å¥½æ˜¾å¼ç½®ä¸º null

   ä¸€èˆ¬è€Œè¨€, ä¸º null çš„å¯¹è±¡éƒ½ä¼šè¢«ä½œä¸ºåƒåœ¾å¤„ç†, æ‰€ä»¥å°†ä¸ç”¨çš„å¯¹è±¡æ˜¾å¼åœ°è®¾ä¸º null, æœ‰åˆ©äº GC æ”¶é›†å™¨åˆ¤å®šåƒåœ¾, ä»è€Œæé«˜äº† GC çš„æ•ˆç‡.

4. å°½é‡å°‘ç”¨é™æ€å¯¹è±¡å˜é‡

   é™æ€å˜é‡å±äºå…¨å±€å˜é‡, ä¸ä¼šè¢« GC å›æ”¶, å®ƒä»¬ä¼šä¸€ç›´å ç”¨å†…å­˜.

## [å¦‚ä½•å®ç°ä¼˜é›…çš„é‡è¯•æœºåˆ¶ï¼Ÿä¸¤ç§æ–¹å¼å¤§æ¯”æ‹¼ï¼](https://blog.dong4j.site/posts/2c5b3e3a.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

æ–‡ï¼LNAmpï¼ˆç®€ä¹¦ä½œè€…ï¼‰
åŸæ–‡é“¾æ¥: [http://www.jianshu.com/p/80c7777d48ad](http://www.jianshu.com/p/80c7777d48ad)

## è§£å†³æ–¹æ¡ˆæ¼”åŒ–

è¿™ä¸ªé—®é¢˜çš„æŠ€æœ¯ç‚¹åœ¨äºèƒ½å¤Ÿè§¦å‘é‡è¯•, ä»¥åŠé‡è¯•æƒ…å†µä¸‹é€»è¾‘æœ‰æ•ˆæ‰§è¡Œ.

### è§£å†³æ–¹æ¡ˆä¸€: try-catch-redo ç®€å•é‡è¯•æ¨¡å¼

åŒ…è£…æ­£å¸¸ä¸Šä¼ é€»è¾‘åŸºç¡€ä¸Š, é€šè¿‡åˆ¤æ–­è¿”å›ç»“æœæˆ–ç›‘å¬å¼‚å¸¸å†³ç­–æ˜¯å¦é‡è¯•, åŒæ—¶ä¸ºäº†è§£å†³ç«‹å³é‡è¯•çš„æ— æ•ˆæ‰§è¡Œ (å‡è®¾å¼‚å¸¸æ˜¯æœ‰å¤–éƒ¨æ‰§è¡Œä¸ç¨³å®šå¯¼è‡´çš„),
ä¼‘çœ ä¸€å®šå»¶è¿Ÿæ—¶é—´é‡æ–°æ‰§è¡ŒåŠŸèƒ½é€»è¾‘.

```java
public void commonRetry(Map<String, Object> dataMap) throws InterruptedException {
    Map<String, Object> paramMap = Maps.newHashMap();
    paramMap.put("tableName", "creativeTable");
    paramMap.put("ds", "20160220");
    paramMap.put("dataMap", dataMap);
    boolean result = false;
    try {
        result = uploadToOdps(paramMap);
        if (!result) {
            Thread.sleep(1000);
            uploadToOdps(paramMap);  // ä¸€æ¬¡é‡è¯•
        }
    } catch (Exception e) {
        Thread.sleep(1000);
        uploadToOdps(paramMap);// ä¸€æ¬¡é‡è¯•
    }
}
```

### è§£å†³æ–¹æ¡ˆäºŒ: try-catch-redo-retry strategy ç­–ç•¥é‡è¯•æ¨¡å¼

è¿°æ–¹æ¡ˆè¿˜æ˜¯æœ‰å¯èƒ½é‡è¯•æ— æ•ˆ, è§£å†³è¿™ä¸ªé—®é¢˜å°è¯•å¢åŠ é‡è¯•æ¬¡æ•° retrycount ä»¥åŠé‡è¯•é—´éš”å‘¨æœŸ interval, è¾¾åˆ°å¢åŠ é‡è¯•æœ‰æ•ˆçš„å¯èƒ½æ€§.

```java
public void commonRetry(Map<String, Object> dataMap) throws InterruptedException {
    Map<String, Object> paramMap = Maps.newHashMap();
    paramMap.put("tableName", "creativeTable");
    paramMap.put("ds", "20160220");
    paramMap.put("dataMap", dataMap);
    boolean result = false;
    try {
        result = uploadToOdps(paramMap);
        if (!result) {
            reuploadToOdps(paramMap,1000L,10);// å»¶è¿Ÿå¤šæ¬¡é‡è¯•
        }
    } catch (Exception e) {
        reuploadToOdps(paramMap,1000L,10);// å»¶è¿Ÿå¤šæ¬¡é‡è¯•
    }
}
```

æ–¹æ¡ˆä¸€å’Œæ–¹æ¡ˆäºŒå­˜åœ¨ä¸€ä¸ªé—®é¢˜: æ­£å¸¸é€»è¾‘å’Œé‡è¯•é€»è¾‘å¼ºè€¦åˆ, é‡è¯•é€»è¾‘éå¸¸ä¾èµ–æ­£å¸¸é€»è¾‘çš„æ‰§è¡Œç»“æœ, å¯¹æ­£å¸¸é€»è¾‘é¢„æœŸç»“æœè¢«åŠ¨é‡è¯•è§¦å‘, å¯¹äºé‡è¯•æ ¹æºå¾€å¾€ç”±äºé€»è¾‘å¤æ‚è¢«æ·¹æ²¡,
å¯èƒ½å¯¼è‡´åç»­è¿ç»´å¯¹äºé‡è¯•é€»è¾‘è¦è§£å†³ä»€ä¹ˆé—®é¢˜äº§ç”Ÿä¸ä¸€è‡´ç†è§£. é‡è¯•æ­£ç¡®æ€§éš¾ä¿è¯è€Œä¸”ä¸åˆ©äºè¿ç»´, åŸå› æ˜¯é‡è¯•è®¾è®¡ä¾èµ–æ­£å¸¸é€»è¾‘å¼‚å¸¸æˆ–é‡è¯•æ ¹æºçš„è‡†æµ‹.

## ä¼˜é›…é‡è¯•æ–¹æ¡ˆå°è¯•

é‚£æœ‰æ²¡æœ‰å¯ä»¥å‚è€ƒçš„æ–¹æ¡ˆå®ç°æ­£å¸¸é€»è¾‘å’Œé‡è¯•é€»è¾‘è§£è€¦, åŒæ—¶èƒ½å¤Ÿè®©é‡è¯•é€»è¾‘æœ‰ä¸€ä¸ªæ ‡å‡†åŒ–çš„è§£å†³æ€è·¯ï¼Ÿç­”æ¡ˆæ˜¯æœ‰: é‚£å°±æ˜¯åŸºäºä»£ç†è®¾è®¡æ¨¡å¼çš„é‡è¯•å·¥å…·,
æˆ‘ä»¬å°è¯•ä½¿ç”¨ç›¸åº”å·¥å…·æ¥é‡æ„ä¸Šè¿°åœºæ™¯.

### å°è¯•æ–¹æ¡ˆä¸€: åº”ç”¨å‘½ä»¤è®¾è®¡æ¨¡å¼è§£è€¦æ­£å¸¸å’Œé‡è¯•é€»è¾‘

å‘½ä»¤è®¾è®¡æ¨¡å¼å…·ä½“å®šä¹‰ä¸å±•å¼€é˜è¿°, ä¸»è¦è¯¥æ–¹æ¡ˆçœ‹ä¸­å‘½ä»¤æ¨¡å¼èƒ½å¤Ÿé€šè¿‡æ‰§è¡Œå¯¹è±¡å®Œæˆæ¥å£æ“ä½œé€»è¾‘, åŒæ—¶å†…éƒ¨å°è£…å¤„ç†é‡è¯•é€»è¾‘, ä¸æš´éœ²å®ç°ç»†èŠ‚,
å¯¹äºè°ƒç”¨è€…æ¥çœ‹å°±æ˜¯æ‰§è¡Œäº†æ­£å¸¸é€»è¾‘, è¾¾åˆ°è§£è€¦çš„ç›®æ ‡, å…·ä½“çœ‹ä¸‹åŠŸèƒ½å®ç°. ï¼ˆç±»å›¾ç»“æ„ï¼‰

![20241229154732_eAN1LD66.webp](https://cdn.dong4j.site/source/image/20241229154732_eAN1LD66.webp)

IRetry çº¦å®šäº†ä¸Šä¼ å’Œé‡è¯•æ¥å£, å…¶å®ç°ç±» OdpsRetry å°è£… ODPS ä¸Šä¼ é€»è¾‘, åŒæ—¶å°è£…é‡è¯•æœºåˆ¶å’Œé‡è¯•ç­–ç•¥. ä¸æ­¤åŒæ—¶ä½¿ç”¨ recover æ–¹æ³•åœ¨ç»“æŸæ‰§è¡Œåšæ¢å¤æ“ä½œ.

è€Œæˆ‘ä»¬çš„è°ƒç”¨è€… LogicClient æ— éœ€å…³æ³¨é‡è¯•, é€šè¿‡é‡è¯•è€… Retryer å®ç°çº¦å®šæ¥å£åŠŸèƒ½, åŒæ—¶ Retryer éœ€è¦å¯¹é‡è¯•é€»è¾‘åšå‡ºå“åº”å’Œå¤„ç†, Retryer
å…·ä½“é‡è¯•å¤„ç†åˆäº¤ç»™çœŸæ­£çš„ IRtry æ¥å£çš„å®ç°ç±» OdpsRetry å®Œæˆ. é€šè¿‡é‡‡ç”¨å‘½ä»¤æ¨¡å¼, ä¼˜é›…å®ç°æ­£å¸¸é€»è¾‘å’Œé‡è¯•é€»è¾‘åˆ†ç¦», åŒæ—¶é€šè¿‡æ„å»ºé‡è¯•è€…è§’è‰²,
å®ç°æ­£å¸¸é€»è¾‘å’Œé‡è¯•é€»è¾‘çš„åˆ†ç¦», è®©é‡è¯•æœ‰æ›´å¥½çš„æ‰©å±•æ€§.

### å°è¯•æ–¹æ¡ˆäºŒ: spring-retry è§„èŒƒæ­£å¸¸å’Œé‡è¯•é€»è¾‘

[spring](http://lib.csdn.net/base/javaee "Java EEçŸ¥è¯†åº“")-retry æ˜¯ä¸€ä¸ªå¼€æºå·¥å…·åŒ…, ç›®å‰å¯ç”¨çš„ç‰ˆæœ¬ä¸º 1.1.2.RELEASE, è¯¥å·¥å…·æŠŠé‡è¯•æ“ä½œæ¨¡æ¿å®šåˆ¶åŒ–,
å¯ä»¥è®¾ç½®é‡è¯•ç­–ç•¥å’Œå›é€€ç­–ç•¥. åŒæ—¶é‡è¯•æ‰§è¡Œå®ä¾‹ä¿è¯çº¿ç¨‹å®‰å…¨, å…·ä½“åœºæ™¯æ“ä½œå®ä¾‹å¦‚ä¸‹:

```java
public void upload(final Map<String, Object> map) throws Exception {
    // æ„å»ºé‡è¯•æ¨¡æ¿å®ä¾‹
    RetryTemplate retryTemplate = new RetryTemplate();
    // è®¾ç½®é‡è¯•ç­–ç•¥, ä¸»è¦è®¾ç½®é‡è¯•æ¬¡æ•°
    SimpleRetryPolicy policy = new SimpleRetryPolicy(3, Collections.<Class<? extends Throwable>, Boolean> singletonMap(Exception.class, true));
    // è®¾ç½®é‡è¯•å›é€€æ“ä½œç­–ç•¥, ä¸»è¦è®¾ç½®é‡è¯•é—´éš”æ—¶é—´
    FixedBackOffPolicy fixedBackOffPolicy = new FixedBackOffPolicy();
    fixedBackOffPolicy.setBackOffPeriod(100);
    retryTemplate.setRetryPolicy(policy);
    retryTemplate.setBackOffPolicy(fixedBackOffPolicy);
    // é€šè¿‡ RetryCallback é‡è¯•å›è°ƒå®ä¾‹åŒ…è£…æ­£å¸¸é€»è¾‘é€»è¾‘, ç¬¬ä¸€æ¬¡æ‰§è¡Œå’Œé‡è¯•æ‰§è¡Œæ‰§è¡Œçš„éƒ½æ˜¯è¿™æ®µé€»è¾‘
    final RetryCallback<Object, Exception> retryCallback = new RetryCallback<Object, Exception>() {
        // RetryContext é‡è¯•æ“ä½œä¸Šä¸‹æ–‡çº¦å®š, ç»Ÿä¸€ spring-try åŒ…è£…
        public Object doWithRetry(RetryContext context) throws Exception {
            System.out.println("do some thing");
            Exception e = uploadToOdps(map);
            System.out.println(context.getRetryCount());
            throw e;// è¿™ä¸ªç‚¹ç‰¹åˆ«æ³¨æ„, é‡è¯•çš„æ ¹æºé€šè¿‡ Exception è¿”å›
        }
    };
    // é€šè¿‡ RecoveryCallback é‡è¯•æµç¨‹æ­£å¸¸ç»“æŸæˆ–è€…è¾¾åˆ°é‡è¯•ä¸Šé™åçš„é€€å‡ºæ¢å¤æ“ä½œå®ä¾‹
    final RecoveryCallback<Object> recoveryCallback = new RecoveryCallback<Object>() {
        public Object recover(RetryContext context) throws Exception {
            System.out.println("do recory operation");
            return null;
        }
    };
    try {
        // ç”± retryTemplate æ‰§è¡Œ execute æ–¹æ³•å¼€å§‹é€»è¾‘æ‰§è¡Œ
        retryTemplate.execute(retryCallback, recoveryCallback);
    } catch (Exception e) {
        e.printStackTrace();
    }
}
```

ç®€å•å‰–æä¸‹æ¡ˆä¾‹ä»£ç , RetryTemplate æ‰¿æ‹…äº†é‡è¯•æ‰§è¡Œè€…çš„è§’è‰², å®ƒå¯ä»¥è®¾ç½® SimpleRetryPolicy(é‡è¯•ç­–ç•¥, è®¾ç½®é‡è¯•ä¸Šé™, é‡è¯•çš„æ ¹æºå®ä½“),
FixedBackOffPolicyï¼ˆå›ºå®šçš„å›é€€ç­–ç•¥, è®¾ç½®æ‰§è¡Œé‡è¯•å›é€€çš„æ—¶é—´é—´éš”ï¼‰. RetryTemplate é€šè¿‡ execute æäº¤æ‰§è¡Œæ“ä½œ, éœ€è¦å‡†å¤‡ RetryCallback å’Œ
RecoveryCallback ä¸¤ä¸ªç±»å®ä¾‹, å‰è€…å¯¹åº”çš„å°±æ˜¯é‡è¯•å›è°ƒé€»è¾‘å®ä¾‹, åŒ…è£…æ­£å¸¸çš„åŠŸèƒ½æ“ä½œ, RecoveryCallback å®ç°çš„æ˜¯æ•´ä¸ªæ‰§è¡Œæ“ä½œç»“æŸçš„æ¢å¤æ“ä½œå®ä¾‹.

RetryTemplate çš„ execute æ˜¯çº¿ç¨‹å®‰å…¨çš„, å®ç°é€»è¾‘ä½¿ç”¨ ThreadLocal ä¿å­˜æ¯ä¸ªæ‰§è¡Œå®ä¾‹çš„ RetryContext æ‰§è¡Œä¸Šä¸‹æ–‡.

pring-retry å·¥å…·è™½èƒ½ä¼˜é›…å®ç°é‡è¯•, ä½†æ˜¯å­˜åœ¨ä¸¤ä¸ªä¸å‹å¥½è®¾è®¡: ä¸€ä¸ªæ˜¯ é‡è¯•å®ä½“é™å®šä¸º Throwable å­ç±», è¯´æ˜é‡è¯•é’ˆå¯¹çš„æ˜¯å¯æ•æ‰çš„åŠŸèƒ½å¼‚å¸¸ä¸ºè®¾è®¡å‰æçš„,
ä½†æ˜¯æˆ‘ä»¬å¸Œæœ›ä¾èµ–æŸä¸ªæ•°æ®å¯¹è±¡å®ä½“ä½œä¸ºé‡è¯•å®ä½“, ä½† Sping-retry æ¡†æ¶å¿…é¡»å¼ºåˆ¶è½¬æ¢ä¸º Throwable å­ç±». å¦ä¸€ä¸ªå°±æ˜¯é‡è¯•æ ¹æºçš„æ–­è¨€å¯¹è±¡ä½¿ç”¨çš„æ˜¯
doWithRetry çš„ Exception å¼‚å¸¸å®ä¾‹, ä¸ç¬¦åˆæ­£å¸¸å†…éƒ¨æ–­è¨€çš„è¿”å›è®¾è®¡.

Spring Retry æå€¡ä»¥æ³¨è§£çš„æ–¹å¼å¯¹æ–¹æ³•è¿›è¡Œé‡è¯•, é‡è¯•é€»è¾‘æ˜¯åŒæ­¥æ‰§è¡Œçš„, é‡è¯•çš„â€œå¤±è´¥â€é’ˆå¯¹çš„æ˜¯ Throwable, å¦‚æœä½ è¦ä»¥è¿”å›å€¼çš„æŸä¸ªçŠ¶æ€æ¥åˆ¤å®šæ˜¯å¦éœ€è¦é‡è¯•,
å¯èƒ½åªèƒ½é€šè¿‡è‡ªå·±åˆ¤æ–­è¿”å›å€¼ç„¶åæ˜¾å¼æŠ›å‡ºå¼‚å¸¸äº†.

## Spring å¯¹äº Retry çš„æŠ½è±¡

â€œæŠ½è±¡â€æ˜¯æ¯ä¸ªç¨‹åºå‘˜å¿…å¤‡çš„ç´ è´¨. å¯¹äºèµ„è´¨å¹³å¹³çš„æˆ‘æ¥è¯´, æ²¡æœ‰æ¯”æ¨¡ä»¿ä¸ç†è§£ä¼˜ç§€æºç æ›´å¥½åœ°è¿›æ­¥é€”å¾„äº†å§. ä¸ºæ­¤, æˆ‘å°†å…¶æ ¸å¿ƒé€»è¾‘é‡å†™äº†ä¸€é... ä¸‹é¢å°±çœ‹çœ‹
Spring Retry å¯¹äºâ€œé‡è¯•â€çš„æŠ½è±¡.

### â€œé‡è¯•â€é€»è¾‘

```java
while(someCondition()) {
    try{
        doSth();
        break;
    } catch(Throwable th) {
        modifyCondition();
        wait();
    }
}
if(stillFail) {
    doSthWhenStillFail();
}
```

åŒæ­¥é‡è¯•ä»£ç åŸºæœ¬å¯ä»¥è¡¨ç¤ºä¸ºä¸Šè¿°, ä½†æ˜¯ Spring Retry å¯¹å…¶è¿›è¡Œäº†éå¸¸ä¼˜é›…åœ°æŠ½è±¡, è™½ç„¶ä¸»è¦é€»è¾‘ä¸å˜, ä½†æ˜¯çœ‹èµ·æ¥å´æ˜¯èˆ’æœå¤šäº†.
ä¸»è¦çš„æ¥å£æŠ½è±¡å¦‚ä¸‹å›¾æ‰€ç¤º:

![20241229154732_4FkeUK8O.webp](https://cdn.dong4j.site/source/image/20241229154732_4FkeUK8O.webp)

- RetryCallback: å°è£…ä½ éœ€è¦é‡è¯•çš„ä¸šåŠ¡é€»è¾‘ï¼ˆä¸Šæ–‡ä¸­çš„ doSthï¼‰
- RecoverCallback: å°è£…åœ¨å¤šæ¬¡é‡è¯•éƒ½å¤±è´¥åä½ éœ€è¦æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘ (ä¸Šæ–‡ä¸­çš„ doSthWhenStillFail)
- RetryContext: é‡è¯•è¯­å¢ƒä¸‹çš„ä¸Šä¸‹æ–‡, å¯ç”¨äºåœ¨å¤šæ¬¡ Retry æˆ–è€… Retry å’Œ Recover ä¹‹é—´ä¼ é€’å‚æ•°æˆ–çŠ¶æ€ï¼ˆåœ¨å¤šæ¬¡ doSth æˆ–è€… doSth ä¸
  doSthWhenStillFail ä¹‹é—´ä¼ é€’å‚æ•°ï¼‰
- RetryOperations : å®šä¹‰äº†â€œé‡è¯•â€çš„åŸºæœ¬æ¡†æ¶ï¼ˆæ¨¡æ¿ï¼‰, è¦æ±‚ä¼ å…¥ RetryCallback, å¯é€‰ä¼ å…¥ RecoveryCallbackï¼›
- RetryListener: å…¸å‹çš„â€œç›‘å¬è€…â€, åœ¨é‡è¯•çš„ä¸åŒé˜¶æ®µé€šçŸ¥â€œç›‘å¬è€…â€ï¼ˆä¾‹å¦‚ doSth, wait ç­‰é˜¶æ®µæ—¶é€šçŸ¥ï¼‰
- RetryPolicy : é‡è¯•çš„ç­–ç•¥æˆ–æ¡ä»¶, å¯ä»¥ç®€å•çš„è¿›è¡Œå¤šæ¬¡é‡è¯•, å¯ä»¥æ˜¯æŒ‡å®šè¶…æ—¶æ—¶é—´è¿›è¡Œé‡è¯•ï¼ˆä¸Šæ–‡ä¸­çš„ someConditionï¼‰
- BackOffPolicy: é‡è¯•çš„å›é€€ç­–ç•¥, åœ¨ä¸šåŠ¡é€»è¾‘æ‰§è¡Œå‘ç”Ÿå¼‚å¸¸æ—¶. å¦‚æœéœ€è¦é‡è¯•, æˆ‘ä»¬å¯èƒ½éœ€è¦ç­‰ä¸€æ®µæ—¶é—´ (å¯èƒ½æœåŠ¡å™¨è¿‡äºç¹å¿™,
  å¦‚æœä¸€ç›´ä¸é—´éš”é‡è¯•å¯èƒ½æ‹–å®æœåŠ¡å™¨), å½“ç„¶è¿™æ®µæ—¶é—´å¯ä»¥æ˜¯ 0, ä¹Ÿå¯ä»¥æ˜¯å›ºå®šçš„, å¯ä»¥æ˜¯éšæœºçš„ï¼ˆå‚è§ tcp çš„æ‹¥å¡æ§åˆ¶ç®—æ³•ä¸­çš„å›é€€ç­–ç•¥ï¼‰. å›é€€ç­–ç•¥åœ¨ä¸Šæ–‡ä¸­ä½“ç°ä¸º
  wait()ï¼›
- RetryTemplate :RetryOperations çš„å…·ä½“å®ç°, ç»„åˆäº† RetryListener[], BackOffPolicy, RetryPolicy.

### å°è¯•æ–¹æ¡ˆä¸‰: guava-retryer åˆ†ç¦»æ­£å¸¸å’Œé‡è¯•é€»è¾‘

Guava retryer å·¥å…·ä¸ spring-retry ç±»ä¼¼, éƒ½æ˜¯é€šè¿‡å®šä¹‰é‡è¯•è€…è§’è‰²æ¥åŒ…è£…æ­£å¸¸é€»è¾‘é‡è¯•, ä½†æ˜¯ Guava retryer æœ‰æ›´ä¼˜çš„ç­–ç•¥å®šä¹‰, åœ¨æ”¯æŒé‡è¯•æ¬¡æ•°å’Œé‡è¯•é¢‘åº¦æ§åˆ¶åŸºç¡€ä¸Š,
èƒ½å¤Ÿå…¼å®¹æ”¯æŒå¤šä¸ªå¼‚å¸¸æˆ–è€…è‡ªå®šä¹‰å®ä½“å¯¹è±¡çš„é‡è¯•æºå®šä¹‰, è®©é‡è¯•åŠŸèƒ½æœ‰æ›´å¤šçš„çµæ´»æ€§. Guava Retryer ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„,
å…¥å£è°ƒç”¨é€»è¾‘é‡‡ç”¨çš„æ˜¯ [Java](http://lib.csdn.net/base/javase "Java SEçŸ¥è¯†åº“").util.concurrent.Callable çš„ call æ–¹æ³•, ç¤ºä¾‹ä»£ç å¦‚ä¸‹:

```java
public void uploadOdps(final Map<String, Object> map) {
    // RetryerBuilder æ„å»ºé‡è¯•å®ä¾‹ retryer, å¯ä»¥è®¾ç½®é‡è¯•æºä¸”å¯ä»¥æ”¯æŒå¤šä¸ªé‡è¯•æº, å¯ä»¥é…ç½®é‡è¯•æ¬¡æ•°æˆ–é‡è¯•è¶…æ—¶æ—¶é—´, ä»¥åŠå¯ä»¥é…ç½®ç­‰å¾…æ—¶é—´é—´éš”
    Retryer<Boolean> retryer = RetryerBuilder.<Boolean> newBuilder()
            .retryIfException().// è®¾ç½®å¼‚å¸¸é‡è¯•æº
            retryIfResult(new Predicate<Boolean>() {// è®¾ç½®è‡ªå®šä¹‰æ®µå…ƒé‡è¯•æº,
        @Override
        public boolean apply(Boolean state) {// ç‰¹åˆ«æ³¨æ„: è¿™ä¸ª apply è¿”å› true è¯´æ˜éœ€è¦é‡è¯•, ä¸æ“ä½œé€»è¾‘çš„è¯­ä¹‰è¦åŒºåˆ†
            return true;
        }
    })
    .withStopStrategy(StopStrategies.stopAfterAttempt(5))// è®¾ç½®é‡è¯• 5 æ¬¡, åŒæ ·å¯ä»¥è®¾ç½®é‡è¯•è¶…æ—¶æ—¶é—´
    .withWaitStrategy(WaitStrategies.fixedWait(100L, TimeUnit.MILLISECONDS)).build();// è®¾ç½®æ¯æ¬¡é‡è¯•é—´éš”

    try {
        // é‡è¯•å…¥å£é‡‡ç”¨ call æ–¹æ³•, ç”¨çš„æ˜¯ java.util.concurrent.Callable<V> çš„ call æ–¹æ³•, æ‰€ä»¥æ‰§è¡Œæ˜¯çº¿ç¨‹å®‰å…¨çš„
        boolean result = retryer.call(new Callable<Boolean>() {
            @Override
            public Boolean call() throws Exception {
                try {
                    // ç‰¹åˆ«æ³¨æ„: è¿”å› false è¯´æ˜æ— éœ€é‡è¯•, è¿”å› true è¯´æ˜éœ€è¦ç»§ç»­é‡è¯•
                    return uploadToOdps(map);
                } catch (Exception e) {
                    throw new Exception(e);
                }
            }
        });

    } catch (ExecutionException e) {
    } catch (RetryException ex) {
    }
}
```

ç¤ºä¾‹ä»£ç åŸç†åˆ†æ:

RetryerBuilder æ˜¯ä¸€ä¸ª factory åˆ›å»ºè€…, å¯ä»¥å®šåˆ¶è®¾ç½®é‡è¯•æºä¸”å¯ä»¥æ”¯æŒå¤šä¸ªé‡è¯•æº, å¯ä»¥é…ç½®é‡è¯•æ¬¡æ•°æˆ–é‡è¯•è¶…æ—¶æ—¶é—´, ä»¥åŠå¯ä»¥é…ç½®ç­‰å¾…æ—¶é—´é—´éš”,
åˆ›å»ºé‡è¯•è€… Retryer å®ä¾‹.

RetryerBuilder çš„é‡è¯•æºæ”¯æŒ Exception å¼‚å¸¸å¯¹è±¡ å’Œè‡ªå®šä¹‰æ–­è¨€å¯¹è±¡, é€šè¿‡ retryIfException å’Œ retryIfResult è®¾ç½®, åŒæ—¶æ”¯æŒå¤šä¸ªä¸”èƒ½å…¼å®¹.

RetryerBuilder çš„ç­‰å¾…æ—¶é—´å’Œé‡è¯•é™åˆ¶é…ç½®é‡‡ç”¨ä¸åŒçš„ç­–ç•¥ç±»å®ç°, åŒæ—¶å¯¹äºç­‰å¾…æ—¶é—´ç‰¹å¾å¯ä»¥æ”¯æŒæ— é—´éš”å’Œå›ºå®šé—´éš”æ–¹å¼.

Retryer æ˜¯é‡è¯•è€…å®ä¾‹, é€šè¿‡ call æ–¹æ³•æ‰§è¡Œæ“ä½œé€»è¾‘, åŒæ—¶å°è£…é‡è¯•æºæ“ä½œ.

## ä¼˜é›…é‡è¯•å…±æ€§å’ŒåŸç†

1. æ­£å¸¸å’Œé‡è¯•ä¼˜é›…è§£è€¦, é‡è¯•æ–­è¨€æ¡ä»¶å®ä¾‹æˆ–é€»è¾‘å¼‚å¸¸å®ä¾‹æ˜¯ä¸¤è€…æ²Ÿé€šçš„åª’ä»‹.
2. çº¦å®šé‡è¯•é—´éš”, å·®å¼‚æ€§é‡è¯•ç­–ç•¥, è®¾ç½®é‡è¯•è¶…æ—¶æ—¶é—´, è¿›ä¸€æ­¥ä¿è¯é‡è¯•æœ‰æ•ˆæ€§ä»¥åŠé‡è¯•æµç¨‹ç¨³å®šæ€§.
3. éƒ½ä½¿ç”¨äº†å‘½ä»¤è®¾è®¡æ¨¡å¼, é€šè¿‡å§”æ‰˜é‡è¯•å¯¹è±¡å®Œæˆç›¸åº”çš„é€»è¾‘æ“ä½œ, åŒæ—¶å†…éƒ¨å°è£…å®ç°é‡è¯•é€»è¾‘.
4. Spring-tryer å’Œ guava-tryer å·¥å…·éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„é‡è¯•, èƒ½å¤Ÿæ”¯æŒå¹¶å‘ä¸šåŠ¡åœºæ™¯çš„é‡è¯•é€»è¾‘æ­£ç¡®æ€§.

## ä¼˜é›…é‡è¯•é€‚ç”¨åœºæ™¯

1. åŠŸèƒ½é€»è¾‘ä¸­å­˜åœ¨ä¸ç¨³å®šä¾èµ–åœºæ™¯, éœ€è¦ä½¿ç”¨é‡è¯•è·å–é¢„æœŸç»“æœæˆ–è€…å°è¯•é‡æ–°æ‰§è¡Œé€»è¾‘ä¸ç«‹å³ç»“æŸ. æ¯”å¦‚è¿œç¨‹æ¥å£è®¿é—®, æ•°æ®åŠ è½½è®¿é—®, æ•°æ®ä¸Šä¼ æ ¡éªŒç­‰ç­‰.
2. å¯¹äºå¼‚å¸¸åœºæ™¯å­˜åœ¨éœ€è¦é‡è¯•åœºæ™¯, åŒæ—¶å¸Œæœ›æŠŠæ­£å¸¸é€»è¾‘å’Œé‡è¯•é€»è¾‘è§£è€¦.
3. å¯¹äºéœ€è¦åŸºäºæ•°æ®åª’ä»‹äº¤äº’, å¸Œæœ›é€šè¿‡é‡è¯•è½®è¯¢æ£€æµ‹æ‰§è¡Œé€»è¾‘åœºæ™¯ä¹Ÿå¯ä»¥è€ƒè™‘é‡è¯•æ–¹æ¡ˆ.

## [å®šåˆ¶ä½ çš„Spring Bootï¼šæ¢ç´¢maven-assembly-plugin](https://blog.dong4j.site/posts/d16c10eb.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## fat jar

## tomcat

## è‡ªå®šä¹‰æ‰“åŒ…éƒ¨ç½² æš´éœ²é…ç½®æ–‡ä»¶å’Œé™æ€èµ„æºæ–‡ä»¶

### å‰è¨€

SpringBoot é»˜è®¤æœ‰ 2 ç§æ‰“åŒ…æ–¹å¼ï¼Œä¸€ç§æ˜¯ç›´æ¥æ‰“æˆ jar åŒ…ï¼Œç›´æ¥ä½¿ç”¨ java -jar è·‘èµ·æ¥ï¼Œå¦ä¸€ç§æ˜¯æ‰“æˆ war åŒ…ï¼Œç§»é™¤æ‰ web starter é‡Œçš„å®¹å™¨ä¾èµ–ï¼Œç„¶åä¸¢åˆ°å¤–éƒ¨å®¹å™¨è·‘èµ·æ¥ã€‚

ç¬¬ä¸€ç§æ–¹å¼çš„ç¼ºç‚¹æ˜¯æ•´ä¸ªé¡¹ç›®ä½œä¸ºä¸€ä¸ª jarï¼Œéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒä¸­ä¸€æ—¦æœ‰é…ç½®æ–‡ä»¶éœ€è¦ä¿®æ”¹ï¼Œåˆ™è¿‡ç¨‹æ¯”è¾ƒéº»çƒ¦  
linux ä¸‹å¯ä»¥ä½¿ç”¨ vim jar åŒ…ï¼Œæ‰¾åˆ°é…ç½®æ–‡ä»¶ä¿®æ”¹åå†ä¿å­˜  
window ä¸‹éœ€è¦ä½¿ç”¨ è§£å‹ç¼©è½¯ä»¶æ‰“å¼€ jar å†æ‰¾åˆ°é…ç½®æ–‡ä»¶ï¼Œä¿®æ”¹åæ›¿æ¢æ›´æ–°

ç¬¬äºŒç§æ–¹å¼çš„ç¼ºç‚¹æ˜¯éœ€è¦ä¾èµ–å¤–éƒ¨å®¹å™¨ï¼Œè¿™æ— éå¤šå¼•å…¥äº†ä¸€éƒ¨åˆ†ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¾ˆä¸æƒ…æ„¿è¿™ä¹ˆåš

> spring boot é¡¹ç›®å¯åŠ¨æ—¶ æŒ‡å®šé…ç½®æœ‰ 2 ç§æ–¹å¼ï¼šä¸€ç§æ˜¯å¯åŠ¨æ—¶ä¿®æ”¹é…ç½®å‚æ•°ï¼Œåƒ java -jar xxxx.jar â€“server.port=8081 è¿™æ ·ï¼›å¦å¤–ä¸€ç§æ˜¯ æŒ‡å®šå¤–éƒ¨é…ç½®æ–‡ä»¶åŠ è½½ï¼Œåƒ java -jar xxxx.jar -Dspring.config.location=applixxx.yml è¿™æ ·

### ç›®æ ‡

æˆ‘ä»¬å¸Œæœ›æ‰“åŒ…æˆ tomcat æˆ–è€… maven é‚£æ ·çš„è½¯ä»¶åŒ…ç»“æ„ï¼Œå³

```
--- bin
    --- start.sh
    --- stop.sh
    --- restart.sh
    --- start.bat
    --- stop.bat
    --- restart.bat
--- boot
    --- xxxx.jar
--- lib
--- conf
--- logs
--- README.md
--- LICENSE
```

- `bin`Â  ç›®å½•æ”¾ä¸€äº›æˆ‘ä»¬ç¨‹åºçš„å¯åŠ¨åœæ­¢è„šæœ¬
- `boot`Â  ç›®å½•æ”¾æˆ‘ä»¬è‡ªå·±çš„ç¨‹åºåŒ…
- `lib`Â  ç›®å½•æ˜¯æˆ‘ä»¬ç¨‹åºçš„ä¾èµ–åŒ…
- `conf`Â  ç›®å½•æ˜¯é¡¹ç›®çš„é…ç½®æ–‡ä»¶
- `logs`Â  ç›®å½•æ˜¯ç¨‹åºè¿è¡Œæ—¶çš„æ—¥å¿—æ–‡ä»¶
- `README.md`Â  ä½¿ç”¨è¯´æ˜
- `LICENSE`Â  è®¸å¯è¯´æ˜

### å‡†å¤‡

- maven-jar-plugin ï¼š æ‰“åŒ…æˆ‘ä»¬å†™çš„ç¨‹åºåŒ…å’Œæ‰€éœ€çš„ä¾èµ–åŒ…ï¼Œå¹¶æŒ‡å®šå…¥å£ç±»ï¼Œä¾èµ–åŒ…è·¯å¾„å’Œ classpath è·¯å¾„ï¼Œå…¶å®å°±æ˜¯åœ¨ MANIFEST.MF è¿™ä¸ªæ–‡ä»¶å†™å…¥ç›¸åº”çš„é…ç½®
- maven-assembly-plugin ï¼š è‡ªå®šä¹‰æˆ‘ä»¬æ‰“åŒ…çš„æ–‡ä»¶ç›®å½•çš„æ ¼å¼

### pom.xml é…ç½®

```xml
<build>
    <plugins>
        <!--<plugin>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-maven-plugin</artifactId>
            <configuration>
                <fork>true</fork>
            </configuration>
        </plugin>-->

        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-jar-plugin</artifactId>
            <configuration>
                <archive>
                    <addMavenDescriptor>false</addMavenDescriptor>
                    <manifest>
                        <mainClass>com.ahtsoft.AhtsoftBigdataWebApplication</mainClass>
                        <addClasspath>true</addClasspath>
                        <classpathPrefix>../lib/</classpathPrefix>
                    </manifest>
                    <manifestEntries>
                        <Class-Path>../conf/resources/</Class-Path>
                    </manifestEntries>
                </archive>
                <excludes>
                    <exclude>static/**</exclude>
                    <exclude>*.yml</exclude>
                </excludes>
            </configuration>
        </plugin>
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-assembly-plugin</artifactId>
            <configuration>
                <descriptors>
                    <descriptor>src/main/assembly/assembly.xml</descriptor>
                </descriptors>
            </configuration>
            <executions>
                <execution>
                    <phase>package</phase>
                    <goals>
                        <goal>single</goal>
                    </goals>
                </execution>
            </executions>
        </plugin>
    </plugins>
</build>
```

1. å°† spring boot é»˜è®¤çš„æ‰“åŒ…æ–¹å¼ spring-boot-maven-plugin å»æ‰ï¼Œä½¿ç”¨ç°åœ¨çš„æ‰“åŒ…æ–¹å¼
2. maven-jar-plugin é…ç½®ä¸­ï¼Œåˆ¶å®šäº†å…¥å£ç±»ï¼ŒaddClasspath é…ç½®å°†æ‰€éœ€çš„ä¾èµ–åŒ…å•ç‹¬æ‰“åŒ…ï¼Œä¾èµ–åŒ…æ‰“çš„ä½ç½®åœ¨ lib ç›®å½•åº•ä¸‹ï¼Œåœ¨ MANIFEST.MF è¿™ä¸ªæ–‡ä»¶å†™å…¥ç›¸åº”çš„é…ç½®
3. é…ç½®äº† classpath åœ¨ /conf/resources/ ,è¿™ä¸ªå’Œåé¢çš„ assembly.xml è¦ç›¸å¯¹åº”
4. æˆ‘å•ç‹¬æŠŠ spring boot çš„é…ç½®æ–‡ä»¶ yml æ–‡ä»¶ å’Œ é™æ€èµ„æºç›®å½• static å•ç‹¬æ‹äº†å‡ºæ¥ï¼Œåœ¨æˆ‘ä»¬çš„æºç åŒ…ä¸­å¹¶æ²¡æœ‰æ‰“è¿›å»ï¼Œè€Œæ˜¯äº¤ç»™ assembly.xml æ¥å•ç‹¬æ‰“åˆ°ä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶ conf æ–‡ä»¶ä¸‹
5. è¿™ä¹Ÿæ˜¯ç…§åº”äº† å‰é¢ä¸ºä»€ä¹ˆè¦è®¾ç½® classpath ä¸º /conf/resources/

ä¸‹é¢é‡è¦çš„æ˜¯ assembly.xml é…ç½®æ–‡ä»¶äº†ï¼Œè¿™ä¸ªæ–‡ä»¶æ‰æ˜¯æŠŠæˆ‘ä»¬çš„ç¨‹åºæ‰“æˆæ ‡å‡†çš„ç›®å½•ç»“æ„

### assembly.xml

```xml
<assembly>
    <id>assembly</id>
    <formats>
        <format>tar.gz</format>
    </formats>
    <baseDirectory>${project.artifactId}-${project.version}/</baseDirectory>

    <files>
        <file>
            <source>target/${project.artifactId}-${project.version}.jar</source>
            <outputDirectory>boot/</outputDirectory>
            <destName>${project.artifactId}-${project.version}.jar</destName>
        </file>
    </files>

    <fileSets>
        <fileSet>
            <directory>./</directory>
            <outputDirectory>./</outputDirectory>
            <includes>
                <include>*.txt</include>
                <include>*.md</include>
            </includes>
        </fileSet>
        <fileSet>
            <directory>src/main/bin</directory>
            <outputDirectory>bin/</outputDirectory>
            <includes>
                <include>*.sh</include>
                <include>*.cmd</include>
            </includes>
            <fileMode>0755</fileMode>
        </fileSet>
        <fileSet>
            <directory>src/main/resources/static</directory>
            <outputDirectory>conf/resources/static/</outputDirectory>
            <includes>
                <include>*</include>
            </includes>
        </fileSet>
        <fileSet>
            <directory>src/main/resources</directory>
            <outputDirectory>conf/resources</outputDirectory>
            <includes>
                <include>*.properties</include>
                <include>*.conf</include>
                <include>*.yml</include>
            </includes>
        </fileSet>
    </fileSets>

    <dependencySets>
        <dependencySet>
            <useProjectArtifact>true</useProjectArtifact>
            <outputDirectory>lib</outputDirectory>
            <scope>runtime</scope>
            <includes>
                <include>*:*</include>
            </includes>
            <excludes>
                <exclude>${groupId}:${artifactId}</exclude>
                <exclude>org.springframework.boot:spring-boot-devtools</exclude>
            </excludes>
        </dependencySet>
    </dependencySets>
</assembly>

```

- å°†æœ€ç»ˆçš„ç¨‹åºåŒ…æ‰“æˆ tar.gz ,å½“ç„¶ä¹Ÿå¯ä»¥æ‰“æˆå…¶ä»–çš„æ ¼å¼å¦‚ zip,rar ç­‰ï¼ŒfileSets é‡Œé¢æŒ‡å®šæˆ‘ä»¬æºç é‡Œçš„æ–‡ä»¶å’Œè·¯å¾„æ‰“æˆæ ‡å‡†åŒ…ç›¸å¯¹åº”çš„ç›®å½•
- éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æœ€ç»ˆçš„ä¾èµ–åº“ lib ä¸‹ å»æ‰æˆ‘ä»¬çš„ç¨‹åºå’Œå¼€å‘æ—¶ spring boot çš„çƒ­éƒ¨ç½²ä¾èµ– spring-boot-devtoolsï¼Œå¦åˆ™çš„ä¼šå‡ºé—®é¢˜
- ä»£ç é‡Œçš„å¯åŠ¨å’Œåœæ­¢è„šæœ¬è¦èµ‹äºˆæƒé™ï¼Œå¦åˆ™åœ¨æ‰§è¡Œçš„æ—¶å€™å¯èƒ½æç¤ºæƒé™çš„é—®é¢˜

## jar å¯åŠ¨åˆ†ç¦»ä¾èµ– lib å’Œé…ç½®

### å‰è¨€

- å…ˆå‰å‘å¸ƒ boot é¡¹ç›®çš„æ—¶å€™ï¼Œæ”¹åŠ¨ä¸€ç‚¹ä¸œè¥¿ï¼Œå°±éœ€è¦å°†æ•´ä¸ªé¡¹ç›®é‡æ–°æ‰“åŒ…éƒ¨ç½²ï¼Œååˆ†ä¸ä¾¿ï¼Œæ•…æŠŠä¾èµ– lib ä»é¡¹ç›®åˆ†ç¦»å‡ºæ¥ï¼Œæ¯æ¬¡éƒ¨ç½²åªéœ€è¦å‘å¸ƒä»£ç å³å¯ã€‚

### åŠè‡ªåŠ¨åŒ–æ­¥éª¤

#### 1. æ›´æ¢ maven çš„ jar æ‰“åŒ…æ’ä»¶

- å…ˆå‰ä½¿ç”¨çš„æ˜¯ spring-boot-maven-plugin æ¥æ‰“åŒ…
  - è¿™ä¸ªæ’ä»¶ä¼šå°†é¡¹ç›®æ‰€æœ‰çš„ä¾èµ–æ‰“å…¥ BOOT-INF/lib ä¸‹
- æ›¿æ¢ä¸º maven-jar-plugin
- addClasspath è¡¨ç¤ºéœ€è¦åŠ å…¥åˆ°ç±»æ„å»ºè·¯å¾„
- classpathPrefix æŒ‡å®šç”Ÿæˆçš„ Manifest æ–‡ä»¶ä¸­ Class-Path ä¾èµ– lib å‰é¢éƒ½åŠ ä¸Šè·¯å¾„,æ„å»ºå‡º lib/xx.jar

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-jar-plugin</artifactId>
    <version>${maven.jar.plugin.version}</version>
    <configuration>
        <archive>
            <manifest>
                <addClasspath>true</addClasspath>
                <classpathPrefix>lib/</classpathPrefix>
                <mainClass>com.xxx.Start</mainClass>
            </manifest>
        </archive>
    </configuration>
</plugin>
```

#### 2. æ‹·è´ä¾èµ–åˆ° jar å¤–é¢çš„ lib ç›®å½•

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-dependency-plugin</artifactId>
    <version>${maven.dependency.plugin.version}</version>
    <executions>
        <execution>
            <id>copy-lib</id>
            <phase>prepare-package</phase>
            <goals>
                <goal>copy-dependencies</goal>
            </goals>
            <configuration>
                <outputDirectory>${project.build.directory}/lib</outputDirectory>
                <overWriteReleases>false</overWriteReleases>
                <overWriteSnapshots>false</overWriteSnapshots>
                <overWriteIfNewer>true</overWriteIfNewer>
                <includeScope>compile</includeScope>
            </configuration>
        </execution>
    </executions>
</plugin>
```

#### 3. åœ¨å’Œ jar åŒ…åŒçº§çš„ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª config ç›®å½•ï¼Œæ”¾å…¥ application.yml æ–‡ä»¶

- è¿™é‡Œå¯èƒ½æœ‰å°ä¼™ä¼´æœ‰ç–‘é—®äº†ï¼Œæ‰“åŒ…çš„ jar é‡Œé¢ä¸æ˜¯åº”è¯¥æœ‰ application.yml æ–‡ä»¶å—ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆå†æ”¾ä¸€ä»½ï¼Ÿ
  - è¿™æ˜¯å› ä¸º boot è¯»å–é…ç½®æœ‰ä¸€ä¸ªä¼˜å…ˆçº§ï¼Œæ”¾åœ¨ jar åŒ…å¤–é¢ config ç›®å½•ä¼˜å…ˆçº§æœ€é«˜ï¼Œä¸»è¦æ˜¯ä¾¿äºä»å¤–éƒ¨ä¿®æ”¹é…ç½®ï¼Œè€Œä¸æ˜¯æ”¹ jar åŒ…ä¸­çš„ application.yml æ–‡ä»¶ã€‚ä¼˜å…ˆçº§å¦‚ä¸‹ï¼š
    - å½“å‰ç›®å½•çš„ config ç›®å½•ä¸‹
    - å½“å‰ç›®å½•
    - classpath çš„ config ç›®å½•ä¸‹
    - classpath çš„æ ¹ç›®å½•

#### 4. æ³¨æ„ä¸€ä¸ªä¾èµ–çš„å‘ï¼Œ

- ç¬”è€…å¤šæ¬¡é€šè¿‡ java -jar çš„æ–¹å¼å¯åŠ¨é¡¹ç›®æ€»æ˜¯æŠ¥å¦‚ä¸‹é”™è¯¯ï¼š

```
ClassNotFoundException: org.springframework.boot.SpringApplication
```

- åæ¥å‘ç°æ—¶ä¸€ä¸ªä¾èµ–çš„é—®é¢˜ï¼Œé—®é¢˜è¯¦æƒ…å¯ä»¥è§è¿™ä¸ªåšå®¢ï¼š  
   -[SpringBoot ä½¿ç”¨ yaml ä½œä¸ºé…ç½®æ–‡ä»¶ä¹‹å‘](https://my.oschina.net/bfleeee/blog/879209)

```xml
<dependency>
    <groupId>org.yaml</groupId>
    <artifactId>snakeyaml</artifactId>
    <version>1.21</version>
</dependency>
```

#### 5. æ„‰å¿«çš„å¯åŠ¨é¡¹ç›®

- åŠ å…¥â€“debug å¯ä»¥è®©ä½ å¯ä»¥çœ‹åˆ°æ¯”è¾ƒè¯¦ç»†çš„å¯åŠ¨æ—¥å¿—

```
java -jar xxx-1.0.0.jar --debug
```

### å…¨è‡ªåŠ¨åŒ–æ­¥éª¤

- å‰é¢ä»‹ç»çš„æ­¥éª¤ä¸­ï¼Œéœ€è¦æ‰‹åŠ¨çš„æ‹·è´ application.yml æ–‡ä»¶ï¼Œå¹¶ä¸” jar åŒ…å†…å¤–éƒ½å­˜åœ¨é…ç½®ï¼Œæ€»æ„Ÿè§‰æ€ªæ€ªçš„ï¼ˆå·ç¬‘â€¦ï¼‰ã€‚è¿™é‡Œå¼•å…¥ä¸€ç§è‡ªåŠ¨åŒ–é…ç½®ï¼Œå°†æ‰€æœ‰ä¸œè¥¿æ‰“æˆ zip æ–‡ä»¶ï¼Œç›´æ¥å‘å¸ƒåˆ°æœåŠ¡ç›®å½•ï¼Œè§£å‹åï¼Œå³å¯å¯åŠ¨ã€‚

#### è‡ªåŠ¨åŒ–æ­¥éª¤ 1

- è¿˜æ˜¯åŒä¸Šé¢æ­¥éª¤ 1ï¼Œ2 æ‰€ç¤ºï¼ŒæŒ‡å®šæ‰“åŒ…æ’ä»¶å’Œæ‹·è´ä¾èµ–çš„æ’ä»¶ã€‚

#### è‡ªåŠ¨åŒ–æ­¥éª¤ 2

- æ’é™¤ resources ä¸‹é¢çš„ yml(å› ä¸ºæˆ‘ä»¬éœ€è¦æŠŠå®ƒæ”¾åœ¨ jar å¤–éƒ¨,ä¸èƒ½è®© jar æ‰“åŒ…æ’ä»¶å°†å…¶æ‰“å…¥ jar åŒ… classpath ä¸‹å»)

```xml
<resources>
    <resource>
        <directory>src/main/resources</directory>
        <excludes>
            <exclude>**/application.yml</exclude>
        </excludes>
    </resource>
</resources>
```

#### è‡ªåŠ¨åŒ–æ­¥éª¤ 3ï¼Œä½¿ç”¨ maven-assembly-plugin è‡ªå®šä¹‰æ‰“åŒ…

- å…·ä½“æ‰“åŒ…è¯¦æƒ…åœ¨ assembly.xml é…ç½®ä¸­æŒ‡å®š

```xml
<plugin>
    <artifactId>maven-assembly-plugin</artifactId>
    <configuration>
        <appendAssemblyId>false</appendAssemblyId>
        <descriptors>
            <descriptor>src/main/resources/assembly.xml</descriptor>
        </descriptors>
    </configuration>
    <executions>
        <execution>
            <id>make-assembly</id>
            <phase>package</phase>
            <goals>
                <goal>single</goal>
            </goals>
        </execution>
    </executions>
</plugin>
```

- assembly.xml å…·ä½“é…ç½®å¦‚ä¸‹ï¼š
- å°† application.yml æ”¾åœ¨å¤–éƒ¨ config ç›®å½•ä¸‹
- æ‰€æœ‰ä¾èµ–æ‰“æˆ zip å‹ç¼©åŒ…

```xml
<assembly xmlns="http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.3"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.3 http://maven.apache.org/xsd/assembly-1.1.3.xsd">
<id>package</id>
<formats>
    <format>zip</format>
</formats>
<includeBaseDirectory>true</includeBaseDirectory>
<fileSets>
    <fileSet>
        <directory>${basedir}/src/main/resources</directory>
        <includes>
            <include>*.yml</include>
        </includes>
        <filtered>true</filtered>
        <outputDirectory>${file.separator}config</outputDirectory>
    </fileSet>

    <fileSet>
        <directory>src/main/resources/runScript</directory>
        <outputDirectory>${file.separator}bin</outputDirectory>
    </fileSet>
    <fileSet>
        <directory>${project.build.directory}/lib</directory>
        <outputDirectory>${file.separator}lib</outputDirectory>
        <includes>
            <include>*.jar</include>
        </includes>
    </fileSet>
    <fileSet>
        <directory>${project.build.directory}</directory>
        <outputDirectory>${file.separator}</outputDirectory>
        <includes>
            <include>*.jar</include>
        </includes>
    </fileSet>
</fileSets>
</assembly>
```

#### è‡ªåŠ¨åŒ–æ­¥éª¤ 4ï¼Œè§£å‹ zipï¼Œå¯åŠ¨

- ç¾æ»‹æ»‹çš„è‡ªåŠ¨åŒ–

## [Javaæ‰“åŒ…è¿›åŒ–è®ºï¼šMaven Jarçš„å¤šç§æ‰“åŒ…æ–¹å¼å¤§æ­ç§˜](https://blog.dong4j.site/posts/79fceeeb.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## æ— ä¾èµ–å…¶ä»–ä»»ä½• jar

```xml
<build>
    <plugins>
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-jar-plugin</artifactId>
            <version>2.4</version>
            <configuration>
                <archive>
                    <manifest>
                        <addClasspath>true</addClasspath>
                        <classpathPrefix>lib/</classpathPrefix>
                        <mainClass>com.think.TestMain</mainClass>
                    </manifest>
                </archive>
            </configuration>
        </plugin>
    </plugins>
</build>
```

è¿è¡Œï¼šmvn clean packageï¼Œåœ¨ target ä¸­æ‰¾åˆ°æ‰“åŒ…å‡ºæ¥çš„ï¼Œå‘½ä»¤åè¿è¡Œ java -jar xxx.jar å³å¯ï¼Œä½†æ˜¯å¦‚æœç¨‹åºæœ‰ä¾èµ–å…¶ä»–åŒ…ï¼Œæ¯”å¦‚ç¨‹åºä¾èµ– jdbc å»æŸ¥è¯¢ dbï¼Œè¿™æ—¶å€™å†æ‰§è¡Œå°±ä¼šå‡ºç°æ‰¾ä¸åˆ° jdbc ä¾èµ–ï¼Œå› ä¸ºæˆ‘ä»¬å¹¶æ²¡æœ‰å°†ä¾èµ–åŒ…æ‰“è¿›å»

## è§£å†³ä¾èµ–å…¶ä»–åŒ…æ—¶ï¼Œå¯æ‰§è¡Œ jar çš„æ‰“åŒ…

```xml
<build>
    <plugins>
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-assembly-plugin</artifactId>
            <version>2.3</version>
            <configuration>
                <appendAssemblyId>false</appendAssemblyId>
                <descriptorRefs>
                    <descriptorRef>jar-with-dependencies</descriptorRef>
                </descriptorRefs>
                <archive>
                    <manifest>
                        <mainClass>com.think.TestMain</mainClass>
                    </manifest>
                </archive>
            </configuration>
            <executions>
                <execution>
                    <id>make-assembly</id>
                    <phase>package</phase>
                    <goals>
                        <goal>assembly</goal>
                    </goals>
                </execution>
            </executions>
        </plugin>
    </plugins>
</build>
```

ä½†ä»¥ä¸Šæ–¹å¼ç”¨çš„æ¯”è¾ƒå°‘ï¼Œå› ä¸ºæˆ‘ä»¬ä¾èµ–çš„ jarï¼Œä¹Ÿä¼šæ‰“è¿›åˆ°æˆ‘ä»¬æœ€ç»ˆç”Ÿæˆçš„ jarï¼Œè¿™æ ·ä¸å¤ªå¥½ï¼Œå‡å¦‚ä½ ç”Ÿæˆçš„ jar è¦ç»™åˆ«äººä½¿ç”¨ï¼Œæœ€å¥½ç»™ä¸€ä¸ªçº¯å‡€çš„ã€‚

ä¸€èˆ¬ç”¨ assembly ä¼šå†ç”¨ä»–å¦å¤–ä¸€ä¸ªåŠŸèƒ½ï¼Œå°†æˆ‘ä»¬çš„ jar å½’æ¡£ï¼Œæ‰“åŒ…æˆä¸€ä¸ª zip

2ã€æ‰“æˆä¸€ä¸ª zip åŒ…ï¼Œå‘å¸ƒé¡¹ç›®çš„æ—¶å€™ï¼Œå°† zip åŒ… copy åˆ°æœåŠ¡å™¨ä¸Šï¼Œç›´æ¥ unzip xxx.zipï¼Œé‡Œé¢åŒ…å«è¦è¿è¡Œåˆ° jar ä»¥åŠä¾èµ–çš„ libï¼Œè¿˜æœ‰é…ç½®çš„ config æ–‡ä»¶ï¼Œå³å¯ç›´æ¥å¯åŠ¨æœåŠ¡

```xml
<build>
    <resources>
        <!-- æ§åˆ¶èµ„æºæ–‡ä»¶çš„æ‹·è´ -->
        <resource>
            <directory>src/main/resources</directory>
            <targetPath>${project.build.directory}/classes</targetPath>
        </resource>
    </resources>
    <plugins>
        <!-- è®¾ç½®æºæ–‡ä»¶ç¼–ç æ–¹å¼ -->
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-compiler-plugin</artifactId>
            <configuration>
                <source>1.6</source>
                <target>1.6</target>
                <encoding>UTF-8</encoding>
            </configuration>
        </plugin>
        <!-- The configuration of maven-jar-plugin -->
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-jar-plugin</artifactId>
            <version>2.4</version>
            <!-- The configuration of the plugin -->
            <configuration>
                <!-- Configuration of the archiver -->
                <archive>

                    <!--
                        ç”Ÿæˆçš„jarä¸­ï¼Œä¸è¦åŒ…å«pom.xmlå’Œpom.propertiesè¿™ä¸¤ä¸ªæ–‡ä»¶
                    -->
                    <addMavenDescriptor>false</addMavenDescriptor>

                    <!-- Manifest specific configuration -->
                    <manifest>
                        <!--
                            æ˜¯å¦è¦æŠŠç¬¬ä¸‰æ–¹jaræ”¾åˆ°manifestçš„classpathä¸­
                        -->
                        <addClasspath>true</addClasspath>
                        <!--
                           ç”Ÿæˆçš„manifestä¸­classpathçš„å‰ç¼€ï¼Œå› ä¸ºè¦æŠŠç¬¬ä¸‰æ–¹jaræ”¾åˆ°libç›®å½•ä¸‹ï¼Œæ‰€ä»¥classpathçš„å‰ç¼€æ˜¯lib/
                       -->
                        <classpathPrefix>lib/</classpathPrefix>
                        <!--
                            åº”ç”¨çš„main class
                        -->
                        <mainClass>com.think.TestMain</mainClass>
                    </manifest>
                </archive>
                <!--
                    è¿‡æ»¤æ‰ä¸å¸Œæœ›åŒ…å«åœ¨jarä¸­çš„æ–‡ä»¶
                -->
                <!--<excludes>-->
                    <!--<exclude>${project.basedir}/xml/*</exclude>-->
                <!--</excludes>-->
            </configuration>
        </plugin>

        <!-- The configuration of maven-assembly-plugin -->
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-assembly-plugin</artifactId>
            <version>2.4</version>
            <!-- The configuration of the plugin -->
            <configuration>
                <!-- Specifies the configuration file of the assembly plugin -->
                <descriptors>
                    <descriptor>src/main/assembly/assembly.xml</descriptor>
                </descriptors>
            </configuration>
            <executions>
                <execution>
                    <id>make-assembly</id>
                    <phase>package</phase>
                    <goals>
                        <goal>single</goal>
                    </goals>
                </execution>
            </executions>
        </plugin>
    </plugins>
</build>
```

è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„æ–‡ä»¶ï¼Œåå­—å¯ä»¥éšä¾¿èµ·ï¼Œæˆ‘ä¸Šé¢ç”¨çš„æ˜¯ src/main/assembly/assembly.xml

```xml
<assembly>
    <id>bin</id>
    <includeBaseDirectory>false</includeBaseDirectory>
    <!-- æœ€ç»ˆæ‰“åŒ…æˆä¸€ä¸ªç”¨äºå‘å¸ƒçš„zipæ–‡ä»¶ -->
    <formats>
        <format>zip</format>
    </formats>

    <!-- Adds dependencies to zip package under lib directory -->
    <dependencySets>
        <dependencySet>
            <!--
               ä¸ä½¿ç”¨é¡¹ç›®çš„artifactï¼Œç¬¬ä¸‰æ–¹jarä¸è¦è§£å‹ï¼Œæ‰“åŒ…è¿›zipæ–‡ä»¶çš„libç›®å½•
           -->
            <useProjectArtifact>false</useProjectArtifact>
            <!--<outputDirectory>lib</outputDirectory>-->
            <unpack>false</unpack>
        </dependencySet>
    </dependencySets>

    <fileSets>
        <!-- æŠŠé¡¹ç›®ç›¸å…³çš„è¯´æ˜æ–‡ä»¶ï¼Œæ‰“åŒ…è¿›zipæ–‡ä»¶çš„æ ¹ç›®å½• -->
        <!--<fileSet>-->
            <!--<directory>${project.basedir}</directory>-->
            <!--<outputDirectory>/</outputDirectory>-->
        <!--</fileSet>-->

        <!-- æŠŠé¡¹ç›®çš„é…ç½®æ–‡ä»¶ï¼Œæ‰“åŒ…è¿›zipæ–‡ä»¶çš„configç›®å½• -->
        <fileSet>
            <directory>${deploy.dir}/classes/</directory>
            <outputDirectory>/conf</outputDirectory>
            <includes>
                <include>*.xml</include>
                <include>*.properties</include>
            </includes>
        </fileSet>
        <!-- æŠŠé¡¹ç›®è‡ªå·±ç¼–è¯‘å‡ºæ¥çš„jaræ–‡ä»¶ï¼Œæ‰“åŒ…è¿›zipæ–‡ä»¶çš„æ ¹ç›®å½• -->
        <fileSet>
            <directory>${project.build.directory}</directory>
            <outputDirectory></outputDirectory>
            <includes>
                <include>*.jar</include>
            </includes>
        </fileSet>
    </fileSets>
</assembly>
```

æœ€ç»ˆæ‰§è¡Œå‘½ä»¤ï¼šmvn clean packageï¼Œå‡ºæ¥çš„æ˜¯è¿™æ ·çš„

![20241229154732_oM5QjCVp.webp](https://cdn.dong4j.site/source/image/20241229154732_oM5QjCVp.webp)

![20241229154732_PqvHi7bi.webp](https://cdn.dong4j.site/source/image/20241229154732_PqvHi7bi.webp)

è§£å‹ zip åŒ…ï¼Œæˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬æƒ³è¦çš„ï¼Œgood

3ã€è¿˜æœ‰ä¸€ç§æ‰“åŒ…æ–¹å¼ï¼Œä¸Šé¢ç›¸å½“äºæŠŠæˆ‘ä»¬æƒ³è¦çš„ä¸œè¥¿æ‰“æˆä¸€ä¸ª zip åŒ…ï¼Œå…¨éƒ¨æ”¾åˆ°ä¸€èµ·ï¼Œçœ‹ç€æ•´æ´å¥½çœ‹ï¼Œä½†æœ‰ç‚¹ç¹çï¼Œæˆ‘ä»¬å…¶å®å¯ä»¥ç”¨å¦å¤–ä¸€ä¸ªæ’ä»¶æ¥å®Œæˆï¼Œä¸æ‰“åŒ…ï¼Œå³çœ‹åˆ°ä¸Šå›¾è§£å‹åçš„æ–‡ä»¶

```xml
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.test</groupId>
    <artifactId>myTestJar</artifactId>
    <version>1.0-SNAPSHOT</version>
    <packaging>jar</packaging>

    <name>myTestJar</name>
    <url>http://maven.apache.org</url>

    <properties>
        <deploy.dir>./target/</deploy.dir>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>

    <dependencies>
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>3.8.1</version>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid</artifactId>
            <version>1.0.9</version>
        </dependency>

        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>5.1.32</version>
        </dependency>
    </dependencies>

    <build>
        <finalName>myTest</finalName>
        <sourceDirectory>src/main/java</sourceDirectory>
        <resources>
            <!-- æ§åˆ¶èµ„æºæ–‡ä»¶çš„æ‹·è´ -->
            <resource>
                <directory>src/main/resources</directory>
                <targetPath>${project.build.directory}</targetPath>
            </resource>
        </resources>
        <plugins>
            <!-- è®¾ç½®æºæ–‡ä»¶ç¼–ç æ–¹å¼ -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <configuration>
                    <defaultLibBundleDir>lib</defaultLibBundleDir>
                    <source>1.6</source>
                    <target>1.6</target>
                    <encoding>UTF-8</encoding>
                </configuration>
            </plugin>
            <!-- æ‰“åŒ…jaræ–‡ä»¶æ—¶ï¼Œé…ç½®manifestæ–‡ä»¶ï¼ŒåŠ å…¥libåŒ…çš„jarä¾èµ– -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-jar-plugin</artifactId>
                <configuration>
                    <archive>
                        <manifest>
                            <addClasspath>true</addClasspath>
                            <classpathPrefix>lib/</classpathPrefix>
                            <mainClass>com.think.TestMain</mainClass>
                        </manifest>
                    </archive>
                </configuration>
            </plugin>
            <!-- æ‹·è´ä¾èµ–çš„jaråŒ…åˆ°libç›®å½• -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-dependency-plugin</artifactId>
                <executions>
                    <execution>
                        <id>copy</id>
                        <phase>package</phase>
                        <goals>
                            <goal>copy-dependencies</goal>
                        </goals>
                        <configuration>
                            <!-- ${project.build.directory}æ˜¯mavenå˜é‡ï¼Œå†…ç½®çš„ï¼Œè¡¨ç¤ºtargetç›®å½•,å¦‚æœä¸å†™ï¼Œå°†åœ¨è·Ÿç›®å½•ä¸‹åˆ›å»º/lib -->
                            <outputDirectory>${project.build.directory}/lib</outputDirectory>
                            <!-- excludeTransitive:æ˜¯å¦ä¸åŒ…å«é—´æ¥ä¾èµ–åŒ…ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¾èµ–Aï¼Œä½†æ˜¯Aåˆä¾èµ–äº†Bï¼Œæˆ‘ä»¬æ˜¯å¦ä¹Ÿè¦æŠŠBæ‰“è¿›å» é»˜è®¤ä¸æ‰“-->
                            <excludeTransitive>true</excludeTransitive>
                            <!-- å¤åˆ¶çš„jaræ–‡ä»¶å»æ‰ç‰ˆæœ¬ä¿¡æ¯ -->
                            <stripVersion>true</stripVersion>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
            <!-- è§£å†³èµ„æºæ–‡ä»¶çš„ç¼–ç é—®é¢˜ -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-resources-plugin</artifactId>
                <version>2.3</version>
                <configuration>
                    <encoding>UTF-8</encoding>
                </configuration>
            </plugin>
            <!-- æ‰“åŒ…sourceæ–‡ä»¶ä¸ºjaræ–‡ä»¶ -->
            <plugin>
                <artifactId>maven-source-plugin</artifactId>
                <version>2.1</version>
                <configuration>
                    <attach>true</attach>
                    <encoding>UTF-8</encoding>
                </configuration>
                <executions>
                    <execution>
                        <phase>compile</phase>
                        <goals>
                            <goal>jar</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>

</project>
```

è¿™é‡Œé‡‡ç”¨çš„æ˜¯ maven-dependency-plugin æ’ä»¶ï¼Œè¿›è¡Œèµ„æºçš„ copyã€‚

4ã€

```xml
<build>
    <resources>
        <resource>
            <targetPath>${project.build.directory}/classes</targetPath>
            <directory>src/main/resources</directory>
            <filtering>true</filtering>
            <includes>
                <include>**/*.xml</include>
            </includes>
        </resource>
    </resources>
    <plugins>
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-compiler-plugin</artifactId>
            <version>3.0</version>
            <configuration>
                <source>1.6</source>
                <target>1.6</target>
                <encoding>UTF-8</encoding>
            </configuration>
        </plugin>
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-shade-plugin</artifactId>
            <version>2.0</version>
            <executions>
                <execution>
                    <phase>package</phase>
                    <goals>
                        <goal>shade</goal>
                    </goals>
                    <configuration>
                        <transformers>
                            <transformer
                                    implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer">
                                <mainClass>com.think.TestMain</mainClass>
                            </transformer>
                            <!--<transformer-->
                                    <!--implementation="org.apache.maven.plugins.shade.resource.AppendingTransformer">-->
                                <!--<resource>applicationContext.xml</resource>-->
                            <!--</transformer>-->
                        </transformers>
                        <shadedArtifactAttached>true</shadedArtifactAttached>
                        <shadedClassifierName>executable</shadedClassifierName>
                    </configuration>
                </execution>
            </executions>
        </plugin>
    </plugins>
</build>
```

è¿™ç§æ–¹å¼æ‰“å‡ºæ¥æ˜¯æŸ”å’Œåˆ°ä¸€èµ·ï¼Œæˆä¸ºä¸€ä¸ª jarï¼Œ

![20241229154732_BzBPvldD.webp](https://cdn.dong4j.site/source/image/20241229154732_BzBPvldD.webp)

å¯ä»¥ç›´æ¥ java -jar xxx.jar è¿è¡Œã€‚

æˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸åŒéœ€è¦æ¥æ‰“åŒ…ï¼Œå¦‚æœæš´éœ²ç»™å¤–é¢ï¼Œå¯ä»¥é‡‡ç”¨ç¬¬ 4 ç§ï¼Œå¦‚æœæ˜¯è‡ªå·±å…¬å¸é¡¹ç›®æ‰“åŒ…ï¼Œå»ºè®® 2ï¼Œ3 ç§ï¼Œå› ä¸ºæœ‰æ—¶å€™åªæ˜¯æ”¹äº†ä¸ªé…ç½®æ–‡ä»¶ï¼Œä¸éœ€è¦æ‰“åŒ…ï¼Œç›´æ¥æŠŠé…ç½®æ–‡ä»¶å¤åˆ¶è¿›å»å³å¯

## [IntelliJ IDEA Gitæ“ä½œæŒ‡å—ï¼šè½»æ¾ç®¡ç†ä»£ç åˆ†æ”¯ä¸åˆå¹¶](https://blog.dong4j.site/posts/22c0ef08.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

åœ¨ IDEA ä¸­æ“ä½œ Git

GitLab ä¸­æœ‰ä¸€ä¸ª git-branch-test çš„é¡¹ç›®

![20241229154732_go0zdZYO.webp](https://cdn.dong4j.site/source/image/20241229154732_go0zdZYO.webp)

å¤„äº master åˆ†æ”¯

æœ¬åœ°é¡¹ç›®ç›®å½•:
![20241229154732_36zcZdNW.webp](https://cdn.dong4j.site/source/image/20241229154732_36zcZdNW.webp)

æ‰€åœ¨åˆ†æ”¯:
![20241229154732_67TDHI3s.webp](https://cdn.dong4j.site/source/image/20241229154732_67TDHI3s.webp)

ä¸€èˆ¬çš„å·¥ä½œæµç¨‹:

1. master ä½œä¸ºä¸»åˆ†æ”¯, ä¸€èˆ¬éƒ½æ˜¯ç”¨æ¥å‘å¸ƒæœ€ç»ˆç‰ˆæœ¬çš„åˆ†æ”¯
2. å½“å®ç°ä¸€ä¸ªæ–°éœ€æ±‚æ—¶, éœ€è¦åˆ›å»ºä¸€ä¸ªåˆ†æ”¯, åœ¨æ–°åˆ›å»ºçš„åˆ†æ”¯ä¸Šè¿›è¡Œå¼€å‘

è¿™æ˜¯å·²ç»å®ç°çš„åŠŸèƒ½, å¹¶ä¸”å·²ç»å‘å¸ƒåˆ° gitlab æœåŠ¡å™¨ä¸Šçš„åˆ†æ”¯ (master):

```java
public class HelloWorld {
    public static void main(String[] args) {
        String s = JOptionPane.showInputDialog("è¯·è¾“å…¥ä¸€ä¸ªæ•´æ•°");
        int a = Integer.parseInt(s);
        System.out.println(a);
        if (isOdd(a))
           System.out.println("å¥‡æ•°");
        else {
            System.out.println("å¶æ•°");
        }
    }

    /**
     * Is odd boolean.
     * æ£€æµ‹å¥‡å¶æ€§
     * @param i the
     * @return the boolean
     */
    public static boolean isOdd(int i) {
        return i % 2 == 1;
    }
}
```

ç°åœ¨æœ‰ä¸€ä¸ªæ–°åŠŸèƒ½éœ€è¦å¼€å‘:
å¢åŠ ä¸€ä¸ªäº¤æ¢ 2 ä¸ªå‚æ•°çš„å€¼çš„æ–¹æ³•

å› ä¸ºæ˜¯æ–°çš„éœ€æ±‚, æˆ‘ä»¬ä¸èƒ½ç›´æ¥åœ¨ master åˆ†æ”¯ä¸Šä¿®æ”¹, å¿…é¡»æ–°å»ºä¸€ä¸ªåˆ†æ”¯, åŠŸèƒ½å®Œæˆåç»è¿‡æµ‹è¯•æ‰èƒ½æ­£å¼æäº¤åˆ°ä¸»åˆ†æ”¯ä¸Š

### æ–°å»ºåˆ†æ”¯

**IDEA è®¾ç½®** ä¸€æ¬¡å°±å¥½

1. è®¾ç½® tasks
   ![20241229154732_A2F91Ijb.webp](https://cdn.dong4j.site/source/image/20241229154732_A2F91Ijb.webp)

token ç™»å½•è‡ªå·±çš„ gitlab è¿›è¡Œç”³è¯·
User Settings --> Access Tokens

è®¾ç½®æˆåŠŸå, IDEA å³ä¸Šè§’ä¼šå‡ºç° task ä¸‹æ‹‰é€‰æ‹©æ¡†

![20241229154732_KKTwZLnE.webp](https://cdn.dong4j.site/source/image/20241229154732_KKTwZLnE.webp)

2. æ–°å»ºåˆ†æ”¯

![20241229154732_ZgMfkZpA.webp](https://cdn.dong4j.site/source/image/20241229154732_ZgMfkZpA.webp)

"ok" ä¹‹å è‡ªåŠ¨åˆ‡æ¢åˆ° sprint1 åˆ†æ”¯

å¼€å§‹æ–°éœ€æ±‚çš„å¼€å‘

```java
public class HelloWorld {
    public static void main(String[] args) {
        String s = JOptionPane.showInputDialog("è¯·è¾“å…¥ä¸€ä¸ªæ•´æ•°");
        int input = Integer.parseInt(s);
        System.out.println(input);
        if (isOdd(input))
           System.out.println("å¥‡æ•°");
        else {
            System.out.println("å¶æ•°");
        }

        Integer[] value = {100,1};
        switchValue(value);
        System.out.println("value[0] = " + value[0] + " \n" + "value[1] = " + value[1]);

    }

    /**
     * Is odd boolean.
     * æ£€æµ‹å¥‡å¶æ€§
     * @param i the
     * @return the boolean
     */
    public static boolean isOdd(int i) {
        return i % 2 == 1;
    }

    /**
     * Switch value.
     * äº¤æ¢å€¼
     * @param value the value
     */
    public static void switchValue(Integer[] value){
        // todo æœªå®Œæˆ
    }
}
```

å‡è®¾æ­¤æ—¶ï¼Œä½ çªç„¶æ¥åˆ°ä¸€ä¸ªç”µè¯è¯´æœ‰ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜éœ€è¦ç´§æ€¥ä¿®è¡¥ï¼Œé‚£ä¹ˆå¯ä»¥æŒ‰ç…§ä¸‹é¢çš„æ–¹å¼å¤„ç†ï¼š

1. æäº¤å½“å‰æœªå®Œæˆçš„å·¥ä½œåˆ°æœ¬åœ°å·¥ä½œåŒº
2. è¿”å›åˆ° master åˆ†æ”¯ã€‚
3. ä¸ºè¿™æ¬¡ç´§æ€¥ä¿®è¡¥å»ºç«‹ä¸€ä¸ªæ–°åˆ†æ”¯ï¼Œå¹¶åœ¨å…¶ä¸­ä¿®å¤é—®é¢˜ã€‚
4. é€šè¿‡æµ‹è¯•åï¼Œå›åˆ° master åˆ†æ”¯ï¼Œå°†ä¿®è¡¥åˆ†æ”¯åˆå¹¶è¿›æ¥ï¼Œç„¶åå†æ¨é€åˆ° gitlab æœåŠ¡å™¨ä¸Šã€‚
5. åˆ‡æ¢åˆ°ä¹‹å‰å®ç°æ–°éœ€æ±‚çš„åˆ†æ”¯ï¼Œç»§ç»­å·¥ä½œã€‚

è¿™é‡Œä½¿ç”¨ IDEA è‡ªå¸¦å·¥å…·è¿›è¡Œåˆ†æ”¯çš„åˆ›å»ºä»¥åŠåˆ‡æ¢

#### ä½¿ç”¨ IDEA åˆ›å»ºåˆ†æ”¯

å…ˆæäº¤å½“å‰æœªå®Œæˆçš„å·¥ä½œåˆ°æœ¬åœ°å·¥ä½œåŒº

![20241229154732_gb79w0V1.webp](https://cdn.dong4j.site/source/image/20241229154732_gb79w0V1.webp)

ç„¶ååˆ‡æ¢åˆ° master

**åˆ›å»ºåˆ†æ”¯**
![20241229154732_u5WKcnrc.webp](https://cdn.dong4j.site/source/image/20241229154732_u5WKcnrc.webp)

ç„¶åä¼šè‡ªåŠ¨åˆ‡æ¢åˆ° iss55 åˆ†æ”¯ä¸Š
[14908590481527](14908590481527.png)

æ‰€æœ‰ä»£ç éƒ½ä¿æŒä¸º master åŸæ ·

```java
public class HelloWorld {
    public static void main(String[] args) {
        String s = JOptionPane.showInputDialog("è¯·è¾“å…¥ä¸€ä¸ªæ•´æ•°");
        int a = Integer.parseInt(s);
        System.out.println(a);
        if (isOdd(a))
           System.out.println("å¥‡æ•°");
        else {
            System.out.println("å¶æ•°");
        }
    }

    /**
     * Is odd boolean.
     * æ£€æµ‹å¥‡å¶æ€§
     * @param i the
     * @return the boolean
     */
    public static boolean isOdd(int i) {
        return i % 2 == 1;
    }
}
```

ç°åœ¨å¼€å§‹ä¿®å¤ bug

```java
public class HelloWorld {
    public static void main(String[] args) {
        String s = JOptionPane.showInputDialog("è¯·è¾“å…¥ä¸€ä¸ªæ•´æ•°");
        int a = Integer.parseInt(s);
        System.out.println(a);
        if (isOdd(a))
           System.out.println("å¥‡æ•°");
        else {
            System.out.println("å¶æ•°");
        }
    }

    /**
     * Is odd boolean.
     * æ£€æµ‹å¥‡å¶æ€§
     * @param i the
     * @return the boolean
     * 2017-03-30 15:35 dong4j
     * ä¿®å¤è¾“å…¥è´Ÿæ•°æ—¶éƒ½ä¸º false çš„ bug
     */
    public static boolean isOdd(int i) {
        return (i & 1) == 1;
    }
}
```

æµ‹è¯•ä¸€ç•ªåæäº¤åˆ°æœ¬åœ°å·¥ä½œåŒº

![20241229154732_6cJT1Sem.webp](https://cdn.dong4j.site/source/image/20241229154732_6cJT1Sem.webp)

ç„¶åå›åˆ° master åˆ†æ”¯, æŠŠå®ƒåˆå¹¶è¿›æ¥, ç„¶åå‘å¸ƒåˆ° gitlab

**åˆå¹¶åˆ†æ”¯**
IDEA ä¸­æ“ä½œ

![20241229154732_6KOAi9as.webp](https://cdn.dong4j.site/source/image/20241229154732_6KOAi9as.webp)

åˆå¹¶ä¹‹å:

![20241229154732_UBlYc4TM.webp](https://cdn.dong4j.site/source/image/20241229154732_UBlYc4TM.webp)

åˆå¹¶ä¹‹å master åˆ†æ”¯å’Œ iss55 åˆ†æ”¯æŒ‡å‘åŒä¸€ä½ç½®
![20241229154732_bRQ8exRm.webp](https://cdn.dong4j.site/source/image/20241229154732_bRQ8exRm.webp)

ç„¶åå°†ä¿®æ”¹ push åˆ° gitlab

![20241229154732_FOsoHqSq.webp](https://cdn.dong4j.site/source/image/20241229154732_FOsoHqSq.webp)

push æˆåŠŸä¹‹å, origin æŒ‡å‘æœ€æ–°çš„ä¸€æ¡è®°å½•

æ­¤æ—¶ iss55 é—®é¢˜å·²è¢«ä¿®å¤, å¯ä»¥åˆ é™¤æ‰

IDEA ä¸Šæ“ä½œ

![20241229154732_TlA8aGZ1.webp](https://cdn.dong4j.site/source/image/20241229154732_TlA8aGZ1.webp)

**æœ€åå›åˆ°åŸæ¥çš„ sprint1 åˆ†æ”¯ä¸Šç»§ç»­å®Œæˆæ²¡æœ‰å®Œæˆçš„å·¥ä½œ**
![20241229154732_Ra5FyrSQ.webp](https://cdn.dong4j.site/source/image/20241229154732_Ra5FyrSQ.webp)

ä»£ç å˜æˆ:

```java
public class HelloWorld {
    public static void main(String[] args) {
        String s = JOptionPane.showInputDialog("è¯·è¾“å…¥ä¸€ä¸ªæ•´æ•°");
        int input = Integer.parseInt(s);
        System.out.println(input);
        if (isOdd(input))
           System.out.println("å¥‡æ•°");
        else {
            System.out.println("å¶æ•°");
        }

        Integer[] value = {100,1};
        switchValue(value);
        System.out.println("value[0] = " + value[0] + " \n" + "value[1] = " + value[1]);

    }

    /**
     * Is odd boolean.
     * æ£€æµ‹å¥‡å¶æ€§
     * @param i the
     * @return the boolean
     */
    public static boolean isOdd(int i) {
        return i % 2 == 1;
    }

    /**
     * Switch value.
     * äº¤æ¢å€¼
     * @param value the value
     */
    public static void switchValue(Integer[] value){
        // todo æœªå®Œæˆ
    }
}
```

æ­¤æ—¶å¯ä»¥çœ‹åˆ° iss55 åˆ†æ”¯ä¿®æ”¹çš„ä»£ç åœ¨ sprint1 åˆ†æ”¯ä¸­å¹¶æ²¡æœ‰æ”¹å˜

ä¸ç”¨æ‹…å¿ƒä¹‹å‰ iss55 åˆ†æ”¯çš„ä¿®æ”¹å†…å®¹å°šæœªåŒ…å«åˆ° sprint1 ä¸­æ¥ã€‚
å¦‚æœç¡®å®éœ€è¦çº³å…¥æ­¤æ¬¡ä¿®è¡¥ï¼Œå¯ä»¥ç”¨ git merge master æŠŠ master åˆ†æ”¯åˆå¹¶åˆ° iss55ï¼›
æˆ–è€…ç­‰ sprint1 å®Œæˆä¹‹åï¼Œå†å°† sprint1 åˆ†æ”¯ä¸­çš„æ›´æ–°å¹¶å…¥ masterã€‚

å…ˆå®Œæˆ sprint1 çš„å¼€å‘å·¥ä½œ

```java
public class HelloWorld {
    public static void main(String[] args) {
        String s = JOptionPane.showInputDialog("è¯·è¾“å…¥ä¸€ä¸ªæ•´æ•°");
        int input = Integer.parseInt(s);
        System.out.println(input);
        if (isOdd(input))
           System.out.println("å¥‡æ•°");
        else {
            System.out.println("å¶æ•°");
        }

        Integer[] value = {100,1};
        switchValue(value);
        System.out.println("value[0] = " + value[0] + " \n" + "value[1] = " + value[1]);

    }

    /**
     * Is odd boolean.
     * æ£€æµ‹å¥‡å¶æ€§
     * @param i the
     * @return the boolean
     */
    public static boolean isOdd(int i) {
        return i % 2 == 1;
    }

    /**
     * Switch value.
     * äº¤æ¢å€¼
     * @param value the value
     */
    public static void switchValue(Integer[] value){
            value[0] = value[0] ^ value[1];
            value[1] = value[0] ^ value[1];
            value[0] = value[0] ^ value[1];
    }
}
```

å®Œæˆå¼€å‘, æäº¤åˆ°æœ¬åœ°å·¥ä½œç©ºé—´

![20241229154732_DKVTDHZ5.webp](https://cdn.dong4j.site/source/image/20241229154732_DKVTDHZ5.webp)

**åˆå¹¶åˆ†æ”¯**

åœ¨é—®é¢˜ sprint1 ç›¸å…³çš„å·¥ä½œå®Œæˆä¹‹åï¼Œå¯ä»¥åˆå¹¶å› master åˆ†æ”¯ã€‚å®é™…æ“ä½œåŒå‰é¢åˆå¹¶ iss55 åˆ†æ”¯å·®ä¸å¤šï¼Œåªéœ€å›åˆ° master åˆ†æ”¯ï¼Œè¿è¡Œ git merge
å‘½ä»¤æŒ‡å®šè¦åˆå¹¶è¿›æ¥çš„åˆ†æ”¯ï¼š

IDEA æ“ä½œä¸ä¸Šé¢åˆå¹¶æ“ä½œä¸€æ ·

![20241229154732_H2dJUBkQ.webp](https://cdn.dong4j.site/source/image/20241229154732_H2dJUBkQ.webp)

æœ€å push åˆ° gitlab

## [IDEAæ’ä»¶æ¨èï¼šMarkdown Image Kitï¼Œè®©ä½ çš„æ–‡æ¡£é…å›¾æ›´ç®€å•ï¼](https://blog.dong4j.site/posts/d03a684c.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

ä¸€ä¸ªèƒ½åœ¨ IDEA ä¸­æ–¹ä¾¿ç®¡ç†å›¾ç‰‡çš„æ’ä»¶

> å®¡æ ¸å·²é€šè¿‡, å¯ç›´æ¥åœ¨ `plugin` ä¸­æœç´¢ `Markdown Image Kit` ä¸‹è½½

![20241229154732_2QWVIh3I.webp](https://cdn.dong4j.site/source/image/20241229154732_2QWVIh3I.webp)

`Markdown Image Kit` æ˜¯ä¸€æ¬¾åœ¨ IDEA ä¸­æ–¹ä¾¿é«˜æ•ˆå¾—ç®¡ç† Markdown æ–‡æ¡£å›¾ç‰‡çš„æ’ä»¶.

åœ¨ IntelliJ IDEA ä¸­å†™ä½œ(ä¸»è¦æ˜¯æŠ€æœ¯æ–‡æ¡£), é…å›¾æˆäº†ä¸€ä¸ªå¤§é—®é¢˜, æˆ‘ä»¬éœ€è¦å€ŸåŠ©å…¶ä»– APP æ¥å®Œæˆè¿™ä¸€æ“ä½œ.

ä¸ºäº†è§£å†³ç°çŠ¶, å› æ­¤å¼€å‘äº†æ­¤æ’ä»¶, èƒ½æ–¹ä¾¿å¾—ç»™æŠ€æœ¯æ–‡æ¡£é…å›¾, ä¸€é”®ä¸Šä¼ å›¾ç‰‡å¹¶ç›´æ¥æ›¿æ¢ä¸º markdown image æ ‡ç­¾, å½“ç„¶è¿˜æä¾›å…¶ä»–ä¸€äº›é™„å±åŠŸèƒ½.

## Features

1. ä¸€é”®ä¸Šä¼ å½“å‰æ–‡æ¡£(æ‰€æœ‰æ–‡æ¡£)æ‰€æœ‰å¼•ç”¨å›¾ç‰‡åè‡ªåŠ¨æ›¿æ¢, ä½“éªŒæœ€ç®€å•é«˜æ•ˆçš„ä¸€æ³¢æµæ“ä½œ;
2. æ”¯æŒå¤šä¸ªå›¾åºŠ, è¿˜æ”¯æŒè‡ªå®šä¹‰å›¾åºŠ, æ²¡æœ‰ä½ ä¸Šä¼ ä¸äº†çš„å›¾ç‰‡;
3. ä¸€é”®æ›¿æ¢æ‰€æœ‰æ ‡ç­¾, æ‰¹é‡å¤„ç†å°±æ˜¯è¿™ä¹ˆç®€å•;
4. ç²˜è´´å›¾ç‰‡, å¤åˆ¶å°±æ˜¯ markdown image mark, å°±æ˜¯è¿™ä¹ˆç›´æ¥;
5. å›¾ç‰‡ç›´æ¥å‹ç¼©, å‡å°‘æµé‡, æé«˜åŠ è½½é€Ÿåº¦, å¤„å¤„ä¸ºä½ ç€æƒ³;
6. å¯å¯¹ä¸€ä¸ª markdown image mark å•ç‹¬å¤„ç†, çµæ´»çš„ä¸è¦ä¸è¦çš„;
7. å›¾åºŠè¿ç§»è®¡åˆ’, å…è´¹æµé‡ç”¨å®Œäº†? è¿ç§»åˆ°å¦ä¸€ä¸ªå…è´¹å›¾åºŠä¸å°± ok äº†;

## åŠŸèƒ½æ¼”ç¤º

### å¤åˆ¶ç²˜è´´ç›´æ¥è¾“å‡º image mark

![save-image.gif](https://cdn.dong4j.site/source/image/save-image.gif)

### å¤åˆ¶ç²˜è´´ç›´æ¥ä¸Šä¼ åˆ° OSS

![paste-upload.gif](https://cdn.dong4j.site/source/image/paste-upload.gif)

### å¤åˆ¶æœ¬åœ°å›¾ç‰‡ç›´æ¥ä¸Šä¼ 

![local-image-upload.gif](https://cdn.dong4j.site/source/image/local-image-upload.gif)

### å•ä¸ªæ ‡ç­¾ä¸Šä¼ 

![single-upload.gif](https://cdn.dong4j.site/source/image/single-upload.gif)

### æ‰¹é‡ä¸Šä¼ 

![multi-upload.gif](https://cdn.dong4j.site/source/image/multi-upload.gif)

### å›¾åºŠè¿ç§»

![MIK-wu5NqZ.gif](https://cdn.dong4j.site/source/image/MIK-wu5NqZ.gif)

### æ ‡ç­¾æ›¿æ¢

![MIK-sPmXWd.gif](https://cdn.dong4j.site/source/image/MIK-sPmXWd.gif)

### ä¸Šä¼ åˆ°ä¸åŒå›¾åºŠ

![MIK-3az5GQ.gif](https://cdn.dong4j.site/source/image/MIK-3az5GQ.gif)

## è¯¦ç»†è®¾ç½®

![20241229154732_RNhkTTKh.webp](https://cdn.dong4j.site/source/image/20241229154732_RNhkTTKh.webp)

### Clipboard ç›‘æ§

![20241229154732_WVUADAjI.webp](https://cdn.dong4j.site/source/image/20241229154732_WVUADAjI.webp)

å¦‚æœå¼€å¯äº† `å¤åˆ¶å›¾ç‰‡åˆ°ç›®å½•`, åˆ™ä¼šç›‘æ§ Clipboard ä¸­æ˜¯å¦æœ‰ Image ç±»å‹çš„æ–‡ä»¶.

å¦‚æœå­˜åœ¨ Image ç±»å‹çš„æ–‡ä»¶, ç›´æ¥ä½¿ç”¨ `ç²˜è´´` æ“ä½œå³å¯å°†å›¾ç‰‡ä¿å­˜åˆ°æŒ‡å®šç›®å½•.

å¦‚æœå¼€å¯äº† `ä¸Šä¼ å›¾ç‰‡å¹¶æ›¿æ¢`, åˆ™åœ¨å¤åˆ¶æ—¶å°†ç›´æ¥ä¸Šä¼  clipboard ä¸­çš„ Image å¹¶æ›¿æ¢ä¸º markdown image mark.

> ä½œä¸ºæœ€æ–¹ä¾¿çš„ä¸€ä¸ªåŠŸèƒ½, å¯ä»¥åªå¯ç”¨ `ä¸Šä¼ å›¾ç‰‡å¹¶æ›¿æ¢`, å¦‚æœéœ€è¦å°†å›¾ç‰‡å¤‡ä»½åˆ°æœ¬åœ°, ä¹Ÿå¯åŒæ—¶å¼€å¯ä¸Šé¢ 2 ä¸ªåŠŸèƒ½.

### OSS è®¾ç½®

![20241229154732_Xb1WWGDz.webp](https://cdn.dong4j.site/source/image/20241229154732_Xb1WWGDz.webp)

ç¬¬ä¸€ç‰ˆæš‚æ—¶åªé›†æˆäº† `å¾®åšå›¾åºŠ`, `é˜¿é‡Œäº‘`, `ä¸ƒç‰›äº‘`, åæœŸä¼šæ…¢æ…¢é›†æˆå…¶ä»–å›¾åºŠ.

åªæœ‰æ­£ç¡®è®¾ç½®è®¤è¯ä¿¡æ¯ä¸”æµ‹è¯•é€šè¿‡, å½“å‰ OSS æ‰å¯ç”¨.

> å¡«å®Œè®¤è¯ä¿¡æ¯å, ä¸€å®šè¦ç‚¹ `æµ‹è¯•` æŒ‰é’®æµ‹è¯•è®¤è¯ä¿¡æ¯.
> æ¯æ¬¡ä¿®æ”¹äº†è®¤è¯ä¿¡æ¯åä¹Ÿéœ€è¦è¿›è¡Œæµ‹è¯•, ä¸ç„¶å°†ä¸å¯ç”¨.

### å…¨å±€è®¾ç½®

![20241229154732_uu2pXnFj.webp](https://cdn.dong4j.site/source/image/20241229154732_uu2pXnFj.webp)

#### è®¾ç½®é»˜è®¤å›¾åºŠ

å¿…é¡»è®¾ç½®é»˜è®¤å›¾åºŠ, clipboard ç›‘æ§ä¸Šä¼ å’Œ `alt + enter` éƒ½æ˜¯ä¸Šä¼ åˆ°é»˜è®¤å›¾åºŠ.

> ç¬¬ä¸€ç‰ˆå°† `å¾®åš` åˆå§‹åŒ–äº†ä¸ºé»˜è®¤å›¾åºŠ, åæœŸå°†ä½¿ç”¨ `sm.ms`, ä¸éœ€è¦è®¤è¯ç›´æ¥ä¸Šä¼ 

#### æ›¿æ¢æ ‡ç­¾

**æ­¤åŠŸèƒ½ä¸»è¦æ˜¯è‡ªç”¨**

å¦‚æœå°† markdown image mark åŠ ä¸Š `<a>`, å›¾ç‰‡å¯ç‚¹å‡»å¹¶åœ¨æ–°æ ‡ç­¾ä¸­æ‰“å¼€.

å¦‚æœä½ ä½¿ç”¨ vuepress æ­å»ºåšå®¢, å¯ä»¥ä½¿ç”¨ `ç‚¹å‡»çœ‹å¤§å›¾` è®¾ç½®, æ•ˆæœå°±æ˜¯ç‚¹å‡»å›¾ç‰‡åå³å¯æ”¾å¤§å›¾ç‰‡

å¦‚æœæƒ³è¦ä¸Šé¢è¯´çš„æ•ˆæœ, éœ€è¦åœ¨ `config.js` çš„ `head` èŠ‚ç‚¹æ·»åŠ å¦‚ä¸‹é…ç½®:

```javascript
// è®© Vuepress æ”¯æŒå›¾ç‰‡æ”¾å¤§åŠŸèƒ½
[
  "script",
  {
    src: "https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js",
  },
],
  [
    "script",
    {
      src: "https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js",
    },
  ],
  [
    "link",
    {
      rel: "stylesheet",
      type: "text/css",
      href: "https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css",
    },
  ];
```

#### å›¾ç‰‡å‹ç¼©

å¼€å¯åä¼šåœ¨ä¿å­˜å›¾ç‰‡, ä¸Šä¼ å›¾ç‰‡æ—¶å‹ç¼©.

> gif æš‚æ—¶æœªæ”¯æŒå‹ç¼©, å› ä¸º gif æ˜¯å¤šå¸§å›¾, ä¸å¥½å¤„ç†

#### å›¾ç‰‡é‡å‘½å

æä¾› 3 ä¸­é‡å‘½åæ–¹å¼, ä½†æ˜¯ `å¾®åšå›¾åºŠ` ä¸æ”¯æŒ, æ²¡æœ‰è¿™ä¸ª API.

ä¸Šä¼ åˆ° `å¾®åšå›¾åºŠ` åä¼šè¿”å›ä¸€ä¸ª PID, URL å°±æ˜¯é€šè¿‡ PID è§£æå‡ºæ¥çš„,
å¦‚æœåŠ å¯†æ–¹å¼æ”¹äº†, è¿™ä¸ªæ’ä»¶å°±è¦å‡çº§äº† (æˆ–è€…åšä¸ªè§£æ PID çš„ WEB æœåŠ¡? `Help` è·³è½¬åˆ°æ­¤é¡µé¢å°±æ˜¯è¿™ä¹ˆåšçš„).

## å…¶ä»–

å°±è¿™ä¹ˆå‡ ä¸ªåŠŸèƒ½, ç”¨çš„ SDK æ˜¯ 2018.3.5 çš„, ä¹Ÿä¸æ‰“ç®—å…¼å®¹è€ç‰ˆæœ¬äº†, èƒ½ç”¨å°±ç”¨å§.

å¦‚æœä½ æœ‰ä»€ä¹ˆæƒ³æ³•æˆ–è€…æ–°éœ€æ±‚, å¯ä»¥è¯´å‡ºæ¥å¬å¬, ä¸‡ä¸€å®ç°äº†å‘¢ ğŸ˜‚.

æ¬¢è¿æäº¤ [issue](https://github.com/dong4j/markdown-image-kit/issues)

è¦æ˜¯ä½ åœ¨ä½¿ç”¨è¿™æ¬¾æ’ä»¶, è®°å¾—ç»™æˆ‘ç‚¹ä¸ª [star](https://github.com/dong4j/markdown-image-kit)

## ä¿®å¤æŠ¥é”™

```
java.lang.Throwable: Element component@ImageManagerSetting.option.WeiboOssState.option.@name=password probably contains sensitive information (file: ~/Library/Preferences/IntelliJIdea2019.1/options/other.xml)
```

æ‰“å¼€ä¸Šé¢çš„æ–‡ä»¶, åˆ é™¤ `<component name="ImageManagerSetting">` èŠ‚ç‚¹

![20241229154732_peWpXmpm.webp](https://cdn.dong4j.site/source/image/20241229154732_peWpXmpm.webp)

![20241229154732_dswSMgMG.webp](https://cdn.dong4j.site/source/image/20241229154732_dswSMgMG.webp)

![20241229154732_saTOZqvU.webp](https://cdn.dong4j.site/source/image/20241229154732_saTOZqvU.webp)

![20241229154732_RvypwKMm.webp](https://cdn.dong4j.site/source/image/20241229154732_RvypwKMm.webp)

## [apidocåŸºç¡€æ•™ç¨‹ï¼šä»é›¶å¼€å§‹ç¼–å†™APIæ–‡æ¡£](https://blog.dong4j.site/posts/b0674c16.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## @api

è¢« @api æ ‡è®°å, ä¼šè§£ææˆ api æ–‡æ¡£

```
@api {method} path [title]
```

| Name          | Description                                                                                                                                                                   |
| :------------ | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| method        | Request method name:Â `DELETE`,Â `GET`,Â `POST`,Â `PUT`, ... More infoÂ [Wikipedia HTTP-Request_methods](http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_methods) |
| path          | Request Path.                                                                                                                                                                 |
| titleoptional | A short title. (used for navigation and article header)                                                                                                                       |

Example:

```
/**
 * @api {get} /user/:id è·å–ç”¨æˆ·è¯¦æƒ…
 */
```

![20241229154732_jjly4yCg.webp](https://cdn.dong4j.site/source/image/20241229154732_jjly4yCg.webp)

## @apiDefine

ç”¨æ¥å®šä¹‰å…¨å±€æè¿°, æ¯”å¦‚æœåŠ¡å™¨å†…éƒ¨é”™è¯¯æè¿°, æƒé™æè¿°ç­‰

```
@apiDefine name [title] [description]
```

| Name                | Description                                                                                                                   |
| :------------------ | :---------------------------------------------------------------------------------------------------------------------------- |
| name                | Unique name for the block / value. Same name with differentÂ `@apiVersion`Â can be defined.                                     |
| titleoptional       | A short title. Only used for named functions likeÂ `@apiPermission`Â orÂ `@apiParam (name)`.                                     |
| descriptionoptional | Detailed Description start at the next line, multiple lines can be used. Only used for named functions likeÂ `@apiPermission`. |

Example:

```
/**
 * @apiDefine MyError
 * @apiError UserNotFound The <code>id</code> of the User was not found.
 */

/**
 * @api {get} /user/:id
 * [ä¸‹é¢å¼•å…¥å…¨å±€å®šä¹‰]
 * @apiUse MyError
 */
```

```
/**
 * @apiDefine admin User access only
 * This optional description belong to to the group admin.
 */

/**
 * @api {get} /user/:id
 * [ä¸‹é¢å¼•å…¥å…¨å±€å®šä¹‰]
 * @apiPermission admin
 */
```

![20241229154732_T80hZbeD.webp](https://cdn.dong4j.site/source/image/20241229154732_T80hZbeD.webp)

## @apiDescription

ç”¨äºå®šä¹‰æ¥å£æè¿°ä¿¡æ¯

```
@apiDescription text
```

| Name | Description                 |
| :--- | :-------------------------- |
| text | Multiline description text. |

Example:

```
/**
 * @api {get} /user/{id} è·å–ç”¨æˆ·è¯¦æƒ…
 * @apiDescription æ¥å£æè¿°ä¿¡æ¯
 * å¯ä»¥æœ‰å¤šè¡Œ
 * @apiUse MyError
 * @apiPermission admin
 */
```

![20241229154732_p8JZlRiJ.webp](https://cdn.dong4j.site/source/image/20241229154732_p8JZlRiJ.webp)

## @apiError

å®šä¹‰é”™è¯¯çš„æè¿°ä¿¡æ¯

```
@apiError [(group)] [{type}] field [description]
```

| Name                | Description                                                                                            |
| :------------------ | :----------------------------------------------------------------------------------------------------- |
| (group)optional     | All parameters will be grouped by this name. Without a group, the defaultÂ `Error 4xx`Â is set.          |
| {type}optional      | Return type, e.g.Â `{Boolean}`,Â `{Number}`,Â `{String}`,`{Object}`,Â `{String[]}`Â (array of strings), ... |
| field               | Return Identifier (returned error code).                                                               |
| descriptionoptional | Description of the field.                                                                              |

## @apiErrorExample

é”™è¯¯ä¿¡æ¯ç¤ºä¾‹

```
@apiErrorExample [{type}] [title] example
```

| Name          | Description                           |
| :------------ | :------------------------------------ |
| typeoptional  | Response format.                      |
| titleoptional | Short title for the example.          |
| example       | Detailed example, multilines capable. |

Example:

```
/**
 * @api {get} /user/{id} è·å–ç”¨æˆ·è¯¦æƒ…
 * @apiDescription æ¥å£æè¿°ä¿¡æ¯
 * å¯ä»¥æœ‰å¤šè¡Œ
 * @apiUse MyError
 * @apiPermission admin
 * @apiErrorExample {json} Error-Response:
 *     HTTP/1.1 404 Not Found
 *     {
 *       "error": "UserNotFound"
 *     }
 */
```

![20241229154732_QASOCI5x.webp](https://cdn.dong4j.site/source/image/20241229154732_QASOCI5x.webp)

## @apiExample

api è¯·æ±‚ç¤ºä¾‹

```
@apiExample [{type}] title
            example
```

| Name         | Description                           |
| :----------- | :------------------------------------ |
| typeoptional | Code language.                        |
| title        | Short title for the example.          |
| example      | Detailed example, multilines capable. |

Example:

```
/**
 * @api {get} /user/{id} è·å–ç”¨æˆ·è¯¦æƒ…
 * @apiDescription æ¥å£æè¿°ä¿¡æ¯
 * å¯ä»¥æœ‰å¤šè¡Œ
 * @apiUse MyError
 * @apiPermission admin
 * @apiErrorExample {json} Error-Response:
 *     HTTP/1.1 404 Not Found
 *     {
 *       "error": "UserNotFound"
 *     }
 * @apiExample {curl} Example usage:
 *     curl -i http://dev.yyyyy.com/test/api/user/1024
 */
```

![20241229154732_qtKaaxz9.webp](https://cdn.dong4j.site/source/image/20241229154732_qtKaaxz9.webp)

## @apiGroup

å®šä¹‰æ–¹æ³•æ–‡æ¡£å—å±äºå“ªä¸ªç»„ã€‚ç»„å°†ç”¨äºç”Ÿæˆè¾“å‡ºä¸­çš„ä¸»å¯¼èˆªã€‚ç»“æ„å®šä¹‰ä¸éœ€è¦ `@apigroup`

```
@apiGroup name
```

| Name | Description                                       |
| :--- | :------------------------------------------------ |
| name | Name of the group. Also used as navigation title. |

Example:

```
/**
 * @api {get} /user/{id} è·å–ç”¨æˆ·è¯¦æƒ…
 * @apiDescription æ¥å£æè¿°ä¿¡æ¯
 * å¯ä»¥æœ‰å¤šè¡Œ
 * @apiGroup User
 * @apiUse MyError
 * @apiPermission admin
 * @apiErrorExample {json} Error-Response:
 *     HTTP/1.1 404 Not Found
 *     {
 *       "error": "UserNotFound"
 *     }
 * @apiExample {curl} Example usage:
 *     curl -i http://dev.yyyyy.com/test/api/user/1024
 */
```

![20241229154732_zC1OHZF6.webp](https://cdn.dong4j.site/source/image/20241229154732_zC1OHZF6.webp)

## @apiHeader

æè¿°ä¼ é€’ç»™ API å¤´éƒ¨çš„å‚æ•°ï¼Œä¾‹å¦‚ç”¨äºæˆæƒã€‚

```
@apiHeader [(group)] [{type}] [field=defaultValue] [description]
```

Usage:Â `@apiHeader (MyHeaderGroup) {String} authorization Authorization value.`

| Name                                                                                          | Description                                                                                               |
| :-------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------- |
| (group)optional                                                                               | All parameters will be grouped by this name. Without a group, the defaultÂ `Parameter`Â is set.             |
| You can set a title and description withÂ [@apiDefine](http://apidocjs.com/#param-api-define). |
| {type}optional                                                                                | Parameter type, e.g.Â `{Boolean}`,Â `{Number}`,Â `{String}`,`{Object}`,Â `{String[]}`Â (array of strings), ... |
| field                                                                                         | Variablename.                                                                                             |
| [field]                                                                                       | Fieldname with brackets define the Variable as optional.                                                  |
| =defaultValueoptional                                                                         | The parameters default value.                                                                             |
| descriptionoptional                                                                           | Description of the field.                                                                                 |

Examples:

```
/**
 * @api {get} /user/:id
 * @apiHeader {String} Content-Type=application/json æµè§ˆå™¨ä»¥ json æ–¹å¼å‘é€æ•°æ®ç»™æœåŠ¡å™¨
 * @apiHeader {String} Accept=application/json;charset=UTF-8 æµè§ˆå™¨æ¥æ”¶ json æ•°æ®
 */
```

![20241229154732_dsaCNEfA.webp](https://cdn.dong4j.site/source/image/20241229154732_dsaCNEfA.webp)

ä½¿ç”¨ @apiDefine å®šä¹‰å…¨å±€ header æè¿°

```
/**
 * @apiDefine Header
 * @apiHeader {String} Content-Type=application/json æµè§ˆå™¨ä»¥ json æ–¹å¼å‘é€æ•°æ®ç»™æœåŠ¡å™¨
 * @apiHeader {String} Accept=application/json;charset=UTF-8 æµè§ˆå™¨æ¥æ”¶ json æ•°æ®
 */
```

å¼•å…¥ header æè¿°

```
/**
 * @api {get} /user/{id} è·å–ç”¨æˆ·è¯¦æƒ…
 * @apiDescription æ¥å£æè¿°ä¿¡æ¯
 * å¯ä»¥æœ‰å¤šè¡Œ
 * @apiGroup User
 * @apiUse MyError
 * @apiPermission admin
 * @apiUse Header
 * @apiErrorExample {json} Error-Response:
 *     HTTP/1.1 404 Not Found
 *     {
 *       "error": "UserNotFound"
 *     }
 * @apiExample {curl} Example usage:
 *     curl -i http://dev.yyyyy.com/test/api/user/1024
 */
```

## @apiHeaderExample

header å‚æ•° ç¤ºä¾‹

```
@apiHeaderExample [{type}] [title]
                   example
```

| Name          | Description                           |
| :------------ | :------------------------------------ |
| typeoptional  | Request format.                       |
| titleoptional | Short title for the example.          |
| example       | Detailed example, multilines capable. |

Example:

```
/**
 * @apiDefine Header
 * @apiHeader {String} Content-Type=application/json æµè§ˆå™¨ä»¥ json æ–¹å¼å‘é€æ•°æ®ç»™æœåŠ¡å™¨
 * @apiHeader {String} Accept=application/json;charset=UTF-8 æµè§ˆå™¨æ¥æ”¶ json æ•°æ®
 * @apiHeaderExample {json} Header-Example:
 *     {
 *       "Content-Type": "Content-Type:application/json",
 *       "Accept": "Accept:application/json;charset=UTF-8"
 *     }
 */
```

![20241229154732_li2cBiFi.webp](https://cdn.dong4j.site/source/image/20241229154732_li2cBiFi.webp)

## @apiIgnore

ç”¨äºå®šä¹‰æœªå®Œæˆçš„æ¥å£æè¿°, ä¸ä¼šè¢«æ˜¾ç¤ºå‡ºæ¥
**å¿…é¡»åœ¨ @api ä¹‹å‰å®šä¹‰**

```
@apiIgnore [hint]
```

Usage:Â `@apiIgnore Not finished Method`

| Name         | Description                                         |
| :----------- | :-------------------------------------------------- |
| hintoptional | Short information why this block should be ignored. |

Example:

```
/**
 * @apiIgnore Not finished Method
 * @api {get} /user/:id
 */
```

## @apiName

å®šä¹‰æ–¹æ³•æ–‡æ¡£å—çš„åç§°ã€‚å°†åœ¨ç”Ÿæˆçš„è¾“å‡ºä¸­ä½¿ç”¨å­å¯¼èˆªåã€‚ç»“æ„å®šä¹‰ä¸éœ€è¦ `@apiName`ã€‚

```
@apiName name
```

| Name | Description                                                                                                                                                               |
| :--- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| name | Unique name of the method. Same name with differentÂ `@apiVersion`Â can be defined. Format:Â *method*Â +Â *path*Â (e.g. Get + User), only a proposal, you can name as you want. |

Example:

```
/**
 * @api {get} /user/:id
 * @apiName GetUser
 */
```

## @apiParam

æè¿°ä¼ é€’ç»™ API æ–¹æ³•çš„å‚æ•°

Usage:Â `@apiParam (MyGroup) {Number} id Users unique ID.`

| Name                         | Description                                                                           |
| :--------------------------- | :------------------------------------------------------------------------------------ |
| (group)optional              | å¯å®šä¹‰ä¸€ä¸ª group ,ç”¨äºæŠ½è±¡å‡ºå…¬å…±çš„å‚æ•° ()è¡¨ç¤ºå¯ä»¥ä¸ç”¨å®šä¹‰ group                       |
| {type}optional               | å‚æ•°ç±»å‹                                                                              |
| {type{size}}optional         | å‚æ•°é•¿åº¦ `{string{..5}}`Â `{string{2..5}}`Â `{number{100-999}}`Â                         |
| {type=allowedValues}optional | å‚æ•°å…è®¸çš„å€¼ `{string="small"}`Â `{string {..5}="small","huge"}`Â Â `{number=1,2,3,99}`Â  |
| field                        | å­—æ®µåç§°                                                                              |
| [field=defaultValueoptional] | å‚æ•°é»˜è®¤å€¼ (æœ‰ä¸€ä¸ªé»˜è®¤æ ‡è¯†) [] æ ‡è¯†æœ‰ä¸€ä¸ªå¯é€‰æ ‡è¯†                                     |
| descriptionoptional          | å­—æ®µæè¿°                                                                              |

Examples:

```
/**
 * @api {get} /user/:id
 * @apiParam {Number} id Users unique ID.
 */

/**
 * @api {post} /user/
 * @apiParam {String} [firstname]  Optional Firstname of the User.
 * @apiParam {String} lastname     Mandatory Lastname.
 * @apiParam {String} country="DE" Mandatory with default value "DE".
 * @apiParam {Number} [age=18]     Optional Age with default 18.
 *
 * @apiParam (Login) {String} pass Only logged in users can post this.
 *                                 In generated documentation a separate
 *                                 "Login" Block will be generated.
 */
```

![20241229154732_5SroB3m0.webp](https://cdn.dong4j.site/source/image/20241229154732_5SroB3m0.webp)

## @apiParamExample

è¯·æ±‚å‚æ•°ç¤ºä¾‹

```
@apiParamExample [{type}] [title]
                   example
```

| Name          | Description                           |
| :------------ | :------------------------------------ |
| typeoptional  | Request format.                       |
| titleoptional | Short title for the example.          |
| example       | Detailed example, multilines capable. |

Example:

```
/**
 * @api {get} /user/:id
 * @apiParamExample {json} Request-Example:
 *     {
 *       "id": 4711
 *     }
 */
```

![20241229154732_EutaILi9.webp](https://cdn.dong4j.site/source/image/20241229154732_EutaILi9.webp)

## @apiPermission

å®šä¹‰æ¥å£æƒé™

```
@apiPermission name
```

| Name | Description                    |
| :--- | :----------------------------- |
| name | Unique name of the permission. |

Example:

```
/**
 * @api {get} /user/:id
 * @apiPermission none
 */
```

## @apiPrivate

å°† API å®šä¹‰ä¸ºç§æœ‰çš„ï¼Œå…è®¸åˆ›å»ºä¸¤ä¸ª API è§„èŒƒæ–‡æ¡£ï¼šä¸€ä¸ªä¸åŒ…å«ç§æœ‰ apiï¼Œå¦ä¸€ä¸ªåŒ…å«å®ƒä»¬ã€‚

```
@apiPrivate
```

Usage:Â `@apiPrivate`

Command line usage to exclude/include private APIs:Â `--private false|true`

Example:

```
/**
 * @api {get} /user/:id
 * @apiPrivate
 */
```

é»˜è®¤ä¸æ˜¾ç¤ºç§æœ‰æ¥å£

å¦‚æœéœ€è¦åŒ…å«ç§æœ‰æ¥å£ ä½¿ç”¨ä¸€ä¸‹å‘½ä»¤

```
apidoc -i . -o apidoc/  --private true
```

## @apiSampleRequest

å®šä¹‰æ˜¯å¦æ˜¾ç¤ºæ¥å£è°ƒç”¨ç›¸å…³éƒ¨åˆ†
åœ¨ä¸ apidoc.json é…ç½®å‚æ•° [ sampleurl ]ç»“åˆä½¿ç”¨æ­¤å‚æ•°

1. å¦‚æœåœ¨ `apidoc.json` å®šä¹‰äº† `sampleUrl`, å…¨éƒ¨çš„ api éƒ½ä¼šæœ‰ä¸€ä¸ªæµ‹è¯•è¡¨å•
2. å¦‚æœæ²¡æœ‰å®šä¹‰ `sampleUrl` å­—æ®µ, åªæœ‰æ ‡è¯†äº† `@apiSampleRequest` çš„æ¥å£æ‰ä¼šæœ‰æµ‹è¯•è¡¨å•
3. å¦‚æœå®šä¹‰äº† `sampleUrl` å­—æ®µ, api ä¸­ä¹Ÿæœ‰ `@apiSampleRequest url`, ä¸” url å·² http å¼€å¤´, åˆ™ api çš„ url ä¼šè¦†ç›–å…¨å±€çš„ `sampleUrl`
4.
5. å¦‚æœå®šä¹‰äº† `sampleUrl` å­—æ®µ, ä½†æ˜¯æŸä¸ª api ä¸éœ€è¦æµ‹è¯•è¡¨å•, åˆ™å¯ä»¥ä½¿ç”¨ `@apiSampleRequest off`

```
@apiSampleRequest url
```

### å®šä¹‰ package.json

```
{
  "name": "xxx-api",
  "version": "1.0.0",
  "description": "xxx-api æ¥å£æ–‡æ¡£",
  "apidoc": {
    "title": "",
    "url" : "",
    "sampleUrl":"http://dev.yyyyy.com/test/api"
  }
}
```

æ‰€æœ‰ api éƒ½ä¼šå‡ºç° æµ‹è¯•è¡¨å•

![20241229154732_CPaV8ODH.webp](https://cdn.dong4j.site/source/image/20241229154732_CPaV8ODH.webp)

åŒæ—¶å®šä¹‰æµ‹è¯• url, ä¸” `@apiSampleRequest` å·² http å¼€å¤´, åˆ™ä¼šè¦†ç›– `sampleUrl`

```
@apiSampleRequest http://127.0.0.1/test/api/user
```

![20241229154732_RoWPWBjx.webp](https://cdn.dong4j.site/source/image/20241229154732_RoWPWBjx.webp)

å¦‚æœ `@apiSampleRequest` åªæ˜¯å®šä¹‰ URI, åˆ™ä¼šç»„åˆ apiSampleRequest å’Œ sampleUrl, ç”Ÿæˆæœ€ç»ˆçš„ æµ‹è¯•åœ°å€

```
@apiSampleRequest /user
```

![20241229154732_oMIXu9N6.webp](https://cdn.dong4j.site/source/image/20241229154732_oMIXu9N6.webp)

## @apiSuccessExample

å®šä¹‰æ­£ç¡®çš„è¿”å›ç»“æœ

```
@apiSuccessExample [{type}] [title]
                   example
```

| Name          | Description                           |
| :------------ | :------------------------------------ |
| typeoptional  | Response format.                      |
| titleoptional | Short title for the example.          |
| example       | Detailed example, multilines capable. |

Example:

```
/**
 * @apiDefine CODE_200 è°ƒç”¨æˆåŠŸ
 * @apiSuccess (Reponse 200) {number} code 200
 * @apiSuccess (Reponse 200) {json} [data='""']
 * @apiSuccessExample {json} Response 200 Example
 *   HTTP/1.1 200 OK
 *   {
 *     "rescode": 1200,
 * 		"message": "æ“ä½œæˆåŠŸ",
 * 		"timestamp": 1513920968552
 *   }
 */
```

![20241229154732_Q24XCnZO.webp](https://cdn.dong4j.site/source/image/20241229154732_Q24XCnZO.webp)

## @apiUse

å®šä¹‰ ä½¿ç”¨ `@apiDefine` å®šä¹‰çš„å…¨å±€å®šä¹‰

```
@apiUse name
```

Usage:Â `@apiUse MySuccess`

| Name | Description                |
| :--- | :------------------------- |
| name | Name of the defined block. |

Example:

```
/**
 * @apiDefine MySuccess
 * @apiSuccess {string} firstname The users firstname.
 * @apiSuccess {number} age The users age.
 */

/**
 * @api {get} /user/:id
 * @apiUse MySuccess
 */
```

## @apiVersion

å®šä¹‰ api ç‰ˆæœ¬, å¯ç”¨äºå¯¹æ¯”ä¸åŒçš„ç‰ˆæœ¬å˜åŒ–

```
@apiVersion version
```

Usage:Â `@apiVersion 1.6.2`

| Name    | Description                                                                                                                     |
| :------ | :------------------------------------------------------------------------------------------------------------------------------ |
| version | Simple versioning supported (major.minor.patch). More info onÂ [Semantic Versioning Specification (SemVer)](http://semver.org/). |

Example:

```
/**
 * @api {get} /user/{id}
 * @apiVersion 1.6.2
 */
```

**å†å²ç‰ˆæœ¬éœ€è¦æ‹·è´çš„ -apidoc.js æ–‡ä»¶ä¸­**

## [æ—¥å¿—è¿½è¸ªç³»ç»Ÿè¯¦è§£ï¼šä»è‡ªåŠ¨åŸ‹ç‚¹åˆ°åŠ¨æ€ä¿®æ”¹çº§åˆ«](https://blog.dong4j.site/posts/9cba1244.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

é€šè¿‡æ‰©å±• dubbo Filter, æ‹¦æˆª RPC è¯·æ±‚çš„æ–¹å¼, å°†åœ¨è¯·æ±‚ API æ—¶é€šè¿‡ SnowFlake ç®—æ³•ç”Ÿæˆçš„å…¨å±€å”¯ä¸€ traceId å­˜å…¥åˆ° RpcContext ä¸­, ä¼ é€’ç»™ä¸‹ä¸€ä¸ªæœåŠ¡.

**dubbo æœåŠ¡è°ƒç”¨æ—¥å¿—**

> é€šè¿‡æ‰©å±• dubbo Filter, æ‹¦æˆª RPC è¯·æ±‚çš„æ–¹å¼, å°†åœ¨è¯·æ±‚ API æ—¶é€šè¿‡ SnowFlake ç®—æ³•ç”Ÿæˆçš„å…¨å±€å”¯ä¸€ traceId å­˜å…¥åˆ° RpcContext ä¸­, ä¼ é€’ç»™ä¸‹ä¸€ä¸ªæœåŠ¡.

**ä¸šåŠ¡æ—¥å¿—**

> é€šè¿‡ [Load Time wearing](https://docs.spring.io/spring/docs/4.0.4.RELEASE/spring-framework-reference/htmlsingle/#aop-aj-ltw-environment-generic)
> æŠ€æœ¯è‡ªåŠ¨åŸ‹ç‚¹, åœ¨è¿›å…¥æ–¹æ³•æ—¶, é€šè¿‡ MDC è·å– traceId

## æ¥å…¥è¿½è¸ªç³»ç»Ÿ

1. dubbo è¿½è¸ªæ¥å…¥

   ```
   <!-- xxx-service pom.xml å¼•å…¥ æ—¥å¿—è¿½è¸ªæ’ä»¶ -->
   <dependency>
       <groupId>com.xxx</groupId>
       <artifactId>xxx-trace-client</artifactId>
       <version>0.2</version>
   </dependency>
   ```

2. http è¿½è¸ªæ¥å…¥

   ```
   <!-- web.xml æ·»åŠ  -->
   <filter>
           <filter-name>controllerFilter</filter-name>
           <filter-class>com.xxx.trace.client.rest.LoggerFilter</filter-class>
   </filter>
   <filter-mapping>
           <filter-name>controllerFilter</filter-name>
           <url-pattern>/*</url-pattern>
   </filter-mapping>
   ```

3. æ–¹æ³•æ—¥å¿—è‡ªåŠ¨åŸ‹ç‚¹

   ```
   <!-- META-INFO/aop.xml-->
   <?xml version="1.0" encoding="UTF-8"?>
   <aspectj>
       <weaver>
           <!-- only weave classes in your application-specific packages -->
           <include within="com.xxx.server.rest.resource.impl.*"/>
       </weaver>
       <aspects>
           <!-- weave in just these aspects -->
           <!--<aspect name="com.xxx.trace.client.aspect.ProfilingAspect"/>-->
           <aspect name="com.xxx.server.rest.aspect.ProfilingAspect"/>
           <aspect name="com.xxx.server.rest.aspect.TraceAspect"/>
       </aspects>
   </aspectj>
   ```

## å®ç°åŸç†

### è‡ªåŠ¨åŸ‹ç‚¹

è‡ªåŠ¨åŸ‹ç‚¹ä½¿ç”¨ ä»£ç ç»‡å…¥ (AOP)

#### ä»£ç ç»‡å…¥å®ç°æ–¹å¼

1. é™æ€ä»£ç†
   1. AspectJ ç»‡å…¥å™¨ weaver)
      1. compile-time weaving ä½¿ç”¨ aspectj ç¼–è¯‘å™¨è¿›è¡Œç¼–è¯‘æºç 
      2. post-compile weaving å¯¹ class æ–‡ä»¶è¿›è¡Œç»‡å…¥
      3. load-time weaving(LTW) å½“ class loader åŠ è½½ç±»çš„æ—¶å€™ï¼Œè¿›è¡Œç»‡å…¥
2. åŠ¨æ€ä»£ç†
   1. JDK åŠ¨æ€ä»£ç† (æ¥å£)
   2. CGlib(ç±»)

è¿™é‡Œä½¿ç”¨ [Load Time wearing](https://docs.spring.io/spring/docs/4.0.4.RELEASE/spring-framework-reference/htmlsingle/#aop-aj-ltw-environment-generic)
å®ç°, è¿™ç§æ–¹å¼åœ¨ç±»åŠ è½½å™¨ç»‡å…¥ä»£ç .
**ç¼–è¯‘å™¨ç»‡å…¥**, ä¼šé€ æˆç¼–è¯‘é€Ÿåº¦å˜æ…¢, è€Œä¸”å¿…é¡»ä½¿ç”¨ ajc ç¼–è¯‘å™¨
**åŠ¨æ€ä»£ç†**ä¼šç”Ÿæˆå¤§é‡ä»£ç†ç±», åŠ é€Ÿå†…å­˜æ¶ˆè€—
ä½¿ç”¨ **ç±»åŠ è½½æœŸç»‡å…¥**ç›¸å¯¹äºå…¶ä»–ä¸¤ç§æ–¹å¼, æ›´åŠ è½»ä¾¿.

#### å…·ä½“å®ç°

![20241229154732_9vtdBCZC.webp](https://cdn.dong4j.site/source/image/20241229154732_9vtdBCZC.webp)

##### å®šä¹‰åˆ‡é¢

```
@Aspect
public class TraceAspect {
    private static final Logger log = LoggerFactory.getLogger(TraceAspect.class);
    @Pointcut("execution(* com.xxx.server.rest.resource.impl..*.*(..))")
    public void profileMethod() {

    }
    @Around("profileMethod()")
    public Object profile(ProceedingJoinPoint jp) {
        Object result = "";
        String methodName = jp.getSignature().getName();
        log.error("å‰ç½®é€šçŸ¥");
        // æ‰§è¡Œç›®æ ‡æ–¹æ³•
        try {
            // å‰ç½®é€šçŸ¥
            log.error("The method " + methodName + " begins with " + Arrays.asList(jp.getArgs()));
            result = jp.proceed();
            // è¿”å›é€šçŸ¥
            log.error("The method " + methodName + " ends with " + Arrays.asList(jp.getArgs()));
        } catch (Throwable e) {
            // å¼‚å¸¸é€šçŸ¥
            log.error("The method " + methodName + " occurs expection : " + e);
            throw new RuntimeException(e);
        }
        log.error("get MDC {}", MDC.get(Span.TRACE_ID));
        return result;
    }
}
```

##### å‡†å¤‡ aop.xml

è¿™ä¸ªæ–‡ä»¶è¦æ±‚æ”¾åœ¨ META-INF/aop.xml è·¯å¾„ä¸‹ï¼Œä»¥å‘ŠçŸ¥ AspectJ Weaver æˆ‘ä»¬éœ€è¦æŠŠ ProfilingAspect ç»‡å…¥åˆ°åº”ç”¨çš„å“ªäº›ç±»ä¸­

```
<?xml version="1.0" encoding="UTF-8"?>
<aspectj>
    <weaver>
        <!-- only weave classes in your application-specific packages -->
        <include within="com.xxx.server.rest.resource.impl.*"/>
        <!-- å¿…é¡»åŒ…å«åˆ‡é¢çš„è·¯å¾„ -->
        <include within="com.xxx.trace.client.aspect.*"/>
    </weaver>
    <aspects>
        <!-- weave in just these aspects -->
        <aspect name="com.xxx.trace.client.aspect.TraceAspect"/>
    </aspects>
</aspectj>
```

##### maven ä¾èµ–

```
<dependency>
    <groupId>org.aspectj</groupId>
    <artifactId>aspectjweaver</artifactId>
    <version>1.8.9</version>
</dependency>
<dependency>
    <groupId>org.springframework</groupId>
    <artifactId>spring-aop</artifactId>
    <version>${spring-version}</version>
</dependency>
```

##### é…ç½® applicationContext.xml

aspectj-weaving = on / off / auto-detect
å¦‚æœè®¾ç½®ä¸º auto-detect(é»˜è®¤),
spring å°†ä¼šåœ¨ classpath ä¸­æŸ¥æ‰¾ aspejct éœ€è¦çš„ META-INF/aop.xmlï¼Œ å¦‚æœæ‰¾åˆ°åˆ™å¼€å¯ aspectj weaving

```
<context:load-time-weaver aspectj-weaving="autodetect"/>
```

##### VM å‚æ•°

å¼€å‘æ—¶, idea è®¾ç½®

**tomcat7**

```
-javaagent:/path/to/spring-instrument-4.3.3.RELEASE.jar
-javaagent:/path/to/aspectjweaver-1.8.9.jar
```

**tomcat8**

```
-javaagent:/path/to/aspectjweaver-1.8.9.jar
```

##### tomcat è®¾ç½® javaagent

catalina.sh æœ€å‰é¢æ·»åŠ 

```
JAVA_OPTS="-javaagent:/path/to/spring-instrument-4.3.3.RELEASE.jar -javaagent:/path/to/aspectjweaver-1.8.9.jar"
```

### è°ƒç”¨é“¾æ—¥å¿—

#### æ‰©å±• Filter

@Activate æ˜¯ä¸€ä¸ª Duboo æ¡†æ¶æä¾›çš„æ³¨è§£ã€‚åœ¨ Dubbo å®˜æ–¹æ–‡æ¡£ä¸Šæœ‰è®°è½½ï¼š
å¯¹äºé›†åˆç±»æ‰©å±•ç‚¹ï¼Œæ¯”å¦‚ï¼šFilter, InvokerListener, ExportListener, TelnetHandler, StatusChecker ç­‰ï¼Œ å¯ä»¥åŒæ—¶åŠ è½½å¤šä¸ªå®ç°ã€‚
ä¸»è¦ç”¨å¤„æ˜¯æ ‡æ³¨åœ¨æ’ä»¶æ¥å£å®ç°ç±»ä¸Šï¼Œç”¨æ¥é…ç½®è¯¥æ‰©å±•å®ç°ç±»æ¿€æ´»æ¡ä»¶ã€‚
åœ¨ Dubbo æ¡†æ¶é‡Œé¢çš„ Filter çš„å„ç§å®ç°ç±»éƒ½é€šè¿‡ Activate æ ‡æ³¨ï¼Œç”¨æ¥æè¿°è¯¥ Filter ä»€ä¹ˆæ—¶å€™ç”Ÿæ•ˆã€‚

ç”¨ @Activate æ¥å®ç°ä¸€äº› Filter ï¼Œå¯ä»¥å…·ä½“å¦‚ä¸‹ï¼š

1. æ— æ¡ä»¶è‡ªåŠ¨æ¿€æ´»

   ç›´æ¥ä½¿ç”¨é»˜è®¤çš„æ³¨è§£å³å¯

   ```
   import com.alibaba.dubbo.common.extension.Activate;
   import com.alibaba.dubbo.rpc.Filter;
   @Activate
   // æ— æ¡ä»¶è‡ªåŠ¨æ¿€æ´»
   public class XxxFilter implements Filter {
   // ...
   }
   ```

2. é…ç½® xxx å‚æ•°ï¼Œå¹¶ä¸”å‚æ•°ä¸ºæœ‰æ•ˆå€¼æ—¶æ¿€æ´»ï¼Œæ¯”å¦‚é…äº† cache=â€lruâ€ï¼Œè‡ªåŠ¨æ¿€æ´» CacheFilter

```
import com.alibaba.dubbo.common.extension.Activate;
import com.alibaba.dubbo.rpc.Filter;
@Activate("xxx") // å½“é…ç½®äº† xxx å‚æ•°ï¼Œå¹¶ä¸”å‚æ•°ä¸ºæœ‰æ•ˆå€¼æ—¶æ¿€æ´»ï¼Œæ¯”å¦‚é…äº† cache="lru"ï¼Œè‡ªåŠ¨æ¿€æ´» CacheFilterã€‚
public class XxxFilter implements Filter {
    // ...
}
```

3. åªå¯¹æä¾›æ–¹æ¿€æ´»ï¼Œgroup å¯é€‰ provider æˆ– consumer

```
import com.alibaba.dubbo.common.extension.Activate;
import com.alibaba.dubbo.rpc.Filter;
@Activate(group = {Constants.PROVIDER, Constants.CONSUMER})
// åªå¯¹æä¾›æ–¹æ¿€æ´»ï¼Œgroup å¯é€‰"provider"æˆ–"consumer"
public class XxxFilter implements Filter {
// ...
}

```

åœ¨ `resourves/META-INF/dubbo/com.alibaba.dubbo.prc.Filter` æ–‡ä»¶ä¸­æ·»åŠ è‡ªå®šä¹‰ Filter å…¨ç±»å

```
tracingFilter=com.xxx.trace.client.dubbo.TracingFilter
```

#### è‡ªå®šä¹‰å‚æ•°åœ¨ RPC è¯·æ±‚çš„ä¼ é€’

ä½¿ç”¨ aop, åœ¨ è°ƒç”¨ dubbo æœåŠ¡ä¹‹å‰, é€šè¿‡ `RpcContext.getContext().setAttachments` ä¿å­˜è‡ªå®šä¹‰å‚æ•°
åœ¨æœåŠ¡ç«¯ä½¿ç”¨ `RpcContext.getContext().getAttachment` è·å–è‡ªå®šä¹‰å‚æ•°

![20241229154732_iMzKs24Y.webp](https://cdn.dong4j.site/source/image/20241229154732_iMzKs24Y.webp)

> RpcContext æ˜¯ä¸€ä¸ª ThreadLocal çš„ä¸´æ—¶çŠ¶æ€è®°å½•å™¨ï¼Œå½“æ¥æ”¶åˆ° RPC è¯·æ±‚ï¼Œæˆ–å‘èµ· RPC è¯·æ±‚ æ—¶ï¼ŒRpcContext çš„çŠ¶æ€éƒ½ä¼šå˜åŒ–ã€‚æ¯”å¦‚ï¼šA è°ƒ Bï¼ŒB å†è°ƒ Cï¼Œåˆ™ B
> æœºå™¨ä¸Šï¼Œåœ¨ B è°ƒ C ä¹‹ å‰ï¼ŒRpcContext è®°å½•çš„æ˜¯ A è°ƒ B çš„ä¿¡æ¯ï¼Œåœ¨ B è°ƒ C ä¹‹åï¼ŒRpcContext è®°å½•çš„æ˜¯ B è°ƒ C çš„ ä¿¡æ¯ã€‚

```
/**
 * åœ¨è°ƒç”¨ service çš„æ¥å£ä¹‹å‰ï¼ŒåŠ å…¥ä¸€äº› dubbo çš„éšå¼å‚æ•°
 * 2017-12-13 17:34 dong4j
 */
@Aspect
@Component
public class DubboServiceContextAop {

    @Pointcut("execution(* com.xxx.xxx.service.*.*(..))")
    public void serviceApi() {
    }

    @Before("serviceApi()")
    public void dubboContext(JoinPoint jp) {
        Map<String, String> context = new HashMap<>();
        // todo you want do
        RpcContext.getContext().setAttachments(context);
    }
}
```

```
public class DubboContextFilter implements Filter {
    @Override
    public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {
        String var= RpcContext.getContext().getAttachment( ä» Aop ä¸­æ”¾å…¥çš„);
        // todo å…¶ä»–ç›¸å…³å¤„ç†
        return invoker.invoke(invocation);
    }
}

```

**RpcContext ç›¸å…³ API**

```
// è¿œç¨‹è°ƒç”¨
xxxService.xxx();
// æœ¬ç«¯æ˜¯å¦ä¸ºæ¶ˆè´¹ç«¯ï¼Œè¿™é‡Œä¼šè¿”å› true
boolean isConsumerSide = RpcContext.getContext().isConsumerSide();
// è·å–æœ€åä¸€æ¬¡è°ƒç”¨çš„æä¾›æ–¹ IP åœ°å€
String serverIP = RpcContext.getContext().getRemoteHost();
// è·å–å½“å‰æœåŠ¡é…ç½®ä¿¡æ¯ï¼Œæ‰€æœ‰é…ç½®ä¿¡æ¯éƒ½å°†è½¬æ¢ä¸º URL çš„å‚æ•°
String application = RpcContext.getContext().getUrl().getParameter("application");
// æ³¨æ„ï¼šæ¯å‘èµ· RPC è°ƒç”¨ï¼Œä¸Šä¸‹æ–‡çŠ¶æ€ä¼šå˜åŒ–
yyyService.yyy();
```

```
public class XxxServiceImpl implements XxxService {
    public void xxx() {
        // æœ¬ç«¯æ˜¯å¦ä¸ºæä¾›ç«¯ï¼Œè¿™é‡Œä¼šè¿”å› true
        boolean isProviderSide = RpcContext.getContext().isProviderSide();
        // è·å–è°ƒç”¨æ–¹ IP åœ°å€
        String clientIP = RpcContext.getContext().getRemoteHost();
        // è·å–å½“å‰æœåŠ¡é…ç½®ä¿¡æ¯ï¼Œæ‰€æœ‰é…ç½®ä¿¡æ¯éƒ½å°†è½¬æ¢ä¸º URL çš„å‚æ•°
        String application = RpcContext.getContext().getUrl().getParameter("applicatio
        n");
        // æ³¨æ„ï¼šæ¯å‘èµ· RPC è°ƒç”¨ï¼Œä¸Šä¸‹æ–‡çŠ¶æ€ä¼šå˜åŒ–
        yyyService.yyy();
        // æ­¤æ—¶æœ¬ç«¯å˜æˆæ¶ˆè´¹ç«¯ï¼Œè¿™é‡Œä¼šè¿”å› false
        boolean isProviderSide = RpcContext.getContext().isProviderSide();
    }
}
```

#### traceId çš„ä¼ é€’è¿‡ç¨‹

##### ç”Ÿæˆ traceId

åœ¨å¤„ç†å‰ç«¯è¯·æ±‚ä¹‹å‰, ä½¿ç”¨ `LoggerFilter` æ‹¦æˆªè¯·æ±‚, é€šè¿‡ SnowFlake ç”Ÿæˆ traceId, å¹¶å­˜å…¥ MDC ä¸­

```java
@Slf4j
public class LoggerFilter extends AbstractRequestLoggingFilter {

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response,
                                    final FilterChain filterChain)
        throws ServletException, IOException {
        final String traceId = "" + new SnowflakeId(0).generate();
        MDC.put(Span.TRACE_ID, traceId);

        ...
        super.doFilterInternal(request, response, filterChain);
        ...
        log.error(ApiLog.buildApiLog(EventType.invoke_interface, request.getRequestURI(), request.getHeader("token"), response.getStatus(), EventLog.MONITOR_STATUS_SUCCESS, "æˆ‘æ˜¯mock apiæˆåŠŸæ—¥å¿—").toString());
        // è¯·æ±‚å¤„ç†å®Œæˆåæ¸…ç† MDC ä¸­çš„å€¼
        MDC.remove(Span.TRACE_ID);
    }
    @Override
    protected void beforeRequest(HttpServletRequest request, String message) {
    }

    @Override
    protected void afterRequest(HttpServletRequest request, String message) {
    }
}
```

##### æœåŠ¡é—´ä¼ é€’ traceId

å­˜æ”¾åœ¨ MDC ä¸­çš„å€¼åªæœ‰åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­æ‰èƒ½å…±äº«, å½“å‘èµ· Rpc è°ƒç”¨å, è‚¯å®šä¸æ˜¯åŒä¸€ä¸ªçº¿ç¨‹, å› æ­¤ä½¿ç”¨ RpcContext æ¥ä¼ é€’ Rpc traceId

**æœåŠ¡è°ƒç”¨ä¹‹å‰, æ¶ˆè´¹è€…ç«¯**

é€šè¿‡ `RpcContext.getContext().setAttachments("traceId",MDC.get("traceId"))` å°† traceId å­˜å…¥ RpcContext

**æœåŠ¡è°ƒç”¨ä¹‹å, æä¾›è€…ç«¯**

é€šè¿‡ `RpcContext.rpcContext.getAttachment("traceId")` ä» RpcContext ä¸­è·å– traceId, å¹¶ä½¿ç”¨ `MDC.put("traceId", traceId)` å°† traceId å­˜å…¥å½“å‰çº¿ç¨‹ä¸­,
ä¾¿äºä¸šåŠ¡æ—¥å¿—æ‰“å°

##### åˆ é™¤ traceId

è¯·æ±‚å®Œæˆå, dubbo æœåŠ¡çº¿ç¨‹è‡ªåŠ¨é”€æ¯, åªéœ€è¦åœ¨ `LoggerFilter` ä¸­è°ƒç”¨ `MDC.clear()` æ¸…é™¤ MDC

## ä¼ è¾“æ—¥å¿—

kafka

http://blog.csdn.net/honglei915/article/details/37563647

## åŠ¨æ€ä¿®æ”¹æ—¥å¿—çº§åˆ«

è¿™é‡Œé€‰æ‹©ä½¿ç”¨ JMX æ¥å®ç°æ—¥å¿—çº§åˆ«åŠ¨æ€ä¿®æ”¹.

### å…·ä½“å®ç°

#### ç›‘å¬å®¹å™¨å¯åŠ¨

å½“å®¹å™¨å¯åŠ¨æ—¶, è·å–åº”ç”¨å, ç„¶ååˆ›å»º zookeeper ä¸´æ—¶èŠ‚ç‚¹

ä»¥å‰ä½¿ç”¨ `ServerListener` å®ç°, ä½†æ˜¯è¿™ç§æ–¹å¼éœ€è¦ä¿®æ”¹ web.xml, æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰ ServerListener ç›‘å¬å™¨.

è¿™é‡Œé‡æ„ä¸‹, å°†ç›‘å¬å®¹å™¨å¯åŠ¨ç„¶ååˆ›å»º zookeeper èŠ‚ç‚¹çš„é€»è¾‘è¿å…¥åˆ° xxx-trace æ¨¡å—ä¸­

```java
@Component
@Slf4j
public class ApplicationEventHandle implements ApplicationListener, ApplicationContextAware {
    @Autowired
    private TraceConfig traceConfig;
    // æ³¨å…¥ ServletContext
    @Autowired
    private ServletContext servletContext;


    /**
     * Sets application context.
     * è·å–åº”ç”¨ä¸Šä¸‹æ–‡, ä»è€Œè·å– speing ç®¡ç†çš„ bean
     * @param applicationContext the application context
     * @throws BeansException the beans exception
     */
    @Override
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException { }

    /**
     * On application event.
     * ç›‘å¬åº”ç”¨å¯åŠ¨äº‹ä»¶
     * @param applicationEvent the application event
     */
    @Override
    public void onApplicationEvent(ApplicationEvent applicationEvent) {
        if (applicationEvent instanceof ContextRefreshedEvent) {
            ContextRefreshedEvent contextRefreshedEvent = (ContextRefreshedEvent) applicationEvent;
            // root application context æ²¡æœ‰ parentï¼Œä»–å°±æ˜¯è€å¤§.
            if (contextRefreshedEvent.getApplicationContext().getParent()== null) {
                // éœ€è¦æ‰§è¡Œçš„é€»è¾‘ä»£ç ï¼Œå½“ spring å®¹å™¨åˆå§‹åŒ–å®Œæˆåå°±ä¼šæ‰§è¡Œè¯¥æ–¹æ³•ã€‚
                log.error("spring å®¹å™¨åˆå§‹åŒ–å®Œæˆ: {}", applicationEvent.getClass());

                // è·å– ServletContext å®¹å™¨æœªåˆå§‹åŒ–å®Œæˆ, ä½¿ç”¨è¿™ç§æ–¹å¼ä¼šæŠ¥ç©ºæŒ‡é’ˆ
                // WebApplicationContext webApplicationContext = ContextLoader.getCurrentWebApplicationContext();
                // ServletContext servletContext = webApplicationContext.getServletContext();
                DynamicChangeLogLevel.initZookeeperNode(traceConfig.getZookeeperHost(), servletContext
                    .getServletContextName());
            }
        } // åº”ç”¨å¯åŠ¨ï¼Œéœ€è¦åœ¨ä»£ç åŠ¨æ€æ·»åŠ ç›‘å¬å™¨æ‰å¯æ•è·
        else if (applicationEvent instanceof ContextStartedEvent) {
            log.error("åº”ç”¨å¯åŠ¨äº‹ä»¶: {}", applicationEvent.getClass());
        }
        // åº”ç”¨åœæ­¢ (context.stop();)
        else if (applicationEvent instanceof ContextStoppedEvent) {
            log.error("åº”ç”¨åœæ­¢äº‹ä»¶: {}", applicationEvent.getClass());
            // é˜²æ­¢åŠ¨æ€ä¿®æ”¹æ—¥å¿—çº§åˆ«æ—¶å†…å­˜æº¢å‡º
            LoggerContext loggerContext = (LoggerContext) LoggerFactory.getILoggerFactory();
            loggerContext.stop();
        }
        // åº”ç”¨å…³é—­ (å¼ºåˆ¶ stop)
        else if (applicationEvent instanceof ContextClosedEvent) {
            log.error("åº”ç”¨å…³é—­äº‹ä»¶: {}", applicationEvent.getClass());
        } else {
            log.error("å…¶ä»–äº‹ä»¶: {}", applicationEvent.getClass());
        }
    }
}
```

#### zk èŠ‚ç‚¹ç»„æˆ

- loglevel
  - applicationName1
    - serviceHost1:servicePort1 --> data = defaultLogLevel
    - serviceHost2:servicePort2 --> data = defaultLogLevel
  - applicationName2
    - serviceHost1:servicePort1 --> data = defaultLogLevel

root èŠ‚ç‚¹ä¸‹, æ ¹æ® **åº”ç”¨å** åŒºåˆ†ä¸åŒåº”ç”¨
é›†ç¾¤éƒ¨ç½²æ—¶, ç›¸åŒåº”ç”¨åæ ¹æ® host å’Œ port åŒºåˆ†, ä¿®æ”¹æŸä¸ªèŠ‚ç‚¹, ä¸ä¼šå½±å“å…¶ä»–èŠ‚ç‚¹.

![20241229154732_ckNH2G92.webp](https://cdn.dong4j.site/source/image/20241229154732_ckNH2G92.webp)

#### å…¶ä»–æ¨¡å—æ¥å…¥

pom.xml é…ç½®

æ·»åŠ  `name` æ ‡ç­¾, ç”¨äºç»Ÿä¸€æ ‡è¯†åº”ç”¨å, ä½¿ç”¨ `${project.name}` è·å– `name` å€¼

```
<name> åº”ç”¨å </name>
```

æ¯”å¦‚åœ¨ logback.xml ä¸­, å‘ JMX æ³¨å†Œ MBean, éœ€è¦æ ‡è¯†å½“å‰åº”ç”¨å
logback.xml é…ç½®

```xml
<?xml version="1.0" encoding="UTF-8"?>

<configuration>
    <!-- è®¾ç½®åˆ«å å¿…é¡»åœ¨ <jmxConfigurator/> ä¹‹å‰è®¾ç½® -->
    <contextName>${project.name}</contextName>
    <!--JMX ç›‘æ§ -->
    <jmxConfigurator/>
    <statusListener class="ch.qos.logback.core.status.OnConsoleStatusListener"/>
    <!-- MDC å¤„ç† -->
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>[%d{yyyy-MM-dd HH:mm:ss.SSS}] [%thread] %-5level %logger{5} - %X{traceId} - %X{platformType} - %X{clientVersion} - %msg%n
            </pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>
    <root level="DEBUG">
        <appender-ref ref="STDOUT"/>
        <!--<appender-ref ref="FILE" />-->
    </root>
    <logger name="com.xxx" level="DEBUG"/>
</configuration>
```

åªéœ€è¦åœ¨ web.xml æ·»åŠ ä»¥ä¸‹é…ç½®, ç”¨äºæ ‡è¯†å½“å‰åº”ç”¨

```xml
<display-name> åº”ç”¨å </display-name>
<context-param>
    <param-name>webAppRootKey</param-name>
    <param-value> åº”ç”¨å </param-value>
</context-param>
```

ä¸ºäº†ä¾¿äºç®¡ç†åº”ç”¨å, è¿™é‡Œä½¿ç”¨ pom.xml ä¸­çš„ name æ ‡ç­¾æ¥è®¾ç½® web.xml ä¸­çš„è®¾ç½®

åœ¨ pom.xml ä¸­æ·»åŠ  `maven-war-plugin` æ’ä»¶

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-war-plugin</artifactId>
    <version>2.6</version>
    <configuration>
        <webResources>
            <resource>
                <directory>src/main/webapp</directory>
                <filtering>true</filtering>
            </resource>
        </webResources>
    </configuration>
</plugin>
```

ç„¶å web.xml çš„é…ç½®å°±å¯ä»¥ä¿®æ”¹ä¸º

```xml
<display-name>${project.name}</display-name>
<context-param>
    <param-name>webAppRootKey</param-name>
    <param-value>${project.name}</param-value>
</context-param>
```

æœ€ååœ¨ applicationContext.xml å¼•å…¥ xxx-config.xml

```
<import resource="classpath:xxx-config.xml"/>
```

### æ—¥å¿—èŠ‚ç‚¹ç›‘æ§å’Œä¿®æ”¹æ—¥å¿—æ¥å£

### ç›‘æ§

### æ¥å£

1. è·å–æ‰€æœ‰åº”ç”¨åˆ—è¡¨
2. åº”ç”¨çš„å½“å‰æ—¥å¿—çº§åˆ« (root, com.xxx)
3. ä¿®æ”¹æŸä¸ªåº”ç”¨çš„æ—¥å¿— (root, com.xxx)
4. ä¿®æ”¹å…¨éƒ¨åº”ç”¨çš„æ—¥å¿— (root, com.xxx)
5. é‡ç½®å…¨éƒ¨æ—¥å¿—çº§åˆ«

## æ—¥å¿—ç±»å‹

| æ—¥å¿—ç±»å‹         | è¯´æ˜                                       |
| :--------------- | :----------------------------------------- |
| normal           | æ­£å¸¸å…¥åº“æ—¥å¿—                               |
| invoke_interface | api è°ƒç”¨æ—¥å¿—                               |
| middleware_opt   | ä¸­é—´ä»¶æ“ä½œæ—¥å¿— (ç›®å‰ä»…æ”¯æŒ hbase å’Œ mongo) |
| job_execute      | job æ‰§è¡Œæ—¥å¿—                               |
| rpc_trace        | rpc trace è·Ÿè¸ªæ—¥å¿—                         |
| custom_log       | è‡ªå®šä¹‰åŸ‹ç‚¹æ—¥å¿—                             |
| thirdparty_call  | ç¬¬ä¸‰æ–¹ç³»ç»Ÿè°ƒç”¨æ—¥å¿—                         |

### æ­£å¸¸æ—¥å¿—

```shell
LOGGER.info("æˆ‘æ˜¯æµ‹è¯•æ—¥å¿—æ‰“å°")
```

### api æ—¥å¿—

```shell
// å‚æ•°ä¾æ¬¡ä¸º EventType(äº‹ä»¶ç±»å‹)ã€apiã€è´¦å·ã€è¯·æ±‚è€—æ—¶ã€æˆåŠŸè¿˜æ˜¯å¤±è´¥ã€å…·ä½“è‡ªå®šä¹‰çš„æ—¥å¿—å†…å®¹
LOGGER.info(ApiLog.buildApiLog(EventType.invoke_interface, "/app/status", "800001", 100, EventLog.MONITOR_STATUS_SUCCESS, "æˆ‘æ˜¯mock apiæˆåŠŸæ—¥å¿—").toString());
LOGGER.info(ApiLog.buildApiLog(EventType.invoke_interface, "/app/status", "800001", 10, EventLog.MONITOR_STATUS_FAILED, "æˆ‘æ˜¯mock apiå¤±è´¥æ—¥å¿—").toString());
```

### ä¸­é—´ä»¶æ—¥å¿—

```shell
// å‚æ•°ä¾æ¬¡ä¸º EventType(äº‹ä»¶ç±»å‹)ã€MiddleWare(ä¸­é—´ä»¶åç§°)ã€æ“ä½œè€—æ—¶ã€æˆåŠŸè¿˜æ˜¯å¤±è´¥ã€å…·ä½“è‡ªå®šä¹‰çš„æ—¥å¿—å†…å®¹
LOGGER.info(EventLog.buildEventLog(EventType.middleware_opt, MiddleWare.HBASE.symbol(), 100, EventLog.MONITOR_STATUS_SUCCESS, "æˆ‘æ˜¯mock middle wareæˆåŠŸæ—¥å¿—").toString());
LOGGER.info(EventLog.buildEventLog(EventType.middleware_opt, MiddleWare.MONGO.symbol(), 10, EventLog.MONITOR_STATUS_FAILED, "æˆ‘æ˜¯mock middle wareå¤±è´¥æ—¥å¿—").toString());
```

### job æ‰§è¡Œæ—¥å¿—

```
// job æ‰§è¡Œä»…ä»…å¤„ç†å¤±è´¥çš„æ—¥å¿—ï¼ˆæˆåŠŸçš„ä¸åšå¤„ç†ï¼Œæ‰€ä»¥åªéœ€è¦æ„é€ å¤±è´¥çš„æ—¥å¿—ï¼‰, å‚æ•°ä¾æ¬¡ä¸º EventType(äº‹ä»¶ç±»å‹)ã€job çš„ id å·ã€æ“ä½œè€—æ—¶ã€å¤±è´¥ã€å…·ä½“è‡ªå®šä¹‰çš„æ—¥å¿—å†…å®¹
LOGGER.info(EventLog.buildEventLog(EventType.job_execute, "application_1477705439920_0544", 10, EventLog.MONITOR_STATUS_FAILED, "æˆ‘æ˜¯mock job execå¤±è´¥æ—¥å¿—").toString());
```

### ç¬¬ä¸‰æ–¹è¯·æ±‚æ—¥å¿—

```
// å‚æ•°ä¾æ¬¡ä¸º EventType(äº‹ä»¶ç±»å‹)ã€ç¬¬ä¸‰æ–¹åç§°ã€æ“ä½œè€—æ—¶ã€æˆåŠŸè¿˜æ˜¯å¤±è´¥ã€å…·ä½“è‡ªå®šä¹‰çš„æ—¥å¿—å†…å®¹
LOGGER.info(EventLog.buildEventLog(EventType.thirdparty_call, "xx1", 100, EventLog.MONITOR_STATUS_FAILED, "æˆ‘æ˜¯mock third å¤±è´¥æ—¥å¿—").toString());
LOGGER.info(EventLog.buildEventLog(EventType.thirdparty_call, "xx1", 100, EventLog.MONITOR_STATUS_SUCCESS, "æˆ‘æ˜¯mock third æˆåŠŸæ—¥å¿—").toString());
LOGGER.info(EventLog.buildEventLog(EventType.thirdparty_call, "xx2", 100, EventLog.MONITOR_STATUS_SUCCESS, "æˆ‘æ˜¯mock third æˆåŠŸæ—¥å¿—").toString());
LOGGER.info(EventLog.buildEventLog(EventType.thirdparty_call, "xx2", 100, EventLog.MONITOR_STATUS_FAILED, "æˆ‘æ˜¯mock third å¤±è´¥æ—¥å¿—").toString());
```

## [å£°ç½‘Agora SDKé›†æˆæ•™ç¨‹ï¼šJavaå®¢æˆ·ç«¯APIè¯¦è§£](https://blog.dong4j.site/posts/7ef4d1ad.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## å£°ç½‘ä¸»è¦äº§å“

å£°ç½‘ä¸»è¦æä¾›ä»¥ä¸‹å‡ ç±»äº§å“ï¼š

**1. å®æ—¶äº’åŠ¨åŸºç¡€èƒ½åŠ›**ï¼š

- **è¯­éŸ³é€šè¯**ï¼š ä¸€å¯¹ä¸€ï¼Œå¤šäººå®æ—¶è¯­éŸ³é€šè¯ã€‚
- **è§†é¢‘é€šè¯**ï¼š ä¸€å¯¹ä¸€ï¼Œå¤šäººå®æ—¶è§†é¢‘é€šè¯ã€‚
- **ç›´æ’­**ï¼š æä¾›ä½å»¶æ—¶ã€å¼ºåŒæ­¥ã€å¤§å¹¶å‘ã€é«˜è´¨é‡çš„äº’åŠ¨ç›´æ’­èƒ½åŠ›ã€‚
- **å®æ—¶æ¶ˆæ¯**ï¼š è¶…ä½å»¶è¿Ÿçš„å…¨çƒä¿¡ä»¤ä¸æ¶ˆæ¯äº‘æœåŠ¡ã€‚
- **å³æ—¶é€šè®¯ IM**ï¼š å•èŠã€ç¾¤èŠã€èŠå¤©å®¤ã€ç³»ç»Ÿé€šçŸ¥ç­‰ IM åŠŸèƒ½ã€‚
- **åª’ä½“æµåŠ é€Ÿ**ï¼š å…·å¤‡ QoS ä¿éšœçš„å…¨çƒç«¯åˆ°ç«¯åŠ é€ŸæœåŠ¡ã€‚

**2. å®æ—¶äº’åŠ¨æ‰©å±•èƒ½åŠ›**ï¼š

- **æ°´æ™¶çƒ**ï¼š å®æ—¶ç›‘æ§ã€å‘Šè­¦é€šçŸ¥ã€é€šè¯è°ƒæŸ¥ã€æ•°æ®æ´å¯Ÿã€‚
- **äº’åŠ¨ç™½æ¿**ï¼š H5 è¯¾ä»¶ã€åŠ¨æ€ PPTã€è½¨è¿¹ä¸éŸ³è§†é¢‘åŒæ­¥ã€‚
- **å®æ—¶å½•åˆ¶**ï¼š äº‘ç«¯å½•åˆ¶ã€æœ¬åœ°æœåŠ¡ç«¯å½•åˆ¶ã€é¡µé¢å½•åˆ¶ã€‚
- **å‡¤é¸£ AI å¼•æ“**ï¼š æ–°ä¸€ä»£éŸ³é¢‘æŠ€æœ¯æ™ºèƒ½å¼•æ“ï¼ŒåŒ…æ‹¬ç©ºé—´éŸ³é¢‘ã€AI é™å™ªã€è™šæ‹Ÿå£°å¡ç­‰åŠŸèƒ½ã€‚
- **Status Page**ï¼š é›†ä¸­å±•ç¤ºå£°ç½‘ä¸»è¦äº§å“åŠæœåŠ¡çš„ç»¼åˆæœåŠ¡è´¨é‡åŠå¯ç”¨æ€§ä¿¡æ¯ã€‚

**3. ä½ä»£ç åº”ç”¨å¹³å°**ï¼š

- **çµåŠ¨è¯¾å ‚**ï¼š 15 åˆ†é’Ÿä¸Šçº¿è‡ªç”±å“ç‰Œäº’åŠ¨æ•™å­¦å¹³å°ã€‚
- **çµéš¼ç‰©è”ç½‘äº‘å¹³å°**ï¼š ã€Œè€³èªç›®æ˜ã€æ™ºèƒ½ç¡¬ä»¶éŸ³è§†é¢‘ä½“éªŒå‡çº§ã€‚

## ä¸»è¦è§£å†³çš„é—®é¢˜

å£°ç½‘äº§å“ä¸»è¦è§£å†³ä»¥ä¸‹é—®é¢˜ï¼š

- **ä½å»¶è¿Ÿã€é«˜å¯é **ï¼š æä¾›ä½å»¶è¿Ÿã€é«˜å¯é çš„å®æ—¶äº’åŠ¨èƒ½åŠ›ï¼Œæ»¡è¶³å„ç±»å®æ—¶äº’åŠ¨åº”ç”¨çš„éœ€æ±‚ã€‚
- **å¯æ‰©å±•æ€§**ï¼š äº§å“æ”¯æŒæµ·é‡ç”¨æˆ·åŒæ—¶åœ¨çº¿ï¼Œå¯æ‰©å±•æ€§å¼ºï¼Œæ»¡è¶³ä¸åŒè§„æ¨¡çš„åº”ç”¨éœ€æ±‚ã€‚
- **å®‰å…¨æ€§**ï¼š äº§å“å…·å¤‡æ•°æ®å®‰å…¨ä¿éšœå’Œä¸ªäººéšç§ä¿æŠ¤æœºåˆ¶ï¼Œç¡®ä¿ç”¨æˆ·æ•°æ®å®‰å…¨ã€‚
- **æ˜“ç”¨æ€§**ï¼š äº§å“æä¾›ä¸°å¯Œçš„ API å’Œå¼€å‘æ–‡æ¡£ï¼Œæ–¹ä¾¿å¼€å‘è€…å¿«é€Ÿé›†æˆå’Œä½¿ç”¨ã€‚
- **å®šåˆ¶åŒ–**ï¼š äº§å“æ”¯æŒå®šåˆ¶åŒ–å¼€å‘ï¼Œæ»¡è¶³ä¸åŒåœºæ™¯çš„ä¸ªæ€§åŒ–éœ€æ±‚ã€‚

## ä¸šåŠ¡åœºæ™¯

æ‰‹æœºç«¯å’Œ PC ç«¯éœ€è¦è¿›è¡Œè¯­éŸ³èŠå¤©, ä¸»è¦åŠŸèƒ½ä¸º:

1. Web ç«¯

   - å‘¼å«åŠŸèƒ½
     - å¼¹å‡ºæ–°çª—å£, å‘¼å«æŒ‰é’®ç½®ç°
     - å®æ—¶ç›‘æ§å‘¼å«
     - æˆ‘çš„è½¦è¾†å‘¼å«
     - ç¬¬ä¸‰æ–¹è´§ä¸»æ´¾è½¦å‘¼å«
     - å¸æœºç®¡ç†å‘¼å«
     - è´§ä¸»æ¥æ”¶æŠ¢å•å‘¼å«
     - è¿å•ä½œä¸šå‘¼å«
   - å‘¼å«è®°å½•
     - å‘¼å‡ºè®°å½•
     - å‘¼å…¥è®°å½•(æŸ¥)

2. å®¢æˆ·ç«¯æ¥å£

   - å»ºç¾¤
   - è§£æ•£ç¾¤
   - æ·»åŠ æˆå‘˜
   - æˆå‘˜åˆ—è¡¨
   - éªŒè¯æ¶ˆæ¯
   - è¸¢äºº
   - ç¾¤åˆ—è¡¨
   - ç”¨æˆ· id åŠ å¯†
   - å£°ç½‘ è¯ä¹¦ token å¤„ç†

3. æ—¥å¿—
   - ç¾¤ç»„ç®¡ç†è®°å½•
   - å‘¼å«è®°å½•(å†™å…¥)

## å£°ç½‘åè¯è§£é‡Š

å…³é”®è¯:

**App ID**

å¼€å‘è€…åœ¨æˆ‘ä»¬å®˜ç½‘æ³¨å†Œåï¼Œå¯ä»¥åˆ›å»ºå¤šä¸ªé¡¹ç›®ï¼Œæ¯ä¸€ä¸ªé¡¹ç›®å¯¹åº”çš„å”¯ä¸€æ ‡è¯†å°±æ˜¯ App IDã€‚ å¦‚æœæœ‰äººéæ³•è·å–äº†ä½ çš„ App IDï¼Œä»–å°†å¯ä»¥åœ¨ Agora æä¾›çš„ SDK ä¸­ä½¿ç”¨ä½ çš„ App IDï¼Œå¦‚æœä»–çŸ¥é“ä½ çš„é¢‘é“åå­—ï¼Œç”šè‡³æœ‰å¯èƒ½å¹²æ‰°ä½ æ­£å¸¸çš„é€šè¯ã€‚

æ‰€ä»¥å»ºè®®ä»…åœ¨æµ‹è¯•é˜¶æ®µæˆ–å¯¹å®‰å…¨æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯é‡Œä½¿ç”¨ App IDã€‚

ä½¿ç”¨ä¸åŒ App ID çš„åº”ç”¨ç¨‹åºæ˜¯ä¸èƒ½äº’é€šçš„ã€‚å¦‚æœå·²åœ¨é€šè¯ä¸­ï¼Œç”¨æˆ·å¿…é¡»è°ƒç”¨ leaveChannel() é€€å‡ºå½“å‰é€šè¯ï¼Œæ‰èƒ½è¿›å…¥ä¸‹ä¸€ä¸ªé¢‘é“

**Dynamic Key**

å½“é¡¹ç›®å‡†å¤‡æ­£å¼ä¸Šçº¿è¿è¥ï¼Œå»ºè®®å¼€å‘è€…é‡‡ç”¨ Dynamic Keyï¼Œè¿™æ˜¯ä¸€ä¸ªæ›´ä¸ºå®‰å…¨çš„ç”¨æˆ·èº«ä»½éªŒè¯æ–¹æ¡ˆã€‚é’ˆå¯¹ä¸åŒçš„æœåŠ¡ï¼ŒDynamic Key æœ‰ä¸åŒçš„åç§°:

1. Channel Key ç”¨äºåŠ å…¥é¢‘é“;
2. Signaling Key ç”¨äºç™»å½•ä¿¡ä»¤ç³»ç»Ÿ;

**App Certificate**

å°†æ‚¨çš„ App Certificate ä¿å­˜åœ¨æœåŠ¡å™¨ç«¯ï¼Œä¸”å¯¹ä»»ä½•å®¢æˆ·ç«¯å‡ä¸å¯è§ã€‚
é€šå¸¸ App Certificate åœ¨å¯ç”¨ä¸€å°æ—¶åç”Ÿæ•ˆã€‚

å½“é¡¹ç›®çš„ App Certificate è¢«å¯ç”¨åï¼Œæ‚¨å¿…é¡»ä½¿ç”¨ Dynamic Keyã€‚ä¾‹å¦‚: åœ¨å¯ç”¨ App Certificate å‰ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ App ID åŠ å…¥é¢‘é“ã€‚ä½†å¯ç”¨äº† App Certificate åï¼Œæ‚¨å¿…é¡»ä½¿ç”¨ Channel Key åŠ å…¥é¢‘é“ã€‚

**channel**

æ ‡è¯†é€šè¯çš„é¢‘é“åç§°ï¼Œé•¿åº¦åœ¨ 64 å­—èŠ‚ä»¥å†…çš„å­—ç¬¦ä¸²

å¯ä»¥ç†è§£ä¸ºæˆ¿é—´å

è¦è¿›è¡Œè¯­éŸ³æˆ–è€…è§†é¢‘, ä¸åŒçš„ç”¨æˆ·éƒ½å¿…é¡»åœ¨åŒä¸€ä¸ª channel ä¸­

![20241229154732_jLP435rJ.webp](https://cdn.dong4j.site/source/image/20241229154732_jLP435rJ.webp)

**channel key**

å®‰å…¨è¦æ±‚ä¸é«˜: å°†å€¼è®¾ä¸º null
å®‰å…¨è¦æ±‚é«˜: å°†å€¼è®¾ç½®ä¸º Channel Keyã€‚ å¦‚æœä½ å·²ç»å¯ç”¨äº† App Certificate, è¯·åŠ¡å¿…ä½¿ç”¨ Channel Keyã€‚

**UID**

ç”¨æˆ·ä½ç§»è¡¨ç¤º

åŒä¸€ä¸ªé¢‘é“é‡Œä¸èƒ½å‡ºç°ä¸¤ä¸ªç›¸åŒçš„ UIDã€‚å¦‚æœä½ çš„ App æ”¯æŒå¤šè®¾å¤‡åŒæ—¶ç™»å½•ï¼Œå³åŒä¸€ä¸ªç”¨æˆ·è´¦å·å¯ä»¥åœ¨ä¸åŒçš„è®¾å¤‡ä¸ŠåŒæ—¶ç™»å½• (ä¾‹å¦‚å¾®ä¿¡æ”¯æŒåœ¨ PC ç«¯å’Œç§»åŠ¨ç«¯åŒæ—¶ç™»å½•)ï¼Œè¯·ä¿è¯ä¼ å…¥çš„ UID ä¸ç›¸åŒã€‚ ä¾‹å¦‚ä½ ä¹‹å‰éƒ½æ˜¯ç”¨åŒä¸€ä¸ªç”¨æˆ·æ ‡è¯†ä½œä¸º UID, å»ºè®®ä»ç°åœ¨å¼€å§‹åŠ ä¸Šè®¾å¤‡ ID, ä»¥ä¿è¯ä¼ å…¥çš„ UID ä¸ç›¸åŒ ã€‚å¦‚æœä½ çš„ App ä¸æ”¯æŒå¤šè®¾å¤‡åŒæ—¶ç™»å½•ï¼Œä¾‹å¦‚åœ¨ç”µè„‘ä¸Šç™»å½•æ—¶ï¼Œæ‰‹æœºä¸Šä¼šè‡ªåŠ¨é€€å‡ºï¼Œè¿™ç§æƒ…å†µä¸‹å°±ä¸éœ€è¦åœ¨ UID ä¸Šæ·»åŠ è®¾å¤‡ IDã€‚

**ä¿¡ä»¤ å’Œ é€šä¿¡**

> é¢‘é“ï¼Œå¯ä»¥ç†è§£æˆé€šè®¯çš„æˆ¿é—´ï¼Œä¿¡ä»¤å’Œé€šä¿¡ä¸­çš„é¢‘é“æ˜¯ä¸€ä¸ªæ„æ€ï¼Œåªä¸è¿‡ï¼Œä¿¡ä»¤æ˜¯ç¡®è®¤è¿›å…¥æˆ¿é—´ï¼Œé€šä¿¡æ˜¯åœ¨æˆ¿é—´å†…èŠå¤©ã€‚

https://dev.agora.io/cn/question/1780

**ç¾¤ç»„**

**é€šè¯ç»Ÿè®¡**

### App çš„ç”¨æˆ·ä¹‹é—´è¦å»ºç«‹å’Œå‘èµ·ä¸€ä¸ªå‘¼å«ï¼Œæ•´ä¸ªæµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ

ä»¥ A å‘¼å« B ä¸ºä¾‹ï¼Œä¸€èˆ¬å‘¼å«æµç¨‹å¦‚ä¸‹:

1. A å‘ä¿¡ä»¤æœåŠ¡å™¨å‘èµ·å‘¼å«è¯·æ±‚ã€‚

2. ä¿¡ä»¤æœåŠ¡å™¨æ£€æŸ¥ B æ˜¯å¦åœ¨çº¿:

- å¦‚ä¸åœ¨çº¿ï¼Œå‘ A è¿”å› B ä¸åœ¨çº¿é”™è¯¯ã€‚
- å¦‚åœ¨çº¿ï¼Œä¿¡ä»¤æœåŠ¡å™¨ç”Ÿæˆé¢‘é“åï¼Œè¿”å›ç»™ Aï¼›å¹¶å‘ B æŠ•é€’å‘¼å«ä¿¡ä»¤ã€‚

3. A æ”¶åˆ°ä¿¡ä»¤æœåŠ¡å™¨è¿”å›çš„é¢‘é“åï¼Œå‡†å¤‡åŠ å…¥è¯­éŸ³é¢‘é“ã€‚æ­¤æ—¶ä¸ºåŠ å¿«è¿›é¢‘é“é€Ÿåº¦ï¼Œå¯ä»¥æå‰è¿›å…¥é¢‘é“å¾…å‘½:

- A è°ƒç”¨ muteLocalAudioStream(true) å’Œ muteLocalVideoStream(true)ï¼ˆå¦‚æœ‰è§†é¢‘åŠŸèƒ½ï¼‰ç¦æ­¢å‘é€éŸ³è§†é¢‘æ•°æ®ã€‚
- è°ƒç”¨ joinChannel è¿›å…¥é¢‘é“ã€‚

4. B æ”¶åˆ°ä¿¡ä»¤æœåŠ¡å™¨æŠ•é€’è¿‡æ¥çš„ A çš„å‘¼å«è¯·æ±‚ã€‚

- B å“é“ƒã€‚ ä¸ºåŠ å¿«è¿›é¢‘é“é€Ÿåº¦ï¼Œå¯ä»¥æäº¤è¿›å…¥é¢‘é“å¾…å‘½ã€‚
- B è°ƒç”¨ muteLocalAudioStream(true) å’Œ muteLocalVideoStream(true)ï¼ˆå¦‚æœ‰è§†é¢‘åŠŸèƒ½ï¼‰ç¦æ­¢å‘é€éŸ³è§†é¢‘æ•°æ®ã€‚

5. A è°ƒç”¨ joinChannel è¿›å…¥é¢‘é“:
   - å¦‚ B æ‹’ç»è¯·æ±‚:
     - B è°ƒç”¨ leaveChannel é€€å‡ºé¢‘é“
     - B å‘ä¿¡ä»¤æœåŠ¡å™¨è¿”å›æ‹’ç»åº”ç­”
     - ä¿¡ä»¤æœåŠ¡å™¨å‘ A è¿”å› B æ‹’ç»åº”ç­”ä¿¡ä»¤
     - A è°ƒç”¨ leaveChannel é€€å‡ºé¢‘é“
   - å¦‚ B æ¥å—è¯·æ±‚:
     - B è°ƒç”¨ muteLocalAudioStream(false) å’Œ muteLocalVideoStream(false) å¼€å§‹å‘é€éŸ³è§†é¢‘æ•°æ®
       - B å‘ä¿¡ä»¤æœåŠ¡å™¨è¿”å›æ¥å—åº”ç­”ä¿¡ä»¤
       - è°ƒç”¨ muteLocalAudioStream(false) å’Œ muteLocalVideoStream(false) å¼€å§‹å‘é€éŸ³è§†é¢‘æ•°æ®

![20241229154732_2cqjFJCm.webp](https://cdn.dong4j.site/source/image/20241229154732_2cqjFJCm.webp)

å‘¼å«å¤±è´¥æˆ–è€…æˆåŠŸ, å®¢æˆ·ç«¯éœ€è¦è°ƒç”¨ xxx æ¥å£å†™æ—¥å¿—

![20241229154732_GzUptBTW.webp](https://cdn.dong4j.site/source/image/20241229154732_GzUptBTW.webp)

![20241229154732_OPhFa2GG.webp](https://cdn.dong4j.site/source/image/20241229154732_OPhFa2GG.webp)

å®¢æˆ·ç«¯å‘¼å« è´§ä¸» (TMS/è´§ä¸» app) éœ€è¦å‘èµ· 2 ä¸ªå‘¼å«, å½“ä¸€æ–¹æ¥é€šæ—¶, å›è°ƒä¸­å…³é—­å¦ä¸€ä¸ªå‘¼å« 4

## å£°ç½‘å®¢æˆ·ç«¯ API

### è´¦å·æ¶ˆæ¯ç³»ç»Ÿ

#### ç™»å½•

```java
public void login(String appId,String account,String token,int uid,String deviceID);

public void login2(String appId,String account,String token,int uid,String deviceID,int retry_time_in_s, int retry_count);
```

#### ç™»å‡º

```java
public void logout();
```

#### æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨çº¿ (isOnline)

```java
public int isOnline();
```

#### å‘é€ç‚¹å¯¹ç‚¹æ¶ˆæ¯ (messageInstantSend)

```java
public void messageInstantSend(String account,int uid,String msg,String msgID);
```

#### è®¾ç½®ç”¨æˆ·å±æ€§ (set_attr)

```java
public void set_attr(String name,String value);
```

#### è·å–è‡ªå·±çš„å±æ€§ (get_attr)

```java
public void get_attr(String name);
```

#### è·å–è‡ªå·±çš„å…¨éƒ¨å±æ€§ (get_attr_all)

```java
public void get_attr_all();
```

#### è·å–æŸä¸ªç”¨æˆ·çš„å±æ€§ (get_user_attr)

```java
public void get_user_attr(String account,String name);

```

#### è·å–æŸä¸ªç”¨æˆ·çš„æ‰€æœ‰å±æ€§ (get_user_attr_all)

```java
public void get_user_attr_all(String account);
```

### é¢‘é“ç³»ç»Ÿ

### åŠ å…¥é¢‘é“ (channelJoin)

```java
public void channelJoin(String channelID);
```

è®©ç”¨æˆ·åŠ å…¥æŒ‡å®šé¢‘é“ã€‚ç”¨æˆ·ä¸€æ¬¡åªèƒ½åŠ å…¥ä¸€ä¸ªé¢‘é“ã€‚å¦‚åŠ å…¥æŒ‡å®šé¢‘é“æ—¶å·²åœ¨å…¶ä»–é¢‘é“ä¸­ï¼Œå°†è‡ªåŠ¨ä»å…¶ä»–é¢‘é“é€€å‡ºã€‚

ç”¨æˆ·åŠ å…¥é¢‘é“æˆåŠŸåï¼Œè‡ªå·±å°†æ”¶åˆ°å›è°ƒ onChannelJoinedï¼Œå…¶ä»–åŒä¸€é¢‘é“å†…ç”¨æˆ·å°†æ”¶åˆ°å›è°ƒ onChannelUserJoinedã€‚ç”¨æˆ·åŠ å…¥å¤±è´¥åï¼Œè‡ªå·±å°†æ”¶åˆ°å›è°ƒ onChannelJoinFailedã€‚

#### ç¦»å¼€é¢‘é“ (channelLeave)

```java
public void channelLeave(String channelID);
```

#### æŸ¥è¯¢é¢‘é“ç”¨æˆ·æ•° (channelQueryUserNum)

```java
public void channelQueryUserNum(String channelID);
```

#### è®¾ç½®é¢‘é“å±æ€§ (channelSetAttr)

```java
public void channelSetAttr(String channelID,String name,String value);
```

#### åˆ é™¤é¢‘é“å±æ€§ (channelDelAttr)

```java
public void channelDelAttr(String channelID,String name);
```

#### åˆ é™¤æ‰€æœ‰é¢‘é“å±æ€§ (channelClearAttr)

```java
public void channelClearAttr(String channelID);
```

#### å‘é€é¢‘é“æ¶ˆæ¯ (messageChannelSend)

```java
public void messageChannelSend(String channelID,String msg,String msgID);
```

### å‘¼å«ç³»ç»Ÿ

#### å‘èµ·å‘¼å« (channelInviteUser)

```java
public void channelInviteUser(String channelID,String account,int uid);

public void channelInviteUser2(String channelID,String account,String extra);
```

è¯¥æ–¹æ³•ç”¨äºå‘èµ·å‘¼å«ï¼Œå³é‚€è¯·æŸç”¨æˆ·åŠ å…¥æŸä¸ªé¢‘é“ã€‚å‘¼å«å’ŒåŠ å…¥é¢‘é“ï¼Œæ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„è¿‡ç¨‹ã€‚ç”¨æˆ·å¿…é¡»è‡ªå·±å†å¦è¡ŒåŠ å…¥é¢‘é“ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©ï¼šå…ˆåŠ å…¥é¢‘é“ï¼Œå†å‘é€å‘¼å«é‚€è¯·æˆ–å…ˆå‘é€å‘¼å«é‚€è¯·ï¼Œå¯¹æ–¹æ¥å—åå†åŠ å…¥é¢‘é“ã€‚å¦‚æœå‘¼å«å¤±è´¥ï¼Œä¼šå›è°ƒ onInviteFailedã€‚å¯èƒ½çš„åŸå› æœ‰ï¼š

1. å¯¹æ–¹ä¸åœ¨çº¿ï¼›
2. æœ¬ç«¯ç½‘ç»œä¸é€šï¼›
3. æœåŠ¡å™¨å¼‚å¸¸

#### æ¥å—å‘¼å« (channelInviteAccept)

```java
public void channelInviteAccept(String channelID,String account,int uid);
```

#### æ‹’ç»å‘¼å« (channelInviteRefuse)

```java
public void channelInviteRefuse(String channelID,String account,int uid);
```

#### ç»“æŸå‘¼å« (channelInviteEnd)

```java
public void channelInviteEnd(String channelID,String account,int uid);
```

## å£°ç½‘ SDK é›†æˆ

### API demo

**Android**

```java
RtcEngine rtcEngine = RtcEngine.create(mContext, appId, mEngineEventHandler.mRtcEventHandler);
rtcEngine.joinChannel(null, channel, "Extraoptional data", uid);
mRtcEngine.leaveChannel();
```

**Web**

```javascript
var client = AgoraRTC.createRtcClient();
client.init(
  appId,
  function () {
    client.join(appId, channel, undefined, successCallback, errorCallback);
  },
  errorCallback
);
```

**iOS**

```javascript
let engine = AgoraRtcEngineKit.sharedEngineWithAppId("AppId", delegate: self)
engine.enableVideo()
engine.joinChannelByKey(nil, channelName: "channelName", info: nil, uid: 0, joinSuccess: nil)
```

## [å£°ç½‘é›†æˆï¼šæŒæ¡App IDã€Dynamic Keyå’ŒUIDï¼Œæ‰“é€ å®‰å…¨é€šè¯ç¯å¢ƒ](https://blog.dong4j.site/posts/d8c7081e.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

å£°ç½‘é›†æˆç›¸å…³

<!-- more -->

å…³é”®è¯:

**App ID**

å¼€å‘è€…åœ¨æˆ‘ä»¬å®˜ç½‘æ³¨å†Œåï¼Œå¯ä»¥åˆ›å»ºå¤šä¸ªé¡¹ç›®ï¼Œæ¯ä¸€ä¸ªé¡¹ç›®å¯¹åº”çš„å”¯ä¸€æ ‡è¯†å°±æ˜¯ App IDã€‚ å¦‚æœæœ‰äººéæ³•è·å–äº†ä½ çš„ App IDï¼Œä»–å°†å¯ä»¥åœ¨ Agora æä¾›çš„ SDK ä¸­ä½¿ç”¨ä½ çš„
App IDï¼Œå¦‚æœä»–çŸ¥é“ä½ çš„é¢‘é“åå­—ï¼Œç”šè‡³æœ‰å¯èƒ½å¹²æ‰°ä½ æ­£å¸¸çš„é€šè¯ã€‚

æ‰€ä»¥å»ºè®®ä»…åœ¨æµ‹è¯•é˜¶æ®µæˆ–å¯¹å®‰å…¨æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯é‡Œä½¿ç”¨ App IDã€‚

ä½¿ç”¨ä¸åŒ App ID çš„åº”ç”¨ç¨‹åºæ˜¯ä¸èƒ½äº’é€šçš„ã€‚å¦‚æœå·²åœ¨é€šè¯ä¸­ï¼Œç”¨æˆ·å¿…é¡»è°ƒç”¨ leaveChannel() é€€å‡ºå½“å‰é€šè¯ï¼Œæ‰èƒ½è¿›å…¥ä¸‹ä¸€ä¸ªé¢‘é“

**Dynamic Key**

å½“é¡¹ç›®å‡†å¤‡æ­£å¼ä¸Šçº¿è¿è¥ï¼Œå»ºè®®å¼€å‘è€…é‡‡ç”¨ Dynamic Keyï¼Œè¿™æ˜¯ä¸€ä¸ªæ›´ä¸ºå®‰å…¨çš„ç”¨æˆ·èº«ä»½éªŒè¯æ–¹æ¡ˆã€‚é’ˆå¯¹ä¸åŒçš„æœåŠ¡ï¼ŒDynamic Key æœ‰ä¸åŒçš„åç§°:

1. Channel Key ç”¨äºåŠ å…¥é¢‘é“;
2. Signaling Key ç”¨äºç™»å½•ä¿¡ä»¤ç³»ç»Ÿ;

**App Certificate**

å°†æ‚¨çš„ App Certificate ä¿å­˜åœ¨æœåŠ¡å™¨ç«¯ï¼Œä¸”å¯¹ä»»ä½•å®¢æˆ·ç«¯å‡ä¸å¯è§ã€‚
é€šå¸¸ App Certificate åœ¨å¯ç”¨ä¸€å°æ—¶åç”Ÿæ•ˆã€‚

å½“é¡¹ç›®çš„ App Certificate è¢«å¯ç”¨åï¼Œæ‚¨å¿…é¡»ä½¿ç”¨ Dynamic Keyã€‚ä¾‹å¦‚: åœ¨å¯ç”¨ App Certificate å‰ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ App ID åŠ å…¥é¢‘é“ã€‚ä½†å¯ç”¨äº† App Certificate
åï¼Œæ‚¨å¿…é¡»ä½¿ç”¨ Channel Key åŠ å…¥é¢‘é“ã€‚

**channel**

æ ‡è¯†é€šè¯çš„é¢‘é“åç§°ï¼Œé•¿åº¦åœ¨ 64 å­—èŠ‚ä»¥å†…çš„å­—ç¬¦ä¸²

å¯ä»¥ç†è§£ä¸ºæˆ¿é—´å

è¦è¿›è¡Œè¯­éŸ³æˆ–è€…è§†é¢‘, ä¸åŒçš„ç”¨æˆ·éƒ½å¿…é¡»åœ¨åŒä¸€ä¸ª channel ä¸­

![20241229154732_t6m0Iacx.webp](https://cdn.dong4j.site/source/image/20241229154732_t6m0Iacx.webp)

**channel key**

å®‰å…¨è¦æ±‚ä¸é«˜: å°†å€¼è®¾ä¸º null
å®‰å…¨è¦æ±‚é«˜: å°†å€¼è®¾ç½®ä¸º Channel Keyã€‚ å¦‚æœä½ å·²ç»å¯ç”¨äº† App Certificate, è¯·åŠ¡å¿…ä½¿ç”¨ Channel Keyã€‚

**UID**

ç”¨æˆ·ä½ç§»è¡¨ç¤º

åŒä¸€ä¸ªé¢‘é“é‡Œä¸èƒ½å‡ºç°ä¸¤ä¸ªç›¸åŒçš„ UIDã€‚å¦‚æœä½ çš„ App æ”¯æŒå¤šè®¾å¤‡åŒæ—¶ç™»å½•ï¼Œå³åŒä¸€ä¸ªç”¨æˆ·è´¦å·å¯ä»¥åœ¨ä¸åŒçš„è®¾å¤‡ä¸ŠåŒæ—¶ç™»å½• (ä¾‹å¦‚å¾®ä¿¡æ”¯æŒåœ¨ PC
ç«¯å’Œç§»åŠ¨ç«¯åŒæ—¶ç™»å½•)ï¼Œè¯·ä¿è¯ä¼ å…¥çš„ UID ä¸ç›¸åŒã€‚ ä¾‹å¦‚ä½ ä¹‹å‰éƒ½æ˜¯ç”¨åŒä¸€ä¸ªç”¨æˆ·æ ‡è¯†ä½œä¸º UID, å»ºè®®ä»ç°åœ¨å¼€å§‹åŠ ä¸Šè®¾å¤‡ ID, ä»¥ä¿è¯ä¼ å…¥çš„ UID ä¸ç›¸åŒ
ã€‚å¦‚æœä½ çš„ App ä¸æ”¯æŒå¤šè®¾å¤‡åŒæ—¶ç™»å½•ï¼Œä¾‹å¦‚åœ¨ç”µè„‘ä¸Šç™»å½•æ—¶ï¼Œæ‰‹æœºä¸Šä¼šè‡ªåŠ¨é€€å‡ºï¼Œè¿™ç§æƒ…å†µä¸‹å°±ä¸éœ€è¦åœ¨ UID ä¸Šæ·»åŠ è®¾å¤‡ IDã€‚

**ä¿¡ä»¤ å’Œ é€šä¿¡**

> é¢‘é“ï¼Œå¯ä»¥ç†è§£æˆé€šè®¯çš„æˆ¿é—´ï¼Œä¿¡ä»¤å’Œé€šä¿¡ä¸­çš„é¢‘é“æ˜¯ä¸€ä¸ªæ„æ€ï¼Œåªä¸è¿‡ï¼Œä¿¡ä»¤æ˜¯ç¡®è®¤è¿›å…¥æˆ¿é—´ï¼Œé€šä¿¡æ˜¯åœ¨æˆ¿é—´å†…èŠå¤©ã€‚

https://dev.agora.io/cn/question/1780

**ç¾¤ç»„**

**é€šè¯ç»Ÿè®¡**

### App çš„ç”¨æˆ·ä¹‹é—´è¦å»ºç«‹å’Œå‘èµ·ä¸€ä¸ªå‘¼å«ï¼Œæ•´ä¸ªæµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ

ä»¥ A å‘¼å« B ä¸ºä¾‹ï¼Œä¸€èˆ¬å‘¼å«æµç¨‹å¦‚ä¸‹:

1. A å‘ä¿¡ä»¤æœåŠ¡å™¨å‘èµ·å‘¼å«è¯·æ±‚ã€‚

2. ä¿¡ä»¤æœåŠ¡å™¨æ£€æŸ¥ B æ˜¯å¦åœ¨çº¿:

- å¦‚ä¸åœ¨çº¿ï¼Œå‘ A è¿”å› B ä¸åœ¨çº¿é”™è¯¯ã€‚
- å¦‚åœ¨çº¿ï¼Œä¿¡ä»¤æœåŠ¡å™¨ç”Ÿæˆé¢‘é“åï¼Œè¿”å›ç»™ Aï¼›å¹¶å‘ B æŠ•é€’å‘¼å«ä¿¡ä»¤ã€‚

3. A æ”¶åˆ°ä¿¡ä»¤æœåŠ¡å™¨è¿”å›çš„é¢‘é“åï¼Œå‡†å¤‡åŠ å…¥è¯­éŸ³é¢‘é“ã€‚æ­¤æ—¶ä¸ºåŠ å¿«è¿›é¢‘é“é€Ÿåº¦ï¼Œå¯ä»¥æå‰è¿›å…¥é¢‘é“å¾…å‘½:

- A è°ƒç”¨ muteLocalAudioStream(true) å’Œ muteLocalVideoStream(true)ï¼ˆå¦‚æœ‰è§†é¢‘åŠŸèƒ½ï¼‰ç¦æ­¢å‘é€éŸ³è§†é¢‘æ•°æ®ã€‚
- è°ƒç”¨ joinChannel è¿›å…¥é¢‘é“ã€‚

4. B æ”¶åˆ°ä¿¡ä»¤æœåŠ¡å™¨æŠ•é€’è¿‡æ¥çš„ A çš„å‘¼å«è¯·æ±‚ã€‚

- B å“é“ƒã€‚ ä¸ºåŠ å¿«è¿›é¢‘é“é€Ÿåº¦ï¼Œå¯ä»¥æäº¤è¿›å…¥é¢‘é“å¾…å‘½ã€‚
- B è°ƒç”¨ muteLocalAudioStream(true) å’Œ muteLocalVideoStream(true)ï¼ˆå¦‚æœ‰è§†é¢‘åŠŸèƒ½ï¼‰ç¦æ­¢å‘é€éŸ³è§†é¢‘æ•°æ®ã€‚

5. A è°ƒç”¨ joinChannel è¿›å…¥é¢‘é“:
   - å¦‚ B æ‹’ç»è¯·æ±‚:
     - B è°ƒç”¨ leaveChannel é€€å‡ºé¢‘é“
     - B å‘ä¿¡ä»¤æœåŠ¡å™¨è¿”å›æ‹’ç»åº”ç­”
     - ä¿¡ä»¤æœåŠ¡å™¨å‘ A è¿”å› B æ‹’ç»åº”ç­”ä¿¡ä»¤
     - A è°ƒç”¨ leaveChannel é€€å‡ºé¢‘é“
   - å¦‚ B æ¥å—è¯·æ±‚:
     - B è°ƒç”¨ muteLocalAudioStream(false) å’Œ muteLocalVideoStream(false) å¼€å§‹å‘é€éŸ³è§†é¢‘æ•°æ®
       - B å‘ä¿¡ä»¤æœåŠ¡å™¨è¿”å›æ¥å—åº”ç­”ä¿¡ä»¤
       - è°ƒç”¨ muteLocalAudioStream(false) å’Œ muteLocalVideoStream(false) å¼€å§‹å‘é€éŸ³è§†é¢‘æ•°æ®

![20241229154732_RLznNSiG.webp](https://cdn.dong4j.site/source/image/20241229154732_RLznNSiG.webp)

å‘¼å«å¤±è´¥æˆ–è€…æˆåŠŸ, å®¢æˆ·ç«¯éœ€è¦è°ƒç”¨ xxx æ¥å£å†™æ—¥å¿—

![20241229154732_omNQ5ZtM.webp](https://cdn.dong4j.site/source/image/20241229154732_omNQ5ZtM.webp)

![20241229154732_hTbqt3js.webp](https://cdn.dong4j.site/source/image/20241229154732_hTbqt3js.webp)

å®¢æˆ·ç«¯å‘¼å« è´§ä¸» (TMS/ è´§ä¸» app) éœ€è¦å‘èµ· 2 ä¸ªå‘¼å«, å½“ä¸€æ–¹æ¥é€šæ—¶, å›è°ƒä¸­å…³é—­å¦ä¸€ä¸ªå‘¼å« 4

## [è½»æ¾æå®šMavenå¤šç¯å¢ƒé…ç½®ï¼šå®æˆ˜æŠ€å·§å¤§æ”¾é€](https://blog.dong4j.site/posts/53d86ec9.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

Maven å¤šç¯å¢ƒé…ç½®æ‰“åŒ…æ–¹å¼

<!-- more -->

## ä½¿ç”¨ profiles

```xml
<profiles>
    <profile>
        <id>local</id>
        <properties>
            <environment>local</environment>
            <env>LOCAL</env>
        </properties>
    </profile>
    <profile>
        <id>dev</id>
        <properties>
            <environment>dev</environment>
            <env>DEV</env>
        </properties>
        <activation>
            <activeByDefault>true</activeByDefault>
        </activation>
    </profile>
    <profile>
        <id>test</id>
        <properties>
            <environment>test</environment>
            <env>TEST</env>
        </properties>
    </profile>
    <profile>
        <id>production</id>
        <properties>
            <environment>production</environment>
            <!-- ä¸ºä»€ä¹ˆè¦ç”¨å¤§å†™? -->
            <env>PRODUCTION</env>
        </properties>
    </profile>
</profiles>
```

## ä¿®æ”¹ build æ·»åŠ  filter

```xml
<build>
    <filters>
        <!-- src/main/filters ä¸º maven é»˜è®¤ä½ç½® -->
        <filter>src/main/filters/${environment}.yyyyy.properties</filter>
    </filters>
    <!-- è¿‡æ»¤ resources ä¸‹çš„æ‰€æœ‰é…ç½®æ–‡ä»¶ -->
    <resources>
        <resource>
            <!-- é…ç½®éœ€è¦è¢«æ›¿æ¢çš„èµ„æºæ–‡ä»¶è·¯å¾„ -->
            <directory>src/main/resources</directory>
            <filtering>true</filtering>
            <includes>
                <include>**/*.xml</include>
                <include>**/*.properties</include>
                <!-- åŠ å…¥ banner æ‰“å°è¾“å‡ºæ–‡ä»¶ -->
                <include>**/*.banner</include>
                <!-- åŠ å…¥ dubbo é…ç½®æ–‡ä»¶ -->
                <include>**/dubbo/*</include>
            </includes>
            <excludes>
                <!-- æ’é™¤ jrebel é…ç½®æ–‡ä»¶ -->
                <exclude>rebel.xml</exclude>
            </excludes>
        </resource>
    </resources>
    <!-- junit æµ‹è¯•ç”¨, ä¸å°† junit ä½¿ç”¨çš„é…ç½®æ‰“åŒ… -->
    <testResources>
        <testResource>
            <directory>src/test/resources</directory>
            <filtering>true</filtering>
            <includes>
                <include>**/*.xml</include>
                <include>**/*.properties</include>
                <include>**/*.banner</include>
            </includes>
        </testResource>
    </testResources>
</build>
```

## ä½¿ç”¨å‘½ä»¤æ‰“åŒ…

```bash
mvn clean install -Dmaven.test.skip=true -Pdev
```

## ä½¿ç”¨ @ ä»£æ›¿ $

å¦‚æœ resource ä¸­å­˜åœ¨ js, ä¸”ä¸ maven å†…ç½®å˜é‡ç›¸åŒ, ä¼šå°† $ å…¨éƒ¨æ›¿æ¢ä¸º maven çš„å‚æ•°
æ‰€æœ‰è¿™é‡Œä½¿ç”¨ @ æ›¿æ¢æ‰ $.

## åŸç†

maven ä¼šä½¿ç”¨ filter ä¸­çš„æ–‡ä»¶å±æ€§æ›¿æ¢æ‰€æœ‰ resource include çš„æ–‡ä»¶ä¸­çš„å ä½ç¬¦

# ä½¿ç”¨ context:property-placeholder

æœ‰äº›å‚æ•°åœ¨æŸäº›é˜¶æ®µä¸­æ˜¯å¸¸é‡ã€‚

1. åœ¨å¼€å‘é˜¶æ®µæˆ‘ä»¬è¿æ¥æ•°æ®åº“æ—¶çš„ urlï¼Œusernameï¼Œpassword ç­‰ä¿¡æ¯
2. åˆ†å¸ƒå¼åº”ç”¨ä¸­ client ç«¯çš„ server åœ°å€ï¼Œç«¯å£ç­‰

è¿™äº›å‚æ•°åœ¨ä¸åŒé˜¶æ®µä¹‹é—´åˆå¾€å¾€éœ€è¦æ”¹å˜

æœŸæœ›ï¼šæœ‰ä¸€ç§æ–¹æ¡ˆå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬åœ¨ä¸€ä¸ªé˜¶æ®µå†…ä¸éœ€è¦é¢‘ç¹å†™ä¸€ä¸ªå‚æ•°çš„å€¼ï¼Œè€Œåœ¨ä¸åŒé˜¶æ®µé—´åˆå¯ä»¥æ–¹ä¾¿çš„åˆ‡æ¢å‚æ•°çš„é…ç½®ä¿¡æ¯
è§£å†³ï¼šspring3 ä¸­æä¾›äº†ä¸€ç§ç®€ä¾¿çš„æ–¹å¼å°±æ˜¯ `<content:property-placeholder>` å…ƒç´ 
åªéœ€è¦åœ¨ spring é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ä¸€å¥ï¼š

```xml
<context:property-placeholder location="classpath:jdbc.properties"/>
```

æˆ–è€…

```xml
<bean id="propertyPlaceholderConfigurer" class="org.springframework,beans.factory.config.PropertyPlaceholderConfigurer">
    <property name="locations">
        <list>
            <value>jdbc.properties<value/>
        </list>
    </property>
</bean>
```

å³å¯ï¼Œè¿™é‡Œçš„ location å€¼ä¸ºå‚æ•°é…ç½®æ–‡ä»¶çš„ä½ç½®ï¼Œé…ç½®æ–‡ä»¶é€šå¸¸æ”¾åˆ° src ç›®å½•ä¸‹ï¼Œå‚æ•°é…ç½®æ–‡ä»¶çš„æ ¼å¼å³é”®å€¼å¯¹çš„å½¢å¼ï¼Œ

```bash
#jdbc é…ç½®
driverClassName=com.mysql.jdbc.Driver
url=jdbc:mysql://localhost:3306/test
username=root
password=root
```

è¡Œå†… #å·åé¢éƒ¨åˆ†ä¸ºæ³¨é‡Š

è¿™æ ·ä¸€æ¥å°±å¯ä»¥ä¸º spring é…ç½®çš„ bean çš„å±æ€§è®¾ç½®å€¼äº†ï¼Œæ¯”å¦‚ spring æœ‰ä¸€ä¸ªæ•°æ®æºçš„ç±»

```xml
<bean id="dataSource" class="org.springframework,jdbc,datasource.DriverManagerDataSource">
    <property name="driverClassName" value="${driverClassName}"/>
    <property name="url" value="${url}"/>
    <property name="username" value="${username}"/>
    <property name="password" value="${password}"/>
</bean>
```

ç”šè‡³å¯ä»¥å°† ${} è¿™ç§å½¢å¼çš„å˜é‡ç”¨åœ¨ spring æä¾›çš„æ³¨è§£å½“ä¸­ï¼Œä¸ºæ³¨è§£çš„å±æ€§æä¾›å€¼ï¼ˆä¸‹é¢ä¼šè®²åˆ°ï¼‰

Spring å®¹å™¨é‡‡ç”¨åå°„æ‰«æçš„å‘ç°æœºåˆ¶ï¼Œåœ¨æ¢æµ‹åˆ° Spring å®¹å™¨ä¸­æœ‰ä¸€ä¸ª org.springframework.beans.config.PropertyPlaceholderConfigurer çš„ Bean
å°±ä¼šåœæ­¢å¯¹å‰©ä½™ PropertyPlaceholderConfigurer çš„æ‰«æï¼Œ

æ¢å¥è¯è¯´ï¼Œå³ Spring å®¹å™¨ä»…å…è®¸æœ€å¤šå®šä¹‰ä¸€ä¸ª PropertyPlaceholderConfigurer æˆ– `<content:property-placeholder>` å…¶ä½™çš„ä¼šè¢« Spring å¿½ç•¥

ç”±äº Spring å®¹å™¨åªèƒ½æœ‰ä¸€ä¸ª PropertyPlaceholderConfigurerï¼Œå¦‚æœæœ‰å¤šä¸ªå±æ€§æ–‡ä»¶ï¼Œè¿™æ—¶å°±çœ‹è°å…ˆè°åäº†ï¼Œå…ˆçš„ä¿ç•™ ï¼Œåçš„å¿½ç•¥ã€‚

è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œæ˜¯ Spring è‡ªåŠ¨æ³¨å…¥ properties æ–‡ä»¶ä¸­çš„é…ç½®ï¼šè¦è‡ªåŠ¨æ³¨å…¥ properties æ–‡ä»¶ä¸­çš„é…ç½®ï¼Œéœ€è¦åœ¨ Spring
é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  `org.springframework.beans.factory.config.PropertiesFactoryBean`
å’Œ `org.springframework.beans.factory.config.PreferencesPlaceholderConfigurer` çš„å®ä¾‹é…ç½®

```xml
<bean id="configProperties" class="org.springframework.beans.factory.config.PropertiesFactoryBean">
    <property name="locations">
        <list>
            <value> classpath*:application.properties</value>
        </list>
    </property>
</bean>
<bean id="propertyConfigurer" class="org.springframework.beans.factory.config.PreferencesPlaceholderConfigurer">
    <property name="properties" ref="configProperties" />
</bean>
```

åœ¨è¿™ä¸ªé…ç½®æ–‡ä»¶ä¸­æˆ‘ä»¬é…ç½®äº†æ³¨è§£æ‰«æï¼Œå’Œ configProperties å®ä¾‹å’Œ propertyConfigurer å®ä¾‹ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ java ç±»ä¸­è‡ªåŠ¨æ³¨å…¥é…ç½®äº†

```java
@Component
public class Test{
    @Value("#{configProperties['userName']}")
    private String userName;

    public String getUserName(){
        return userName;
    }

}
```

è‡ªåŠ¨æ³¨å…¥éœ€è¦ä½¿ç”¨ @Value è¿™ä¸ªæ³¨è§£ï¼Œè¿™ä¸ªæ³¨è§£çš„æ ¼å¼ `#{configProperties['userName']}` å…¶ä¸­ configProperties æ˜¯æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®çš„ bean çš„ idï¼Œ
userName æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®çš„é¡¹

åœ¨ Spring ä¸­çš„ xml ä¸­ä½¿ç”¨ > æ ‡ç­¾å¯¼å…¥é…ç½®æ–‡ä»¶æ—¶ï¼Œæƒ³è¦å¯¼å…¥å¤šä¸ª properties é…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š

```xml
<context:property-placeholderlocation="classpath:db.properties " />
<context:property-placeholderlocation="classpath:zxg.properties " />
```

ç»“æœå‘ç°ä¸è¡Œï¼Œç¬¬äºŒä¸ªé…ç½®æ–‡ä»¶å§‹ç»ˆè¯»å–ä¸åˆ°ï¼Œåæ¥å‘ç° `<context:property-placeholder>` æ ‡ç­¾åœ¨ Spring é…ç½®æ–‡ä»¶ä¸­åªèƒ½å­˜åœ¨ä¸€ä»½ï¼ï¼ï¼Spring
å®¹å™¨æ˜¯é‡‡ç”¨åå°„æ‰«æçš„å‘ç°æœºåˆ¶ï¼Œé€šè¿‡æ ‡ç­¾çš„å‘½åç©ºé—´å®ä¾‹åŒ–å®ä¾‹ï¼Œå½“ Spring
æ¢æµ‹åˆ°å®¹å™¨ä¸­æœ‰ä¸€ä¸ª `org.springframework.beans.factory.config.PropertyPlaceholderCVonfigurer` çš„ Bean å°±ä¼šåœæ­¢å¯¹å‰©ä½™
PropertyPlaceholderConfigurer çš„æ‰«æï¼Œå³åªèƒ½å­˜åœ¨ä¸€ä¸ªå®ä¾‹ã€‚

```xml
<context:property-placeholder
       location=""
       file-encoding=""
       ignore-resource-not-found=""
       ignore-unresolvable=""
       properties-ref=""
       local-override=""
       system-properties-mode=""
       order=""
/>
```

é‚£å¦‚æœæœ‰å¤šä¸ªé…ç½®æ–‡ä»¶æ€ä¹ˆåŠå‘¢ï¼Ÿé‚£å°±å¤šä¸ªæ–‡ä»¶ä¹‹é—´ä»¥â€œ,â€åˆ†éš”ï¼Œå¦‚ä¸‹ï¼š

```xml
<context:property-placeholderlocation="classpath:db.properties,classpath:monitor.properties" />
```

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šå¤šä¸ªé…ç½®æ–‡ä»¶å°†ä¾æ¬¡åŠ è½½ï¼Œå¦‚æœåä¸€ä¸ªæ–‡ä»¶ä¸­æœ‰å’Œå‰é¢æŸä¸€ä¸ªæ–‡ä»¶ä¸­å±æ€§åæ˜¯ç›¸åŒçš„ï¼Œæœ€ç»ˆå–çš„å€¼æ˜¯ååŠ è½½çš„å€¼ã€‚

## [æé«˜å¼€å‘æ•ˆç‡ï¼Œæå‡ä»£ç è´¨é‡ï¼šCheckStyleçš„å®æˆ˜åº”ç”¨](https://blog.dong4j.site/posts/e5eb73b9.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

æ ¹æ® ã€Œé˜¿é‡Œå·´å·´å¼€å‘è§„èŒƒã€ é…ç½® IDEA å¼€å‘ç¯å¢ƒ

google-code-checks-xxx.xml
æ ¹æ® google-code-checks.xml ä¿®æ”¹
æŒ‰ç…§å®˜æ–¹æ–‡æ¡£åŠ ä¸Šä¸­æ–‡æ³¨é‡Š
å…·ä½“çš„ checkstyle è§„åˆ™å¯ä»¥æŸ¥çœ‹ google-code-checks.xml

## å‘½åè§„çº¦

é€šè¿‡ checkstyle æ§åˆ¶, æ‰€æœ‰ä¸ç¬¦åˆè¦æ±‚çš„ åŒ…å, ç±»å, æ–¹æ³•å, å±€éƒ¨å˜é‡, é™æ€å˜é‡, å¸¸é‡ éƒ½ä¼šæç¤º

![name.gif](https://cdn.dong4j.site/source/image/name.gif)

1. æ¥å£ç±»ä¸­çš„æ–¹æ³•å’Œå±æ€§ä¸è¦åŠ ä»»ä½•ä¿®é¥°ç¬¦å·ï¼ˆpublic ä¹Ÿä¸è¦åŠ ï¼‰ï¼Œä¿æŒä»£ç çš„ç®€æ´ æ€§ï¼Œå¹¶åŠ ä¸Šæœ‰æ•ˆçš„ Javadoc æ³¨é‡Š
   ![20241229154732_Gp3mXzIv.webp](https://cdn.dong4j.site/source/image/20241229154732_Gp3mXzIv.webp)

   idea å¯¹äºå¤šä½™çš„ä¿®é¥°ç¬¦ä¹Ÿä¼šæ ‡è®°, è¿™é‡Œä½¿ç”¨ checkstyle æç¤º

### å¸¸é‡å®šä¹‰

1. é‡å¤çš„å­—ç¬¦ä¸²å‡ºç° 2 æ¬¡ä»¥ä¸Š, å°±ä¼šæç¤º, åº”è¯¥ä½¿ç”¨å¸¸é‡å­—ç¬¦ä¸²ä»£æ›¿
   ![20241229154732_g3xmU12z.webp](https://cdn.dong4j.site/source/image/20241229154732_g3xmU12z.webp)
2. å½“å®šä¹‰ä¸€ä¸ªå¸¸é‡æ—¶, å¸Œæœ›ä½¿ç”¨å¤§å†™çš„ L æ¥ä»£æ›¿å°å†™çš„ l, åŸå› æ˜¯å°å†™çš„ l å’Œæ•°å­— 1 å¾ˆè±¡
3. long æˆ–è€… Long åˆå§‹èµ‹å€¼æ—¶ï¼Œå¿…é¡»ä½¿ç”¨å¤§å†™çš„ Lï¼Œä¸èƒ½æ˜¯å°å†™çš„ lï¼Œå°å†™å®¹æ˜“è·Ÿæ•°å­— 1 æ··æ·†ï¼Œé€ æˆè¯¯è§£
   ![20241229154732_E6dayluU.webp](https://cdn.dong4j.site/source/image/20241229154732_E6dayluU.webp)

## æ ¼å¼è§„çº¦

å…¨éƒ¨ä½¿ç”¨ checkstyle çº¦æŸ
å¦‚æœè¿åè§„åˆ™, åˆ™ä¼šç»™å‡ºæç¤º, æŒ‰ç…§ç›¸åº”æç¤ºä¿®æ”¹å³å¯, ä¿®æ”¹ä¹‹å‰å…ˆå…¨éƒ¨æ ¼å¼åŒ–, ä¼šå‡å°‘å¾ˆå¤šæç¤º

1. ç¼©è¿›é‡‡ç”¨ 4 ä¸ªç©ºæ ¼ï¼Œç¦æ­¢ä½¿ç”¨ tab å­—ç¬¦
2. å•è¡Œå­—ç¬¦æ•°é™åˆ¶ä¸è¶…è¿‡
3. å•è¡Œå­—ç¬¦æ•°é™åˆ¶ä¸è¶…è¿‡ 120 ä¸ªï¼Œè¶…å‡ºéœ€è¦æ¢è¡Œï¼Œæ¢è¡Œæ—¶
   éµå¾ªå¦‚ä¸‹åŸåˆ™ï¼š

   1. ç¬¬äºŒè¡Œç›¸å¯¹ç¬¬ä¸€è¡Œç¼©è¿› 4 ä¸ªç©ºæ ¼
   2. è¿ç®—ç¬¦ä¸ä¸‹æ–‡ä¸€èµ·æ¢è¡Œã€‚
   3. æ–¹æ³•è°ƒç”¨çš„ç‚¹ç¬¦å·ä¸ä¸‹æ–‡ä¸€èµ·æ¢è¡Œã€‚
   4. åœ¨å¤šä¸ªå‚æ•°è¶…é•¿ï¼Œé€—å·åè¿›è¡Œæ¢è¡Œã€‚
   5. åœ¨æ‹¬å·å‰ä¸è¦æ¢è¡Œ

   æ ¼å¼åŒ–æ–‡ä»¶å’Œ checkstyle éƒ½å·²ç»è®¾ç½®ä¸º 120 ä¸ªå­—ç¬¦é•¿åº¦, å¦‚æœè¶…é•¿, ä½¿ç”¨å¿«æ·é”®æ ¼å¼åŒ–, ç„¶åæŒ‰ç…§ä¸Šé¢çš„ 5 ç‚¹åŸåˆ™ä¿®æ”¹å³å¯

4. IDE çš„ text file encoding è®¾ç½®ä¸º UTF-8; IDE ä¸­æ–‡ä»¶çš„æ¢è¡Œç¬¦ä½¿ç”¨ Unix æ ¼å¼ï¼Œä¸è¦ä½¿ç”¨ windows æ ¼å¼ã€‚
   ![20241229154732_p0zIZSOx.webp](https://cdn.dong4j.site/source/image/20241229154732_p0zIZSOx.webp)
5. Object çš„ equals æ–¹æ³•å®¹æ˜“æŠ›ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œåº”ä½¿ç”¨å¸¸é‡æˆ–ç¡®å®šæœ‰å€¼çš„å¯¹è±¡æ¥è°ƒç”¨ equalsã€‚
6. ä¸ä½¿ç”¨ System.out[err].print[ln]
   ![20241229154732_LTNkgVyJ.webp](https://cdn.dong4j.site/source/image/20241229154732_LTNkgVyJ.webp)

æ”¹ä¸º

![20241229154732_BQdn0DGp.webp](https://cdn.dong4j.site/source/image/20241229154732_BQdn0DGp.webp)

## æ³¨é‡Šè§„çº¦

1. è§„èŒƒ todo å’Œ fixme æ ‡è®°  
   ![todo.gif](https://cdn.dong4j.site/source/image/todo.gif)

   todo å’Œ fixme å è·Ÿ - åå­— è°æ ‡è®°è°å¤„ç†

   ```
   fixme-dong4j : ($date$ $time$ [ è¯´æ˜] [é¢„è®¡å¤„ç†æ—¶é—´])
   todo-dong4j : ($date$ $time$ [ è¯´æ˜] [é¢„è®¡å¤„ç†æ—¶é—´])
   ```

   ![20241229154732_S0bgDTGj.webp](https://cdn.dong4j.site/source/image/20241229154732_S0bgDTGj.webp)

   ![20241229154732_sT7NwYnw.webp](https://cdn.dong4j.site/source/image/20241229154732_sT7NwYnw.webp)

2. ç±», æ–¹æ³•, å­—æ®µæ³¨é‡Šè¦æ±‚

   > åˆ›å»ºç±»æ—¶, ä½¿ç”¨æ¨¡æ¿è‡ªåŠ¨ç”Ÿæˆç±»æ³¨é‡Š
   > æ–¹æ³•æ³¨é‡Šä½¿ç”¨ javadoc[æ’ä»¶] è‡ªåŠ¨ç”Ÿæˆ
   > å­—æ®µæ³¨é‡Šä½¿ç”¨ `/ ** æ³¨é‡Šå†…å®¹ */` çš„æ–¹å¼, å½“ä½¿ç”¨ F1 æŸ¥çœ‹å­—æ®µæ—¶, å³å¯çœ‹è§æ³¨é‡Šè¯´æ˜, ä¸éœ€è¦è·³è½¬åˆ°å¯¹åº”çš„ç±»æŸ¥çœ‹

   ![class.gif](https://cdn.dong4j.site/source/image/class.gif)

   ![method.gif](https://cdn.dong4j.site/source/image/method.gif)

   ![20241229154732_emSXa0iL.webp](https://cdn.dong4j.site/source/image/20241229154732_emSXa0iL.webp)

   ![20241229154732_HiwlLvwj.webp](https://cdn.dong4j.site/source/image/20241229154732_HiwlLvwj.webp)

   ```
   /**
    * <p>Title: $packagename$</p>
    * <p>Company: xxx å…¬å¸ </p>
    * <p>Copyright Â© 2014 x'x'x All Rights Reserved</p>
    * <p>Description: $END$</p>
    * author: dong4j
    * emali: dong4j@gmail.com
    * version: 1.0
    * date: $date$  $time$
    * updatetime:
    * reason:
    */
   ```

![20241229154732_qEnNI6Yb.webp](https://cdn.dong4j.site/source/image/20241229154732_qEnNI6Yb.webp)

## checkstyle ä½¿ç”¨æ–¹æ³•

1. å®‰è£… CheckStyle-IDEA æ’ä»¶
2. å¯¼å…¥ google-code-checks-xxx.xml
3. ç„¶åå¯¼å…¥ google-code-style.xml
4. æœ€åå…³è” 2 ä¸ªæ–‡ä»¶
   ![20241229154732_AAxyu2Sv.webp](https://cdn.dong4j.site/source/image/20241229154732_AAxyu2Sv.webp)

### checkstyle æ’ä»¶çš„ä½¿ç”¨

å®‰è£…å¥½æ’ä»¶å, ç¬¬ä¸€æ¬¡æ‰“å¼€é¡¹ç›®, å°±ä¼šæ‰«é¢å…¨éƒ¨æ–‡ä»¶çš„ä»£ç , ä¼šæ—¶æ—¶æç¤ºè§„åˆ™

1. æ‰‹åŠ¨æ£€æŸ¥å½“å‰æ–‡ä»¶ å³é”® --> check current file
   ![20241229154732_u37mHagb.webp](https://cdn.dong4j.site/source/image/20241229154732_u37mHagb.webp)

2. æ‰‹åŠ¨æ‰«æ module
3. æ‰‹åŠ¨æ‰«é¢ project
   ![20241229154732_jeXfXrJv.webp](https://cdn.dong4j.site/source/image/20241229154732_jeXfXrJv.webp)

#### è­¦å‘Šæç¤º

![20241229154732_e3azFvY8.webp](https://cdn.dong4j.site/source/image/20241229154732_e3azFvY8.webp)

è¿™ä¸ªä¸æ™“å¾—æ˜¯ä¸æ˜¯ bug, æš‚æ—¶è¿˜æ²¡æœ‰æ‰¾åˆ°è§£å†³åŠæ³•, æ‰€ä»¥æš‚æ—¶å¿½ç•¥

![20241229154732_oB9m6YSz.webp](https://cdn.dong4j.site/source/image/20241229154732_oB9m6YSz.webp)

checkstyle å–æ¶ˆå‹¾é€‰å³å¯

## [èµ°è¿›Pythonæ ¸å¿ƒï¼šæ­ç§˜å…ƒç±»å’Œç±»çš„åˆ›å»ºè¿‡ç¨‹](https://blog.dong4j.site/posts/8f42e00b.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

# python é¢å‘å¯¹è±¡ï¼ˆè¿›é˜¶ç¯‡ï¼‰

åŸæ–‡å‡ºå¤„ï¼š[æ­¦æ²›é½ cnblog](http://www.cnblogs.com/wupeiqi/p/4766801.html)

- é¢å‘å¯¹è±¡æ˜¯ä¸€ç§ç¼–ç¨‹æ–¹å¼ï¼Œæ­¤ç¼–ç¨‹æ–¹å¼çš„å®ç°æ˜¯åŸºäºå¯¹**ç±»**å’Œ**å¯¹è±¡**çš„ä½¿ç”¨
- ç±» æ˜¯ä¸€ä¸ªæ¨¡æ¿ï¼Œæ¨¡æ¿ä¸­åŒ…è£…äº†å¤šä¸ªâ€œå‡½æ•°â€ä¾›ä½¿ç”¨ï¼ˆå¯ä»¥è®²å¤šå‡½æ•°ä¸­å…¬ç”¨çš„å˜é‡å°è£…åˆ°å¯¹è±¡ä¸­ï¼‰
- å¯¹è±¡ï¼Œæ ¹æ®æ¨¡æ¿åˆ›å»ºçš„å®ä¾‹ï¼ˆå³ï¼šå¯¹è±¡ï¼‰ï¼Œå®ä¾‹ç”¨äºè°ƒç”¨è¢«åŒ…è£…åœ¨ç±»ä¸­çš„å‡½æ•°
- é¢å‘å¯¹è±¡ä¸‰å¤§ç‰¹æ€§ï¼šå°è£…ã€ç»§æ‰¿å’Œå¤šæ€

æœ¬ç¯‡å°†è¯¦ç»†ä»‹ç» Python ç±»çš„æˆå‘˜ã€æˆå‘˜ä¿®é¥°ç¬¦ã€ç±»çš„ç‰¹æ®Šæˆå‘˜ã€‚

## ç±»çš„æˆå‘˜

ç±»çš„æˆå‘˜å¯ä»¥åˆ†ä¸ºä¸‰å¤§ç±»ï¼šå­—æ®µã€æ–¹æ³•å’Œå±æ€§

![20241229154732_jg2T9uao.webp](https://cdn.dong4j.site/source/image/20241229154732_jg2T9uao.webp)

-

æ³¨ï¼šæ‰€æœ‰æˆå‘˜ä¸­ï¼Œåªæœ‰æ™®é€šå­—æ®µçš„å†…å®¹ä¿å­˜å¯¹è±¡ä¸­ï¼Œå³ï¼šæ ¹æ®æ­¤ç±»åˆ›å»ºäº†å¤šå°‘å¯¹è±¡ï¼Œåœ¨å†…å­˜ä¸­å°±æœ‰å¤šå°‘ä¸ªæ™®é€šå­—æ®µã€‚è€Œå…¶ä»–çš„æˆå‘˜ï¼Œåˆ™éƒ½æ˜¯ä¿å­˜åœ¨ç±»ä¸­ï¼Œå³ï¼šæ— è®ºå¯¹è±¡çš„å¤šå°‘ï¼Œåœ¨å†…å­˜ä¸­åªåˆ›å»ºä¸€ä»½

### å­—æ®µ

å­—æ®µåŒ…æ‹¬ï¼šæ™®é€šå­—æ®µå’Œé™æ€å­—æ®µï¼Œä»–ä»¬åœ¨å®šä¹‰å’Œä½¿ç”¨ä¸­æœ‰æ‰€åŒºåˆ«ï¼Œè€Œæœ€æœ¬è´¨çš„åŒºåˆ«æ˜¯å†…å­˜ä¸­ä¿å­˜çš„ä½ç½®ä¸åŒï¼Œ

- æ™®é€šå­—æ®µå±äº **å¯¹è±¡**
- é™æ€å­—æ®µå±äº **ç±»**

```python
class Province:

    # é™æ€å­—æ®µ
    country ï¼ 'ä¸­å›½'

    def __init__(self, name):

        # æ™®é€šå­—æ®µ
        self.name = name

# ç›´æ¥è®¿é—®æ™®é€šå­—æ®µ
obj = Province('æ²³åŒ—çœ')
print obj.name

# ç›´æ¥è®¿é—®é™æ€å­—æ®µ
Province.country
```

#### å­—æ®µçš„å®šä¹‰å’Œä½¿ç”¨

ç”±ä¸Šè¿°ä»£ç å¯ä»¥çœ‹å‡ºã€æ™®é€šå­—æ®µéœ€è¦é€šè¿‡å¯¹è±¡æ¥è®¿é—®ã€‘ã€é™æ€å­—æ®µé€šè¿‡ç±»è®¿é—®ã€‘ï¼Œåœ¨ä½¿ç”¨ä¸Šå¯ä»¥çœ‹å‡ºæ™®é€šå­—æ®µå’Œé™æ€å­—æ®µçš„å½’å±æ˜¯ä¸åŒçš„ã€‚å…¶åœ¨å†…å®¹çš„å­˜å‚¨æ–¹å¼ç±»ä¼¼å¦‚ä¸‹å›¾ï¼š

![20241229154732_j4ReiyvB.webp](https://cdn.dong4j.site/source/image/20241229154732_j4ReiyvB.webp)

ç”±ä¸Šå›¾å¯æ˜¯ï¼š

- é™æ€å­—æ®µåœ¨å†…å­˜ä¸­åªä¿å­˜ä¸€ä»½
- æ™®é€šå­—æ®µåœ¨æ¯ä¸ªå¯¹è±¡ä¸­éƒ½è¦ä¿å­˜ä¸€ä»½

åº”ç”¨åœºæ™¯ï¼š é€šè¿‡ç±»åˆ›å»ºå¯¹è±¡æ—¶ï¼Œå¦‚æœæ¯ä¸ªå¯¹è±¡éƒ½å…·æœ‰ç›¸åŒçš„å­—æ®µï¼Œé‚£ä¹ˆå°±ä½¿ç”¨é™æ€å­—æ®µ

### æ–¹æ³•

æ–¹æ³•åŒ…æ‹¬ï¼šæ™®é€šæ–¹æ³•ã€é™æ€æ–¹æ³•å’Œç±»æ–¹æ³•ï¼Œä¸‰ç§æ–¹æ³•åœ¨ **å†…å­˜ä¸­éƒ½å½’å±äºç±»**ï¼ŒåŒºåˆ«åœ¨äºè°ƒç”¨æ–¹å¼ä¸åŒã€‚

- æ™®é€šæ–¹æ³•ï¼šç”± **å¯¹è±¡**è°ƒç”¨ï¼›è‡³å°‘ä¸€ä¸ª **self** å‚æ•°ï¼›æ‰§è¡Œæ™®é€šæ–¹æ³•æ—¶ï¼Œè‡ªåŠ¨å°†è°ƒç”¨è¯¥æ–¹æ³•çš„ **å¯¹è±¡** èµ‹å€¼ç»™ **self**ï¼›
- ç±»æ–¹æ³•ï¼šç”± **ç±»** è°ƒç”¨ï¼› è‡³å°‘ä¸€ä¸ª **cls** å‚æ•°ï¼›æ‰§è¡Œç±»æ–¹æ³•æ—¶ï¼Œè‡ªåŠ¨å°†è°ƒç”¨è¯¥æ–¹æ³•çš„ **ç±»** å¤åˆ¶ç»™ **cls**ï¼›
- é™æ€æ–¹æ³•ï¼šç”± **ç±»** è°ƒç”¨ï¼›æ— é»˜è®¤å‚æ•°ï¼›

```python
class Foo:

    def __init__(self, name):
        self.name = name

    def ord_func(self):
        """ å®šä¹‰æ™®é€šæ–¹æ³•ï¼Œè‡³å°‘æœ‰ä¸€ä¸ªselfå‚æ•° """

        # print self.name
        print 'æ™®é€šæ–¹æ³•'

    @classmethod
    def class_func(cls):
        """ å®šä¹‰ç±»æ–¹æ³•ï¼Œè‡³å°‘æœ‰ä¸€ä¸ªclså‚æ•° """

        print 'ç±»æ–¹æ³•'

    @staticmethod
    def static_func():
        """ å®šä¹‰é™æ€æ–¹æ³• ï¼Œæ— é»˜è®¤å‚æ•°"""

        print 'é™æ€æ–¹æ³•'

# è°ƒç”¨æ™®é€šæ–¹æ³•
f = Foo()
f.ord_func()

# è°ƒç”¨ç±»æ–¹æ³•
Foo.class_func()

# è°ƒç”¨é™æ€æ–¹æ³•
Foo.static_func()
```

#### æ–¹æ³•çš„å®šä¹‰å’Œä½¿ç”¨

![20241229154732_h6vrNQ1q.webp](https://cdn.dong4j.site/source/image/20241229154732_h6vrNQ1q.webp)

**ç›¸åŒç‚¹**å¯¹äºæ‰€æœ‰çš„æ–¹æ³•è€Œè¨€ï¼Œå‡å±äºç±»ï¼ˆéå¯¹è±¡ï¼‰ä¸­ï¼Œæ‰€ä»¥ï¼Œåœ¨å†…å­˜ä¸­ä¹Ÿåªä¿å­˜ä¸€ä»½ã€‚

**ä¸åŒç‚¹** æ–¹æ³•è°ƒç”¨è€…ä¸åŒã€è°ƒç”¨æ–¹æ³•æ—¶è‡ªåŠ¨ä¼ å…¥çš„å‚æ•°ä¸åŒã€‚

### å±æ€§

å¦‚æœä½ å·²ç»äº†è§£ Python ç±»ä¸­çš„æ–¹æ³•ï¼Œé‚£ä¹ˆå±æ€§å°±éå¸¸ç®€å•äº†ï¼Œå› ä¸º Python ä¸­çš„å±æ€§å…¶å®æ˜¯ **æ™®é€šæ–¹æ³•** çš„å˜ç§ã€‚

å¯¹äºå±æ€§ï¼Œæœ‰ä»¥ä¸‹ä¸‰ä¸ªçŸ¥è¯†ç‚¹ï¼š

- å±æ€§çš„åŸºæœ¬ä½¿ç”¨
- å±æ€§çš„ä¸¤ç§å®šä¹‰æ–¹å¼

#### å±æ€§çš„åŸºæœ¬ä½¿ç”¨

```python
# ############### å®šä¹‰ ###############
class Foo:

    def func(self):
        pass

    # å®šä¹‰å±æ€§
    @property
    def prop(self):
        pass
# ############### è°ƒç”¨ ###############
foo_obj = Foo()

foo_obj.func()
foo_obj.prop   #è°ƒç”¨å±æ€§
```

#### å±æ€§çš„å®šä¹‰å’Œä½¿ç”¨

![20241229154732_mim7LQLK.webp](https://cdn.dong4j.site/source/image/20241229154732_mim7LQLK.webp)

ç”±å±æ€§çš„å®šä¹‰å’Œè°ƒç”¨è¦æ³¨æ„ä¸€ä¸‹å‡ ç‚¹ï¼š

- å®šä¹‰æ—¶ï¼Œåœ¨æ™®é€šæ–¹æ³•çš„åŸºç¡€ä¸Šæ·»åŠ **@property**è£…é¥°å™¨ï¼›
- å®šä¹‰æ—¶ï¼Œå±æ€§ **ä»…æœ‰ä¸€ä¸ª **self å‚æ•°
- è°ƒç”¨æ—¶ï¼Œæ— éœ€ **æ‹¬å· **
  æ–¹æ³•ï¼šfoo_obj.func()
  å±æ€§ï¼šfoo_obj.prop

æ³¨æ„ï¼šå±æ€§å­˜åœ¨æ„ä¹‰æ˜¯ï¼šè®¿é—®å±æ€§æ—¶å¯ä»¥åˆ¶é€ å‡ºå’Œè®¿é—®å­—æ®µå®Œå…¨ç›¸åŒçš„å‡è±¡

å±æ€§ç”±æ–¹æ³•å˜ç§è€Œæ¥ï¼Œå¦‚æœ Python ä¸­æ²¡æœ‰å±æ€§ï¼Œæ–¹æ³•å®Œå…¨å¯ä»¥ä»£æ›¿å…¶åŠŸèƒ½ã€‚

å®ä¾‹ï¼šå¯¹äºä¸»æœºåˆ—è¡¨é¡µé¢ï¼Œæ¯æ¬¡è¯·æ±‚ä¸å¯èƒ½æŠŠæ•°æ®åº“ä¸­çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¾ç¤ºåˆ°é¡µé¢ä¸Šï¼Œè€Œæ˜¯é€šè¿‡åˆ†é¡µçš„åŠŸèƒ½å±€éƒ¨æ˜¾ç¤ºï¼Œæ‰€ä»¥åœ¨å‘æ•°æ®åº“ä¸­è¯·æ±‚æ•°æ®æ—¶å°±è¦æ˜¾ç¤ºçš„æŒ‡å®šè·å–ä»ç¬¬
m æ¡åˆ°ç¬¬ n æ¡çš„æ‰€æœ‰æ•°æ®ï¼ˆå³ï¼šlimit m,nï¼‰ï¼Œè¿™ä¸ªåˆ†é¡µçš„åŠŸèƒ½åŒ…æ‹¬ï¼š

- æ ¹æ®ç”¨æˆ·è¯·æ±‚çš„å½“å‰é¡µå’Œæ€»æ•°æ®æ¡æ•°è®¡ç®—å‡º m å’Œ n
- æ ¹æ® m å’Œ n å»æ•°æ®åº“ä¸­è¯·æ±‚æ•°æ®

```python
# ############### å®šä¹‰ ###############
class Pager:

    def __init__(self, current_page):
        # ç”¨æˆ·å½“å‰è¯·æ±‚çš„é¡µç ï¼ˆç¬¬ä¸€é¡µã€ç¬¬äºŒé¡µ...ï¼‰
        self.current_page = current_page
        # æ¯é¡µé»˜è®¤æ˜¾ç¤º 10 æ¡æ•°æ®
        self.per_items = 10

    @property
    def start(self):
        val = (self.current_page - 1) * self.per_items
        return val

    @property
    def end(self):
        val = self.current_page * self.per_items
        return val

# ############### è°ƒç”¨ ###############

p = Pager(1)
p.start å°±æ˜¯èµ·å§‹å€¼ï¼Œå³ï¼šm
p.end   å°±æ˜¯ç»“æŸå€¼ï¼Œå³ï¼šn
```

ä»ä¸Šè¿°å¯è§ï¼ŒPython çš„å±æ€§çš„åŠŸèƒ½æ˜¯ï¼šå±æ€§å†…éƒ¨è¿›è¡Œä¸€ç³»åˆ—çš„é€»è¾‘è®¡ç®—ï¼Œæœ€ç»ˆå°†è®¡ç®—ç»“æœè¿”å›ã€‚

#### å±æ€§çš„ä¸¤ç§å®šä¹‰æ–¹å¼

å±æ€§çš„å®šä¹‰æœ‰ä¸¤ç§æ–¹å¼ï¼š

- è£…é¥°å™¨ å³ï¼šåœ¨æ–¹æ³•ä¸Šåº”ç”¨è£…é¥°å™¨
- é™æ€å­—æ®µ å³ï¼šåœ¨ç±»ä¸­å®šä¹‰å€¼ä¸º property å¯¹è±¡çš„é™æ€å­—æ®µ

**è£…é¥°å™¨æ–¹å¼ï¼šåœ¨ç±»çš„æ™®é€šæ–¹æ³•ä¸Šåº”ç”¨ @property è£…é¥°å™¨ **

æˆ‘ä»¬çŸ¥é“ Python ä¸­çš„ç±»æœ‰ç»å…¸ç±»å’Œæ–°å¼ç±»ï¼Œæ–°å¼ç±»çš„å±æ€§æ¯”ç»å…¸ç±»çš„å±æ€§ä¸°å¯Œã€‚ï¼ˆ å¦‚æœç±»ç»§ objectï¼Œé‚£ä¹ˆè¯¥ç±»æ˜¯æ–°å¼ç±» ï¼‰
**ç»å…¸ç±» **ï¼Œå…·æœ‰ä¸€ç§ @property è£…é¥°å™¨ï¼ˆå¦‚ä¸Šä¸€æ­¥å®ä¾‹ï¼‰

```python
# ############### å®šä¹‰ ###############
class Goods:

    @property
    def price(self):
        return "wupeiqi"
# ############### è°ƒç”¨ ###############
obj = Goods()
result = obj.price  # è‡ªåŠ¨æ‰§è¡Œ @property ä¿®é¥°çš„ price æ–¹æ³•ï¼Œå¹¶è·å–æ–¹æ³•çš„è¿”å›å€¼
```

**æ–°å¼ç±» **ï¼Œå…·æœ‰ä¸‰ç§ @property è£…é¥°å™¨

```python
# ############### å®šä¹‰ ###############
class Goods(object):

    @property
    def price(self):
        print '@property'

    @price.setter
    def price(self, value):
        print '@price.setter'

    @price.deleter
    def price(self):
        print '@price.deleter'

# ############### è°ƒç”¨ ###############
obj = Goods()

obj.price          # è‡ªåŠ¨æ‰§è¡Œ @property ä¿®é¥°çš„ price æ–¹æ³•ï¼Œå¹¶è·å–æ–¹æ³•çš„è¿”å›å€¼

obj.price = 123    # è‡ªåŠ¨æ‰§è¡Œ @price.setter ä¿®é¥°çš„ price æ–¹æ³•ï¼Œå¹¶å°†  123 èµ‹å€¼ç»™æ–¹æ³•çš„å‚æ•°

del obj.price      # è‡ªåŠ¨æ‰§è¡Œ @price.deleter ä¿®é¥°çš„ price æ–¹æ³•
```

> æ³¨ï¼šç»å…¸ç±»ä¸­çš„å±æ€§åªæœ‰ä¸€ç§è®¿é—®æ–¹å¼ï¼Œå…¶å¯¹åº”è¢« @property ä¿®é¥°çš„æ–¹æ³•
> æ–°å¼ç±»ä¸­çš„å±æ€§æœ‰ä¸‰ç§è®¿é—®æ–¹å¼ï¼Œå¹¶åˆ†åˆ«å¯¹åº”äº†ä¸‰ä¸ªè¢« @propertyã€@æ–¹æ³•å.setterã€@æ–¹æ³•å.deleter ä¿®é¥°çš„æ–¹æ³•
>
> ç”±äºæ–°å¼ç±»ä¸­å…·æœ‰ä¸‰ç§è®¿é—®æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ä»–ä»¬å‡ ä¸ªå±æ€§çš„è®¿é—®ç‰¹ç‚¹ï¼Œåˆ†åˆ«å°†ä¸‰ä¸ªæ–¹æ³•å®šä¹‰ä¸ºå¯¹åŒä¸€ä¸ªå±æ€§ï¼šè·å–ã€ä¿®æ”¹ã€åˆ é™¤

```python
class Goods(object):

    def __init__(self):
        # åŸä»·
        self.original_price = 100
        # æŠ˜æ‰£
        self.discount = 0.8

    @property
    def price(self):
        # å®é™…ä»·æ ¼ = åŸä»· * æŠ˜æ‰£
        new_price = self.original_price * self.discount
        return new_price

    @price.setter
    def price(self, value):
        self.original_price = value

    @price.deltter
    def price(self, value):
        del self.original_price

obj = Goods()
obj.price         # è·å–å•†å“ä»·æ ¼
obj.price = 200   # ä¿®æ”¹å•†å“åŸä»·
del obj.price     # åˆ é™¤å•†å“åŸä»·
```

å®ä¾‹

**é™æ€å­—æ®µæ–¹å¼ï¼Œåˆ›å»ºå€¼ä¸º property å¯¹è±¡çš„é™æ€å­—æ®µ **

å½“ä½¿ç”¨é™æ€å­—æ®µçš„æ–¹å¼åˆ›å»ºå±æ€§æ—¶ï¼Œç»å…¸ç±»å’Œæ–°å¼ç±»æ— åŒºåˆ«

```python
class Foo:

    def get_bar(self):
        return 'wupeiqi'

    BAR = property(get_bar)

obj = Foo()
reuslt = obj.BAR        # è‡ªåŠ¨è°ƒç”¨ get_bar æ–¹æ³•ï¼Œå¹¶è·å–æ–¹æ³•çš„è¿”å›å€¼
print reuslt
```

> property çš„æ„é€ æ–¹æ³•ä¸­æœ‰ä¸ªå››ä¸ªå‚æ•°
>
> - ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ **æ–¹æ³•å **ï¼Œè°ƒç”¨`å¯¹è±¡. å±æ€§`æ—¶è‡ªåŠ¨è§¦å‘æ‰§è¡Œæ–¹æ³•
> - ç¬¬äºŒä¸ªå‚æ•°æ˜¯ **æ–¹æ³•å **ï¼Œè°ƒç”¨` å¯¹è±¡. å±æ€§ ï¼ XXX`æ—¶è‡ªåŠ¨è§¦å‘æ‰§è¡Œæ–¹æ³•
> - ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ **æ–¹æ³•å **ï¼Œè°ƒç”¨`del å¯¹è±¡. å±æ€§ `æ—¶è‡ªåŠ¨è§¦å‘æ‰§è¡Œæ–¹æ³•
> - ç¬¬å››ä¸ªå‚æ•°æ˜¯ **å­—ç¬¦ä¸² **ï¼Œè°ƒç”¨` å¯¹è±¡. å±æ€§.__doc__`ï¼Œæ­¤å‚æ•°æ˜¯è¯¥å±æ€§çš„æè¿°ä¿¡æ¯

```python
class Fooï¼š

    def get_bar(self):
        return 'wupeiqi'

    # * å¿…é¡»ä¸¤ä¸ªå‚æ•°
    def set_bar(self, value):
        return return 'set value' + value

    def del_bar(self):
        return 'wupeiqi'

    BAR ï¼ property(get_bar, set_bar, del_bar, 'description...')

obj = Foo()

obj.BAR              # è‡ªåŠ¨è°ƒç”¨ç¬¬ä¸€ä¸ªå‚æ•°ä¸­å®šä¹‰çš„æ–¹æ³•ï¼šget_bar
obj.BAR = "alex"     # è‡ªåŠ¨è°ƒç”¨ç¬¬äºŒä¸ªå‚æ•°ä¸­å®šä¹‰çš„æ–¹æ³•ï¼šset_bar æ–¹æ³•ï¼Œå¹¶å°†â€œalexâ€å½“ä½œå‚æ•°ä¼ å…¥
del Foo.BAR          # è‡ªåŠ¨è°ƒç”¨ç¬¬ä¸‰ä¸ªå‚æ•°ä¸­å®šä¹‰çš„æ–¹æ³•ï¼šdel_bar æ–¹æ³•
obj.BAE.__doc__      # è‡ªåŠ¨è·å–ç¬¬å››ä¸ªå‚æ•°ä¸­è®¾ç½®çš„å€¼ï¼šdescription...
```

> ç”±äºé™æ€å­—æ®µæ–¹å¼åˆ›å»ºå±æ€§å…·æœ‰ä¸‰ç§è®¿é—®æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ä»–ä»¬å‡ ä¸ªå±æ€§çš„è®¿é—®ç‰¹ç‚¹ï¼Œåˆ†åˆ«å°†ä¸‰ä¸ªæ–¹æ³•å®šä¹‰ä¸ºå¯¹åŒä¸€ä¸ªå±æ€§ï¼šè·å–ã€ä¿®æ”¹ã€åˆ é™¤

```python
class Goods(object):

    def __init__(self):
        # åŸä»·
        self.original_price = 100
        # æŠ˜æ‰£
        self.discount = 0.8

    def get_price(self):
        # å®é™…ä»·æ ¼ = åŸä»· * æŠ˜æ‰£
        new_price = self.original_price * self.discount
        return new_price

    def set_price(self, value):
        self.original_price = value

    def del_price(self, value):
        del self.original_price

    PRICE = property(get_price, set_price, del_price, 'ä»·æ ¼å±æ€§æè¿°...')

obj = Goods()
obj.PRICE         # è·å–å•†å“ä»·æ ¼
obj.PRICE = 200   # ä¿®æ”¹å•†å“åŸä»·
del obj.PRICE     # åˆ é™¤å•†å“åŸä»·
```

> å®ä¾‹

> æ³¨æ„ï¼šPython WEB æ¡†æ¶ Django çš„è§†å›¾ä¸­ request.POST å°±æ˜¯ä½¿ç”¨çš„é™æ€å­—æ®µçš„æ–¹å¼åˆ›å»ºçš„å±æ€§

```python
class WSGIRequest(http.HttpRequest):
def __init__(self, environ):
   script_name = get_script_name(environ)
   path_info = get_path_info(environ)
   if not path_info:
       # Sometimes PATH_INFO exists, but is empty (e.g. accessing
       # the SCRIPT_NAME URL without a trailing slash). We really need to
       # operate as if they'd requested '/'. Not amazingly nice to force
       # the path like this, but should be harmless.
       path_info = '/'
   self.environ = environ
   self.path_info = path_info
   self.path = '%s/%s' % (script_name.rstrip('/'), path_info.lstrip('/'))
   self.META = environ
   self.META['PATH_INFO'] = path_info
   self.META['SCRIPT_NAME'] = script_name
   self.method = environ['REQUEST_METHOD'].upper()
   _, content_params = cgi.parse_header(environ.get('CONTENT_TYPE', ''))
   if 'charset' in content_params:
       try:
           codecs.lookup(content_params['charset'])
       except LookupError:
           pass
       else:
           self.encoding = content_params['charset']
   self._post_parse_error = False
   try:
       content_length = int(environ.get('CONTENT_LENGTH'))
   except (ValueError, TypeError):
       content_length = 0
   self._stream = LimitedStream(self.environ['wsgi.input'], content_length)
   self._read_started = False
   self.resolver_match = None

def _get_scheme(self):
   return self.environ.get('wsgi.url_scheme')

def _get_request(self):
   warnings.warn('`request.REQUEST` is deprecated, use `request.GET` or '
                 '`request.POST` instead.', RemovedInDjango19Warning, 2)
   if not hasattr(self, '_request'):
       self._request = datastructures.MergeDict(self.POST, self.GET)
   return self._request

@cached_property
def GET(self):
   # The WSGI spec says 'QUERY_STRING' may be absent.
   raw_query_string = get_bytes_from_wsgi(self.environ, 'QUERY_STRING', '')
   return http.QueryDict(raw_query_string, encoding=self._encoding)

# ############### çœ‹è¿™é‡Œçœ‹è¿™é‡Œ  ###############
def _get_post(self):
   if not hasattr(self, '_post'):
       self._load_post_and_files()
   return self._post

# ############### çœ‹è¿™é‡Œçœ‹è¿™é‡Œ  ###############
def _set_post(self, post):
   self._post = post

@cached_property
def COOKIES(self):
   raw_cookie = get_str_from_wsgi(self.environ, 'HTTP_COOKIE', '')
   return http.parse_cookie(raw_cookie)

def _get_files(self):
   if not hasattr(self, '_files'):
       self._load_post_and_files()
   return self._files

# ############### çœ‹è¿™é‡Œçœ‹è¿™é‡Œ  ###############
POST = property(_get_post, _set_post)

FILES = property(_get_files)
REQUEST = property(_get_request)
```

> Django æºç 

æ‰€ä»¥ï¼Œå®šä¹‰å±æ€§å…±æœ‰ä¸¤ç§æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯ã€è£…é¥°å™¨ã€‘å’Œã€é™æ€å­—æ®µã€‘ï¼Œè€Œã€è£…é¥°å™¨ã€‘æ–¹å¼é’ˆå¯¹ç»å…¸ç±»å’Œæ–°å¼ç±»åˆæœ‰æ‰€ä¸åŒã€‚

### ç±»æˆå‘˜çš„ä¿®é¥°ç¬¦

ç±»çš„æ‰€æœ‰æˆå‘˜åœ¨ä¸Šä¸€æ­¥éª¤ä¸­å·²ç»åšäº†è¯¦ç»†çš„ä»‹ç»ï¼Œå¯¹äºæ¯ä¸€ä¸ªç±»çš„æˆå‘˜è€Œè¨€éƒ½æœ‰ä¸¤ç§å½¢å¼ï¼š

- å…¬æœ‰æˆå‘˜ï¼Œåœ¨ä»»ä½•åœ°æ–¹éƒ½èƒ½è®¿é—®
- ç§æœ‰æˆå‘˜ï¼Œåªæœ‰åœ¨ç±»çš„å†…éƒ¨æ‰èƒ½æ–¹æ³•

**ç§æœ‰æˆå‘˜å’Œå…¬æœ‰æˆå‘˜çš„å®šä¹‰ä¸åŒ **ï¼šç§æœ‰æˆå‘˜å‘½åæ—¶ï¼Œå‰ä¸¤ä¸ªå­—ç¬¦æ˜¯ä¸‹åˆ’çº¿ã€‚ï¼ˆç‰¹æ®Šæˆå‘˜é™¤å¤–ï¼Œä¾‹å¦‚ï¼š**init**ã€**call**ã€**dict** ç­‰ï¼‰

```python
class C:

	def __init__(self):
        self.name = 'å…¬æœ‰å­—æ®µ'
		self.__foo = "ç§æœ‰å­—æ®µ"
```

**ç§æœ‰æˆå‘˜å’Œå…¬æœ‰æˆå‘˜çš„è®¿é—®é™åˆ¶ä¸åŒ **ï¼š

#### é™æ€å­—æ®µ

- å…¬æœ‰é™æ€å­—æ®µï¼šç±»å¯ä»¥è®¿é—®ï¼›ç±»å†…éƒ¨å¯ä»¥è®¿é—®ï¼›æ´¾ç”Ÿç±»ä¸­å¯ä»¥è®¿é—®
- ç§æœ‰é™æ€å­—æ®µï¼šä»…ç±»å†…éƒ¨å¯ä»¥è®¿é—®ï¼›

```python
class C:

    name = "å…¬æœ‰é™æ€å­—æ®µ"

    def func(self):
        print C.name

class D(C):

    def show(self):
        print C.name

C.name         # ç±»è®¿é—®

obj = C()
obj.func()     # ç±»å†…éƒ¨å¯ä»¥è®¿é—®

obj_son = D()
obj_son.show() # æ´¾ç”Ÿç±»ä¸­å¯ä»¥è®¿é—®
```

##### å…¬æœ‰é™æ€å­—æ®µ

```python
class C:

    __name = "å…¬æœ‰é™æ€å­—æ®µ"

    def func(self):
        print C.__name

class D(C):

    def show(self):
        print C.__name

C.__name       # ç±»è®¿é—®            é”™è¯¯

obj = C()
obj.func()     # ç±»å†…éƒ¨å¯ä»¥è®¿é—®    æ­£ç¡®

obj_son = D()
obj_son.show() # æ´¾ç”Ÿç±»ä¸­å¯ä»¥è®¿é—®   é”™è¯¯
```

##### ç§æœ‰é™æ€å­—æ®µ

#### æ™®é€šå­—æ®µ

- å…¬æœ‰æ™®é€šå­—æ®µï¼šå¯¹è±¡å¯ä»¥è®¿é—®ï¼›ç±»å†…éƒ¨å¯ä»¥è®¿é—®ï¼›æ´¾ç”Ÿç±»ä¸­å¯ä»¥è®¿é—®
- ç§æœ‰æ™®é€šå­—æ®µï¼šä»…ç±»å†…éƒ¨å¯ä»¥è®¿é—®ï¼›

psï¼šå¦‚æœæƒ³è¦å¼ºåˆ¶è®¿é—®ç§æœ‰å­—æ®µï¼Œå¯ä»¥é€šè¿‡ ã€`å¯¹è±¡._ç±»å` ç§æœ‰å­—æ®µåã€‘è®¿é—®ï¼ˆå¦‚ `obj._C**foo`ï¼‰ï¼Œä¸å»ºè®®å¼ºåˆ¶è®¿é—®ç§æœ‰æˆå‘˜ã€‚

```python
class C:

    def __init__(self):
        self.foo = "å…¬æœ‰å­—æ®µ"

    def func(self):
        print self.foo ã€€#ã€€ç±»å†…éƒ¨è®¿é—®

class D(C):

    def show(self):
        print self.fooã€€ï¼ƒã€€æ´¾ç”Ÿç±»ä¸­è®¿é—®

obj = C()

obj.foo     # é€šè¿‡å¯¹è±¡è®¿é—®
obj.func()  # ç±»å†…éƒ¨è®¿é—®

obj_son = D();
obj_son.show()  # æ´¾ç”Ÿç±»ä¸­è®¿é—®
```

##### å…¬æœ‰å­—æ®µ

```python
class C:

    def __init__(self):
        self.__foo = "ç§æœ‰å­—æ®µ"

    def func(self):
        print self.foo ã€€#ã€€ç±»å†…éƒ¨è®¿é—®

class D(C):

    def show(self):
        print self.fooã€€ï¼ƒã€€æ´¾ç”Ÿç±»ä¸­è®¿é—®

obj = C()

obj.__foo     # é€šè¿‡å¯¹è±¡è®¿é—®    é”™è¯¯
obj.func()  # ç±»å†…éƒ¨è®¿é—®        æ­£ç¡®

obj_son = D();
obj_son.show()  # æ´¾ç”Ÿç±»ä¸­è®¿é—®  é”™è¯¯
```

##### ç§æœ‰å­—æ®µ

æ–¹æ³•ã€å±æ€§çš„è®¿é—®äºä¸Šè¿°æ–¹å¼ç›¸ä¼¼ï¼Œå³ï¼šç§æœ‰æˆå‘˜åªèƒ½åœ¨ç±»å†…éƒ¨ä½¿ç”¨

### ç±»çš„ç‰¹æ®Šæˆå‘˜

ä¸Šæ–‡ä»‹ç»äº† Python çš„ç±»æˆå‘˜ä»¥åŠæˆå‘˜ä¿®é¥°ç¬¦ï¼Œä»è€Œäº†è§£åˆ°ç±»ä¸­æœ‰å­—æ®µã€æ–¹æ³•å’Œå±æ€§ä¸‰å¤§ç±»æˆå‘˜ï¼Œå¹¶ä¸”æˆå‘˜åå‰å¦‚æœæœ‰ä¸¤ä¸ªä¸‹åˆ’çº¿ï¼Œåˆ™è¡¨ç¤ºè¯¥æˆå‘˜æ˜¯ç§æœ‰æˆå‘˜ï¼Œç§æœ‰æˆå‘˜åªèƒ½ç”±ç±»å†…éƒ¨è°ƒç”¨ã€‚æ— è®ºäººæˆ–äº‹ç‰©å¾€å¾€éƒ½æœ‰ä¸æŒ‰å¥—è·¯å‡ºç‰Œçš„æƒ…å†µï¼ŒPython
çš„ç±»æˆå‘˜ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå­˜åœ¨ç€ä¸€äº›å…·æœ‰ç‰¹æ®Šå«ä¹‰çš„æˆå‘˜ï¼Œè¯¦æƒ…å¦‚ä¸‹ï¼š

#### . **doc**

è¡¨ç¤ºç±»çš„æè¿°ä¿¡æ¯

```python
class Foo:
    """ æè¿°ç±»ä¿¡æ¯ï¼Œè¿™æ˜¯ç”¨äºçœ‹ç‰‡çš„ç¥å¥‡ """

    def func(self):
        pass

print Foo.__doc__
#è¾“å‡ºï¼šç±»çš„æè¿°ä¿¡æ¯
```

#### . **module** å’Œ **class**

**module** è¡¨ç¤ºå½“å‰æ“ä½œçš„å¯¹è±¡åœ¨é‚£ä¸ªæ¨¡å—

**class**è¡¨ç¤ºå½“å‰æ“ä½œçš„å¯¹è±¡çš„ç±»æ˜¯ä»€ä¹ˆ

```python
#!/usr/bin/env python
# -*- coding:utf-8 -*-

class C:

    def __init__(self):
        self.name = 'wupeiqi'
```

lib/aa.py

```python
from lib.aa import C

obj = C()
print obj.__module__  # è¾“å‡º lib.aaï¼Œå³ï¼šè¾“å‡ºæ¨¡å—
print obj.__class__      # è¾“å‡º lib.aa.Cï¼Œå³ï¼šè¾“å‡ºç±»
```

index.py

#### . **init**

æ„é€ æ–¹æ³•ï¼Œé€šè¿‡ç±»åˆ›å»ºå¯¹è±¡æ—¶ï¼Œè‡ªåŠ¨è§¦å‘æ‰§è¡Œã€‚

```python
class Foo:

    def __init__(self, name):
        self.name = name
        self.age = 18

obj = Foo('wupeiqi') # è‡ªåŠ¨æ‰§è¡Œç±»ä¸­çš„ __init__ æ–¹æ³•
```

#### . **del**

ææ„æ–¹æ³•ï¼Œå½“å¯¹è±¡åœ¨å†…å­˜ä¸­è¢«é‡Šæ”¾æ—¶ï¼Œè‡ªåŠ¨è§¦å‘æ‰§è¡Œã€‚

æ³¨ï¼šæ­¤æ–¹æ³•ä¸€èˆ¬æ— é¡»å®šä¹‰ï¼Œå› ä¸º Python æ˜¯ä¸€é—¨é«˜çº§è¯­è¨€ï¼Œç¨‹åºå‘˜åœ¨ä½¿ç”¨æ—¶æ— éœ€å…³å¿ƒå†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾ï¼Œå› ä¸ºæ­¤å·¥ä½œéƒ½æ˜¯äº¤ç»™ Python
è§£é‡Šå™¨æ¥æ‰§è¡Œï¼Œæ‰€ä»¥ï¼Œææ„å‡½æ•°çš„è°ƒç”¨æ˜¯ç”±è§£é‡Šå™¨åœ¨è¿›è¡Œåƒåœ¾å›æ”¶æ—¶è‡ªåŠ¨è§¦å‘æ‰§è¡Œçš„ã€‚

```python
class Foo:

    def __del__(self):
        pass
```

#### . **call**

å¯¹è±¡åé¢åŠ æ‹¬å·ï¼Œè§¦å‘æ‰§è¡Œã€‚

æ³¨ï¼šæ„é€ æ–¹æ³•çš„æ‰§è¡Œæ˜¯ç”±åˆ›å»ºå¯¹è±¡è§¦å‘çš„ï¼Œå³ï¼šå¯¹è±¡ = ç±»å ()ï¼›è€Œå¯¹äº **call** æ–¹æ³•çš„æ‰§è¡Œæ˜¯ç”±å¯¹è±¡ååŠ æ‹¬å·è§¦å‘çš„ï¼Œå³ï¼šå¯¹è±¡ () æˆ–è€… ç±» ()()

```python
class Foo:

    def __init__(self):
        pass

    def __call__(self, *args, **kwargs):

        print '__call__'

obj = Foo() # æ‰§è¡Œ __init__
obj()       # æ‰§è¡Œ __call__
```

#### . **dict**

ç±»æˆ–å¯¹è±¡ä¸­çš„æ‰€æœ‰æˆå‘˜

ä¸Šæ–‡ä¸­æˆ‘ä»¬çŸ¥é“ï¼šç±»çš„æ™®é€šå­—æ®µå±äºå¯¹è±¡ï¼›ç±»ä¸­çš„é™æ€å­—æ®µå’Œæ–¹æ³•ç­‰å±äºç±»ï¼Œå³ï¼š

![20241229154732_oYdwaMPb.webp](https://cdn.dong4j.site/source/image/20241229154732_oYdwaMPb.webp)

```python
class Province:

    country = 'China'

    def __init__(self, name, count):
        self.name = name
        self.count = count

    def func(self, *args, **kwargs):
        print 'func'

# è·å–ç±»çš„æˆå‘˜ï¼Œå³ï¼šé™æ€å­—æ®µã€æ–¹æ³•ã€
print Province.__dict__
# è¾“å‡ºï¼š{'country': 'China', '__module__': '__main__', 'func': , '__init__': , '__doc__': None}

obj1 = Province('HeBei',10000)
print obj1.__dict__
# è·å– å¯¹è±¡ obj1 çš„æˆå‘˜
# è¾“å‡ºï¼š{'count': 10000, 'name': 'HeBei'}

obj2 = Province('HeNan', 3888)
print obj2.__dict__
# è·å– å¯¹è±¡ obj1 çš„æˆå‘˜
# è¾“å‡ºï¼š{'count': 3888, 'name': 'HeNan'}
```

#### . **str**

å¦‚æœä¸€ä¸ªç±»ä¸­å®šä¹‰äº† **str** æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨æ‰“å° å¯¹è±¡ æ—¶ï¼Œé»˜è®¤è¾“å‡ºè¯¥æ–¹æ³•çš„è¿”å›å€¼ã€‚

```python
class Foo:

    def __str__(self):
        return 'wupeiqi'

obj = Foo()
print obj
# è¾“å‡ºï¼šwupeiqi
```

#### **getitem** **setitem** **delitem**

ç”¨äºç´¢å¼•æ“ä½œï¼Œå¦‚å­—å…¸ã€‚ä»¥ä¸Šåˆ†åˆ«è¡¨ç¤ºè·å–ã€è®¾ç½®ã€åˆ é™¤æ•°æ®

```python
#!/usr/bin/env python
# -*- coding:utf-8 -*-

class Foo(object):

    def __getitem__(self, key):
        print '__getitem__',key

    def __setitem__(self, key, value):
        print '__setitem__',key,value

    def __delitem__(self, key):
        print '__delitem__',key

obj = Foo()

result = obj['k1']      # è‡ªåŠ¨è§¦å‘æ‰§è¡Œ __getitem__
obj['k2'] = 'wupeiqi'   # è‡ªåŠ¨è§¦å‘æ‰§è¡Œ __setitem__
del obj['k1']           # è‡ªåŠ¨è§¦å‘æ‰§è¡Œ __delitem__
```

#### **getslice** **setslice** **delslice**

è¯¥ä¸‰ä¸ªæ–¹æ³•ç”¨äºåˆ†ç‰‡æ“ä½œï¼Œå¦‚ï¼šåˆ—è¡¨

```python
#!/usr/bin/env python
# -*- coding:utf-8 -*-

class Foo(object):

    def __getslice__(self, i, j):
        print '__getslice__',i,j

    def __setslice__(self, i, j, sequence):
        print '__setslice__',i,j

    def __delslice__(self, i, j):
        print '__delslice__',i,j

obj = Foo()

obj[-1:1]                   # è‡ªåŠ¨è§¦å‘æ‰§è¡Œ __getslice__
obj[0:1] = [11,22,33,44]    # è‡ªåŠ¨è§¦å‘æ‰§è¡Œ __setslice__
del obj[0:2]                # è‡ªåŠ¨è§¦å‘æ‰§è¡Œ __delslice__
```

#### . **iter**

ç”¨äºè¿­ä»£å™¨ï¼Œä¹‹æ‰€ä»¥åˆ—è¡¨ã€å­—å…¸ã€å…ƒç»„å¯ä»¥è¿›è¡Œ for å¾ªç¯ï¼Œæ˜¯å› ä¸ºç±»å‹å†…éƒ¨å®šä¹‰äº† **iter**

```python
class Foo(object):
    pass

obj = Foo()

for i in obj:
    print i

# æŠ¥é”™ï¼šTypeError: 'Foo' object is not iterable
```

ç¬¬ä¸€æ­¥

```python
#!/usr/bin/env python
# -*- coding:utf-8 -*-

class Foo(object):

    def __iter__(self):
        pass

obj = Foo()

for i in obj:
    print i

# æŠ¥é”™ï¼šTypeError: iter() returned non-iterator of type 'NoneType'
```

ç¬¬äºŒæ­¥

```python
#!/usr/bin/env python
# -*- coding:utf-8 -*-

class Foo(object):

    def __init__(self, sq):
        self.sq = sq

    def __iter__(self):
        return iter(self.sq)

obj = Foo([11,22,33,44])

for i in obj:
    print i
```

ç¬¬ä¸‰æ­¥

ä»¥ä¸Šæ­¥éª¤å¯ä»¥çœ‹å‡ºï¼Œfor å¾ªç¯è¿­ä»£çš„å…¶å®æ˜¯ iter([11,22,33,44]) ï¼Œæ‰€ä»¥æ‰§è¡Œæµç¨‹å¯ä»¥å˜æ›´ä¸ºï¼š

```python
#!/usr/bin/env python
# -*- coding:utf-8 -*-

obj = iter([11,22,33,44])

for i in obj:
    print i
```

```python
#!/usr/bin/env python
# -*- coding:utf-8 -*-

obj = iter([11,22,33,44])

while True:
    val = obj.next()
    print val
```

For å¾ªç¯è¯­æ³•å†…éƒ¨

#### . **new** å’Œ **metaclass**

é˜…è¯»ä»¥ä¸‹ä»£ç ï¼š

```python
class Foo(object):

    def __init__(self):
        pass

obj = Foo()   # obj æ˜¯é€šè¿‡ Foo ç±»å®ä¾‹åŒ–çš„å¯¹è±¡
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œobj æ˜¯é€šè¿‡ Foo ç±»å®ä¾‹åŒ–çš„å¯¹è±¡ï¼Œå…¶å®ï¼Œä¸ä»… obj æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒFoo ç±»æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå› ä¸ºåœ¨ **Python ä¸­ä¸€åˆ‡äº‹ç‰©éƒ½æ˜¯å¯¹è±¡ **ã€‚

å¦‚æœæŒ‰ç…§ä¸€åˆ‡äº‹ç‰©éƒ½æ˜¯å¯¹è±¡çš„ç†è®ºï¼šobj å¯¹è±¡æ˜¯é€šè¿‡æ‰§è¡Œ Foo ç±»çš„æ„é€ æ–¹æ³•åˆ›å»ºï¼Œé‚£ä¹ˆ Foo ç±»å¯¹è±¡åº”è¯¥ä¹Ÿæ˜¯é€šè¿‡æ‰§è¡ŒæŸä¸ªç±»çš„ æ„é€ æ–¹æ³• åˆ›å»ºã€‚

```python
print type(obj) # è¾“å‡ºï¼š     è¡¨ç¤ºï¼Œobj å¯¹è±¡ç”± Foo ç±»åˆ›å»º
print type(Foo) # è¾“å‡ºï¼š              è¡¨ç¤ºï¼ŒFoo ç±»å¯¹è±¡ç”± type ç±»åˆ›å»º
```

æ‰€ä»¥ï¼Œ**obj å¯¹è±¡æ˜¯ Foo ç±»çš„ä¸€ä¸ªå®ä¾‹ **ï¼Œ**Foo ç±»å¯¹è±¡æ˜¯ type ç±»çš„ä¸€ä¸ªå®ä¾‹ **ï¼Œå³ï¼šFoo ç±»å¯¹è±¡ æ˜¯é€šè¿‡ type ç±»çš„æ„é€ æ–¹æ³•åˆ›å»ºã€‚

## åˆ›å»ºç±»å°±å¯ä»¥æœ‰ä¸¤ç§æ–¹å¼

### æ™®é€šæ–¹å¼

```python
class Foo(object):

    def func(self):
        print 'hello wupeiqi'
```

### ç‰¹æ®Šæ–¹å¼ï¼ˆtype ç±»çš„æ„é€ å‡½æ•°ï¼‰

```python
def func(self):
    print 'hello wupeiqi'

Foo = type('Foo',(object,), {'func': func})
#type ç¬¬ä¸€ä¸ªå‚æ•°ï¼šç±»å
#type ç¬¬äºŒä¸ªå‚æ•°ï¼šå½“å‰ç±»çš„åŸºç±»
#type ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šç±»çš„æˆå‘˜
```

ï¼ï¼ã€‹ ç±» æ˜¯ç”± type ç±»å®ä¾‹åŒ–äº§ç”Ÿ

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œç±»é»˜è®¤æ˜¯ç”± type ç±»å®ä¾‹åŒ–äº§ç”Ÿï¼Œtype ç±»ä¸­å¦‚ä½•å®ç°çš„åˆ›å»ºç±»ï¼Ÿç±»åˆæ˜¯å¦‚ä½•åˆ›å»ºå¯¹è±¡ï¼Ÿ

ç­”ï¼šç±»ä¸­æœ‰ä¸€ä¸ªå±æ€§**metaclass**ï¼Œå…¶ç”¨æ¥è¡¨ç¤ºè¯¥ç±»ç”± è° æ¥å®ä¾‹åŒ–åˆ›å»ºï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥ä¸º**metaclass** è®¾ç½®ä¸€ä¸ª type ç±»çš„æ´¾ç”Ÿç±»ï¼Œä»è€ŒæŸ¥çœ‹ ç±» åˆ›å»ºçš„è¿‡ç¨‹ã€‚

![20241229154732_GNU1bhCj.webp](https://cdn.dong4j.site/source/image/20241229154732_GNU1bhCj.webp)

```python
class MyType(type):

    def __init__(self, what, bases=None, dict=None):
        super(MyType, self).__init__(what, bases, dict)

    def __call__(self, *args, **kwargs):
        obj = self.__new__(self, *args, **kwargs)

        self.__init__(obj)

class Foo(object):

    __metaclass__ = MyType

    def __init__(self, name):
        self.name = name

    def __new__(cls, *args, **kwargs):
        return object.__new__(cls, *args, **kwargs)

# ç¬¬ä¸€é˜¶æ®µï¼šè§£é‡Šå™¨ä»ä¸Šåˆ°ä¸‹æ‰§è¡Œä»£ç åˆ›å»º Foo ç±»
# ç¬¬äºŒé˜¶æ®µï¼šé€šè¿‡ Foo ç±»åˆ›å»º obj å¯¹è±¡
obj = Foo()
```

## [Python OOP å…¥é—¨ï¼šè½»æ¾æŒæ¡å°è£…ã€ç»§æ‰¿å’Œå¤šæ€](https://blog.dong4j.site/posts/b158ae75.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

Python é¢å‘å¯¹è±¡åŸºç¡€éƒ¨åˆ†

<!-- more -->

åŸæ–‡å‡ºå¤„: [æ­¦æ²›é½ cnblog](http://www.cnblogs.com/wupeiqi/p/4493506.html)

## æ¦‚è¿°

- é¢å‘è¿‡ç¨‹ï¼šæ ¹æ®ä¸šåŠ¡é€»è¾‘ä»ä¸Šåˆ°ä¸‹å†™å’ä»£ç 
- å‡½æ•°å¼ï¼šå°†æŸåŠŸèƒ½ä»£ç å°è£…åˆ°å‡½æ•°ä¸­ï¼Œæ—¥åä¾¿æ— éœ€é‡å¤ç¼–å†™ï¼Œä»…è°ƒç”¨å‡½æ•°å³å¯
- é¢å‘å¯¹è±¡ï¼šå¯¹å‡½æ•°è¿›è¡Œåˆ†ç±»å’Œå°è£…ï¼Œè®©å¼€å‘â€œæ›´å¿«æ›´å¥½æ›´å¼ºâ€¦â€

é¢å‘è¿‡ç¨‹ç¼–ç¨‹æœ€æ˜“è¢«åˆå­¦è€…æ¥å—ï¼Œå…¶å¾€å¾€ç”¨ä¸€é•¿æ®µä»£ç æ¥å®ç°æŒ‡å®šåŠŸèƒ½ï¼Œå¼€å‘è¿‡ç¨‹ä¸­æœ€å¸¸è§çš„æ“ä½œå°±æ˜¯ç²˜è´´å¤åˆ¶ï¼Œå³ï¼šå°†ä¹‹å‰å®ç°çš„ä»£ç å—å¤åˆ¶åˆ°ç°éœ€åŠŸèƒ½å¤„ã€‚

```python
while Trueï¼š
    if cpu åˆ©ç”¨ç‡ > 90%:
        #å‘é€é‚®ä»¶æé†’
        è¿æ¥é‚®ç®±æœåŠ¡å™¨
        å‘é€é‚®ä»¶
        å…³é—­è¿æ¥

    if ç¡¬ç›˜ä½¿ç”¨ç©ºé—´ > 90%:
        #å‘é€é‚®ä»¶æé†’
        è¿æ¥é‚®ç®±æœåŠ¡å™¨
        å‘é€é‚®ä»¶
        å…³é—­è¿æ¥

    if å†…å­˜å ç”¨ > 80%:
        #å‘é€é‚®ä»¶æé†’
        è¿æ¥é‚®ç®±æœåŠ¡å™¨
        å‘é€é‚®ä»¶
        å…³é—­è¿æ¥
```

éšç€æ—¶é—´çš„æ¨ç§»ï¼Œå¼€å§‹ä½¿ç”¨äº†å‡½æ•°å¼ç¼–ç¨‹ï¼Œå¢å¼ºä»£ç çš„é‡ç”¨æ€§å’Œå¯è¯»æ€§ï¼Œå°±å˜æˆäº†è¿™æ ·

```python
def å‘é€é‚®ä»¶ (å†…å®¹)
    #å‘é€é‚®ä»¶æé†’
    è¿æ¥é‚®ç®±æœåŠ¡å™¨
    å‘é€é‚®ä»¶
    å…³é—­è¿æ¥

while Trueï¼š
    if cpu åˆ©ç”¨ç‡ > 90%:
        å‘é€é‚®ä»¶ ('CPUæŠ¥è­¦')

    if ç¡¬ç›˜ä½¿ç”¨ç©ºé—´ > 90%:
        å‘é€é‚®ä»¶ ('ç¡¬ç›˜æŠ¥è­¦')

    if å†…å­˜å ç”¨ > 80%:
        å‘é€é‚®ä»¶ ('å†…å­˜æŠ¥è­¦')
```

ä»Šå¤©æˆ‘ä»¬æ¥å­¦ä¹ ä¸€ç§æ–°çš„ç¼–ç¨‹æ–¹å¼ï¼šé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼ˆObject Oriented Programmingï¼ŒOOPï¼Œé¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡ï¼‰

## åˆ›å»ºç±»å’Œå¯¹è±¡

é¢å‘å¯¹è±¡ç¼–ç¨‹æ˜¯ä¸€ç§ç¼–ç¨‹æ–¹å¼ï¼Œæ­¤ç¼–ç¨‹æ–¹å¼çš„è½åœ°éœ€è¦ä½¿ç”¨ â€œç±»â€ å’Œ â€œå¯¹è±¡â€ æ¥å®ç°ï¼Œæ‰€ä»¥ï¼Œé¢å‘å¯¹è±¡ç¼–ç¨‹å…¶å®å°±æ˜¯å¯¹ â€œç±»â€ å’Œ â€œå¯¹è±¡â€ çš„ä½¿ç”¨ã€‚

ç±»å°±æ˜¯ä¸€ä¸ªæ¨¡æ¿ï¼Œæ¨¡æ¿é‡Œå¯ä»¥åŒ…å«å¤šä¸ªå‡½æ•°ï¼Œå‡½æ•°é‡Œå®ç°ä¸€äº›åŠŸèƒ½

å¯¹è±¡åˆ™æ˜¯æ ¹æ®æ¨¡æ¿åˆ›å»ºçš„å®ä¾‹ï¼Œé€šè¿‡å®ä¾‹å¯¹è±¡å¯ä»¥æ‰§è¡Œç±»ä¸­çš„å‡½æ•° ![20241229154732_wkz3JL10.webp](https://cdn.dong4j.site/source/image/20241229154732_wkz3JL10.webp)

- class æ˜¯å…³é”®å­—ï¼Œè¡¨ç¤ºç±»
- åˆ›å»ºå¯¹è±¡ï¼Œç±»åç§°ååŠ æ‹¬å·å³å¯

_psï¼šç±»ä¸­çš„å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯ selfï¼ˆè¯¦ç»†è§ï¼šç±»çš„ä¸‰å¤§ç‰¹æ€§ä¹‹å°è£…ï¼‰_
_ç±»ä¸­å®šä¹‰çš„å‡½æ•°å«åš â€œæ–¹æ³•â€_

```python
# åˆ›å»ºç±»
class Foo:
    def Bar(self):
        print 'Bar'

    def Hello(self, name):
        print 'i am %s' %name

# æ ¹æ®ç±» Foo åˆ›å»ºå¯¹è±¡ obj
obj = Foo()
obj.Bar()            #æ‰§è¡Œ Bar æ–¹æ³•
obj.Hello('wupeiqi') #æ‰§è¡Œ Hello æ–¹æ³•
```

- è¯¶ï¼Œä½ åœ¨è¿™é‡Œæ˜¯ä¸æ˜¯æœ‰ç–‘é—®äº†ï¼Ÿä½¿ç”¨å‡½æ•°å¼ç¼–ç¨‹å’Œé¢å‘å¯¹è±¡ç¼–ç¨‹æ–¹å¼æ¥æ‰§è¡Œä¸€ä¸ªâ€œæ–¹æ³•â€æ—¶å‡½æ•°è¦æ¯”é¢å‘å¯¹è±¡ç®€ä¾¿

- - é¢å‘å¯¹è±¡ï¼šã€åˆ›å»ºå¯¹è±¡ã€‘ã€é€šè¿‡å¯¹è±¡æ‰§è¡Œæ–¹æ³•ã€‘
- - å‡½æ•°ç¼–ç¨‹ï¼šã€æ‰§è¡Œå‡½æ•°ã€‘

è§‚å¯Ÿä¸Šè¿°å¯¹æ¯”ç­”æ¡ˆåˆ™æ˜¯è‚¯å®šçš„ï¼Œç„¶åå¹¶éç»å¯¹ï¼Œåœºæ™¯çš„ä¸åŒé€‚åˆå…¶çš„ç¼–ç¨‹æ–¹å¼ä¹Ÿä¸åŒã€‚

æ€»ç»“ï¼šå‡½æ•°å¼çš„åº”ç”¨åœºæ™¯ â€“> å„ä¸ªå‡½æ•°ä¹‹é—´æ˜¯ç‹¬ç«‹ä¸”æ— å…±ç”¨çš„æ•°æ®

### é¢å‘å¯¹è±¡ä¸‰å¤§ç‰¹æ€§

é¢å‘å¯¹è±¡çš„ä¸‰å¤§ç‰¹æ€§æ˜¯æŒ‡ï¼šå°è£…ã€ç»§æ‰¿å’Œå¤šæ€ã€‚

#### å°è£…

å°è£…ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯å°†å†…å®¹å°è£…åˆ°æŸä¸ªåœ°æ–¹ï¼Œä»¥åå†å»è°ƒç”¨è¢«å°è£…åœ¨æŸå¤„çš„å†…å®¹ã€‚

æ‰€ä»¥ï¼Œåœ¨ä½¿ç”¨é¢å‘å¯¹è±¡çš„å°è£…ç‰¹æ€§æ—¶ï¼Œéœ€è¦ï¼š

- å°†å†…å®¹å°è£…åˆ°æŸå¤„
- ä»æŸå¤„è°ƒç”¨è¢«å°è£…çš„å†…å®¹

**ç¬¬ä¸€æ­¥ï¼šå°†å†…å®¹å°è£…åˆ°æŸå¤„ ![20241229154732_KUELWY3L.webp](https://cdn.dong4j.site/source/image/20241229154732_KUELWY3L.webp)**

self æ˜¯ä¸€ä¸ªå½¢å¼å‚æ•°

å½“æ‰§è¡Œ obj1 = Foo(â€˜wupeiqiâ€™, 18) æ—¶ï¼Œself ç­‰äº obj1

å½“æ‰§è¡Œ obj2 = Foo(â€˜alexâ€™, 78) æ—¶ï¼Œself ç­‰äº obj2

æ‰€ä»¥ï¼Œå†…å®¹å…¶å®è¢«å°è£…åˆ°äº†å¯¹è±¡ obj1 å’Œ obj2 ä¸­ï¼Œæ¯ä¸ªå¯¹è±¡ä¸­éƒ½æœ‰ name å’Œ age
å±æ€§ï¼Œåœ¨å†…å­˜é‡Œç±»ä¼¼äºä¸‹å›¾æ¥ä¿å­˜ã€‚![20241229154732_CaGPuPCm.webp](https://cdn.dong4j.site/source/image/20241229154732_CaGPuPCm.webp)

**ç¬¬äºŒæ­¥ï¼šä»æŸå¤„è°ƒç”¨è¢«å°è£…çš„å†…å®¹**

è°ƒç”¨è¢«å°è£…çš„å†…å®¹æ—¶ï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼š

- é€šè¿‡å¯¹è±¡ç›´æ¥è°ƒç”¨
- é€šè¿‡ self é—´æ¥è°ƒç”¨

1ã€é€šè¿‡å¯¹è±¡ç›´æ¥è°ƒç”¨è¢«å°è£…çš„å†…å®¹

ä¸Šå›¾å±•ç¤ºäº†å¯¹è±¡ obj1 å’Œ obj2 åœ¨å†…å­˜ä¸­ä¿å­˜çš„æ–¹å¼ï¼Œæ ¹æ®ä¿å­˜æ ¼å¼å¯ä»¥å¦‚æ­¤è°ƒç”¨è¢«å°è£…çš„å†…å®¹ï¼šå¯¹è±¡. å±æ€§å

```python
class Foo:

    def __init__(self, name, age):
        self.name = name
        self.age = age

obj1 = Foo('wupeiqi', 18)
print obj1.name    # ç›´æ¥è°ƒç”¨ obj1 å¯¹è±¡çš„ name å±æ€§
print obj1.age     # ç›´æ¥è°ƒç”¨ obj1 å¯¹è±¡çš„ age å±æ€§

obj2 = Foo('alex', 73)
print obj2.name    # ç›´æ¥è°ƒç”¨ obj2 å¯¹è±¡çš„ name å±æ€§
print obj2.age     # ç›´æ¥è°ƒç”¨ obj2 å¯¹è±¡çš„ age å±æ€§
```

2ã€é€šè¿‡ self é—´æ¥è°ƒç”¨è¢«å°è£…çš„å†…å®¹

æ‰§è¡Œç±»ä¸­çš„æ–¹æ³•æ—¶ï¼Œéœ€è¦é€šè¿‡ self é—´æ¥è°ƒç”¨è¢«å°è£…çš„å†…å®¹

```python
class Foo:

    def __init__(self, name, age):
        self.name = name
        self.age = age

    def detail(self):
        print self.name
        print self.age

obj1 = Foo('wupeiqi', 18)
obj1.detail()# Python é»˜è®¤ä¼šå°† obj1 ä¼ ç»™ self å‚æ•°ï¼Œå³ï¼šobj1.detail(obj1)ï¼Œæ‰€ä»¥ï¼Œæ­¤æ—¶æ–¹æ³•å†…éƒ¨çš„ self ï¼ obj1ï¼Œå³ï¼šself.name æ˜¯ wupeiqi ï¼›self.age æ˜¯ 18

obj2 = Foo('alex', 73)
obj2.detail()# Python é»˜è®¤ä¼šå°† obj2 ä¼ ç»™ self å‚æ•°ï¼Œå³ï¼šobj1.detail(obj2)ï¼Œæ‰€ä»¥ï¼Œæ­¤æ—¶æ–¹æ³•å†…éƒ¨çš„ self ï¼ obj2ï¼Œå³ï¼šself.name æ˜¯ alex ï¼› self.age æ˜¯ 78
```

**ç»¼ä¸Šæ‰€è¿°ï¼Œå¯¹äºé¢å‘å¯¹è±¡çš„å°è£…æ¥è¯´ï¼Œå…¶å®å°±æ˜¯ä½¿ç”¨æ„é€ æ–¹æ³•å°†å†…å®¹å°è£…åˆ° å¯¹è±¡ ä¸­ï¼Œç„¶åé€šè¿‡å¯¹è±¡ç›´æ¥æˆ–è€… self é—´æ¥è·å–è¢«å°è£…çš„å†…å®¹ã€‚**

```
ç»ƒä¹ ä¸€ï¼šåœ¨ç»ˆç«¯è¾“å‡ºå¦‚ä¸‹ä¿¡æ¯

å°æ˜ï¼Œ10 å²ï¼Œç”·ï¼Œä¸Šå±±å»ç æŸ´
å°æ˜ï¼Œ10 å²ï¼Œç”·ï¼Œå¼€è½¦å»ä¸œåŒ—
å°æ˜ï¼Œ10 å²ï¼Œç”·ï¼Œæœ€çˆ±å¤§ä¿å¥
è€æï¼Œ90 å²ï¼Œç”·ï¼Œä¸Šå±±å»ç æŸ´
è€æï¼Œ90 å²ï¼Œç”·ï¼Œå¼€è½¦å»ä¸œåŒ—
è€æï¼Œ90 å²ï¼Œç”·ï¼Œæœ€çˆ±å¤§ä¿å¥
è€å¼ ...
```

```python
def kanchai(name, age, gender):
    print "%s,%så²,%s,ä¸Šå±±å»ç æŸ´" %(name, age, gender)

def qudongbei(name, age, gender):
    print "%s,%så²,%s,å¼€è½¦å»ä¸œåŒ—" %(name, age, gender)

def dabaojian(name, age, gender):
    print "%s,%så²,%s,æœ€çˆ±å¤§ä¿å¥" %(name, age, gender)

kanchai('å°æ˜', 10, 'ç”·')
qudongbei('å°æ˜', 10, 'ç”·')
dabaojian('å°æ˜', 10, 'ç”·')

kanchai('è€æ', 90, 'ç”·')
qudongbei('è€æ', 90, 'ç”·')
dabaojian('è€æ', 90, 'ç”·')
```

```python
class Foo:

    def __init__(self, name, age ,gender):
        self.name = name
        self.age = age
        self.gender = gender

    def kanchai(self):
        print "%s,%så²,%s,ä¸Šå±±å»ç æŸ´" %(self.name, self.age, self.gender)

    def qudongbei(self):
        print "%s,%så²,%s,å¼€è½¦å»ä¸œåŒ—" %(self.name, self.age, self.gender)

    def dabaojian(self):
        print "%s,%så²,%s,æœ€çˆ±å¤§ä¿å¥" %(self.name, self.age, self.gender)

xiaoming = Foo('å°æ˜', 10, 'ç”·')
xiaoming.kanchai()
xiaoming.qudongbei()
xiaoming.dabaojian()

laoli = Foo('è€æ', 90, 'ç”·')
laoli.kanchai()
laoli.qudongbei()
laoli.dabaojian()
```

```
ç»ƒä¹ äºŒï¼šæ¸¸æˆäººç”Ÿç¨‹åº

1ã€åˆ›å»ºä¸‰ä¸ªæ¸¸æˆäººç‰©ï¼Œåˆ†åˆ«æ˜¯ï¼š

è‹äº•äº•ï¼Œå¥³ï¼Œ18ï¼Œåˆå§‹æˆ˜æ–—åŠ› 1000
ä¸œå°¼æœ¨æœ¨ï¼Œç”·ï¼Œ20ï¼Œåˆå§‹æˆ˜æ–—åŠ› 1800
æ³¢å¤šå¤šï¼Œå¥³ï¼Œ19ï¼Œåˆå§‹æˆ˜æ–—åŠ› 2500
2ã€æ¸¸æˆåœºæ™¯ï¼Œåˆ†åˆ«ï¼š

è‰ä¸›æˆ˜æ–—ï¼Œæ¶ˆè€— 200 æˆ˜æ–—åŠ›
è‡ªæˆ‘ä¿®ç‚¼ï¼Œå¢é•¿ 100 æˆ˜æ–—åŠ›
å¤šäººæ¸¸æˆï¼Œæ¶ˆè€— 500 æˆ˜æ–—åŠ›
```

```python
# -*- coding:utf-8 -*-

# #####################  å®šä¹‰å®ç°åŠŸèƒ½çš„ç±»  #####################

class Person:

    def __init__(self, na, gen, age, fig):
        self.name = na
        self.gender = gen
        self.age = age
        self.fight =fig

    def grassland(self):
        """æ³¨é‡Šï¼šè‰ä¸›æˆ˜æ–—ï¼Œæ¶ˆè€—200æˆ˜æ–—åŠ›"""

        self.fight = self.fight - 200

    def practice(self):
        """æ³¨é‡Šï¼šè‡ªæˆ‘ä¿®ç‚¼ï¼Œå¢é•¿100æˆ˜æ–—åŠ›"""

        self.fight = self.fight + 200

    def incest(self):
        """æ³¨é‡Šï¼šå¤šäººæ¸¸æˆï¼Œæ¶ˆè€—500æˆ˜æ–—åŠ›"""

        self.fight = self.fight - 500

    def detail(self):
        """æ³¨é‡Šï¼šå½“å‰å¯¹è±¡çš„è¯¦ç»†æƒ…å†µ"""

        temp = "å§“å:%s ; æ€§åˆ«:%s ; å¹´é¾„:%s ; æˆ˜æ–—åŠ›:%s"  % (self.name, self.gender, self.age, self.fight)
        print temp

# #####################  å¼€å§‹æ¸¸æˆ  #####################

cang = Person('è‹äº•äº•', 'å¥³', 18, 1000)    # åˆ›å»ºè‹äº•äº•è§’è‰²
dong = Person('ä¸œå°¼æœ¨æœ¨', 'ç”·', 20, 1800)  # åˆ›å»ºä¸œå°¼æœ¨æœ¨è§’è‰²
bo = Person('æ³¢å¤šå¤š', 'å¥³', 19, 2500)      # åˆ›å»ºæ³¢å¤šå¤šè§’è‰²

cang.incest() #è‹äº•ç©ºå‚åŠ ä¸€æ¬¡å¤šäººæ¸¸æˆ
dong.practice()# ä¸œå°¼æœ¨æœ¨è‡ªæˆ‘ä¿®ç‚¼äº†ä¸€æ¬¡
bo.grassland() #æ³¢å¤šå¤šå‚åŠ ä¸€æ¬¡è‰ä¸›æˆ˜æ–—

#è¾“å‡ºå½“å‰æ‰€æœ‰äººçš„è¯¦ç»†æƒ…å†µ
cang.detail()
dong.detail()
bo.detail()

cang.incest() #è‹äº•ç©ºåˆå‚åŠ ä¸€æ¬¡å¤šäººæ¸¸æˆ
dong.incest() #ä¸œå°¼æœ¨æœ¨ä¹Ÿå‚åŠ äº†ä¸€ä¸ªå¤šäººæ¸¸æˆ
bo.practice() #æ³¢å¤šå¤šè‡ªæˆ‘ä¿®ç‚¼äº†ä¸€æ¬¡

#è¾“å‡ºå½“å‰æ‰€æœ‰äººçš„è¯¦ç»†æƒ…å†µ
cang.detail()
dong.detail()
bo.detail()
```

#### ç»§æ‰¿

ç»§æ‰¿ï¼Œé¢å‘å¯¹è±¡ä¸­çš„ç»§æ‰¿å’Œç°å®ç”Ÿæ´»ä¸­çš„ç»§æ‰¿ç›¸åŒï¼Œå³ï¼šå­å¯ä»¥ç»§æ‰¿çˆ¶çš„å†…å®¹ã€‚

ä¾‹å¦‚ï¼š

çŒ«å¯ä»¥ï¼šå–µå–µå«ã€åƒã€å–ã€æ‹‰ã€æ’’

ç‹—å¯ä»¥ï¼šæ±ªæ±ªå«ã€åƒã€å–ã€æ‹‰ã€æ’’

å¦‚æœæˆ‘ä»¬è¦åˆ†åˆ«ä¸ºçŒ«å’Œç‹—åˆ›å»ºä¸€ä¸ªç±»ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸º çŒ« å’Œ ç‹— å®ç°ä»–ä»¬æ‰€æœ‰çš„åŠŸèƒ½ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```python
class çŒ«ï¼š

    def å–µå–µå« (self):
        print 'å–µå–µå«'

    def åƒ (self):
        # do something

    def å– (self):
        # do something

    def æ‹‰ (self):
        # do something

    def æ’’ (self):
        # do something

class ç‹—ï¼š

    def æ±ªæ±ªå« (self):
        print 'å–µå–µå«'

    def åƒ (self):
        # do something

    def å– (self):
        # do something

    def æ‹‰ (self):
        # do something

    def æ’’ (self):
        # do something
```

ä¸Šè¿°ä»£ç ä¸éš¾çœ‹å‡ºï¼Œåƒã€å–ã€æ‹‰ã€æ’’æ˜¯çŒ«å’Œç‹—éƒ½å…·æœ‰çš„åŠŸèƒ½ï¼Œè€Œæˆ‘ä»¬å´åˆ†åˆ«çš„çŒ«å’Œç‹—çš„ç±»ä¸­ç¼–å†™äº†ä¸¤æ¬¡ã€‚å¦‚æœä½¿ç”¨ ç»§æ‰¿ çš„æ€æƒ³ï¼Œå¦‚ä¸‹å®ç°ï¼š

åŠ¨ç‰©ï¼šåƒã€å–ã€æ‹‰ã€æ’’

çŒ«ï¼šå–µå–µå«ï¼ˆçŒ«ç»§æ‰¿åŠ¨ç‰©çš„åŠŸèƒ½ï¼‰

ç‹—ï¼šæ±ªæ±ªå«ï¼ˆç‹—ç»§æ‰¿åŠ¨ç‰©çš„åŠŸèƒ½ï¼‰

```python
class åŠ¨ç‰©:

    def åƒ (self):
        # do something

    def å– (self):
        # do something

    def æ‹‰ (self):
        # do something

    def æ’’ (self):
        # do something

# åœ¨ç±»åé¢æ‹¬å·ä¸­å†™å…¥å¦å¤–ä¸€ä¸ªç±»åï¼Œè¡¨ç¤ºå½“å‰ç±»ç»§æ‰¿å¦å¤–ä¸€ä¸ªç±»
class çŒ« (åŠ¨ç‰©)ï¼š

    def å–µå–µå« (self):
        print 'å–µå–µå«'

# åœ¨ç±»åé¢æ‹¬å·ä¸­å†™å…¥å¦å¤–ä¸€ä¸ªç±»åï¼Œè¡¨ç¤ºå½“å‰ç±»ç»§æ‰¿å¦å¤–ä¸€ä¸ªç±»
class ç‹— (åŠ¨ç‰©)ï¼š

    def æ±ªæ±ªå« (self):
        print 'å–µå–µå«'
```

```python
class Animal:

    def eat(self):
        print "%s åƒ " %self.name

    def drink(self):
        print "%s å– " %self.name

    def shit(self):
        print "%s æ‹‰ " %self.name

    def pee(self):
        print "%s æ’’ " %self.name

class Cat(Animal):

    def __init__(self, name):
        self.name = name
        self.breed ï¼ 'çŒ«'

    def cry(self):
        print 'å–µå–µå«'

class Dog(Animal):

    def __init__(self, name):
        self.name = name
        self.breed ï¼ 'ç‹—'

    def cry(self):
        print 'æ±ªæ±ªå«'

# ######### æ‰§è¡Œ #########

c1 = Cat('å°ç™½å®¶çš„å°é»‘çŒ«')
c1.eat()

c2 = Cat('å°é»‘çš„å°ç™½çŒ«')
c2.drink()

d1 = Dog('èƒ–å­å®¶çš„å°ç˜¦ç‹—')
d1.eat()
```

**æ‰€ä»¥ï¼Œå¯¹äºé¢å‘å¯¹è±¡çš„ç»§æ‰¿æ¥è¯´ï¼Œå…¶å®å°±æ˜¯å°†å¤šä¸ªç±»å…±æœ‰çš„æ–¹æ³•æå–åˆ°çˆ¶ç±»ä¸­ï¼Œå­ç±»ä»…éœ€ç»§æ‰¿çˆ¶ç±»è€Œä¸å¿…ä¸€ä¸€å®ç°æ¯ä¸ªæ–¹æ³•ã€‚**

- æ³¨ï¼šé™¤äº†å­ç±»å’Œçˆ¶ç±»çš„ç§°è°“ï¼Œä½ å¯èƒ½çœ‹åˆ°è¿‡ æ´¾ç”Ÿç±» å’Œ åŸºç±» ï¼Œä»–ä»¬ä¸å­ç±»å’Œçˆ¶ç±»åªæ˜¯å«æ³•ä¸åŒè€Œå·²ã€‚![20241229154732_M6gkWMir.webp](https://cdn.dong4j.site/source/image/20241229154732_M6gkWMir.webp)

å­¦ä¹ äº†ç»§æ‰¿çš„å†™æ³•ä¹‹åï¼Œæˆ‘ä»¬ç”¨ä»£ç æ¥æ˜¯ä¸Šè¿°é˜¿çŒ«é˜¿ç‹—çš„åŠŸèƒ½ï¼š

```python
class Animal:

    def eat(self):
        print "%s åƒ " %self.name

    def drink(self):
        print "%s å– " %self.name

    def shit(self):
        print "%s æ‹‰ " %self.name

    def pee(self):
        print "%s æ’’ " %self.name

class Cat(Animal):

    def __init__(self, name):
        self.name = name
        self.breed ï¼ 'çŒ«'

    def cry(self):
        print 'å–µå–µå«'

class Dog(Animal):

    def __init__(self, name):
        self.name = name
        self.breed ï¼ 'ç‹—'

    def cry(self):
        print 'æ±ªæ±ªå«'

# ######### æ‰§è¡Œ #########

c1 = Cat('å°ç™½å®¶çš„å°é»‘çŒ«')
c1.eat()

c2 = Cat('å°é»‘çš„å°ç™½çŒ«')
c2.drink()

d1 = Dog('èƒ–å­å®¶çš„å°ç˜¦ç‹—')
d1.eat()
```

**é‚£ä¹ˆé—®é¢˜åˆæ¥äº†ï¼Œå¤šç»§æ‰¿å‘¢ï¼Ÿ**

- æ˜¯å¦å¯ä»¥ç»§æ‰¿å¤šä¸ªç±»
- å¦‚æœç»§æ‰¿çš„å¤šä¸ªç±»æ¯ä¸ªç±»ä¸­éƒ½å®šäº†ç›¸åŒçš„å‡½æ•°ï¼Œé‚£ä¹ˆé‚£ä¸€ä¸ªä¼šè¢«ä½¿ç”¨å‘¢ï¼Ÿ

1ã€Python çš„ç±»å¯ä»¥ç»§æ‰¿å¤šä¸ªç±»ï¼ŒJava å’Œ C# ä¸­åˆ™åªèƒ½ç»§æ‰¿ä¸€ä¸ªç±»

2ã€Python çš„ç±»å¦‚æœç»§æ‰¿äº†å¤šä¸ªç±»ï¼Œé‚£ä¹ˆå…¶å¯»æ‰¾æ–¹æ³•çš„æ–¹å¼æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯ï¼š**æ·±åº¦ä¼˜å…ˆ** å’Œ **å¹¿åº¦ä¼˜å…ˆ ![20241229154732_C3em8waV.webp](https://cdn.dong4j.site/source/image/20241229154732_C3em8waV.webp)**

- å½“ç±»æ˜¯ç»å…¸ç±»æ—¶ï¼Œå¤šç»§æ‰¿æƒ…å†µä¸‹ï¼Œä¼šæŒ‰ç…§æ·±åº¦ä¼˜å…ˆæ–¹å¼æŸ¥æ‰¾
- å½“ç±»æ˜¯æ–°å¼ç±»æ—¶ï¼Œå¤šç»§æ‰¿æƒ…å†µä¸‹ï¼Œä¼šæŒ‰ç…§å¹¿åº¦ä¼˜å…ˆæ–¹å¼æŸ¥æ‰¾

ç»å…¸ç±»å’Œæ–°å¼ç±»ï¼Œä»å­—é¢ä¸Šå¯ä»¥çœ‹å‡ºä¸€ä¸ªè€ä¸€ä¸ªæ–°ï¼Œæ–°çš„å¿…ç„¶åŒ…å«äº†è·Ÿå¤šçš„åŠŸèƒ½ï¼Œä¹Ÿæ˜¯ä¹‹åæ¨èçš„å†™æ³•ï¼Œä»å†™æ³•ä¸ŠåŒºåˆ†çš„è¯ï¼Œå¦‚æœ**å½“å‰ç±»æˆ–è€…çˆ¶ç±»ç»§æ‰¿äº† object
ç±»**ï¼Œé‚£ä¹ˆè¯¥ç±»ä¾¿æ˜¯æ–°å¼ç±»ï¼Œå¦åˆ™ä¾¿æ˜¯ç»å…¸ç±»ã€‚![20241229154732_AOCRysi0.webp](https://cdn.dong4j.site/source/image/20241229154732_AOCRysi0.webp)

![20241229154732_L3hW7L54.webp](https://cdn.dong4j.site/source/image/20241229154732_L3hW7L54.webp)

```python
class D:

    def bar(self):
        print 'D.bar'

class C(D):

    def bar(self):
        print 'C.bar'

class B(D):

    def bar(self):
        print 'B.bar'

class A(B, C):

    def bar(self):
        print 'A.bar'

a = A()
# æ‰§è¡Œ bar æ–¹æ³•æ—¶
# é¦–å…ˆå» A ç±»ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœ A ç±»ä¸­æ²¡æœ‰ï¼Œåˆ™ç»§ç»­å» B ç±»ä¸­æ‰¾ï¼Œå¦‚æœ B ç±»ä¸­ä¹ˆæœ‰ï¼Œåˆ™ç»§ç»­å» D ç±»ä¸­æ‰¾ï¼Œå¦‚æœ D ç±»ä¸­ä¹ˆæœ‰ï¼Œåˆ™ç»§ç»­å» C ç±»ä¸­æ‰¾ï¼Œå¦‚æœè¿˜æ˜¯æœªæ‰¾åˆ°ï¼Œåˆ™æŠ¥é”™
# æ‰€ä»¥ï¼ŒæŸ¥æ‰¾é¡ºåºï¼šA --> B --> D --> C
# åœ¨ä¸Šè¿°æŸ¥æ‰¾ bar æ–¹æ³•çš„è¿‡ç¨‹ä¸­ï¼Œä¸€æ—¦æ‰¾åˆ°ï¼Œåˆ™å¯»æ‰¾è¿‡ç¨‹ç«‹å³ä¸­æ–­ï¼Œä¾¿ä¸ä¼šå†ç»§ç»­æ‰¾äº†
a.bar()
```

```python
class D(object):

    def bar(self):
        print 'D.bar'

class C(D):

    def bar(self):
        print 'C.bar'

class B(D):

    def bar(self):
        print 'B.bar'

class A(B, C):

    def bar(self):
        print 'A.bar'

a = A()
# æ‰§è¡Œ bar æ–¹æ³•æ—¶
# é¦–å…ˆå» A ç±»ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœ A ç±»ä¸­æ²¡æœ‰ï¼Œåˆ™ç»§ç»­å» B ç±»ä¸­æ‰¾ï¼Œå¦‚æœ B ç±»ä¸­ä¹ˆæœ‰ï¼Œåˆ™ç»§ç»­å» C ç±»ä¸­æ‰¾ï¼Œå¦‚æœ C ç±»ä¸­ä¹ˆæœ‰ï¼Œåˆ™ç»§ç»­å» D ç±»ä¸­æ‰¾ï¼Œå¦‚æœè¿˜æ˜¯æœªæ‰¾åˆ°ï¼Œåˆ™æŠ¥é”™
# æ‰€ä»¥ï¼ŒæŸ¥æ‰¾é¡ºåºï¼šA --> B --> C --> D
# åœ¨ä¸Šè¿°æŸ¥æ‰¾ bar æ–¹æ³•çš„è¿‡ç¨‹ä¸­ï¼Œä¸€æ—¦æ‰¾åˆ°ï¼Œåˆ™å¯»æ‰¾è¿‡ç¨‹ç«‹å³ä¸­æ–­ï¼Œä¾¿ä¸ä¼šå†ç»§ç»­æ‰¾äº†
a.bar()
```

ç»å…¸ç±»ï¼šé¦–å…ˆå» **A** ç±»ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœ A ç±»ä¸­æ²¡æœ‰ï¼Œåˆ™ç»§ç»­å» **B** ç±»ä¸­æ‰¾ï¼Œå¦‚æœ B ç±»ä¸­ä¹ˆæœ‰ï¼Œåˆ™ç»§ç»­å» **D** ç±»ä¸­æ‰¾ï¼Œå¦‚æœ D ç±»ä¸­ä¹ˆæœ‰ï¼Œåˆ™ç»§ç»­å» **C**
ç±»ä¸­æ‰¾ï¼Œå¦‚æœè¿˜æ˜¯æœªæ‰¾åˆ°ï¼Œåˆ™æŠ¥é”™

æ–°å¼ç±»ï¼šé¦–å…ˆå» **A** ç±»ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœ A ç±»ä¸­æ²¡æœ‰ï¼Œåˆ™ç»§ç»­å» **B** ç±»ä¸­æ‰¾ï¼Œå¦‚æœ B ç±»ä¸­ä¹ˆæœ‰ï¼Œåˆ™ç»§ç»­å» **C** ç±»ä¸­æ‰¾ï¼Œå¦‚æœ C ç±»ä¸­ä¹ˆæœ‰ï¼Œåˆ™ç»§ç»­å» **D**
ç±»ä¸­æ‰¾ï¼Œå¦‚æœè¿˜æ˜¯æœªæ‰¾åˆ°ï¼Œåˆ™æŠ¥é”™

æ³¨æ„ï¼šåœ¨ä¸Šè¿°æŸ¥æ‰¾è¿‡ç¨‹ä¸­ï¼Œä¸€æ—¦æ‰¾åˆ°ï¼Œåˆ™å¯»æ‰¾è¿‡ç¨‹ç«‹å³ä¸­æ–­ï¼Œä¾¿ä¸ä¼šå†ç»§ç»­æ‰¾äº†

#### å¤šæ€

Pyhon ä¸æ”¯æŒå¤šæ€å¹¶ä¸”ä¹Ÿç”¨ä¸åˆ°å¤šæ€ï¼Œå¤šæ€çš„æ¦‚å¿µæ˜¯åº”ç”¨äº Java å’Œ C# è¿™ä¸€ç±»å¼ºç±»å‹è¯­è¨€ä¸­ï¼Œè€Œ Python å´‡å°šâ€œé¸­å­ç±»å‹â€ã€‚

```python
class F1:
    pass

class S1(F1):

    def show(self):
        print 'S1.show'

class S2(F1):

    def show(self):
        print 'S2.show'

# ç”±äºåœ¨ Java æˆ– C# ä¸­å®šä¹‰å‡½æ•°å‚æ•°æ—¶ï¼Œå¿…é¡»æŒ‡å®šå‚æ•°çš„ç±»å‹
# ä¸ºäº†è®© Func å‡½æ•°æ—¢å¯ä»¥æ‰§è¡Œ S1 å¯¹è±¡çš„ show æ–¹æ³•ï¼Œåˆå¯ä»¥æ‰§è¡Œ S2 å¯¹è±¡çš„ show æ–¹æ³•ï¼Œæ‰€ä»¥ï¼Œå®šä¹‰äº†ä¸€ä¸ª S1 å’Œ S2 ç±»çš„çˆ¶ç±»
# è€Œå®é™…ä¼ å…¥çš„å‚æ•°æ˜¯ï¼šS1 å¯¹è±¡å’Œ S2 å¯¹è±¡

def Func(F1 obj):
    """Funcå‡½æ•°éœ€è¦æ¥æ”¶ä¸€ä¸ªF1ç±»å‹æˆ–è€…F1å­ç±»çš„ç±»å‹"""

    print obj.show()

s1_obj = S1()
Func(s1_obj) # åœ¨ Func å‡½æ•°ä¸­ä¼ å…¥ S1 ç±»çš„å¯¹è±¡ s1_objï¼Œæ‰§è¡Œ S1 çš„ show æ–¹æ³•ï¼Œç»“æœï¼šS1.show

s2_obj = S2()
Func(s2_obj) # åœ¨ Func å‡½æ•°ä¸­ä¼ å…¥ Ss ç±»çš„å¯¹è±¡ ss_objï¼Œæ‰§è¡Œ Ss çš„ show æ–¹æ³•ï¼Œç»“æœï¼šS2.show
```

```python
class F1:
    pass

class S1(F1):

    def show(self):
        print 'S1.show'

class S2(F1):

    def show(self):
        print 'S2.show'

def Func(obj):
    print obj.show()

s1_obj = S1()
Func(s1_obj)

s2_obj = S2()
Func(s2_obj)
```

## æ€»ç»“

ä»¥ä¸Šå°±æ˜¯æœ¬èŠ‚å¯¹äºé¢å‘å¯¹è±¡åˆçº§çŸ¥è¯†çš„ä»‹ç»ï¼Œæ€»ç»“å¦‚ä¸‹ï¼š

- é¢å‘å¯¹è±¡æ˜¯ä¸€ç§ç¼–ç¨‹æ–¹å¼ï¼Œæ­¤ç¼–ç¨‹æ–¹å¼çš„å®ç°æ˜¯åŸºäºå¯¹** ç±» **å’Œ** å¯¹è±¡ **çš„ä½¿ç”¨
- ç±» æ˜¯ä¸€ä¸ªæ¨¡æ¿ï¼Œæ¨¡æ¿ä¸­åŒ…è£…äº†å¤šä¸ªâ€œå‡½æ•°â€ä¾›ä½¿ç”¨
- å¯¹è±¡ï¼Œæ ¹æ®æ¨¡æ¿åˆ›å»ºçš„å®ä¾‹ï¼ˆå³ï¼šå¯¹è±¡ï¼‰ï¼Œå®ä¾‹ç”¨äºè°ƒç”¨è¢«åŒ…è£…åœ¨ç±»ä¸­çš„å‡½æ•°
- é¢å‘å¯¹è±¡ä¸‰å¤§ç‰¹æ€§ï¼šå°è£…ã€ç»§æ‰¿å’Œå¤šæ€

**é—®ç­”ä¸“åŒº**

### é—®é¢˜ä¸€ï¼šä»€ä¹ˆæ ·çš„ä»£ç æ‰æ˜¯é¢å‘å¯¹è±¡

- ç­”ï¼šä»ç®€å•æ¥è¯´ï¼Œå¦‚æœç¨‹åºä¸­çš„æ‰€æœ‰åŠŸèƒ½éƒ½æ˜¯ç”¨ ç±» å’Œ å¯¹è±¡ æ¥å®ç°ï¼Œé‚£ä¹ˆå°±æ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹äº†ã€‚

### é—®é¢˜äºŒï¼šå‡½æ•°å¼ç¼–ç¨‹ å’Œ é¢å‘å¯¹è±¡ å¦‚ä½•é€‰æ‹©ï¼Ÿåˆ†åˆ«åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨ï¼Ÿ

- ç­”ï¼šé¡»çŸ¥ï¼šå¯¹äº C# å’Œ Java ç¨‹åºå‘˜æ¥è¯´ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºè¯¥ä¸¤é—¨è¯­è¨€åªæ”¯æŒé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼ˆä¸æ”¯æŒå‡½æ•°å¼ç¼–ç¨‹ï¼‰ã€‚è€Œå¯¹äº Python å’Œ PHP
  ç­‰è¯­è¨€å´åŒæ—¶æ”¯æŒä¸¤ç§ç¼–ç¨‹æ–¹å¼ï¼Œä¸”å‡½æ•°å¼ç¼–ç¨‹èƒ½å®Œæˆçš„æ“ä½œï¼Œé¢å‘å¯¹è±¡éƒ½å¯ä»¥å®ç°ï¼›è€Œé¢å‘å¯¹è±¡çš„èƒ½å®Œæˆçš„æ“ä½œï¼Œå‡½æ•°å¼ç¼–ç¨‹ä¸è¡Œï¼ˆå‡½æ•°å¼ç¼–ç¨‹æ— æ³•å®ç°é¢å‘å¯¹è±¡çš„å°è£…åŠŸèƒ½ï¼‰ã€‚

- æ‰€ä»¥ï¼Œä¸€èˆ¬åœ¨ Python å¼€å‘ä¸­ï¼Œ**å…¨éƒ¨ä½¿ç”¨é¢å‘å¯¹è±¡**æˆ–**é¢å‘å¯¹è±¡å’Œå‡½æ•°å¼æ··åˆä½¿ç”¨**

- é¢å‘å¯¹è±¡çš„åº”ç”¨åœºæ™¯:

1. **å¤šå‡½æ•°éœ€ä½¿ç”¨å…±åŒçš„å€¼ï¼Œå¦‚ï¼šæ•°æ®åº“çš„å¢ã€åˆ ã€æ”¹ã€æŸ¥æ“ä½œéƒ½éœ€è¦è¿æ¥æ•°æ®åº“å­—ç¬¦ä¸²ã€ä¸»æœºåã€ç”¨æˆ·åå’Œå¯†ç  **

````python
class SqlHelper:

  def __init__(self, host, user, pwd):

      self.host = host
      self.user = user
      self.pwd = pwd

  def å¢ (self):
      # ä½¿ç”¨ä¸»æœºåã€ç”¨æˆ·åã€å¯†ç ï¼ˆself.host ã€self.user ã€self.pwdï¼‰æ‰“å¼€æ•°æ®åº“è¿æ¥
      # do something
      # å…³é—­æ•°æ®åº“è¿æ¥

  def åˆ  (self):
      # ä½¿ç”¨ä¸»æœºåã€ç”¨æˆ·åã€å¯†ç ï¼ˆself.host ã€self.user ã€self.pwdï¼‰æ‰“å¼€æ•°æ®åº“è¿æ¥
      # do something
      # å…³é—­æ•°æ®åº“è¿æ¥

  def æ”¹ (self):
      # ä½¿ç”¨ä¸»æœºåã€ç”¨æˆ·åã€å¯†ç ï¼ˆself.host ã€self.user ã€self.pwdï¼‰æ‰“å¼€æ•°æ®åº“è¿æ¥
      # do something
      # å…³é—­æ•°æ®åº“è¿æ¥

  def æŸ¥ (self):
  # ä½¿ç”¨ä¸»æœºåã€ç”¨æˆ·åã€å¯†ç ï¼ˆself.host ã€self.user ã€self.pwdï¼‰æ‰“å¼€æ•°æ®åº“è¿æ¥
      # do something
      # å…³é—­æ•°æ®åº“è¿æ¥# do something
  ```

2. * éœ€è¦åˆ›å»ºå¤šä¸ªäº‹ç‰©ï¼Œæ¯ä¸ªäº‹ç‰©å±æ€§ä¸ªæ•°ç›¸åŒï¼Œä½†æ˜¯å€¼çš„éœ€æ±‚ *
  **å¦‚ï¼šå¼ ä¸‰ã€æå››ã€æ¨äº”ï¼Œä»–ä»¬éƒ½æœ‰å§“åã€å¹´é¾„ã€è¡€å‹ï¼Œä½†å…¶éƒ½æ˜¯ä¸ç›¸åŒã€‚å³ï¼šå±æ€§ä¸ªæ•°ç›¸åŒï¼Œä½†å€¼ä¸ç›¸åŒ**

```python
 class Person:

  def __init__(self, name ,age ,blood_type):

      self.name = name
      self.age = age
      self.blood_type = blood_type

  def detail(self):
      temp = "i am %s, age %s , blood type %s " % (self.name, self.age, self.blood_type)
      print temp

zhangsan = Person('å¼ ä¸‰', 18, 'A')
lisi = Person('æå››', 73, 'AB')
yangwu = Person('æ¨äº”', 84, 'A')
````

### é—®é¢˜ä¸‰ï¼šç±»å’Œå¯¹è±¡åœ¨å†…å­˜ä¸­æ˜¯å¦‚ä½•ä¿å­˜ï¼Ÿ

ç­”ï¼š_ ç±»ä»¥åŠç±»ä¸­çš„æ–¹æ³•åœ¨å†…å­˜ä¸­åªæœ‰ä¸€ä»½ï¼Œè€Œæ ¹æ®ç±»åˆ›å»ºçš„æ¯ä¸€ä¸ªå¯¹è±¡éƒ½åœ¨å†…å­˜ä¸­éœ€è¦å­˜ä¸€ä»½ï¼Œå¤§è‡´å¦‚ä¸‹å›¾ï¼š_

![20241229154732_UvmyvrBy.webp](https://cdn.dong4j.site/source/image/20241229154732_UvmyvrBy.webp)

- å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ ¹æ®ç±»åˆ›å»ºå¯¹è±¡æ—¶ï¼Œå¯¹è±¡ä¸­é™¤äº†å°è£… name å’Œ age çš„å€¼ä¹‹å¤–ï¼Œè¿˜ä¼šä¿å­˜ä¸€ä¸ª **ç±»å¯¹è±¡æŒ‡é’ˆ **ï¼Œè¯¥å€¼æŒ‡å‘å½“å‰å¯¹è±¡çš„ç±»ã€‚

- å½“é€šè¿‡ obj1 æ‰§è¡Œ ã€æ–¹æ³•ä¸€ã€‘ æ—¶ï¼Œè¿‡ç¨‹å¦‚ä¸‹

1. æ ¹æ®å½“å‰å¯¹è±¡ä¸­çš„ ç±»å¯¹è±¡æŒ‡é’ˆ æ‰¾åˆ°ç±»ä¸­çš„æ–¹æ³•
2. å°†å¯¹è±¡ obj1 å½“ä½œå‚æ•°ä¼ ç»™ æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•° self

## [æ—¥å¿—è¿½è¸ªç³»ç»Ÿè®¾è®¡ï¼šæ„å»ºé«˜æ•ˆç›‘æ§ç³»ç»Ÿ](https://blog.dong4j.site/posts/747eedc9.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

ä¸€ä¸ªåŸºäº dubbo filter çš„æ—¥å¿—è¿½æº¯ç³»ç»Ÿè®¾è®¡

## è§£å†³çš„é—®é¢˜

1. äº†è§£çº¿ä¸Šç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€
2. å¿«é€Ÿå‡†ç¡®å®šä½çº¿ä¸Šé—®é¢˜
3. å‘ç°ç³»ç»Ÿç“¶é¢ˆ
4. é¢„è­¦ç³»ç»Ÿæ½œåœ¨é£é™©
5. æŒ–æ˜äº§å“æœ€å¤§ä»·å€¼

## æ—¥å¿—çš„åˆ†ç±»

1. è¯Šæ–­æ—¥å¿—ï¼Œ å…¸å‹çš„æœ‰ï¼š
   - è¯·æ±‚å…¥å£å’Œå‡ºå£
   - å¤–éƒ¨æœåŠ¡è°ƒç”¨å’Œè¿”å›
   - èµ„æºæ¶ˆè€—æ“ä½œ: å¦‚è¯»å†™æ–‡ä»¶ç­‰
   - å®¹é”™è¡Œä¸ºï¼š å¦‚äº‘ç¡¬ç›˜çš„å‰¯æœ¬ä¿®å¤æ“ä½œ
   - ç¨‹åºå¼‚å¸¸ï¼š å¦‚æ•°æ®åº“æ— æ³•è¿æ¥
   - åå°æ“ä½œï¼šå®šæœŸæ‰§è¡Œåˆ é™¤çš„çº¿ç¨‹
   - å¯åŠ¨ã€å…³é—­ã€é…ç½®åŠ è½½
2. ç»Ÿè®¡æ—¥å¿—ï¼š
   - ç”¨æˆ·è®¿é—®ç»Ÿè®¡ï¼šç”¨æˆ· IPã€ä¸Šä¼ ä¸‹è½½çš„æ•°æ®é‡ï¼Œè¯·æ±‚è€—æ—¶ç­‰
   - è®¡è´¹æ—¥å¿—ï¼ˆå¦‚è®°å½•ç”¨æˆ·ä½¿ç”¨çš„ç½‘ç»œèµ„æºæˆ–ç£ç›˜å ç”¨ï¼Œæ ¼å¼è¾ƒä¸ºä¸¥æ ¼ï¼Œä¾¿äºç»Ÿè®¡ï¼‰
3. å®¡è®¡æ—¥å¿—ï¼š
   - ç®¡ç†æ“ä½œ
     å¯¹äºç®€å•çš„ç³»ç»Ÿï¼Œå¯ä»¥å°†æ‰€æœ‰çš„æ—¥å¿—è¾“å‡ºåˆ°åŒä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ä¸­ï¼Œå¹¶é€šè¿‡ä¸åŒçš„å…³é”®å­—è¿›è¡ŒåŒºåˆ†ã€‚è€Œå¯¹äºå¤æ‚çš„ç³»ç»Ÿï¼Œå°†ä¸åŒéœ€æ±‚çš„æ—¥å¿—è¾“å‡ºåˆ°ä¸åŒçš„æ—¥å¿—æ–‡ä»¶ä¸­æ˜¯å¿…è¦çš„ï¼Œé€šè¿‡å¯¹ä¸åŒç±»å‹çš„æ–‡ä»¶é‡‡ç”¨ä¸åŒçš„æ—¥å¿—æ ¼å¼
4. **ä¸šåŠ¡æ—¥å¿— **

## åˆ†å¸ƒå¼æ—¥å¿—ç³»ç»Ÿçš„è®¾è®¡

![20241229154732_awHDAlCW.webp](https://cdn.dong4j.site/source/image/20241229154732_awHDAlCW.webp)

### æ—¥å¿—é‡‡é›†å™¨

è´Ÿè´£æŠŠä¸šåŠ¡ç³»ç»Ÿçš„æ–¹æ³•è°ƒç”¨æ ˆå’Œè¿œç¨‹æœåŠ¡è°ƒç”¨ä¿¡æ¯ä»ä¸šåŠ¡ç³»ç»Ÿä¸­ä¼ é€’ç»™å¤„ç†å™¨

å®ç°æ–¹å¼æœ‰:

1. åº”ç”¨å±‚ç¼–å†™ä»£ç ä¸»åŠ¨æ¨é€
2. AOP æ‹¦æˆª
3. JavaAgent å­—èŠ‚ç å¢å¼º

**é—®é¢˜:**
è¿™é‡Œæ¨é€ç»™é‡‡é›†å™¨çš„æ—¥å¿—æ˜¯ç»Ÿä¸€æ ¼å¼çš„æ—¥å¿—, å¹¶éæˆ‘ä»¬è‡ªå·±å†™çš„ log è¾“å‡º, è‡ªå·±å†™çš„ log è¾“å‡ºå¯ä»¥é€šè¿‡ appender è¾“å‡ºç»™ logstash.

#### ç”Ÿæˆè°ƒç”¨é“¾ ID

ä¸€ä¸ªç³»ç»Ÿé€šå¸¸é€šè¿‡ traceId æ¥å¯¹è¯·æ±‚è¿›è¡Œå”¯ä¸€çš„æ ‡è®°ï¼Œç›®çš„æ˜¯å¯ä»¥é€šè¿‡ traceId å°†ä¸€ä¸ªè¯·æ±‚åœ¨ç³»ç»Ÿä¸­çš„æ‰§è¡Œè¿‡ç¨‹ä¸²è”èµ·æ¥ã€‚è¯¥ traceId
é€šå¸¸ä¼šéšç€å“åº”è¿”å›ç»™è°ƒç”¨è€…ï¼Œå¦‚æœè°ƒç”¨å‡ºç°é—®é¢˜ï¼Œè°ƒç”¨è€…ä¹Ÿå¯ä»¥é€šè¿‡æä¾› traceId å¸®åŠ©æœåŠ¡æä¾›è€…å®šä½é—®é¢˜ã€‚

![20241229154732_abCFALVC.webp](https://cdn.dong4j.site/source/image/20241229154732_abCFALVC.webp)

#### ä¼ é€’è°ƒç”¨é“¾ä¿¡æ¯

å‰é¢ç”Ÿæˆçš„ traceId ä¼ é€’åˆ°ä¸‹ä¸€çº§è°ƒç”¨, ä»è€Œå°†è°ƒç”¨ä¿¡æ¯å…³è”èµ·æ¥.

è¿™é‡Œåˆ†ä¸º 5 ç§ä¼ é€’æ–¹å¼:

1. Java è¿›ç¨‹å†…ä¼ é€’
2. æœåŠ¡é—´ä¼ é€’
3. ä¸»å­çº¿ç¨‹é—´ä¼ é€’
4. æ¶ˆæ¯é˜Ÿåˆ—çš„ä¼ é€’
5. ç¼“å­˜, æ•°æ®åº“è®¿é—®

![20241229154732_sqTtlpKe.webp](https://cdn.dong4j.site/source/image/20241229154732_sqTtlpKe.webp)

##### Java è¿›ç¨‹å†…ä¼ é€’

åœ¨ Java åº”ç”¨ç³»ç»Ÿä¸­, é€šè¿‡ ThreadLocal æ¥ä¼ é€’ TraceId å’Œ spanId

![20241229154732_1PA0DAtk.webp](https://cdn.dong4j.site/source/image/20241229154732_1PA0DAtk.webp)

##### æœåŠ¡é—´ä¼ é€’

åœ¨æœåŠ¡é—´é€šè¿‡ RPC ä¼ é€’

ä½¿ç”¨ com.alibaba.dubbo.rpc.RpcInvocation çš„ setAttachment å’Œ getAttachment æ¥è®¾ç½®å’Œè·å–è‡ªå®šä¹‰ä¸Šä¸‹æ–‡æ•°æ®

![20241229154732_1Xucebl3.webp](https://cdn.dong4j.site/source/image/20241229154732_1Xucebl3.webp)

##### ä¸»å­çº¿ç¨‹é—´ä¼ é€’

å°†ä¸€äº›è€—æ—¶æˆ–è€…éæ ¸å¿ƒä¸šåŠ¡é€šè¿‡å¼‚æ­¥çº¿ç¨‹å¤„ç†, å¦‚æœè¦è·Ÿè¸ªè¿™éƒ¨åˆ†è°ƒç”¨é“¾, åˆ™éœ€è¦åœ¨åˆ›å»ºå­çº¿ç¨‹æ—¶, å°† traceId å’Œ spanId ä¸€èµ·ä¼ é€’è¿‡å», å¹¶æ”¾åœ¨å­çº¿ç¨‹çš„
ThreadLocal ä¸­.

##### æ¶ˆæ¯é˜Ÿåˆ—çš„ä¼ é€’

å¯¹ kafka æ¶ˆæ¯é˜Ÿåˆ—çš„è·Ÿè¸ª

1. å‘é€æ¶ˆæ¯æ—¶, æ‰‹å·¥æ·»åŠ  traceId å’Œ spanId
2. ä¿®æ”¹ kafka æºç , åœ¨æ¯æ¬¡å‘é€æ¶ˆæ¯æ—¶, å°† traceId å’Œ spanId å¢åŠ åˆ°æ¶ˆæ¯æŠ¥æ–‡ä¸­, åœ¨æ¶ˆæ¯é˜Ÿåˆ—çš„å¤„ç†ç«¯çš„åº“ä¸­å…ˆè§£ææŠ¥æ–‡, å†è®²ä¸šåŠ¡æŠ¥æ–‡ä¼ é€’ç»™ä¸šåŠ¡å±‚å¤„ç†.

##### ç¼“å­˜, æ•°æ®åº“è®¿é—®

å°è£…ç¼“å­˜, æ•°æ®åº“çš„å®¢æˆ·ç«¯, å°† traceId å’Œ spanId ä¸è®¿é—®çš„æ•°æ®è¿›è¡Œå…³è”

#### é‡‡é›†ç‡è®¾ç½®

å› ä¸º QPS è¶Šé«˜ï¼Œéœ€è¦ç”Ÿæˆçš„è°ƒç”¨æ—¥å¿—ä¹Ÿå°±è¶Šé«˜ã€‚å› æ­¤ï¼Œä¸ºäº†é™ä½æ•´ä½“çš„è¾“å‡ºæ•°æ®é‡ï¼Œæ ¹æ® traceId ä¸­çš„é¡ºåºæ•°è¿›è¡Œé‡‡æ ·ï¼Œæä¾›äº†å¤šç§é‡‡æ ·ç­–ç•¥æ­é…ï¼š

- 100% é‡‡æ ·ï¼šå®ƒä¼šå¯¹ä¸šåŠ¡å¸¦æ¥å½±å“ï¼Œå› æ­¤æœ€å¥½å†…ç½®æ”¯æŒå®¢æˆ·ç«¯è‡ªåŠ¨é™çº§ï¼›
- å›ºå®šé˜ˆå€¼é‡‡æ ·ï¼šå…¨å±€æˆ–ç§Ÿæˆ·å†…ç»Ÿä¸€æ§åˆ¶ï¼›
- é™é€Ÿé‡‡æ ·ï¼šåœ¨å…¥å£å¤„æŒ‰å›ºå®šé¢‘ç‡é‡‡æ ·è‹¥å¹²æ¡è°ƒç”¨é“¾ï¼›
- å¼‚å¸¸ä¼˜å…ˆé‡‡æ ·ï¼šè°ƒç”¨å‡ºé”™æ—¶ä¼˜å…ˆé‡‡æ ·ï¼›
- ä¸ªæ€§åŒ–é‡‡æ ·ï¼šæŒ‰ç”¨æˆ· IDã€å…¥å£ IPã€åº”ç”¨ã€è°ƒç”¨é“¾å…¥å£ã€ä¸šåŠ¡æ ‡è¯†ç­‰é…ç½®å¼€å¯é‡‡æ ·ã€‚

é€šè¿‡ä¸Šé¢è¿™äº”ç§é‡‡æ ·ç­–ç•¥çš„æ­é…ä½¿ç”¨ï¼Œå¯ä»¥çµæ´»åœ°æ§åˆ¶è°ƒç”¨é“¾ä¸Šæ•°æ®çš„è¾“å‡ºï¼Œç¡®ä¿æ•°æ®é‡ä¸ä¼šè¿‡å¤§ã€‚

### æ—¥å¿—å¤„ç†å™¨

è´Ÿè´£ä»ä¸šåŠ¡ç³»ç»Ÿçš„é‡‡é›†å™¨ä¸­æ¥æ”¶æœåŠ¡è°ƒç”¨ä¿¡æ¯å¹¶èšåˆè°ƒç”¨é“¾, å°†å…¶å­˜å‚¨åœ¨åˆ†å¸ƒå¼æ•°æ®å­˜å‚¨ä¸­, ä»¥åŠå¯¹è°ƒç”¨é“¾è¿›è¡Œåˆ†æ, å¹¶è¾“å‡ºç»™ç›‘æ§å’ŒæŠ¥è­¦ç³»ç»Ÿ.

èšåˆè°ƒç”¨é“¾ä¿¡æ¯, ä»ä¸­å‘ç°è°ƒç”¨çš„é—®é¢˜, å¦‚:

1. æŠ›å‡ºå¼‚å¸¸
2. è°ƒç”¨è¶…æ—¶
3. ç»Ÿè®¡è°ƒç”¨æ¬¡æ•°ç­‰
4. å‘é€æŠ¥è­¦çŸ­ä¿¡, é‚®ä»¶, å¾®ä¿¡ä¿¡æ¯ç­‰

### æ—¥å¿—å­˜å‚¨å’Œæœç´¢

å­˜å‚¨æµ·é‡çš„è°ƒç”¨é“¾æ•°æ®, å¹¶æ”¯æŒçµæ´»çš„æŸ¥è¯¢å’Œæœç´¢åŠŸèƒ½

#### å…³è”ä¸šåŠ¡ Id

åœ¨ä¸šåŠ¡æ—¥å¿—ä¸­è®°å½• traceIdã€ä¸šåŠ¡äº‹ä»¶ id ç­‰ä¿¡æ¯ï¼Œä»è€Œå»ºç«‹è°ƒç”¨é“¾ä¸ä¸šåŠ¡äº‹ä»¶æ—¥å¿—çš„å…³è”, é€šè¿‡ä¸šåŠ¡ Id åæŸ¥ traceId,
è·å–æ›´å¤šçš„ä¸Šä¸‹æ–‡ä¿¡æ¯

ä¸€ä¸ªå…‘å§è®¢å•ï¼ˆorder_234325123124ï¼‰å‘ç°å­˜åœ¨é—®é¢˜, æˆ‘ä»¬å¯ä»¥æ ¹æ®è®¢å•å·æŸ¥åˆ°ä¸ä¹‹ç»‘å®šçš„ traceId, æ ¹æ® traceId ä¸ä»…å¯ä»¥æŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨çš„äº‹ä»¶,
è¿˜å¯ä»¥çœ‹åˆ°ä¸ä¸šåŠ¡ç›¸å…³çš„äº‹ä»¶, å¦‚ç”¨æˆ·ç§¯åˆ†æƒ…å†µç­‰ï¼Œä¹Ÿå°±æ˜¯è¯´æ ¹æ®ä¸šåŠ¡ Id å¯ä»¥åœ¨è°ƒç”¨é“¾ä¸ŠæŸ¥çœ‹å…‘å§å•†å“, ç”¨æˆ·ç§¯åˆ†ä»¥åŠæ‰£é™¤ç§¯åˆ†ç­‰ä¿¡æ¯ï¼Œå¤§å¤§æå‡é”™è¯¯æ’æŸ¥é€Ÿåº¦ã€‚

### æ—¥å¿—å±•ç¤ºç³»ç»Ÿ

æ”¯æŒæŸ¥è¯¢è°ƒç”¨é“¾, ä¸šåŠ¡é“¾ç­‰åŠŸèƒ½

ä¸ºäº†æ›´ç›´è§‚çš„æŸ¥çœ‹è°ƒç”¨é“¾ä¿¡æ¯, éœ€è¦ä¸€ä¸ªå‰ç«¯å±•ç¤ºé¡µé¢

### ç›‘æ§å’ŒæŠ¥è­¦

é€šè¿‡å®šæ—¶çš„åœ¨æ—¥å¿—å­˜å‚¨å’Œæœç´¢ç³»ç»Ÿä¸­æŸ¥æ‰¾æœåŠ¡å’ŒæŸä¸€æ ‡å‡†çš„æ•°æ®æŒ‡æ ‡, ç„¶åä¸è®¾ç½®çš„é˜ˆå€¼å¯¹æ¯”, å¦‚æœè¶…å‡ºé˜ˆå€¼, åˆ™é€šè¿‡çŸ­ä¿¡, é‚®ä»¶æˆ–å¾®ä¿¡æ¥æŠ¥è­¦

## æ—¥å¿—ç³»ç»Ÿä¼˜åŒ–å’Œæœ€ä½³å®è·µ

1. æ‰“å°æ—¥å¿—çš„æœ€ä½³æ—¶æœº
2. æ—¥å¿—çº§åˆ«è®¾ç½®
3. æ—¥å¿—çš„æ•°é‡å’Œå¤§å°
4. æ—¥å¿—çš„åˆ‡å‰²æ–¹å¼
5. æ—¥å¿—æ ¼å¼è®¾ç½®

### æ—¥å¿—çº§åˆ«è®¾ç½®

- QA ç¯å¢ƒä½¿ç”¨ debug åŠä»¥ä¸‹çº§åˆ«æ—¥å¿—
- åˆšåˆšä¸Šçº¿çš„å¼•ç”¨è¿˜æ²¡åˆ°ç¨³å®šæœŸ, ä½¿ç”¨ debug çº§åˆ«çš„æ—¥å¿—
- ä¸Šçº¿ç¨³å®šåä½¿ç”¨ info çº§åˆ«çš„æ—¥å¿—
- å¸¸å¹´ç¨³å®šä¸å‡ºé—®é¢˜çš„åº”ç”¨ä½¿ç”¨ error çº§åˆ«çš„æ—¥å¿—
- é€‰æ‹©ä¸€å°æœºå™¨å¼€å¯ DEBUG çº§åˆ«çš„æ—¥å¿—, åœ¨çº¿ä¸Šä»»ä½•é—®é¢˜çš„æ—¶å€™ï¼Œéƒ½å¯ä»¥é€šè¿‡æ—¥å¿—æœ€å¿«çš„æ‰¾åˆ°é—®é¢˜çš„æ ¹æºã€‚

#### æ—¥å¿—çº§åˆ«çš„ä½¿ç”¨

å¯¹äºæ—¥å¿—çº§åˆ«çš„åˆ†ç±»ï¼Œæœ‰ä»¥ä¸‹å‚è€ƒï¼š

- **FATAL**
  è¡¨ç¤ºéœ€è¦ç«‹å³è¢«å¤„ç†çš„ç³»ç»Ÿçº§é”™è¯¯ã€‚å½“è¯¥é”™è¯¯å‘ç”Ÿæ—¶ï¼Œè¡¨ç¤ºæœåŠ¡å·²ç»å‡ºç°äº†æŸç§ç¨‹åº¦çš„ä¸å¯ç”¨ï¼Œç³»ç»Ÿç®¡ç†å‘˜éœ€è¦ç«‹å³ä»‹å…¥ã€‚è¿™å±äºæœ€ä¸¥é‡çš„æ—¥å¿—çº§åˆ«ï¼Œå› æ­¤è¯¥æ—¥å¿—çº§åˆ«å¿…é¡»æ…ç”¨ï¼Œå¦‚æœè¿™ç§çº§åˆ«çš„æ—¥å¿—ç»å¸¸å‡ºç°ï¼Œåˆ™è¯¥æ—¥å¿—ä¹Ÿå¤±å»äº†æ„ä¹‰ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œ**
  ä¸€ä¸ªè¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¸­åº”è¯¥åªè®°å½•ä¸€æ¬¡ FATAL çº§åˆ«çš„æ—¥å¿—ï¼Œå³è¯¥è¿›ç¨‹é‡åˆ°æ— æ³•æ¢å¤çš„é”™è¯¯è€Œé€€å‡ºæ—¶ **ã€‚å½“ç„¶ï¼Œå¦‚æœæŸä¸ªç³»ç»Ÿçš„å­ç³»ç»Ÿé‡åˆ°äº†ä¸å¯æ¢å¤çš„é”™è¯¯ï¼Œé‚£è¯¥å­ç³»ç»Ÿçš„è°ƒç”¨æ–¹ä¹Ÿå¯ä»¥è®°å…¥
  FATAL çº§åˆ«æ—¥å¿—ï¼Œä»¥ä¾¿é€šè¿‡æ—¥å¿—æŠ¥è­¦æé†’ç³»ç»Ÿç®¡ç†å‘˜ä¿®å¤ï¼›
- **ERROR**

  è¯¥çº§åˆ«çš„é”™è¯¯ä¹Ÿéœ€è¦é©¬ä¸Šè¢«å¤„ç†ï¼Œä½†æ˜¯ç´§æ€¥ç¨‹åº¦è¦ä½äº FATAL çº§åˆ«ã€‚å½“ ERROR é”™è¯¯å‘ç”Ÿæ—¶ï¼Œå·²ç»å½±å“äº†ç”¨æˆ·çš„æ­£å¸¸è®¿é—®ã€‚ä»è¯¥æ„ä¹‰ä¸Šæ¥è¯´ï¼Œå®é™…ä¸Š ERROR é”™è¯¯å’Œ
  FATAL é”™è¯¯å¯¹ç”¨æˆ·çš„å½±å“æ˜¯ç›¸å½“çš„ã€‚FATAL ç›¸å½“äºæœåŠ¡å·²ç»æŒ‚äº†ï¼Œè€Œ ERROR ç›¸å½“äºå¥½æ­»ä¸å¦‚èµ–æ´»ç€ï¼Œç„¶è€Œæ´»ç€å´æ— æ³•æä¾›æ­£å¸¸çš„æœåŠ¡ï¼Œåªèƒ½ä¸æ–­åœ°æ‰“å° ERROR
  æ—¥å¿—ã€‚ç‰¹åˆ«éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒERROR å’Œ FATAL éƒ½å±äºæœåŠ¡å™¨è‡ªå·±çš„å¼‚å¸¸ï¼Œæ˜¯éœ€è¦é©¬ä¸Šå¾—åˆ°äººå·¥ä»‹å…¥å¹¶å¤„ç†çš„ã€‚**è€Œå¯¹äºç”¨æˆ·è‡ªå·±æ“ä½œä¸å½“ï¼Œå¦‚è¯·æ±‚å‚æ•°é”™è¯¯ç­‰ç­‰ï¼Œæ˜¯ç»å¯¹ä¸åº”è¯¥è®°ä¸º
  ERROR æ—¥å¿—çš„ **ï¼›

- **WARN**è¯¥æ—¥å¿—è¡¨ç¤ºç³»ç»Ÿå¯èƒ½å‡ºç°é—®é¢˜ï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰ï¼Œè¿™ç§æƒ…å†µå¦‚ç½‘ç»œçš„æ³¢åŠ¨ç­‰ã€‚å¯¹äºé‚£äº›ç›®å‰è¿˜ä¸æ˜¯é”™è¯¯ï¼Œç„¶è€Œä¸åŠæ—¶å¤„ç†ä¹Ÿä¼šå˜ä¸ºé”™è¯¯çš„æƒ…å†µï¼Œä¹Ÿå¯ä»¥è®°ä¸º
  WARN æ—¥å¿—ï¼Œä¾‹å¦‚ä¸€ä¸ªå­˜å‚¨ç³»ç»Ÿçš„ç£ç›˜ä½¿ç”¨é‡è¶…è¿‡é˜ˆå€¼ï¼Œæˆ–è€…ç³»ç»Ÿä¸­æŸä¸ªç”¨æˆ·çš„å­˜å‚¨é…é¢å¿«ç”¨å®Œç­‰ç­‰ã€‚å¯¹äº WARN
  çº§åˆ«çš„æ—¥å¿—ï¼Œè™½ç„¶ä¸éœ€è¦ç³»ç»Ÿç®¡ç†å‘˜é©¬ä¸Šå¤„ç†ï¼Œä¹Ÿæ˜¯éœ€è¦åŠæ—¶æŸ¥çœ‹å¹¶å¤„ç†çš„ã€‚å› æ­¤æ­¤ç§çº§åˆ«çš„æ—¥å¿—ä¹Ÿä¸åº”å¤ªå¤šï¼Œèƒ½ä¸æ‰“ WARN çº§åˆ«çš„æ—¥å¿—ï¼Œå°±å°½é‡ä¸è¦æ‰“ï¼›
- **INFO**è¯¥ç§æ—¥å¿—è®°å½•ç³»ç»Ÿçš„æ­£å¸¸è¿è¡ŒçŠ¶æ€ï¼Œä¾‹å¦‚æŸä¸ªå­ç³»ç»Ÿçš„åˆå§‹åŒ–ï¼ŒæŸä¸ªè¯·æ±‚çš„æˆåŠŸæ‰§è¡Œç­‰ç­‰ã€‚é€šè¿‡æŸ¥çœ‹ INFO çº§åˆ«çš„æ—¥å¿—ï¼Œå¯ä»¥å¾ˆå¿«åœ°å¯¹ç³»ç»Ÿä¸­å‡ºç°çš„
  WARN,ERROR,FATAL é”™è¯¯è¿›è¡Œå®šä½ã€‚INFO æ—¥å¿—ä¸å®œè¿‡å¤šï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼ŒINFO çº§åˆ«çš„æ—¥å¿—åº”è¯¥ä¸å¤§äº TRACE æ—¥å¿—çš„ 10%ï¼›
- **DEBUG**or**TRACE**è¿™ä¸¤ç§æ—¥å¿—å…·ä½“çš„è§„èŒƒåº”è¯¥ç”±é¡¹ç›®ç»„è‡ªå·±å®šä¹‰ï¼Œè¯¥çº§åˆ«æ—¥å¿—çš„ä¸»è¦ä½œç”¨æ˜¯å¯¹ç³»ç»Ÿæ¯ä¸€æ­¥çš„è¿è¡ŒçŠ¶æ€è¿›è¡Œç²¾ç¡®çš„è®°å½•ã€‚é€šè¿‡è¯¥ç§æ—¥å¿—ï¼Œå¯ä»¥æŸ¥çœ‹æŸä¸€ä¸ªæ“ä½œæ¯ä¸€æ­¥çš„æ‰§
  è¡Œè¿‡ç¨‹ï¼Œå¯ä»¥å‡†ç¡®å®šä½æ˜¯ä½•ç§æ“ä½œï¼Œä½•ç§å‚æ•°ï¼Œä½•ç§é¡ºåºå¯¼è‡´äº†æŸç§é”™è¯¯çš„å‘ç”Ÿã€‚å¯ä»¥ä¿è¯åœ¨ä¸é‡ç°é”™è¯¯çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ DEBUGï¼ˆæˆ–
  TRACEï¼‰çº§åˆ«çš„æ—¥å¿—å¯¹é—®é¢˜è¿›è¡Œè¯Šæ–­ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**DEBUG æ—¥å¿—ä¹Ÿéœ€è¦è§„èŒƒæ—¥å¿—æ ¼å¼ **ï¼Œåº”è¯¥ä¿è¯é™¤äº†è®°å½•æ—¥å¿—çš„å¼€å‘äººå‘˜è‡ªå·±å¤–ï¼Œå…¶ä»–çš„å¦‚è¿ç»´ï¼Œæµ‹è¯•äººå‘˜ç­‰ä¹Ÿå¯ä»¥é€šè¿‡
  DEBUGï¼ˆæˆ– TRACEï¼‰æ—¥å¿—æ¥å®šä½é—®é¢˜ï¼›

### æ—¥å¿—æ•°é‡å’Œå¤§å°

æ§åˆ¶æ—¥å¿—çš„è¾“å‡ºé‡, é¿å…ç”±äºä¸šåŠ¡é‡å¤§è€Œå¯¼è‡´æœåŠ¡å™¨ç£ç›˜å¤§é‡è¾“å‡ºæ— ç”¨çš„æ—¥å¿—è€Œè¢«å æ»¡

- åªæ‰“å°å…³é”®ä¿¡æ¯, ä¸è¦éšä¾¿æŠŠå¯¹è±¡ Json åºåˆ—åŒ–åæ‰“å°å‡ºæ¥
- å•æ¡æ—¥å¿—ä¸èƒ½è¶…è¿‡ 1K
- å®šæ—¶ä»»åŠ¡åˆ é™¤ä¹‹å‰çš„æ—¥å¿— (logback maxHistory å±æ€§è®¾ç½®)

### åˆ‡å‰²æ–¹å¼

- ä½¿ç”¨æ—¥å¿—æ¡†æ¶è‡ªå¸¦çš„ Appender å°†æ—¥å¿—æŒ‰ç…§æ—¥æœŸè¿›è¡Œåˆ‡å‰² (ä¸åŒç³»ç»Ÿæ ¹æ®ä¸šåŠ¡é‡è®¾ç½®ä¸åŒçš„æ—¥å¿—åˆ‡å‰²æ–¹å¼)
- å°†ä¸åŒçº§åˆ«çš„æ—¥å¿—è¾“å‡ºåˆ°ä¸åŒæ–‡ä»¶ä¸­.

### æ—¥å¿—æ ¼å¼çš„é…ç½®

1. å‘ç”Ÿæ—¶é—´
2. æ—¥å¿—çº§åˆ« (DEBUG,INFO,WARN,ERROR,FATAL)
3. æ—¥å¿—è¾“å‡ºæ ‡è®°
4. çº¿ç¨‹æ ‡è¯†
5. æ–‡ä»¶åç§° (DEBUG æ—¥å¿—éœ€è¦, é DEBUG æ—¥å¿—å¯ä»¥ä¸ºç©º)
6. æ–‡ä»¶è¡Œå· (DEBUG æ—¥å¿—éœ€è¦, é DEBUG æ—¥å¿—å¯ä»¥ä¸ºç©º)
7. å‡½æ•°åç§° (DEBUG æ—¥å¿—éœ€è¦, é DEBUG æ—¥å¿—å¯ä»¥ä¸ºç©º)
8. æ—¥å¿—æè¿°

### å¼€å‘äººå‘˜çš„æ—¥å¿—æ„è¯†

ä¸ç®¡æ˜¯é€šè¿‡ AOP è¿˜æ˜¯ Filter æ¥é‡‡é›†æ—¥å¿—, éƒ½æ˜¯æŒ‰ç…§ç»Ÿä¸€çš„æ ¼å¼æ¥è¾“å‡ºæ—¥å¿—, æ˜¯ä¸ºäº†æ›´å¥½çš„èšåˆè¿™äº›æ—¥å¿—, æ–¹ä¾¿æŸ¥è¯¢.
è€Œåœ¨ç¨‹åºä¸­éš¾å…éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æ·»åŠ ä¸€äº›æ—¥å¿—, æ¥è°ƒè¯•ä»£ç æˆ–è€…åœ¨é‡è¦çš„ä¸šåŠ¡ä¸­è¾“å‡ºä¿¡æ¯ç­‰, æˆ‘ä»¬ä¹Ÿå¿…é¡»æŒ‰ç…§ç»Ÿä¸€çš„æ ¼å¼æ‰“å°æ—¥å¿—, æ–¹ä¾¿æœç´¢.

1. ç»Ÿä¸€çš„æ—¥å¿—æ ¼å¼
2. ä½¿ç”¨å ä½ç¬¦çš„æ–¹å¼æ‰“å°æ—¥å¿—
3. **ä½¿ç”¨ MDC**

## [æŒæ¡MDCï¼ŒJavaæ—¥å¿—è¿½è¸ªæ–°é«˜åº¦](https://blog.dong4j.site/posts/36b6823d.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

log MDC çš„ä½¿ç”¨

<!-- more -->

### MDC ä»‹ç»

MDCï¼ˆMapped Diagnostic Context, æ˜ å°„è°ƒè¯•ä¸Šä¸‹æ–‡ï¼‰æ˜¯ log4j å’Œ logback æä¾›çš„ä¸€ç§æ–¹ä¾¿åœ¨å¤šçº¿ç¨‹æ¡ä»¶ä¸‹è®°å½•æ—¥å¿—çš„åŠŸèƒ½. æŸäº›åº”ç”¨ç¨‹åºé‡‡ç”¨å¤šçº¿ç¨‹çš„æ–¹å¼æ¥å¤„ç†å¤šä¸ªç”¨æˆ·çš„è¯·æ±‚.
åœ¨ä¸€ä¸ªç”¨æˆ·çš„ä½¿ç”¨è¿‡ç¨‹ä¸­, å¯èƒ½æœ‰å¤šä¸ªä¸åŒçš„çº¿ç¨‹æ¥è¿›è¡Œå¤„ç†. å…¸å‹çš„ä¾‹å­æ˜¯ Web åº”ç”¨æœåŠ¡å™¨. å½“ç”¨æˆ·è®¿é—®æŸä¸ªé¡µé¢æ—¶, åº”ç”¨æœåŠ¡å™¨å¯èƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥å¤„ç†è¯¥è¯·æ±‚,
ä¹Ÿå¯èƒ½ä»çº¿ç¨‹æ± ä¸­å¤ç”¨å·²æœ‰çš„çº¿ç¨‹. åœ¨ä¸€ä¸ªç”¨æˆ·çš„ä¼šè¯å­˜ç»­æœŸé—´, å¯èƒ½æœ‰å¤šä¸ªçº¿ç¨‹å¤„ç†è¿‡è¯¥ç”¨æˆ·çš„è¯·æ±‚. è¿™ä½¿å¾—æ¯”è¾ƒéš¾ä»¥åŒºåˆ†ä¸åŒç”¨æˆ·æ‰€å¯¹åº”çš„æ—¥å¿—.
å½“éœ€è¦è¿½è¸ªæŸä¸ªç”¨æˆ·åœ¨ç³»ç»Ÿä¸­çš„ç›¸å…³æ—¥å¿—è®°å½•æ—¶, å°±ä¼šå˜å¾—å¾ˆéº»çƒ¦.

ä¸€ç§è§£å†³çš„åŠæ³•æ˜¯é‡‡ç”¨è‡ªå®šä¹‰çš„æ—¥å¿—æ ¼å¼, æŠŠç”¨æˆ·çš„ä¿¡æ¯é‡‡ç”¨æŸç§æ–¹å¼ç¼–ç åœ¨æ—¥å¿—è®°å½•ä¸­. è¿™ç§æ–¹å¼çš„é—®é¢˜åœ¨äºè¦æ±‚åœ¨æ¯ä¸ªä½¿ç”¨æ—¥å¿—è®°å½•å™¨çš„ç±»ä¸­,
éƒ½å¯ä»¥è®¿é—®åˆ°ç”¨æˆ·ç›¸å…³çš„ä¿¡æ¯. è¿™æ ·æ‰å¯èƒ½åœ¨è®°å½•æ—¥å¿—æ—¶ä½¿ç”¨. è¿™æ ·çš„æ¡ä»¶é€šå¸¸æ˜¯æ¯”è¾ƒéš¾ä»¥æ»¡è¶³çš„. MDC çš„ä½œç”¨æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜.

MDC å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªä¸å½“å‰çº¿ç¨‹ç»‘å®šçš„å“ˆå¸Œè¡¨, å¯ä»¥å¾€å…¶ä¸­æ·»åŠ é”®å€¼å¯¹. MDC ä¸­åŒ…å«çš„å†…å®¹å¯ä»¥è¢«åŒä¸€çº¿ç¨‹ä¸­æ‰§è¡Œçš„ä»£ç æ‰€è®¿é—®. å½“å‰çº¿ç¨‹çš„å­çº¿ç¨‹ä¼šç»§æ‰¿å…¶çˆ¶çº¿ç¨‹ä¸­çš„
MDC çš„å†…å®¹. å½“éœ€è¦è®°å½•æ—¥å¿—æ—¶, åªéœ€è¦ä» MDC ä¸­è·å–æ‰€éœ€çš„ä¿¡æ¯å³å¯. MDC çš„å†…å®¹åˆ™ç”±ç¨‹åºåœ¨é€‚å½“çš„æ—¶å€™ä¿å­˜è¿›å». å¯¹äºä¸€ä¸ª Web åº”ç”¨æ¥è¯´,
é€šå¸¸æ˜¯åœ¨è¯·æ±‚è¢«å¤„ç†çš„æœ€å¼€å§‹ä¿å­˜è¿™äº›æ•°æ®.

### MDC ä½¿ç”¨æ¡ˆä¾‹

ç›¸å¯¹æ¯”è¾ƒå¤§çš„é¡¹ç›®æ¥è¯´, ä¸€èˆ¬ä¼šæœ‰å¤šä¸ªå¼€å‘äººå‘˜, å¦‚æœæ¯ä¸ªå¼€å‘äººå‘˜å‡­è‡ªå·±çš„ç†è§£æ‰“å°æ—¥å¿—, é‚£ä¹ˆå½“ç”¨æˆ·åé¦ˆé—®é¢˜æ—¶, å¾ˆéš¾é€šè¿‡æ—¥å¿—å»å¿«é€Ÿçš„å®šä½åˆ°å‡ºé”™åŸå› ,
ä¹Ÿä¼šæ¶ˆè€—æ›´å¤šçš„æ—¶é—´. æ‰€ä»¥é’ˆå¯¹è¿™ç§é—®é¢˜, ä¸€èˆ¬ä¼šå®šä¹‰å¥½æ•´ä¸ªé¡¹ç›®çš„æ—¥å¿—æ ¼å¼, å¦‚æœæ˜¯éœ€è¦è¿½è¸ªçš„æ—¥å¿—, å¼€å‘äººå‘˜è°ƒç”¨ç»Ÿä¸€çš„æ‰“å°æ–¹æ³•, åœ¨æ—¥å¿—é…ç½®æ–‡ä»¶é‡Œé¢å®šä¹‰å¥½ç›¸åº”çš„å­—æ®µ,
é€šè¿‡ MDC åŠŸèƒ½å°±èƒ½å¾ˆå¥½çš„è§£å†³é—®é¢˜.

æ¯”å¦‚æˆ‘ä»¬å¯ä»¥äº‹å…ˆæŠŠç”¨æˆ·çš„ sessionId, ç™»å½•ç”¨æˆ·çš„ç”¨æˆ·å, è®¿é—®çš„åŸå¸‚ id, å½“å‰è®¿é—®å•†æˆ· id ç­‰ä¿¡æ¯å®šä¹‰æˆå­—æ®µ, çº¿ç¨‹å¼€å§‹æ—¶æŠŠå€¼æ”¾å…¥ MDC é‡Œé¢,
åç»­åœ¨å…¶ä»–åœ°æ–¹å°±èƒ½ç›´æ¥ä½¿ç”¨, æ— éœ€å†å»è®¾ç½®äº†.

ä½¿ç”¨ MDC æ¥è®°å½•æ—¥å¿—, ä¸€æ¥å¯ä»¥è§„èŒƒå¤šå¼€å‘ä¸‹æ—¥å¿—æ ¼å¼çš„ä¸€è‡´æ€§, äºŒæ¥å¯ä»¥ä¸ºåç»­ä½¿ç”¨ ELK å¯¹æ—¥å¿—è¿›è¡Œåˆ†æ.

æ‰€éœ€ä¾èµ–

```xml
<dependency>
  <groupId>log4j</groupId>
  <artifactId>log4j</artifactId>
  <version>1.2.17</version>
</dependency>
<dependency>
    <groupId>org.slf4j</groupId>
    <artifactId>slf4j-log4j12</artifactId>
    <version>1.7.21</version>
</dependency>
```

log4j.xml é…ç½®æ ·ä¾‹, è¿½è¸ªæ—¥å¿—è‡ªå®šä¹‰æ ¼å¼ä¸»è¦åœ¨ name="trance" çš„ layout é‡Œé¢è¿›è¡Œè®¾ç½®, æˆ‘ä»¬ä½¿ç”¨ %X{userName} æ¥å®šä¹‰æ­¤å¤„ä¼šæ‰“å° MDC é‡Œé¢ key ä¸º
userName çš„ value, å¦‚æœæ‰€å®šä¹‰çš„å­—æ®µåœ¨ MDC ä¸å­˜åœ¨å¯¹åº”çš„ key, é‚£ä¹ˆå°†ä¸ä¼šæ‰“å°, ä¼šç•™ä¸€ä¸ªå ä½ç¬¦.

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE log4j:configuration SYSTEM "log4j.dtd">
<log4j:configuration>
    <appender name="console" class="org.apache.log4j.ConsoleAppender">
        <param name="target" value="System.out" />
        <layout class="org.apache.log4j.PatternLayout">
            <param name="ConversionPattern" value="%-d{yyyy-MM-dd HH:mm:ss.SSS} %-6p%c:%L %x - %m%n" />
        </layout>
    </appender>

    <appender name="error" class="org.apache.log4j.DailyRollingFileAppender">
        <param name="File" value="D://logs//error.log" />
        <param name="DatePattern" value="'.'yyyy-MM-dd" />
        <param name="threshold" value="error"/>
        <param name="append" value="true"/>
        <layout class="org.apache.log4j.PatternLayout">
            <param name="ConversionPattern" value="[%d{yyyy-MM-dd HH:mm:ss.SSS}] %-6p%c:%L - %m%n" />
        </layout>
    </appender>

    <appender name="logic" class="org.apache.log4j.DailyRollingFileAppender">
        <param name="File" value="D://logs//logic.log" />
        <param name="DatePattern" value="'.'yyyy-MM-dd" />
        <param name="threshold" value="info"/>
        <param name="append" value="true"/>
        <layout class="org.apache.log4j.PatternLayout">
            <param name="ConversionPattern" value="[%d{yyyy-MM-dd HH:mm:ss.SSS}] %-6p%c:%L - %m%n" />
        </layout>
    </appender>

    <appender name="trace" class="org.apache.log4j.DailyRollingFileAppender">
        <param name="File" value="D://logs//trace.log" />
        <param name="DatePattern" value="'.'yyyy-MM-dd" />
        <param name="threshold" value="info"/>
        <param name="append" value="true"/>
        <layout class="org.apache.log4j.PatternLayout">
               <param name="ConversionPattern" value="[%d{yyyy-MM-dd HH:mm:ss.SSS}] - %X{mchId} - %X{mchName} - %X{siteName} - %X{sessionId} - %X{cityId} - %X{userName} - %X{mobile} - %m%n" />
         </layout>
    </appender>

    <logger name="traceLog" additivity="false">
        <level value="info" />
        <appender-ref ref="trace" />
    </logger>

    <root>
        <level value="info" />
        <appender-ref ref="console"/>
        <appender-ref ref="logic" />
        <appender-ref ref="error" />
    </root>
</log4j:configuration>
```

æ—¥å¿—æ‰“å°ç±»

```java
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class TraceLogger {
    // æ­¤å¤„çš„ "tranceLog" ä¸º log4j ä¸­å®šä¹‰çš„å¯¹åº”çš„ logger çš„ name
    private static final Logger TRACE_LOGGER = LoggerFactory.getLogger("traceLog");

    private TraceLogger() {

    }

    public static void info(String message){
        TRACE_LOGGER.info(message);
    }

    public static void info(String format,Object... arguments){
        TRACE_LOGGER.info(format, arguments);
    }
}
```

æœ€åå†™ä¸ªæ—¥å¿—æ‰“å°æµ‹è¯•ä¸€ä¸‹æ•ˆæœ

```java
@Test
public void Test(){
    MDC.clear();
    MDC.put("sessionId" , "f9e287fad9e84cff8b2c2f2ed92adbe6");
    MDC.put("cityId" , 1);
    MDC.put("siteName" , "åŒ—äº¬");
    MDC.put("userName" , "userwyh");
    TraceLogger. info("æµ‹è¯• MDC æ‰“å°ä¸€");

    MDC.put("mobile" , "110");
    TraceLogger. info("æµ‹è¯• MDC æ‰“å°äºŒ");

    MDC.put("mchId" , 12);
    MDC.put("mchName", "å•†æˆ·åç§°");
    TraceLogger. info("æµ‹è¯• MDC æ‰“å°ä¸‰");

}
```

æ‰§è¡Œå®Œåæˆ‘ä»¬å¯ä»¥åœ¨å®šä¹‰çš„æ—¥å¿—è¾“å‡ºè·¯å¾„ä¸‹çœ‹åˆ°ä»¥ä¸‹è¾“å‡º

```
[2016-10-19 19:20:26.564] -  -  - åŒ—äº¬ - f9e287fad9e84cff8b2c2f2ed92adbe6 - 1 - userwyh -  - æµ‹è¯• MDC æ‰“å°ä¸€
[2016-10-19 19:20:26.565] -  -  - åŒ—äº¬ - f9e287fad9e84cff8b2c2f2ed92adbe6 - 1 - userwyh - 110 - æµ‹è¯• MDC æ‰“å°äºŒ
[2016-10-19 19:20:26.565] - 12 - å•†æˆ·åç§° - åŒ—äº¬ - f9e287fad9e84cff8b2c2f2ed92adbe6 - 1 - userwyh - 110 - æµ‹è¯• MDC æ‰“å°ä¸‰
```

## [zheng æ¡†æ¶è§£æ (äºŒ)ï¼šä»ç¯å¢ƒæ­å»ºåˆ°éƒ¨ç½²å®æˆ˜](https://blog.dong4j.site/posts/ffbf019e.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})


çœ‹åˆ°ç¾¤é‡Œæœ‰æœ‹å‹å‡ºç°äº†ä¸‹é¢çš„é”™è¯¯, æˆ‘ä¹Ÿå‡ºç°äº†

```
com.alibaba.dubbo.rpc.RpcException: Forbid consumer 192.168.1.89 access service com.alibaba.dubbo.monitor.MonitorService from registry zkserver:2181 use dubbo version 2.5.3, Please check registry access list (whitelist/blacklist).
```

åœ¨å‡ºç°ä¸Šé¢çš„é”™è¯¯æ—¶, éƒ½ä¼šæ‰“å°ä¸‹é¢ä¸€æ®µä¿¡æ¯

```
INFO  [com.alibaba.dubbo.monitor.dubbo.DubboMonitor] -  [DUBBO] Send statistics to monitor zookeeper://zkserver:2181/com.alibaba.dubbo.monitor.MonitorService?dubbo=2.5.3&interface=com.alibaba.dubbo.monitor.MonitorService&pid=43821&timestamp=1504769453531, dubbo version: 2.5.3, current host: 192.168.1.89
```

æ¶ˆè´¹è€…å‘æä¾›è€…å‘é€ç»Ÿè®¡æ•°æ®æ—¶, ç”±äºæ³¨å†Œä¸­å¿ƒé‡Œé¢æ‰¾ä¸åˆ°é‚£ä¸ªæä¾›è€…çš„ä¿¡æ¯, æŠ›å‡ºäº†æœ€ä¸Šé¢çš„é”™è¯¯.

`MonitorService`, ä¸€çœ‹å°±çŸ¥é“æ˜¯è·Ÿ dubbo monitor æœ‰å…³.

æŸ¥çœ‹ `dubb-admin`, ä¹Ÿå¯ä»¥çœ‹åˆ°, `MonitorService` æ²¡æœ‰æä¾›è€…

![20241229154732_BwTUq4KI.webp](https://cdn.dong4j.site/source/image/20241229154732_BwTUq4KI.webp)

æœ€åæŸ¥çœ‹ readme.md, çœ‹è§ zheng ä½¿ç”¨äº† `Dubbo-monitor`
`dubbo-monitor` è·Ÿ `dubbo-admin` ä¸€æ ·, éœ€è¦æˆ‘ä»¬è‡ªå·±éƒ¨å±

## dubbo-monitor éƒ¨å±

è¿™é‡Œä½¿ç”¨ [éŸ©éƒ½è¡£èˆ](http://git.oschina.net/handu/dubbo-monitor) çš„ `Dubbo Monitor for Relational Database`

ä¸ä¸ºåˆ«çš„, å°±å› ä¸º `dubbo-monitor-simple` å¤ªä¸‘äº† ğŸ˜‚

å®˜æ–¹çš„ readme.md è¯´å¾—å·²ç»å¾ˆæ¸…æ¥šäº†, ç…§ç€æ¥å°±æ˜¯äº†

éƒ¨å±æˆåŠŸå è®¿é—® `http://127.0.0.1:9527/dubbo-monitor/`

æœ€åçš„æ•ˆæœå¦‚ä¸‹:

![20241229154732_Z2cMlmk3.webp](https://cdn.dong4j.site/source/image/20241229154732_Z2cMlmk3.webp)
![20241229154732_zJno8Aw3.webp](https://cdn.dong4j.site/source/image/20241229154732_zJno8Aw3.webp)
ç„¶åå°±ä¸ä¼šæŠ¥é”™äº†

![20241229154732_3U6ku0kX.webp](https://cdn.dong4j.site/source/image/20241229154732_3U6ku0kX.webp)
çº¢è‰²éƒ¨åˆ†ä¸æœªéƒ¨ç½²ä¹‹å‰, åé¢å¯ä»¥çœ‹åˆ°, å‘é€ç»Ÿè®¡æ•°æ®åæ²¡æœ‰æŠ¥é”™äº†

**å¦ä¸€ç§è§£å†³æ–¹æ¡ˆ**

åœ¨ dubbo.xml ä¸­é…ç½®äº† monitor æ‰ä¼šå‘é€ç»Ÿè®¡æ•°æ®

æ‰€ä»¥åˆ é™¤æ‰€æœ‰ `<dubbo:monitor protocol="registry"/>` ä¸ä½¿ç”¨ monitor å³å¯

## dubbo-admin éƒ¨ç½²

å’Œ dubbo-monitor ä¸€æ · ğŸ˜„

## é¡¹ç›®éƒ¨ç½²

æœ¬äººå·¥ä½œä¸­ä½¿ç”¨çš„ Maven ç¯å¢ƒè·Ÿ zheng ä¸ä¸€æ ·, ä¸ºäº†æ–¹ä¾¿, è¿™é‡Œå†™äº†ä¸ªè„šæœ¬, å¯ä»¥åˆ‡æ¢ä¸åŒçš„ Maven é…ç½®

```bash
change(){
  file_name='settings.xml.'$1
  is_exist="$(find ~/.m2 -name $file_name)"
  if [$is_exist]
  then
    mv ~/.m2/settings.xml ~/.m2/settings.xml.$2;
    mv ~/.m2/$file_name ~/.m2/settings.xml
  fi
  echo "change " $1 'to ' $2
}
```

### ç¯å¢ƒæ­å»º

è¿™é‡Œä½¿ç”¨ Vagrant æ¥æ­å»ºç¯å¢ƒ, ä¸€æ˜¯ä¸æƒ³æŠŠè‡ªå·±æœ¬åœ°çš„ç¯å¢ƒæä¹±, äºŒæ˜¯æ–¹ä¾¿, ç¯å¢ƒæ­å»ºå¥½ä¹‹å, æ‰“åŒ…ä¸€ä¸ª package, åˆ°å“ªå„¿éƒ½èƒ½ç”¨.

Vagrant é‡Œé¢çš„ä¾èµ–éƒ½å·²ç»å®‰è£…å¥½äº†, é…ç½®ä¸€ä¸‹å°± ok äº†.

Vagrant çš„ ip åœ°å€ä¸º `2.2.2.2`

**zheng æ˜¯éœ€è¦ä¿®æ”¹ hosts çš„, å¾ˆå¤šæœ‹å‹æ²¡æœ‰çœ‹å®Œæ–‡æ¡£å°±å¼€å§‹æ, å¯¼è‡´é¡¹ç›®è¿è¡Œä¸èµ·æ¥.**

#### Redis

1. å…è®¸è¿œç¨‹è®¿é—®
   è¿™é‡Œä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹ redis , è¿™é‡Œè®¾ç½®ä¸ºå…è®¸è¿œç¨‹è®¿é—®

   ```
   # ä¿®æ”¹ä»¥ä¸‹é…ç½®:
   # 1. æ³¨é‡Š bind 127.0.0.1
   # 2. protected-mode ç”± yes --> no
   ```

2. ä¿®æ”¹å¯†ç 
   æˆ‘è¿™é‡Œä¿®æ”¹äº† Redis çš„å¯†ç , é»˜è®¤æ˜¯ä¸ºç©ºçš„

   ```
   requirepass 123456
   ```

Redis è¿œç¨‹è¿æ¥æˆåŠŸ

![20241229154732_Ql5bfynw.webp](https://cdn.dong4j.site/source/image/20241229154732_Ql5bfynw.webp)

#### Nginx

æ¥ä¸€ä»½ç®€å•å®ç”¨çš„ nginx.conf é…ç½®

```nginx
worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    server {
        listen  80;
        server_name  localhost;
        location / {
            root   /zheng/zheng-cms-web/;
            index  index.html index.htm;
            add_header Access-Control-Allow-Origin *;
        }
    }
}
```

![20241229154732_fDEDLZ26.webp](https://cdn.dong4j.site/source/image/20241229154732_fDEDLZ26.webp)

```
# ä¿®æ”¹äº† nginx.conf å, é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶
nginx -s reload
# åœæ­¢ nginx
nginx -s stop
# æ£€æŸ¥é…ç½®æ–‡ä»¶
nginx -t
```

##### IDEA é…ç½®æœåŠ¡å™¨, ç›´æ¥ä¸Šä¼ æ–‡ä»¶

è®©ä½ ä½“ä¼šä¸€ä¸‹ä»€ä¹ˆæ˜¯ **æ²‰æµ¸å¼ IDE**

é…ç½® Deployment

![20241229154732_piqBf0lB.webp](https://cdn.dong4j.site/source/image/20241229154732_piqBf0lB.webp)

1. é…ç½®æœåŠ¡å™¨
   ![20241229154732_QKP3wVrc.webp](https://cdn.dong4j.site/source/image/20241229154732_QKP3wVrc.webp)

2. é…ç½®æœ¬åœ°ç›®å½•ä¸æœåŠ¡å™¨ç›®å½•æ˜ å°„å…³ç³»
   ![20241229154732_q4KLzQXy.webp](https://cdn.dong4j.site/source/image/20241229154732_q4KLzQXy.webp)

3. å®Œæˆé…ç½®
   ![20241229154732_9N6ltVcM.webp](https://cdn.dong4j.site/source/image/20241229154732_9N6ltVcM.webp)

4. ä¸Šä¼ æœ¬åœ°æ–‡ä»¶åˆ°æœåŠ¡å™¨

![20241229154732_7YUtTE57.webp](https://cdn.dong4j.site/source/image/20241229154732_7YUtTE57.webp)

5. å“¦äº†
   ![20241229154732_RiTcJ9NL.webp](https://cdn.dong4j.site/source/image/20241229154732_RiTcJ9NL.webp)

ä¿®æ”¹äº† html, upload, åˆ·æ–°, so easy
![4444.gif](https://cdn.dong4j.site/source/image/4444.gif)

#### Zookeeper

Zookeeper ä½¿ç”¨é»˜è®¤é…ç½®å°±å¯ä»¥äº†, ä¸‰ç§é…ç½®æ–¹å¼

1. å•æœº
2. ä¼ªé›†ç¾¤
3. çœŸé›†ç¾¤

è¿™é‡Œå°±ä¸è¯´äº†, æˆ‘ä½¿ç”¨å•æœºé…ç½®, ç®€å•

```
# å¿ƒè·³æ£€æµ‹æ¯«ç§’æ•°
tickTime=2000
# follower åˆå§‹åŒ–è¿æ¥æœ€é•¿å¿å—çš„å¿ƒè·³æ•°æ—¶é—´é—´éš” 2000*10=20 ç§’
initLimit=10
# leader å’Œ follower ä¹‹é—´å‘é€æ¶ˆæ¯è¯·æ±‚å’Œåº”ç­”æ—¶é—´é•¿åº¦ 5*2000=10 ç§’
syncLimit=5
# æ•°æ®æŒä¹…åŒ–çš„ç›®å½•
dataDir=~/Develop/logs/zookeeper/data
# æ—¥å¿—
dataLogDir=~/Develop/logs/zookeeper/log
# å‘ client æš´éœ²çš„ç«¯å£
clientPort=2181

# æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°
# maxClientCnxns=60
# å¿«ç…§ä¸ªæ•°
# autopurge.snapRetainCount=3
# å¿«ç…§ä¿å­˜æ—¶é—´é—´éš”å°æ—¶
#autopurge.purgeInterval=1
```

ä¸‹ä¸ªæ’ä»¶ zookeeper, èƒ½çœ‹åˆ° zookeeper çš„èŠ‚ç‚¹ä¿¡æ¯

![20241229154732_JfNznTUq.webp](https://cdn.dong4j.site/source/image/20241229154732_JfNznTUq.webp)

#### ActiveMQ

é»˜è®¤é…ç½®

ç•¥... ğŸ˜‚ğŸ˜‚

#### Tomcat

è¿™é‡Œåªè¦ä¸€å°æœåŠ¡å™¨, æ‰€æœ‰å°±æä¸ªå•æœºå¤šå®ä¾‹çš„é…ç½®, è¿™é‡Œè¦ä¿®æ”¹ Tomcat é…ç½®,
è®©ä¸€å°æœåŠ¡å™¨ä¸Šè·‘ 2 ä¸ª Tomcat, ä¸ä¸ºåˆ«çš„, ä»¥ä¸ºæˆ‘å°±ä¸€å°è™šæ‹Ÿæœº, æ„æ€ä¸€ä¸‹å°±å¯ä»¥äº† ğŸ˜‚ğŸ˜‚

å°†è§£å‹åçš„ Tomcat å¤åˆ¶ä¸€ä»½
ä¿®æ”¹ **æ¯ä¸ª tomcat å®ä¾‹ä¸­ server.xml ä¸­çš„ç«¯å£**

```
<?xml version="1.0" encoding="UTF-8"?>
<Server port="9005" shutdown="SHUTDOWN">
  ....
  <Service name="Catalina">
    <Connector port="1111" protocol="HTTP/1.1"
               connectionTimeout="20000"
               redirectPort="9443" />
    <Connector port="9009" protocol="AJP/1.3" redirectPort="9443" />
    ...
  </Service>
</Server>
```

2 ä¸ª server.xml åªè¦ä¸ä¸€æ ·å°±è¡Œäº†, åªè¦ç¡®ä¿ä¿®æ”¹çš„ç«¯å£æ²¡æœ‰è¢«å…¶ä»–ç¨‹åºå ç”¨å°±å¯ä»¥äº†.

ç„¶åä¸€ä¸ªä¸€ä¸ªå¯åŠ¨å§, å¦‚æœå«Œéº»çƒ¦, ä¹Ÿå¯ä»¥å†™è„šæœ¬ä¸€é”®å¯åŠ¨

![20241229154732_HirA2IKk.webp](https://cdn.dong4j.site/source/image/20241229154732_HirA2IKk.webp)

ä¸€ä¸ª 1111, å¦ä¸€ä¸ª 2222

ä¸€èˆ¬éƒ½æ˜¯å…ˆæŠŠ war ä¸Šä¼ åˆ°ä¸´æ—¶ç›®å½•ä¸‹, ç„¶åå†ç§»åŠ¨åˆ° webapp ä¸‹, ä¸è¦åœ¨ tomcat æ­£åœ¨è¿è¡Œçš„æ—¶å€™æŠŠ war ç›´æ¥ä¸Šä¼ åˆ° webapp ä¸‹, å› ä¸ºä¸€æ—¦ä¸Šä¼ å¼€å§‹, webapp
ä¸‹å°±ä¼šæœ‰å‡ºç° war, ç„¶å tomcat å°±å¼€å§‹è§£å‹äº†, ä½†æ˜¯è¿™ä¸ª war å¹¶ä¸å®Œæ•´, ä¼šå‡ºé”™çš„

ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸Šé¢çš„æ–¹å¼, åŒæ­¥æœ¬åœ°æ–‡ä»¶åˆ°æœåŠ¡å™¨, åªé™äºå¼€å‘, ç”Ÿäº§ç¯å¢ƒä½ ä¸ä¸€å®šæœ‰è´¦å·, äºŒæ˜¯è°è®©ä½ æ²¡äº‹ä¸€ç›´è¿ç€ç”Ÿäº§æœåŠ¡å™¨çš„?

#### å¯åŠ¨ä¾èµ–è½¯ä»¶

å†™ä¸€ä¸ªç®€å•çš„è„šæœ¬, ä¸€é”®å¯åŠ¨æ‰€æœ‰ä¾èµ–

```bash
#!/bin/bash
export JAVA_HOME=/usr/local/java
export PATH=$JAVA_HOME/bin:$PATH
# zookeeper
nohup /usr/local/kafka/bin/zookeeper-server-start.sh /usr/local/kafka/config/zookeeper.properties &
echo "zookeeper å¯åŠ¨å®Œæˆ"
# redis
nohup /usr/local/redis/src/redis-server /usr/local/redis/redis.conf &
echo "redis å¯åŠ¨å®Œæˆ"
# nginx
/usr/local/nginx/sbin/nginx
echo "nginx å¯åŠ¨å®Œæˆ"
# ActiveMQ
/usr/local/activemq/bin/activemq start
echo "activemq å¯åŠ¨å®Œæˆ"
```

tomcat å°±æ‰‹åŠ¨å¯åŠ¨å§, æ•²æ•²å‘½åä¹Ÿæ˜¯å¥½çš„

ğŸ˜‚ğŸ˜‚

### æ‰“åŒ…

å…ˆä¿®æ”¹é…ç½®æ–‡ä»¶

ç”±äº Vagrant é‡Œé¢æ²¡æœ‰å®‰è£… MySQL, æˆ‘å°±è¿æ¥æœ¬åœ°çš„äº†, ä¸€èˆ¬æ•°æ®åº“éƒ½æ˜¯å•ç‹¬çš„æœåŠ¡å™¨, æ­£å¥½æ¨¡æ‹Ÿä¸€ä¸‹

**2017-09-14 11:59 dong4j æ›´æ–°**

è¿™é‡Œåæ§½ä¸€ä¸‹, å¾ˆå¤šé…ç½®æ˜¯å†™æ­»çš„, æ¯”å¦‚è¯´ dubbo é‡Œé¢çš„ zookeeper æ³¨å†Œåœ°å€, æ²¡æœ‰å†™åˆ°é…ç½®æ–‡ä»¶ä¸­å»,
æ‰€ä»¥è¿™é‡Œè¿˜æ˜¯æ”¹å›ä½¿ç”¨ hosts çš„æ–¹å¼.

åªä¿®æ”¹äº† mysql çš„åœ°å€, å…¶ä»–çš„æŒ‰ç…§åŸæ–‡æ¡£ä¿®æ”¹ hosts

ä½¿ç”¨ Maven æ‰“åŒ…

```
mvn clean package -Pprod
```

### ä¸Šä¼ 

å°† 4 ä¸ªåŒ…ä¸Šä¼ åˆ°æœåŠ¡å™¨

```
scp zheng-cms-rpc-service-assembly.tar.gz root@2.2.2.2:/zheng/upload/
```

```
# å†…å®¹ç®¡ç†ç³»ç»Ÿ, é€šè¿‡ ZhengUpmsRpcServiceApplication.main æ–¹æ³•å¯åŠ¨æœåŠ¡æä¾›è€…
zheng-upms-rpc-service-assembly.tar.gz
# å†…å®¹ç®¡ç†ç³»ç»Ÿ, ä½¿ç”¨ jar åŒ…çš„æ–¹å¼å¯åŠ¨, é€šè¿‡ ZhengCmsRpcServiceApplication æ–¹æ³•å¯åŠ¨æœåŠ¡æä¾›è€…
zheng-cms-rpc-service-assembly.tar.gz
# ç”¨æˆ·æƒé™ç³»ç»ŸåŠ SSO æœåŠ¡ç«¯ [ç«¯å£:1111] æ¶ˆè´¹ç«¯ éƒ¨å±åˆ° tomcat1 1111
zheng-upms-server.war
# åå°ç®¡ç† [ç«¯å£:2222] æ¶ˆè´¹ç«¯ éƒ¨å±åˆ° tomcat2 2222
zheng-cms-admin.war
```

### å¯åŠ¨

#### æä¾›è€…

å…ˆè§£å‹ 2 ä¸ªåŒ…

```
zheng-cms-rpc-service-assembly.tar.gz
zheng-upms-rpc-service-assembly.tar.gz
```

```
tar -zxvf *.tar.gz
```

åˆ†åˆ«å¯åŠ¨ `zheng-upms-rpc-service` å’Œ `zheng-cms-rpc-service`

ä½¿ç”¨å¯¹åº”ç›®å½•ä¸‹çš„ `bin/start.sh` è„šæœ¬

#### æ¶ˆè´¹è€…

åˆ é™¤ tomcat1[2]/webapps/ROOT é‡Œçš„æ‰€æœ‰æ–‡ä»¶, å°† war åŒ…åˆ†åˆ«æ‹·å…¥åˆ° tomcat1 å’Œ tomcat2 ä¸‹çš„ webapps/ROOT,

ç„¶åä½¿ç”¨ unzip è§£å‹

```
unzip *war
```

å¦‚æœç›´æ¥æ”¾å…¥ webapps ä¸‹, å¯åŠ¨ tomcat åä¼šè‡ªåŠ¨è§£å‹ war åŒ…, ä½†æ˜¯è¯·æ±‚åº”ç”¨æ—¶, å°±å¿…é¡»é€šè¿‡ `http://ip:port/ åº”ç”¨å / èµ„æºè·¯å¾„ ` çš„æ–¹å¼è®¿é—®

è¿™é‡Œç›´æ¥è§£å‹åˆ° ROOT ç›®å½•ä¸‹, å°±ä¸éœ€è¦çŸ¥é“åº”ç”¨å.

### å®Œæˆ

ç”±äºæ˜¯è™šæ‹Ÿæœº, åœ°å€ä¸º 2.2.2.2, æ‰€ä»¥éœ€è¦ä¿®æ”¹æˆ‘ **æœ¬åœ°** çš„ hosts, æŠŠ åŸŸåæŒ‡å‘ 2.2.2.2

```
2.2.2.2 ui.zhangshuzheng.cn
2.2.2.2 upms.zhangshuzheng.cn
2.2.2.2 cms.zhangshuzheng.cn
2.2.2.2 pay.zhangshuzheng.cn
2.2.2.2 ucenter.zhangshuzheng.cn
2.2.2.2 wechat.zhangshuzheng.cn
2.2.2.2 api.zhangshuzheng.cn
2.2.2.2 oss.zhangshuzheng.cn
2.2.2.2 config.zhangshuzheng.cn
```

ç³»ç»Ÿç®¡ç†

![20241229154732_ZWx2ern5.webp](https://cdn.dong4j.site/source/image/20241229154732_ZWx2ern5.webp)

ç»„ç»‡ç®¡ç†

![20241229154732_VrnKvSMq.webp](https://cdn.dong4j.site/source/image/20241229154732_VrnKvSMq.webp)

æƒé™ç®¡ç†

![20241229154732_Bp1NmEPm.webp](https://cdn.dong4j.site/source/image/20241229154732_Bp1NmEPm.webp)

Redis

![20241229154732_OiJg61e1.webp](https://cdn.dong4j.site/source/image/20241229154732_OiJg61e1.webp)

Zookeeper

![20241229154732_Wrvd2tyJ.webp](https://cdn.dong4j.site/source/image/20241229154732_Wrvd2tyJ.webp)

ActiveMQ

![20241229154732_6CHgup1F.webp](https://cdn.dong4j.site/source/image/20241229154732_6CHgup1F.webp)

## é‡åˆ°çš„é—®é¢˜

### hosts

æœ¬æ¥æ˜¯æƒ³ä¸ä¿®æ”¹ hosts æ¥éƒ¨ç½² zheng çš„, ä½†æ˜¯å¤§æ¦‚çœ‹äº†ä¸‹ä»£ç , å‘ç°å¾ˆå¤šåŸŸåå’Œé…ç½®éƒ½æ˜¯å†™æ­»çš„, è¿˜éœ€è¦ä¿®æ”¹æ•°æ®åº“, æ”¹åŠ¨ä¼šå¾ˆå¤§, å°±æ²¡æœ‰å¿ƒæƒ…ä¿®æ”¹äº†.

ä½†æ˜¯ hosts è¿˜æ˜¯éœ€è¦ä¿®æ”¹ä¸€ä¸‹æ‰èƒ½åœ¨æœåŠ¡å™¨ä¸Šä½¿ç”¨.

1. ä¿®æ”¹ hosts , å°†åŸŸåæŒ‡å‘æœåŠ¡å™¨ ip
   **è¿™éƒ¨åˆ†æ˜¯åœ¨æœ¬åœ°ä¿®æ”¹**

   ```
   2.2.2.2 ui.zhangshuzheng.cn
   2.2.2.2 upms.zhangshuzheng.cn
   2.2.2.2 cms.zhangshuzheng.cn
   2.2.2.2 pay.zhangshuzheng.cn
   2.2.2.2 ucenter.zhangshuzheng.cn
   2.2.2.2 wechat.zhangshuzheng.cn
   2.2.2.2 api.zhangshuzheng.cn
   2.2.2.2 oss.zhangshuzheng.cn
   2.2.2.2 config.zhangshuzheng.cn

   ```

2. å°†æœåŠ¡å™¨ä¾èµ–è½¯ä»¶çš„ ip æŒ‡å‘æœåŠ¡å™¨

**è¿™éƒ¨ä»½æ˜¯ä¿®æ”¹æœåŠ¡å™¨çš„ hosts**

zookeeper, redis, activemq éƒ½å®‰è£…åœ¨ 2.2.2.2 è¿™å°æœåŠ¡å™¨ä¸Šçš„

    ```
    127.0.0.1 zkserver
    127.0.0.1 rdserver
    # 127.0.0.1 dbserver mysql çš„ åœ°å€ä¿®æ”¹ä¸ºäº†æˆ‘æœ¬åœ°çš„ mysql å±€åŸŸç½‘åœ°å€æ˜¯ 192.168.31.28
    127.0.0.1 mqserver
    ```

### dubbo-monitor

[éŸ©éƒ½è¡£èˆ](http://git.oschina.net/handu/dubbo-monitor) çš„ dubbo-monitor ç¼–è¯‘åä¸èƒ½ç›´æ¥ç”¨äº dubbo 2.5.3

éœ€è¦ä¿®æ”¹ pom.xml

```
# ç”± 2.8.4 ä¿®æ”¹ä¸º 2.5.3
<dubbo.version>2.5.3</dubbo.version>

# æ’é™¤ dubbo ä¾èµ–çš„ æ—§ç‰ˆæœ¬çš„ spring
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>dubbo</artifactId>
    <version>${dubbo.version}</version>
    <exclusions>
        ...
        <exclusion>
            <artifactId>spring</artifactId>
            <groupId>org.springframework</groupId>
        </exclusion>
    </exclusions>
</dependency>
```

## [æ·±å…¥è§£æZhengæ¡†æ¶ï¼šæ­å»ºä¸éƒ¨ç½²å®æˆ˜æŒ‡å—](https://blog.dong4j.site/posts/508e9afc.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})


## å‰ææ¡ä»¶

ç¾¤é‡Œé¢æœ‰ä¸€ç¯‡ `zheng- ç¯å¢ƒæ­å»ºåŠç³»ç»Ÿéƒ¨ç½²æ–‡æ¡£ 20170213(ä¸‰ç‰ˆ).docx`, é‡Œé¢è¯¦ç»†è®²è§£äº†å„ä¸ªä¾èµ–è½¯ä»¶çš„å®‰è£…å’Œé…ç½®,
æ‰€ä»¥è¿™é‡Œä¸ä¼šå†è®²ä¾èµ–çš„æ­å»ºè¿‡ç¨‹.
å‡è®¾ä½ å·²ç»å°†æ‰€æœ‰çš„ä¾èµ–ç¯å¢ƒæ­å»ºå®Œæ¯•.

## æˆ‘çš„ç¯å¢ƒ

| åç§°          | ç‰ˆæœ¬                   |
| ------------- | ---------------------- |
| ç³»ç»Ÿ          | MacOS 10.12.6          |
| IDE           | Intellij IDEA 2017.2.3 |
| JDK           | 1.8                    |
| Maven         | 3.3.9                  |
| Dubbo         | 2.5.3                  |
| Zookeepe      | 3.4.10                 |
| Nginx         | 1.12.1                 |
| ActiveMQ      | 5.15.0                 |
| MySQL         | 5.7.16                 |
| Redis         | 3.2.3                  |
| Dubbo-admin   |                        |
| Dubbo-monitor |                        |

### ç”¨åˆ°çš„å·¥å…·

1. IDEA
2. LICEcap --> gif åˆ¶ä½œ
3. MWeb --> Markdown ç¼–è¾‘å™¨
4. iTerm --> æ›¿ä»£ Terminal çš„å·¥å…·

## ç¯å¢ƒæ­å»º

æˆ‘è®°å¾—å»å¹´è¿˜æ˜¯å‰å¹´, ç”¨ Intellij IDEA çš„äººå·²ç»è¶…è¿‡äº† Eclipse, å¦‚æœä½ è¿˜åœ¨ç”¨ Eclipse, æˆ‘æƒ³å®‰åˆ©ä½ é©¬ä¸Šè½¬åˆ° IDEA æ¥, ä¸æ˜¯ä¸€èˆ¬çš„å¥½ç”¨, æˆ‘å·²ç»å®‰åˆ©äº†ä¸ä¸‹
50 äºº ä½¿ç”¨ IDEA äº†.

ä¹‹åçš„ç³»åˆ—æ–‡ç« , ä¼šç©¿æ’ä¸€äº› IDEA çš„æ•™ç¨‹, åœ¨å®è·µä¸­å­¦ä¹ , æ•ˆæœæ æ çš„.

è¿™é‡Œå¼ºçƒˆæ¨èä¸€ä¸ªä¸“é—¨å†™ IDEA çš„æ•™ç¨‹, å¸Œæœ›èƒ½å¸®åŠ©ä½ ä¸€äº›

https://github.com/judasn/IntelliJ-IDEA-Tutorial.git

ä¸è¦æ€•ä¸ä¼šç”¨, ç­‰ä½ å­¦ä¼šäº†ä»¥å, æ•ˆç‡æ˜¯åˆ«äººçš„å‡ å€

![20241229154732_BGyuUh4B.webp](https://cdn.dong4j.site/source/image/20241229154732_BGyuUh4B.webp)

clone é¡¹ç›®, ä½¿ç”¨ Intellji IDEA å¯¼å…¥è¿™äº›å°±ä¸è¯´äº†

è¿™æ­¥å®Œæˆçš„æ ·å­æ˜¯è¿™æ ·çš„

![20241229154732_yKJSQxsX.webp](https://cdn.dong4j.site/source/image/20241229154732_yKJSQxsX.webp)

é¡¹ç›®ç»“æ„å’Œå‘½åçœ‹ç€éå¸¸èˆ’æœ

### å¯¼å…¥ SQL

æ‰¾åˆ° `project-datamodel --> zheng.sql` , åŒå‡»æ‰“å¼€

å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ‰“å¼€è¿™ä¸ªé¡¹ç›®, ä½ è‚¯å®šä¼šçœ‹åˆ°è¿™ä¸ª

![20241229154732_FpAPd2IP.webp](https://cdn.dong4j.site/source/image/20241229154732_FpAPd2IP.webp)

#### è®¾ç½®æ•°æ®åº“

è®¾ç½®ä¹‹å‰ä½ å¾—ä½¿ç”¨å‘½ä»¤æˆ–è€… navicat åˆ›å»ºä¸€ä¸ªå« `zheng` çš„æ•°æ®åº“

##### é—®é¢˜ 1: [1067] Invalid default value for 'last_login_time'

å¯¼å…¥ SQL æŠ¥é”™

é¦–å…ˆå¤ä¹ ä¸‹ MySQl ä¸­ datetime, timestamp, date çš„åŒºåˆ«.

| æ—¥æœŸç±»å‹  | å­˜å‚¨ç©ºé—´ | æ—¥å¿—æ ¼å¼            | æ—¥æœŸèŒƒå›´                                  |
| --------- | -------- | ------------------- | ----------------------------------------- |
| datetime  | 8 bytes  | YYYY-MM-DD HH:MM:SS | 1000-01-01 00:00:00 ~ 9999-12-31 23:59:59 |
| timestamp | 4 bytes  | YYYY-MM-DD HH:MM:SS | 1970-01-01 00:00:01 ~ 2037-12-31 23:59:59 |
| date      | 3 bytes  | YYYY-MM-DD          | 1000-01-01 ~ 9999-12-31                   |

è¿™é‡Œç”¨ `timestamp`

1. å ç”¨ç©ºé—´å°
2. åœ¨è¿›è¡Œ `insert`, `update` æ•°æ®æ—¶ï¼Œ`timestamp` åˆ—ä¼šè‡ªåŠ¨ä»¥å½“å‰æ—¶é—´ï¼ˆCURRENT_TIMESTAMPï¼‰å¡«å…… / æ›´æ–°.

ä½†æ˜¯åˆ° 2038-00-00 00:00:00 æ—¶, ç³»ç»Ÿå°±å´©æºƒäº†, æƒ³æƒ³å°±åˆºæ¿€, ğŸ˜‚

**ç„¶è€Œå¹¶ä¸æ˜¯è¿™ä¸ªé—®é¢˜**

è¿™ç§æŠ¥é”™å¤šåŠæ˜¯ä½  MySQl å‡çº§åˆ° 5.7 è€Œå¼•èµ·çš„é»˜è®¤å€¼ä¸å…¼å®¹çš„é—®é¢˜.
æƒ³åˆ°å¯èƒ½æ˜¯ç±»å‹çš„é»˜è®¤å€¼è¢«é™åˆ¶äº†ï¼ŒæŸ¥çœ‹ sql_mode.

```sql
show variables like 'sql_mode';
```

> sql_mode STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION

æœç„¶ NO_ZERO_IN_DATE, NO_ZERO_DATE è¿™ä¸¤ä¸ªå‚æ•°é™åˆ¶æ—¶é—´ä¸èƒ½ä¸º 0

```sql
# ä¸´æ—¶è§£å†³
set session sql_mode='STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
```

```
# æ°¸ä¹…æ–¹æ¡ˆ
# ç›´æ¥ä¿®æ”¹ my.cnf æ–‡ä»¶

åœ¨ [mysqld] ä¸‹é¢æ·»åŠ å¦‚ä¸‹åˆ—ï¼š

sql_mode=STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION
```

![20241229154732_pW5gOynv.webp](https://cdn.dong4j.site/source/image/20241229154732_pW5gOynv.webp)

é£éªšçš„æ“ä½œ, å®Œç¾çš„è¡¨å ğŸ˜

### ä¿®æ”¹é…ç½®æ–‡ä»¶

å¯†ç å€¼ä½¿ç”¨äº† AES åŠ å¯†ï¼Œä½¿ç”¨ `com.zheng.common.util.AESUtil` å·¥å…·ç±»ä¿®æ”¹è¿™äº›å€¼

è¿™ä¹ˆå¤šæ–‡ä»¶æ€ä¹ˆæ‰¾?

IDEA çš„å¼ºå¤§ä¹‹å¤„ **ä¹‹ä¸€** å°±åœ¨äºå®ƒå¼ºå¤§çš„æœç´¢åŠŸèƒ½. ç¬¬ä¸€æ¬¡æ‰“å¼€é¡¹ç›®æ—¶, IDEA ä¼šèŠ±ç‚¹æ—¶é—´åˆ›å»ºæ‰€æœ‰é™¤äº† `Exclued Folders` çš„æ–‡ä»¶çš„ç´¢å¼•.

ä¸ç®¡è¿™äº›, ç›´æ¥ä½¿ç”¨ ` åŒå‡» shift` æ¥å…¨å±€æŸ¥æ‰¾.

![2.gif](https://cdn.dong4j.site/source/image/2.gif)

èƒ¡æ‚ æˆ‘, æ‰“å¼€çš„å…¨æ˜¯å ä½ç¬¦çš„é…ç½®æ–‡ä»¶, è¿˜è¦å»æ‰¾ä¸»é…ç½®æ‰è¡Œ, ç„¶åä¸€ä¸ªä¸€ä¸ªçš„æ”¹? you are so young so simple

å…¨å±€æ›¿æ¢, ç§’ç§’é’Ÿçš„äº‹

![3.gif](https://cdn.dong4j.site/source/image/3.gif)

å…¶ä»–çš„ç…§ç€æ¥

### å¯åŠ¨ä¾èµ–

æˆ‘å¯åŠ¨è¿™äº›ä¾èµ–è´¼ç®€å•, ä¸ä¿¡ä½ çœ‹

![20241229154732_258FNQfX.webp](https://cdn.dong4j.site/source/image/20241229154732_258FNQfX.webp)

start, start, start ....

æˆ‘è®°å¾—ä»¥å‰ç”¨ windows çš„æ—¶å€™, å¯åŠ¨è¿™äº›ä¾èµ–å¾ˆæ¼ç«, ä¸€ä¸ªä¸€ä¸ªå¯åŠ¨, åæ¥å†™äº†ä¸ªæ‰¹å¤„ç†, ä¸€å»ºå¯åŠ¨, åœ¨è™šæ‹Ÿæœºä¸Š, æ‡’çš„å¼€äº†.....

#### é…ç½® nginx

è¿™é‡Œå…ˆè¯´ä¸€ä¸ª windows çš„å‘

nginx.conf é…ç½®æ–‡ä»¶é»˜è®¤ç¼–ç æ˜¯ utf-8, åœ¨ windows ä¸Šä½¿ç”¨è®°äº‹æœ¬æ‰“å¼€ utf-8 ç¼–ç çš„æ–‡ä»¶, å®ƒä¼šåœ¨æ–‡ä»¶å‰é¢åŠ ä¸Šä¸€ä¸ª `BOM` ğŸ˜‚, ä¸çŸ¥é“ä½ ä»¬æœ‰æ²¡æœ‰è¸©è¿‡è¿™ä¸ªå‘....

ä¹Ÿæ˜¯è¿™ä¸ªå‘, åˆè¸©äº†ä¸€æ¬¡.

æ˜¯é¡¹ç›®ä¸Šä¸€ä¸ª Excel å¯¼å‡ºçš„é—®é¢˜

poi å¯¼å‡ºå¤§é‡æ•°æ®, å†…å­˜æº¢å‡º, æ‰€ä»¥åˆ°æ•°æ®é‡å¾ˆå¤§æ—¶, å°±ç”¨å¯¼å‡ºæ–‡æœ¬æ–‡ä»¶çš„æ–¹å¼

```java
@Test
public void test() throws IOException {
    // æ•°æ®å­˜æ”¾çš„ä½ç½®
    String path="/Users/xxx/Develop/test.xls";
    // ç”Ÿæˆæ–‡ä»¶
    BufferedWriter buff = new BufferedWriter(new FileWriter(path));
    // æ’å…¥æ ‡é¢˜ ä»£è¡¨ 3 åˆ—
    buff.write("éƒ¨é—¨åç§°\tç”¨æˆ·\tç”µè¯");
    // æ¢è¡Œ
    buff.write("\n");
    // æ’å…¥ 5 ä¸‡æ¡è®°å½•
    String s = "ä¸­æ–‡æµ‹è¯•";
    for (int i = 0; i < 50000; i++) {
        buff.write(s +  "\tzheng\t1234567890");
        buff.write("\n");
    }
    buff.close();
}
```

å¦‚æœ windows çš„ç”¨æˆ·ä½¿ç”¨ Excel æ‰“å¼€å°±ä¼šæ˜¯ä¹±ç , åŸå› å°±æ˜¯ä¸Šé¢è¯´åˆ°çš„

æ”¹ä¸º:

```
@Test
public void test() throws IOException {
    // æ•°æ®å­˜æ”¾çš„ä½ç½®
    String path="/Users/codeai/Develop/test.xls";
    // ç”Ÿæˆæ–‡ä»¶
    BufferedWriter buff = new BufferedWriter(new FileWriter(path));
    // åœ¨æ–‡ä»¶å¼€å§‹åŠ ä¸€ä¸ª  U+FEFF
    buff.write(new String(new byte[] {(byte) 0xEF, (byte) 0xBB, (byte) 0xBF}));
    // æ’å…¥æ ‡é¢˜ ä»£è¡¨ 3 åˆ—
    buff.write("éƒ¨é—¨åç§°,ç”¨æˆ·,ç”µè¯");
    // æ¢è¡Œ
    buff.write("\r\n");
    // æ’å…¥ 5 ä¸‡æ¡è®°å½•
    String s = "ä¸­æ–‡æµ‹è¯•";
    for (int i = 0; i < 50000; i++) {
        buff.write(s +  ",zheng,1234567890");
        buff.write("\r\n");
    }
    buff.close();
}
```

ä¸ºå·¨ç¡¬æ„Ÿåˆ°å§”å±ˆ, æ˜æ˜æ˜¯å®ƒå…ˆï¼Œä»€ä¹ˆéƒ½æ˜¯å®ƒå…ˆçš„ï¼ŒVC6 ä¹Ÿå¥½ï¼ŒBOM ä¹Ÿç½¢... ä¸ºä»€ä¹ˆä¸æŒ‰ç…§å®ƒçš„æ¥äº†, æå¾—å®ƒç°åœ¨æƒ³æ”¹éƒ½ä¸è¡Œäº†.... ğŸ˜‚

**æ‰€ä»¥åœ¨ windows ä¸‹, ä¸è¦ç”¨ è®°äº‹æœ¬, ç”¨ sublime text æˆ–è€… vscode.**

æ‰¯è¿œäº†............. ğŸ˜…

2 ä¸ª server é…ç½®, æ²¡æœ‰çœ‹åˆ° zheng-config æ¨¡å—, æ‰€æœ‰è¿™é‡Œåªé…ç½®ä¸€ä¸ªåå‘ä»£ç†

```nginx
#user  nobody;
worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    server {
        listen  9526;
        server_name  localhost;
        location / {
            root   /Users/codeai/Develop/codes/Java/zheng/zheng-ui/zheng-cms-web/;
            index  index.html index.htm;
            add_header Access-Control-Allow-Origin *;
        }
    }
}
```

### å¯åŠ¨æœåŠ¡

å¯åŠ¨ä¹‹å‰ å…ˆ `install` ä¸€ä¸‹

1. zheng-upms-rpc-service
2. zheng-cms-rpc-service
3. zheng-upms-server
4. zheng-cms-admin

![20241229154732_sP9iBIVK.webp](https://cdn.dong4j.site/source/image/20241229154732_sP9iBIVK.webp)
![20241229154732_iLxiIuNt.webp](https://cdn.dong4j.site/source/image/20241229154732_iLxiIuNt.webp)

![20241229154732_JzTMDdjk.webp](https://cdn.dong4j.site/source/image/20241229154732_JzTMDdjk.webp)

## é¡¹ç›®éƒ¨å±

ğŸ˜‚

å¤ªæ™šäº†, åå¤©è¦æ—©å»å»å¤§ç†æ‹å©šçº±ç…§, ç•™ç€åé¢å†™
åªæ˜¯ç…§ç€é¡¹ç›®çš„ readme.md æŠŠç¯å¢ƒæ­å¥½äº†, èƒ½æˆåŠŸè¿è¡Œäº†, é‡Œé¢çš„ä»£ç è¿˜æ²¡çœ‹

åƒè¿™äº›ç¯å¢ƒä¾èµ–, å¤§å®¶å¯ä»¥ä½¿ç”¨ Vagrant æ¥æ­å»º, ä»¥åæ¢ç”µè„‘æˆ–è€…ç»™åˆ«çš„åŒäº‹æ­å»ºç¯å¢ƒ, ä¸¢ä¸€ä¸ªæ–‡ä»¶ç»™ä»–å°± ok äº†.
æˆ–è€…ä½¿ç”¨ docker, è¯´å¾—æˆ‘å¥½åƒä¼šä¸€æ ·.... ğŸ˜‚, è¿˜æ²¡å¼€å§‹çœ‹å‘¢ å“ˆå“ˆ, ä»¥åå¤§å®¶ä¸€èµ·å­¦ä¹ 

**æ„Ÿè°¢ zheng å“¥ç»™æˆ‘ä»¬å¼€æºè¿™ä¹ˆå¥½çš„å­¦ä¹ æ¡†æ¶**

å¦‚æœæˆ‘æ²¡å«é”™çš„è¯, åº”è¯¥å« zheng å“¥å§...

![20241229154732_zO1CRq26.webp](https://cdn.dong4j.site/source/image/20241229154732_zO1CRq26.webp)

![20241229154732_toybalCB.webp](https://cdn.dong4j.site/source/image/20241229154732_toybalCB.webp)

ä¸ºä»€ä¹ˆ 0 ä¸ä»£è¡¨å¥³? è¿™æ ·å¥½è®°å•Š

å‘ Facebook å­¦ä¹ , å¢åŠ  56 ç§æ€§åˆ«, é‚£æ‰å¥½ç© ğŸ˜‚ğŸ˜‚ğŸ˜‚

## [Google Dapperï¼šæ­ç§˜åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿçš„ç§˜å¯†](https://blog.dong4j.site/posts/a69881a6.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

[View project onGitHub](https://github.com/bigbully/Dapper-translation)

### æ¦‚è¿°

å½“ä»£çš„äº’è”ç½‘çš„æœåŠ¡ï¼Œé€šå¸¸éƒ½æ˜¯ç”¨å¤æ‚çš„ã€å¤§è§„æ¨¡åˆ†å¸ƒå¼é›†ç¾¤æ¥å®ç°çš„ã€‚äº’è”ç½‘åº”ç”¨æ„å»ºåœ¨ä¸åŒçš„è½¯ä»¶æ¨¡å—é›†ä¸Šï¼Œè¿™äº›è½¯ä»¶æ¨¡å—ï¼Œæœ‰å¯èƒ½æ˜¯ç”±ä¸åŒçš„å›¢é˜Ÿå¼€å‘ã€å¯èƒ½ä½¿ç”¨ä¸åŒçš„ç¼–ç¨‹è¯­è¨€æ¥å®ç°ã€æœ‰å¯èƒ½å¸ƒåœ¨äº†å‡ åƒå°æœåŠ¡å™¨ï¼Œæ¨ªè·¨å¤šä¸ªä¸åŒçš„æ•°æ®ä¸­å¿ƒã€‚å› æ­¤ï¼Œå°±éœ€è¦ä¸€äº›å¯ä»¥å¸®åŠ©ç†è§£ç³»ç»Ÿè¡Œä¸ºã€ç”¨äºåˆ†ææ€§èƒ½é—®é¢˜çš„å·¥å…·ã€‚

Dapper--Google ç”Ÿäº§ç¯å¢ƒä¸‹çš„åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿï¼Œåº”è¿è€Œç”Ÿã€‚é‚£ä¹ˆæˆ‘ä»¬å°±æ¥ä»‹ç»ä¸€ä¸ªå¤§è§„æ¨¡é›†ç¾¤çš„è·Ÿè¸ªç³»ç»Ÿï¼Œå®ƒæ˜¯å¦‚ä½•æ»¡è¶³ä¸€ä¸ªä½æŸè€—ã€åº”ç”¨é€æ˜çš„ã€å¤§èŒƒå›´éƒ¨ç½²è¿™ä¸‰ä¸ªéœ€æ±‚çš„ã€‚å½“ç„¶
Dapper è®¾è®¡ä¹‹åˆï¼Œå‚è€ƒäº†ä¸€äº›å…¶ä»–åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç†å¿µï¼Œå°¤å…¶æ˜¯ Magpie å’Œ X-Traceï¼Œä½†æ˜¯æˆ‘ä»¬ä¹‹æ‰€ä»¥èƒ½æˆåŠŸåº”ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒä¸Šï¼Œè¿˜éœ€è¦ä¸€äº›ç”»é¾™ç‚¹ç›ä¹‹ç¬”ï¼Œä¾‹å¦‚é‡‡æ ·ç‡çš„ä½¿ç”¨ä»¥åŠæŠŠä»£ç æ¤å…¥é™åˆ¶åœ¨ä¸€å°éƒ¨åˆ†å…¬å…±åº“çš„æ”¹é€ ä¸Šã€‚

è‡ªä» Dapper å‘å±•æˆä¸ºä¸€æµçš„ç›‘æ§ç³»ç»Ÿä¹‹åï¼Œç»™å…¶ä»–åº”ç”¨çš„å¼€å‘è€…å’Œè¿ç»´å›¢é˜Ÿå¸®äº†å¤§å¿™ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»Šå¤©æ‰å‘è¡¨è¿™ç¯‡è®ºæ–‡ï¼Œæ¥æ±‡æŠ¥ä¸€ä¸‹è¿™ä¸¤å¹´æ¥ï¼ŒDapper
æ˜¯æ€ä¹ˆæ„å»ºå’Œéƒ¨ç½²çš„ã€‚Dapper æœ€åˆåªæ˜¯ä½œä¸ºä¸€ä¸ªè‡ªç»™è‡ªè¶³çš„ç›‘æ§å·¥å…·èµ·æ­¥çš„ï¼Œä½†æœ€ç»ˆè¿›åŒ–æˆä¸€ä¸ªç›‘æ§å¹³å°ï¼Œè¿™ä¸ªç›‘æ§å¹³å°ä¿ƒç”Ÿå‡ºå¤šç§å¤šæ ·çš„ç›‘æ§å·¥å…·ï¼Œæœ‰äº›ç”šè‡³å·²ç»ä¸æ˜¯ç”±
Dapper å›¢é˜Ÿå¼€å‘çš„äº†ã€‚ä¸‹é¢æˆ‘ä»¬ä¼šä»‹ç»ä¸€äº›ä½¿ç”¨ Dapper æ­å»ºçš„åˆ†æå·¥å…·ï¼Œåˆ†äº«ä¸€ä¸‹è¿™äº›å·¥å…·åœ¨ google å†…éƒ¨ä½¿ç”¨çš„ç»Ÿè®¡æ•°æ®ï¼Œå±•ç°ä¸€äº›ä½¿ç”¨åœºæ™¯ï¼Œæœ€åä¼šè®¨è®ºä¸€ä¸‹æˆ‘ä»¬è¿„ä»Šä¸ºæ­¢ä»
Dapper æ”¶è·äº†äº›ä»€ä¹ˆã€‚

### 1. ä»‹ç»

æˆ‘ä»¬å¼€å‘ Dapper æ˜¯ä¸ºäº†æ”¶é›†æ›´å¤šçš„å¤æ‚åˆ†å¸ƒå¼ç³»ç»Ÿçš„è¡Œä¸ºä¿¡æ¯ï¼Œç„¶åå‘ˆç°ç»™ Google
çš„å¼€å‘è€…ä»¬ã€‚è¿™æ ·çš„åˆ†å¸ƒå¼ç³»ç»Ÿæœ‰ä¸€ä¸ªç‰¹æ®Šçš„å¥½å¤„ï¼Œå› ä¸ºé‚£äº›å¤§è§„æ¨¡çš„ä½ç«¯æœåŠ¡å™¨ï¼Œä½œä¸ºäº’è”ç½‘æœåŠ¡çš„è½½ä½“ï¼Œæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç»æµåˆ’ç®—çš„å¹³å°ã€‚æƒ³è¦åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­ç†è§£åˆ†å¸ƒå¼ç³»ç»Ÿçš„è¡Œä¸ºï¼Œå°±éœ€è¦ç›‘æ§é‚£äº›æ¨ªè·¨äº†ä¸åŒçš„åº”ç”¨ã€ä¸åŒçš„æœåŠ¡å™¨ä¹‹é—´çš„å…³è”åŠ¨ä½œã€‚

ä¸‹é¢ä¸¾ä¸€ä¸ªè·Ÿæœç´¢ç›¸å…³çš„ä¾‹å­ï¼Œè¿™ä¸ªä¾‹å­é˜è¿°äº† Dapper å¯ä»¥åº”å¯¹å“ªäº›æŒ‘æˆ˜ã€‚æ¯”å¦‚ä¸€ä¸ªå‰æ®µæœåŠ¡å¯èƒ½å¯¹ä¸Šç™¾å°æŸ¥è¯¢æœåŠ¡å™¨å‘èµ·äº†ä¸€ä¸ª Web æŸ¥è¯¢ï¼Œæ¯ä¸€ä¸ªæŸ¥è¯¢éƒ½æœ‰è‡ªå·±çš„
Indexã€‚è¿™ä¸ªæŸ¥è¯¢å¯èƒ½ä¼šè¢«å‘é€åˆ°å¤šä¸ªçš„å­ç³»ç»Ÿï¼Œè¿™äº›å­ç³»ç»Ÿåˆ†åˆ«ç”¨æ¥å¤„ç†å¹¿å‘Šã€è¿›è¡Œæ‹¼å†™æ£€æŸ¥æˆ–æ˜¯æŸ¥æ‰¾ä¸€äº›åƒå›¾ç‰‡ã€è§†é¢‘æˆ–æ–°é—»è¿™æ ·çš„ç‰¹æ®Šç»“æœã€‚æ ¹æ®æ¯ä¸ªå­ç³»ç»Ÿçš„æŸ¥è¯¢ç»“æœè¿›è¡Œç­›é€‰ï¼Œå¾—åˆ°æœ€ç»ˆç»“æœï¼Œæœ€åæ±‡æ€»åˆ°é¡µé¢ä¸Šã€‚æˆ‘ä»¬æŠŠè¿™ç§æœç´¢æ¨¡å‹ç§°ä¸º
â€œå…¨å±€æœç´¢â€ï¼ˆuniversal
searchï¼‰ã€‚æ€»çš„æ¥è¯´ï¼Œè¿™ä¸€æ¬¡å…¨å±€æœç´¢æœ‰å¯èƒ½è°ƒç”¨ä¸Šåƒå°æœåŠ¡å™¨ï¼Œæ¶‰åŠå„ç§æœåŠ¡ã€‚è€Œä¸”ï¼Œç”¨æˆ·å¯¹æœç´¢çš„è€—æ—¶æ˜¯å¾ˆæ•æ„Ÿçš„ï¼Œè€Œä»»ä½•ä¸€ä¸ªå­ç³»ç»Ÿçš„ä½æ•ˆéƒ½å¯¼è‡´å¯¼è‡´æœ€ç»ˆçš„æœç´¢è€—æ—¶ã€‚å¦‚æœä¸€ä¸ªå·¥ç¨‹å¸ˆåªèƒ½çŸ¥é“è¿™ä¸ªæŸ¥è¯¢è€—æ—¶ä¸æ­£å¸¸ï¼Œä½†æ˜¯ä»–æ— ä»çŸ¥æ™“è¿™ä¸ªé—®é¢˜åˆ°åº•æ˜¯ç”±å“ªä¸ªæœåŠ¡è°ƒç”¨é€ æˆçš„ï¼Œæˆ–è€…ä¸ºä»€ä¹ˆè¿™ä¸ªè°ƒç”¨æ€§èƒ½å·®å¼ºäººæ„ã€‚é¦–å…ˆï¼Œè¿™ä¸ªå·¥ç¨‹å¸ˆå¯èƒ½æ— æ³•å‡†ç¡®çš„å®šä½åˆ°è¿™æ¬¡å…¨å±€æœç´¢æ˜¯è°ƒç”¨äº†å“ªäº›æœåŠ¡ï¼Œå› ä¸ºæ–°çš„æœåŠ¡ã€ä¹ƒè‡³æœåŠ¡ä¸Šçš„æŸä¸ªç‰‡æ®µï¼Œéƒ½æœ‰å¯èƒ½åœ¨ä»»ä½•æ—¶é—´ä¸Šè¿‡çº¿æˆ–ä¿®æ”¹è¿‡ï¼Œæœ‰å¯èƒ½æ˜¯é¢å‘ç”¨æˆ·åŠŸèƒ½ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸€äº›ä¾‹å¦‚é’ˆå¯¹æ€§èƒ½æˆ–å®‰å…¨è®¤è¯æ–¹é¢çš„åŠŸèƒ½æ”¹è¿›ã€‚å…¶æ¬¡ï¼Œä½ ä¸èƒ½è‹›æ±‚è¿™ä¸ªå·¥ç¨‹å¸ˆå¯¹æ‰€æœ‰å‚ä¸è¿™æ¬¡å…¨å±€æœç´¢çš„æœåŠ¡éƒ½äº†å¦‚æŒ‡æŒï¼Œæ¯ä¸€ä¸ªæœåŠ¡éƒ½æœ‰å¯èƒ½æ˜¯ç”±ä¸åŒçš„å›¢é˜Ÿå¼€å‘æˆ–ç»´æŠ¤çš„ã€‚å†æ¬¡ï¼Œè¿™äº›æš´éœ²å‡ºæ¥çš„æœåŠ¡æˆ–æœåŠ¡å™¨æœ‰å¯èƒ½åŒæ—¶è¿˜è¢«å…¶ä»–å®¢æˆ·ç«¯ä½¿ç”¨ç€ï¼Œæ‰€ä»¥è¿™æ¬¡å…¨å±€æœç´¢çš„æ€§èƒ½é—®é¢˜ç”šè‡³æœ‰å¯èƒ½æ˜¯ç”±å…¶ä»–åº”ç”¨é€ æˆçš„ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä¸€ä¸ªåå°æœåŠ¡å¯èƒ½è¦åº”ä»˜å„ç§å„æ ·çš„è¯·æ±‚ç±»å‹ï¼Œè€Œä¸€ä¸ªä½¿ç”¨æ•ˆç‡å¾ˆé«˜çš„å­˜å‚¨ç³»ç»Ÿï¼Œæ¯”å¦‚
Bigtableï¼Œæœ‰å¯èƒ½æ­£è¢«åå¤è¯»å†™ç€ï¼Œå› ä¸ºä¸Šé¢è·‘ç€å„ç§å„æ ·çš„åº”ç”¨ã€‚

ä¸Šé¢è¿™ä¸ªæ¡ˆä¾‹ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¯¹ Dapper æˆ‘ä»¬åªæœ‰ä¸¤ç‚¹è¦æ±‚ï¼šæ— æ‰€ä¸åœ¨çš„éƒ¨ç½²ï¼ŒæŒç»­çš„ç›‘æ§ã€‚æ— æ‰€ä¸åœ¨çš„é‡è¦æ€§ä¸è¨€è€Œå–»ï¼Œå› ä¸ºåœ¨ä½¿ç”¨è·Ÿè¸ªç³»ç»Ÿçš„è¿›è¡Œç›‘æ§æ—¶ï¼Œå³ä¾¿åªæœ‰ä¸€å°éƒ¨åˆ†æ²¡è¢«ç›‘æ§åˆ°ï¼Œé‚£ä¹ˆäººä»¬å¯¹è¿™ä¸ªç³»ç»Ÿæ˜¯ä¸æ˜¯å€¼å¾—ä¿¡ä»»éƒ½ä¼šäº§ç”Ÿå·¨å¤§çš„è´¨ç–‘ã€‚å¦å¤–ï¼Œç›‘æ§åº”è¯¥æ˜¯
7x24 å°æ—¶çš„ï¼Œæ¯•ç«Ÿï¼Œç³»ç»Ÿå¼‚å¸¸æˆ–æ˜¯é‚£äº›é‡è¦çš„ç³»ç»Ÿè¡Œä¸ºæœ‰å¯èƒ½å‡ºç°è¿‡ä¸€æ¬¡ï¼Œå°±å¾ˆéš¾ç”šè‡³ä¸å¤ªå¯èƒ½é‡ç°ã€‚é‚£ä¹ˆï¼Œæ ¹æ®è¿™ä¸¤ä¸ªæ˜ç¡®çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ¨å‡ºä¸‰ä¸ªå…·ä½“çš„è®¾è®¡ç›®æ ‡ï¼š

1. ä½æ¶ˆè€—ï¼šè·Ÿè¸ªç³»ç»Ÿå¯¹åœ¨çº¿æœåŠ¡çš„å½±å“åº”è¯¥åšåˆ°è¶³å¤Ÿå°ã€‚åœ¨ä¸€äº›é«˜åº¦ä¼˜åŒ–è¿‡çš„æœåŠ¡ï¼Œå³ä½¿ä¸€ç‚¹ç‚¹æŸè€—ä¹Ÿä¼šå¾ˆå®¹æ˜“å¯Ÿè§‰åˆ°ï¼Œè€Œä¸”æœ‰å¯èƒ½è¿«ä½¿åœ¨çº¿æœåŠ¡çš„éƒ¨ç½²å›¢é˜Ÿä¸å¾—ä¸å°†è·Ÿè¸ªç³»ç»Ÿå…³åœã€‚
2. åº”ç”¨çº§çš„é€æ˜ï¼šå¯¹äºåº”ç”¨çš„ç¨‹åºå‘˜æ¥è¯´ï¼Œæ˜¯ä¸éœ€è¦çŸ¥é“æœ‰è·Ÿè¸ªç³»ç»Ÿè¿™å›äº‹çš„ã€‚å¦‚æœä¸€ä¸ªè·Ÿè¸ªç³»ç»Ÿæƒ³ç”Ÿæ•ˆï¼Œå°±å¿…é¡»éœ€è¦ä¾èµ–åº”ç”¨çš„å¼€å‘è€…ä¸»åŠ¨é…åˆï¼Œé‚£ä¹ˆè¿™ä¸ªè·Ÿè¸ªç³»ç»Ÿä¹Ÿå¤ªè„†å¼±äº†ï¼Œå¾€å¾€ç”±äºè·Ÿè¸ªç³»ç»Ÿåœ¨åº”ç”¨ä¸­æ¤å…¥ä»£ç çš„
   bug æˆ–ç–å¿½å¯¼è‡´åº”ç”¨å‡ºé—®é¢˜ï¼Œè¿™æ ·æ‰æ˜¯æ— æ³•æ»¡è¶³å¯¹è·Ÿè¸ªç³»ç»Ÿ â€œæ— æ‰€ä¸åœ¨çš„éƒ¨ç½²â€ è¿™ä¸ªéœ€æ±‚ã€‚é¢å¯¹å½“ä¸‹æƒ³ Google è¿™æ ·çš„å¿«èŠ‚å¥çš„å¼€å‘ç¯å¢ƒæ¥è¯´ï¼Œå°¤å…¶é‡è¦ã€‚
3. å»¶å±•æ€§ï¼šGoogle è‡³å°‘åœ¨æœªæ¥å‡ å¹´çš„æœåŠ¡å’Œé›†ç¾¤çš„è§„æ¨¡ï¼Œç›‘æ§ç³»ç»Ÿéƒ½åº”è¯¥èƒ½å®Œå…¨æŠŠæ§ä½ã€‚

ä¸€ä¸ªé¢å¤–çš„è®¾è®¡ç›®æ ‡æ˜¯ä¸ºè·Ÿè¸ªæ•°æ®äº§ç”Ÿä¹‹åï¼Œè¿›è¡Œåˆ†æçš„é€Ÿåº¦è¦å¿«ï¼Œç†æƒ³æƒ…å†µæ˜¯æ•°æ®å­˜å…¥è·Ÿè¸ªä»“åº“åä¸€åˆ†é’Ÿå†…å°±èƒ½ç»Ÿè®¡å‡ºæ¥ã€‚å°½ç®¡è·Ÿè¸ªç³»ç»Ÿå¯¹ä¸€å°æ—¶å‰çš„æ—§æ•°æ®è¿›è¡Œç»Ÿè®¡ä¹Ÿæ˜¯ç›¸å½“æœ‰ä»·å€¼çš„ï¼Œä½†å¦‚æœè·Ÿè¸ªç³»ç»Ÿèƒ½æä¾›è¶³å¤Ÿå¿«çš„ä¿¡æ¯åé¦ˆï¼Œå°±å¯ä»¥å¯¹ç”Ÿäº§ç¯å¢ƒä¸‹çš„å¼‚å¸¸çŠ¶å†µåšå‡ºå¿«é€Ÿååº”ã€‚

åšåˆ°çœŸæ­£çš„åº”ç”¨çº§åˆ«çš„é€æ˜ï¼Œè¿™åº”è¯¥æ˜¯å½“ä¸‹é¢ä¸´çš„æœ€æŒ‘æˆ˜æ€§çš„è®¾è®¡ç›®æ ‡ï¼Œæˆ‘ä»¬æŠŠæ ¸å¿ƒè·Ÿè¸ªä»£ç åšçš„å¾ˆè½»å·§ï¼Œç„¶åæŠŠå®ƒæ¤å…¥åˆ°é‚£äº›æ— æ‰€ä¸åœ¨çš„å…¬å…±ç»„ä»¶ç§ï¼Œæ¯”å¦‚çº¿ç¨‹è°ƒç”¨ã€æ§åˆ¶æµä»¥åŠ
RPC åº“ã€‚ä½¿ç”¨è‡ªé€‚åº”çš„é‡‡æ ·ç‡å¯ä»¥ä½¿è·Ÿè¸ªç³»ç»Ÿå˜å¾—å¯ä¼¸ç¼©ï¼Œå¹¶é™ä½æ€§èƒ½æŸè€—ï¼Œè¿™äº›å†…å®¹å°†åœ¨ç¬¬ 4.4
èŠ‚ä¸­æåŠã€‚ç»“æœå±•ç¤ºçš„ç›¸å…³ç³»ç»Ÿä¹Ÿéœ€è¦åŒ…å«ä¸€äº›ç”¨æ¥æ”¶é›†è·Ÿè¸ªæ•°æ®çš„ä»£ç ï¼Œç”¨æ¥å›¾å½¢åŒ–çš„å·¥å…·ï¼Œä»¥åŠç”¨æ¥åˆ†æå¤§è§„æ¨¡è·Ÿè¸ªæ•°æ®çš„åº“å’Œ APIã€‚è™½ç„¶å•ç‹¬ä½¿ç”¨ Dapper
æœ‰æ—¶å°±è¶³å¤Ÿè®©å¼€å‘äººå‘˜æŸ¥æ˜å¼‚å¸¸çš„æ¥æºï¼Œä½†æ˜¯ Dapper çš„åˆè¡·ä¸æ˜¯è¦å–ä»£æ‰€æœ‰å…¶ä»–ç›‘æ§çš„å·¥å…·ã€‚æˆ‘ä»¬å‘ç°ï¼ŒDapper çš„æ•°æ®å¾€å¾€ä¾§é‡æ€§èƒ½æ–¹é¢çš„è°ƒæŸ¥ï¼Œæ‰€ä»¥å…¶ä»–ç›‘æ§å·¥å…·ä¹Ÿæœ‰ä»–ä»¬å„è‡ªçš„ç”¨å¤„ã€‚

## 1.1 æ–‡çŒ®çš„æ€»ç»“

åˆ†å¸ƒå¼ç³»ç»Ÿè·Ÿè¸ªå·¥å…·çš„è®¾è®¡ç©ºé—´å·²ç»è¢«ä¸€äº›ä¼˜ç§€æ–‡ç« æ¢ç´¢è¿‡äº†ï¼Œå…¶ä¸­çš„ Pinpoint[9]ã€Magpie[3] å’Œ X-Trace[12] å’Œ Dapper
æœ€ä¸ºç›¸è¿‘ã€‚è¿™äº›ç³»ç»Ÿåœ¨å…¶å‘å±•è¿‡ç¨‹çš„æ—©æœŸå€¾å‘äºå†™å…¥ç ”ç©¶æŠ¥å‘Šä¸­ï¼Œå³ä¾¿ä»–ä»¬è¿˜æ²¡æ¥å¾—åŠæ¸…æ¥šåœ°è¯„ä¼°ç³»ç»Ÿå½“ä¸­ä¸€äº›è®¾è®¡çš„é‡è¦æ€§ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œç”±äº Dapper
å·²ç»åœ¨å¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒä¸­æ‘¸çˆ¬æ»šæ‰“äº†å¤šå¹´ï¼Œç»è¿‡è¿™ä¹ˆå¤šç”Ÿäº§ç¯å¢ƒçš„éªŒè¯ä¹‹åï¼Œæˆ‘ä»¬è®¤ä¸ºè¿™ç¯‡è®ºæ–‡æœ€é€‚åˆé‡ç‚¹é˜è¿°åœ¨éƒ¨ç½² Dapper
çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬æœ‰é‚£äº›æ”¶è·ï¼Œæˆ‘ä»¬çš„è®¾è®¡æ€æƒ³æ˜¯å¦‚ä½•å†³å®šçš„ï¼Œä»¥åŠä»¥ä»€ä¹ˆæ ·çš„æ–¹å¼å®ç°å®ƒæ‰ä¼šæœ€æœ‰ç”¨ã€‚Dappe ä½œä¸ºä¸€ä¸ªå¹³å°ï¼Œæ‰¿è½½åŸºäº Dapper å¼€å‘çš„æ€§èƒ½åˆ†æå·¥å…·ï¼Œä»¥åŠ
Dapper è‡ªèº«çš„ç›‘æµ‹å·¥å…·ï¼Œå®ƒçš„ä»·å€¼åœ¨äºæˆ‘ä»¬å¯ä»¥åœ¨å›é¡¾è¯„ä¼°ä¸­æ‰¾å‡ºä¸€äº›æ„æƒ³ä¸åˆ°çš„ç»“æœã€‚

è™½ç„¶ Dapper åœ¨è®¸å¤šé«˜é˜¶çš„è®¾è®¡æ€æƒ³ä¸Šå¸å–äº† Pinpoint å’Œ Magpie çš„ç ”ç©¶æˆæœï¼Œä½†åœ¨åˆ†å¸ƒå¼è·Ÿè¸ªè¿™ä¸ªé¢†åŸŸä¸­ï¼ŒDapper
çš„å®ç°åŒ…å«äº†è®¸å¤šæ–°çš„è´¡çŒ®ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬æƒ³å®ç°ä½æŸè€—çš„è¯ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜åº¦ä¼˜åŒ–çš„è€Œä¸”è¶‹äºæç«¯å»¶è¿Ÿæ•æ„Ÿçš„ Web æœåŠ¡ä¸­ï¼Œé‡‡æ ·ç‡æ˜¯å¾ˆå¿…è¦çš„ã€‚æˆ–è®¸æ›´ä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œæˆ‘ä»¬å‘ç°å³ä¾¿æ˜¯
1/1000 çš„é‡‡æ ·ç‡ï¼Œå¯¹äºè·Ÿè¸ªæ•°æ®çš„é€šç”¨ä½¿ç”¨å±‚é¢ä¸Šï¼Œä¹Ÿå¯ä»¥æä¾›è¶³å¤Ÿå¤šçš„ä¿¡æ¯ã€‚

æˆ‘ä»¬çš„ç³»ç»Ÿçš„å¦ä¸€ä¸ªé‡è¦çš„ç‰¹å¾ï¼Œå°±æ˜¯æˆ‘ä»¬èƒ½å®ç°çš„åº”ç”¨çº§çš„é€æ˜ã€‚æˆ‘ä»¬çš„ç»„ä»¶å¯¹åº”ç”¨çš„ä¾µå…¥è¢«å…ˆé™åˆ¶åœ¨è¶³å¤Ÿä½çš„æ°´å¹³ä¸Šï¼Œå³ä½¿æƒ³ Google
ç½‘é¡µæœç´¢è¿™ä¹ˆå¤§è§„æ¨¡çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¿›è¡Œè·Ÿè¸ªè€Œæ— éœ€åŠ å…¥é¢å¤–çš„æ ‡æ³¨ (Annotation)
ã€‚è™½ç„¶ç”±äºæˆ‘ä»¬çš„éƒ¨ç½²ç³»ç»Ÿæœ‰å¹¸æ˜¯ä¸€å®šç¨‹åº¦çš„åŒè´¨åŒ–çš„ï¼Œæ‰€ä»¥æ›´å®¹æ˜“åšåˆ°å¯¹åº”ç”¨å±‚çš„é€æ˜è¿™ç‚¹ï¼Œä½†æ˜¯æˆ‘ä»¬è¯æ˜äº†è¿™æ˜¯å®ç°è¿™ç§ç¨‹åº¦çš„é€æ˜æ€§çš„å……åˆ†æ¡ä»¶ã€‚

## 2. Dapper çš„åˆ†å¸ƒå¼è·Ÿè¸ª

![20241229154732_Sz5MQBI6.webp](https://cdn.dong4j.site/source/image/20241229154732_Sz5MQBI6.webp)

å›¾ 1ï¼šè¿™ä¸ªè·¯å¾„ç”±ç”¨æˆ·çš„ X è¯·æ±‚å‘èµ·ï¼Œç©¿è¿‡ä¸€ä¸ªç®€å•çš„æœåŠ¡ç³»ç»Ÿã€‚ç”¨å­—æ¯æ ‡è¯†çš„èŠ‚ç‚¹ä»£è¡¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ä¸åŒå¤„ç†è¿‡ç¨‹ã€‚

åˆ†å¸ƒå¼æœåŠ¡çš„è·Ÿè¸ªç³»ç»Ÿéœ€è¦è®°å½•åœ¨ä¸€æ¬¡ç‰¹å®šçš„è¯·æ±‚åç³»ç»Ÿä¸­å®Œæˆçš„æ‰€æœ‰å·¥ä½œçš„ä¿¡æ¯ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå›¾ 1 å±•ç°çš„æ˜¯ä¸€ä¸ªå’Œ 5 å°æœåŠ¡å™¨ç›¸å…³çš„ä¸€ä¸ªæœåŠ¡ï¼ŒåŒ…æ‹¬ï¼šå‰ç«¯ï¼ˆAï¼‰ï¼Œä¸¤ä¸ªä¸­é—´å±‚ï¼ˆB
å’Œ Cï¼‰ï¼Œä»¥åŠä¸¤ä¸ªåç«¯ï¼ˆD å’Œ Eï¼‰ã€‚å½“ä¸€ä¸ªç”¨æˆ·ï¼ˆè¿™ä¸ªç”¨ä¾‹çš„å‘èµ·äººï¼‰å‘èµ·ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œé¦–å…ˆåˆ°è¾¾å‰ç«¯ï¼Œç„¶åå‘é€ä¸¤ä¸ª RPC åˆ°æœåŠ¡å™¨ B å’Œ Cã€‚B ä¼šé©¬ä¸Šåšå‡ºååº”ï¼Œä½†æ˜¯ C
éœ€è¦å’Œåç«¯çš„ D å’Œ E äº¤äº’ä¹‹åå†è¿”è¿˜ç»™ Aï¼Œç”± A
æ¥å“åº”æœ€åˆçš„è¯·æ±‚ã€‚å¯¹äºè¿™æ ·ä¸€ä¸ªè¯·æ±‚ï¼Œç®€å•å®ç”¨çš„åˆ†å¸ƒå¼è·Ÿè¸ªçš„å®ç°ï¼Œå°±æ˜¯ä¸ºæœåŠ¡å™¨ä¸Šæ¯ä¸€æ¬¡ä½ å‘é€å’Œæ¥æ”¶åŠ¨ä½œæ¥æ”¶é›†è·Ÿè¸ªæ ‡è¯†ç¬¦ (message identifiers)
å’Œæ—¶é—´æˆ³ (timestamped events)ã€‚

ä¸ºäº†å°†æ‰€æœ‰è®°å½•æ¡ç›®ä¸ä¸€ä¸ªç»™å®šçš„å‘èµ·è€…ï¼ˆä¾‹å¦‚ï¼Œå›¾ 1 ä¸­çš„ RequestXï¼‰å…³è”ä¸Šå¹¶è®°å½•æ‰€æœ‰ä¿¡æ¯ï¼Œç°åœ¨æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œé»‘ç›’ (black-box) å’ŒåŸºäºæ ‡æ³¨ (
annotation-based) çš„ç›‘æ§æ–¹æ¡ˆã€‚é»‘ç›’æ–¹æ¡ˆ [1ï¼Œ15ï¼Œ2]
å‡å®šéœ€è¦è·Ÿè¸ªçš„é™¤äº†ä¸Šè¿°ä¿¡æ¯ä¹‹å¤–æ²¡æœ‰é¢å¤–çš„ä¿¡æ¯ï¼Œè¿™æ ·ä½¿ç”¨ç»Ÿè®¡å›å½’æŠ€æœ¯æ¥æ¨æ–­ä¸¤è€…ä¹‹é—´çš„å…³ç³»ã€‚åŸºäºæ ‡æ³¨çš„æ–¹æ¡ˆ [3ï¼Œ12ï¼Œ9ï¼Œ16] ä¾èµ–äºåº”ç”¨ç¨‹åºæˆ–ä¸­é—´ä»¶æ˜ç¡®åœ°æ ‡è®°ä¸€ä¸ªå…¨å±€
IDï¼Œä»è€Œè¿æ¥æ¯ä¸€æ¡è®°å½•å’Œå‘èµ·è€…çš„è¯·æ±‚ã€‚è™½ç„¶é»‘ç›’æ–¹æ¡ˆæ¯”æ ‡æ³¨æ–¹æ¡ˆæ›´è½»ä¾¿ï¼Œä»–ä»¬éœ€è¦æ›´å¤šçš„æ•°æ®ï¼Œä»¥è·å¾—è¶³å¤Ÿçš„ç²¾åº¦ï¼Œå› ä¸ºä»–ä»¬ä¾èµ–äºç»Ÿè®¡æ¨è®ºã€‚åŸºäºæ ‡æ³¨çš„æ–¹æ¡ˆæœ€ä¸»è¦çš„ç¼ºç‚¹æ˜¯ï¼Œå¾ˆæ˜æ˜¾ï¼Œéœ€è¦ä»£ç æ¤å…¥ã€‚åœ¨æˆ‘ä»¬çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå› ä¸ºæ‰€æœ‰çš„åº”ç”¨ç¨‹åºéƒ½ä½¿ç”¨ç›¸åŒçš„çº¿ç¨‹æ¨¡å‹ï¼Œæ§åˆ¶æµå’Œ
RPC ç³»ç»Ÿï¼Œæˆ‘ä»¬å‘ç°ï¼Œå¯ä»¥æŠŠä»£ç æ¤å…¥é™åˆ¶åœ¨ä¸€ä¸ªå¾ˆå°çš„é€šç”¨ç»„ä»¶åº“ä¸­ï¼Œä»è€Œå®ç°äº†ç›‘æµ‹ç³»ç»Ÿçš„åº”ç”¨å¯¹å¼€å‘äººå‘˜æ˜¯æœ‰æ•ˆåœ°é€æ˜ã€‚

æˆ‘ä»¬å€¾å‘äºè®¤ä¸ºï¼ŒDapper çš„è·Ÿè¸ªæ¶æ„åƒæ˜¯å†…åµŒåœ¨ RPC è°ƒç”¨çš„æ ‘å½¢ç»“æ„ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬çš„æ ¸å¿ƒæ•°æ®æ¨¡å‹ä¸åªå±€é™äºæˆ‘ä»¬çš„ç‰¹å®šçš„ RPC æ¡†æ¶ï¼Œæˆ‘ä»¬è¿˜èƒ½è·Ÿè¸ªå…¶ä»–è¡Œä¸ºï¼Œä¾‹å¦‚
Gmail çš„ SMTP ä¼šè¯ï¼Œå¤–ç•Œçš„ HTTP è¯·æ±‚ï¼Œå’Œå¤–éƒ¨å¯¹ SQL æœåŠ¡å™¨çš„æŸ¥è¯¢ç­‰ã€‚ä»å½¢å¼ä¸Šçœ‹ï¼Œæˆ‘ä»¬çš„ Dapper è·Ÿè¸ªæ¨¡å‹ä½¿ç”¨çš„æ ‘å½¢ç»“æ„ï¼ŒSpan ä»¥åŠ Annotationã€‚

## 2.1 è·Ÿè¸ªæ ‘å’Œ span

åœ¨ Dapper è·Ÿè¸ªæ ‘ç»“æ„ä¸­ï¼Œæ ‘èŠ‚ç‚¹æ˜¯æ•´ä¸ªæ¶æ„çš„åŸºæœ¬å•å…ƒï¼Œè€Œæ¯ä¸€ä¸ªèŠ‚ç‚¹åˆæ˜¯å¯¹ span çš„å¼•ç”¨ã€‚èŠ‚ç‚¹ä¹‹é—´çš„è¿çº¿è¡¨ç¤ºçš„ span å’Œå®ƒçš„çˆ¶ span ç›´æ¥çš„å…³ç³»ã€‚è™½ç„¶
span åœ¨æ—¥å¿—æ–‡ä»¶ä¸­åªæ˜¯ç®€å•çš„ä»£è¡¨ span çš„å¼€å§‹å’Œç»“æŸæ—¶é—´ï¼Œä»–ä»¬åœ¨æ•´ä¸ªæ ‘å½¢ç»“æ„ä¸­å´æ˜¯ç›¸å¯¹ç‹¬ç«‹çš„ï¼Œä»»ä½• RPC ç›¸å…³çš„æ—¶é—´æ•°æ®ã€é›¶ä¸ªæˆ–å¤šä¸ªç‰¹å®šåº”ç”¨ç¨‹åºçš„
Annotation çš„ç›¸å…³å†…å®¹ä¼šåœ¨ 2.3 èŠ‚ä¸­è®¨è®ºã€‚

![20241229154732_HfF91uBJ.webp](https://cdn.dong4j.site/source/image/20241229154732_HfF91uBJ.webp)

å›¾ 2ï¼š5 ä¸ª span åœ¨ Dapper è·Ÿè¸ªæ ‘ç§çŸ­æš‚çš„å…³è”å…³ç³»

åœ¨å›¾ 2 ä¸­è¯´æ˜äº† span åœ¨ä¸€ä¸ªå¤§çš„è·Ÿè¸ªè¿‡ç¨‹ä¸­æ˜¯ä»€ä¹ˆæ ·çš„ã€‚Dapper è®°å½•äº† span åç§°ï¼Œä»¥åŠæ¯ä¸ª span çš„ ID å’Œçˆ¶ IDï¼Œä»¥é‡å»ºåœ¨ä¸€æ¬¡è¿½è¸ªè¿‡ç¨‹ä¸­ä¸åŒ span
ä¹‹é—´çš„å…³ç³»ã€‚å¦‚æœä¸€ä¸ª span æ²¡æœ‰çˆ¶ ID è¢«ç§°ä¸º root spanã€‚æ‰€æœ‰ span éƒ½æŒ‚åœ¨ä¸€ä¸ªç‰¹å®šçš„è·Ÿè¸ªä¸Šï¼Œä¹Ÿå…±ç”¨ä¸€ä¸ªè·Ÿè¸ª idï¼ˆåœ¨å›¾ä¸­æœªç¤ºå‡ºï¼‰ã€‚æ‰€æœ‰è¿™äº› ID ç”¨å…¨å±€å”¯ä¸€çš„
64 ä½æ•´æ•°æ ‡ç¤ºã€‚åœ¨ä¸€ä¸ªå…¸å‹çš„ Dapper è·Ÿè¸ªä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸ºæ¯ä¸€ä¸ª RPC å¯¹åº”åˆ°ä¸€ä¸ªå•ä¸€çš„ span ä¸Šï¼Œè€Œä¸”æ¯ä¸€ä¸ªé¢å¤–çš„ç»„ä»¶å±‚éƒ½å¯¹åº”ä¸€ä¸ªè·Ÿè¸ªæ ‘å‹ç»“æ„çš„å±‚çº§ã€‚

![20241229154732_XFQ7JCFQ.webp](https://cdn.dong4j.site/source/image/20241229154732_XFQ7JCFQ.webp)

å›¾ 3ï¼šåœ¨å›¾ 2 ä¸­æ‰€ç¤ºçš„ä¸€ä¸ªå•ç‹¬çš„ span çš„ç»†èŠ‚å›¾

å›¾ 3 ç»™å‡ºäº†ä¸€ä¸ªæ›´è¯¦ç»†çš„å…¸å‹çš„ Dapper è·Ÿè¸ª span çš„è®°å½•ç‚¹çš„è§†å›¾ã€‚åœ¨å›¾ 2 ä¸­è¿™ç§æŸä¸ª span è¡¨è¿°äº†ä¸¤ä¸ª â€œHelper.Callâ€ çš„ RPC(åˆ†åˆ«ä¸º server ç«¯å’Œ
client ç«¯)ã€‚span çš„å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´ï¼Œä»¥åŠä»»ä½• RPC çš„æ—¶é—´ä¿¡æ¯éƒ½é€šè¿‡ Dapper åœ¨ RPC ç»„ä»¶åº“çš„æ¤å…¥è®°å½•ä¸‹æ¥ã€‚å¦‚æœåº”ç”¨ç¨‹åºå¼€å‘è€…é€‰æ‹©åœ¨è·Ÿè¸ªä¸­å¢åŠ ä»–ä»¬è‡ªå·±çš„æ³¨é‡Šï¼ˆå¦‚å›¾ä¸­
â€œfooâ€ çš„æ³¨é‡Šï¼‰(ä¸šåŠ¡æ•°æ®)ï¼Œè¿™äº›ä¿¡æ¯ä¹Ÿä¼šå’Œå…¶ä»– span ä¿¡æ¯ä¸€æ ·è®°å½•ä¸‹æ¥ã€‚

è®°ä½ï¼Œä»»ä½•ä¸€ä¸ª span å¯ä»¥åŒ…å«æ¥è‡ªä¸åŒçš„ä¸»æœºä¿¡æ¯ï¼Œè¿™äº›ä¹Ÿè¦è®°å½•ä¸‹æ¥ã€‚äº‹å®ä¸Šï¼Œæ¯ä¸€ä¸ª RPC span å¯ä»¥åŒ…å«å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¸¤ä¸ªè¿‡ç¨‹çš„æ³¨é‡Šï¼Œä½¿å¾—é“¾æ¥ä¸¤ä¸ªä¸»æœºçš„
span ä¼šæˆä¸ºæ¨¡å‹ä¸­æ‰€è¯´çš„ spanã€‚ç”±äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¸Šçš„æ—¶é—´æˆ³æ¥è‡ªä¸åŒçš„ä¸»æœºï¼Œæˆ‘ä»¬å¿…é¡»è€ƒè™‘åˆ°æ—¶é—´åå·®ã€‚åœ¨æˆ‘ä»¬çš„åˆ†æå·¥å…·ï¼Œæˆ‘ä»¬åˆ©ç”¨äº†è¿™ä¸ªäº‹å®ï¼šRPC
å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªè¯·æ±‚ä¹‹åï¼ŒæœåŠ¡å™¨ç«¯æ‰èƒ½æ¥æ”¶åˆ°ï¼Œå¯¹äºå“åº”ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼ˆæœåŠ¡å™¨å…ˆå“åº”ï¼Œç„¶åå®¢æˆ·ç«¯æ‰èƒ½æ¥æ”¶åˆ°è¿™ä¸ªå“åº”ï¼‰ã€‚è¿™æ ·ä¸€æ¥ï¼ŒæœåŠ¡å™¨ç«¯çš„ RPC
å°±æœ‰ä¸€ä¸ªæ—¶é—´æˆ³çš„ä¸€ä¸ªä¸Šé™å’Œä¸‹é™ã€‚

## 2.2 æ¤å…¥ç‚¹

Dapper å¯ä»¥ä»¥å¯¹åº”ç”¨å¼€å‘è€…è¿‘ä¹é›¶æµ¸å…¥çš„æˆæœ¬å¯¹åˆ†å¸ƒå¼æ§åˆ¶è·¯å¾„è¿›è¡Œè·Ÿè¸ªï¼Œå‡ ä¹å®Œå…¨ä¾èµ–äºåŸºäºå°‘é‡é€šç”¨ç»„ä»¶åº“çš„æ”¹é€ ã€‚å¦‚ä¸‹ï¼š

- å½“ä¸€ä¸ªçº¿ç¨‹åœ¨å¤„ç†è·Ÿè¸ªæ§åˆ¶è·¯å¾„çš„è¿‡ç¨‹ä¸­ï¼ŒDapper æŠŠè¿™æ¬¡è·Ÿè¸ªçš„ä¸Šä¸‹æ–‡çš„åœ¨ ThreadLocal ä¸­è¿›è¡Œå­˜å‚¨ã€‚è¿½è¸ªä¸Šä¸‹æ–‡æ˜¯ä¸€ä¸ªå°è€Œä¸”å®¹æ˜“å¤åˆ¶çš„å®¹å™¨ï¼Œå…¶ä¸­æ‰¿è½½äº†
  Scan çš„å±æ€§æ¯”å¦‚è·Ÿè¸ª ID å’Œ span IDã€‚
- å½“è®¡ç®—è¿‡ç¨‹æ˜¯å»¶è¿Ÿè°ƒç”¨çš„æˆ–æ˜¯å¼‚æ­¥çš„ï¼Œå¤§å¤šæ•° Google å¼€å‘è€…é€šè¿‡çº¿ç¨‹æ± æˆ–å…¶ä»–æ‰§è¡Œå™¨ï¼Œä½¿ç”¨ä¸€ä¸ªé€šç”¨çš„æ§åˆ¶æµåº“æ¥å›è°ƒã€‚Dapper
  ç¡®ä¿æ‰€æœ‰è¿™æ ·çš„å›è°ƒå¯ä»¥å­˜å‚¨è¿™æ¬¡è·Ÿè¸ªçš„ä¸Šä¸‹æ–‡ï¼Œè€Œå½“å›è°ƒå‡½æ•°è¢«è§¦å‘æ—¶ï¼Œè¿™æ¬¡è·Ÿè¸ªçš„ä¸Šä¸‹æ–‡ä¼šä¸é€‚å½“çš„çº¿ç¨‹å…³è”ä¸Šã€‚åœ¨è¿™ç§æ–¹å¼ä¸‹ï¼ŒDapper å¯ä»¥ä½¿ç”¨ trace ID
  å’Œ span ID æ¥è¾…åŠ©æ„å»ºå¼‚æ­¥è°ƒç”¨çš„è·¯å¾„ã€‚
- å‡ ä¹æ‰€æœ‰çš„ Google çš„è¿›ç¨‹é—´é€šä¿¡æ˜¯å»ºç«‹åœ¨ä¸€ä¸ªç”¨ C++ å’Œ Java å¼€å‘çš„ RPC æ¡†æ¶ä¸Šã€‚æˆ‘ä»¬æŠŠè·Ÿè¸ªæ¤å…¥è¯¥æ¡†æ¶æ¥å®šä¹‰ RPC ä¸­æ‰€æœ‰çš„ spanã€‚span çš„ ID å’Œè·Ÿè¸ªçš„
  ID ä¼šä»å®¢æˆ·ç«¯å‘é€åˆ°æœåŠ¡ç«¯ã€‚åƒé‚£æ ·çš„åŸºäº RPC çš„ç³»ç»Ÿè¢«å¹¿æ³›ä½¿ç”¨åœ¨ Google ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªé‡è¦çš„æ¤å…¥ç‚¹ã€‚å½“é‚£äº›é RPC é€šä¿¡æ¡†æ¶å‘å±•æˆç†Ÿå¹¶æ‰¾åˆ°äº†è‡ªå·±çš„ç”¨æˆ·ç¾¤ä¹‹åï¼Œæˆ‘ä»¬ä¼šè®¡åˆ’å¯¹
  RPC é€šä¿¡æ¡†æ¶è¿›è¡Œæ¤å…¥ã€‚

Dapper çš„è·Ÿè¸ªæ•°æ®æ˜¯ç‹¬ç«‹äºè¯­è¨€çš„ï¼Œå¾ˆå¤šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„è·Ÿè¸ªç»“åˆäº†ç”¨ C++ å’Œ Java å†™çš„è¿›ç¨‹çš„æ•°æ®ã€‚åœ¨ 3.2 èŠ‚ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºåº”ç”¨ç¨‹åºçš„é€æ˜åº¦æ—¶æˆ‘ä»¬ä¼šæŠŠè¿™äº›ç†è®ºçš„æ˜¯å¦‚ä½•å®è·µçš„è¿›è¡Œè®¨è®ºã€‚

## 2.3 Annotation

![20241229154732_P1fOvOJA.webp](https://cdn.dong4j.site/source/image/20241229154732_P1fOvOJA.webp)

ä¸Šè¿°æ¤å…¥ç‚¹è¶³å¤Ÿæ¨å¯¼å‡ºå¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿçš„è·Ÿè¸ªç»†èŠ‚ï¼Œä½¿å¾— Dapper çš„æ ¸å¿ƒåŠŸèƒ½åœ¨ä¸æ”¹åŠ¨ Google åº”ç”¨çš„æƒ…å†µä¸‹å¯ç”¨ã€‚ç„¶è€Œï¼ŒDapper è¿˜å…è®¸åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜åœ¨
Dapper è·Ÿè¸ªçš„è¿‡ç¨‹ä¸­æ·»åŠ é¢å¤–çš„ä¿¡æ¯ï¼Œä»¥ç›‘æ§æ›´é«˜çº§åˆ«çš„ç³»ç»Ÿè¡Œä¸ºï¼Œæˆ–å¸®åŠ©è°ƒè¯•é—®é¢˜ã€‚æˆ‘ä»¬å…è®¸ç”¨æˆ·é€šè¿‡ä¸€ä¸ªç®€å•çš„ API å®šä¹‰å¸¦æ—¶é—´æˆ³çš„ Annotationï¼Œæ ¸å¿ƒçš„ç¤ºä¾‹ä»£ç å…¥å›¾
4 æ‰€ç¤ºã€‚è¿™äº› Annotation å¯ä»¥æ·»åŠ ä»»æ„å†…å®¹ã€‚ä¸ºäº†ä¿æŠ¤ Dapper çš„ç”¨æˆ·æ„å¤–çš„è¿‡åˆ†çƒ­è¡·äºæ—¥å¿—çš„è®°å½•ï¼Œæ¯ä¸€ä¸ªè·Ÿè¸ª span æœ‰ä¸€ä¸ªå¯é…ç½®çš„æ€» Annotation
é‡çš„ä¸Šé™ã€‚ä½†æ˜¯ï¼Œåº”ç”¨ç¨‹åºçº§çš„ Annotation æ˜¯ä¸èƒ½æ›¿ä»£ç”¨äºè¡¨ç¤º span ç»“æ„çš„ä¿¡æ¯å’Œè®°å½•ç€ RPC ç›¸å…³çš„ä¿¡æ¯ã€‚

é™¤äº†ç®€å•çš„æ–‡æœ¬ Annotationï¼ŒDapper ä¹Ÿæ”¯æŒçš„ key-value æ˜ å°„çš„ Annotationï¼Œæä¾›ç»™å¼€å‘äººå‘˜æ›´å¼ºçš„è·Ÿè¸ªèƒ½åŠ›ï¼Œå¦‚æŒç»­çš„è®¡æ•°å™¨ï¼ŒäºŒè¿›åˆ¶æ¶ˆæ¯è®°å½•å’Œåœ¨ä¸€ä¸ªè¿›ç¨‹ä¸Šè·‘ç€çš„ä»»æ„çš„ç”¨æˆ·æ•°æ®ã€‚é”®å€¼å¯¹çš„
Annotation æ–¹å¼ç”¨æ¥åœ¨åˆ†å¸ƒå¼è¿½è¸ªçš„ä¸Šä¸‹æ–‡ä¸­å®šä¹‰æŸä¸ªç‰¹å®šåº”ç”¨ç¨‹åºçš„ç›¸å…³ç±»å‹ã€‚

## 2.4 é‡‡æ ·ç‡

ä½æŸè€—çš„æ˜¯ Dapper çš„ä¸€ä¸ªå…³é”®çš„è®¾è®¡ç›®æ ‡ï¼Œå› ä¸ºå¦‚æœè¿™ä¸ªå·¥å…·ä»·å€¼æœªè¢«è¯å®ä½†åˆå¯¹æ€§èƒ½æœ‰å½±å“çš„è¯ï¼Œä½ å¯ä»¥ç†è§£æœåŠ¡è¿è¥äººå‘˜ä¸ºä»€ä¹ˆä¸æ„¿æ„éƒ¨ç½²å®ƒã€‚å†µä¸”ï¼Œæˆ‘ä»¬æƒ³è®©å¼€å‘äººå‘˜ä½¿ç”¨
Annotation çš„ APIï¼Œè€Œä¸ç”¨æ‹…å¿ƒé¢å¤–çš„å¼€é”€ã€‚æˆ‘ä»¬è¿˜å‘ç°ï¼ŒæŸäº›ç±»å‹çš„ Web æœåŠ¡å¯¹æ¤å…¥å¸¦æ¥çš„æ€§èƒ½æŸè€—ç¡®å®éå¸¸æ•æ„Ÿã€‚å› æ­¤ï¼Œé™¤äº†æŠŠ Dapper
çš„æ”¶é›†å·¥ä½œå¯¹åŸºæœ¬ç»„ä»¶çš„æ€§èƒ½æŸè€—é™åˆ¶çš„å°½å¯èƒ½å°ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜æœ‰è¿›ä¸€æ­¥æ§åˆ¶æŸè€—çš„åŠæ³•ï¼Œé‚£å°±æ˜¯é‡åˆ°å¤§é‡è¯·æ±‚æ—¶åªè®°å½•å…¶ä¸­çš„ä¸€å°éƒ¨åˆ†ã€‚æˆ‘ä»¬å°†åœ¨ 4.4
èŠ‚ä¸­è®¨è®ºè·Ÿè¸ªçš„é‡‡æ ·ç‡æ–¹æ¡ˆçš„æ›´å¤šç»†èŠ‚ã€‚

![20241229154732_ZrsnqkWv.webp](https://cdn.dong4j.site/source/image/20241229154732_ZrsnqkWv.webp)

å›¾ 5ï¼šDapper æ”¶é›†ç®¡é“çš„æ€»è§ˆ

## 2.5 è·Ÿè¸ªçš„æ”¶é›†

Dapper çš„è·Ÿè¸ªè®°å½•å’Œæ”¶é›†ç®¡é“çš„è¿‡ç¨‹åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼ˆå‚è§å›¾ 5ï¼‰ã€‚é¦–å…ˆï¼Œspan æ•°æ®å†™å…¥ï¼ˆ1ï¼‰æœ¬åœ°æ—¥å¿—æ–‡ä»¶ä¸­ã€‚ç„¶å Dapper
çš„å®ˆæŠ¤è¿›ç¨‹å’Œæ”¶é›†ç»„ä»¶æŠŠè¿™äº›æ•°æ®ä»ç”Ÿäº§ç¯å¢ƒçš„ä¸»æœºä¸­æ‹‰å‡ºæ¥ï¼ˆ2ï¼‰ï¼Œæœ€ç»ˆå†™åˆ°ï¼ˆ3ï¼‰Dapper çš„ Bigtable ä»“åº“ä¸­ã€‚ä¸€æ¬¡è·Ÿè¸ªè¢«è®¾è®¡æˆ Bigtable ä¸­çš„ä¸€è¡Œï¼Œæ¯ä¸€åˆ—ç›¸å½“äºä¸€ä¸ª
spanã€‚Bigtable çš„æ”¯æŒç¨€ç–è¡¨æ ¼å¸ƒå±€æ­£é€‚åˆè¿™ç§æƒ…å†µï¼Œå› ä¸ºæ¯ä¸€æ¬¡è·Ÿè¸ªå¯ä»¥æœ‰ä»»æ„å¤šä¸ª spanã€‚è·Ÿè¸ªæ•°æ®æ”¶é›†ï¼ˆå³ä»åº”ç”¨ä¸­çš„äºŒè¿›åˆ¶æ•°æ®ä¼ è¾“åˆ°ä¸­å¤®ä»“åº“æ‰€èŠ±è´¹çš„æ—¶é—´ï¼‰çš„å»¶è¿Ÿä¸­ä½æ•°å°‘äº
15 ç§’ã€‚ç¬¬ 98 ç™¾åˆ†ä½çš„å»¶è¿Ÿ (The 98th percentile latency) å¾€å¾€éšç€æ—¶é—´çš„æ¨ç§»å‘ˆç°åŒå³°å‹; å¤§çº¦ 75% çš„æ—¶é—´ï¼Œç¬¬ 98 ç™¾åˆ†ä½çš„å»¶è¿Ÿæ—¶é—´å°äº 2 åˆ†é’Ÿï¼Œä½†æ˜¯å¦å¤–å¤§çº¦
25% çš„æ—¶é—´ï¼Œå®ƒå¯ä»¥å¢æ¶¨åˆ°å‡ ä¸ªå°æ—¶ã€‚

Dapper è¿˜æä¾›äº†ä¸€ä¸ª API æ¥ç®€åŒ–è®¿é—®æˆ‘ä»¬ä»“åº“ä¸­çš„è·Ÿè¸ªæ•°æ®ã€‚ Google çš„å¼€å‘äººå‘˜ç”¨è¿™ä¸ª APIï¼Œä»¥æ„å»ºé€šç”¨å’Œç‰¹å®šåº”ç”¨ç¨‹åºçš„åˆ†æå·¥å…·ã€‚ç¬¬ 5.1 èŠ‚åŒ…å«æ›´å¤šå¦‚ä½•ä½¿ç”¨å®ƒçš„ä¿¡æ¯ã€‚

## 2.5.1 å¸¦å¤–æ•°æ®è·Ÿè¸ªæ”¶é›†

tip1: å¸¦å¤–æ•°æ®: ä¼ è¾“å±‚åè®®ä½¿ç”¨å¸¦å¤–æ•°æ® (out-of-bandï¼ŒOOB) æ¥å‘é€ä¸€äº›é‡è¦çš„æ•°æ®, å¦‚æœé€šä¿¡ä¸€æ–¹æœ‰é‡è¦çš„æ•°æ®éœ€è¦é€šçŸ¥å¯¹æ–¹æ—¶,
åè®®èƒ½å¤Ÿå°†è¿™äº›æ•°æ®å¿«é€Ÿåœ°å‘é€åˆ°å¯¹æ–¹ã€‚ä¸ºäº†å‘é€è¿™äº›æ•°æ®ï¼Œåè®®ä¸€èˆ¬ä¸ä½¿ç”¨ä¸æ™®é€šæ•°æ®ç›¸åŒçš„é€šé“, è€Œæ˜¯ä½¿ç”¨å¦å¤–çš„é€šé“ã€‚

tip2: è¿™é‡ŒæŒ‡çš„ in-band ç­–ç•¥æ˜¯æŠŠè·Ÿè¸ªæ•°æ®éšç€è°ƒç”¨é“¾è¿›è¡Œä¼ é€ï¼Œout-of-band æ˜¯é€šè¿‡å…¶ä»–çš„é“¾è·¯è¿›è¡Œè·Ÿè¸ªæ•°æ®çš„æ”¶é›†ï¼ŒDapper çš„å†™æ—¥å¿—ç„¶åè¿›è¡Œæ—¥å¿—é‡‡é›†çš„æ–¹å¼å°±å±äº
out-of-band ç­–ç•¥

Dapper ç³»ç»Ÿè¯·æ±‚æ ‘æ ‘è‡ªèº«è¿›è¡Œè·Ÿè¸ªè®°å½•å’Œæ”¶é›†å¸¦å¤–æ•°æ®ã€‚è¿™æ ·åšæ˜¯ä¸ºä¸¤ä¸ªä¸ç›¸å…³çš„åŸå› ã€‚é¦–å…ˆï¼Œå¸¦å†…æ”¶é›†æ–¹æ¡ˆ -- è¿™é‡Œè·Ÿè¸ªæ•°æ®ä¼šä»¥ RPC å“åº”å¤´çš„å½¢å¼è¢«è¿”å› --
ä¼šå½±å“åº”ç”¨ç¨‹åºç½‘ç»œåŠ¨æ€ã€‚åœ¨ Google é‡Œçš„è®¸å¤šè§„æ¨¡è¾ƒå¤§çš„ç³»ç»Ÿä¸­ï¼Œä¸€æ¬¡è·Ÿè¸ªæˆåƒä¸Šä¸‡çš„ span å¹¶ä¸å°‘è§ã€‚ç„¶è€Œï¼ŒRPC å›åº”å¤§å° --
ç”šè‡³æ˜¯æ¥è¿‘å¤§å‹åˆ†å¸ƒå¼çš„è·Ÿè¸ªçš„æ ¹èŠ‚ç‚¹çš„è¿™ç§æƒ…å†µä¸‹ -- ä»ç„¶æ˜¯æ¯”è¾ƒå°çš„ï¼šé€šå¸¸å°äº 10Kã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¸¦å†… Dapper
çš„è·Ÿè¸ªæ•°æ®ä¼šè®©åº”ç”¨ç¨‹åºæ•°æ®å’Œå€¾å‘äºä½¿ç”¨åç»­åˆ†æç»“æœçš„æ•°æ®é‡ç›¸å½¢è§ç»Œã€‚å…¶æ¬¡ï¼Œå¸¦å†…æ”¶é›†æ–¹æ¡ˆå‡å®šæ‰€æœ‰çš„ RPC
æ˜¯å®Œç¾åµŒå¥—çš„ã€‚æˆ‘ä»¬å‘ç°ï¼Œåœ¨æ‰€æœ‰çš„åç«¯çš„ç³»ç»Ÿè¿”å›çš„æœ€ç»ˆç»“æœä¹‹å‰ï¼Œæœ‰è®¸å¤šä¸­é—´ä»¶ä¼šæŠŠç»“æœè¿”å›ç»™ä»–ä»¬çš„è°ƒç”¨è€…ã€‚å¸¦å†…æ”¶é›†ç³»ç»Ÿæ˜¯æ— æ³•è§£é‡Šè¿™ç§éåµŒå¥—çš„åˆ†å¸ƒå¼æ‰§è¡Œæ¨¡å¼çš„ã€‚

## 2.6 å®‰å…¨å’Œéšç§è€ƒè™‘

è®°å½•ä¸€å®šé‡çš„ RPC æœ‰æ•ˆè´Ÿè½½ä¿¡æ¯å°†ä¸°å¯Œ Dapper
çš„è·Ÿè¸ªèƒ½åŠ›ï¼Œå› ä¸ºåˆ†æå·¥å…·èƒ½å¤Ÿåœ¨æœ‰æ•ˆè½½è·æ•°æ®ï¼ˆæ–¹æ³•ä¼ é€’çš„å‚æ•°ï¼‰ä¸­æ‰¾åˆ°ç›¸å…³çš„æ ·ä¾‹ï¼Œè¿™äº›æ ·ä¾‹å¯ä»¥è§£é‡Šè¢«ç›‘æ§ç³»ç»Ÿçš„ä¸ºä½•è¡¨ç°å¼‚å¸¸ã€‚ç„¶è€Œï¼Œæœ‰äº›æƒ…å†µä¸‹ï¼Œæœ‰æ•ˆè½½è·æ•°æ®å¯èƒ½åŒ…å«çš„ä¸€äº›ä¸åº”è¯¥é€éœ²ç»™æœªç»æˆæƒç”¨æˆ· (
åŒ…æ‹¬æ­£åœ¨ debug çš„å·¥ç¨‹å¸ˆ) çš„å†…éƒ¨ä¿¡æ¯ã€‚

ç”±äºå®‰å…¨å’Œéšç§é—®é¢˜æ˜¯ä¸å¯å¿½ç•¥çš„ï¼Œdapper ä¸­çš„è™½ç„¶å­˜å‚¨ RPC æ–¹æ³•çš„åç§°ï¼Œä½†åœ¨è¿™ä¸ªæ—¶å€™ä¸è®°å½•ä»»ä½•æœ‰æ•ˆè½½è·æ•°æ®ã€‚ç›¸åï¼Œåº”ç”¨ç¨‹åºçº§åˆ«çš„ Annotation
æä¾›äº†ä¸€ä¸ªæ–¹ä¾¿çš„å¯é€‰æœºåˆ¶ï¼šåº”ç”¨ç¨‹åºå¼€å‘äººå‘˜å¯ä»¥åœ¨ span ä¸­é€‰æ‹©å…³è”é‚£äº›ä¸ºä»¥ååˆ†ææä¾›ä»·å€¼çš„æ•°æ®ã€‚

Dapper è¿˜æä¾›äº†ä¸€äº›å®‰å…¨ä¸Šçš„ä¾¿åˆ©ï¼Œæ˜¯å®ƒçš„è®¾è®¡è€…äº‹å…ˆæ²¡æœ‰é¢„æ–™åˆ°çš„ã€‚é€šè¿‡è·Ÿè¸ªå…¬å¼€çš„å®‰å…¨åè®®å‚æ•°ï¼ŒDapper å¯ä»¥é€šè¿‡ç›¸åº”çº§åˆ«çš„è®¤è¯æˆ–åŠ å¯†ï¼Œæ¥ç›‘è§†åº”ç”¨ç¨‹åºæ˜¯å¦æ»¡è¶³å®‰å…¨ç­–ç•¥ã€‚ä¾‹å¦‚ã€‚Dapper
è¿˜å¯ä»¥æä¾›ä¿¡æ¯ï¼Œä»¥åŸºäºç­–ç•¥çš„çš„éš”ç¦»ç³»ç»ŸæŒ‰é¢„æœŸæ‰§è¡Œï¼Œä¾‹å¦‚æ”¯æ’‘æ•æ„Ÿæ•°æ®çš„åº”ç”¨ç¨‹åºä¸ä¸æœªç»æˆæƒçš„ç³»ç»Ÿç»„ä»¶è¿›è¡Œäº†äº¤äº’ã€‚è¿™æ ·çš„æµ‹ç®—æä¾›äº†æ¯”æºç å®¡æ ¸æ›´å¼ºå¤§çš„ä¿éšœã€‚

## 3. Dapper éƒ¨ç½²çŠ¶å†µ

Dapper ä½œä¸ºæˆ‘ä»¬ç”Ÿäº§ç¯å¢ƒä¸‹çš„è·Ÿè¸ªç³»ç»Ÿå·²ç»è¶…è¿‡ä¸¤å¹´ã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¼šæ±‡æŠ¥ç³»ç»ŸçŠ¶æ€ï¼ŒæŠŠé‡ç‚¹æ”¾åœ¨ Dapper å¦‚ä½•æ»¡è¶³äº†æˆ‘ä»¬çš„ç›®æ ‡â€”â€”æ— å¤„ä¸åœ¨çš„éƒ¨ç½²å’Œåº”ç”¨çº§çš„é€æ˜ã€‚

## 3.1 Dapper è¿è¡Œåº“

ä¹Ÿè®¸ Dapper ä»£ç ä¸­ä¸­æœ€å…³é”®çš„éƒ¨åˆ†ï¼Œå°±æ˜¯å¯¹åŸºç¡€ RPCã€çº¿ç¨‹æ§åˆ¶å’Œæµç¨‹æ§åˆ¶çš„ç»„ä»¶åº“çš„æ¤å…¥ï¼Œå…¶ä¸­åŒ…æ‹¬ span
çš„åˆ›å»ºï¼Œé‡‡æ ·ç‡çš„è®¾ç½®ï¼Œä»¥åŠæŠŠæ—¥å¿—å†™å…¥æœ¬åœ°ç£ç›˜ã€‚é™¤äº†åšåˆ°è½»é‡çº§ï¼Œæ¤å…¥çš„ä»£ç æ›´éœ€è¦ç¨³å®šå’Œå¥å£®ï¼Œå› ä¸ºå®ƒä¸æµ·é‡çš„åº”ç”¨å¯¹æ¥ï¼Œç»´æŠ¤å’Œ bug ä¿®å¤å˜å¾—å›°éš¾ã€‚æ¤å…¥çš„æ ¸å¿ƒä»£ç æ˜¯ç”±æœªè¶…è¿‡
1000 è¡Œçš„ C++ å’Œä¸è¶…è¿‡ 800 è¡Œ Java ä»£ç ç»„æˆã€‚ä¸ºäº†æ”¯æŒé”®å€¼å¯¹çš„ Annotation è¿˜æ·»åŠ äº†é¢å¤–çš„ 500 è¡Œä»£ç ã€‚

## 3.2 ç”Ÿäº§ç¯å¢ƒä¸‹çš„æ¶µç›–é¢

Dapper çš„æ¸—é€å¯ä»¥æ€»ç»“ä¸ºä¸¤ä¸ªæ–¹é¢ï¼šä¸€æ–¹é¢æ˜¯å¯ä»¥åˆ›å»º Dapper è·Ÿè¸ªçš„è¿‡ç¨‹ (ä¸ Dapper æ¤å…¥çš„ç»„ä»¶åº“ç›¸å…³)ï¼Œå’Œç”Ÿäº§ç¯å¢ƒä¸‹çš„æœåŠ¡å™¨ä¸Šåœ¨è¿è¡Œ Dapper
è·Ÿè¸ªæ”¶é›†å®ˆæŠ¤è¿›ç¨‹ã€‚Dapper çš„å®ˆæŠ¤è¿›ç¨‹çš„åˆ†å¸ƒç›¸å½“äºæˆ‘ä»¬æœåŠ¡å™¨çš„ç®€å•çš„æ‹“æ‰‘å›¾ï¼Œå®ƒå­˜åœ¨äº Google å‡ ä¹æ‰€æœ‰çš„æœåŠ¡å™¨ä¸Šã€‚è¿™å¾ˆéš¾ç¡®å®šç²¾ç¡®çš„ Dapper-ready
è¿›ç¨‹éƒ¨åˆ†ï¼Œå› ä¸ºè¿‡ç¨‹å³ä¾¿ä¸äº§ç”Ÿè·Ÿè¸ªä¿¡æ¯ Dapper ä¹Ÿæ˜¯æ— ä»çŸ¥æ™“çš„ã€‚å°½ç®¡å¦‚æ­¤ï¼Œè€ƒè™‘åˆ°æ— å¤„ä¸åœ¨ Dapper ç»„ä»¶çš„æ¤å…¥åº“ï¼Œæˆ‘ä»¬ä¼°è®¡å‡ ä¹æ¯ä¸€ä¸ª Google
çš„ç”Ÿäº§è¿›ç¨‹éƒ½æ˜¯æ”¯æŒè·Ÿè¸ªçš„ã€‚

åœ¨æŸäº›æƒ…å†µä¸‹ Dapper çš„æ˜¯ä¸èƒ½æ­£ç¡®çš„è·Ÿè¸ªæ§åˆ¶è·¯å¾„çš„ã€‚è¿™äº›é€šå¸¸æºäºä½¿ç”¨éæ ‡å‡†çš„æ§åˆ¶æµï¼Œæˆ–æ˜¯ Dapper çš„é”™è¯¯çš„æŠŠè·¯å¾„å…³è”å½’åˆ°ä¸ç›¸å…³çš„äº‹ä»¶ä¸Šã€‚Dapper
æä¾›äº†ä¸€ä¸ªç®€å•çš„åº“æ¥å¸®åŠ©å¼€å‘è€…æ‰‹åŠ¨æ§åˆ¶è·Ÿè¸ªä¼ æ’­ä½œä¸ºä¸€ç§å˜é€šæ–¹æ³•ã€‚ç›®å‰æœ‰ 40 ä¸ª C++ åº”ç”¨ç¨‹åºå’Œ 33 ä¸ª Java
åº”ç”¨ç¨‹åºéœ€è¦ä¸€äº›æ‰‹åŠ¨æ§åˆ¶çš„è¿½è¸ªä¼ æ’­ï¼Œä¸è¿‡è¿™åªæ˜¯ä¸Šåƒä¸ªçš„è·Ÿè¸ªä¸­çš„ä¸€å°éƒ¨åˆ†ã€‚ä¹Ÿæœ‰éå¸¸å°çš„ä¸€éƒ¨åˆ†ç¨‹åºä½¿ç”¨çš„éç»„ä»¶æ€§è´¨çš„é€šä¿¡åº“ï¼ˆæ¯”å¦‚åŸç”Ÿçš„ TCP Socket æˆ–
SOAP RPCï¼‰ï¼Œå› æ­¤ä¸èƒ½ç›´æ¥æ”¯æŒ Dapper çš„è·Ÿè¸ªã€‚ä½†æ˜¯è¿™äº›åº”ç”¨å¯ä»¥å•ç‹¬æ¥å…¥åˆ° Dapper ä¸­ï¼Œå¦‚æœéœ€è¦çš„è¯ã€‚

è€ƒè™‘åˆ°ç”Ÿäº§ç¯å¢ƒçš„å®‰å…¨ï¼ŒDapper çš„è·Ÿè¸ªä¹Ÿå¯ä»¥å…³é—­ã€‚äº‹å®ä¸Šï¼Œå®ƒåœ¨éƒ¨ç½²çš„æ—©èµ·å°±æ˜¯é»˜è®¤å…³é—­çš„ï¼Œç›´åˆ°æˆ‘ä»¬å¯¹ Dapper çš„ç¨³å®šæ€§å’Œä½æŸè€—æœ‰äº†è¶³å¤Ÿçš„ä¿¡å¿ƒä¹‹åæ‰æŠŠå®ƒå¼€å¯ã€‚Dapper
çš„å›¢é˜Ÿå¶å°”ä¼šæ‰§è¡Œå®¡æŸ¥å¯»æ‰¾è·Ÿè¸ªé…ç½®çš„å˜åŒ–ï¼Œæ¥çœ‹çœ‹é‚£äº›æœåŠ¡å…³é—­äº† Dapper çš„è·Ÿè¸ªã€‚ä½†è¿™ç§æƒ…å†µä¸å¤šè§ï¼Œè€Œä¸”é€šå¸¸æ˜¯æºäºå¯¹ç›‘æ§å¯¹æ€§èƒ½æ¶ˆè€—çš„æ‹…å¿§ã€‚ç»è¿‡äº†å¯¹å®é™…æ€§èƒ½æ¶ˆè€—çš„è¿›ä¸€æ­¥è°ƒæŸ¥å’Œæµ‹é‡ï¼Œæ‰€æœ‰è¿™äº›å…³é—­
Dapper è·Ÿè¸ªéƒ½å·²ç»æ¢å¤å¼€å¯äº†ï¼Œä¸è¿‡è¿™äº›å·²ç»ä¸é‡è¦äº†ã€‚

## 3.3 è·Ÿè¸ª Annotation çš„ä½¿ç”¨

ç¨‹åºå‘˜å€¾å‘äºä½¿ç”¨ç‰¹å®šåº”ç”¨ç¨‹åºçš„ Annotationï¼Œæ— è®ºæ˜¯ä½œä¸ºä¸€ç§åˆ†å¸ƒå¼è°ƒè¯•æ—¥å¿—æ–‡ä»¶ï¼Œè¿˜æ˜¯é€šè¿‡ä¸€äº›åº”ç”¨ç¨‹åºç‰¹å®šçš„åŠŸèƒ½å¯¹è·Ÿè¸ªè¿›è¡Œåˆ†ç±»ã€‚ä¾‹å¦‚ï¼Œæ‰€æœ‰çš„ Bigtable
çš„è¯·æ±‚ä¼šæŠŠè¢«è®¿é—®çš„è¡¨åä¹Ÿè®°å½•åˆ° Annotation ä¸­ã€‚ç›®å‰ï¼Œ70ï¼…çš„ Dapper span å’Œ 90ï¼…çš„æ‰€æœ‰ Dapper è·Ÿè¸ªéƒ½è‡³å°‘æœ‰ä¸€ä¸ªç‰¹æ®Šåº”ç”¨çš„ Annotationã€‚

41 ä¸ª Java åº”ç”¨å’Œ 68 ä¸ª C++ åº”ç”¨ä¸­éƒ½æ·»åŠ è‡ªå®šä¹‰çš„ Annotation ä¸ºäº†æ›´å¥½åœ°ç†è§£åº”ç”¨ç¨‹åºä¸­çš„ span åœ¨ä»–ä»¬çš„æœåŠ¡ä¸­çš„è¡Œä¸ºã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿„ä»Šä¸ºæ­¢æˆ‘ä»¬çš„
Java å¼€å‘è€…æ¯” C++ å¼€å‘è€…æ›´å¤šçš„åœ¨æ¯ä¸€ä¸ªè·Ÿè¸ª span ä¸Šé‡‡ç”¨ Annotation çš„ APIã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºæˆ‘ä»¬çš„ Java åº”ç”¨çš„ä½œç”¨åŸŸå¾€å¾€æ˜¯æ›´æ¥è¿‘æœ€ç»ˆç”¨æˆ· (C++
ååº•å±‚); è¿™äº›ç±»å‹çš„åº”ç”¨ç¨‹åºç»å¸¸å¤„ç†æ›´å¹¿æ³›çš„è¯·æ±‚ç»„åˆï¼Œå› æ­¤å…·æœ‰æ¯”è¾ƒå¤æ‚çš„æ§åˆ¶è·¯å¾„ã€‚

## 4. å¤„ç†è·Ÿè¸ªæŸè€—

è·Ÿè¸ªç³»ç»Ÿçš„æˆæœ¬ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š

1. æ­£åœ¨è¢«ç›‘æ§çš„ç³»ç»Ÿåœ¨ç”Ÿæˆè¿½è¸ªå’Œæ”¶é›†è¿½è¸ªæ•°æ®çš„æ¶ˆè€—å¯¼è‡´ç³»ç»Ÿæ€§èƒ½ä¸‹é™ï¼Œ
2. éœ€è¦ä½¿ç”¨ä¸€éƒ¨åˆ†èµ„æºæ¥å­˜å‚¨å’Œåˆ†æè·Ÿè¸ªæ•°æ®ã€‚è™½ç„¶ä½ å¯ä»¥è¯´ä¸€ä¸ªæœ‰ä»·å€¼çš„ç»„ä»¶æ¤å…¥è·Ÿè¸ªå¸¦æ¥ä¸€éƒ¨åˆ†æ€§èƒ½æŸè€—æ˜¯å€¼å¾—çš„ï¼Œæˆ‘ä»¬ç›¸ä¿¡å¦‚æœåŸºæœ¬æŸè€—èƒ½è¾¾åˆ°å¯ä»¥å¿½ç•¥çš„ç¨‹åº¦ï¼Œé‚£ä¹ˆå¯¹è·Ÿè¸ªç³»ç»Ÿæœ€åˆçš„æ¨å¹¿ä¼šæœ‰æå¤§çš„å¸®åŠ©ã€‚

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¼šå±•ç°ä¸€ä¸‹ä¸‰ä¸ªæ–¹é¢ï¼šDapper ç»„ä»¶æ“ä½œçš„æ¶ˆè€—ï¼Œè·Ÿè¸ªæ”¶é›†çš„æ¶ˆè€—ï¼Œä»¥åŠ Dapper å¯¹ç”Ÿäº§ç¯å¢ƒè´Ÿè½½çš„å½±å“ã€‚æˆ‘ä»¬è¿˜ä»‹ç»äº† Dapper
å¯è°ƒèŠ‚çš„é‡‡æ ·ç‡æœºåˆ¶å¦‚ä½•å¸®æˆ‘ä»¬å¤„ç†ä½æŸè€—å’Œè·Ÿè¸ªä»£è¡¨æ€§ä¹‹é—´çš„å¹³è¡¡å’Œå–èˆã€‚

## 4.1 ç”Ÿæˆè·Ÿè¸ªçš„æŸè€—

ç”Ÿæˆè·Ÿè¸ªçš„å¼€é”€æ˜¯ Dapper æ€§èƒ½å½±å“ä¸­æœ€å…³é”®çš„éƒ¨åˆ†ï¼Œå› ä¸ºæ”¶é›†å’Œåˆ†æå¯ä»¥æ›´å®¹æ˜“åœ¨ç´§æ€¥æƒ…å†µä¸‹è¢«å…³é—­ã€‚Dapper è¿è¡Œåº“ä¸­æœ€é‡è¦çš„è·Ÿè¸ªç”Ÿæˆæ¶ˆè€—åœ¨äºåˆ›å»ºå’Œé”€æ¯
span å’Œ annotationï¼Œå¹¶è®°å½•åˆ°æœ¬åœ°ç£ç›˜ä¾›åç»­çš„æ”¶é›†ã€‚æ ¹ span çš„åˆ›å»ºå’Œé”€æ¯éœ€è¦æŸè€—å¹³å‡ 204 çº³ç§’çš„æ—¶é—´ï¼Œè€ŒåŒæ ·çš„æ“ä½œåœ¨å…¶ä»– span ä¸Šéœ€è¦æ¶ˆè€— 176
çº³ç§’ã€‚æ—¶é—´ä¸Šçš„å·®åˆ«ä¸»è¦åœ¨äºéœ€è¦åœ¨è·Ÿ span ä¸Šç»™è¿™æ¬¡è·Ÿè¸ªåˆ†é…ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ IDã€‚

å¦‚æœä¸€ä¸ª span æ²¡æœ‰è¢«é‡‡æ ·çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªé¢å¤–çš„ span ä¸‹åˆ›å»º annotation çš„æˆæœ¬å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œä»–ç”±åœ¨ Dapper è¿è¡ŒæœŸå¯¹ ThreadLocal æŸ¥æ‰¾æ“ä½œæ„æˆï¼Œè¿™å¹³å‡åªæ¶ˆè€—
9 çº³ç§’ã€‚å¦‚æœè¿™ä¸ª span è¢«è®¡å…¥é‡‡æ ·çš„è¯ï¼Œä¼šç”¨ä¸€ä¸ªç”¨å­—ç¬¦ä¸²è¿›è¡Œæ ‡æ³¨ -- åœ¨å›¾ 4 ä¸­æœ‰å±•ç° -- å¹³å‡éœ€è¦æ¶ˆè€— 40 çº³ç§’ã€‚è¿™äº›æ•°æ®éƒ½æ˜¯åœ¨ 2.2GHz çš„ x86
æœåŠ¡å™¨ä¸Šé‡‡é›†çš„ã€‚

åœ¨ Dapper è¿è¡ŒæœŸå†™å…¥åˆ°æœ¬åœ°ç£ç›˜æ˜¯æœ€æ˜‚è´µçš„æ“ä½œï¼Œä½†æ˜¯ä»–ä»¬çš„å¯è§æŸè€—å¤§å¤§å‡å°‘ï¼Œå› ä¸ºå†™å…¥æ—¥å¿—æ–‡ä»¶å’Œæ“ä½œç›¸å¯¹äºè¢«è·Ÿè¸ªçš„åº”ç”¨ç³»ç»Ÿæ¥è¯´éƒ½æ˜¯å¼‚æ­¥çš„ã€‚ä¸è¿‡ï¼Œæ—¥å¿—å†™å…¥çš„æ“ä½œå¦‚æœåœ¨å¤§æµé‡çš„æƒ…å†µï¼Œå°¤å…¶æ˜¯æ¯ä¸€ä¸ªè¯·æ±‚éƒ½è¢«è·Ÿè¸ªçš„æƒ…å†µä¸‹å°±ä¼šå˜å¾—å¯ä»¥å¯Ÿè§‰åˆ°ã€‚æˆ‘ä»¬è®°å½•äº†åœ¨
4.3 èŠ‚å±•ç¤ºäº†ä¸€æ¬¡ Web æœç´¢çš„è´Ÿè½½ä¸‹çš„æ€§èƒ½æ¶ˆè€—ã€‚

## 4.2 è·Ÿè¸ªæ”¶é›†çš„æ¶ˆè€—

è¯»å‡ºè·Ÿè¸ªæ•°æ®ä¹Ÿä¼šå¯¹æ­£åœ¨è¢«ç›‘æ§çš„è´Ÿè½½äº§ç”Ÿå¹²æ‰°ã€‚è¡¨ 1 å±•ç¤ºçš„æ˜¯æœ€åæƒ…å†µä¸‹ï¼ŒDapper æ”¶é›†æ—¥å¿—çš„å®ˆæŠ¤è¿›ç¨‹åœ¨é«˜äºå®é™…æƒ…å†µçš„è´Ÿè½½åŸºå‡†ä¸‹è¿›è¡Œæµ‹è¯•æ—¶çš„ cpu
ä½¿ç”¨ç‡ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œè·Ÿè¸ªæ•°æ®å¤„ç†ä¸­ï¼Œè¿™ä¸ªå®ˆæŠ¤è¿›ç¨‹ä»æ¥æ²¡æœ‰è¶…è¿‡ 0.3% çš„å•æ ¸ cpu ä½¿ç”¨ç‡ï¼Œè€Œä¸”åªæœ‰å¾ˆå°‘é‡çš„å†…å­˜ä½¿ç”¨ï¼ˆä»¥åŠå †ç¢ç‰‡çš„å™ªéŸ³ï¼‰ã€‚æˆ‘ä»¬è¿˜é™åˆ¶äº†
Dapper å®ˆæŠ¤è¿›ç¨‹ä¸ºå†…æ ¸ scheduler æœ€ä½çš„ä¼˜å…ˆçº§ï¼Œä»¥é˜²åœ¨ä¸€å°é«˜è´Ÿè½½çš„æœåŠ¡å™¨ä¸Šå‘ç”Ÿ cpu ç«äº‰ã€‚

Dapper ä¹Ÿæ˜¯ä¸€ä¸ªå¸¦å®½èµ„æºçš„è½»é‡çº§çš„æ¶ˆè´¹è€…ï¼Œæ¯ä¸€ä¸ª span åœ¨æˆ‘ä»¬çš„ä»“åº“ä¸­ä¼ è¾“åªå ç”¨äº†å¹³å‡ 426 çš„ byteã€‚ä½œä¸ºç½‘ç»œè¡Œä¸ºä¸­çš„æå°éƒ¨åˆ†ï¼ŒDapper çš„æ•°æ®æ”¶é›†åœ¨
Google çš„ç”Ÿäº§ç¯å¢ƒä¸­çš„åªå ç”¨äº† 0.01% çš„ç½‘ç»œèµ„æºã€‚

![20241229154732_jRzkp5pe.webp](https://cdn.dong4j.site/source/image/20241229154732_jRzkp5pe.webp)

è¡¨ 1ï¼šDapper å®ˆæŠ¤è¿›ç¨‹åœ¨è´Ÿè½½æµ‹è¯•æ—¶çš„ CPU èµ„æºä½¿ç”¨ç‡

## 4.3 åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹å¯¹è´Ÿè½½çš„å½±å“

æ¯ä¸ªè¯·æ±‚éƒ½ä¼šåˆ©ç”¨åˆ°å¤§é‡çš„æœåŠ¡å™¨çš„é«˜ååé‡çš„çº¿ä¸ŠæœåŠ¡ï¼Œè¿™æ˜¯å¯¹æœ‰æ•ˆè·Ÿè¸ªæœ€ä¸»è¦çš„éœ€æ±‚ä¹‹ä¸€ï¼›è¿™ç§æƒ…å†µéœ€è¦ç”Ÿæˆå¤§é‡çš„è·Ÿè¸ªæ•°æ®ï¼Œå¹¶ä¸”ä»–ä»¬å¯¹æ€§èƒ½çš„å½±å“æ˜¯æœ€æ•æ„Ÿçš„ã€‚åœ¨è¡¨
2 ä¸­æˆ‘ä»¬ç”¨é›†ç¾¤ä¸‹çš„ç½‘ç»œæœç´¢æœåŠ¡ä½œä¸ºä¾‹å­ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒæ•´é‡‡æ ·ç‡ï¼Œæ¥è¡¡é‡ Dapper åœ¨å»¶è¿Ÿå’Œååé‡æ–¹é¢å¯¹æ€§èƒ½çš„å½±å“ã€‚

![20241229154732_NRNUPfjs.webp](https://cdn.dong4j.site/source/image/20241229154732_NRNUPfjs.webp)

è¡¨ 2ï¼šç½‘ç»œæœç´¢é›†ç¾¤ä¸­ï¼Œå¯¹ä¸åŒé‡‡æ ·ç‡å¯¹ç½‘ç»œå»¶è¿Ÿå’Œååçš„å½±å“ã€‚å»¶è¿Ÿå’Œååçš„å®éªŒè¯¯å·®åˆ†åˆ«æ˜¯ 2.5% å’Œ 0.15%ã€‚

æˆ‘ä»¬çœ‹åˆ°ï¼Œè™½ç„¶å¯¹ååé‡çš„å½±å“ä¸æ˜¯å¾ˆæ˜æ˜¾ï¼Œä½†ä¸ºäº†é¿å…æ˜æ˜¾çš„å»¶è¿Ÿï¼Œè·Ÿè¸ªçš„é‡‡æ ·è¿˜æ˜¯å¿…è¦çš„ã€‚ç„¶è€Œï¼Œå»¶è¿Ÿå’Œååé‡çš„å¸¦æ¥çš„æŸå¤±åœ¨æŠŠé‡‡æ ·ç‡è°ƒæ•´åˆ°å°äº 1/16
ä¹‹åå°±å…¨éƒ¨åœ¨å®éªŒè¯¯å·®èŒƒå›´å†…ã€‚åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬å‘ç°å³ä¾¿é‡‡æ ·ç‡è°ƒæ•´åˆ° 1/1024 ä»ç„¶æ˜¯æœ‰è¶³å¤Ÿé‡çš„è·Ÿè¸ªæ•°æ®çš„ç”¨æ¥è·Ÿè¸ªå¤§é‡çš„æœåŠ¡ã€‚ä¿æŒ Dapper
çš„æ€§èƒ½æŸè€—åŸºçº¿åœ¨ä¸€ä¸ªéå¸¸ä½çš„æ°´å¹³æ˜¯å¾ˆé‡è¦çš„ï¼Œå› ä¸ºå®ƒä¸ºé‚£äº›åº”ç”¨æä¾›äº†ä¸€ä¸ªå®½æ¾çš„ç¯å¢ƒä½¿ç”¨å®Œæ•´çš„ Annotation API
è€Œæ— æƒ§æ€§èƒ½æŸå¤±ã€‚ä½¿ç”¨è¾ƒä½çš„é‡‡æ ·ç‡è¿˜æœ‰é¢å¤–çš„å¥½å¤„ï¼Œå¯ä»¥è®©æŒä¹…åŒ–åˆ°ç¡¬ç›˜ä¸­çš„è·Ÿè¸ªæ•°æ®åœ¨åƒåœ¾å›æ”¶æœºåˆ¶å¤„ç†ä¹‹å‰ä¿ç•™æ›´é•¿çš„æ—¶é—´ï¼Œè¿™æ ·ä¸º Dapper
çš„æ”¶é›†ç»„ä»¶ç»™äº†æ›´å¤šçš„çµæ´»æ€§ã€‚

## 4.4 å¯å˜é‡‡æ ·

ä»»ä½•ç»™å®šè¿›ç¨‹çš„ Dapper çš„æ¶ˆè€—å’Œæ¯ä¸ªè¿›ç¨‹å•ä½æ—¶é—´çš„è·Ÿè¸ªçš„é‡‡æ ·ç‡æˆæ­£æ¯”ã€‚Dapper çš„ç¬¬ä¸€ä¸ªç”Ÿäº§ç‰ˆæœ¬åœ¨ Google å†…éƒ¨çš„æ‰€æœ‰è¿›ç¨‹ä¸Šä½¿ç”¨ç»Ÿä¸€çš„é‡‡æ ·ç‡ï¼Œä¸º
1/1024ã€‚è¿™ä¸ªç®€å•çš„æ–¹æ¡ˆæ˜¯å¯¹æˆ‘ä»¬çš„é«˜ååé‡çš„çº¿ä¸ŠæœåŠ¡æ¥è¯´æ˜¯éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºé‚£äº›æ„Ÿå…´è¶£çš„äº‹ä»¶ (åœ¨å¤§ååé‡çš„æƒ…å†µä¸‹) ä»ç„¶å¾ˆæœ‰å¯èƒ½ç»å¸¸å‡ºç°ï¼Œå¹¶ä¸”é€šå¸¸è¶³ä»¥è¢«æ•æ‰åˆ°ã€‚

ç„¶è€Œï¼Œåœ¨è¾ƒä½çš„é‡‡æ ·ç‡å’Œè¾ƒä½çš„ä¼ è¾“è´Ÿè½½ä¸‹å¯èƒ½ä¼šå¯¼è‡´é”™è¿‡é‡è¦äº‹ä»¶ï¼Œè€Œæƒ³ç”¨è¾ƒé«˜çš„é‡‡æ ·ç‡å°±éœ€è¦èƒ½æ¥å—çš„æ€§èƒ½æŸè€—ã€‚å¯¹äºè¿™æ ·çš„ç³»ç»Ÿçš„è§£å†³æ–¹æ¡ˆå°±æ˜¯è¦†ç›–é»˜è®¤çš„é‡‡æ ·ç‡ï¼Œè¿™éœ€è¦æ‰‹åŠ¨å¹²é¢„çš„ï¼Œè¿™ç§æƒ…å†µæ˜¯æˆ‘ä»¬è¯•å›¾é¿å…åœ¨
dapper ä¸­å‡ºç°çš„ã€‚

æˆ‘ä»¬åœ¨éƒ¨ç½²å¯å˜é‡‡æ ·çš„è¿‡ç¨‹ä¸­ï¼Œå‚æ•°åŒ–é…ç½®é‡‡æ ·ç‡æ—¶ï¼Œä¸æ˜¯ä½¿ç”¨ä¸€ä¸ªç»Ÿä¸€çš„é‡‡æ ·æ–¹æ¡ˆï¼Œè€Œæ˜¯ä½¿ç”¨ä¸€ä¸ªé‡‡æ ·æœŸæœ›ç‡æ¥æ ‡è¯†å•ä½æ—¶é—´å†…é‡‡æ ·çš„è¿½è¸ªã€‚è¿™æ ·ä¸€æ¥ï¼Œä½æµé‡ä½è´Ÿè½½è‡ªåŠ¨æé«˜é‡‡æ ·ç‡ï¼Œè€Œåœ¨é«˜æµé‡é«˜è´Ÿè½½çš„æƒ…å†µä¸‹ä¼šé™ä½é‡‡æ ·ç‡ï¼Œä½¿æŸè€—ä¸€ç›´ä¿æŒåœ¨æ§åˆ¶ä¹‹ä¸‹ã€‚å®é™…ä½¿ç”¨çš„é‡‡æ ·ç‡ä¼šéšç€è·Ÿè¸ªæœ¬èº«è®°å½•ä¸‹æ¥ï¼Œè¿™æœ‰åˆ©äºä»
Dapper çš„è·Ÿè¸ªæ•°æ®ä¸­å‡†ç¡®çš„åˆ†æã€‚

## 4.5 åº”å¯¹ç§¯æé‡‡æ · (Coping with aggressive sampling)

æ–°çš„ Dapper ç”¨æˆ·å¾€å¾€è§‰å¾—ä½é‡‡æ ·ç‡ -- åœ¨é«˜ååé‡çš„æœåŠ¡ä¸‹ç»å¸¸ä½è‡³ 0.01ï¼…-- å°†ä¼šä¸åˆ©äºä»–ä»¬çš„åˆ†æã€‚æˆ‘ä»¬åœ¨ Google
çš„ç»éªŒä½¿æˆ‘ä»¬ç›¸ä¿¡ï¼Œå¯¹äºé«˜ååé‡æœåŠ¡ï¼Œç§¯æé‡‡æ · (aggressive sampling)
å¹¶ä¸å¦¨ç¢æœ€é‡è¦çš„åˆ†æã€‚å¦‚æœä¸€ä¸ªæ˜¾ç€çš„æ“ä½œåœ¨ç³»ç»Ÿä¸­å‡ºç°ä¸€æ¬¡ï¼Œä»–å°±ä¼šå‡ºç°ä¸Šåƒæ¬¡ã€‚ä½ååé‡çš„æœåŠ¡ -- ä¹Ÿè®¸æ˜¯æ¯ç§’è¯·æ±‚å‡ åæ¬¡ï¼Œè€Œä¸æ˜¯å‡ åä¸‡ --
å¯ä»¥è´Ÿæ‹…å¾—èµ·è·Ÿè¸ªæ¯ä¸€ä¸ªè¯·æ±‚ï¼Œè¿™æ˜¯ä¿ƒä½¿æˆ‘ä»¬ä¸‹å†³å¿ƒä½¿ç”¨è‡ªé€‚åº”é‡‡æ ·ç‡çš„åŸå› ã€‚

## 4.6 åœ¨æ”¶é›†è¿‡ç¨‹ä¸­é¢å¤–çš„é‡‡æ ·

ä¸Šè¿°é‡‡æ ·æœºåˆ¶è¢«è®¾è®¡ä¸ºå°½é‡å‡å°‘ä¸ Dapper è¿è¡Œåº“åä½œçš„åº”ç”¨ç¨‹åºä¸­æ˜æ˜¾çš„æ€§èƒ½æŸè€—ã€‚Dapper çš„å›¢é˜Ÿè¿˜éœ€è¦æ§åˆ¶å†™å…¥ä¸­å¤®èµ„æ–™åº“çš„æ•°æ®çš„æ€»è§„æ¨¡ï¼Œå› æ­¤ä¸ºè¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œæˆ‘ä»¬ç»“åˆäº†äºŒçº§é‡‡æ ·ã€‚

ç›®å‰æˆ‘ä»¬çš„ç”Ÿäº§é›†ç¾¤æ¯å¤©äº§ç”Ÿè¶…è¿‡ 1TB çš„é‡‡æ ·è·Ÿè¸ªæ•°æ®ã€‚Dapper çš„ç”¨æˆ·å¸Œæœ›ç”Ÿäº§ç¯å¢ƒä¸‹çš„è¿›ç¨‹çš„è·Ÿè¸ªæ•°æ®ä»è¢«è®°å½•ä¹‹åèƒ½ä¿å­˜è‡³å°‘ä¸¤å‘¨çš„æ—¶é—´ã€‚é€æ¸å¢é•¿çš„è¿½è¸ªæ•°æ®çš„å¯†åº¦å¿…é¡»å’Œ
Dapper ä¸­å¤®ä»“åº“æ‰€æ¶ˆè€—çš„æœåŠ¡å™¨åŠç¡¬ç›˜å­˜å‚¨è¿›è¡Œæƒè¡¡ã€‚å¯¹è¯·æ±‚çš„é«˜é‡‡æ ·ç‡è¿˜ä½¿å¾— Dapper æ”¶é›†å™¨æ¥è¿‘å†™å…¥ååé‡çš„ä¸Šé™ã€‚

ä¸ºäº†ç»´æŒç‰©è´¨èµ„æºçš„éœ€æ±‚å’Œæ¸å¢çš„ Bigtable çš„ååä¹‹é—´çš„çµæ´»æ€§ï¼Œæˆ‘ä»¬åœ¨æ”¶é›†ç³»ç»Ÿè‡ªèº«ä¸Šå¢åŠ äº†é¢å¤–çš„é‡‡æ ·ç‡çš„æ”¯æŒã€‚æˆ‘ä»¬å……åˆ†åˆ©ç”¨æ‰€æœ‰ span
éƒ½æ¥è‡ªä¸€ä¸ªç‰¹å®šçš„è·Ÿè¸ªå¹¶åˆ†äº«åŒä¸€ä¸ªè·Ÿè¸ª ID è¿™ä¸ªäº‹å®ï¼Œè™½ç„¶è¿™äº› span æœ‰å¯èƒ½æ¨ªè·¨äº†æ•°åƒä¸ªä¸»æœºã€‚å¯¹äºåœ¨æ”¶é›†ç³»ç»Ÿä¸­çš„æ¯ä¸€ä¸ª spanï¼Œæˆ‘ä»¬ç”¨ hash ç®—æ³•æŠŠè·Ÿè¸ª
ID è½¬æˆä¸€ä¸ªæ ‡é‡ Zï¼Œè¿™é‡Œ 0<=Z<=1ã€‚å¦‚æœ Z æ¯”æˆ‘ä»¬æ”¶é›†ç³»ç»Ÿä¸­çš„ç³»æ•°ä½çš„è¯ï¼Œæˆ‘ä»¬å°±ä¿ç•™è¿™ä¸ª span ä¿¡æ¯ï¼Œå¹¶å†™å…¥åˆ° Bigtable ä¸­ã€‚åä¹‹ï¼Œæˆ‘ä»¬å°±æŠ›å¼ƒä»–ã€‚é€šè¿‡åœ¨é‡‡æ ·å†³ç­–ä¸­çš„è·Ÿè¸ª
IDï¼Œæˆ‘ä»¬è¦ä¹ˆä¿å­˜ã€è¦ä¹ˆæŠ›å¼ƒæ•´ä¸ªè·Ÿè¸ªï¼Œè€Œä¸æ˜¯å•ç‹¬å¤„ç†è·Ÿè¸ªå†…çš„ spanã€‚æˆ‘ä»¬å‘ç°ï¼Œæœ‰äº†è¿™ä¸ªé¢å¤–çš„é…ç½®å‚æ•°ä½¿ç®¡ç†æˆ‘ä»¬çš„æ”¶é›†ç®¡é“å˜å¾—ç®€å•å¤šäº†ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨é…ç½®æ–‡ä»¶ä¸­è°ƒæ•´æˆ‘ä»¬çš„å…¨å±€å†™å…¥ç‡è¿™ä¸ªå‚æ•°ã€‚

å¦‚æœæ•´ä¸ªè·Ÿè¸ªè¿‡ç¨‹å’Œæ”¶é›†ç³»ç»Ÿåªä½¿ç”¨ä¸€ä¸ªé‡‡æ ·ç‡å‚æ•°ç¡®å®ä¼šç®€å•ä¸€äº›ï¼Œä½†æ˜¯è¿™å°±ä¸èƒ½åº”å¯¹å¿«é€Ÿè°ƒæ•´åœ¨æ‰€æœ‰éƒ¨ç½²çš„èŠ‚ç‚¹ä¸Šçš„è¿è¡ŒæœŸé‡‡æ ·ç‡é…ç½®çš„è¿™ä¸ªè¦æ±‚ã€‚æˆ‘ä»¬é€‰æ‹©äº†è¿è¡ŒæœŸé‡‡æ ·ç‡ï¼Œè¿™æ ·å°±å¯ä»¥ä¼˜é›…çš„å»æ‰æˆ‘ä»¬æ— æ³•å†™å…¥åˆ°ä»“åº“ä¸­çš„å¤šä½™æ•°æ®ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡è°ƒèŠ‚æ”¶é›†ç³»ç»Ÿä¸­çš„äºŒçº§é‡‡æ ·ç‡ç³»æ•°æ¥è°ƒæ•´è¿™ä¸ªè¿è¡ŒæœŸé‡‡æ ·ç‡ã€‚Dapper
çš„ç®¡é“ç»´æŠ¤å˜å¾—æ›´å®¹æ˜“ï¼Œå› ä¸ºæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä¿®æ”¹æˆ‘ä»¬çš„äºŒçº§é‡‡æ ·ç‡çš„é…ç½®ï¼Œç›´æ¥å¢åŠ æˆ–å‡å°‘æˆ‘ä»¬çš„å…¨å±€è¦†ç›–ç‡å’Œå†™å…¥é€Ÿåº¦ã€‚

## 5. é€šç”¨çš„ Dapper å·¥å…·

å‡ å¹´å‰ï¼Œå½“ Dapper è¿˜åªæ˜¯ä¸ªåŸå‹çš„æ—¶å€™ï¼Œå®ƒåªèƒ½åœ¨ Dapper å¼€å‘è€…è€å¿ƒçš„æ”¯æŒä¸‹ä½¿ç”¨ã€‚ä»é‚£æ—¶èµ·ï¼Œæˆ‘ä»¬é€æ¸è¿­ä»£çš„å»ºç«‹äº†æ”¶é›†ç»„ä»¶ï¼Œç¼–ç¨‹æ¥å£ï¼Œå’ŒåŸºäº Web
çš„äº¤äº’å¼ç”¨æˆ·ç•Œé¢ï¼Œå¸®åŠ© Dapper çš„ç”¨æˆ·ç‹¬ç«‹è§£å†³è‡ªå·±çš„é—®é¢˜ã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¼šæ€»ç»“ä¸€ä¸‹å“ªäº›çš„æ–¹æ³•æœ‰ç”¨ï¼Œå“ªäº›ç”¨å¤„ä¸å¤§ï¼Œæˆ‘ä»¬è¿˜æä¾›å…³äºè¿™äº›é€šç”¨çš„åˆ†æå·¥å…·çš„åŸºæœ¬çš„ä½¿ç”¨ä¿¡æ¯ã€‚

## 5.1 Dapper Depot API

Dapper çš„ â€œDepot APIâ€ æˆ–ç§°ä½œ DAPIï¼Œæä¾›åœ¨ Dapper çš„åŒºåŸŸä»“åº“ä¸­å¯¹åˆ†å¸ƒå¼è·Ÿè¸ªæ•°æ®ä¸€ä¸ªç›´æ¥è®¿é—®ã€‚DAPI å’Œ Dapper è·Ÿè¸ªä»“åº“è¢«è®¾è®¡æˆä¸²è”çš„ï¼Œè€Œä¸” DAPI
æ„å‘³ç€å¯¹ Dapper ä»“åº“ä¸­çš„å…ƒæ•°æ®æš´éœ²ä¸€ä¸ªå¹²å‡€å’Œç›´è§‚çš„çš„æ¥å£ã€‚æˆ‘ä»¬ä½¿ç”¨äº†ä»¥ä¸‹æ¨èçš„ä¸‰ç§æ–¹å¼å»æš´éœ²è¿™æ ·çš„æ¥å£ï¼š

- é€šè¿‡è·Ÿè¸ª ID æ¥è®¿é—®ï¼šDAPI å¯ä»¥é€šè¿‡ä»–çš„å…¨å±€å”¯ä¸€çš„è·Ÿè¸ª ID è¯»å–ä»»ä½•ä¸€æ¬¡è·Ÿè¸ªä¿¡æ¯ã€‚
- æ‰¹é‡è®¿é—®ï¼šDAPI å¯ä»¥åˆ©ç”¨çš„ MapReduce æä¾›å¯¹ä¸Šäº¿æ¡ Dapper è·Ÿè¸ªæ•°æ®çš„å¹¶è¡Œè¯»å–ã€‚ç”¨æˆ·é‡å†™ä¸€ä¸ªè™šæ‹Ÿå‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ª Dapper
  çš„è·Ÿè¸ªä¿¡æ¯ä½œä¸ºå…¶å”¯ä¸€çš„å‚æ•°ï¼Œè¯¥æ¡†æ¶å°†åœ¨ç”¨æˆ·æŒ‡å®šçš„æ—¶é—´çª—å£ä¸­è°ƒç”¨æ¯ä¸€æ¬¡æ”¶é›†åˆ°çš„è·Ÿè¸ªä¿¡æ¯ã€‚
- ç´¢å¼•è®¿é—®ï¼šDapper çš„ä»“åº“æ”¯æŒä¸€ä¸ªç¬¦åˆæˆ‘ä»¬é€šç”¨è°ƒç”¨æ¨¡æ¿çš„å”¯ä¸€ç´¢å¼•ã€‚è¯¥ç´¢å¼•æ ¹æ®é€šç”¨è¯·æ±‚è·Ÿè¸ªç‰¹æ€§ (commonly-requested trace features) è¿›è¡Œç»˜åˆ¶æ¥è¯†åˆ«
  Dapper çš„è·Ÿè¸ªä¿¡æ¯ã€‚å› ä¸ºè·Ÿè¸ª ID æ˜¯æ ¹æ®ä¼ªéšæœºçš„è§„åˆ™åˆ›å»ºçš„ï¼Œè¿™æ˜¯æœ€å¥½çš„åŠæ³•å»è®¿é—®è·ŸæŸä¸ªæœåŠ¡æˆ–ä¸»æœºç›¸å…³çš„è·Ÿè¸ªæ•°æ®ã€‚

æ‰€æœ‰è¿™ä¸‰ç§è®¿é—®æ¨¡å¼æŠŠç”¨æˆ·æŒ‡å‘ä¸åŒçš„ Dapper è·Ÿè¸ªè®°å½•ã€‚æ­£å¦‚ç¬¬ 2.1 èŠ‚æ‰€è¿°çš„ï¼ŒDapper çš„ç”± span ç»„æˆçš„è·Ÿè¸ªæ•°æ®æ˜¯ç”¨æ ‘å½¢ç»“æ„å»ºæ¨¡çš„ï¼Œå› æ­¤ï¼Œè·Ÿè¸ªæ•°æ®çš„æ•°æ®ç»“æ„ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç®€å•çš„ç”±
span ç»„æˆéå†æ ‘ã€‚Span å°±ç›¸å½“äº RPC è°ƒç”¨ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒRPC çš„æ—¶é—´ä¿¡æ¯æ˜¯å¯ç”¨çš„ã€‚å¸¦æ—¶é—´æˆ³çš„ç‰¹æ®Šçš„åº”ç”¨æ ‡æ³¨ä¹Ÿæ˜¯å¯ä»¥é€šè¿‡è¿™ä¸ª span ç»“æ„æ¥è®¿é—®çš„ã€‚

é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„è‡ªå®šä¹‰ç´¢å¼•æ˜¯ DAPI è®¾è®¡ä¸­æœ€å…·æŒ‘æˆ˜æ€§çš„éƒ¨åˆ†ã€‚å‹ç¼©å­˜å‚¨è¦æ±‚åœ¨è·Ÿè¸ªæ•°æ®ç§å»ºç«‹ä¸€ä¸ªç´¢å¼•çš„æƒ…å†µåªæ¯”å®é™…æ•°æ®å°
26%ï¼Œæ‰€ä»¥æ¶ˆè€—æ˜¯å·¨å¤§çš„ã€‚æœ€åˆï¼Œæˆ‘ä»¬éƒ¨ç½²äº†ä¸¤ä¸ªç´¢å¼•ï¼šç¬¬ä¸€ä¸ªæ˜¯ä¸»æœºç´¢å¼•ï¼Œå¦ä¸€ä¸ªæ˜¯æœåŠ¡åçš„ç´¢å¼•ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰æ‰¾åˆ°ä¸»æœºç´¢å¼•å’Œå­˜å‚¨æˆæœ¬ä¹‹é—´çš„åˆ©å®³å…³ç³»ã€‚å½“ç”¨æˆ·å¯¹æ¯ä¸€å°ä¸»æœºæ„Ÿå…´è¶£çš„æ—¶å€™ï¼Œä»–ä»¬ä¹Ÿä¼šå¯¹ç‰¹å®šçš„æœåŠ¡æ„Ÿå…´è¶£ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆé€‰æ‹©æŠŠä¸¤è€…ç›¸ç»“åˆï¼Œæˆä¸ºä¸€ä¸ªç»„åˆç´¢å¼•ï¼Œå®ƒå…è®¸ä»¥æœåŠ¡åç§°ï¼Œä¸»æœºï¼Œå’Œæ—¶é—´æˆ³çš„é¡ºåºè¿›è¡Œæœ‰æ•ˆçš„æŸ¥æ‰¾ã€‚

## 5.1.1 DAPI åœ¨ Google å†…éƒ¨çš„ä½¿ç”¨

DAPI åœ¨è°·æ­Œçš„ä½¿ç”¨æœ‰ä¸‰ç±»ï¼šä½¿åˆ©ç”¨ DAPI çš„æŒç»­çš„çº¿ä¸Š Web åº”ç”¨ï¼Œç»´æŠ¤è‰¯å¥½çš„å¯ä»¥åœ¨æ§åˆ¶å°ä¸Šè°ƒç”¨çš„åŸºäº DAPI çš„å·¥å…·ï¼Œå¯ä»¥è¢«å†™å…¥ï¼Œè¿è¡Œã€ä¸è¿‡å¤§éƒ¨åˆ†å·²ç»è¢«å¿˜è®°äº†çš„ä¸€æ¬¡æ€§åˆ†æå·¥å…·ã€‚æˆ‘ä»¬çŸ¥é“çš„æœ‰
3 ä¸ªæŒä¹…æ€§çš„åŸºäº DAPI çš„åº”ç”¨ç¨‹åºï¼Œ8 ä¸ªé¢å¤–çš„æŒ‰éœ€å®šåˆ¶çš„åŸºäº DAPI åˆ†æå·¥å…·ï¼Œä»¥åŠä½¿ç”¨ DAPI æ¡†æ¶æ„å»ºçš„çº¦ 15~20
ä¸€æ¬¡æ€§çš„åˆ†æå·¥å…·ã€‚åœ¨è¿™ä¹‹åçš„å·¥å…·å°±è¿™æ˜¯å¾ˆéš¾è¯´æ˜äº†ï¼Œå› ä¸ºå¼€å‘è€…å¯ä»¥æ„å»ºã€è¿è¡Œå’Œä¸¢å¼ƒè¿™äº›é¡¹ç›®ï¼Œè€Œä¸éœ€è¦ Dapper å›¢é˜Ÿçš„æŠ€æœ¯æ”¯æŒã€‚

## 5.2 Dapper çš„ç”¨æˆ·æ¥å£

ç»å¤§å¤šæ•°ç”¨æˆ·ä½¿ç”¨å‘ç”Ÿåœ¨åŸºäº web çš„ç”¨æˆ·äº¤äº’æ¥å£ã€‚ç¯‡å¹…æœ‰é™ï¼Œæˆ‘ä»¬ä¸èƒ½åˆ—å‡ºæ¯ä¸€ä¸ªç‰¹ç‚¹ï¼Œè€Œåªèƒ½æŠŠå…¸å‹çš„ç”¨æˆ·å·¥ä½œæµåœ¨å›¾ 6 ä¸­å±•ç¤ºã€‚

![20241229154732_W4wKk8eh.webp](https://cdn.dong4j.site/source/image/20241229154732_W4wKk8eh.webp)

1. ç”¨æˆ·æè¿°çš„ä»–ä»¬å…³å¿ƒçš„æœåŠ¡å’Œæ—¶é—´ï¼Œå’Œå…¶ä»–ä»»ä½•ä»–ä»¬å¯ä»¥ç”¨æ¥åŒºåˆ†è·Ÿè¸ªæ¨¡æ¿çš„ä¿¡æ¯ï¼ˆæ¯”å¦‚ï¼Œspan çš„åç§°ï¼‰ã€‚ä»–ä»¬è¿˜å¯ä»¥æŒ‡å®šä¸ä»–ä»¬çš„æœç´¢æœ€ç›¸å…³çš„æˆæœ¬åº¦é‡ (
   cost metric)(æ¯”å¦‚ï¼ŒæœåŠ¡å“åº”æ—¶é—´)ã€‚
2. ä¸€ä¸ªå…³äºæ€§èƒ½æ¦‚è¦çš„å¤§è¡¨æ ¼ï¼Œå¯¹åº”ç¡®å®šçš„æœåŠ¡å…³è”çš„æ‰€æœ‰åˆ†å¸ƒå¼å¤„ç†å›¾è¡¨ã€‚ç”¨æˆ·å¯ä»¥æŠŠè¿™äº›æ‰§è¡Œå›¾æ ‡æ’åºæˆä»–ä»¬æƒ³è¦çš„ï¼Œå¹¶é€‰æ‹©ä¸€ç§ç›´æ–¹å›¾å»å±•ç°å‡ºæ›´å¤šçš„ç»†èŠ‚ã€‚
3. ä¸€æ—¦æŸä¸ªå•ä¸€çš„åˆ†å¸ƒå¼æ‰§è¡Œéƒ¨åˆ†è¢«é€‰ä¸­åï¼Œç”¨æˆ·èƒ½çœ‹åˆ°å…³äºæ‰§è¡Œéƒ¨åˆ†çš„çš„å›¾å½¢åŒ–æè¿°ã€‚è¢«é€‰ä¸­çš„æœåŠ¡è¢«é«˜äº®å±•ç¤ºåœ¨è¯¥å›¾çš„ä¸­å¿ƒã€‚
4. åœ¨ç”Ÿæˆä¸æ­¥éª¤ 1 ä¸­é€‰ä¸­çš„æˆæœ¬åº¦é‡ (cost metric) ç»´åº¦ç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯ä¹‹åï¼ŒDapper
   çš„ç”¨æˆ·ç•Œé¢ä¼šæä¾›äº†ä¸€ä¸ªç®€å•çš„ç›´æ–¹å›¾ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ªå¤§è‡´çš„æ‰€é€‰ä¸­éƒ¨åˆ†çš„åˆ†å¸ƒå¼å“åº”æ—¶é—´åˆ†å¸ƒå›¾ã€‚ç”¨æˆ·è¿˜ä¼šçœ‹åˆ°ä¸€ä¸ªå…³äºå…·ä½“çš„è·Ÿè¸ªä¿¡æ¯çš„åˆ—è¡¨ï¼Œå±•ç°è·Ÿè¸ªä¿¡æ¯åœ¨ç›´æ–¹å›¾ä¸­è¢«åˆ’åˆ†ä¸ºçš„ä¸åŒåŒºåŸŸã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç”¨æˆ·ç‚¹å‡»åˆ—è¡¨ç§ç¬¬äºŒä¸ªè·Ÿè¸ªä¿¡æ¯å®ä¾‹æ—¶ï¼Œä¼šåœ¨ä¸‹æ–¹çœ‹åˆ°è¿™ä¸ªè·Ÿè¸ªä¿¡æ¯çš„è¯¦ç»†è§†å›¾ (
   æ­¥éª¤ 5)ã€‚
5. ç»å¤§å¤šæ•° Dapper
   çš„ä½¿ç”¨è€…æœ€ç»ˆçš„ä¼šæ£€æŸ¥æŸä¸ªè·Ÿè¸ªçš„æƒ…å†µï¼Œå¸Œæœ›èƒ½æ”¶é›†ä¸€äº›ä¿¡æ¯å»äº†è§£ç³»ç»Ÿè¡Œä¸ºçš„æ ¹æºæ‰€åœ¨ã€‚æˆ‘ä»¬æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´æ¥åšè·Ÿè¸ªè§†å›¾çš„å®¡æŸ¥ï¼Œä½†æˆ‘ä»¬ä½¿ç”¨ç”±ä¸€ä¸ªå…¨å±€æ—¶é—´è½´ï¼ˆåœ¨ä¸Šæ–¹å¯ä»¥çœ‹åˆ°ï¼‰ï¼Œå¹¶èƒ½å¤Ÿå±•å¼€å’ŒæŠ˜å æ ‘å½¢ç»“æ„çš„äº¤äº’æ–¹å¼ï¼Œè¿™ä¹Ÿå¾ˆæœ‰ç‰¹ç‚¹ã€‚åˆ†å¸ƒå¼è·Ÿè¸ªæ ‘çš„è¿ç»­å±‚ç”¨å†…åµŒçš„ä¸åŒé¢œè‰²çš„çŸ©å½¢è¡¨ç¤ºã€‚æ¯ä¸€ä¸ª
   RPC çš„ span è¢«ä»æ—¶é—´ä¸Šåˆ†è§£ä¸ºä¸€ä¸ªæœåŠ¡å™¨è¿›ç¨‹ä¸­çš„æ¶ˆè€—ï¼ˆç»¿è‰²éƒ¨åˆ†ï¼‰å’Œåœ¨ç½‘ç»œä¸Šçš„æ¶ˆè€—ï¼ˆè“è‰²éƒ¨åˆ†ï¼‰ã€‚ç”¨æˆ· Annotation æ²¡æœ‰æ˜¾ç¤ºåœ¨è¿™ä¸ªæˆªå›¾ä¸­ï¼Œä½†ä»–ä»¬å¯ä»¥é€‰æ‹©æ€§çš„ä»¥
   span çš„å½¢å¼åŒ…å«åœ¨å…¨å±€æ—¶é—´è½´ä¸Šã€‚

ä¸ºäº†è®©ç”¨æˆ·æŸ¥è¯¢å®æ—¶æ•°æ®ï¼ŒDapper çš„ç”¨æˆ·ç•Œé¢èƒ½å¤Ÿç›´æ¥ä¸ Dapper
æ¯ä¸€å°ç”Ÿäº§ç¯å¢ƒä¸‹çš„æœåŠ¡å™¨ä¸Šçš„å®ˆæŠ¤è¿›ç¨‹è¿›è¡Œäº¤äº’ã€‚åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œä¸å¯èƒ½æŒ‡æœ›èƒ½çœ‹åˆ°ä¸Šé¢æ‰€è¯´çš„ç³»ç»Ÿçº§çš„å›¾è¡¨å±•ç¤ºï¼Œä½†ä»ç„¶å¯ä»¥å¾ˆå®¹æ˜“åŸºäºæ€§èƒ½å’Œç½‘ç»œç‰¹æ€§é€‰å–ä¸€ä¸ªç‰¹å®šçš„è·Ÿè¸ªã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¯åœ¨å‡ ç§’é’Ÿå†…æŸ¥åˆ°å®æ—¶çš„æ•°æ®ã€‚

æ ¹æ®æˆ‘ä»¬çš„è®°å½•ï¼Œå¤§çº¦æœ‰ 200 ä¸ªä¸åŒçš„ Google å·¥ç¨‹å¸ˆåœ¨ä¸€å¤©å†…ä½¿ç”¨çš„ Dapper çš„ UI; åœ¨ä¸€å‘¨çš„è¿‡ç¨‹ä¸­ï¼Œå¤§çº¦æœ‰ 750-1000
ä¸åŒçš„ç”¨æˆ·ã€‚è¿™äº›ç”¨æˆ·æ•°ï¼Œåœ¨æ–°åŠŸèƒ½çš„å†…éƒ¨é€šå‘Šä¸Šï¼Œæ˜¯æŒ‰æœˆè¿ç»­çš„ã€‚é€šå¸¸ç”¨æˆ·ä¼šå‘é€ç‰¹å®šè·Ÿè¸ªçš„è¿æ¥ï¼Œè¿™å°†ä¸å¯é¿å…åœ°åœ¨æŸ¥è¯¢è·Ÿè¸ªæƒ…å†µæ—¶ä¸­äº§ç”Ÿå¾ˆå¤šä¸€æ¬¡æ€§çš„ï¼ŒæŒç»­æ—¶é—´è¾ƒçŸ­çš„äº¤äº’ã€‚

## 6. ç»éªŒ

Dapper åœ¨ Google è¢«å¹¿æ³›åº”ç”¨ï¼Œä¸€éƒ¨åˆ†ç›´æ¥é€šè¿‡ Dapper çš„ç”¨æˆ·ç•Œé¢ï¼Œå¦ä¸€éƒ¨åˆ†é—´æ¥åœ°é€šè¿‡å¯¹ Dapper API çš„äºŒæ¬¡å¼€å‘æˆ–è€…å»ºç«‹åœ¨åŸºäº api
çš„åº”ç”¨ä¸Šã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å¹¶ä¸æ‰“ç®—ç½—åˆ—å‡ºæ¯ä¸€ç§å·²çŸ¥çš„ Dapper ä½¿ç”¨æ–¹å¼ï¼Œè€Œæ˜¯è¯•å›¾è¦†ç›– Dapper ä½¿ç”¨æ–¹å¼çš„ â€œåŸºæœ¬å‘é‡â€ï¼Œå¹¶åŠªåŠ›æ¥è¯´æ˜ä»€ä¹ˆæ ·çš„åº”ç”¨æ˜¯æœ€æˆåŠŸçš„ã€‚

## 6.1 åœ¨å¼€å‘ä¸­ä½¿ç”¨ Dapper

Google AdWords ç³»ç»Ÿæ˜¯å›´ç»•ä¸€ä¸ªå¤§å‹çš„å…³é”®è¯å®šä½å‡†åˆ™å’Œç›¸å…³æ–‡å­—å¹¿å‘Šçš„æ•°æ®åº“æ­å»ºçš„ã€‚å½“æ–°çš„å…³é”®å­—æˆ–å¹¿å‘Šè¢«æ’å…¥æˆ–ä¿®æ”¹æ—¶ï¼Œå®ƒä»¬å¿…é¡»é€šè¿‡æœåŠ¡ç­–ç•¥æœ¯è¯­çš„æ£€æŸ¥ï¼ˆå¦‚æ£€æŸ¥ä¸æ°å½“çš„è¯­è¨€ï¼Œè¿™ä¸ªè¿‡ç¨‹å¦‚æœä½¿ç”¨è‡ªåŠ¨å¤æŸ¥ç³»ç»Ÿæ¥åšçš„è¯ä¼šæ›´åŠ æœ‰æ•ˆï¼‰ã€‚

å½“è½®åˆ°ä»å¤´é‡æ–°è®¾è®¡ä¸€ä¸ªå¹¿å‘Šå®¡æŸ¥æœåŠ¡æ—¶ï¼Œè¿™ä¸ªå›¢é˜Ÿè¿­ä»£çš„ä»ç¬¬ä¸€ä¸ªç³»ç»ŸåŸå‹å¼€å§‹ä½¿ç”¨ Dapperï¼Œå¹¶ä¸”ï¼Œæœ€ç»ˆç”¨ Dapper ä¸€ç›´ç»´æŠ¤ç€ä»–ä»¬çš„ç³»ç»Ÿã€‚Dapper
å¸®åŠ©ä»–ä»¬ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ”¹è¿›äº†ä»–ä»¬çš„æœåŠ¡ï¼š

- æ€§èƒ½ï¼šå¼€å‘äººå‘˜é’ˆå¯¹è¯·æ±‚å»¶è¿Ÿçš„ç›®æ ‡è¿›è¡Œè·Ÿè¸ªï¼Œå¹¶å¯¹å®¹æ˜“ä¼˜åŒ–çš„åœ°æ–¹è¿›è¡Œå®šä½ã€‚Dapper ä¹Ÿè¢«ç”¨æ¥ç¡®å®šåœ¨å…³é”®è·¯å¾„ä¸Šä¸å¿…è¦çš„ä¸²è¡Œè¯·æ±‚ --
  é€šå¸¸æ¥æºäºä¸æ˜¯å¼€å‘è€…è‡ªå·±å¼€å‘çš„å­ç³»ç»Ÿ -- å¹¶ä¿ƒä½¿å›¢é˜ŸæŒç»­ä¿®å¤ä»–ä»¬ã€‚
- æ­£ç¡®æ€§ï¼šå¹¿å‘Šå®¡æŸ¥æœåŠ¡å›´ç»•å¤§å‹æ•°æ®åº“ç³»ç»Ÿæ­å»ºã€‚ç³»ç»ŸåŒæ—¶å…·æœ‰åªè¯»å‰¯æœ¬ç­–ç•¥ï¼ˆæ•°æ®è®¿é—®å»‰ä»·ï¼‰å’Œè¯»å†™çš„ä¸»ç­–ç•¥ï¼ˆè®¿é—®ä»£ä»·é«˜ï¼‰ã€‚Dapper
  è¢«ç”¨æ¥åœ¨å¾ˆå¤šç§æƒ…å†µä¸­ç¡®å®šï¼Œå“ªäº›æŸ¥è¯¢æ˜¯æ— éœ€é€šè¿‡ä¸»ç­–ç•¥è®¿é—®è€Œå¯ä»¥é‡‡ç”¨å‰¯æœ¬ç­–ç•¥è®¿é—®ã€‚Dapper ç°åœ¨å¯ä»¥è´Ÿè´£ç›‘æ§å“ªäº›ä¸»ç­–ç•¥è¢«ç›´æ¥è®¿é—®ï¼Œå¹¶å¯¹é‡è¦çš„ç³»ç»Ÿå¸¸é‡è¿›è¡Œä¿éšœã€‚
- ç†è§£æ€§ï¼šå¹¿å‘Šå®¡æŸ¥æŸ¥è¯¢è·¨è¶Šäº†å„ç§ç±»å‹çš„ç³»ç»Ÿï¼ŒåŒ…æ‹¬ BigTableâ€”ä¹‹å‰æåˆ°çš„é‚£ä¸ªæ•°æ®åº“ï¼Œå¤šç»´ç´¢å¼•æœåŠ¡ï¼Œä»¥åŠå…¶ä»–å„ç§ C++ å’Œ Java åç«¯æœåŠ¡ã€‚Dapper
  çš„è·Ÿè¸ªç”¨æ¥è¯„ä¼°æ€»æŸ¥è¯¢æˆæœ¬ï¼Œä¿ƒè¿›é‡æ–°å¯¹ä¸šåŠ¡çš„è®¾è®¡ï¼Œç”¨ä»¥åœ¨ä»–ä»¬çš„ç³»ç»Ÿä¾èµ–ä¸Šå‡å°‘è´Ÿè½½ã€‚
- æµ‹è¯•ï¼šæ–°çš„ä»£ç ç‰ˆæœ¬ä¼šç»è¿‡ä¸€ä¸ªä½¿ç”¨ Dapper è¿›è¡Œè·Ÿè¸ªçš„ QA è¿‡ç¨‹ï¼Œç”¨æ¥éªŒè¯æ­£ç¡®çš„ç³»ç»Ÿè¡Œä¸ºå’Œæ€§èƒ½ã€‚åœ¨è·‘æµ‹è¯•çš„è¿‡ç¨‹ä¸­èƒ½å‘ç°å¾ˆå¤šé—®é¢˜ï¼Œè¿™äº›é—®é¢˜æ¥è‡ªå¹¿å‘Šå®¡æŸ¥ç³»ç»Ÿè‡ªèº«çš„ä»£ç æˆ–æ˜¯ä»–çš„ä¾èµ–åŒ…ã€‚

å¹¿å‘Šå®¡æŸ¥å›¢é˜Ÿå¹¿æ³›ä½¿ç”¨äº† Dapper Annotation APIã€‚Guice[13] å¼€æºçš„ AOP æ¡†æ¶ç”¨æ¥åœ¨é‡è¦çš„è½¯ä»¶ç»„ä»¶ä¸Šæ ‡æ³¨
â€œ@Tracedâ€ã€‚è¿™äº›è·Ÿè¸ªä¿¡æ¯å¯ä»¥è¿›ä¸€æ­¥è¢«æ ‡æ³¨ï¼ŒåŒ…å«ï¼šé‡è¦å­è·¯å¾„çš„è¾“å…¥è¾“å‡ºå¤§å°ã€åŸºç¡€ä¿¡æ¯ã€å…¶ä»–è°ƒè¯•ä¿¡æ¯ï¼Œæ‰€æœ‰è¿™äº›ä¿¡æ¯å°†ä¼šé¢å¤–å‘é€åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ã€‚

åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå‘ç°äº†ä¸€äº›å¹¿å‘Šå®¡æŸ¥å°ç»„åœ¨ä½¿ç”¨æ–¹é¢çš„ä¸è¶³ã€‚æ¯”å¦‚ï¼šä»–ä»¬æƒ³æ ¹æ®ä»–ä»¬æ‰€æœ‰è·Ÿè¸ªçš„ Annotation ä¿¡æ¯ï¼Œåœ¨ä¸€ä¸ªäº¤äº’æ—¶é—´æ®µå†…è¿›è¡Œæœç´¢ï¼Œç„¶è€Œè¿™å°±å¿…é¡»è·‘ä¸€ä¸ªè‡ªå®šä¹‰çš„
MapReduce æˆ–è¿›è¡Œæ¯ä¸€ä¸ªè·Ÿè¸ªçš„æ‰‹åŠ¨æ£€æŸ¥ã€‚å¦å¤–ï¼Œåœ¨ Google è¿˜æœ‰ä¸€äº›å…¶ä»–çš„ç³»ç»Ÿåœ¨ä¹Ÿä»é€šç”¨è°ƒè¯•æ—¥å¿—ä¸­æ”¶é›†å’Œé›†ä¸­ä¿¡æ¯ï¼ŒæŠŠé‚£äº›ç³»ç»Ÿçš„æµ·é‡æ•°æ®å’Œ Dapper
ä»“åº“æ•´åˆä¹Ÿæ˜¯æœ‰ä»·å€¼çš„ã€‚

æ€»çš„æ¥è¯´ï¼Œå³ä¾¿å¦‚æ­¤ï¼Œå¹¿å‘Šå®¡æŸ¥å›¢é˜Ÿä»ç„¶å¯¹ Dapper çš„ä½œç”¨è¿›è¡Œäº†ä»¥ä¸‹è¯„ä¼°ï¼Œé€šè¿‡ä½¿ç”¨ Dapper çš„è·Ÿè¸ªå¹³å°çš„æ•°æ®åˆ†æï¼Œä»–ä»¬çš„æœåŠ¡å»¶è¿Ÿæ€§å·²ç»ä¼˜åŒ–äº†ä¸¤ä¸ªæ•°é‡çº§ã€‚

## 6.1.1 ä¸å¼‚å¸¸ç›‘æ§çš„é›†æˆ

Google ç»´æŠ¤äº†ä¸€ä¸ªä»è¿è¡Œè¿›ç¨‹ä¸­ä¸æ–­æ”¶é›†å¹¶é›†ä¸­å¼‚å¸¸ä¿¡æ¯æŠ¥å‘Šçš„æœåŠ¡ã€‚å¦‚æœè¿™äº›å¼‚å¸¸å‘ç”Ÿåœ¨ Dapper è·Ÿè¸ªé‡‡æ ·çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œé‚£ä¹ˆç›¸åº”çš„è·Ÿè¸ª ID å’Œ span çš„ ID
ä¹Ÿä¼šä½œä¸ºå…ƒæ•°æ®è®°å½•åœ¨å¼‚å¸¸æŠ¥å‘Šä¸­ã€‚å¼‚å¸¸ç›‘æµ‹æœåŠ¡çš„å‰ç«¯ä¼šæä¾›ä¸€ä¸ªé“¾æ¥ï¼Œä»ç‰¹å®šçš„å¼‚å¸¸ä¿¡æ¯çš„æŠ¥å‘Šç›´æ¥å¯¼å‘åˆ°ä»–ä»¬å„è‡ªçš„åˆ†å¸ƒå¼è·Ÿè¸ªã€‚å¹¿å‘Šå®¡æŸ¥å›¢é˜Ÿä½¿ç”¨è¿™ä¸ªåŠŸèƒ½å¯ä»¥äº†è§£
bug å‘ç”Ÿçš„æ›´å¤§èŒƒå›´çš„ä¸Šä¸‹æ–‡ã€‚é€šè¿‡æš´éœ²åŸºäºç®€å•çš„å”¯ä¸€ ID æ„å»ºçš„æ¥å£ï¼ŒDapper å¹³å°è¢«é›†æˆåˆ°å…¶ä»–äº‹ä»¶ç›‘æµ‹ç³»ç»Ÿä¼šç›¸å¯¹å®¹æ˜“ã€‚

## 6.2 è§£å†³å»¶è¿Ÿçš„é•¿å°¾æ•ˆåº”

è€ƒè™‘åˆ°ç§»åŠ¨éƒ¨ä»¶çš„æ•°é‡ã€ä»£ç åº“çš„è§„æ¨¡ã€éƒ¨ç½²çš„èŒƒå›´ï¼Œè°ƒè¯•ä¸€ä¸ªåƒå…¨æ–‡æœç´¢é‚£æ ·æœåŠ¡ï¼ˆç¬¬ 1 èŠ‚é‡Œæåˆ°è¿‡ï¼‰æ˜¯éå¸¸å…·æœ‰æŒ‘æˆ˜æ€§çš„ã€‚åœ¨è¿™èŠ‚ï¼Œæˆ‘ä»¬æè¿°äº†æˆ‘ä»¬åœ¨å‡è½»å…¨æ–‡æœç´¢çš„å»¶è¿Ÿåˆ†å¸ƒçš„é•¿å°¾æ•ˆåº”ä¸Šåšçš„å„ç§åŠªåŠ›ã€‚Dapper
èƒ½å¤ŸéªŒè¯ç«¯åˆ°ç«¯çš„å»¶è¿Ÿçš„å‡è®¾ï¼Œæ›´å…·ä½“åœ°è¯´ï¼ŒDapper
èƒ½å¤ŸéªŒè¯å¯¹äºæœç´¢è¯·æ±‚çš„å…³é”®è·¯å¾„ã€‚å½“ä¸€ä¸ªç³»ç»Ÿä¸ä»…æ¶‰åŠæ•°ä¸ªå­ç³»ç»Ÿï¼Œè€Œæ˜¯å‡ åä¸ªå¼€å‘å›¢é˜Ÿçš„æ¶‰åŠåˆ°çš„ç³»ç»Ÿçš„æƒ…å†µä¸‹ï¼Œç«¯åˆ°ç«¯æ€§èƒ½è¾ƒå·®çš„æ ¹æœ¬åŸå› åˆ°åº•åœ¨å“ªï¼Œè¿™ä¸ªé—®é¢˜å³ä½¿æ˜¯æˆ‘ä»¬æœ€å¥½çš„å’Œæœ€æœ‰ç»éªŒçš„å·¥ç¨‹å¸ˆä¹Ÿæ— æ³•æ­£ç¡®å›ç­”ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒDapper
å¯ä»¥æä¾›æ€¥éœ€çš„æ•°æ®ï¼Œè€Œä¸”å¯ä»¥å¯¹è®¸å¤šé‡è¦çš„æ€§èƒ½é—®é¢˜å¾—å‡ºç»“è®ºã€‚

![20241229154732_MdxLbMYD.webp](https://cdn.dong4j.site/source/image/20241229154732_MdxLbMYD.webp)

å›¾ 7ï¼šå…¨å±€æœç´¢çš„è·Ÿè¸ªç‰‡æ®µï¼Œåœ¨ä¸å¸¸é‡åˆ°é«˜ç½‘ç»œå»¶è¿Ÿçš„æƒ…å†µä¸‹ï¼Œåœ¨æ²¿ç€å…³é”®è·¯å¾„çš„ç«¯åˆ°ç«¯çš„è¯·æ±‚å»¶è¿Ÿï¼Œå¦‚å›¾æ‰€ç¤ºã€‚

åœ¨è°ƒè¯•å»¶è¿Ÿé•¿å°¾æ•ˆåº”çš„è¿‡ç¨‹ä¸­ï¼Œå·¥ç¨‹å¸ˆå¯ä»¥å»ºç«‹ä¸€ä¸ªå°å‹åº“ï¼Œè¿™ä¸ªå°å‹åº“å¯ä»¥æ ¹æ® DAPI
è·Ÿè¸ªå¯¹è±¡æ¥æ¨æ–­å…³é”®è·¯å¾„çš„å±‚çº§ç»“æ„ã€‚è¿™äº›å…³é”®è·¯å¾„çš„ç»“æ„å¯ä»¥è¢«ç”¨æ¥è¯Šæ–­é—®é¢˜ï¼Œå¹¶ä¸”ä¸ºå…¨æ–‡æœç´¢æä¾›å¯ä¼˜å…ˆå¤„ç†çš„é¢„æœŸçš„æ€§èƒ½æ”¹è¿›ã€‚Dapper çš„è¿™é¡¹å·¥ä½œå¯¼è‡´äº†ä¸‹åˆ—å‘ç°ï¼š

- åœ¨å…³é”®è·¯å¾„ä¸Šçš„çŸ­æš‚çš„ç½‘ç»œæ€§èƒ½é€€åŒ–ä¸å½±å“ç³»ç»Ÿçš„ååé‡ï¼Œä½†å®ƒå¯èƒ½ä¼šå¯¹å»¶è¿Ÿå¼‚å¸¸å€¼äº§ç”Ÿæå¤§çš„å½±å“ã€‚åœ¨å›¾ 7 ä¸­å¯ä»¥çœ‹å‡ºï¼Œå¤§éƒ¨åˆ†çš„å…¨å±€æœç´¢çš„ç¼“æ…¢çš„è·Ÿè¸ªéƒ½æ¥æºäºå…³é”®è·¯å¾„çš„ç½‘ç»œæ€§èƒ½é€€åŒ–ã€‚
- è®¸å¤šé—®é¢˜å’Œä»£ä»·å¾ˆé«˜çš„æŸ¥è¯¢æ¨¡å¼æ¥æºäºä¸€äº›æ„æƒ³ä¸åˆ°çš„æœåŠ¡ä¹‹é—´çš„äº¤äº’ã€‚ä¸€æ—¦å‘ç°ï¼Œå¾€å¾€å®¹æ˜“çº æ­£å®ƒä»¬ï¼Œä½†æ˜¯ Dapper å‡ºç°ä¹‹å‰æƒ³æ‰¾å‡ºè¿™äº›é—®é¢˜æ˜¯ç›¸å½“å›°éš¾çš„ã€‚
- é€šç”¨çš„æŸ¥è¯¢ä» Dapper ä¹‹å¤–çš„å®‰å…¨æ—¥å¿—ä»“åº“ä¸­æ”¶å–ï¼Œå¹¶ä½¿ç”¨ Dapper å”¯ä¸€çš„è·Ÿè¸ª IDï¼Œä¸ Dapper çš„ä»“åº“åšå…³è”ã€‚ç„¶åï¼Œè¯¥æ˜ å°„ç”¨æ¥å»ºç«‹å…³äºåœ¨å…¨å±€æœç´¢ä¸­çš„æ¯ä¸€ä¸ªç‹¬ç«‹å­ç³»ç»Ÿéƒ½å¾ˆæ…¢çš„å®ä¾‹æŸ¥è¯¢çš„åˆ—è¡¨ã€‚

## 6.3 æ¨æ–­æœåŠ¡ä¾èµ–

åœ¨ä»»ä½•ç»™å®šçš„æ—¶é—´å†…ï¼ŒGoogle å†…éƒ¨çš„ä¸€ä¸ªå…¸å‹çš„è®¡ç®—é›†ç¾¤æ˜¯ä¸€ä¸ªæ±‡é›†äº†æˆåƒä¸Šä¸‡ä¸ªé€»è¾‘ â€œä»»åŠ¡â€ çš„ä¸»æœºï¼Œä¸€å¥—çš„å¤„ç†å™¨åœ¨æ‰§è¡Œä¸€ä¸ªé€šç”¨çš„æ–¹æ³•ã€‚Google
ç»´æŠ¤ç€è®¸å¤šè¿™æ ·çš„é›†ç¾¤ï¼Œå½“ç„¶ï¼Œäº‹å®ä¸Šï¼Œæˆ‘ä»¬å‘ç°åœ¨ä¸€ä¸ªé›†ç¾¤ä¸Šè®¡ç®—ç€çš„è¿™äº›ä»»åŠ¡é€šå¸¸ä¾èµ–äºå…¶ä»–çš„é›†ç¾¤ä¸Šçš„ä»»åŠ¡ã€‚ç”±äºä»»åŠ¡ä»¬ä¹‹é—´çš„ä¾èµ–æ˜¯åŠ¨æ€æ”¹å˜çš„ï¼Œæ‰€ä»¥ä¸å¯èƒ½ä»…ä»é…ç½®ä¿¡æ¯ä¸Šæ¨æ–­å‡ºæ‰€æœ‰è¿™äº›æœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚ä¸è¿‡ï¼Œé™¤äº†å…¶ä»–æ–¹é¢çš„åŸå› ä¹‹å¤–ï¼Œåœ¨å…¬å¸å†…éƒ¨çš„å„ä¸ªæµç¨‹éœ€è¦å‡†ç¡®çš„æœåŠ¡ä¾èµ–å…³ç³»ä¿¡æ¯ï¼Œä»¥ç¡®å®šç“¶é¢ˆæ‰€åœ¨ï¼Œä»¥åŠè®¡åˆ’æœåŠ¡çš„è¿ç§»ã€‚Google
çš„å¯ç§°ä¸º â€œService Dependenciesâ€ çš„é¡¹ç›®æ˜¯é€šè¿‡ä½¿ç”¨è·Ÿè¸ª Annotation å’Œ DAPI MapReduce æ¥å£æ¥å®ç°è‡ªåŠ¨åŒ–ç¡®å®šæœåŠ¡ä¾èµ–å½’å±çš„ã€‚

Dapper æ ¸å¿ƒç»„ä»¶ä¸ Dapper è·Ÿè¸ª Annotation ä¸€å¹¶ä½¿ç”¨çš„æƒ…å†µä¸‹ï¼Œâ€œService Dependenciesâ€ é¡¹ç›®èƒ½å¤Ÿæ¨ç®—å‡ºä»»åŠ¡å„è‡ªä¹‹é—´çš„ä¾èµ–ï¼Œä»¥åŠä»»åŠ¡å’Œå…¶ä»–è½¯ä»¶ç»„ä»¶ä¹‹é—´çš„ä¾èµ–ã€‚æ¯”å¦‚ï¼Œæ‰€æœ‰çš„
BigTable çš„æ“ä½œä¼šåŠ ä¸Šä¸å—å½±å“çš„è¡¨åç§°ç›¸å…³çš„æ ‡è®°ã€‚è¿ç”¨ Dapper çš„å¹³å°ï¼ŒService Dependencies å›¢é˜Ÿå°±å¯ä»¥è‡ªåŠ¨çš„æ¨ç®—å‡ºä¾èµ–äºå‘½åçš„ä¸åŒèµ„æºçš„æœåŠ¡ç²’åº¦ã€‚

## 6.4 ä¸åŒæœåŠ¡çš„ç½‘ç»œä½¿ç”¨ç‡

Google æŠ•å…¥äº†å¤§é‡çš„äººåŠ›å’Œç‰©åŠ›èµ„æºåœ¨ä»–çš„ç½‘ç»œç»“æ„ä¸Šã€‚ä»å‰ç½‘ç»œç®¡ç†å‘˜å¯èƒ½åªå…³æ³¨ç‹¬ç«‹çš„ç¡¬ä»¶ä¿¡æ¯ã€å¸¸ç”¨å·¥å…·åŠä»¥åŠæ­å»ºå‡ºçš„å„ç§å…¨å±€ç½‘ç»œé¸Ÿç°å›¾çš„
dashboard ä¸Šçš„ä¿¡æ¯ã€‚ç½‘ç»œç®¡ç†å‘˜ç¡®å®å¯ä»¥ä¸€è§ˆæ•´ä¸ªç½‘ç»œçš„å¥åº·çŠ¶å†µï¼Œä½†æ˜¯ï¼Œå½“é‡åˆ°é—®é¢˜æ—¶ï¼Œä»–ä»¬å¾ˆå°‘æœ‰èƒ½å¤Ÿå‡†ç¡®æŸ¥æ‰¾ç½‘ç»œè´Ÿè½½çš„å·¥å…·ï¼Œç”¨æ¥å®šä½åº”ç”¨ç¨‹åºçº§åˆ«çš„ç½ªé­ç¥¸é¦–ã€‚

è™½ç„¶ Dapper ä¸æ˜¯è®¾è®¡ç”¨æ¥åšé“¾è·¯çº§çš„ç›‘æ§çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°ï¼Œå®ƒæ˜¯éå¸¸é€‚åˆå»åšé›†ç¾¤ä¹‹é—´ç½‘ç»œæ´»åŠ¨æ€§çš„åº”ç”¨çº§ä»»åŠ¡çš„åˆ†æã€‚Google èƒ½å¤Ÿåˆ©ç”¨ Dapper
è¿™ä¸ªå¹³å°ï¼Œå»ºç«‹ä¸€ä¸ªä¸æ–­æ›´æ–°çš„æ§åˆ¶å°ï¼Œæ¥æ˜¾ç¤ºé›†ç¾¤ä¹‹é—´æœ€æ´»è·ƒçš„ç½‘ç»œæµé‡çš„åº”ç”¨çº§çš„çƒ­ç‚¹ã€‚æ­¤å¤–ï¼Œä½¿ç”¨ Dapper
æˆ‘ä»¬èƒ½å¤Ÿä¸ºæ˜‚è´µçš„ç½‘ç»œè¯·æ±‚æä¾›æŒ‡å‡ºçš„æ„æˆåŸå› çš„è·Ÿè¸ªï¼Œè€Œä¸æ˜¯é¢å¯¹ä¸åŒæœåŠ¡å™¨ä¹‹é—´çš„ä¿¡æ¯å­¤å²›è€Œæ— æ‰€é€‚ä»ã€‚å»ºç«‹ä¸€ä¸ªåŸºäº Dapper API çš„ dashboard æ€»å…±æ²¡èŠ±è¶…è¿‡
2 å‘¨çš„æ—¶é—´ã€‚

## 6.5 åˆ†å±‚å’Œå…±äº«å­˜å‚¨ç³»ç»Ÿ

åœ¨ Google çš„è®¸å¤šå­˜å‚¨ç³»ç»Ÿæ˜¯ç”±å¤šé‡ç‹¬ç«‹å¤æ‚å±‚çº§çš„åˆ†å¸ƒå¼åŸºç¡€è®¾å¤‡ç»„æˆçš„ã€‚ä¾‹å¦‚ï¼ŒGoogle çš„ App Engine[5] å°±æ˜¯æ­å»ºåœ¨ä¸€ä¸ªå¯æ‰©å±•çš„å®ä½“å­˜å‚¨ç³»ç»Ÿä¸Šçš„ã€‚è¯¥å®ä½“å­˜å‚¨ç³»ç»Ÿåœ¨åŸºäº
BigTable ä¸Šå…¬å¼€æŸäº› RDBMS åŠŸèƒ½ã€‚ BigTable çš„åŒæ—¶ä½¿ç”¨ Chubby[7]ï¼ˆåˆ†å¸ƒå¼é”ç³»ç»Ÿï¼‰åŠ GFSã€‚å†è€…ï¼Œåƒ BigTable è¿™æ ·çš„ç³»ç»Ÿç®€åŒ–äº†éƒ¨ç½²ï¼Œå¹¶æ›´å¥½çš„åˆ©ç”¨äº†è®¡ç®—èµ„æºã€‚

åœ¨è¿™ç§åˆ†å±‚çš„ç³»ç»Ÿï¼Œå¹¶ä¸æ€»æ˜¯å¾ˆå®¹æ˜“ç¡®å®šæœ€ç»ˆç”¨æˆ·èµ„æºçš„æ¶ˆè´¹æ¨¡å¼ã€‚ä¾‹å¦‚ï¼Œæ¥è‡ªäºä¸€ä¸ªç»™å®šçš„ BigTable å•å…ƒæ ¼çš„ GFS å¤§ä¿¡æ¯é‡ä¸»è¦æ¥è‡ªäºä¸€ä¸ªç”¨æˆ·æˆ–æ˜¯ç”±å¤šä¸ªç”¨æˆ·äº§ç”Ÿï¼Œä½†æ˜¯åœ¨
GFS å±‚é¢ï¼Œè¿™ä¸¤ç§æ˜æ˜¾çš„ä½¿ç”¨åœºæ™¯æ˜¯å¾ˆéš¾ç•Œå®šã€‚è€Œä¸”ï¼Œå¦‚æœç¼ºä¹ä¸€ä¸ªåƒ Dapper ä¸€æ ·çš„å·¥å…·çš„æƒ…å†µä¸‹ï¼Œå¯¹å…±äº«æœåŠ¡çš„ç«äº‰å¯èƒ½ä¼šåŒæ ·éš¾äºè°ƒè¯•ã€‚

ç¬¬ 5.2 èŠ‚ä¸­æ‰€ç¤ºçš„ Dapper çš„ç”¨æˆ·ç•Œé¢å¯ä»¥èšåˆé‚£äº›è°ƒç”¨ä»»æ„å…¬å…±æœåŠ¡çš„å¤šä¸ªå®¢æˆ·ç«¯çš„è·Ÿè¸ªçš„æ€§èƒ½ä¿¡æ¯ã€‚è¿™å°±å¾ˆå®¹æ˜“è®©æä¾›è¿™äº›æœåŠ¡çš„æºä»å¤šä¸ªç»´åº¦ç»™ä»–ä»¬çš„ç”¨æˆ·æ’åã€‚ï¼ˆä¾‹å¦‚ï¼Œå…¥ç«™çš„ç½‘ç»œè´Ÿè½½ï¼Œå‡ºç«™çš„ç½‘ç»œè´Ÿè½½ï¼Œæˆ–æœåŠ¡è¯·æ±‚çš„æ€»æ—¶é—´ï¼‰

## 6.6 Dapper çš„æ•‘ç«èƒ½åŠ› (Firefighting)

å¯¹äºä¸€äº› â€œæ•‘ç«â€ ä»»åŠ¡ï¼ŒDapper å¯ä»¥å¤„ç†å…¶ä¸­çš„ä¸€éƒ¨åˆ†ã€‚â€œæ•‘ç«â€ ä»»åŠ¡åœ¨è¿™é‡Œæ˜¯æŒ‡ä¸€äº›æœ‰é£é™©å¾ˆé«˜çš„åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸Šçš„æ“ä½œã€‚é€šå¸¸æƒ…å†µä¸‹ï¼ŒDapper ç”¨æˆ·å½“æ­£åœ¨è¿›è¡Œ
â€œæ•‘ç«â€ ä»»åŠ¡æ—¶éœ€è¦ä½¿ç”¨æ–°çš„æ•°æ®ï¼Œå¹¶ä¸”æ²¡æœ‰æ—¶é—´å†™æ–°çš„ DAPI ä»£ç æˆ–ç­‰å¾…å‘¨æœŸæ€§çš„æŠ¥å‘Šè¿è¡Œã€‚

å¯¹äºé‚£äº›é«˜å»¶è¿Ÿï¼Œä¸ï¼Œå¯èƒ½æ›´ç³Ÿç³•çš„é‚£äº›åœ¨æ­£å¸¸è´Ÿè½½ä¸‹éƒ½ä¼šå“åº”è¶…æ—¶çš„æœåŠ¡ï¼ŒDapper ç”¨æˆ·ç•Œé¢é€šå¸¸ä¼šæŠŠè¿™äº›å»¶è¿Ÿç“¶é¢ˆçš„ä½ç½®éš”ç¦»å‡ºæ¥ã€‚é€šè¿‡ä¸ Dapper
å®ˆæŠ¤è¿›ç¨‹çš„ç›´æ¥é€šä¿¡ï¼Œé‚£äº›ç‰¹å®šçš„é«˜å»¶è¿Ÿçš„è·Ÿè¸ªæ•°æ®è½»æ˜“çš„æ”¶é›†åˆ°ã€‚å½“å‡ºç°ç¾éš¾æ€§æ•…éšœæ—¶ï¼Œé€šå¸¸æ˜¯æ²¡æœ‰å¿…è¦å»çœ‹ç»Ÿè®¡æ•°æ®ä»¥ç¡®å®šæ ¹æœ¬åŸå› ï¼ŒåªæŸ¥çœ‹ç¤ºä¾‹è·Ÿè¸ªå°±è¶³å¤Ÿäº† (
å› ä¸ºå‰æ–‡æåˆ°è¿‡ä» Dapper å®ˆæŠ¤è¿›ç¨‹ä¸­å‡ ä¹å¯ä»¥ç«‹å³è·å¾—è·Ÿè¸ªæ•°æ®)ã€‚

ä½†æ˜¯ï¼Œå¦‚åœ¨ 6.5 èŠ‚ä¸­æè¿°çš„å…±äº«çš„å­˜å‚¨æœåŠ¡ï¼Œè¦æ±‚å½“ç”¨æˆ·æ´»åŠ¨è¿‡ç¨‹ä¸­çªç„¶ä¸­æ–­æ—¶èƒ½å°½å¯èƒ½å¿«çš„æ±‡æ€»ä¿¡æ¯ã€‚å¯¹äºäº‹ä»¶å‘ç”Ÿä¹‹åï¼Œå…±äº«æœåŠ¡ä»ç„¶å¯ä»¥åˆ©ç”¨æ±‡æ€»çš„çš„
Dapper æ•°æ®ï¼Œä½†æ˜¯ï¼Œé™¤éæ”¶é›†åˆ°çš„ Dapper æ•°æ®çš„æ‰¹é‡åˆ†æèƒ½åœ¨é—®é¢˜å‡ºç° 10 åˆ†é’Ÿä¹‹å†…å®Œæˆï¼Œå¦åˆ™ Dapper é¢å¯¹ä¸å…±äº«å­˜å‚¨æœåŠ¡ç›¸å…³çš„ â€œæ•‘ç«â€ ä»»åŠ¡å°±å¾ˆéš¾æŒ‰é¢„æƒ³çš„é‚£èˆ¬é¡ºåˆ©å®Œæˆã€‚

## 7. å…¶ä»–æ”¶è·

è™½ç„¶è¿„ä»Šä¸ºæ­¢ï¼Œæˆ‘ä»¬åœ¨ Dapper ä¸Šçš„ç»éªŒå·²ç»å¤§è‡´ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸï¼Œä½†æ˜¯ä¹Ÿå‡ºç°äº†ä¸€äº›ç§¯æçš„æ–¹é¢æ˜¯æˆ‘ä»¬æ²¡æœ‰å……åˆ†é¢„æ–™åˆ°çš„ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬è·å¾—äº†è¶…å‡ºé¢„æœŸçš„ Dapper
ä½¿ç”¨ç”¨ä¾‹çš„æ•°é‡ï¼Œå¯¹æ­¤æˆ‘ä»¬å¯è°“æ¬¢å¿ƒé¼“èˆã€‚å¦å¤–ï¼Œåœ¨é™¤äº†å‡ ä¸ªçš„åœ¨ç¬¬ 6 èŠ‚ä½¿ç”¨ç»éªŒä¸­æåˆ°è¿‡çš„ä¸€äº›ç”¨ä¾‹ä¹‹å¤–ï¼Œè¿˜åŒ…æ‹¬èµ„æºæ ¸ç®—ç³»ç»Ÿï¼Œå¯¹æŒ‡å®šçš„é€šè®¯æ¨¡å¼æ•æ„Ÿçš„æœåŠ¡çš„æ£€æŸ¥å·¥å…·ï¼Œä»¥åŠä¸€ç§å¯¹
RPC å‹ç¼©ç­–ç•¥çš„åˆ†æå™¨ï¼Œç­‰ç­‰ã€‚æˆ‘ä»¬è®¤ä¸ºè¿™äº›æ„æƒ³ä¸åˆ°çš„ç”¨ä¾‹ä¸€å®šç¨‹åº¦ä¸Šæ˜¯ç”±äºæˆ‘ä»¬å‘å¼€å‘è€…ä»¥ä¸€ç§ç®€å•çš„ç¼–ç¨‹æ¥å£çš„æ–¹å¼å¼€æ”¾äº†è·Ÿè¸ªæ•°æ®å­˜å‚¨çš„ç¼˜æ•…ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿå……åˆ†åˆ©ç”¨è¿™ä¸ªå¤§çš„å¤šçš„ç¤¾åŒºçš„åˆ›é€ åŠ›ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒDapper
å¯¹æ—§çš„è´Ÿè½½çš„æ”¯æŒä¹Ÿæ¯”é¢„æœŸçš„è¦ç®€å•ï¼Œåªéœ€è¦åœ¨ç¨‹åºä¸­å¼•å…¥ä¸€ä¸ªç”¨æ–°ç‰ˆæœ¬çš„é‡æ–°ç¼–è¯‘è¿‡çš„å…¬å…±ç»„ä»¶åº“ (åŒ…å«å¸¸è§„çš„çº¿ç¨‹ä½¿ç”¨ï¼Œæ§åˆ¶æµå’Œ RPC æ¡†æ¶) å³å¯ã€‚

Dapper åœ¨ Google å†…éƒ¨çš„å¹¿æ³›ä½¿ç”¨è¿˜ä¸ºæˆ‘ä»¬åœ¨ Dapper çš„å±€é™æ€§ä¸Šæä¾›äº†å®è´µçš„åé¦ˆæ„è§ã€‚ä¸‹é¢æˆ‘ä»¬å°†ä»‹ç»ä¸€äº›æˆ‘ä»¬å·²çŸ¥çš„æœ€é‡è¦çš„ Dapper çš„ä¸è¶³ï¼š

-

åˆå¹¶çš„å½±å“ï¼šæˆ‘ä»¬çš„æ¨¡å‹éšå«çš„å‰ææ˜¯ä¸åŒçš„å­ç³»ç»Ÿåœ¨å¤„ç†çš„éƒ½æ˜¯æ¥è‡ªåŒä¸€ä¸ªè¢«è·Ÿè¸ªçš„è¯·æ±‚ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç¼“å†²ä¸€éƒ¨åˆ†è¯·æ±‚ï¼Œç„¶åä¸€æ¬¡æ€§æ“ä½œä¸€ä¸ªè¯·æ±‚é›†ä¼šæ›´åŠ æœ‰æ•ˆã€‚ï¼ˆæ¯”å¦‚ï¼Œç£ç›˜ä¸Šçš„ä¸€æ¬¡åˆå¹¶å†™å…¥æ“ä½œï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€ä¸ªè¢«è·Ÿè¸ªçš„è¯·æ±‚å¯ä»¥çœ‹ä¼¼æ˜¯ä¸€ä¸ªå¤§å‹å·¥ä½œå•å…ƒã€‚æ­¤å¤–ï¼Œå½“æœ‰å¤šä¸ªè¿½è¸ªè¯·æ±‚è¢«æ”¶é›†åœ¨ä¸€èµ·ï¼Œä»–ä»¬å½“ä¸­åªæœ‰ä¸€ä¸ªä¼šç”¨æ¥ç”Ÿæˆé‚£ä¸ªå”¯ä¸€çš„è·Ÿè¸ª
IDï¼Œç”¨æ¥ç»™å…¶ä»– span ä½¿ç”¨ï¼Œæ‰€ä»¥å°±æ— æ³•è·Ÿè¸ªä¸‹å»äº†ã€‚æˆ‘ä»¬æ­£åœ¨è€ƒè™‘çš„è§£å†³æ–¹æ¡ˆï¼Œå¸Œæœ›åœ¨å¯ä»¥è¯†åˆ«è¿™ç§æƒ…å†µçš„å‰æä¸‹ï¼Œç”¨å°½å¯èƒ½å°‘çš„è®°å½•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

- è·Ÿè¸ªæ‰¹å¤„ç†è´Ÿè½½ï¼šDapper çš„è®¾è®¡ï¼Œä¸»è¦æ˜¯é’ˆå¯¹åœ¨çº¿æœåŠ¡ç³»ç»Ÿï¼Œæœ€åˆçš„ç›®æ ‡æ˜¯äº†è§£ä¸€ä¸ªç”¨æˆ·è¯·æ±‚äº§ç”Ÿçš„ç³»ç»Ÿè¡Œä¸ºã€‚ç„¶è€Œï¼Œç¦»çº¿çš„å¯†é›†å‹è´Ÿè½½ï¼Œä¾‹å¦‚ç¬¦åˆ
  MapReduce[10] æ¨¡å‹çš„æƒ…å†µï¼Œä¹Ÿå¯ä»¥å—ç›Šäºæ€§èƒ½æŒ–æ½œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè·Ÿè¸ª ID ä¸ä¸€äº›å…¶ä»–çš„æœ‰æ„ä¹‰çš„å·¥ä½œå•å…ƒåšå…³è”ï¼Œè¯¸å¦‚è¾“å…¥æ•°æ®ä¸­çš„é”®å€¼ï¼ˆæˆ–é”®å€¼çš„èŒƒå›´ï¼‰ï¼Œæˆ–æ˜¯ä¸€ä¸ª
  MapReduce shardã€‚
- å¯»æ‰¾æ ¹æºï¼šDapper
  å¯ä»¥æœ‰æ•ˆåœ°ç¡®å®šç³»ç»Ÿä¸­çš„å“ªä¸€éƒ¨åˆ†è‡´ä½¿ç³»ç»Ÿæ•´ä¸ªé€Ÿåº¦å˜æ…¢ï¼Œä½†å¹¶ä¸æ€»æ˜¯èƒ½å¤Ÿæ‰¾å‡ºé—®é¢˜çš„æ ¹æºã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªè¯·æ±‚å¾ˆæ…¢æœ‰å¯èƒ½ä¸æ˜¯å› ä¸ºå®ƒè‡ªå·±çš„è¡Œä¸ºï¼Œè€Œæ˜¯ç”±äºé˜Ÿåˆ—ä¸­å…¶ä»–æ’åœ¨å®ƒå‰é¢çš„ (
  queued ahead of) è¯·æ±‚è¿˜æ²¡å¤„ç†å®Œã€‚ç¨‹åºå¯ä»¥ä½¿ç”¨åº”ç”¨çº§çš„ annotation æŠŠé˜Ÿåˆ—çš„å¤§å°æˆ–è¿‡è½½æƒ…å†µå†™å…¥è·Ÿè¸ªç³»ç»Ÿã€‚æ­¤å¤–ï¼Œå¦‚æœè¿™ç§æƒ…å†µå±¡è§ä¸é²œï¼Œé‚£ä¹ˆåœ¨
  ProfileMe[11] ä¸­æåˆ°çš„æˆå¯¹çš„é‡‡æ ·æŠ€æœ¯å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å®ƒç”±ä¸¤ä¸ªæ—¶é—´é‡å çš„é‡‡æ ·ç‡ç»„æˆï¼Œå¹¶è§‚å¯Ÿå®ƒä»¬åœ¨æ•´ä¸ªç³»ç»Ÿä¸­çš„ç›¸å¯¹å»¶è¿Ÿã€‚
-

è®°å½•å†…æ ¸çº§çš„ä¿¡æ¯ï¼šä¸€äº›å†…æ ¸å¯è§çš„äº‹ä»¶çš„è¯¦ç»†ä¿¡æ¯æœ‰æ—¶å¯¹ç¡®å®šé—®é¢˜æ ¹æºæ˜¯å¾ˆæœ‰ç”¨çš„ã€‚æˆ‘ä»¬æœ‰ä¸€äº›å·¥å…·ï¼Œèƒ½å¤Ÿè·Ÿè¸ªæˆ–ä»¥å…¶ä»–æ–¹å¼æè¿°å†…æ ¸çš„æ‰§è¡Œï¼Œä½†æ˜¯ï¼Œæƒ³ç”¨é€šç”¨çš„æˆ–æ˜¯ä¸é‚£ä¹ˆçªå…€çš„æ–¹å¼ï¼Œæ˜¯å¾ˆéš¾æŠŠè¿™äº›ä¿¡æ¯åˆ°æ†ç»‘åˆ°ç”¨æˆ·çº§åˆ«çš„è·Ÿè¸ªä¸Šä¸‹æ–‡ä¸­ã€‚æˆ‘ä»¬æ­£åœ¨ç ”ç©¶ä¸€ç§å¦¥åçš„è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬åœ¨ç”¨æˆ·å±‚é¢ä¸ŠæŠŠä¸€äº›å†…æ ¸çº§çš„æ´»åŠ¨å‚æ•°åšå¿«ç…§ï¼Œç„¶åç»‘å®šä»–ä»¬åˆ°ä¸€ä¸ªæ´»åŠ¨çš„
span ä¸Šã€‚

## 8. ç›¸å…³äº§å“

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿè·Ÿè¸ªé¢†åŸŸï¼Œæœ‰ä¸€å¥—å®Œæ•´çš„ä½“ç³»ï¼Œä¸€éƒ¨åˆ†ç³»ç»Ÿä¸»è¦å…³æ³¨å®šä½åˆ°æ•…éšœä½ç½®ï¼Œå…¶ä»–çš„ç›®æ ‡æ˜¯é’ˆå¯¹æ€§èƒ½è¿›è¡Œä¼˜åŒ–ã€‚ Dapper
ç¡®å®è¢«ç”¨äºå‘ç°ç³»ç»Ÿé—®é¢˜ï¼Œä½†å®ƒæ›´é€šå¸¸ç”¨äºæ¢æŸ¥æ€§èƒ½ä¸è¶³ï¼Œä»¥åŠæé«˜å…¨é¢å¤§è§„æ¨¡çš„å·¥ä½œè´Ÿè½½ä¸‹çš„ç³»ç»Ÿè¡Œä¸ºçš„ç†è§£ã€‚

ä¸ Dapper ç›¸å…³çš„é»‘ç›’ç›‘æ§ç³»ç»Ÿï¼Œæ¯”å¦‚ Project5[1]ï¼ŒWAP5[15] å’Œ Sherlock[2]
ï¼Œå¯ä»¥è¯´ä¸ä¾èµ–è¿è¡Œåº“çš„æƒ…å†µä¸‹ï¼Œé»‘ç›’ç›‘æ§ç³»ç»Ÿèƒ½å¤Ÿå®ç°æ›´é«˜çš„åº”ç”¨çº§é€æ˜ã€‚é»‘ç›’çš„ç¼ºç‚¹æ˜¯ä¸€å®šç¨‹åº¦ä¸Šä¸å¤Ÿç²¾ç¡®ï¼Œå¹¶å¯èƒ½åœ¨ç»Ÿè®¡æ¨æ–­å…³é”®è·¯å¾„æ—¶å¸¦æ¥æ›´å¤§çš„ç³»ç»ŸæŸè€—ã€‚

å¯¹äºåˆ†å¸ƒå¼ç³»ç»Ÿç›‘æ§æ¥è¯´ï¼ŒåŸºäº Annotation çš„ä¸­é—´ä»¶æˆ–åº”ç”¨è‡ªèº«æ˜¯ä¸€ä¸ªå¯èƒ½æ˜¯æ›´å—æ¬¢è¿çš„è§£å†³åŠæ³•. æ‹¿ Pip[14] å’Œ Webmon[16] ç³»ç»Ÿä¸¾ä¾‹ï¼Œä»–ä»¬æ›´ä¾èµ–äºåº”ç”¨çº§çš„
Annotationï¼Œè€Œ X-Trace[12]ï¼ŒPinpoint[9] å’Œ Magpie[3] å¤§å¤šé›†ä¸­åœ¨å¯¹åº“å’Œä¸­é—´ä»¶çš„ä¿®æ”¹ã€‚Dapper æ›´æ¥è¿‘åè€…ã€‚åƒ Pinpointï¼ŒX-Traceï¼Œå’Œæ—©æœŸç‰ˆæœ¬çš„ Magpie
ä¸€æ ·ï¼ŒDapper é‡‡ç”¨äº†å…¨å±€æ ‡è¯†ç¬¦æŠŠåˆ†å¸ƒå¼ç³»ç»Ÿä¸­å„éƒ¨åˆ†ç›¸å…³çš„äº‹ä»¶è”ç³»åœ¨ä¸€èµ·ã€‚å’Œè¿™äº›ç³»ç»Ÿç±»ä¼¼ï¼ŒDapper å°è¯•é¿å…ä½¿ç”¨åº”ç”¨çº§
Annotationï¼Œè€Œæ˜¯æŠŠçš„æ¤å…¥éšè—åœ¨é€šç”¨ç»„ä»¶æ¨¡å—å†…ã€‚Magpie æ”¾å¼ƒä½¿ç”¨å…¨å±€ IDï¼Œä»ç„¶è¯•å›¾æ­£ç¡®çš„å®Œæˆè¯·æ±‚çš„æ­£ç¡®ä¼ æ’­ï¼Œä»–é€šè¿‡é‡‡ç”¨åº”ç”¨ç³»ç»Ÿå„è‡ªå†™å…¥çš„äº‹ä»¶ç­–ç•¥ï¼Œæœ€ç»ˆä¹Ÿèƒ½ç²¾ç¡®æè¿°ä¸åŒäº‹ä»¶ä¹‹é—´å…³ç³»ã€‚ä½†æ˜¯ç›®å‰è¿˜ä¸æ¸…æ¥š
Magpie åœ¨å®é™…ç¯å¢ƒä¸­å®ç°é€æ˜æ€§è¿™äº›ç­–ç•¥åˆ°åº•å¤šä¹ˆæœ‰æ•ˆã€‚ X-Trace çš„æ ¸å¿ƒ Annotation æ¯” Dapper æ›´æœ‰é‡å¿ƒä¸€äº›ï¼Œå› ä¸º X-Trace
ç³»ç»Ÿå¯¹äºè·Ÿè¸ªçš„æ”¶é›†ï¼Œä¸ä»…åœ¨è·Ÿè¸ªèŠ‚ç‚¹å±‚é¢ä¸Šï¼Œè€Œä¸”åœ¨èŠ‚ç‚¹å†…éƒ¨ä¸åŒçš„è½¯ä»¶å±‚ä¹Ÿä¼šè¿›è¡Œè·Ÿè¸ªã€‚è€Œæˆ‘ä»¬å¯¹äºç»„ä»¶çš„ä½æ€§èƒ½æŸè€—çš„è¦æ±‚è¿«ä½¿æˆ‘ä»¬ä¸èƒ½é‡‡ç”¨ X-Trace
è¿™æ ·çš„æ¨¡å‹ï¼Œè€Œæ˜¯æœç€æŠŠä¸€ä¸ªè¯·æ±‚è¿æ¥èµ·æ¥å®Œæ•´è·Ÿè¸ªæ‰€èƒ½åšåˆ°çš„æœ€å°ä»£ä»·è€ŒåŠªåŠ›ã€‚è€Œ Dapper çš„è·Ÿè¸ªä»ç„¶å¯ä»¥ä»å¯é€‰çš„åº”ç”¨çº§ Annotation ä¸­è·ç›Šã€‚

## 9. æ€»ç»“

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä»‹ç» Dapper è¿™ä¸ª Google çš„ç”Ÿäº§ç¯å¢ƒä¸‹çš„åˆ†å¸ƒå¼ç³»ç»Ÿè·Ÿè¸ªå¹³å°ï¼Œå¹¶æ±‡æŠ¥äº†æˆ‘ä»¬å¼€å‘å’Œä½¿ç”¨å®ƒçš„ç›¸å…³ç»éªŒã€‚ Dapper å‡ ä¹åœ¨éƒ¨ç½²åœ¨æ‰€æœ‰çš„ Google
ç³»ç»Ÿä¸Šï¼Œå¹¶å¯ä»¥åœ¨ä¸éœ€è¦åº”ç”¨çº§ä¿®æ”¹çš„æƒ…å†µä¸‹è¿›è¡Œè·Ÿè¸ªï¼Œè€Œä¸”æ²¡æœ‰æ˜æ˜¾çš„æ€§èƒ½å½±å“ã€‚Dapper å¯¹äºå¼€å‘äººå‘˜å’Œè¿ç»´å›¢é˜Ÿå¸¦æ¥çš„å¥½å¤„ï¼Œå¯ä»¥ä»æˆ‘ä»¬ä¸»è¦çš„è·Ÿè¸ªç”¨æˆ·ç•Œé¢çš„å¹¿æ³›ä½¿ç”¨ä¸Šçœ‹å‡ºæ¥ï¼Œå¦å¤–æˆ‘ä»¬è¿˜åˆ—ä¸¾äº†ä¸€äº›
Dapper çš„ä½¿ç”¨ç”¨ä¾‹æ¥è¯´æ˜ Dapper çš„ä½œç”¨ï¼Œè¿™äº›ç”¨ä¾‹æœ‰äº›ç”šè‡³éƒ½æ²¡æœ‰ Dapper å¼€å‘å›¢é˜Ÿå‚ä¸ï¼Œè€Œæ˜¯è¢«åº”ç”¨çš„å¼€å‘è€…å¼€å‘å‡ºæ¥çš„ã€‚

æ®æˆ‘ä»¬æ‰€çŸ¥ï¼Œè¿™æ˜¯ç¬¬ä¸€ç¯‡æ±‡æŠ¥ç”Ÿäº§ç¯å¢ƒä¸‹åˆ†å¸ƒå¼ç³»ç»Ÿè·Ÿè¸ªæ¡†æ¶çš„è®ºæ–‡ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬çš„ä¸»è¦è´¡çŒ®æºäºè¿™ä¸ªäº‹å®ï¼šè®ºæ–‡ä¸­å›é¡¾çš„è¿™ä¸ªç³»ç»Ÿå·²ç»è¿è¡Œä¸¤å¹´ä¹‹ä¹…ã€‚æˆ‘ä»¬å‘ç°ï¼Œç»“åˆå¯¹å¼€å‘äººå‘˜æä¾›ç®€å•
API å’Œå¯¹åº”ç”¨ç³»ç»Ÿå®Œå…¨é€æ˜æ¥å¢å¼ºè·Ÿè¸ªçš„è¿™ä¸ªå†³å®šï¼Œæ˜¯éå¸¸å€¼å¾—çš„ã€‚

æˆ‘ä»¬ç›¸ä¿¡ï¼ŒDapper æ¯”ä»¥å‰çš„åŸºäº Annotation
çš„åˆ†å¸ƒå¼è·Ÿè¸ªè¾¾åˆ°æ›´é«˜çš„åº”ç”¨é€æ˜åº¦ï¼Œè¿™ä¸€ç‚¹å·²ç»é€šè¿‡åªéœ€è¦å°‘é‡äººå·¥å¹²é¢„çš„å·¥ä½œé‡å¾—ä»¥è¯æ˜ã€‚è™½ç„¶ä¸€å®šç¨‹åº¦ä¸Šå¾—ç›Šäºæˆ‘ä»¬çš„ç³»ç»Ÿçš„åŒè´¨æ€§ï¼Œä½†å®ƒæœ¬èº«ä»ç„¶æ˜¯ä¸€ä¸ªé‡å¤§çš„æŒ‘æˆ˜ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬çš„è®¾è®¡æå‡ºäº†ä¸€äº›å®ç°åº”ç”¨çº§é€æ˜æ€§çš„å……åˆ†æ¡ä»¶ï¼Œå¯¹æ­¤æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿå¯¹æ›´é”™æ‚ç¯å¢ƒä¸‹çš„è§£å†³æ–¹æ¡ˆçš„å¼€å‘æœ‰æ‰€å¸®åŠ©ã€‚

æœ€åï¼Œé€šè¿‡å¼€æ”¾ Dapper è·Ÿè¸ªä»“åº“ç»™å†…éƒ¨å¼€å‘è€…ï¼Œæˆ‘ä»¬ä¿ƒä½¿æ›´å¤šçš„åŸºäºè·Ÿè¸ªä»“åº“çš„åˆ†æå·¥å…·çš„äº§ç”Ÿï¼Œè€Œä»…ä»…ç”± Dapper
å›¢é˜Ÿé»˜é»˜çš„åœ¨ä¿¡æ¯å­¤å²›ä¸­åŸ‹å¤´è‹¦å¹²çš„ç»“æœè¿œè¾¾ä¸åˆ°ç°åœ¨è¿™ä¹ˆå¤§çš„è§„æ¨¡ï¼Œè¿™ä¸ªå†³å®šä¿ƒä½¿äº†è®¾è®¡å’Œå®æ–½çš„å±•å¼€ã€‚

### Acknowledgments

We thank Mahesh Palekar, Cliff Biffle, Thomas Kotzmann, Kevin Gibbs, Yonatan Zunger, Michael Kleber, and Toby Smith for their experimental
data and feedback about Dapper experiences. We also thank Silvius Rus for his assistance with load testing. Most importantly, though, we
thank the outstanding team of engineers who have continued to develop and improve Dapper over the years; in order of appearance, Sharon
Perl, Dick Sites, Rob von Behren, Tony DeWitt, Don Pazel, Ofer Zajicek, Anthony Zana, Hyang-Ah Kim, Joshua MacDonald, Dan Sturman, Glenn
Willen, Alex Kehlenbeck, Brian McBarron, Michael Kleber, Chris Povirk, Bradley White, Toby Smith, Todd Derr, Michael De Rosa, and Athicha
Muthitacharoen. They have all done a tremendous amount of work to make Dapper a day-to-day reality at Google.

### References

[1] M. K. Aguilera, J. C. Mogul, J. L. Wiener, P. Reynolds, and A. Muthitacharoen. Performance Debugging for Distributed Systems of Black
Boxes. In Proceedings of the 19th ACM Symposium on Operating Systems Principles, December 2003.
[2] P. Bahl, R. Chandra, A. Greenberg, S. Kandula, D. A. Maltz, and M. Zhang. Towards Highly Reliable Enterprise Network Services Via
Inference of Multi-level Dependencies. In Proceedings of SIGCOMM, 2007.
[3] P. Barham, R. Isaacs, R. Mortier, and D. Narayanan. Magpie: online modelling and performance-aware systems. In Proceedings of USENIX
HotOS IX, 2003.
[4] L. A. Barroso, J. Dean, and U. Holzle. Web Search for a Planet: The Google Cluster Architecture. IEEE Micro, 23(2):22â€“28, March/April

2003.

[5] T. O. G. Blog. Developers, start your engines. http://googleblog.blogspot.com/2008/04/developers-start-your-engines.html,2007.
[6] T. O. G. Blog. Universal search: The best answer is still the best
answer. http://googleblog.blogspot.com/2007/05/universal-search-best-answer-is-still.html, 2007.
[7] M. Burrows. The Chubby lock service for loosely-coupled distributed systems. In Proceedings of the 7th USENIX Symposium on Operating
Systems Design and Implementation, pages 335 â€“ 350, 2006.
[8] F. Chang, J. Dean, S. Ghemawat, W. C. Hsieh, D. A. Wallach, M. Burrows, T. Chandra, A. Fikes, and R. E. Gruber. Bigtable: A Distributed
Storage System for Structured Data. In Proceedings of the 7th USENIX Symposium on Operating Systems Design and Implementation (OSDIâ€™06),
November 2006.
[9] M. Y. Chen, E. Kiciman, E. Fratkin, A. fox, and E. Brewer. Pinpoint: Problem Determination in Large, Dynamic Internet Services. In
Proceedings of ACM International Conference on Dependable Systems and Networks, 2002.
[10] J. Dean and S. Ghemawat. MapReduce: Simplified Data Processing on Large Clusters. In Proceedings of the 6th USENIX Symposium on
Operating Systems Design and Implementation (OSDIâ€™04), pages 137 â€“ 150, December 2004.
[11] J. Dean, J. E. Hicks, C. A. Waldspurger, W. E. Weihl, and G. Chrysos. ProfileMe: Hardware Support for Instruction-Level Profiling on
Out-of-Order Processors. In Proceedings of the IEEE/ACM International Symposium on Microarchitecture, 1997.
[12] R. Fonseca, G. Porter, R. H. Katz, S. Shenker, and I. Stoica. X-Trace: A Pervasive Network Tracing Framework. In Proceedings of USENIX
NSDI, 2007.
[13] B. Lee and K. Bourrillion. The Guice Project Home Page. http://code.google.com/p/google-guice/, 2007.
[14] P. Reynolds, C. Killian, J. L. Wiener, J. C. Mogul, M. A. Shah, and A. Vahdat. Pip: Detecting the Unexpected in Distributed Systems. In
Proceedings of USENIX NSDI, 2006.
[15] P. Reynolds, J. L. Wiener, J. C. Mogul, M. K. Aguilera, and A. Vahdat. WAP5: Black Box Performance Debugging for Wide-Area Systems. In
Proceedings of the 15th International World Wide Web Conference, 2006.
[16] P. K. G. T. Gschwind, K. Eshghi and K. Wurster. WebMon: A Performance Profiler for Web Transactions. In E-Commerce Workshop, 2002.

[](https://github.com/bigbully/Dapper-translation)is maintained by[bigbully](https://github.com/bigbully).

This page was generated by[GitHub Pages](http://bigbully.github.io/Dapper-translation/pages.github.com)using the Architect theme
by[Jason Long](http://twitter.com/jasonlong).

## [IntelliJ IDEA ç¿»è¯‘æ’ä»¶å¼€å‘ - ä»æ¦‚å¿µåˆ°å®è·µ](https://blog.dong4j.site/posts/d2f9713d.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

ç›¸å¯¹äº Hello World ç‰ˆçš„æ’ä»¶, æˆ‘ä»¬å¯ä»¥å­¦ä¹ ä¸€ä¸ª API çš„ç”¨æ³•.

åœ¨æ¥ä¸‹æ¥çš„åšæ–‡ä¸­å°†åˆ›å»ºä¸€ä¸ªç¿»è¯‘æ’ä»¶, ç›¸å¯¹äº Hello World ç‰ˆçš„æ’ä»¶,
æˆ‘ä»¬å¯ä»¥å­¦ä¹ ä¸€ä¸ª API çš„ç”¨æ³•.

åœ¨å†™ä¹‹å‰, å…ˆè¡¥å……ä¸€ä¸‹ä¸Šä¸€ç¯‡åšæ–‡ä¸­å­˜åœ¨çš„é—®é¢˜.

## ä½¿ç”¨ Gradle å¼€å‘ Intellij IDEA Plugin çš„é—®é¢˜

å½“æˆ‘ä»¬ä½¿ç”¨ Intellij è‡ªå¸¦çš„ Intellij Platform Plugin åˆ›å»ºæ’ä»¶é¡¹ç›®å, æˆ‘ä»¬å¯ä»¥é€šè¿‡ Intellij ä»¥å›¾å½¢åŒ–ç•Œé¢åˆ›å»º Action, Module Component ç­‰,
å°±åƒè¿™æ ·:

![20241229154732_agqWr29W.webp](https://cdn.dong4j.site/source/image/20241229154732_agqWr29W.webp)

![20241229154732_oLiFqQVA.webp](https://cdn.dong4j.site/source/image/20241229154732_oLiFqQVA.webp)

OK ä¹‹å, å°±ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª `GenerateActionByGui` ç»§æ‰¿ AnAction çš„ç±», å¹¶ä¸”åœ¨ plugin.xml ä¸­è‡ªåŠ¨å†™å…¥æ’ä»¶çš„é…ç½®:

```xml
<actions>
    <action id="plugin.demo" class="com.code.demo.GenerateActionByGui" text="demo" description="this is a demo">
      <add-to-group group-id="WindowMenu" anchor="first"/>
    </action>
</actions>
```

ç®€å•å¿«æ·æ–¹ä¾¿, å°†ç¨‹åºçŒ¿å·æ‡’çš„ç²¾ç¥å±•ç°çš„æ·‹æ¼“å°½è‡´, é‚£ä¹ˆé—®é¢˜æ¥äº†.......

å½“æˆ‘ä»¬ä½¿ç”¨ Gradle æˆ–è€… Maven è¿™ç§é¡¹ç›®ç®¡ç†è½¯ä»¶åˆ›å»º æ’ä»¶é¡¹ç›®æ—¶, ä½ ä¼šå‘ç°è¿™äº›åŠŸèƒ½æ²¡æœ‰äº†, ä¸ä¿¡ä½ çœ‹..

![20241229154732_WEwAIx7S.webp](https://cdn.dong4j.site/source/image/20241229154732_WEwAIx7S.webp)

æ²¡æœ‰é€‰æ‹© Action çš„æŒ‰é’®äº†, è€Œä¸”è¿˜è¦ä¸€ä¸ªé—®é¢˜

![20241229154732_MODMbmRJ.webp](https://cdn.dong4j.site/source/image/20241229154732_MODMbmRJ.webp)

Use classpath of module ä¸€ç›´ä¸º [none] , è¿™æ—¶å€™è¯¥æ€ä¹ˆåŠå‘¢?

### è§£å†³æ–¹æ³•

è¿™é‡Œé¦–å…ˆåº”è¯¥æƒ³åˆ°, ä¸ºä»€ä¹ˆåˆ›å»º Intellij Platform Plugin é¡¹ç›®å’Œåˆ›å»º Gradle é¡¹ç›®å­˜åœ¨åŒºåˆ«? IDEA åº”è¯¥ä¼šæ ¹æ®ä¸åŒçš„é¡¹ç›®ç±»åˆ«æ˜¾ç¤ºä¸åŒçš„å¯ç”¨åŠŸèƒ½æŒ‰é’®.
å¯¹ Intellij IDEA äº†è§£çš„æœ‹å‹åº”è¯¥çŸ¥é“, å½“åˆ›å»ºæˆ–è€…æ‰“å¼€ä¸€ä¸ª IDEA å·¥ç¨‹æ—¶, ä¼šè‡ªåŠ¨åˆ›å»º .idea æ–‡ä»¶å¤¹ å’Œ .iml æ–‡ä»¶, iml æ˜¯ Intellij IDEA
çš„å·¥ç¨‹é…ç½®æ–‡ä»¶ï¼Œé‡Œé¢æ˜¯å½“å‰ projec çš„ä¸€äº›é…ç½®ä¿¡æ¯. æ—¢ç„¶æ˜¯å·¥ç¨‹é…ç½®æ–‡ä»¶, åº”è¯¥ä¼šæ ‡è¯†å½“å‰é¡¹ç›®æ˜¯å±äºå“ªç§ç±»å‹çš„å·¥ç¨‹, é¡ºç€è¿™ç§æ€è·¯, è¿˜çœŸè¢«æˆ‘æ‰¾åˆ°äº†.

ä½¿ç”¨ Gradle åˆ›å»ºçš„é¡¹ç›®ä¸­, åœ¨ .idea/moudle/ ä¸‹æœ‰ 3 ä¸ª .iml æ–‡ä»¶

![20241229154732_AuprBGdq.webp](https://cdn.dong4j.site/source/image/20241229154732_AuprBGdq.webp)

æˆ‘ä»¬éœ€è¦æ”¹çš„å°±æ˜¯ `_main.iml`

åŸæ¥çš„æ–‡ä»¶å†…å®¹:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<module external.linked.project.id="Translation:main" external.linked.project.path="$MODULE_DIR$/../.." external.root.project.path="$MODULE_DIR$/../.." external.system.id="GRADLE" external.system.module.group="" external.system.module.type="sourceSet" external.system.module.version="unspecified" type="JAVA_MODULE" version="4">
  <component name="NewModuleRootManager" LANGUAGE_LEVEL="JDK_1_8" inherit-compiler-output="false">
    <output url="file://$MODULE_DIR$/../../build/classes/main" />
    <exclude-output />
    <content url="file://$MODULE_DIR$/../../src/main">
      <sourceFolder url="file://$MODULE_DIR$/../../src/main/java" isTestSource="false" />
      <sourceFolder url="file://$MODULE_DIR$/../../src/main/resources" type="java-resource" />
    </content>
    ......
```

æ”¹è¿‡ä¹‹åçš„å†…å®¹:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<module external.linked.project.id="Translation:main" external.linked.project.path="$MODULE_DIR$/../.." external.root.project.path="$MODULE_DIR$/../.." external.system.id="GRADLE" external.system.module.group="" external.system.module.type="sourceSet" external.system.module.version="unspecified" type="PLUGIN_MODULE" version="4">
  <!-- æ–°åŠ çš„ä¸€è¡Œ -->
  <component name="DevKit.ModuleBuildProperties" url="file://$MODULE_DIR$/../../src/main/resources/META-INF/plugin.xml" />
  <component name="NewModuleRootManager" LANGUAGE_LEVEL="JDK_1_8" inherit-compiler-output="false">
    <output url="file://$MODULE_DIR$/../../build/classes/main" />
    <exclude-output />
    <content url="file://$MODULE_DIR$/../../src/main">
      <sourceFolder url="file://$MODULE_DIR$/../../src/main/java" isTestSource="false" />
      <sourceFolder url="file://$MODULE_DIR$/../../src/main/resources" type="java-resource" />
    </content>
    ......
```

åŒºåˆ«å°±æ˜¯å°† `<module>` æ ‡ç­¾ä¸­çš„ type å±æ€§ç”±åŸæ¥çš„ JAVA_MODULE æ”¹ä¸º PLUGIN_MODULE. ä¿®æ”¹ä¹‹åæ•´ä¸ªé¡¹ç›®å…¶å®å·²ç»æ˜¯ä¸€ä¸ª Plugin é¡¹ç›®äº†

![20241229154732_Y8lFfaE8.webp](https://cdn.dong4j.site/source/image/20241229154732_Y8lFfaE8.webp)

å›¾æ ‡éƒ½å˜æˆ Plugin ç‰¹æœ‰çš„äº†, çœ‹åˆ°è¿™ä¸ªæˆ‘å°±æ”¾å¿ƒäº†.....

å¦‚æœç°åœ¨é€šè¿‡ GUI åˆ›å»ºä¸€ä¸ª Action, åˆ°æœ€åä½ ä¼šå‘ç°ä¼šæŠ¥ä¸€ä¸ªæ‰¾ä¸åˆ° plugin.xml çš„é”™è¯¯, æ‰€ä»¥è¿˜éœ€è¦æ·»åŠ ä¸€ä¸ªè¡Œ

```xml
<component name="DevKit.ModuleBuildProperties" url="file://$MODULE_DIR$/../../src/main/resources/META-INF/plugin.xml" />
```

è®© IDEA æ‰¾åˆ° plugin.xml, å¹¶åœ¨æˆ‘ä»¬åˆ›å»ºå¥½ Action å, å‘ plugin.xml ä¸­å†™å…¥ Action é…ç½®.

è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ²¡æœ‰è§£å†³, è™½ç„¶æˆ‘ä»¬å·²ç»èƒ½é…ç½®

![20241229154732_fgyzTJ2T.webp](https://cdn.dong4j.site/source/image/20241229154732_fgyzTJ2T.webp)

ä½†æ˜¯å½“è¿è¡Œçš„æ—¶å€™, å´ä¼šæŠ¥é”™, å› ä¸ºæˆ‘ä»¬çš„ä¾èµ–æ˜¯é€šè¿‡ Gradle ç®¡ç†çš„, è¿™æ ·ç›´æ¥è¿è¡Œè™½ç„¶èƒ½æ‰“å¼€å®¹å™¨, ä½†å´ä¸èƒ½è°ƒè¯•æˆ‘ä»¬çš„æ’ä»¶, æˆ‘ä»¬è¿˜æ˜¯é€šè¿‡ Gradle è¿è¡Œ

```shell
gradle runI
```

å¦‚æœä» GitHub ä¸Š clone ä¸‹æ¥ä¸€ä¸ªä¼˜ç§€çš„æ’ä»¶å­¦ä¹ çš„è¯, clone ä¸‹æ¥çš„åŒ…ä¸­å¯èƒ½æ²¡æœ‰ .idea è¿™ä¸ªæ–‡ä»¶å¤¹, å½“å¯¼å…¥åˆ° IDEA ä¸­æ—¶,
åªæœ‰
![20241229154732_hB7EeLXq.webp](https://cdn.dong4j.site/source/image/20241229154732_hB7EeLXq.webp)
è¿™ 3 ä¸ªé€‰æ‹©, å¦‚æœä¸æ˜¯ä¸Šè¿°é¡¹ç›®, æˆ‘é€‰æ‹©ç›´æ¥æ‰“å¼€é¡¹ç›®, ç­‰ IDEA è‡ªåŠ¨åˆ›å»ºå¥½ .idea å, é€šè¿‡ä¿®æ”¹ .iml æ–‡ä»¶, å°†é¡¹ç›®æ”¹ä¸º plugin é¡¹ç›®, ç„¶åå°±å¯ä»¥åˆ›å»º
Plugin çš„è¿è¡Œç¯å¢ƒäº†. è¿™ç§æ–¹æ³•é€‚åˆæ²¡æœ‰é€šè¿‡ Gradle æˆ–è€… Maven é¡¹ç›®ç®¡ç†çš„ Plugin é¡¹ç›®.

é—®é¢˜è§£å†³, æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªç¿»è¯‘æ’ä»¶çš„å¼€å‘è¿‡ç¨‹

## ç¿»è¯‘æ’ä»¶å¼€å‘

æ„‰å¿«çš„ç”¨ GUI åˆ›å»ºä¸€ä¸ª Action

![20241229154732_OeiDbFYr.webp](https://cdn.dong4j.site/source/image/20241229154732_OeiDbFYr.webp)

### æœ‰é“ API

æœ‰é“ç¿»è¯‘ API HTTP åœ°å€ï¼š

> [http://openapi.youdao.com/api](http://openapi.youdao.com/api)

æœ‰é“ç¿»è¯‘ API HTTPS åœ°å€ï¼š

> [https://openapi.youdao.com/api](https://openapi.youdao.com/api)

## æ¥å£è°ƒç”¨å‚æ•° [](http://ai.youdao.com/docs/api.s#id2 "æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜")

è°ƒç”¨ API éœ€è¦å‘æ¥å£å‘é€ä»¥ä¸‹å­—æ®µæ¥è®¿é—®æœåŠ¡ã€‚

| å­—æ®µå | ç±»å‹ | å«ä¹‰                                      | å¿…å¡« | å¤‡æ³¨                                                            |
| :----- | :--- | :---------------------------------------- | :--- | :-------------------------------------------------------------- |
| q      | text | è¦ç¿»è¯‘çš„æ–‡æœ¬                              | True | å¿…é¡»æ˜¯ UTF-8 ç¼–ç                                                |
| from   | text | æºè¯­è¨€                                    | True | [è¯­è¨€åˆ—è¡¨](http://ai.youdao.com/docs/api.s#id5) (å¯è®¾ç½®ä¸º auto) |
| to     | text | ç›®æ ‡è¯­è¨€                                  | True | [è¯­è¨€åˆ—è¡¨](http://ai.youdao.com/docs/api.s#id5) (å¯è®¾ç½®ä¸º auto) |
| appKey | text | åº”ç”¨ ID                                   | True | å¯åœ¨ [åº”ç”¨ç®¡ç†](http://ai.youdao.com/appmgr.s) æŸ¥çœ‹             |
| salt   | text | éšæœºæ•°                                    | True |                                                                 |
| sign   | text | ç­¾åï¼Œé€šè¿‡ md5(appKey+q+salt + å¯†é’¥) ç”Ÿæˆ | True | appKey+q+salt + å¯†é’¥çš„ MD5 å€¼                                   |

ç­¾åç”Ÿæˆæ–¹æ³•å¦‚ä¸‹ï¼š

1ã€å°†è¯·æ±‚å‚æ•°ä¸­çš„ appKeyï¼Œç¿»è¯‘æ–‡æœ¬ query(q, æ³¨æ„ä¸º UTF-8 ç¼–ç )ï¼Œéšæœºæ•° (salt) å’Œå¯†é’¥ ï¼ˆå¯åœ¨ [åº”ç”¨ç®¡ç†](http://ai.youdao.com/appmgr.s) æŸ¥çœ‹ï¼‰ï¼Œ æŒ‰ç…§
appid+q+salt + å¯†é’¥ çš„é¡ºåºæ‹¼æ¥å¾—åˆ°å­—ç¬¦ä¸² strã€‚

2ã€å¯¹å­—ç¬¦ä¸² str åš md5ï¼Œå¾—åˆ° 32 ä½å°å†™çš„ sign[(å‚è€ƒ Java ç”Ÿæˆ MD5 ç¤ºä¾‹)](http://ai.youdao.com/docs/api.s#java-demo)

æ³¨æ„:

1ã€è¯·å…ˆå°†éœ€è¦ç¿»è¯‘çš„æ–‡æœ¬è½¬æ¢ä¸º UTF-8 ç¼–ç 

2ã€åœ¨å‘é€ HTTP è¯·æ±‚ä¹‹å‰éœ€è¦å¯¹å„å­—æ®µåš URL encodeã€‚

3ã€åœ¨ç”Ÿæˆç­¾åæ‹¼æ¥ appKey+q+salt å­—ç¬¦ä¸²æ—¶ï¼Œq ä¸éœ€è¦åš URL encodeï¼Œåœ¨ç”Ÿæˆç­¾åä¹‹åï¼Œå‘é€ HTTP è¯·æ±‚ä¹‹å‰æ‰éœ€è¦å¯¹è¦å‘é€çš„å¾…ç¿»è¯‘æ–‡æœ¬å­—æ®µ q åš URL
encodeã€‚

## è¾“å‡ºç»“æœ [](http://ai.youdao.com/docs/api.s#id3 "æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜")

è¿”å›çš„ç»“æœæ˜¯ json æ ¼å¼ï¼ŒåŒ…å«å­—æ®µä¸ FROM å’Œ TO çš„å€¼æœ‰å…³ï¼Œå…·ä½“è¯´æ˜å¦‚ä¸‹ï¼š

| å­—æ®µå      | ç±»å‹ | å«ä¹‰         | å¤‡æ³¨                       |
| :---------- | :--- | :----------- | :------------------------- |
| errorCode   | text | é”™è¯¯è¿”å›ç    | ä¸€å®šå­˜åœ¨                   |
| query       | text | æºè¯­è¨€       | æŸ¥è¯¢æ­£ç¡®æ—¶ï¼Œä¸€å®šå­˜åœ¨       |
| speakUrl    | text | è¾“å…¥å‘éŸ³åœ°å€ | è¾“å…¥å‘éŸ³åœ°å€ï¼Œä¸€å®šå­˜åœ¨     |
| tSpeakUrl   | text | ç¿»è¯‘å‘éŸ³åœ°å€ | ç¿»è¯‘å‘éŸ³åœ°å€ï¼Œä¸€å®šå­˜åœ¨     |
| translation | text | ç¿»è¯‘ç»“æœ     | æŸ¥è¯¢æ­£ç¡®æ—¶ä¸€å®šå­˜åœ¨         |
| basic       | text | è¯ä¹‰         | åŸºæœ¬è¯å…¸, æŸ¥è¯æ—¶æ‰æœ‰       |
| web         | text | è¯ä¹‰         | ç½‘ç»œé‡Šä¹‰ï¼Œè¯¥ç»“æœä¸ä¸€å®šå­˜åœ¨ |

## æ€»ç»“

1. æ€ä¹ˆè·å–é€‰æ‹©çš„å¯¹è±¡?
2.

Action ID : ä»£è¡¨å½“å‰ Action çš„å”¯ä¸€ id
Class Name : ç±»å
Name : æ’ä»¶æŒ‰é’®æ˜¾ç¤ºåœ¨èœå•ä¸Šçš„åç§°
Description : é¼ æ ‡æ‚¬æµ®åœ¨æŒ‰é’®ä¸Šæ—¶, ç•Œé¢åº•éƒ¨æ˜¾å¾—çš„æè¿°
Add to Group : åŠŸèƒ½æŒ‰é’®æ·»åŠ çš„ä½ç½®
Groups : æ‰€å±çš„åˆ†ç»„
Action : è®¾ç½®åœ¨ç»„ä¸­çš„ä½ç½®
Keyboard shortcuts : åŠŸèƒ½æŒ‰é’®çš„å¿«æ·é”®

#### æ’ä»¶å¼€å‘ä¸€äº› API

è·å–å½“å‰ç¼–è¾‘çš„æ–‡ä»¶
`PsiFile psiFile = event.getData(LangDataKeys.PSI_FILE);`
å¯ä»¥é€šè¿‡ä¸‹é¢ä¸¤ç§æ–¹å¼å¯¹æ–‡ä»¶çš„è¿›è¡Œæ“ä½œï¼š

```
new WriteCommandAction.Simple(event.getProject(), psiFile) {
    @Override
    protected void run() throws Throwable {
        // do something
    }
}.execute();
```

```
WriteCommandAction.runWriteCommandAction(event.getProject(), new Runnable() {
    @Override
    public void run() {
        // do something
    }
});
```

è·å–å½“å‰ç¼–è¾‘çš„ class å¯¹è±¡

```
PsiElement element = psiFile.findElementAt(editor.getCaretModel().getOffset());
PsiClass psiClass = PsiTreeUtil.getParentOfType(element, PsiClass.class);
```

è·å–ç±»å

```
String className = psiClass.getNameIdentifier().getText();
```

è·å¾— PsiElementFactory å¯¹è±¡ å¯ä»¥é€šè¿‡è¿™ä¸ªå·¥å‚ç±»åˆ›å»ºæˆå‘˜å˜é‡ æ–¹æ³• ç±»ç­‰ç­‰

```
PsiElementFactory elementFactory = JavaPsiFacade.getElementFactory(project);
```

æ·»åŠ ä¸€ä¸ªæ–¹æ³•

```
String methodText = buildMethodText(className);
PsiMethod psiMethod = elementFactory.createMethodFromText(methodText, psiClass);
psiClass.add(psiMethod);
```

```
private String buildMethodText (String className){
    return "public static " + className + " getInstance() {\n" +
            "        return " + buildFiledText() + ";\n" +
            "    }";
}
```

æ·»åŠ ä¸€ä¸ªæ„é€ æ–¹æ³•

```
PsiMethod constructor = elementFactory.createConstructor();
psiClass.add(constructor);
```

æ·»åŠ ä¸€ä¸ªæˆå‘˜å˜é‡ï¼ŒPsiType è¡¨ç¤ºå˜é‡çš„ç±»å‹ï¼ŒPsiModifierList ä»£è¡¨å˜é‡çš„ä¿®é¥°ç¬¦ï¼Œå¯ä»¥é€šè¿‡ setInitializer è®¾ç½®å˜é‡åˆå§‹åŒ–æ–¹å¼

```
PsiType psiType = PsiType.getTypeByName(className, project
        , GlobalSearchScope.EMPTY_SCOPE);
PsiField psiField = elementFactory.createField("mInstance", psiType);
PsiExpression psiInitializer = elementFactory.createExpressionFromText("new " + className + "()", psiField);
psiField.setInitializer(psiInitializer);
PsiModifierList modifierList = psiField.getModifierList();
if (modifierList != null) {
    modifierList.setModifierProperty(PsiModifier.STATIC, true);
}
psiClass.add(psiField);
```

æ·»åŠ ä¸€ä¸ªå†…éƒ¨ç±»

```
PsiClass innerClass = elementFactory.createClass(innerClassName);
PsiModifierList classModifierList = innerClass.getModifierList();
if (classModifierList != null) {
    classModifierList.setModifierProperty(PsiModifier.PRIVATE, true);
    classModifierList.setModifierProperty(PsiModifier.STATIC, true);
}
psiClass.add(innerClass);
```

å…¶ä»–

```
// åˆ›å»ºæšä¸¾
PsiClass anEnum = elementFactory.createEnum("TestEnum");
// åˆ›å»ºä¸€ä¸ªæšä¸¾å¸¸é‡
PsiEnumConstant enumConstant= elementFactory.createEnumConstantFromText("TEST",anEnum);
// åˆ›å»ºæ¥å£
elementFactory.createInterface("TestInterface");
```

æ ¼å¼åŒ–ä»£ç 

```
CodeStyleManager.getInstance(project).reformat(psiClass);
```

æ’ä»¶çš„ UI éƒ½æ˜¯ä½¿ç”¨ java Swing æ¥å®ç°ï¼Œæ¯”å¦‚åˆ›å»ºä¸€ä¸ª Dialog:src>new>Dialog; ç„¶åä¼šç”Ÿæˆä¸€ä¸ª JDialog çš„ java ç±»å’Œä¸€ä¸ª Dialog çš„ from æ–‡ä»¶ã€‚ç„¶ååœ¨
Action ä¸­ä½¿ç”¨ï¼š

```
TestDialog dialog = new TestDialog();
dialog.setBounds(new Rectangle(300, 200));
// è®© dialog å±…ä¸­
dialog.setLocationRelativeTo(null);
dialog.setVisible(true);
```

## [æŒæ¡IntelliJæ’ä»¶å¼€å‘ï¼šä»Gradleå…¥é—¨åˆ°é«˜çº§å®æˆ˜](https://blog.dong4j.site/posts/7dc8ea5f.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

IDEA Plugin å¼€å‘è®°å½• hello world ç¯‡.

ä¸ºä»€ä¹ˆæ²¡æœ‰ Intellij æ’ä»¶å¼€å‘å…¥é—¨, å› ä¸ºç½‘ä¸Šå·²ç»æœ‰å¾ˆå¤šå…¥é—¨çš„æ•™ç¨‹äº†, éšä¾¿ä¸€æœ, å¤§éƒ¨åˆ†éƒ½æ˜¯ Hello World å…¥é—¨æ•™ç¨‹, è¿™é‡Œå†å†™å°±æ²¡æœ‰æ„ä¹‰äº†,
æ¥ä¸‹æ¥çš„å‡ ç¯‡éƒ½å°†å›´ç»•è‡ªå·±å¼€å‘çš„å‡ ä¸ªæ’ä»¶, å°†ç”¨åˆ°çš„æ²¡æœ‰ç”¨åˆ°çš„éƒ½å†™å‡ºæ¥, ä¸€æ˜¯åšä¸€ä¸ªè®°å½•, äºŒæ˜¯å¸Œæœ›èƒ½å¸®åŠ©é‚£äº›æƒ³å¼€å‘è‡ªå·±çš„æ’ä»¶çš„è€é“.

å‰æœŸä¸»è¦æ˜¯ä¸ºæ’ä»¶å¼€å‘åšå‡†å¤‡, æœç´¢äº†å¾ˆå¤š Intellij æ’ä»¶å¼€å‘çš„åšæ–‡, å¦‚æœæœåˆ°çš„ä¸æ»¡æ„, å¯ä»¥å°è¯•ä»¥ "Android Stutio æ’ä»¶å¼€å‘" å…³é”®å­—è¿›è¡Œæœç´¢, æ¯•ç«Ÿ
Android Stutio æ˜¯æ ¹æ® Intellij IDEA è¿›è¡ŒäºŒæ¬¡å¼€å‘çš„.

è¿™é‡Œç°å°†çœ‹åˆ°çš„æœ‰ä»·å€¼çš„åšæ–‡åœ°å€åˆ†äº«ä¸€äº›, è°¢è°¢ä»–ä»¬çš„åˆ†äº«.

[è¡—å¤´å®¢ - ç®€ä¹¦](http://www.jianshu.com/u/5239b57bf75e)
ä¸€å…± 9 ç¯‡æ’ä»¶å¼€å‘çš„åšæ–‡, éå¸¸å¥½.

## ä½¿ç”¨ Gradle å¼€å‘ Intellij æ’ä»¶

å®˜æ–¹ä½¿ç”¨ Intellij çš„ Intellij Platform Plugin æ¥åˆ›å»ºæ’ä»¶é¡¹ç›®, ç”¨æƒ¯äº† Maven, æ²¡ç”¨é¡¹ç›®ç®¡ç†å·¥å…·, æ„Ÿè§‰ä¸€ä¸‹å­å›åˆ°äº†è§£æ”¾å‰, è¿™é‡Œä¸ç”¨ Maven è€Œç”¨
Gradle, æ˜¯ä¸ºäº†å­¦ä¹ ä¸‹ Gradle.

### Gradle ç‰ˆçš„ Intellij IDEA Plugin Hello World

#### å®‰è£… Gradle

```shell
brew install gradle
```

æŸ¥çœ‹å®‰è£…åçš„ä¿¡æ¯

```shell
 ~ brew info gradle
gradle: stable 3.4.1
Build system based on the Groovy language
https://www.gradle.org/
/usr/local/Cellar/gradle/2.14.1 (171 files, 47.4MB) *
  Built from source on 2016-09-28 at 10:22:44
From: https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git/Formula/gradle.rb
==> Requirements
Required: java >= 1.7 âœ”
==> Options
--with-all
	Installs Javadoc, examples, and source in addition to the binaries
```

è®¾ç½®ç¯å¢ƒå˜é‡ (zsh)

```shell
GRADLE_HOME="/usr/local/Cellar/gradle/2.14.1"
export GRADLE_HOME
export PATH=$PATH:$GRADLE_HOME/bin
```

è®°å¾—

```shell
source ~/.zshrc
```

æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯

```shell
 âœ˜ î‚° ~ î‚° gradle -version

------------------------------------------------------------
Gradle 2.14.1
------------------------------------------------------------

Build time:   2016-07-18 06:38:37 UTC
Revision:     d9e2113d9fb05a5caabba61798bdb8dfdca83719

Groovy:       2.4.4
Ant:          Apache Ant(TM) version 1.9.6 compiled on June 29 2015
JVM:          1.8.0_72 (Oracle Corporation 25.72-b15)
OS:           Mac OS X 10.12.4 x86_64
```

#### åˆ›å»ºæ’ä»¶é¡¹ç›®

è¿™é‡Œç›´æ¥ä½¿ç”¨ Intellij åˆ›å»º Gradle é¡¹ç›®

![20241229154732_CgdCH5r9.webp](https://cdn.dong4j.site/source/image/20241229154732_CgdCH5r9.webp)

æ¥ä¸‹éœ€è¦è®¾ç½®ä¸‹ "ä¸‰è¦ç´ ", åŒ Maven ä¸€æ ·, ç„¶åä¸€è·¯ next

ç„¶åè®¾ç½® gradle

![20241229154732_JfSqPXtV.webp](https://cdn.dong4j.site/source/image/20241229154732_JfSqPXtV.webp)

æœ€ååˆ›å»ºå®Œæˆçš„æ ·å­

![20241229154732_wRkxsSlT.webp](https://cdn.dong4j.site/source/image/20241229154732_wRkxsSlT.webp)

src ç›®å½•ç»“æ„æ˜¯æˆ‘è‡ªå·±åŠ çš„, ç›´æ¥åˆ›å»ºç›®å½•å°±è¡Œäº†, gradle ä¼šè‡ªåŠ¨è¯†åˆ«æ–‡ä»¶ç»“æ„ (ç›®å½•ç»“æ„åŒ Maven)

#### è®¾ç½® build.gradle

```
buildscript {
    repositories {
        mavenCentral()
        maven { url 'http://dl.bintray.com/jetbrains/intellij-plugin-service'}
    }
}

// æ·»åŠ  intellij build plugins ä»“åº“åœ°å€
plugins {
    id "org.jetbrains.intellij" version "0.1.10"
}

repositories {
    mavenCentral()
}

tasks.withType(JavaCompile) {
    options.encoding = "UTF-8"
}

// ä½¿ç”¨ intellij idea çš„æ’ä»¶
apply plugin: 'java'
apply plugin: 'idea'
apply plugin: 'org.jetbrains.intellij'

sourceCompatibility = 1.8

// è®¾ç½®è¿è¡Œæ’ä»¶çš„ intellij ç‰ˆæœ¬ä»¥åŠæ²™ç®±åœ°å€
intellij {
    version 'IC-14.1.4'
    sandboxDirectory = project.rootDir.canonicalPath + "/.sandbox" // æ’ä»¶ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶çš„åœ°å€
}

dependencies {
    testCompile group: 'junit', name: 'junit', version: '4.11'
}
```

#### æ·»åŠ  plugin.xml

```xml
<idea-plugin version="2">
  <id>com.your.company.unique.plugin.id</id>
  <name>Plugin display name here</name>
  <version>1.0</version>
  <vendor email="support@yourcompany.com" url="http://www.yourcompany.com">YourCompany</vendor>

  <description><![CDATA[
      Enter short description for your plugin here.<br>
      <arraydsj@163.com>most HTML tags may be used</em>
    ]]></description>

  <change-notes><![CDATA[
      Add change notes here.<br>
      <arraydsj@163.com>most HTML tags may be used</em>
    ]]>
  </change-notes>

  <!-- please see http://www.jetbrains.org/intellij/sdk/docs/basics/getting_started/build_number_ranges.html for description -->
  <idea-version since-build="145.0"/>

  <!-- please see http://www.jetbrains.org/intellij/sdk/docs/basics/getting_started/plugin_compatibility.html
       on how to target different products -->
  <!-- uncomment to enable plugin in all products
  <depends>com.intellij.modules.lang</depends>
  -->

  <extensions defaultExtensionNs="com.intellij">
    <!-- Add your extensions here -->
  </extensions>

  <actions>
    <!-- Add your actions here -->
  </actions>

</idea-plugin>
```

æœ€åçš„ç›®å½•ç»“æ„

![20241229154732_xjjHuxuj.webp](https://cdn.dong4j.site/source/image/20241229154732_xjjHuxuj.webp)

#### è¿è¡Œ

è¿˜æ˜¯å†™ä¸ª Hello World å§, ä¸ç„¶æ€ä¹ˆçŸ¥é“è¿™ä¸ªæ˜¯å¦å¯è¡Œå‘¢?

å½“åˆæŒ‰ç…§å®˜æ–¹çš„æ•™ç¨‹, ç…§ç€å†™äº†ä¸€é Hello World, ç„¶åä½¿ç”¨ Gradle å†æ¥ä¸€é, å¯æ˜¯ "User classpath of module" ä¸€ç›´ä¸º [none]

![20241229154732_tFJzJDh8.webp](https://cdn.dong4j.site/source/image/20241229154732_tFJzJDh8.webp)

ææ¯›å•Š, æ²¡æœ‰è¿™ä¸ªå¯åŠ¨ä¸äº†æ’ä»¶, å°±è°ƒè¯•ä¸äº†å•Š, åæ¥æƒ³äº†æƒ³ Maven, Maven æœ‰å¾ˆå¤šæ’ä»¶,
ä»€ä¹ˆ `maven-source-plugin` , `maven-compiler-plugin` , `maven-deploy-plugin` ä»€ä¹ˆçš„

![20241229154732_7Aaxt2nN.webp](https://cdn.dong4j.site/source/image/20241229154732_7Aaxt2nN.webp)

å†çœ‹çœ‹ Gradle
![20241229154732_ka8UZZM4.webp](https://cdn.dong4j.site/source/image/20241229154732_ka8UZZM4.webp)

å³é”® è¿è¡Œ æˆ–è€… debug

æˆ–è€… ç›´æ¥

```
gradle runI
```

![20241229154732_hoY1G8Zs.webp](https://cdn.dong4j.site/source/image/20241229154732_hoY1G8Zs.webp)

![20241229154732_ZOp06YCn.webp](https://cdn.dong4j.site/source/image/20241229154732_ZOp06YCn.webp)

[gradle-demo æºç ](https://github.com/dong4j/gradle-demo)

#### é‡åˆ°çš„é—®é¢˜

###### Gradle è·¯å¾„è®¾ç½®

ç”±äºæˆ‘ä½¿ç”¨ brew å®‰è£… Gradle, ä½¿ç”¨ ç¯å¢ƒå˜é‡ä¸­çš„ `/usr/local/Cellar/gradle/2.14.1` è·¯å¾„ä¼šé€ æˆ

```
intellij gradle cannot save settings
```

é”™è¯¯.

è¿™é‡Œè´´å‡º è§£å†³æ–¹æ³•:

åœ¨ä»»æ„ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª build.gradle æ–‡ä»¶ , é‡Œé¢å†™å…¥

```shell
task getHomeDir << {
	println gradle.gradleHomeDir
}
```

åœ¨ build.gradle ç›®å½•ä¸‹æ‰§è¡Œ

```
gradle getHomeDir
```

è¾“å‡º:

```shell
:getHomeDir
/usr/local/Cellar/gradle/2.14.1/libexec
```

è¿™é‡Œçš„è¾“å‡ºæ‰æ˜¯çœŸæ­£çš„ gradle ç›®å½•

è¿™é‡Œè¯´ä¸€ä¸‹ é€šè¿‡ brew å®‰è£…çš„è½¯ä»¶çš„æƒ…å†µ.

é€šè¿‡ brew å®‰è£…çš„è½¯ä»¶ä¼šä¼šåœ¨ `/usr/local/Cellar` ç›®å½•ä¸‹

ä»¥ Tomcat ä¸ºä¾‹:

```
/usr/local/Cellar/tomcat
â””â”€â”€ 8.5.9
    â”œâ”€â”€ bin
    â”‚     â”œâ”€â”€ catalina -> ../libexec/bin/catalina.sh
    â””â”€â”€ libexec
        â”œâ”€â”€ bin
```

åœ¨ä¸åŒçš„ç‰ˆæœ¬ç›®å½•ä¸‹ä¼šæœ‰ **bin** å’Œ **libexec** è¿™ 2 ä¸ªé‡è¦çš„ç›®å½•

**bin** ç›®å½•ä¸‹å…¶å®æ˜¯ä¸€ä¸ªè½¯è¿æ¥, çœŸæ­£çš„æ‰§è¡Œæ–‡ä»¶æ˜¯ **../libexec/bin/catalina.sh**

è€Œ **libexec** æ‰æ˜¯è½¯ä»¶çœŸæ­£çš„å®‰è£…ç›®å½•.

å¤§å¤šæ•°ä½¿ç”¨ brew å®‰è£…çš„è½¯ä»¶éƒ½æ˜¯è¿™æ ·çš„.

###### Gradle Intellij ä¾èµ–

ç”±äºä¼—æ‰€å‘¨çŸ¥çš„åŸå› , Gradle ä¸‹è½½å¾ˆæ…¢, æ‰€ä»¥è¿™é‡Œä½¿ç”¨è¿…é›·å…ˆæŠŠ `ideaIC-14.1.4.zip` å’Œ `ideaIC-14.1.4-sources.jar` ä¸‹è½½ä¸‹æ¥, æ”¾åœ¨

```
/Users/xxxx/.gradle/caches/modules-2/files-2.1/com.jetbrains.intellij.idea/ideaIC/14.1.4/xxxxxxxxxxxx/
```

#### å‚è€ƒ

- [Gradle 10 åˆ†é’Ÿä¸Šæ‰‹æŒ‡å—](http://www.cnblogs.com/yjmyzz/p/gradle-getting-start.html)
- [ä½¿ç”¨ gradle æ¥æ„å»º intellij æ’ä»¶](http://blog.qianlicao.cn/technology/2016/11/03/build-plugins-with-gradle/)
- [Setting up Gradle Plugin For IntelliJ](http://www.rabblemedia.net/blog/setting-up-gradle-plugin-for-intellij/)

## [ZooKeeperé…ç½®ä¸­å¿ƒï¼šç®€åŒ–ä½ çš„å¼€å‘éƒ¨ç½²è¿‡ç¨‹](https://blog.dong4j.site/posts/ffa1ef45.md)

åŸºäº Zookeeper å®ç°çš„ä¸€ä¸ªé…ç½®ä¸­å¿ƒ


<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})


## ç°åœ¨æ¶æ„å­˜åœ¨çš„é—®é¢˜

1. é…ç½®åˆ†æ•£
   æ¯”å¦‚ä¿®æ”¹æ—¥å¿—é…ç½®éœ€è¦ä¿®æ”¹ xxx-api, xxx-webgis, ..., xxx-server.
2. åªæœ‰ dev, test, pro
   æœ¬åœ°å¼€å‘æ—¶éœ€è¦ä¿®æ”¹ dubbo.server.version, æäº¤æ—¶å¿˜è®°æ”¹å›æ¥é€ æˆæœåŠ¡è°ƒç”¨å‡ºé”™.
3. é…ç½®ç±»å¤ªå¤š, ä¸”æœ‰é‡å¤çš„é…ç½®ç±», ä¸å¥½ç®¡ç†
4. éå¼€å‘ç¯å¢ƒä¸‹åº”ç”¨é…ç½®åœ¨ war åŒ…ä¸­ï¼Œå…³é”®é…ç½®æ˜æ–‡æ˜¾ç¤º
5. ä¿®æ”¹é…ç½®å, éœ€è¦é‡æ–°æ‰“åŒ…éƒ¨ç½²
6. å…³é”®é…ç½®éšæ—¶å¯ä¿®æ”¹, ä¸€ä¸å°å¿ƒå°±ä¼šé€ æˆç”Ÿäº§äº‹æ•…

**ä¸ºäº†ç»Ÿä¸€ç®¡ç†é…ç½® **.
ç°å°†é…ç½®ä» pom ä¸­è¿å…¥åˆ° xxx-common-config, ä½¿ç”¨ maven filter å®ç°æ ¹æ®ä¸åŒç¯å¢ƒä» ${env}.yyyyy.properties è·å–é…ç½®æ›¿æ¢ application.properties
é…ç½® (@å ä½ç¬¦æ›¿æ¢)
ä½¿ç”¨ `<context:property-placeholder/>` é…åˆ `@Value("${}")` å®ç°è‡ªåŠ¨æ³¨å…¥é…ç½®åˆ°é…ç½®ç±».
æ–°å¢ local ç¯å¢ƒç”¨äºæœ¬åœ°å¼€å‘

ä½†æ˜¯ä»ç„¶è§£å†³ä¸äº†æ•æ„Ÿé…ç½®çš„å®‰å…¨, é…ç½®ä¸èƒ½ç»Ÿä¸€ç®¡ç†ç­‰é—®é¢˜.

## è§£å†³æ–¹æ¡ˆ

ä½¿ç”¨é…ç½®ä¸­å¿ƒ, ç»Ÿä¸€ç®¡ç†é…ç½®, å°†æ•æ„Ÿé…ç½®éš”ç¦»å‡ºæ¥.

å€ŸåŠ© ZooKeeper æˆ‘ä»¬å®ç°çš„é…ç½®ä¿¡æ¯å­˜å‚¨æ–¹æ¡ˆå…·æœ‰çš„ä¼˜ç‚¹å¦‚ä¸‹:

1. ç®€å•ã€‚å°½ç®¡å‰æœŸæ­å»º ZooKeeper æœåŠ¡å™¨é›†ç¾¤è¾ƒä¸ºéº»çƒ¦, ä½†æ˜¯å®ç°è¯¥æ–¹æ¡ˆå, ä¿®æ”¹é…ç½®æ•´ä¸ªè¿‡ç¨‹å˜å¾—ç®€å•å¾ˆå¤šã€‚ç”¨æˆ·åªè¦ä¿®æ”¹é…ç½®, æ— éœ€è¿›è¡Œå…¶ä»–ä»»ä½•æ“ä½œ,
   é…ç½®è‡ªåŠ¨ç”Ÿæ•ˆã€‚
2. å¯é ã€‚ZooKeeper æœåŠ¡é›†ç¾¤å…·æœ‰æ— å•ç‚¹å¤±æ•ˆçš„ç‰¹æ€§, ä½¿æ•´ä¸ªç³»ç»Ÿæ›´åŠ å¯é ã€‚å³ä½¿ ZooKeeper é›†ç¾¤ä¸­çš„ä¸€å°æœºå™¨å¤±æ•ˆ, ä¹Ÿä¸ä¼šå½±å“æ•´ä½“æœåŠ¡,
   æ›´ä¸ä¼šå½±å“åˆ†å¸ƒå¼åº”ç”¨é…ç½®ä¿¡æ¯çš„æ›´æ–°ã€‚
3. å®æ—¶ã€‚ZooKeeper çš„æ•°æ®æ›´æ–°é€šçŸ¥æœºåˆ¶, å¯ä»¥åœ¨æ•°æ®å‘ç”Ÿå˜åŒ–å, ç«‹å³é€šçŸ¥ç»™åˆ†å¸ƒå¼åº”ç”¨ç¨‹åº, å…·æœ‰å¾ˆå¼ºçš„å˜åŒ–å“åº”èƒ½åŠ›ã€‚

**èƒ½è§£å†³çš„é—®é¢˜ **

- ä¿è¯ä¸åŒéƒ¨ç½²ç¯å¢ƒä¸‹åº”ç”¨é…ç½®çš„ **éš”ç¦»æ€§ **
- ä¿è¯éå¼€å‘ç¯å¢ƒä¸‹åº”ç”¨é…ç½®çš„ **ä¿å¯†æ€§ **
- ä¿è¯ä¸åŒéƒ¨ç½²èŠ‚ç‚¹ä¸ŠåŒä¸€åº”ç”¨é…ç½®çš„ **ä¸€è‡´æ€§ **
- å®ç°åˆ†å¸ƒå¼ç¯å¢ƒä¸‹åº”ç”¨é…ç½®çš„ **å¯ç®¡ç†æ€§ **

## é…ç½®åˆ†ç±»

### ç°æœ‰é…ç½®

```
# ç¯å¢ƒå˜é‡
env
# api æµ‹è¯•ä½¿ç”¨
ignore.auth.flag
# æ—¥å¿—é…ç½®
#  JDBC
# å›¾ç‰‡ä¸Šä¼ é…ç½®
# SSDB
# kafka é…ç½®ä¿¡æ¯
# activemq é…ç½®ä¿¡æ¯
# dubbo é…ç½®
# å…‘å§
...
```

**æ¥æº **

1. æœ¬åœ°é…ç½®æ–‡ä»¶
2. æ•°æ®åº“
3. Redis
4. Zookeeper

**è¯»å†™é¢‘ç‡ **

1. å•æ¬¡è¯»å–å‹
   1. dubbo.service.version
   2. Logback
2. å¤šæ¬¡è¯»å–å‹ (æœ¬åœ°å¼€å‘æ—¶åŠ¨æ€åˆ‡æ¢ç¯å¢ƒ)
   1. MongoDB
   2. Kafka
   3. Zookeeper
   4. JDBC
   5. Redis
   6. SSDB
3. åŠ¨æ€è¯»å–å‹
   1. **å­—å…¸æ•°æ® **
   2. waybill.upload
   3. ä¿é™©
   4. æ”¯ä»˜
   5. ä¼æŸ¥æŸ¥
   6. å£°ç½‘
   7. ä¸Šä¼ åœ°å€
   8. å®šä½ã€è¯è´¹ã€ç¤¼å“å…‘æ¢å¼€å…³é…ç½®
   9. å•†åŠ¡ç«¯æ¨é€é…ç½®
   10. å…‘å§é…ç½®
   11. ä¸ªæ¨
   12. ä¸­äº¤é…ç½®
   13. å®¹è”äº‘é…ç½®

## æ€»ä½“è®¾è®¡

### ç³»ç»Ÿæ¶æ„

![20241229154732_SnRlXtfr.webp](https://cdn.dong4j.site/source/image/20241229154732_SnRlXtfr.webp)

### åŸºç¡€æ¨¡å‹

![20241229154732_dPGKve6u.webp](https://cdn.dong4j.site/source/image/20241229154732_dPGKve6u.webp)

- ç”¨æˆ·é€šè¿‡é…ç½®ä¸­å¿ƒä¿®æ”¹ zk èŠ‚ç‚¹é…ç½®
- client ç›‘å¬åˆ°èŠ‚ç‚¹æ•°æ®è¢«ä¿®æ”¹, è·å– spring å®¹å™¨é…ç½®ç±», åŠ¨æ€ä¿®æ”¹é…ç½®

### åºåˆ—å›¾

#### Config center

åŠŸèƒ½:

1. ç»Ÿä¸€ç®¡ç†é…ç½®
2. ä¿®æ”¹æ—¥å¿—çº§åˆ«
3. ä¿®æ”¹æ—¥å¿—é‡‡é›†ç‡
   4 æŸ¥çœ‹åº”ç”¨çŠ¶æ€ (æ˜¯å¦åœ¨çº¿, ä¸Šæ¬¡éƒ¨ç½²æ—¶é—´ç­‰)

åæœŸè€ƒè™‘å¢åŠ çš„åŠŸèƒ½

1. åº”ç”¨ä¸‹çº¿é‚®ä»¶ (çŸ­ä¿¡ / å¾®ä¿¡) æç¤º
2. kafka æ“ä½œ, æŸ¥çœ‹ä¿¡æ¯
3. dubbo æœåŠ¡æ³¨å†Œä¿¡æ¯

![20241229154732_AI9g85IB.webp](https://cdn.dong4j.site/source/image/20241229154732_AI9g85IB.webp)

#### Client

å¯åŠ¨æ—¶è¯»å–é…ç½®ï¼Œè¿è¡Œæ—¶æ ¹æ®é…ç½®è°ƒæ•´è¡Œä¸º

![20241229154732_pdeGNmRL.webp](https://cdn.dong4j.site/source/image/20241229154732_pdeGNmRL.webp)

### Zookeeper é…ç½®èŠ‚ç‚¹è®¾è®¡

![20241229154732_k6F5M08C.webp](https://cdn.dong4j.site/source/image/20241229154732_k6F5M08C.webp)

**åªæœ‰ local ç¯å¢ƒæ‰æœ‰äººå‘˜èŠ‚ç‚¹ **

åªæœ‰ local æ˜¯æœ¬åœ°å¼€å‘é…ç½®, å› ä¸ºå¼€å‘éœ€è¦, æœ‰æ—¶ä¼šåˆ‡æ¢ä¸åŒé…ç½®, å› æ­¤å°†é…ç½®åˆ†é…åˆ°å…·ä½“å¼€å‘è€…èº«ä¸Š, è¿™æ ·ä¿®æ”¹ä¸€ä¸ªé…ç½®æ—¶, åªä¼šå¯¹æŸä¸ªå¼€å‘è€…ç”Ÿæ•ˆ,
ä¸å½±å“å…¶ä»–äºº

**èŠ‚ç‚¹ä¸èƒ½å…±ç”¨ **

æ„æ€æ˜¯ä¸èƒ½æŠ½å–å‡ºå…¬å…±çš„é…ç½®, å› ä¸ºä¿®æ”¹äº†å…¬å…±é…ç½®, ç›‘å¬æ­¤èŠ‚ç‚¹çš„ client éƒ½ä¼šä¿®æ”¹é…ç½®.

## æ¨¡å—è¯´æ˜

### Client ç«¯

Client ç«¯æš‚æ—¶æ”¾åœ¨ trace æ¨¡å—ä¸­, æ–¹ä¾¿å¼€å‘æµ‹è¯•

### é…ç½®ä¸­å¿ƒ admin

```lua
.
â”œâ”€â”€ common-parent                       # æ‰€æœ‰æ¨¡å—çš„çˆ¶æ¨¡å—, è´Ÿè´£ç‰ˆæœ¬ä¸ä¾èµ–æ§åˆ¶
â”œâ”€â”€ common-utils                        # å…¬å…±å·¥å…·ç±»
â”œâ”€â”€ xxx-api-manager                     # æœªæ¥è¦åšçš„ api ç®¡ç†ç³»ç»Ÿ
â”‚     â””â”€â”€ api-manager-rest                # api ç®¡ç†ç³»ç»Ÿçš„ rest æ¥å£
â”œâ”€â”€ xxx-config-server                   # é…ç½®ä¸­å¿ƒçˆ¶æ¨¡å—
â”‚     â”œâ”€â”€ xxx-config-admin                # é…ç½®ä¸­å¿ƒå‰ç«¯
â”‚     â””â”€â”€ xxx-config-rest                 # é…ç½®ä¸­å¿ƒ rest æ¥å£
â””â”€â”€ spring-boot-starter-curator         # å°è£…çš„ curator spring boot start
```

## æŠ€æœ¯é€‰å‹

**Curator(é¦†é•¿, ç®¡ç†å‘˜)**

æ›¿ä»£ Zkclient çš„å¦ä¸€ä¸ªç®€å•å¼ºå¤§çš„ Zookeeper å®¢æˆ·ç«¯, (Curator)é¦†é•¿ä¸ (Zookeeper) åŠ¨ç‰©å›­, å¤©ç”Ÿä¸€å¯¹ ğŸ¤£ğŸ¤£

Curator åŒ…å«äº†å‡ ä¸ªåŒ…ï¼š

- curator-frameworkï¼šå¯¹ zookeeper çš„åº•å±‚ api çš„ä¸€äº›å°è£…
- curator-clientï¼šæä¾›ä¸€äº›å®¢æˆ·ç«¯çš„æ“ä½œï¼Œä¾‹å¦‚é‡è¯•ç­–ç•¥ç­‰
- curator-recipesï¼šå°è£…äº†ä¸€äº›é«˜çº§ç‰¹æ€§ï¼Œå¦‚ï¼šCache äº‹ä»¶ç›‘å¬ã€é€‰ä¸¾ã€åˆ†å¸ƒå¼é”ã€åˆ†å¸ƒå¼è®¡æ•°å™¨ã€åˆ†å¸ƒå¼ Barrier ç­‰

**Spring Boot**

ç”¨äºå¼€å‘é…ç½®ä¸­å¿ƒçš„ Web ç«¯æ¡†æ¶, å®ç°å¿«é€Ÿå¼€å‘, ç®€å•éƒ¨ç½².

### å¼€å‘é…ç½®ç®¡ç†è§£å†³æ–¹æ¡ˆ

1. clone ä»£ç åˆ°æœ¬åœ° (git å¹¶æ²¡æœ‰ç®¡ç† xxx-common-config ä¸­çš„ application.yml)
2. maven profile é€‰æ‹© **local(é»˜è®¤)**
3. æ‰§è¡Œ xxx-common-config çš„ **pullConfig()** æ–¹æ³•, ç”¨äºæ‹‰å–é…ç½®
4. å®Œæˆåä¼šåœ¨ resource ç›®å½•ä¸‹ç”Ÿæˆ application.yml æ–‡ä»¶, ç”¨äºç¼–è¯‘æ—¶æ›¿æ¢å ä½ç¬¦ (**è¿™é‡Œæ˜¯è€ƒè™‘ä½¿ç”¨ @Bean æ³¨å…¥ jdbc, redis, kafka, mongodb ç­‰å¯¹è±¡,
   ä½†æ˜¯ dubbo å’Œ logback æ³¨å…¥æœ‰é—®é¢˜, ä»¥åä¼šä¼˜åŒ–è¿™é‡Œ**)

   ```lua
   env: local
   ```

# zookeeper é…ç½®

zookeeper:
connect:
list: 192.168.2.8:2181

# dubbo é…ç½®

dubbo:
service:
version: 5.2.8
...

````
å…¶ä»–é…ç½®è¿™ä¼šæ ¹æ® maven profile , å¯åŠ¨ app æ—¶åŠ¨æ€æ³¨å…¥.
æœ¬åœ°å¼€å‘æ—¶, ä»¥æœ¬åœ°é…ç½®ä¼˜å…ˆ, æ²¡æœ‰é…ç½®çš„åˆ™è¯»å– zk é…ç½®.

å¦‚æœä» local åˆ‡æ¢åˆ° test ç¯å¢ƒ, éœ€è¦å†æ¬¡è¿è¡Œ **pullConfig() **, åªæœ‰ä»¥ä¸‹é…ç½® **ä¸ä¼š** è¢«æ›¿æ¢

```lua
# zookeeper é…ç½®
zookeeper:
  connect:
    list: 192.168.2.8:2181
# dubbo é…ç½®
dubbo:
  service:
    version: 5.2.8
# æ—¥å¿—é…ç½®
logback:
  log:
    level: DEBUG
    root:
      level: ERROR
  appender:
    one: STDOUT
    two:
  logstash:
    ip: 192.168.2.121:8801
  path: /Users/codeai/Develop/logs/xxx/mnt/syslogs/tomcat
# ä¸Šä¼ é…ç½®
uploadPath: /data/devuploads/
````

è¿™æ ·å¯ä»¥é¿å…åˆ‡æ¢ç¯å¢ƒåè¿˜è¦æ‰‹åŠ¨ä¿®æ”¹é…ç½®

### å¼€å‘æ—¶åˆ‡æ¢é…ç½®

å¯èƒ½æœ‰è¿™æ ·çš„éœ€æ±‚, æˆ‘ä»¬å¼€å§‹åœ¨ local ç¯å¢ƒå¼€å‘, test ç¯å¢ƒæœ‰å‡ºç° bug, ä¸ºäº†å¤ç° bug, æˆ‘ä»¬å¯èƒ½ä¼šåˆ‡æ¢åˆ° test ç¯å¢ƒ.

è¿™ä¸ªçš„è§£å†³æ–¹æ¡ˆ:

æˆ‘ä»¬ä¸éœ€è¦é‡å¯åº”ç”¨, ç›´æ¥åœ¨ Web ç«¯åˆ‡æ¢è¿™ä¸ªå¼€å‘è€…çš„é…ç½®å³å¯.

åŸç†:

åˆ‡æ¢åŠŸèƒ½åªä¼šå°† test çš„é…ç½®æ›¿æ¢åˆ°å½“å‰å¼€å‘è€…èŠ‚ç‚¹ä¸‹çš„ local é…ç½®, ç„¶åè‡ªåŠ¨è°ƒç”¨ zk ç›‘å¬æœºåˆ¶, åŠ¨æ€ä¿®æ”¹é…ç½®å³å¯.

### Dev Test Prod ç¯å¢ƒéƒ¨ç½²è§£å†³æ–¹æ¡ˆ

å½“éœ€è¦éƒ¨ç½²åˆ°é local ç¯å¢ƒçš„æœåŠ¡å™¨æ—¶, éœ€è¦æ‰§è¡Œ xxx-common-config ä¸­çš„ **pullDeployConfig()** æ–¹æ³•

**pullConfig()** ä¸ **pullDeployConfig()** çš„åŒºåˆ«:

å› å¼€å‘éœ€è¦åˆ‡æ¢ç¯å¢ƒæ—¶, è°ƒç”¨ **pullConfig()** åä¸ä¼šè¦†ç›– application.yml ä¸­è‡ªå®šä¹‰é…ç½®.

å› ä¸ºéƒ¨ç½²æ—¶, å¹¶ä¸éœ€è¦æœ¬åœ°è‡ªå®šä¹‰é…ç½®, å› æ­¤ **pullDeployConfig()** ä¼šå°†åŸæ¥çš„ application.yml é‡å‘½åä¸º application.yml.local( ä¸ä¼šè¢«æ‰“åŒ…åˆ° war
ä¸­), ç„¶åæ‹‰å–é…ç½®ç”Ÿæˆ application.yml

### ç¬¬ä¸‰æ–¹å…¬å¸é…ç½®è§£å†³æ–¹æ¡ˆ

ç¬¬ä¸‰æ–¹å…¬å¸é…ç½®ç”±æœ¬å…¬å¸ç»Ÿä¸€ç®¡ç†, åªéœ€è¦åœ¨ configs èŠ‚ç‚¹ä¸‹å¢åŠ ä¸€ä¸ªå­èŠ‚ç‚¹, æ¯”å¦‚ chengtong, ç„¶åå†æ·»åŠ é…ç½®èŠ‚ç‚¹

æ‰“åŒ…æ—¶, åˆ‡æ¢åˆ° chengtong åˆ†æ”¯, maven é€‰æ‹© chengtong profile, å¦‚æœéœ€è¦ä¸ªæ€§åŒ–é…ç½®, åœ¨æœ¬åœ°æ–°å»º application.yml é…ç½®å³å¯, é»˜è®¤ä¼šä»¥æœ¬åœ°ä¼˜å…ˆ (
åªé’ˆå¯¹ç¬¬ä¸‰æ–¹å…¬å¸)

å¦‚æœæ˜¯ xxx å…¬å¸, ä»¥ dev,test,prod ç¯å¢ƒæ‰“åŒ…æ—¶, åˆ™ä¼šå¿½ç•¥æœ¬åœ°é…ç½®æ–‡ä»¶.

åŸå› æ˜¯å¼€å‘æ—¶æ‹‰å–é…ç½®, ä¸ªæ€§åŒ–é…ç½®å (ä¿®æ”¹ dubbo service version, ä¿®æ”¹æ—¥å¿—è¾“å‡ºç­‰), ä¸å°å¿ƒæäº¤äº†æœ¬åœ°é…ç½®, æ‰“åŒ…æ—¶ä¸å½±å“, ä¾ç„¶æ˜¯ä»¥ zk é…ç½®ä¸ºä¸».

## Todo list

1. è¿ç§»é¡¹ç›®ä¸­çš„é…ç½®æ–‡ä»¶åŠç±»åˆ° `xxx-common-config` ä¸­
   1. ä½¿ç”¨ @Value("${...}") æ›¿æ¢ xml çš„ bean é…ç½®
2. æ•´ç† xxx-common-config ä¸­çš„é…ç½®æ˜ å°„åˆ° zk çš„èŠ‚ç‚¹
3. å®ç°ä¸€é”®åˆ›å»º zk èŠ‚ç‚¹
   1. shell å‘½ä»¤æˆ–è€… Go å®ç°
4. ä»æ•°æ®æºï¼ˆzkã€mysqlã€redisï¼‰è¯»å–é…ç½®ä¿¡æ¯å†™å…¥ properties
   1. å®ç° pullConfig() æ–¹æ³•
      1. åˆå¹¶æœ¬åœ°é…ç½®, åˆ‡æ¢ç¯å¢ƒæ—¶, å“ªäº›é…ç½®ä¸éœ€è¦è¦†ç›–
   2. å®ç° pullDeployConfig() æ–¹æ³•
      1. æ–‡ä»¶é‡å‘½å
      2. é‡æ–°ç”Ÿæˆ properties .yml
5. mvn æ‰“åŒ…å‰ï¼Œè¯»å–é…ç½®æ›¿æ¢ xml ä¸­çš„å ä½ç¬¦ï¼ˆdubboã€logstashï¼‰
   1. åˆ é™¤å¤šä½™ç¯å¢ƒé…ç½®, åªä¿ç•™ application.yml
   2. ä¿®æ”¹ maven çš„ profiles
   3. ä¿®æ”¹ maven çš„ build filter
6. ä» Java å¯¹è±¡ä¸­æ˜ å°„åˆ° Env ç¯å¢ƒé…ç½®ç±»ä¸­
   1. å¯åŠ¨æ—¶è¯»å– zk(mysql, redis) é…ç½® (ä¸åŒ…æ‹¬ jdbc, redis, logback..)
   2. åœ¨å®ä¾‹åŒ– bean ä¹‹å‰, å°†é…ç½®åŠ¨æ€æ³¨å…¥åˆ° Spring Environment å¯¹è±¡ä¸­
   3. å¯åŠ¨å®Œæˆåæ·»åŠ  listener, ç›‘å¬é…ç½®å˜åŒ–
   4. å®ç° callback, åŠ¨æ€ä¿®æ”¹é…ç½®

## [Redisé›†æˆæ”»ç•¥ï¼šä»Jedisåˆ°ShardedJedisPool](https://blog.dong4j.site/posts/4fa65dbc.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

Redis çš„å‡ ç§é›†æˆæ–¹å¼

ç¼“å­˜æœåŠ¡ç»„ä»¶

ä¾èµ–äº:

1. jedis
2. spring-data-redis
3. spring-session-data-redis

redis é›†ç¾¤ä½¿ç”¨çš„æ˜¯ ShardedJedisPool, redis 3.x åè‡ªå¸¦é›†ç¾¤è´Ÿè½½

## jar ä¸­é‡è¦çš„ç±»

1. JedisConnectionFactory
   ç”¨äºè·å– jedis å®ä¾‹, ä»è€Œæ“ä½œ redis

2. ShardedJedisPool
   ç”¨äºè¿æ¥ redis é›†ç¾¤

## cache é‡è¦çš„ç±»

1. RedisDataSource
   ä½¿ç”¨ JedisConnectionFactory ä» ShardedJedisPool è¿æ¥æ± ä¸­è·å– jedis

2. RedisClientTemplate
   ä¾èµ– RedisDataSource æ“ä½œ redis çš„å…·ä½“æ¨¡æ¿æ–¹æ³•

3. RedisCacheServiceImpl
   å¯¹ RedisClientTemplate å†æ¬¡å°è£…

## JedisPool(éåˆ‡ç‰‡é“¾æ¥æ± ) å’Œ ShardedJedisPool(åˆ‡ç‰‡é“¾æ¥æ± ) æœ‰ä»€ä¹ˆåŒºåˆ«

JedisPool è¿ä¸€å° Redis, ShardedJedisPool è¿ Redis é›†ç¾¤,
é€šè¿‡ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å†³å®šæŠŠæ•°æ®å­˜åˆ°å“ªå°ä¸Š, ç®—æ˜¯ä¸€ç§å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡,
æ‰€ä»¥æ·»åŠ æ˜¯ç”¨è¿™ä¸ªï¼ˆRedis 3.0 ä¹‹åæ”¯æŒæœåŠ¡ç«¯è´Ÿè½½å‡è¡¡ï¼‰
åˆ é™¤é‚£ä¸ªé—®é¢˜çš„ç­”æ¡ˆå°±æ˜¾è€Œæ˜“è§äº†, æ€»ä¸å¯èƒ½éšæœºæ‰¾ä¸€ä¸ª Redis æœåŠ¡ç«¯å»åˆ å§

## é›†ç¾¤ session å…±äº«æœºåˆ¶

ç°åœ¨é›†ç¾¤ä¸­ä½¿ç”¨çš„ Session å…±äº«æœºåˆ¶æœ‰ä¸¤ç§, åˆ†åˆ«æ˜¯ session å¤åˆ¶å’Œ session ç²˜æ€§.

**Session å¤åˆ¶**

è¯¥ç§æ–¹å¼ä¸‹, è´Ÿè½½å‡è¡¡å™¨ä¼šæ ¹æ®å„ä¸ª node çš„çŠ¶æ€, æŠŠæ¯ä¸ª request è¿›è¡Œåˆ†å‘, ä½¿ç”¨è¿™æ ·çš„æµ‹è¯•, å¿…é¡»åœ¨å¤šä¸ª node ä¹‹é—´å¤åˆ¶ç”¨æˆ·çš„ session,
å®æ—¶ä¿æŒæ•´ä¸ªé›†ç¾¤ä¸­ç”¨æˆ·çš„çŠ¶æ€åŒæ­¥.
å…¶ä¸­ jboss çš„å®ç°åŸç†æ˜¯ä½¿ç”¨æ‹¦æˆªå™¨, æ ¹æ®ç”¨æˆ·çš„åŒæ­¥ç­–ç•¥æ‹¦æˆª request, åšå®ŒåŒæ­¥å¤„ç†åå†äº¤ç»™ server äº§ç”Ÿå“åº”.

ä¼˜ç‚¹: session ä¸ä¼šè¢«ç»‘å®šåˆ°å…·ä½“çš„ node, åªè¦æœ‰ä¸€ä¸ª node å­˜æ´», ç”¨æˆ·çŠ¶æ€å°±ä¸ä¼šä¸¢å¤±, é›†ç¾¤èƒ½å¤Ÿæ­£å¸¸å·¥ä½œ.

ç¼ºç‚¹: node ä¹‹é—´é€šä¿¡é¢‘ç¹, å“åº”é€Ÿåº¦æœ‰å½±å“, é«˜å¹¶å‘æƒ…å†µä¸‹æ€§èƒ½ä¸‹é™æ¯”è¾ƒå‰å®³.

**Session ç²˜æ€§**

è¯¥ç§æ–¹å¼ä¸‹, å½“ç”¨æˆ·å‘å‡ºç¬¬ä¸€ä¸ª request å, è´Ÿè½½å‡è¡¡å™¨åŠ¨æ€çš„æŠŠè¯¥ç”¨æˆ·åˆ†é…è‡³åˆ°æŸä¸ªèŠ‚ç‚¹, å¹¶è®°å½•è¯¥èŠ‚ç‚¹çš„ jvm è·¯ç”±, ä»¥åè¯¥ç”¨æˆ·çš„æ‰€æœ‰çš„ request
éƒ½ä¼šç»‘å®šåˆ°è¿™ä¸ª jvm è·¯ç”±, ç”¨æˆ·åªä¼šå’Œè¯¥ server äº¤äº’.

ä¼˜ç‚¹: å“åº”é€Ÿåº¦å¿«, å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´æ— éœ€é€šä¿¡

ç¼ºç‚¹: æŸä¸ª node æ­»æ‰ä¹‹å, å®ƒè´Ÿè´£çš„æ‰€æœ‰ç”¨æˆ·éƒ½ä¼šä¸¢å¤± session.

æ”¹è¿›: servlet å®¹å™¨åœ¨æ–°å»ºã€æ›´æ–°æˆ–ç»´æŠ¤ session æ—¶, å‘å…¶å®ƒ no de æ¨é€ä¿®æ”¹ä¿¡æ¯. è¿™ç§æ–¹å¼åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹åŒæ ·ä¼šå½±å“æ•ˆç‡.

ä»¥ä¸Šè¿™ä¸¤ç§æ–¹å¼éƒ½éœ€è¦è´Ÿè½½å‡è¡¡å™¨å’Œ Servlet å®¹å™¨çš„æ”¯æŒ, åœ¨éƒ¨ç½²æ—¶éœ€è¦å•ç‹¬é…ç½®è´Ÿè½½å‡è¡¡å™¨å’Œ Servelt å®¹å™¨.

**åŸºäºåˆ†å¸ƒå¼ç¼“å­˜çš„ session å…±äº«æœºåˆ¶**

å°†ä¼šè¯ Session ç»Ÿä¸€å­˜å‚¨åœ¨åˆ†å¸ƒå¼ç¼“å­˜ä¸­, å¹¶ä½¿ç”¨ Cookie ä¿æŒå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„è”ç³»,
æ¯ä¸€æ¬¡ä¼šè¯å¼€å§‹å°±ç”Ÿæˆä¸€ä¸ª GUID ä½œä¸º SessionID, ä¿å­˜åœ¨å®¢æˆ·ç«¯çš„ Cookie ä¸­, åœ¨æœåŠ¡ç«¯é€šè¿‡ SessionID å‘åˆ†å¸ƒå¼ç¼“å­˜ä¸­è·å– session.

å®ç°æ€è·¯: é€šè¿‡ä¸€ä¸ª Filter è¿‡æ»¤æ‰€æœ‰çš„ request è¯·æ±‚, åœ¨ Filter åˆ›å»º request å’Œ session çš„ä»£ç†, é€šè¿‡ä»£ç†ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜å¯¹ session è¿›è¡Œæ“ä½œ.
è¿™æ ·å®ç°å¯¹ç°æœ‰åº”ç”¨ä¸­å¯¹ request å¯¹è±¡çš„æ“ä½œé€æ˜
æ‰©å±•æŒ‡å®š server åˆ©ç”¨ Servlet å®¹å™¨æä¾›çš„æ’ä»¶åŠŸèƒ½, è‡ªå®šä¹‰ HttpSession çš„åˆ›å»ºå’Œç®¡ç†ç­–ç•¥, å¹¶é€šè¿‡é…ç½®çš„æ–¹å¼æ›¿æ¢æ‰é»˜è®¤çš„ç­–ç•¥.

ä¸è¿‡è¿™ç§æ–¹å¼æœ‰ä¸ªç¼ºç‚¹, å°±æ˜¯éœ€è¦è€¦åˆ Tomcat/Jetty ç­‰ Servlet å®¹å™¨çš„ä»£ç .
è¿™æ–¹é¢å…¶å®æ—©å°±æœ‰å¼€æºé¡¹ç›®äº†, ä¾‹å¦‚ memcached-session-manager , ä»¥åŠ tomcat-redis-session-manager . æš‚æ—¶éƒ½åªæ”¯æŒ Tomcat6/Tomcat7.

è®¾è®¡ä¸€ä¸ª Filter åˆ©ç”¨ HttpServletRequestWrapper, å®ç°è‡ªå·±çš„ getSession() æ–¹æ³•, æ¥ç®¡åˆ›å»ºå’Œç®¡ç† Session æ•°æ®çš„å·¥ä½œ. spring-session
å°±æ˜¯é€šè¿‡è¿™æ ·çš„æ€è·¯å®ç°çš„.

**spring-session**
SpringSession çš„å‡ ä¸ªå…³é”®ç±»

1. SessionRepositoryFilter(order æ˜¯ Integer.MIN_VALUE + 50)
2. SessionRepositoryRequestWrapper ä¸ SessionRepositoryResponseWrapper, é€šè¿‡ SessionRepository å»æ“çºµ session
3. SessionRepository
4. CookieHttpSessionStrategy

## redis è¿‡æœŸæ•°æ®çš„åˆ é™¤æ–¹å¼

1. å®šæ—¶åˆ é™¤: åœ¨è®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´çš„åŒæ—¶, åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ (timer), è®©å®šæ—¶å™¨åœ¨é”®çš„è¿‡æœŸæ—¶é—´æ¥ä¸´æ—¶, ç«‹å³æ‰§è¡Œå¯¹é”®çš„åˆ é™¤æ“ä½œ.
2. æƒ°æ€§åˆ é™¤: æ”¾ä»»é”®è¿‡æœŸä¸ç®¡, ä½†æ˜¯æ¯æ¬¡ä»é”®ç©ºé—´ä¸­è·å–é”®æ—¶, éƒ½æ£€æŸ¥å–å¾—çš„é”®æ˜¯å¦è¿‡æœŸ, å¦‚æœè¿‡æœŸçš„è¯, å°±åˆ é™¤è¯¥é”®ï¼›å¦‚æœæ²¡æœ‰è¿‡æœŸ, å°±è¿”å›è¯¥é”®.
3. å®šæœŸåˆ é™¤: æ¯éš”ä¸€æ®µæ—¶é—´, ç¨‹åºå°±å¯¹æ•°æ®åº“è¿›è¡Œä¸€æ¬¡æ£€æŸ¥, åˆ é™¤é‡Œé¢çš„è¿‡æœŸé”®. è‡³äºè¦åˆ é™¤å¤šå°‘è¿‡æœŸé”®, ä»¥åŠè¦æ£€æŸ¥å¤šå°‘ä¸ªæ•°æ®åº“, åˆ™ç”±ç®—æ³•å†³å®š.

redis å®é™…æ˜¯ä»¥æ‡’æ€§åˆ é™¤ + å®šæœŸåˆ é™¤è¿™ç§ç­–ç•¥ç»„åˆæ¥å®ç°è¿‡æœŸé”®åˆ é™¤çš„,
å¯¼è‡´ Spring éœ€è¦é‡‡ç”¨åŠæ—¶åˆ é™¤çš„ç­–ç•¥ï¼ˆå®šæ—¶è½®è¯¢ï¼‰, åœ¨è¿‡æœŸçš„æ—¶å€™, è®¿é—®ä¸€ä¸‹è¯¥ key, ç„¶ååŠæ—¶è§¦å‘æƒ°æ€§åˆ é™¤
Spring çš„è½®è¯¢å¦‚ä½•ä¿è¯æ—¶æ•ˆæ€§

```java
@Scheduled(cron = "0 * * * * *")
// æ¯åˆ†é’Ÿè·‘ä¸€æ¬¡, æ¯æ¬¡æ¸…é™¤å‰ä¸€åˆ†é’Ÿçš„è¿‡æœŸé”®
public void cleanExpiredSessions() {
    long now = system.currentTimeMillis();
    long prevMin = roundDownMinute(now);

    if (logger.isDebugEnabled()) {
        logger.debug("Cleaning up sessions expiring at " + new Date(prevMin));
    }

    String expirationKey = getExpirationKey(prevMin);
    Set < String > sessionsToExpire = expirationRedisOperations.boundSetOps(expirationKey).members();
    expirationRedisOperations.delete(expirationKey);
    for (String session: sessionsToExpire) {
        String sessionKey = getSessionKey(session);
        touch(sessionKey);
    }
}
```

è¿™é‡Œçš„ touch æ“ä½œå°±æ˜¯è®¿é—®è¯¥ key, ç„¶åè§¦å‘ redis åˆ é™¤.

```java
/**
     * By trying to access the session we only trigger a deletion if it the TTL is expired. This is done to handle
     * https://github.com/spring-projects/spring-session/issues/93
     *
     * @param key
     */
    private void touch(String key) {
        sessionRedisOperations.hasKey(key);
    }
```

ä¸»åŠ¨åˆ é™¤ session

```java
public void onDelete(ExpiringSession session) {
    long toExpire = roundUpToNextMinute(expiresInMillis(session));
    String expireKey = getExpirationKey(toExpire);
    expirationRedisOperations.boundSetOps(expireKey).remove(session.getId());
}
```

å»¶é•¿ session è¿‡æœŸæ—¶é—´

```java
public void onExpirationupdated(Long originalExpirationTimeInMilli, ExpiringSession session) {
    if (originalExpirationTimeInMilli != null) {
        long originalRoundedUp = roundUpToNextMinute(originalExpirationTimeInMilli);
        String expireKey = getExpirationKey(originalRoundedUp);
        expirationRedisOperations.boundSetOps(expireKey).remove(session.getId());
    }

    long toExpire = roundUpToNextMinute(expiresInMillis(session));

    String expireKey = getExpirationKey(toExpire);
    BoundSetOperations < String,
    String > expireOperations = expirationRedisOperations.boundSetOps(expireKey);
    expireOperations.add(session.getId());

    long sessionExpireInSeconds = session.getMaxInactiveIntervalInSeconds();
    String sessionKey = getSessionKey(session.getId());

    expireOperations.expire(sessionExpireInSeconds + 60, TimeUnit.SECONDS);
    sessionRedisOperations.boundHashOps(sessionKey).expire(sessionExpireInSeconds, TimeUnit.SECONDS);
}
```

## æ›¿æ¢åºåˆ—åŒ–æ–¹å¼

ä½¿ç”¨ GenericJackson2JsonRedisSerializer æ›¿æ¢ JdkSerializationRedisSerializer
ä½¿å¾—å­˜å…¥ redis çš„æ•°æ®æ˜¾ç¤ºæ›´å‹å¥½

å­˜åœ¨çš„é—®é¢˜

æ•°æ®è¿ç§»
åŸæ¥å­˜åœ¨äº redis ä¸­çš„æ•°æ® ä¸èƒ½ä½¿ç”¨ GenericJackson2JsonRedisSerializer ååºåˆ—åŒ–

## jedisPool ä¸ RedisTemplate çš„åŒºåˆ«

jedisPool æ˜¯ç›´æ¥é€šè¿‡è·å– jedis æ¥æ“ä½œ redis
è€Œ RedisTemplate æ˜¯é€šè¿‡ spring ç”± IOC æ¥é…ç½®ä¾èµ–å…³ç³»

## Spring æä¾›çš„ redis åºåˆ—åŒ–æ–¹å¼çš„åŒºåˆ«

1. JdkSerializationRedisSerializer
2. GenericJackson2JsonRedisSerializer

## [RESTEasyå…¥é—¨ï¼šJAX-RSå®è·µæŒ‡å—](https://blog.dong4j.site/posts/9659e30c.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

**RESTEasy**

RESTEasy æ˜¯ JBoss çš„ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œæä¾›å„ç§æ¡†æ¶å¸®åŠ©ä½ æ„å»º RESTful Web Services å’Œ RESTful Java åº”ç”¨ç¨‹åºã€‚å®ƒæ˜¯ JAX-RS è§„èŒƒçš„ä¸€ä¸ªå®Œæ•´å®ç°å¹¶é€šè¿‡ JCP è®¤è¯ã€‚ä½œä¸ºä¸€ä¸ª JBOSS çš„é¡¹ç›®ï¼Œå®ƒå½“ç„¶èƒ½å’Œ JBOSS åº”ç”¨æœåŠ¡å™¨å¾ˆå¥½åœ°é›†æˆåœ¨ä¸€èµ·ã€‚ä½†æ˜¯ï¼Œå®ƒä¹Ÿèƒ½åœ¨ä»»ä½•è¿è¡Œ JDK5 æˆ–ä»¥ä¸Šç‰ˆæœ¬çš„ Servlet å®¹å™¨ä¸­è¿è¡Œã€‚RESTEasy è¿˜æä¾›ä¸€ä¸ª RESTEasy JAX-RS å®¢æˆ·ç«¯è°ƒç”¨æ¡†æ¶ã€‚èƒ½å¤Ÿå¾ˆæ–¹ä¾¿ä¸ EJBã€Seamã€Guiceã€Spring å’Œ Spring MVC é›†æˆä½¿ç”¨ã€‚æ”¯æŒåœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯è‡ªåŠ¨å®ç° GZIP è§£å‹ç¼©ã€‚

RESTEasyÂ  é¡¹ç›®æ˜¯ Â JAX-RSÂ  çš„ä¸€ä¸ªå®ç°ï¼Œé›†æˆçš„ä¸€äº›äº®ç‚¹ï¼š

- ä¸éœ€è¦é…ç½®æ–‡ä»¶ï¼Œåªè¦æŠŠ JARs æ–‡ä»¶æ”¾åˆ°ç±»è·¯å¾„é‡Œé¢ï¼Œæ·»åŠ  Â @PathÂ  æ ‡æ³¨å°±å¯ä»¥äº†ã€‚
- å®Œå…¨çš„æŠŠ RESTEeasy é…ç½®ä½œä¸º Seam ç»„ä»¶æ¥çœ‹å¾…ã€‚
- HTTP è¯·æ±‚ç”± Seam æ¥æä¾›ï¼Œä¸éœ€è¦ä¸€ä¸ªé¢å¤–çš„ Servletã€‚
- Resources å’Œ providers å¯ä»¥ä½œä¸º Seam components (JavaBean or EJB)ï¼Œå…·æœ‰å…¨é¢çš„ Seam injection,lifecycle, interception, ç­‰åŠŸèƒ½æ”¯æŒã€‚
- æ”¯æŒåœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯è‡ªåŠ¨å®ç° GZIP è§£å‹ç¼©ã€‚

**JAX-RS:**
Java API for RESTful Web Services æ˜¯ä¸€ä¸ª Java ç¼–ç¨‹è¯­è¨€çš„åº”ç”¨ç¨‹åºæ¥å£, æ”¯æŒæŒ‰ç…§ è¡¨è±¡åŒ–çŠ¶æ€è½¬å˜ (REST) æ¶æ„é£æ ¼åˆ›å»º Web æœåŠ¡ Web æœåŠ¡ [1]. JAX-RS ä½¿ç”¨äº† Java SE 5 å¼•å…¥çš„ Java æ ‡æ³¨æ¥ç®€åŒ– Web æœåŠ¡å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„å¼€å‘å’Œéƒ¨ç½²ã€‚

JAX-RS æä¾›äº†ä¸€äº›æ ‡æ³¨å°†ä¸€ä¸ªèµ„æºç±»ï¼Œä¸€ä¸ª POJOJava ç±»ï¼Œå°è£…ä¸º Web èµ„æºã€‚æ ‡æ³¨åŒ…æ‹¬ï¼š

1. @Pathï¼Œæ ‡æ³¨èµ„æºç±»æˆ–æ–¹æ³•çš„ç›¸å¯¹è·¯å¾„
2. @GETï¼Œ@PUTï¼Œ@POSTï¼Œ@DELETEï¼Œæ ‡æ³¨æ–¹æ³•æ˜¯ç”¨çš„ HTTP è¯·æ±‚çš„ç±»å‹
3. @Producesï¼Œæ ‡æ³¨è¿”å›çš„ MIME åª’ä½“ç±»å‹
4. @Consumesï¼Œæ ‡æ³¨å¯æ¥å—è¯·æ±‚çš„ MIME åª’ä½“ç±»å‹
5. @PathParamï¼Œ@QueryParamï¼Œ@HeaderParamï¼Œ@CookieParamï¼Œ@MatrixParamï¼Œ@FormParam, åˆ†åˆ«æ ‡æ³¨æ–¹æ³•çš„å‚æ•°æ¥è‡ªäº HTTP è¯·æ±‚çš„ä¸åŒä½ç½®ï¼Œä¾‹å¦‚ @PathParam æ¥è‡ªäº URL çš„è·¯å¾„ï¼Œ@QueryParam æ¥è‡ªäº URL çš„æŸ¥è¯¢å‚æ•°ï¼Œ@HeaderParam æ¥è‡ªäº HTTP è¯·æ±‚çš„å¤´ä¿¡æ¯ï¼Œ@CookieParam æ¥è‡ªäº HTTP è¯·æ±‚çš„ Cookieã€‚

## é…ç½®

web.xml é…ç½®

```xml
<web-app>
    <display-name>Archetype Created Web Application</display-name>
    <servlet>
        <servlet-name>Resteasy</servlet-name>
        <servlet-class>
            org.jboss.resteasy.plugins.server.servlet.HttpServletDispatcher
        </servlet-class>
        <init-param>
            <param-name>javax.ws.rs.Application</param-name>
            <param-value>com.restfully.shop.services.ShoppingApplication</param-value>
        </init-param>
    </servlet>
    <servlet-mapping>
        <servlet-name>Resteasy</servlet-name>
        <url-pattern>/*</url-pattern>
    </servlet-mapping>
</web-app>
```

ä½¿ç”¨ ServletContextListener æ¥é…ç½®

```xml
<web-app>
   <listener>
      <listener-class>
         org.jboss.resteasy.plugins.server.servlet.ResteasyBootstrap
      </listener-class>
   </listener>
  <!-- ** INSERT YOUR LISTENERS HERE!!!! -->
   <servlet>
      <servlet-name>Resteasy</servlet-name>
      <servlet-class>
         org.jboss.resteasy.plugins.server.servlet.HttpServletDispatcher
      </servlet-class>
   </servlet>
   <servlet-mapping>
      <servlet-name>Resteasy</servlet-name>
      <url-pattern>/resteasy/*</url-pattern>
   </servlet-mapping>
</web-app>
```

ä½¿ç”¨ ServletFilter æ¥é…ç½®

```xml
<web-app>
    <filter>
        <filter-name>Resteasy</filter-name>
        <filter-class>
            org.jboss.resteasy.plugins.server.servlet.FilterDispatcher
        </filter-class>
        <init-param>
            <param-name>javax.ws.rs.Application</param-name>
            <param-value>com.restfully.shop.services.ShoppingApplication</param-value>
        </init-param>
    </filter>
    <filter-mapping>
        <filter-name>Resteasy</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>
</web-app>
```

ä¸ Spring é›†æˆ

```xml
<web-app>
   <display-name>Archetype Created Web Application</display-name>
   <listener>
      <listener-class>org.jboss.resteasy.plugins.server.servlet.ResteasyBootstrap</listener-class>
   </listener>
   <listener>
      <listener-class>org.jboss.resteasy.plugins.spring.SpringContextLoaderListener</listener-class>
   </listener>
   <servlet>
      <servlet-name>Resteasy</servlet-name>
      <servlet-class>org.jboss.resteasy.plugins.server.servlet.HttpServletDispatcher</servlet-class>
   </servlet>
   <servlet-mapping>
      <servlet-name>Resteasy</servlet-name>
      <url-pattern>/*</url-pattern>
   </servlet-mapping>
</web-app>
```

## ä½¿ç”¨ @Path,@Get,@Post ç­‰æ ‡æ³¨

```java
@Path("/library")
public class Library {
   @GET
   @Path("/books")
   public String getBooks() {...}
   @GET
   @Path("/book/{isbn}")
   public String getBook(@PathParam("isbn") String id) {
      // search my database and get a string representation and return it
   }
   @PUT
   @Path("/book/{isbn}")
   public void addBook(@PathParam("isbn") String id, @QueryParam("name") String name) {...}
   @DELETE
   @Path("/book/{id}")
   public void removeBook(@PathParam("id") String id {...}
}
```

ä»¥ä¸‹æ“ä½œéƒ½æ˜¯é’ˆå¯¹ library è¿™ä¸ªèµ„æºçš„

1. GET http://myhost.com/services/library/books æ„æ€ä¸ºè·å¾—æ‰€æœ‰çš„ books è°ƒç”¨çš„æ–¹æ³•ä¸º getBooks
2. GET http://myhost.com/services/library/book/333 æ„æ€ä¸ºè·å¾— ID ä¸º 333 çš„ book è°ƒç”¨çš„æ–¹æ³•ä¸º getBook
3. PUT http://myhost.com/services/library/book/333 æ–°å¢ä¸€ä¸ª ID ä¸º 333 çš„ book è°ƒç”¨çš„æ–¹æ³•ä¸º addBook
4. DELETE http://myhost.com/services/library/book/333 åˆ é™¤ä¸€ä¸ª ID ä¸º 333 çš„ book è°ƒç”¨çš„æ–¹æ³•ä¸º removeBook

**@Path **
è¿™ä¸ªæ ‡æ³¨å¯ä»¥åœ¨ç±»ä¸Šä¹Ÿå¯ä»¥åœ¨æ–¹æ³•ä¸Š, å¦‚æœ**ç±»å’Œæ–¹æ³•ä¸Šéƒ½æœ‰çš„è¯, é‚£ä¹ˆæ–¹æ³•ä¸Šçš„è·¯å¾„æ˜¯çº§è”çš„**å¦‚ä¸Šé¢ä¾‹å­çš„ / library/book/
@Path å’Œä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…è·¯å¾„
@Path ä¸ä»…ä»…æ¥æ”¶ç®€å•çš„è·¯å¾„è¡¨è¾¾å¼, ä¹Ÿå¯ä»¥ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼:

```java
@Path("/resources)
public class MyResource {
   @GET
   @Path("{var:.*}/stuff")
   public String get() {...}
}
```

å¦‚ä¸‹æ“ä½œå°±èƒ½è·å¾—è¯¥èµ„æº:
GET /resources/stuff
GET /resources/foo/stuff
GET /resources/on/and/on/stuff

è¡¨è¾¾å¼çš„æ ¼å¼ä¸º:

`"{" variable-name [ ":" regular-expression] "}"`

æ­£åˆ™è¡¨è¾¾å¼éƒ¨åˆ†æ˜¯å¯é€‰çš„, å½“æœªæä¾›æ—¶, åˆ™ä¼šåŒ¹é…ä¸€ä¸ªé»˜è®¤çš„è¡¨è¾¾å¼ "(`[]*`)"

@Path("/resources/{var}/stuff")

ä¼šåŒ¹é…å¦‚ä¸‹è·¯å¾„:
GET /resources/foo/stuff
GET /resources/bar/stuff

ä¸‹é¢çš„åˆ™ä¸ä¼šåŒ¹é…
GET /resources/a/bunch/of/stuff

**@QueryParam**
@QueryParam è¿™ä¸ªæ ‡æ³¨æ˜¯ç»™é€šè¿‡? çš„æ–¹å¼ä¼ å‚è·å¾—å‚æ•°å€¼çš„, å¦‚:

`GET /books?num=5&index=1`

```java
@GET
   public String getBooks(@QueryParam("num") int num,@QueryParam("index") int index) {
   ...
   }
```

è¿™é‡ŒåŒä¸Šé¢çš„ @PathParam, å‚æ•°ç±»å‹å¯ä»¥æ˜¯ä»»æ„ç±»å‹

**@HeaderParam**
è¿™ä¸ªæ ‡æ³¨æ—¶ç”¨æ¥è·å¾—ä¿å­˜åœ¨ HttpRequest å¤´é‡Œé¢çš„å‚æ•°ä¿¡æ¯çš„, å¦‚:

```java
@PUT
public void put(@HeaderParam("Content-Type") MediaType contentType, ...)
```

è¿™é‡ŒåŒä¸Šé¢çš„ @PathParam, å‚æ•°ç±»å‹å¯ä»¥æ˜¯ä»»æ„ç±»å‹

**@CookieParam**
ç”¨æ¥è·å–ä¿å­˜åœ¨ Cookie é‡Œé¢çš„å‚æ•°, å¦‚:

```java
@GET
public String getBooks(@CookieParam("sessionid") int id) {
   ...
}
```

**@FormParam**
ç”¨æ¥è·å– Form ä¸­çš„å‚æ•°å€¼, å¦‚:
é¡µé¢ä»£ç :

```html
<form method="POST" action="/resources/service">
  First name:
  <input type="text" name="firstname" />
  <br />
  Middle name:
  <input type="text" name="middlename" />
  Last name:
  <input type="text" name="lastname" />
</form>
```

åå°ä»£ç 

```java
@Path("/")
public class NameRegistry {
   @Path("/resources/service")
   @POST
   public void addName(@FormParam("firstname") String first, @FormParam("lastname") String last) {...}
}
```

æ ‡æ³¨äº† @FormParam, ä¼šæŠŠè¡¨è¾¾é‡Œé¢çš„å€¼è‡ªåŠ¨æ˜ å°„åˆ°æ–¹æ³•çš„å‚æ•°ä¸Šå».
å¦‚æœè¦å–å¾— Form é‡Œé¢çš„æ‰€æœ‰å±æ€§, å¯ä»¥é€šè¿‡åœ¨æ–¹æ³•ä¸Šå¢åŠ ä¸€ä¸ª MultivaluedMap<String, String> form è¿™æ ·çš„å¯¹è±¡æ¥è·å¾—, å¦‚ä¸‹:

```java
@Path("/resources/service")
   @POST
   public void addName(@FormParam("firstname") String first, @FormParam("lastname") String last,MultivaluedMap<String, String> form) {...}
```

**@Form**
ä¸Šé¢å·²ç»è¯´çš„å‡ ç§æ ‡æ³¨éƒ½æ˜¯ä¸€ä¸ªå±æ€§å¯¹åº”ä¸€ä¸ªå‚æ•°çš„, é‚£ä¹ˆå¦‚æœå±æ€§å¤šäº†, å®šä¹‰çš„æ–¹æ³•å°±ä¼šå˜å¾—ä¸å¥½é˜…è¯», æ­¤æ—¶æœ€å¥½æœ‰ä¸ªä¸œè¥¿èƒ½å¤ŸæŠŠä¸Šé¢çš„å‡ ç§è‡ªåŠ¨æ ‡æ³¨è‡ªåŠ¨å°è£…æˆä¸€ä¸ªå¯¹è±¡,@Form è¿™ä¸ªæ ‡æ³¨å°±æ˜¯ç”¨æ¥å®ç°è¿™ä¸ªåŠŸèƒ½çš„, å¦‚:

```java
public class MyForm {
   @FormParam("stuff")
   private int stuff;
   @HeaderParam("myHeader")
   private String header;
   @PathParam("foo")
   public void setFoo(String foo) {...}
}
```

**@POST**

```java
@Path("/myservice")
public void post(@Form MyForm form) {...}
```

**@DefaultValue**
åœ¨ä»¥ä¸Šæ ‡æ³¨ä½¿ç”¨çš„æ—¶å€™, æœ‰äº›å‚æ•°å€¼åœ¨æ²¡æœ‰å€¼çš„æƒ…å†µä¸‹å¦‚æœéœ€è¦æœ‰é»˜è®¤å€¼, åˆ™ä½¿ç”¨è¿™ä¸ªæ ‡æ³¨, å¦‚:

```java
@GET
public String getBooks(@QueryParam("num") @DefaultValue("10") int num) {...}
```

## æ»¡è¶³ JAX-RS è§„èŒƒçš„ Resource Locators å’Œå­èµ„æº

èµ„æºå¤„ç†ç±»å®šä¹‰çš„æŸä¸ªæ–¹æ³•å¯ä»¥å¤„ç†æŸä¸ªè¯·æ±‚çš„ä¸€éƒ¨åˆ†, å‰©ä½™éƒ¨åˆ†ç”±å­èµ„æºå¤„ç†ç±»æ¥å¤„ç†, å¦‚:

```java
@Path("/")
public class ShoppingStore {
   @Path("/customers/{id}")
   public Customer getCustomer(@PathParam("id") int id) {
      Customer cust = ...; // Find a customer object
      return cust;
   }
}
public class Customer {
    @GET
    public String get() {...}
    @Path("/address")
    public String getAddress() {...}
}
```

å½“æˆ‘ä»¬å‘èµ· GET /customer/123 è¿™æ ·çš„è¯·æ±‚çš„æ—¶å€™, ç¨‹åºä¼šå…ˆè°ƒç”¨ ShoppingStore çš„ getCustomer è¿™ä¸ªæ–¹æ³•, ç„¶åæ¥ç€è°ƒç”¨ Customer é‡Œé¢çš„ get æ–¹æ³•

å½“æˆ‘ä»¬å‘èµ· GET /customer/123/address è¿™æ ·çš„è¯·æ±‚çš„æ—¶å€™, ç¨‹åºä¼šå…ˆè°ƒç”¨ ShoppingStore çš„ getCustomer è¿™ä¸ªæ–¹æ³•, ç„¶åæ¥ç€è°ƒç”¨ Customer é‡Œé¢çš„ getAddress æ–¹æ³•

## JAX-RS Content Negotiation

**@Consumes**
æˆ‘ä»¬ä»é¡µé¢æäº¤æ•°æ®åˆ°åå°çš„æ—¶å€™, æ•°æ®çš„ç±»å‹å¯ä»¥æ˜¯ text çš„, xml çš„, json çš„, ä½†æ˜¯æˆ‘ä»¬åœ¨è¯·æ±‚èµ„æºçš„æ—¶å€™æƒ³è¦è¯·æ±‚åˆ°åŒä¸€ä¸ªèµ„æºè·¯å¾„ä¸Šé¢å», æ­¤æ—¶æ€ä¹ˆæ¥åŒºåˆ†å¤„ç†å‘¢? ä½¿ç”¨ @Consumes æ ‡æ³¨, ä¸‹é¢çš„ä¾‹å­å°†è¯´æ˜:

```java
 @Consumes("text/*")
@Path("/library")
public class Library {
         @POST
         public String stringBook(String book) {...}
         @Consumes("text/xml")
         @POST
         public String jaxbBook(Book book) {...}
}
```

å½“å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚çš„æ—¶å€™, ç³»ç»Ÿä¼šå…ˆæ‰¾åˆ°æ‰€æœ‰åŒ¹é…è·¯å¾„çš„æ–¹æ³•, ç„¶åæ ¹æ® content-type æ‰¾åˆ°å…·ä½“çš„å¤„ç†æ–¹æ³•, æ¯”å¦‚:

```
POST /library
content-type: text/plain
```

å°±ä¼šæ‰§è¡Œä¸Šé¢çš„ **stringBook** è¿™ä¸ªæ–¹æ³•, å› ä¸ºè¿™ä¸ªæ–¹æ³•ä¸Šé¢æ²¡æœ‰æ ‡æ³¨ @ Consumes, ç¨‹åºæ‰¾äº†æ‰€æœ‰çš„æ–¹æ³•æ²¡æœ‰æ‰¾åˆ°æ ‡æ³¨ @ Consumes(â€œtext/plainâ€) è¿™ä¸ªç±»å‹çš„, æ‰€ä»¥å°±æ‰§è¡Œè¿™ä¸ªæ–¹æ³•äº†. å¦‚æœè¯·æ±‚çš„ content-type=xml, æ¯”å¦‚:

```
POST /library
content-type: text/xml
```

æ­¤æ—¶å°±ä¼šæ‰§è¡Œ jaxbBook è¿™ä¸ªæ–¹æ³•

**@Produces**
å½“æœåŠ¡å™¨ç«¯å®è¡Œå®Œæˆç›¸å…³çš„é€»è¾‘éœ€è¦è¿”å›å¯¹è±¡çš„æ—¶å€™, ç¨‹åºä¼šæ ¹æ® @Produces è¿”å›ç›¸åº”çš„å¯¹è±¡ç±»å‹

```java
@Produces("text/*")
@Path("/library")
public class Library {
         @GET
         @Produces("application/json")
         public String getJSON() {...}
         @GET
         public String get() {...}
}
```

å¦‚æœå®¢æˆ·ç«¯å‘èµ·å¦‚ä¸‹è¯·æ±‚

```
GET /library
```

é‚£ä¹ˆåˆ™ä¼šè°ƒç”¨åˆ° get æ–¹æ³•å¹¶ä¸”è¿”å›çš„æ ¼å¼æ˜¯ json ç±»å‹çš„
è¿™äº›æ ‡æ³¨èƒ½ä¸èƒ½å†™å¤šä¸ªå‘¢? ç­”æ¡ˆæ˜¯å¯ä»¥çš„, ä½†æ˜¯ç³»ç»Ÿåªè®¤ç¬¬ä¸€ä¸ª

## [Springç”Ÿæ€ä¸‹çš„Logbackï¼šå®ç°ç»“æ„åŒ–æ—¥å¿—çš„ç§˜è¯€](https://blog.dong4j.site/posts/b6d58107.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

# [logback ä½¿ç”¨ï¼Œè‡ªå®šä¹‰è¾“å‡ºæ ¼å¼](http://www.ulewo.com/user/10001/blog/550)

è¯´åˆ° log4jï¼ŒåŸºæœ¬äººäººéƒ½çŸ¥é“ï¼Œä½†æ˜¯ logbackï¼Œä¼°è®¡ç”¨çš„äººä¸å¤šï¼Œå…¶å®è¿™ä¸¤ä¸ªéƒ½æ˜¯ sl4j çš„å®ç°ï¼Œè€Œä¸”æ˜¯ä¸€ä¸ªä½œè€…å†™çš„ã€‚

logback æ¯” log4j æ›´åŠ å¥½ç”¨ï¼Œè€Œä¸”æ•ˆç‡æ›´é«˜ã€‚

å¦‚ä½•é…ç½® logbackã€‚

```xml
<dependency>
    <groupId>ch.qos.logback</groupId>
    <artifactId>logback-classic</artifactId>
    <version>1.1.3</version>
</dependency>
```

é…ç½®æ–‡ä»¶ï¼šlogback.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<configuration scan="true" scanPeriod="10 minutes">
 <property name="LOG_HOME" value="d:/logs"/>

 <appender name="stdot" class="ch.qos.logback.core.ConsoleAppender">
  <layout class="ch.qos.logback.classic.PatternLayout">
   <pattern>%d{yyyy-MM-dd HH:mm:ss} [%p][%c][%M][%L]-> %m%n</pattern>
  </layout>
 </appender>
 <appender name="file" class="ch.qos.logback.core.rolling.RollingFileAppender">
  <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
   <FileNamePattern>${LOG_HOME}/log.%d{yyyy-MM-dd}(%i).log</FileNamePattern>
   <cleanHistoryOnStart>true</cleanHistoryOnStart>
   <TimeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
    <MaxFileSize>10MB</MaxFileSize>
   </TimeBasedFileNamingAndTriggeringPolicy>
  </rollingPolicy>
  <encoder>
    <charset>utf-8</charset>
    <pattern>%d{yyyy-MM-dd HH:mm:ss} [%p][%c][%M][%L]-> %m%n</pattern>
  </encoder>
  <append>false</append>
  <prudent>false</prudent>
 </appender>

 <logger name="org.mortbay.log" additivity="false"  level="ERROR">
       <appender-ref ref="stdot" />
 </logger>

 <logger name="org.mybatis.spring" additivity="false"  level="ERROR">
       <appender-ref ref="stdot" />
 </logger>

 <root level="debug">
  <appender-ref ref="stdot" />
  <appender-ref ref="file" />
 </root>

</configuration>
```

å°†è¿™ä¸ªæ–‡ä»¶æ”¾åˆ°èµ„æºç›®å½•æ ¹ç›®å½•ä¸‹ï¼ŒæœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œlogback ä¼šæ ¹æ® logback è¿™ä¸ªåç§°è‡ªå·±å»åŒ¹é…åŠ è½½

è¿™é‡Œå¦‚æœè¦è¾“å‡ºé¡¹ç›®ä¸­çš„ SQL å¾ˆç®€å•ï¼Œåªéœ€è¦å°†æ—¥å¿—çº§åˆ«æ”¹æˆ debug å°±å¯ä»¥äº†ï¼ˆmybatis æ˜¯è¿™æ ·çš„ï¼Œå…¶ä»–çš„æ²¡è¯•è¿‡ï¼‰

ä»Šå¤©ä¸»è¦è¯´çš„æ˜¯æ—¥å¿—æ ¼å¼

`%d{yyyy-MM-dd HH:mm:ss} [%p][%c][%M][%L]-> %m%n Â  Â `

è¿™é‡Œå°±æ˜¯é…ç½®æ ¼å¼çš„ï¼Œä»¥ä¸‹æ˜¯å„ä¸ªå‚æ•°çš„è¯´æ˜

| å‚æ•° | è¯´æ˜                                                                                                                                                   |
| :--: | :----------------------------------------------------------------------------------------------------------------------------------------------------- |
|  %m  | è¾“å‡ºä»£ç ä¸­æŒ‡å®šçš„æ¶ˆæ¯                                                                                                                                   |
|  %p  | è¾“å‡ºä¼˜å…ˆçº§ï¼Œå³ DEBUGï¼ŒINFOï¼ŒWARNï¼ŒERRORï¼ŒFATAL                                                                                                         |
|  %r  | è¾“å‡ºè‡ªåº”ç”¨å¯åŠ¨åˆ°è¾“å‡ºè¯¥ log ä¿¡æ¯è€—è´¹çš„æ¯«ç§’æ•°                                                                                                            |
|  %c  | è¾“å‡ºæ‰€å±çš„ç±»ç›®ï¼Œé€šå¸¸å°±æ˜¯æ‰€åœ¨ç±»çš„å…¨å                                                                                                                   |
|  %t  | è¾“å‡ºäº§ç”Ÿè¯¥æ—¥å¿—äº‹ä»¶çš„çº¿ç¨‹å                                                                                                                             |
|  %n  | è¾“å‡ºä¸€ä¸ªå›è½¦æ¢è¡Œç¬¦ï¼ŒWindows å¹³å°ä¸º `\r\n`ï¼ŒUnix å¹³å°ä¸º `\n`                                                                                            |
|  %d  | è¾“å‡ºæ—¥å¿—æ—¶é—´ç‚¹çš„æ—¥æœŸæˆ–æ—¶é—´ï¼Œé»˜è®¤æ ¼å¼ä¸º ISO8601ï¼Œä¹Ÿå¯ä»¥åœ¨å…¶åæŒ‡å®šæ ¼å¼ï¼Œæ¯”å¦‚ï¼š%d{yyy MMM dd HH:mm:ss,SSS}ï¼Œè¾“å‡ºç±»ä¼¼ï¼š2002 å¹´ 10 æœˆ 18 æ—¥ 22ï¼š10ï¼š28ï¼Œ921 |
|  %l  | è¾“å‡ºæ—¥å¿—äº‹ä»¶çš„å‘ç”Ÿä½ç½®ï¼ŒåŒ…æ‹¬ç±»ç›®åã€å‘ç”Ÿçš„çº¿ç¨‹ï¼Œä»¥åŠåœ¨ä»£ç ä¸­çš„è¡Œæ•°ã€‚ä¸¾ä¾‹ï¼šTestlog4.main(TestLog4.java:10)                                              |

è¿™ä¸ªæ—¶å€™ï¼Œæ—¥å¿—å°±ä¼šè¾“å‡º æ—¶é—´ï¼Œæ—¥å¿—ä¼˜å…ˆçº§ï¼Œç±»åï¼Œæ–¹æ³•åï¼Œè¡Œæ•°ï¼Œæ—¥å¿—å†…å®¹

åŸºæœ¬å°±æ˜¯è¿™æ ·çš„äº†

```
2016-09-02 14:45:53 [DEBUG][com.ulewo.mapper.SignInMapper.selectCount][debug][132]-> ==>  Preparing: select count(1) from ulewo_sign_in WHERE sign_date = DATE_FORMAT(?,'%Y-%m-%d')

2016-09-02 14:45:53 [DEBUG][com.ulewo.mapper.SignInMapper.selectCount][debug][132]-> ==> Parameters: 2016-09-02 14:45:53.098(Timestamp)

2016-09-02 14:45:53 [DEBUG][com.ulewo.mapper.SignInMapper.selectCount][debug][132]-> <==      Total: 1
```

è¿™é‡Œè¾“å‡ºäº† SQLã€‚

ä¸ºä»€ä¹ˆè¦è®²è¾“å‡ºæ ¼å¼ï¼Œæœ¬æ¥è¿™æ ·è¾“å‡ºæŒºå¥½çš„å‘€ï¼Œæ˜¯çš„ï¼Œç°åœ¨åœ¨æˆ‘ä»¬çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ€»å…±æœ‰ 16 å°æœåŠ¡å™¨ï¼Œæœ‰æ—¶å€™æŸ¥é—®é¢˜ï¼Œè¦ä¸€å°å°çš„æŸ¥ï¼Œå› ä¸ºä¸çŸ¥é“è¯·æ±‚åˆ°åº•æ˜¯å¤§åˆ°é‚£ä¸ªæœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·æŸ¥é—®é¢˜éå¸¸çš„ç—›è‹¦ï¼Œäºæ˜¯é¡¹ç›®å¼•å…¥äº† graylog ä¸€ä¸ªæ—¥å¿—æ”¶é›†å·¥å…·ï¼Œå¯ä»¥å°†å„ä¸ªæœåŠ¡å™¨çš„æ—¥å¿—æ”¶é›†åˆ°ä¸€èµ·ï¼Œè¿™æ ·æŸ¥é—®é¢˜å°±æ–¹ä¾¿å¤šäº†ã€‚ä½†æ˜¯ graylog è¦æ±‚æ—¥å¿—å¿…é¡»æ˜¯ json æ ¼å¼çš„ï¼Œé‚£ä¹ˆæŒ‰ç…§æˆ‘ä¸Šé¢æ ¼å¼å°±æ— æ³•ä½¿ç”¨äº†ï¼Œæ‰€ä»¥è¦ä¿®æ”¹æ—¥å¿—è¾“å‡ºæ ¼å¼ã€‚

æŸ¥äº†ä¸€ç•ªèµ„æ–™å‘ç°ï¼Œåªè¦é‡å†™ ClassicConverter å’Œ PatternLayout è¿™ä¸¤ä¸ªç±»å°±å¯ä»¥äº†

**é‡æ–° Converter ç±»**

```java
public class NetbarLogerConvert extends ClassicConverter {

 long lastTimestamp = -1;
 String timestampStrCache = null;
 SimpleDateFormat simpleFormat = null;

 String businessName = null;

 static String hostName;
 static String localIp;

 static {
  InetAddress ia = null;
  try {
   ia = ia.getLocalHost();
   hostName = ia.getHostName();
   localIp = ia.getHostAddress();
  } catch (Exception e) {
   // TODO Auto-generated catch block
   e.printStackTrace();
  }
 }

 @Override
 public String convert(ILoggingEvent le) {
  LogObject log = new LogObject();
  log.setBusiness(businessName);
  log.setIp(localIp);
  log.setHostName(hostName);
  log.setTime(getTime(le));
  log.setLeave(le.getLevel().toString());
  log.setClassName(getFullyQualifiedName(le));
  log.setMethodName(getMethodName(le));
  log.setLine(getLineNumber(le));
  log.setMessage(le.getFormattedMessage());
  return JacksonUtil.writJson(log);
 }

 public void start() {
  businessName = getFirstOption();
  businessName = businessName == null ? "æœªè®¾ç½®äº§å“çº¿" : businessName;
  String datePattern = DateStyle.YYYY_MM_DD_HH_MM_SS.getValue();
  try {
   simpleFormat = new SimpleDateFormat(datePattern);
   // maximumCacheValidity =
   // CachedDateFormat.getMaximumCacheValidity(pattern);
  } catch (IllegalArgumentException e) {
   addWarn("Could not instantiate SimpleDateFormat with pattern " + datePattern, e);
   // default to the ISO8601 format
   simpleFormat = new SimpleDateFormat(CoreConstants.ISO8601_PATTERN);
  }
  List optionList = getOptionList();
  // if the option list contains a TZ option, then set it.
  if (optionList != null && optionList.size() > 1) {
   TimeZone tz = TimeZone.getTimeZone((String) optionList.get(1));
   simpleFormat.setTimeZone(tz);
  }
 }

 private String getTime(ILoggingEvent le) {
  long timestamp = le.getTimeStamp();
  synchronized (this) {
   // if called multiple times within the same millisecond
   // return cache value
   if (timestamp == lastTimestamp) {
    return timestampStrCache;
   } else {
    lastTimestamp = timestamp;
    // SimpleDateFormat is not thread safe.
    // See also http://jira.qos.ch/browse/LBCLASSIC-36
    timestampStrCache = simpleFormat.format(new Date(timestamp));
    return timestampStrCache;
   }
  }
 }

 private String getFullyQualifiedName(ILoggingEvent le) {

  StackTraceElement[] cda = le.getCallerData();
  if (cda != null && cda.length > 0) {
   return cda[0].getClassName();
  } else {
   return CallerData.NA;
  }
 }

 private String getLineNumber(ILoggingEvent le) {
  StackTraceElement[] cda = le.getCallerData();
  if (cda != null && cda.length > 0) {
   return Integer.toString(cda[0].getLineNumber());
  } else {
   return CallerData.NA;
  }
 }

 private String getMethodName(ILoggingEvent le) {
  StackTraceElement[] cda = le.getCallerData();
  if (cda != null && cda.length > 0) {
   return cda[0].getMethodName();
  } else {
   return CallerData.NA;
  }
 }

 public class LogObject {
  /**
   * äº§å“çº¿
   */
  private String business;
  /**
   * ä¸»æœºå
   */
  private String hostName;
  /**
   * IP
   */
  private String ip;
  /**
   * æ—¶é—´
   */
  private String time;
  /**
   * æ—¥å¿—çº§åˆ«
   */
  private String leave;
  /**
   * ç±»å
   */
  private String className;
  /**
   * æ–¹æ³•å
   */
  private String methodName;
  /**
   * è¡Œæ•°
   */
  private String line;
  /**
   * æ—¥å¿—å†…å®¹
   */
  private String message;

  public String getTime() {
   return time;
  }

  public void setTime(String time) {
   this.time = time;
  }

  public String getLeave() {
   return leave;
  }

  public void setLeave(String leave) {
   this.leave = leave;
  }

  public String getClassName() {
   return className;
  }

  public void setClassName(String className) {
   this.className = className;
  }

  public String getMethodName() {
   return methodName;
  }

  public void setMethodName(String methodName) {
   this.methodName = methodName;
  }

  public String getLine() {
   return line;
  }

  public void setLine(String line) {
   this.line = line;
  }

  public String getMessage() {
   return message;
  }

  public void setMessage(String message) {
   this.message = message;
  }

  public String getBusiness() {
   return business;
  }

  public void setBusiness(String business) {
   this.business = business;
  }

  public String getIp() {
   return ip;
  }

  public void setIp(String ip) {
   this.ip = ip;
  }

  public String getHostName() {
   return hostName;
  }

  public void setHostName(String hostName) {
   this.hostName = hostName;
  }

 }
}
```

**é‡å†™ layout ç±»**

```java
public class NetbarLoggerPatternLayout extends PatternLayout {
 static {
  defaultConverterMap.put("netbarLoggerPattern", NetbarLogerConvert.class.getName());
 }
}
```

è¿™é‡Œå¦‚ä½•è·å– æ–¹æ³•åï¼Œè¡Œæ•°ï¼Œç”šè‡³è¿˜æœ‰å…¶ä»–çš„ä¸€äº›ä¿¡æ¯å¯ä»¥å‚è€ƒ logback

è¿™ä¸ªç±»ï¼š

```java
public class PatternLayout extends PatternLayoutBase<ILoggingEvent> {

  public static final Map<String, String> defaultConverterMap = new HashMap<String, String>();

  static {

    defaultConverterMap.put("d", DateConverter.class.getName());
    defaultConverterMap.put("date", DateConverter.class.getName());

    defaultConverterMap.put("r", RelativeTimeConverter.class.getName());
    defaultConverterMap.put("relative", RelativeTimeConverter.class.getName());

    defaultConverterMap.put("level", LevelConverter.class.getName());
    defaultConverterMap.put("le", LevelConverter.class.getName());
    defaultConverterMap.put("p", LevelConverter.class.getName());

    defaultConverterMap.put("t", ThreadConverter.class.getName());
    defaultConverterMap.put("thread", ThreadConverter.class.getName());

    defaultConverterMap.put("lo", LoggerConverter.class.getName());
    defaultConverterMap.put("logger", LoggerConverter.class.getName());
    defaultConverterMap.put("c", LoggerConverter.class.getName());

    defaultConverterMap.put("m", MessageConverter.class.getName());
    defaultConverterMap.put("msg", MessageConverter.class.getName());
    defaultConverterMap.put("message", MessageConverter.class.getName());

    defaultConverterMap.put("C", ClassOfCallerConverter.class.getName());
    defaultConverterMap.put("class", ClassOfCallerConverter.class.getName());

    defaultConverterMap.put("M", MethodOfCallerConverter.class.getName());
    defaultConverterMap.put("method", MethodOfCallerConverter.class.getName());

    defaultConverterMap.put("L", LineOfCallerConverter.class.getName());
    defaultConverterMap.put("line", LineOfCallerConverter.class.getName());

    defaultConverterMap.put("F", FileOfCallerConverter.class.getName());
    defaultConverterMap.put("file", FileOfCallerConverter.class.getName());

    defaultConverterMap.put("X", MDCConverter.class.getName());
    defaultConverterMap.put("mdc", MDCConverter.class.getName());

    defaultConverterMap.put("ex", ThrowableProxyConverter.class.getName());
    defaultConverterMap.put("exception", ThrowableProxyConverter.class
        .getName());
    defaultConverterMap.put("throwable", ThrowableProxyConverter.class
        .getName());

    defaultConverterMap.put("xEx", ExtendedThrowableProxyConverter.class.getName());
    defaultConverterMap.put("xException", ExtendedThrowableProxyConverter.class
        .getName());
    defaultConverterMap.put("xThrowable", ExtendedThrowableProxyConverter.class
        .getName());

    defaultConverterMap.put("nopex", NopThrowableInformationConverter.class
        .getName());
    defaultConverterMap.put("nopexception",
        NopThrowableInformationConverter.class.getName());

    defaultConverterMap.put("cn", ContextNameAction.class.getName());
    defaultConverterMap.put("contextName", ContextNameConverter.class.getName());

    defaultConverterMap.put("caller", CallerDataConverter.class.getName());

    defaultConverterMap.put("marker", MarkerConverter.class.getName());

    defaultConverterMap.put("property", PropertyConverter.class.getName());


    defaultConverterMap.put("n", LineSeparatorConverter.class.getName());
  }

  public PatternLayout() {
    this.postCompileProcessor = new EnsureExceptionHandling();
  }

  public Map<String, String> getDefaultConverterMap() {
    return defaultConverterMap;
  }

  public String doLayout(ILoggingEvent event) {
    if (!isStarted()) {
      return CoreConstants.EMPTY_STRING;
    }
    return writeLoopOnConverters(event);
  }

}
```

è¿™é‡Œæœ‰å„ä¸ªå‚æ•° convert çš„å®ç°ï¼Œç›´æ¥æ‹·è´è¿‡æ¥å°±å¯ä»¥äº†ã€‚

ç„¶å logback è¿™é‡Œçš„é…ç½®ä¿®æ”¹ä¸‹

```
 appenderÂ name="stdot"Â class="ch.qos.logback.core.ConsoleAppender">Â Â Â Â Â Â Â Â 
  layoutÂ class="com.stnts.netbar.logger.NetbarLoggerPatternLayout">
   pattern>%netbarLoggerPattern{XXXç³»ç»Ÿ}Â %npattern>Â Â Â Â Â Â Â Â 
  layout>
 appender>
```

ä¸Šé¢ layout çš„ class æŒ‡å®šä¸ºä½ é‡å†™çš„ class,pattern ä¸­ç”¨ä½ è‡ªå·±å®šä¹‰çš„ pattern ååé¢å¤§æ‹¬å·æ˜¯å®šä¹‰äº§å“çº¿çš„

è¿™ä¸ªæ—¶å€™æ—¥å¿—å°±æ˜¯è¿™æ ·è¾“å‡ºçš„ï¼š

```
{"message":"[å¾®ä¿¡å…¬ä¼—å¸å·][å®šæ—¶åˆ·æ–° AccessToken çš„å®šæ—¶å™¨] redis ä¸­è·å–çš„ accessToken çš„è¿‡æœŸæ—¶é—´: 7200 ç§’","methodName":"refresh","className":"xxx.xxx.xxx.class","hostName":"pcname","time":"2016-09-02 14:40:00","leave":"INFO","line":"50","business":"xxxx ç³»ç»Ÿ","ip":"192.168.32.115"}
```

å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„ json äº†ã€‚

å½“ç„¶ä½ è§‰å¾—è¿™æ ·çš„æ—¥å¿—æ ¼å¼ï¼Œä½ çœ‹èµ·æ¥è¿˜ä¸èˆ’æœï¼Œå¯ä»¥è‡ªå·±å»å®šä¹‰äº†ã€‚

## [å‘Šåˆ«keys *ï¼ŒæŒæ¡Redis scanç³»åˆ—å‘½ä»¤çš„ç²¾é«“](https://blog.dong4j.site/posts/958ae77b.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## 1. ä»‹ç»

`scan`å‘½ä»¤çš„ä½œç”¨å’Œ`keys *`çš„ä½œç”¨ç±»ä¼¼ï¼Œä¸»è¦ç”¨äºæŸ¥æ‰¾ redis ä¸­çš„é”®ï¼Œä½†æ˜¯åœ¨æ­£å¼çš„ç”Ÿäº§ç¯å¢ƒä¸­ä¸€èˆ¬ä¸ä¼šç›´æ¥ä½¿ç”¨`keys *`
è¿™ä¸ªå‘½ä»¤ï¼Œå› ä¸ºä»–ä¼šè¿”å›æ‰€æœ‰çš„é”®ï¼Œå¦‚æœé”®çš„æ•°é‡å¾ˆå¤šä¼šå¯¼è‡´æŸ¥è¯¢æ—¶é—´å¾ˆé•¿ï¼Œè¿›è€Œå¯¼è‡´æœåŠ¡å™¨é˜»å¡ï¼Œæ‰€ä»¥éœ€è¦ scan æ¥è¿›è¡Œæ›´ç»†è‡´çš„æŸ¥æ‰¾

`scan`æ€»å…±æœ‰è¿™å‡ ç§å‘½ä»¤ï¼š`scan`ã€`sscan`ã€`hscan`ã€`zscan`ï¼Œåˆ†åˆ«ç”¨äºè¿­ä»£æ•°æ®åº“ä¸­çš„ï¼šæ•°æ®åº“ä¸­æ‰€æœ‰é”®ã€é›†åˆé”®ã€å“ˆå¸Œé”®ã€æœ‰åºé›†åˆé”®ï¼Œå‘½ä»¤å…·ä½“ç»“æ„å¦‚ä¸‹ï¼š

```bash
scan cursor [MATCH pattern] [COUNT count] [TYPE type]
sscan key cursor [MATCH pattern] [COUNT count]
hscan key cursor [MATCH pattern] [COUNT count]
zscan key cursor [MATCH pattern] [COUNT count]
```

## 2. scan

`scan cursor [MATCH pattern] [COUNT count] [TYPE type]`ï¼Œcursor è¡¨ç¤ºæ¸¸æ ‡ï¼ŒæŒ‡æŸ¥è¯¢å¼€å§‹çš„ä½ç½®ï¼Œcount é»˜è®¤ä¸º 10ï¼ŒæŸ¥è¯¢å®Œåä¼šè¿”å›ä¸‹ä¸€ä¸ªå¼€å§‹çš„æ¸¸æ ‡ï¼Œå½“è¿”å› 0 çš„æ—¶å€™è¡¨ç¤ºæ‰€æœ‰é”®æŸ¥è¯¢å®Œäº†

```bash
127.0.0.1:6379[2]> scan 0
1) "3"
2)  1) "mystring"
    2) "myzadd"
    3) "myhset"
    4) "mylist"
    5) "myset2"
    6) "myset1"
    7) "mystring1"
    8) "mystring3"
    9) "mystring4"
   10) "myset"
127.0.0.1:6379[2]> scan 3
1) "0"
2) 1) "myzadd1"
   2) "mystring2"
   3) "mylist2"
   4) "myhset1"
   5) "mylist1"
```

MATCH å¯ä»¥é‡‡ç”¨æ¨¡ç³ŠåŒ¹é…æ‰¾å‡ºè‡ªå·±æƒ³è¦æŸ¥æ‰¾çš„é”®ï¼Œè¿™é‡Œçš„é€»è¾‘æ˜¯å…ˆæŸ¥å‡º 20 ä¸ªï¼Œå†åŒ¹é…ï¼Œè€Œä¸æ˜¯å…ˆåŒ¹é…å†æŸ¥è¯¢ï¼Œè¿™é‡ŒåŠ ä¸Š count
20 æ˜¯å› ä¸ºé»˜è®¤æŸ¥å‡ºçš„ 10 ä¸ªæ•°ä¸­å¯èƒ½ä¸èƒ½åŒ…å«æ‰€æœ‰çš„ç›¸å…³é¡¹ï¼Œæ‰€ä»¥æŠŠèŒƒå›´æ‰©å¤§åˆ°æŸ¥ 20 ä¸ªï¼Œæˆ‘è¿™é‡Œæµ‹è¯•çš„é”®æ€»å…±æœ‰ 15 ä¸ª

```bash
127.0.0.1:6379[2]> scan 0 match mylist* count 20
1) "0"
2) 1) "mylist"
   2) "mylist2"
   3) "mylist1"
```

TYPE å¯ä»¥æ ¹æ®å…·ä½“çš„ç»“æ„ç±»å‹æ¥åŒ¹é…è¯¥ç±»å‹çš„é”®

```bash
127.0.0.1:6379[2]> scan 0 count 20 type list
1) "0"
2) 1) "mylist"
   2) "mylist2"
   3) "mylist1"
```

## 3. sscan

`sscan key cursor [MATCH pattern] [COUNT count]`ï¼Œsscan çš„ç¬¬ä¸€ä¸ªå‚æ•°æ€»æ˜¯é›†åˆç±»å‹çš„ key

```bash
127.0.0.1:6379[2]> sadd myset1 a b c d
(integer) 4
127.0.0.1:6379[2]> smembers myset1
1) "d"
2) "a"
3) "c"
4) "b"
127.0.0.1:6379[2]> sscan myset1 0
1) "0"
2) 1) "d"
   2) "c"
   3) "b"
   4) "a"
127.0.0.1:6379[2]> sscan myset1 0 match a
1) "0"
2) 1) "a"
```

## 4. hscan

`hscan key cursor [MATCH pattern] [COUNT count]`ï¼Œsscan çš„ç¬¬ä¸€ä¸ªå‚æ•°æ€»æ˜¯å“ˆå¸Œç±»å‹çš„ key

```bash
127.0.0.1:6379[2]> hset myhset1 kk1 vv1 kk2 vv2 kk3 vv3
(integer) 3
127.0.0.1:6379[2]> hgetall myhset1
1) "kk1"
2) "vv1"
3) "kk2"
4) "vv2"
5) "kk3"
6) "vv3"
127.0.0.1:6379[2]> hscan myhset1 0
1) "0"
2) 1) "kk1"
   2) "vv1"
   3) "kk2"
   4) "vv2"
   5) "kk3"
   6) "vv3"
```

## 5. zscan

`zscan key cursor [MATCH pattern] [COUNT count]`ï¼Œsscan çš„ç¬¬ä¸€ä¸ªå‚æ•°æ€»æ˜¯æœ‰åºé›†åˆç±»å‹çš„ key

```bash
127.0.0.1:6379[2]> zadd myzadd1 1 zz1 2 zz2 3 zz3
(integer) 3
127.0.0.1:6379[2]> zrange myzadd1 0 -1 withscores
1) "zz1"
2) "1"
3) "zz2"
4) "2"
5) "zz3"
6) "3"
127.0.0.1:6379[2]> zscan myzadd1 0
1) "0"
2) 1) "zz1"
   2) "1"
   3) "zz2"
   4) "2"
   5) "zz3"
   6) "3"
```

## [åŸå‹æ¨¡å¼æ­ç§˜ï¼šä»Linuxå‘½ä»¤scpåˆ°è®¾è®¡æ¨¡å¼çš„å®è·µåº”ç”¨](https://blog.dong4j.site/posts/91ad9ce3.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

#### æ¯å¤©ä¸€ä¸ª Linux å‘½ä»¤

**scp**

åŠ å¯†çš„æ–¹å¼åœ¨æœ¬åœ°ä¸»æœºå’Œè¿œç¨‹ä¸»æœºä¹‹é—´å¤åˆ¶æ–‡ä»¶

ç”¨äºåœ¨ Linux ä¸‹è¿›è¡Œè¿œç¨‹æ‹·è´æ–‡ä»¶çš„å‘½ä»¤, å’Œå®ƒç±»ä¼¼çš„å‘½ä»¤æœ‰ cp, ä¸è¿‡ cp åªæ˜¯åœ¨æœ¬æœºè¿›è¡Œæ‹·è´ä¸èƒ½è·¨æœåŠ¡å™¨, è€Œä¸” scp ä¼ è¾“æ˜¯åŠ å¯†çš„. å¯èƒ½ä¼šç¨å¾®å½±å“ä¸€ä¸‹é€Ÿåº¦.
å½“ä½ æœåŠ¡å™¨ç¡¬ç›˜å˜ä¸ºåªè¯» read only system æ—¶, ç”¨ scp å¯ä»¥å¸®ä½ æŠŠæ–‡ä»¶ç§»å‡ºæ¥. å¦å¤–, scp è¿˜éå¸¸ä¸å èµ„æº, ä¸ä¼šæé«˜å¤šå°‘ç³»ç»Ÿè´Ÿè·, åœ¨è¿™ä¸€ç‚¹ä¸Š, rsync
å°±è¿œè¿œä¸åŠå®ƒäº†. è™½ç„¶ rsync æ¯” scp ä¼šå¿«ä¸€ç‚¹, ä½†å½“å°æ–‡ä»¶ä¼—å¤šçš„æƒ…å†µä¸‹, rsync ä¼šå¯¼è‡´ç¡¬ç›˜ I/O éå¸¸é«˜, è€Œ scp åŸºæœ¬ä¸å½±å“ç³»ç»Ÿæ­£å¸¸ä½¿ç”¨.

```
-1: ä½¿ç”¨ ssh åè®®ç‰ˆæœ¬ 1ï¼›
-2: ä½¿ç”¨ ssh åè®®ç‰ˆæœ¬ 2ï¼›
-4: ä½¿ç”¨ ipv4ï¼›
-6: ä½¿ç”¨ ipv6ï¼›
-B: ä»¥æ‰¹å¤„ç†æ¨¡å¼è¿è¡Œï¼›
-C: ä½¿ç”¨å‹ç¼©ï¼›
-F: æŒ‡å®š ssh é…ç½®æ–‡ä»¶ï¼›
-l: æŒ‡å®šå®½å¸¦é™åˆ¶ï¼›
-o: æŒ‡å®šä½¿ç”¨çš„ ssh é€‰é¡¹ï¼›
-P: æŒ‡å®šè¿œç¨‹ä¸»æœºçš„ç«¯å£å·ï¼›
-p: ä¿ç•™æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´, æœ€åè®¿é—®æ—¶é—´å’Œæƒé™æ¨¡å¼ï¼›
-q: ä¸æ˜¾ç¤ºå¤åˆ¶è¿›åº¦ï¼›
-r: ä»¥é€’å½’æ–¹å¼å¤åˆ¶.
```

**ä»è¿œç¨‹å¤åˆ¶æ–‡ä»¶åˆ°æœ¬åœ°ç›®å½•**

```bash
scp root@10.10.10.10:/opt/soft/nginx-0.5.38.tar.gz /opt/soft/
```

**ä¸Šä¼ æœ¬åœ°ç›®å½•åˆ°è¿œç¨‹æœºå™¨æŒ‡å®šç›®å½•**

```bash
scp -r /opt/soft/mongodb root@10.10.10.10:/opt/soft/scptest
```

# åˆ›å»ºè€…æ¨¡å¼ä¹‹å››: åŸå‹æ¨¡å¼

ä½¿ç”¨åŸå‹å®ä¾‹æŒ‡å®šåˆ›å»ºå¯¹è±¡çš„ç§ç±», å¹¶ä¸”é€šè¿‡æ‹·è´è¿™äº›åŸå‹åˆ›å»ºæ–°çš„å¯¹è±¡

å°†ä¸€ä¸ªåŸå‹å¯¹è±¡ä¼ ç»™é‚£ä¸ªè¦å‘åŠ¨åˆ›å»ºçš„å¯¹è±¡, è¿™ä¸ªè¦å‘åŠ¨åˆ›å»ºçš„å¯¹è±¡é€šè¿‡è¯·æ±‚åŸå‹å¯¹è±¡æ‹·è´è‡ªå·±æ¥å®ç°åˆ›å»ºè¿‡ç¨‹. ç”±äºåœ¨è½¯ä»¶ç³»ç»Ÿä¸­æˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°éœ€è¦åˆ›å»ºå¤šä¸ªç›¸åŒæˆ–è€…ç›¸ä¼¼å¯¹è±¡çš„æƒ…å†µ,
å› æ­¤åŸå‹æ¨¡å¼åœ¨çœŸå®å¼€å‘ä¸­çš„ä½¿ç”¨é¢‘ç‡è¿˜æ˜¯éå¸¸é«˜çš„. åŸå‹æ¨¡å¼æ˜¯ä¸€ç§ â€œå¦ç±»â€ çš„åˆ›å»ºå‹æ¨¡å¼, åˆ›å»ºå…‹éš†å¯¹è±¡çš„å·¥å‚å°±æ˜¯åŸå‹ç±»è‡ªèº«, å·¥å‚æ–¹æ³•ç”±å…‹éš†æ–¹æ³•æ¥å®ç°.

éœ€è¦æ³¨æ„çš„æ˜¯é€šè¿‡å…‹éš†æ–¹æ³•æ‰€åˆ›å»ºçš„å¯¹è±¡æ˜¯å…¨æ–°çš„å¯¹è±¡, å®ƒä»¬åœ¨å†…å­˜ä¸­æ‹¥æœ‰æ–°çš„åœ°å€, é€šå¸¸å¯¹å…‹éš†æ‰€äº§ç”Ÿçš„å¯¹è±¡è¿›è¡Œä¿®æ”¹å¯¹åŸå‹å¯¹è±¡ä¸ä¼šé€ æˆä»»ä½•å½±å“,
æ¯ä¸€ä¸ªå…‹éš†å¯¹è±¡éƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„. é€šè¿‡ä¸åŒçš„æ–¹å¼ä¿®æ”¹å¯ä»¥å¾—åˆ°ä¸€ç³»åˆ—ç›¸ä¼¼ä½†ä¸å®Œå…¨ç›¸åŒçš„å¯¹è±¡.

## UML

![20241229154732_3EW1ousA.webp](https://cdn.dong4j.site/source/image/20241229154732_3EW1ousA.webp)

**Prototype (æŠ½è±¡åŸå‹ç±»)**
å£°æ˜å…‹éš†æ–¹æ³•çš„æ¥å£, æ˜¯æ‰€æœ‰å…·ä½“åŸå‹ç±»çš„å…¬å…±çˆ¶ç±»
**ConcretePrototype (å…·ä½“åŸå‹ç±»)**
å®ç°åœ¨æŠ½è±¡åŸå‹ç±»ä¸­å£°æ˜çš„å…‹éš†æ–¹æ³•, åœ¨å…‹éš†æ–¹æ³•ä¸­è¿”å›è‡ªå·±çš„ä¸€ä¸ªå…‹éš†å¯¹è±¡
**Client (å®¢æˆ·ç±»)**
è®©ä¸€ä¸ªåŸå‹å¯¹è±¡å…‹éš†è‡ªèº«ä»è€Œåˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡, åœ¨å®¢æˆ·ç±»ä¸­åªéœ€è¦ç›´æ¥å®ä¾‹åŒ–æˆ–é€šè¿‡å·¥å‚æ–¹æ³•ç­‰æ–¹å¼åˆ›å»ºä¸€ä¸ªåŸå‹å¯¹è±¡, å†é€šè¿‡è°ƒç”¨è¯¥å¯¹è±¡çš„å…‹éš†æ–¹æ³•å³å¯å¾—åˆ°å¤šä¸ªç›¸åŒçš„å¯¹è±¡

### ä¸¤ç§é€šç”¨æ–¹æ³•å®ç°åŸå‹æ¨¡å¼

**1. åœ¨å…·ä½“åŸå‹ç±»çš„å…‹éš†æ–¹æ³•ä¸­å®ä¾‹åŒ–ä¸€ä¸ªä¸è‡ªèº«ç±»å‹ç›¸åŒçš„å¯¹è±¡å¹¶å°†å…¶è¿”å›, å¹¶å°†ç›¸å…³çš„å‚æ•°ä¼ å…¥æ–°åˆ›å»ºçš„å¯¹è±¡ä¸­, ä¿è¯å®ƒä»¬çš„æˆå‘˜å±æ€§ç›¸åŒ**

```java
class ConcretePrototype implements Prototype{
    private String attr;
    public void setAttr(String attr){
        this.attr = attr;
    }
    public String getAttr(){
        return this.attr;
    }
    public Prototype clone(){
        Prototype prototype = new ConcretePrototype();
        prototype.setAttr(this.attr);
        return prototype;
    }
}
```

åœ¨ clone æ–¹æ³•ä¸­æ–°åˆ›å»ºä¸€ä¸ªå®ä¾‹, å¹¶è®¾ç½®ç›¸åº”çš„å‚æ•°å†è¿”å›, è¿”å›çš„å®ä¾‹æ˜¯ä¸€ä¸ªå®Œå…¨ä¸åŒä½†æ˜¯ç±»å‹ä¸€æ ·çš„å¯¹è±¡

å¦‚æœå°† clone() æ–¹æ³•æ”¹ä¸º:

```java
public Prototype clone() {
    return this;
}
```

è¿™æ ·è¿”å›çš„å¯¹è±¡æ˜¯è‡ªèº«, æ ¹æœ¬ä¸æ˜¯ä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡.

**å®¢æˆ·ç«¯è°ƒç”¨æ–¹å¼**

```java
Prototype obj1  = new ConcretePrototype();
obj1.setAttr("Sunny");
Prototype obj2  = obj1.clone();
```

## å¼•ç”¨

-[http://blog.csdn.net/lovelion/article/details/7424559](http://blog.csdn.net/lovelion/article/details/7424559)

## [Javaç¼–ç¨‹è¿›é˜¶ï¼šå•ä¾‹æ¨¡å¼ä¸åå°„æŒ‘æˆ˜](https://blog.dong4j.site/posts/f1601c3e.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})


#### æ¯å¤©ä¸€ä¸ª Linux å‘½ä»¤

**less å‘½ä»¤**

less å‘½ä»¤ çš„ä½œç”¨ä¸ more ååˆ†ç›¸ä¼¼, éƒ½å¯ä»¥ç”¨æ¥æµè§ˆæ–‡å­—æ¡£æ¡ˆçš„å†…å®¹, ä¸åŒçš„æ˜¯ less å‘½ä»¤å…è®¸ç”¨æˆ·å‘å‰æˆ–å‘åæµè§ˆæ–‡ä»¶, è€Œ more å‘½ä»¤åªèƒ½å‘å‰æµè§ˆ. ç”¨
less å‘½ä»¤æ˜¾ç¤ºæ–‡ä»¶æ—¶, ç”¨ PageUp é”®å‘ä¸Šç¿»é¡µ, ç”¨ PageDown é”®å‘ä¸‹ç¿»é¡µ. è¦é€€å‡º less ç¨‹åº, åº”æŒ‰ Q é”®.

```
-e: æ–‡ä»¶å†…å®¹æ˜¾ç¤ºå®Œæ¯•å, è‡ªåŠ¨é€€å‡ºï¼›
-f: å¼ºåˆ¶æ˜¾ç¤ºæ–‡ä»¶ï¼›
-g: ä¸åŠ äº®æ˜¾ç¤ºæœç´¢åˆ°çš„æ‰€æœ‰å…³é”®è¯, ä»…æ˜¾ç¤ºå½“å‰æ˜¾ç¤ºçš„å…³é”®å­—, ä»¥æé«˜æ˜¾ç¤ºé€Ÿåº¦ï¼›
-l: æœç´¢æ—¶å¿½ç•¥å¤§å°å†™çš„å·®å¼‚ï¼›
-N: æ¯ä¸€è¡Œè¡Œé¦–æ˜¾ç¤ºè¡Œå·ï¼›
-s: å°†è¿ç»­å¤šä¸ªç©ºè¡Œå‹ç¼©æˆä¸€è¡Œæ˜¾ç¤ºï¼›
-S: åœ¨å•è¡Œæ˜¾ç¤ºè¾ƒé•¿çš„å†…å®¹, è€Œä¸æ¢è¡Œæ˜¾ç¤ºï¼›
-x< æ•°å­— >: å°† TAB å­—ç¬¦æ˜¾ç¤ºä¸ºæŒ‡å®šä¸ªæ•°çš„ç©ºæ ¼å­—ç¬¦.
```

## æŠ½è±¡å·¥å‚æ¨¡å¼ç»ƒä¹ 

Sunny è½¯ä»¶å…¬å¸æ¬²æ¨å‡ºä¸€æ¬¾æ–°çš„æ‰‹æœºæ¸¸æˆè½¯ä»¶, è¯¥è½¯ä»¶èƒ½å¤Ÿæ”¯æŒ Symbianã€Android å’Œ Windows Mobile ç­‰å¤šä¸ªæ™ºèƒ½æ‰‹æœºæ“ä½œç³»ç»Ÿå¹³å°, é’ˆå¯¹ä¸åŒçš„æ‰‹æœºæ“ä½œç³»ç»Ÿ,
è¯¥æ¸¸æˆè½¯ä»¶æä¾›äº†ä¸åŒçš„æ¸¸æˆæ“ä½œæ§åˆ¶ (OperationController) ç±»å’Œæ¸¸æˆç•Œé¢æ§åˆ¶ (InterfaceController) ç±», å¹¶æä¾›ç›¸åº”çš„å·¥å‚ç±»æ¥å°è£…è¿™äº›ç±»çš„åˆå§‹åŒ–è¿‡ç¨‹.
è½¯ä»¶è¦æ±‚å…·æœ‰è¾ƒå¥½çš„æ‰©å±•æ€§ä»¥æ”¯æŒæ–°çš„æ“ä½œç³»ç»Ÿå¹³å°, ä¸ºäº†æ»¡è¶³ä¸Šè¿°éœ€æ±‚, è¯•é‡‡ç”¨æŠ½è±¡å·¥å‚æ¨¡å¼å¯¹å…¶è¿›è¡Œè®¾è®¡.

### UML

![20241229154732_s52IuBOz.webp](https://cdn.dong4j.site/source/image/20241229154732_s52IuBOz.webp)

### ä»£ç 

æŠ½è±¡å·¥å‚

```java
public interface GameFactory {
    OperationController createOperationController();
    InterfaceController createInterfaceController();
}
```

å…·ä½“å·¥å‚

```java
public class SymbianGameFactory implements GameFactory{
    @Override
    public OperationController createOperationController() {
        return new SymbianOperationController();
    }

    @Override
    public InterfaceController createInterfaceController() {
        return new SymbianInterfaceController();
    }
}

public class AndroidGameFactory implements GameFactory{
    @Override
    public OperationController createOperationController() {
        return  new AndroidOperationController();
    }

    @Override
    public InterfaceController createInterfaceController() {
        return  new AndroidInterfaceController();
    }
}

public class WMGameFactory implements GameFactory{
    @Override
    public OperationController createOperationController() {
        return new WMOperationController();
    }

    @Override
    public InterfaceController createInterfaceController() {
        return new WMInterfaceController();
    }
}
```

æŠ½è±¡äº§å“

```java
public interface OperationController {
    void play();
}
public interface InterfaceController {
    void show();
}
```

å…·ä½“äº§å“

```java
public class SymbianOperationController implements OperationController {
    @Override
    public void play() {
        System.out.println("Symbian ç³»ç»Ÿæ“ä½œ");
    }
}
public class SymbianInterfaceController implements InterfaceController {
    @Override
    public void show() {
        System.out.println("Symbian æ˜¾ç¤º");
    }
}
public class AndroidOperationController implements OperationController {
    @Override
    public void play() {
        System.out.println("Android æ“ä½œ");
    }
}
public class AndroidInterfaceController implements InterfaceController {
    @Override
    public void show() {
        System.out.println("Android æ˜¾ç¤º");
    }
}
public class WMOperationController implements OperationController {
    @Override
    public void play() {
        System.out.println("WM æ“ä½œ");
    }
}
public class WMInterfaceController implements InterfaceController {
    @Override
    public void show() {
        System.out.println("WM æ˜¾ç¤º");
    }
}
```

æ·»åŠ é…ç½®

```
gameType=com.dong4j.homework.WMGameFactory
```

æµ‹è¯•ç±»

```java
 @Test
    public void gameTest() throws IllegalAccessException, InstantiationException, ClassNotFoundException {
        GameFactory gameFactory;
        OperationController operationController;
        InterfaceController interfaceController;
        gameFactory = (GameFactory) ConfigUtil.getType("gameType");
        operationController = gameFactory.createOperationController();
        interfaceController = gameFactory.createInterfaceController();
        operationController.play();
        interfaceController.show();
    }
```

# åˆ›å»ºè€…æ¨¡å¼ä¹‹ä¸‰: å•ä¾‹æ¨¡å¼

ç¡®ä¿æŸä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹, è€Œä¸”è‡ªè¡Œå®ä¾‹åŒ–å¹¶å‘æ•´ä¸ªç³»ç»Ÿæä¾›è¿™ä¸ªå®ä¾‹, è¿™ä¸ªç±»ç§°ä¸ºå•ä¾‹ç±», å®ƒæä¾›å…¨å±€è®¿é—®çš„æ–¹æ³•

## å•ä¾‹æ¨¡å¼çš„å‡ ç§å®ç°

### é¥¿æ±‰æ¨¡å¼

```java
public class EagerSingleton {
    private  static final EagerSingleton instance = new EagerSingleton();

    private EagerSingleton(){}

    public static EagerSingleton getINstance(){
        return instance;
    }
}
```

### æ‡’æ±‰æ¨¡å¼

```java
public class LazySingleton {
    private static LazySingleton instance = null;
    private LazySingleton(){}
    public static LazySingleton getInstance(){
        return new LazySingleton();
    }
}
```

#### å¤šçº¿ç¨‹ä¼˜åŒ–

```java
public class SynchronizedLazySingleton {
    private static SynchronizedLazySingleton instance = null;
    private SynchronizedLazySingleton(){}
    public static SynchronizedLazySingleton getInstance(){
        if(instance == null){
            synchronized (SynchronizedLazySingleton.class){
                instance = new SynchronizedLazySingleton();
            }
        }
        return instance;
    }
}
```

å­˜åœ¨çš„é—®é¢˜:
å½“ A, B 2 ä¸ªçº¿ç¨‹è°ƒç”¨ getInstance() æ—¶, è¿›å…¥ if åˆ¤æ–­, å¦‚æœæ­¤æ—¶ä¸º null, æ€ä¹ˆæ’é˜Ÿè¿›å…¥åˆ›å»ºå¯¹è±¡çš„åŒæ­¥å—,
å½“ A åˆ›å»ºå®Œå¹¶è¿”å›äº†ä¸€ä¸ªå•ä¾‹å¯¹è±¡æ—¶, çº¿ç¨‹ B è¿›å…¥åŒæ­¥å—, å†æ¬¡åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡.

**åŒé”æœºåˆ¶**

```java
public class DoubleSynchronizedLazySingleton {
    private volatile static DoubleSynchronizedLazySingleton instance = null;
    private DoubleSynchronizedLazySingleton(){}
    public static DoubleSynchronizedLazySingleton getInstance(){
        if(instance == null){
            synchronized (DoubleSynchronizedLazySingleton.class){
                if(instance == null){
                    instance = new DoubleSynchronizedLazySingleton();
                }
            }
        }
        return instance;
    }
}
```

instance å¿…é¡»ç”¨ volatile ä¿®é¥°, volatile åœ¨è¿™é‡Œçš„ä½œç”¨æ˜¯ç¦æ­¢é‡æ’åº

### é™æ€å†…éƒ¨ç±» å•ä¾‹

```java
public class SynchronizedLazySingleton {
    private static SynchronizedLazySingleton instance = null;
    private SynchronizedLazySingleton(){}
    public static SynchronizedLazySingleton getInstance(){
        if(instance == null){
            synchronized (SynchronizedLazySingleton.class){
                instance = new SynchronizedLazySingleton();
            }
        }
        return instance;
    }
}
```

ä½¿ç”¨ classload æœºåˆ¶æ¥ä¿è¯åˆå§‹åŒ– instance æ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹, åªæœ‰åœ¨æ˜¾ç¤ºè°ƒç”¨ getInstance() æ—¶æ‰ä¼šåˆ›å»ºå•ä¾‹å¯¹è±¡

### æšä¸¾ å•ä¾‹

```java
public enum EnumSingleton {
    INSTANCE;
}
```

ä½¿ç”¨ EnumSingleton.INSTANCE æ¥è®¿é—®

### é˜²æ­¢å•ä¾‹æ¨¡å¼è¢« åå°„, ååºåˆ—åŒ–, å…‹éš†ç ´å

#### åå°„ç ´åå•ä¾‹æ¨¡å¼

**é˜²æ­¢åå°„å®ä¾‹åŒ–å¯¹è±¡**

åˆ©ç”¨åå°„ç”Ÿæˆå¯¹è±¡

```java
// ä½¿ç”¨åå°„ç ´åå•ä¾‹æ¨¡å¼
Class c = Class.forName(Singleton.class.getName());
Constructor constructor = c.getDeclaredConstructor();
// èƒ½è®¿é—®ç§æœ‰æ„é€ æ–¹æ³•
constructor.setAccessible(true);
// åˆ©ç”¨ç§æœ‰æ„é€ æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°çš„å•ä¾‹å¯¹è±¡, ç ´åå•ä¾‹æ¨¡å¼
Singleton singleton = (Singleton)ct.newInstance();
```

**è§£å†³æ–¹æ³•**

åœ¨ç§æœ‰æ„é€ ä¸­æŠ›å‡ºå¼‚å¸¸

```java
public class LazySingleton {
    private static LazySingleton instance = null;
    private LazySingleton() throws Exception {
        throw new Exception();
    }
    public static LazySingleton getInstance() throws Exception {
        return new LazySingleton();
    }
}
```

#### ååºåˆ—åŒ–ç ´åå•ä¾‹æ¨¡å¼

```java
import java.io.Serializable;
/**
 * ä½¿ç”¨åŒé‡æ ¡éªŒé”æ–¹å¼å®ç°å•ä¾‹
 */
public class Singleton implements Serializable{
    private volatile static Singleton singleton;
    private Singleton (){}
    public static Singleton getSingleton() {
        if (singleton == null) {
            synchronized (Singleton.class) {
                if (singleton == null) {
                    singleton = new Singleton();
                }
            }
        }
        return singleton;
    }
}
```

```java
public class SerializableDemo1 {
    // ä¸ºäº†ä¾¿äºç†è§£, å¿½ç•¥å…³é—­æµæ“ä½œåŠåˆ é™¤æ–‡ä»¶æ“ä½œ. çœŸæ­£ç¼–ç æ—¶åƒä¸‡ä¸è¦å¿˜è®°
    // Exception ç›´æ¥æŠ›å‡º
    public static void main(String[] args) throws IOException, ClassNotFoundException {
        // Write Obj to file
        ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream("tempFile"));
        oos.writeObject(Singleton.getSingleton());
        // Read Obj from file
        File file = new File("tempFile");
        ObjectInputStream ois =  new ObjectInputStream(new FileInputStream(file));
        Singleton newInstance = (Singleton) ois.readObject();
        // åˆ¤æ–­æ˜¯å¦æ˜¯åŒä¸€ä¸ªå¯¹è±¡
        System.out.println(newInstance == Singleton.getSingleton());
    }
}
```

**é˜²æ­¢åºåˆ—åŒ–ååºåˆ—åŒ–ç ´åå•ä¾‹çš„æ–¹æ³•:**

æ·»åŠ  **readResolve** æ–¹æ³•

```java
private Object readResolve() {
        return singleton;
    }
```

#### å…‹éš†ç ´åå•ä¾‹æ¨¡å¼

ç”±å…‹éš†æˆ‘ä»¬å¯ä»¥æƒ³åˆ°åŸå‹æ¨¡å¼, åŸå‹æ¨¡å¼å°±æ˜¯é€šè¿‡ clone æ–¹æ³•å®ç°å¯¹è±¡çš„åˆ›å»ºçš„, clone æ–¹å¼æ˜¯ Object æ–¹æ³•, æ¯ä¸ªå¯¹è±¡éƒ½æœ‰, é‚£æˆ‘ä½¿ç”¨ä¸€ä¸ªå•ä¾‹æ¨¡å¼ç±»çš„å¯¹è±¡,
è°ƒç”¨ clone æ–¹æ³•, å†åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡äº†, é‚£å²‚ä¸æ˜¯ä¸Šé¢è¯´çš„å•ä¾‹æ¨¡å¼å¤±æ•ˆäº†. å½“ç„¶ç­”æ¡ˆæ˜¯å¦å®š, æŸä¸€ä¸ªå¯¹è±¡ç›´æ¥è°ƒç”¨ clone æ–¹æ³•, ä¼šæŠ›å‡ºå¼‚å¸¸,
å³å¹¶ä¸èƒ½æˆåŠŸå…‹éš†ä¸€ä¸ªå¯¹è±¡. è°ƒç”¨è¯¥æ–¹æ³•æ—¶, å¿…é¡»å®ç°ä¸€ä¸ª Cloneable æ¥å£. è¿™ä¹Ÿå°±æ˜¯åŸå‹æ¨¡å¼çš„å®ç°æ–¹å¼. è¿˜æœ‰å³å¦‚æœè¯¥ç±»å®ç°äº† cloneable æ¥å£,
å°½ç®¡æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„, ä»–ä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ªå¯¹è±¡. å³ clone æ–¹æ³•æ˜¯ä¸ä¼šè°ƒç”¨æ„é€ å‡½æ•°çš„, ä»–æ˜¯ç›´æ¥ä»å†…å­˜ä¸­ copy å†…å­˜åŒºåŸŸçš„. **æ‰€ä»¥å•ä¾‹æ¨¡å¼çš„ç±»æ˜¯ä¸å¯ä»¥å®ç°
cloneable æ¥å£çš„**.

#### åˆ©ç”¨æšä¸¾é˜²æ­¢ç ´å

```java
/**
* Singleton pattern example using Java Enumj
*/
public enum EasySingleton{
    INSTANCE;
}
```

**ä½¿ç”¨åå°„ç ´è§£æšä¸¾å•ä¾‹:**
è¿è¡Œç»“æœæ˜¯æŠ›å‡ºå¼‚å¸¸:Exception in thread "main" java.lang.NoSuchMethodException: cn.xing.test.Weekday.<init>()
æ˜æ˜ Weekday æœ‰ä¸€ä¸ªæ— å‚çš„æ„é€ å‡½æ•°, ä¸ºä½•ä¸èƒ½é€šè¿‡æš´åŠ›åå°„è®¿é—®?
æœ€æ–°çš„ Java Language Specification (Â§8.9) è§„å®š: Reflective instantiation of enum types is prohibited. è¿™æ˜¯ java è¯­è¨€çš„å†…ç½®è§„èŒƒ.

**ä½¿ç”¨ clone ç ´è§£æšä¸¾å•ä¾‹**
æ‰€æœ‰çš„æšä¸¾ç±»éƒ½ç»§æ‰¿è‡ª java.lang.Enum ç±», è€Œä¸æ˜¯ Object ç±». åœ¨ java.lang.Enum ç±»ä¸­ clone æ–¹æ³•å¦‚ä¸‹:

```java
protected final Object clone() throws CloneNotSupportedException {
    throw new CloneNotSupportedException();
}
```

è°ƒç”¨è¯¥æ–¹æ³•å°†æŠ›å‡ºå¼‚å¸¸, ä¸” final æ„å‘³ç€å­ç±»ä¸èƒ½é‡å†™ clone æ–¹æ³•, æ‰€ä»¥é€šè¿‡ clone æ–¹æ³•è·å–æ–°çš„å¯¹è±¡æ˜¯ä¸å¯å–çš„.

**ä½¿ç”¨åºåˆ—åŒ–ç ´è§£æšä¸¾å•ä¾‹**
java.lang.Enum ç±»çš„ readObject æ–¹æ³•å¦‚ä¸‹:

```java
private void readObject(ObjectInputStream in) throws IOException,
        ClassNotFoundException {
            throw new InvalidObjectException("can't deserialize enum");
}
private void readObjectNoData() throws ObjectStreamException {
        throw new InvalidObjectException("can't deserialize enum");
}
```

åŒæš´åŠ›åå°„ä¸€æ ·, Java Language Specification (Â§8.9) æœ‰ç€è¿™æ ·çš„è§„å®š: the special treatment by the serialization mechanism ensures that
duplicate instances are never created as a result of deserialization.

## å¼•ç”¨

- [http://blog.csdn.net/lovelion/article/details/7420883](http://blog.csdn.net/lovelion/article/details/7420883)
- [http://blog.csdn.net/chao_19/article/details/51112962](http://blog.csdn.net/chao_19/article/details/51112962)

## [æŠ½è±¡å·¥å‚æ¨¡å¼ï¼šæ„å»ºçµæ´»çš„è½¯ä»¶ç³»ç»Ÿ](https://blog.dong4j.site/posts/9b7d6e62.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

#### æ¯å¤©ä¸€ä¸ª Linux å‘½ä»¤

**more å‘½ä»¤**

more å‘½ä»¤æ˜¯ä¸€ä¸ªåŸºäº vi ç¼–è¾‘å™¨æ–‡æœ¬è¿‡æ»¤å™¨, å®ƒä»¥å…¨å±å¹•çš„æ–¹å¼æŒ‰é¡µæ˜¾ç¤ºæ–‡æœ¬æ–‡ä»¶çš„å†…å®¹, æ”¯æŒ vi ä¸­çš„å…³é”®å­—å®šä½æ“ä½œ.

```
æŒ‰ ç©ºæ ¼ é”®: æ˜¾ç¤ºæ–‡æœ¬çš„ä¸‹ä¸€å±å†…å®¹.
æŒ‰ å›è½¦ é”®: åªæ˜¾ç¤ºæ–‡æœ¬çš„ä¸‹ä¸€è¡Œå†…å®¹.
/: æ¥ç€è¾“å…¥ä¸€ä¸ªæ¨¡å¼, å¯ä»¥åœ¨æ–‡æœ¬ä¸­å¯»æ‰¾ä¸‹ä¸€ä¸ªç›¸åŒ¹é…çš„æ¨¡å¼.
æŒ‰ h é”®: æ˜¾ç¤ºå¸®åŠ©å±, è¯¥å±ä¸Šæœ‰ç›¸å…³çš„å¸®åŠ©ä¿¡æ¯.
æŒ‰ b é”®: æ˜¾ç¤ºä¸Šä¸€å±å†…å®¹.
æŒ‰ q é”®: é€€å‡º rnore å‘½ä»¤
```

```
-< æ•°å­— >: æŒ‡å®šæ¯å±æ˜¾ç¤ºçš„è¡Œæ•°ï¼›

-d: æ˜¾ç¤ºâ€œ[press space to continue,'q' to quit.]â€å’Œâ€œ[Press 'h' for instructions]â€ï¼›
-c: ä¸è¿›è¡Œæ»šå±æ“ä½œ. æ¯æ¬¡åˆ·æ–°è¿™ä¸ªå±å¹•ï¼›
-s: å°†å¤šä¸ªç©ºè¡Œå‹ç¼©æˆä¸€è¡Œæ˜¾ç¤ºï¼›
-u: ç¦æ­¢ä¸‹åˆ’çº¿ï¼›
+< æ•°å­— >: ä»æŒ‡å®šæ•°å­—çš„è¡Œå¼€å§‹æ˜¾ç¤º.
```

```
# æ˜¾ç¤ºæ–‡ä»¶ file çš„å†…å®¹, ä½†åœ¨æ˜¾ç¤ºä¹‹å‰å…ˆæ¸…å±, å¹¶ä¸”åœ¨å±å¹•çš„æœ€ä¸‹æ–¹æ˜¾ç¤ºå®Œæ ¸çš„ç™¾åˆ†æ¯”.
more -dc file
# æ˜¾ç¤ºæ–‡ä»¶ file çš„å†…å®¹, æ¯ 10 è¡Œæ˜¾ç¤ºä¸€æ¬¡, è€Œä¸”åœ¨æ˜¾ç¤ºä¹‹å‰å…ˆæ¸…å±.
more -c -10 file
```

## å·¥å‚æ–¹æ³•å›é¡¾

å·¥å‚æ–¹å¼é€šè¿‡å¼•å…¥å·¥å‚ç­‰çº§ç»“æ„, è§£å†³äº†ç®€å•å·¥å‚æ¨¡å¼ä¸­å·¥å‚ç±»è´£ä»»å¤ªé‡çš„é—®é¢˜, å½“ç”±äºå·¥å‚æ–¹æ³•æ¨¡å¼ä¸­çš„æ¯ä¸€ä¸ªå·¥å‚åªç”Ÿäº§ä¸€ç±»äº§å“, å¯èƒ½å¯¼è‡´ç³»ç»Ÿä¸­å­˜åœ¨å¤§é‡çš„å·¥å‚ç±»,
å¢åŠ äº†ç³»ç»Ÿçš„å¼€é”€.

**ä¼˜ç‚¹:**

1. å¢åŠ å…·ä½“äº§å“æ—¶ä¸éœ€è¦ä¿®æ”¹åŸæ¥çš„ä»£ç , åªéœ€è¦å¢åŠ ä¸€ä¸ªå…·ä½“å·¥å‚ç±»å’Œä¸€ä¸ªå…·ä½“äº§å“ç±»å³å¯, æ˜¯ç³»ç»Ÿæ˜“äºæ‰©å±•.

**ç¼ºç‚¹:**

1. ç”±äºå†…ä¸ªå…·ä½“å·¥å‚åªèƒ½ç”Ÿäº§å‡ºä¸€ä¸ªå…·ä½“äº§å“, å¢åŠ äº†ç±»çš„ä¸ªæ•°, å¢åŠ äº†ç³»ç»Ÿå¼€é”€.

**ç»ƒä¹ **

ä½¿ç”¨å·¥å‚æ–¹æ³•æ¨¡å¼è®¾è®¡ä¸€ä¸ªç¨‹åºæ¥è¯»å–å„ç§ä¸åŒç±»å‹çš„å›¾ç‰‡æ ¼å¼, é’ˆå¯¹æ¯ä¸€ç§å›¾ç‰‡æ ¼å¼éƒ½è®¾è®¡ä¸€ä¸ªå›¾ç‰‡è¯»å–å™¨, å¦‚ GIF å›¾ç‰‡è¯»å–å™¨ç”¨äºè¯»å– GIF æ ¼å¼çš„å›¾ç‰‡ã€JPG
å›¾ç‰‡è¯»å–å™¨ç”¨äºè¯»å– JPG æ ¼å¼çš„å›¾ç‰‡. éœ€å……åˆ†è€ƒè™‘ç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§.

![20241229154732_SWFLolwS.webp](https://cdn.dong4j.site/source/image/20241229154732_SWFLolwS.webp)

ä»£ç :

æŠ½è±¡å·¥å‚æ¥å£

```java
public interface PictureFactory {
    public Picture getPicture();
}
```

å…·ä½“å·¥å‚ç±»

```java
class GifPictureFactory implements PictureFactory{
    @Override
    public Picture getPicture() {
        return new GifPicture();
    }
}
class JpgPictureFactory implements PictureFactory {
    @Override
    public Picture getPicture() {
        return new JpgPicture();
    }
}
```

æŠ½è±¡äº§å“

```java
public interface Picture {
    void readInfo();
}
```

å…·ä½“äº§å“ç±»

```java
class GifPicture implements Picture{
    @Override
    public void readInfo(){
        System.out.println("è¯»å– gif å›¾ç‰‡ä¿¡æ¯");
    }
}

class JpgPicture implements Picture{
    @Override
    public void readInfo(){
        System.out.println("è¯»å– jpg å›¾ç‰‡ä¿¡æ¯");
    }
}
```

æµ‹è¯•ç±»

```java
@Test
    public void homeworkTest() throws IllegalAccessException, InstantiationException, ClassNotFoundException {
        PictureFactory pictureFactory = (PictureFactory) ConfigUtil.getType("pictureType");
        pictureFactory.getPicture().readInfo();
    }
```

# åˆ›å»ºè€…æ¨¡å¼ä¹‹ä¸‰: æŠ½è±¡å·¥å‚æ¨¡å¼

## æ¡ˆä¾‹

å¼€å‘ä¸€å¥—ç•Œé¢çš®è‚¤åº“, å¯ä»¥å¯¹ Java æ¡Œé¢è½¯ä»¶è¿›è¡Œç•Œé¢ç¾åŒ–. ä¸ºäº†ä¿æŠ¤ç‰ˆæƒ, è¯¥çš®è‚¤åº“æºä»£ç ä¸æ‰“ç®—å…¬å¼€, è€Œåªå‘ç”¨æˆ·æä¾›å·²æ‰“åŒ…ä¸º jar æ–‡ä»¶çš„ class å­—èŠ‚ç æ–‡ä»¶.
ç”¨æˆ·åœ¨ä½¿ç”¨æ—¶å¯ä»¥é€šè¿‡èœå•æ¥é€‰æ‹©çš®è‚¤, ä¸åŒçš„çš®è‚¤å°†æä¾›è§†è§‰æ•ˆæœä¸åŒçš„æŒ‰é’®ã€æ–‡æœ¬æ¡†ã€ç»„åˆæ¡†ç­‰ç•Œé¢å…ƒç´ 

![20241229154732_wBzkJ0LQ.webp](https://cdn.dong4j.site/source/image/20241229154732_wBzkJ0LQ.webp)

ä½¿ç”¨å·¥å‚æ–¹æ³•æ¨¡å¼ UML ç»“æ„

![20241229154732_kZpVcxk4.webp](https://cdn.dong4j.site/source/image/20241229154732_kZpVcxk4.webp)

ä½¿ç”¨å·¥å‚æ–¹æ³•æ¨¡æ¿å­˜åœ¨çš„é—®é¢˜:

1. å¦‚æœéœ€è¦æ·»åŠ å…·ä½“ç»„ä»¶æ—¶, éƒ½éœ€è¦æ·»åŠ ä¸€ä¸ªå…·ä½“å·¥å‚, ç±»çš„ä¸ªæ•°å¢å¤§.
2. ç”±äºç»Ÿä¸€é£æ ¼çš„å…·ä½“ç•Œé¢ç»„ä»¶éœ€è¦ä¸€èµ·æ˜¾ç¤º, å¦‚æœæŸä¸ªå…·ä½“å·¥å‚é€‰æ‹©å‡ºé”™å°†å¯¼è‡´ç•Œé¢æ··ä¹±.
3. å®¢æˆ·ç«¯å’Œé…ç½®æ–‡ä»¶å¤æ‚.

å¦‚ä½•å‡å°‘ç±»çš„ä¸ªæ•°å’Œä¿è¯æ¯æ¬¡åˆå§‹åŒ–æ—¶åªæ˜¯ç”¨ä¸€ç§é£æ ¼çš„å…·ä½“ç•Œé¢çš„ç»„ä»¶?
æ˜¯ç”¨æŠ½è±¡å·¥å‚æ¨¡å¼è§£å†³.

## æŠ½è±¡å·¥å‚æ¨¡å¼

æŠ½è±¡å·¥å‚æä¸ªä¸€ä¸ªåˆ›å»ºä¸€ç³»åˆ—ç›¸å…³æˆ–ç›¸äº’ä¾èµ–å¯¹è±¡çš„æ¥å£, è€Œæ— éœ€æŒ‡å®šä»–ä»¬å…·ä½“çš„ç±».

![20241229154732_ryqmwULr.webp](https://cdn.dong4j.site/source/image/20241229154732_ryqmwULr.webp)

- AbstractFactory æŠ½è±¡å·¥å‚ : å£°æ˜äº†ä¸€ç»„ç”¨äºåˆ›å»ºåŒä¸€ç±»äº§å“çš„æ–¹æ³•, æ¯ä¸ªæ–¹æ³•å¯¹åº”ä¸€ç§äº§å“.
- ConcreteFactory å…·ä½“å·¥å‚ : å®ç°äº†æŠ½è±¡å·¥å‚ä¸­å£°æ˜çš„åˆ›å»ºäº§å“çš„æ–¹æ³•,, ç”Ÿäº§ä¸€ç»„å…·ä½“çš„äº§å“.
- AbstractProduct æŠ½è±¡äº§å“ : æ¯ç§äº§å“çš„æ¥å£
- ConcreteProduct å…·ä½“äº§å“ : å…·ä½“å·¥å‚ç”Ÿäº§çš„å…·ä½“äº§å“, å®ç°äº†æŠ½è±¡äº§å“ä¸­çš„å£°æ˜çš„ä¸šåŠ¡æ–¹æ³•.

### ä½¿ç”¨æŠ½è±¡æ–¹æ³•æ¨¡å¼å®ç°æ¡ˆä¾‹

![20241229154732_dnsOOLUh.webp](https://cdn.dong4j.site/source/image/20241229154732_dnsOOLUh.webp)

ä»£ç 

çš®è‚¤æŠ½è±¡å·¥å‚æ¥å£

```java
public interface SkinFactory {
    Button createButton();
    TextField createTextField();
    Combobox createCombobox();
}
```

Spring é£æ ¼çš®è‚¤å·¥å‚å®ç°

```java
public class SpringSkinFactory implements SkinFactory{
    @Override
    public Button createButton() {
        return new SpringButton();
    }

    @Override
    public TextField createTextField() {
        return new SpringTextField();
    }

    @Override
    public Combobox createCombobox() {
        return new SpringCombobox();
    }
}
```

Summer é£æ ¼çš®è‚¤å·¥å‚å®ç°

```java
public class SummerSkinFactory implements SkinFactory{
    @Override
    public Button createButton() {
        return new SummerButton();
    }

    @Override
    public TextField createTextField() {
        return new SummerTextField();
    }

    @Override
    public Combobox createCombobox() {
        return new SummerCombobox();
    }
}
```

åˆ ä¸ªæ§ä»¶æ¥å£

```java
public interface Button {
    void display();
}

public interface Combobox {
    void display();
}

public interface TextField {
    void display();
}
```

Spring é£æ ¼ç³»åˆ—æ§ä»¶å®ç°

```java
public class SpringButton implements Button{
    @Override
    public void display() {
        System.out.println("spring é£æ ¼æŒ‰é’®");
    }
}

public class SpringCombobox implements Combobox{
    @Override
    public void display() {
        System.out.println("spring é£æ ¼ä¸‹æ‹‰åˆ—è¡¨æ¡†");
    }
}

public class SpringTextField implements TextField{
    @Override
    public void display() {
        System.out.println("spring é£æ ¼æ–‡æœ¬è¾“å…¥æ¡†");
    }
}
```

Summer é£æ ¼ç³»åˆ—æ§ä»¶å®ç°

```java
public class SummerButton implements Button{
    @Override
    public void display() {
        System.out.println("summer é£æ ¼æŒ‰é’®");
    }
}

public class SummerCombobox implements Combobox{
    @Override
    public void display() {
        System.out.println("summer é£æ ¼ä¸‹æ‹‰åˆ—è¡¨æ¡†");
    }
}

public class SummerTextField implements TextField{
    @Override
    public void display() {
        System.out.println("summer é£æ ¼æ–‡æœ¬è¾“å…¥æ¡†");
    }
}
```

é…ç½®æ–‡ä»¶

```
skinType=com.dong4j.factory.SpringSkinFactory
```

æµ‹è¯•ä»£ç 

```java
public class AbstractFactoryTest {
    @Test
    public void abstractFactoryTest() throws IllegalAccessException, InstantiationException, ClassNotFoundException {
        // ä½¿ç”¨æŠ½è±¡å±‚å®šä¹‰
        SkinFactory factory;
        Button      bt;
        TextField   tf;
        Combobox    cb;
        factory = (SkinFactory) ConfigUtil.getType("skinType");
        bt = factory.createButton();
        tf = factory.createTextField();
        cb = factory.createCombobox();
        bt.display();
        tf.display();
        cb.display();
    }
}
```

1. å¦‚æœéœ€è¦å¢åŠ æ–°çš„çš®è‚¤, åªéœ€è¦æ·»åŠ ä¸€ä¸ªçš®è‚¤å·¥å‚, ç„¶åæ·»åŠ ç»„ä»¶çš„å®ç°å³å¯, ä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯ä½¿ç”¨æ–°çš„çš®è‚¤, åŸæœ‰ä»£ç æ— é¡»ä¿®æ”¹, ç¬¦åˆ â€œå¼€é—­åŸåˆ™â€.
2. å¦‚æœéœ€è¦å¢åŠ æ–°çš„æ§ä»¶, éœ€è¦ä¿®æ”¹æŠ½è±¡å·¥å‚, æ·»åŠ ä¸€ä¸ªç»„ä»¶æŠ½è±¡æ¥å£, ç„¶åæ·»åŠ ä¸¤ç§é£æ ¼çš„å®ç°, è¿˜è¦ä¿®æ”¹çš®è‚¤å…·ä½“å·¥å‚.

## æ€»ç»“

**ä¼˜ç‚¹:**

1. æŠ½è±¡å·¥å‚æ¨¡å¼éš”ç¦»äº†å…·ä½“ç±»çš„ç”Ÿæˆ, ä½¿å¾—å®¢æˆ·ä¸éœ€è¦çŸ¥é“ä»€ä¹ˆè¢«åˆ›å»º. ç”±äºéš”ç¦»æ€§, æ˜¯çš„æ›´æ¢ä¸€ä¸ªå…·ä½“å·¥å‚å˜å¾—å®¹æ˜“, æ‰€ä»¥çš„å…·ä½“å·¥å‚éƒ½å®ç°äº†æŠ½è±¡å·¥å‚çš„å®šä¹‰çš„æ–¹æ³•,
   å› æ­¤åªéœ€è¦æ”¹å˜å…·ä½“å·¥å‚çš„å®ä¾‹, å°±å¯ä»¥æŸç§ç¨‹åº¦ä¸Šæ”¹å˜æ•´ä¸ªè½¯ä»¶ç³»ç»Ÿçš„è¡Œä¸º.
2. å½“ä¸€ä¸ªäº§å“æ—ä¸­çš„å¤šä¸ªå¯¹è±¡è¢«è®¾è®¡æˆä¸€èµ·å·¥ä½œæ—¶, å®ƒèƒ½ä¿è¯å®¢æˆ·ç«¯å§‹ç»ˆåªä½¿ç”¨åŒä¸€ä¸ªäº§å“æ—ä¸­çš„å¯¹è±¡.
3. å¢åŠ æ–°çš„äº§å“æ—å¾ˆæ–¹ä¾¿, ç¬¦åˆå¼€é—­åŸåˆ™.

**ç¼ºç‚¹:**

1. å¢åŠ æ–°çš„äº§å“ç™»è®°ç»“æ„éœ€è¦ä¿®æ”¹ä¼—å¤šä»£ç , è¿èƒŒå¼€é—­åŸåˆ™.

**é€‚ç”¨åœºæ™¯**

1. ä¸€ä¸ªç³»ç»Ÿä¸åº”å½“ä¾èµ–äºäº§å“ç±»å®ä¾‹å¦‚ä½•è¢«åˆ›å»ºã€ç»„åˆå’Œè¡¨è¾¾çš„ç»†èŠ‚, è¿™å¯¹äºæ‰€æœ‰ç±»å‹çš„å·¥å‚æ¨¡å¼éƒ½æ˜¯å¾ˆé‡è¦çš„, ç”¨æˆ·æ— é¡»å…³å¿ƒå¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹, å°†å¯¹è±¡çš„åˆ›å»ºå’Œä½¿ç”¨è§£è€¦.
2. ç³»ç»Ÿä¸­æœ‰å¤šäºä¸€ä¸ªçš„äº§å“æ—, è€Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­æŸä¸€äº§å“æ—. å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ç­‰æ–¹å¼æ¥ä½¿å¾—ç”¨æˆ·å¯ä»¥åŠ¨æ€æ”¹å˜äº§å“æ—, ä¹Ÿå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¢åŠ æ–°çš„äº§å“æ—.
3. å±äºåŒä¸€ä¸ªäº§å“æ—çš„äº§å“å°†åœ¨ä¸€èµ·ä½¿ç”¨, è¿™ä¸€çº¦æŸå¿…é¡»åœ¨ç³»ç»Ÿçš„è®¾è®¡ä¸­ä½“ç°å‡ºæ¥. åŒä¸€ä¸ªäº§å“æ—ä¸­çš„äº§å“å¯ä»¥æ˜¯æ²¡æœ‰ä»»ä½•å…³ç³»çš„å¯¹è±¡, ä½†æ˜¯å®ƒä»¬éƒ½å…·æœ‰ä¸€äº›å…±åŒçš„çº¦æŸ,
   å¦‚åŒä¸€æ“ä½œç³»ç»Ÿä¸‹çš„æŒ‰é’®å’Œæ–‡æœ¬æ¡†, æŒ‰é’®ä¸æ–‡æœ¬æ¡†ä¹‹é—´æ²¡æœ‰ç›´æ¥å…³ç³», ä½†å®ƒä»¬éƒ½æ˜¯å±äºæŸä¸€æ“ä½œç³»ç»Ÿçš„, æ­¤æ—¶å…·æœ‰ä¸€ä¸ªå…±åŒçš„çº¦æŸæ¡ä»¶: æ“ä½œç³»ç»Ÿçš„ç±»å‹.
4. äº§å“ç­‰çº§ç»“æ„ç¨³å®š, è®¾è®¡å®Œæˆä¹‹å, ä¸ä¼šå‘ç³»ç»Ÿä¸­å¢åŠ æ–°çš„äº§å“ç­‰çº§ç»“æ„æˆ–è€…åˆ é™¤å·²æœ‰çš„äº§å“ç­‰çº§ç»“æ„.

## å¼•ç”¨

- [http://blog.csdn.net/lovelion/article/details/9319181](http://blog.csdn.net/lovelion/article/details/9319181)
- [http://blog.csdn.net/lovelion/article/details/9319323](http://blog.csdn.net/lovelion/article/details/9319323)
- [http://blog.csdn.net/lovelion/article/details/9319423](http://blog.csdn.net/lovelion/article/details/9319423)
- [http://blog.csdn.net/lovelion/article/details/9319481](http://blog.csdn.net/lovelion/article/details/9319481)
- [http://blog.csdn.net/lovelion/article/details/9319571](http://blog.csdn.net/lovelion/article/details/9319571)

## [å¼€é—­åŸåˆ™çš„å®è·µï¼šå·¥å‚æ–¹æ³•æ¨¡å¼çš„æ¡ˆä¾‹è§£æ](https://blog.dong4j.site/posts/8ec7c960.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})


#### æ¯å¤©ä¸€ä¸ª Linux å‘½ä»¤

**cat**

cat å‘½ä»¤è¿æ¥æ–‡ä»¶å¹¶æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºè®¾å¤‡ä¸Š, cat ç»å¸¸ç”¨æ¥æ˜¾ç¤ºæ–‡ä»¶çš„å†…å®¹, ç±»ä¼¼äºä¸‹çš„ type å‘½ä»¤.

```
-n æˆ– -number: æœ‰ 1 å¼€å§‹å¯¹æ‰€æœ‰è¾“å‡ºçš„è¡Œæ•°ç¼–å·ï¼›
-b æˆ– --number-nonblank: å’Œ -n ç›¸ä¼¼, åªä¸è¿‡å¯¹äºç©ºç™½è¡Œä¸ç¼–å·ï¼›
-s æˆ– --squeeze-blank: å½“é‡åˆ°æœ‰è¿ç»­ä¸¤è¡Œä»¥ä¸Šçš„ç©ºç™½è¡Œ, å°±ä»£æ¢ä¸ºä¸€è¡Œçš„ç©ºç™½è¡Œï¼›
-A: æ˜¾ç¤ºä¸å¯æ‰“å°å­—ç¬¦, è¡Œå°¾æ˜¾ç¤ºâ€œ$â€ï¼›
-e: ç­‰ä»·äº"-vE"é€‰é¡¹ï¼›
-t: ç­‰ä»·äº"-vT"é€‰é¡¹ï¼›
```

```
cat file1  # æ˜¾ç¤º æ–‡ä»¶ file1 ä¸­çš„å†…å®¹
cat file1 file2 # åŒæ—¶æ˜¾ç¤º file1 å’Œ file2 çš„å†…å®¹
cat file1 file2 > file # å°†æ–‡ä»¶ file1 å’Œ file2 åˆå¹¶å’Œæ”¾å…¥ file ä¸­
```

# å›é¡¾ ç®€å•å·¥å‚æ¨¡å¼

ä¼˜ç‚¹:

1. å°†åˆ›å»ºå’Œä½¿ç”¨åˆ†ç¦», éµå¾ªå•ä¸€åŸåˆ™
2. å¼•å…¥é…ç½®æ–‡ä»¶, éµå¾ªå¼€é—­åŸåˆ™
3. ä½¿ç”¨åˆ«åä»£æ›¿å¤æ‚çš„ç±»å, ç®€åŒ–ä»£ç 

ç¼ºç‚¹:

1. å¦‚æœè¦æ·»åŠ æ–°çš„äº§å“ç±»æ—¶, å¿…é¡»ä¿®æ”¹å·¥å‚ç±»é€»è¾‘, ä¸æ–¹ä¾¿æ‰©å±•
2. å¼•å…¥è¿‡å¤šçš„ç±», é€ æˆç»“æ„å¤æ‚, éš¾äºç†è§£

å…³é”®ä»£ç :

```java
public static äº§å“ç±»çˆ¶ç±» create(String type){
        switch (type) {
                case "å…·ä½“äº§å“ç±»1æ ‡è¯†" :
                        return new å…·ä½“äº§å“ç±» 1();
                case "å…·ä½“äº§å“ç±»2æ ‡è¯†" :
                        return new å…·ä½“äº§å“ç±» 2();
                .....
        }
}
```

ä¾‹å­:

ä½¿ç”¨ç®€å•å·¥å‚æ¨¡å¼è®¾è®¡ä¸€ä¸ªå¯ä»¥åˆ›å»ºä¸åŒå‡ ä½•å½¢çŠ¶ï¼ˆå¦‚åœ†å½¢ã€æ–¹å½¢å’Œä¸‰è§’å½¢ç­‰ï¼‰çš„ç»˜å›¾å·¥å…·, æ¯ä¸ªå‡ ä½•å›¾å½¢éƒ½å…·æœ‰ç»˜åˆ¶ draw()å’Œæ“¦é™¤ erase() ä¸¤ä¸ªæ–¹æ³•,
è¦æ±‚åœ¨ç»˜åˆ¶ä¸æ”¯æŒçš„å‡ ä½•å›¾å½¢æ—¶, æç¤ºä¸€ä¸ª UnSupportedShapeException.

![20241229154732_OjjqHtJZ.webp](https://cdn.dong4j.site/source/image/20241229154732_OjjqHtJZ.webp)

ä½¿ç”¨ç®€åŒ–çš„ç®€å•å·¥å‚æ¨¡å¼, å³å°†é™æ€å·¥å‚æ”¾å…¥åˆ°çˆ¶ç±»ä¸­.

ä»£ç :

å›¾å½¢çˆ¶ç±»

```java
public class Graphics {
     public void draw(){
         System.out.println("ç”»å›¾æ–¹æ³•");
     }
     public void erase(){
         System.out.println("æ“¦é™¤æ–¹æ³•");
     }

     public static Graphics createGraphics(String type) throws UnSupportedShapeException {
         switch (type){
             case "rot" :
                 return new Rotundity();
             case "squ" :
                 return new Squareness();
             case "tri" :
                 return new Trigon();
             default :
                 throw new UnSupportedShapeException();
         }
     }
}
```

å…·ä½“å›¾å½¢ç±»

```java
class Rotundity extends Graphics {
    @Override
    public void draw(){
        System.out.println("ç”»åœ†");
    }

    @Override
    public void erase(){
        System.out.println("æ“¦é™¤åœ†å½¢");
    }
}

class Squareness extends Graphics {
    @Override
    public void draw(){
        System.out.println("ç”»æ–¹å½¢");
    }

    @Override
    public void erase(){
        System.out.println("æ“¦é™¤æ–¹å½¢");
    }
}

class Trigon extends Graphics {
    @Override
    public void draw(){
        System.out.println("ç”»ä¸‰è§’å½¢");
    }

    @Override
    public void erase(){
        System.out.println("æ“¦é™¤ä¸‰è§’å½¢");
    }
}
```

å¼‚å¸¸ç±»

```java
public class UnSupportedShapeException extends Exception{
    public UnSupportedShapeException(){
        super("ä¸æ”¯æŒçš„å›¾å½¢");
    }
}
```

config é…ç½®

```
type=tri
```

æµ‹è¯•ç±»

```java
@Test
    public void graphicsTest() throws UnSupportedShapeException {
        String type = ConfigUtil.getType("type");
        Graphics graphics = Graphics.createGraphics(type);
        graphics.draw();
        graphics.erase();
    }
```

ç”Ÿæ´»ä¸­çš„ä¾‹å­:

é“¶è¡ŒåŠç†ä¸šåŠ¡, æ¯”å¦‚å¼€æˆ·, æŒ‚å¤±, è¡¥åŠç­‰
æˆ‘åªè¦ç»™å¤§å ‚ç»ç†è¯´æˆ‘éœ€è¦åŠç†çš„ä¸šåŠ¡ (å…·ä½“äº§å“), ç„¶åå¡«å†™ç›¸åº”çš„ä¿¡æ¯ (åˆå§‹åŒ–å…·ä½“äº§å“çš„ä¿¡æ¯),
ç„¶åå°±å¯ä»¥å¼€å§‹åŠç† (ä½¿ç”¨å…·ä½“äº§å“).
å¦‚æœé“¶è¡Œä¸æ”¯æŒæˆ‘åŠç†çš„ä¸šåŠ¡, æ¯”å¦‚è¯´æˆ‘è¦åŠå°å­¦å…¥å­¦ä»£ç¼´è´¹, å°±åªæœ‰ç­‰å¾…é“¶è¡Œå‘ä¸Šçº§åæ˜ , åšå¥½ç›¸å…³å·¥ä½œåæ”¯æŒè¿™é¡¹ä¸šåŠ¡åæ‰èƒ½ä½¿ç”¨.

# åˆ›å»ºè€…æ¨¡å¼ä¹‹äºŒ: å·¥å‚æ–¹æ³•æ¨¡å¼

ä½¿ç”¨ç®€å•å·¥å‚æœ€å¤§çš„ä¸€ä¸ªç¼ºç‚¹å°±æ˜¯æ–°å¢å…·ä½“äº§å“æ—¶, å¿…é¡»ä¿®æ”¹é™æ€å·¥å‚, è¿èƒŒäº†å¼€é—­åŸåˆ™.

**å¦‚æœå®ç°å¢åŠ æ–°äº§å“æ—¶ä¸å½±å“åŸæ¥çš„ä»£ç ?**

æŠ½è±¡å‡ºä¸€ä¸ªå·¥å‚æ¥å£, é‡Œé¢æœ‰ä¸€ä¸ªåˆ›å»ºå…·ä½“äº§å“çš„æ–¹æ³•, ç„¶åè®©å…·ä½“å·¥å‚å®ç°è¿™ä¸ªæ¥å£, ä½¿ç”¨å…·ä½“äº§å“æ—¶, new ä¸€ä¸ªå¯¹åº”çš„å·¥å‚è·å–å…·ä½“äº§å“ (
æˆ–è€…ä½¿ç”¨é…ç½®æ–‡ä»¶)

å®šä¹‰ä¸€ä¸ªç”¨äºåˆ›å»ºå¯¹è±¡çš„æ¥å£, è®©å­ç±»å†³å®šå®ä¾‹åŒ–å“ªä¸€ä¸ªç±». å·¥å‚æ–¹æ³•ä½¿ä¸€ä¸ªç±»çš„å®ä¾‹åŒ–å»¶è¿Ÿåˆ°å…¶å­ç±».

![20241229154732_P3yYepqE.webp](https://cdn.dong4j.site/source/image/20241229154732_P3yYepqE.webp)

- æŠ½è±¡å·¥å‚: ç”³æ˜äº†å·¥å‚æ–¹æ³•, ç”¨äºè¿”å›ä¸€ä¸ªäº§å“. æ‰€æœ‰çš„å…·ä½“å·¥å‚ç±»éƒ½è¦äº‹å…ˆè¿™ä¸ªæ¥å£
- å…·ä½“å·¥å‚: æ˜¯æŠ½è±¡å·¥å‚çš„å­ç±», å®ç°äº†å·¥å‚æ–¹æ³•, å¹¶ç”±å®¢æˆ·ç«¯è°ƒç”¨, è¿”å›ä¸€ä¸ªå…·ä½“äº§å“ç±»å®ä¾‹.
- æŠ½è±¡äº§å“: æ‰€æœ‰äº§å“ç±»çš„çˆ¶ç±»
- å…·ä½“äº§å“: å®ç°äº†æŠ½è±¡äº§å“ç±», å’Œå…·ä½“å·¥å‚ä¸€ä¸€å¯¹åº”

ä¸ç®€å•å·¥å‚ç›¸æ¯”, å·¥å‚æ–¹æ³•å¼•å…¥äº†æŠ½è±¡å·¥å‚, æŠ½è±¡å·¥å‚å¯ä»¥æ˜¯æ¥å£, æŠ½è±¡ç±»æˆ–è€…å…·ä½“ç±».

```java
interface Factory{
        public Product createProduct();
}
```

å…·ä½“å·¥å‚å®ç°æŠ½è±¡å·¥å‚, äº§ç”Ÿå¯¹åº”çš„å…·ä½“äº§å“å®ä¾‹.

```java
class ConcteteFactory implements Factory{
        public Product createProduct(){
                return new ConcreteProduct();
        }
}
```

åœ¨å®¢æˆ·ç«¯åªéœ€è¦å…³å¿ƒå·¥å‚ç±»å³å¯

```java
Factory factory = new ConcreteFactory(); // å¯é€šè¿‡é…ç½®æ–‡ä»¶å®ç°
Product product = factory.createProduct();
```

## æ¡ˆä¾‹

è®°å½• log çš„æ–¹å¼ç°åœ¨æœ‰ 2 ç§, ä¸€ç§æ˜¯å†™å…¥æ–‡ä»¶, ä¸€ç§æ˜¯å†™å…¥æ•°æ®åº“

![20241229154732_htZN3W1q.webp](https://cdn.dong4j.site/source/image/20241229154732_htZN3W1q.webp)

ä»£ç :

æŠ½è±¡å·¥å‚æ¥å£

```java
public interface LoggerFactory {
    public Logger createLogger();
}
```

å…·ä½“å·¥å‚ç±»

```java
class DatabaseLoggerFactory implements LoggerFactory{
    @Override
    public Logger createLogger() {
        return new DatabaseLogger();
    }
}

class FileLoggerFactory implements LoggerFactory{
    @Override
    public Logger createLogger() {
        return new FileLogger();
    }
}
```

æŠ½è±¡äº§å“ç±»

```java
public interface Logger {
    void writeLog();
}
```

å…·ä½“äº§å“ç±»

```java
class FileLogger implements Logger{
    @Override
    public void writeLog(){
        System.out.println("å°†æ—¥å¿—å†™å…¥æ–‡ä»¶");
    }
}
class DatabaseLogger implements Logger{
    @Override
    public void writeLog(){
        System.out.println("å°†æ—¥å¿—å†™å…¥æ•°æ®åº“");
    }
}
```

é€šè¿‡é…ç½®æ–‡ä»¶è·å–å…·ä½“äº§å“å·¥å‚

```java
public class ConfigUtil {
    public static Object getType(String type) throws ClassNotFoundException, IllegalAccessException, InstantiationException {
        Properties properties = new Properties();
        try {
            // config.properties å¿…é¡»æ”¾åœ¨ classpath è·¯å¾„ä¸‹æ‰èƒ½åŠ è½½.
            properties.load(ConfigUtil.class.getClassLoader().getResourceAsStream("config.properties"));
        } catch (IOException e) {
            e.printStackTrace();
        }
        Class obj = Class.forName(properties.getProperty(type));
        return obj.newInstance();
    }
}
```

æµ‹è¯•ç±»

```java
public class FactoryTest {
    @Test
    public void factoryTest() throws ClassNotFoundException, IllegalAccessException, InstantiationException {
        LoggerFactory loggerFactory = (LoggerFactory)ConfigUtil.getType("loggerType");
        Logger logger = loggerFactory.createLogger();
        logger.writeLog();
    }
}
```

æ·»åŠ æ–°çš„æ—¥å¿—è®°å½•æ–¹å¼çš„æ­¥éª¤:

1. è®©æ–°çš„æ—¥å¿—è®°å½•ç±»ç»§æ‰¿æŠ½è±¡æ—¥å¿—è®°å½•å™¨ç±» Logger;
2. æ·»åŠ ä¸€ä¸ªå¯¹åº”çš„å…·ä½“å·¥å‚ç±», ç»§æ‰¿æŠ½è±¡æ—¥å¿—è®°å½•å·¥å‚ LoggerFactory, å¹¶å®ç°å…¶ä¸­çš„å·¥å‚æ–¹æ³• createLogger();
3. ä¿®æ”¹ config.properties, å°†åŸæ¥çš„å…¨ç±»åä¿®æ”¹ä¸ºæ–°çš„å…¨ç±»å
4. ç¼–è¯‘æ–°å¢çš„ä¸¤ä¸ªç±», åŸæ¥çš„ä»£ç ä¸åšä»»ä½•ä¿®æ”¹, è¿è¡Œæµ‹è¯•ç±»å³å¯.

é€šè¿‡å·¥å‚æ¨¡å¼ä½¿å¾—ç³»ç»Ÿæ›´åŠ çµæ´», æ–°å¢äº§å“æ—¶åªéœ€è¦æ·»åŠ ä¸¤ä¸ªç±»å³å¯, ä¸éœ€è¦ä¿®æ”¹åŸæœ‰ä»£ç .

## ç®€åŒ–å·¥å‚æ¨¡å¼

å°†æŠ½è±¡å·¥å‚æ¥å£æ”¹ä¸ºæŠ½è±¡ç±»

```java
public abstract class LoggerFactory {
    public abstract Logger createLogger();

    // åœ¨å·¥å‚ç±»ä¸­ç›´æ¥è°ƒç”¨æ—¥å¿—è®°å½•å™¨ç±»çš„ä¸šåŠ¡æ–¹æ³• writeLogger()
    public void writeLog(){
        Logger logger = this.createLogger();
        logger.writeLog();
    }
}
```

## æ€»ç»“

å·¥å‚æ–¹æ³•æ˜¯ç®€å•å·¥å‚çš„å»¶ä¼¸, ä¿®å¤äº†ç®€å•å·¥å‚æ·»åŠ æ–°äº§å“æ—¶å¿…é¡»ä¿®æ”¹æºä»£ç çš„é—®é¢˜

**ä¼˜ç‚¹:**

1. ä½¿ç”¨å…·ä½“å·¥å‚ç±»åˆ›å»ºå¯¹åº”çš„äº§å“, æƒ³å®¢æˆ·ç«¯éšè—äº†å…·ä½“å®ç°, ç”¨æˆ·åªéœ€è¦å…³ç³»æ‰€éœ€çš„äº§å“å³å¯, ç”šè‡³ä¸éœ€è¦çŸ¥é“äº§å“ç±»å.
2. å¢åŠ æ–°äº§å“æ—¶, åªéœ€è¦æ·»åŠ ä¸€ä¸ªå…·ä½“å·¥å‚ç±»å’Œä¸€ä¸ªå…·ä½“äº§å“ç±», æ— éœ€ä¿®æ”¹åŸæ¥çš„ä»£ç , ä½¿ç³»ç»Ÿæ›´å…·æ‰©å±•æ€§.

**ç¼ºç‚¹:**

1. å› ä¸ºå…·ä½“äº§å“ç±»å’Œå…·ä½“å·¥å‚ç±»è¦ä¸€ä¸€å¯¹åº”, æ‰€ä»¥å¢åŠ äº†ç±»çš„ä¸ªæ•°, ç»™ç³»ç»Ÿé€ æˆäº†ä¸€å®šçš„å¤æ‚åº¦.
2. ä¸ºäº†æ›´å¥½çš„éµå¾ªå¼€é—­åŸåˆ™, ä½¿ç”¨é…ç½®æ–‡ä»¶, åå°„, å¢åŠ äº†ç³»ç»Ÿå¤æ‚åº¦

**é€‚ç”¨åœºæ™¯**

1. å®¢æˆ·ç«¯ä¸çŸ¥é“å®ƒæ‰€éœ€è¦çš„å¯¹è±¡çš„ç±». åœ¨å·¥å‚æ–¹æ³•æ¨¡å¼ä¸­, å®¢æˆ·ç«¯ä¸éœ€è¦çŸ¥é“å…·ä½“äº§å“ç±»çš„ç±»å, åªéœ€è¦çŸ¥é“æ‰€ å¯¹åº”çš„å·¥å‚å³å¯, å…·ä½“çš„äº§å“å¯¹è±¡ç”±å…·ä½“å·¥å‚ç±»åˆ›å»º,
   å¯å°†å…·ä½“å·¥å‚ç±»çš„ç±»åå­˜å‚¨åœ¨é…ç½®æ–‡ä»¶æˆ–æ•°æ®åº“ä¸­.
2. æŠ½è±¡å·¥å‚ç±»é€šè¿‡å…¶å­ç±»æ¥æŒ‡å®šåˆ›å»ºå“ªä¸ªå¯¹è±¡. åœ¨å·¥å‚æ–¹æ³•æ¨¡å¼ä¸­, å¯¹äºæŠ½è±¡å·¥å‚ç±»åªéœ€è¦æä¾›ä¸€ä¸ªåˆ›å»ºäº§å“çš„ æ¥å£, è€Œç”±å…¶å­ç±»æ¥ç¡®å®šå…·ä½“è¦åˆ›å»ºçš„å¯¹è±¡,
   åˆ©ç”¨é¢å‘å¯¹è±¡çš„å¤šæ€æ€§å’Œé‡Œæ°ä»£æ¢åŸåˆ™, åœ¨ç¨‹åºè¿è¡Œæ—¶, å­ç±»å¯¹è±¡ å°†è¦†ç›–çˆ¶ç±»å¯¹è±¡, ä»è€Œä½¿å¾—ç³»ç»Ÿæ›´å®¹æ˜“æ‰©å±•.

## å¼•ç”¨

- [http://blog.csdn.net/lovelion/article/details/9306457](http://blog.csdn.net/lovelion/article/details/9306457)
- [http://blog.csdn.net/lovelion/article/details/9306745](http://blog.csdn.net/lovelion/article/details/9306745)
- [http://blog.csdn.net/lovelion/article/details/9307137](http://blog.csdn.net/lovelion/article/details/9307137)
- [http://blog.csdn.net/lovelion/article/details/9307561](http://blog.csdn.net/lovelion/article/details/9307561)

## [æŒæ¡è®¾è®¡æ¨¡å¼ç²¾é«“ï¼šäº”å¤§æ ¸å¿ƒåŸåˆ™æ·±åº¦è§£æ](https://blog.dong4j.site/posts/7244523f.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})


## å•ä¸€èŒè´£åŸåˆ™ (Single Responsibility Principle, SRP)

**å®šä¹‰:**

ä¸€ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½é¢†åŸŸä¸­ç›¸åº”èŒè´£ (å¯¹ä¸€ä¸ªç±»è€Œè¨€, åº”è¯¥åªæœ‰ä¸€ä¸ªå¼•èµ·å®ƒå˜åŒ–çš„åŸå› )

**ä½œç”¨:**
å®ç°é«˜å†…èš, ä½è€¦åˆ

### æ¡ˆä¾‹:

å®¢æˆ·ä¿¡æ¯å›¾å½¢ç»Ÿè®¡æ¨¡å—

![20241229154732_pLo4amG4.webp](https://cdn.dong4j.site/source/image/20241229154732_pLo4amG4.webp)

è¿èƒŒå•ä¸€èŒè´£åŸåˆ™
å¦‚æœä¿®æ”¹æ•°æ®åº“è¿æ¥æ–¹å¼æˆ–è€…ä¿®æ”¹å›¾æ ‡æ˜¾ç¤ºæ–¹å¼éƒ½éœ€è¦ä¿®æ”¹è¿™ä¸ªç±»;
ä¸èƒ½é‡ç”¨æ•°æ®åº“è¿æ¥çš„ä»£ç 

### é‡æ„

![20241229154732_2jnU7yLX.webp](https://cdn.dong4j.site/source/image/20241229154732_2jnU7yLX.webp)

**ä»£ç å®ç°:**

```java
class CustomerDataChart {
    private CustomerDao customerDao;

    public void createChart(){
        System.out.println("åˆ›å»ºå›¾è¡¨");
    }

    public void displayChart(){
        System.out.println("æ˜¾ç¤ºå›¾è¡¨");
    }
}

class CustomerDao {
    private DBUtil dbUtil;

    public List<Customer> findCustomers() {
        System.out.println("è·å–å…¨éƒ¨çš„å®¢æˆ·åˆ—è¡¨");
    }
}

class DBUtil {
    public Connection getConnection() {
        System.out.println("è·å–æ•°æ®åº“è¿æ¥");
    }
}
```

---

## å¼€é—­åŸåˆ™ (Open-Closed Principle, OCP)

**å®šä¹‰:**

ä¸€ä¸ªè½¯ä»¶å®ä½“åº”å½“å¯¹æ‰©å±•å¼€æ”¾, å¯¹ä¿®æ”¹å…³é—­ (å°½é‡ä¸ä¿®æ”¹åŸæ¥çš„ä»£ç , è€Œæ˜¯æ·»åŠ æ–°ä»£ç å®ç°éœ€æ±‚)

**ä½œç”¨:**
ä½¿ç³»ç»Ÿæ‹¥æœ‰é€‚åº”æ€§å’Œçµæ´»æ€§, åŒæ—¶å…·å¤‡è¾ƒå¥½çš„ç¨³å®šæ€§å’Œå»¶ç»­æ€§

### æ¡ˆä¾‹

![20241229154732_sxgIpcu4.webp](https://cdn.dong4j.site/source/image/20241229154732_sxgIpcu4.webp)

ä»£ç 

```java
......
if (type.equals("pie")) {
    PieChart chart = new PieChart();
    chart.display();
}
else if (type.equals("bar")) {
    BarChart chart = new BarChart();
    chart.display();
}
......
```

é—®é¢˜:
å½“éœ€è¦æ–°å¢ä¸€ç§å›¾è¡¨æ˜¾ç¤ºæ—¶, å¿…é¡»ä¿®æ”¹æºä»£ç , å¢åŠ åˆ¤æ–­è¯­å¥, è¿èƒŒå¼€é—­åŸåˆ™

### é‡æ„

![20241229154732_IKIGT8WG.webp](https://cdn.dong4j.site/source/image/20241229154732_IKIGT8WG.webp)

ä»£ç :

```java
class ChartDisplay {
	private AbstractChart chart;

	public void setChart(AbstractChart chart) {
		this.chart = chart;
	}

	public void display(){
		chart.display();
	}
}

abstract class AbstractChart {
	public abstract void display();
}

class PieChart extends AbstractChart {
	public void display() {
		System.out.println("åœ†é¥¼å›¾å½¢æ˜¾ç¤º");
	}
}

class BarChart extends AbstractChart {
	public void display() {
		System.out.println("æ¡å½¢å›¾å½¢æ˜¾ç¤º");
	}
}

// æ–°å¢æ˜¾ç¤ºç±», ä¸éœ€è¦ä¿®æ”¹åŸæœ‰ä»£ç 
class CurveChart extends AbstractChart {
	public void display() {
		System.out.println("æ›²çº¿å›¾å½¢æ˜¾ç¤º");
	}
}

public class OCPTest {
	public static void main(String[] args) {
		ChartDisplay c	= new ChartDisplay();
		// ä¿®æ”¹å®¢æˆ·ç«¯ä»£ç , æˆ–è€…ä½¿ç”¨ xml æˆ–è€… properties é…ç½®æ–‡ä»¶, ä¿®æ”¹é…ç½®æ–‡ä»¶å®ç°ç±»å­—ç¬¦ä¸²å®ç°
		AbstractChart chart = new CurveChart();
		c.setChart(chart);
		c.display();
	}
}
```

---

## é‡Œæ°æ›¿æ¢ (Liskov Substitution Principle, LSP)

**å®šä¹‰:**

æ‰€æœ‰å¼•ç”¨åŸºç±»çš„åœ°æ–¹å¿…é¡»èƒ½é€æ˜çš„ä½¿ç”¨å…¶å­ç±»çš„å¯¹è±¡
åœ¨è½¯ä»¶ä¸­å°†ä¸€ä¸ªåŸºç±»å¯¹è±¡æ›¿æ¢æˆå®ƒçš„å­ç±»å¯¹è±¡, ç¨‹åºå°†ä¸ä¼šäº§ç”Ÿä»»ä½•é”™è¯¯å’Œå¼‚å¸¸, åè¿‡æ¥åˆ™ä¸æˆç«‹, å¦‚æœä¸€ä¸ªè½¯ä»¶å®ä½“ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªå­ç±»å¯¹è±¡çš„è¯,
é‚£ä¹ˆå®ƒä¸ä¸€å®šèƒ½å¤Ÿä½¿ç”¨åŸºç±»å¯¹è±¡.

**ä½œç”¨:**
é‡Œæ°ä»£æ¢åŸåˆ™æ˜¯å®ç°å¼€é—­åŸåˆ™çš„é‡è¦æ–¹å¼ä¹‹ä¸€, ç”±äºä½¿ç”¨åŸºç±»å¯¹è±¡çš„åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨å­ç±»å¯¹è±¡, å› æ­¤åœ¨ç¨‹åºä¸­å°½é‡ä½¿ç”¨åŸºç±»ç±»å‹æ¥å¯¹å¯¹è±¡è¿›è¡Œå®šä¹‰,
è€Œåœ¨è¿è¡Œæ—¶å†ç¡®å®šå…¶å­ç±»ç±»å‹, ç”¨å­ç±»å¯¹è±¡æ¥æ›¿æ¢çˆ¶ç±»å¯¹è±¡.

**åœ¨ä½¿ç”¨é‡Œæ°ä»£æ¢åŸåˆ™æ—¶éœ€è¦æ³¨æ„å¦‚ä¸‹å‡ ä¸ªé—®é¢˜**:

1. å­ç±»çš„æ‰€æœ‰æ–¹æ³•å¿…é¡»åœ¨çˆ¶ç±»ä¸­å£°æ˜, æˆ–å­ç±»å¿…é¡»å®ç°çˆ¶ç±»ä¸­å£°æ˜çš„æ‰€æœ‰æ–¹æ³•. æ ¹æ®é‡Œæ°ä»£æ¢åŸåˆ™, ä¸ºäº†ä¿è¯ç³»ç»Ÿçš„æ‰©å±•æ€§, åœ¨ç¨‹åºä¸­é€šå¸¸ä½¿ç”¨çˆ¶ç±»æ¥è¿›è¡Œå®šä¹‰,
   å¦‚æœä¸€ä¸ªæ–¹æ³•åªå­˜åœ¨å­ç±»ä¸­, åœ¨çˆ¶ç±»ä¸­ä¸æä¾›ç›¸åº”çš„å£°æ˜, åˆ™æ— æ³•åœ¨ä»¥çˆ¶ç±»å®šä¹‰çš„å¯¹è±¡ä¸­ä½¿ç”¨è¯¥æ–¹æ³•.
2. æˆ‘ä»¬åœ¨è¿ç”¨é‡Œæ°ä»£æ¢åŸåˆ™æ—¶, å°½é‡æŠŠçˆ¶ç±»è®¾è®¡ä¸ºæŠ½è±¡ç±»æˆ–è€…æ¥å£, è®©å­ç±»ç»§æ‰¿çˆ¶ç±»æˆ–å®ç°çˆ¶æ¥å£, å¹¶å®ç°åœ¨çˆ¶ç±»ä¸­å£°æ˜çš„æ–¹æ³•, è¿è¡Œæ—¶, å­ç±»å®ä¾‹æ›¿æ¢çˆ¶ç±»å®ä¾‹,
   æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ‰©å±•ç³»ç»Ÿçš„åŠŸèƒ½, åŒæ—¶æ— é¡»ä¿®æ”¹åŸæœ‰å­ç±»çš„ä»£ç , å¢åŠ æ–°çš„åŠŸèƒ½å¯ä»¥é€šè¿‡å¢åŠ ä¸€ä¸ªæ–°çš„å­ç±»æ¥å®ç°. é‡Œæ°ä»£æ¢åŸåˆ™æ˜¯å¼€é—­åŸåˆ™çš„å…·ä½“å®ç°æ‰‹æ®µä¹‹ä¸€.
3. Java è¯­è¨€ä¸­, åœ¨ç¼–è¯‘é˜¶æ®µ, Java ç¼–è¯‘å™¨ä¼šæ£€æŸ¥ä¸€ä¸ªç¨‹åºæ˜¯å¦ç¬¦åˆé‡Œæ°ä»£æ¢åŸåˆ™, è¿™æ˜¯ä¸€ä¸ªä¸å®ç°æ— å…³çš„ã€çº¯è¯­æ³•æ„ä¹‰ä¸Šçš„æ£€æŸ¥, ä½† Java ç¼–è¯‘å™¨çš„æ£€æŸ¥æ˜¯æœ‰å±€é™çš„.

### æ¡ˆä¾‹

![20241229154732_C3xVQGJs.webp](https://cdn.dong4j.site/source/image/20241229154732_C3xVQGJs.webp)

### é‡æ„

![20241229154732_a9HhpLh9.webp](https://cdn.dong4j.site/source/image/20241229154732_a9HhpLh9.webp)

ä»£ç 

```java
class EmailSender {
	public void send(Customer customer){
		System.out.print(customer.getName() + "å‘é€é‚®ä»¶");
	}
}

abstract class Customer {
	protected String name;
	protected String email;
	public void setName(String name){
		this.name = name;
	}
	public String getName(){
		return name;
	}
	public void setEmail(String email){
		this.email = email;
	}
	public String getEmail(){
		return email;
	}
}

class CommonCustomer extends Customer{

}

class VIPCustomer extends Customer{

}

public class LSPTest {
	public static void main(String[] args) {
		Customer customer = new CommonCustomer();
		customer.setName("æ™®é€šç”¨æˆ·");
		new EmailSender().send(customer);
	}
}
```

---

## ä¾èµ–å€’è½¬ (Dependency Inversion Principle, DIP)

**å®šä¹‰:**

æŠ½è±¡ä¸åº”è¯¥ä¾èµ–äºç»†èŠ‚, ç»†èŠ‚åº”å½“ä¾èµ–äºæŠ½è±¡ (é’ˆå¯¹æ¥å£ç¼–ç¨‹, è€Œä¸æ˜¯é’ˆå¯¹å®ç°ç¼–ç¨‹)
ä¾èµ–å€’è½¬åŸåˆ™è¦æ±‚æˆ‘ä»¬åœ¨ç¨‹åºä»£ç ä¸­ä¼ é€’å‚æ•°æ—¶æˆ–åœ¨å…³è”å…³ç³»ä¸­, å°½é‡å¼•ç”¨å±‚æ¬¡é«˜çš„æŠ½è±¡å±‚ç±», å³ä½¿ç”¨æ¥å£å’ŒæŠ½è±¡ç±»è¿›è¡Œå˜é‡ç±»å‹å£°æ˜ã€å‚æ•°ç±»å‹å£°æ˜ã€æ–¹æ³•è¿”å›ç±»å‹å£°æ˜,
ä»¥åŠæ•°æ®ç±»å‹çš„è½¬æ¢ç­‰, è€Œä¸è¦ç”¨å…·ä½“ç±»æ¥åšè¿™äº›äº‹æƒ….

**ä½œç”¨:**
åœ¨å¼•å…¥æŠ½è±¡å±‚å, ç³»ç»Ÿå°†å…·æœ‰å¾ˆå¥½çš„çµæ´»æ€§, åœ¨ç¨‹åºä¸­å°½é‡ä½¿ç”¨æŠ½è±¡å±‚è¿›è¡Œç¼–ç¨‹, è€Œå°†å…·ä½“ç±»å†™åœ¨é…ç½®æ–‡ä»¶ä¸­, è¿™æ ·ä¸€æ¥, å¦‚æœç³»ç»Ÿè¡Œä¸ºå‘ç”Ÿå˜åŒ–,
åªéœ€è¦å¯¹æŠ½è±¡å±‚è¿›è¡Œæ‰©å±•, å¹¶ä¿®æ”¹é…ç½®æ–‡ä»¶, è€Œæ— é¡»ä¿®æ”¹åŸæœ‰ç³»ç»Ÿçš„æºä»£ç , åœ¨ä¸ä¿®æ”¹çš„æƒ…å†µä¸‹æ¥æ‰©å±•ç³»ç»Ÿçš„åŠŸèƒ½, æ»¡è¶³å¼€é—­åŸåˆ™çš„è¦æ±‚

### æ¡ˆä¾‹

![20241229154732_2jnU7yLX.webp](https://cdn.dong4j.site/source/image/20241229154732_2jnU7yLX.webp)

ä»£ç 

```java
class CustomerDao {
	public void addCustomers(TXTDataConvertor convertor){
		convertor.readFile();
		System.out.println("å­˜å…¥æ•°æ®åº“");
	}
}

class TXTDataConvertor {
	public void readFile(){
		System.out.println("ä»æ–‡æœ¬è½¬æ¢æ•°æ®");
	}
}

class ExcelDataConvertor {
	public void readFile(){
		System.out.println("ä»excleè½¬æ¢æ•°æ®");
	}
}


class DIPTest {
	public static void main(String[] args) {
		CustomerDao customerDao = new CustomerDao();
		customerDao.addCustomers(new TXTDataConvertor());
	}
}
```

å½“éœ€è¦ä» excel æ–‡ä»¶è½¬æ¢æ•°æ®æ—¶, å¿…é¡»ä¿®æ”¹ CustomerDao å®ç°ä»£ç , è¿èƒŒå¼€é—­åŸåˆ™.

### é‡æ„

![20241229154732_zejrvvRa.webp](https://cdn.dong4j.site/source/image/20241229154732_zejrvvRa.webp)

ä»£ç 

```java
class CustomerDao {
      // æ”¹æˆæŠ½è±¡ç±»
	public void addCustomers(DataConvertor convertor){
		convertor.readFile();
		System.out.println("å­˜å…¥æ•°æ®åº“");
	}
}

abstract class DataConvertor {
	public abstract void readFile();
}

class TXTDataConvertor extends DataConvertor {
	public void readFile(){
		System.out.println("ä»æ–‡æœ¬è½¬æ¢æ•°æ®");
	}
}

class ExcelDataConvertor extends DataConvertor {
	public void readFile(){
		System.out.println("ä»excleè½¬æ¢æ•°æ®");
	}
}

class DIPTest {
	public static void main(String[] args) {
		CustomerDao customerDao = new CustomerDao();
		// è¿™é‡Œå¯ä»¥ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–ç±»å, ç„¶åä½¿ç”¨åå°„åˆ›å»ºå¯¹è±¡
		customerDao.addCustomers(new TXTDataConvertor());
	}
}
```

**é‡Œæ°ä»£æ¢åŸåˆ™æ˜¯åŸºç¡€, ä¾èµ–å€’è½¬åŸåˆ™æ˜¯æ‰‹æ®µ, å¼€é—­åŸåˆ™æ˜¯ç›®æ ‡**

## æ¥å£éš”ç¦» (Interface Segregation Principle, ISP)

**å®šä¹‰:**

ä½¿ç”¨å¤šä¸ªä¸“é—¨çš„æ¥å£, è€Œä¸ä½¿ç”¨å•ä¸€çš„ä¸­æ¥å£ (å®¢æˆ·ç«¯ä¸åº”è¯¥ä¾èµ–é‚£äº›ä¸éœ€è¦çš„æ¥å£)

**ä½œç”¨:**
é¿å…å®ç°ä¸éœ€è¦çš„åŠŸèƒ½, é€ æˆç±»è¿‡å¤§

### æ¡ˆä¾‹

![20241229154732_9YohyQXM.webp](https://cdn.dong4j.site/source/image/20241229154732_9YohyQXM.webp)

å®ç° CustomerDataDisplay , å¿…é¡»å…¨éƒ¨å®ç°é‡Œé¢çš„æŠ½è±¡æ–¹æ³•, ä½†æ˜¯æ˜¾ç¤ºç±»æœ‰æ—¶å€™å¹¶ä¸éœ€è¦æŸäº›æ–¹æ³•, è¿™æ˜¯å› ä¸º CustomerDataDisplay å£°æ˜äº†å¤ªå¤šæŠ½è±¡æ–¹æ³•

### é‡æ„

![20241229154732_RxaRuJtG.webp](https://cdn.dong4j.site/source/image/20241229154732_RxaRuJtG.webp)

æ˜¾ç¤ºç±»æœ¬èº«æœ‰ 3 ä¸ªæ–¹æ³•, å¦‚æœéœ€è¦å…¶ä»–åŠŸèƒ½, å¯ä»¥å®ç°å¯¹åº”åŠŸèƒ½çš„æ¥å£å³å¯

åœ¨ä½¿ç”¨æ¥å£éš”ç¦»åŸåˆ™æ—¶, æˆ‘ä»¬éœ€è¦æ³¨æ„æ§åˆ¶æ¥å£çš„ç²’åº¦, æ¥å£ä¸èƒ½å¤ªå°, å¦‚æœå¤ªå°ä¼šå¯¼è‡´ç³»ç»Ÿä¸­æ¥å£æ³›æ»¥, ä¸åˆ©äºç»´æŠ¤ï¼›æ¥å£ä¹Ÿä¸èƒ½å¤ªå¤§, å¤ªå¤§çš„æ¥å£å°†è¿èƒŒæ¥å£éš”ç¦»åŸåˆ™,
çµæ´»æ€§è¾ƒå·®, ä½¿ç”¨èµ·æ¥å¾ˆä¸æ–¹ä¾¿. ä¸€èˆ¬è€Œè¨€, æ¥å£ä¸­ä»…åŒ…å«ä¸ºæŸä¸€ç±»ç”¨æˆ·å®šåˆ¶çš„æ–¹æ³•å³å¯, ä¸åº”è¯¥å¼ºè¿«å®¢æˆ·ä¾èµ–äºé‚£äº›å®ƒä»¬ä¸ç”¨çš„æ–¹æ³•.

## åˆæˆå¤ç”¨åŸåˆ™ (Composite Reuse Principle, CRP)

**å®šä¹‰:**

å°½é‡ä½¿ç”¨å¯¹è±¡ç»„åˆ, è€Œä¸æ˜¯è¿›ç¨‹æ¥è¾¾åˆ°å¤ç”¨çš„ç›®çš„
åœ¨é¢å‘å¯¹è±¡è®¾è®¡ä¸­, å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹æ³•åœ¨ä¸åŒçš„ç¯å¢ƒä¸­å¤ç”¨å·²æœ‰çš„è®¾è®¡å’Œå®ç°, å³é€šè¿‡ç»„åˆ / èšåˆå…³ç³»æˆ–é€šè¿‡ç»§æ‰¿, ä½†é¦–å…ˆåº”è¯¥è€ƒè™‘ä½¿ç”¨ç»„åˆ / èšåˆ, ç»„åˆ /
èšåˆå¯ä»¥ä½¿ç³»ç»Ÿæ›´åŠ çµæ´», é™ä½ç±»ä¸ç±»ä¹‹é—´çš„è€¦åˆåº¦, ä¸€ä¸ªç±»çš„å˜åŒ–å¯¹å…¶ä»–ç±»é€ æˆçš„å½±å“ç›¸å¯¹è¾ƒå°‘ï¼›å…¶æ¬¡æ‰è€ƒè™‘ç»§æ‰¿, åœ¨ä½¿ç”¨ç»§æ‰¿æ—¶, éœ€è¦ä¸¥æ ¼éµå¾ªé‡Œæ°ä»£æ¢åŸåˆ™,
æœ‰æ•ˆä½¿ç”¨ç»§æ‰¿ä¼šæœ‰åŠ©äºå¯¹é—®é¢˜çš„ç†è§£, é™ä½å¤æ‚åº¦, è€Œæ»¥ç”¨ç»§æ‰¿åè€Œä¼šå¢åŠ ç³»ç»Ÿæ„å»ºå’Œç»´æŠ¤çš„éš¾åº¦ä»¥åŠç³»ç»Ÿçš„å¤æ‚åº¦, å› æ­¤éœ€è¦æ…é‡ä½¿ç”¨ç»§æ‰¿å¤ç”¨.

**ä½œç”¨:**
é™ä½è€¦åˆåº¦

is-a å…³ç³» (ç»§æ‰¿):
ä¸€ä¸ªç±»æ˜¯å¦ä¸€ä¸ªçš„**ä¸€ç§**
has-a å…³ç³» (ç»„åˆ / èšåˆ):
æŸä¸ªè§’è‰²å…·æœ‰æŸä¸€é¡¹è´£ä»»

### æ¡ˆä¾‹

![20241229154732_d1buxWKK.webp](https://cdn.dong4j.site/source/image/20241229154732_d1buxWKK.webp)

å°†è·å–æ•°æ®åº“è¿æ¥çš„æ–¹æ³•æå–åˆ° DBUtil ä¸­, CustomerDao ç»§æ‰¿ DBUtil
å½“éœ€è¦æ›´æ¢æ•°æ®åº“æ—¶, å¿…é¡»ä¿®æ”¹ DBUtil ä»£ç , è¿åäº†å¼€é—­åŸåˆ™, æˆ–è€…ä¿®æ”¹ CustomerDao, ç»§æ‰¿å¦ä¸€ä¸ªè·å–æ•°æ®åº“è¿æ¥å®ç°ç±», åŒæ ·æ½åŠäº†å¼€é—­åŸåˆ™

### é‡æ„

![20241229154732_wW9BZmoq.webp](https://cdn.dong4j.site/source/image/20241229154732_wW9BZmoq.webp)

ä½¿ç”¨å…³è”å…³ç³»

ä»£ç 

```java
class DBUtil {
	public Connection getConnection(){
		System.out.println("å¾—åˆ°æ•°æ®åº“è¿æ¥");
		return null;
	}
}
class OracleDBUtil extends DBUtil {
	public Connection getConnection(){
		System.out.println("å¾—åˆ°Oracleæ•°æ®åº“è¿æ¥");
		return null;
	}
}

class CustomerDao {
	private DBUtil dbUtil;
	public CustomerDao(DBUtil dbUtil){
		this.dbUtil = dbUtil;
	}
	public void addCustomerDao(){
		dbUtil.getConnection();
		System.out.println("æ·»åŠ æ“ä½œ");
	}
}
public class CRPTest {
	public static void main(String[] args) {
		DBUtil dbUtil = new OracleDBUtil();
		// å¯ä»¥ä»é…ç½®æ–‡ä»¶ä¸­è·å–æ•°æ®åº“å®ç°ç±», ç„¶åä½¿ç”¨åå°„åˆ›å»ºå¯¹è±¡
		CustomerDao customerDao = new CustomerDao(dbUtil);
		customerDao.addCustomerDao();
	}
}
```

è¿™æ ·é‡æ„å, å½“å†æ¬¡æ›´æ¢æ•°æ®åº“æ—¶, åªéœ€è¦æ·»åŠ ä¸€ä¸ªè·å–æ•°æ®åº“çš„å®ç°ç±», ç„¶åç»§æ‰¿ DBUtil å³å¯. ä¸éœ€è¦æ›´æ”¹ä»»ä½•ä»£ç 

## è¿ªç±³ç‰¹æ³•åˆ™ (Law of Demeter, LoD)

**å®šä¹‰:**

ä¸€ä¸ªè½¯ä»¶å®ä½“åº”å½“å°½å¯èƒ½å°‘åœ°ä¸å…¶ä»–å®ä½“å‘ç”Ÿç›¸äº’ä½œç”¨.
å¦‚æœä¸€ä¸ªç³»ç»Ÿç¬¦åˆè¿ªç±³ç‰¹æ³•åˆ™, é‚£ä¹ˆå½“å…¶ä¸­æŸä¸€ä¸ªæ¨¡å—å‘ç”Ÿä¿®æ”¹æ—¶, å°±ä¼šå°½é‡å°‘åœ°å½±å“å…¶ä»–æ¨¡å—, æ‰©å±•ä¼šç›¸å¯¹å®¹æ˜“, è¿™æ˜¯å¯¹è½¯ä»¶å®ä½“ä¹‹é—´é€šä¿¡çš„é™åˆ¶,
è¿ªç±³ç‰¹æ³•åˆ™è¦æ±‚é™åˆ¶è½¯ä»¶å®ä½“ä¹‹é—´é€šä¿¡çš„å®½åº¦å’Œæ·±åº¦. è¿ªç±³ç‰¹æ³•åˆ™å¯é™ä½ç³»ç»Ÿçš„è€¦åˆåº¦, ä½¿ç±»ä¸ç±»ä¹‹é—´ä¿æŒæ¾æ•£çš„è€¦åˆå…³ç³».

**ä½œç”¨:**
ä½¿ç³»ç»Ÿæ›´å®¹æ˜“æ‰©å±•, é™ä½è€¦åˆåº¦

è¿ªç±³ç‰¹æ³•åˆ™è¿˜æœ‰å‡ ç§å®šä¹‰å½¢å¼, åŒ…æ‹¬: ä¸è¦å’Œ â€œé™Œç”Ÿäººâ€ è¯´è¯ã€åªä¸ä½ çš„ç›´æ¥æœ‹å‹é€šä¿¡ç­‰, åœ¨è¿ªç±³ç‰¹æ³•åˆ™ä¸­, å¯¹äºä¸€ä¸ªå¯¹è±¡, å…¶æœ‹å‹åŒ…æ‹¬ä»¥ä¸‹å‡ ç±»:

1. å½“å‰å¯¹è±¡æœ¬èº« (this)ï¼›
2. ä»¥å‚æ•°å½¢å¼ä¼ å…¥åˆ°å½“å‰å¯¹è±¡æ–¹æ³•ä¸­çš„å¯¹è±¡ï¼›
3. å½“å‰å¯¹è±¡çš„æˆå‘˜å¯¹è±¡ï¼›
4. å¦‚æœå½“å‰å¯¹è±¡çš„æˆå‘˜å¯¹è±¡æ˜¯ä¸€ä¸ªé›†åˆ, é‚£ä¹ˆé›†åˆä¸­çš„å…ƒç´ ä¹Ÿéƒ½æ˜¯æœ‹å‹ï¼›
5. å½“å‰å¯¹è±¡æ‰€åˆ›å»ºçš„å¯¹è±¡.

## å¼•ç”¨

- [é¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™ä¹‹å•ä¸€èŒè´£åŸåˆ™](http://blog.csdn.net/lovelion/article/details/7536542)
- [é¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™ä¹‹å¼€é—­åŸåˆ™](http://blog.csdn.net/lovelion/article/details/7537584)
- [é¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™ä¹‹é‡Œæ°ä»£æ¢åŸåˆ™](http://blog.csdn.net/lovelion/article/details/7540445)
- [é¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™ä¹‹ä¾èµ–å€’è½¬åŸåˆ™](http://blog.csdn.net/lovelion/article/details/7562783)
- [é¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™ä¹‹æ¥å£éš”ç¦»åŸåˆ™](http://blog.csdn.net/lovelion/article/details/7562842)
- [é¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™ä¹‹åˆæˆå¤ç”¨åŸåˆ™](http://blog.csdn.net/lovelion/article/details/7563441)
- [é¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™ä¹‹è¿ªç±³ç‰¹æ³•åˆ™](http://blog.csdn.net/lovelion/article/details/7563445)

## [ä»é›¶åˆ°ä¸€ï¼ŒæŒæ¡Javaç®€å•å·¥å‚æ¨¡å¼](https://blog.dong4j.site/posts/6b3bea20.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

#### æ¯å¤©ä¸€ä¸ª Linux å‘½ä»¤

**ls å‘½ä»¤**

```
-a: æ˜¾ç¤ºæ‰€æœ‰æ¡£æ¡ˆåŠç›®å½•ï¼ˆls å†…å®šå°†æ¡£æ¡ˆåæˆ–ç›®å½•åç§°ä¸ºâ€œ.â€çš„è§†ä¸ºå½±è—, ä¸ä¼šåˆ—å‡ºï¼‰ï¼›
-A: æ˜¾ç¤ºé™¤å½±è—æ–‡ä»¶â€œ.â€å’Œâ€œ..â€ä»¥å¤–çš„æ‰€æœ‰æ–‡ä»¶åˆ—è¡¨ï¼›
-C: å¤šåˆ—æ˜¾ç¤ºè¾“å‡ºç»“æœ. è¿™æ˜¯é»˜è®¤é€‰é¡¹ï¼›
-l: ä¸â€œ-Câ€é€‰é¡¹åŠŸèƒ½ç›¸å, æ‰€æœ‰è¾“å‡ºä¿¡æ¯ç”¨å•åˆ—æ ¼å¼è¾“å‡º, ä¸è¾“å‡ºä¸ºå¤šåˆ—ï¼›
-F: åœ¨æ¯ä¸ªè¾“å‡ºé¡¹åè¿½åŠ æ–‡ä»¶çš„ç±»å‹æ ‡è¯†ç¬¦, å…·ä½“å«ä¹‰: â€œ*â€è¡¨ç¤ºå…·æœ‰å¯æ‰§è¡Œæƒé™çš„æ™®é€šæ–‡ä»¶, â€œ/â€è¡¨ç¤ºç›®å½•, â€œ@â€è¡¨ç¤ºç¬¦å·é“¾æ¥, â€œ|â€è¡¨ç¤ºå‘½ä»¤ç®¡é“ FIFO, â€œ=â€è¡¨ç¤º sockets å¥—æ¥å­—. å½“æ–‡ä»¶ä¸ºæ™®é€šæ–‡ä»¶æ—¶, ä¸è¾“å‡ºä»»ä½•æ ‡è¯†ç¬¦ï¼›
-b: å°†æ–‡ä»¶ä¸­çš„ä¸å¯è¾“å‡ºçš„å­—ç¬¦ä»¥åæ–œçº¿â€œâ€åŠ å­—ç¬¦ç¼–ç çš„æ–¹å¼è¾“å‡ºï¼›
-c: ä¸â€œ-ltâ€é€‰é¡¹è¿ç”¨æ—¶, æŒ‰ç…§æ–‡ä»¶çŠ¶æ€æ—¶é—´æ’åºè¾“å‡ºç›®å½•å†…å®¹, æ’åºçš„ä¾æ®æ˜¯æ–‡ä»¶çš„ç´¢å¼•èŠ‚ç‚¹ä¸­çš„ ctime å­—æ®µ. ä¸â€œ-lâ€é€‰é¡¹è¿ç”¨æ—¶, åˆ™æ’åºçš„ä¸€å¥æ˜¯æ–‡ä»¶çš„çŠ¶æ€æ”¹å˜æ—¶é—´ï¼›
-d: ä»…æ˜¾ç¤ºç›®å½•å, è€Œä¸æ˜¾ç¤ºç›®å½•ä¸‹çš„å†…å®¹åˆ—è¡¨. æ˜¾ç¤ºç¬¦å·é“¾æ¥æ–‡ä»¶æœ¬èº«, è€Œä¸æ˜¾ç¤ºå…¶æ‰€æŒ‡å‘çš„ç›®å½•åˆ—è¡¨ï¼›
-f: æ­¤å‚æ•°çš„æ•ˆæœå’ŒåŒæ—¶æŒ‡å®šâ€œaUâ€å‚æ•°ç›¸åŒ, å¹¶å…³é—­â€œlstâ€å‚æ•°çš„æ•ˆæœï¼›
-i: æ˜¾ç¤ºæ–‡ä»¶ç´¢å¼•èŠ‚ç‚¹å·ï¼ˆinodeï¼‰. ä¸€ä¸ªç´¢å¼•èŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªæ–‡ä»¶ï¼›
--file-type: ä¸â€œ-Fâ€é€‰é¡¹çš„åŠŸèƒ½ç›¸åŒ, ä½†æ˜¯ä¸æ˜¾ç¤ºâ€œ*â€ï¼›
-k: ä»¥ KBï¼ˆåƒå­—èŠ‚ï¼‰ä¸ºå•ä½æ˜¾ç¤ºæ–‡ä»¶å¤§å°ï¼›
-l: ä»¥é•¿æ ¼å¼æ˜¾ç¤ºç›®å½•ä¸‹çš„å†…å®¹åˆ—è¡¨. è¾“å‡ºçš„ä¿¡æ¯ä»å·¦åˆ°å³ä¾æ¬¡åŒ…æ‹¬æ–‡ä»¶å, æ–‡ä»¶ç±»å‹ã€æƒé™æ¨¡å¼ã€ç¡¬è¿æ¥æ•°ã€æ‰€æœ‰è€…ã€ç»„ã€æ–‡ä»¶å¤§å°å’Œæ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´ç­‰ï¼›
-m: ç”¨â€œ,â€å·åŒºéš”æ¯ä¸ªæ–‡ä»¶å’Œç›®å½•çš„åç§°ï¼›
-n: ä»¥ç”¨æˆ·è¯†åˆ«ç å’Œç¾¤ç»„è¯†åˆ«ç æ›¿ä»£å…¶åç§°ï¼›
-r: ä»¥æ–‡ä»¶åååºæ’åˆ—å¹¶è¾“å‡ºç›®å½•å†…å®¹åˆ—è¡¨ï¼›
-s: æ˜¾ç¤ºæ–‡ä»¶å’Œç›®å½•çš„å¤§å°, ä»¥åŒºå—ä¸ºå•ä½ï¼›
-t: ç”¨æ–‡ä»¶å’Œç›®å½•çš„æ›´æ”¹æ—¶é—´æ’åºï¼›
-L: å¦‚æœé‡åˆ°æ€§è´¨ä¸ºç¬¦å·é“¾æ¥çš„æ–‡ä»¶æˆ–ç›®å½•, ç›´æ¥åˆ—å‡ºè¯¥é“¾æ¥æ‰€æŒ‡å‘çš„åŸå§‹æ–‡ä»¶æˆ–ç›®å½•ï¼›
-R: é€’å½’å¤„ç†, å°†æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åŠå­ç›®å½•ä¸€å¹¶å¤„ç†ï¼›
--full-time: åˆ—å‡ºå®Œæ•´çš„æ—¥æœŸä¸æ—¶é—´ï¼›
--color[=WHEN]: ä½¿ç”¨ä¸åŒçš„é¢œè‰²é«˜äº®æ˜¾ç¤ºä¸åŒç±»å‹çš„.
```

```bash
ls -sail
# æ­£åˆ™åŒ¹é… åŒ¹é…ä¸€ä¸ªå­—ç¬¦
ls -l fileName?
# åŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªå­—ç¬¦
ls -l fileName*
```

## ç®€å•å·¥å‚

ç®€å•å·¥å‚è·Ÿåå­—ä¸€æ ·, ç®€å•. ä½†æ˜¯å®ƒå´ä¸å±äºè®¾è®¡æ¨¡å¼ä¸­çš„ä¸€ç§, åªæ˜¯å› ä¸ºè½¯ä»¶å¼€å‘ä¸­ç”¨çš„æ¯”è¾ƒå¤š, è€Œä¸”å¤Ÿç®€å•, æ‰€ä»¥åªæ˜¯ä½œä¸ºå­¦ä¹ å…¶ä»–è®¾è®¡æ¨¡å¼çš„ä¾‹å­,
æ…¢æ…¢æ·±å…¥.

---

## æ²¡æœ‰ä½¿ç”¨è®¾è®¡æ¨¡å¼çš„ä¾‹å­

è®¾è®¡ä¸€ä¸ªè®¡ç®—å™¨, æ ¹æ®ä¼ å…¥çš„æ“ä½œç¬¦å’Œå¾…è¿ç®—çš„æ•°å­—, å¾—å‡ºç»“æœ.

code:

```java
public class Operation {
    private double numberA;
    private double numberB;
    private String operateType;
    public Operation(String operateType, double numberA, double numberB){
        // å¯¹å‚æ•°è¿›è¡Œæ£€æŸ¥æ“ä½œ
        this.numberA = numberA;
        this.numberB = numberB;
        this.operateType = operateType;
    }
    public double getResult(){
        double result = 0;
        switch (operateType) {
            case "+":
                return numberA + numberB;
            case "-":
                return numberA - numberB;
            case "*":
                return numberA * numberB;
            case "/":
                if(numberB == 0) return 0;
                return numberA / numberB;
        }
        return result;
    }
}
```

æ ¹æ®è¾“å…¥çš„æ“ä½œç¬¦åš switch åˆ†æ”¯, ä¸åŒçš„æ“ä½œç¬¦å¯¹åº”ä¸åŒçš„è®¡ç®—, æœ€åè¿”å›ç»“æœ.

### ç¼ºç‚¹

1. æ„é€ æ–¹æ³•ä¸­è´Ÿè´£çš„å¤ªå¤šæ“ä½œ, é€ æˆä»£ç å†—é•¿
2. å®¢æˆ·ç«¯åªèƒ½ä½¿ç”¨ new å…³é”®å­—æ¥åˆ›å»ºæ“ä½œç±»å¯¹è±¡, ä¸å®¢æˆ·ç«¯è€¦åˆè¾ƒé«˜, å¯¹è±¡çš„åˆ›å»ºå’Œä½¿ç”¨æ²¡æœ‰åˆ†ç¦».

## é‡æ„

ä½¿ç”¨ç®€å•å·¥å‚è¿›è¡Œé‡æ„.
æŠ½è±¡å‡ºä¸€ä¸ªæ“ä½œç±», å°†éƒ½éœ€è¦çš„å±æ€§å°è£…åˆ°è¿™ä¸ªç±»ä¸­, å…¶ä»–æ“ä½œç±»ç»§æ‰¿è¿™ä¸ªæ“ä½œç±», å¹¶ä¸”å®ç°ä¸åŒçš„æ“ä½œ.
ç„¶åä½¿ç”¨ç®€å•å·¥å‚æ ¹æ®ä¼ å…¥çš„æ“ä½œç±»å‹åˆ›å»ºä¸æ‡‚çš„æ“ä½œç±», æ˜¯åˆ›å»ºå’Œä½¿ç”¨åˆ†ç¦»,
å®¢æˆ·ç«¯åªéœ€è¦è°ƒç”¨å·¥å‚ç±»çš„å·¥å‚æ–¹æ³•ä¼ å…¥ç›¸åº”çš„å‚æ•°å³å¯å¾—åˆ°ä¸€ä¸ªå…·ä½“çš„æ“ä½œç±»è¿›è¡Œæ“ä½œ.

ç®€å•å·¥å‚å®šä¹‰:

ç®€å•å·¥å‚æ¨¡å¼ (Simple Factory Pattern): å®šä¹‰ä¸€ä¸ªå·¥å‚ç±», å®ƒå¯ä»¥æ ¹æ®å‚æ•°çš„ä¸åŒè¿”å›ä¸åŒç±»çš„å®ä¾‹, è¢«åˆ›å»ºçš„å®ä¾‹é€šå¸¸éƒ½å…·æœ‰å…±åŒçš„çˆ¶ç±».
å› ä¸ºåœ¨ç®€å•å·¥å‚æ¨¡å¼ä¸­ç”¨äºåˆ›å»ºå®ä¾‹çš„æ–¹æ³•æ˜¯é™æ€ (static) æ–¹æ³•, å› æ­¤ç®€å•å·¥å‚æ¨¡å¼åˆè¢«ç§°ä¸ºé™æ€å·¥å‚æ–¹æ³• (Static Factory Method) æ¨¡å¼, å®ƒå±äºç±»åˆ›å»ºå‹æ¨¡å¼.

### UML

![20241229154732_y9VrKljK.webp](https://cdn.dong4j.site/source/image/20241229154732_y9VrKljK.webp)

### ä»£ç å®ç°

Operation.java

```java
public class Operation {
    private double numberA;
    private double numberB;

    public Operation(){

    }

    public double getNumberA() {
        return numberA;
    }

    public void setNumberA(double numberA) {
        this.numberA = numberA;
    }

    public double getNumberB() {
        return numberB;
    }

    public void setNumberB(double numberB) {
        this.numberB = numberB;
    }

    public double getResult() throws Exception {
        return (double) 0;
    }
}
```

å…·ä½“æ“ä½œç±»:

```java
class OperationAdd extends Operation{
    @Override
    public double getResult(){
        return getNumberA()+ getNumberB();
    }
}

class OperationSub extends Operation{
    @Override
    public double getResult(){
        return getNumberA()- getNumberB();
    }
}

class OperationMul extends Operation{
    @Override
    public double getResult(){
        return getNumberA()* getNumberB();
    }
}

class OperationDiv extends Operation{
    @Override
    public double getResult() throws Exception {
        if(getNumberB() == 0){
            throw new Exception("é™¤æ•°ä¸èƒ½ä¸º0");
        }
        return getNumberA()/ getNumberB();
    }
}
```

OperationFactory.java ç®€å•å·¥å‚ç±», è´Ÿè´£åˆ›å»ºå…·ä½“æ“ä½œç±»å¯¹è±¡

```java
public class OperationFactory {
    public static Operation createOperation(String operationType) throws Exception {
        switch (operationType){
            case "+":
                return new OperationAdd();
            case "-":
                return new OperationSub();
            case "*":
                return new OperationMul();
            case "/":
                return new OperationDiv();
            default:
                throw new Exception("æ“ä½œä¸å…è®¸");
        }
    }
}
```

æµ‹è¯•ç±»ä½¿ç”¨

```java
public class OperationTest {
    /**
     * Simple factory test.
     * ä½¿ç”¨ç®€å•å·¥å‚è·å–æ“ä½œç±»å¯¹è±¡è¿›è¡Œè®¡ç®—
     * @throws Exception the exception
     */
    @Test
    public void simpleFactoryTest() throws Exception {
        com.dong4j.simple.Operation operation = OperationFactory.createOperation("+");
        operation.setNumberA(101.0);
        operation.setNumberB(10.0);
        System.out.println(operation.getResult());

        operation = OperationFactory.createOperation("-");
        operation.setNumberA(-0.01);
        operation.setNumberB(100.0);
        System.out.println(operation.getResult());

        operation = OperationFactory.createOperation("*");
        operation.setNumberA(20);
        operation.setNumberB(0.0);
        System.out.println(operation.getResult());

        operation = OperationFactory.createOperation("/");
        operation.setNumberA(10.0);
        operation.setNumberB(0.0);
        System.out.println(operation.getResult());
    }
}
```

### ä¼˜ç‚¹

ä½¿ç”¨ Factory æ¥ç”Ÿäº§æˆ‘ä»¬éœ€è¦çš„å…·ä½“æ“ä½œç±», ä¸éœ€è¦åœ¨ä½¿ç”¨ new æ¥åˆ›å»ºå¯¹è±¡, å°†åˆ›å»ºè¿‡ç¨‹å’Œä½¿ç”¨è¿‡ç¨‹åˆ†å¼€.
ä½†æ˜¯æ¯æ¬¡è¿›è¡Œå…¶ä»–æ“ä½œæ—¶, è¿˜æ˜¯éœ€è¦ä¼ å…¥å…·ä½“æ“ä½œç±»å‹è·å–å¯¹åº”çš„æ“ä½œç±»å¯¹è±¡, å³è¦ä¿®æ”¹å®¢æˆ·ç«¯ä»£ç .
æ‰€ä»¥è¿™é‡Œä½¿ç”¨ properties æ ¼å¼çš„é…ç½®æ–‡ä»¶, å°†éœ€è¦çš„å‚æ•°å†™åœ¨é…ç½®æ–‡ä»¶ä¸­, ä»¥ååªéœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯ (ä¹Ÿå¯ä»¥ä½¿ç”¨ xml)

#### æ­¥éª¤

æ·»åŠ  config.properties æ–‡ä»¶

```
operationType=+
```

ä½¿ç”¨ ConfigUtil è¯»å–é…ç½®æ–‡ä»¶

```java
public class ConfigUtil {
    public static String getOperationType(){
        Properties properties = new Properties();
        try {
            // config.properties å¿…é¡»æ”¾åœ¨ classpath è·¯å¾„ä¸‹æ‰èƒ½åŠ è½½.
            properties.load(ConfigUtil.class.getClassLoader().getResourceAsStream("config.properties"));
        } catch (IOException e) {
            e.printStackTrace();
        }
        return properties.getProperty("operationType");
    }
}
```

æµ‹è¯•

```java
public class OperationTest {
    /**
     * Config test.
     * ä½¿ç”¨é…ç½®å·¥å…·ç±»è¯»å–é…ç½®æ–‡ä»¶ä¿¡æ¯, é¿å…ä¿®æ”¹å®¢æˆ·ç«¯ä»£ç 
     * @throws Exception the exception
     */
    @Test
    public void configTest() throws Exception {
        // ä½¿ç”¨é…ç½®æ–‡ä»¶è·å–æ“ä½œç¬¦
        String operationType = ConfigUtil.getOperationType();
        com.dong4j.simple.Operation operation = OperationFactory.createOperation(operationType);
        operation.setNumberA(101.0);
        operation.setNumberB(10.0);
        System.out.println(operation.getResult());
    }
}
```

æ­¤æ—¶åªéœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯è·å–ä¸åŒæ“ä½œç±»å‹.

### ç®€å•å·¥å‚çš„ç®€åŒ–

å¯ä»¥å°†é™æ€å·¥å‚æ–¹æ³•ç§»åŠ¨åˆ° Operation ç±»ä¸­, å®¢æˆ·ç«¯æ‰§è¡Œé€šè¿‡çˆ¶ç±»çš„é™æ€å·¥å‚æ–¹æ³•, æ ¹æ®å‚æ•°çš„ä¸åŒåˆ›å»ºä¸åŒç±»å‹çš„å­ç±».

```java
public class Operation {
    private double numberA;
    private double numberB;

    public Operation(){

    }

    public double getNumberA() {
        return numberA;
    }

    public void setNumberA(double numberA) {
        this.numberA = numberA;
    }

    public double getNumberB() {
        return numberB;
    }

    public void setNumberB(double numberB) {
        this.numberB = numberB;
    }

    public double getResult() throws Exception {
        return (double) 0;
    }

    // å†æ¬¡ä¼˜åŒ–, å°†åˆ›å»ºå…·ä½“æ“ä½œç±»çš„æ–¹æ³•æ”¾åœ¨çˆ¶ç±»ä¸­, ä¸å†ä½¿ç”¨ç®€å•å·¥å‚
    public static Operation createOperation(String operationType) throws Exception {
        switch (operationType){
            case "+":
                return new OperationAdd();
            case "-":
                return new OperationSub();
            case "*":
                return new OperationMul();
            case "/":
                return new OperationDiv();
            default:
                throw new Exception("æ“ä½œä¸å…è®¸");
        }
    }
}
```

æµ‹è¯•

```java
public class OperationTest {
   /**
     * Operation static test.
     * å°†åˆ›å»ºå…·ä½“æ“ä½œç±»çš„é™æ€æ–¹æ³•ç®€åŒ–åˆ° Operation ç±»ä¸­, å»æ‰ OperationFactory.
     * @throws Exception the exception
     */
    @Test
    public void operationStaticTest() throws Exception {
        // ä½¿ç”¨é…ç½®æ–‡ä»¶è·å–æ“ä½œç¬¦
        String operationType = ConfigUtil.getOperationType();
        com.dong4j.simple.Operation operation = com.dong4j.simple.Operation.createOperation(operationType);
        operation.setNumberA(110.0);
        operation.setNumberB(11.0);
        System.out.println(operation.getResult());
    }
}
```

### æ€»ç»“

ç®€å•å·¥å‚æ¨¡å¼ä¸“é—¨æä¾›äº†å·¥å‚ç±»ç”¨äºåˆ›å»ºå¯¹è±¡, å°†å¯¹è±¡çš„åˆ›å»ºå’Œå¯¹è±¡çš„ä½¿ç”¨åˆ†å¼€

**ä¼˜ç‚¹:**

1. å·¥å‚ç±»è´Ÿè´£åˆ›å»ºå…·ä½“äº§å“ç±», å®¢æˆ·ç«¯å¯ä»¥ä¸ç”¨åˆ›å»ºå¯¹è±¡, ç›´æ¥ä½¿ç”¨å³å¯.
2. å®¢æˆ·ç«¯æ— éœ€çŸ¥é“æ‰€åˆ›å»ºå…·ä½“äº§å“åç§°, åªéœ€è¦çŸ¥é“å…·ä½“äº§å“ç±»æ‰€å¯¹åº”çš„å‚æ•°å³å¯, å‡å°‘äº†å¯¹äºå¤æ‚ç±»åçš„è®°å¿†.
3. é€šè¿‡å¼•å…¥é…ç½®æ–‡ä»¶, å¯ä»¥ä¸ä¿®æ”¹å®¢æˆ·ç«¯çš„æƒ…å†µåŠ æ›´æ¢å…·ä½“äº§å“ç±». æé«˜äº†ç³»ç»Ÿçµæ´»æ€§

**ç¼ºç‚¹:**

1. ä½¿ç”¨ç®€å•å·¥å‚å¢åŠ äº†ç±»çš„ä¸ªæ•°, æ˜¯ç³»ç»Ÿå˜å¾—å¤æ‚, ä¸ä¾¿äºç†è§£.
2. ç³»ç»Ÿæ‰©å±•å›°éš¾, å¦‚æœéœ€è¦æ–°å¢æ“ä½œç±»å‹, å°†ä¸å¾—ä¸ä¿®æ”¹å·¥å‚ç±»çš„é€»è¾‘, å¢åŠ æ–°çš„åˆ¤æ–­. ä¸åˆ©äºç³»ç»Ÿçš„æ‰©å±•å’Œç»´æŠ¤.

## å¼•ç”¨

- [http://blog.csdn.net/lovelion/article/details/9300337](http://blog.csdn.net/lovelion/article/details/9300337)
- [http://blog.csdn.net/lovelion/article/details/9300549](http://blog.csdn.net/lovelion/article/details/9300549)
- [http://blog.csdn.net/lovelion/article/details/9300657](http://blog.csdn.net/lovelion/article/details/9300657)
- [http://blog.csdn.net/lovelion/article/details/9300731](http://blog.csdn.net/lovelion/article/details/9300731)

## ä»£ç ä¸‹è½½

[https://github.com/dong4j/pattern_code](https://github.com/dong4j/pattern_code)

## [ä½¿ç”¨ validate API éªŒè¯ Elasticsearch æŸ¥è¯¢è¯­å¥çš„åˆæ³•æ€§ä¸è§£é‡Š](https://blog.dong4j.site/posts/f20ffdb.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## éªŒè¯æŸ¥è¯¢

æŸ¥è¯¢è¯­å¥å¯ä»¥å˜å¾—éå¸¸å¤æ‚ï¼Œç‰¹åˆ«æ˜¯ä¸ä¸åŒçš„åˆ†æå™¨å’Œå­—æ®µæ˜ å°„ç›¸ç»“åˆåï¼Œå°±ä¼šæœ‰äº›éš¾åº¦ã€‚  
validate API å¯ä»¥éªŒè¯ä¸€æ¡æŸ¥è¯¢è¯­å¥æ˜¯å¦åˆæ³•ã€‚

```json
GET /gb/tweet/_validate/query
{
   "query": {
      "tweet" : {
         "match" : "really powerful"
      }
   }
}
```

ä»¥ä¸Šè¯·æ±‚çš„è¿”å›å€¼å‘Šè¯‰æˆ‘ä»¬è¿™æ¡è¯­å¥æ˜¯éæ³•çš„ï¼š

```json
{
  "valid": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "failed": 0
  }
}
```

### ç†è§£é”™è¯¯ä¿¡æ¯

æƒ³çŸ¥é“è¯­å¥éæ³•çš„å…·ä½“é”™è¯¯ä¿¡æ¯ï¼Œéœ€è¦åŠ ä¸Š explain å‚æ•°ï¼š

```json
GET /gb/tweet/_validate/query?explain <1>
{
   "query": {
      "tweet" : {
         "match" : "really powerful"
      }
   }
}
```

> <1> explain å‚æ•°å¯ä»¥æä¾›è¯­å¥é”™è¯¯çš„æ›´å¤šè¯¦æƒ…ã€‚  
> å¾ˆæ˜¾ç„¶ï¼Œæˆ‘ä»¬æŠŠ query è¯­å¥çš„ match ä¸å­—æ®µåä½ç½®å¼„åäº†ï¼š

```json
{
  "valid" :     false,
  "_shards" :   { ... },
  "explanations" : [ {
    "index" :   "gb",
    "valid" :   false,
    "error" :   "org.elasticsearch.index.query.QueryParsingException:
                 [gb] No query registered for [tweet]"
  } ]
}
```

### ç†è§£æŸ¥è¯¢è¯­å¥

å¦‚æœæ˜¯åˆæ³•è¯­å¥çš„è¯ï¼Œä½¿ç”¨ explain å‚æ•°å¯ä»¥è¿”å›ä¸€ä¸ªå¸¦æœ‰æŸ¥è¯¢è¯­å¥çš„å¯é˜…è¯»æè¿°ï¼Œ å¯ä»¥å¸®åŠ©äº†è§£æŸ¥è¯¢è¯­å¥åœ¨ ES ä¸­æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼š

```json
GET /_validate/query?explain
{
   "query": {
      "match" : {
         "tweet" : "really powerful"
      }
   }
}
```

explanation ä¼šä¸ºæ¯ä¸€ä¸ªç´¢å¼•è¿”å›ä¸€æ®µæè¿°ï¼Œå› ä¸ºæ¯ä¸ªç´¢å¼•ä¼šæœ‰ä¸åŒçš„æ˜ å°„å…³ç³»å’Œåˆ†æå™¨ï¼š

```json
{
  "valid" :         true,
  "_shards" :       { ... },
  "explanations" : [ {
    "index" :       "us",
    "valid" :       true,
    "explanation" : "tweet:really tweet:powerful"
  }, {
    "index" :       "gb",
    "valid" :       true,
    "explanation" : "tweet:really tweet:power"
  } ]
}
```

ä»è¿”å›çš„ explanation ä½ ä¼šçœ‹åˆ° match æ˜¯å¦‚ä½•ä¸ºæŸ¥è¯¢å­—ç¬¦ä¸² "really powerful" è¿›è¡ŒæŸ¥è¯¢çš„ï¼Œ é¦–å…ˆï¼Œå®ƒè¢«æ‹†åˆ†æˆä¸¤ä¸ªç‹¬ç«‹çš„è¯åˆ†åˆ«åœ¨ tweet å­—æ®µä¸­è¿›è¡ŒæŸ¥è¯¢ã€‚

è€Œä¸”ï¼Œåœ¨ç´¢å¼• us ä¸­è¿™ä¸¤ä¸ªè¯ä¸º "really" å’Œ "powerful"ï¼Œåœ¨ç´¢å¼• gb ä¸­è¢«æ‹†åˆ†æˆ "really" å’Œ "power"ã€‚ è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨ç´¢å¼• gb ä¸­ä½¿ç”¨äº† english åˆ†æå™¨ã€‚

## [æŒæ¡Elasticsearchï¼Œä»ç†è§£æŸ¥è¯¢å’Œè¿‡æ»¤å¼€å§‹](https://blog.dong4j.site/posts/f56310d4.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## æŸ¥è¯¢è¯­å¥å’Œè¿‡æ»¤è¯­å¥åˆå¹¶

æŸ¥è¯¢è¯­å¥å’Œè¿‡æ»¤è¯­å¥å¯ä»¥æ”¾åœ¨å„è‡ªçš„ä¸Šä¸‹æ–‡ä¸­ã€‚ åœ¨ ElasticSearch API ä¸­æˆ‘ä»¬ä¼šçœ‹åˆ°è®¸å¤šå¸¦æœ‰ query æˆ– filter çš„è¯­å¥ã€‚ è¿™äº›è¯­å¥æ—¢å¯ä»¥åŒ…å«å•æ¡ query è¯­å¥ï¼Œä¹Ÿå¯ä»¥åŒ…å«ä¸€æ¡ filter å­å¥ã€‚ æ¢å¥è¯è¯´ï¼Œè¿™äº›è¯­å¥éœ€è¦é¦–å…ˆåˆ›å»ºä¸€ä¸ª query æˆ– filter çš„ä¸Šä¸‹æ–‡å…³ç³»ã€‚

å¤åˆæŸ¥è¯¢è¯­å¥å¯ä»¥åŠ å…¥å…¶ä»–æŸ¥è¯¢å­å¥ï¼Œå¤åˆè¿‡æ»¤è¯­å¥ä¹Ÿå¯ä»¥åŠ å…¥å…¶ä»–è¿‡æ»¤å­å¥ã€‚ é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€æ¡æŸ¥è¯¢è¯­å¥éœ€è¦è¿‡æ»¤è¯­å¥çš„è¾…åŠ©ï¼Œå…¨æ–‡æœ¬æœç´¢é™¤å¤–ã€‚

æ‰€ä»¥è¯´ï¼ŒæŸ¥è¯¢è¯­å¥å¯ä»¥åŒ…å«è¿‡æ»¤å­å¥ï¼Œåä¹‹äº¦ç„¶ã€‚ ä»¥ä¾¿äºæˆ‘ä»¬åˆ‡æ¢ query æˆ– filter çš„ä¸Šä¸‹æ–‡ã€‚è¿™å°±è¦æ±‚æˆ‘ä»¬åœ¨è¯»æ‡‚éœ€æ±‚çš„åŒæ—¶æ„é€ æ­£ç¡®æœ‰æ•ˆçš„è¯­å¥ã€‚

### å¸¦è¿‡æ»¤çš„æŸ¥è¯¢è¯­å¥

è¿‡æ»¤ä¸€æ¡æŸ¥è¯¢è¯­å¥

æ¯”å¦‚è¯´æˆ‘ä»¬æœ‰è¿™æ ·ä¸€æ¡æŸ¥è¯¢è¯­å¥:

```json
{
  "match": {
    "email": "business opportunity"
  }
}
```

ç„¶åæˆ‘ä»¬æƒ³è¦è®©è¿™æ¡è¯­å¥åŠ å…¥ term è¿‡æ»¤ï¼Œåœ¨æ”¶ä¿¡ç®±ä¸­åŒ¹é…é‚®ä»¶ï¼š

```json
{
  "term": {
    "folder": "inbox"
  }
}
```

search API ä¸­åªèƒ½åŒ…å« query è¯­å¥ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨ filtered æ¥åŒæ—¶åŒ…å« "query" å’Œ "filter" å­å¥ï¼š

```json
{
  "filtered": {
    "query": { "match": { "email": "business opportunity" } },
    "filter": { "term": { "folder": "inbox" } }
  }
}
```

æˆ‘ä»¬åœ¨å¤–å±‚å†åŠ å…¥ query çš„ä¸Šä¸‹æ–‡å…³ç³»ï¼š

```json
GET /_search
{
    "query": {
        "filtered": {
            "query":  { "match": { "email": "business opportunity" }},
            "filter": { "term": { "folder": "inbox" }}
        }
    }
}
```

### å•æ¡è¿‡æ»¤è¯­å¥

åœ¨ query ä¸Šä¸‹æ–‡ä¸­ï¼Œå¦‚æœä½ åªéœ€è¦ä¸€æ¡è¿‡æ»¤è¯­å¥ï¼Œæ¯”å¦‚åœ¨åŒ¹é…å…¨éƒ¨é‚®ä»¶çš„æ—¶å€™ï¼Œä½ å¯ä»¥ çœç•¥ query å­å¥ï¼š

```json
GET /_search
{
    "query": {
        "filtered": {
            "filter":   { "term": { "folder": "inbox" }}
        }
    }
}
```

å¦‚æœä¸€æ¡æŸ¥è¯¢è¯­å¥æ²¡æœ‰æŒ‡å®šæŸ¥è¯¢èŒƒå›´ï¼Œé‚£ä¹ˆå®ƒé»˜è®¤ä½¿ç”¨ match_all æŸ¥è¯¢ï¼Œæ‰€ä»¥ä¸Šé¢è¯­å¥ çš„å®Œæ•´å½¢å¼å¦‚ä¸‹ï¼š

```json
GET /_search
{
    "query": {
        "filtered": {
            "query":    { "match_all": {}},
            "filter":   { "term": { "folder": "inbox" }}
        }
    }
}
```

### æŸ¥è¯¢è¯­å¥ä¸­çš„è¿‡æ»¤

æœ‰æ—¶å€™ï¼Œä½ éœ€è¦åœ¨ filter çš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ä¸€ä¸ª query å­å¥ã€‚ä¸‹é¢çš„è¯­å¥å°±æ˜¯ä¸€æ¡å¸¦æœ‰æŸ¥è¯¢åŠŸèƒ½ çš„è¿‡æ»¤è¯­å¥ï¼Œ è¿™æ¡è¯­å¥å¯ä»¥è¿‡æ»¤æ‰çœ‹èµ·æ¥åƒåƒåœ¾é‚®ä»¶çš„æ–‡æ¡£ï¼š

```json
GET /_search
{
    "query": {
        "filtered": {
            "filter":   {
                "bool": {
                    "must":     { "term":  { "folder": "inbox" }},
                    "must_not": {
                        "query": { <1>
                            "match": { "email": "urgent business proposal" }
                        }
                    }
                }
            }
        }
    }
}
```

> <1> è¿‡æ»¤è¯­å¥ä¸­å¯ä»¥ä½¿ç”¨ query æŸ¥è¯¢çš„æ–¹å¼ä»£æ›¿ bool è¿‡æ»¤å­å¥ã€‚  
> æç¤ºï¼š æˆ‘ä»¬å¾ˆå°‘ç”¨åˆ°çš„è¿‡æ»¤è¯­å¥ä¸­åŒ…å«æŸ¥è¯¢ï¼Œä¿ç•™è¿™ç§ç”¨æ³•åªæ˜¯ä¸ºäº†è¯­æ³•çš„å®Œæ•´æ€§ã€‚ åªæœ‰åœ¨è¿‡æ»¤ä¸­ç”¨åˆ°å…¨æ–‡æœ¬åŒ¹é…çš„æ—¶å€™æ‰ä¼šä½¿ç”¨è¿™ç§ç»“æ„ã€‚

## [Elasticsearchè¿›é˜¶ï¼šé«˜æ•ˆçš„è¿‡æ»¤æ¡ä»¶ä¸ç²¾ç¡®æŸ¥è¯¢](https://blog.dong4j.site/posts/8b9030ff.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

æŸ¥è¯¢è¿‡æ»¤å…³é”®å­—

### term è¿‡æ»¤

term ä¸»è¦ç”¨äºç²¾ç¡®åŒ¹é…å“ªäº›å€¼ï¼Œæ¯”å¦‚æ•°å­—ï¼Œæ—¥æœŸï¼Œå¸ƒå°”å€¼æˆ– not_analyzed çš„å­—ç¬¦ä¸² (æœªç»åˆ†æçš„æ–‡æœ¬æ•°æ®ç±»å‹)ï¼š

```json
{ "term": { "age":    26           }}
{ "term": { "date":   "2014-09-01" }}
{ "term": { "public": true         }}
{ "term": { "tag":    "full_text"  }}
```

### terms è¿‡æ»¤

terms è·Ÿ term æœ‰ç‚¹ç±»ä¼¼ï¼Œä½† terms å…è®¸æŒ‡å®šå¤šä¸ªåŒ¹é…æ¡ä»¶ã€‚ å¦‚æœæŸä¸ªå­—æ®µæŒ‡å®šäº†å¤šä¸ªå€¼ï¼Œé‚£ä¹ˆæ–‡æ¡£éœ€è¦ä¸€èµ·å»åšåŒ¹é…ï¼š

```json
{
  "terms": {
    "tag": ["search", "full_text", "nosql"]
  }
}
```

### range è¿‡æ»¤ (èŒƒå›´è¿‡æ»¤)

range è¿‡æ»¤å…è®¸æˆ‘ä»¬æŒ‰ç…§æŒ‡å®šèŒƒå›´æŸ¥æ‰¾ä¸€æ‰¹æ•°æ®ï¼š

```json
{
  "range": {
    "age": {
      "gte": 20,
      "lt": 30
    }
  }
}
```

èŒƒå›´æ“ä½œç¬¦åŒ…å«ï¼š  
gt :: å¤§äº  
gte:: å¤§äºç­‰äº  
lt :: å°äº  
lte:: å°äºç­‰äº

### exists å’Œ missing è¿‡æ»¤

exists å’Œ missing è¿‡æ»¤å¯ä»¥ç”¨äºæŸ¥æ‰¾æ–‡æ¡£ä¸­æ˜¯å¦åŒ…å«æŒ‡å®šå­—æ®µæˆ–æ²¡æœ‰æŸä¸ªå­—æ®µï¼Œç±»ä¼¼äº SQL è¯­å¥ä¸­çš„ IS_NULL æ¡ä»¶

```json
{
  "exists": {
    "field": "title"
  }
}
```

è¿™ä¸¤ä¸ªè¿‡æ»¤åªæ˜¯é’ˆå¯¹å·²ç»æŸ¥å‡ºä¸€æ‰¹æ•°æ®æ¥ï¼Œä½†æ˜¯æƒ³åŒºåˆ†å‡ºæŸä¸ªå­—æ®µæ˜¯å¦å­˜åœ¨çš„æ—¶å€™ä½¿ç”¨ã€‚

### bool è¿‡æ»¤

bool è¿‡æ»¤å¯ä»¥ç”¨æ¥åˆå¹¶å¤šä¸ªè¿‡æ»¤æ¡ä»¶æŸ¥è¯¢ç»“æœçš„å¸ƒå°”é€»è¾‘ï¼Œå®ƒåŒ…å«ä¸€ä¸‹æ“ä½œç¬¦ï¼š

must :: å¤šä¸ªæŸ¥è¯¢æ¡ä»¶çš„å®Œå…¨åŒ¹é…,ç›¸å½“äº andã€‚  
must_not :: å¤šä¸ªæŸ¥è¯¢æ¡ä»¶çš„ç›¸ååŒ¹é…ï¼Œç›¸å½“äº notã€‚  
should :: è‡³å°‘æœ‰ä¸€ä¸ªæŸ¥è¯¢æ¡ä»¶åŒ¹é…, ç›¸å½“äº orã€‚

è¿™äº›å‚æ•°å¯ä»¥åˆ†åˆ«ç»§æ‰¿ä¸€ä¸ªè¿‡æ»¤æ¡ä»¶æˆ–è€…ä¸€ä¸ªè¿‡æ»¤æ¡ä»¶çš„æ•°ç»„ï¼š

```json
{
  "bool": {
    "must": { "term": { "folder": "inbox" } },
    "must_not": { "term": { "tag": "spam" } },
    "should": [{ "term": { "starred": true } }, { "term": { "unread": true } }]
  }
}
```

### bool æŸ¥è¯¢

bool æŸ¥è¯¢ä¸ bool è¿‡æ»¤ç›¸ä¼¼ï¼Œç”¨äºåˆå¹¶å¤šä¸ªæŸ¥è¯¢å­å¥ã€‚ä¸åŒçš„æ˜¯ï¼Œbool è¿‡æ»¤å¯ä»¥ç›´æ¥ç»™å‡ºæ˜¯å¦åŒ¹é…æˆåŠŸï¼Œ è€Œ bool æŸ¥è¯¢è¦è®¡ç®—æ¯ä¸€ä¸ªæŸ¥è¯¢å­å¥çš„ `_score` ï¼ˆç›¸å…³æ€§åˆ†å€¼ï¼‰ã€‚

```
must:: æŸ¥è¯¢æŒ‡å®šæ–‡æ¡£ä¸€å®šè¦è¢«åŒ…å«ã€‚
must_not:: æŸ¥è¯¢æŒ‡å®šæ–‡æ¡£ä¸€å®šä¸è¦è¢«åŒ…å«ã€‚
should:: æŸ¥è¯¢æŒ‡å®šæ–‡æ¡£ï¼Œæœ‰åˆ™å¯ä»¥ä¸ºæ–‡æ¡£ç›¸å…³æ€§åŠ åˆ†ã€‚
```

ä»¥ä¸‹æŸ¥è¯¢å°†ä¼šæ‰¾åˆ° title å­—æ®µä¸­åŒ…å« "how to make millions"ï¼Œå¹¶ä¸” "tag" å­—æ®µæ²¡æœ‰è¢«æ ‡ä¸º spamã€‚ å¦‚æœæœ‰æ ‡è¯†ä¸º "starred" æˆ–è€…å‘å¸ƒæ—¥æœŸä¸º 2014 å¹´ä¹‹å‰ï¼Œé‚£ä¹ˆè¿™äº›åŒ¹é…çš„æ–‡æ¡£å°†æ¯”åŒç±»ç½‘ç«™ç­‰çº§é«˜ï¼š

```json
{
  "bool": {
    "must": { "match": { "title": "how to make millions" } },
    "must_not": { "match": { "tag": "spam" } },
    "should": [
      { "match": { "tag": "starred" } },
      { "range": { "date": { "gte": "2014-01-01" } } }
    ]
  }
}
```

> æç¤ºï¼š å¦‚æœ bool æŸ¥è¯¢ä¸‹æ²¡æœ‰ must å­å¥ï¼Œé‚£è‡³å°‘åº”è¯¥æœ‰ä¸€ä¸ª should å­å¥ã€‚ä½†æ˜¯ å¦‚æœæœ‰ must å­å¥ï¼Œé‚£ä¹ˆæ²¡æœ‰ should å­å¥ä¹Ÿå¯ä»¥è¿›è¡ŒæŸ¥è¯¢ã€‚

### match_all æŸ¥è¯¢

ä½¿ç”¨ match_all å¯ä»¥æŸ¥è¯¢åˆ°æ‰€æœ‰æ–‡æ¡£ï¼Œæ˜¯æ²¡æœ‰æŸ¥è¯¢æ¡ä»¶ä¸‹çš„é»˜è®¤è¯­å¥ã€‚

```json
{
  "match_all": {}
}
```

æ­¤æŸ¥è¯¢å¸¸ç”¨äºåˆå¹¶è¿‡æ»¤æ¡ä»¶ã€‚ æ¯”å¦‚è¯´ä½ éœ€è¦æ£€ç´¢æ‰€æœ‰çš„é‚®ç®±,æ‰€æœ‰çš„æ–‡æ¡£ç›¸å…³æ€§éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥å¾—åˆ°çš„ `_score` ä¸º 1

### match æŸ¥è¯¢

match æŸ¥è¯¢æ˜¯ä¸€ä¸ªæ ‡å‡†æŸ¥è¯¢ï¼Œä¸ç®¡ä½ éœ€è¦å…¨æ–‡æœ¬æŸ¥è¯¢è¿˜æ˜¯ç²¾ç¡®æŸ¥è¯¢åŸºæœ¬ä¸Šéƒ½è¦ç”¨åˆ°å®ƒã€‚  
å¦‚æœä½ ä½¿ç”¨ match æŸ¥è¯¢ä¸€ä¸ªå…¨æ–‡æœ¬å­—æ®µï¼Œå®ƒä¼šåœ¨çœŸæ­£æŸ¥è¯¢ä¹‹å‰ç”¨åˆ†æå™¨å…ˆåˆ†æ match ä¸€ä¸‹æŸ¥è¯¢å­—ç¬¦ï¼š

```json
{
  "match": {
    "tweet": "About Search"
  }
}
```

å¦‚æœç”¨ match ä¸‹æŒ‡å®šäº†ä¸€ä¸ªç¡®åˆ‡å€¼ï¼Œåœ¨é‡åˆ°æ•°å­—ï¼Œæ—¥æœŸï¼Œå¸ƒå°”å€¼æˆ–è€… not_analyzed çš„å­—ç¬¦ä¸²æ—¶ï¼Œå®ƒå°†ä¸ºä½ æœç´¢ä½ ç»™å®šçš„å€¼ï¼š

```json
{ "match": { "age":    26           }}
{ "match": { "date":   "2014-09-01" }}
{ "match": { "public": true         }}
{ "match": { "tag":    "full_text"  }}
```

> æç¤ºï¼š åšç²¾ç¡®åŒ¹é…æœç´¢æ—¶ï¼Œä½ æœ€å¥½ç”¨è¿‡æ»¤è¯­å¥ï¼Œå› ä¸ºè¿‡æ»¤è¯­å¥å¯ä»¥ç¼“å­˜æ•°æ®ã€‚

ä¸åƒæˆ‘ä»¬åœ¨ã€Šç®€å•æœç´¢ã€‹ä¸­ä»‹ç»çš„å­—ç¬¦æŸ¥è¯¢ï¼Œmatch æŸ¥è¯¢ä¸å¯ä»¥ç”¨ç±»ä¼¼ "+usid:2 +tweet:search" è¿™æ ·çš„è¯­å¥ã€‚ å®ƒåªèƒ½å°±æŒ‡å®šæŸä¸ªç¡®åˆ‡å­—æ®µæŸä¸ªç¡®åˆ‡çš„å€¼è¿›è¡Œæœç´¢ï¼Œè€Œä½ è¦åšçš„å°±æ˜¯ä¸ºå®ƒæŒ‡å®šæ­£ç¡®çš„å­—æ®µåä»¥é¿å…è¯­æ³•é”™è¯¯ã€‚

### multi_match æŸ¥è¯¢

multi_match æŸ¥è¯¢å…è®¸ä½ åš match æŸ¥è¯¢çš„åŸºç¡€ä¸ŠåŒæ—¶æœç´¢å¤šä¸ªå­—æ®µï¼š

```json
{
  "multi_match": {
    "query": "full text search",
    "fields": ["title", "body"]
  }
}
```

## [å…³ç³»å‹æ•°æ®åº“ä¸Elasticsearchå¯¹æ¯”ï¼šç´¢å¼•ã€ç±»å‹å’Œæ–‡æ¡£è§£æ](https://blog.dong4j.site/posts/24a1ab9d.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

å…³ç³»å‹æ•°æ®åº“å’Œ ES å¯¹æ¯”

```
Relational DB -> Databases -> Tables -> Rows -> Columns
Elasticsearch -> Indexing   -> Types  -> Documents -> Fields
```

Elasticsearch é›†ç¾¤å¯ä»¥åŒ…å«å¤šä¸ªç´¢å¼• (indices)ï¼ˆæ•°æ®åº“ï¼‰ï¼Œæ¯ä¸€ä¸ªç´¢å¼•å¯ä»¥åŒ…å«å¤šä¸ªç±»å‹ (types)ï¼ˆè¡¨ï¼‰ï¼Œæ¯ä¸€ä¸ªç±»å‹åŒ…å«å¤šä¸ªæ–‡æ¡£ (documents)ï¼ˆè¡Œï¼‰ï¼Œç„¶åæ¯ä¸ªæ–‡æ¡£åŒ…å«å¤šä¸ªå­—æ®µ (Fields)ï¼ˆåˆ—ï¼‰

> # ã€Œç´¢å¼•ã€å«ä¹‰çš„åŒºåˆ†

> ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°ç´¢å¼• (index) è¿™ä¸ªè¯åœ¨ Elasticsearch ä¸­æœ‰ç€ä¸åŒçš„å«ä¹‰ï¼Œæ‰€ä»¥æœ‰å¿…è¦åœ¨æ­¤åšä¸€ä¸‹åŒºåˆ†:  
> ç´¢å¼•ï¼ˆåè¯ï¼‰ å¦‚ä¸Šæ–‡æ‰€è¿°ï¼Œä¸€ä¸ªç´¢å¼• (index) å°±åƒæ˜¯ä¼ ç»Ÿå…³ç³»æ•°æ®åº“ä¸­çš„æ•°æ®åº“ï¼Œå®ƒæ˜¯ç›¸å…³æ–‡æ¡£å­˜å‚¨çš„åœ°æ–¹ï¼Œindex çš„å¤æ•°æ˜¯ indices æˆ– indexesã€‚  
> ç´¢å¼•ï¼ˆåŠ¨è¯ï¼‰ ã€Œç´¢å¼•ä¸€ä¸ªæ–‡æ¡£ã€è¡¨ç¤ºæŠŠä¸€ä¸ªæ–‡æ¡£å­˜å‚¨åˆ°ç´¢å¼•ï¼ˆåè¯ï¼‰é‡Œï¼Œä»¥ä¾¿å®ƒå¯ä»¥è¢«æ£€ç´¢æˆ–è€…æŸ¥è¯¢ã€‚è¿™å¾ˆåƒ SQL ä¸­çš„ INSERT å…³é”®å­—ï¼Œå·®åˆ«æ˜¯ï¼Œå¦‚æœæ–‡æ¡£å·²ç»å­˜åœ¨ï¼Œæ–°çš„æ–‡æ¡£å°†è¦†ç›–æ—§çš„æ–‡æ¡£ã€‚  
> å€’æ’ç´¢å¼• ä¼ ç»Ÿæ•°æ®åº“ä¸ºç‰¹å®šåˆ—å¢åŠ ä¸€ä¸ªç´¢å¼•ï¼Œä¾‹å¦‚ B-Tree ç´¢å¼•æ¥åŠ é€Ÿæ£€ç´¢ã€‚Elasticsearch å’Œ Lucene ä½¿ç”¨ä¸€ç§å«åšå€’æ’ç´¢å¼• (inverted index) çš„æ•°æ®ç»“æ„æ¥è¾¾åˆ°ç›¸åŒç›®çš„ã€‚

åˆ›å»ºä¸€ä¸ªå‘˜å·¥ä¿¡æ¯

```json
PUT /megacorp/employee/1
{
    "first_name" : "John",
    "last_name" :  "Smith",
    "age" :        25,
    "about" :      "I love to go rock climbing",
    "interests": [ "sports", "music" ]
}
```

**åˆ é™¤ä½¿ç”¨** delete  
**æŸ¥è¯¢** ä½¿ç”¨ get  
**æŸ¥è¯¢å…¨éƒ¨** åœ¨æœ€ååŠ ä¸Š `_search`
**è‡ªåŠ¨ç”Ÿæˆ id** ä½¿ç”¨ post

> è‡ªåŠ¨ç”Ÿæˆçš„ ID æœ‰ 22 ä¸ªå­—ç¬¦é•¿ï¼ŒURL-safe, Base64-encoded string universally unique identifiers, æˆ–è€…å« UUIDsã€‚

**æ ¹æ®å…³é”®å­—æŸ¥è¯¢**  
`GET /megacorp/employee/_search?q=last_name:Smith`

æˆ‘ä»¬åœ¨è¯·æ±‚ä¸­ä¾æ—§ä½¿ç”¨ `_search` å…³é”®å­—ï¼Œç„¶åå°†æŸ¥è¯¢è¯­å¥ä¼ é€’ç»™å‚æ•° q=ã€‚

Elasticsearch è‡´åŠ›äºéšè—åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¤æ‚æ€§ã€‚ä»¥ä¸‹è¿™äº›æ“ä½œéƒ½æ˜¯åœ¨åº•å±‚è‡ªåŠ¨å®Œæˆçš„ï¼š

> å°†ä½ çš„æ–‡æ¡£åˆ†åŒºåˆ°ä¸åŒçš„å®¹å™¨æˆ–è€…åˆ†ç‰‡ (shards) ä¸­ï¼Œå®ƒä»¬å¯ä»¥å­˜åœ¨äºä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹ä¸­ã€‚  
> å°†åˆ†ç‰‡å‡åŒ€çš„åˆ†é…åˆ°å„ä¸ªèŠ‚ç‚¹ï¼Œå¯¹ç´¢å¼•å’Œæœç´¢åšè´Ÿè½½å‡è¡¡ã€‚  
> å†—ä½™æ¯ä¸€ä¸ªåˆ†ç‰‡ï¼Œé˜²æ­¢ç¡¬ä»¶æ•…éšœé€ æˆçš„æ•°æ®ä¸¢å¤±ã€‚  
> å°†é›†ç¾¤ä¸­ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„è¯·æ±‚è·¯ç”±åˆ°ç›¸åº”æ•°æ®æ‰€åœ¨çš„èŠ‚ç‚¹ã€‚  
> æ— è®ºæ˜¯å¢åŠ èŠ‚ç‚¹ï¼Œè¿˜æ˜¯ç§»é™¤èŠ‚ç‚¹ï¼Œåˆ†ç‰‡éƒ½å¯ä»¥åšåˆ°æ— ç¼çš„æ‰©å±•å’Œè¿ç§»ã€‚

## åˆ›å»ºä¸€ä¸ªæ–°æ–‡æ¡£

> å½“ç´¢å¼•ä¸€ä¸ªæ–‡æ¡£ï¼Œæˆ‘ä»¬å¦‚ä½•ç¡®å®šæ˜¯å®Œå…¨åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„è¿˜æ˜¯è¦†ç›–äº†ä¸€ä¸ªå·²ç»å­˜åœ¨çš„å‘¢ï¼Ÿ  
> è¯·è®°ä½ `_index`ã€`_type`ã€`_id` ä¸‰è€…å”¯ä¸€ç¡®å®šä¸€ä¸ªæ–‡æ¡£ã€‚æ‰€ä»¥è¦æƒ³ä¿è¯æ–‡æ¡£æ˜¯æ–°åŠ å…¥çš„ï¼Œæœ€ç®€å•çš„æ–¹å¼æ˜¯ä½¿ç”¨ POST æ–¹æ³•è®© Elasticsearch è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€ `_id`ï¼š

```json
POST /website/blog/
{ ... }
```

ç„¶è€Œï¼Œå¦‚æœæƒ³ä½¿ç”¨è‡ªå®šä¹‰çš„ `_id`ï¼Œæˆ‘ä»¬å¿…é¡»å‘Šè¯‰ Elasticsearch åº”è¯¥åœ¨ `_index`ã€`_type`ã€`_id` ä¸‰è€…éƒ½ä¸åŒæ—¶æ‰æ¥å—è¯·æ±‚ã€‚ä¸ºäº†åšåˆ°è¿™ç‚¹æœ‰ä¸¤ç§æ–¹æ³•ï¼Œå®ƒä»¬å…¶å®åšçš„æ˜¯åŒä¸€ä»¶äº‹æƒ…ã€‚ä½ å¯ä»¥é€‰æ‹©é€‚åˆè‡ªå·±çš„æ–¹å¼ï¼š1

1. ç¬¬ä¸€ç§æ–¹æ³•ä½¿ç”¨ op_type æŸ¥è¯¢å‚æ•°ï¼š

```json
PUT /website/blog/123?op_type=create
{ ... }
```

2. æˆ–è€…ç¬¬äºŒç§æ–¹æ³•æ˜¯åœ¨ URL ååŠ  `/_create` åšä¸ºç«¯ç‚¹ï¼š

```json
PUT /website/blog/123/_create
{ ... }
```

å¦‚æœè¯·æ±‚æˆåŠŸçš„åˆ›å»ºäº†ä¸€ä¸ªæ–°æ–‡æ¡£ï¼ŒElasticsearch å°†è¿”å›æ­£å¸¸çš„å…ƒæ•°æ®ä¸”å“åº”çŠ¶æ€ç æ˜¯ 201 Createdã€‚

å¦ä¸€æ–¹é¢ï¼Œå¦‚æœåŒ…å«ç›¸åŒçš„ `_index`ã€`_type` å’Œ `_id` çš„æ–‡æ¡£å·²ç»å­˜åœ¨ï¼ŒElasticsearch å°†è¿”å› 409 Conflict å“åº”çŠ¶æ€ç ï¼Œé”™è¯¯ä¿¡æ¯ç±»ä¼¼å¦‚ä¸‹ï¼š

```json
{
  "error" : "DocumentAlreadyExistsException[[website][4] [blog][123]:
             document already exists]",
  "status" : 409
}
```

## å¤šç´¢å¼•å’Œå¤šç±»å‹æœç´¢

```
/_search

åœ¨æ‰€æœ‰ç´¢å¼•çš„æ‰€æœ‰ç±»å‹ä¸­æœç´¢
/gb/_search

åœ¨ç´¢å¼•gbçš„æ‰€æœ‰ç±»å‹ä¸­æœç´¢
/gb,us/_search

åœ¨ç´¢å¼•gbå’Œusçš„æ‰€æœ‰ç±»å‹ä¸­æœç´¢
/g*,u*/_search

åœ¨ä»¥gæˆ–uå¼€å¤´çš„ç´¢å¼•çš„æ‰€æœ‰ç±»å‹ä¸­æœç´¢
/gb/user/_search

åœ¨ç´¢å¼•gbçš„ç±»å‹userä¸­æœç´¢
/gb,us/user,tweet/_search

åœ¨ç´¢å¼•gbå’Œusçš„ç±»å‹ä¸ºuserå’Œtweetä¸­æœç´¢
/_all/user,tweet/_search
```

## åˆ†é¡µ

```json
GET /_search?size=5
GET /_search?size=5&from=5
GET /_search?size=5&from=10
```

æ·±åº¦åˆ†é¡µé—®é¢˜

## æŸ¥è¯¢æ–¹å¼

1. ç®€å•æŸ¥è¯¢  
   ç›´æ¥åœ¨ url åé¢æ‹¼æ¥å‚æ•°

```json
GET /_all/tweet/_search?q=tweet:elasticsearch
```

"+" å‰ç¼€è¡¨ç¤ºè¯­å¥åŒ¹é…æ¡ä»¶å¿…é¡»è¢«æ»¡è¶³ã€‚ç±»ä¼¼çš„ "-" å‰ç¼€è¡¨ç¤ºæ¡ä»¶å¿…é¡»ä¸è¢«æ»¡è¶³ã€‚æ‰€æœ‰æ¡ä»¶å¦‚æœæ²¡æœ‰ + æˆ– - è¡¨ç¤ºæ˜¯å¯é€‰çš„â€”â€”åŒ¹é…è¶Šå¤šï¼Œç›¸å…³çš„æ–‡æ¡£å°±è¶Šå¤šã€‚

## [Java åŸºç¡€ï¼šä¸€äº›å¸¸ç”¨çš„ä»£ç ç‰‡æ®µå››](https://blog.dong4j.site/posts/1553cb8c.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## å¤–éƒ¨æ’åºï¼šé€šè¿‡ Comparator å®ç°ä¸ªæ€§åŒ–æ’åº

### ä½¿ç”¨ Comparator çš„åŸºæœ¬æ­¥éª¤

1. **å®šä¹‰ä¸€ä¸ªå®ç°äº† `Comparator<T>` æ¥å£çš„ç±»**ï¼Œå…¶ä¸­éœ€è¦å®ç° `compare` æ–¹æ³•ã€‚
2. **ä½¿ç”¨ Collections.sort(List<T> list, Comparator<T> c)** å¯¹åˆ—è¡¨è¿›è¡Œæ’åºã€‚

### ç¤ºä¾‹ä»£ç ï¼š

#### Person ç±»

```java
public class Person {
    private int age;
    private String name;

    public Person(int age, String name) {
        this.age = age;
        this.name = name;
    }

    public int getAge() {
        return age;
    }

    @Override
    public String toString() {
        return "Person{" +
                "age=" + age +
                ", name='" + name + '\'' +
                '}';
    }
}
```

#### PersonComparator ç±»ï¼ˆå®ç°äº† Comparator æ¥å£ï¼‰

```java
import java.util.Comparator;

public class PersonComparator implements Comparator<Person> {
    @Override
    public int compare(Person o1, Person o2) {
        return Integer.compare(o1.getAge(), o2.getAge());
    }
}
```

#### TestComparator ç±»ï¼ˆæµ‹è¯•æ’åºé€»è¾‘ï¼‰

```java
import java.util.*;

public class TestComparator {

    public static String outCollection(Collection<?> coll) {
        StringBuffer sb = new StringBuffer();
        for (Object obj : coll) {
            sb.append(obj + "\n");
        }
        System.out.println(sb.toString());
        return sb.toString();
    }

    public static void main(String[] args) {
        test1();
    }

    public static void test1() {
        System.out.println("----------test1()---------");
        System.out.println("å‡åºæ’åºæµ‹è¯•:");
        List<Person> listPerson = new ArrayList<>();
        Person person1 = new Person(34, "lavasoft");
        Person person2 = new Person(12, "lavasoft");
        Person person3 = new Person(23, "leizhimin");
        Person person4 = new Person(13, "sdg");

        listPerson.add(person1);
        listPerson.add(person2);
        listPerson.add(person3);
        listPerson.add(person4);

        Comparator<Person> ascComparator = new PersonComparator();

        System.out.println("åŸé›†åˆä¸º:");
        outCollection(listPerson);

        System.out.println("æ’åºåé›†åˆä¸º:");
        Collections.sort(listPerson, ascComparator);
        outCollection(listPerson);
    }
}
```

### è¾“å‡ºç»“æœ

```
----------test1()---------
å‡åºæ’åºæµ‹è¯•:
åŸé›†åˆä¸º:
Person{age=34, name='lavasoft'}
Person{age=12, name='lavasoft'}
Person{age=23, name='leizhimin'}
Person{age=13, name='sdg'}

æ’åºåé›†åˆä¸º:
Person{age=12, name='lavasoft'}
Person{age=13, name='sdg'}
Person{age=23, name='leizhimin'}
Person{age=34, name='lavasoft'}
```

## å†…éƒ¨æ’åºï¼šé€šè¿‡å®ç° Comparable æ¥å£

### ä½¿ç”¨ Comparable çš„åŸºæœ¬æ­¥éª¤

1. **åœ¨éœ€è¦æ’åºçš„ç±»ä¸­å®ç° `Comparable<T>` æ¥å£**ï¼Œå¹¶é‡å†™ `compareTo` æ–¹æ³•ã€‚
2. **ä½¿ç”¨ Collections.sort(List<T> list)** å¯¹åˆ—è¡¨è¿›è¡Œé»˜è®¤å‡åºæˆ–è°ƒç”¨ `Collections.reverseOrder()` è¿›è¡Œé™åºã€‚

### ç¤ºä¾‹ä»£ç ï¼š

#### Cat ç±»

```java
public class Cat implements Comparable<Cat> {
    private int age;
    private String name;

    public Cat(int age, String name) {
        this.age = age;
        this.name = name;
    }

    public int getAge() {
        return age;
    }

    @Override
    public String toString() {
        return "Cat{" +
                "age=" + age +
                ", name='" + name + '\'' +
                '}';
    }

    @Override
    public int compareTo(Cat o) {
        return Integer.compare(this.getAge(), o.getAge());
    }
}
```

#### TestComparable ç±»ï¼ˆæµ‹è¯•æ’åºé€»è¾‘ï¼‰

```java
import java.util.*;

public class TestComparable {

    public static String outCollection(Collection<?> coll) {
        StringBuffer sb = new StringBuffer();
        for (Object obj : coll) {
            sb.append(obj + "\n");
        }
        System.out.println(sb.toString());
        return sb.toString();
    }

    public static void main(String[] args) {
        test();
    }

    public static void test() {
        System.out.println("----------test()---------");
        System.out.println("å‡åºæ’åºæµ‹è¯•:");
        List<Cat> listCat = new ArrayList<>();
        Cat cat1 = new Cat(34, "hehe");
        Cat cat2 = new Cat(12, "haha");
        Cat cat3 = new Cat(23, "leizhimin");
        Cat cat4 = new Cat(13, "lavasoft");

        listCat.add(cat1);
        listCat.add(cat2);
        listCat.add(cat3);
        listCat.add(cat4);

        System.out.println("åŸé›†åˆä¸º:");
        outCollection(listCat);

        System.out.println("è°ƒç”¨Collections.sort(List<T> list)æ’åºï¼š");
        Collections.sort(listCat);
        outCollection(listCat);

        System.out.println("é€†åºæ’åˆ—å…ƒç´ :");
        Collections.sort(listCat, Collections.reverseOrder());
        outCollection(listCat);
    }
}
```

### è¾“å‡ºç»“æœ

```
----------test()---------
å‡åºæ’åºæµ‹è¯•:
åŸé›†åˆä¸º:
Cat{age=34, name='hehe'}
Cat{age=12, name='haha'}
Cat{age=23, name='leizhimin'}
Cat{age=13, name='lavasoft'}

è°ƒç”¨Collections.sort(List<T> list)æ’åºï¼š
Cat{age=12, name='haha'}
Cat{age=13, name='lavasoft'}
Cat{age=23, name='leizhimin'}
Cat{age=34, name='hehe'}

é€†åºæ’åˆ—å…ƒç´ :
Cat{age=34, name='hehe'}
Cat{age=23, name='leizhimin'}
Cat{age=13, name='lavasoft'}
Cat{age=12, name='haha'}
```

## æ€»ç»“

é€šè¿‡ä¸Šè¿°ç¤ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä½¿ç”¨ `Comparator` å’Œå®ç° `Comparable` æ¥å£åˆ†åˆ«å®ç°äº†å¤–éƒ¨æ’åºå’Œå†…éƒ¨æ’åºã€‚ä¸¤ç§æ–¹æ³•å„æœ‰ä¼˜åŠ¿ï¼š

- **å¤–éƒ¨æ’åºï¼ˆä½¿ç”¨ Comparatorï¼‰**ï¼š

  - é«˜åº¦çµæ´»ï¼Œå¯ä»¥ä¸ºä¸€ä¸ªç±»å®šä¹‰å¤šç§ä¸åŒçš„æ¯”è¾ƒæ–¹å¼ã€‚
  - å¯¹äºä¸å¸Œæœ›ä¿®æ”¹åŸå§‹ç±»çš„ä»£ç ç»“æ„çš„æƒ…å†µç‰¹åˆ«æœ‰ç”¨ã€‚

- **å†…éƒ¨æ’åºï¼ˆå®ç° Comparable æ¥å£ï¼‰**ï¼š
  - ç®€æ´ä¸”ç›´æ¥åœ¨å¯¹è±¡å†…éƒ¨å®šä¹‰æ’åºé€»è¾‘ï¼Œä¿æŒäº†å•ä¸ªç±»çš„ä¸€è‡´æ€§ã€‚
  - å¯¹äºéœ€è¦é¢‘ç¹æ’åºçš„å¯¹è±¡ç‰¹åˆ«åˆé€‚ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ `Collections.reverseOrder()` å¿«é€Ÿåè½¬æ’åºé¡ºåºã€‚

## ä½¿ç”¨è¿­ä»£å™¨åˆ é™¤é›†åˆå…ƒç´ 

### åœºæ™¯æè¿°

å½“ä½ éœ€è¦éå†ä¸€ä¸ªé›†åˆå¹¶æ ¹æ®æŸäº›æ¡ä»¶ç§»é™¤å…¶ä¸­çš„å…ƒç´ æ—¶ï¼Œç›´æ¥åœ¨å¾ªç¯ä½“å†…è¿›è¡Œåˆ é™¤æ“ä½œä¼šå¯¼è‡´ `ConcurrentModificationException`ã€‚è¿™æ˜¯å› ä¸ºç›´æ¥ä¿®æ”¹é›†åˆï¼ˆå¦‚è°ƒç”¨ `List.remove()`ï¼‰ä¼šç ´åè¿­ä»£å™¨çš„çŠ¶æ€ã€‚

ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Java çš„ `Iterator` æ¥å£æ¥å®‰å…¨åœ°æ‰§è¡Œåˆ é™¤æ“ä½œã€‚

### ç¤ºä¾‹ä»£ç 

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªè®¢å•åˆ—è¡¨ï¼Œå¹¶å¸Œæœ›æ ¹æ®åº—é“º ID ç§»é™¤ä¸å±äºç‰¹å®šåº—é“ºçš„å•†å“é¡¹ã€‚

```java
for (OrderDto orderDto : list) {
    Iterator<ProductItemDto> productItemDtoIterator = orderDto.getProductItems().iterator();
    while (productItemDtoIterator.hasNext()) {
        ProductItemDto productItemDto = productItemDtoIterator.next();
        if (!productItemDto.getShopId().equals(shopId)) {
            // é€šè¿‡è°ƒç”¨è¿­ä»£å™¨çš„ remove æ–¹æ³•æ¥å®‰å…¨åœ°ç§»é™¤å…ƒç´ 
            productItemDtoIterator.remove();
        }
    }
}
```

è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº† `Iterator` çš„ `remove()` æ–¹æ³•è€Œä¸æ˜¯ç›´æ¥åˆ é™¤é›†åˆä¸­çš„å…ƒç´ ã€‚æ­¤æ–¹æ³•ç¡®ä¿äº†æ“ä½œçš„å®‰å…¨æ€§ï¼Œå¹¶ä¸”é¿å…äº†å¹¶å‘ä¿®æ”¹å¼‚å¸¸ã€‚

### æ³¨æ„äº‹é¡¹

- **ä¸è¦åœ¨å¾ªç¯ä¸­è°ƒç”¨å…¶ä»–å¯èƒ½æ”¹å˜åˆ—è¡¨çš„æ–¹æ³•**ã€‚
- å½“éœ€è¦åŒæ—¶è¿›è¡Œå¢åˆ æ”¹æŸ¥ç­‰å¤æ‚æ“ä½œæ—¶ï¼Œå»ºè®®ä½¿ç”¨è¿­ä»£å™¨æ¥éå†å’Œä¿®æ”¹æ•°æ®ç»“æ„ã€‚

## JDBC ä¸­çš„äº‹åŠ¡ç®¡ç†

### äº‹åŠ¡åŸºç¡€æ¦‚å¿µ

æ•°æ®åº“äº‹åŠ¡æ˜¯ä¸€ç»„æ•°æ®åº“æ“ä½œæŒ‡ä»¤é›†ï¼Œè¿™äº›æ“ä½œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼ˆæˆåŠŸï¼‰ï¼Œè¦ä¹ˆå…¨éƒ¨éƒ½ä¸æ‰§è¡Œï¼ˆå¤±è´¥ï¼‰ã€‚JDBC æä¾›äº†å¯¹ SQL è¯­å¥æ‰§è¡Œçš„æ§åˆ¶èƒ½åŠ›ï¼Œå¹¶ä¸”å¯ä»¥è¿›è¡Œæ˜¾å¼åœ°æäº¤æˆ–å›æ»šå½“å‰äº‹åŠ¡ã€‚

### ç¤ºä¾‹ä»£ç 

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ JDBC ç®¡ç†æ•°æ®åº“ä¸­çš„äº‹åŠ¡ï¼š

```java
Connection con = null;
Statement st = null;
ResultSet rs = null;
PreparedStatement ps = null;

public void startTransaction() {
    try {
        // è·å–è¿æ¥å¯¹è±¡
        con = DBCManager.getConnect();

        // è®¾ç½®äº‹åŠ¡çš„æäº¤æ–¹å¼ä¸ºéè‡ªåŠ¨æäº¤ï¼Œç¡®ä¿éœ€è¦çš„æ‰€æœ‰æ“ä½œéƒ½æˆåŠŸåæ‰è¿›è¡Œæäº¤ã€‚
        con.setAutoCommit(false);

        // å‡†å¤‡å¹¶æ‰§è¡Œ SQL è¯­å¥
        String sql1 = "delete from me where id = 7";
        ps = con.prepareStatement(sql1);
        ps.executeUpdate();

        String sql2 = "update me set name='chengong', age=34 where id=4";
        ps = con.prepareStatement(sql2);
        ps.executeUpdate();

        // å¦‚æœäº‹åŠ¡æˆåŠŸæ‰§è¡Œï¼Œåˆ™æäº¤äº‹åŠ¡ã€‚
        con.commit();
    } catch (SQLException e) {
        try {
            // å‡ºç°å¼‚å¸¸æ—¶ï¼Œå›æ»šå½“å‰çš„æ•°æ®åº“æ“ä½œã€‚
            if(con != null)
                con.rollback();
        } catch (SQLException ex) {
            ex.printStackTrace();
        }

        // æ‰“å°é”™è¯¯ä¿¡æ¯
        e.printStackTrace();
    } finally {
        // é‡Šæ”¾èµ„æº
        DBCManager.release(rs, ps, con);
    }
}
```

### è¾“å‡ºç»“æœä¸è§£é‡Š

å¦‚æœä¸Šè¿°æ“ä½œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ²¡æœ‰ä»»ä½•å¼‚å¸¸ï¼Œåˆ™æ•´ä¸ªäº‹åŠ¡ä¼šè¢«æäº¤åˆ°æ•°æ®åº“ã€‚å¦‚æœæœ‰ä»»ä½• SQL æ“ä½œå¤±è´¥ï¼Œé‚£ä¹ˆ `commit` è°ƒç”¨å°†ä¸ä¼šå‘ç”Ÿï¼Œå¹¶ä¸”ä¹‹å‰çš„æ›´æ”¹å°†ä¼šè¢«å›æ»šã€‚

## æ€»ç»“

é€šè¿‡ä½¿ç”¨ Java çš„è¿­ä»£å™¨æ¥å£æ¥å®‰å…¨åœ°ä¿®æ”¹é›†åˆä¸­çš„å…ƒç´ æ˜¯å¤„ç†å¹¶å‘è®¿é—®æ—¶çš„ä¸€ä¸ªå…³é”®æŠ€å·§ï¼›è€Œåœ¨æ‰§è¡Œå¤šä¸ªæ“ä½œä»¥ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§æ—¶ï¼Œäº‹åŠ¡ç®¡ç†åˆ™æ˜¯ JDBC ç¼–ç¨‹ä¸­çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚è¿™ä¸¤ç§æŠ€æœ¯éƒ½æä¾›äº†å¼ºå¤§çš„å·¥å…·æ¥å¸®åŠ©æˆ‘ä»¬ç¼–å†™æ›´åŠ å¥å£®çš„åº”ç”¨ç¨‹åºä»£ç ã€‚

## [Java åŸºç¡€ï¼šä¸€äº›å¸¸ç”¨ä»£ç ç‰‡æ®µä¸‰](https://blog.dong4j.site/posts/5981a792.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## åŠ¨æ€è·å–åŠ è½½çš„ Jar åŒ…

æœ‰æ—¶æˆ‘ä»¬éœ€è¦åœ¨è¿è¡Œæ—¶ç¡®å®šä¸€ä¸ªç‰¹å®šç±»æ‰€å¯¹åº”çš„ JAR åŒ…æˆ–ç›®å½•çš„ä½ç½®ã€‚ä¸ºæ­¤æˆ‘ä»¬æä¾›äº†`ClassLocationUtils.where(cls)`è¿™ä¸ªé™æ€å·¥å…·æ–¹æ³•æ¥å¸®åŠ©è¯†åˆ«æŒ‡å®šç±»çš„æ¥æºæ–‡ä»¶ã€‚

```java
import java.io.File;
import java.net.MalformedURLException;
import java.net.URL;
import java.security.CodeSource;
import java.security.ProtectionDomain;

public class ClassLocationUtils {

    public static String where(final Class<?> cls) {
        if (cls == null)throw new IllegalArgumentException("null input: cls");
        URL result = null;
        final String clsAsResource = cls.getName().replace('.', '/').concat(".class");
        final ProtectionDomain pd = cls.getProtectionDomain();
        if (pd != null) {
            final CodeSource cs = pd.getCodeSource();
            if (cs != null) result = cs.getLocation();
            if ("file".equals(result.getProtocol())) {
                try {
                    if (result.toExternalForm().endsWith(".jar") ||
                            result.toExternalForm().endsWith(".zip"))
                        result = new URL("jar:".concat(result.toExternalForm())
                                .concat("!/").concat(clsAsResource));
                    else if (new File(result.getFile()).isDirectory())
                        result = new URL(result, clsAsResource);
                } catch (MalformedURLException ignore) { }
            }
        }
        if (result == null) {
            final ClassLoader clsLoader = cls.getClassLoader();
            result = clsLoader != null ?
                    clsLoader.getResource(clsAsResource) :
                    ClassLoader.getSystemResource(clsAsResource);
        }
        return result.toString();
    }
}
```

### æ–¹æ³•è§£é‡Š

- **è·å–ç±»çš„èµ„æºè¡¨ç¤º**ï¼šé¦–å…ˆï¼Œå°†æä¾›çš„ç±»åè½¬æ¢æˆèµ„æºè·¯å¾„çš„å½¢å¼ï¼ˆä¾‹å¦‚ï¼Œ`com/example/MyClass.class`ï¼‰ã€‚
- **è·å–ä»£ç æºä½ç½®**ï¼šé€šè¿‡è°ƒç”¨`ProtectionDomain.getCodeSource()`æ–¹æ³•å¯ä»¥æ‰¾åˆ°è¯¥ç±»æ‰€åœ¨ JAR æˆ–ç›®å½•çš„ä½ç½®ã€‚
- **å¤„ç†æ–‡ä»¶ URL**ï¼šå¦‚æœ URL åè®®æ˜¯â€œfileâ€ï¼Œåˆ™è¿›ä¸€æ­¥æ£€æŸ¥å®ƒæ˜¯å¦æŒ‡å‘ä¸€ä¸ª ZIP/JAR æ–‡ä»¶ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ„å»ºä¸€ä¸ªæ–°çš„ URL æ¥è¡¨ç¤ºå†…éƒ¨çš„èµ„æºè·¯å¾„ï¼›å¦‚æœä¸æ˜¯ ZIP/JARï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸ªç›®å½•ï¼Œåˆ™ç›´æ¥ä½¿ç”¨`URL.openConnection()`æ–¹æ³•å°è¯•è·å–åˆ°ç›¸åº”çš„ç±»æ–‡ä»¶ã€‚

### ä½¿ç”¨åœºæ™¯

åœ¨è¿›è¡Œè°ƒè¯•æˆ–åˆ†ææ—¶ï¼Œæ­¤å·¥å…·å¯ä»¥éå¸¸æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œåœ¨ IDE ä¸­è®¾ç½®æ–­ç‚¹åè¾“å…¥ `ClassLocationUtils.where(xxx.class)` å¯ä»¥å¿«é€Ÿå¾—åˆ°å½“å‰è¢«åŠ è½½çš„ JAR åŒ…è·¯å¾„ã€‚

## å®ç°å®šæ—¶ä»»åŠ¡çš„ä¸‰ç§æ–¹æ³•

Java æä¾›äº†å¤šç§å®ç°å®šæ—¶æ‰§è¡Œä»»åŠ¡çš„æ–¹å¼ï¼Œè¿™é‡Œä»‹ç»äº†å…¶ä¸­æœ€å¸¸è§çš„ä¸‰ç§æ–¹å¼ï¼š

### æ–¹æ³•ä¸€ï¼šä½¿ç”¨æ™®é€š Thread

è¿™ç§æ–¹å¼æ˜¯é€šè¿‡åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¹¶è®©å…¶åœ¨æ— é™å¾ªç¯ä¸­æ‰§è¡ŒæŒ‡å®šçš„ä»»åŠ¡ï¼Œå¹¶ä¸”åœ¨æ¯æ¬¡è¿è¡Œä¹‹é—´è®¾ç½®ä¸€å®šçš„å»¶æ—¶ã€‚è™½ç„¶ç®€å•æ˜“è¡Œï¼Œä½†å®ƒç¼ºä¹å¯¹ä»»åŠ¡å¯åŠ¨å’Œåœæ­¢çš„æ§åˆ¶ã€‚

```java
public class Task1 {
    public static void main(String[] args) {
        final long timeInterval = 1000; // æ¯ç§’æ‰§è¡Œä¸€æ¬¡
        new Thread(() -> {
            while (true) {
                System.out.println("Hello !!");
                try {
                    Thread.sleep(timeInterval);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }).start();
    }
}
```

### æ–¹æ³•äºŒï¼šä½¿ç”¨`java.util.Timer`

è¿™ç§æ–¹æ³•æä¾›äº†å¯¹ä»»åŠ¡å¯åŠ¨å’Œå–æ¶ˆçš„æ§åˆ¶èƒ½åŠ›ï¼Œå¹¶å…è®¸æŒ‡å®šå»¶è¿Ÿæ‰§è¡Œçš„æ—¶é—´é—´éš”ã€‚ç¼ºç‚¹æ˜¯ä»…æ”¯æŒå•çº¿ç¨‹æ“ä½œã€‚

```java
import java.util.Timer;
import java.util.TimerTask;

public class Task2 {
    public static void main(String[] args) {
        Timer timer = new Timer();
        TimerTask task = () -> System.out.println("Hello !!!");

        // ç¬¬äºŒä¸ªå‚æ•°ä¸ºå»¶è¿Ÿæ—¶é—´ï¼Œç¬¬ä¸‰ä¸ªä¸ºæ¯æ¬¡æ‰§è¡Œä»»åŠ¡çš„æ—¶é—´é—´éš”
        timer.scheduleAtFixedRate(task, 0, 1000);
    }
}
```

### æ–¹æ³•ä¸‰ï¼šä½¿ç”¨`java.util.concurrent.ScheduledExecutorService`

è¿™æ˜¯ Java SE5 å¼•å…¥çš„ä¸€ä¸ªé«˜çº§å®šæ—¶ä»»åŠ¡å¤„ç†ç±»ã€‚å®ƒæä¾›äº†æ›´çµæ´»çš„ä»»åŠ¡è°ƒåº¦æ–¹å¼ï¼Œæ”¯æŒå¤šçº¿ç¨‹æ‰§è¡Œï¼Œå¹¶ä¸”èƒ½æ–¹ä¾¿åœ°è®¾ç½®é¦–æ¬¡æ‰§è¡Œçš„å»¶è¿Ÿæ—¶é—´ã€‚

```java
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;

public class Task3 {
    public static void main(String[] args) {
        ScheduledExecutorService service = Executors.newSingleThreadScheduledExecutor();

        // ç¬¬äºŒä¸ªå‚æ•°ä¸ºé¦–æ¬¡æ‰§è¡Œçš„å»¶æ—¶æ—¶é—´ï¼Œç¬¬ä¸‰ä¸ªä¸ºæ¯æ¬¡æ‰§è¡Œä»»åŠ¡çš„æ—¶é—´é—´éš”
        service.scheduleAtFixedRate(() -> System.out.println("Hello !!"), 10, 1, TimeUnit.SECONDS);
    }
}
```

## æ‹¼æ¥å­—ç¬¦ä¸²æ—¶å»é™¤æœ€åä¸€ä¸ªå¤šä½™çš„é€—å·

å½“æˆ‘ä»¬åœ¨ Java ä¸­è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œæ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°éœ€è¦ç§»é™¤æœ€åä¸€ä¸ªå¤šä½™é€—å·çš„æƒ…å†µã€‚ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ `StringBuffer` ç±»æ¥å®ç°è¿™ä¸€åŠŸèƒ½ï¼š

```java
String str[] = { "hello", "beijing", "world", "shenzhen" };
StringBuffer buf = new StringBuffer();

for (int i = 0; i < str.length; i++) {
    buf.append(str[i]).append(",");
}

if (buf.length() > 0) {
    //æ–¹æ³•ä¸€  : substring
    System.out.println(buf.substring(0, buf.length()-1));
    //æ–¹æ³•äºŒ ï¼šreplace
    System.out.println(buf.replace(buf.length() - 1, buf.length(), ""));
    //æ–¹æ³•ä¸‰ï¼š deleteCharAt
    System.out.println(buf.deleteCharAt(buf.length()-1));
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ `substring`ã€`replace` å’Œ `deleteCharAt` æ–¹æ³•å®ç°äº†å¯¹æœ€åä¸€ä¸ªé€—å·çš„ç§»é™¤ã€‚

## å°† List å¯¹è±¡è½¬æ¢ä¸ºå¸¦åˆ†éš”ç¬¦çš„å­—ç¬¦ä¸²

æœ‰æ—¶æˆ‘ä»¬éœ€è¦å°†ä¸€ä¸ª `List` ç±»å‹çš„å¯¹è±¡è½¬æ¢æˆåŒ…å«ç‰¹å®šåˆ†éš”ç¬¦çš„å­—ç¬¦ä¸²ã€‚è¿™é‡Œæä¾›äº†ä¸€äº›å®ç°æ­¤åŠŸèƒ½çš„æ–¹æ³•ï¼š

```java
// æ–¹æ³•ä¸€ï¼š
public String listToString(List list, char separator) {
    StringBuilder sb = new StringBuilder();
    for (int i = 0; i <list.size(); i++) {
        sb.append(list.get(i)).append(separator);
    }
    return list.isEmpty()?"":sb.toString().substring(0, sb.toString().length() - 1);
}

// æ–¹æ³•äºŒï¼š
public String listToString2(List list, char separator) {
    StringBuilder sb = new StringBuilder();
    for (int i = 0; i <list.size(); i++) {
        if (i == list.size() - 1) {
            sb.append(list.get(i));
        } else {
            sb.append(list.get(i)).append(separator);
        }
    }
    return sb.toString();
}

// æ–¹æ³•ä¸‰ï¼š
public String listToString3(List list, char separator) {
    StringBuilder sb = new StringBuilder();
    for (int i = 0; i <list.size(); i++) {
        sb.append(list.get(i));
        if (i < list.size() - 1) {
            sb.append(separator);
        }
    }
    return sb.toString();
}

// æ–¹æ³•å››ï¼š
public class Separator {
    private String next = "";
    private String separator;

    public Separator(String separator) {
        this.separator = separator;
    }

    public String get() {
        String result = next;
        next = separator;
        return result;
    }
}

public String listToString4(List<String> list, Separator separator) {
    StringBuilder sb = new StringBuilder();
    for (String s : list) {
        if (s != null && !"".equals(s)) {
            sb.append(separator.get()).append(s);
        }
    }
    return sb.toString();
}

// æ–¹æ³•äº”ï¼š
public String listToString5(List list, char separator) {
    return org.apache.commons.lang.StringUtils.join(list.toArray(),separator);
}
```

è¿™äº›æ–¹æ³•å„å…·ç‰¹ç‚¹ï¼Œå¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚é€‰æ‹©æœ€åˆé€‚çš„å®ç°ã€‚

## åˆ©ç”¨åå°„æœºåˆ¶æ ¹æ®å®Œæ•´ç±»åè·å–ç±»å¯¹è±¡

Java çš„åå°„æœºåˆ¶å…è®¸æˆ‘ä»¬åŠ¨æ€åœ°åˆ›å»ºã€è®¿é—®å’Œæ“ä½œç±»åŠå…¶æˆå‘˜ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªé€šè¿‡åå°„åŠ è½½å¹¶ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„ç±»å®ä¾‹çš„ä¾‹å­ï¼š

```java
public class Test {
    public static void main(String[] args) throws Exception {
        Properties properties = new Properties();
properties.load(Test.class.getClassLoader().getResourceAsStream("com/lsd/beanfactory/ApplicationContext.properties"));//æ ¹æ®é…ç½®æ–‡ä»¶çš„è·¯å¾„åŠ è½½å¯¹è±¡
        String key = properties.getProperty("vehicle");//æ ¹æ®keyè·å–value
        Class c = Class.forName(key);
        System.out.println(key);
        Object object = c.newInstance();
        Vehicle vehicle = (Vehicle) object;
        vehicle.run();
    }
}
```

è¿™æ®µä»£ç é¦–å…ˆä» `Properties` å¯¹è±¡ä¸­è¯»å–é…ç½®æ–‡ä»¶ä¸­çš„ç±»åï¼Œç„¶åä½¿ç”¨åå°„æœºåˆ¶åŠ è½½æŒ‡å®šçš„ç±»ï¼Œå¹¶å®ä¾‹åŒ–å¯¹è±¡æœ€åè°ƒç”¨è¯¥å¯¹è±¡çš„æ–¹æ³•ã€‚è¿™åœ¨æ¡†æ¶è®¾è®¡å’Œä¾èµ–æ³¨å…¥åœºæ™¯ä¸‹éå¸¸æœ‰ç”¨ã€‚

## ä½¿ç”¨å¤šæ¡ä»¶æ’åº ArrayList

å½“éœ€è¦æ ¹æ®å¤šä¸ªå±æ€§è¿›è¡Œå¤æ‚çš„æ’åºæ—¶ï¼ŒJava æä¾›äº†çµæ´»çš„æœºåˆ¶æ¥å®ç°è¿™ä¸€ç‚¹ã€‚ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨è‡ªå®šä¹‰æ¯”è¾ƒå™¨å¯¹åŒ…å«å‘˜å·¥ä¿¡æ¯çš„ `ArrayList` è¿›è¡Œæ’åºï¼š

```java
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;

public class TestComparator {
    public static void main(String[] args) {

        ArrayList<Person> persons = new ArrayList<>();
        persons.add(new Person(10, 1000, 4));
        persons.add(new Person(1, 1020, 5));
        persons.add(new Person(1, 1020, 4));
        persons.add(new Person(13, 1100, 2));
        persons.add(new Person(1, 1020, 5));

        // æ‰“å°æ’åºå‰çš„åˆ—è¡¨
        for (Person person : persons) {
            System.out.println(person);
        }
        System.out.println();

        // ä½¿ç”¨è‡ªå®šä¹‰æ¯”è¾ƒå™¨è¿›è¡Œå¤šæ¡ä»¶æ’åºï¼ˆçº§åˆ«ã€è–ªèµ„å’Œå¹´ä»½ï¼‰
        Collections.sort(persons, new Comparator<Person>() {
            @Override
            public int compare(Person o1, Person o2) {
                if (o1.level == o2.level) {
                    if (o1.salary == o2.salary) {
                        return Integer.compare(o2.years, o1.years);
                    } else {
                        return Integer.compare(o2.salary, o1.salary);
                    }
                } else {
                    return Integer.compare(o2.level, o1.level);
                }
            }
        });

        // æ‰“å°æ’åºåçš„åˆ—è¡¨
        for (Person person : persons) {
            System.out.println(person);
        }
    }

    static class Person {
        int level;  // çº§åˆ«
        int salary; // è–ªèµ„
        int years;  // å…¥èŒå¹´æ•°

        public Person(int level, int salary, int years) {
            this.level = level;
            this.salary = salary;
            this.years = years;
        }

        @Override
        public String toString() {
            return "Person{" +
                    "level=" + level +
                    ", salary=" + salary +
                    ", years=" + years +
                    '}';
        }
    }
}
```

ä¸Šè¿°ä»£ç å±•ç¤ºäº†å¦‚ä½•æ ¹æ®å¤šä¸ªå±æ€§è¿›è¡Œæ’åºã€‚æˆ‘ä»¬é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª `Comparator`ï¼Œå¹¶åœ¨å…¶ä¸­å®ç°äº†å¤šæ¡ä»¶çš„æ¯”è¾ƒé€»è¾‘ï¼šå…ˆæŒ‰ç…§çº§åˆ«é™åºæ’åˆ—ï¼›å¦‚æœçº§åˆ«ç›¸åŒï¼Œåˆ™æŒ‰è–ªèµ„é™åºæ’åˆ—ï¼›æœ€åï¼Œåœ¨çº§åˆ«å’Œè–ªèµ„éƒ½ç›¸åŒæ—¶æŒ‰å…¥èŒå¹´æ•°å‡åºæ’åˆ—ã€‚

## éå† Map çš„å‡ ç§æ–¹æ³•

åœ¨ Java ä¸­éå† `Map` å¯¹è±¡æœ‰å¤šç§æ–¹å¼ï¼Œä»¥ä¸‹æ˜¯å¸¸ç”¨çš„å››ç§æ–¹æ³•ï¼š

### ä½¿ç”¨ for å¾ªç¯è¿­ä»£

```java
Map<String, String> map = new HashMap<>();
map.put("username", "qq");
map.put("password", "123");  // æ³¨æ„æ­¤å¤„æ‹¼å†™ä¿®æ­£
map.put("userID", "1");
map.put("email", "qq@qq.com");

for (Map.Entry<String, String> entry : map.entrySet()) {
    System.out.println(entry.getKey() + "-->" + entry.getValue());
}
```

### ä½¿ç”¨ Iterator è¿›è¡Œè¿­ä»£

```java
Set<Map.Entry<String, String>> set = map.entrySet();
Iterator<Map.Entry<String, String>> iterator = set.iterator();

while (iterator.hasNext()) {
    Map.Entry<String, String> entry = iterator.next();
    System.out.println(entry.getKey() + "==" + entry.getValue());
}
```

### ä½¿ç”¨ keySet è¿›è¡Œè¿­ä»£

```java
Iterator<String> it = map.keySet().iterator();

while(it.hasNext()){
    String key = it.next();
    String value = map.get(key);
    System.out.println(key+"--"+value);
}
```

### ä½¿ç”¨ entrySet è¿›è¡Œè¿­ä»£

```java
Iterator<Map.Entry<String, String>> it = map.entrySet().iterator();
System.out.println(map.entrySet().size());

while(it.hasNext()){
    Map.Entry<String, String> entry = it.next();
    String key = entry.getKey();
    String value = entry.getValue();
    System.out.println(key+"===="+value);
}
```

æ¯ç§æ–¹æ³•éƒ½æœ‰å…¶é€‚ç”¨çš„åœºæ™¯ï¼Œæ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©åˆé€‚çš„éå†æ–¹å¼å¯ä»¥æé«˜ä»£ç æ•ˆç‡å’Œå¯è¯»æ€§ã€‚ä¾‹å¦‚ï¼Œåœ¨éœ€è¦é¢‘ç¹è®¿é—® `entry` å¯¹è±¡æ—¶ï¼Œç›´æ¥ä½¿ç”¨ `for-each` å¾ªç¯æ˜¯æœ€ç®€å•ä¸”é«˜æ•ˆçš„ï¼›å¦‚æœå¯¹æ€§èƒ½æœ‰è¾ƒé«˜è¦æ±‚ï¼Œåˆ™å¯ä»¥é€šè¿‡æå‰è·å– `Iterator` å¯¹è±¡æ¥å‡å°‘åˆ›å»ºå®ä¾‹çš„å¼€é”€ã€‚

## ä½¿ç”¨ `SimpleDateFormat` è¿›è¡Œæ—¥æœŸå’Œå­—ç¬¦ä¸²è½¬æ¢

åœ¨å¤„ç†æ—¥æœŸæ—¶ï¼ŒJava æä¾›äº†å¼ºå¤§çš„ API æ¥è¿›è¡Œæ ¼å¼åŒ–æ“ä½œã€‚ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•å°† `Date` å¯¹è±¡è½¬åŒ–ä¸ºæŒ‡å®šæ ¼å¼çš„å­—ç¬¦ä¸²ï¼š

### å­—ç¬¦ä¸²è½¬æ—¥æœŸ

```java
public static Date stringToDate(String dateStr) throws ParseException {
    SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
    return sdf.parse(dateStr);
}
```

ç»™å®šä¸€ä¸ªæ—¥æœŸæ—¶é—´å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ "2002-10-8 15:30:22"ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ `SimpleDateFormat` çš„ `parse` æ–¹æ³•å°†å…¶è§£æä¸º `Date` å¯¹è±¡ï¼š

```java
try {
    Date date = sdf.parse("2002-10-8 15:30:22");
} catch (ParseException e) {
    // å¤„ç†å¼‚å¸¸æƒ…å†µ
}
```

### æ—¥æœŸè½¬å­—ç¬¦ä¸²

```java
public static String dateToString(Date time){
    SimpleDateFormat formatter;
    formatter = new SimpleDateFormat ("yyyy-MM-dd HH:mm:ss");
    return formatter.format(time);
}
```

è¦å°†å½“å‰æ—¶é—´æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œå¯ä»¥ä½¿ç”¨ `SimpleDateFormat` çš„ `format` æ–¹æ³•ï¼š

```java
String datestr = sdf.format(new Date());
// è¾“å‡ºç±»ä¼¼ï¼š2002-10-08 14:55:38
```

## Math ç±»å¸¸ç”¨æ–¹æ³•

Java æä¾›äº†ä¸°å¯Œçš„æ•°å­¦è®¡ç®—å·¥å…·ç±»ï¼Œå³ `Math`ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼š

```java
class MathTest {
    public static void main(String[] args) {
        System.out.println("ceil    å‘ä¸Šå–æ•´ " + Math.ceil(11.2));
        System.out.println("floor   å‘ä¸‹å–æ•´ " + Math.floor(11.8));
        System.out.println("rint    å››èˆäº”å…¥å–æµ®ç‚¹ " + Math.rint(-11.1));
        System.out.println("round   å››èˆäº”å…¥å–æ•´ " + Math.round(-11.1));
    }
}
```

è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

- `ceil` æ–¹æ³•å°†æ•°å€¼å‘ä¸Šå–æ•´ï¼Œå³å‘æ­£æ— ç©·æ–¹å‘å–æœ€è¿‘çš„æ•´æ•°ï¼›
- `floor` æ–¹æ³•å°†æ•°å€¼å‘ä¸‹å–æ•´ï¼Œå³å‘è´Ÿæ— ç©·æ–¹å‘å–æœ€è¿‘çš„æ•´æ•°ï¼›
- `rint` è¿”å›æœ€æ¥è¿‘å‚æ•°çš„æ•´æ•°å€¼çš„åŒç²¾åº¦æµ®ç‚¹æ•°ï¼›
- `round` å°†å‚æ•°å››èˆäº”å…¥åˆ°æœ€é‚»è¿‘çš„æ•´æ•°ã€‚

## å•ä¾‹æ¨¡å¼å®ç°

å•ä¾‹æ¨¡å¼æ˜¯ä¸€ç§å¸¸ç”¨çš„è½¯ä»¶è®¾è®¡æ¨¡å¼ï¼Œç¡®ä¿ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›å…¨å±€è®¿é—®ç‚¹ã€‚ä»¥ä¸‹æ˜¯å‡ ç§å¸¸è§çš„å®ç°æ–¹å¼ï¼š

### æ‡’æ±‰å¼ï¼ˆçº¿ç¨‹ä¸å®‰å…¨ï¼‰

```java
public class Singleton {
    private static Singleton instance;
    private Singleton() {}

    public static synchronized Singleton getInstance() {
        if (instance == null) {
            instance = new Singleton();
        }
        return instance;
    }
}
```

è¿™ç§æ–¹å¼åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œä½†æ•ˆç‡è¾ƒä½ã€‚99%çš„æƒ…å†µä¸‹ä¸éœ€è¦åŒæ­¥ã€‚

### é¥¿æ±‰å¼

```java
public class Singleton {
    private static final Singleton INSTANCE = new Singleton();

    private Singleton() {}

    public static Singleton getInstance() {
        return INSTANCE;
    }
}
```

æ­¤æ–¹å¼åˆ©ç”¨ç±»åŠ è½½æœºåˆ¶é¿å…äº†å¤šçº¿ç¨‹é—®é¢˜ï¼Œä½†åœ¨åŠ è½½æ—¶ä¼šç«‹å³åˆ›å»ºå®ä¾‹ã€‚

### é™æ€å†…éƒ¨ç±»å®ç°

```java
public class Singleton {
    private static class SingletonHolder {
        private static final Singleton INSTANCE = new Singleton();
    }

    private Singleton() {}

    public static final Singleton getInstance() {
        return SingletonHolder.INSTANCE;
    }
}
```

è¿™ç§æ–¹å¼ä½¿ç”¨äº† `classloader` æœºåˆ¶ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œå¹¶ä¸”åœ¨éœ€è¦æ—¶æ‰åˆ›å»ºå®ä¾‹ã€‚

### æšä¸¾å®ç°

```java
public enum Singleton {
    INSTANCE;

    public void whateverMethod() {}
}
```

æšä¸¾å•ä¾‹æ¨¡å¼æ˜¯é«˜æ•ˆä¸”çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†å¯èƒ½ä¼šè®©äººæ„Ÿè§‰ç”Ÿç–ï¼Œä¸å¸¸ç”¨ã€‚

### åŒé‡æ£€æŸ¥é”å®ç°ï¼ˆJDK 1.5+ï¼‰

```java
public class Singleton {
    private volatile static Singleton singleton;
    private Singleton() {}

    public static Singleton getSingleton() {
        if (singleton == null) {
            synchronized (Singleton.class) {
                if (singleton == null) {
                    singleton = new Singleton();
                }
            }
        }
        return singleton;
    }
}
```

è¿™ç§æ–¹å¼ç»“åˆäº†å»¶è¿ŸåŠ è½½å’Œçº¿ç¨‹å®‰å…¨çš„ä¼˜ç‚¹ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½å›  `volatile` è€Œå½±å“æ€§èƒ½ã€‚

## æ³¨æ„äº‹é¡¹

1. **ç±»è£…è½½å™¨**ï¼šå¦‚æœå•ä¾‹ç”±ä¸åŒçš„ç±»è£…è½½å™¨è£…å…¥ï¼Œåˆ™æœ‰å¯èƒ½åˆ›å»ºå¤šä¸ªå®ä¾‹ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€äº› Servlet å®¹å™¨ä¸­å¯¹æ¯ä¸ª Servlet ä½¿ç”¨å®Œå…¨ä¸åŒçš„ç±»è£…è½½å™¨ã€‚
2. **åºåˆ—åŒ–ä¸ååºåˆ—åŒ–**ï¼š
   - å¦‚æœå®ç°äº† `Serializable` æ¥å£ï¼Œå¯ä»¥æ·»åŠ ä¸€ä¸ª `readResolve()` æ–¹æ³•æ¥ç¡®ä¿å•ä¾‹æ¨¡å¼åœ¨ååºåˆ—åŒ–åä»åªæœ‰ä¸€ä¸ªå®ä¾‹ã€‚

### ä¿®å¤ç¤ºä¾‹

```java
private static Class<?> getClass(String classname) throws ClassNotFoundException {
    ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
    if (classLoader == null)
        classLoader = Singleton.class.getClassLoader();
    return classLoader.loadClass(classname);
}
```

## [JavaåŸºç¡€ï¼šä¸€äº›å¸¸ç”¨ä»£ç ç‰‡äºŒ](https://blog.dong4j.site/posts/1bdd319f.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

åœ¨ Java å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦è¿›è¡Œå­—ç¬¦ä¸²çš„æ‹¼æ¥å’Œå¤„ç†é›†åˆä¸­çš„å…ƒç´ ã€‚æ­¤å¤–ï¼Œåœ¨æŸäº›ç‰¹å®šåœºæ™¯ä¸‹ï¼Œå¦‚æ€§èƒ½ç›‘æ§æˆ–ä»£ç è°ƒè¯•æ—¶ï¼Œä¹Ÿéœ€è¦æŸ¥çœ‹ GC æ—¥å¿—ä»¥åŠå­—èŠ‚ç ä¿¡æ¯ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»è¿™äº›å¸¸ç”¨æŠ€æœ¯åŠå…¶æœ€ä½³å®è·µã€‚

## å­—ç¬¦ä¸²æ‹¼æ¥æ–¹æ³•

### ä½¿ç”¨ `org.apache.commons.lang.StringUtils` æ‹¼æ¥

```java
import org.apache.commons.lang3.StringUtils;

String result = StringUtils.join(array, "-");
```

è¯¥æ–¹æ³•ä½¿ç”¨æŒ‡å®šçš„åˆ†éš”ç¬¦ï¼ˆå¦‚è¿™é‡Œçš„'-'ï¼‰å°†æ•°ç»„ä¸­çš„å…ƒç´ è¿æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²ã€‚

### ä½¿ç”¨ Google Guava çš„ `Joiner` ç±»

```java
import com.google.common.base.Joiner;
String result = Joiner.on('-').join(array);
```

Guava åº“æä¾›çš„`Joiner`ç±»å¯ä»¥æ›´åŠ çµæ´»åœ°æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œæ”¯æŒå¤šç§åˆ†éš”ç¬¦å’Œè‡ªå®šä¹‰è½¬æ¢å‡½æ•°ã€‚

## è·å–é›†åˆä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ 

### ä½¿ç”¨ `Iterables.getOnlyElement` æ–¹æ³•

```java
import com.google.common.collect.Iterables;
Object first = Iterables.getOnlyElement(collection);
```

è¯¥æ–¹æ³•ç”¨äºç¡®ä¿é›†åˆä¸­åªæœ‰ä¸€ä¸ªå…ƒç´ æ—¶è·å–è¯¥å…ƒç´ ï¼Œå¦‚æœå¤šä¸ªæˆ–ä¸ºç©ºåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚é€‚ç”¨äºç¡®è®¤é›†åˆå†…å®¹çš„æƒ…å†µä¸‹ã€‚

### è·å–ç¬¬ä¸€ä¸ªå…ƒç´ å¹¶å…è®¸æŒ‡å®šé»˜è®¤å€¼

```java
Object firstOrDefault = Iterables.getFirst(collection, defaultValue);
```

`Iterables.getFirst` æ–¹æ³•å…è®¸åœ¨é›†åˆä¸ºç©ºæ—¶è¿”å›ä¸€ä¸ªé»˜è®¤å€¼ï¼Œå¢åŠ äº†ä»£ç çš„çµæ´»æ€§å’Œå¥å£®æ€§ã€‚

### ç›´æ¥ä»è¿­ä»£å™¨ä¸­è·å–ç¬¬ä¸€ä¸ªå…ƒç´ 

```java
Object first = collection.iterator().next();
```

ç›´æ¥ä½¿ç”¨`iterator()`å¹¶è°ƒç”¨`next()`æ˜¯æœ€åŸºæœ¬çš„æ–¹æ³•ã€‚é€‚ç”¨äºå¿«é€Ÿè€Œç®€å•çš„åœºæ™¯ã€‚

## æŸ¥çœ‹ GC æ—¥å¿—

ä¸ºäº†è°ƒè¯•åº”ç”¨ç¨‹åºä¸­çš„å†…å­˜é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‚æ•°å¯åŠ¨ Java è™šæ‹Ÿæœºï¼ˆJVMï¼‰ä»¥æŸ¥çœ‹è¯¦ç»†çš„åƒåœ¾æ”¶é›†(GC)æ´»åŠ¨ï¼š

```bash
java -XX:+PrintGCDetails -jar yourApp.jar
```

æ­¤å‘½ä»¤ä¼šè¾“å‡ºæ¯æ¬¡ GC äº‹ä»¶çš„è¯¦ç»†ä¿¡æ¯ã€‚

## æŸ¥çœ‹å­—èŠ‚ç 

ä¸ºäº†æ›´å¥½åœ°ç†è§£ç±»çš„å·¥ä½œåŸç†æˆ–è€…ç”¨äºåç¼–è¯‘ç›®çš„ï¼Œå¯ä»¥ä½¿ç”¨`javap`å·¥å…·æŸ¥çœ‹ç±»æ–‡ä»¶çš„å†…å®¹ã€‚ä¾‹å¦‚:

```bash
javap -c class_path
```

## é›†åˆæ“ä½œï¼šå¹¶é›†ã€äº¤é›†å’Œå·®é›†ç­‰

### ç¤ºä¾‹ä»£ç å±•ç¤ºé›†åˆçš„å„ç§æ“ä½œ

```java
public static void main(String[] args) {
    List<String> list1 = new ArrayList<>();
    list1.add("A");
    list1.add("B");
    list1.add("C");

    List<String> list2 = new ArrayList<>();
    list2.add("C");
    list2.add("B");
    list2.add("D");

    // å¹¶é›†
    List<String> unionList = new ArrayList<>(list1);
    unionList.addAll(list2);

    // å»é‡å¤å¹¶é›†
    Set<String> tempSet = new HashSet<>();
    tempSet.addAll(unionList);
    unionList.clear();
    unionList.addAll(tempSet);

    System.out.println("å»é‡åçš„å¹¶é›†ï¼š " + unionList);

    // äº¤é›†
    List<String> intersectionList = new ArrayList<>(list1);
    intersectionList.retainAll(list2);
    System.out.println("äº¤é›†: " + intersectionList);

    // å·®é›†
    List<String> diffList = new ArrayList<>(list1);
    diffList.removeAll(list2);
    System.out.println("å·®é›†: " + diffList);
}
```

## é€šè¿‡æšä¸¾å±æ€§è·å–æšä¸¾å®ä¾‹

### æšä¸¾ç¤ºä¾‹ä»£ç å±•ç¤º

```java
enum Gender {
    MALE(0),
    FEMALE(1);

    private int code;

    private static final Map<Integer, Gender> MAP = new HashMap<>();

    static {
        for (Gender item : Gender.values()) {
            MAP.put(item.code, item);
        }
    }

    public int getCode() {
        return code;
    }

    private Gender(int code) {
        this.code = code;
    }
}

public class EnumUtil {

    @SuppressWarnings("unchecked")
    public static <E extends Enum<?>> E getByCode(Class<E> enumClass, int code) {
        try {
            for (E e : enumClass.getEnumConstants()) {
                Field field = e.getClass().getField("code");
                Object value = field.get(e);
                if (value.equals(code)) {
                    return e;
                }
            }
        } catch (Exception ex) {
            throw new RuntimeException("æ ¹æ®codeè·å–æšä¸¾å®ä¾‹å¼‚å¸¸" + enumClass.getName() + " code:" + code, ex);
        }
        return null;
    }

    public static void main(String[] args) {
        System.out.println(EnumUtil.getByCode(Gender.class, 0));
    }
}
```

## å›½é™…åŒ–å¤„ç†

### ä½¿ç”¨ .properties æ–‡ä»¶å®ç°å›½é™…åŒ–

åœ¨ Java ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºå’Œä½¿ç”¨`.properties`æ–‡ä»¶æ¥æ”¯æŒå¤šç§è¯­è¨€çš„å›½é™…åŒ–çš„æ“ä½œã€‚è¿™äº›æ–‡ä»¶é€šå¸¸åŒ…å«é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨æ–‡æœ¬ä¿¡æ¯ï¼Œè€Œå½“éœ€è¦ç‰¹å®šè¯­è¨€ç‰ˆæœ¬æ—¶ï¼Œåˆ™åŠ è½½ç›¸åº”çš„`.properties`æ–‡ä»¶ã€‚

#### `.properties`æ–‡ä»¶ä¸­æ–‡å­—ç¬¦ä¸ Unicode å­—ç¬¦ä¹‹é—´çš„è½¬æ¢

- ä½¿ç”¨`native2ascii.exe`å·¥å…·å¯ä»¥å°†`.properties`æ–‡ä»¶ä¸­çš„ä¸­æ–‡å­—ç¬¦è½¬ä¸º Unicode æ ¼å¼ã€‚
  ```bash
  native2ascii resources.properties tmp.properties æˆ–è€…
  native2ascii -encoding Unicode resources.properties tmp.properties
  ```
- è‹¥éœ€è¦å†å°†å…¶è½¬åŒ–ä¸ºä¸­æ–‡ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š
  ```bash
  native2ascii -reverse -encoding GB2312 resources.properties tmp.properties
  ```

## `switch` vs. `if-else`

### æ€§èƒ½æ¯”è¾ƒ

åœ¨ Java ä¸­ï¼Œ`switch-case`ç»“æ„å¸¸ç”¨äºå¤šåˆ†æ”¯é€‰æ‹©ã€‚å®ƒä¸`if-else`è¯­å¥åœ¨åŠŸèƒ½ä¸Šæœ‰ä¸€å®šçš„é‡å ã€‚ç„¶è€Œï¼Œåœ¨å®é™…åº”ç”¨æ—¶ï¼Œä¸¤è€…åœ¨æ•ˆç‡ä¸Šå­˜åœ¨åŒºåˆ«ï¼š

1. **äºŒå‰æ ‘ç®—æ³•**ï¼š`switch`ä½¿ç”¨äº† Binary Tree ç®—æ³•è€Œ`if-else`é¡ºåºæ¯”è¾ƒã€‚
2. **è·³è½¬è¡¨ç”Ÿæˆ**ï¼šå¯¹äºå¤šä¸ªåˆ†æ”¯çš„åœºæ™¯ä¸‹ï¼ˆå¤§äºç­‰äºå››ä¸ªï¼‰ï¼Œ`switch`ä¼šåˆ›å»ºä¸€ä¸ªæœ€å¤§ case å¸¸é‡+1 å¤§å°çš„ jump tableï¼Œè¿™æ¯”ç®€å•çš„çº¿æ€§æŸ¥æ‰¾æ•ˆç‡æ›´é«˜ã€‚

## åå°„ä¸æ³¨è§£

### è·å–æ–¹æ³•ä¸Šçš„æ³¨è§£

ä» Java 7 å¼€å§‹ï¼Œå¯ä»¥é€šè¿‡åå°„æœºåˆ¶è·å–ç±»ä¸Šæˆ–æ–¹æ³•ä¸Šçš„æ³¨è§£ä¿¡æ¯ã€‚ä¸‹é¢å±•ç¤ºäº†åœ¨ JDK ç‰ˆæœ¬ä¸º 7 å’Œ 8 æ—¶çš„ä¸åŒä»£ç å®ç°ï¼š

```java
// JDK7æ–¹å¼:
RequestMapping methodDeclaredAnnotation = method.getAnnotation(RequestMapping.class);

// JDK8æ–¹å¼:
RequestMapping methodDeclaredAnnotation = method.getDeclaredAnnotation(RequestMapping.class);
```

## é˜…è¯»æ–‡ä»¶ä¸­çš„å†…å®¹

ä½¿ç”¨ Java æ ‡å‡†åº“å¯ä»¥è½»æ¾ä»èµ„æºæˆ–æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œä¾‹å¦‚ï¼š

```java
InputStream stream = this.getClass().getClassLoader().getResourceAsStream("test.md");
BufferedReader reader = new BufferedReader(new InputStreamReader(stream, "utf-8"));
List<String> list = reader.lines().collect(Collectors.toList());
String content = Joiner.on("\n").join(list);
```

## Java æšä¸¾ç±»çš„ç‰¹æ€§

### ä¸ºä»€ä¹ˆ`Enum`ä¸èƒ½è¢«ç»§æ‰¿ï¼Ÿ

åœ¨ Java ä¸­ï¼Œå½“ä¸€ä¸ªç±»ä½¿ç”¨`enum`å…³é”®å­—å®šä¹‰åï¼Œé»˜è®¤ä¼šç»§æ‰¿`java.lang.Enum`ã€‚è¿™æ„å‘³ç€è¯¥æšä¸¾ç±»å‹æ˜¯ä¸å¯å†æ‰©å±•çš„ï¼Œå¹¶ä¸”ä¼šè¢«ç¼–è¯‘å™¨æ ‡è®°ä¸º final ä»¥é˜²æ­¢ä»»ä½•å­ç±»å‹çš„åˆ›å»ºã€‚

## Timer ç±»é«˜çº§ç”¨æ³•

### å…­ç§æ‰§è¡Œä»»åŠ¡çš„æ–¹æ³•

```java
import java.util.Calendar;
import java.util.Date;
import java.util.Timer;
import java.util.TimerTask;
public class TimerUtil {
    public static void main(String[] args) throws Exception {
        System.out.println(new Date().getTime() + "-------å¼€å§‹å®šæ—¶ä»»åŠ¡--------");
        timer1();
        timer2();
        timer3();
        timer4();
        timer5();
        timer6();
    }
    // ç¬¬ä¸€ç§æ–¹æ³•ï¼šæŒ‡å®šä»»åŠ¡taskåœ¨æŒ‡å®šæ—¶é—´timeæ‰§è¡Œ
    // schedule(TimerTask task, Date time)
    public static void timer1() {
        Calendar calendar = Calendar.getInstance();
        calendar.set(Calendar.HOUR_OF_DAY, 0); // æ§åˆ¶æ—¶
        calendar.set(Calendar.MINUTE, 0);    // æ§åˆ¶åˆ†
        calendar.set(Calendar.SECOND, 0);    // æ§åˆ¶ç§’
        Date time = calendar.getTime();     // å¾—å‡ºæ‰§è¡Œä»»åŠ¡çš„æ—¶é—´,æ­¤å¤„ä¸ºä»Šå¤©çš„00ï¼š00ï¼š00
        Timer timer = new Timer();
        timer.schedule(new TimerTask() {
            @Override
            public void run() {
                System.out.println(new Date().getTime() + "-------å®šæ—¶ä»»åŠ¡1--------");
            }
        }, time);
    }
    // ç¬¬äºŒç§æ–¹æ³•ï¼šæŒ‡å®šä»»åŠ¡taskåœ¨æŒ‡å®šå»¶è¿Ÿdelayåæ‰§è¡Œ
    // schedule(TimerTask task, long delay)
    public static void timer2() {
        Timer timer = new Timer();
        timer.schedule(new TimerTask() {
            @Override
            public void run() {
                System.out.println(new Date().getTime() + "-------å®šæ—¶ä»»åŠ¡2--------");
            }
        }, 2000); // æŒ‡å®šå»¶è¿Ÿ2000æ¯«ç§’åæ‰§è¡Œ
    }
    // ç¬¬ä¸‰ç§æ–¹æ³•ï¼šæŒ‡å®šä»»åŠ¡taskåœ¨æŒ‡å®šæ—¶é—´firstTimeæ‰§è¡Œåï¼Œè¿›è¡Œé‡å¤å›ºå®šå»¶è¿Ÿé¢‘ç‡periodçš„æ‰§è¡Œ
    // schedule(TimerTask task, Date firstTime, long period)
    public static void timer3() {
        Calendar calendar = Calendar.getInstance();
        calendar.set(Calendar.HOUR_OF_DAY, 0); // æ§åˆ¶æ—¶
        calendar.set(Calendar.MINUTE, 0);    // æ§åˆ¶åˆ†
        calendar.set(Calendar.SECOND, 0);    // æ§åˆ¶ç§’
        Date time = calendar.getTime();     // å¾—å‡ºæ‰§è¡Œä»»åŠ¡çš„æ—¶é—´,æ­¤å¤„ä¸ºä»Šå¤©çš„00ï¼š00ï¼š00
        Timer timer = new Timer();
        timer.schedule(new TimerTask() {
            @Override
            public void run() {
                System.out.println(new Date().getTime() + "-------å®šæ—¶ä»»åŠ¡3--------");
            }
        }, time, 1000 * 60 * 60 * 24);
    }
    // ç¬¬å››ç§æ–¹æ³•ï¼šæŒ‡å®šä»»åŠ¡taskåœ¨æŒ‡å®šå»¶è¿Ÿdelayåï¼Œè¿›è¡Œé‡å¤å›ºå®šå»¶è¿Ÿé¢‘ç‡periodçš„æ‰§è¡Œ
    // schedule(TimerTask task, long delay, long period)
    public static void timer4() {
        Timer timer = new Timer();
        timer.schedule(new TimerTask() {
            @Override
            public void run() {
                System.out.println(new Date().getTime() + "-------å®šæ—¶ä»»åŠ¡4--------");
            }
        }, 1000, 5000);
    }
    // ç¬¬äº”ç§æ–¹æ³•ï¼šæŒ‡å®šä»»åŠ¡taskåœ¨æŒ‡å®šæ—¶é—´firstTimeæ‰§è¡Œåï¼Œè¿›è¡Œé‡å¤å›ºå®šå»¶è¿Ÿé¢‘ç‡periodçš„æ‰§è¡Œ
    // scheduleAtFixedRate(TimerTask task, Date firstTime, long period)
    public static void timer5() {
        Calendar calendar = Calendar.getInstance();
        calendar.set(Calendar.HOUR_OF_DAY, 0); // æ§åˆ¶æ—¶
        calendar.set(Calendar.MINUTE, 0);    // æ§åˆ¶åˆ†
        calendar.set(Calendar.SECOND, 0);    // æ§åˆ¶ç§’
        Date time = calendar.getTime();     // å¾—å‡ºæ‰§è¡Œä»»åŠ¡çš„æ—¶é—´,æ­¤å¤„ä¸ºä»Šå¤©çš„00ï¼š00ï¼š00
        Timer timer = new Timer();
        timer.scheduleAtFixedRate(new TimerTask() {
            @Override
            public void run() {
                System.out.println(new Date().getTime() + "-------å®šæ—¶ä»»åŠ¡5--------");
            }
        }, time, 1000 * 60 * 60 * 24);
    }
    // ç¬¬å…­ç§æ–¹æ³•ï¼šæŒ‡å®šä»»åŠ¡taskåœ¨æŒ‡å®šå»¶è¿Ÿdelayåï¼Œè¿›è¡Œé‡å¤å›ºå®šå»¶è¿Ÿé¢‘ç‡periodçš„æ‰§è¡Œ
    // scheduleAtFixedRate(TimerTask task, long delay, long period)
    public static void timer6() {
        Timer timer = new Timer();
        timer.scheduleAtFixedRate(new TimerTask() {
            @Override
            public void run() {
                System.out.println(new Date().getTime() + "-------å®šæ—¶ä»»åŠ¡6--------");
            }
        }, 1000, 2000);
    }
}
```

## Cron è¡¨è¾¾å¼è¯¦è§£

Cron è¡¨è¾¾å¼çš„æ ¼å¼ç”±è‡³å°‘ 6 ä¸ªéƒ¨åˆ†ç»„æˆï¼Œæ¯ä¸€éƒ¨åˆ†ä½¿ç”¨ç©ºæ ¼åˆ†éš”ï¼š

1. ç§’ (0-59)
2. åˆ†é’Ÿ (0-59)
3. å°æ—¶ (0-23)
4. æ—¥æœŸ (0-31)
5. æœˆä»½ (0-11 æˆ– JAN-DEC)
6. æ˜ŸæœŸå‡  (0-7 æˆ– SUN-SATï¼Œå…¶ä¸­ 0 å’Œ 7 éƒ½è¡¨ç¤ºå‘¨æ—¥)

### å¸¸ç”¨å®ä¾‹

#### æ¯éš”è‹¥å¹²æ—¶é—´æ‰§è¡Œ

- æ¯éš” 5 ç§’ï¼š`*/5 * * * * ?`
- æ¯éš” 1 åˆ†é’Ÿï¼š`0 */1 * * * ?`

#### å®šæ—¶ä»»åŠ¡

- æ¯å¤© 23 ç‚¹æ‰§è¡Œï¼š`0 0 23 * * ?`
- æ¯æ—¥å‡Œæ™¨ 1 ç‚¹æ‰§è¡Œï¼š`0 0 1 * * ?`
- æ¯æœˆ 1 å·å‡Œæ™¨ 1 ç‚¹æ‰§è¡Œï¼š`0 0 1 1 * ?`

#### å¤æ‚ä»»åŠ¡è°ƒåº¦

- æ¯å¤©çš„ 0 ç‚¹ã€13 ç‚¹ã€18 ç‚¹å’Œ 21 ç‚¹è§¦å‘ä¸€æ¬¡ä»»åŠ¡ï¼š`0 0 0,13,18,21 * * ?`
- åœ¨æ¯å¤©ä¸Šåˆ 10:15 æ‰§è¡Œï¼š`0 15 10 * * ?`

### Cron è¡¨è¾¾å¼é«˜çº§ç”¨æ³•

- æ¯æœˆæœ€åä¸€å¤©æ™šä¸Š 11 ç‚¹è§¦å‘ä¸€æ¬¡ä»»åŠ¡ï¼š`0 0 23 L * ?`
- æ¯å¹´çš„æŸä¸ªç‰¹å®šæ˜ŸæœŸå‡ ï¼ˆå¦‚æ¯å‘¨ä¸‰ï¼‰çš„æŸæ—¶æ‰§è¡Œï¼š`0 0 12 ? * WED`

### ç‰¹æ®Šå­—ç¬¦çš„æ„ä¹‰

- `*`: æ‰€æœ‰å¯èƒ½å€¼ã€‚
- `,`: åˆ†éš”åˆ—è¡¨ä¸­çš„å¤šä¸ªå€¼ã€‚
- `-`: è¡¨ç¤ºåŒºé—´ï¼Œå¦‚ `6-8/2` è¡¨ç¤ºåœ¨ç¬¬ 6ã€8 åˆ†é’Ÿæ—¶æ‰§è¡Œä»»åŠ¡ã€‚
- `/`: æŒ‡å®šå¢é‡æ­¥é•¿ã€‚

## è§£å†³`java.lang.OutOfMemoryError: PermGen space`

### å¸¸è§çš„è§£å†³æ–¹æ¡ˆ

```bash
-server -XX:PermSize=256M -XX:MaxPermSize=512m
```

è¿™è¡Œå‘½ä»¤å¯ä»¥é€šè¿‡è°ƒæ•´æ°¸ä¹…ä»£ï¼ˆPermanent Generationï¼‰çš„ç©ºé—´å¤§å°æ¥è§£å†³å†…å­˜æº¢å‡ºé—®é¢˜ã€‚

## ä½¿ç”¨ CXF ç”Ÿæˆå®¢æˆ·ç«¯ä»£ç 

Apache CXF æä¾›äº† wsdl2java å·¥å…·ç”¨äºä» WSDL æ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆ Java å®¢æˆ·ç«¯ä»£ç ã€‚å…¶åŸºæœ¬ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š

```bash
/opt/apache-cxf-3.2.5/bin/wsdl2java -client -encoding utf-8 'http://172.16.4.207/iavpwebservice/CallOut.asmx?wsdl'
```

## JDK 8 ä¸­æ¨èä½¿ç”¨çš„æ—¥æœŸå¤„ç†ç±»

JDK 8 å¼•å…¥äº†æ–°çš„æ—¥æœŸå’Œæ—¶é—´ APIï¼ŒåŒ…æ‹¬`Instant`, `LocalDateTime`, å’Œ `DateTimeFormatter`ç­‰ã€‚è¿™äº›æ–°å·¥å…·æ¯”æ—§çš„`Date`å’Œ`Calendar`æ›´å¼ºå¤§ä¸”æ˜“äºä½¿ç”¨ã€‚

### ç¤ºä¾‹ä»£ç 

```java
// å¾—åˆ°å°æ—¶
private int getHour(Date date) {
    Calendar calendar = Calendar.getInstance();
    calendar.setTime(date);
    return calendar.get(Calendar.HOUR_OF_DAY);
}

// å¾—åˆ°åˆ†é’Ÿ
private int getMinute(Date date) {
    Calendar calendar = Calendar.getInstance();
    calendar.setTime(date);
    return calendar.get(Calendar.MINUTE);
}

// è®¾ç½®å°æ—¶
private Date setHour(int hour, Date date) {
    Calendar calendar = Calendar.getInstance();
    calendar.setTime(date);
    calendar.set(Calendar.HOUR_OF_DAY, hour);
    return calendar.getTime();
}

// è®¾ç½®åˆ†é’Ÿ
private Date setMinute(int minute, Date date) {
    Calendar calendar = Calendar.getInstance();
    calendar.setTime(date);
    calendar.set(Calendar.MINUTE, minute);
    return calendar.getTime();
}
```

## æ‰“å° GC è¯¦æƒ…

ä¸ºäº†èƒ½å¤Ÿè·å¾—è¯¦ç»†çš„ GC ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¯æ¬¡åƒåœ¾å›æ”¶çš„æ—¶é—´ã€æŒç»­æ—¶é—´å’Œåº”ç”¨ç¨‹åºæš‚åœæ—¶é—´ç­‰ç»†èŠ‚æ•°æ®ï¼Œå¯ä»¥åœ¨å¯åŠ¨ JVM æ—¶æ·»åŠ ä»¥ä¸‹é€‰é¡¹ï¼š

```bash
java -XX:+PrintGCTimeStamps
-XX:-PrintClassHistogram
-XX:+PrintHeapAtGC
-verbose:gc
-XX:+PrintGCDetails
-XX:+PrintGCTimeStamps
-XX:+PrintGCApplicationStoppedTime
-XX:+HeapDumpOnOutOfMemoryError
```

è¿™äº›é€‰é¡¹çš„ä½œç”¨åˆ†åˆ«æ˜¯ï¼š

1. `-XX:+PrintGCTimeStamps` - æ¯æ¬¡åƒåœ¾å›æ”¶éƒ½è®°å½•æ—¶é—´æˆ³ï¼›
2. `-XX:-PrintClassHistogram` - æ‰“å°ç±»çš„ç›´æ–¹å›¾ï¼ˆé€šå¸¸åœ¨ Full GC åæ‰“å°ï¼‰ï¼›
3. `-XX:+PrintHeapAtGC` - åœ¨æ¯æ¬¡åƒåœ¾å›æ”¶ä¹‹å‰è¾“å‡ºå †ä¿¡æ¯ï¼›
4. `-verbose:gc` - è¾“å‡ºç®€è¦çš„ GC æ—¥å¿—ä¿¡æ¯ï¼›
5. `-XX:+PrintGCDetails` - æ‰“å°è¯¦ç»†çš„ GC æ—¥å¿—ã€‚

## ç§»é™¤å­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰ç©ºæ ¼

åœ¨å¤„ç†æ–‡æœ¬æ•°æ®æ—¶ï¼Œç»å¸¸éœ€è¦å»é™¤ä¸å¿…è¦çš„ç©ºç™½å­—ç¬¦ã€‚ä»¥ä¸‹æ˜¯å‡ ç§æœ‰æ•ˆçš„ç§»é™¤æ–¹æ³•ï¼š

### ä½¿ç”¨ Apache Commons Lang åº“

æœ€ç®€å•ç›´æ¥çš„æ–¹æ³•æ˜¯ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“å¦‚ Apache Commons Lang çš„`StringUtils.deleteWhitespace()`å‡½æ•°ã€‚

```java
import org.apache.commons.lang3.StringUtils;

public class StringProcessor {
    public static void main(String[] args) {
        System.out.println(StringUtils.deleteWhitespace(" a b c d "));
    }
}
```

### æ‰‹åŠ¨å®ç°å»é™¤æ‰€æœ‰ç©ºæ ¼

1. ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢ï¼š

   ```java
   public class MainClass {
       public static void main(String[] args) {
           String str = " hell o ";
           System.out.println(str.replaceAll("\\s+", ""));
       }
   }
   ```

2. éå†å­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—ç¬¦ï¼Œå¹¶ä½¿ç”¨`StringBuilder`æ„å»ºæ–°å­—ç¬¦ä¸²ï¼š

   ```java
   public class MainClass {
       public static void main(String[] args) {
           String str = " a b c d ";
           StringBuilder sb = new StringBuilder();
           for (int i = 0; i < str.length(); i++) {
               if (!Character.isWhitespace(str.charAt(i))) {
                   sb.append(str.charAt(i));
               }
           }
           System.out.println(sb.toString());
       }
   }
   ```

3. ä½¿ç”¨`replaceAll()`æ–¹æ³•å¤„ç†è¿ç»­çš„ç©ºæ ¼ï¼š
   ```java
   public class MainClass {
       public static void main(String[] args) {
           String str = " hell o ";
           str = str.replaceAll(" +", "");
           System.out.println(str);
       }
   }
   ```

## éå† Properties å¯¹è±¡

`Properties`ç±»æä¾›äº†å¤šç§éå†å…¶å†…éƒ¨æ•°æ®çš„æ–¹å¼ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼š

```java
public static void printProp(Properties properties) {
    System.out.println("---------ï¼ˆæ–¹å¼ä¸€ï¼‰------------");
    for (String key : properties.stringPropertyNames()) {
        System.out.println(key + "=" + properties.getProperty(key));
    }

    System.out.println("---------ï¼ˆæ–¹å¼äºŒï¼‰------------");
    Set<Object> keys = properties.keySet();
    for (Object key : keys) {
       System.out.println(key.toString() + "=" + properties.get(key));
    }

    System.out.println("---------ï¼ˆæ–¹å¼ä¸‰ï¼‰------------");
    Set<Map.Entry<Object, Object>> entrySet = properties.entrySet();
    for (Map.Entry<Object, Object> entry : entrySet) {
        System.out.println(entry.getKey() + "=" + entry.getValue());
    }

    System.out.println("---------ï¼ˆæ–¹å¼å››ï¼‰------------");
    Enumeration<?> e = properties.propertyNames();
    while (e.hasMoreElements()) {
       String key = (String) e.nextElement();
       String value = properties.getProperty(key);
        System.out.println(key + "=" + value);
   }
}
```

## [Java åŸºç¡€ï¼šä¸€äº›å¸¸è§çš„ä»£ç ç‰‡æ®µä¸€](https://blog.dong4j.site/posts/205d1f36.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å‡ ç§å¸¸è§çš„ Java ç¼–ç¨‹æŠ€æœ¯åŠå…¶ç›¸å…³çŸ¥è¯†ç‚¹ï¼Œå¹¶æä¾›ä¸€äº›æœ€ä½³å®è·µå’Œæ³¨æ„äº‹é¡¹ã€‚è¿™äº›å†…å®¹åŒ…æ‹¬é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰ã€ä½¿ç”¨ Jackson è¿›è¡Œæ³›å‹ååºåˆ—åŒ–ã€å•æ¬¡æ‰§è¡Œé€»è¾‘çš„å®ç°æ–¹æ³•ï¼Œä»¥åŠé˜²æ­¢ä¸»çº¿ç¨‹é€€å‡ºç­‰ã€‚

## é¢å‘åˆ‡é¢ç¼–ç¨‹ (Aspect-Oriented Programming, AOP)

### ä»£ç ç‰‡æ®µå±•ç¤º

```java
try {
    try {
        doBefore(); // å¯¹åº”@Beforeæ³¨è§£çš„æ–¹æ³•åˆ‡é¢é€»è¾‘
        method.invoke();
    } finally {
        doAfter(); //å¯¹åº”@Afteræ³¨è§£çš„æ–¹æ³•åˆ‡é¢é€»è¾‘
    }
    doAfterReturning(); //å¯¹åº”@AfterReturningæ³¨è§£çš„æ–¹æ³•åˆ‡é¢é€»è¾‘
} catch (Exception e) {
    doAfterThrowing(); // å¯¹åº”@AfterThrowingæ³¨è§£çš„æ–¹æ³•åˆ‡é¢é€»è¾‘
}
```

### è§£é‡Šä¸æ³¨æ„äº‹é¡¹

AOP æ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œç”¨äºå°†æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆå¦‚æ—¥å¿—ã€äº‹åŠ¡å¤„ç†ç­‰ï¼‰ä»æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¸­åˆ†ç¦»å‡ºæ¥ã€‚ä¸Šè¿°ä»£ç å±•ç¤ºäº†å¦‚ä½•é€šè¿‡ try-catch-finally ç»“æ„æ¥æ¨¡æ‹Ÿ AOP ä¸­çš„é€šçŸ¥æ‰§è¡Œé¡ºåºã€‚

- **æœ€ä½³å®è·µ**ï¼š

  - ç¡®ä¿`doBefore()`æ–¹æ³•åœ¨ä¸»è¦ä¸šåŠ¡é€»è¾‘å¼€å§‹ä¹‹å‰è¢«è°ƒç”¨ã€‚
  - `doAfterReturning()`åº”åœ¨ä¸šåŠ¡é€»è¾‘æˆåŠŸè¿”å›æ—¶è¢«è§¦å‘ï¼Œè¡¨ç¤ºæ­£å¸¸ç»“æŸã€‚
  - `catch`å—å†…çš„`doAfterThrowing()`ç”¨äºæ•è·å¹¶å¤„ç†ä»»ä½•å¼‚å¸¸ã€‚

- **æ³¨æ„äº‹é¡¹**ï¼š
  - è€ƒè™‘åˆ°ä»£ç å¯ç»´æŠ¤æ€§ä¸æ‰©å±•æ€§ï¼Œåœ¨å®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨ Spring AOP æ¡†æ¶æˆ–å…¶ä»–æˆç†Ÿçš„ AOP å·¥å…·åº“æ¥å®ç°è¿™äº›é€»è¾‘ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨å¤åˆ¶ç²˜è´´ä¸Šè¿°ç»“æ„ã€‚

## ä½¿ç”¨ Jackson è¿›è¡Œæ³›å‹ååºåˆ—åŒ–

### ä»£ç ç‰‡æ®µå±•ç¤º

```java
CollectionType javaType = mapper.getTypeFactory().constructCollectionType(List.class, MyDto.class);
List<MyDTO> asList = mapper.readValue(jsonArray, javaType);
```

### è§£é‡Šä¸æ³¨æ„äº‹é¡¹

å½“éœ€è¦å°† JSON å­—ç¬¦ä¸²è§£æä¸ºå¸¦æœ‰æ³›å‹ç±»å‹çš„åˆ—è¡¨æ—¶ï¼ŒJackson åº“æä¾›äº†ä¸€ç§ç®€ä¾¿çš„æ–¹æ³•ã€‚

- **æœ€ä½³å®è·µ**ï¼š
  - ä½¿ç”¨`constructCollectionType()`æ–¹æ³•æ¥æŒ‡å®šå…·ä½“çš„é›†åˆç±»å‹åŠå…ƒç´ ç±»å‹ã€‚
  - å°½å¯èƒ½ä¿æŒåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ•°æ®ç»“æ„ä¸€è‡´ï¼Œä»¥é¿å…å‡ºç°ä¸å¿…è¦çš„é”™è¯¯æˆ–ä¸å…¼å®¹é—®é¢˜ã€‚

## å•æ¬¡æ‰§è¡Œé€»è¾‘çš„å®ç°

### ä»£ç ç‰‡æ®µå±•ç¤º

```java
AtomicBoolean WARNED_TOO_MANY_INSTANCES = new AtomicBoolean();

if(WARNED_TOO_MANY_INSTANCES.compareAndSet(false, true)){
    xxxx //å…·ä½“æ“ä½œé€»è¾‘
}
```

### è§£é‡Šä¸æ³¨æ„äº‹é¡¹

æ­¤æ®µä»£ç ä½¿ç”¨äº†`AtomicBoolean`ç±»æ¥ç¡®ä¿æŸæ®µç‰¹å®šçš„æ‰§è¡Œé€»è¾‘åœ¨æ•´ä¸ªç¨‹åºç”Ÿå‘½å‘¨æœŸä¸­ä»…è¢«æ‰§è¡Œä¸€æ¬¡ã€‚

- **æœ€ä½³å®è·µ**ï¼š
  - ä½¿ç”¨åŸå­æ€§æ•°æ®ç±»å‹å¦‚`AtomicBoolean`å¯ä»¥æœ‰æ•ˆé¿å…å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„ç«æ€æ¡ä»¶é—®é¢˜ã€‚

## åˆ†å‰²å­—ç¬¦ä¸²ä¸ºè¿­ä»£å™¨

### ä»£ç ç‰‡æ®µå±•ç¤º

```java
Splitter.on(",").trimResults().omitEmptyStrings().split(str)
```

- **æœ€ä½³å®è·µ**ï¼š
  - ä½¿ç”¨ Guava åº“çš„`Splitter`ç±»å¯ä»¥æ›´çµæ´»åœ°å¤„ç†å¤æ‚çš„æ–‡æœ¬åˆ†å‰²ä»»åŠ¡ï¼Œæ”¯æŒå¤šç§é…ç½®é€‰é¡¹ï¼ˆå¦‚å¿½ç•¥ç©ºå­—ç¬¦ä¸²ã€ä¿®å‰ªç»“æœç­‰ï¼‰ã€‚

## Slf4j å ä½ç¬¦æ ¼å¼åŒ–

### ä»£ç ç‰‡æ®µå±•ç¤º

```java
FormattingTuple ft = MessageFormatter.arrayFormat(appendLogPattern, appendLogArguments);
```

- **æœ€ä½³å®è·µ**ï¼š
  - ä½¿ç”¨`MessageFormatter`ç±»å¯ä»¥é¿å…ç¡¬ç¼–ç å­—ç¬¦ä¸²ä¸­çš„å ä½ç¬¦ï¼Œä»è€Œæé«˜æ—¥å¿—ä¿¡æ¯çš„å¯è¯»æ€§å’Œæ˜“ç®¡ç†æ€§ã€‚

## é˜²æ­¢ Java ä¸»çº¿ç¨‹é€€å‡º

### å®ç°ä»£ç å±•ç¤º

```java
public class StartMain {

    private static final ReentrantLock LOCK = new ReentrantLock();
    private static final Condition STOP = LOCK.newCondition();

    public static void main(String[] args) {
        AbstractApplicationContext applicationContext = new ClassPathXmlApplicationContext("applicationContext.xml");
        applicationContext.start();
        logger.info("service start success !~");
        addHook(applicationContext);
        try {
            LOCK.lock();
            STOP.await();
        } catch (InterruptedException e) {
            logger.warn(" service   stopped, interrupted by other thread!", e);
        } finally {
            LOCK.unlock();
        }
    }

    private static void addHook(AbstractApplicationContext applicationContext) {
        Runtime.getRuntime().addShutdownHook(new Thread(() -> {
            try {
                applicationContext.stop();
            } catch (Exception e) { logger.error("StartMain stop exception ", e); }

            logger.info("jvm exit, all service stopped.");
            LOCK.lock();
            STOP.signal();
        }, "StartMain-shutdown-hook"));
    }

}
```

- **æœ€ä½³å®è·µ**ï¼š
  - åœ¨åº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹æ³¨å†Œä¸€ä¸ª`shutdown hook`ï¼Œç¡®ä¿åœ¨ JVM é€€å‡ºå‰èƒ½å¤Ÿæ­£å¸¸å…³é—­æœåŠ¡ã€‚

## BeanDefinitionRegistryPostProcessor çš„åº”ç”¨

### ç¤ºä¾‹ä»£ç å±•ç¤º

```java
@Component
public class RegistryDemo implements BeanDefinitionRegistryPostProcessor {
    @Override
    public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry beanDefinitionRegistry) throws BeansException {
        GenericBeanDefinition definition = new GenericBeanDefinition();
        definition.setBeanClass(Demo.class); //è®¾ç½®ç±»
        definition.setScope("singleton"); //è®¾ç½®scope
        definition.setLazyInit(false); //è®¾ç½®æ˜¯å¦æ‡’åŠ è½½
        definition.setAutowireCandidate(true); //è®¾ç½®æ˜¯å¦å¯ä»¥è¢«å…¶ä»–å¯¹è±¡è‡ªåŠ¨æ³¨å…¥
        beanDefinitionRegistry.registerBeanDefinition("demo", definition);
    }
}
```

- **æœ€ä½³å®è·µ**ï¼š
  - ä½¿ç”¨`BeanDefinitionRegistryPostProcessor`å¯ä»¥åœ¨ Spring å®¹å™¨å¯åŠ¨ä¹‹å‰å¯¹ bean çš„å®šä¹‰è¿›è¡Œè‡ªå®šä¹‰ä¿®æ”¹ã€‚

## instanceof, isInstance, isAssignableFrom çš„åŒºåˆ«

### è§£é‡Šä¸å®ä¾‹åˆ†æ

```java
String s = new String("javaisland");

// trueï¼Œè‡ªèº«å®ä¾‹æˆ–å­ç±»å®ä¾‹ instanceof è‡ªèº«ç±»
System.out.println(s instanceof String);

// ä½¿ç”¨Classç±»çš„isInstance(Object obj)æ–¹æ³•è¿›è¡Œæµ‹è¯•ã€‚
// æ­£ç¡®çš„æµ‹è¯•åº”ä¸ºï¼šè‡ªèº«ç±».class.isInstance(è‡ªèº«å®ä¾‹æˆ–å­ç±»å®ä¾‹)
String s = new String("javaisland");
System.out.println(String.class.isInstance(s)); // true

// Class ç±»çš„ isAssignableFrom (Class cls) æ–¹æ³•
System.out.println(ArrayList.class.isAssignableFrom(Object.class));  // false
System.out.println(Object.class.isAssignableFrom(ArrayList.class));  // true
```

- **æœ€ä½³å®è·µ**ï¼š
  - åœ¨ç¼–ç¨‹ä¸­ï¼Œæ ¹æ®å…·ä½“çš„ä½¿ç”¨åœºæ™¯é€‰æ‹©åˆé€‚çš„æ–¹æ³•æ¥æ£€æµ‹ç±»å‹å…³ç³»ã€‚å¯¹äºå¯¹è±¡å®ä¾‹çš„ç›´æ¥åˆ¤æ–­ï¼Œ`instanceof`è¿ç®—ç¬¦é€šå¸¸æ˜¯æœ€ç®€å•ç›´æ¥çš„é€‰æ‹©ã€‚

## Dubbo ç™¾åˆ†æ•°ä¸ Double äº’è½¬

### ç™¾åˆ†æ•°è½¬ Double

```java
// import java.text.NumberFormat;
// import java.text.ParseException;

try {
    // æ¥å£è¿”å›çš„æ˜¯Numberå¯¹è±¡ï¼Œä½†æ˜¯å®é™…æ˜¯Doubleç±»å‹
    Double num = (Double) NumberFormat.getInstance().parse("67.89%");  // è½¬æ¢çš„ç»“æœæ˜¯67.89

    // ä½¿ç”¨ getPercentInstance() æ–¹æ³•æ¥æ­£ç¡®è§£æç™¾åˆ†æ¯”å­—ç¬¦ä¸²ä¸ºDoubleç±»å‹çš„å€¼ï¼Œç»“æœä¼šè½¬æ¢æˆçœŸæ­£çš„ç™¾åˆ†æ¯”å€¼ï¼Œå³0.6789
    Double num2 = (Double) NumberFormat.getPercentInstance().parse("67.89%");  // è½¬æ¢çš„ç»“æœæ˜¯0.6789

    System.out.println(num);
} catch (ParseException e) {
    e.printStackTrace();
}
```

### Double è½¬ç™¾åˆ†æ•°

```java
// import java.text.NumberFormat;
try {
    NumberFormat percentInstance = NumberFormat.getPercentInstance(); // åˆ›å»ºä¸€ä¸ªæ ¼å¼åŒ–ä¸ºç™¾åˆ†æ¯”çš„NumberFormatterå¯¹è±¡
    percentInstance.setMaximumFractionDigits(2);  // è®¾ç½®æœ€å¤šä¿ç•™ä¸¤ä½å°æ•°

    String formattedValue = percentInstance.format(0.81247);  // å°†Doubleç±»å‹è½¬æ¢ä¸ºåŒ…å«ä¸¤ä½å°æ•°çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚"81.25%"

    System.out.println(formattedValue);
} catch (Exception e) {
    // è¿™é‡Œä¸éœ€è¦æ•è·ParseExceptionï¼Œå› ä¸ºformatæ–¹æ³•ä¸ä¼šæŠ›å‡ºè¯¥å¼‚å¸¸
}
```

## Lombok æ³¨è§£è¯¦è§£

Lombok æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ Java åº“ï¼Œç”¨äºå‡å°‘æ ·æ¿ä»£ç ã€‚

- `@val`: ç±»ä¼¼äº final çš„å˜é‡å£°æ˜ã€‚
- `@var`: ä¸ JDK10 ä¸­çš„`var`å…³é”®å­—ç±»ä¼¼ã€‚
- `@Data`: è‡ªåŠ¨ä¸ºç±»ç”Ÿæˆ`get`/`set`æ–¹æ³•ï¼Œå¹¶ä¸”å®ç°`equals`ã€`hashCode`å’Œ`toString`ç­‰æ–¹æ³•ã€‚
- `@Setter`, `@Getter`: åˆ†åˆ«ç”¨äºè‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰æˆ–ç‰¹å®šå­—æ®µçš„ setter/getter æ–¹æ³•ã€‚
- `@NotNull`: æŒ‡å®šå‚æ•°ä¸èƒ½ä¸º nullï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚
- `@Synchronized`: å¯¹äºæŒ‡å®šçš„æ–¹æ³•æ·»åŠ åŒæ­¥æ§åˆ¶ã€‚
- `@Builder`: ä½¿ç”¨ builder æ¨¡å¼æ¥åˆ›å»ºå¯¹è±¡å®ä¾‹ã€‚
- `@NoArgsConstructor`, `@AllArgsConstructor`: åˆ†åˆ«æä¾›æ— å‚æ„é€ å™¨å’Œå…¨å‚æ„é€ å™¨ã€‚
- `@Accessors(chain = true)`: ä½¿å¾— setter æ–¹æ³•è¿”å›å½“å‰å¯¹è±¡æœ¬èº«ï¼Œç”¨äºé“¾å¼è°ƒç”¨ã€‚
- `@RequiredArgsConstructor`: ä¸ºç±»ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰æ‰€æœ‰ final å­—æ®µæˆ–æ ‡è®°ä¸º`@NonNull`çš„æ„é€ å‡½æ•°ã€‚
- `@UtilityClass`, `@ExtensionMethod`, `@FieldDefaults`: æä¾›å·¥å…·ç±»ã€æ‰©å±•çˆ¶ç±»å’Œè®¾ç½®å±æ€§çš„è®¿é—®çº§åˆ«ç­‰ç‰¹æ€§ã€‚
- `@Cleanup`: ç¡®ä¿åœ¨ä½¿ç”¨å®Œæµèµ„æºåè‡ªåŠ¨å…³é—­å®ƒä»¬ã€‚

### æ³¨æ„äº‹é¡¹

å½“ä½¿ç”¨ Lombok çš„ `Builder` æ³¨è§£æ—¶ï¼Œå¦‚æœæƒ³è¦ä¸ºæŸä¸ªå­—æ®µæŒ‡å®šé»˜è®¤å€¼ï¼Œå¹¶ä¸”å¸Œæœ›è¿™ä¸ªé»˜è®¤å€¼ä¸ä¼šè¢«æ¸…é™¤ï¼Œåˆ™éœ€è¦é¢å¤–æ·»åŠ  `@lombok.Builder.Default` æ³¨è§£åˆ°è¯¥å±æ€§ä¸Šã€‚è¿™å…è®¸ä½ å®šä¹‰ä¸€ä¸ªåˆå§‹å€¼ï¼Œå³ä½¿åœ¨æœªæä¾›ç‰¹å®šæ„é€ å‚æ•°çš„æƒ…å†µä¸‹ä¹Ÿèƒ½ä¿æŒå…¶æœ‰æ•ˆæ€§ã€‚

## ä½¿ç”¨ Lombok @Builder å¯¼è‡´é»˜è®¤å€¼æ— æ•ˆ

```java
// ç¤ºä¾‹ä»£ç å±•ç¤ºå¦‚ä½•æ­£ç¡®ä½¿ç”¨ @Builder å’Œ @lombok.Builder.Default æ¥ç¡®ä¿é»˜è®¤å€¼ä¸è¢«æ¸…é™¤ã€‚
public class User {
    private String name;
    private int age;

    // ä½¿ç”¨ Lombok çš„ Builder æ³¨è§£æ¥åˆ›å»ºç”¨æˆ·å¯¹è±¡
    @Builder
    public User(String name, int age) {
        this.name = name;
        this.age = age;
    }

    // ä¸º 'age' å­—æ®µæ·»åŠ é»˜è®¤å€¼ï¼ŒåŒæ—¶ä½¿ç”¨ @lombok.Builder.Default ç¡®ä¿å…¶ä¸ä¼šåœ¨æ„å»ºæ—¶è¢«æ¸…é™¤ã€‚
    @Builder.Default
    private int defaultAge = 20; // è®¾ç½®ä¸€ä¸ªé»˜è®¤å¹´é¾„

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public int getAge() {
        return age;
    }

    public void setAge(int age) {
        this.age = age;
    }
}
```

## Optional ç±»çš„ä½¿ç”¨

`Optional`ç±»æä¾›äº†å¤„ç†å¯èƒ½ä¸ºç©ºçš„å¯¹è±¡çš„æ–¹å¼ï¼Œé¿å…äº†ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚

```java
public class Java8Tester {
   public static void main(String args[]){

      Java8Tester java8Tester = new Java8Tester();

      // ä¼ å…¥çš„ä¸¤ä¸ªå‚æ•°å€¼åˆ†åˆ«æ˜¯ null å’Œä¸€ä¸ªæ•´æ•°å®ä¾‹åŒ–åçš„å¯¹è±¡
      Integer value1 = null;
      Integer value2 = new Integer(10);

      // Optional.ofNullable - å…è®¸ä¼ é€’ä¸º null å‚æ•°ï¼Œç”¨äºåˆ›å»ºOptionalå®ä¾‹ã€‚
       Optional<Integer> a = Optional.ofNullable(value1);

      // Optional.of - å¦‚æœä¼ é€’çš„å‚æ•°æ˜¯null, æŠ›å‡ºå¼‚å¸¸ NullPointerException
      Optional<Integer> b = Optional.of(value2);

      System.out.println(java8Tester.sum(a,b));
   }

   public Integer sum(Optional<Integer> a, Optional<Integer> b){
        boolean valueExistsA = a.isPresent(); // åˆ¤æ–­å€¼æ˜¯å¦å­˜åœ¨
        boolean valueExistsB = b.isPresent();

        System.out.println(" ç¬¬ä¸€ä¸ªå‚æ•°å€¼å­˜åœ¨: " + valueExistsA);
        System.out.println(" ç¬¬äºŒä¸ªå‚æ•°å€¼å­˜åœ¨: " + valueExistsB);

        Integer valA = a.orElse(new Integer(0)); // å¦‚æœå€¼å­˜åœ¨ï¼Œè¿”å›å®ƒï¼›å¦åˆ™ä½¿ç”¨é»˜è®¤å€¼ã€‚

       Integer valB = b.get();  // è·å–å€¼, å€¼éœ€è¦å­˜åœ¨
      return valA + valB;
   }
}
```

## Spring è¯»å– Classpath ä¸‹çš„æ–‡ä»¶

### æ–¹æ³•ä¸€ï¼šåˆ©ç”¨ `this.getClass().getResource()` æˆ– `this.getClass().getResourceAsStream()`

è¿™ä¸¤ç§æ–¹å¼é€‚ç”¨äºä»å½“å‰ç±»èµ„æºè·¯å¾„ä¸­è·å–æŒ‡å®šæ–‡ä»¶æˆ–æµå¯¹è±¡ã€‚

```java
// è·å–æ–‡ä»¶æˆ–æµï¼Œæ³¨æ„"/"å¼€å¤´ä»£è¡¨æ ¹ç›®å½•ä¸‹çš„ä½ç½®
String path = this.getClass().getResource("/"+fileName).getPath();

InputStream inputStream = this.getClass().getResourceAsStream(failName); // æ³¨æ„å˜é‡åæ‹¼å†™é”™è¯¯ï¼Œåº”è¯¥æ˜¯ fileName
```

### æ–¹æ³•äºŒï¼šé€šè¿‡ `org.springframework.util.ResourceUtils.getFile()`

æ­¤æ–¹æ³•è¿”å›ä¸€ä¸ª`File`å¯¹è±¡ï¼Œæ–¹ä¾¿æ–‡ä»¶æ“ä½œã€‚

```java
// è·å–èµ„æºè·¯å¾„ä¸‹çš„æ–‡ä»¶
File file = org.springframework.util.ResourceUtils.getFile("classpath:test.txt");
```

### æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ `ClassPathResource` ç±»

è¿™ä¸ªç±»æä¾›äº†æ›´å¼ºå¤§çš„åŠŸèƒ½å»è®¿é—® classpath ä¸­çš„èµ„æºï¼Œå¹¶ä¸”èƒ½å¤Ÿç›´æ¥è·å–åˆ°æ–‡ä»¶æˆ–è¾“å…¥æµã€‚

```java
import org.springframework.core.io.ClassPathResource;

// è·å–èµ„æºè·¯å¾„ä¸‹çš„æ–‡ä»¶
ClassPathResource classPathResource = new ClassPathResource("test.txt");
File file = classPathResource.getFile();
InputStream inputStream = classPathResource.getInputStream();
```

### ç‰¹åˆ«æ³¨æ„ï¼šè¯»å– Jar åŒ…ä¸­çš„æ–‡ä»¶

å¦‚æœä½ çš„æ–‡ä»¶è¢«å­˜æ”¾åœ¨ jar åŒ…ä¸­ï¼Œå¯ä»¥é€šè¿‡ç±»åŠ è½½å™¨æ¥è·å–èµ„æºã€‚

```java
// é€šè¿‡å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»è£…è½½å™¨è·å–èµ„æº
InputStream io = Thread.currentThread().getContextClassLoader().getResourceAsStream("test.txt");

// æˆ–è€…ä½¿ç”¨å½“å‰ç±»çš„ç±»åŠ è½½å™¨
InputStream io = getClass().getClassLoader().getResourceAsStream("test.txt");
```

## BigDecimal çš„åŸºæœ¬æ“ä½œä¸è¿ç®—

`BigDecimal` æ˜¯ Java ä¸­ç”¨äºç²¾ç¡®æµ®ç‚¹æ•°è®¡ç®—çš„é‡è¦å·¥å…·ï¼Œç‰¹åˆ«é€‚åˆäºé‡‘èæˆ–ç§‘å­¦è®¡ç®—ç­‰é¢†åŸŸã€‚å®ƒæä¾›äº†ä¸°å¯Œçš„æ„é€ æ–¹æ³•å’Œæ“ä½œæ–¹æ³•ã€‚

### å¸¸è§çš„æ„é€ å™¨

- `BigDecimal(int)`ï¼šåˆ›å»ºä¸€ä¸ªå…·æœ‰æŒ‡å®šæ•´æ•°å€¼çš„å¯¹è±¡ã€‚
- `BigDecimal(double)`ï¼šä½¿ç”¨ double ç±»å‹å‚æ•°åˆå§‹åŒ–å¯¹è±¡ã€‚ï¼ˆæ³¨æ„ï¼Œdouble è½¬æ¢ä¸º BigDecimal æ—¶ä¼šä¸¢å¤±ç²¾åº¦ï¼‰
- `BigDecimal(long)`ï¼šåˆ›å»ºä¸€ä¸ªå…·æœ‰æŒ‡å®šé•¿æ•´æ•°å€¼çš„å¯¹è±¡ã€‚
- `BigDecimal(String)`ï¼šåŸºäºå­—ç¬¦ä¸²è¡¨ç¤ºçš„å€¼æ¥æ„é€ ã€‚

### å¸¸è§çš„æ–¹æ³•

- `add(BigDecimal)`: åˆå¹¶ä¸¤ä¸ª BigDecimal å¯¹è±¡çš„å€¼ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚
- `subtract(BigDecimal)`: ä»ç¬¬ä¸€ä¸ªå‚æ•°ä¸­å‡å»ç¬¬äºŒä¸ªå‚æ•°çš„å€¼ï¼Œå¾—åˆ°çš„ç»“æœå­˜å‚¨åœ¨æ–°çš„å¯¹è±¡ä¸­ã€‚
- `multiply(BigDecimal)`: å°†ä¸¤ä¸ªå‚æ•°ç›¸ä¹˜åçš„ç»“æœæ”¾åœ¨ä¸€ä¸ªæ–°å¯¹è±¡é‡Œè¿”å›ã€‚
- `divide(BigDecimal)`: è¿”å›é™¤æ³•è¿ç®—åçš„æ–° BigDecimal å¯¹è±¡ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šæŠ›å‡º ArithmeticException å¼‚å¸¸ï¼Œé™¤éè°ƒç”¨è€…æŒ‡å®šäº†é€‚å½“çš„èˆå…¥æ¨¡å¼ã€‚
- `toString()`: æŠŠ BigDecimal è½¬æ¢ä¸º String ç±»å‹çš„è¡¨ç¤ºå½¢å¼ã€‚
- `doubleValue()`, `floatValue()`, `longValue()`, `intValue()`ï¼šåˆ†åˆ«å°†å€¼è½¬æ¢æˆ double, float, long å’Œ int å‹æ•°æ®ã€‚

### ç²¾ç¡®æµ®ç‚¹æ•°è¿ç®—å·¥å…·ç±»

ä¸‹é¢æ˜¯ä¸€ä¸ªå®ç°ç²¾ç¡®ç®—æœ¯æ“ä½œï¼ŒåŒ…æ‹¬åŠ æ³•ã€å‡æ³•ã€ä¹˜æ³•ä»¥åŠé™¤æ³•ï¼ˆå¯æŒ‡å®šç²¾åº¦ï¼‰çš„ç¤ºä¾‹ã€‚

```java
import java.math.BigDecimal;

/**
 * æä¾›ç²¾ç¡®çš„æµ®ç‚¹æ•°è¿ç®—, åŒ…æ‹¬åŠ å‡ä¹˜é™¤åŠå››èˆäº”å…¥ç­‰ã€‚
 */
public class ArithUtil {
    // é»˜è®¤çš„é™¤æ³•è¿ç®—ç»“æœä¿ç•™10ä½å°æ•°
    private static final int DEF_DIV_SCALE = 10;

    private ArithUtil() {}

    /**
     * åŠ æ³•è¿ç®—
     *
     * @param v1 è¢«åŠ æ•°
     * @param v2 åŠ æ•°
     * @return å’Œå€¼
     */
    public static double add(double v1, double v2) {
        BigDecimal b1 = new BigDecimal(Double.toString(v1));
        BigDecimal b2 = new BigDecimal(Double.toString(v2));
        return b1.add(b2).doubleValue();
    }

    /**
     * å‡æ³•è¿ç®—
     *
     * @param v1 è¢«å‡æ•°
     * @param v2 å‡æ•°
     * @return å·®å€¼
     */
    public static double sub(double v1, double v2) {
        BigDecimal b1 = new BigDecimal(Double.toString(v1));
        BigDecimal b2 = new BigDecimal(Double.toString(v2));
        return b1.subtract(b2).doubleValue();
    }

    /**
     * ä¹˜æ³•è¿ç®—
     *
     * @param v1 è¢«ä¹˜æ•°
     * @param v2 ä¹˜æ•°
     * @return ç§¯
     */
    public static double mul(double v1, double v2) {
        BigDecimal b1 = new BigDecimal(Double.toString(v1));
        BigDecimal b2 = new BigDecimal(Double.toString(v2));
        return b1.multiply(b2).doubleValue();
    }

    /**
     * é™¤æ³•è¿ç®—ï¼Œè¿”å›å•†ï¼Œä¿ç•™é»˜è®¤çš„å°æ•°ä½
     *
     * @param v1 è¢«é™¤æ•°
     * @param v2 é™¤æ•°
     * @return å•†å€¼ï¼ˆå››èˆäº”å…¥ï¼‰
     */
    public static double div(double v1, double v2) {
        return div(v1, v2, DEF_DIV_SCALE);
    }

    /**
     * é™¤æ³•è¿ç®—ï¼Œè¿”å›å•†ï¼Œæ ¹æ®æŒ‡å®šçš„å°æ•°ä½æ•°è¿›è¡Œå››èˆäº”å…¥
     *
     * @param v1 è¢«é™¤æ•°
     * @param v2 é™¤æ•°
     * @param scale ç²¾åº¦ï¼ˆä¿ç•™å‡ ä½å°æ•°ï¼‰
     * @return å•†å€¼ï¼ˆå››èˆäº”å…¥ï¼‰
     */
    public static double div(double v1, double v2, int scale) {
        if (scale < 0)
            throw new IllegalArgumentException("The scale must be a positive integer or zero");
        BigDecimal b1 = new BigDecimal(Double.toString(v1));
        BigDecimal b2 = new BigDecimal(Double.toString(v2));

        return b1.divide(b2, scale, BigDecimal.ROUND_HALF_UP).doubleValue();
    }

    /**
     * å››èˆäº”å…¥ï¼Œä¿ç•™æŒ‡å®šçš„å°æ•°ä½
     *
     * @param v éœ€è¦å››èˆäº”å…¥çš„æ•°å­—
     * @param scale å°æ•°ç‚¹åä¿ç•™å‡ ä½
     * @return ä¿®çº¦åçš„ç»“æœ
     */
    public static double round(double v, int scale) {
        if (scale < 0)
            throw new IllegalArgumentException("The scale must be a positive integer or zero");

        BigDecimal b = new BigDecimal(Double.toString(v));
        return b.setScale(scale, BigDecimal.ROUND_HALF_UP).doubleValue();
    }
}
```

### æ³¨æ„äº‹é¡¹

- `BigDecimal` çš„æ„é€ å‡½æ•°ä¸æ¥å— `float` æˆ– `double` ç±»å‹ï¼Œå› ä¸ºè¿™äº›ç±»å‹é€šå¸¸æ— æ³•å‡†ç¡®è¡¨ç¤ºåè¿›åˆ¶æ•°ã€‚
- å¯¹äºé™¤æ³•è¿ç®—ï¼ŒåŠ¡å¿…æŒ‡å®šåˆé€‚çš„èˆå…¥æ¨¡å¼ï¼ˆå¦‚ ROUND_HALF_UPï¼‰æ¥é¿å…å‡ºç°å¼‚å¸¸æˆ–è·å¾—æ„å¤–ç»“æœã€‚

## [æ¢ç´¢ Java 8 Stream APIï¼šä»æ’åºåˆ°è¿‡æ»¤çš„å…¨é¢æŒ‡å—](https://blog.dong4j.site/posts/845cfa4f.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

Java 8 å¼•è¿›äº†å¼ºå¤§çš„ Stream APIï¼Œä½¿å¾—é›†åˆæ“ä½œæ›´åŠ ç®€æ´ä¼˜é›…ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Java 8 çš„ Stream API è¿›è¡Œ List è½¬ Mapã€List æ’åºã€åˆ—è¡¨è¿‡æ»¤åŠ Map ä¸­çš„æ¡ä»¶æ“ä½œã€‚

## ä½¿ç”¨ Java 8 Lambda å°† list è½¬ä¸º map

### å¸¸ç”¨æ–¹å¼

è¦å°†ä¸€ä¸ª List è½¬æ¢ä¸º Mapï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ `Collectors.toMap()` æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š

```java
public Map<Long, String> getIdNameMap(List<Account> accounts) {
    return accounts.stream().collect(Collectors.toMap(Account::getId, Account::getUsername));
}
```

### æ”¶é›†æˆå®ä½“æœ¬èº« map

æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½å¸Œæœ›å°†åˆ—è¡¨ä¸­çš„å¯¹è±¡ç›´æ¥æ˜ å°„åˆ° Map ä¸­ä½œä¸ºå€¼ï¼Œå¯ä»¥è¿™æ ·åšï¼š

```java
public Map<Long, Account> getIdAccountMap(List<Account> accounts) {
    return accounts.stream().collect(Collectors.toMap(Account::getId, account -> account));
}
```

`account -> account` æ˜¯ä¸€ä¸ªè¿”å›æœ¬èº«çš„ lambda è¡¨è¾¾å¼ã€‚ä½¿ç”¨ `Function.identity()` ä¼šä½¿å¾—ä»£ç æ›´ç®€æ´ï¼š

```java
public Map<Long, Account> getIdAccountMap(List<Account> accounts) {
    return accounts.stream().collect(Collectors.toMap(Account::getId, Function.identity()));
}
```

### å¤„ç†é‡å¤ key çš„æƒ…å†µ

å½“éœ€è¦æ ¹æ®å¯èƒ½æœ‰é‡å¤å€¼ï¼ˆå¦‚ nameï¼‰çš„å­—æ®µæ¥åˆ›å»º map æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ° `java.lang.IllegalStateException: Duplicate key` å¼‚å¸¸ã€‚ä¸ºäº†å¤„ç†è¿™ç§æƒ…å†µï¼Œå¯ä»¥ç»™ `toMap()` æ–¹æ³•ä¼ å…¥ä¸€ä¸ªåˆå¹¶å‡½æ•°ï¼š

```java
public Map<String, Account> getNameAccountMap(List<Account> accounts) {
    return accounts.stream().collect(Collectors.toMap(Account::getUsername, Function.identity(), (key1, key2) -> key2));
}
```

è¿™é‡Œåªæ˜¯ç®€å•çš„ä½¿ç”¨åè€…è¦†ç›–å‰è€…ã€‚`toMap()` è¿˜å…è®¸æˆ‘ä»¬æŒ‡å®šä¸€ä¸ªå…·ä½“çš„ `Map` å®ç°ç±»æ¥æ”¶é›†æ•°æ®ï¼š

```java
public Map<String, Account> getNameAccountMap(List<Account> accounts) {
    return accounts.stream().collect(Collectors.toMap(Account::getUsername, Function.identity(), (key1, key2) -> key2, LinkedHashMap::new));
}
```

## JDK 8 å¯¹ List å’Œ Map çš„æ’åº

### Java 8 æ›´æ–°å‰çš„ List æ’åºæ“ä½œ

åœ¨ä½¿ç”¨ Java 8 ä¹‹å‰ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦åˆ›å»ºä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»æ¥å®ç°æ’åºï¼š

```java
Collections.sort(humans, new Comparator<Human>() {
    @Override
    public int compare(Human h1, Human h2) {
        return h1.getName().compareTo(h2.getName());
    }
});
```

### ä½¿ç”¨ Lambda è¡¨è¾¾å¼çš„ List æ’åº

Java 8 ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ lambda è¡¨è¾¾å¼æ¥å®šä¹‰æ¯”è¾ƒå™¨ï¼š

```java
humans.sort((Human h1, Human h2) -> h1.getName().compareTo(h2.getName()));
```

è¿˜å¯ä»¥è¿›ä¸€æ­¥ç®€åŒ–ä¸ºï¼š

```java
humans.sort((h1, h2) -> h1.getName().compareTo(h2.getName()));
```

æˆ–è€…ä½¿ç”¨é™æ€æ–¹æ³•å¼•ç”¨ï¼š

```java
humans.sort(Human::compareByNameThenAge);
```

ä»¥åŠæ¯”è¾ƒå™¨æä¾›çš„è¾…åŠ©æ–¹æ³•ï¼š

```java
Collections.sort(humans, Comparator.comparing(Human::getName));
```

### ååºæ’åº

Java 8 æä¾›äº† `Comparator.reversed()` æ–¹æ³•æ¥å®ç°åå‘æ’åºï¼š

```java
humans.sort(comparator.reversed());
```

### ä½¿ç”¨å¤šä¸ªæ¡ä»¶è¿›è¡Œæ’åº

å¯ä»¥ä½¿ç”¨é“¾å¼æ“ä½œæ¥è¿›è¡Œå¤šçº§æ’åºï¼š

```java
humans.sort(Comparator.comparing(Human::getName).thenComparing(Human::getAge));
```

## åˆ©ç”¨ Stream API è¿›è¡Œ List çš„è¿‡æ»¤å’Œ map æ“ä½œ

### åˆ—è¡¨çš„è¿‡æ»¤å¤„ç†

ä½¿ç”¨ `stream().filter()` å¯ä»¥æ–¹ä¾¿åœ°å¯¹åˆ—è¡¨è¿›è¡Œè¿‡æ»¤ï¼š

```java
List<String> list2 = list1.stream().filter(s -> s != "1").collect(Collectors.toList());
```

è¾“å‡ºç»“æœæ˜¯ `[2, 3]`ã€‚

### List è½¬æ¢ä¸ºå¦ä¸€ä¸ª List

å¯ä»¥åˆ©ç”¨ `stream().map()` æ¥è½¬æ¢åˆ—è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œç„¶åæ”¶é›†åˆ°æ–°çš„åˆ—è¡¨ä¸­ï¼š

```java
List<String> list2 = list1.stream().map(string -> "stream ().map () å¤„ç†ä¹‹åï¼š" + string).collect(Collectors.toList());
```

### æ•°æ®èšåˆ

ä»¥ä¸‹æ˜¯ä¸€äº›åˆ©ç”¨ Stream å¯¹åˆ—è¡¨ä¸­çš„ç”¨æˆ·å¯¹è±¡ `User` è¿›è¡Œå„ç§æ•°æ®èšåˆçš„æ–¹æ³•ï¼š

- **æ±‚å’Œ**ï¼š`list.stream().mapToDouble(User::getHeight).sum()` æ­¤æ–¹æ³•è¿”å›ç”¨æˆ·é›†åˆä¸­æ‰€æœ‰ç”¨æˆ·çš„èº«é«˜æ€»å’Œã€‚
- **æœ€å¤§å€¼**ï¼š`list.stream().mapToDouble(User::getHeight).max()` è·å–ç”¨æˆ·å¯¹è±¡ä¸­çš„æœ€é«˜èº«é«˜çš„ç”¨æˆ·ï¼Œè¿”å›çš„æ˜¯ Optional ç±»å‹ã€‚
- **æœ€å°å€¼**ï¼š`list.stream().mapToDouble(User::getHeight).min()` è¿”å›ç”¨æˆ·é›†åˆä¸­æœ€çŸ®çš„ç”¨æˆ·ï¼Œä¹Ÿæ˜¯è¿”å› Optional ç±»å‹ã€‚
- **å¹³å‡å€¼**ï¼š`list.stream().mapToDouble(User::getHeight).average()` è®¡ç®—æ‰€æœ‰ç”¨æˆ·çš„èº«é«˜å¹³å‡å€¼ï¼Œå¹¶ä»¥ `Optional<Average>` å½¢å¼è¿”å›ã€‚

### åˆ—è¡¨æ‹†åˆ†ä¸åˆå¹¶

åœ¨ Java8 ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Stream çš„æ–¹æ³•æ¥å®Œæˆå­—ç¬¦ä¸²çš„æ‹†åˆ†ä»¥åŠåˆ—è¡¨çš„åˆå¹¶ã€‚ä¾‹å¦‚ï¼š

- **åˆ†å‰²**ï¼š`Stream.of(string.split(","))` å°†åŸå§‹å­—ç¬¦ä¸²æŒ‰é€—å·åˆ†å‰²ï¼Œå¹¶å°†ç»“æœè½¬æ¢ä¸º Listã€‚
- **æ‹¼æ¥**ï¼š`asList.stream().collect(Collectors.joining())` å¯ä»¥æŠŠä¸€ä¸ªé›†åˆé‡Œçš„å…ƒç´ ä½¿ç”¨æŒ‡å®šçš„ç¬¦å·è¿æ¥èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ã€‚

### æå–å­—æ®µè½¬æ¢æˆåˆ—è¡¨

æœ‰å‡ ç§æ–¹æ³•å¯ä»¥ç”¨äºæå– `appPermissionVoList` åˆ—è¡¨ä¸­çš„ç”¨æˆ· IDï¼š

1. ä½¿ç”¨ Stream çš„æ–¹å¼ï¼š
   ```java
   List<String> userIds = appPermissionVoList.stream()
           .map(appPermissionVo -> appPermissionVo.getUserId())
           .collect(Collectors.toList());
   ```
2. ä½¿ç”¨ Guava åº“çš„ `Lists.transform()` æ–¹æ³•:
   ```java
   List<String> usrIds = Lists.transform(appPermissionVoList,appPerm->appPerm.getUserId());
   ```

### åˆ†ç»„

åˆ†ç»„æ“ä½œæ˜¯ä¸€ç§å¸¸è§çš„éœ€æ±‚ã€‚ä¾‹å¦‚ï¼š

```java
Map<String, List<User>> groupBySex = userList.stream()
        .collect(Collectors.groupingBy(User::getSex));
```

æ­¤ä»£ç å°†æ ¹æ®ç”¨æˆ·æ€§åˆ«è¿›è¡Œåˆ—è¡¨çš„åˆ†ç»„å¤„ç†ã€‚

## HashMap çš„ `compute`, `computeIfAbsent` åŠ `computeIfPresent`

è¿™ä¸‰è€…éƒ½æ˜¯ç”¨æ¥å¯¹æ˜ å°„ä¸­çš„å…ƒç´ è¿›è¡Œä¿®æ”¹ã€‚å®ƒä»¬çš„åŒºåˆ«åœ¨äºï¼š

- `computeIfPresent(K key, BiFunction<? super K, ? super V, ? extends V> remappingFunction)` ä»…å½“æŒ‡å®šçš„é”®å­˜åœ¨æ—¶æ‰æ‰§è¡Œæ“ä½œã€‚
- `computeIfAbsent(K key, Function<? super K, ? extends V> mappingFunction)` å½“ç»™å®šçš„é”®ä¸å­˜åœ¨äºè¯¥æ˜ å°„ä¸­ï¼Œåˆ™è®¡ç®—å…¶å¯¹åº”çš„å€¼ï¼Œå¹¶å°†å…¶æ”¾å…¥è¯¥æ˜ å°„ä¸­ï¼Œç„¶åè¿”å›è¯¥å€¼ï¼›å¦åˆ™ç›´æ¥è¿”å›å½“å‰å€¼ã€‚
- `compute(K key, BiFunction<? super K, ? super V, ? extends V> remappingFunction)` ä¸ç®¡æ˜¯æ–°æ’å…¥è¿˜æ˜¯å·²å­˜åœ¨çš„é”®éƒ½å¯ä»¥æ“ä½œã€‚

```java
Object key2 = map.computeIfAbsent("key", k -> new Object());
```

## æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ

1. **æ€§èƒ½è€ƒè™‘**ï¼šå°½ç®¡ Stream API æä¾›äº†æå¤§çš„ä¾¿åˆ©æ€§ï¼Œä½†è¿‡åº¦ä½¿ç”¨å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚å› æ­¤ï¼Œéœ€è¦æƒè¡¡ä»£ç çš„å¯è¯»æ€§å’Œæ•ˆç‡ã€‚
2. **ç©ºå€¼æ£€æŸ¥**ï¼šåœ¨å¤„ç†æ•°æ®æµæ—¶ä¸€å®šè¦æ³¨æ„å¯èƒ½å‡ºç°çš„å¼‚å¸¸æƒ…å†µï¼Œç‰¹åˆ«æ˜¯æ¥è‡ªå¤–éƒ¨çš„æ•°æ®æºå¯èƒ½åŒ…å« null å€¼çš„æƒ…å†µï¼Œè¿™å¯èƒ½å¯¼è‡´ `NullPointerException` å¼‚å¸¸ã€‚
3. **å¹¶è¡Œæµçš„ä½¿ç”¨**: å¯¹äºå¤§æ•°æ®é›†ï¼Œè€ƒè™‘ä½¿ç”¨å¹¶è¡Œæµæ¥åŠ é€Ÿè®¡ç®—ã€‚ä½†è¦æ³¨æ„ï¼Œå¹¶éæ‰€æœ‰åœºæ™¯éƒ½é€‚åˆå¹¶è¡ŒåŒ–å¤„ç†ã€‚

## [Zookeeper æ¦‚è¿°ï¼šæ ¸å¿ƒæ¦‚å¿µä¸åº”ç”¨åœºæ™¯](https://blog.dong4j.site/posts/5f2cc770.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

Zookeeper æ˜¯ Google çš„ Chubby ä¸€ä¸ªå¼€æºçš„å®ç°ï¼Œæ˜¯ Hadoop çš„åˆ†å¸ƒå¼åè°ƒæœåŠ¡

è‡ª 2010 å¹´ 10 æœˆå‡çº§æˆ Apache Software Foundation(ASF) é¡¶çº§é¡¹ç›®

### åˆ†å¸ƒå¼åè°ƒæœåŠ¡, æä¾›ä»¥ä¸‹åŠŸèƒ½:

1. ç»„ç®¡ç†æœåŠ¡
2. åˆ†å¸ƒå¼é…ç½®æœåŠ¡
3. åˆ†å¸ƒå¼åŒæ­¥æœåŠ¡
4. åˆ†å¸ƒå¼å‘½åæœåŠ¡

---

## è°åœ¨ä½¿ç”¨ Zookeeper

**å¼€æºè½¯ä»¶**

- HBase å¼€æºçš„éå…³ç³»å‹åˆ†å¸ƒå¼æ•°æ®åº“
- Solr Apache Lucene é¡¹ç›®çš„å¼€æºä¼ä¸šæœç´¢å¹³å°
- Storm åˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶
- Neo4j é«˜æ€§èƒ½çš„,Nosql å›¾å½¢æ•°æ®åº“
- ...

**å…¬å¸**

- Yahoo
- LinkedIn
- Twitter
- Taobao
- ...

---

## Zookeeper æ¶æ„

![20241229154732_2Z8F9pu0.webp](https://cdn.dong4j.site/source/image/20241229154732_2Z8F9pu0.webp)

---

- å®¢æˆ·ç«¯éšæœºè¿æ¥é›†ç¾¤ä¸­çš„ä»»ä½•ä¸€å° server
- é›†ç¾¤å†…æ‰€æœ‰çš„ server åŸºäº Zab(ZooKeeper Atomic Broadcast) åè®®é€šä¿¡
- é›†ç¾¤å†…éƒ¨æ ¹æ®ç®—æ³•è‡ªåŠ¨é€‰ä¸¾å‡º leader, è´Ÿè´£å‘ follower å¹¿æ’­æ‰€æœ‰å˜åŒ–æ¶ˆæ¯
- é›†ç¾¤ä¸­æ¯ä¸ª follower éƒ½å’Œ leader é€šä¿¡
  - follower æ¥æ”¶æ¥è‡ª leader çš„æ‰€æœ‰å˜åŒ–æ¶ˆæ¯, ä¿å­˜åœ¨è‡ªå·±çš„å†…å­˜ä¸­
  - follower è½¬å‘æ¥è‡ªå®¢æˆ·ç«¯çš„å†™è¯·æ±‚ç»™ leader
  - å®¢æˆ·ç«¯çš„è¯»è¯·æ±‚ä¼šåœ¨ follower ç«¯ç›´æ¥å¤„ç†, æ— éœ€è½¬å‘ç»™ leader

---

![20241229154732_SIC1xgXk.webp](https://cdn.dong4j.site/source/image/20241229154732_SIC1xgXk.webp)

---

![20241229154732_SIC1xgXk.webp](https://cdn.dong4j.site/source/image/20241229154732_SIC1xgXk.webp)

---

## Zookeeper æ•°æ®æ¨¡å‹

- åŸºäºæ ‘å½¢ç»“æ„çš„å‘½åç©ºé—´, ä¸æ–‡ä»¶ç³»ç»Ÿç±»ä¼¼
- èŠ‚ç‚¹ (znode) éƒ½å¯ä»¥å­˜å‚¨æ•°æ®, å¯ä»¥æœ‰å­èŠ‚ç‚¹
- èŠ‚ç‚¹ä¸æ”¯æŒé‡å‘½å
- æ•°æ®å¤§å°ä¸è¶…è¿‡ 1MB(å¯é…ç½®)
- æ•°æ®è¯»å†™ä¿æŒå®Œæ•´æ€§

![20241229154732_a4CQ0fJe.webp](https://cdn.dong4j.site/source/image/20241229154732_a4CQ0fJe.webp)

---

## Zookeeper åŸºæœ¬ API

![20241229154732_nrNPSnH5.webp](https://cdn.dong4j.site/source/image/20241229154732_nrNPSnH5.webp)

---

## Znode èŠ‚ç‚¹ç±»å‹

- PERSISTENT
- PERSISTENT_SEQUENTIAL
- EPHEMERAL
- EPHEMERAL_SEQUENTIAL

```java
PERSISTENT(0, false, false),
PERSISTENT_SEQUENTIAL(2, false, true),
EPHEMERAL(1, true, false),
EPHEMERAL_SEQUENTIAL(3, true, true);
```

---

## Sequential/non-sequential èŠ‚ç‚¹ç±»å‹

- Non-sequential èŠ‚ç‚¹ä¸èƒ½æœ‰é‡å
- Sequential èŠ‚ç‚¹
  - åˆ›å»ºæ—¶å¯é‡å
  - å®é™…ç”ŸæˆèŠ‚ç‚¹åæœ«å°¾è‡ªåŠ¨æ·»åŠ ä¸€ä¸ª 10 ä½é•¿åº¦, å·¦è¾¹ä»¥ 0 å¡«å……çš„å•é€’å¢æ•°å­—
    ![20241229154732_hNPyK838.webp](https://cdn.dong4j.site/source/image/20241229154732_hNPyK838.webp)

---

## Ephemeral/Persistent èŠ‚ç‚¹ç±»å‹

- Ephemeral èŠ‚ç‚¹åœ¨å®¢æˆ·ç«¯ session ç»“æŸæˆ–è¶…æ—¶åè‡ªåŠ¨åˆ é™¤
- Persistent èŠ‚ç‚¹ç”Ÿå‘½å‘¨æœŸå’Œ session æ— å…³, åªèƒ½æ˜¾å¼åˆ é™¤
  ![20241229154732_guwkHMoJ.webp](https://cdn.dong4j.site/source/image/20241229154732_guwkHMoJ.webp)
  ![20241229154732_oUQNhGe8.webp](https://cdn.dong4j.site/source/image/20241229154732_oUQNhGe8.webp)
  **æ³¨æ„ **:EPHEMERAL ç±»å‹çš„ç›®å½•èŠ‚ç‚¹ä¸èƒ½æœ‰å­èŠ‚ç‚¹ç›®å½•

---

## ZooKeeper Session

- å®¢æˆ·ç«¯å’Œ server é—´é‡‡ç”¨é•¿è¿æ¥
- è¿æ¥å»ºç«‹å, server ç”Ÿæˆ session id(64 ä½) è¿”è¿˜ç»™å®¢æˆ·ç«¯
- å®¢æˆ·ç«¯å®šæœŸå‘é€ ping åŒ…æ¥æ£€æŸ¥å’Œä¿å­˜å’Œ server çš„è¿æ¥
- ä¸€æ—¦ session ç»“æŸæˆ–è¶…æ—¶, æ‰€æœ‰ ephemeral èŠ‚ç‚¹ä¼šè¢«åˆ é™¤
- å®¢æˆ·ç«¯å¯æ ¹æ®æƒ…å†µè®¾ç½®åˆé€‚çš„ session è¶…æ—¶æ—¶é—´

---

## Zookeeper Watcher

- Watch æ˜¯å®¢æˆ·ç«¯å®‰è£…åœ¨ server çš„äº‹ä»¶ç›‘å¬æ–¹æ³•
- å½“ç›‘å¬çš„èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–, server å°†é€šçŸ¥æ‰€æœ‰æ³¨å†Œçš„å®¢æˆ·ç«¯
- å®¢æˆ·ç«¯ä½¿ç”¨å•çº¿ç¨‹å¯¹æ‰€æœ‰æ—¶é—´æŒ‰é¡ºåºåŒæ­¥å›è°ƒ
- è§¦å‘å›è°ƒæ¡ä»¶:
  - å®¢æˆ·ç«¯è¿æ¥, æ–­å¼€è¿æ¥
  - èŠ‚ç‚¹æ•°æ®å‘ç”Ÿå˜åŒ–
  - èŠ‚ç‚¹æœ¬èº«å‘ç”Ÿå˜åŒ–

**æ³¨æ„:**

1. Watch æ˜¯å•æ¬¡çš„, æ¯æ¬¡è§¦å‘åä¼šè¢«è‡ªåŠ¨åˆ é™¤
2. å¦‚æœéœ€è¦å†æ¬¡ç›‘å¬æ—¶é—´, å¿…é¡»é‡æ–°å®‰è£… Watch

---

## Watch çš„åˆ›å»ºå’Œè§¦å‘è§„åˆ™

- åœ¨è¯»æ“ä½œ existsã€getChildren å’Œ getData ä¸Šå¯ä»¥è®¾ç½®è§‚å¯Ÿï¼Œè¿™äº›è§‚å¯Ÿå¯ä»¥è¢«å†™æ“ä½œ createã€delete å’Œ setData è§¦å‘

<br/>

![20241229154732_kKfwednt.webp](https://cdn.dong4j.site/source/image/20241229154732_kKfwednt.webp)

---

# ç¬¬äºŒéƒ¨åˆ†:Zooleeper åº”ç”¨

- åˆ†å¸ƒå¼é…ç½®ç®¡ç†
- é«˜å¯ç”¨åˆ†å¸ƒå¼é›†ç¾¤
- åˆ†å¸ƒå¼é˜Ÿåˆ—
- åˆ†å¸ƒå¼é”

---

## åˆ†å¸ƒå¼é…ç½®å®ç°

- å°†é…ç½®æ–‡ä»¶ä¿¡æ¯ä¿å­˜åœ¨ Server æŸä¸ªç›®å½•èŠ‚ç‚¹ä¸­, ç„¶åæ‰€æœ‰éœ€è¦ä¿®æ”¹çš„åº”ç”¨åŠå…¶ç›‘æ§é…ç½®ä¿¡æ¯çš„çŠ¶æ€
- ä¸€æ—¦é…ç½®ä¿¡æ¯å‘ç”Ÿå˜åŒ–, æ¯å°åº”ç”¨å°†ä¼šæ”¶åˆ° server çš„é€šçŸ¥, ç„¶åä» server è·å–æœ€æ–°çš„é…ç½®ä¿¡æ¯åˆ°ç³»ç»Ÿä¸­
  ![20241229154732_KUKMb9jl.webp](https://cdn.dong4j.site/source/image/20241229154732_KUKMb9jl.webp)

---

## ç”Ÿäº§é…ç½®å‘å¸ƒç³»ç»Ÿè§£å†³æ–¹æ¡ˆ

![20241229154732_MfI0NAzu.webp](https://cdn.dong4j.site/source/image/20241229154732_MfI0NAzu.webp)

---

## Zookeeper + Dubbo

### é«˜å¯ç”¨åˆ†å¸ƒå¼é›†ç¾¤æ–¹æ¡ˆ (ä¸‹å›åˆ†è§£)

![20241229154732_FW4WDGHW.webp](https://cdn.dong4j.site/source/image/20241229154732_FW4WDGHW.webp)

---

## é›†ç¾¤ç®¡ç†

![20241229154732_e96bHff5.webp](https://cdn.dong4j.site/source/image/20241229154732_e96bHff5.webp)

---

## æ•°æ®åº“å®•æœºæ£€æµ‹æ–¹æ¡ˆ

1. ä½¿ç”¨å®šæ—¶ä»»åŠ¡ç›‘æ§ oracle è¿›ç¨‹ (ç«¯å£), å¼€æœºè‡ªå¯åŠ¨;
2. å¦‚æœç›‘æµ‹åˆ°æœ‰ oracle è¿›ç¨‹ï¼Œè°ƒç”¨ monitor service, é€€å‡ºå®šæ—¶ä»»åŠ¡;
   - monitor service è´Ÿè´£ç›‘å¬ oracle ç«¯å£;
   - monitor ä¾èµ–äº zookeeperclient service;
   - zookeeperclient service è´Ÿè´£è¿æ¥ Zookeeper server åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹;

---

4. å½“ oracle è¿›ç¨‹é€€å‡ºæ—¶ï¼Œmonitor service åœæ­¢ zookeeperclient service
   - zookeeperclient service ä¸ server æ–­å¼€å,server è‡ªåŠ¨åˆ é™¤ä¸´æ—¶èŠ‚ç‚¹;
   - monitor service å‘ç®¡ç†å‘˜é‚®ç®±å‘é€æ•°æ®åº“å®•æœºé‚®ä»¶, å†™å…¥æ—¥å¿—;
5. å½“ æ•°æ®åº“æœåŠ¡å™¨å®•æœºæ—¶ï¼Œzookeeperclient service ä¸ Server æ–­å¼€è¿æ¥ï¼Œè‡ªåŠ¨åˆ é™¤ä¸´æ—¶èŠ‚ç‚¹

---

## å…·ä½“å®ç°

#### zookeeperclient.sh

```shell
#!/bin/bash
# /etc/init.d/zookeeperclient.sh
case "$1" in
    start)
        echo "Starting Zookeeper Client"
        python /home/master/zookeeperclient.py &
        ;;
    stop)
        echo "Stopping Zookeeper Client"
        #killall zookeeperclient.py
        kill $(ps aux | grep -m 1 'python /home/master/zookeeperclient.py' | awk '{ print $2 }')
        ;;
    *)
        echo "Usage: service Client start|stop"
        exit 1
        ;;
esac
exit 0
```

---

#### zookeeperclient.py

```python
#!/usr/local/bin/python3
from kazoo.client import KazooClient
import time

zk = KazooClient(hosts = '192.168.43.125:2181',connection_retry = True)
zk.start()
zk.create("/datasource/datasource1", b"DATASOURCE1", None, True, False, True)
while True:
    try:
        time.sleep(2)
    except (KeyboardInterrupt, SystemExit):
        zk.stop()
```

---

#### monitor.sh

```shell
#!/bin/bash
# /etc/init.d/monitor.sh
case "$1" in
    start)
        python3 /Users/codeai/Desktop/monitor.py &
        sleep 2
        if [ "$(ps -ef | grep zookeeperclient.py | grep -v grep | awk '{ print $2 }')" = ""]
        then
            exit 1
        else
            python3 /Users/codeai/Desktop/zookeeperclient.py &
        fi
        ;;
    stop)
        kill $(ps -ef | grep zookeeperclient.py | grep -v grep | awk '{ print $2 }')
        sleep 2
        kill $(ps -ef | grep monitor.py | grep -v grep | awk '{ print $2 }')
        ;;
    *)
        echo "Usage: service command start|stop"
        exit 1
        ;;
esac
exit 0
```

---

#### monitor.py

```python
def socketmronitor():
    line = "127.0.0.1 8080"
    ip = line.split()[0]
    port = int(line.split()[1])
    while True:
        try:
            sc = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            print(ip, port)
            sc.settimeout(2)
            sc.connect((ip, port))
            timenow = time.localtime()
            datenow = time.strftime('%Y-%m-%d %H:%M:%S', timenow)
            print("%s:%s è¿æ¥æˆåŠŸ->%s \n" % (ip, port, datenow))
            sc.close()
            time.sleep(3)
        except Exception as e:
            file = open("socketmonitor_err.log", "a")
            timenow = time.localtime()
            datenow = time.strftime('%Y-%m-%d %H:%M:%S', timenow)
            file.write("%s:%s è¿æ¥å¤±è´¥->%s \n" % (ip, port, datenow))
            file.close()
            send_mail(['348055827@qq.com'], 'Oracle quit', sysinfo())
            exit(-1)
```

---

#### server ç«¯ç›‘å¬èŠ‚ç‚¹å˜åŒ–

```java
Watcher wh = new Watcher() {
    public void process(WatchedEvent event) {
        // å¦‚æœå‘ç”Ÿäº†"/datasource"èŠ‚ç‚¹ä¸‹çš„å­èŠ‚ç‚¹å˜åŒ–äº‹ä»¶, æ›´æ–° server åˆ—è¡¨, å¹¶é‡æ–°æ³¨å†Œç›‘å¬
        if (event.getType() == Event.EventType.NodeChildrenChanged && ("/" + groupNode).equals(event.getPath())) {
            try {
                updateServerList();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
};
zk = new ZooKeeper("127.0.0.1:2181", Integer.MAX_VALUE, wh);
```

---

## åˆ†å¸ƒå¼é˜Ÿåˆ—

å…ˆè¯´ä¸€ä¸ªé€šä¿—æ˜“æ‡‚çš„ä¾‹å­:

> ä¸€ä¸ªè€ä¸­åŒ»æ¯å¤©åªçœ‹ 5 ä¸ªç—…äºº, å½“ç¬¬ä¸€ä¸ªç—…äººå·²ç»æŒ‚å· (å‘ Service æ³¨å†Œå¹¶ä¸”åˆ›å»ºäº†ä¸€ä¸ªèŠ‚ç‚¹), ä½†æ˜¯å¹¶æœªè¾¾åˆ° 5 ä¸ªäººçš„è¦æ±‚, æ‰€ä»¥è¿™ä¸ªç—…äººå°±ç­‰å¾…, çŸ¥é“ç¬¬
> 5 ä¸ªäººæŒ‚å·å, è¿™ 5 ä¸ªäººæ‰ä¼šåˆ°è€ä¸­åŒ»é‚£å„¿å»çœ‹ç—….
> è¿™ä¸ªå°±å¯ä»¥ç®€å•çš„ç†è§£ä¸ºåˆ†å¸ƒå¼é˜Ÿåˆ—,5 ä¸ªäººæ˜¯ä¸åŒ client, ä»–ä»¬éƒ½å¿…é¡»ç­‰åˆ°æ‰€æœ‰äººéƒ½å‘ Zookeeper Server åˆ›å»ºäº†ä¸€ä¸ªèŠ‚ç‚¹,( ä»–ä»¬é€šè¿‡å¯¹èŠ‚ç‚¹çš„ç›‘æ§ä»è€ŒçŸ¥æ™“æ˜¯å¦è¾¾åˆ°
> 5 ä¸ªäºº ), å½“åˆ›å»ºäº† 5 ä¸ªèŠ‚ç‚¹å, é€šè¿‡ Watcher åˆ›å»ºä¸€ä¸ª start çš„èŠ‚ç‚¹æ ‡è¯†, å‘ŠçŸ¥æ‰€æœ‰çš„ client, è¿™ä¸ªé˜Ÿåˆ—å·²ç»å¯ä»¥ä½¿ç”¨äº†.

---

## å…·ä½“å®ç°

åˆ›å»ºä¸€ä¸ªçˆ¶ç›®å½• /synchronizingï¼Œæ¯ä¸ªæˆå‘˜éƒ½ç›‘æ§ç›®å½• /synchronizing/start æ˜¯å¦å­˜åœ¨ï¼Œç„¶åæ¯ä¸ªæˆå‘˜éƒ½åŠ å…¥è¿™ä¸ªé˜Ÿåˆ—ï¼ˆåˆ›å»º /synchronizing/member_i
çš„ä¸´æ—¶ç›®å½•èŠ‚ç‚¹ï¼‰ï¼Œç„¶åæ¯ä¸ªæˆå‘˜è·å– / synchronizing ç›®å½•çš„æ‰€æœ‰ç›®å½•èŠ‚ç‚¹ï¼Œåˆ¤æ–­ i çš„å€¼æ˜¯å¦å·²ç»æ˜¯æˆå‘˜çš„ä¸ªæ•°ï¼Œå¦‚æœå°äºæˆå‘˜ä¸ªæ•°ç­‰å¾…
/synchronizing/start çš„å‡ºç°ï¼Œå¦‚æœå·²ç»ç›¸ç­‰å°±åˆ›å»º /synchronizing/start

---

## åˆ†å¸ƒå¼é”

è¿˜æ˜¯å…ˆè¯´ä¸€ä¸ªé€šä¿—æ˜“æ‡‚çš„ä¾‹å­:

> æœ‰ä¸ªç§‘å®¤çš„å¥³åŒ»ç”Ÿå¾ˆæ¼‚äº®, å¾ˆå¤šäººæ…•åå‰æ¥, ä½†æ˜¯å¥¹ä¸€æ¬¡åªä¼šç»™ä¸€ä¸ªäººçœ‹ç—…, ä¹Ÿæ˜¯æœ‰è¿™ä¹ˆ 5 ä¸ªäºº, å…ˆå»æŒ‚å· (å‘ Server æ³¨å†Œ), ç„¶åæ¯ä¸ªäººæ‹¿åˆ°äº†
> P1,P2...P5 ç¼–å·çš„ç‰Œå­. æŠ¤å£«ä»å°å·å¼€å§‹å–Š, å«åˆ°è°è°å°±å»æ‰¾å¥³åŒ»ç”Ÿç©å„¿ ( å¬æŠ¤å£«å–Šè¯, ç„¶åå¯¹æ¯”è‡ªå·±æ‰‹ä¸Šçš„å·æ‹, å¦‚æœå«åˆ°çš„è·Ÿè‡ªå·±æ‰‹ä¸Šçš„å·ç‰Œä¸€æ ·,
> åˆ™è¯´æ˜è·å¾—äº†é” ), å…¶ä»–äººåˆ™ç­‰å¾…,
> å½“ä¸Šä¸€ä¸ªç—…äººçœ‹å®Œç—…ç¦»å¼€ä¹‹å, å°†æ‰‹ä¸Šçš„å·ç‰Œæ‰”æ‰, æŠ¤å£«ç»§ç»­å–Šå·, é‡å¤ä¸Šé¢çš„è¿‡ç¨‹.

---

## å…·ä½“å®ç°

Server åˆ›å»ºä¸€ä¸ª EPHEMERAL_SEQUENTIAL ç›®å½•èŠ‚ç‚¹ï¼Œç„¶åè°ƒç”¨ getChildren æ–¹æ³•è·å–å½“å‰çš„ç›®å½•èŠ‚ç‚¹åˆ—è¡¨ä¸­æœ€å°çš„ç›®å½•èŠ‚ç‚¹æ˜¯ä¸æ˜¯å°±æ˜¯è‡ªå·±åˆ›å»ºçš„ç›®å½•èŠ‚ç‚¹ï¼Œå¦‚æœæ­£æ˜¯è‡ªå·±åˆ›å»ºçš„ï¼Œé‚£ä¹ˆå®ƒå°±è·å¾—äº†è¿™ä¸ªé”ï¼Œå¦‚æœä¸æ˜¯é‚£ä¹ˆå®ƒå°±è°ƒç”¨
exists(String path, boolean watch) æ–¹æ³•å¹¶ç›‘æ§ Zookeeper ä¸Šç›®å½•èŠ‚ç‚¹åˆ—è¡¨çš„å˜åŒ–ï¼Œä¸€ç›´åˆ°è‡ªå·±åˆ›å»ºçš„èŠ‚ç‚¹æ˜¯åˆ—è¡¨ä¸­æœ€å°ç¼–å·çš„ç›®å½•èŠ‚ç‚¹ï¼Œä»è€Œè·å¾—é”ï¼Œé‡Šæ”¾é”å¾ˆç®€å•ï¼Œåªè¦åˆ é™¤å‰é¢å®ƒè‡ªå·±æ‰€åˆ›å»ºçš„ç›®å½•èŠ‚ç‚¹å°±è¡Œäº†ã€‚

---

## æ€»ç»“

1. æ–‡ä»¶ç³»ç»Ÿæ˜¯ä¸€ä¸ªæ ‘å½¢çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä½†æ¯” linux ç³»ç»Ÿç®€å•ï¼Œä¸åŒºåˆ†æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ï¼Œæ‰€æœ‰çš„æ–‡ä»¶ç»Ÿä¸€ç§°ä¸º znode
2. znode çš„ä½œç”¨ï¼šå­˜æ”¾æ•°æ®ï¼Œä½†ä¸Šé™æ˜¯ 1M ; å­˜æ”¾ ACL(access control list) è®¿é—®æ§åˆ¶åˆ—è¡¨
3. æ•°æ®æ¨¡å‹ï¼šçŸ­æš‚ znode(zkCli.sh å®¢æˆ·ç«¯æ–­æ‰è¿æ¥ä¹‹åï¼Œå°±ä¸å­˜åœ¨äº†) å’ŒæŒä¹… znode
4. é¡ºåºå·ï¼šæ¯ä¸ª znode åœ¨åˆ›å»ºçš„æ—¶å€™éƒ½ä¼šç¼–ä¸€ä¸ªå·ï¼ŒæŒ‰ç…§é‚£ä»–ä»¬å°±ä¼šæŒ‰ç…§åˆ›å»ºçš„æ—¶é—´ç¼–å·ï¼ŒåŒæ ·çš„çˆ¶èŠ‚ç‚¹çš„ znode å…±ç”¨ä¸€å¥—ç¼–å·
5. è§‚å¯Ÿï¼ˆwatchï¼‰ï¼šè§‚å¯Ÿå­èŠ‚ç‚¹çš„å˜åŒ–ï¼Œç±»ä¼¼äºæˆ‘ä»¬ä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“ä¸­çš„è§¦å‘å™¨
6. æ“ä½œï¼šcreate delete setData getData exists(znode æ˜¯å¦å­˜åœ¨å¹¶ä¸”æŸ¥è¯¢ä»–çš„ data) getACL setACL
7. é›†ç¾¤æ˜¯æ— ä¸­å¿ƒçš„ï¼Œåªè¦æœ‰è¶…è¿‡ä¸€åŠä»¥ä¸Šçš„èŠ‚ç‚¹æ²¡æœ‰ down æ‰å°±èƒ½å·¥ä½œï¼Œå‡ºäºè¿™ä¸ªåŸå› ï¼Œæˆ‘ä»¬ zookeeper çš„èŠ‚ç‚¹æ•°é€šå¸¸è¦è®¾ç½®æˆå¥‡æ•°ã€‚
8. åœ¨æ•´ä¸ªé›†ç¾¤æ²¡æœ‰ down æ‰ä¹‹å‰ï¼Œè‡³å°‘æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯æœ€æ–°çš„çŠ¶æ€ï¼Œè¿™æ˜¯é€šè¿‡ Zap, è¯¥ zap åè®®æ˜¯åŒ…æ‹¬ 2 ä¸ªæ— é™é‡å¤çš„é˜¶æ®µ:
   1. é€‰ä¸¾ï¼ˆé€‰ä¸¾å‡ºä¸€ä¸ª leaderï¼Œå…¶ä»–èŠ‚ç‚¹å°±å˜æˆäº† followerï¼‰
   2. åŸå­å¹¿æ’­ï¼ˆæ‰€æœ‰å†™è¯·æ±‚è½¬å‘ç»™ leaderï¼Œå†ç”± leader å¹¿æ’­ç»™å„ä¸ª followerï¼Œå½“åŠæ•°ä»¥ä¸Š follower å°†ä¿®æ”¹æŒä¹…åŒ–åï¼Œleader
      æ‰ä¼šæäº¤è¿™ä¸ªæ›´æ–°ï¼Œæ¥ä¸‹æ¥å®¢æˆ·ç«¯æ‰ä¼šæ”¶åˆ°ä¸€ä¸ªæ›´æ–°æˆåŠŸçš„å“åº”ï¼‰
9. åº”ç”¨ï¼š
   1. é…ç½®æ–‡ä»¶çš„åŒæ­¥ï¼ˆæ”¾ä¸€ä¸ª watch, æ£€æµ‹åˆ°æ•°æ®æ”¹åŠ¨åï¼Œç«‹åˆ»åŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œç¡®ä¿é…ç½®æ–‡ä»¶çš„ä¸€è‡´æ€§ï¼‰
   2. é”æœºåˆ¶çš„å®ç°ï¼Œæ¯”å¦‚å¾ˆå¤šå®¢æˆ·ç«¯è®¿é—®ä¸€ä¸ª znode çš„èµ„æºï¼Œå…ˆç»™è¿™ä¸ª znode è®¾ç½®ä¸€ä¸ªè§‚å¯Ÿï¼Œè§‚å¯ŸèŠ‚ç‚¹çš„åˆ é™¤ï¼Œå…¶ä»–å®¢æˆ·ç«¯è¿›æ¥åï¼Œä¼šæ·»åŠ ä¸€ä¸ªå¯¹åº”çš„çŸ­æš‚
      znodeï¼Œå› ä¸º zookeeper çš„é¡ºåºå·æœºåˆ¶ï¼Œç»™æ¯ä¸ªè¦è®¿é—®èµ„æºçš„å®¢æˆ·ç«¯å¯¹åº”çš„ znode åˆ†é…ä¸€ä¸ªé¡ºåºå·ï¼Œé€šè¿‡å¯¹æ¯”é¡ºåºå·ï¼Œå†³å®šèƒ½ä¸èƒ½ä½¿ç”¨è¿™ä¸ªèµ„æº

---

å®Œæ•´ä»£ç 
[GitHub](https://github.com/dong4j/dubbo_demo)

## [Pythonè‡ªåŠ¨åŒ–è„šæœ¬ï¼šå…¬å¸WiFiç›‘æ§ä¸é‚®ä»¶é€šçŸ¥](https://blog.dong4j.site/posts/958f9ffe.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

Python é¢å‘å¯¹è±¡åŸºç¡€éƒ¨åˆ†

<!-- more -->

ä¸­ç§‹åœ¨å®¶æ²¡äº‹, å†™äº†ä¸€ä¸ªå¾ˆä¹…ä»¥å‰å°±æƒ³å†™çš„è„šæœ¬

å¦‚æœä¸‹åˆ 6 ç‚¹ 10 åˆ†è¿˜è¿æ¥ç€å…¬å¸çš„ wifi, å°±å‘é‚®ä»¶ç»™è€å©†è¯´è¦åŠ ç­

ä¸ºä»€ä¹ˆè¦å‘é‚®ä»¶è€Œä¸å‘çŸ­ä¿¡å‘¢, å› ä¸ºçŸ­ä¿¡æ¥å£è¦é’±....
æœ€è¿‘ä¹°äº†ä¸ª 4k çš„æ˜¾ç¤ºå™¨, æ‹¿æ¥å¤–æ¥ mac çœ‹ä»£ç , çˆ½ç¿»äº†, ä¸è¿‡æœ‰ç‚¹è›®çƒ¦çš„å°±æ˜¯æ¯æ¬¡éƒ½è¦æ‹–åŠ¨é¼ æ ‡åˆ°å¦ä¸€ä¸ªå±å¹•ä¸Šå», ä¸è¿‡å…¨å›½æœ€å¤§çš„åŒæ€§äº¤å‹ç½‘ç«™ GitHub
ä¸Šé¢æœ‰ä¸€æ¬¾å¼€æºçš„è½¯ä»¶å« `CatchMouse` è§£å†³äº†è¿™ä¸ªé—®é¢˜

ä¸‹è½½åœ°å€: [CatchMouse](http://https://github.com/ROUND/CatchMouse)

å¦ä¸€ä¸ªé—®é¢˜æ˜¯å¦‚æœæƒ³æŠŠè½¯ä»¶ä» mac å±å¹•æ”¾åˆ°å¤–æ¥æ˜¾ç¤ºå±çš„è¯, è¿˜æ˜¯è¦æ‹–è¿‡å», ä½†æ˜¯....
å¦ä¸€æ¬¾ç¥å™¨ Moon èƒ½å¸®æˆ‘ä»¬å¿«é€Ÿçš„æŠŠå½“å‰åº”ç”¨ç§»åŠ¨åˆ°å¤–æ¥æ˜¾ç¤ºå™¨ä¸Š,

![20241229154732_6XddkZWb.webp](https://cdn.dong4j.site/source/image/20241229154732_6XddkZWb.webp)

å…‰æ ‡å®šä½åˆ°éœ€è¦ç§»åŠ¨çš„ app ä¸Š, å¿«æ·é”® contro+` å³å¯

æ¥ä¸‹æ¥æ˜¯è„šæœ¬

æˆ‘çš„æ€è·¯æ˜¯:

å…ˆæ£€æµ‹å½“å‰è¿æ¥çš„æ˜¯å“ªé‡Œçš„ wifi
å¦‚æœæ˜¯å…¬å¸çš„ wifi, ä¸”å½“å‰æ—¶é—´å¤§äº 6 ç‚¹ 10 åˆ†, åˆ™ç»™è€å©†å‘é€é‚®ä»¶
å¦‚æœè¿æ¥çš„æ˜¯å®¶é‡Œçš„ wifi, åˆ™æ£€æµ‹æ˜¯å¦è¿æ¥äº†å¤–æ¥æ˜¾ç¤ºå™¨,
å¦‚æœè¿æ¥äº†, åˆ™æ£€æµ‹æ˜¯å¦å¼€å¯äº† CatchMouse.app, æ²¡æœ‰åˆ™æ‰“å¼€.

æ¥ä¸‹æ¥å¼€å§‹æ’¸ä»£ç :

```python
# Created by: dong4j
# Description: æ£€æŸ¥è¿æ¥çš„ wifi, å¦‚æœæ˜¯å®¶é‡Œçš„, æ£€æŸ¥æ˜¯å¦è¿æ¥å¤–æ¥æ˜¾ç¤ºå™¨
# å¦‚æœè¿æ¥äº†, åˆ™å¯åŠ¨ CatchMouse.app, åˆ‡æ¢éŸ³é¢‘è¾“å‡ºåˆ°å¤–æ¥æ˜¾ç¤ºå™¨
# å¦‚æœè¿æ¥å…¬å¸çš„ wifi, åˆ™æ£€æµ‹ 6 ç‚¹ 10 åˆ†æ˜¯å¦è¿˜æ˜¯è¿æ¥çš„å…¬å¸ wifi
# å¦‚æœæ˜¯, åˆ™å‘é€é‚®ä»¶ç»™è€å©†, è¯´è¦åŠ ç­

# coding=utf-8
import socket
import subprocess
import datetime
import smtplib
import time
from email.mime.text import MIMEText
from email.header import Header

mail_host = "smtp.163.com"
mail_user = "ç”¨æˆ·å"
mail_pass = "å¯†ç "
mail_postfix = "163.com"
log_dir = "smartlife.log"

# å…¨å±€å˜é‡, æ ‡è¯†æ˜¯å¦å·²ç»å‘é€è¿‡é‚®ä»¶
global_flag = True

def whereami(flag):
    myname = socket.getfqdn(socket.gethostname())
    save_log(myname)
    myaddr = socket.gethostbyname(myname)
    # å®¶é‡Œæœ‰ä¸€ä¸ªæè·¯ç”±å’Œä¸€ä¸ªå°ç±³è·¯ç”±å™¨, æ‰€ä»¥æœ‰ 2 ä¸ªç½‘æ®µ
    count_spring = myaddr.count("192.168.31.")
    count_hiwifi = myaddr.count("192.168.199.")
    # æ‚¨é˜¿å§ä»»æ„ä¸€ä¸ªåˆ™è¡¨ç¤ºè¿æ¥çš„æ˜¯å®¶é‡Œçš„ wifi
    if count_hiwifi + count_spring == 1:
        save_log("å®¶é‡Œçš„wifi")
        # è°ƒç”¨æ£€æŸ¥å¤–æ¥æ˜¾ç¤ºå™¨çš„æ–¹æ³•
        display()
    else:
        save_log("å…¬å¸çš„wifi")
        now_time = datetime.datetime.now()
        save_log("å½“å‰å°æ—¶æ˜¯ %s" % now_time.hour)
        save_log("å½“å‰åˆ†é’Ÿæ˜¯ %s" % now_time.minute)
        if now_time.hour == 18 and now_time.minute >= 10 and flag:
            send_mail(['269321381@qq.com'], 'æ¥è‡ªè€å…¬çš„é‚®ä»¶', "è€å©† æˆ‘è¦åŠ ç­,ä½ å…ˆåƒ")
            global global_flag
            global_flag = False
            # exit()

def display():
    # ä½¿ç”¨ shell å‘½ä»¤æ£€æŸ¥æ˜¯å¦è¿æ¥äº†å¤–æ¥æ˜¾ç¤ºå™¨, å¦‚æœæœ‰ä¸¤ä¸ª DisplayProductID, åˆ™è¡¨ç¤ºè¿æ¥å¤–æ¥æ˜¾ç¤ºå™¨, è¿˜å¯ä»¥ä½¿ç”¨ system_profiler SPDisplaysDataType | grep Resolution
    out_bytes = subprocess.check_output("ioreg -l | grep 'DisplayProductID'", shell = True)
    str1 = str(out_bytes, encoding = "utf-8")
    count = str1.count("DisplayProductID")
    str2 = str(subprocess.check_output("ps -ef | grep CatchMouse.app | grep -v grep | awk '{ print $2 }'", shell = True),
               encoding = "utf-8")
    save_log("CatchMouse.app pid: " + str2)
    # å¦‚æœä½ æœ‰å¤šä¸ªæ˜¾ç¤ºå™¨, è¿™é‡Œè¦ä¿®æ”¹ä¸ºä½ è‡ªå·±çš„æ˜¾ç¤ºå™¨ä¸ªæ•°
    if count == 2 and str2 == "":
        save_log("å¼€å¯CatchMouse")
        retcode = subprocess.call("open -a CatchMouse.app", shell = True)
        if retcode == 0:
            log = " å¼€å¯CatchMouse.appæˆåŠŸ"
        else:
            log = " å¼€å¯CatchMouse.appå¤±è´¥"
        save_log(log)

# å‘é€é‚®ä»¶
def send_mail(to_list, title, context):
    me = mail_user + "<" + mail_user + "@" + mail_postfix + ">"
    msg = MIMEText(context, 'plain', 'utf-8')
    msg['Subject'] = Header(title, 'utf-8')
    msg['From'] = me
    msg['To'] = ";".join(to_list)
    try:
        s = smtplib.SMTP()
        s.connect(mail_host)
        s.login(mail_user, mail_pass)
        s.sendmail(me, to_list, msg.as_string())
        s.quit()
        save_log("é‚®ä»¶å‘é€æˆåŠŸ")
    except Exception as e:
        save_log(str(e))

# ä¿å­˜ log
def save_log(log_str):
    write_log = open(log_dir, 'a')
    log = '[%s]--> %s\n' % (time.strftime('%Y-%m-%d %H:%M:%S'), log_str)
    print(log)
    write_log.write(log)
    write_log.close()

if __name__ == '__main__':
    while (True):
        whereami(global_flag)
        time.sleep(10)
```

è„šæœ¬å®Œæˆäº†
å—åˆ° [è¶…è¿‡ 90 ç§’çš„ä»»åŠ¡ä¸è‡ªåŠ¨åŒ–, ä½ å¥½æ„æ€è¯´è‡ªå·±æ˜¯é»‘å®¢ï¼Ÿ](http://http://blog.jobbole.com/95222/) è¿™ç¯‡æ–‡ç« çš„å¯å‘, æ‰€æœ‰æœ‰äº†è¿™ä¸ªè„šæœ¬

çµæ„Ÿæ¥æºäºç”Ÿæ´».......

## [è‡ªå®šä¹‰SSHå¯†é’¥ï¼Œé«˜æ•ˆç®¡ç†å¤šä¸ªGitHubå’ŒGitLabè´¦æˆ·](https://blog.dong4j.site/posts/32516dfc.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

> ERROR: Permission to ArrayDsj/git-test.git denied to dong4j.
> fatal: Could not read from remote repository.

> Please make sure you have the correct access rights
> and the repository exists.

ç›®å‰æœ‰ 2 ä¸ª github è´¦å·, ä¸€ä¸ªå…¬å¸çš„ gitlab è´¦å·

æœ‰ä¸€æ¬¡é‡åˆ°äº†

```
ERROR: Permission to XXX.git denied to user
```

é”™è¯¯, æ•´ç†äº†ä¸€ä¸‹,è¿™é‡Œåšä¸€ä¸ªè®°å½•

## é”™è¯¯å‰æ

å¾ˆä¹…ä»¥å‰ä½¿ç”¨ ssh-keygen ç”Ÿæˆä¸€å¯¹é»˜è®¤åç§°çš„å…¬ç§åŒ™, ç›´æ¥å¯¼å…¥ github ä¸­å°±èƒ½ä½¿ç”¨, è¿™æ˜¯åªåœ¨ä¸€ä¸ªç”¨æˆ·çš„æƒ…å†µä¸‹, åå°åˆç”³è¯·äº†ä¸€ä¸ª github è´¦å·, è¿˜æ˜¯ä½¿ç”¨ id_rsa.pub è¿™ä¸ªé»˜è®¤çš„å…¬åŒ™, è¿™å°±é€ æˆäº†ä¸Šé¢çš„é”™è¯¯.

## è§£å†³æ–¹æ³•

ä¸ºä¸åŒçš„è´¦å·ç”Ÿæˆä¸åŒçš„å…¬ç§åŒ™

**1. ç”Ÿæˆå¯†åŒ™å¯¹**

```shell
# ç”Ÿæˆå¯†åŒ™å¯¹ åç§°ä¸º user1-github-ssh-key
ssh-keygen -t rsa -f ~/.ssh/user1-github-ssh-key -b 4096 -C "user1@mail.com"

# ç”Ÿæˆå¯†åŒ™å¯¹ åç§°ä¸º user2-github-ssh-key
ssh-keygen -t rsa -f ~/.ssh/user2-github-ssh-key -C user2@mail.com

# å› ä¸ºé»˜è®¤åªè¯»å– id_rsaï¼Œä¸ºäº†è®© SSH è¯†åˆ«æ–°çš„ç§é’¥ï¼Œéœ€å°†å…¶æ·»åŠ åˆ° SSH agent ä¸­ï¼š
ssh-add ~/.ssh/user1-github-ssh-key
ssh-add ~/.ssh/user2-github-ssh-key

# ç™»é™†2ä¸ªä¸åŒçš„Githubè´¦å·, ç‚¹å‡» ç½‘é¡µå³ä¸Šä¾§çš„ Account Setting æŒ‰é’® - é€‰æ‹© ssh-keys  ç‚¹å‡» Add SSH Key
```

**2. è®¾ç½® ssh config**

```shell
# Default github user(user1@mail.com)
Host github.com
    HostName github.com
    User git
    IdentityFile ~/.ssh/user1-github-ssh-key

 # second user(user2@mail.com)
 # å»ºä¸€ä¸ªgithubåˆ«åï¼Œæ–°å»ºçš„å¸å·ä½¿ç”¨è¿™ä¸ªåˆ«ååšå…‹éš†å’Œæ›´æ–°
Host github2
    HostName github.com
    User git
    IdentityFile ~/.ssh/user2-github-ssh-key.pub
```

**3. è¿æ¥æµ‹è¯•**

```shell
$ ssh -T git@github.com
Hi user1! You've successfully authenticated, but GitHub does not provide shell access.

$ ssh -T github2
Hi user2! You've successfully authenticated, but GitHub does not provide shell access.
```

**4. ä½¿ç”¨ repo è®¾ç½®ä»£æ›¿ git å…¨å±€è®¾ç½®**

```shell
# æŸ¥çœ‹ git config é…ç½®
æ ¼å¼ï¼šgit config [--local| --global | --system] -l
æŸ¥çœ‹ä»“åº“çº§çš„ configï¼Œå³ .git/configï¼Œå‘½ä»¤ï¼šgit config --local -l
æŸ¥çœ‹å…¨å±€çº§çš„ configï¼Œå³ ~/.gitconfigï¼Œå‘½ä»¤ï¼šgit config --global -l
# ä½¿ç”¨ homebrew å®‰è£…çš„ git çš„é…ç½®æ–‡ä»¶è·¯å¾„
æŸ¥çœ‹ç³»ç»Ÿçº§çš„ configï¼Œå³ /usr/local/etc/gitconfigï¼Œå‘½ä»¤ï¼šgit config --system -l
æŸ¥çœ‹å½“å‰ç”Ÿæ•ˆçš„é…ç½®ï¼Œå‘½ä»¤ï¼šgit config -l
```

```shell
# åˆ é™¤å…¨å±€é…ç½®
git config --global --unset user.email

# åœ¨ repo ä¸‹ä½¿ç”¨å±€éƒ¨é…ç½®
git config --local user.name "user1"
git config --local user.email user1@mail.com
```

**5. git æ“ä½œæµ‹è¯•**

```shell
# æœ¬åœ°æ–°å»ºé¡¹ç›®
git init
git add .
git commit -t 'init'
git remote add origin git@github.com:dong4j/dubbo_demo.git
# push åˆ°è¿œç¨‹ä»“åº“
git push -u origin master
# ä»è¿œç¨‹ä»“åº“æ›´æ–°
git pull origin master
```

## GitLab ä½¿ç”¨è‡ªå®šä¹‰å¯†åŒ™

ä¿®æ”¹ .ssh/config

```
Host  gitlabæœåŠ¡å™¨ipåœ°å€
    RSAAuthentication yes
    IdentityFile ~/.ssh/your-ssh-key
```

## [JVMå†…éƒ¨æœºåˆ¶å¤§æ­ç§˜ï¼šJavaç±»åŠ è½½å…¨è¿‡ç¨‹](https://blog.dong4j.site/posts/cd5f7bae.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

å½“ç¨‹åºä½¿ç”¨æŸä¸ªç±»æ—¶, å¦‚æœè¯¥ç±»è¿˜æ²¡è¢«åˆå§‹åŒ–, åŠ è½½åˆ°å†…å­˜ä¸­, åˆ™ç³»ç»Ÿä¼šé€šè¿‡åŠ è½½ã€è¿æ¥ã€åˆå§‹åŒ–ä¸‰ä¸ªè¿‡ç¨‹æ¥å¯¹è¯¥ç±»è¿›è¡Œåˆå§‹åŒ–. è¯¥è¿‡ç¨‹å°±è¢«ç§°ä¸ºç±»çš„åˆå§‹åŒ–

<!-- more -->

### ç±»åŠ è½½

æŒ‡å°†ç±»çš„ class æ–‡ä»¶è¯»å…¥å†…å­˜, å¹¶ä¸ºä¹‹åˆ›å»ºä¸€ä¸ª java.lang.Class çš„å¯¹è±¡

#### ç±»æ–‡ä»¶æ¥æº

- ä»æœ¬åœ°æ–‡ä»¶ç³»ç»ŸåŠ è½½çš„ class æ–‡ä»¶

- ä» JAR åŒ…åŠ è½½ class æ–‡ä»¶

- ä»ç½‘ç»œåŠ è½½ class æ–‡ä»¶

- æŠŠä¸€ä¸ª Java æºæ–‡ä»¶åŠ¨æ€ç¼–è¯‘, å¹¶æ‰§è¡ŒåŠ è½½

ç±»åŠ è½½å™¨é€šå¸¸æ— é¡»ç­‰åˆ°â€œé¦–æ¬¡ä½¿ç”¨â€è¯¥ç±»æ—¶æ‰åŠ è½½è¯¥ç±», JVM å…è®¸ç³»ç»Ÿé¢„å…ˆåŠ è½½æŸäº›ç±»

#### ç±»åŠ è½½å™¨

ç±»åŠ è½½å™¨å°±æ˜¯è´Ÿè´£åŠ è½½æ‰€æœ‰çš„ç±», å°†å…¶è½½å…¥å†…å­˜ä¸­, ç”Ÿæˆä¸€ä¸ª java.lang.Class å®ä¾‹. ä¸€æ—¦ä¸€ä¸ªç±»è¢«åŠ è½½åˆ° JVM ä¸­ä¹‹å, å°±ä¸ä¼šå†æ¬¡è½½å…¥äº†.

![20241229154732_YsqIonrn.webp](https://cdn.dong4j.site/source/image/20241229154732_YsqIonrn.webp)

- æ ¹ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰: å…¶è´Ÿè´£åŠ è½½ Java çš„æ ¸å¿ƒç±», æ¯”å¦‚ Stringã€System è¿™äº›ç±»

- æ‹“å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰: å…¶è´Ÿè´£åŠ è½½ JRE çš„æ‹“å±•ç±»åº“

- ç³»ç»Ÿç±»åŠ è½½å™¨ï¼ˆSystem ClassLoaderï¼‰: å…¶è´Ÿè´£åŠ è½½ CLASSPATH ç¯å¢ƒå˜é‡æ‰€æŒ‡å®šçš„ JAR åŒ…å’Œç±»è·¯å¾„

- ç”¨æˆ·ç±»åŠ è½½å™¨: ç”¨æˆ·è‡ªå®šä¹‰çš„åŠ è½½å™¨, ä»¥ç±»åŠ è½½å™¨ä¸ºçˆ¶ç±»

> ç±»åŠ è½½å™¨ä¹‹é—´çš„çˆ¶å­å…³ç³»å¹¶ä¸æ˜¯ç»§æ‰¿å…³ç³», æ˜¯ç±»åŠ è½½å™¨å®ä¾‹ä¹‹é—´çš„å…³ç³»

```java
public static void main(String[] args) throws IOException {
    ClassLoader systemLoader = ClassLoader.getSystemClassLoader();
    System.out.println("ç³»ç»Ÿç±»åŠ è½½");
    Enumeration<URL> em1 = systemLoader.getResources("");
    while (em1.hasMoreElements()) {
        System.out.println(em1.nextElement());
    }
    ClassLoader extensionLader = systemLoader.getParent();
    System.out.println("æ‹“å±•ç±»åŠ è½½å™¨" + extensionLader);
    System.out.println("æ‹“å±•ç±»åŠ è½½å™¨çš„çˆ¶" + extensionLader.getParent());
}
```

`ç»“æœ`

```
ç³»ç»Ÿç±»åŠ è½½
file:/E:/gaode/em/bin/
æ‹“å±•ç±»åŠ è½½å™¨ sun.misc.Launcher$ExtClassLoader@6d06d69c
æ‹“å±•ç±»åŠ è½½å™¨çš„çˆ¶ null
```

**ä¸ºä»€ä¹ˆæ ¹ç±»åŠ è½½å™¨ä¸º NULL?**

> æ ¹ç±»åŠ è½½å™¨å¹¶ä¸æ˜¯ Java å®ç°çš„, è€Œä¸”ç”±äºç¨‹åºé€šå¸¸é¡»è®¿é—®æ ¹åŠ è½½å™¨, å› æ­¤è®¿é—®æ‰©å±•ç±»åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨æ—¶è¿”å› NULL

#### JVM ç±»åŠ è½½æœºåˆ¶

- å…¨ç›˜è´Ÿè´£, å½“ä¸€ä¸ªç±»åŠ è½½å™¨è´Ÿè´£åŠ è½½æŸä¸ª Class æ—¶, è¯¥ Class æ‰€ä¾èµ–çš„å’Œå¼•ç”¨çš„å…¶ä»– Class ä¹Ÿå°†ç”±è¯¥ç±»åŠ è½½å™¨è´Ÿè´£è½½å…¥, é™¤éæ˜¾ç¤ºä½¿ç”¨å¦å¤–ä¸€ä¸ªç±»åŠ è½½å™¨æ¥è½½å…¥
- çˆ¶ç±»å§”æ‰˜, å…ˆè®©çˆ¶ç±»åŠ è½½å™¨è¯•å›¾åŠ è½½è¯¥ç±», åªæœ‰åœ¨çˆ¶ç±»åŠ è½½å™¨æ— æ³•åŠ è½½è¯¥ç±»æ—¶æ‰å°è¯•ä»è‡ªå·±çš„ç±»è·¯å¾„ä¸­åŠ è½½è¯¥ç±»
- ç¼“å­˜æœºåˆ¶, ç¼“å­˜æœºåˆ¶å°†ä¼šä¿è¯æ‰€æœ‰åŠ è½½è¿‡çš„ Class éƒ½ä¼šè¢«ç¼“å­˜, å½“ç¨‹åºä¸­éœ€è¦ä½¿ç”¨æŸä¸ª Class æ—¶, ç±»åŠ è½½å™¨å…ˆä»ç¼“å­˜åŒºå¯»æ‰¾è¯¥ Class, åªæœ‰ç¼“å­˜åŒºä¸å­˜åœ¨,
  ç³»ç»Ÿæ‰ä¼šè¯»å–è¯¥ç±»å¯¹åº”çš„äºŒè¿›åˆ¶æ•°æ®, å¹¶å°†å…¶è½¬æ¢æˆ Class å¯¹è±¡, å­˜å…¥ç¼“å­˜åŒº. è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¿®æ”¹äº† Class å, å¿…é¡»é‡å¯ JVM, ç¨‹åºçš„ä¿®æ”¹æ‰ä¼šç”Ÿæ•ˆ

#### URLClassLoader ç±»

URLClassLoader ä¸º ClassLoader çš„ä¸€ä¸ªå®ç°ç±», è¯¥ç±»ä¹Ÿæ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨å’Œæ‹“å±•ç±»åŠ è½½å™¨çš„çˆ¶ç±»ï¼ˆç»§æ‰¿å…³ç³»ï¼‰. å®ƒæ—¢å¯ä»¥ä»æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿè·å–äºŒè¿›åˆ¶æ–‡ä»¶æ¥åŠ è½½ç±»,
ä¹Ÿå¯ä»¥è¿œç¨‹ä¸»æœºè·å–äºŒè¿›åˆ¶æ–‡ä»¶æ¥åŠ è½½ç±».

ä¸¤ä¸ªæ„é€ å™¨

- `URLClassLoader(URL[] urls)`: ä½¿ç”¨é»˜è®¤çš„çˆ¶ç±»åŠ è½½å™¨åˆ›å»ºä¸€ä¸ª ClassLoader å¯¹è±¡, è¯¥å¯¹è±¡å°†ä» urls æ‰€æŒ‡å®šçš„è·¯å¾„æ¥æŸ¥è¯¢å¹¶åŠ è½½ç±»
- `URLClassLoader(URL[] urls,ClassLoader parent)`: ä½¿ç”¨æŒ‡å®šçš„çˆ¶ç±»åŠ è½½å™¨åˆ›å»ºä¸€ä¸ª ClassLoader å¯¹è±¡, å…¶ä»–åŠŸèƒ½ä¸å‰ä¸€ä¸ªæ„é€ å™¨ç›¸åŒ

```java
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLClassLoader;
import java.sql.Connection;
import java.sql.SQLException;
import java.util.Properties;

import com.mysql.jdbc.Driver;

public class GetMysql {
    private static Connection conn;
    public static Connection getConn(String url,String user,String pass) throws MalformedURLException, InstantiationException, IllegalAccessException, ClassNotFoundException, SQLException{
        if(conn==null){
            URL[]urls={new URL("file:mysql-connector-java-5.1.18.jar")};
            URLClassLoader myClassLoader=new URLClassLoader(urls);
            Driver driver=(Driver) myClassLoader.loadClass("com.mysql.jdbc.Driver").newInstance();
            Properties pros=new Properties();
            pros.setProperty("user", user);
            pros.setProperty("password", pass);
            conn=driver.connect(url, pros);
        }
        return conn;
    }
    public static method1 getConn() throws MalformedURLException, InstantiationException, IllegalAccessException, ClassNotFoundException, SQLException{

            URL[]urls={new URL("file:com.arraydsj@163.com")};
            URLClassLoader myClassLoader=new URLClassLoader(urls);
            method1 driver=(method1) myClassLoader.loadClass("com.arraydsj@163.com.method1").newInstance();

        return driver;
    }

    public static void main(String[] args) throws MalformedURLException, InstantiationException, IllegalAccessException, ClassNotFoundException, SQLException {
        System.out.println(getConn("jdbc:mysql://10.10.16.11:3306/auto?useUnicode=true&characterEncoding=utf8&allowMultiQueries=true", "jiji", "jiji"));
        System.out.println(getConn());
    }
}
```

è·å¾— URLClassLoader å¯¹è±¡å, è°ƒç”¨ **loanClass()** æ–¹æ³•æ¥åŠ è½½æŒ‡å®šçš„ç±»

#### è‡ªå®šä¹‰ç±»åŠ è½½å™¨

```java
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.lang.reflect.Method;

public class CompileClassLoader extends ClassLoader{

    // è¯»å–ä¸€ä¸ªæ–‡ä»¶çš„å†…å®¹
    @SuppressWarnings("resource")
    private byte[] getBytes(String filename) throws IOException{
        File file = new File(filename);
        long len = file.length();
        byte[] raw = new byte[(int) len];
        FileInputStream fin = new FileInputStream(file);
        // ä¸€æ¬¡è¯»å– class æ–‡ä»¶çš„å…¨éƒ¨äºŒè¿›åˆ¶æ•°æ®
        int r = fin.read(raw);
        if (r != len)
            throw new IOException("æ— æ³•è¯»å–å…¨éƒ¨æ–‡ä»¶" + r + "!=" + len);
        fin.close();
        return raw;
    }

    // å®šä¹‰ç¼–è¯‘æŒ‡å®š java æ–‡ä»¶çš„æ–¹æ³•
    private boolean compile(String javaFile) throws IOException {
        System.out.println("CompileClassLoader:æ­£åœ¨ç¼–è¯‘" + javaFile + "â€¦â€¦..");
        // è°ƒç”¨ç³»ç»Ÿçš„ javac å‘½ä»¤
        Process p = Runtime.getRuntime().exec("javac" + javaFile);
        try {
            // å…¶å®ƒçº¿ç¨‹éƒ½ç­‰å¾…è¿™ä¸ªçº¿ç¨‹å®Œæˆ
            p.waitFor();
        } catch (InterruptedException ie){
            System.out.println(ie);
        }
        // è·å– javac çš„çº¿ç¨‹çš„é€€å‡ºå€¼
        int ret = p.exitValue();
        // è¿”å›ç¼–è¯‘æ˜¯å¦æˆåŠŸ
        return ret == 0;
    }

    // é‡å†™ Classloader çš„ findCLass æ–¹æ³•
    protected Class<?> findClass(String name) throws ClassNotFoundException{
        Class clazz = null;
        // å°†åŒ…è·¯å¾„ä¸­çš„. æ›¿æ¢æˆæ–œçº¿ /
        String fileStub = name.replace(".", "/");
        String javaFilename = fileStub + ".java";
        String classFilename = fileStub + ".class";
        File javaFile = new File(javaFilename);
        File classFile = new File(classFilename);
        // å½“æŒ‡å®š Java æºæ–‡ä»¶å­˜åœ¨, ä¸” class æ–‡ä»¶ä¸å­˜åœ¨, æˆ–è€… Java æºæ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´æ¯” class æ–‡ä»¶ // ä¿®æ”¹æ—¶é—´æ™šæ—¶, é‡æ–°ç¼–è¯‘
        if (javaFile.exists() && (!classFile.exists())
                || javaFile.lastModified()> classFile.lastModified()) {
            try {
                // å¦‚æœç¼–è¯‘å¤±è´¥, æˆ–è¯¥ Class æ–‡ä»¶ä¸å­˜åœ¨
                if (!compile(javaFilename) || !classFile.exists()) {
                    throw new ClassNotFoundException("ClassNotFoundException:"
                            + javaFilename);
                }
            } catch (IOException ex) {
                ex.printStackTrace();
            }
        }
        // å¦‚æœ class æ–‡ä»¶å­˜åœ¨, ç³»ç»Ÿè´Ÿè´£å°†è¯¥æ–‡ä»¶è½¬åŒ–æˆ class å¯¹è±¡
        if (classFile.exists()) {
            try {
                // å°† class æ–‡ä»¶çš„äºŒè¿›åˆ¶æ•°æ®è¯»å…¥æ•°ç»„
                byte[] raw = getBytes(classFilename);
                // è°ƒç”¨ Classloader çš„ defineClass æ–¹æ³•å°†äºŒè¿›åˆ¶æ•°æ®è½¬æ¢æˆ class å¯¹è±¡
                clazz = defineClass(name, raw, 0, raw.length);
            } catch (IOException ie) {
                ie.printStackTrace();
            }
        }

        // å¦‚æœ claszz ä¸º null, è¡¨æ˜åŠ è½½å¤±è´¥, åˆ™æŠ›å‡ºå¼‚å¸¸
        if (clazz == null) {
            throw new ClassNotFoundException(name);
        }
        return clazz;
    }

    // å®šä¹‰ä¸€ä¸ªä¸»æ–¹æ³•
    public static void main(String[] args) throws Exception {
        // å¦‚æœè¿è¡Œè¯¥ç¨‹åºæ—¶æ²¡æœ‰å‚æ•°, å³æ²¡æœ‰ç›®æ ‡ç±»
        if (args.length < 1) {
            System.out.println("ç¼ºå°‘è¿è¡Œçš„ç›®æ ‡ç±», è¯·æŒ‰å¦‚ä¸‹æ ¼å¼è¿è¡Œjavaæºæ–‡ä»¶: ");
            System.out.println("java CompileClassLoader ClassName");
        }
        // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯éœ€è¦è¿è¡Œçš„ç±»
        String progClass = args[0];
        // å‰©ä¸‹çš„å‚æ•°å°†ä½œä¸ºè¿è¡Œç›®æ ‡ç±»æ—¶çš„å‚æ•°, æ‰€ä»¥å°†è¿™äº›å‚æ•°å¤åˆ¶åˆ°ä¸€ä¸ªæ–°æ•°ç»„ä¸­
        String progargs[] = new String[args.length - 1];
        System.arraycopy(args, 1, progargs, 0, progargs.length);
        CompileClassLoader cl = new CompileClassLoader();
        // åŠ è½½éœ€è¦è¿è¡Œçš„ç±»
        Class<?> clazz = cl.loadClass(progClass);
        // è·å–éœ€è¦è¿è¡Œçš„ç±»çš„ä¸»æ–¹æ³•
        Method main = clazz.getMethod("main", (new String[0]).getClass());
        Object argsArray[] = { progargs};
        main.invoke(null, argsArray);
    }
}
```

JVM ä¸­é™¤äº†æ ¹ç±»åŠ è½½å™¨ä¹‹å¤–çš„æ‰€æœ‰ç±»çš„åŠ è½½å™¨éƒ½æ˜¯ ClassLoader å­ç±»çš„å®ä¾‹, é€šè¿‡é‡å†™ ClassLoader ä¸­çš„æ–¹æ³•, å®ç°è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨

loadClass(String name,boolean resolve): ä¸º ClassLoader çš„å…¥å£ç‚¹, æ ¹æ®æŒ‡å®šåç§°æ¥åŠ è½½ç±», ç³»ç»Ÿå°±æ˜¯è°ƒç”¨ ClassLoader çš„è¯¥æ–¹æ³•æ¥è·å–åˆ¶å®šç´¯å¯¹åº”çš„
Class å¯¹è±¡

findClass(String name): æ ¹æ®æŒ‡å®šåç§°æ¥æŸ¥æ‰¾ç±»

> æ¨èä½¿ç”¨ findClass æ–¹æ³•

### ç±»çš„é“¾æ¥

å½“ç±»è¢«åŠ è½½å, ç³»ç»Ÿä¼šä¸ºä¹‹ç”Ÿæˆä¸€ä¸ª Class å¯¹è±¡, æ¥ç€å°†ä¼šè¿›å…¥è¿æ¥é˜¶æ®µ, é“¾æ¥é˜¶æ®µè´Ÿè´£æŠŠç±»çš„äºŒè¿›åˆ¶æ•°æ®åˆå¹¶åˆ° JRE ä¸­

**ä¸‰ä¸ªé˜¶æ®µ**

éªŒè¯: æ£€éªŒè¢«åŠ è½½çš„ç±»æ˜¯å¦æœ‰æ­£ç¡®çš„å†…éƒ¨ç»“æ„, å¹¶å’Œå…¶ä»–ç±»åè°ƒä¸€è‡´

å‡†å¤‡: è´Ÿè´£ä¸ºç±»çš„ç±»å˜é‡åˆ†é…å†…å­˜. å¹¶è®¾ç½®é»˜è®¤åˆå§‹å€¼

è§£æ: å°†ç±»çš„äºŒè¿›åˆ¶æ•°æ®ä¸­çš„ç¬¦å·å¼•ç”¨æ›¿æ¢æˆç›´æ¥å¼•ç”¨

### ç±»çš„åˆå§‹åŒ–

JVM è´Ÿè´£å¯¹ç±»è¿›è¡Œåˆå§‹åŒ–, ä¸»è¦å¯¹ç±»å˜é‡è¿›è¡Œåˆå§‹åŒ–

åœ¨ Java ä¸­å¯¹ç±»å˜é‡è¿›è¡Œåˆå§‹å€¼è®¾å®šæœ‰ä¸¤ç§æ–¹å¼: â‘  å£°æ˜ç±»å˜é‡æ˜¯æŒ‡å®šåˆå§‹å€¼ â‘¡ ä½¿ç”¨é™æ€ä»£ç å—ä¸ºç±»å˜é‡æŒ‡å®šåˆå§‹å€¼

**JVM åˆå§‹åŒ–æ­¥éª¤**

1. å‡å¦‚è¿™ä¸ªç±»è¿˜æ²¡æœ‰è¢«åŠ è½½å’Œè¿æ¥, åˆ™ç¨‹åºå…ˆåŠ è½½å¹¶è¿æ¥è¯¥ç±»
2. å‡å¦‚è¯¥ç±»çš„ç›´æ¥çˆ¶ç±»è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–, åˆ™å…ˆåˆå§‹åŒ–å…¶ç›´æ¥çˆ¶ç±»
3. å‡å¦‚ç±»ä¸­æœ‰åˆå§‹åŒ–è¯­å¥, åˆ™ç³»ç»Ÿä¾æ¬¡æ‰§è¡Œè¿™äº›åˆå§‹åŒ–è¯­å¥

### ç±»åˆå§‹åŒ–æ—¶æœº

1. åˆ›å»ºç±»å®ä¾‹. ä¹Ÿå°±æ˜¯ new çš„æ–¹å¼
2. è°ƒç”¨æŸä¸ªç±»çš„ç±»æ–¹æ³•
3. è®¿é—®æŸä¸ªç±»æˆ–æ¥å£çš„ç±»å˜é‡, æˆ–ä¸ºè¯¥ç±»å˜é‡èµ‹å€¼
4. ä½¿ç”¨åå°„æ–¹å¼å¼ºåˆ¶åˆ›å»ºæŸä¸ªç±»æˆ–æ¥å£å¯¹åº”çš„ java.lang.Class å¯¹è±¡
5. åˆå§‹åŒ–æŸä¸ªç±»çš„å­ç±», åˆ™å…¶çˆ¶ç±»ä¹Ÿä¼šè¢«åˆå§‹åŒ–
6. ç›´æ¥ä½¿ç”¨ java.exe å‘½ä»¤æ¥è¿è¡ŒæŸä¸ªä¸»ç±»

[ç±»åŠ è½½æœºåˆ¶ï¼ˆç±»åŠ è½½è¿‡ç¨‹å’Œç±»åŠ è½½å™¨ï¼‰](http://blog.csdn.net/boyupeng/article/details/47951037)

## [æŒæ¡ Java å¹¶å‘ç²¾é«“ - ç†è§£JMMä¸Happens-beforeåŸåˆ™](https://blog.dong4j.site/posts/4d06da5c.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

ä»‹ç» Java å†…å­˜æ¨¡å‹ 3 å¤§æ ¸å¿ƒ

- åŸå­æ€§
- å¯è§æ€§
- é¡ºåºæ€§

[åŸæ–‡å‡ºå¤„ https://segmentfault.com/a/1190000000435392](https://segmentfault.com/a/1190000000435392)

<!-- more -->

## å¹¶å‘ç¼–ç¨‹æ¨¡å‹çš„åˆ†ç±»

åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼šçº¿ç¨‹ä¹‹é—´å¦‚ä½•é€šä¿¡åŠçº¿ç¨‹ä¹‹é—´å¦‚ä½•åŒæ­¥ï¼ˆè¿™é‡Œçš„çº¿ç¨‹æ˜¯æŒ‡å¹¶å‘æ‰§è¡Œçš„æ´»åŠ¨å®ä½“ï¼‰ã€‚é€šä¿¡æ˜¯æŒ‡çº¿ç¨‹ä¹‹é—´ä»¥ä½•ç§æœºåˆ¶æ¥äº¤æ¢ä¿¡æ¯ã€‚åœ¨å‘½ä»¤å¼ç¼–ç¨‹ä¸­ï¼Œçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡æœºåˆ¶æœ‰ä¸¤ç§ï¼šå…±äº«å†…å­˜å’Œæ¶ˆæ¯ä¼ é€’ã€‚

åœ¨å…±äº«å†…å­˜çš„å¹¶å‘æ¨¡å‹é‡Œï¼Œçº¿ç¨‹ä¹‹é—´å…±äº«ç¨‹åºçš„å…¬å…±çŠ¶æ€ï¼Œçº¿ç¨‹ä¹‹é—´é€šè¿‡å†™ - è¯»å†…å­˜ä¸­çš„å…¬å…±çŠ¶æ€æ¥éšå¼è¿›è¡Œé€šä¿¡ã€‚åœ¨æ¶ˆæ¯ä¼ é€’çš„å¹¶å‘æ¨¡å‹é‡Œï¼Œçº¿ç¨‹ä¹‹é—´æ²¡æœ‰å…¬å…±çŠ¶æ€ï¼Œçº¿ç¨‹ä¹‹é—´å¿…é¡»é€šè¿‡æ˜ç¡®çš„å‘é€æ¶ˆæ¯æ¥æ˜¾å¼è¿›è¡Œé€šä¿¡ã€‚

åŒæ­¥æ˜¯æŒ‡ç¨‹åºç”¨äºæ§åˆ¶ä¸åŒçº¿ç¨‹ä¹‹é—´æ“ä½œå‘ç”Ÿç›¸å¯¹é¡ºåºçš„æœºåˆ¶ã€‚åœ¨å…±äº«å†…å­˜å¹¶å‘æ¨¡å‹é‡Œï¼ŒåŒæ­¥æ˜¯æ˜¾å¼è¿›è¡Œçš„ã€‚ç¨‹åºå‘˜å¿…é¡»æ˜¾å¼æŒ‡å®šæŸä¸ªæ–¹æ³•æˆ–æŸæ®µä»£ç éœ€è¦åœ¨çº¿ç¨‹ä¹‹é—´äº’æ–¥æ‰§è¡Œã€‚åœ¨æ¶ˆæ¯ä¼ é€’çš„å¹¶å‘æ¨¡å‹é‡Œï¼Œç”±äºæ¶ˆæ¯çš„å‘é€å¿…é¡»åœ¨æ¶ˆæ¯çš„æ¥æ”¶ä¹‹å‰ï¼Œå› æ­¤åŒæ­¥æ˜¯éšå¼è¿›è¡Œçš„ã€‚

Java çš„å¹¶å‘é‡‡ç”¨çš„æ˜¯å…±äº«å†…å­˜æ¨¡å‹ï¼ŒJava çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡æ€»æ˜¯éšå¼è¿›è¡Œï¼Œæ•´ä¸ªé€šä¿¡è¿‡ç¨‹å¯¹ç¨‹åºå‘˜å®Œå…¨é€æ˜ã€‚å¦‚æœç¼–å†™å¤šçº¿ç¨‹ç¨‹åºçš„ Java
ç¨‹åºå‘˜ä¸ç†è§£éšå¼è¿›è¡Œçš„çº¿ç¨‹ä¹‹é—´é€šä¿¡çš„å·¥ä½œæœºåˆ¶ï¼Œå¾ˆå¯èƒ½ä¼šé‡åˆ°å„ç§å¥‡æ€ªçš„å†…å­˜å¯è§æ€§é—®é¢˜ã€‚

## Java å†…å­˜æ¨¡å‹çš„æŠ½è±¡

åœ¨ java ä¸­ï¼Œæ‰€æœ‰å®ä¾‹åŸŸã€é™æ€åŸŸå’Œæ•°ç»„å…ƒç´ å­˜å‚¨åœ¨å †å†…å­˜ä¸­ï¼Œå †å†…å­˜åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«ï¼ˆæœ¬æ–‡ä½¿ç”¨â€œå…±äº«å˜é‡â€è¿™ä¸ªæœ¯è¯­ä»£æŒ‡å®ä¾‹åŸŸï¼Œé™æ€åŸŸå’Œæ•°ç»„å…ƒç´ ï¼‰ã€‚å±€éƒ¨å˜é‡ï¼ˆLocal
variablesï¼‰ï¼Œæ–¹æ³•å®šä¹‰å‚æ•°ï¼ˆjava è¯­è¨€è§„èŒƒç§°ä¹‹ä¸º formal method parametersï¼‰å’Œå¼‚å¸¸å¤„ç†å™¨å‚æ•°ï¼ˆexception handler
parametersï¼‰ä¸ä¼šåœ¨çº¿ç¨‹ä¹‹é—´å…±äº«ï¼Œå®ƒä»¬ä¸ä¼šæœ‰å†…å­˜å¯è§æ€§é—®é¢˜ï¼Œä¹Ÿä¸å—å†…å­˜æ¨¡å‹çš„å½±å“ã€‚

Java çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ç”± Java å†…å­˜æ¨¡å‹ï¼ˆæœ¬æ–‡ç®€ç§°ä¸º JMMï¼‰æ§åˆ¶ï¼ŒJMM å†³å®šä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å†™å…¥ä½•æ—¶å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ã€‚ä»æŠ½è±¡çš„è§’åº¦æ¥çœ‹ï¼ŒJMM
å®šä¹‰äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„æŠ½è±¡å…³ç³»ï¼šçº¿ç¨‹ä¹‹é—´çš„å…±äº«å˜é‡å­˜å‚¨åœ¨ä¸»å†…å­˜ï¼ˆmain memoryï¼‰ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç§æœ‰çš„æœ¬åœ°å†…å­˜ï¼ˆlocal
memoryï¼‰ï¼Œæœ¬åœ°å†…å­˜ä¸­å­˜å‚¨äº†è¯¥çº¿ç¨‹ä»¥è¯» / å†™å…±äº«å˜é‡çš„å‰¯æœ¬ã€‚æœ¬åœ°å†…å­˜æ˜¯ JMM çš„ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µï¼Œå¹¶ä¸çœŸå®å­˜åœ¨ã€‚å®ƒæ¶µç›–äº†ç¼“å­˜ï¼Œå†™ç¼“å†²åŒºï¼Œå¯„å­˜å™¨ä»¥åŠå…¶ä»–çš„ç¡¬ä»¶å’Œç¼–è¯‘å™¨ä¼˜åŒ–ã€‚Java
å†…å­˜æ¨¡å‹çš„æŠ½è±¡ç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![20241229154732_Z3p8GoC9.webp](https://cdn.dong4j.site/source/image/20241229154732_Z3p8GoC9.webp)

ä»ä¸Šå›¾æ¥çœ‹ï¼Œçº¿ç¨‹ A ä¸çº¿ç¨‹ B ä¹‹é—´å¦‚è¦é€šä¿¡çš„è¯ï¼Œå¿…é¡»è¦ç»å†ä¸‹é¢ 2 ä¸ªæ­¥éª¤ï¼š

1. é¦–å…ˆï¼Œçº¿ç¨‹ A æŠŠæœ¬åœ°å†…å­˜ A ä¸­æ›´æ–°è¿‡çš„å…±äº«å˜é‡åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­å»ã€‚
2. ç„¶åï¼Œçº¿ç¨‹ B åˆ°ä¸»å†…å­˜ä¸­å»è¯»å–çº¿ç¨‹ A ä¹‹å‰å·²æ›´æ–°è¿‡çš„å…±äº«å˜é‡ã€‚

ä¸‹é¢é€šè¿‡ç¤ºæ„å›¾æ¥è¯´æ˜è¿™ä¸¤ä¸ªæ­¥éª¤ï¼š

![20241229154732_zwPLe6LN.webp](https://cdn.dong4j.site/source/image/20241229154732_zwPLe6LN.webp)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæœ¬åœ°å†…å­˜ A å’Œ B æœ‰ä¸»å†…å­˜ä¸­å…±äº«å˜é‡ x çš„å‰¯æœ¬ã€‚å‡è®¾åˆå§‹æ—¶ï¼Œè¿™ä¸‰ä¸ªå†…å­˜ä¸­çš„ x å€¼éƒ½ä¸º 0ã€‚çº¿ç¨‹ A åœ¨æ‰§è¡Œæ—¶ï¼ŒæŠŠæ›´æ–°åçš„ x å€¼ï¼ˆå‡è®¾å€¼ä¸º
1ï¼‰ä¸´æ—¶å­˜æ”¾åœ¨è‡ªå·±çš„æœ¬åœ°å†…å­˜ A ä¸­ã€‚å½“çº¿ç¨‹ A å’Œçº¿ç¨‹ B éœ€è¦é€šä¿¡æ—¶ï¼Œçº¿ç¨‹ A é¦–å…ˆä¼šæŠŠè‡ªå·±æœ¬åœ°å†…å­˜ä¸­ä¿®æ”¹åçš„ x å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ï¼Œæ­¤æ—¶ä¸»å†…å­˜ä¸­çš„ x å€¼å˜ä¸ºäº†
1ã€‚éšåï¼Œçº¿ç¨‹ B åˆ°ä¸»å†…å­˜ä¸­å»è¯»å–çº¿ç¨‹ A æ›´æ–°åçš„ x å€¼ï¼Œæ­¤æ—¶çº¿ç¨‹ B çš„æœ¬åœ°å†…å­˜çš„ x å€¼ä¹Ÿå˜ä¸ºäº† 1ã€‚

ä»æ•´ä½“æ¥çœ‹ï¼Œè¿™ä¸¤ä¸ªæ­¥éª¤å®è´¨ä¸Šæ˜¯çº¿ç¨‹ A åœ¨å‘çº¿ç¨‹ B å‘é€æ¶ˆæ¯ï¼Œè€Œä¸”è¿™ä¸ªé€šä¿¡è¿‡ç¨‹å¿…é¡»è¦ç»è¿‡ä¸»å†…å­˜ã€‚JMM é€šè¿‡æ§åˆ¶ä¸»å†…å­˜ä¸æ¯ä¸ªçº¿ç¨‹çš„æœ¬åœ°å†…å­˜ä¹‹é—´çš„äº¤äº’ï¼Œæ¥ä¸º
java ç¨‹åºå‘˜æä¾›å†…å­˜å¯è§æ€§ä¿è¯ã€‚

## é‡æ’åº

åœ¨æ‰§è¡Œç¨‹åºæ—¶ä¸ºäº†æé«˜æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¸¸å¸¸ä¼šå¯¹æŒ‡ä»¤åšé‡æ’åºã€‚é‡æ’åºåˆ†ä¸‰ç§ç±»å‹ï¼š

1. ç¼–è¯‘å™¨ä¼˜åŒ–çš„é‡æ’åºã€‚ç¼–è¯‘å™¨åœ¨ä¸æ”¹å˜å•çº¿ç¨‹ç¨‹åºè¯­ä¹‰çš„å‰æä¸‹ï¼Œå¯ä»¥é‡æ–°å®‰æ’è¯­å¥çš„æ‰§è¡Œé¡ºåºã€‚
2. æŒ‡ä»¤çº§å¹¶è¡Œçš„é‡æ’åºã€‚ç°ä»£å¤„ç†å™¨é‡‡ç”¨äº†æŒ‡ä»¤çº§å¹¶è¡ŒæŠ€æœ¯ï¼ˆInstruction-Level Parallelismï¼Œ ILPï¼‰æ¥å°†å¤šæ¡æŒ‡ä»¤é‡å æ‰§è¡Œã€‚å¦‚æœä¸å­˜åœ¨æ•°æ®ä¾èµ–æ€§ï¼Œå¤„ç†å™¨å¯ä»¥æ”¹å˜è¯­å¥å¯¹åº”æœºå™¨æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºã€‚
3. å†…å­˜ç³»ç»Ÿçš„é‡æ’åºã€‚ç”±äºå¤„ç†å™¨ä½¿ç”¨ç¼“å­˜å’Œè¯» / å†™ç¼“å†²åŒºï¼Œè¿™ä½¿å¾—åŠ è½½å’Œå­˜å‚¨æ“ä½œçœ‹ä¸Šå»å¯èƒ½æ˜¯åœ¨ä¹±åºæ‰§è¡Œã€‚

ä» java æºä»£ç åˆ°æœ€ç»ˆå®é™…æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—ï¼Œä¼šåˆ†åˆ«ç»å†ä¸‹é¢ä¸‰ç§é‡æ’åºï¼š

![20241229154732_sfrpZLks.webp](https://cdn.dong4j.site/source/image/20241229154732_sfrpZLks.webp)

ä¸Šè¿°çš„ 1 å±äºç¼–è¯‘å™¨é‡æ’åºï¼Œ2 å’Œ 3 å±äºå¤„ç†å™¨é‡æ’åºã€‚è¿™äº›é‡æ’åºéƒ½å¯èƒ½ä¼šå¯¼è‡´å¤šçº¿ç¨‹ç¨‹åºå‡ºç°å†…å­˜å¯è§æ€§é—®é¢˜ã€‚å¯¹äºç¼–è¯‘å™¨ï¼ŒJMM
çš„ç¼–è¯‘å™¨é‡æ’åºè§„åˆ™ä¼šç¦æ­¢ç‰¹å®šç±»å‹çš„ç¼–è¯‘å™¨é‡æ’åºï¼ˆä¸æ˜¯æ‰€æœ‰çš„ç¼–è¯‘å™¨é‡æ’åºéƒ½è¦ç¦æ­¢ï¼‰ã€‚å¯¹äºå¤„ç†å™¨é‡æ’åºï¼ŒJMM çš„å¤„ç†å™¨é‡æ’åºè§„åˆ™ä¼šè¦æ±‚ java
ç¼–è¯‘å™¨åœ¨ç”ŸæˆæŒ‡ä»¤åºåˆ—æ—¶ï¼Œæ’å…¥ç‰¹å®šç±»å‹çš„å†…å­˜å±éšœï¼ˆmemory barriersï¼Œintel ç§°ä¹‹ä¸º memory fenceï¼‰æŒ‡ä»¤ï¼Œé€šè¿‡å†…å­˜å±éšœæŒ‡ä»¤æ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºï¼ˆä¸æ˜¯æ‰€æœ‰çš„å¤„ç†å™¨é‡æ’åºéƒ½è¦ç¦æ­¢ï¼‰ã€‚

JMM å±äºè¯­è¨€çº§çš„å†…å­˜æ¨¡å‹ï¼Œå®ƒç¡®ä¿åœ¨ä¸åŒçš„ç¼–è¯‘å™¨å’Œä¸åŒçš„å¤„ç†å™¨å¹³å°ä¹‹ä¸Šï¼Œé€šè¿‡ç¦æ­¢ç‰¹å®šç±»å‹çš„ç¼–è¯‘å™¨é‡æ’åºå’Œå¤„ç†å™¨é‡æ’åºï¼Œä¸ºç¨‹åºå‘˜æä¾›ä¸€è‡´çš„å†…å­˜å¯è§æ€§ä¿è¯ã€‚

## å¤„ç†å™¨é‡æ’åºä¸å†…å­˜å±éšœæŒ‡ä»¤

ç°ä»£çš„å¤„ç†å™¨ä½¿ç”¨å†™ç¼“å†²åŒºæ¥ä¸´æ—¶ä¿å­˜å‘å†…å­˜å†™å…¥çš„æ•°æ®ã€‚å†™ç¼“å†²åŒºå¯ä»¥ä¿è¯æŒ‡ä»¤æµæ°´çº¿æŒç»­è¿è¡Œï¼Œå®ƒå¯ä»¥é¿å…ç”±äºå¤„ç†å™¨åœé¡¿ä¸‹æ¥ç­‰å¾…å‘å†…å­˜å†™å…¥æ•°æ®è€Œäº§ç”Ÿçš„å»¶è¿Ÿã€‚åŒæ—¶ï¼Œé€šè¿‡ä»¥æ‰¹å¤„ç†çš„æ–¹å¼åˆ·æ–°å†™ç¼“å†²åŒºï¼Œä»¥åŠåˆå¹¶å†™ç¼“å†²åŒºä¸­å¯¹åŒä¸€å†…å­˜åœ°å€çš„å¤šæ¬¡å†™ï¼Œå¯ä»¥å‡å°‘å¯¹å†…å­˜æ€»çº¿çš„å ç”¨ã€‚è™½ç„¶å†™ç¼“å†²åŒºæœ‰è¿™ä¹ˆå¤šå¥½å¤„ï¼Œä½†æ¯ä¸ªå¤„ç†å™¨ä¸Šçš„å†™ç¼“å†²åŒºï¼Œä»…ä»…å¯¹å®ƒæ‰€åœ¨çš„å¤„ç†å™¨å¯è§ã€‚è¿™ä¸ªç‰¹æ€§ä¼šå¯¹å†…å­˜æ“ä½œçš„æ‰§è¡Œé¡ºåºäº§ç”Ÿé‡è¦çš„å½±å“ï¼šå¤„ç†å™¨å¯¹å†…å­˜çš„è¯» /
å†™æ“ä½œçš„æ‰§è¡Œé¡ºåºï¼Œä¸ä¸€å®šä¸å†…å­˜å®é™…å‘ç”Ÿçš„è¯» / å†™æ“ä½œé¡ºåºä¸€è‡´ï¼ä¸ºäº†å…·ä½“è¯´æ˜ï¼Œè¯·çœ‹ä¸‹é¢ç¤ºä¾‹ï¼š

Processor A

Processor B

```
a = 1; //A1
x = b; //A2

b = 2; //B1
y = a; //B2
```

åˆå§‹çŠ¶æ€ï¼š`a = b = 0`
å¤„ç†å™¨å…è®¸æ‰§è¡Œåå¾—åˆ°ç»“æœï¼š`x = y = 0`

å‡è®¾å¤„ç†å™¨ A å’Œå¤„ç†å™¨ B æŒ‰ç¨‹åºçš„é¡ºåºå¹¶è¡Œæ‰§è¡Œå†…å­˜è®¿é—®ï¼Œæœ€ç»ˆå´å¯èƒ½å¾—åˆ° x = y = 0 çš„ç»“æœã€‚å…·ä½“çš„åŸå› å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![20241229154732_VqOWkkYt.webp](https://cdn.dong4j.site/source/image/20241229154732_VqOWkkYt.webp)

è¿™é‡Œå¤„ç†å™¨ A å’Œå¤„ç†å™¨ B å¯ä»¥åŒæ—¶æŠŠå…±äº«å˜é‡å†™å…¥è‡ªå·±çš„å†™ç¼“å†²åŒºï¼ˆA1ï¼ŒB1ï¼‰ï¼Œç„¶åä»å†…å­˜ä¸­è¯»å–å¦ä¸€ä¸ªå…±äº«å˜é‡ï¼ˆA2ï¼ŒB2ï¼‰ï¼Œæœ€åæ‰æŠŠè‡ªå·±å†™ç¼“å­˜åŒºä¸­ä¿å­˜çš„è„æ•°æ®åˆ·æ–°åˆ°å†…å­˜ä¸­ï¼ˆA3ï¼ŒB3ï¼‰ã€‚å½“ä»¥è¿™ç§æ—¶åºæ‰§è¡Œæ—¶ï¼Œç¨‹åºå°±å¯ä»¥å¾—åˆ°
x = y = 0 çš„ç»“æœã€‚

ä»å†…å­˜æ“ä½œå®é™…å‘ç”Ÿçš„é¡ºåºæ¥çœ‹ï¼Œç›´åˆ°å¤„ç†å™¨ A æ‰§è¡Œ A3 æ¥åˆ·æ–°è‡ªå·±çš„å†™ç¼“å­˜åŒºï¼Œå†™æ“ä½œ A1 æ‰ç®—çœŸæ­£æ‰§è¡Œäº†ã€‚è™½ç„¶å¤„ç†å™¨ A æ‰§è¡Œå†…å­˜æ“ä½œçš„é¡ºåºä¸ºï¼š`A1->A2`
ï¼Œä½†å†…å­˜æ“ä½œå®é™…å‘ç”Ÿçš„é¡ºåºå´æ˜¯ï¼š`A2->A1`ã€‚æ­¤æ—¶ï¼Œå¤„ç†å™¨ A çš„å†…å­˜æ“ä½œé¡ºåºè¢«é‡æ’åºäº†ï¼ˆå¤„ç†å™¨ B çš„æƒ…å†µå’Œå¤„ç†å™¨ A ä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ï¼‰ã€‚

è¿™é‡Œçš„å…³é”®æ˜¯ï¼Œç”±äºå†™ç¼“å†²åŒºä»…å¯¹è‡ªå·±çš„å¤„ç†å™¨å¯è§ï¼Œå®ƒä¼šå¯¼è‡´å¤„ç†å™¨æ‰§è¡Œå†…å­˜æ“ä½œçš„é¡ºåºå¯èƒ½ä¼šä¸å†…å­˜å®é™…çš„æ“ä½œæ‰§è¡Œé¡ºåºä¸ä¸€è‡´ã€‚ç”±äºç°ä»£çš„å¤„ç†å™¨éƒ½ä¼šä½¿ç”¨å†™ç¼“å†²åŒºï¼Œå› æ­¤ç°ä»£çš„å¤„ç†å™¨éƒ½ä¼šå…è®¸å¯¹å†™ -
è¯»æ“ä½œé‡æ’åºã€‚

ä¸‹é¢æ˜¯å¸¸è§å¤„ç†å™¨å…è®¸çš„é‡æ’åºç±»å‹çš„åˆ—è¡¨ï¼š

|           | Load-Load | Load-Store | Store-Store | Store-Load | æ•°æ®ä¾èµ– |
| --------- | --------- | ---------- | ----------- | ---------- | -------- |
| sparc-TSO | N         | N          | N           | Y          | N        |
| x86       | N         | N          | N           | Y          | N        |
| ia64      | Y         | Y          | Y           | Y          | N        |
| PowerPC   | Y         | Y          | Y           | Y          | N        |

ä¸Šè¡¨å•å…ƒæ ¼ä¸­çš„â€œNâ€è¡¨ç¤ºå¤„ç†å™¨ä¸å…è®¸ä¸¤ä¸ªæ“ä½œé‡æ’åºï¼Œâ€œYâ€è¡¨ç¤ºå…è®¸é‡æ’åºã€‚

ä»ä¸Šè¡¨æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼šå¸¸è§çš„å¤„ç†å™¨éƒ½å…è®¸ Store-Load é‡æ’åºï¼›å¸¸è§çš„å¤„ç†å™¨éƒ½ä¸å…è®¸å¯¹å­˜åœ¨æ•°æ®ä¾èµ–çš„æ“ä½œåšé‡æ’åºã€‚sparc-TSO å’Œ x86
æ‹¥æœ‰ç›¸å¯¹è¾ƒå¼ºçš„å¤„ç†å™¨å†…å­˜æ¨¡å‹ï¼Œå®ƒä»¬ä»…å…è®¸å¯¹å†™ - è¯»æ“ä½œåšé‡æ’åºï¼ˆå› ä¸ºå®ƒä»¬éƒ½ä½¿ç”¨äº†å†™ç¼“å†²åŒºï¼‰ã€‚

â€»æ³¨ 1ï¼šsparc-TSO æ˜¯æŒ‡ä»¥ TSO(Total Store Order) å†…å­˜æ¨¡å‹è¿è¡Œæ—¶ï¼Œsparc å¤„ç†å™¨çš„ç‰¹æ€§ã€‚  
â€»æ³¨ 2ï¼šä¸Šè¡¨ä¸­çš„ x86 åŒ…æ‹¬ x64 åŠ AMD64ã€‚  
â€»æ³¨ 3ï¼šç”±äº ARM å¤„ç†å™¨çš„å†…å­˜æ¨¡å‹ä¸ PowerPC å¤„ç†å™¨çš„å†…å­˜æ¨¡å‹éå¸¸ç±»ä¼¼ï¼Œæœ¬æ–‡å°†å¿½ç•¥å®ƒã€‚  
â€»æ³¨ 4ï¼šæ•°æ®ä¾èµ–æ€§åæ–‡ä¼šä¸“é—¨è¯´æ˜ã€‚

ä¸ºäº†ä¿è¯å†…å­˜å¯è§æ€§ï¼Œjava ç¼–è¯‘å™¨åœ¨ç”ŸæˆæŒ‡ä»¤åºåˆ—çš„é€‚å½“ä½ç½®ä¼šæ’å…¥å†…å­˜å±éšœæŒ‡ä»¤æ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚JMM æŠŠå†…å­˜å±éšœæŒ‡ä»¤åˆ†ä¸ºä¸‹åˆ—å››ç±»ï¼š

| å±éšœç±»å‹ | æŒ‡ä»¤ç¤ºä¾‹ | è¯´æ˜ |
| -------- | -------- | ---- |
|          |          |      |

| LoadLoad Barriers | Load1; LoadLoad; Load2 | ç¡®ä¿ Load1 æ•°æ®çš„è£…è½½ï¼Œä¹‹å‰äº Load2 åŠæ‰€æœ‰åç»­è£…è½½æŒ‡ä»¤çš„è£…è½½ã€‚|  
| StoreStore Barriers | Store1; StoreStore; Store2 | ç¡®ä¿ Store1 æ•°æ®å¯¹å…¶ä»–å¤„ç†å™¨å¯è§ï¼ˆåˆ·æ–°åˆ°å†…å­˜ï¼‰ï¼Œä¹‹å‰äº Store2 åŠæ‰€æœ‰åç»­å­˜å‚¨æŒ‡ä»¤çš„å­˜å‚¨ã€‚|  
| LoadStore Barriers | Load1; LoadStore; Store2 | ç¡®ä¿ Load1 æ•°æ®è£…è½½ï¼Œä¹‹å‰äº Store2 åŠæ‰€æœ‰åç»­çš„å­˜å‚¨æŒ‡ä»¤åˆ·æ–°åˆ°å†…å­˜ã€‚|  
| StoreLoad Barriers | Store1; StoreLoad; Load2 | ç¡®ä¿ Store1 æ•°æ®å¯¹å…¶ä»–å¤„ç†å™¨å˜å¾—å¯è§ï¼ˆæŒ‡åˆ·æ–°åˆ°å†…å­˜ï¼‰ï¼Œä¹‹å‰äº Load2 åŠæ‰€æœ‰åç»­è£…è½½æŒ‡ä»¤çš„è£…è½½ã€‚StoreLoad
Barriers ä¼šä½¿è¯¥å±éšœä¹‹å‰çš„æ‰€æœ‰å†…å­˜è®¿é—®æŒ‡ä»¤ï¼ˆå­˜å‚¨å’Œè£…è½½æŒ‡ä»¤ï¼‰å®Œæˆä¹‹åï¼Œæ‰æ‰§è¡Œè¯¥å±éšœä¹‹åçš„å†…å­˜è®¿é—®æŒ‡ä»¤ã€‚|

StoreLoad Barriers æ˜¯ä¸€ä¸ªâ€œå…¨èƒ½å‹â€çš„å±éšœï¼Œå®ƒåŒæ—¶å…·æœ‰å…¶ä»–ä¸‰ä¸ªå±éšœçš„æ•ˆæœã€‚ç°ä»£çš„å¤šå¤„ç†å™¨å¤§éƒ½æ”¯æŒè¯¥å±éšœï¼ˆå…¶ä»–ç±»å‹çš„å±éšœä¸ä¸€å®šè¢«æ‰€æœ‰å¤„ç†å™¨æ”¯æŒï¼‰ã€‚æ‰§è¡Œè¯¥å±éšœå¼€é”€ä¼šå¾ˆæ˜‚è´µï¼Œå› ä¸ºå½“å‰å¤„ç†å™¨é€šå¸¸è¦æŠŠå†™ç¼“å†²åŒºä¸­çš„æ•°æ®å…¨éƒ¨åˆ·æ–°åˆ°å†…å­˜ä¸­ï¼ˆbuffer
fully flushï¼‰ã€‚

## happens-before

ä» JDK5 å¼€å§‹ï¼Œjava ä½¿ç”¨æ–°çš„ JSR -133 å†…å­˜æ¨¡å‹ï¼ˆæœ¬æ–‡é™¤éç‰¹åˆ«è¯´æ˜ï¼Œé’ˆå¯¹çš„éƒ½æ˜¯ JSR- 133 å†…å­˜æ¨¡å‹ï¼‰ã€‚JSR-133 ä½¿ç”¨ happens-before çš„æ¦‚å¿µæ¥é˜è¿°æ“ä½œä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚åœ¨
JMM ä¸­ï¼Œå¦‚æœä¸€ä¸ªæ“ä½œæ‰§è¡Œçš„ç»“æœéœ€è¦å¯¹å¦ä¸€ä¸ªæ“ä½œå¯è§ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´å¿…é¡»è¦å­˜åœ¨ happens-before å…³ç³»ã€‚è¿™é‡Œæåˆ°çš„ä¸¤ä¸ªæ“ä½œæ—¢å¯ä»¥æ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹ä¹‹å†…ï¼Œä¹Ÿå¯ä»¥æ˜¯åœ¨ä¸åŒçº¿ç¨‹ä¹‹é—´ã€‚

ä¸ç¨‹åºå‘˜å¯†åˆ‡ç›¸å…³çš„ happens-before è§„åˆ™å¦‚ä¸‹ï¼š

- ç¨‹åºé¡ºåºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ¯ä¸ªæ“ä½œï¼Œhappens- before äºè¯¥çº¿ç¨‹ä¸­çš„ä»»æ„åç»­æ“ä½œã€‚
- ç›‘è§†å™¨é”è§„åˆ™ï¼šå¯¹ä¸€ä¸ªç›‘è§†å™¨é”çš„è§£é”ï¼Œhappens- before äºéšåå¯¹è¿™ä¸ªç›‘è§†å™¨é”çš„åŠ é”ã€‚
- volatile å˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ª volatile åŸŸçš„å†™ï¼Œhappens- before äºä»»æ„åç»­å¯¹è¿™ä¸ª volatile åŸŸçš„è¯»ã€‚
- ä¼ é€’æ€§ï¼šå¦‚æœ A happens- before Bï¼Œä¸” B happens- before Cï¼Œé‚£ä¹ˆ A happens- before Cã€‚

æ³¨æ„ï¼Œä¸¤ä¸ªæ“ä½œä¹‹é—´å…·æœ‰ happens-before å…³ç³»ï¼Œå¹¶ä¸æ„å‘³ç€å‰ä¸€ä¸ªæ“ä½œå¿…é¡»è¦åœ¨åä¸€ä¸ªæ“ä½œä¹‹å‰æ‰§è¡Œï¼happens-before
ä»…ä»…è¦æ±‚å‰ä¸€ä¸ªæ“ä½œï¼ˆæ‰§è¡Œçš„ç»“æœï¼‰å¯¹åä¸€ä¸ªæ“ä½œå¯è§ï¼Œä¸”å‰ä¸€ä¸ªæ“ä½œæŒ‰é¡ºåºæ’åœ¨ç¬¬äºŒä¸ªæ“ä½œä¹‹å‰ï¼ˆthe first is visible to and ordered before the
secondï¼‰ã€‚happens- before çš„å®šä¹‰å¾ˆå¾®å¦™ï¼Œåæ–‡ä¼šå…·ä½“è¯´æ˜ happens-before ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå®šä¹‰ã€‚

happens-before ä¸ JMM çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![20241229154732_HrSV4B0G.webp](https://cdn.dong4j.site/source/image/20241229154732_HrSV4B0G.webp)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸€ä¸ª happens-before è§„åˆ™é€šå¸¸å¯¹åº”äºå¤šä¸ªç¼–è¯‘å™¨å’Œå¤„ç†å™¨é‡æ’åºè§„åˆ™ã€‚å¯¹äº java ç¨‹åºå‘˜æ¥è¯´ï¼Œhappens-before è§„åˆ™ç®€å•æ˜“æ‡‚ï¼Œå®ƒé¿å… java
ç¨‹åºå‘˜ä¸ºäº†ç†è§£ JMM æä¾›çš„å†…å­˜å¯è§æ€§ä¿è¯è€Œå»å­¦ä¹ å¤æ‚çš„é‡æ’åºè§„åˆ™ä»¥åŠè¿™äº›è§„åˆ™çš„å…·ä½“å®ç°ã€‚

## [åŒæ­¥ä¸å¼‚æ­¥çš„è¾ƒé‡ï¼šå¦‚ä½•åœ¨Spring Bootä¸­ä¼˜åŒ–æ‰§è¡Œæ•ˆç‡](https://blog.dong4j.site/posts/603b8025.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

â€œå¼‚æ­¥è°ƒç”¨â€å¯¹åº”çš„æ˜¯â€œåŒæ­¥è°ƒç”¨â€ï¼Œ*åŒæ­¥è°ƒç”¨*æŒ‡ç¨‹åºæŒ‰ç…§å®šä¹‰é¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œæ¯ä¸€è¡Œç¨‹åºéƒ½å¿…é¡»ç­‰å¾…ä¸Šä¸€è¡Œç¨‹åºæ‰§è¡Œå®Œæˆä¹‹åæ‰èƒ½æ‰§è¡Œï¼›*å¼‚æ­¥è°ƒç”¨*æŒ‡ç¨‹åºåœ¨é¡ºåºæ‰§è¡Œæ—¶ï¼Œä¸ç­‰å¾…å¼‚æ­¥è°ƒç”¨çš„è¯­å¥è¿”å›ç»“æœå°±æ‰§è¡Œåé¢çš„ç¨‹åºã€‚

## åŒæ­¥è°ƒç”¨

ä¸‹é¢é€šè¿‡ä¸€ä¸ªç®€å•ç¤ºä¾‹æ¥ç›´è§‚çš„ç†è§£ä»€ä¹ˆæ˜¯åŒæ­¥è°ƒç”¨ï¼š

- å®šä¹‰ Task ç±»ï¼Œåˆ›å»ºä¸‰ä¸ªå¤„ç†å‡½æ•°åˆ†åˆ«æ¨¡æ‹Ÿä¸‰ä¸ªæ‰§è¡Œä»»åŠ¡çš„æ“ä½œï¼Œæ“ä½œæ¶ˆè€—æ—¶é—´éšæœºå–ï¼ˆ10 ç§’å†…ï¼‰

```java
@Component
public class Task {
 public static Random random =new Random();
    public void doTaskOne() throws Exception {
        System.out.println("å¼€å§‹åšä»»åŠ¡ä¸€");
        long start = System.currentTimeMillis();
        Thread.sleep(random.nextInt(10000));
        long end = System.currentTimeMillis();
        System.out.println("å®Œæˆä»»åŠ¡ä¸€ï¼Œè€—æ—¶ï¼š" + (end - start) + "æ¯«ç§’");
    }

    public void doTaskTwo() throws Exception {
        System.out.println("å¼€å§‹åšä»»åŠ¡äºŒ");
        long start = System.currentTimeMillis();
        Thread.sleep(random.nextInt(10000));
        long end = System.currentTimeMillis();
        System.out.println("å®Œæˆä»»åŠ¡äºŒï¼Œè€—æ—¶ï¼š" + (end - start) + "æ¯«ç§’");
    }

    public void doTaskThree() throws Exception {
        System.out.println("å¼€å§‹åšä»»åŠ¡ä¸‰");
        long start = System.currentTimeMillis();
        Thread.sleep(random.nextInt(10000));
        long end = System.currentTimeMillis();
        System.out.println("å®Œæˆä»»åŠ¡ä¸‰ï¼Œè€—æ—¶ï¼š" + (end - start) + "æ¯«ç§’");
    }
}
```

- åœ¨å•å…ƒæµ‹è¯•ç”¨ä¾‹ä¸­ï¼Œæ³¨å…¥ Task å¯¹è±¡ï¼Œå¹¶åœ¨æµ‹è¯•ç”¨ä¾‹ä¸­æ‰§è¡Œ `doTaskOne`ã€`doTaskTwo`ã€`doTaskThree` ä¸‰ä¸ªå‡½æ•°ã€‚

```java
@RunWith(SpringJUnit4ClassRunner.class)
@SpringApplicationConfiguration(classes = Application.class)
public class ApplicationTests {

    @Autowired
    private Task task;

    @Test
    public void test() throws Exception {
        task.doTaskOne();
        task.doTaskTwo();
        task.doTaskThree();
    }
}
```

- æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹è¾“å‡ºï¼š

```
å¼€å§‹åšä»»åŠ¡ä¸€
å®Œæˆä»»åŠ¡ä¸€ï¼Œè€—æ—¶ï¼š4256æ¯«ç§’
å¼€å§‹åšä»»åŠ¡äºŒ
å®Œæˆä»»åŠ¡äºŒï¼Œè€—æ—¶ï¼š4957æ¯«ç§’
å¼€å§‹åšä»»åŠ¡ä¸‰
å®Œæˆä»»åŠ¡ä¸‰ï¼Œè€—æ—¶ï¼š7173æ¯«ç§’

```

ä»»åŠ¡ä¸€ã€ä»»åŠ¡äºŒã€ä»»åŠ¡ä¸‰é¡ºåºçš„æ‰§è¡Œå®Œäº†ï¼Œæ¢è¨€ä¹‹ `doTaskOne`ã€`doTaskTwo`ã€`doTaskThree` ä¸‰ä¸ªå‡½æ•°é¡ºåºçš„æ‰§è¡Œå®Œæˆã€‚

## å¼‚æ­¥è°ƒç”¨

ä¸Šè¿°çš„åŒæ­¥è°ƒç”¨è™½ç„¶é¡ºåˆ©çš„æ‰§è¡Œå®Œäº†ä¸‰ä¸ªä»»åŠ¡ï¼Œä½†æ˜¯å¯ä»¥çœ‹åˆ°æ‰§è¡Œæ—¶é—´æ¯”è¾ƒé•¿ï¼Œè‹¥è¿™ä¸‰ä¸ªä»»åŠ¡æœ¬èº«ä¹‹é—´ä¸å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œå¯ä»¥å¹¶å‘æ‰§è¡Œçš„è¯ï¼ŒåŒæ­¥è°ƒç”¨åœ¨æ‰§è¡Œæ•ˆç‡æ–¹é¢å°±æ¯”è¾ƒå·®ï¼Œå¯ä»¥è€ƒè™‘é€šè¿‡å¼‚æ­¥è°ƒç”¨çš„æ–¹å¼æ¥å¹¶å‘æ‰§è¡Œã€‚

åœ¨ Spring Boot ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦é€šè¿‡ä½¿ç”¨ `@Async` æ³¨è§£å°±èƒ½ç®€å•çš„å°†åŸæ¥çš„åŒæ­¥å‡½æ•°å˜ä¸ºå¼‚æ­¥å‡½æ•°ï¼ŒTask ç±»æ”¹åœ¨ä¸ºå¦‚ä¸‹æ¨¡å¼ï¼š

```java
@Component
public class Task {

    @Async
    public void doTaskOne() throws Exception {
        // åŒä¸Šå†…å®¹ï¼Œçœç•¥
    }

    @Async
    public void doTaskTwo() throws Exception {
        // åŒä¸Šå†…å®¹ï¼Œçœç•¥
    }

    @Async
    public void doTaskThree() throws Exception {
        // åŒä¸Šå†…å®¹ï¼Œçœç•¥
    }
}
```

ä¸ºäº†è®©@Async æ³¨è§£èƒ½å¤Ÿç”Ÿæ•ˆï¼Œè¿˜éœ€è¦åœ¨ Spring Boot çš„ä¸»ç¨‹åºä¸­é…ç½®@EnableAsyncï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
@SpringBootApplication
@EnableAsync
public class Application {

 public static void main(String[] args) {
    SpringApplication.run(Application.class, args);
 }
}
```

æ­¤æ—¶å¯ä»¥åå¤æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼Œæ‚¨å¯èƒ½ä¼šé‡åˆ°å„ç§ä¸åŒçš„ç»“æœï¼Œæ¯”å¦‚ï¼š

- æ²¡æœ‰ä»»ä½•ä»»åŠ¡ç›¸å…³çš„è¾“å‡º
- æœ‰éƒ¨åˆ†ä»»åŠ¡ç›¸å…³çš„è¾“å‡º
- ä¹±åºçš„ä»»åŠ¡ç›¸å…³çš„è¾“å‡º

åŸå› æ˜¯ç›®å‰ `doTaskOne`ã€`doTaskTwo`ã€`doTaskThree` ä¸‰ä¸ªå‡½æ•°çš„æ—¶å€™å·²ç»æ˜¯å¼‚æ­¥æ‰§è¡Œäº†ã€‚ä¸»ç¨‹åºåœ¨å¼‚æ­¥è°ƒç”¨ä¹‹åï¼Œä¸»ç¨‹åºå¹¶ä¸ä¼šç†ä¼šè¿™ä¸‰ä¸ªå‡½æ•°æ˜¯å¦æ‰§è¡Œå®Œæˆäº†ï¼Œç”±äºæ²¡æœ‰å…¶ä»–éœ€è¦æ‰§è¡Œçš„å†…å®¹ï¼Œæ‰€ä»¥ç¨‹åºå°±è‡ªåŠ¨ç»“æŸäº†ï¼Œå¯¼è‡´äº†ä¸å®Œæ•´æˆ–æ˜¯æ²¡æœ‰è¾“å‡ºä»»åŠ¡ç›¸å…³å†…å®¹çš„æƒ…å†µã€‚

**æ³¨ï¼š @Async æ‰€ä¿®é¥°çš„å‡½æ•°ä¸è¦å®šä¹‰ä¸º static ç±»å‹ï¼Œè¿™æ ·å¼‚æ­¥è°ƒç”¨ä¸ä¼šç”Ÿæ•ˆ**

## å¼‚æ­¥å›è°ƒ

ä¸ºäº†è®© `doTaskOne`ã€`doTaskTwo`ã€`doTaskThree` èƒ½æ­£å¸¸ç»“æŸï¼Œå‡è®¾æˆ‘ä»¬éœ€è¦ç»Ÿè®¡ä¸€ä¸‹ä¸‰ä¸ªä»»åŠ¡å¹¶å‘æ‰§è¡Œå…±è€—æ—¶å¤šå°‘ï¼Œè¿™å°±éœ€è¦ç­‰åˆ°ä¸Šè¿°ä¸‰ä¸ªå‡½æ•°éƒ½å®Œæˆè°ƒåŠ¨ä¹‹åè®°å½•æ—¶é—´ï¼Œå¹¶è®¡ç®—ç»“æœã€‚

é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•åˆ¤æ–­ä¸Šè¿°ä¸‰ä¸ªå¼‚æ­¥è°ƒç”¨æ˜¯å¦å·²ç»æ‰§è¡Œå®Œæˆå‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦ä½¿ç”¨ `Future<T>` æ¥è¿”å›å¼‚æ­¥è°ƒç”¨çš„ç»“æœï¼Œå°±åƒå¦‚ä¸‹æ–¹å¼æ”¹é€  `doTaskOne` å‡½æ•°ï¼š

```java
@Async
public Future doTaskOne() throws Exception {
    System.out.println("å¼€å§‹åšä»»åŠ¡ä¸€");
    long start = System.currentTimeMillis();
    Thread.sleep(random.nextInt(10000));
    long end = System.currentTimeMillis();
    System.out.println("å®Œæˆä»»åŠ¡ä¸€ï¼Œè€—æ—¶ï¼š" + (end - start) + "æ¯«ç§’");
    return new AsyncResult<>("ä»»åŠ¡ä¸€å®Œæˆ");
}
```

æŒ‰ç…§å¦‚ä¸Šæ–¹å¼æ”¹é€ ä¸€ä¸‹å…¶ä»–ä¸¤ä¸ªå¼‚æ­¥å‡½æ•°ä¹‹åï¼Œä¸‹é¢æˆ‘ä»¬æ”¹é€ ä¸€ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼Œè®©æµ‹è¯•åœ¨ç­‰å¾…å®Œæˆä¸‰ä¸ªå¼‚æ­¥è°ƒç”¨ä¹‹åæ¥åšä¸€äº›å…¶ä»–äº‹æƒ…ã€‚

```java
@Test
public void test() throws Exception {

    long start = System.currentTimeMillis();

    Future task1 = task.doTaskOne();
    Future task2 = task.doTaskTwo();
    Future task3 = task.doTaskThree();

    while(true) {
        if(task1.isDone() && task2.isDone() && task3.isDone()) {
        // ä¸‰ä¸ªä»»åŠ¡éƒ½è°ƒç”¨å®Œæˆï¼Œé€€å‡ºå¾ªç¯ç­‰å¾…
            break;
        }
        Thread.sleep(1000);
    }

    long end = System.currentTimeMillis();
    System.out.println("ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼Œæ€»è€—æ—¶ï¼š" + (end - start) + "æ¯«ç§’");
}
```

çœ‹çœ‹æˆ‘ä»¬åšäº†å“ªäº›æ”¹å˜ï¼š

- åœ¨æµ‹è¯•ç”¨ä¾‹ä¸€å¼€å§‹è®°å½•å¼€å§‹æ—¶é—´
- åœ¨è°ƒç”¨ä¸‰ä¸ªå¼‚æ­¥å‡½æ•°çš„æ—¶å€™ï¼Œè¿”å› `Future<String>` ç±»å‹çš„ç»“æœå¯¹è±¡
- åœ¨è°ƒç”¨å®Œä¸‰ä¸ªå¼‚æ­¥å‡½æ•°ä¹‹åï¼Œå¼€å¯ä¸€ä¸ªå¾ªç¯ï¼Œæ ¹æ®è¿”å›çš„ `Future<String>` å¯¹è±¡æ¥åˆ¤æ–­ä¸‰ä¸ªå¼‚æ­¥å‡½æ•°æ˜¯å¦éƒ½ç»“æŸäº†ã€‚è‹¥éƒ½ç»“æŸï¼Œå°±ç»“æŸå¾ªç¯ï¼›è‹¥æ²¡æœ‰éƒ½ç»“æŸï¼Œå°±ç­‰ 1 ç§’åå†åˆ¤æ–­ã€‚
- è·³å‡ºå¾ªç¯ä¹‹åï¼Œæ ¹æ®ç»“æŸæ—¶é—´ - å¼€å§‹æ—¶é—´ï¼Œè®¡ç®—å‡ºä¸‰ä¸ªä»»åŠ¡å¹¶å‘æ‰§è¡Œçš„æ€»è€—æ—¶ã€‚

æ‰§è¡Œä¸€ä¸‹ä¸Šè¿°çš„å•å…ƒæµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç»“æœï¼š

```
å¼€å§‹åšä»»åŠ¡ä¸€
å¼€å§‹åšä»»åŠ¡äºŒ
å¼€å§‹åšä»»åŠ¡ä¸‰
å®Œæˆä»»åŠ¡ä¸‰ï¼Œè€—æ—¶ï¼š37æ¯«ç§’
å®Œæˆä»»åŠ¡äºŒï¼Œè€—æ—¶ï¼š3661æ¯«ç§’
å®Œæˆä»»åŠ¡ä¸€ï¼Œè€—æ—¶ï¼š7149æ¯«ç§’
ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼Œæ€»è€—æ—¶ï¼š8025æ¯«ç§’
```

å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡å¼‚æ­¥è°ƒç”¨ï¼Œè®©ä»»åŠ¡ä¸€ã€äºŒã€ä¸‰å¹¶å‘æ‰§è¡Œï¼Œæœ‰æ•ˆçš„å‡å°‘äº†ç¨‹åºçš„æ€»è¿è¡Œæ—¶é—´ã€‚

## [SpringBoot é€€å‡ºæœåŠ¡æ—¶è°ƒç”¨è‡ªå®šä¹‰é”€æ¯æ–¹æ³•çš„ä¸¤ç§æ–¹å¼](https://blog.dong4j.site/posts/442823ed.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

æˆ‘ä»¬åœ¨å·¥ä½œä¸­æœ‰æ—¶å€™å¯èƒ½ä¼šé‡åˆ°è¿™æ ·åœºæ™¯ï¼Œéœ€è¦åœ¨é€€å‡ºå®¹å™¨çš„æ—¶å€™æ‰§è¡ŒæŸäº›æ“ä½œã€‚SpringBoot ä¸­æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥ä¾›æˆ‘ä»¬æ¥é€‰æ‹©ï¼ˆå…¶å®å°±æ˜¯ spring ä¸­æˆ‘ä»¬å¸¸ç”¨çš„æ–¹å¼ã€‚åªæ˜¯ destory-method æ˜¯åœ¨ XML ä¸­é…ç½®çš„ï¼ŒSpringBoot æ˜¯å»é…ç½®åŒ–ã€‚æ‰€ä»¥è¿™é‡Œå°±ä¸æè¿™ç§æ–¹å¼äº†ï¼‰ï¼Œä¸€ç§æ˜¯å®ç° DisposableBean æ¥å£ï¼Œä¸€ç§æ˜¯ä½¿ç”¨@PreDestroy æ³¨è§£ã€‚OKï¼Œä¸‹é¢æˆ‘å†™ä¸¤ä¸ªä¾‹å­çœ‹ä¸€ä¸‹ï¼š

## DisposableBean æ¥å£

æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç°è¿™ä¸ªæ¥å£æ¥åœ¨å®¹å™¨é€€å‡ºçš„æ—¶å€™æ‰§è¡ŒæŸäº›æ“ä½œã€‚ä¾‹å­å¦‚ä¸‹ï¼š

```java

@Component
public class TestImplDisposableBean implements DisposableBean, ExitCodeGenerator {

    @Override
    public void destroy() throws Exception {

        System.out.println("<<<<<<<<<<<æˆ‘è¢«é”€æ¯äº†......................>>>>>>>>>>>>>>>");
        System.out.println("<<<<<<<<<<<æˆ‘è¢«é”€æ¯äº†......................>>>>>>>>>>>>>>>");
    }

    @Override
    public int getExitCode() {

        return 5;
    }
}

```

## @PreDestroy æ³¨è§£

æˆ‘ä»¬å¯ä»¥åœ¨éœ€è¦çš„ç±»çš„æ–¹æ³•ä¸Šæ·»åŠ è¿™ä¸ªæ³¨è§£ï¼ŒåŒæ ·å¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚

```java
@Component
public class TestAnnotationPreDestroy {

    @PreDestroy
    public void destory() {

        System.out.println("æˆ‘è¢«é”€æ¯äº†ã€ã€ã€ã€ã€æˆ‘æ˜¯ç”¨çš„@PreDestoryçš„æ–¹å¼ã€ã€ã€ã€ã€ã€");
        System.out.println("æˆ‘è¢«é”€æ¯äº†ã€ã€ã€ã€ã€æˆ‘æ˜¯ç”¨çš„@PreDestoryçš„æ–¹å¼ã€ã€ã€ã€ã€ã€");
    }
}

```

## TIPSï¼š

é€€å‡ºä½ å¯ä»¥é€šè¿‡ Ide ä¸­çš„åŠŸèƒ½æ¥é€€å‡ºã€‚è¿™é‡Œæˆ‘å¯åŠ¨çš„æ—¶å€™æ˜¯åœ¨ CMD ä¸­ç”¨ jar å¯åŠ¨çš„ï¼Œå¯åŠ¨å‘½ä»¤å¦‚ä¸‹ï¼šjava -jar LearnSpringBoot-0.0.1-SNAPSHOT.jarï¼Œæ‰€ä»¥æˆ‘åœ¨è¿™é‡Œé€€å‡ºçš„æ—¶å€™æ˜¯ç”¨çš„ Ctrl+C æ¥æ‰§è¡Œçš„é€€å‡ºæ“ä½œã€‚å¦‚æœä½ ç”¨çš„ mvn spring-boot:run æ¥å¯åŠ¨è¿è¡Œçš„è¯ï¼Œå¯èƒ½ä¸ä¼šæ‰§è¡Œé”€æ¯çš„æ“ä½œã€‚

## [åŸºäºTokençš„RESTful APIï¼ŒSpring Securityå…¥é—¨](https://blog.dong4j.site/posts/31d0a22c.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

åœ¨å¤§éƒ¨åˆ†æ—¶å€™ï¼Œæˆ‘ä»¬è®¨è®º API çš„è®¾è®¡æ—¶ï¼Œä¼šä»åŠŸèƒ½çš„è§’åº¦å‡ºå‘å®šä¹‰å‡ºå®Œå–„çš„ï¼Œæ˜“ç”¨çš„ APIã€‚è€Œå¾ˆå¤šæ—¶å€™ï¼ŒéåŠŸèƒ½éœ€æ±‚å¦‚å®‰å…¨éœ€æ±‚åˆ™ä¼šåœ¨å¾ˆæ™šæ‰åŠ å…¥è€ƒè™‘ã€‚è€Œå¾€å¾€è¿™éƒ¨åˆ†ä¼šæ¶‰åŠå¾ˆå¤šé¢å¤–çš„å·¥ä½œé‡ï¼Œæ¯”å¦‚ä¸å¤–éƒ¨çš„ SSO é›†æˆï¼ŒToken æœºåˆ¶ç­‰ç­‰ã€‚

è¿™ç¯‡æ–‡ç« ä¼šä»¥ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œä»åº”ç”¨ç¨‹åºå’Œéƒ¨ç½²æ¶æ„ä¸Šåˆ†åˆ«è®¨è®ºå‡ ç§å¸¸è§çš„æ¨¡å‹ã€‚è¿™ç¯‡æ–‡ç« æ˜¯è¿™ä¸ªç³»åˆ—çš„ç¬¬ä¸€ç¯‡ï¼Œä¼šè®¨è®ºä¸¤ä¸ªç®€å•çš„ä¸»é¢˜ï¼š

- åŸºäº Session çš„ç”¨æˆ·è®¤è¯
- åŸºäº Token çš„ RESTful APIï¼ˆä½¿ç”¨ Spring Securityï¼‰

### ä½¿ç”¨ Session

ç”±äº HTTP åè®®æœ¬èº«æ˜¯æ— çŠ¶æ€çš„ï¼ŒæœåŠ¡å™¨éœ€è¦æŸç§æœºåˆ¶æ¥åŒºåˆ†æ¯ä¸ªè¯·æ±‚ã€‚æ¯”å¦‚åœ¨è¿”å›ç»™å®¢æˆ·çš„å“åº”ä¸­åŠ å…¥ä¸€äº› IDï¼Œå®¢æˆ·ç«¯å†æ¬¡è¯·æ±‚æ—¶å¸¦ä¸Šè¿™ä¸ª IDï¼Œè¿™æ ·æœåŠ¡å™¨å°±å¯ä»¥åŒºåˆ†å‡ºæ¥æ¯ä¸ªè¯·æ±‚ï¼Œå¹¶å®Œæˆäº‹åŠ¡æ€§çš„æ“ä½œï¼ˆå®Œæˆè®¢å•çš„åˆ›å»ºï¼Œæ›´æ–°ï¼Œå•†å“æ´¾é€ç­‰ç­‰ï¼‰ã€‚

åœ¨å¤šæ•° Web å®¹å™¨ä¸­ï¼Œè¿™ç§æœºåˆ¶é€šè¿‡ Session æ¥å®ç°ã€‚Web å®¹å™¨ä¼šä¸ºæ¯ä¸ªé¦–æ¬¡è¯·æ±‚åˆ›å»ºä¸€ä¸ª Sessionï¼Œå¹¶å°† Session çš„ ID ä»¥æµè§ˆå™¨ Cookie çš„æ–¹å¼è¿”å›ç»™å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯ï¼ˆå¸¸å¸¸æ˜¯æµè§ˆå™¨ï¼‰åœ¨åç»­çš„è¯·æ±‚ä¸­å¸¦ä¸Šè¿™ä¸ª Session çš„ ID æ¥è¡¨æ˜è‡ªå·±çš„èº«ä»½ã€‚è¿™ç§æœºåˆ¶åŒæ ·è¢«ç”¨åœ¨äº†é‰´æƒæ–¹é¢ï¼Œç”¨æˆ·ç™»å½•ç³»ç»Ÿä¹‹åï¼Œç³»ç»Ÿåˆ†é…ä¸€ä¸ª Session ID ç»™ä»–ã€‚

é™¤é Session è¿‡æœŸï¼Œæˆ–è€…ç”¨æˆ·ä»å®¢æˆ·ç«¯çš„ Cookie ä¸­ä¸»åŠ¨åˆ äº† Session IDï¼Œå¦åˆ™åœ¨æœåŠ¡å™¨ç«¯æ¥çœ‹ï¼Œç”¨æˆ·çš„ä¿¡æ¯ä¼šå’Œè¿™ä¸ª Session ç»‘å®šèµ·æ¥ã€‚åå°ç³»ç»Ÿä¹Ÿå¯ä»¥éšæ—¶çŸ¥é“è¯·æ±‚æŸä¸ªèµ„æºçš„çœŸå®ç”¨æˆ·æ˜¯è°ï¼Œå¹¶ä»¥æ­¤æ¥åˆ¤æ–­è¯¥ç”¨æˆ·æ—¶å€™çœŸçš„æœ‰æƒé™è¿™ä¹ˆåšã€‚

```java
HttpSession session = request.getSession();
String user = (String)session.getAttribute("user");

if(user != null) {
    //
}
```

#### Session çš„é—®é¢˜

è¿™ç§åšæ³•åœ¨å°è§„æ¨¡åº”ç”¨ä¸­å·¥ä½œè‰¯å¥½ï¼Œéšç€ç”¨æˆ·çš„å¢å¤šï¼Œä¼ä¸šå¾€å¾€éœ€è¦éƒ¨ç½²å¤šå°æœåŠ¡å™¨å½¢æˆé›†ç¾¤æ¥å¯¹å¤–æä¾›æœåŠ¡ã€‚åœ¨é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œå½“æŸä¸ªèŠ‚ç‚¹æŒ‚æ‰ä¹‹åï¼Œç”±äº Session é»˜è®¤æ˜¯ä¿å­˜åœ¨éƒ¨ç½² Web å®¹å™¨ä¸­çš„ï¼Œç”¨æˆ·ä¼šè¢«è¯¯åˆ¤ä¸ºæœªç™»å½•ï¼Œåç»­çš„è¯·æ±‚ä¼šè¢«é‡å®šå‘åˆ°ç™»é™†é¡µé¢ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚

è¿™ç§å°†åº”ç”¨ç¨‹åºçŠ¶æ€å†…ç½®çš„æ–¹æ³•å·²ç»å®Œå…¨æ— æ³•æ»¡è¶³åº”ç”¨çš„æ‰©å±•ï¼Œå› æ­¤åœ¨å·¥ç¨‹å®è·µä¸­ï¼Œæˆ‘ä»¬ä¼šé‡‡ç”¨å°† Session å¤–ç½®çš„æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å³é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½å°† Session ä¿å­˜åœ¨ä¸€ä¸ªå…¬ç”¨çš„é”®å€¼æ•°æ®åº“ä¸­ï¼š

```java
@Configuration
@EnableRedisHttpSession
public class HttpSessionConfig {
}
```

ä¸Šé¢è¿™ä¸ªä¾‹å­æ˜¯åœ¨ Spring Boot ä¸­ä½¿ç”¨ Redis æ¥å¤–ç½® Sessionã€‚Spring ä¼šæ‹¦æˆªæ‰€æœ‰å¯¹ HTTPSession å¯¹è±¡çš„æ“ä½œï¼Œåç»­çš„å¯¹ Session çš„æ“ä½œï¼ŒSpring éƒ½ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºä¸åå°çš„ Redis æœåŠ¡å™¨çš„äº¤äº’ï¼Œä»è€Œé¿å…èŠ‚ç‚¹æŒ‚æ‰ä¹‹å Session ä¸¢å¤±çš„é—®é¢˜ã€‚

```java
spring.redis.host=192.168.99.100
spring.redis.password=
spring.redis.port=6379
```

å¦‚æœä½ è·Ÿæˆ‘ä¸€æ ·æ‡’çš„è¯ï¼Œç›´æ¥å¯åŠ¨ä¸€ä¸ª redis çš„ docker container å°±å¯ä»¥ï¼š

```java
$ docker run --name redis-server -d redis
```

è¿™æ ·ï¼Œå¤šä¸ªåº”ç”¨å…±äº«è¿™ä¸€ä¸ªå®ä¾‹ï¼Œä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹çš„ç»ˆæ­¢ã€å¼‚å¸¸éƒ½ä¸ä¼šäº§ç”Ÿ Session çš„é—®é¢˜ã€‚

### åŸºäº Token çš„å®‰å…¨æœºåˆ¶

ä¸Šé¢è¯´åˆ°çš„åœºæ™¯ä¸­ï¼Œä½¿ç”¨ Session éœ€è¦é¢å¤–éƒ¨ç½²ä¸€ä¸ªç»„ä»¶ï¼ˆæˆ–è€…å¼•å…¥æ›´åŠ å¤æ‚çš„ Session åŒæ­¥æœºåˆ¶ï¼‰ï¼Œè¿™ä¼šå¸¦æ¥å¦å¤–çš„é—®é¢˜ï¼Œæ¯”å¦‚å¦‚ä½•ä¿è¯è¿™ä¸ªèŠ‚ç‚¹çš„é«˜å¯ç”¨ï¼Œé™¤äº† Production ç¯å¢ƒä¹‹å¤–ï¼ŒStaging å’Œ QA ç¯å¢ƒä¹Ÿéœ€è¦è¿™ä¸ªç»„ä»¶çš„é…ç½®ã€æµ‹è¯•å’Œç»´æŠ¤ã€‚

å¾ˆå¤šé¡¹ç›®ç°åœ¨ä¼šé‡‡ç”¨å¦å¤–ä¸€ç§æ›´åŠ ç®€å•çš„æ–¹å¼ï¼šåŸºäº Token çš„å®‰å…¨æœºåˆ¶ã€‚å³ä¸ä½¿ç”¨ Sessionï¼Œç”¨æˆ·åœ¨ç™»é™†ä¹‹åï¼Œä¼šè·å¾—ä¸€ä¸ª Tokenï¼Œè¿™ä¸ª Token ä¼šä»¥ HTTP Header çš„æ–¹å¼å‘é€ç»™å®¢æˆ·ï¼ŒåŒæ ·ï¼Œå®¢æˆ·å†åç»­çš„èµ„æºè¯·æ±‚ä¸­ä¹Ÿéœ€è¦å¸¦ç€è¿™ä¸ª Tokenã€‚é€šå¸¸è¿™ä¸ª Token è¿˜ä¼šæœ‰è¿‡æœŸæ—¶é—´çš„é™åˆ¶ï¼ˆæ¯”å¦‚åªèƒ½ä½¿ç”¨ 1 å‘¨ï¼Œä¸€å‘¨ä¹‹åéœ€è¦é‡æ–°è·å–ï¼‰ã€‚

åŸºäº Token çš„æœºåˆ¶æ›´åŠ ç®€å•ï¼Œå’Œ RESTful é£æ ¼çš„ API ä¸€èµ·ä½¿ç”¨æ›´åŠ è‡ªç„¶ï¼Œç›¸è¾ƒäºä¼ ç»Ÿçš„ Web åº”ç”¨ï¼ŒRESTful çš„æ¶ˆè´¹è€…å¯èƒ½æ˜¯äººï¼Œä¹Ÿå¯èƒ½æ˜¯ Mobile Appï¼Œä¹Ÿå¯èƒ½æ˜¯ç³»ç»Ÿä¸­å¦å¤–çš„ Serviceã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„æ¶ˆè´¹è€…éƒ½å¯ä»¥å¤„ç†ä¸€ä¸ªç™»é™†è¡¨å•ï¼

#### Restful API

æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®ä¾‹æ¥çœ‹ä½¿ç”¨ Spring Security ä¿æŠ¤å—é™åˆ¶è®¿é—®èµ„æºçš„åœºæ™¯ã€‚

å¯¹äº Controllerï¼š

```java
@RestController
@RequestMapping("/protected")
public class ProtectedResourceController {

    @RequestMapping("/{id}")
    public Message getOne(@PathVariable("id") String id) {
        return new Message("Protected resource "+id);
    }
}
```

æˆ‘ä»¬éœ€è¦æ‰€æœ‰è¯·æ±‚ä¸Šéƒ½å¸¦æœ‰ä¸€ä¸ª`X-Auth-Token`çš„ Headerï¼Œç®€å•èµ·è§ï¼Œå¦‚æœè¿™ä¸ª Header æœ‰å€¼ï¼Œæˆ‘ä»¬å°±è®¤ä¸ºè¿™ä¸ªè¯·æ±‚å·²ç»è¢«æˆæƒäº†ã€‚æˆ‘ä»¬åœ¨ Spring Security ä¸­å®šä¹‰è¿™æ ·çš„ä¸€ä¸ªé…ç½®ï¼š

```java
@Override
protected void configure(HttpSecurity http) throws Exception {
    http.
            csrf().disable().
            sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS).
            and().
            authorizeRequests().
            anyRequest().
            authenticated().
            and().
            exceptionHandling().
            authenticationEntryPoint(new RestAuthenticationEntryPoint());
}
```

æˆ‘ä»¬ä½¿ç”¨`SessionCreationPolicy.STATELESS`æ— çŠ¶æ€çš„ Session æœºåˆ¶ï¼ˆå³ Spring ä¸ä½¿ç”¨ HTTPSessionï¼‰ï¼Œå¯¹äºæ‰€æœ‰çš„è¯·æ±‚éƒ½åšæƒé™æ ¡éªŒï¼Œè¿™æ · Spring Security çš„æ‹¦æˆªå™¨ä¼šåˆ¤æ–­æ‰€æœ‰è¯·æ±‚çš„ Header ä¸Šæœ‰æ²¡æœ‰ "X-Auth-Token"ã€‚å¯¹äºå¼‚å¸¸æƒ…å†µï¼ˆå³å½“ Spring Security å‘ç°æ²¡æœ‰ï¼‰ï¼ŒSpring ä¼šå¯ç”¨ä¸€ä¸ªè®¤è¯å…¥å£ï¼š`new RestAuthenticationEntryPoint`ã€‚åœ¨æˆ‘ä»¬è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œè¿™ä¸ªå…¥å£åªæ˜¯ç®€å•çš„è¿”å›ä¸€ä¸ª 401 å³å¯ï¼š

```java
@Component
public class RestAuthenticationEntryPoint implements AuthenticationEntryPoint {

    @Override
    public void commence(HttpServletRequest request, HttpServletResponse response,
                         AuthenticationException authException ) throws IOException {
        response.sendError( HttpServletResponse.SC_UNAUTHORIZED, "Unauthorized" );
    }
}
```

è¿™æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬è¯·æ±‚è¿™ä¸ªå—é™åˆ¶çš„èµ„æºï¼š

```java
$ curl http://api.kanban.com:9000/api/protected/1 -s | jq .
{
  "timestamp": 1462621552738,
  "status": 401,
  "error": "Unauthorized",
  "message": "Unauthorized",
  "path": "/api/protected/1"
}
```

#### è¿‡æ»¤å™¨ï¼ˆFilterï¼‰åŠé¢„è®¤è¯ï¼ˆPreAuthenticationï¼‰

ä¸ºäº†è®© Spring Security å¯ä»¥å¤„ç†ç”¨æˆ·ç™»å½•çš„ caseï¼Œæˆ‘ä»¬éœ€è¦æä¾›ä¸€ä¸ª`Filter`ã€‚å½“ç„¶ï¼ŒSpring Security æä¾›äº†ä¸°å¯Œçš„`Filter`æœºåˆ¶ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨ä¸€ä¸ªé¢„è®¤è¯çš„`Filter`ï¼ˆå³å‡è®¾ç”¨æˆ·å·²ç»åœ¨åˆ«çš„å¤–éƒ¨ç³»ç»Ÿå¦‚ SSO ä¸­ç™»å½•äº†ï¼‰:

```java
public class KanBanPreAuthenticationFilter extends AbstractPreAuthenticatedProcessingFilter {
    public static final String SSO_TOKEN = "X-Auth-Token";
    public static final String SSO_CREDENTIALS = "N/A";

    public KanBanPreAuthenticationFilter(AuthenticationManager authenticationManager) {
        setAuthenticationManager(authenticationManager);
    }

    @Override
    protected Object getPreAuthenticatedPrincipal(HttpServletRequest request) {
        return request.getHeader(SSO_TOKEN);
    }

    @Override
    protected Object getPreAuthenticatedCredentials(HttpServletRequest request) {
        return SSO_CREDENTIALS;
    }
}
```

è¿‡æ»¤å™¨åœ¨è·å¾— Header ä¸­çš„ Token åï¼ŒSpring Security ä¼šå°è¯•å»è®¤è¯ç”¨æˆ·ï¼š

```java
@Override
protected void configure(AuthenticationManagerBuilder builder) throws Exception {
    builder.authenticationProvider(preAuthenticationProvider());
}

private AuthenticationProvider preAuthenticationProvider() {
    PreAuthenticatedAuthenticationProvider provider = new PreAuthenticatedAuthenticationProvider();
    provider.setPreAuthenticatedUserDetailsService(new KanBanAuthenticationUserDetailsService());

    return provider;
}
```

è¿™é‡Œçš„`KanBanAuthenticationUserDetailsService`æ˜¯ä¸€ä¸ªå®ç°äº† Spring Security çš„ UserDetailsService çš„ç±»ï¼š

```java
public class KanBanAuthenticationUserDetailsService
        implements AuthenticationUserDetailsService<PreAuthenticatedAuthenticationToken> {

    @Override
    public UserDetails loadUserDetails(PreAuthenticatedAuthenticationToken token) throws UsernameNotFoundException {
        String principal = (String) token.getPrincipal();

        if(!StringUtils.isEmpty(principal)) {
            return new KanBanUserDetails(new KanBanUser(principal));
        }

        return null;
    }
}
```

è¿™ä¸ªç±»çš„èŒè´£æ˜¯ï¼ŒæŸ¥çœ‹ä»`KanBanPreAuthenticationFilter`è¿”å›çš„`PreAuthenticatedAuthenticationToken`ï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºè¯¥ç”¨æˆ·åœ¨ç³»ç»Ÿä¸­å­˜åœ¨ï¼Œå¹¶æ­£å¸¸åŠ è½½ç”¨æˆ·ã€‚å¦‚æœè¿”å› nullï¼Œåˆ™è¡¨ç¤ºè¯¥è®¤è¯å¤±è´¥ï¼Œè¿™æ—¶æ ¹æ®é…ç½®ï¼ŒSpring Security ä¼šé‡å®šå‘åˆ°è®¤è¯å…¥å£`RestAuthenticationEntryPoint`ã€‚

åŠ ä¸Šè¿™ä¸ªè¿‡æ»¤å™¨çš„é…ç½®ä¹‹åï¼š

```java
@Override
protected void configure(HttpSecurity http) throws Exception {
    //...
    http.addFilter(headerAuthenticationFilter());
}

@Bean
public KanBanPreAuthenticationFilter headerAuthenticationFilter() throws Exception {
    return new KanBanPreAuthenticationFilter(authenticationManager());
}
```

è¿™æ ·ï¼Œå½“æˆ‘ä»¬åœ¨ Header ä¸ŠåŠ ä¸Š`X-Auth-Token`ä¹‹åï¼Œå°±ä¼šè®¿é—®åˆ°å—é™çš„èµ„æºäº†ï¼š

```java
$ curl -H "X-Auth-Token: juntao" http://api.kanban.com:9000/api/protected/1 -s | jq .
{
  "content": "Protected resource for 1"
}
```

## å‰åç«¯åˆ†ç¦»ä¹‹å

å‰åç«¯åˆ†ç¦»ä¹‹åï¼Œåœ¨éƒ¨ç½²ä¸Šé€šè¿‡ä¸€ä¸ªåå‘ä»£ç†å°±å¯ä»¥å®ç°åŠ¨é™æ€åˆ†ç¦»ï¼Œè·¨åŸŸé—®é¢˜çš„è§£å†³ç­‰ã€‚ä½†æ˜¯ä¸€æ—¦å¼•å…¥é‰´æƒï¼Œåˆ™åˆä¼šäº§ç”Ÿæ–°çš„é—®é¢˜ã€‚é€šå¸¸æ¥è¯´ï¼Œé‰´æƒæ˜¯å¯¹äºåå° API/API èƒŒåçš„èµ„æºçš„ä¿æŠ¤ï¼Œå³**æœªç»æˆæƒçš„ç”¨æˆ·ä¸èƒ½è®¿é—®å—ä¿æŠ¤èµ„æº**ã€‚

è¦å®ç°è¿™ä¸ªåŠŸèƒ½æœ‰å¾ˆå¤šç§æ–¹å¼ï¼Œåœ¨åº”ç”¨ç¨‹åºä¹‹å¤–è®¾ç½®å®Œå–„çš„å®‰å…¨æ‹¦æˆªå™¨æ˜¯æœ€å¸¸è§çš„æ–¹å¼ã€‚ä¸è¿‡æœ‰ç‚¹ä¸å¤Ÿä¼˜é›…çš„æ˜¯ï¼Œä¸€äº›ä¸å¤ªçº¯ç²¹çš„ã€éåŠŸèƒ½æ€§çš„ä»£ç å’Œä¸šåŠ¡ä»£ç æ··åœ¨åŒä¸€ä¸ªä»£ç åº“ä¸­ã€‚

å¦ä¸€æ–¹é¢ï¼Œå„ä¸ªä¸šåŠ¡ç³»ç»Ÿéƒ½å¯èƒ½éœ€è¦æŸç§æœºåˆ¶çš„é‰´æƒï¼Œæ‰€ä»¥å¾ˆå¤šä¼ä¸šéƒ½ä¼šæ­å»º SSO æœºåˆ¶ï¼Œå³ [Single Sign-On](https://en.wikipedia.org/wiki/Single_sign-on)ã€‚è¿™æ ·å¯ä»¥é¿å…äººä»¬åœ¨å¤šä¸ªç³»ç»Ÿåˆ›å»ºä¸åŒè´¦å·ï¼Œè®¾ç½®ä¸åŒå¯†ç ï¼Œä¸åŒçš„è¶…æ—¶æ—¶é—´ç­‰ç­‰ã€‚å¦‚æœ SSO ç³»ç»Ÿå·²ç»å…ˆäºç³»ç»Ÿå­˜åœ¨äº†å¾ˆä¹…ï¼Œé‚£ä¹ˆæ–°å¼€å‘çš„ç³»ç»Ÿå®Œå…¨ä¸éœ€è¦è‡ªå·±å†é…ç½®ä¸€å¥—ç”¨æˆ·ç®¡ç†æœºåˆ¶äº†ï¼ˆä¸€èˆ¬ SSO åªä¼šå®Œæˆ**é‰´æƒ**ä¸­**é‰´åˆ«**çš„éƒ¨åˆ†ï¼Œ**æˆæƒ**è¿˜æ˜¯éœ€è¦å„ä¸ªä¸šåŠ¡ç³»ç»Ÿè‡ªè¡Œå¤„ç†ï¼‰ã€‚

æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨åŸºç¡€è®¾æ–½ï¼ˆåå‘ä»£ç†ï¼‰çš„ä¸€äº›é…ç½®ï¼Œæ¥å®Œæˆ**ä¿æŠ¤æœªæˆæƒèµ„æº**çš„ç›®çš„ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å‡è®¾ç³»ç»Ÿç”±è¿™æ ·å‡ ä¸ªæœåŠ¡å™¨ç»„æˆï¼š

### ç³»ç»Ÿç»„æˆ

è¿™ä¸ªå®ä¾‹ä¸­ï¼Œæˆ‘ä»¬çš„ç³»ç»Ÿåˆ†ä¸ºä¸‰éƒ¨åˆ†

1.  `kanban.com:8000`ï¼ˆä¸šåŠ¡ç³»ç»Ÿå‰ç«¯ï¼‰
2.  `api.kanban.com:9000`ï¼ˆä¸šåŠ¡ç³»ç»Ÿåç«¯ APIï¼‰
3.  `sso.kanban.com:8100` ï¼ˆå•ç‚¹ç™»å½•ç³»ç»Ÿï¼Œç™»é™†ç•Œé¢ï¼‰

å‰ç«¯åŒ…å«äº† HTML/JS/CSS ç­‰èµ„æºï¼Œæ˜¯ä¸€ä¸ªçº¯é™æ€èµ„æºï¼Œæ‰€ä»¥æœ¬åœ°ç£ç›˜å³å¯ã€‚åç«¯ API åˆ™æ˜¯ä¸€ç»„éœ€è¦è¢«ä¿æŠ¤çš„ APIï¼ˆæ¯”å¦‚æŸ¥è¯¢å·¥èµ„è¯¦æƒ…ï¼ŒæŸ¥è¯¢å·¥ä½œç»å†ç­‰ï¼‰ã€‚æœ€åï¼Œå•ç‚¹ç™»å½•ç³»ç»Ÿæ˜¯ä¸€ä¸ªç®€å•çš„è¡¨å•ï¼Œç”¨æˆ·å¡«å…¥ç”¨æˆ·åå’Œå¯†ç åï¼Œå¦‚æœç™»å½•æˆåŠŸï¼Œå•ç‚¹ç™»å½•ä¼šå°†ç”¨æˆ·é‡å®šå‘åˆ°ç™»å½•å‰çš„ä½ç½®ã€‚

æˆ‘ä»¬ä¸¾ä¸€ä¸ªå…·ä½“åœºæ™¯çš„ä¾‹å­ï¼š

1.  æœªç™»å½•ç”¨æˆ·è®¿é—®`http://kanba.com:8000/index.html`
2.  ç³»ç»Ÿä¼šé‡å®šå‘ç”¨æˆ·åˆ°`http://sso.kanban.com:8100/sso?return=http://kanba.com:8000/index.html`
3.  ç”¨æˆ·çœ‹åˆ°ç™»å½•é¡µé¢ï¼Œè¾“å…¥ç”¨æˆ·åã€å¯†ç ç™»å½•
4.  ç”¨æˆ·è¢«é‡å®šå‘å›`http://kanba.com:8000/index.html`
5.  æ­¤å¤–ï¼Œ`index.htm`l é¡µé¢ä¸Šçš„`app.js`å¯¹`api.kanban.com:9000`çš„è®¿é—®ä¹Ÿå¾—åˆ°äº†æˆæƒ

#### ç¯å¢ƒè®¾ç½®

ç®€å•èµ·è§ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ / etc/hosts æ–‡ä»¶æ¥è®¾ç½®æœåŠ¡å™¨ç¯å¢ƒï¼š

```java
127.0.0.1 sso.kanban.com
127.0.0.1 api.kanban.com
127.0.0.1 kanban.com
```

### nginx åŠ auth_request

åå‘ä»£ç† nginx æœ‰ä¸€ä¸ª auth_request çš„æ¨¡å—ã€‚åœ¨ä¸€ä¸ªè™šæ‹Ÿ host ä¸­ï¼Œæ¯ä¸ªè¯·æ±‚ä¼šå…ˆå‘å¾€ä¸€ä¸ªå†…éƒ¨`location`ï¼Œè¿™ä¸ªå†…éƒ¨çš„`location`å¯ä»¥æŒ‡å‘ä¸€ä¸ªå¯ä»¥åšé‰´æƒçš„ Endpointã€‚å¦‚æœè¿™ä¸ªè¯·æ±‚å¾—åˆ°çš„ç»“æœæ˜¯ 200ï¼Œé‚£ä¹ˆ nginx ä¼šè¿”å›ç”¨æˆ·æœ¬æ¥è¯·æ±‚çš„å†…å®¹ï¼Œå¦‚æœè¿”å› 401ï¼Œåˆ™å°†ç”¨æˆ·é‡å®šå‘åˆ°ä¸€ä¸ªé¢„å®šä¹‰çš„åœ°å€ï¼š

```java
server {
    listen 8000;
    server_name kanban.com;

    root /usr/local/var/www/kanban/;

    error_page 401 = @error401;

    location @error401 {
        return 302 http://sso.kanban.com:8100/sso?return=$scheme://$http_host$request_uri;
    }

    auth_request /api/auth;

    location = /api/auth {
        internal;

        proxy_pass http://api.kanban.com:9000;

        proxy_pass_request_body     off;

        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        if ($http_cookie ~* "w3=(\w+)") {
            set $token "$1";
        }

        proxy_set_header X-KANBAN-TOKEN $token;
    }
}
```

æ¯”å¦‚ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`auth_request`çš„ URL ä¸º`/api/auth`ï¼Œå®ƒæ˜¯ä¸€ä¸ªå†…éƒ¨çš„ locationï¼Œå¤–éƒ¨æ— æ³•è®¿é—®ã€‚åœ¨è¿™ä¸ª`locaiton`ä¸­ï¼Œè¯·æ±‚ä¼šè¢«è½¬å‘åˆ°`http://api.kanban.com:9000`ï¼Œæ ¹æ® nginx çš„æ­£åˆ™è¯­æ³•ï¼Œè¯·æ±‚å°†ä¼šè¢«è½¬å‘åˆ°`http://api.kanban.com:9000/api/auth`ï¼ˆæˆ‘ä»¬éšåå¯ä»¥çœ‹åˆ°è¿™ä¸ª Endpoint çš„å®šä¹‰ï¼‰ã€‚

æˆ‘ä»¬è®¾ç½®äº†è¯·æ±‚çš„åŸå§‹å¤´ä¿¡æ¯ï¼Œå¹¶ç¦ç”¨äº† request_bodyï¼Œå¦‚æœ cookie ä¸­åŒ…å«äº†`w3=(\w+)`å­—æ ·ï¼Œåˆ™å°†è¿™ä¸ª w3 çš„å€¼æŠ½å–å‡ºæ¥ï¼Œå¹¶èµ‹å€¼ç»™ä¸€ä¸ª`X-KANBAN-TOKEN`çš„ HTTP å¤´ã€‚

#### æƒé™ Endpoint

å¯¹åº”çš„`/api/auth`çš„å®šä¹‰å¦‚ä¸‹ï¼š

```java
@RestController
@RequestMapping("/auth")
public class AuthController {

    @RequestMapping
    public ResponseEntity<String> simpleAuth(@RequestHeader(value="X-KANBAN-TOKEN", defaultValue = "") String token) {
        if(StringUtils.isEmpty(token)) {
            return new ResponseEntity<>("Unauthorized", HttpStatus.UNAUTHORIZED);
        } else {
            return new ResponseEntity<>("Authorized", HttpStatus.OK);
        }
    }
}
```

å¦‚æœ HTTP å¤´ä¸Šæœ‰`X-KANBAN-TOKEN`ä¸”å€¼ä¸ä¸ºç©ºï¼Œåˆ™è¿”å› 200ï¼Œå¦åˆ™è¿”å› 401ã€‚

å½“è¿™ä¸ªè¯·æ±‚å¾—åˆ° 401 ä¹‹åï¼Œç”¨æˆ·è¢«é‡å®šå‘åˆ°`http://sso.kanban.com:8100/sso`

```java
error_page 401 = @error401;

location @error401 {
    return 302 http://sso.kanban.com:8100/sso?return=$scheme://$http_host$request_uri;
}
```

### SSO ç»„ä»¶ï¼ˆç®€åŒ–ç‰ˆï¼‰

è¿™é‡Œç”¨`sinatra`å®šä¹‰äº†ä¸€ä¸ªç®€å•çš„ SSO æœåŠ¡å™¨ï¼ˆå»é™¤äº†å®é™…çš„æ ¡éªŒéƒ¨åˆ†ï¼‰

```java
require 'sinatra'
require 'uri'

set :return_url, ''
set :bind, '0.0.0.0'

get '/sso' do
    settings.return_url = params[:return]
    send_file 'public/index.html'
end

post '/login' do
	credential = params[:credential]
	# check credential against database
	uri = URI.parse(settings.return_url)
	response.set_cookie("w3", {
		:domain => ".#{uri.host}",
	    :expires => Time.now + 2400,
	    :value => "#{credential['name']}",
	    :path => '/'
  	})
	redirect settings.return_url, 302
end
```

`/sso`å¯¹åº”çš„ Login Form æ˜¯ï¼š

```java
<form action="/login" method="post">
	<input type="text" name="credential[name]" />
	<input type="password" name="credential[password]" />
	<input type="submit">
</form>
```

å½“ç”¨æˆ·æäº¤è¡¨å•ä¹‹åï¼Œæˆ‘ä»¬åªæ˜¯ç®€å•çš„è®¾ç½®äº†`cookie`ï¼Œå¹¶é‡å®šå‘ç”¨æˆ·åˆ°è·³è½¬å‰çš„ URLã€‚

### å‰ç«¯é¡µé¢

è¿™ä¸ªåº”ç”¨çš„å‰ç«¯åº”ç”¨éå¸¸ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦å°†è¿™äº›é™æ€æ–‡ä»¶æ”¾åˆ°`/usr/local/var/www/kanban`ç›®å½•ä¸‹ï¼š

```java
$ tree /usr/local/var/www/kanban

â”œâ”€â”€ index.html
â””â”€â”€ scripts
    â”œâ”€â”€ app.js
    â””â”€â”€ jquery.min.js
```

å…¶ä¸­`index.html`ä¸­å¼•ç”¨çš„`app.js`ä¼šè¯·æ±‚ä¸€ä¸ªå—ä¿æŠ¤çš„èµ„æºï¼š

```java
$(function() {
	$.get('/api/protected/1').done(function(message) {
		$('#message').text(message.content);
	});
});
```

ä»ä¸‹å›¾ä¸­çš„ç½‘ç»œè¯·æ±‚å¯ä»¥çœ‹åˆ°é‡å®šå‘çš„æµç¨‹ï¼š

![20241229154732_GAUYMvQ9.webp](https://cdn.dong4j.site/source/image/20241229154732_GAUYMvQ9.webp)

### æ€»ç»“

æœ¬æ–‡æˆ‘ä»¬é€šè¿‡é…ç½®åå‘ä»£ç†ï¼Œå°†å¤šä¸ª Endpoint ç»„ç»‡èµ·æ¥ã€‚è¿™ä¸ªè¿‡ç¨‹å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­é€šè¿‡ä»£ç å®ç°ï¼Œä¹Ÿå¯ä»¥åœ¨åŸºç¡€è®¾æ–½ä¸­é€šè¿‡é…ç½®å®ç°ï¼Œé€šå¸¸æ¥è®²ï¼Œå¦‚æœå¯ä»¥é€šè¿‡é…ç½®æ¥å®ç°çš„ï¼Œå°±å°½é‡å°†å…¶ä¸è´Ÿè´£ä¸šåŠ¡é€»è¾‘çš„ä»£ç éš”ç¦»å‡ºæ¥ã€‚è¿™æ ·å¯ä»¥ä¿è¯å„ä¸ªç»„ä»¶çš„ç‹¬ç«‹æ€§ï¼Œä¹Ÿå¯ä»¥ä½¿å¾—ä¼˜åŒ–å’Œå®šä½é—®é¢˜æ›´åŠ å®¹æ˜“ã€‚

## [Java ç¨‹åºå‘˜å¿…å­¦ï¼šclasspath æ–‡ä»¶è¯»å–æŠ€å·§](https://blog.dong4j.site/posts/a5564900.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

å†™ Java ç¨‹åºæ—¶ä¼šç»å¸¸ä» classpath ä¸‹è¯»å–æ–‡ä»¶, æ˜¯æ—¶å€™è¯¥æ•´ç†ä¸€ä¸‹äº†, å¹¶åœ¨ä¸æ–­æ·±å…¥çš„è¿‡ç¨‹ä¸­, é™†ç»­è¡¥å……ä¸Š.

<!-- more -->

ç°åœ¨ Java project éƒ½ä»¥ maven é¡¹ç›®å±…å¤š, æ¯”å¦‚åƒä¸‹é¢è¿™æ ·çš„ä¸€ä¸ªé¡¹ç›®ç»“æ„:

![20241229154732_YWDwQbhz.webp](https://cdn.dong4j.site/source/image/20241229154732_YWDwQbhz.webp)

ç¼–è¯‘åçš„ class æ–‡ä»¶éƒ½åˆ°äº† target ç›®å½•, å¦‚ä¸‹é¢çš„ç»“æ„:

![20241229154732_BvAjGpSn.webp](https://cdn.dong4j.site/source/image/20241229154732_BvAjGpSn.webp)

çœ‹ä»£ç :

```java
import java.io.File;
import java.net.URL;

public class Poem {
    public static void main(String[] args) {

        Poem poem = new Poem();
        poem.getFile("extObj.txt");
    }

    private void getFile(String fileName) {
        ClassLoader classLoader = getClass().getClassLoader();
        /**
        getResource() æ–¹æ³•ä¼šå» classpath ä¸‹æ‰¾è¿™ä¸ªæ–‡ä»¶, è·å–åˆ° url resource, å¾—åˆ°è¿™ä¸ªèµ„æºå, è°ƒç”¨ url.getFile è·å–åˆ° æ–‡ä»¶ çš„ç»å¯¹è·¯å¾„
        */
        URL url = classLoader.getResource(fileName);
        /**
         * url.getFile() å¾—åˆ°è¿™ä¸ªæ–‡ä»¶çš„ç»å¯¹è·¯å¾„
         */
        System.out.println(url.getFile());
        File file = new File(url.getFile());
        System.out.println(file.exists());
    }
}
```

é€šè¿‡ä¸Šé¢è¿™ç§æ–¹å¼å°±å¯ä»¥è·å–åˆ°è¿™ä¸ªæ–‡ä»¶èµ„æº.  
åœ¨ä¸€ä¸ª static method é‡Œå¯ä»¥ç›´æ¥é€šè¿‡ç±»çš„ ClassLoader å¯¹è±¡è·å–æ–‡ä»¶èµ„æº.

```java
URL url = Poem.class.getClassLoader().getResource("extObj.txt");
File file = new File(url.getFile());

```

```java
// ç›´æ¥è·å–åˆ°è¾“å…¥æµ
// fileName å°±æ˜¯ resources é‡Œçš„æ–‡ä»¶å
InputStream in = Poem.class.getClassLoader().getResourceAsStream(fileName);
```

ç»¼ä¸Šè¿°, ç±»é‡Œçš„ getClassLoader å»å¯»æ‰¾ fileName éƒ½æ˜¯ä» classpath å»æ‰¾çš„, æ¯•ç«Ÿæ˜¯ ClassLoader å˜›.

å¦‚æœä¸€ä¸ªåŒ…é‡Œé¢æœ‰ä¸€ä¸ªé…ç½®æ–‡ä»¶, é‚£è¯¥æ€ä¹ˆè·å–å‘¢ï¼Ÿ å¦‚å›¾:

![20241229154732_unL2GHSm.webp](https://cdn.dong4j.site/source/image/20241229154732_unL2GHSm.webp)

ç¬¬ä¸€ä¸ª dbconfig.properties åœ¨ç±» package ä¸‹, ç¬¬äºŒä¸ª dbconfig.properties åœ¨ resources ç›®å½•ä¸‹,  
é‚£æ€ä¹ˆè·å–åˆ° package ä¸‹çš„ dbconfig properties æ–‡ä»¶å‘¢ï¼Ÿ
here goes code:

```java
package com.getfilefromclasspath;

import java.io.IOException;
import java.io.InputStream;
import java.util.Properties;

public class ClassLoaderDemo {
    public static void main(String[] args) throws IOException {
        ClassLoaderDemo demo = new ClassLoaderDemo();
        demo.loadProperties();

    }

    public void loadProperties() throws  IOException {
        InputStream input = null;
        try
        {
            /**
             /dbconfig.properties  ç»å¯¹è·¯å¾„, å–åˆ°çš„æ–‡ä»¶æ˜¯ classpath ä¸‹çš„
              resources/dbconfig.properties ç›¸å¯¹è·¯å¾„ è·å–æ–‡ä»¶æµ
             */
             // è·å–åˆ° classpath ä¸‹çš„æ–‡ä»¶
            input = Class.forName(ClassLoaderDemo.class.getName()).getResourceAsStream("/dbconfig.properties");
            // è·å–åˆ° package ä¸‹çš„æ–‡ä»¶
//            input = Class.forName(ClassLoaderDemo.class.getName()).getResourceAsStream("resources/dbconfig.properties");
        } catch (ClassNotFoundException e)
        {
            e.printStackTrace();
        }
        printProperties(input);
    }

    private void printProperties(InputStream input) throws IOException
    {
        Properties properties = new Properties();
        properties.load(input);
        System.out.println(properties.getProperty("username"));
    }
}

```

ä¸ä½¿ç”¨ Class.forName(), é€šè¿‡å…·ä½“å¯¹è±¡è·å–åˆ° Class å¯¹è±¡:

```java
// also can be this way:
input = this.getClass().getResourceAsStream("resources/dbconfig.properties");    // å¯¹åº” package ä¸‹çš„æ–‡ä»¶
input = this.getClass().getResourceAsStream("/dbconfig.properties");    // å¯¹åº” resources ä¸‹çš„æ–‡ä»¶
```

Class å¯¹è±¡è¿˜æœ‰ getResource() çš„æ–¹æ³•å»è·å–æ–‡ä»¶èµ„æº, ä½¿ç”¨è§„åˆ™å’Œä¸Šé¢çš„ä¸€æ ·.

maven é¡¹ç›®è¿˜è¦æ³¨æ„ä¸€ç‚¹, maven çš„ compiler æ’ä»¶åœ¨ç¼–è¯‘æ—¶æ˜¯ä¸ä¼šå°† package ä¸‹çš„æ–‡æœ¬æ–‡ä»¶ç»™ç¼–è¯‘åˆ° target ä¸‹çš„,  
ä¸‹å›¾æ˜¯æˆ‘åœ¨ç”¨ mybatis æ¡†æ¶çš„æ—¶å€™å°† xml çš„ mapper ç»™æ”¾åˆ° package ç¼–è¯‘åçš„æ•ˆæœ:

![20241229154732_GlI663O1.webp](https://cdn.dong4j.site/source/image/20241229154732_GlI663O1.webp)

è¿™ä¸ªå¾—åœ¨ pom.xml åŠ å¯¹åº”çš„é…ç½® ( è¿™æ˜¯åœ¨ä½¿ç”¨ mybatis æ—¶é‡åˆ°çš„å‘ï¼‰:

```java
<build>
    <finalName>java-io</finalName>
    <resources>
        <resource>
            <directory>src/main/java</directory>
            <includes>
                <!--properties çš„é…ç½®æ–‡ä»¶ä¼šå’Œç¼–è¯‘åçš„ class æ–‡ä»¶æ”¾åœ¨ä¸€èµ· -->
                <include>**/*.properties</include>
            </includes>
        </resource>
        <resource>
            <!-- åŠ è½½é…ç½®çš„èµ„æº -->
            <directory>src/main/resources</directory>
        </resource>
    </resources>
    <plugins>
        <plugin>
            <artifactId>maven-compiler-plugin</artifactId>
            <configuration>
                <source>1.8</source>
                <target>1.8</target>
            </configuration>
        </plugin>
    </plugins>
</build>
```

## [Javaå¹¶å‘åˆ©å™¨ï¼šThreadPoolExecutor é«˜æ•ˆä½¿ç”¨æŒ‡å—](https://blog.dong4j.site/posts/f1e67b7e.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

æœ‰æ—¶å€™ï¼Œç³»ç»Ÿéœ€è¦å¤„ç†éå¸¸å¤šçš„æ‰§è¡Œæ—¶é—´å¾ˆçŸ­çš„è¯·æ±‚ï¼Œå¦‚æœæ¯ä¸€ä¸ªè¯·æ±‚éƒ½å¼€å¯ä¸€ä¸ªæ–°çº¿ç¨‹çš„è¯ï¼Œç³»ç»Ÿå°±è¦ä¸æ–­çš„è¿›è¡Œçº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯ï¼Œæœ‰æ—¶èŠ±åœ¨åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ä¸Šçš„æ—¶é—´ä¼šæ¯”çº¿ç¨‹çœŸæ­£æ‰§è¡Œçš„æ—¶é—´è¿˜é•¿ã€‚è€Œä¸”å½“çº¿ç¨‹æ•°é‡å¤ªå¤šæ—¶ï¼Œç³»ç»Ÿä¸ä¸€å®šèƒ½å—å¾—äº†ã€‚

ä½¿ç”¨çº¿ç¨‹æ± ä¸»è¦ä¸ºäº†è§£å†³ä¸€ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

- é€šè¿‡é‡ç”¨çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ï¼Œæ¥å‡å°‘æ¯ä¸ªçº¿ç¨‹åˆ›å»ºå’Œé”€æ¯çš„æ€§èƒ½å¼€é”€ã€‚
- å¯¹çº¿ç¨‹è¿›è¡Œä¸€äº›ç»´æŠ¤å’Œç®¡ç†ï¼Œæ¯”å¦‚å®šæ—¶å¼€å§‹ï¼Œå‘¨æœŸæ‰§è¡Œï¼Œå¹¶å‘æ•°æ§åˆ¶ç­‰ç­‰ã€‚

# Executor

Executor æ˜¯ä¸€ä¸ªæ¥å£ï¼Œè·Ÿçº¿ç¨‹æ± æœ‰å…³çš„åŸºæœ¬éƒ½è¦è·Ÿä»–æ‰“äº¤é“ã€‚ä¸‹é¢æ˜¯å¸¸ç”¨çš„ ThreadPoolExecutor çš„å…³ç³»ã€‚

![20241229154732_0gAWOlv1.webp](https://cdn.dong4j.site/source/image/20241229154732_0gAWOlv1.webp)

Executor æ¥å£å¾ˆç®€å•ï¼Œåªæœ‰ä¸€ä¸ª execute æ–¹æ³•ã€‚

ExecutorService æ˜¯ Executor çš„å­æ¥å£ï¼Œå¢åŠ äº†ä¸€äº›å¸¸ç”¨çš„å¯¹çº¿ç¨‹çš„æ§åˆ¶æ–¹æ³•ï¼Œä¹‹åä½¿ç”¨çº¿ç¨‹æ± ä¸»è¦ä¹Ÿæ˜¯ä½¿ç”¨è¿™äº›æ–¹æ³•ã€‚

AbstractExecutorService æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ã€‚ThreadPoolExecutor å°±æ˜¯å®ç°äº†è¿™ä¸ªç±»ã€‚

# ThreadPoolExecutor

## æ„é€ æ–¹æ³•

ThreadPoolExecutor æ˜¯çº¿ç¨‹æ± çš„çœŸæ­£å®ç°ï¼Œä»–é€šè¿‡æ„é€ æ–¹æ³•çš„ä¸€ç³»åˆ—å‚æ•°ï¼Œæ¥æ„æˆä¸åŒé…ç½®çš„çº¿ç¨‹æ± ã€‚å¸¸ç”¨çš„æ„é€ æ–¹æ³•æœ‰ä¸‹é¢å››ä¸ªï¼š

![20241229154732_MPBClhGO.webp](https://cdn.dong4j.site/source/image/20241229154732_MPBClhGO.webp)

```java
ThreadPoolExecutor(int corePoolSize,
                        int maximumPoolSize,
                        long keepAliveTime,
                        TimeUnit unit,
                        BlockingQueue<Runnable> workQueue)
```

```java
ThreadPoolExecutor(int corePoolSize,
                        int maximumPoolSize,
                        long keepAliveTime,
                        TimeUnit unit,
                        BlockingQueue<Runnable> workQueue,
                        ThreadFactory threadFactory)
```

```java
ThreadPoolExecutor(int corePoolSize,
                        int maximumPoolSize,
                        long keepAliveTime,
                        TimeUnit unit,
                        BlockingQueue<Runnable> workQueue,
                        RejectedExecutionHandler handler)
```

```java
ThreadPoolExecutor(int corePoolSize,
                        int maximumPoolSize,
                        long keepAliveTime,
                        TimeUnit unit,
                        BlockingQueue<Runnable> workQueue,
                        ThreadFactory threadFactory,
                        RejectedExecutionHandler handler)
```

## æ„é€ æ–¹æ³•å‚æ•°è¯´æ˜

- corePoolSize

  æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œé»˜è®¤æƒ…å†µä¸‹æ ¸å¿ƒçº¿ç¨‹ä¼šä¸€ç›´å­˜æ´»ï¼Œå³ä½¿å¤„äºé—²ç½®çŠ¶æ€ä¹Ÿä¸ä¼šå—å­˜ `keepAliveTime` é™åˆ¶ã€‚é™¤éå°† `allowCoreThreadTimeOut` è®¾ç½®ä¸º `true`ã€‚

- maximumPoolSize

  çº¿ç¨‹æ± æ‰€èƒ½å®¹çº³çš„æœ€å¤§çº¿ç¨‹æ•°ã€‚è¶…è¿‡è¿™ä¸ªæ•°çš„çº¿ç¨‹å°†è¢«é˜»å¡ã€‚å½“ä»»åŠ¡é˜Ÿåˆ—ä¸ºæ²¡æœ‰è®¾ç½®å¤§å°çš„ LinkedBlockingDeque æ—¶ï¼Œè¿™ä¸ªå€¼æ— æ•ˆã€‚

- keepAliveTime

  éæ ¸å¿ƒçº¿ç¨‹çš„é—²ç½®è¶…æ—¶æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´å°±ä¼šè¢«å›æ”¶ã€‚

- unit

  æŒ‡å®š `keepAliveTime` çš„å•ä½ï¼Œå¦‚ `TimeUnit.SECONDS`ã€‚å½“å°† `allowCoreThreadTimeOut` è®¾ç½®ä¸º `true` æ—¶å¯¹ corePoolSize ç”Ÿæ•ˆã€‚

- workQueue

  çº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡é˜Ÿåˆ—.

  å¸¸ç”¨çš„æœ‰ä¸‰ç§é˜Ÿåˆ—ï¼Œ`SynchronousQueue`,`LinkedBlockingDeque`,`ArrayBlockingQueue`ã€‚

- threadFactory

  çº¿ç¨‹å·¥å‚ï¼Œæä¾›åˆ›å»ºæ–°çº¿ç¨‹çš„åŠŸèƒ½ã€‚ThreadFactory æ˜¯ä¸€ä¸ªæ¥å£ï¼Œåªæœ‰ä¸€ä¸ªæ–¹æ³•

  ```java
  public interface ThreadFactory {
    Thread newThread(Runnable r);
  }
  ```

  é€šè¿‡çº¿ç¨‹å·¥å‚å¯ä»¥å¯¹çº¿ç¨‹çš„ä¸€äº›å±æ€§è¿›è¡Œå®šåˆ¶ã€‚

  é»˜è®¤çš„å·¥å‚ï¼š

  ```java
  static class DefaultThreadFactory implements ThreadFactory {
    private static final AtomicInteger poolNumber = new AtomicInteger(1);
    private final ThreadGroup group;
    private final AtomicInteger threadNumber = new AtomicInteger(1);
    private final String namePrefix;

    DefaultThreadFactory() {
        SecurityManager var1 = System.getSecurityManager();
        this.group = var1 != null?var1.getThreadGroup():Thread.currentThread().getThreadGroup();
        this.namePrefix = "pool-" + poolNumber.getAndIncrement() + "-thread-";
    }

    public Thread newThread(Runnable var1) {
        Thread var2 = new Thread(this.group, var1, this.namePrefix + this.threadNumber.getAndIncrement(), 0L);
        if(var2.isDaemon()) {
            var2.setDaemon(false);
        }

        if(var2.getPriority() != 5) {
            var2.setPriority(5);
        }

        return var2;
    }
  }
  ```

- RejectedExecutionHandler

  `RejectedExecutionHandler` ä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£ï¼Œåªæœ‰ä¸€ä¸ªæ–¹æ³•

  ```java
  public interface RejectedExecutionHandler {
    void rejectedExecution(Runnable var1, ThreadPoolExecutor var2);
  }
  ```

  å½“çº¿ç¨‹æ± ä¸­çš„èµ„æºå·²ç»å…¨éƒ¨ä½¿ç”¨ï¼Œæ·»åŠ æ–°çº¿ç¨‹è¢«æ‹’ç»æ—¶ï¼Œä¼šè°ƒç”¨ RejectedExecutionHandler çš„ rejectedExecution æ–¹æ³•ã€‚

## çº¿ç¨‹æ± è§„åˆ™

çº¿ç¨‹æ± çš„çº¿ç¨‹æ‰§è¡Œè§„åˆ™è·Ÿä»»åŠ¡é˜Ÿåˆ—æœ‰å¾ˆå¤§çš„å…³ç³»ã€‚

- ä¸‹é¢éƒ½å‡è®¾ä»»åŠ¡é˜Ÿåˆ—æ²¡æœ‰å¤§å°é™åˆ¶ï¼š

  1. å¦‚æœçº¿ç¨‹æ•°é‡æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä½†æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä½†æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¹¶ä¸” > æœ€å¤§çº¿ç¨‹æ•°ï¼Œå½“ä»»åŠ¡é˜Ÿåˆ—æ˜¯ LinkedBlockingDequeï¼Œä¼šå°†è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹çš„ä»»åŠ¡æ”¾åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­æ’é˜Ÿã€‚ä¹Ÿå°±æ˜¯å½“ä»»åŠ¡é˜Ÿåˆ—æ˜¯
     LinkedBlockingDeque å¹¶ä¸”æ²¡æœ‰å¤§å°é™åˆ¶æ—¶ï¼Œçº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°è®¾ç½®æ˜¯æ— æ•ˆçš„ï¼Œä»–çš„çº¿ç¨‹æ•°æœ€å¤šä¸ä¼šè¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚
  2. å¦‚æœçº¿ç¨‹æ•°é‡ > æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¹¶ä¸” > æœ€å¤§çº¿ç¨‹æ•°ï¼Œå½“ä»»åŠ¡é˜Ÿåˆ—æ˜¯ SynchronousQueue çš„æ—¶å€™ï¼Œä¼šå› ä¸ºçº¿ç¨‹æ± æ‹’ç»æ·»åŠ ä»»åŠ¡è€ŒæŠ›å‡ºå¼‚å¸¸ã€‚

- ä»»åŠ¡é˜Ÿåˆ—å¤§å°æœ‰é™æ—¶

  1. å½“ LinkedBlockingDeque å¡æ»¡æ—¶ï¼Œæ–°å¢çš„ä»»åŠ¡ä¼šç›´æ¥åˆ›å»ºæ–°çº¿ç¨‹æ¥æ‰§è¡Œï¼Œå½“åˆ›å»ºçš„çº¿ç¨‹æ•°é‡è¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°é‡æ—¶ä¼šæŠ›å¼‚å¸¸ã€‚
  2. SynchronousQueue æ²¡æœ‰æ•°é‡é™åˆ¶ã€‚å› ä¸ºä»–æ ¹æœ¬ä¸ä¿æŒè¿™äº›ä»»åŠ¡ï¼Œè€Œæ˜¯ç›´æ¥äº¤ç»™çº¿ç¨‹æ± å»æ‰§è¡Œã€‚å½“ä»»åŠ¡æ•°é‡è¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°æ—¶ä¼šç›´æ¥æŠ›å¼‚å¸¸ã€‚

## è§„åˆ™éªŒè¯

### å‰æ

æ‰€æœ‰çš„ä»»åŠ¡éƒ½æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼Œç¡çœ ä¸¤ç§’åæ‰“å°ä¸€è¡Œæ—¥å¿—ï¼š

```java
Runnable myRunnable = new Runnable() {
    @Override
    public void run() {
        try {
            Thread.sleep(2000);
            System.out.println(Thread.currentThread().getName() + " run");
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

    }
};
```

æ‰€æœ‰éªŒè¯è¿‡ç¨‹éƒ½æ˜¯ä¸‹é¢è¿™æ ·ï¼Œå…ˆæ‰§è¡Œä¸‰ä¸ªï¼Œå†æ‰§è¡Œä¸‰ä¸ªï¼Œ8 ç§’åï¼Œå„çœ‹ä¸€æ¬¡ä¿¡æ¯

```java
executor.execute(myRunnable);
executor.execute(myRunnable);
executor.execute(myRunnable);
System.out.println("---å…ˆå¼€ä¸‰ä¸ª---");
System.out.println("æ ¸å¿ƒçº¿ç¨‹æ•°" + executor.getCorePoolSize());
System.out.println("çº¿ç¨‹æ± æ•°" + executor.getPoolSize());
System.out.println("é˜Ÿåˆ—ä»»åŠ¡æ•°" + executor.getQueue().size());
executor.execute(myRunnable);
executor.execute(myRunnable);
executor.execute(myRunnable);
System.out.println("---å†å¼€ä¸‰ä¸ª---");
System.out.println("æ ¸å¿ƒçº¿ç¨‹æ•°" + executor.getCorePoolSize());
System.out.println("çº¿ç¨‹æ± æ•°" + executor.getPoolSize());
System.out.println("é˜Ÿåˆ—ä»»åŠ¡æ•°" + executor.getQueue().size());
Thread.sleep(8000);
System.out.println("----8ç§’ä¹‹å----");
System.out.println("æ ¸å¿ƒçº¿ç¨‹æ•°" + executor.getCorePoolSize());
System.out.println("çº¿ç¨‹æ± æ•°" + executor.getPoolSize());
System.out.println("é˜Ÿåˆ—ä»»åŠ¡æ•°" + executor.getQueue().size());
```

### éªŒè¯ 1

1. æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º 6ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸º 10ã€‚è¶…æ—¶æ—¶é—´ä¸º 5 ç§’

   ```java
   ThreadPoolExecutor executor = new ThreadPoolExecutor(6, 10, 5, TimeUnit.SECONDS, new SynchronousQueue<Runnable>());
   ```

   ```
   --- å…ˆå¼€ä¸‰ä¸ª ---
   æ ¸å¿ƒçº¿ç¨‹æ•° 6
   çº¿ç¨‹æ± çº¿ç¨‹æ•° 3
   é˜Ÿåˆ—ä»»åŠ¡æ•° 0
   --- å†å¼€ä¸‰ä¸ª ---
   æ ¸å¿ƒçº¿ç¨‹æ•° 6
   çº¿ç¨‹æ± çº¿ç¨‹æ•° 6
   é˜Ÿåˆ—ä»»åŠ¡æ•° 0
   pool-1-thread-1 run
   pool-1-thread-6 run
   pool-1-thread-5 run
   pool-1-thread-3 run
   pool-1-thread-4 run
   pool-1-thread-2 run
   ----8 ç§’ä¹‹å ----
   æ ¸å¿ƒçº¿ç¨‹æ•° 6
   çº¿ç¨‹æ± çº¿ç¨‹æ•° 6
   é˜Ÿåˆ—ä»»åŠ¡æ•° 0
   ```

å¯ä»¥çœ‹åˆ°æ¯ä¸ªä»»åŠ¡éƒ½æ˜¯æ˜¯ç›´æ¥å¯åŠ¨ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œä¸€å…±åˆ›å»ºäº† 6 ä¸ªçº¿ç¨‹ï¼Œä¸ä¼šæ”¾å…¥é˜Ÿåˆ—ä¸­ã€‚8 ç§’åçº¿ç¨‹æ± è¿˜æ˜¯ 6 ä¸ªçº¿ç¨‹ï¼Œæ ¸å¿ƒçº¿ç¨‹é»˜è®¤æƒ…å†µä¸‹ä¸ä¼šè¢«å›æ”¶ï¼Œä¸æ”¶è¶…æ—¶æ—¶é—´é™åˆ¶ã€‚

### éªŒè¯ 2

1. æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º 3ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸º 6ã€‚è¶…æ—¶æ—¶é—´ä¸º 5 ç§’, é˜Ÿåˆ—æ˜¯ LinkedBlockingDeque

   ```java
   ThreadPoolExecutor executor = new ThreadPoolExecutor(3, 6, 5, TimeUnit.SECONDS, new LinkedBlockingDeque<Runnable>());
   ```

   ```
   --- å…ˆå¼€ä¸‰ä¸ª ---
   æ ¸å¿ƒçº¿ç¨‹æ•° 3
   çº¿ç¨‹æ± çº¿ç¨‹æ•° 3
   é˜Ÿåˆ—ä»»åŠ¡æ•° 0
   --- å†å¼€ä¸‰ä¸ª ---
   æ ¸å¿ƒçº¿ç¨‹æ•° 3
   çº¿ç¨‹æ± çº¿ç¨‹æ•° 3
   é˜Ÿåˆ—ä»»åŠ¡æ•° 3
   pool-1-thread-3 run
   pool-1-thread-1 run
   pool-1-thread-2 run
   pool-1-thread-3 run
   pool-1-thread-1 run
   pool-1-thread-2 run
   ----8 ç§’ä¹‹å ----
   æ ¸å¿ƒçº¿ç¨‹æ•° 3
   çº¿ç¨‹æ± çº¿ç¨‹æ•° 3
   é˜Ÿåˆ—ä»»åŠ¡æ•° 0
   ```

   å½“ä»»åŠ¡æ•°è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œä¼šå°†è¶…å‡ºçš„ä»»åŠ¡æ”¾åœ¨é˜Ÿåˆ—ä¸­ï¼Œåªä¼šåˆ›å»º 3 ä¸ªçº¿ç¨‹é‡å¤åˆ©ç”¨ã€‚

### éªŒè¯ 3

1. æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º 3ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸º 6ã€‚è¶…æ—¶æ—¶é—´ä¸º 5 ç§’, é˜Ÿåˆ—æ˜¯ SynchronousQueue

```java
ThreadPoolExecutor executor = new ThreadPoolExecutor(3, 6, 5, TimeUnit.SECONDS, new SynchronousQueue<Runnable>());
```

```
--- å…ˆå¼€ä¸‰ä¸ª ---
æ ¸å¿ƒçº¿ç¨‹æ•° 3
çº¿ç¨‹æ± çº¿ç¨‹æ•° 3
é˜Ÿåˆ—ä»»åŠ¡æ•° 0
--- å†å¼€ä¸‰ä¸ª ---
æ ¸å¿ƒçº¿ç¨‹æ•° 3
çº¿ç¨‹æ± çº¿ç¨‹æ•° 6
é˜Ÿåˆ—ä»»åŠ¡æ•° 0
pool-1-thread-2 run
pool-1-thread-3 run
pool-1-thread-6 run
pool-1-thread-4 run
pool-1-thread-5 run
pool-1-thread-1 run
----8 ç§’ä¹‹å ----
æ ¸å¿ƒçº¿ç¨‹æ•° 3
çº¿ç¨‹æ± çº¿ç¨‹æ•° 3
é˜Ÿåˆ—ä»»åŠ¡æ•° 0
```

å½“é˜Ÿåˆ—æ˜¯ SynchronousQueue æ—¶ï¼Œè¶…å‡ºæ ¸å¿ƒçº¿ç¨‹çš„ä»»åŠ¡ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œï¼Œçœ‹åˆ°ä¸€å…±æœ‰ 6 ä¸ªçº¿ç¨‹ã€‚ä½†æ˜¯è¿™äº›çº¿ç¨‹æ˜¯è´¹æ ¸å¿ƒçº¿ç¨‹ï¼Œæ”¶è¶…æ—¶æ—¶é—´é™åˆ¶ï¼Œåœ¨ä»»åŠ¡å®Œæˆåé™åˆ¶è¶…è¿‡
5 ç§’å°±ä¼šè¢«å›æ”¶ã€‚æ‰€ä»¥æœ€åçœ‹åˆ°çº¿ç¨‹æ± è¿˜æ˜¯åªæœ‰ä¸‰ä¸ªçº¿ç¨‹ã€‚

### éªŒè¯ 4

1. æ ¸å¿ƒçº¿ç¨‹æ•°æ˜¯ 3ï¼Œæœ€å¤§çº¿ç¨‹æ•°æ˜¯ 4ï¼Œé˜Ÿåˆ—æ˜¯ LinkedBlockingDeque

   ```java
   ThreadPoolExecutor executor = new ThreadPoolExecutor(3, 4, 5, TimeUnit.SECONDS, new LinkedBlockingDeque<Runnable>());
   ```

```java
--- å…ˆå¼€ä¸‰ä¸ª ---
æ ¸å¿ƒçº¿ç¨‹æ•° 3
çº¿ç¨‹æ± çº¿ç¨‹æ•° 3
é˜Ÿåˆ—ä»»åŠ¡æ•° 0
--- å†å¼€ä¸‰ä¸ª ---
æ ¸å¿ƒçº¿ç¨‹æ•° 3
çº¿ç¨‹æ± çº¿ç¨‹æ•° 3
é˜Ÿåˆ—ä»»åŠ¡æ•° 3
pool-1-thread-3 run
pool-1-thread-1 run
pool-1-thread-2 run
pool-1-thread-3 run
pool-1-thread-1 run
pool-1-thread-2 run
----8 ç§’ä¹‹å ----
æ ¸å¿ƒçº¿ç¨‹æ•° 3
çº¿ç¨‹æ± çº¿ç¨‹æ•° 3
é˜Ÿåˆ—ä»»åŠ¡æ•° 0
```

LinkedBlockingDeque æ ¹æœ¬ä¸å—æœ€å¤§çº¿ç¨‹æ•°å½±å“ã€‚

ä½†æ˜¯å½“ LinkedBlockingDeque æœ‰å¤§å°é™åˆ¶æ—¶å°±ä¼šå—æœ€å¤§çº¿ç¨‹æ•°å½±å“äº†

4.1 æ¯”å¦‚ä¸‹é¢ï¼Œå°†é˜Ÿåˆ—å¤§å°è®¾ç½®ä¸º 2.

```java
ThreadPoolExecutor executor = new ThreadPoolExecutor(3, 4, 5, TimeUnit.SECONDS, new LinkedBlockingDeque<Runnable>(2));
```

```java
--- å…ˆå¼€ä¸‰ä¸ª ---
æ ¸å¿ƒçº¿ç¨‹æ•° 3
çº¿ç¨‹æ± çº¿ç¨‹æ•° 3
é˜Ÿåˆ—ä»»åŠ¡æ•° 0
--- å†å¼€ä¸‰ä¸ª ---
æ ¸å¿ƒçº¿ç¨‹æ•° 3
çº¿ç¨‹æ± çº¿ç¨‹æ•° 4
é˜Ÿåˆ—ä»»åŠ¡æ•° 2
pool-1-thread-2 run
pool-1-thread-1 run
pool-1-thread-4 run
pool-1-thread-3 run
pool-1-thread-1 run
pool-1-thread-2 run
----8 ç§’ä¹‹å ----
æ ¸å¿ƒçº¿ç¨‹æ•° 3
çº¿ç¨‹æ± çº¿ç¨‹æ•° 3
é˜Ÿåˆ—ä»»åŠ¡æ•° 0
```

é¦–å…ˆä¸ºä¸‰ä¸ªä»»åŠ¡å¼€å¯äº†ä¸‰ä¸ªæ ¸å¿ƒçº¿ç¨‹ 1ï¼Œ2ï¼Œ3ï¼Œç„¶åç¬¬å››ä¸ªä»»åŠ¡å’Œç¬¬äº”ä¸ªä»»åŠ¡åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œç¬¬å…­ä¸ªä»»åŠ¡å› ä¸ºé˜Ÿåˆ—æ»¡äº†ï¼Œå°±ç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹
4ï¼Œè¿™æ˜¯ä¸€å…±æœ‰å››ä¸ªçº¿ç¨‹ï¼Œæ²¡æœ‰è¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°ã€‚8 ç§’åï¼Œéæ ¸å¿ƒçº¿ç¨‹æ”¶è¶…æ—¶æ—¶é—´å½±å“å›æ”¶äº†ï¼Œå› æ­¤çº¿ç¨‹æ± åªå‰© 3 ä¸ªçº¿ç¨‹äº†ã€‚

4.2 å°†é˜Ÿåˆ—å¤§å°è®¾ç½®ä¸º 1

```java
ThreadPoolExecutor executor = new ThreadPoolExecutor(3, 4, 5, TimeUnit.SECONDS, new LinkedBlockingDeque<Runnable>(1));
```

```java
Exception in thread "main" java.util.concurrent.RejectedExecutionException: Task com.sunlinlin.threaddemo.Main$1@677327b6 rejected from java.util.concurrent.ThreadPoolExecutor@14ae5a5[Running, pool size = 4, active threads = 4, queued tasks = 1, completed tasks = 0]
    at java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2047)
    at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:823)
    at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1369)
    at com.sunlinlin.threaddemo.Main.main(Main.java:35)
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
    at java.lang.reflect.Method.invoke(Method.java:498)
    at com.intellij.rt.execution.application.AppMain.main(AppMain.java:147)
--- å…ˆå¼€ä¸‰ä¸ª ---
æ ¸å¿ƒçº¿ç¨‹æ•° 3
çº¿ç¨‹æ± çº¿ç¨‹æ•° 3
é˜Ÿåˆ—ä»»åŠ¡æ•° 0
pool-1-thread-1 run
pool-1-thread-2 run
pool-1-thread-3 run
pool-1-thread-4 run
pool-1-thread-1 run
```

ç›´æ¥å‡ºé”™åœ¨ç¬¬ 6 ä¸ª execute æ–¹æ³•ä¸Šã€‚å› ä¸ºæ ¸å¿ƒçº¿ç¨‹æ˜¯ 3 ä¸ªï¼Œå½“åŠ å…¥ç¬¬å››ä¸ªä»»åŠ¡çš„æ—¶å€™ï¼Œå°±æŠŠç¬¬å››ä¸ªæ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚åŠ å…¥ç¬¬äº”ä¸ªä»»åŠ¡æ—¶ï¼Œå› ä¸ºé˜Ÿåˆ—æ»¡äº†ï¼Œå°±åˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œï¼Œåˆ›å»ºäº†çº¿ç¨‹
4ã€‚å½“åŠ å…¥ç¬¬å…­ä¸ªçº¿ç¨‹æ—¶ï¼Œä¹Ÿä¼šå°è¯•åˆ›å»ºçº¿ç¨‹ï¼Œä½†æ˜¯å› ä¸ºå·²ç»è¾¾åˆ°äº†çº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°ï¼Œæ‰€ä»¥ç›´æ¥æŠ›å¼‚å¸¸äº†ã€‚

### éªŒè¯ 5

1. æ ¸å¿ƒçº¿ç¨‹æ•°æ˜¯ 3 ï¼Œæœ€å¤§çº¿ç¨‹æ•°æ˜¯ 4ï¼Œé˜Ÿåˆ—æ˜¯ SynchronousQueue

   ```java
   ThreadPoolExecutor executor = new ThreadPoolExecutor(3, 4, 5, TimeUnit.SECONDS, new SynchronousQueue<Runnable>());
   ```

```
Exception in thread "main" java.util.concurrent.RejectedExecutionException: Task com.sunlinlin.threaddemo.Main$1@14ae5a5 rejected from java.util.concurrent.ThreadPoolExecutor@7f31245a[Running, pool size = 4, active threads = 4, queued tasks = 0, completed tasks = 0]
    at java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2047)
    at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:823)
    at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1369)
    at com.sunlinlin.threaddemo.Main.main(Main.java:34)
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
    at java.lang.reflect.Method.invoke(Method.java:498)
    at com.intellij.rt.execution.application.AppMain.main(AppMain.java:147)
--- å…ˆå¼€ä¸‰ä¸ª ---
æ ¸å¿ƒçº¿ç¨‹æ•° 3
çº¿ç¨‹æ± çº¿ç¨‹æ•° 3
é˜Ÿåˆ—ä»»åŠ¡æ•° 0
pool-1-thread-2 run
pool-1-thread-3 run
pool-1-thread-4 run
pool-1-thread-1 run
```

è¿™æ¬¡åœ¨æ·»åŠ ç¬¬äº”ä¸ªä»»åŠ¡æ—¶å°±æŠ¥é”™äº†ï¼Œå› ä¸º SynchronousQueue å„å¥”ä¸ä¿å­˜ä»»åŠ¡ï¼Œæ”¶åˆ°ä¸€ä¸ªä»»åŠ¡å°±å»åˆ›å»ºæ–°çº¿ç¨‹ã€‚æ‰€ä»¥ç¬¬äº”ä¸ªå°±ä¼šæŠ›å¼‚å¸¸äº†ã€‚

![æ­»å¾ªç¯æ‡µé€¼.gif](https://cdn.dong4j.site/source/image/%E6%AD%BB%E5%BE%AA%E7%8E%AF%E6%87%B5%E9%80%BC.gif)

## [Javaçº¿ç¨‹æ± æ·±åº¦è§£æï¼šå››ç§åˆ›å»ºæ–¹å¼è¯¦è§£](https://blog.dong4j.site/posts/c7d0ca57.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

æ€»ç»“çº¿ç¨‹æ± çš„ä½¿ç”¨æ–¹å¼

<!-- more -->

Java é€šè¿‡ Executors æä¾›å››ç§çº¿ç¨‹æ± , åˆ†åˆ«ä¸º:

1. newCachedThreadPool åˆ›å»ºä¸€ä¸ªå¯ç¼“å­˜çº¿ç¨‹æ± , å¦‚æœçº¿ç¨‹æ± é•¿åº¦è¶…è¿‡å¤„ç†éœ€è¦, å¯çµæ´»å›æ”¶ç©ºé—²çº¿ç¨‹, è‹¥æ— å¯å›æ”¶, åˆ™æ–°å»ºçº¿ç¨‹.
2. newFixedThreadPool åˆ›å»ºä¸€ä¸ªå®šé•¿çº¿ç¨‹æ± , å¯æ§åˆ¶çº¿ç¨‹æœ€å¤§å¹¶å‘æ•°, è¶…å‡ºçš„çº¿ç¨‹ä¼šåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾….
3. newScheduledThreadPool åˆ›å»ºä¸€ä¸ªå®šé•¿çº¿ç¨‹æ± , æ”¯æŒå®šæ—¶åŠå‘¨æœŸæ€§ä»»åŠ¡æ‰§è¡Œ.
4. newSingleThreadExecutor åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹åŒ–çš„çº¿ç¨‹æ± , å®ƒåªä¼šç”¨å”¯ä¸€çš„å·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡, ä¿è¯æ‰€æœ‰ä»»åŠ¡æŒ‰ç…§æŒ‡å®šé¡ºåº (FIFO, LIFO, ä¼˜å…ˆçº§) æ‰§è¡Œ.

çº¿ç¨‹æ± æ¯”è¾ƒå•çº¿ç¨‹çš„ä¼˜åŠ¿åœ¨äº:

- é‡ç”¨å­˜åœ¨çš„çº¿ç¨‹, å‡å°‘å¯¹è±¡åˆ›å»ºã€æ¶ˆäº¡çš„å¼€é”€, æ€§èƒ½ä½³.
- å¯æœ‰æ•ˆæ§åˆ¶æœ€å¤§å¹¶å‘çº¿ç¨‹æ•°, æé«˜ç³»ç»Ÿèµ„æºçš„ä½¿ç”¨ç‡, åŒæ—¶é¿å…è¿‡å¤šèµ„æºç«äº‰, é¿å…å µå¡.
- æä¾›å®šæ—¶æ‰§è¡Œã€å®šæœŸæ‰§è¡Œã€å•çº¿ç¨‹ã€å¹¶å‘æ•°æ§åˆ¶ç­‰åŠŸèƒ½.

newCachedThreadPool

```java
public static void main(String[] args) {
    ExecutorService cachedThreadPool = Executors.newCachedThreadPool();
    for (int i = 0; i < 10; i++) {
        final int index = i;
        try {
            Thread.sleep(10);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        cachedThreadPool.execute(new Runnable() {
            public void run() {
                System.out.println(index);
            }
        });
    }
}
```

```java
public static ExecutorService newCachedThreadPool() {
        return new ThreadPoolExecutor(0, Integer.MAX_VALUE,
                                      60L, TimeUnit.SECONDS,
                                      new SynchronousQueue<Runnable>());
    }
```

åˆ›å»ºä¸€ä¸ªå¯ç¼“å­˜çº¿ç¨‹æ± , å¦‚æœçº¿ç¨‹æ± é•¿åº¦è¶…è¿‡å¤„ç†éœ€è¦, å¯çµæ´»å›æ”¶ç©ºé—²çº¿ç¨‹, è‹¥æ— å¯å›æ”¶, åˆ™æ–°å»ºçº¿ç¨‹.

è¿™é‡Œçš„çº¿ç¨‹æ± æ˜¯æ— é™å¤§çš„, å½“ä¸€ä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡ä¹‹å, è¿™ä¸ªçº¿ç¨‹å¯ä»¥æ¥ä¸‹æ¥å®Œæˆå°†è¦åˆ†é…çš„ä»»åŠ¡, è€Œä¸æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹,

java api 1.7 will reuse previously constructed threads when they are available.

newFixedThreadPool

```java
public static void main(String[] args) {
    ExecutorService fixedThreadPool = Executors.newFixedThreadPool(3);
    for (int i = 0; i < 10; i++) {
        final int index = i;
        fixedThreadPool.execute(new Runnable() {
            public void run() {
                try {
                    System.out.println(index);
                    Thread.sleep(10);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        });
    }
}
```

```java
public static ExecutorService newFixedThreadPool(int nThreads) {
        return new ThreadPoolExecutor(nThreads, nThreads,
                                      0L, TimeUnit.MILLISECONDS,
                                      new LinkedBlockingQueue<Runnable>());
    }
```

åˆ›å»ºä¸€ä¸ªå®šé•¿çº¿ç¨‹æ± , å¯æ§åˆ¶çº¿ç¨‹æœ€å¤§å¹¶å‘æ•°, è¶…å‡ºçš„çº¿ç¨‹ä¼šåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…

å®šé•¿çº¿ç¨‹æ± çš„å¤§å°æœ€å¥½æ ¹æ®ç³»ç»Ÿèµ„æºè¿›è¡Œè®¾ç½®. å¦‚ Runtime.getRuntime().availableProcessors()

```java
public static void main(String[] args) {
    ScheduledExecutorService scheduledThreadPool = Executors.newScheduledThreadPool(5);
    for (int i = 0; i < 10; i++) {
        scheduledThreadPool.schedule(new Runnable() {
            public void run() {
                System.out.println("delay 3 seconds");
            }
        }, 3, TimeUnit.SECONDS);
    }
}
```

```java
public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize) {
        return new ScheduledThreadPoolExecutor(corePoolSize);
    }

public ScheduledThreadPoolExecutor(int corePoolSize) {
        super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS,
              new DelayedWorkQueue());
    }

public ThreadPoolExecutor(int corePoolSize,
                              int maximumPoolSize,
                              long keepAliveTime,
                              TimeUnit unit,
                              BlockingQueue<Runnable> workQueue) {
        this(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,
             Executors.defaultThreadFactory(), defaultHandler);
    }
```

newSingleThreadExecutor

```java
public static void main(String[] args) {
    ExecutorService singleThreadExecutor = Executors.newSingleThreadExecutor();
    for (int i = 0; i < 10; i++) {
        final int index = i;
        singleThreadExecutor.execute(new Runnable() {
            public void run() {
                try {
                    System.out.println(index);
                    Thread.sleep(2000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        });
    }
}
```

```java
public static ExecutorService newSingleThreadExecutor() {
        return new FinalizableDelegatedExecutorService
            (new ThreadPoolExecutor(1, 1,
                                    0L, TimeUnit.MILLISECONDS,
                                    new LinkedBlockingQueue<Runnable>()));
    }
```

æŒ‰é¡ºåºæ¥æ‰§è¡Œçº¿ç¨‹ä»»åŠ¡ ä½†æ˜¯ä¸åŒäºå•çº¿ç¨‹, è¿™ä¸ªçº¿ç¨‹æ± åªæ˜¯åªèƒ½å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹, è¿™ä¸ªçº¿ç¨‹æ­»åå¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¼šè¡¥ä¸Š

```java
/**
 * ThreadPoolExecutor ç±»çš„ä½¿ç”¨æ–¹æ³•
 * å®ç°é«˜å¹¶å‘: åœ¨çº¿ç¨‹ç±»ä¸­çš„ runï¼ˆï¼‰æ–¹æ³•å†…è®¾ç½® Thread.sleepï¼ˆlong deltaï¼‰ï¼› delta å–å€¼ä¸º: ï¼ˆå¹¶å‘å¼€å§‹æ—¶é—´æˆ³ - çº¿ç¨‹å¼€å§‹æ—¶é—´æˆ³ï¼‰
 * Created by Administrator on 2016/11/19.
 */
public class ThreadPoolExecutorTest {
    public static void main(String[] args) {

        // è®¾ç½®æ ¸å¿ƒæ± å¤§å°
        int corePoolSize = 5;

        // è®¾ç½®çº¿ç¨‹æ± æœ€å¤§èƒ½æ¥å—å¤šå°‘çº¿ç¨‹

        // å½“å‰çº¿ç¨‹æ•°å¤§äº corePoolSizeã€å°äº maximumPoolSize æ—¶, è¶…å‡º corePoolSize çš„çº¿ç¨‹æ•°çš„ç”Ÿå‘½å‘¨æœŸ
        long keepActiveTime = 200;

        // è®¾ç½®æ—¶é—´å•ä½, ç§’
        TimeUnit timeUnit = TimeUnit.SECONDS;

        // è®¾ç½®çº¿ç¨‹æ± ç¼“å­˜é˜Ÿåˆ—çš„æ’é˜Ÿç­–ç•¥ä¸º FIFO, å¹¶ä¸”æŒ‡å®šç¼“å­˜é˜Ÿåˆ—å¤§å°ä¸º 5
        BlockingQueue<Runnable> workQueue = new ArrayBlockingQueue<Runnable>(5);

        // åˆ›å»º ThreadPoolExecutor çº¿ç¨‹æ± å¯¹è±¡, å¹¶åˆå§‹åŒ–è¯¥å¯¹è±¡çš„å„ç§å‚æ•°
        ThreadPoolExecutor executor = new ThreadPoolExecutor(corePoolSize, maximumPoolSize, keepActiveTime, timeUnit,workQueue);

        // å¾€çº¿ç¨‹æ± ä¸­å¾ªç¯æäº¤çº¿ç¨‹
        for (int i = 0; i < 15; i++) {
            // åˆ›å»ºçº¿ç¨‹ç±»å¯¹è±¡
            MyTask myTask = new MyTask(i);
            // å¼€å¯çº¿ç¨‹
            executor.execute(myTask);
            // è·å–çº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„ç›¸åº”å‚æ•°
            System.out.println("çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°ç›®: " +executor.getPoolSize() + ", é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡æ•°ç›®: "+executor.getQueue().size() + ", å·²æ‰§è¡Œå®Œçš„ä»»åŠ¡æ•°ç›®: "+executor.getCompletedTaskCount());
        }
        // å¾…çº¿ç¨‹æ± ä»¥åŠç¼“å­˜é˜Ÿåˆ—ä¸­æ‰€æœ‰çš„çº¿ç¨‹ä»»åŠ¡å®Œæˆåå…³é—­çº¿ç¨‹æ± .
        executor.shutdown();
    }
}
/**
 * çº¿ç¨‹ç±»
 */
class MyTask implements Runnable {
    private int num;

    public MyTask(int num) {
        this.num = num;
    }

    @Override
    public void run() {
        System.out.println("æ­£åœ¨æ‰§è¡Œtask " + num );
        try {
            Thread.currentThread().sleep(5000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println("task " + num + "æ‰§è¡Œå®Œæ¯•");
    }

    /**
     * è·å–ï¼ˆæœªæ¥æ—¶é—´æˆ³ - å½“å‰æ—¶é—´æˆ³ï¼‰çš„å·®å€¼,
     * ä¹Ÿå³æ˜¯: ï¼ˆæ¯ä¸ªçº¿ç¨‹çš„ç¡é†’æ—¶é—´æˆ³ - æ¯ä¸ªçº¿ç¨‹çš„å…¥ç¡æ—¶é—´æˆ³ï¼‰
     * ä½œç”¨: ç”¨äºå®ç°å¤šçº¿ç¨‹é«˜å¹¶å‘
     * @return
     * @throws ParseException
     */
    public long getDelta() throws ParseException {
        // è·å–å½“å‰æ—¶é—´æˆ³
        long t1 = new Date().getTime();
        // è·å–æœªæ¥æŸä¸ªæ—¶é—´æˆ³ï¼ˆè‡ªå®šä¹‰, å¯å†™å…¥é…ç½®æ–‡ä»¶ï¼‰
        String str = "2016-11-11 15:15:15";
        SimpleDateFormat simpleDateFormat = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        long t2 = simpleDateFormat.parse(str).getTime();
        return t2 - t1;
    }
}
```

## [æŒæ¡Java GCï¼šæ·±å…¥ç†è§£å¹¶é«˜æ•ˆé…ç½®GCå‚æ•°](https://blog.dong4j.site/posts/29d7a15f.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

åœ¨ Java ä¸­, GC çš„å¯¹è±¡æ˜¯å †ç©ºé—´å’Œæ°¸ä¹…åŒº

<!-- more -->

### å¼•ç”¨è®¡æ•°ç®—æ³•

![20241229154732_Xidtz6g4.webp](https://cdn.dong4j.site/source/image/20241229154732_Xidtz6g4.webp)

- Java ä¸å†ä½¿ç”¨
- Python,COM,ActionScript3 ä½¿ç”¨
- æ€§èƒ½å·®
- ä¸èƒ½è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜

### æ ‡è®° - æ¸…é™¤ç®—æ³•

#### æ ‡è®°é˜¶æ®µ

åœ¨æ ‡è®°é˜¶æ®µï¼Œé¦–å…ˆé€šè¿‡æ ¹èŠ‚ç‚¹ï¼Œæ ‡è®°æ‰€æœ‰ä»æ ¹èŠ‚ç‚¹å¼€å§‹çš„å¯è¾¾å¯¹è±¡

#### æ¸…é™¤é˜¶æ®µ

æ¸…é™¤æ‰€æœ‰æœªè¢«æ ‡è®°çš„å¯¹è±¡

### æ ‡è®° - å‹ç¼©ç®—æ³•

![20241229154732_8Sh9Pelm.webp](https://cdn.dong4j.site/source/image/20241229154732_8Sh9Pelm.webp)

æ ‡è®° - å‹ç¼©ç®—æ³•é€‚åˆç”¨äºå­˜æ´»å¯¹è±¡è¾ƒå¤šçš„åœºåˆï¼Œå¦‚è€å¹´ä»£.
å®ƒåœ¨æ ‡è®° - æ¸…é™¤ç®—æ³•çš„åŸºç¡€ä¸Šåšäº†ä¸€äº›ä¼˜åŒ–.

#### æ ‡è®°é˜¶æ®µ

ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œå¯¹æ‰€æœ‰å¯è¾¾å¯¹è±¡åšä¸€æ¬¡æ ‡è®°

#### å‹ç¼©é˜¶æ®µ

å°†æ‰€æœ‰å­˜æ´»å¯¹è±¡å‹ç¼©åˆ°å†…å­˜ä¸€ç«¯, ç„¶åæ¸…é™¤è¾¹ç•Œå¤–çš„æ‰€æœ‰ç©ºé—´

### å¤åˆ¶ç®—æ³•

![20241229154732_GNfE6QNt.webp](https://cdn.dong4j.site/source/image/20241229154732_GNfE6QNt.webp)

- ä¸æ ‡è®° - æ¸…é™¤ç®—æ³•ç›¸æ¯”, å¤åˆ¶ç®—æ³•æ˜¯ä¸€ç§ç›¸å¯¹é«˜æ•ˆçš„å›æ”¶æ–¹å¼
- ä¸é€‚åˆå­˜æ´»å¯¹è±¡è¾ƒå¤šçš„åœºåˆ, å¦‚è€å¹´ä»£
- å°†åŸæ¥çš„å†…å­˜åˆ†ä¸ºç›¸åŒå¤§å°çš„ä¸¤å—, æ¯æ¬¡åªæ˜¯ç”¨å…¶ä¸­ä¸€å—, åœ¨åƒåœ¾å›æ”¶æ—¶, å°†æ­£åœ¨æ˜¯ç”¨çš„å†…å­˜ä¸­çš„å¯¹è±¡å¤åˆ¶åˆ°æœªä½¿ç”¨çš„å†…å­˜å—ä¸­, ä¹‹åæ¸…é™¤æ­£åœ¨æ˜¯ç”¨çš„å†…å­˜ä¸­çš„æ‰€æœ‰å¯¹è±¡,
  äº¤æ¢ä¸¤ä¸ªå†…å­˜çš„è§’è‰², å®Œæˆåƒåœ¾å›æ”¶

é—®é¢˜:

- ç©ºé—´æµªè´¹, åªæ˜¯ç”¨äº†ä¸€åŠ

æ˜¯ç”¨æ ‡è®°æ¸…ç†å’Œå¤åˆ¶ç®—æ³•é…ç½®å›æ”¶åƒåœ¾

![20241229154732_xecT49yQ.webp](https://cdn.dong4j.site/source/image/20241229154732_xecT49yQ.webp)

1. åœ¨æœ€ä¸Šé¢é‚£å—å¤§çš„åŒºåŸŸäº§ç”Ÿæ–°å¯¹è±¡ã€‚
2. å¤§å¯¹è±¡ä¸å¤ªé€‚åˆåœ¨å¤åˆ¶ç©ºé—´ï¼Œå› ä¸ºå¤åˆ¶ç©ºé—´çš„å®¹é‡æ˜¯æœ‰é™çš„ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªå¤§çš„ç©ºé—´åšæ‹…ä¿ï¼Œæ‰€ä»¥è®©è€å¹´ä»£åšæ‹…ä¿ã€‚è¿™æ ·äº§ç”Ÿçš„å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ã€‚
3. æ¯ä¸€æ¬¡ GCï¼Œå¯¹è±¡çš„å¹´é¾„å°±ä¼š +1ï¼Œä¸€ä¸ªå¯¹è±¡åœ¨å‡ æ¬¡ GC åä»ç„¶æ²¡æœ‰è¢«å›æ”¶ï¼Œåˆ™è¿™ä¸ªå¯¹è±¡å°±æ˜¯ä¸€ä¸ªè€å¹´å¯¹è±¡ã€‚è€å¹´å¯¹è±¡æ˜¯ä¸€ä¸ªé•¿æœŸè¢«å¼•ç”¨çš„å¯¹è±¡ï¼Œè€å¹´å¯¹è±¡å°†è¢«æ”¾å…¥è€å¹´ä»£ã€‚
4. æ­¥éª¤ 1 ä¸­äº§ç”Ÿçš„å°å¯¹è±¡ï¼Œå°†è¿›å…¥åˆ°å¤åˆ¶ç©ºé—´ã€‚åŸå…ˆå¤åˆ¶ç©ºé—´ä¸­çš„æ–°å¯¹è±¡ä¹Ÿå°†è¢«å¤åˆ¶åˆ°å¦ä¸€å—å¤åˆ¶ç©ºé—´
5. æ¸…ç©ºåƒåœ¾å¯¹è±¡

![20241229154732_2Cv7w0uQ.webp](https://cdn.dong4j.site/source/image/20241229154732_2Cv7w0uQ.webp)

ä¸€ä¸ªå †åˆ†ä¸º new generation(æ–°ç”Ÿä»£) , tenured generation(è€å¹´ä»£) å’Œ compacting perm genã€‚
è€Œ new generation åˆ†ä¸º eden space,from spaceï¼ˆæœ‰äº›åœ°æ–¹ç§°ä¸º s0 å’Œ s1ï¼Œè¡¨ç¤ºå¹¸å­˜ä»£ï¼‰ , to spaceã€‚
eden space å°±æ˜¯ä¸Šé¢é‚£ç§å›¾ä¸­ï¼Œå¯¹è±¡äº§ç”Ÿçš„åœ°æ–¹ã€‚
from space å’Œ to space æ˜¯ä¸¤å—å¤§å°ä¸€æ ·çš„åŒºåŸŸï¼Œæ˜¯ä¸Šå›¾ä¸­çš„å¤åˆ¶ç©ºé—´ã€‚
new generation çš„å¯ç”¨æ€»ç©ºé—´å°±æ˜¯ eden space+ ä¸€å—å¤åˆ¶ç©ºé—´ï¼ˆå¦ä¸€å—ä¸ç®—ï¼‰ï¼Œä½†æ˜¯æ ¹æ® new generation çš„åœ°å€è®¿é—®å¯ä»¥ç®—å‡ºæ˜¯ eden space +
ä¸¤å—å¤åˆ¶ç©ºé—´åŒºåŸŸï¼Œæ‰€ä»¥å¤åˆ¶ç®—æ³•æµªè´¹äº†ä¸€éƒ¨åˆ†ç©ºé—´ã€‚

## åˆ†ä»£æ€æƒ³

ä¾æ®å¯¹è±¡çš„å­˜æ´»å‘¨æœŸè¿›è¡Œåˆ†ç±»ï¼ŒçŸ­å‘½å¯¹è±¡å½’ä¸ºæ–°ç”Ÿä»£ï¼Œé•¿å‘½å¯¹è±¡å½’ä¸ºè€å¹´ä»£ã€‚
æ ¹æ®ä¸åŒä»£çš„ç‰¹ç‚¹ï¼Œé€‰å–åˆé€‚çš„æ”¶é›†ç®—æ³•

- å°‘é‡å¯¹è±¡å­˜æ´»ï¼Œé€‚åˆå¤åˆ¶ç®—æ³•
- å¤§é‡å¯¹è±¡å­˜æ´»ï¼Œé€‚åˆæ ‡è®°æ¸…ç†æˆ–è€…æ ‡è®°å‹ç¼©
- è¿›å…¥è€å¹´ä»£çš„å¯¹è±¡æœ‰ä¸¤ç§æƒ…å†µï¼š
  1. æ–°ç”Ÿä»£ç©ºé—´ä¸å¤Ÿï¼Œè€å¹´ä»£åšæ‹…ä¿å­˜æ”¾ä¸€äº›å¤§å¯¹è±¡
  2. æŸäº›å¯¹è±¡å¤šæ¬¡ GC åä»ç„¶å­˜åœ¨ï¼Œè¿›å…¥è€å¹´ä»£ã€‚

è€å¹´ä»£çš„å¤§å¤šæ•°å¯¹è±¡éƒ½æ˜¯ç¬¬ 2 ç§æƒ…å†µï¼Œæ‰€ä»¥è€å¹´ä»£çš„å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ¯”è¾ƒé•¿ï¼ŒGC çš„å‘ç”Ÿä¹Ÿæ¯”è¾ƒå°‘ï¼Œä¼šæœ‰å¤§é‡å¯¹è±¡å­˜æ´»ï¼Œæ‰€ä»¥ä¸ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€Œæ”¹ä¸ºæ ‡è®°æ¸…ç†æˆ–è€…æ ‡è®°å‹ç¼©ã€‚
æ‰€æœ‰çš„ç®—æ³•ï¼Œéœ€è¦èƒ½å¤Ÿè¯†åˆ«ä¸€ä¸ªåƒåœ¾å¯¹è±¡ï¼Œå› æ­¤éœ€è¦ç»™å‡ºä¸€ä¸ªå¯è§¦åŠæ€§çš„å®šä¹‰

### å¯è§¦åŠæ€§

ä»æ ¹èŠ‚ç‚¹å¯ä»¥è§¦åŠåˆ°è¿™ä¸ªå¯¹è±¡
å¯å¤æ´»çš„
ä¸€æ—¦æ‰€æœ‰å¼•ç”¨è¢«é‡Šæ”¾ï¼Œå°±æ˜¯å¯å¤æ´»çŠ¶æ€
å› ä¸ºåœ¨ finalize() ä¸­å¯èƒ½å¤æ´»è¯¥å¯¹è±¡
ä¸å¯è§¦åŠçš„
åœ¨ finalize() åï¼Œå¯èƒ½ä¼šè¿›å…¥ä¸å¯è§¦åŠçŠ¶æ€
ä¸å¯è§¦åŠçš„å¯¹è±¡ä¸å¯èƒ½å¤æ´»
å¯ä»¥å›æ”¶
ä¸‹é¢ä¸¾ä¸ªä¾‹å­æ¥è¯´æ˜å¯å¤æ´»è¿™ä¸ªçŠ¶æ€ï¼š

```java
public class CanReliveObj{
	public static CanReliveObj obj;
	@Override
	protected void finalize() throws Throwable{
		super.finalize();
		System.out.println("CanReliveObj finalize called");
		obj = this;
	}
	@Override
	public String toString(){
		return "I am CanReliveObj";
	}
	public static void main(String[] args) throws InterruptedException{
		obj = new CanReliveObj();
		obj = null; // å¯å¤æ´»
		System.gc();
		Thread.sleep(1000);
		if (obj == null){
			System.out.println("obj æ˜¯ null");
		}
		else{
			System.out.println("obj å¯ç”¨");
		}
		System.out.println("ç¬¬äºŒæ¬¡gc");
		obj = null; // ä¸å¯å¤æ´»
		System.gc();
		Thread.sleep(1000);
		if (obj == null){
			System.out.println("obj æ˜¯ null");
		}
		else{
			System.out.println("obj å¯ç”¨");
		}
	}
}
```

è¾“å‡ºï¼š

```
CanReliveObj finalize called
obj å¯ç”¨
ç¬¬äºŒæ¬¡ gc
obj æ˜¯ null
```

ä¸€èˆ¬æˆ‘ä»¬è®¤ä¸ºï¼Œå¯¹è±¡èµ‹å€¼ null åï¼Œå¯¹è±¡å°±å¯ä»¥è¢« GC äº†ï¼Œåœ¨ä¸Šè¿°å®ä¾‹ä¸­ï¼Œåœ¨ finalize ä¸­ï¼Œåˆå°† obj=thisï¼Œä½¿å¯¹è±¡å¤æ´»ã€‚å› ä¸º finalize åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡
GC æ—¶ï¼Œobj è¢«å›æ”¶ã€‚
å› æ­¤å¯¹äº finalize ä¼šæœ‰è¿™æ ·çš„å»ºè®®ï¼š

- ç»éªŒï¼šé¿å…ä½¿ç”¨ finalize()ï¼Œæ“ä½œä¸æ…å¯èƒ½å¯¼è‡´é”™è¯¯ã€‚
- finalize ä¼˜å…ˆçº§ä½ï¼Œä½•æ—¶è¢«è°ƒç”¨ï¼ˆåœ¨ GC æ—¶è¢«è°ƒç”¨ï¼Œä½•æ—¶å‘ç”Ÿ GC ä¸ç¡®å®šï¼‰ ä¸ç¡®å®š
- å¯ä»¥ä½¿ç”¨ try-catch-finally æ¥æ›¿ä»£å®ƒ

å¦å¤–åœ¨ä¹‹å‰ï¼Œæˆ‘ä»¬ä¸€ç›´åœ¨æåˆ°ä»æ ¹å‡ºå‘ï¼Œé‚£ä¹ˆæ ¹æ˜¯æŒ‡å“ªäº›å¯¹è±¡å‘¢ï¼Ÿ

- æ ˆä¸­å¼•ç”¨çš„å¯¹è±¡
- æ–¹æ³•åŒºä¸­é™æ€æˆå‘˜æˆ–è€…å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ï¼ˆå…¨å±€å¯¹è±¡ï¼‰
- JNI æ–¹æ³•æ ˆä¸­å¼•ç”¨å¯¹è±¡

## Stop-The-World

Stop-The-World æ˜¯ Java ä¸­ä¸€ç§å…¨å±€æš‚åœçš„ç°è±¡ã€‚
å…¨å±€åœé¡¿ï¼Œæ‰€æœ‰ Java ä»£ç åœæ­¢ï¼Œnative ä»£ç å¯ä»¥æ‰§è¡Œï¼Œä½†ä¸èƒ½å’Œ JVM äº¤äº’

å¤šåŠç”±äº GC å¼•èµ·ï¼Œå½“ç„¶ Dump çº¿ç¨‹ã€æ­»é”æ£€æŸ¥ã€å † Dump éƒ½æœ‰å¯èƒ½å¼•èµ· Stop-The-World

**GC æ—¶ä¸ºä»€ä¹ˆä¼šæœ‰å…¨å±€åœé¡¿ï¼Ÿ**
ç±»æ¯”åœ¨èšä¼šæ—¶æ‰“æ‰«æˆ¿é—´ï¼Œèšä¼šæ—¶å¾ˆä¹±ï¼Œåˆæœ‰æ–°çš„åƒåœ¾äº§ç”Ÿï¼Œæˆ¿é—´æ°¸è¿œæ‰“æ‰«ä¸å¹²å‡€ï¼Œåªæœ‰è®©å¤§å®¶åœæ­¢æ´»åŠ¨äº†ï¼Œæ‰èƒ½å°†æˆ¿é—´æ‰“æ‰«å¹²å‡€ã€‚

**å±å®³**

- é•¿æ—¶é—´æœåŠ¡åœæ­¢ï¼Œæ²¡æœ‰å“åº”
- é‡åˆ° HA ç³»ç»Ÿï¼Œå¯èƒ½å¼•èµ·ä¸»å¤‡åˆ‡æ¢ï¼Œä¸¥é‡å±å®³ç”Ÿäº§ç¯å¢ƒã€‚

**æ–°ç”Ÿä»£çš„ GCï¼ˆMinor GCï¼‰ï¼Œåœé¡¿æ—¶é—´æ¯”è¾ƒçŸ­**
**è€å¹´ä»£çš„ GCï¼ˆFull GCï¼‰ï¼Œåœé¡¿æ—¶é—´å¯èƒ½æ¯”è¾ƒé•¿**

## ä¸²è¡Œæ”¶é›†å™¨

![20241229154732_z9Ogdnsj.webp](https://cdn.dong4j.site/source/image/20241229154732_z9Ogdnsj.webp)

ä¸²è¡Œæ”¶é›†å™¨æ˜¯æœ€å¤è€ï¼Œæœ€ç¨³å®šä»¥åŠæ•ˆç‡é«˜çš„æ”¶é›†å™¨
å¯èƒ½ä¼šäº§ç”Ÿè¾ƒé•¿çš„åœé¡¿ï¼Œåªä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹å»å›æ”¶
-XX:+UseSerialGC

- æ–°ç”Ÿä»£ã€è€å¹´ä»£ä½¿ç”¨ä¸²è¡Œå›æ”¶
- æ–°ç”Ÿä»£å¤åˆ¶ç®—æ³•
- è€å¹´ä»£æ ‡è®° - å‹ç¼©

![20241229154732_fKWU1kDv.webp](https://cdn.dong4j.site/source/image/20241229154732_fKWU1kDv.webp)

## å¹¶è¡Œæ”¶é›†å™¨

### ParNew

![20241229154732_msvwo0y6.webp](https://cdn.dong4j.site/source/image/20241229154732_msvwo0y6.webp)

- -XX:+UseParNewGCï¼ˆnew ä»£è¡¨æ–°ç”Ÿä»£ï¼Œæ‰€ä»¥é€‚ç”¨äºæ–°ç”Ÿä»£ï¼‰
  - æ–°ç”Ÿä»£å¹¶è¡Œ
  - è€å¹´ä»£ä¸²è¡Œ
- Serial æ”¶é›†å™¨æ–°ç”Ÿä»£çš„å¹¶è¡Œç‰ˆæœ¬
- å¤åˆ¶ç®—æ³•
- å¤šçº¿ç¨‹ï¼Œéœ€è¦å¤šæ ¸æ”¯æŒ
- -XX:ParallelGCThreads é™åˆ¶çº¿ç¨‹æ•°é‡

### Parallel

![20241229154732_HBBpLaFF.webp](https://cdn.dong4j.site/source/image/20241229154732_HBBpLaFF.webp)

- ç±»ä¼¼ ParNew
- æ–°ç”Ÿä»£å¤åˆ¶ç®—æ³•
- è€å¹´ä»£ æ ‡è®° - å‹ç¼©
- æ›´åŠ å…³æ³¨ååé‡
- -XX:+UseParallelGC
- ä½¿ç”¨ Parallel æ”¶é›†å™¨ + è€å¹´ä»£ä¸²è¡Œ
- -XX:+UseParallelOldGC
- ä½¿ç”¨ Parallel æ”¶é›†å™¨ + å¹¶è¡Œè€å¹´ä»£

- -XX:MaxGCPauseMills
  - æœ€å¤§åœé¡¿æ—¶é—´ï¼Œå•ä½æ¯«ç§’
  - GC å°½åŠ›ä¿è¯å›æ”¶æ—¶é—´ä¸è¶…è¿‡è®¾å®šå€¼
- -XX:GCTimeRatio
  - 0-100 çš„å–å€¼èŒƒå›´
  - åƒåœ¾æ”¶é›†æ—¶é—´å æ€»æ—¶é—´çš„æ¯”
  - é»˜è®¤ 99ï¼Œå³æœ€å¤§å…è®¸ 1% æ—¶é—´åš GC
- è¿™ä¸¤ä¸ªå‚æ•°æ˜¯çŸ›ç›¾çš„ã€‚å› ä¸ºåœé¡¿æ—¶é—´å’Œååé‡ä¸å¯èƒ½åŒæ—¶è°ƒä¼˜

### CMS æ”¶é›†å™¨

![20241229154732_XvTdgL4p.webp](https://cdn.dong4j.site/source/image/20241229154732_XvTdgL4p.webp)

- Concurrent Mark Sweep å¹¶å‘æ ‡è®°æ¸…é™¤
- æ ‡è®° - æ¸…é™¤ç®—æ³•
- ä¸æ ‡è®° - å‹ç¼©ç›¸æ¯”
- å¹¶å‘é˜¶æ®µä¼šé™ä½ååé‡
- è€å¹´ä»£æ”¶é›†å™¨ï¼ˆæ–°ç”Ÿä»£ä½¿ç”¨ ParNewï¼‰
- -XX:+UseConcMarkSweepGC

- åˆå§‹æ ‡è®°
  - æ ¹å¯ä»¥ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡
  - é€Ÿåº¦å¿«
- å¹¶å‘æ ‡è®°ï¼ˆå’Œç”¨æˆ·çº¿ç¨‹ä¸€èµ·ï¼‰
  - ä¸»è¦æ ‡è®°è¿‡ç¨‹ï¼Œæ ‡è®°å…¨éƒ¨å¯¹è±¡
- é‡æ–°æ ‡è®°
  - ç”±äºå¹¶å‘æ ‡è®°æ—¶ï¼Œç”¨æˆ·çº¿ç¨‹ä¾ç„¶è¿è¡Œï¼Œå› æ­¤åœ¨æ­£å¼æ¸…ç†å‰ï¼Œå†åšä¿®æ­£
- å¹¶å‘æ¸…é™¤ï¼ˆå’Œç”¨æˆ·çº¿ç¨‹ä¸€èµ·ï¼‰
  - åŸºäºæ ‡è®°ç»“æœï¼Œç›´æ¥æ¸…ç†å¯¹è±¡

#### ç‰¹ç‚¹

- å°½å¯èƒ½é™ä½åœé¡¿
- ä¼šå½±å“ç³»ç»Ÿæ•´ä½“ååé‡å’Œæ€§èƒ½
  - æ¯”å¦‚ï¼Œåœ¨ç”¨æˆ·çº¿ç¨‹è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œåˆ†ä¸€åŠ CPU å»åš GCï¼Œç³»ç»Ÿæ€§èƒ½åœ¨ GC é˜¶æ®µï¼Œååº”é€Ÿåº¦å°±ä¸‹é™ä¸€åŠ
- æ¸…ç†ä¸å½»åº•
  - å› ä¸ºåœ¨æ¸…ç†é˜¶æ®µï¼Œç”¨æˆ·çº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œä¼šäº§ç”Ÿæ–°çš„åƒåœ¾ï¼Œæ— æ³•æ¸…ç†
- å› ä¸ºå’Œç”¨æˆ·çº¿ç¨‹ä¸€èµ·è¿è¡Œï¼Œä¸èƒ½åœ¨ç©ºé—´å¿«æ»¡æ—¶å†æ¸…ç†

  - -XX:CMSInitiatingOccupancyFraction è®¾ç½®è§¦å‘ GC çš„é˜ˆå€¼
  - å¦‚æœä¸å¹¸å†…å­˜é¢„ç•™ç©ºé—´ä¸å¤Ÿï¼Œå°±ä¼šå¼•èµ· concurrent mode failure

- -XX:+ UseCMSCompactAtFullCollection Full GC åï¼Œè¿›è¡Œä¸€æ¬¡æ•´ç†
  - æ•´ç†è¿‡ç¨‹æ˜¯ç‹¬å çš„ï¼Œä¼šå¼•èµ·åœé¡¿æ—¶é—´å˜é•¿
- -XX:+CMSFullGCsBeforeCompaction
  - è®¾ç½®è¿›è¡Œå‡ æ¬¡ Full GC åï¼Œè¿›è¡Œä¸€æ¬¡ç¢ç‰‡æ•´ç†
- -XX:ParallelCMSThreads
  - è®¾å®š CMS çš„çº¿ç¨‹æ•°é‡

CMS çš„æå‡ºæ˜¯æƒ³æ”¹å–„ GC çš„åœé¡¿æ—¶é—´ï¼Œåœ¨ GC è¿‡ç¨‹ä¸­çš„ç¡®åšåˆ°äº†å‡å°‘ GC æ—¶é—´ï¼Œä½†æ˜¯åŒæ ·å¯¼è‡´äº§ç”Ÿå¤§é‡å†…å­˜ç¢ç‰‡ï¼Œåˆéœ€è¦æ¶ˆè€—å¤§é‡æ—¶é—´å»æ•´ç†ç¢ç‰‡ï¼Œä»æœ¬è´¨ä¸Šå¹¶æ²¡æœ‰æ”¹å–„æ—¶é—´ã€‚

## GC å‚æ•°æ•´ç†

-XX:+UseSerialGCï¼šåœ¨æ–°ç”Ÿä»£å’Œè€å¹´ä»£ä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨
-XX:SurvivorRatioï¼šè®¾ç½® eden åŒºå¤§å°å’Œ survivior åŒºå¤§å°çš„æ¯”ä¾‹
-XX:NewRatio: æ–°ç”Ÿä»£å’Œè€å¹´ä»£çš„æ¯”
-XX:+UseParNewGCï¼šåœ¨æ–°ç”Ÿä»£ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨
-XX:+UseParallelGC ï¼šæ–°ç”Ÿä»£ä½¿ç”¨å¹¶è¡Œå›æ”¶æ”¶é›†å™¨
-XX:+UseParallelOldGCï¼šè€å¹´ä»£ä½¿ç”¨å¹¶è¡Œå›æ”¶æ”¶é›†å™¨
-XX:ParallelGCThreadsï¼šè®¾ç½®ç”¨äºåƒåœ¾å›æ”¶çš„çº¿ç¨‹æ•°
-XX:+UseConcMarkSweepGCï¼šæ–°ç”Ÿä»£ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨ï¼Œè€å¹´ä»£ä½¿ç”¨ CMS+ ä¸²è¡Œæ”¶é›†å™¨
-XX:ParallelCMSThreadsï¼šè®¾å®š CMS çš„çº¿ç¨‹æ•°é‡
-XX:CMSInitiatingOccupancyFractionï¼šè®¾ç½® CMS æ”¶é›†å™¨åœ¨è€å¹´ä»£ç©ºé—´è¢«ä½¿ç”¨å¤šå°‘åè§¦å‘
-XX:+UseCMSCompactAtFullCollectionï¼šè®¾ç½® CMS æ”¶é›†å™¨åœ¨å®Œæˆåƒåœ¾æ”¶é›†åæ˜¯å¦è¦è¿›è¡Œä¸€æ¬¡å†…å­˜ç¢ç‰‡çš„æ•´ç†
-XX:CMSFullGCsBeforeCompactionï¼šè®¾å®šè¿›è¡Œå¤šå°‘æ¬¡ CMS åƒåœ¾å›æ”¶åï¼Œè¿›è¡Œä¸€æ¬¡å†…å­˜å‹ç¼©
-XX:+CMSClassUnloadingEnabledï¼šå…è®¸å¯¹ç±»å…ƒæ•°æ®è¿›è¡Œå›æ”¶
-XX:CMSInitiatingPermOccupancyFractionï¼šå½“æ°¸ä¹…åŒºå ç”¨ç‡è¾¾åˆ°è¿™ä¸€ç™¾åˆ†æ¯”æ—¶ï¼Œå¯åŠ¨ CMS å›æ”¶
-XX:UseCMSInitiatingOccupancyOnlyï¼šè¡¨ç¤ºåªåœ¨åˆ°è¾¾é˜€å€¼çš„æ—¶å€™ï¼Œæ‰è¿›è¡Œ CMS å›æ”¶

## [volatile çŸ¥è¯†ç‚¹æ±‡æ€»ï¼šæŒæ¡å¹¶å‘ç¼–ç¨‹åˆ©å™¨](https://blog.dong4j.site/posts/8705625e.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

volatile å…³é”®å­—çš„ 2 ä¸ªè¯­ä¹‰

- å†…å­˜å¯è§æ€§
- é˜»æ­¢é‡æ’åº

volatile ä¸èƒ½ä¿è¯åŸå­æ€§

<!-- more -->

**volatile å…³é”®å­—çš„ 2 å±‚å«ä¹‰:**

ç”¨ volatile ä¿®é¥°çš„å˜é‡, çº¿ç¨‹åœ¨æ¯æ¬¡ä½¿ç”¨å˜é‡çš„æ—¶å€™, éƒ½ä¼šè¯»å–å˜é‡ä¿®æ”¹åçš„æœ€æ–°çš„å€¼.
ä½œä¸ºæŒ‡ä»¤å…³é”®å­—, ç¡®ä¿æœ¬æ¡æŒ‡ä»¤ä¸ä¼šå› ç¼–è¯‘å™¨çš„ä¼˜åŒ–è€Œçœç•¥, ä¸”è¦æ±‚æ¯æ¬¡ç›´æ¥è¯»å€¼.

## å¯è§æ€§

å¯è§æ€§æ˜¯æŒ‡ å½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†ä¸€ä¸ªå…±äº«å˜é‡, å…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹åˆ»å¾—çŸ¥è¿™ä¸ªä¿®æ”¹.
è¿™é‡Œæœ‰å¿…è¦äº†è§£ä¸€ä¸‹ Java çš„å†…å­˜æ¨¡å‹

![20241229154732_INvb9WUG.webp](https://cdn.dong4j.site/source/image/20241229154732_INvb9WUG.webp)

è¢« volatile ä¿®é¥°çš„å˜é‡, å½“çº¿ç¨‹éœ€è¦ä½¿ç”¨è¿™ä¸ªå˜é‡æ—¶, å›å»ä¸»å†…å­˜ä¸­è¯»å–, ç„¶ååŠ è½½åˆ°è‡ªå·±çš„å·¥ä½œçº¿ç¨‹ä¸­,
å·¥ä½œçº¿ç¨‹ä¸­çš„å˜é‡åªæ˜¯ä¸»å­˜å˜é‡çš„ä¸€ä¸ªæ‹·è´, å½“ä½¿ç”¨å®Œè¿™ä¸ªå˜é‡å, ä¼šåˆ·æ–°ä¼šä¸»å­˜ä¸­.

![20241229154732_dptrw0mD.webp](https://cdn.dong4j.site/source/image/20241229154732_dptrw0mD.webp)

å½“æ•°æ®ä¸­ä¸»å†…å­˜å¤åˆ¶åˆ°å·¥ä½œå†…å­˜å­˜å‚¨æ—¶, å¿…é¡»å‡ºç°ä¸¤ä¸ªåŠ¨ä½œ:

1. ç”±ä¸»å†…å­˜æ‰§è¡Œçš„ read æ“ä½œ
2. æœ‰å·¥ä½œå†…å­˜æ‰§è¡Œç›¸åº”çš„ load æ“ä½œ

å½“æ•°æ®ä»å·¥ä½œå†…å­˜æ‹·è´åˆ°ä¸»å†…å­˜æ—¶, ä¹Ÿä¼šæœ‰ä¸¤ä¸ªæ“ä½œ:

1. ç”¨å·¥ä½œå†…å­˜æ‰§è¡Œçš„ store æ“ä½œ
2. ç”¨ä¸»å†…å­˜æ‰§è¡Œç›¸åº”çš„ write æ“ä½œ

volatile çš„ç‰¹æ®Šè§„åˆ™å°±æ˜¯ readã€loadã€use å¿…é¡»è¿ç»­å‡ºç°. assignã€storeã€write åŠ¨ä½œå¿…é¡»è¿ç»­å‡ºç°. æ‰€ä»¥ä½¿ç”¨ volatile å˜é‡èƒ½å¤Ÿä¿è¯å¿…é¡»å…ˆä»ä¸»å†…å­˜åˆ·æ–°æœ€æ–°çš„å€¼,
æ¯æ¬¡ä¿®æ”¹åå¿…é¡»ç«‹å³åŒæ­¥å›ä¸»å†…å­˜å½“ä¸­.

æ‰€ä»¥ colatile çš„å¯è§æ€§å¾ˆé€‚åˆç”¨æ¥æ§åˆ¶å¹¶å‘:

```java
public class VolatileDemo {
	private static volatile boolean flag;
	public static void shutdown(){
		flag=true;
	}
	public static void main(String[] args) throws InterruptedException{
		VolatileDemo m = new VolatileDemo();
		for(int i=0;i<20;i++){
			new Thread(new Runnable() {
				public void run() {
					while(!flag){
						  System.out.println("aaa");
					}
				}
			}).start();
		}
		Thread.sleep(2000);
		shutdown();
	}
}
```

å½“è°ƒç”¨ shutdown() æ—¶, èƒ½ä¿è¯æ‰€æœ‰çº¿ç¨‹ç«‹åˆ»åœæ­¢.

## volatile çš„ç¦æ­¢æŒ‡ä»¤é‡æ’åº

æŒ‡ä»¤é‡æ’æ˜¯ ç¼–è¯‘å™¨å’Œ cup åœ¨ä¸å½±å“æ‰§è¡Œç»“æœçš„æƒ…å†µä¸‹, è¿›è¡Œçš„ä¸€ç§ä¼˜åŒ–ç­–ç•¥.

åœ¨ Java ä¸­æ™®éçš„å˜é‡ä»…ä»…ä¼šä¿è¯åœ¨è¯¥æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€æœ‰ä¾èµ–çš„èµ‹å€¼ç»“æœçš„åœ°æ–¹éƒ½èƒ½è·å–åˆ°æ­£ç¡®çš„ç»“æœ, è€Œä¸èƒ½ä¿è¯å˜é‡èµ‹å€¼æ“ä½œçš„é¡ºåºä¸ç¨‹åºä»£ç ä¸­çš„æ‰§è¡Œé¡ºåºä¸€è‡´.
å› ä¸ºåœ¨ä¸€ä¸ªçº¿ç¨‹çš„æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­æ— æ³•æ„ŸçŸ¥åˆ°è¿™ç‚¹, è¿™ä¹Ÿå°±æ˜¯ Java å†…å­˜æ¨¡å‹ä¸­æè¿°çš„æ‰€è°“â€œçº¿ç¨‹å†…è¡¨ç°ä¸ºä¸²è¡Œçš„è¯­ä¹‰â€.

### æœ‰åºæ€§

è®¡ç®—æœºåœ¨æ‰§è¡Œä»£ç æ—¶, ä¸ä¸€å®šæŒ‰ç…§ç¨‹åºçš„é¡ºåºæ¥æ‰§è¡Œ.

```java
class OrderExample {
	int a = 0;
	boolean flag = false;
	public void writer() {
		a = 1;
		flag = true;
	}
	public void reader() {
		if (flag) {
			int i = a +1;
		}
	}
}
```

æ¯”å¦‚ä¸Šè¿°ä»£ç , ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«è¢«ä¸¤ä¸ªçº¿ç¨‹è°ƒç”¨.
æŒ‰ç…§å¸¸ç†, å†™çº¿ç¨‹åº”è¯¥å…ˆæ‰§è¡Œ a=1, å†æ‰§è¡Œ flag=true.
å½“è¯»çº¿ç¨‹è¿›è¡Œè¯»çš„æ—¶å€™, i=2ï¼›
ä½†æ˜¯å› ä¸º a=1 å’Œ flag=true, å¹¶æ²¡æœ‰é€»è¾‘ä¸Šçš„å…³è”.
æ‰€ä»¥æœ‰å¯èƒ½æ‰§è¡Œçš„é¡ºåºé¢ å€’, æœ‰å¯èƒ½å…ˆæ‰§è¡Œ flag=true, å†æ‰§è¡Œ a=1.
è¿™æ—¶å½“ flag=true æ—¶, åˆ‡æ¢åˆ°è¯»çº¿ç¨‹, æ­¤æ—¶ a=1 è¿˜æ²¡æœ‰æ‰§è¡Œ, é‚£ä¹ˆè¯»çº¿ç¨‹å°† i=1.

**æŒ‡ä»¤é‡æ’å¯ä»¥ä½¿æµæ°´çº¿æ›´åŠ é¡ºç•…**

å½“ç„¶æŒ‡ä»¤é‡æ’çš„åŸåˆ™æ˜¯ä¸èƒ½ç ´åä¸²è¡Œç¨‹åºçš„è¯­ä¹‰, ä¾‹å¦‚ a=1,b=a+1, è¿™ç§æŒ‡ä»¤å°±ä¸ä¼šé‡æ’äº†, å› ä¸ºé‡æ’çš„ä¸²è¡Œç»“æœå’ŒåŸå…ˆçš„ä¸åŒ.

åœ¨ Java é‡Œé¢, å¯ä»¥é€šè¿‡ volatile å…³é”®å­—æ¥ä¿è¯ä¸€å®šçš„â€œæœ‰åºæ€§â€. å¦å¤–å¯ä»¥é€šè¿‡ synchronized å’Œ Lock æ¥ä¿è¯æœ‰åºæ€§, å¾ˆæ˜¾ç„¶, synchronized å’Œ Lock
ä¿è¯æ¯ä¸ªæ—¶åˆ»æ˜¯æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒæ­¥ä»£ç , ç›¸å½“äºæ˜¯è®©çº¿ç¨‹é¡ºåºæ‰§è¡ŒåŒæ­¥ä»£ç , è‡ªç„¶å°±ä¿è¯äº†æœ‰åºæ€§.

### Happen-Before

Java å†…å­˜æ¨¡å‹å…·å¤‡ä¸€äº›å…ˆå¤©çš„â€œæœ‰åºæ€§â€, å³ä¸éœ€è¦é€šè¿‡ä»»ä½•æ‰‹æ®µå°±èƒ½å¤Ÿå¾—åˆ°ä¿è¯çš„æœ‰åºæ€§, è¿™ä¸ªé€šå¸¸ä¹Ÿç§°ä¸º happen-before åŸåˆ™. å¦‚æœä¸¤ä¸ªæ“ä½œçš„æ‰§è¡Œæ¬¡åºæ— æ³•ä»
happen-before åŸåˆ™æ¨å¯¼å‡ºæ¥, é‚£ä¹ˆå®ƒä»¬å°±ä¸èƒ½ä¿è¯å®ƒä»¬çš„æœ‰åºæ€§, è™šæ‹Ÿæœºå¯ä»¥éšæ„åœ°å¯¹å®ƒä»¬è¿›è¡Œé‡æ’åº.

- ç¨‹åºé¡ºåºåŸåˆ™: ä¸€ä¸ªçº¿ç¨‹å†…ä¿è¯è¯­ä¹‰çš„ä¸²è¡Œæ€§ (å†™åœ¨å‰é¢çš„å…ˆå‘ç”Ÿ, ç”¨æ¥ä¿è¯å•çº¿ç¨‹ç»“æœçš„æ­£ç¡®æ€§)
- volatile è§„åˆ™: volatile å˜é‡çš„å†™, å…ˆå‘ç”Ÿäºè¯», è¿™ä¿è¯äº† volatile å˜é‡çš„å¯è§æ€§
- é”è§„åˆ™: è§£é”ï¼ˆunlockï¼‰å¿…ç„¶å‘ç”Ÿåœ¨éšåçš„åŠ é”ï¼ˆlockï¼‰å‰
- ä¼ é€’æ€§: A å…ˆäº B, B å…ˆäº C, é‚£ä¹ˆ A å¿…ç„¶å…ˆäº C
- çº¿ç¨‹çš„ start() æ–¹æ³•å…ˆäºå®ƒçš„æ¯ä¸€ä¸ªåŠ¨ä½œ
- çº¿ç¨‹çš„æ‰€æœ‰æ“ä½œå…ˆäºçº¿ç¨‹çš„ç»ˆç»“ï¼ˆThread.join()ï¼‰
- çº¿ç¨‹çš„ä¸­æ–­ï¼ˆinterrupt()ï¼‰å…ˆäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç 
- å¯¹è±¡çš„æ„é€ å‡½æ•°æ‰§è¡Œç»“æŸå…ˆäº finalize() æ–¹æ³•

**ä¸ºä»€ä¹ˆ Happen-Before åŸåˆ™ä¸è¢«æŒ‡ä»¤é‡æ’å½±å“?**
ä¾‹å¦‚ä½ è®©ä¸€ä¸ª volatile çš„ integer è‡ªå¢ï¼ˆi++ï¼‰, å…¶å®è¦åˆ†æˆ 3 æ­¥: 1ï¼‰è¯»å– volatile å˜é‡å€¼åˆ° localï¼› 2ï¼‰å¢åŠ å˜é‡çš„å€¼ï¼›3ï¼‰æŠŠ local çš„å€¼å†™å›, è®©å…¶å®ƒçš„çº¿ç¨‹å¯è§.
è¿™ 3 æ­¥çš„ jvm æŒ‡ä»¤ä¸º:

```
mov
0xc(%r10),%r8d
 ; Load
inc
 %r8d           ; Increment
mov
 %r8d,0xc(%r10)
 ; Store
lock
 addl $0x0,(%rsp)
 ; StoreLoad Barrier
```

StoreLoad Barrier å°±æ˜¯å†…å­˜å±éšœ

å†…å­˜å±éšœï¼ˆmemory barrierï¼‰æ˜¯ä¸€ä¸ª CPU æŒ‡ä»¤. åŸºæœ¬ä¸Š, å®ƒæ˜¯è¿™æ ·ä¸€æ¡æŒ‡ä»¤:

1. ç¡®ä¿ä¸€äº›ç‰¹å®šæ“ä½œæ‰§è¡Œçš„é¡ºåºï¼›
2. å½±å“ä¸€äº›æ•°æ®çš„å¯è§æ€§ (å¯èƒ½æ˜¯æŸäº›æŒ‡ä»¤æ‰§è¡Œåçš„ç»“æœ).

ç¼–è¯‘å™¨å’Œ CPU å¯ä»¥åœ¨ä¿è¯è¾“å‡ºç»“æœä¸€æ ·çš„æƒ…å†µä¸‹å¯¹æŒ‡ä»¤é‡æ’åº, ä½¿æ€§èƒ½å¾—åˆ°ä¼˜åŒ–.
æ’å…¥ä¸€ä¸ªå†…å­˜å±éšœ, ç›¸å½“äºå‘Šè¯‰ CPU å’Œç¼–è¯‘å™¨å…ˆäºè¿™ä¸ªå‘½ä»¤çš„å¿…é¡»å…ˆæ‰§è¡Œ, åäºè¿™ä¸ªå‘½ä»¤çš„å¿…é¡»åæ‰§è¡Œ.

å†…å­˜å±éšœå¦ä¸€ä¸ªä½œç”¨æ˜¯å¼ºåˆ¶æ›´æ–°ä¸€æ¬¡ä¸åŒ CPU çš„ç¼“å­˜.

ä¾‹å¦‚, ä¸€ä¸ªå†™å±éšœä¼šæŠŠè¿™ä¸ªå±éšœå‰å†™å…¥çš„æ•°æ®åˆ·æ–°åˆ°ç¼“å­˜, è¿™æ ·ä»»ä½•è¯•å›¾è¯»å–è¯¥æ•°æ®çš„çº¿ç¨‹å°†å¾—åˆ°æœ€æ–°å€¼, è€Œä¸ç”¨è€ƒè™‘åˆ°åº•æ˜¯è¢«å“ªä¸ª cpu æ ¸å¿ƒæˆ–è€…å“ªé¢— CPU
æ‰§è¡Œçš„.

**å†…å­˜å±éšœå’Œ volatile çš„å…³ç³»**

ä¸Šé¢çš„è™šæ‹ŸæœºæŒ‡ä»¤é‡Œé¢æœ‰æåˆ°, å¦‚æœä½ çš„å­—æ®µæ˜¯ volatile, Java å†…å­˜æ¨¡å‹å°†åœ¨å†™æ“ä½œåæ’å…¥ä¸€ä¸ª **å†™å±éšœæŒ‡ä»¤**, åœ¨è¯»æ“ä½œå‰æ’å…¥ä¸€ä¸ª **è¯»å±éšœæŒ‡ä»¤**.
è¿™æ„å‘³ç€å¦‚æœä½ å¯¹ä¸€ä¸ª volatile å­—æ®µè¿›è¡Œå†™æ“ä½œ, ä½ å¿…é¡»çŸ¥é“:

1. ä¸€æ—¦ä½ å®Œæˆå†™å…¥, ä»»ä½•è®¿é—®è¿™ä¸ªå­—æ®µçš„çº¿ç¨‹å°†ä¼šå¾—åˆ°æœ€æ–°çš„å€¼.
2. åœ¨ä½ å†™å…¥å‰, ä¼šä¿è¯æ‰€æœ‰ä¹‹å‰å‘ç”Ÿçš„äº‹å·²ç»å‘ç”Ÿ, å¹¶ä¸”ä»»ä½•æ›´æ–°è¿‡çš„æ•°æ®å€¼ä¹Ÿæ˜¯å¯è§çš„, å› ä¸ºå†…å­˜å±éšœä¼šæŠŠä¹‹å‰çš„å†™å…¥å€¼éƒ½åˆ·æ–°åˆ°ç¼“å­˜.

æ˜ç™½äº†å†…å­˜å±éšœè¿™ä¸ª CPU æŒ‡ä»¤, å›åˆ°å‰é¢çš„ JVM æŒ‡ä»¤: ä» load åˆ° use åˆ° assign åˆ° store åˆ°å†…å­˜å±éšœ, ä¸€å…± 4 æ­¥, å…¶ä¸­æœ€åä¸€æ­¥ jvm
è®©è¿™ä¸ªæœ€æ–°çš„å˜é‡çš„å€¼åœ¨æ‰€æœ‰çº¿ç¨‹å¯è§, ä¹Ÿå°±æ˜¯æœ€åä¸€æ­¥è®©æ‰€æœ‰çš„ CPU å†…æ ¸éƒ½è·å¾—äº†æœ€æ–°çš„å€¼, ä½†ä¸­é—´çš„å‡ æ­¥ï¼ˆä» Load åˆ° Storeï¼‰æ˜¯ä¸å®‰å…¨çš„, ä¸­é—´å¦‚æœå…¶ä»–çš„
CPU ä¿®æ”¹äº†å€¼å°†ä¼šä¸¢å¤±.

### volatile ç¦æ­¢æŒ‡ä»¤é‡æ’çš„ä¸¤å±‚å«ä¹‰

1. å½“ç¨‹åºæ‰§è¡Œåˆ° volatile å˜é‡çš„è¯»æ“ä½œæˆ–è€…å†™æ“ä½œæ—¶, åœ¨å…¶å‰é¢çš„æ“ä½œè‚¯å®šå·²ç»å…¨éƒ¨è¿›è¡Œ, ä¸”ç»“æœå¯¹åé¢çš„æ“ä½œå¯è§; ä¸”åé¢çš„æ“ä½œè¿˜æ²¡æœ‰è¿›è¡Œ;
2. åœ¨è¿›è¡ŒæŒ‡ä»¤ä¼˜åŒ–æ—¶, ä¸èƒ½å°†å¯¹ volatile å˜é‡çš„è®¿é—®è¯­å¥æ”¾åœ¨æ°”å€™æ‰§è¡Œ, ä¹Ÿä¸èƒ½æŠŠ volatile å˜é‡åé¢çš„è¯­å¥æ”¾åœ¨å…¶å‰é¢æ‰§è¡Œ.

```java
// xã€y ä¸ºé volatile å˜é‡
// flag ä¸º volatile å˜é‡
x = 2;          // è¯­å¥ 1
y = 0;          // è¯­å¥ 2
flag = true;  // è¯­å¥ 3
x = 4;          // è¯­å¥ 4
y = -1;         // è¯­å¥ 5
```

ç”±äº flag å˜é‡ä¸º volatile å˜é‡, é‚£ä¹ˆåœ¨è¿›è¡ŒæŒ‡ä»¤é‡æ’åºçš„è¿‡ç¨‹çš„æ—¶å€™, ä¸ä¼šå°†è¯­å¥ 3 æ”¾åˆ°è¯­å¥ 1ã€è¯­å¥ 2 å‰é¢, ä¹Ÿä¸ä¼šè®²è¯­å¥ 3 æ”¾åˆ°è¯­å¥ 4ã€è¯­å¥ 5 åé¢.
ä½†æ˜¯è¦æ³¨æ„è¯­å¥ 1 å’Œè¯­å¥ 2 çš„é¡ºåºã€è¯­å¥ 4 å’Œè¯­å¥ 5 çš„é¡ºåºæ˜¯ä¸ä½œä»»ä½•ä¿è¯çš„.

å¹¶ä¸” volatile å…³é”®å­—èƒ½ä¿è¯, æ‰§è¡Œåˆ°è¯­å¥ 3 æ—¶, è¯­å¥ 1 å’Œè¯­å¥ 2 å¿…å®šæ˜¯æ‰§è¡Œå®Œæ¯•äº†çš„, ä¸”è¯­å¥ 1 å’Œè¯­å¥ 2 çš„æ‰§è¡Œç»“æœå¯¹è¯­å¥ 3ã€è¯­å¥ 4ã€è¯­å¥ 5 æ˜¯å¯è§çš„

## vloatile çš„å¹¶å‘é—®é¢˜

volatile èƒ½ä¿è¯å¯è§æ€§å’Œç¦æ­¢æŒ‡ä»¤é‡æ’, ä½†æ˜¯å´ä¸èƒ½ä¿è¯åŸå­æ€§,
å…¶å®é€šè¿‡ä¸Šé¢çš„åˆ†æä¹Ÿèƒ½å¾—å‡ºè¿™ä¸ªç»“è®º.

æ¯”å¦‚ i++ æ“ä½œ:

1. è¯»å– volatile å˜é‡å€¼åˆ°å½“å‰çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­
2. è¿›è¡Œ i+1 è®¡ç®—
3. å°†å·¥ä½œå†…å­˜ä¸­çš„å€¼å†™ä¼šåˆ°ä¸»å†…å­˜, è®©å…¶ä»–çº¿ç¨‹å¯è§

ç°åœ¨æœ‰ 2 ä¸ªçº¿ç¨‹åŒæ—¶å¯¹ volatile å˜é‡è¿›è¡Œæ“ä½œ,
å½“ç¬¬ä¸€ä¸ªå˜é‡ä»ä¸»å†…å­˜ä¸­è¯»å–äº†å˜é‡, ä½†æ˜¯è¿˜æœªè¿›è¡Œ i+1 æ“ä½œ,
æ­¤æ—¶ç¬¬äºŒä¸ªçº¿ç¨‹ä¹Ÿä»ä¸»å­˜ä¸­è¯»å–äº†è¿™ä¸ªå˜é‡, ä½†æ˜¯å’Œçº¿ç¨‹ä¸€è¯»å–çš„å€¼ä¸€æ ·, å› ä¸ºçº¿ç¨‹ä¸€è¿˜æœªå°†è®¡ç®—è¿‡çš„å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­, æ­¤æ—¶ 2 ä¸ªçº¿ç¨‹éƒ½å¯¹å˜é‡è¿›è¡Œ +1 æ“ä½œ,
ç„¶ååˆ·æ–°åˆ°ä¸»å†…å­˜, æ­¤æ—¶, ä¸»å†…å­˜ä¸­çš„å€¼åªæ˜¯åšäº†ä¸€æ¬¡ +1 æ“ä½œ, è€Œä¸æ˜¯ 2 æ¬¡.

**æŸä¸ªçº¿ç¨‹å°†ä¸€ä¸ªå…±äº«å€¼ä¼˜åŒ–åˆ°äº†å†…å­˜ä¸­, è€Œå¦ä¸€ä¸ªçº¿ç¨‹å°†è¿™ä¸ªå…±äº«å€¼ä¼˜åŒ–åˆ°äº†ç¼“å­˜ä¸­, å½“ä¿®æ”¹å†…å­˜ä¸­å€¼çš„æ—¶å€™, ç¼“å­˜ä¸­çš„å€¼æ˜¯ä¸çŸ¥é“è¿™ä¸ªä¿®æ”¹çš„.**

## [æŒæ¡JavaåŒæ­¥æœºåˆ¶ï¼šç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼å®æˆ˜](https://blog.dong4j.site/posts/d3a1d32e.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜æ˜¯ç ”ç©¶å¤šçº¿ç¨‹ç¨‹åºæ—¶ç»•ä¸å¼€çš„ç»å…¸é—®é¢˜ä¹‹ä¸€, å®ƒæè¿°æ˜¯æœ‰ä¸€å—ç¼“å†²åŒºä½œä¸ºä»“åº“, ç”Ÿäº§è€…å¯ä»¥å°†äº§å“æ”¾å…¥ä»“åº“, æ¶ˆè´¹è€…åˆ™å¯ä»¥ä»ä»“åº“ä¸­å–èµ°äº§å“

<!-- more -->

## ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜

ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜æ˜¯ç ”ç©¶å¤šçº¿ç¨‹ç¨‹åºæ—¶ç»•ä¸å¼€çš„ç»å…¸é—®é¢˜ä¹‹ä¸€, å®ƒæè¿°æ˜¯æœ‰ä¸€å—ç¼“å†²åŒºä½œä¸ºä»“åº“, ç”Ÿäº§è€…å¯ä»¥å°†äº§å“æ”¾å…¥ä»“åº“, æ¶ˆè´¹è€…åˆ™å¯ä»¥ä»ä»“åº“ä¸­å–èµ°äº§å“.
è§£å†³ç”Ÿäº§è€… / æ¶ˆè´¹è€…é—®é¢˜çš„æ–¹æ³•å¯åˆ†ä¸ºä¸¤ç±»:

1. é‡‡ç”¨æŸç§æœºåˆ¶ä¿æŠ¤ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„åŒæ­¥ï¼›
2. åœ¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´å»ºç«‹ä¸€ä¸ªç®¡é“.

ç¬¬ä¸€ç§æ–¹å¼æœ‰è¾ƒé«˜çš„æ•ˆç‡, å¹¶ä¸”æ˜“äºå®ç°, ä»£ç çš„å¯æ§åˆ¶æ€§è¾ƒå¥½, å±äºå¸¸ç”¨çš„æ¨¡å¼. ç¬¬äºŒç§ç®¡é“ç¼“å†²åŒºä¸æ˜“æ§åˆ¶, è¢«ä¼ è¾“æ•°æ®å¯¹è±¡ä¸æ˜“äºå°è£…ç­‰, å®ç”¨æ€§ä¸å¼º.

åŒæ­¥é—®é¢˜æ ¸å¿ƒåœ¨äº:
å¦‚ä½•ä¿è¯åŒä¸€èµ„æºè¢«å¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®æ—¶çš„å®Œæ•´æ€§.
å¸¸ç”¨çš„åŒæ­¥æ–¹æ³•æ˜¯é‡‡ç”¨ä¿¡å·æˆ–åŠ é”æœºåˆ¶, ä¿è¯èµ„æºåœ¨ä»»æ„æ—¶åˆ»è‡³å¤šè¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®.
Java è¯­è¨€åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸Šå®ç°äº†å®Œå…¨å¯¹è±¡åŒ–, æä¾›äº†å¯¹åŒæ­¥æœºåˆ¶çš„è‰¯å¥½æ”¯æŒ.
åœ¨ Java ä¸­ä¸€å…±æœ‰äº”ç§æ–¹æ³•æ”¯æŒåŒæ­¥, å…¶ä¸­å‰å››ä¸ªæ˜¯åŒæ­¥æ–¹æ³•, ä¸€ä¸ªæ˜¯ç®¡é“æ–¹æ³•.

- wait()/ notify() æ–¹æ³•
- await()/ signal() æ–¹æ³•
- BlockingQueue é˜»å¡é˜Ÿåˆ—æ–¹æ³•
- Semaphore æ–¹æ³•
- PipedInputStream / PipedOutputStream

### wait()/ notify() æ–¹æ³•

wait()/ nofity() æ–¹æ³•æ˜¯åŸºç±» Object çš„ä¸¤ä¸ªæ–¹æ³•, ä¹Ÿå°±æ„å‘³ç€æ‰€æœ‰ Java ç±»éƒ½ä¼šæ‹¥æœ‰è¿™ä¸¤ä¸ªæ–¹æ³•, è¿™æ ·, æˆ‘ä»¬å°±å¯ä»¥ä¸ºä»»ä½•å¯¹è±¡å®ç°åŒæ­¥æœºåˆ¶.

wait() æ–¹æ³•: å½“ç¼“å†²åŒºå·²æ»¡ / ç©ºæ—¶, ç”Ÿäº§è€… / æ¶ˆè´¹è€…çº¿ç¨‹åœæ­¢è‡ªå·±çš„æ‰§è¡Œ, æ”¾å¼ƒé”, ä½¿è‡ªå·±å¤„äºç­‰ç­‰çŠ¶æ€, è®©å…¶ä»–çº¿ç¨‹æ‰§è¡Œ.

notify() æ–¹æ³•: å½“ç”Ÿäº§è€… / æ¶ˆè´¹è€…å‘ç¼“å†²åŒºæ”¾å…¥ / å–å‡ºä¸€ä¸ªäº§å“æ—¶, å‘å…¶ä»–ç­‰å¾…çš„çº¿ç¨‹å‘å‡ºå¯æ‰§è¡Œçš„é€šçŸ¥, åŒæ—¶æ”¾å¼ƒé”, ä½¿è‡ªå·±å¤„äºç­‰å¾…çŠ¶æ€.

```java
public class Hosee {
    private static       Integer count = 0;
    private static final Integer FULL  = 10;
    private static final String  LOCK  = "LOCK";

    // ç”Ÿäº§è€…
    class Producer implements Runnable {
        public void run() {
            for (int i = 0; i < 10; i++) {
                try {
                    Thread.sleep(3000);
                } catch (Exception e) {
                    e.printStackTrace();
                }
                synchronized (LOCK) {
                    while (count.equals(FULL)) {
                        try {
                            // é‡Šæ”¾é”, è¿›å»ç­‰å¾…æ± ç­‰å¾…å”¤é†’, ç”Ÿäº§è€…åœæ­¢ç”Ÿäº§å•†å“
                            LOCK.wait();
                        } catch (Exception e) {
                            e.printStackTrace();
                        }
                    }
                    count++;
                    System.out.println(Thread.currentThread().getName() + "ç”Ÿäº§è€…ç”Ÿäº§, ç›®å‰æ€»å…±æœ‰" + count);
                    // å”¤é†’ç­‰å¾…æ± ä¸­çš„æ‰€æœ‰çº¿ç¨‹, è¿™é‡Œå”¤é†’æ¶ˆè´¹è€…æ¶ˆè´¹å•†å“
                    LOCK.notifyAll();
                }
            }
        }
    }

    // æ¶ˆè´¹è€…
    class Consumer implements Runnable {
        public void run() {
            for (int i = 0; i < 10; i++) {
                try {
                    // ä¸æ”¾å¼ƒåŒæ­¥é”
                    Thread.sleep(3000);
                } catch (InterruptedException e1) {
                    e1.printStackTrace();
                }
                synchronized (LOCK) {
                    while (count == 0) {
                        try {
                            // æ”¾å¼ƒé”, è¿›å…¥ç­‰å¾…æ± ç­‰å¾…è¢«å”¤é†’, æ¶ˆè´¹è€…åœæ­¢æ¶ˆè´¹å•†å“
                            LOCK.wait();
                        } catch (Exception e) {
                            e.printStackTrace();
                        }
                    }
                    count--;
                    System.out.println(Thread.currentThread().getName() + "æ¶ˆè´¹è€…æ¶ˆè´¹, ç›®å‰æ€»å…±æœ‰" + count);
                    // å”¤é†’ç”Ÿäº§è€…ç”Ÿäº§å•†å“
                    LOCK.notifyAll();
                }
            }
        }
    }

    public static void main(String[] args) throws Exception {
        Hosee hosee = new Hosee();
        new Thread(hosee.new Producer()).start();
        new Thread(hosee.new Consumer()).start();
        new Thread(hosee.new Producer()).start();
        new Thread(hosee.new Consumer()).start();
        new Thread(hosee.new Producer()).start();
        new Thread(hosee.new Consumer()).start();
        new Thread(hosee.new Producer()).start();
        new Thread(hosee.new Consumer()).start();
    }
}
```

### await()/ signal() æ–¹æ³•

wait()å’Œ notify() å¿…é¡»åœ¨ synchronized çš„ä»£ç å—ä¸­ä½¿ç”¨ å› ä¸ºåªæœ‰åœ¨è·å–å½“å‰å¯¹è±¡çš„é”æ—¶æ‰èƒ½è¿›è¡Œè¿™ä¸¤ä¸ªæ“ä½œ å¦åˆ™ä¼šæŠ¥å¼‚å¸¸
è€Œ await()å’Œ signal() ä¸€èˆ¬ä¸ Lock() é…åˆä½¿ç”¨.
wait æ˜¯ Object çš„æ–¹æ³•, è€Œ await åªæœ‰éƒ¨åˆ†ç±»æœ‰, å¦‚ Condition.
await()/signal() å’Œæ–°å¼•å…¥çš„é”å®šæœºåˆ¶ Lock ç›´æ¥æŒ‚é’©, å…·æœ‰æ›´å¤§çš„çµæ´»æ€§.

```java
public class Test2 {
    private static Integer   count    = 0;
    private final  Integer   FULL     = 10;
    final          Lock      lock     = new ReentrantLock();
    final          Condition NotFull  = lock.newCondition();
    final          Condition NotEmpty = lock.newCondition();

    class Producer implements Runnable {
        public void run() {
            for (int i = 0; i < 10; i++) {
                try {
                    Thread.sleep(3000);
                } catch (Exception e) {
                    e.printStackTrace();
                }
                lock.lock();
                try {
                    while (count == FULL) {
                        try {
                            NotFull.await();
                        } catch (InterruptedException e) {
                            // TODO Auto-generated catch block
                            e.printStackTrace();
                        }
                    }
                    count++;
                    System.out.println(Thread.currentThread().getName()
                            + "ç”Ÿäº§è€…ç”Ÿäº§, ç›®å‰æ€»å…±æœ‰" + count);
                    NotEmpty.signal();
                } finally {
                    lock.unlock();
                }

            }
        }
    }

    class Consumer implements Runnable {

        public void run() {
            for (int i = 0; i < 10; i++) {
                try {
                    Thread.sleep(3000);
                } catch (InterruptedException e1) {
                    e1.printStackTrace();
                }
                lock.lock();
                try {
                    while (count == 0) {
                        try {
                            NotEmpty.await();
                        } catch (Exception e) {
                            // TODO: handle exception
                            e.printStackTrace();
                        }
                    }
                    count--;
                    System.out.println(Thread.currentThread().getName()
                            + "æ¶ˆè´¹è€…æ¶ˆè´¹, ç›®å‰æ€»å…±æœ‰" + count);
                    NotFull.signal();
                } finally {
                    lock.unlock();
                }

            }

        }

    }

    public static void main(String[] args) throws Exception {
        Hosee hosee = new Hosee();
        new Thread(hosee.new Producer()).start();
        new Thread(hosee.new Consumer()).start();
        new Thread(hosee.new Producer()).start();
        new Thread(hosee.new Consumer()).start();

        new Thread(hosee.new Producer()).start();
        new Thread(hosee.new Consumer()).start();
        new Thread(hosee.new Producer()).start();
        new Thread(hosee.new Consumer()).start();
    }
}
```

### BlockingQueue é˜»å¡é˜Ÿåˆ—æ–¹æ³•

put() æ–¹æ³•: ç±»ä¼¼äºæˆ‘ä»¬ä¸Šé¢çš„ç”Ÿäº§è€…çº¿ç¨‹, å®¹é‡è¾¾åˆ°æœ€å¤§æ—¶, è‡ªåŠ¨é˜»å¡.
take() æ–¹æ³•: ç±»ä¼¼äºæˆ‘ä»¬ä¸Šé¢çš„æ¶ˆè´¹è€…çº¿ç¨‹, å®¹é‡ä¸º 0 æ—¶, è‡ªåŠ¨é˜»å¡.

```java
public class Hosee {
	private static Integer count = 0;
	final BlockingQueue<Integer> bq = new ArrayBlockingQueue<Integer>(10);
	class Producer implements Runnable {
		public void run() {
			for (int i = 0; i < 10; i++) {
				try {
					Thread.sleep(3000);
				} catch (Exception e) {
					e.printStackTrace();
				}
				try {
					bq.put(1);
					count++;
					System.out.println(Thread.currentThread().getName()
							+ "ç”Ÿäº§è€…ç”Ÿäº§, ç›®å‰æ€»å…±æœ‰" + count);
				} catch (InterruptedException e) {
					e.printStackTrace();
				}
			}
		}
	}

	class Consumer implements Runnable {
		public void run() {
			for (int i = 0; i < 10; i++) {
				try {
					Thread.sleep(3000);
				} catch (InterruptedException e1) {
					e1.printStackTrace();
				}
				try {
					bq.take();
					count--;
					System.out.println(Thread.currentThread().getName()
							+ "æ¶ˆè´¹è€…æ¶ˆè´¹, ç›®å‰æ€»å…±æœ‰" + count);
				} catch (Exception e) {
					e.printStackTrace();
				}
			}
		}

	}

	public static void main(String[] args) throws Exception {
		Hosee hosee = new Hosee();
		new Thread(hosee.new Producer()).start();
		new Thread(hosee.new Consumer()).start();
		new Thread(hosee.new Producer()).start();
		new Thread(hosee.new Consumer()).start();
		new Thread(hosee.new Producer()).start();
		new Thread(hosee.new Consumer()).start();
		new Thread(hosee.new Producer()).start();
		new Thread(hosee.new Consumer()).start();
	}
}
```

### Semaphore æ–¹æ³•

Semaphore ä¿¡å·é‡, å°±æ˜¯ä¸€ä¸ªå…è®¸å®ç°è®¾ç½®å¥½çš„ä»¤ç‰Œ. ä¹Ÿè®¸æœ‰ 1 ä¸ª, ä¹Ÿè®¸æœ‰ 10 ä¸ªæˆ–æ›´å¤š.
è°æ‹¿åˆ°ä»¤ç‰Œ (acquire) å°±å¯ä»¥å»æ‰§è¡Œäº†, å¦‚æœæ²¡æœ‰ä»¤ç‰Œåˆ™éœ€è¦ç­‰å¾….
æ‰§è¡Œå®Œæ¯•, ä¸€å®šè¦å½’è¿˜ (release) ä»¤ç‰Œ, å¦åˆ™ä»¤ç‰Œä¼šè¢«å¾ˆå¿«ç”¨å…‰, åˆ«çš„çº¿ç¨‹å°±æ— æ³•è·å¾—ä»¤ç‰Œè€Œæ‰§è¡Œä¸‹å»äº†

```java
public class Hosee{
	int count = 0;
	final Semaphore notFull = new Semaphore(10);
	final Semaphore notEmpty = new Semaphore(0);
	final Semaphore mutex = new Semaphore(1);
	class Producer implements Runnable{
		public void run(){
			for (int i = 0; i < 10; i++){
				try{
					Thread.sleep(3000);
				}
				catch (Exception e){
					e.printStackTrace();
				}
				try{
					notFull.acquire();// é¡ºåºä¸èƒ½é¢ å€’, å¦åˆ™ä¼šé€ æˆæ­»é”.
					mutex.acquire();
					count++;
					System.out.println(Thread.currentThread().getName()
							+ "ç”Ÿäº§è€…ç”Ÿäº§, ç›®å‰æ€»å…±æœ‰" + count);
				}
				catch (Exception e){
					e.printStackTrace();
				}
				finally{
					mutex.release();
					notEmpty.release();
				}
			}
		}
	}

	class Consumer implements Runnable{
		public void run(){
			for (int i = 0; i < 10; i++){
				try{
					Thread.sleep(3000);
				}
				catch (InterruptedException e1){
					e1.printStackTrace();
				}
				try{
					notEmpty.acquire();// é¡ºåºä¸èƒ½é¢ å€’, å¦åˆ™ä¼šé€ æˆæ­»é”.
					mutex.acquire();
					count--;
					System.out.println(Thread.currentThread().getName()
							+ "æ¶ˆè´¹è€…æ¶ˆè´¹, ç›®å‰æ€»å…±æœ‰" + count);
				}
				catch (Exception e){
					e.printStackTrace();
				}
				finally{
					mutex.release();
					notFull.release();
				}
			}
		}
	}
	public static void main(String[] args) throws Exception{
		Hosee hosee = new Hosee();
		new Thread(hosee.new Producer()).start();
		new Thread(hosee.new Consumer()).start();
		new Thread(hosee.new Producer()).start();
		new Thread(hosee.new Consumer()).start();
		new Thread(hosee.new Producer()).start();
		new Thread(hosee.new Consumer()).start();
		new Thread(hosee.new Producer()).start();
		new Thread(hosee.new Consumer()).start();
	}
}
```

### PipedInputStream / PipedOutputStream

è¿™ä¸ªç±»ä½äº java.io åŒ…ä¸­, æ˜¯è§£å†³åŒæ­¥é—®é¢˜çš„æœ€ç®€å•çš„åŠæ³•, ä¸€ä¸ªçº¿ç¨‹å°†æ•°æ®å†™å…¥ç®¡é“, å¦ä¸€ä¸ªçº¿ç¨‹ä»ç®¡é“è¯»å–æ•°æ®, è¿™æ ·ä¾¿æ„æˆäº†ä¸€ç§ç”Ÿäº§è€… /
æ¶ˆè´¹è€…çš„ç¼“å†²åŒºç¼–ç¨‹æ¨¡å¼. PipedInputStream/PipedOutputStream åªèƒ½ç”¨äºå¤šçº¿ç¨‹æ¨¡å¼, ç”¨äºå•çº¿ç¨‹ä¸‹å¯èƒ½ä¼šå¼•å‘æ­»é”.

```java
public class Hosee {
	final PipedInputStream pis = new PipedInputStream();
	final PipedOutputStream pos = new PipedOutputStream();
	{
		try {
			pis.connect(pos);
		} catch (IOException e) {
			e.printStackTrace();
		}
	}

	class Producer implements Runnable {
		@Override
		public void run() {
			try{
                while(true){
                    int b = (int) (Math.random() * 255);
                    System.out.println("Producer: a byte, the value is " + b);
                    pos.write(b);
                    pos.flush();
                }
            }catch(Exception e){
                e.printStackTrace();
            }finally{
                try{
                    pos.close();
                    pis.close();
                }catch(IOException e){
                    System.out.println(e);
                }
            }
		}
	}

	class Consumer implements Runnable {

		@Override
		public void run() {
			try{
                while(true){
                    int b = pis.read();
                    System.out.println("Consumer: a byte, the value is " + String.valueOf(b));
                }
            }catch(Exception e){
                e.printStackTrace();
            }finally{
                try{
                    pos.close();
                    pis.close();
                }catch(IOException e){
                    System.out.println(e);
                }
            }
		}

	}

	public static void main(String[] args) throws Exception {
		Hosee hosee = new Hosee();
		new Thread(hosee.new Producer()).start();
		new Thread(hosee.new Consumer()).start();
	}
}
```

## [Java å¤šçº¿ç¨‹å…¥é—¨ï¼šä»æ¦‚å¿µåˆ°å®æˆ˜](https://blog.dong4j.site/posts/71aa5641.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

å‡ ä¸ªå¤šçº¿ç¨‹æ¦‚å¿µçš„ä»‹ç»

çº¿ç¨‹çŠ¶æ€è½¬æ¢

![20241229154732_YGh7IluL.webp](https://cdn.dong4j.site/source/image/20241229154732_YGh7IluL.webp)

- æ–°å»º (new): æ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¯¹è±¡
- å¯è¿è¡Œ (runnable)ï¼šçº¿ç¨‹å¯¹è±¡åˆ›å»ºåï¼Œå…¶ä»–çº¿ç¨‹(æ¯”å¦‚ main çº¿ç¨‹ï¼‰è°ƒç”¨äº†è¯¥å¯¹è±¡çš„ start() æ–¹æ³•ã€‚è¯¥çŠ¶æ€çš„çº¿ç¨‹ä½äºå¯è¿è¡Œçº¿ç¨‹æ± ä¸­ï¼Œç­‰å¾…è¢«çº¿ç¨‹è°ƒåº¦é€‰ä¸­ï¼Œè·å–
  cpu çš„ä½¿ç”¨æƒ ã€‚
- è¿è¡Œ (running)ï¼šå¯è¿è¡ŒçŠ¶æ€(runnable) çš„çº¿ç¨‹è·å¾—äº† cpu æ—¶é—´ç‰‡ï¼ˆtimesliceï¼‰ ï¼Œæ‰§è¡Œç¨‹åºä»£ç ã€‚
- é˜»å¡ (block)ï¼šé˜»å¡çŠ¶æ€æ˜¯æŒ‡çº¿ç¨‹å› ä¸ºæŸç§åŸå› æ”¾å¼ƒäº† cpu ä½¿ç”¨æƒï¼Œä¹Ÿå³è®©å‡ºäº† cpu timesliceï¼Œæš‚æ—¶åœæ­¢è¿è¡Œã€‚ç›´åˆ°çº¿ç¨‹è¿›å…¥å¯è¿è¡Œ(runnable) çŠ¶æ€ï¼Œæ‰æœ‰æœºä¼šå†æ¬¡è·å¾—
  cpu timeslice è½¬åˆ°è¿è¡Œ (running) çŠ¶æ€ã€‚é˜»å¡çš„æƒ…å†µåˆ†ä¸‰ç§ï¼š
  - ç­‰å¾…é˜»å¡ï¼šè¿è¡Œ (running) çš„çº¿ç¨‹æ‰§è¡Œ o.wait()æ–¹æ³•ï¼ŒJVM ä¼šæŠŠè¯¥çº¿ç¨‹æ”¾å…¥ç­‰å¾…é˜Ÿåˆ— (waitting queue) ä¸­ã€‚
  - åŒæ­¥é˜»å¡ï¼šè¿è¡Œ (running) çš„çº¿ç¨‹åœ¨è·å–å¯¹è±¡çš„åŒæ­¥é”æ—¶ï¼Œè‹¥è¯¥åŒæ­¥é”è¢«åˆ«çš„çº¿ç¨‹å ç”¨ï¼Œåˆ™ JVM ä¼šæŠŠè¯¥çº¿ç¨‹æ”¾å…¥é”æ±  (lock pool) ä¸­ã€‚
  - å…¶ä»–é˜»å¡ï¼šè¿è¡Œ (running) çš„çº¿ç¨‹æ‰§è¡Œ Thread.sleep(long ms)æˆ– t.join()æ–¹æ³•ï¼Œæˆ–è€…å‘å‡ºäº† I/O è¯·æ±‚æ—¶ï¼ŒJVM ä¼šæŠŠè¯¥çº¿ç¨‹ç½®ä¸ºé˜»å¡çŠ¶æ€ã€‚å½“ sleep()
    çŠ¶æ€è¶…æ—¶ã€join()ç­‰å¾…çº¿ç¨‹ç»ˆæ­¢æˆ–è€…è¶…æ—¶ã€æˆ–è€… I/O å¤„ç†å®Œæ¯•æ—¶ï¼Œçº¿ç¨‹é‡æ–°è½¬å…¥å¯è¿è¡Œ (runnable) çŠ¶æ€ã€‚
- æ­»äº¡ (dead)ï¼šçº¿ç¨‹ run()ã€main() æ–¹æ³•æ‰§è¡Œç»“æŸï¼Œæˆ–è€…å› å¼‚å¸¸é€€å‡ºäº† run() æ–¹æ³•ï¼Œåˆ™è¯¥çº¿ç¨‹ç»“æŸç”Ÿå‘½å‘¨æœŸã€‚æ­»äº¡çš„çº¿ç¨‹ä¸å¯å†æ¬¡å¤ç”Ÿã€‚

## æ–°å»ºçº¿ç¨‹

```java
Thread thread = new Thread();
thread.start();
```

è¿™æ ·å°±å¼€å¯äº†ä¸€ä¸ªçº¿ç¨‹ã€‚
æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯

```java
Thread thread = new Thread();
thread.run();
```

ç›´æ¥è°ƒç”¨ run æ–¹æ³•æ˜¯æ— æ³•å¼€å¯ä¸€ä¸ªæ–°çº¿ç¨‹çš„ã€‚
start æ–¹æ³•å…¶å®æ˜¯åœ¨ä¸€ä¸ªæ–°çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸Šé¢å»è°ƒç”¨ run æ–¹æ³•ã€‚æ¢å¥è¯è¯´ï¼Œç›´æ¥è°ƒç”¨ run æ–¹æ³•è€Œä¸æ˜¯è°ƒç”¨ start æ–¹æ³•çš„è¯ï¼Œå®ƒå¹¶ä¸ä¼šå¼€å¯æ–°çš„çº¿ç¨‹ï¼Œè€Œæ˜¯åœ¨è°ƒç”¨
run çš„å½“å‰çš„çº¿ç¨‹å½“ä¸­æ‰§è¡Œä½ çš„æ“ä½œã€‚

```java
Thread thread = new Thread("t1"){
	@Override
	public void run(){
		System.out.println(Thread.currentThread().getName());
	}
};
thread.start();
```

å¦‚æœè°ƒç”¨ startï¼Œåˆ™è¾“å‡ºæ˜¯ t1

```java
Thread thread = new Thread("t1"){
	@Override
	public void run(){
		System.out.println(Thread.currentThread().getName());
	}
};
thread.run();
```

å¦‚æœæ˜¯ run, åˆ™è¾“å‡º mainã€‚ï¼ˆç›´æ¥è°ƒç”¨ run å…¶å®å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„å‡½æ•°è°ƒç”¨è€Œå·²ï¼Œå¹¶æ²¡æœ‰è¾¾åˆ°å¤šçº¿ç¨‹çš„ä½œç”¨ï¼‰
run æ–¹æ³•çš„å®ç°æœ‰ä¸¤ç§æ–¹å¼

ç¬¬ä¸€ç§æ–¹å¼ï¼Œç›´æ¥è¦†ç›– run æ–¹æ³•ï¼Œå°±å¦‚åˆšåˆšä»£ç ä¸­æ‰€ç¤ºï¼Œæœ€æ–¹ä¾¿çš„ç”¨ä¸€ä¸ªåŒ¿åç±»å°±å¯ä»¥å®ç°ã€‚

```java
Thread thread = new Thread("t1")
{
	@Override
	public void run()
	{
		// TODO Auto-generated method stub
		System.out.println(Thread.currentThread().getName());
	}
};
```

ç¬¬äºŒç§æ–¹å¼

```java
# CreateThread3() å®ç°äº† Runnable æ¥å£ã€‚
Thread t1=new Thread(new CreateThread3());
```

## ç»ˆæ­¢çº¿ç¨‹

> Thread.stop() ä¸æ¨èä½¿ç”¨ã€‚å®ƒä¼šé‡Šæ”¾æ‰€æœ‰ monitor

åœ¨æºç ä¸­å·²ç»æ˜ç¡®è¯´æ˜ stop æ–¹æ³•è¢« Deprecatedï¼Œåœ¨ Javadoc ä¸­ä¹Ÿè¯´æ˜äº†åŸå› ã€‚
åŸå› åœ¨äº stop æ–¹æ³•å¤ªè¿‡"æš´åŠ›"äº†ï¼Œæ— è®ºçº¿ç¨‹æ‰§è¡Œåˆ°å“ªé‡Œï¼Œå®ƒå°†ä¼šç«‹å³åœæ­¢æ‰çº¿ç¨‹ã€‚
![20241229154732_QX4dTHlh.webp](https://cdn.dong4j.site/source/image/20241229154732_QX4dTHlh.webp)
å½“å†™çº¿ç¨‹å¾—åˆ°é”ä»¥åå¼€å§‹å†™å…¥æ•°æ®ï¼Œå†™å®Œ id = 1ï¼Œåœ¨å‡†å¤‡å°† name = 1 æ—¶è¢« stop, é‡Šæ”¾é”ã€‚è¯»çº¿ç¨‹è·å¾—é”è¿›è¡Œè¯»æ“ä½œï¼Œè¯»åˆ°çš„ id ä¸º 1ï¼Œè€Œ name è¿˜æ˜¯
0ï¼Œå¯¼è‡´äº†æ•°æ®ä¸ä¸€è‡´ã€‚
æœ€é‡è¦çš„æ˜¯è¿™ç§é”™è¯¯ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå°†å¾ˆéš¾è¢«å‘ç°ã€‚

## çº¿ç¨‹ä¸­æ–­

```java
public void Thread.interrupt() // ä¸­æ–­çº¿ç¨‹
public boolean Thread.isInterrupted() // åˆ¤æ–­æ˜¯å¦è¢«ä¸­æ–­
public static boolean Thread.interrupted() // åˆ¤æ–­æ˜¯å¦è¢«ä¸­æ–­ï¼Œå¹¶æ¸…é™¤å½“å‰ä¸­æ–­çŠ¶æ€
```

> Java çš„ä¸­æ–­æ˜¯ä¸€ç§åä½œæœºåˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´è°ƒç”¨çº¿ç¨‹å¯¹è±¡çš„ interrupt æ–¹æ³•å¹¶ä¸ä¸€å®šå°±ä¸­æ–­äº†æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œå®ƒåªæ˜¯è¦æ±‚çº¿ç¨‹è‡ªå·±åœ¨åˆé€‚çš„æ—¶æœºä¸­æ–­è‡ªå·±ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ª
> boolean çš„ä¸­æ–­çŠ¶æ€ï¼ˆä¸ä¸€å®šå°±æ˜¯å¯¹è±¡çš„å±æ€§ï¼Œäº‹å®ä¸Šï¼Œè¯¥çŠ¶æ€ä¹Ÿç¡®å®ä¸æ˜¯ Thread çš„å­—æ®µï¼‰ï¼Œinterrupt æ–¹æ³•ä»…ä»…åªæ˜¯å°†è¯¥çŠ¶æ€ç½®ä¸º trueã€‚å¯¹äºéé˜»å¡ä¸­çš„çº¿ç¨‹,
> åªæ˜¯æ”¹å˜äº†ä¸­æ–­çŠ¶æ€, å³ Thread.isInterrupted() å°†è¿”å› trueï¼Œå¹¶ä¸ä¼šä½¿ç¨‹åºåœæ­¢;

ä¼˜é›…çš„ç»ˆæ­¢çº¿ç¨‹

```java
public void run(){
    while(true){
        if(Thread.currentThread().isInterrupted()){
           System.out.println("Interruted!");
           break;
        }
        Thread.yield();
    }
}
```

å¯¹äºå¯å–æ¶ˆçš„é˜»å¡çŠ¶æ€ä¸­çš„çº¿ç¨‹, æ¯”å¦‚ç­‰å¾…åœ¨è¿™äº›å‡½æ•°ä¸Šçš„çº¿ç¨‹, Thread.sleep(), Object.wait(), Thread.join(), è¿™ä¸ªçº¿ç¨‹æ”¶åˆ°ä¸­æ–­ä¿¡å·å, ä¼šæŠ›å‡º
InterruptedException, åŒæ—¶ä¼šæŠŠä¸­æ–­çŠ¶æ€ç½®å›ä¸º false.

å¯¹äºå–æ¶ˆé˜»å¡çŠ¶æ€ä¸­çš„çº¿ç¨‹:

```java
public void run(){
    while(true){
        if(Thread.currentThread().isInterrupted()){
            System.out.println("Interruted!");
            break;
        }
        try {
           Thread.sleep(2000);
        } catch (InterruptedException e) {
           System.out.println("Interruted When Sleep");
           // è®¾ç½®ä¸­æ–­çŠ¶æ€ï¼ŒæŠ›å‡ºå¼‚å¸¸åä¼šæ¸…é™¤ä¸­æ–­æ ‡è®°ä½
           Thread.currentThread().interrupt();
        }
        Thread.yield();
    }
}
```

## çº¿ç¨‹æŒ‚èµ·

æŒ‚èµ·ï¼ˆsuspendï¼‰å’Œç»§ç»­æ‰§è¡Œï¼ˆresumeï¼‰çº¿ç¨‹

- suspend() ä¸ä¼šé‡Šæ”¾é”
- å¦‚æœåŠ é”å‘ç”Ÿåœ¨ resume() ä¹‹å‰ ï¼Œåˆ™æ­»é”å‘ç”Ÿ

è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯ Deprecated æ–¹æ³•ï¼Œä¸æ¨èä½¿ç”¨ã€‚
åŸå› åœ¨äºï¼Œsuspend ä¸é‡Šæ”¾é”ï¼Œå› æ­¤æ²¡æœ‰çº¿ç¨‹å¯ä»¥è®¿é—®è¢«å®ƒé”ä½çš„ä¸´ç•ŒåŒºèµ„æºï¼Œç›´åˆ°è¢«å…¶ä»–çº¿ç¨‹ resumeã€‚å› ä¸ºæ— æ³•æ§åˆ¶çº¿ç¨‹è¿è¡Œçš„å…ˆåé¡ºåºï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹çš„
resume æ–¹æ³•å…ˆè¢«è¿è¡Œï¼Œé‚£åˆ™åè¿è¡Œçš„ suspendï¼Œå°†ä¸€ç›´å æœ‰è¿™æŠŠé”ï¼Œé€ æˆæ­»é”å‘ç”Ÿã€‚

ä½¿ç”¨ä»£ç æ¨¡æ‹Ÿ:

```java
public class Test{
	static Object u = new Object();
	static TestSuspendThread t1 = new TestSuspendThread("t1");
	static TestSuspendThread t2 = new TestSuspendThread("t2");
	public static class TestSuspendThread extends Thread{
		public TestSuspendThread(String name){
			setName(name);
		}
		@Override
		public void run(){
			synchronized (u){
				System.out.println("in " + getName());
				Thread.currentThread().suspend();
			}
		}
	}
	public static void main(String[] args) throws InterruptedException{
		t1.start();
		Thread.sleep(100);
		t2.start();
		t1.resume();
		t2.resume();
		t1.join();
		t2.join();
	}
}
```

è®© t1,t2 åŒæ—¶äº‰å¤ºä¸€æŠŠé”ï¼Œäº‰å¤ºåˆ°çš„çº¿ç¨‹ suspendï¼Œç„¶åå† resumeï¼ŒæŒ‰ç†æ¥è¯´ï¼Œåº”è¯¥æŸä¸ªçº¿ç¨‹äº‰å¤ºåè¢« resume é‡Šæ”¾äº†é”ï¼Œç„¶åå¦ä¸€ä¸ªçº¿ç¨‹äº‰å¤ºæ‰é”ï¼Œå†è¢« resumeã€‚

```
in t1
in t2
```

è¯´æ˜ä¸¤ä¸ªçº¿ç¨‹éƒ½äº‰å¤ºåˆ°äº†é”ï¼Œä½†æ˜¯æ§åˆ¶å°çš„çº¢ç¯è¿˜æ˜¯äº®ç€çš„ï¼Œè¯´æ˜ t1,t2 ä¸€å®šæœ‰çº¿ç¨‹æ²¡æœ‰æ‰§è¡Œå®Œã€‚

## join å’Œ yeild

yeild æ˜¯ä¸ª native é™æ€æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯æƒ³æŠŠè‡ªå·±å æœ‰çš„ cpu æ—¶é—´é‡Šæ”¾æ‰ï¼Œç„¶åå’Œå…¶ä»–çº¿ç¨‹ä¸€èµ·ç«äº‰ (æ³¨æ„ yeild çš„çº¿ç¨‹è¿˜æ˜¯æœ‰å¯èƒ½äº‰å¤ºåˆ° cpuï¼Œæ³¨æ„ä¸
sleep åŒºåˆ«)ã€‚åœ¨ javadoc ä¸­ä¹Ÿè¯´æ˜äº†ï¼Œyeild æ˜¯ä¸ªåŸºæœ¬ä¸ä¼šç”¨åˆ°çš„æ–¹æ³•ï¼Œä¸€èˆ¬åœ¨ debug å’Œ test ä¸­ä½¿ç”¨ã€‚

join æ–¹æ³•çš„æ„æ€æ˜¯ç­‰å¾…å…¶ä»–çº¿ç¨‹ç»“æŸï¼Œå°±å¦‚ suspend é‚£èŠ‚çš„ä»£ç ï¼Œæƒ³è®©ä¸»çº¿ç¨‹ç­‰å¾… t1,t2 ç»“æŸä»¥åå†ç»“æŸã€‚æ²¡æœ‰ç»“æŸçš„è¯ï¼Œä¸»çº¿ç¨‹å°±ä¸€ç›´é˜»å¡åœ¨é‚£é‡Œã€‚

```java
public class Test{
	public volatile static int i = 0;
	public static class AddThread extends Thread{
		@Override
		public void run(){
			for (i = 0; i < 10000000; i++)
				;
		}
	}

	public static void main(String[] args) throws InterruptedException{
		AddThread at = new AddThread();
		at.start();
		at.join();
		System.out.println(i);
	}
}
```

å¦‚æœæŠŠä¸Šè¿°ä»£ç çš„ at.join å»æ‰ï¼Œåˆ™ä¸»çº¿ç¨‹ä¼šç›´æ¥è¿è¡Œç»“æŸï¼Œi çš„å€¼ä¼šå¾ˆå°ã€‚å¦‚æœæœ‰ join, æ‰“å°å‡ºçš„ i çš„å€¼ä¸€å®šæ˜¯ 10000000ã€‚

join çš„æœ¬è´¨:

```java
while(isAlive()) {
   wait(0);
}
```

join() æ–¹æ³•ä¹Ÿå¯ä»¥ä¼ é€’ä¸€ä¸ªæ—¶é—´ï¼Œæ„ä¸ºæœ‰é™æœŸåœ°ç­‰å¾…ï¼Œè¶…è¿‡äº†è¿™ä¸ªæ—¶é—´å°±è‡ªåŠ¨å”¤é†’ã€‚
è¿™æ ·å°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œè°æ¥ notify è¿™ä¸ªçº¿ç¨‹å‘¢ï¼Œåœ¨ thread ç±»ä¸­æ²¡æœ‰åœ°æ–¹è°ƒç”¨äº† notifyï¼Ÿ
åœ¨ javadoc ä¸­ï¼Œæ‰¾åˆ°äº†ç›¸å…³è§£é‡Šã€‚å½“ä¸€ä¸ªçº¿ç¨‹è¿è¡Œå®Œæˆç»ˆæ­¢åï¼Œå°†ä¼šè°ƒç”¨ notifyAll æ–¹æ³•å»å”¤é†’ç­‰å¾…åœ¨å½“å‰çº¿ç¨‹å®ä¾‹ä¸Šçš„æ‰€æœ‰çº¿ç¨‹, è¿™ä¸ªæ“ä½œæ˜¯ jvm è‡ªå·±å®Œæˆçš„ã€‚
æ‰€ä»¥ javadoc ä¸­è¿˜ç»™äº†æˆ‘ä»¬ä¸€ä¸ªå»ºè®®ï¼Œä¸è¦ä½¿ç”¨ wait å’Œ notify/notifyall åœ¨çº¿ç¨‹å®ä¾‹ä¸Šã€‚å› ä¸º jvm ä¼šè‡ªå·±è°ƒç”¨ï¼Œæœ‰å¯èƒ½ä¸ä½ è°ƒç”¨æœŸæœ›çš„ç»“æœä¸åŒã€‚

## å®ˆæŠ¤çº¿ç¨‹

- åœ¨åå°é»˜é»˜åœ°å®Œæˆä¸€äº›ç³»ç»Ÿæ€§çš„æœåŠ¡ï¼Œæ¯”å¦‚åƒåœ¾å›æ”¶çº¿ç¨‹ã€JIT çº¿ç¨‹å°±å¯ä»¥ç†è§£ä¸ºå®ˆæŠ¤çº¿ç¨‹ã€‚
- å½“ä¸€ä¸ª Java åº”ç”¨å†…ï¼Œæ‰€æœ‰éå®ˆæŠ¤è¿›ç¨‹éƒ½ç»“æŸæ—¶ï¼ŒJava è™šæ‹Ÿæœºå°±ä¼šè‡ªç„¶é€€å‡ºã€‚

å¼€å¯å®ˆæŠ¤è¿›ç¨‹:

```java
Thread t=new DaemonT();
t.setDaemon(true);
t.start()
```

## çº¿ç¨‹ä¼˜å…ˆçº§

```
public final static int MIN_PRIORITY = 1;
public final static int NORM_PRIORITY = 5;
public final static int MAX_PRIORITY = 10;
```

çº¿ç¨‹ä¼˜å…ˆçº§åªæ˜¯è¡¨ç¤ºè·å–é”çš„æ¦‚ç‡å¤§å°

## åŸºæœ¬çš„çº¿ç¨‹åŒæ­¥æ“ä½œ

synchronized æœ‰ä¸‰ç§åŠ é”æ–¹å¼ï¼š

- æŒ‡å®šåŠ é”å¯¹è±¡ï¼šå¯¹ç»™å®šå¯¹è±¡åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾—ç»™å®šå¯¹è±¡çš„é”ã€‚
- ç›´æ¥ä½œç”¨äºå®ä¾‹æ–¹æ³•ï¼šç›¸å½“äºå¯¹å½“å‰å®ä¾‹åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾—å½“å‰å®ä¾‹çš„é”ã€‚
- ç›´æ¥ä½œç”¨äºé™æ€æ–¹æ³•ï¼šç›¸å½“äºå¯¹å½“å‰ç±»åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾—å½“å‰ç±»çš„é”ã€‚

ä½œç”¨äºå®ä¾‹æ–¹æ³•ï¼Œåˆ™ä¸è¦ new ä¸¤ä¸ªä¸åŒçš„å®ä¾‹
ä½œç”¨äºé™æ€æ–¹æ³•ï¼Œåªè¦ç±»ä¸€æ ·å°±å¯ä»¥äº†ï¼Œå› ä¸ºåŠ çš„é”æ˜¯ç±».classï¼Œå¯ä»¥ new ä¸¤ä¸ªä¸åŒå®ä¾‹ã€‚

wait å’Œ notify çš„ç”¨æ³•ï¼š
ç”¨ä»€ä¹ˆé”ä½ï¼Œå°±ç”¨ä»€ä¹ˆè°ƒç”¨ wait å’Œ notify

## [Javaå†…å­˜ç®¡ç†ï¼šæ–¹æ³•åŒºä¸å¸¸é‡æ± ](https://blog.dong4j.site/posts/42f151c0.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

æ€»ç»“æ–¹æ³•åŒºå’Œè¿è¡Œæ—¶å¸¸é‡æ± 

## ç›¸å…³ç‰¹å¾

### æ–¹æ³•åŒºç‰¹å¾

- åŒ Java å †ä¸€æ ·, æ–¹æ³•åŒºä¹Ÿæ˜¯å…¨å±€å…±äº«çš„ä¸€å—å†…å­˜åŒºåŸŸ
- æ–¹æ³•åŒºçš„ä½œç”¨æ˜¯å­˜å‚¨ Java ç±»çš„ç»“æ„ä¿¡æ¯, å½“æˆ‘ä»¬åˆ›å»ºå¯¹è±¡å®ä¾‹å, **å¯¹è±¡çš„ç±»å‹ä¿¡æ¯å­˜å‚¨åœ¨æ–¹æ³•å †ä¹‹ä¸­, å®ä¾‹æ•°æ®å­˜æ”¾åœ¨å †ä¸­ï¼›å®ä¾‹æ•°æ®æŒ‡çš„æ˜¯åœ¨ Java
  ä¸­åˆ›å»ºçš„å„ç§å®ä¾‹å¯¹è±¡ä»¥åŠå®ƒä»¬çš„å€¼, ç±»å‹ä¿¡æ¯æŒ‡çš„æ˜¯å®šä¹‰åœ¨ Java
  ä»£ç ä¸­çš„å¸¸é‡ã€é™æ€å˜é‡ã€ä»¥åŠåœ¨ç±»ä¸­å£°æ˜çš„å„ç§æ–¹æ³•ã€æ–¹æ³•å­—æ®µç­‰ç­‰ï¼›åŒäº‹å¯èƒ½åŒ…æ‹¬å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åäº§ç”Ÿçš„ä»£ç æ•°æ®.**

- JVMS ä¸è¦æ±‚è¯¥åŒºåŸŸå®ç°è‡ªåŠ¨çš„å†…å­˜ç®¡ç†, ä½†æ˜¯å•†ç”¨ JVM ä¸€èˆ¬éƒ½å·²å®ç°è¯¥åŒºåŸŸçš„è‡ªåŠ¨å†…å­˜ç®¡ç†.
- æ–¹æ³•åŒºåˆ†é…å†…å­˜å¯ä»¥ä¸è¿ç»­, å¯ä»¥åŠ¨æ€æ‰©å±•.
- è¯¥åŒºåŸŸå¹¶éåƒ JMM è§„èŒƒæè¿°çš„é‚£æ ·æ•°æ®ä¸€æ—¦æ”¾è¿›å»å°±å±äº â€œæ°¸ä¹…ä»£â€ï¼› **åœ¨è¯¥åŒºåŸŸè¿›è¡Œå†…å­˜å›æ”¶çš„ä¸»è¦ç›®çš„æ˜¯å¯¹å¸¸é‡æ± çš„å›æ”¶å’Œå¯¹å†…å­˜æ•°æ®çš„å¸è½½ï¼›ä¸€èˆ¬æ¥è¯´è¿™ä¸ªåŒºåŸŸçš„å†…å­˜å›æ”¶æ•ˆç‡æ¯”èµ·
  Java å †è¦ä½å¾—å¤š.**
- å½“æ–¹æ³•åŒºæ— æ³•æ»¡è¶³å†…å­˜éœ€æ±‚æ—¶, å°†æŠ›å‡º OutOfMemoryError å¼‚å¸¸.

### è¿è¡Œæ—¶å¸¸é‡æ± çš„ç‰¹å¾

- **è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†,** æ‰€ä»¥ä¹Ÿæ˜¯å…¨å±€å…±äº«çš„.
- **å…¶ä½œç”¨æ˜¯å­˜å‚¨ Java ç±»æ–‡ä»¶å¸¸é‡æ± ä¸­çš„ç¬¦å·ä¿¡æ¯.**
- **class æ–‡ä»¶ä¸­å­˜åœ¨å¸¸é‡æ±  (éè¿è¡Œæ—¶å¸¸é‡æ± ), å…¶åœ¨ç¼–è¯‘é˜¶æ®µå°±å·²ç»ç¡®å®šï¼›JVM è§„èŒƒå¯¹ class æ–‡ä»¶ç»“æ„æœ‰ç€ä¸¥æ ¼çš„è§„èŒƒ, å¿…é¡»ç¬¦åˆæ­¤è§„èŒƒçš„ class æ–‡ä»¶æ‰ä¼šè¢«
  JVM è®¤å¯å’Œè£…è½½.**
- **è¿è¡Œæ—¶å¸¸é‡æ± ** ä¸­ä¿å­˜ç€ä¸€äº› class æ–‡ä»¶ä¸­æè¿°çš„ç¬¦å·å¼•ç”¨, åŒæ—¶è¿˜ä¼šå°†è¿™äº›ç¬¦å·å¼•ç”¨æ‰€ç¿»è¯‘å‡ºæ¥çš„ç›´æ¥å¼•ç”¨å­˜å‚¨åœ¨ **è¿è¡Œæ—¶å¸¸é‡æ± ** ä¸­.
- **è¿è¡Œæ—¶å¸¸é‡æ± ç›¸å¯¹äº class å¸¸é‡æ± ä¸€å¤§ç‰¹å¾å°±æ˜¯å…¶å…·æœ‰åŠ¨æ€æ€§, Java è§„èŒƒå¹¶ä¸è¦æ±‚å¸¸é‡åªèƒ½åœ¨è¿è¡Œæ—¶æ‰äº§ç”Ÿ, ä¹Ÿå°±æ˜¯è¯´è¿è¡Œæ—¶å¸¸é‡æ± ä¸­çš„å†…å®¹å¹¶ä¸å…¨éƒ¨æ¥è‡ª
  class å¸¸é‡æ± , class å¸¸é‡æ± å¹¶éè¿è¡Œæ—¶å¸¸é‡æ± çš„å”¯ä¸€æ•°æ®è¾“å…¥å£ï¼›åœ¨è¿è¡Œæ—¶å¯ä»¥é€šè¿‡ä»£ç ç”Ÿæˆå¸¸é‡å¹¶å°†å…¶æ”¾å…¥è¿è¡Œæ—¶å¸¸é‡æ± ä¸­**
- åŒæ–¹æ³•åŒºä¸€æ ·, å½“è¿è¡Œæ—¶å¸¸é‡æ± æ— æ³•ç”³è¯·åˆ°æ–°çš„å†…å­˜æ—¶, å°†æŠ›å‡º OutOfMemoryError å¼‚å¸¸.

## HotSpot æ–¹æ³•åŒºå˜è¿

### JDK1.2 ~ JDK6

åœ¨ JDK1.2 ~ JDK6 çš„å®ç°ä¸­, HotSpot ä½¿ç”¨æ°¸ä¹…ä»£å®ç°æ–¹æ³•åŒºï¼›HotSpot ä½¿ç”¨ GC åˆ†ä»£å®ç°æ–¹æ³•åŒºå¸¦æ¥äº†å¾ˆå¤§ä¾¿åˆ©ï¼›

### JDK7

ç”±äº GC åˆ†ä»£æŠ€æœ¯çš„å½±å“, ä½¿ä¹‹è®¸å¤šä¼˜ç§€çš„å†…å­˜è°ƒè¯•å·¥å…·æ— æ³•åœ¨ Oracle HotSpot ä¹‹ä¸Šè¿è¡Œ, å¿…é¡»å•ç‹¬å¤„ç†ï¼›å¹¶ä¸” Oracle åŒæ—¶æ”¶è´­äº† BEA å’Œ Sun å…¬å¸, åŒæ—¶æ‹¥æœ‰
JRockit å’Œ HotSpot, åœ¨å°† JRockit è®¸å¤šä¼˜ç§€ç‰¹æ€§ç§»æ¤åˆ° HotSpot æ—¶ç”±äº GC åˆ†ä»£æŠ€æœ¯é‡åˆ°äº†ç§ç§å›°éš¾, **æ‰€ä»¥ä» JDK7 å¼€å§‹ Oracle HotSpot
å¼€å§‹ç§»é™¤æ°¸ä¹…ä»£.**

**JDK7 ä¸­ç¬¦å·è¡¨è¢«ç§»åŠ¨åˆ° Native Heap ä¸­, å­—ç¬¦ä¸²å¸¸é‡å’Œç±»å¼•ç”¨è¢«ç§»åŠ¨åˆ° Java Heap ä¸­.**

### JDK8

**åœ¨ JDK8 ä¸­, æ°¸ä¹…ä»£å·²å®Œå…¨è¢«å…ƒç©ºé—´ (Meatspace) æ‰€å–ä»£.**

## æ°¸ä¹…ä»£å˜è¿äº§ç”Ÿçš„å½±å“

#### æµ‹è¯•ä»£ç  1

```java
public class Test1 {
    public static void main(String[] args) {
        String s1 = new StringBuilder("æ¼ ").append("ç„¶").toString();
        System.out.println(s1.intern() == s1);
        String s2 = new StringBuilder("æ¼ ").append("ç„¶").toString();
        System.out.println(s2.intern() == s2);
    }
}
```

ä»¥ä¸Šä»£ç , åœ¨ JDK6 ä¸‹æ‰§è¡Œç»“æœä¸º falseã€false, åœ¨ JDK7 ä»¥ä¸Šæ‰§è¡Œç»“æœä¸º trueã€false.

**é¦–å…ˆæ˜ç¡®ä¸¤ç‚¹**:

1. åœ¨ Java ä¸­ç›´æ¥ä½¿ç”¨åŒå¼•å·å±•ç¤ºçš„å­—ç¬¦ä¸²å°†ä¼šåœ¨å¸¸é‡æ± ä¸­ç›´æ¥åˆ›å»º.
2. String çš„ intern æ–¹æ³•é¦–å…ˆå°†å°è¯•åœ¨å¸¸é‡æ± ä¸­æŸ¥æ‰¾è¯¥å¯¹è±¡,
   å¦‚æœæ‰¾åˆ°åˆ™ç›´æ¥è¿”å›è¯¥å¯¹è±¡åœ¨å¸¸é‡æ± ä¸­çš„åœ°å€ï¼›æ‰¾ä¸åˆ°åˆ™å°†è¯¥å¯¹è±¡æ”¾å…¥å¸¸é‡æ± åå†è¿”å›å…¶åœ°å€. **JDK6 å¸¸é‡æ± åœ¨æ–¹æ³•åŒº, é¢‘ç¹è°ƒç”¨è¯¥æ–¹æ³•å¯èƒ½é€ æˆ
   OutOfMemoryError.**

**äº§ç”Ÿä¸¤ç§ç»“æœçš„åŸå› **:

åœ¨ JDK6 ä¸‹ s1ã€s2 æŒ‡å‘çš„æ˜¯æ–°åˆ›å»ºçš„å¯¹è±¡, **è¯¥å¯¹è±¡å°†åœ¨ Java Heap ä¸­åˆ›å»º, æ‰€ä»¥ s1ã€s2 æŒ‡å‘çš„æ˜¯ Java Heap ä¸­çš„å†…å­˜åœ°å€ï¼›** è°ƒç”¨ intern
æ–¹æ³•åå°†å°è¯•åœ¨å¸¸é‡æ± ä¸­æŸ¥æ‰¾è¯¥å¯¹è±¡, æ²¡æ‰¾åˆ°åå°†å…¶æ”¾å…¥å¸¸é‡æ± å¹¶è¿”å›, **æ‰€ä»¥æ­¤æ—¶ s1/s2.intern()æŒ‡å‘çš„æ˜¯å¸¸é‡æ± ä¸­çš„åœ°å€, JDK6 å¸¸é‡æ± åœ¨æ–¹æ³•åŒº,
ä¸å †éš”ç¦», ï¼›æ‰€ä»¥ s1.intern()==s1 è¿”å› false.**

#### æµ‹è¯•ä»£ç  2

```java
public class Test2 {
    public static void main(String[] args) {
        /**
         * é¦–å…ˆè®¾ç½® æŒä¹…ä»£æœ€å¤§å’Œæœ€å°å†…å­˜å ç”¨ (é™å®šä¸º 10M)
         * VM args: -XX:PermSize=10M -XX:MaxPremSize=10M
         */
        List<String> list = new ArrayList<String>();
        // æ— é™å¾ªç¯ ä½¿ç”¨ list å¯¹å…¶å¼•ç”¨ä¿è¯ ä¸è¢« GC  intern æ–¹æ³•ä¿è¯å…¶åŠ å…¥åˆ°å¸¸é‡æ± ä¸­
        int          i    = 0;
        while (true) {
            // æ­¤å¤„æ°¸ä¹…æ‰§è¡Œ, æœ€å¤šå°±æ˜¯å°†æ•´ä¸ª int èŒƒå›´è½¬åŒ–æˆå­—ç¬¦ä¸²å¹¶æ”¾å…¥å¸¸é‡æ± 
            list.add(String.valueOf(i++).intern());
        }
    }
}
```

ä»¥ä¸Šä»£ç åœ¨ JDK6 ä¸‹ä¼šå‡ºç° Perm å†…å­˜æº¢å‡º, JDK7 or high åˆ™æ²¡é—®é¢˜.

**åŸå› åˆ†æ**:

**JDK6 å¸¸é‡æ± å­˜åœ¨æ–¹æ³•åŒº, è®¾ç½®äº†æŒä¹…ä»£å¤§å°å, ä¸æ–­ while å¾ªç¯å¿…å°†æ’‘æ»¡ Perm å¯¼è‡´å†…å­˜æº¢å‡ºï¼›JDK7 å¸¸é‡æ± è¢«ç§»åŠ¨åˆ° Native Heap(Java Heap),
æ‰€ä»¥å³ä½¿è®¾ç½®äº†æŒä¹…ä»£å¤§å°, ä¹Ÿä¸ä¼šå¯¹å¸¸é‡æ± äº§ç”Ÿå½±å“ï¼›ä¸æ–­ while å¾ªç¯åœ¨å½“å‰çš„ä»£ç ä¸­, æ‰€æœ‰ int çš„å­—ç¬¦ä¸²ç›¸åŠ è¿˜ä¸è‡³äºæ’‘æ»¡ Heap åŒº,
æ‰€ä»¥ä¸ä¼šå‡ºç°å¼‚å¸¸.**

## [æ·±å…¥æµ…å‡ºJavaå¹¶å‘åŸºç¡€ï¼šä»æ¦‚å¿µåˆ°å®è·µ](https://blog.dong4j.site/posts/ef65c071.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

å‡ ä¸ªå¹¶å‘æ¦‚å¿µçš„ä»‹ç»

<!-- more -->

- åŒæ­¥ï¼ˆsynchronousï¼‰å’Œå¼‚æ­¥ï¼ˆasynchronousï¼‰

åŒæ­¥è°ƒç”¨ä¼šç­‰å¾…æ–¹æ³•çš„è¿”å›, å¼‚æ­¥è°ƒç”¨ä¼šé©¬ä¸Šè¿”å›, ä½†æ˜¯å¼‚æ­¥è°ƒç”¨è¿”å›å¹¶ä¸ä»£è¡¨äººä»»åŠ¡å·²ç»å®Œæˆ, å®ƒä¼šåœ¨åå°å¯ä¸ªçº¿ç¨‹ç»§ç»­è¿›è¡Œä»»åŠ¡

- å¹¶å‘ï¼ˆConcurrencyï¼‰å’Œå¹¶è¡Œï¼ˆParallelismï¼‰

å¹¶å‘å’Œå¹¶è¡Œåœ¨å¤–åœ¨è¡¨è±¡æ¥è¯´, æ˜¯å·®ä¸å¤šçš„. ç”±å›¾æ‰€ç¤º, å¹¶è¡Œåˆ™æ˜¯ä¸¤ä¸ªä»»åŠ¡åŒæ—¶è¿›è¡Œ, è€Œå¹¶å‘å‘¢, åˆ™æ˜¯ä¸€ä¼šåšä¸€ä¸ªä»»åŠ¡ä¸€ä¼šåˆåˆ‡æ¢åšå¦ä¸€ä¸ªä»»åŠ¡. æ‰€ä»¥å•ä¸ª cpu
æ˜¯ä¸èƒ½åšå¹¶è¡Œçš„, åªèƒ½æ˜¯å¹¶å‘.

- ä¸´ç•ŒåŒº

ä¸´ç•ŒåŒºç”¨æ¥è¡¨ç¤ºä¸€ç§å…¬å…±èµ„æºæˆ–è€…è¯´æ˜¯å…±äº«æ•°æ®, å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹ä½¿ç”¨, ä½†æ˜¯æ¯ä¸€æ¬¡, åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨å®ƒ, ä¸€æ—¦ä¸´ç•ŒåŒºèµ„æºè¢«å ç”¨, å…¶ä»–çº¿ç¨‹è¦æƒ³ä½¿ç”¨è¿™ä¸ªèµ„æº,
å°±å¿…é¡»ç­‰å¾….

- é˜»å¡ï¼ˆBlockingï¼‰å’Œéé˜»å¡ï¼ˆNon-Blockingï¼‰

  - é˜»å¡å’Œéé˜»å¡é€šå¸¸ç”¨æ¥å½¢å®¹å¤šçº¿ç¨‹é—´çš„ç›¸äº’å½±å“. æ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹å ç”¨äº†ä¸´ç•ŒåŒºèµ„æº, é‚£ä¹ˆå…¶å®ƒæ‰€æœ‰éœ€è¦ è¿™ä¸ªèµ„æºçš„çº¿ç¨‹å°±å¿…é¡»åœ¨è¿™ä¸ªä¸´ç•ŒåŒºä¸­è¿›è¡Œç­‰å¾…,
    ç­‰å¾…ä¼šå¯¼è‡´çº¿ç¨‹æŒ‚èµ·. è¿™ç§æƒ…å†µå°±æ˜¯é˜»å¡. æ­¤æ—¶, å¦‚ æœå ç”¨èµ„æºçš„çº¿ç¨‹ä¸€ç›´ä¸æ„¿æ„é‡Šæ”¾èµ„æº, é‚£ä¹ˆå…¶å®ƒæ‰€æœ‰é˜»å¡åœ¨è¿™ä¸ªä¸´ç•ŒåŒºä¸Šçš„çº¿ç¨‹éƒ½ä¸èƒ½å·¥ä½œ.
  - éé˜»å¡å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒº
    æ‰€ä»¥é˜»å¡çš„æ–¹å¼, ä¸€èˆ¬æ€§èƒ½ä¸ä¼šå¤ªå¥½. æ ¹æ®ä¸€èˆ¬çš„ç»Ÿè®¡, å¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨æ“ä½œç³»ç»Ÿå±‚é¢è¢«æŒ‚èµ·, åšäº†ä¸Šä¸‹æ–‡åˆ‡æ¢äº†, é€šå¸¸æƒ…å†µéœ€è¦ 8W ä¸ªæ—¶é—´å‘¨æœŸæ¥åšè¿™ä¸ªäº‹æƒ….

- æ­»é”ï¼ˆDeadlockï¼‰ã€é¥¥é¥¿ï¼ˆStarvationï¼‰å’Œæ´»é”ï¼ˆLivelockï¼‰

  - æ­»é”: æ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­, ç”±äºç«äº‰èµ„æºæˆ–è€…ç”±äºå½¼æ­¤é€šä¿¡è€Œé€ æˆçš„ä¸€ç§é˜»å¡çš„ç°è±¡, è‹¥æ— å¤–åŠ›ä½œç”¨, å®ƒä»¬éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å».
    æ­¤æ—¶ç§°ç³»ç»Ÿå¤„äºæ­»é”çŠ¶æ€æˆ–ç³»ç»Ÿäº§ç”Ÿäº†æ­»é”, è¿™äº›æ°¸è¿œåœ¨äº’ç›¸ç­‰å¾…çš„è¿›ç¨‹ç§°ä¸ºæ­»é”è¿›ç¨‹.
    - ä½†æ˜¯æ­»é”è™½è¯´æ˜¯ä¸å¥½çš„ç°è±¡, ä½†æ˜¯å®ƒæ˜¯ä¸€ä¸ªé™æ€çš„é—®é¢˜, ä¸€æ—¦å‘ç”Ÿæ­»é”, è¿›ç¨‹è¢«å¡æ­», cpu å æœ‰ç‡ä¹Ÿæ˜¯ 0, å®ƒä¸ä¼šå ç”¨ cpu, å®ƒä¼šè¢«è°ƒå‡ºå».
      ç›¸å¯¹æ¥è¯´è¿˜æ˜¯æ¯”è¾ƒå¥½å‘ç°å’Œåˆ†æçš„.
  - æ´»é”: æŒ‡äº‹ç‰© 1 å¯ä»¥ä½¿ç”¨èµ„æº, ä½†å®ƒè®©å…¶ä»–äº‹ç‰©å…ˆä½¿ç”¨èµ„æºï¼›äº‹ç‰© 2 å¯ä»¥ä½¿ç”¨èµ„æº, ä½†å®ƒä¹Ÿè®©å…¶ä»–äº‹ç‰©å…ˆä½¿ç”¨èµ„æº, äºæ˜¯ä¸¤è€…ä¸€ç›´è°¦è®©, éƒ½æ— æ³•ä½¿ç”¨èµ„æº.
    - ä¸ºäº†é¿å…æ­»é”æŠŠè‡ªå·±æŒæœ‰çš„èµ„æºéƒ½æ”¾å¼ƒæ‰. å¦‚æœå¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¹Ÿåšäº†åŒæ ·çš„äº‹æƒ…, ä»–ä»¬éœ€è¦ç›¸åŒçš„èµ„æº, æ¯”å¦‚ A æŒæœ‰ a èµ„æº, B æŒæœ‰ b èµ„æº,
      æ”¾å¼ƒäº†èµ„æºä»¥å, A åˆè·å¾—äº† b èµ„æº, B åˆè·å¾—äº† a èµ„æº, å¦‚æ­¤åå¤, åˆ™å‘ç”Ÿäº†æ´»é”.
  - é¥¥é¥¿: æŒ‡æŸä¸€ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹å› ä¸ºç§ç§åŸå› æ— æ³•è·å¾—æ‰€éœ€è¦çš„èµ„æº, å¯¼è‡´ä¸€ç›´æ— æ³•æ‰§è¡Œ.

- å¹¶è¡Œçš„çº§åˆ«
  - é˜»å¡ (å½“ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒºå, å…¶ä»–çº¿ç¨‹å¿…é¡»ç­‰å¾…)
  - éé˜»å¡
    - æ— éšœç¢é˜»å¡
      - æ— éšœç¢é˜»å¡æ˜¯ä¸€ç§æœ€å¼±çš„éé˜»å¡è°ƒåº¦
      - è‡ªç”±å‡ºå…¥ä¸´ç•ŒåŒº
      - æ— ç«äº‰æ—¶, æœ‰é™æ­¥å†…å®Œæˆæ“ä½œ
      - æœ‰ç«äº‰æ—¶, å›æ»šæ•°æ®.
    - æ— é”
      - æ˜¯æ— ä¿éšœçš„
      - ä¿è¯æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥èƒœå‡º
    - æ— ç­‰å¾…
      - æ— é”é¢
      - è¦æ±‚æ‰€æœ‰çš„çº¿ç¨‹éƒ½å¿…é¡»åœ¨æœ‰é™æ­¥å†…å®Œæˆ
      - æ— é¥¥é¥¿çš„

é˜»å¡è°ƒåº¦æ˜¯ä¸€ç§æ‚²è§‚çš„ç­–ç•¥, å®ƒä¼šè®¤ä¸ºè¯´ä¸€èµ·ä¿®æ”¹æ•°æ®æ˜¯å¾ˆæœ‰å¯èƒ½æŠŠæ•°æ®æ”¹åçš„. è€Œéé˜»å¡è°ƒåº¦å‘¢, æ˜¯ä¸€ç§ä¹è§‚çš„ç­–ç•¥, å®ƒè®¤ä¸ºå¤§å®¶ä¿®æ”¹æ•°æ®æœªå¿…æŠŠæ•°æ®æ”¹å.
ä½†æ˜¯å®ƒæ˜¯ä¸€ç§å®½è¿›ä¸¥å‡ºçš„ç­–ç•¥, å½“å®ƒå‘ç°ä¸€ä¸ªè¿›ç¨‹åœ¨ä¸´ç•ŒåŒºå†…å‘ç”Ÿäº†æ•°æ®ç«äº‰, äº§ç”Ÿäº†å†²çª, é‚£ä¹ˆæ— éšœç¢çš„è°ƒåº¦æ–¹å¼åˆ™ä¼šå›æ»šè¿™æ¡æ•°æ®.

åœ¨è¿™ä¸ªæ— éšœç¢çš„è°ƒåº¦æ–¹å¼å½“ä¸­, æ‰€æœ‰çš„çº¿ç¨‹éƒ½ç›¸å½“äºåœ¨æ‹¿å»ä¸€ä¸ªç³»ç»Ÿå½“å‰çš„ä¸€ä¸ªå¿«ç…§. ä»–ä»¬ä¸€ç›´ä¼šå°è¯•æ‹¿å»çš„å¿«ç…§æ˜¯æœ‰æ•ˆçš„ä¸ºæ­¢.
æ— éšœç¢å¹¶ä¸ä¿è¯æœ‰ç«äº‰æ—¶ä¸€å®šèƒ½å®Œæˆæ“ä½œ, å› ä¸ºå¦‚æœå®ƒå‘ç°æ¯æ¬¡æ“ä½œéƒ½ä¼šäº§ç”Ÿå†²çª, é‚£å®ƒåˆ™ä¼šä¸åœåœ°å°è¯•. å¦‚æœä¸´ç•ŒåŒºå†…çš„çº¿ç¨‹äº’ç›¸å¹²æ‰°, åˆ™ä¼šå¯¼è‡´æ‰€æœ‰çš„çº¿ç¨‹ä¼šå¡æ­»åœ¨ä¸´ç•ŒåŒº,
é‚£ä¹ˆç³»ç»Ÿæ€§èƒ½åˆ™ä¼šæœ‰å¾ˆå¤§çš„å½±å“.
è€Œæ— é”å¢åŠ äº†ä¸€ä¸ªæ–°çš„æ¡ä»¶, ä¿è¯æ¯æ¬¡ç«äº‰æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥èƒœå‡º, åˆ™è§£å†³äº†æ— éšœç¢çš„é—®é¢˜. è‡³å°‘ä¿è¯äº†æ‰€æœ‰çº¿ç¨‹éƒ½é¡ºåˆ©æ‰§è¡Œä¸‹å».

é¦–å…ˆæ— ç­‰å¾…çš„å‰ææ˜¯æ— é”çš„åŸºç¡€ä¸Šçš„, æ— é”å®ƒåªä¿è¯äº†ä¸´ç•ŒåŒºè‚¯å®šæœ‰è¿›ä¹Ÿæœ‰å‡º, ä½†æ˜¯å¦‚æœè¿›çš„ä¼˜å…ˆçº§éƒ½å¾ˆé«˜, é‚£ä¹ˆä¸´ç•ŒåŒºå†…çš„æŸäº›ä¼˜å…ˆçº§ä½çš„çº¿ç¨‹å¯èƒ½å‘ç”Ÿé¥¥é¥¿,
ä¸€ç›´å‡ºä¸äº†ä¸´ç•ŒåŒº. é‚£ä¹ˆæ— ç­‰å¾…è§£å†³äº†è¿™ä¸ªé—®é¢˜, å®ƒä¿è¯æ‰€æœ‰çš„çº¿ç¨‹éƒ½å¿…é¡»åœ¨æœ‰é™æ­¥å†…å®Œæˆ, è‡ªç„¶æ˜¯æ— é¥¥é¥¿çš„.

æ— ç­‰å¾…æ˜¯å¹¶è¡Œçš„æœ€é«˜çº§åˆ«, å®ƒèƒ½ä½¿è¿™ä¸ªç³»ç»Ÿè¾¾åˆ°æœ€ä¼˜çŠ¶æ€.

æ— ç­‰å¾…çš„å…¸å‹æ¡ˆä¾‹:
å¦‚æœåªæœ‰è¯»çº¿ç¨‹, æ²¡æœ‰çº¿çº¿ç¨‹, é‚£ä¹ˆè¿™ä¸ªåˆ™å¿…ç„¶æ˜¯æ— ç­‰å¾…çš„.
å¦‚æœæ—¢æœ‰è¯»çº¿ç¨‹åˆæœ‰å†™çº¿ç¨‹, è€Œæ¯ä¸ªå†™çº¿ç¨‹ä¹‹å‰, éƒ½æŠŠæ•°æ®æ‹·è´ä¸€ä»½å‰¯æœ¬, ç„¶åä¿®æ”¹è¿™ä¸ªå‰¯æœ¬, è€Œä¸æ˜¯ä¿®æ”¹åŸå§‹æ•°æ®, å› ä¸ºä¿®æ”¹å‰¯æœ¬, åˆ™æ²¡æœ‰å†²çª,
é‚£ä¹ˆè¿™ä¸ªä¿®æ”¹çš„è¿‡ç¨‹ä¹Ÿæ˜¯æ— ç­‰å¾…çš„. æœ€åéœ€è¦åšåŒæ­¥çš„åªæ˜¯å°†å†™å®Œçš„æ•°æ®è¦†ç›–åŸå§‹æ•°æ®.

## [ä»é›¶å¼€å§‹ï¼šTmuxä¼šè¯ç®¡ç†å®æˆ˜](https://blog.dong4j.site/posts/88c12565.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

æœ¬æ–‡å°†å¸¦ä½ æ·±å…¥äº†è§£ tmux çš„åŸºæœ¬æ“ä½œå’Œä½¿ç”¨æŠ€å·§ï¼Œè®©ä½ èƒ½å¤Ÿæ›´é«˜æ•ˆåœ°ä½¿ç”¨ç»ˆç«¯ã€‚æˆ‘ä»¬å°†ä»å®‰è£…ã€é…ç½®ã€å¸¸ç”¨å‘½ä»¤ä»¥åŠæ’ä»¶ç­‰æ–¹é¢è¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚

## ä¸€ã€ä»€ä¹ˆæ˜¯ tmuxï¼Ÿ

tmux æ˜¯ä¸€ä¸ªç»ˆç«¯å¤ç”¨è½¯ä»¶ï¼Œå®ƒå¯ä»¥å°†å¤šä¸ªç»ˆç«¯çª—å£åˆå¹¶åˆ°ä¸€ä¸ªçª—å£ä¸­ï¼Œä»è€Œæé«˜å·¥ä½œæ•ˆç‡ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒå¯ä»¥è®©ä½ åœ¨ä¸€ä¸ªç»ˆç«¯çª—å£ä¸­åŒæ—¶æ‰“å¼€å¤šä¸ªä¼šè¯ï¼ˆsessionï¼‰ã€çª—å£ï¼ˆwindowï¼‰å’Œé¢æ¿ï¼ˆpanelï¼‰ï¼Œå¹¶è¿›è¡Œè‡ªç”±åˆ‡æ¢å’Œç®¡ç†ã€‚

## äºŒã€å®‰è£…ä¸é…ç½®

1. å®‰è£…

```bash
git clone https://github.com/gpakosz/.tmux.git .oh-my-tmux
ln -s -f .oh-my-tmux/.tmux.conf ~/.tmux.conf
cp .oh-my-tmux/.tmux.conf.local ~/.tmux.conf.local
```

2. æ’ä»¶å®‰è£…

```bash
git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
```

## ä¸‰ã€å¸¸ç”¨å‘½ä»¤

1. ä¼šè¯ç®¡ç†

- æ–°å»ºä¼šè¯ï¼š`tmux new -s my_session_name`
- åˆ‡æ¢ä¼šè¯ï¼š`tmux at -t session_name`
- åˆ é™¤ä¼šè¯ï¼š`tmux kill-session -t session_name`
- é€€å‡ºä¼šè¯ï¼š`<prefix>d`

2. çª—å£ç®¡ç†

- æ–°å»ºçª—å£ï¼š`<prefix>c`
- åˆ é™¤çª—å£ï¼š`exit` æˆ– `<prefix>&`
- åˆ‡æ¢çª—å£ï¼š`<prefix>hjkl` æˆ– `<prefix>q windowæ•°å­—`
- é‡å‘½åçª—å£ï¼š`<prefix>, new_window_name`

3. é¢æ¿ç®¡ç†

- å‚ç›´åˆ†å‰²ï¼š`<prefix>"`
- æ°´å¹³åˆ†å‰²ï¼š`<prefix>%`
- åˆ‡æ¢é¢æ¿ï¼š`<prefix>hjkl` æˆ– `<prefix>q panelæ•°å­—`
- å…³é—­é¢æ¿ï¼š`<prefix>x`
- è°ƒæ•´é¢æ¿å¤§å°ï¼š`<prefix>shift + hjkl` æˆ– `<prefix>ctrl + æ–¹å‘é”®`

4. å…¶ä»–å¸¸ç”¨å‘½ä»¤

- æŸ¥çœ‹ä¼šè¯åˆ—è¡¨ï¼š`tmux ls`
- ä¿å­˜å½“å‰ä¼šè¯ï¼š`Ctrl+b d`ï¼ˆæ¨èä½¿ç”¨å¿«æ·é”®ï¼‰
- è¿›å…¥ä¸Šæ¬¡ä¿å­˜çš„ä¼šè¯ï¼š`tmux attach`
- æ€æ­»æœ€è¿‘ä½¿ç”¨çš„ä¼šè¯ï¼š`tmux kill-session`

## å››ã€æ’ä»¶ä»‹ç»

1. tpm (The Prime Minister)
   tpm æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ tmux æ’ä»¶ç®¡ç†å™¨ï¼Œå®ƒå¯ä»¥æ–¹ä¾¿åœ°å®‰è£…ã€æ›´æ–°å’Œç®¡ç†å…¶ä»– tmux æ’ä»¶ã€‚ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š

```bash
~/.tmux/plugins/tpm/tpm install <plugin_name>
```

2. copycat
   copycat æ˜¯ä¸€ä¸ªæ–¹ä¾¿çš„å¤åˆ¶ç²˜è´´æ’ä»¶ï¼Œå¯ä»¥å°†é¢æ¿å†…å®¹å¤åˆ¶åˆ°å‰ªè´´æ¿æˆ–ç²˜è´´åˆ°é¢æ¿ä¸­ã€‚

3. tree
   tree æ˜¯ä¸€ä¸ªåˆ—å‡ºç›®å½•ç»“æ„çš„æ’ä»¶ï¼Œå¯ä»¥æ–¹ä¾¿åœ°æŸ¥çœ‹å’Œç®¡ç†æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ã€‚

## äº”ã€æ€»ç»“

é€šè¿‡æœ¬æ–‡çš„å­¦ä¹ ï¼Œç›¸ä¿¡ä½ å·²ç»å¯¹ tmux æœ‰äº†ä¸€å®šçš„äº†è§£ã€‚tmux å¯ä»¥å¤§å¤§æé«˜ä½ çš„ç»ˆç«¯å·¥ä½œæ•ˆç‡ï¼Œè®©ä½ åœ¨å¤šä¸ªä¼šè¯ã€çª—å£å’Œé¢æ¿ä¹‹é—´è‡ªç”±åˆ‡æ¢å’Œç®¡ç†ã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¤Ÿå¸®åŠ©ä½ æ›´å¥½åœ°ä½¿ç”¨ tmuxï¼Œæå‡ä½ çš„å·¥ä½œæ•ˆç‡ã€‚

## [æŒæ¡ Homebrewï¼Œè½»æ¾ç®¡ç†ä½ çš„è½¯ä»¶åŒ…](https://blog.dong4j.site/posts/711ab194.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

Homebrew æ˜¯ macOS å’Œ Linux ä¸Šçš„åŒ…ç®¡ç†å™¨ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡å‘½ä»¤è¡Œè½»æ¾å®‰è£…ã€æ›´æ–°å’Œç®¡ç†è½¯ä»¶åŒ…ã€‚å®ƒæå¤§åœ°ç®€åŒ–äº†è½¯ä»¶åŒ…çš„è·å–å’Œç»´æŠ¤è¿‡ç¨‹ï¼Œå°¤å…¶é€‚åˆå¼€å‘è€…ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨ Homebrew çš„åŠŸèƒ½ã€å®‰è£…æ–¹å¼ã€æ ¸å¿ƒå‘½ä»¤ä»¥åŠä¸€äº›è¿›é˜¶ç”¨æ³•ï¼Œå¸®åŠ©ä½ å¿«é€Ÿä¸Šæ‰‹å¹¶é«˜æ•ˆç®¡ç†å¼€å‘ç¯å¢ƒã€‚

## ä»€ä¹ˆæ˜¯ Homebrewï¼Ÿ

Homebrew æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œç”± Max Howell åœ¨ 2009 å¹´å‘å¸ƒï¼Œæ—¨åœ¨ä¸º macOS ç”¨æˆ·æä¾›ç±»ä¼¼ Linux åŒ…ç®¡ç†å™¨çš„ä½“éªŒã€‚Homebrew çš„è®¾è®¡å“²å­¦æ˜¯â€œå°†å¤æ‚çš„äº‹æƒ…ç®€å•åŒ–â€ï¼Œå®ƒèƒ½è‡ªåŠ¨è§£å†³ä¾èµ–å…³ç³»å¹¶ä¼˜åŒ–å®‰è£…è¿‡ç¨‹ï¼Œä¸ºå¼€å‘è€…æä¾›äº†ä¸€ç§è½»é‡çº§ã€æ—  GUI çš„æ–¹å¼æ¥å®‰è£…å„ç§å¼€å‘å·¥å…·ã€‚ç°åœ¨ï¼ŒHomebrew ä¹Ÿæ‰©å±•æ”¯æŒäº† Linux ç³»ç»Ÿï¼Œä½¿å…¶æˆä¸ºè·¨å¹³å°çš„å·¥å…·ã€‚

## ä¸ºä»€ä¹ˆä½¿ç”¨ Homebrewï¼Ÿ

macOS è‡ªå¸¦çš„ç³»ç»Ÿå·¥å…·å’Œå¼€å‘ç¯å¢ƒæ¯”è¾ƒæœ‰é™ï¼ŒHomebrew é€šè¿‡ä¸€ç³»åˆ—å‘½ä»¤è¡Œå·¥å…·ç®€åŒ–äº†è½¯ä»¶åŒ…çš„å®‰è£…å’Œç®¡ç†æµç¨‹ï¼Œä¸º macOS å’Œ Linux ç”¨æˆ·æä¾›äº†ä¸€å¥—å®Œå–„çš„åŒ…ç®¡ç†æ–¹æ¡ˆã€‚ç›¸æ¯”äºæ‰‹åŠ¨ä¸‹è½½å’Œé…ç½®è½¯ä»¶ï¼ŒHomebrew èƒ½è‡ªåŠ¨é…ç½®ä¾èµ–é¡¹ã€è·¯å¾„å’Œæ›´æ–°ç®¡ç†ç­‰å·¥ä½œï¼Œè®©ç”¨æˆ·å¯ä»¥ä¸“æ³¨äºå¼€å‘è€Œä¸æ˜¯ç¯å¢ƒé…ç½®ã€‚

## Homebrew vs. Fink vs. MacPorts

- **Flink**ï¼šæä¾›ç›´æ¥ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶åŒ…ï¼Œä½†å®¹æ˜“å‡ºç°ä¾èµ–åº“é—®é¢˜ã€‚
- **MacPorts**ï¼šä¸‹è½½æ‰€æœ‰ä¾èµ–åº“çš„æºä»£ç ï¼Œåœ¨æœ¬åœ°ç¼–è¯‘å®‰è£…ï¼Œè¿‡ç¨‹ç¹çä¸”è€—æ—¶ã€‚
- **Homebrew**ï¼šä¼˜å…ˆæŸ¥æ‰¾æœ¬åœ°ä¾èµ–åº“ï¼Œç„¶åä¸‹è½½åŒ…æºä»£ç ç¼–è¯‘å®‰è£…ï¼Œæ—¢åˆç†åˆé«˜æ•ˆã€‚

## å®‰è£… Homebrew

å®‰è£… Homebrew éå¸¸ç®€å•ï¼Œåªéœ€åœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```

å®‰è£…å®Œæˆåï¼Œç¡®ä¿åœ¨`.zshrc`æˆ–`.bash_profile`æ–‡ä»¶ä¸­æ·»åŠ äº† Homebrew çš„ç¯å¢ƒå˜é‡ã€‚

## Homebrew çš„åŸºæœ¬ä½¿ç”¨

### æ›´æ–° formula å’Œ Homebrew

```bash
brew update
```

### æ˜¾ç¤ºå·²å®‰è£…çš„è½¯ä»¶åˆ—è¡¨

```bash
brew list
```

### å»é™¤ä¾èµ–

```bash
brew leaves
```

### æœç´¢è½¯ä»¶

```bash
brew search wget
```

### å®‰è£…è½¯ä»¶

```bash
brew install wget
```

### æŸ¥çœ‹éœ€è¦å‡çº§çš„è½¯ä»¶

```bash
brew outdated
```

### å‡çº§æ‰€æœ‰è½¯ä»¶

```bash
brew upgrade
```

### å‡çº§ç‰¹å®šè½¯ä»¶

```bash
brew upgrade wget
```

### åˆ é™¤è½¯ä»¶

```bash
brew uninstall wget --force
```

### æŸ¥çœ‹è½¯ä»¶åŒ…ä¿¡æ¯

```bash
brew info wget
```

### åˆ—å‡ºè½¯ä»¶åŒ…çš„ä¾èµ–å…³ç³»

```bash
brew deps wget
```

### å‡ºé”™å¤„ç†

- **å‡çº§ Homebrew**ï¼š
  ```bash
  brew update
  ```
- **æ£€æŸ¥ Homebrew çŠ¶å†µ**ï¼š
  ```bash
  brew doctor
  ```

### brew services

1. å¯åŠ¨æœåŠ¡ï¼šä½¿ç”¨ brew services start <formula> å¯åŠ¨æŸä¸ªæœåŠ¡ï¼Œå¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªåŠ¨å¯åŠ¨ã€‚
2. åœæ­¢æœåŠ¡ï¼šä½¿ç”¨ brew services stop <formula> åœæ­¢æ­£åœ¨è¿è¡Œçš„æœåŠ¡ã€‚
3. é‡å¯æœåŠ¡ï¼šä½¿ç”¨ brew services restart <formula> é‡æ–°å¯åŠ¨æœåŠ¡ï¼Œé€‚åˆæ›´æ”¹é…ç½®åé‡æ–°åŠ è½½æœåŠ¡ã€‚
4. æŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼šä½¿ç”¨ brew services list æŸ¥çœ‹å½“å‰é€šè¿‡ Homebrew å®‰è£…çš„æ‰€æœ‰æœåŠ¡åŠå…¶çŠ¶æ€ï¼ˆæ˜¯å¦æ­£åœ¨è¿è¡Œã€æ˜¯å¦å¼€æœºå¯åŠ¨ï¼‰ã€‚

## æ€»ç»“

Homebrew ä¸º Mac OS X ç”¨æˆ·æä¾›äº†éå¸¸æ–¹ä¾¿çš„è½¯ä»¶å®‰è£…æ–¹å¼ï¼Œè§£å†³äº†åŒ…çš„ä¾èµ–é—®é¢˜ï¼Œä¸å†éœ€è¦çƒ¦äººçš„ sudo æƒé™ï¼Œä¸€é”®å¼ç¼–è¯‘ï¼Œæ— å‚æ•°å›°æ‰°ã€‚ç”±äºå…¶å®‰è£…æ–¹å¼å¯èƒ½ä¼šæ›´æ–°ï¼Œå»ºè®®ç”¨æˆ·è®¿é—®å®˜æ–¹ç½‘ç«™ä»¥è·å–æœ€æ–°çš„å®‰è£…æ–¹æ³•å’Œæ–‡æ¡£ã€‚
é€šè¿‡æœ¬æ–‡ï¼Œæ‚¨åº”è¯¥å·²ç»æŒæ¡äº† Homebrew çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ã€‚æ— è®ºæ˜¯å®‰è£…ã€å‡çº§è¿˜æ˜¯å¸è½½è½¯ä»¶ï¼ŒHomebrew éƒ½èƒ½è®©æ‚¨çš„å·¥ä½œæ›´åŠ é«˜æ•ˆã€‚å¼€å§‹ä½¿ç”¨ Homebrewï¼Œè®©æ‚¨çš„ Mac OS X ä½“éªŒæ›´åŠ é¡ºç•…å§ï¼

---

æ³¨ï¼šç”±äº Homebrew çš„å®‰è£…æ–¹å¼å¯èƒ½ä¼šå˜åŒ–ï¼Œè¯·åˆ°å®˜æ–¹ç½‘ç«™æŸ¥çœ‹æœ€æ–°çš„æ–¹æ³•å’Œæ–‡æ¡£ã€‚

## [macOS ä¸Šä½¿ç”¨ IDEA æ­å»º SSM é¡¹ç›®](https://blog.dong4j.site/posts/23cbb67c.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

é¡¹ç›®æ­å»ºé‡‡ç”¨æŠ€æœ¯æ ˆä¸ºï¼šSpring+Spring MVC+Hibernate+Jsp+Gradle ï¼‹ tomcat+mysql5.6

æ­å»ºç¯å¢ƒæ–‡æ¡£ç›®å½•ç»“æ„è¯´æ˜ï¼š

1. ä½¿ç”¨ Intellj Idea æ­å»ºé¡¹ç›®è¿‡ç¨‹è¯¦è§£
2. é¡¹ç›®å„é…ç½®æ–‡ä»¶è®²è§£åŠéƒ¨ç½²
3. å„å±‚åŒ…åŠŸèƒ½è®²è§£ & é¡¹ç›®æ­å»ºå®Œæ¯•æœ€ç»ˆæ•ˆæœæ¼”ç¤ºå›¾
4. é¡¹ç›®ä¸­é‡è¦ä»£ç è®²è§£
5. é…ç½® tomcat è¿è¡Œç¯å¢ƒ
6. webapp æ–‡ä»¶å¤¹ä¸‹åˆ†å±‚è¯¦è§£

### **1. ä½¿ç”¨ Intellj Idea æ­å»ºé¡¹ç›®è¿‡ç¨‹è¯¦è§£**

**1.1 æ‰“å¼€ Intellj Idea**

![20241229154732_UmUYAM5B.webp](https://cdn.dong4j.site/source/image/20241229154732_UmUYAM5B.webp)

**1.2 æ“ä½œ Intellj Idea å·¥å…·æ  æ–°å»ºé¡¹ç›®**

![20241229154732_dQUO0QRI.webp](https://cdn.dong4j.site/source/image/20241229154732_dQUO0QRI.webp)

![20241229154732_4hecK3or.webp](https://cdn.dong4j.site/source/image/20241229154732_4hecK3or.webp)

![20241229154732_OQM0gIFM.webp](https://cdn.dong4j.site/source/image/20241229154732_OQM0gIFM.webp)

![20241229154732_pjRYBW6i.webp](https://cdn.dong4j.site/source/image/20241229154732_pjRYBW6i.webp)

![20241229154732_HiyaFYc8.webp](https://cdn.dong4j.site/source/image/20241229154732_HiyaFYc8.webp)

![20241229154732_XTyTDehX.webp](https://cdn.dong4j.site/source/image/20241229154732_XTyTDehX.webp)

![20241229154732_uWlJZ4Oz.webp](https://cdn.dong4j.site/source/image/20241229154732_uWlJZ4Oz.webp)

éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæœ€åˆåˆ›å»ºçš„é¡¹ç›®è§†å›¾æ˜¯ä¸å®Œæ•´çš„ï¼ŒåŒ…æ‹¬ webapp æ–‡ä»¶å¤¹ä¸‹æ²¡æœ‰ web.xmlï¼Œä»¥åŠ src åŒ…ä¸‹ç¼ºå°‘ Java æ–‡ä»¶å¤¹ (æ”¾ç½® java æºä»£ç æ–‡ä»¶)ï¼ŒResources æ–‡ä»¶å¤¹ï¼ˆæ”¾ç½®é¡¹ç›®é…ç½®æ–‡ä»¶ï¼‰ã€‚

æˆ‘ä»¬ç»§ç»­åšä»¥ä¸‹æ“ä½œï¼Œä½¿å¾—é¡¹ç›®çš„ç»“æ„ç¬¦åˆ web åº”ç”¨é¡¹ç›®çš„å±‚çº§æ ‡å‡†ã€‚

![20241229154732_w031AEdD.webp](https://cdn.dong4j.site/source/image/20241229154732_w031AEdD.webp)

å‡ºç°å¦‚ä¸‹è§†å›¾ï¼š

![20241229154732_xQkY98hW.webp](https://cdn.dong4j.site/source/image/20241229154732_xQkY98hW.webp)

![20241229154732_jXXkzc48.webp](https://cdn.dong4j.site/source/image/20241229154732_jXXkzc48.webp)

æ¥ä¸‹æ¥ï¼šå•å‡» main æ–‡ä»¶å¤¹æŒ‰ç…§å¦‚ä¸‹æ“ä½œï¼š

![20241229154732_FpSXWcZK.webp](https://cdn.dong4j.site/source/image/20241229154732_FpSXWcZK.webp)

å±å¹•å¿«ç…§ 2016-11-20 ä¸‹åˆ 4.44.33.png

![20241229154732_cSVKsRzs.webp](https://cdn.dong4j.site/source/image/20241229154732_cSVKsRzs.webp)

ç‚¹å‡» okï¼Œå†æŒ‰ç…§ä¸Šå›¾æ“ä½œæ“ä½œä¸€éï¼Œè¾“å…¥æ–‡ä»¶åä¸º **resources**

æœ€ç»ˆçš„ç»“æ„å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![20241229154732_kSY0ppsp.webp](https://cdn.dong4j.site/source/image/20241229154732_kSY0ppsp.webp)

### **2. é¡¹ç›®å„é…ç½®æ–‡ä»¶è®²è§£åŠéƒ¨ç½²**

å®Œæˆäº†é¡¹ç›®çš„åˆå§‹åŒ–ç»“æ„åˆ›å»ºï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ¥åˆ›å»ºé…ç½®æ–‡ä»¶ã€‚

é¦–å…ˆæ˜¯ resources æ–‡ä»¶å¤¹ä¸‹çš„é…ç½®æ–‡ä»¶

**2.1resources ä¸‹èµ„æºæ–‡ä»¶æˆªå›¾:(æœ€ç»ˆé…ç½®çš„ç»“æœ)**

![20241229154732_ETRD79L5.webp](https://cdn.dong4j.site/source/image/20241229154732_ETRD79L5.webp)

**2.2 data-access-applicationContext.xml**

ä¸»è¦ç®¡ç†æ•°æ®åº“è®¿é—®ç»„ä»¶

```
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context.xsd
       ">

    <!-- é…ç½®è‡ªåŠ¨æ‰«æçš„åŒ… -->
    <context:component-scan base-package="com.fxmms" use-default-filters="false">
        <context:include-filter type="regex" expression="com.fxmms.*.*.dao.*"/>
        <context:include-filter type="regex" expression="com.fxmms.*.dao.*"/>
    </context:component-scan>

    <!-- é…ç½®æ•°æ®æº -->
    <context:property-placeholder location="classpath:db.properties"/>
    <bean id="dataSource" class="org.springframework.jdbc.datasource.DriverManagerDataSource">
        <property name="driverClassName" value="${jdbc.driverClass}"/>
        <property name="url" value="${jdbc.jdbcUrl}"/>
        <property name="username" value="${jdbc.user}"/>
        <property name="password" value="${jdbc.password}"/>
    </bean>

    <!--é…ç½®hibernate SessionFactory-->
    <bean id="sessionFactory"
          class="org.springframework.orm.hibernate4.LocalSessionFactoryBean">
        <property name="dataSource" ref="dataSource"></property>
        <property name="hibernateProperties">
            <props>
                <prop key="hibernate.dialect">${dataSource.hibernate.dialect}</prop>
                <prop key="hibernate.show_sql">${dataSource.hibernate.show_sql}</prop>
                <prop key="hibernate.format_sql">true</prop>
                <!--è´Ÿè´£è‡ªåŠ¨åˆ›å»ºæ•°æ®è¡¨ï¼ŒåŸºæœ¬ä¸Šä¸èƒ½æ‰“å¼€æ³¨é‡Šï¼Œå¦åˆ™æ‰€æœ‰çš„æ•°æ®åº“ä¸­è¡¨ä¿¡æ¯éƒ½ä¼šè¢«åˆ é™¤ï¼Œé‡æ–°åˆ›å»º-->
                <!-- <prop key="hibernate.hbm2ddl.auto">create</prop> -->
            </props>
        </property>
        <!-- <property name="hibernate.jdbc.batch_size" value="50"></property> -->
        <property name="packagesToScan">
            <list>
                <value>com.fxmms.*.*.domain</value>
                <value>com.fxmms.*.domain</value>
            </list>
        </property>
    </bean>

    <!--jdbcTemplate start -->
    <bean id="jdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate">
        <property name="dataSource" ref="dataSource"></property>
    </bean>
    <!--Spring JDBC ä¸­æ“ä½œ LOB æ•°æ® -->
    <bean id="lobHandler" class="org.springframework.jdbc.support.lob.DefaultLobHandler"
          lazy-init="true"></bean>
    <!-- é…ç½®JPAéƒ¨åˆ† -->
    <!-- é…ç½®JPAçš„EntityManagerFactory -->
    <!-- <bean id="entityManagerFactory"
           class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean">
         <property name="dataSource" ref="dataSource"></property>
         <property name="jpaVendorAdapter">
             <bean class="org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter"></bean>
         </property>
         <property name="packagesToScan" value="com.fxmms"></property>
         <property name="jpaProperties">
             <props>
                 <prop key="hibernate.ejb.naming_strategy">org.hibernate.cfg.ImprovedNamingStrategy</prop>
                 <prop key="hibernate.hbm2ddl.auto">update</prop>
                 <prop key="hibernate.show_sql">true</prop>
                 <prop key="hibernate.format_sql">true</prop>
                 <prop key="hibernate.dialect">org.hibernate.dialect.MySQL5InnoDBDialect</prop>

                 <prop key="hibernate.cache.use_second_level_cache">true</prop>
                 <prop key="hibernate.cache.region.factory_class">org.hibernate.cache.ehcache.EhCacheRegionFactory
                 </prop>
                 <prop key="hibernate.cache.use_query_cache">true</prop>
             </props>
         </property>
         <!â€“ä½¿ç”¨äºŒç´šç·©å­˜â€“>
         <property name="sharedCacheMode" value="ENABLE_SELECTIVE"></property>
     </bean>

     <!â€“ é…ç½®äº‹åŠ¡ â€“>
     <bean id="transactionManager" class="org.springframework.orm.jpa.JpaTransactionManager">
         <property name="entityManagerFactory" ref="entityManagerFactory"></property>
     </bean>-->

    <!-- <!â€“ é…ç½®SpringDataéƒ¨åˆ† â€“>
     <jpa:repositories base-package="com.fxmms"
                       entity-manager-factory-ref="entityManagerFactory">

     </jpa:repositories>-->
</beans>
```

**2.3 service-applicationContext.xml**

ä¸»è¦ç®¡ç†ä¸šåŠ¡é€»è¾‘ç»„ä»¶ï¼ŒåŒ…æ‹¬å¯¹æ•°æ®åº“è®¿é—®çš„äº‹åŠ¡æ§åˆ¶ï¼Œä»¥åŠå®šæ—¶ä»»åŠ¡ã€‚

```
<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xmlns:task="http://www.springframework.org/schema/task"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
  http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
  http://www.springframework.org/schema/aop
  http://www.springframework.org/schema/aop/spring-aop.xsd
  http://www.springframework.org/schema/tx
  http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/task
        http://www.springframework.org/schema/task/spring-task.xsd">

    <aop:aspectj-autoproxy/>

    <!--è®¾ç½®å®šæ—¶ä»»åŠ¡-->
    <task:annotation-driven/>
    <context:component-scan base-package="com.fxmms.www" use-default-filters="false">
        <context:include-filter type="annotation" expression="org.springframework.stereotype.Service"/>
    </context:component-scan>

    <!-- enable the configuration of transactional behavior based on annotations -->
    <tx:annotation-driven transaction-manager="txManager"/>

    <bean id="txManager" class="org.springframework.orm.hibernate4.HibernateTransactionManager">
        <property name="sessionFactory" ref="sessionFactory"/>
    </bean>

</beans>
```

**2.4default-servlet.xml**

è®¾ç½® springmvc-applicationContext.xml, å‰ç«¯æ§åˆ¶å™¨å°†è¯·æ±‚è½¬å‘åˆ°ç›¸åº”çš„ controller å±‚ä¸­çš„å¤„ç†æ–¹æ³•ä¸Šã€‚

```
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:mvc="http://www.springframework.org/schema/mvc"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context.xsd
       http://www.springframework.org/schema/mvc
       http://www.springframework.org/schema/mvc/spring-mvc.xsd">
    <!---->
    <mvc:annotation-driven>
        <!--jsonè§£æ-->
        <mvc:message-converters>
            <bean class="org.springframework.http.converter.StringHttpMessageConverter"/>
            <bean class="org.springframework.http.converter.json.MappingJackson2HttpMessageConverter"/>
        </mvc:message-converters>
    </mvc:annotation-driven>
    <context:component-scan base-package="com.fxmms.www.controller">
        <context:include-filter type="annotation" expression="org.springframework.stereotype.Controller"/>
    </context:component-scan>
    <!--å› ä¸ºweb.xmlä¸­defaultDispatcherServletå¯¹æ‰€æœ‰è¯·æ±‚è¿›è¡Œäº†æ‹¦æˆªï¼Œæ‰€ä»¥å¯¹ä¸€äº›.css .jpg .html .jspä¹Ÿè¿›è¡Œäº†æ‹¦æˆªï¼Œæ‰€ä»¥æ­¤é…ç½®é¡¹
    ä¿è¯å¯¹å¯¹é™æ€èµ„æºä¸æ‹¦æˆª-->
    <mvc:default-servlet-handler/>
    <!--è§†å›¾è§£æå™¨-->
    <bean id="viewResolver"
          class="org.springframework.web.servlet.view.InternalResourceViewResolver">
        <property name="prefix" value="/WEB-INF/views/"/>
        <property name="suffix" value=".jsp"/>
    </bean>
    <!--é…ç½®æ–‡ä»¶ä¸Šä¸Šä¼ -->
    <bean id="multipartResolver" class="org.springframework.web.multipart.commons.CommonsMultipartResolver">
        <property name="defaultEncoding" value="utf-8"/>
        <property name="maxUploadSize" value="10485760000"/>
        <property name="maxInMemorySize" value="40960"/>
    </bean>
</beans>
```

**2.5 spring-security.xml**

è®¾ç½® springï¼security æƒé™æ§åˆ¶é…ç½®æ–‡ä»¶ï¼Œé¡¹ç›®ä¸­æƒé™çš„æ§åˆ¶ç»Ÿä¸€åœ¨æ­¤é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼ŒåŒ…æ‹¬ä»æ•°æ®åº“ä¸­è·å–ç”¨æˆ·çš„ç›¸å…³ä¿¡æ¯ï¼Œä»¥åŠé…ç½®ç›¸åº” pattern çš„è¯·æ±‚è¿‡æ»¤è§„åˆ™ã€‚

```
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:sec="http://www.springframework.org/schema/security"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans-3.2.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/security
        http://www.springframework.org/schema/security/spring-security-3.2.xsd">
    <!--    <sec:http pattern="/**/*.jpg" security="none"></sec:http>
        <sec:http pattern="/**/*.jpeg" security="none"></sec:http>
        <sec:http pattern="/**/*.gif" security="none"></sec:http>
        <sec:http pattern="/**/*.png" security="none"></sec:http>s
        <sec:http pattern="/getCode" security="none" /><!â€“ ä¸è¿‡æ»¤éªŒè¯ç  â€“>
        <sec:http pattern="/test/**" security="none"></sec:http><!â€“ ä¸è¿‡æ»¤æµ‹è¯•å†…å®¹ â€“>-->
    <!--spring security æƒé™ç®¡ç†é…ç½®æ–‡ä»¶-->
    <context:component-scan base-package="com.fxmms.common.security">
    </context:component-scan>
    <context:property-placeholder location="classpath:db.properties"></context:property-placeholder>
    <!--æƒé™æ§åˆ¶-->
    <sec:http auto-config="true" use-expressions="true">
        <sec:intercept-url pattern="/superadmin/**" access="hasRole('superadmin')"/>
        <sec:intercept-url pattern="/admin/**" access="hasRole('admin')"/>
        <sec:intercept-url pattern="/customer/**" access="hasRole('customer')"/>
        <!--è‡ªå®šä¹‰ç™»é™†é¡µé¢,æƒé™éªŒè¯å¤±è´¥é¡µé¢ï¼Œç™»å½•æˆåŠŸé¡µé¢-->
        <sec:form-login login-page="/login.jsp" authentication-failure-url="/login.jsp" login-processing-url="/j_spring_security_check"
                        authentication-success-handler-ref="loginSuccessHandler"/>
        <!--ç”¨æˆ·æƒé™ä¸ä¸€è‡´å‡ºç°çš„æƒé™ä¸å¯å¾—æƒ…å†µï¼Œé»˜è®¤æƒ…å†µä¸‹è·³è½¬åˆ°403é¡µé¢-->
        <sec:access-denied-handler ref="accessDeniedServletHandler" />
        <sec:logout logout-success-url="/login.jsp" />
    </sec:http>

    <sec:authentication-manager>
        <sec:authentication-provider>
            <!--é…ç½®ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·æƒé™  and isDelete = 0 and enable = 1-->
            <sec:jdbc-user-service data-source-ref="dataSource"
                                   users-by-username-query="select userName,password,enable  from mms_admin where userName=? and isDelete = 0 and enable = 1"
                                   authorities-by-username-query="select userName,role from mms_admin where username=?"
            ></sec:jdbc-user-service>
        </sec:authentication-provider>
    </sec:authentication-manager>
</beans>
```

**2.6 db.properties**

æ•°æ®åº“è®¿é—®é…ç½®æ–‡ä»¶

```
jdbc.user=root
jdbc.password=feixun*123
jdbc.driverClass=com.mysql.jdbc.Driver
#jdbc.jdbcUrl=jdbc:mysql://localhost/fxmms?useUnicode=true&characterEncoding=UTF-8
jdbc.jdbcUrl=jdbc:mysql://222.73.156.132:13306/fxmms?useUnicode=true&characterEncoding=UTF-8

jdbc.initPoolSize=5
jdbc.maxPoolSize=20
dataSource.hibernate.dialect=org.hibernate.dialect.MySQL5Dialect
#######################
##      local        ##
#######################
dataSource.hibernate.show_sql=true
```

**2.7 log4j.properties**

é…ç½®é¡¹ç›®æ—¥å¿—æ–‡ä»¶ï¼Œæ—¥å¿—è¾“å‡ºæ¨¡å¼ä¸º Console

```
###########################################################################
# Properties file for the log4j logger system
#
#  Note: During the uPortal build, the file at /properties/Logger.properties is copied
#  to the log4j standard location /WEB-INF/classes/log4j.properties .  This means that editing the file
#  at /properties/Logger.properties in a deployed uPortal will have no effect.
#
# Please read the instructions for the Log4J logging system at
# http://jakarta.apache.org/log4j/ if you want to modify this.

###########################################################################
# You should probably replace the word "debug" with "info" in the
# following line after everything is running.  This will turn off
# the tons of debug messages, and leave only INFO, WARN, ERROR, etc.
#
log4j.rootLogger=info, stdout

# Console output
log4j.appender.stdout=org.apache.log4j.ConsoleAppender
log4j.appender.stdout.layout=org.apache.log4j.PatternLayout
log4j.appender.stdout.layout.ConversionPattern=%d{mm:ss,SSS} %p [%l] - <%m>%n
```

**2.8 web.xml**

```
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"
         version="3.1">
    <!--é…ç½®éœ€è¦åŠ è½½çš„springé…ç½®æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶ä¸­çš„é…ç½®çš„ç±»éƒ½æ˜¯è¢«<context:component-scan>æ‰«æåˆ°çš„ï¼Œæ¯”å¦‚@Repository @Component
    @Service @Controllerç­‰-->
    <context-param>
        <param-name>contextConfigLocation</param-name>
        <param-value>classpath:data-access-applicationContext.xml;classpath:spring-security.xml;classpath:service-applicationContext.xml</param-value>
    </context-param>
    <!--é…ç½®æ—¥å¿—ç›‘å¬ ï¼Œå¦‚æœé…ç½®æ–‡ä»¶æŠ¥çº¢ï¼Œæ²¡æœ‰å…³ç³»å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œè¿™ä¸ªä¸ideaçš„éªŒè¯è§„åˆ™æœ‰å…³-->
    <context-param>
        <param-name>log4jConfigLocation</param-name>
        <param-value>classpath:log4j.properties</param-value>
    </context-param>
    <listener>
        <listener-class>org.springframework.web.util.Log4jConfigListener</listener-class>
    </listener>

    <listener>
        <listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>
    </listener>

   <!--é…ç½®æƒé™è¿‡æ»¤å™¨ï¼Œæ³¨æ„å¿…é¡»é…ç½®åœ¨springmvc ä¹‹å‰ï¼Œå› ä¸ºå¯¹ç”¨æˆ·è®¿é—®èµ„æºçš„æƒé™åˆ¤æ–­ä¸æ§åˆ¶æ˜¯åœ¨è®¿é—®ç‰¹å®šurlä¹‹å‰å‘ç”Ÿçš„-->
    <filter>
        <filter-name>springSecurityFilterChain</filter-name>
        <filter-class>org.springframework.web.filter.DelegatingFilterProxy</filter-class>
    </filter>
    <filter-mapping>
        <filter-name>springSecurityFilterChain</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>

    <!-- é…ç½®å­—ç¬¦ç¼–ç è¿‡æ»¤å™¨  å¿…é¡»é…ç½®åœ¨æ‰€æœ‰è¿‡æ»¤å™¨çš„æœ€å‰é¢ -->
    <filter>
        <filter-name>CharacterEncodingFilter</filter-name>
        <filter-class>org.springframework.web.filter.CharacterEncodingFilter</filter-class>
        <init-param>
            <param-name>encoding</param-name>
            <param-value>UTF-8</param-value>
        </init-param>
        <init-param>
            <param-name>forceEncoding</param-name>
            <param-value>true</param-value>
        </init-param>
    </filter>

    <filter-mapping>
        <filter-name>CharacterEncodingFilter</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>
    <!--è¶…çº§ç®¡ç†å‘˜ -->
  <!-- <filter>
        <filter-name>superAdminFilter</filter-name>
        <filter-class>com.fxmms.filter.SuperAdminFilter</filter-class>
    </filter>
    <filter-mapping>
        <filter-name>superAdminFilter</filter-name>
        <url-pattern>/fxmms/superadmin/*</url-pattern>
    </filter-mapping>

    <filter>
        <filter-name>adminFilter</filter-name>
        <filter-class>com.fxmms.filter.AdminFilter</filter-class>
    </filter>
    <filter-mapping>
        <filter-name>adminFilter</filter-name>
        <url-pattern>/fxmms/admin/*</url-pattern>
    </filter-mapping>

    <filter>
        <filter-name>customerFilter</filter-name>
        <filter-class>com.fxmms.filter.CustomerFilter</filter-class>
    </filter>
    <filter-mapping>
        <filter-name>customerFilter</filter-name>
        <url-pattern>/fxmms/customer/*</url-pattern>
    </filter-mapping>

    <servlet>
        <servlet-name>LoginServlet</servlet-name>
        <servlet-class>com.fxmms.servlet.LoginServlet</servlet-class>
    </servlet>
    <servlet>
        <servlet-name>InvalidateServlet</servlet-name>
        <servlet-class>com.fxmms.servlet.InvalidateServlet</servlet-class>
    </servlet>-

    <servlet-mapping>
        <servlet-name>LoginServlet</servlet-name>
        <url-pattern>/loginServlet</url-pattern>
    </servlet-mapping>
    <servlet-mapping>
    <servlet-name>InvalidateServlet</servlet-name>
    <url-pattern>/invalidateServlet</url-pattern>
    </servlet-mapping>-->

    <!-- é…ç½®çœ‹å¯ä»¥æŠŠPOSTè¯·æ±‚è½¬ä¸ºPUTï¼ŒDELETEè¯·æ±‚çš„Filter -->
    <filter>
        <filter-name>HiddenHttpMethodFilter</filter-name>
        <filter-class>org.springframework.web.filter.HiddenHttpMethodFilter</filter-class>
    </filter>
    <filter-mapping>
        <filter-name>HiddenHttpMethodFilter</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>
    <!--é…ç½®ä¸­å¤®æ§åˆ¶å™¨ï¼Œå¯¹æ‰€æœ‰è¯·æ±‚è¿›è¡Œæ‹¦æˆªå¹¶åšè¯·æ±‚è·¯å¾„ï¼Œä¸å¤„ç†è¯·æ±‚æ¡©æ¨¡å—ä¹‹é—´çš„æ˜ å°„-->
    <servlet>
        <servlet-name>defaultDispatcherServlet</servlet-name>
        <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>
        <init-param>
            <param-name>contextConfigLocation
            </param-name>
            <param-value>classpath:default-servlet.xml</param-value>
        </init-param>
        <load-on-startup>1</load-on-startup>
    </servlet>
    <!--è¿™é‡Œæ˜¯æ‹¦æˆªæ‰€æœ‰-->
    <servlet-mapping>
        <servlet-name>defaultDispatcherServlet</servlet-name>
        <url-pattern>/</url-pattern>
    </servlet-mapping>
</web-app>
```

**2.9 build.gradle**

é¡¹ç›®æ„å»ºè„šæœ¬

```
group 'com.fxmms'
version '1.0-SNAPSHOT'

apply plugin: 'java'
apply plugin: 'idea'
apply plugin: 'war'
sourceCompatibility = 1.8

repositories {
    maven { url "http://maven.aliyun.com/nexus/content/groups/public/" }
    mavenLocal()
    jcenter()
    maven { url "http://repo.maven.apache.org/maven2/"}
    maven { url 'https://repo.spring.io/libs-milestone'}
    mavenCentral()
}

dependencies {
    testCompile group: 'junit', name: 'junit', version: '4.12'
    // servlet-api
    compile group: 'javax.servlet', name: 'servlet-api', version: '2.5'
    //springç›¸å…³
    compile group: 'org.springframework', name: 'spring-webmvc', version: '4.3.3.RELEASE'
    compile group: 'org.springframework', name: 'spring-orm', version: '4.3.3.RELEASE'
    compile group: 'org.springframework', name: 'spring-aspects', version: '4.3.3.RELEASE'
    compile group: 'org.springframework.security', name: 'spring-security-config', version: '3.2.0.RELEASE'
    compile group: 'org.springframework.security', name: 'spring-security-taglibs', version: '3.2.0.RELEASE'
    compile 'org.springframework.security:spring-security-web:3.2.0.RELEASE'
    //hibernateç›¸å…³
    compile 'org.hibernate:hibernate-core:4.3.6.Final'
    //c3p0è¿æ¥æ± 
    compile group: 'org.hibernate', name: 'hibernate-c3p0', version: '4.3.6.Final'
    //ehcaheäºŒçº§ç¼“å­˜
    compile group: 'org.hibernate', name: 'hibernate-ehcache', version: '4.3.6.Final'
    //mysql
    compile group: 'mysql', name: 'mysql-connector-java', version: '5.1.39'
    //springData
    compile group: 'org.springframework.data', name: 'spring-data-jpa', version: '1.10.3.RELEASE'
    // https://mvnrepository.com/artifact/log4j/log4jæ—¥å¿—
    compile group: 'log4j', name: 'log4j', version: '1.2.17'
    //jsonè§£æç›¸å…³
    compile group: 'com.fasterxml.jackson.core', name: 'jackson-databind', version: '2.5.4'
    compile group: 'com.fasterxml.jackson.core', name: 'jackson-core', version: '2.5.4'
    //è¿…é›·æ¥å£æœ‰å…³jar åŒ…
    compile 'org.apache.httpcomponents:httpclient:4.4'
    compile 'org.json:json:20141113'
    compile group: 'org.apache.clerezza.ext', name: 'org.json.simple', version: '0.4'
    //https://mvnrepository.com/artifact/org.apache.commons/commons-io è¯»å–æ–‡ä»¶ç›¸å…³
    compile group: 'org.apache.commons', name: 'commons-io', version: '1.3.2'
    // https://mvnrepository.com/artifact/org.apache.poi/poi æ–‡ä»¶è¯»å–ç›¸å…³ apache-poi
    compile group: 'org.apache.poi', name: 'poi', version: '3.9'
    // https://mvnrepository.com/artifact/org.apache.poi/poi-ooxml è§£å†³execl ç‰ˆæœ¬å·®å¼‚
    compile group: 'org.apache.poi', name: 'poi-ooxml', version: '3.9'
    // https://mvnrepository.com/artifact/commons-io/commons-io æ–‡ä»¶ä¸Šä¼ 
    compile group: 'commons-io', name: 'commons-io', version: '1.3.1'
    // https://mvnrepository.com/artifact/commons-fileupload/commons-fileupload
    compile group: 'commons-fileupload', name: 'commons-fileupload', version: '1.2.2'
}
```

### **3. å„å±‚åŒ…åŠŸèƒ½è®²è§£ & é¡¹ç›®æ­å»ºå®Œæ¯•æœ€ç»ˆæ•ˆæœæ¼”ç¤ºå›¾**

**3.1 é¡¹ç›®ä¸­å„å±‚åŒ…åŠŸèƒ½è®²è§£**

é¡¹ç›®ä¸­ Java æºä»£ç å±‚çº§ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![20241229154732_XHVuaqIU.webp](https://cdn.dong4j.site/source/image/20241229154732_XHVuaqIU.webp)

å¯¹äº www åŒ…ä¸­çš„å„åˆ†å±‚ï¼Œæˆ‘ä»¬å¯¹ç…§ä¸Šå›¾é‡ç‚¹è¯´æ˜ï¼š

controller: ç”¨äºè·¯ç”±å„ç§ http è®¿é—®ï¼Œå…¶ä¸­å¯ä»¥å®ç°å¯¹å‰å°é¡µé¢å‚æ•°çš„å¯¹è±¡åŒ–ç»‘å®šï¼Œè¿™ä¸ªåŠŸèƒ½çš„å®ç°æ˜¯ä¾èµ–äº spring mvc ä¸­çš„å‚æ•°ç»‘å®šåŠŸèƒ½ï¼Œä»¥åŠè¿”å›å‘å‰ç«¯é¡µé¢è¿”å›æ•°æ®ã€‚ä¹Ÿå¯ä»¥å®ç°åŸºäº Restful é£æ ¼ API çš„ç¼–å†™ã€‚

daoï¼šç”¨äºå®ç°å¯¹æ•°æ®åº“çš„æ“ä½œï¼ŒåŒ…ä¸­çš„ä»£ç ç»§æ‰¿å¹¶å®ç°è‡ª common ä¸­çš„ dao å±‚ä»£ç ï¼Œé‡‡ç”¨çš„æ˜¯ç±»çš„é€‚é…å™¨æ¨¡å¼å®ç°çš„ï¼Œè¿™é‡Œçš„ä»£ç å€¼å¾—ç»†ç»†å“å‘³ï¼Œå¯ä»¥è¯´æ˜¯æ•´ä¸ªé¡¹ç›®çš„çµé­‚æ‰€åœ¨ä¹‹å¤„ã€‚

domain: é¡¹ç›®çš„å®ä½“ç±»éƒ½å­˜åœ¨äºè¿™ä¸ªåŒ…ä¸­ï¼Œå…¶ä¸­çš„ç±»ä¸æ•°æ®åº“è¡¨ç›¸å¯¹åº”ã€‚

dto: å®ç°äº†åºåˆ—åŒ–çš„æ•°æ®ä¼ è¾“å±‚å¯¹è±¡ï¼Œç”¨äºæ¥æ”¶å‰å°å‚æ•°ï¼Œå¹¶å°è£…æˆ dto å¯¹è±¡ä¼ è¾“è‡³åå°ï¼Œä¹Ÿè´Ÿè´£ä»æ•°æ®åº“ä¸­æŸ¥è¯¢æ•°æ®çš„å°è£…ã€‚

qo: æ¨¡ç³ŠæŸ¥è¯¢å¯¹è±¡æ‰€åœ¨çš„åŒ…ï¼Œç”¨äºå°è£… QBC åŠ¨æ€æŸ¥è¯¢å‚æ•°ã€‚

rowmapperï¼šç”¨äºå¯¹åº” jdbcTemplate æŸ¥è¯¢æ•°æ®åº“è¿”å›å¯¹è±¡çš„æ•°æ®é›†ï¼Œå¹¶å°†æ•°æ®é›†ä¾ç…§æ­¤å¯¹è±¡è¿›è¡Œå°è£…ã€‚

schedulejobï¼šå®šæ—¶ä»»åŠ¡ç±»æ‰€åœ¨çš„åŒ…ï¼Œå…¶ä¸­ç±»è¦åŠ ä¸Š @Service æ³¨è§£ï¼Œå› ä¸ºå®šæ—¶ä»»åŠ¡æ³¨è§£é…ç½®åœ¨ service-applicationContext.xml ä¸­ï¼ŒåŒ…æ‰«æç»„ä»¶çš„è§„åˆ™æ˜¯åªæ‰«ææœ‰ @Service æ³¨è§£çš„ç»„ä»¶ç±»

service: ä¸šåŠ¡é€»è¾‘å±‚ï¼Œä¸»è¦å®Œæˆä¸šåŠ¡é€»è¾‘çš„ä¹¦å†™ï¼Œå…¶ä¸­è°ƒç”¨äº† dao å®ç°ç±»ä¸­çš„æ–¹æ³•ï¼Œå¹¶ä¸”æ¯ä¸ªæœ‰å…³äºæ•°æ®åº“æ“ä½œçš„æ–¹æ³•ä¸Šéƒ½åŠ ä¸Šäº† @Transaction æ³¨è§£ï¼Œ@Transaction æ˜¯ Spring Framework å¯¹ AOP çš„å¦ä¸€ç§åŒºåˆ«äºæ‹¦æˆªå™¨çš„è‡ªå®šä¹‰æ³¨è§£å®ç°ã€‚

### **4. é¡¹ç›®ä¸­é‡è¦ä»£ç è®²è§£**

ä¸»è¦è®²è§£ä¸€ä¸‹ Dao å±‚ä¸­ä»£ç å¯¹é€‚é…å™¨è®¾è®¡æ¨¡å¼çš„åº”ç”¨ï¼š

**4.1 é¦–å…ˆçœ‹ä¸‹ commom å±‚ä¸­ BaseDao.java**

```
package com.fxmms.common.dao;

import com.fxmms.common.ro.Dto;
import com.fxmms.common.ro.DtoResultWithPageInfo;
import com.fxmms.common.ro.PageQo;
import org.hibernate.Criteria;
import org.springframework.stereotype.Repository;

import java.io.Serializable;
import java.util.List;
import java.util.Map;

/**
 *
 * @param <T>
 * @usage  æ•°æ®åº“å…¬å…±æ“ä½œæ¥å£
 */
@Repository
public interface BaseDao<T> {

 /**
  *
  *
  * @param id
  * @usage æ ¹æ®idè·å–æ•°æ®åº“ä¸­å”¯ä¸€çºªå½•ï¼Œå°è£…æˆjavaå¯¹è±¡å¹¶è¿”å›
  * @return T
  */
 public T getById(Serializable id);

 /**
  *
  *
  * @param id
  * @usage æ ¹æ®idæ‡’åŠ è½½æ•°æ®åº“ä¸­å”¯ä¸€çºªå½•ï¼Œå°è£…æˆjavaå¯¹è±¡å¹¶è¿”å›
  * @return T
  */
 public T load(Serializable id);

 /**
  *
  *
  * @param columnName
  *
  * @param value
  *
  * @usage æ ¹æ®åˆ—åï¼Œä»¥åŠå¯¹åº”çš„å€¼è·å–æ•°æ®åº“ä¸­æƒŸä¸€çºªå½•ï¼Œå°è£…æˆJavaå¯¹è±¡å¹¶è¿”å›
  *
  * @return
  */
 public T getByUniqueKey(String columnName, Object value);

 /**
  *
  *
  * @param nameValuePairs
  *
  * @return T
  */
 public T getUniqueResult(Map<String, Object> nameValuePairs);

 /**
  *
  *
  * @param columnName
  *
  * @param value
  *
  * @param sort
  *
  * @param order
  *            asc/desc
  * @return List<T>
  */
 public List<T> getListByColumn(String columnName, Object value,
                                   String sort, String order);

 public List<T> getListByColumn(String columnName, Object value);

 /**
  * Í¨
  *
  * @param nameValuePairs
  *
  * @param sort
  *
  * @param order
  *            asc/desc
  * @return List<T>
  */
 public List<T> getListByColumns(Map<String, Object> nameValuePairs,
                                    String sort, String order);

 public List<T> getListByColumns(Map<String, Object> nameValuePairs);

 /**
  *
  *
  * @return List<T>
  */
 public List<T> getAll();

 /**
  *
  *
  * @param t
  * @return Serializable id
  */
 public Serializable save(T t);

 /**
  *
  *
  * @param t
  */
 public void update(T t);

 /**
  *
  *
  * @param t
  */
 public void delete(T t);

 /**
  * QBC
  * @return
  */
 public Criteria createCriteria();

 /**
  * @param <E>
  * @param <D>
  * @param criteria
  * @param pageNo
  * @param pageSize
  * @param dtoClazz
  * @return
  */
 public <E, D extends Dto> DtoResultWithPageInfo<D> queryPageListByCriteria(
            Criteria criteria, int pageNo, int pageSize, Class<D> dtoClazz);

 /**
  * @param <E>
  * @param <D>
  * @param criteria
  * @param qo
  * @param class1
  * @return
  */
 public <E, D extends Dto> DtoResultWithPageInfo<D> queryPageListByCriteriaWithQo(PageQo qo, Class<D> dtoClazz);

}
```

å…¶ä¸­å®šä¹‰äº†ä¸€äº›å¯¹æ•°æ®åº“çš„æŠ½è±¡å…¬å…±æ“ä½œæ–¹æ³•ï¼Œä»£ç ä¸­æœ‰æ³¨é‡Šï¼Œå¯ä»¥å¯¹ç…§ç†è§£ã€‚

**4.2 çœ‹ä¸‹ HibernateTemplateDao.java å¯¹ BaseDao.java çš„æŠ½è±¡å®ç°**

```
package com.fxmms.common.dao.hib;

import com.fxmms.common.dao.BaseDao;
import com.fxmms.common.ro.Dto;
import com.fxmms.common.ro.DtoResultWithPageInfo;
import com.fxmms.common.ro.PageInfo;
import com.fxmms.common.ro.PageQo;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.hibernate.Criteria;
import org.hibernate.Session;
import org.hibernate.SessionFactory;
import org.hibernate.criterion.Order;
import org.hibernate.criterion.Projections;
import org.hibernate.criterion.Restrictions;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Repository;
import org.springframework.util.StringUtils;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

/**
 *
 * @param <T>
 * @usage åº”ç”¨æ•°æ®è®¿é—®çš„çµé­‚ï¼ŒæŠ½è±¡å‡ºå„ç§æ¨¡å‹ç±»è¿›è¡Œæ•°æ®åº“è®¿é—®çš„å…¬å…±æ“ä½œã€‚
 *        ä¸»è¦ä½¿ç”¨åˆ°QBCåŠ¨æ€æŸ¥è¯¢ã€‚ä¸»è¦æ€æƒ³æ˜¯åˆ©ç”¨åå°„ã€‚
 */
@Repository
public abstract class HibernateTemplateDao<T> implements BaseDao<T> {
 protected static final Log log = LogFactory
   .getLog(HibernateTemplateDao.class);
    //é€šè¿‡åå°„ï¼Œå¯ä»¥å®ç°å¯¹ä¸åŒç±»å¯¹åº”çš„æ•°æ®è¡¨çš„æ“ä½œ
 protected abstract Class<?> getEntityClass();

 protected SessionFactory sessionFactory;

 @Autowired
 @Qualifier("sessionFactory")
 public void setSessionFactory(SessionFactory sessionFactory) {
  this.sessionFactory = sessionFactory;
 }

 public Session getSession() {
  return sessionFactory.getCurrentSession();
 }

 public Session openNewSession() {
  return sessionFactory.openSession();
 }

 @Override
 @SuppressWarnings("unchecked")
 public T getById(Serializable id) {
  return (T) getSession().get(getEntityClass(), id);
 }

 @Override
 @SuppressWarnings("unchecked")
 public T getByUniqueKey(String columnName, Object value) {
  return (T) getSession().createCriteria(getEntityClass())
    .add(Restrictions.eq(columnName, value)).uniqueResult();
 }

 @Override
 @SuppressWarnings("unchecked")
 public List<T> getListByColumn(String columnName, Object value,String sort,String order) {
  Criteria criteria = getSession().createCriteria(getEntityClass());
  criteria.add(Restrictions.eq(columnName, value));
  if(StringUtils.hasText(sort) && StringUtils.hasText(order)){
   if("asc".equals(order)){
    criteria.addOrder(Order.asc(sort));
   }else if("desc".equals(order)){
    criteria.addOrder(Order.desc(sort));
   }
  }
  List<T> list = criteria.list();
  return list;
 }

 @Override
 @SuppressWarnings("unchecked")
 public List<T> getListByColumn(String columnName, Object value) {
  Criteria criteria = getSession().createCriteria(getEntityClass());
  criteria.add(Restrictions.eq(columnName, value));
  List<T> list = criteria.list();
  return list;
 }

 @Override
 @SuppressWarnings("unchecked")
 public List<T> getListByColumns(Map<String, Object> nameValuePairs,String sort,String order){
  Criteria criteria = getSession().createCriteria(getEntityClass());
  for (Map.Entry<String, Object> entry : nameValuePairs.entrySet()) {
   criteria.add(Restrictions.eq(entry.getKey(), entry.getValue()));
  }
  if(StringUtils.hasText(sort) && StringUtils.hasText(order)){
   if("asc".equals(order)){
    criteria.addOrder(Order.asc(sort));
   }else if("desc".equals(order)){
    criteria.addOrder(Order.desc(sort));
   }
  }
  List<T> list = criteria.list();
  return list;
 }

 @Override
 @SuppressWarnings("unchecked")
 public List<T> getListByColumns(Map<String, Object> nameValuePairs){
  Criteria criteria = getSession().createCriteria(getEntityClass());
  for (Map.Entry<String, Object> entry : nameValuePairs.entrySet()) {
   criteria.add(Restrictions.eq(entry.getKey(), entry.getValue()));
  }
  List<T> list = criteria.list();
  return list;
 }
 @Override
 @SuppressWarnings("unchecked")
 public List<T> getAll() {
  return getSession().createCriteria(getEntityClass()).list();
 }

 @Override
 @SuppressWarnings("unchecked")
 public T getUniqueResult(Map<String, Object> nameValuePairs) {
  Criteria criteria = getSession().createCriteria(getEntityClass());
  for (Map.Entry<String, Object> entry : nameValuePairs.entrySet()) {
   criteria.add(Restrictions.eq(entry.getKey(), entry.getValue()));
  }
  return (T) criteria.uniqueResult();
 }

 @Override
 @SuppressWarnings("unchecked")
 public T load(Serializable id){
  return (T) getSession().load(getEntityClass(), id);
 }

 @Override
 public Serializable save(T t) {
  return getSession().save(t);
 }

 @Override
 public void update(T t) {
  Session session = this.getSession();
  session.update(t);
  //å¼ºåˆ¶åˆ·æ–°ç¼“å­˜ä¸­æ•°æ®è‡³æ•°æ®åº“ä¸­ï¼Œé˜²æ­¢å¤§æ‰¹é‡æ•°æ®æ›´æ–°ä¹‹åå‡ºç°è„æ•°æ®
  session.flush();
 }

 @Override
 public void delete(T t) {
  this.getSession().delete(t);
 }

 /**
  * QO  DtoResultWithPageInfo<dtoClazz>list+Ò³Ï¢
  *
  * @param page
  * @param pageSize
  * @param qo
  * @param dtoClazz
  * @return
  */
/* public <Q extends QueryObject, D extends Dto> DtoResultWithPageInfo<D> queryPageListByQueryObject(
   int page, int pageSize,Q qo, Class<D> dtoClazz){
  Criteria criteria = QueryObjectHelper.buildCriteria(qo, getSession());
  return queryPageListByCriteria(criteria, page, pageSize, dtoClazz);
 }*/

 /**
  * QO List<dtoClazz>
  * @param qo
  * @param dtoClazz
  * @return
  */
 /*public <Q extends QueryObject,E, D extends Dto> List<D> queryListByQueryObject(
   Q qo, Class<D> dtoClazz){
  Criteria criteria = QueryObjectHelper.buildCriteria(qo, getSession());
  @SuppressWarnings("unchecked")
  List<E> list = criteria.list();
  List<D> resultsDtoList = new ArrayList<D>();
  for(E entity:list){
   try {
    D dto = dtoClazz.newInstance();
    BeanUtils.copyProperties(entity, dto);
    resultsDtoList.add(dto);
   } catch (InstantiationException e) {
    log.error("dtoÊµì³£ExMsg==>"+e.getMessage());
   } catch (IllegalAccessException e) {
    log.error("dtoÊµì³£ExMsg==>"+e.getMessage());
   }
  }
  return resultsDtoList;
 }*/

 /**
  * queryPageListByCriteria
  *
  * Í¨criteria  DtoResultWithPageInfo<dtoClazz>list+Ò³Ï¢
  *
  * @param criteria
  *            Ñ¯
  * @param pageNo
  *            Ç°Ò³
  * @param pageSize
  *            Ã¿Ò³Ê¾
  * @param dtoClass
  *            İ´İ¶class
  *
  */
 /*public <E, D extends Dto> DtoResultWithPageInfo<D> queryPageListByCriteria(
   Criteria criteria, int pageNo, int pageSize, Class<D> dtoClazz) {

  PageInfo pageInfo = getInstancePageInfoWithCriteria(criteria, pageNo,
    pageSize);
  criteria.setProjection(null);// Í¶Ó°
  criteria.setFirstResult(pageInfo.getFirstResultNum());
  criteria.setMaxResults(pageInfo.getPageSize());
  @SuppressWarnings("unchecked")
  List<E> resultsList = criteria.list();
  List<D> resultsDtoList = new ArrayList<D>();
  for (E result : resultsList) {
   D dto;
   try {
    dto = dtoClazz.newInstance();
    try {
     BeanUtils.copyProperties(result, dto);
    } catch (Exception e) {
     log.error("Ò³Ñ¯ì³£beanì³£");
     e.printStackTrace();
    }
   } catch (InstantiationException e) {
    log.error("Ò³Ñ¯ì³£dtoÊ¼ì³£");
    e.printStackTrace();
    dto = null;
   } catch (IllegalAccessException e) {
    log.error("Ò³Ñ¯ì³£dtoÊ¼ì³£");
    e.printStackTrace();
    dto = null;
   }
   resultsDtoList.add(dto);
  }
  DtoResultWithPageInfo<D> resultWithPageInfo = new DtoResultWithPageInfo<D>(
    resultsDtoList, pageInfo);
  return resultWithPageInfo;
 }*/

 /**
  * Í¨criteria  List<dtoClazz>
  *
  * @param criteria
  * @param dtoClazz
  * @return
  */
 /*public <E, D extends Dto> List<D> queryListByCriteria(
   Criteria criteria,Class<D> dtoClazz) {

  @SuppressWarnings("unchecked")
  List<E> resultsList = criteria.list();
  List<D> resultsDtoList = new ArrayList<D>();
  for (E result : resultsList) {
   D dto;
   try {
    dto = dtoClazz.newInstance();
    try {
     BeanUtils.copyProperties(result, dto);
    } catch (Exception e) {
     log.error("Ò³Ñ¯ì³£beanì³£");
     e.printStackTrace();
    }
   } catch (InstantiationException e) {
    log.error("Ò³Ñ¯ì³£dtoÊ¼ì³£");
    e.printStackTrace();
    dto = null;
   } catch (IllegalAccessException e) {
    log.error("Ò³Ñ¯ì³£dtoÊ¼ì³£");
    e.printStackTrace();
    dto = null;
   }
   resultsDtoList.add(dto);
  }
  return resultsDtoList;
 }*/

 /*public DataTablePageList queryDataTablePageListByCriteria(
   Criteria criteria, String displayStart, String displayLength) {
  // Ü¼Â¼
  long totalRecords = 0L;
  criteria.setProjection(Projections.rowCount());
  totalRecords = (Long) criteria.uniqueResult();

  //
  criteria.setProjection(null);
  criteria.setFirstResult(Integer.parseInt(displayStart));
  criteria.setMaxResults(Integer.parseInt(displayLength));

  @SuppressWarnings("rawtypes")
  List resultsList = criteria.list();

  DataTablePageList dtpl = new DataTablePageList(
    String.valueOf((int) totalRecords), resultsList);
  return dtpl;
 }
 */

 /**
  * @param criteria
  * @param pageNo
  * @param pageSize
  * @return
  *//*
 private PageInfo getInstancePageInfoWithCriteria(Criteria criteria,
   int pageNo, int pageSize) {
  long totalQuantity = 0L;
  criteria.setProjection(Projections.rowCount());
  totalQuantity = (Long) criteria.uniqueResult();
  PageInfo pageInfo = PageInfo.getInstance(pageNo, pageSize,
    totalQuantity);
  return pageInfo;
 }*/

 @Override
 public Criteria createCriteria() {
  // TODO Auto-generated method stub
  return getSession().createCriteria(getEntityClass());
 }

 /**
  * queryPageListByCriteria
  *
  * Í¨criteria  DtoResultWithPageInfo<dtoClazz>list+Ò³Ï¢
  *
  * @param criteria
  *            Ñ¯
  * @param pageNo
  *            Ç°Ò³
  * @param pageSize
  *            Ã¿Ò³Ê¾
  * @param dtoClass
  *            İ´İ¶class
  * Øµ DtoResultWithPageInfo
  *
  * Îª queryPageListByCriteria
  */
 @Override
 public <E, D extends Dto> DtoResultWithPageInfo<D> queryPageListByCriteria(
   Criteria criteria, int pageNo, int pageSize, Class<D> dtoClazz) {
      //Ë·ÄµÃ£pageinfoÑ¾firstResult  maxresult
  PageInfo pageInfo = getInstancePageInfoWithCriteria(criteria, pageNo,
    pageSize);

  criteria.setProjection(null);// Í¶Ó°
  criteria.setFirstResult(pageInfo.getFirstResultNum());
  criteria.setMaxResults(pageInfo.getPageSize());
  @SuppressWarnings("unchecked")
  List<E> resultsList = criteria.list();
  List<D> resultsDtoList = new ArrayList<D>();
  for (E result : resultsList) {
   D dto;
   try {
    dto = dtoClazz.newInstance();
    try {
     BeanUtils.copyProperties(result, dto);
    } catch (Exception e) {
     log.error("Ò³Ñ¯ì³£beanì³£");
     e.printStackTrace();
    }
   } catch (InstantiationException e) {
    log.error("Ò³Ñ¯ì³£dtoÊ¼ì³£");
    e.printStackTrace();
    dto = null;
   } catch (IllegalAccessException e) {
    log.error("Ò³Ñ¯ì³£dtoÊ¼ì³£");
    e.printStackTrace();
    dto = null;
   }
   resultsDtoList.add(dto);
  }
  DtoResultWithPageInfo<D> resultWithPageInfo = new DtoResultWithPageInfo<D>(
    resultsDtoList, pageInfo);
  return resultWithPageInfo;
 }

 /**
  * queryPageListByCriteriaWithQo
  *
  * Í¨criteria  DtoResultWithPageInfo<dtoClazz>list+Ò³Ï¢
  *
  * @param criteria
  *            Ñ¯
  * @param pageNo
  *            Ç°Ò³
  * @param pageSize
  *            Ã¿Ò³Ê¾
  * @param dtoClass
  *            İ´İ¶class
  * Øµ DtoResultWithPageInfo
  *
  * Îª queryPageListByCriteria
  */
 @Override
 public <E, D extends Dto> DtoResultWithPageInfo<D> queryPageListByCriteriaWithQo(PageQo qo, Class<D> dtoClazz) {
      //Ë·ÄµÃ£pageinfoÑ¾firstResult  maxresult
  Criteria criteria = this.createCriteria();
  qo.add(criteria);
  PageInfo pageInfo = getInstancePageInfoWithCriteria(criteria, qo.getPage(),qo.getRows());

  criteria.setProjection(null);// Í¶Ó°
  criteria.setFirstResult(pageInfo.getFirstResultNum());
  criteria.setMaxResults(pageInfo.getPageSize());
  @SuppressWarnings("unchecked")
  List<E> resultsList = criteria.list();
  List<D> resultsDtoList = new ArrayList<D>();
  for (E result : resultsList) {
   D dto;
   try {
    dto = dtoClazz.newInstance();
    try {
     BeanUtils.copyProperties(result, dto);
    } catch (Exception e) {
     log.error("Ò³Ñ¯ì³£beanì³£");
     e.printStackTrace();
    }
   } catch (InstantiationException e) {
    log.error("Ò³Ñ¯ì³£dtoÊ¼ì³£");
    e.printStackTrace();
    dto = null;
   } catch (IllegalAccessException e) {
    log.error("Ò³Ñ¯ì³£dtoÊ¼ì³£");
    e.printStackTrace();
    dto = null;
   }
   resultsDtoList.add(dto);
  }
  DtoResultWithPageInfo<D> resultWithPageInfo = new DtoResultWithPageInfo<D>(
    resultsDtoList, pageInfo);
  return resultWithPageInfo;
 }

 /**
  * Í¨Ñ¯Ê¼Ò³Ï¢
  *
  * @param criteria
  * @param pageNo
  * @param pageSize
  * @return
  */
 private PageInfo getInstancePageInfoWithCriteria(Criteria criteria,
  int pageNo, int pageSize) {
   long totalQuantity = 0L;
         //  ÜµtotalQuality
  criteria.setProjection(Projections.rowCount());
  totalQuantity = (Long) criteria.uniqueResult();

  PageInfo pageInfo = PageInfo.getInstance(pageNo, pageSize,
    totalQuantity);
  return pageInfo;
 }
}
```

è¿™ä¸ªæ–¹æ³•æ˜¯æä¸ºé‡è¦çš„ **protected abstract Class getEntityClass();**

åç»­ä»‹ç»ï¼Œç°åœ¨æš‚æ—¶æœ‰ä¸ªå°è±¡ã€‚

åœ¨ www ä¸­çš„ dao å±‚æœ‰ä¸å„å…·ä½“ç±» (æ•°æ®è¡¨) ç›¸å¯¹åº”çš„æ•°æ®åº“æ“ä½œå®ç°ï¼š

![20241229154732_tHo8ryx3.webp](https://cdn.dong4j.site/source/image/20241229154732_tHo8ryx3.webp)

ä¸Šå›¾å£°æ˜äº†ä¸‰ä¸ªå…·ä½“ç±»å¯¹åº”çš„æ¥å£å£°æ˜ï¼šAdminDaoã€MacDaoã€TaskDaoã€‚

å¯¹åº”ä¸‰ä¸ªæ¥å£æœ‰ä¸‰ä¸ªå…·ä½“çš„å®ç°ç±»ï¼šAdminDaoImplã€MacDaoImplã€TaskDaoImplã€‚

æˆ‘ä»¬ä»¥ä¸ Admin ç±»ç›¸å…³çš„ dao å±‚æ“ä½œä¸ºä¾‹ï¼š

**Admin.java**

```
package com.fxmms.www.domain;

import org.hibernate.annotations.GenericGenerator;

import javax.persistence.*;

/**
 * Created by mark on 16/11/2.
 * @usage ç®¡ç†å‘˜å®ä½“ç±»ï¼Œä¸æ•°æ®åº“ä¸­è¡¨ç›¸å¯¹åº”
 */
@Entity
@Table(name = "mms_admin")
public class Admin {
    @Id
    @GeneratedValue(generator = "increment")
    @GenericGenerator(name = "increment", strategy = "increment")
    @Column
    private int id;
    @Column
    private String userName;
    @Column
    private String password;
    @Column
    private String role;
    @Column
    private int enable;
    @Column
    private int isDelete;

    public int getId() {
        return id;
    }

    public void setId(int id) {
        this.id = id;
    }

    public String getUserName() {
        return userName;
    }

    public void setUserName(String userName) {
        this.userName = userName;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    public String getRole() {
        return role;
    }

    public void setRole(String role) {
        this.role = role;
    }

    public int getEnable() {
        return enable;
    }

    public void setEnable(int enable) {
        this.enable = enable;
    }

    public int getIsDelete() {
        return isDelete;
    }

    public void setIsDelete(int isDelete) {
        this.isDelete = isDelete;
    }
}
```

AdminDao.java

```
package com.fxmms.www.dao;

import com.fxmms.common.dao.BaseDao;
import com.fxmms.www.domain.Admin;

/**
 * Created by mark on 16/10/31.
 * @usage æ“ä½œç®¡ç†å‘˜æ•°æ®åº“è®¿é—®æ¥å£
 */
public interface AdminDao extends BaseDao<Admin> {

}
```

**AdminDaoImpl.java**

```
package com.fxmms.www.dao.hib;

import com.fxmms.common.dao.hib.HibernateTemplateDao;
import com.fxmms.www.dao.AdminDao;
import com.fxmms.www.domain.Admin;

/**
 * Created by mark on 16/11/2.
 * @usage ä½¿ç”¨é€‚é…å™¨æ¨¡å¼ï¼Œå°†commonå±‚ä¸­å®šä¹‰çš„å…¬å…±è®¿é—®æ•°æ®åº“æ–¹æ³•å®ç°å«æ¥åˆ°Adminç±»çš„æ¥å£ä¸­ã€‚
 */
public class AdminDaoImpl extends HibernateTemplateDao<Admin> implements AdminDao {

    @Override
    protected Class<?> getEntityClass() {
        // TODO Auto-generated method stub
        return Admin.class;
    }
}
```

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å…·ä½“ç±»ç›¸å…³çš„æ•°æ®åº“æ“ä½œå®ç°ç±»ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç° HibernateTemplateDao ä¸­æŠ½è±¡æ–¹æ³• protected Class getEntityClass()ï¼›å³å¯ã€‚

ç»™æˆ‘ä»¬çš„æ„Ÿè§‰å°±æ˜¯è¿™ä¸ªæ–¹æ³•çš„å®ç°æ˜¯ç”»é¾™ç‚¹ç›ä¹‹ç¬”ã€‚

å›è¿‡å¤´å»çœ‹ï¼Œåœ¨ HibernateTemplateDao ç±»ä¸­æ‰€æœ‰ä¸æ•°æ®åº“æ“ä½œæœ‰å…³çš„æ–¹æ³•ï¼š

ä¾‹å¦‚ï¼š

```
@Override
 @SuppressWarnings("unchecked")
 public T getByUniqueKey(String columnName, Object value) {
  return (T) getSession().createCriteria(getEntityClass())
    .add(Restrictions.eq(columnName, value)).uniqueResult();
 }
```

getEntityClass() æ–¹æ³•æœ€ç»ˆéƒ½ä¼šè¢«å…·ä½“çš„ç±»æ‰€å®ç°ã€‚è¿™ä¸ªè®¾è®¡çœŸçš„æ˜¯å¾ˆå·§å¦™ã€‚

### **5. é…ç½® tomcat è¿è¡Œç¯å¢ƒ**

é¡¹ç›®æ­å»ºå·²ç»å®Œæ¯•ï¼Œæ¥ä¸‹æ¥éœ€è¦åšçš„å°±æ˜¯é…ç½®é¡¹ç›®çš„è¿è¡Œç¯å¢ƒäº†ï¼Œè¿™é‡Œæˆ‘ä»¬é‡‡ç”¨ tomcat æ¥å……å½“åº”ç”¨æœåŠ¡å™¨ã€‚

**5.1 å»å®˜ç½‘ä¸‹è½½** **tomcat 8.0** ï¼š

**5.2 é…ç½® tomcat æœåŠ¡å™¨ï¼š**

ç‚¹å‡» Edit Configurations

![20241229154732_tHo8ryx3.webp](https://cdn.dong4j.site/source/image/20241229154732_tHo8ryx3.webp)

ç‚¹å‡» **+** , å¹¶é€‰æ‹© Tomcat Server ä¸­ local é€‰é¡¹

![20241229154732_ojYcFsU5.webp](https://cdn.dong4j.site/source/image/20241229154732_ojYcFsU5.webp)

æ·»åŠ å¯åŠ¨ä»»åŠ¡åç§°ï¼Œé»˜è®¤ä¸º unnamed

![20241229154732_ig9DUzOL.webp](https://cdn.dong4j.site/source/image/20241229154732_ig9DUzOL.webp)

é…ç½® Application Server

![20241229154732_fIKJvfBo.webp](https://cdn.dong4j.site/source/image/20241229154732_fIKJvfBo.webp)

è£…è½½å¼€å‘ç‰ˆ (exploded) åº”ç”¨ war åŒ…, æ­¤æ­¥éª¤æœ‰ä¸¤ç§æ–¹å¼ï¼š

ç¬¬ä¸€ç§æ–¹å¼ï¼šé€‰æ‹© Deploy at the server startup ä¸‹æ–¹çš„ **+** ï¼Œå…¥ä¸‹å›¾æ‰€ç¤ºï¼š

![20241229154732_lD9SgjpR.webp](https://cdn.dong4j.site/source/image/20241229154732_lD9SgjpR.webp)

æ¥ä¸‹æ¥åœ¨ Select Artifacts Deploy å¼¹å‡ºæ¡†ä¸­ é€‰æ‹© exploded å±æ€§çš„ war åŒ…

![20241229154732_BJd5P2dY.webp](https://cdn.dong4j.site/source/image/20241229154732_BJd5P2dY.webp)

æ¥ä¸‹æ¥é€‰æ‹© applyï¼> ok ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯ï¼š

![20241229154732_PcOBGRdB.webp](https://cdn.dong4j.site/source/image/20241229154732_PcOBGRdB.webp)

![20241229154732_hYLbPDmx.webp](https://cdn.dong4j.site/source/image/20241229154732_hYLbPDmx.webp)

æœ€ç»ˆç‚¹å‡»å¯åŠ¨æŒ‰é’®å¯åŠ¨åº”ç”¨

![20241229154732_c5xOPjVC.webp](https://cdn.dong4j.site/source/image/20241229154732_c5xOPjVC.webp)

æœ€ç»ˆçš„å¯åŠ¨æ•ˆæœå¦‚ä¸‹æ‰€ç¤º

![20241229154732_YWeoAGWC.webp](https://cdn.dong4j.site/source/image/20241229154732_YWeoAGWC.webp)

### **6.webapp æ–‡ä»¶å¤¹ä¸‹åˆ†å±‚è¯¦è§£**

webapp ä¸‹æœ‰ res æ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜å‚¨é™æ€æ–‡ä»¶ï¼ŒWEB-INF æ–‡ä»¶å¤¹ä¸‹æœ‰ view æ–‡ä»¶å¤¹è¡¨ç¤º

å…³äºé¡¹ç›®ä¸­åº”ç”¨åˆ°çš„ JNI æŠ€æœ¯ï¼Œä¼šåœ¨åé¢è®²è§£ï¼Œä¸»è¦ä¾§é‡ç‚¹æ˜¯åœ¨ä»£ç å±‚é¢è§£å†³ JNI link library çš„é—®é¢˜ã€‚

## [ä½¿ç”¨Axiosæ‹¦æˆªå™¨ç»Ÿä¸€å¤„ç†HTTPè¯·æ±‚å’Œå“åº”](https://blog.dong4j.site/posts/d9e151a4.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

è¦æƒ³ç»Ÿä¸€å¤„ç†æ‰€æœ‰ http è¯·æ±‚å’Œå“åº”ï¼Œå°±å¾—ç”¨ä¸Š axios çš„æ‹¦æˆªå™¨ã€‚é€šè¿‡é…ç½® http response inteceptorï¼Œå½“åç«¯æ¥å£è¿”å› 401 Unauthorizedï¼ˆæœªæˆæƒï¼‰ï¼Œè®©ç”¨æˆ·é‡æ–°ç™»å½•ã€‚

```javascript
// http request æ‹¦æˆªå™¨
axios.interceptors.request.use(
    config => {
        if (store.state.token) {  // åˆ¤æ–­æ˜¯å¦å­˜åœ¨tokenï¼Œå¦‚æœå­˜åœ¨çš„è¯ï¼Œåˆ™æ¯ä¸ªhttp headeréƒ½åŠ ä¸Štoken
            config.headers.Authorization = `token ${store.state.token}`;
        }
        return config;
    },
    err => {
        return Promise.reject(err);
    });

// http response æ‹¦æˆªå™¨
axios.interceptors.response.use(
    response => {
        return response;
    },
    error => {
        if (error.response) {
            switch (error.response.status) {
                case 401:
                    // è¿”å› 401 æ¸…é™¤tokenä¿¡æ¯å¹¶è·³è½¬åˆ°ç™»å½•é¡µé¢
                    store.commit(types.LOGOUT);
                    router.replace({
                        path: 'login',
                        query: {redirect: router.currentRoute.fullPath}
                    })
            }
        }
        return Promise.reject(error.response.data)   // è¿”å›æ¥å£è¿”å›çš„é”™è¯¯ä¿¡æ¯
    });

é¦–å…ˆæˆ‘ä»¬è¦æ˜ç™½è®¾ç½®æ‹¦æˆªå™¨çš„ç›®çš„æ˜¯ä»€ä¹ˆ,å½“æˆ‘ä»¬éœ€è¦ç»Ÿä¸€å¤„ç†httpè¯·æ±‚å’Œå“åº”æ—¶æˆ‘ä»¬é€šè¿‡è®¾ç½®æ‹¦æˆªå™¨å¤„ç†æ–¹ä¾¿å¾ˆå¤š.

è¿™ä¸ªé¡¹ç›®æˆ‘å¼•å…¥äº†element uiæ¡†æ¶,æ‰€ä»¥æˆ‘æ˜¯ç»“åˆelementä¸­loadingå’Œmessageç»„ä»¶æ¥å¤„ç†çš„.æˆ‘ä»¬å¯ä»¥å•ç‹¬å»ºç«‹ä¸€ä¸ªhttpçš„jsæ–‡ä»¶å¤„ç†axios,å†åˆ°main.jsä¸­å¼•å…¥.

/**
 * httpé…ç½®
 */
// å¼•å…¥axiosä»¥åŠelement uiä¸­çš„loadingå’Œmessageç»„ä»¶
import axios from 'axios'
import { Loading, Message } from 'element-ui'
// è¶…æ—¶æ—¶é—´
axios.defaults.timeout = 5000
// httpè¯·æ±‚æ‹¦æˆªå™¨
var loadinginstace
axios.interceptors.request.use(config => {
 // element ui Loadingæ–¹æ³•
 loadinginstace = Loading.service({ fullscreen: true })
 return config
}, error => {
 loadinginstace.close()
 Message.error({
 message: 'åŠ è½½è¶…æ—¶'
 })
 return Promise.reject(error)
})
// httpå“åº”æ‹¦æˆªå™¨
axios.interceptors.response.use(data => {// å“åº”æˆåŠŸå…³é—­loading
 loadinginstace.close()
 return data
}, error => {
 loadinginstace.close()
 Message.error({
 message: 'åŠ è½½å¤±è´¥'
 })
 return Promise.reject(error)
})

export default axios
```

## [æŒæ¡Sublime Texté«˜æ•ˆå¿«æ·é”®ï¼Œæå‡ç¼–ç¨‹æ•ˆç‡](https://blog.dong4j.site/posts/350ed0bd.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

Sublime Text æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ–‡æœ¬ç¼–è¾‘å™¨ï¼Œæä¾›äº†ä¸°å¯Œçš„å¿«æ·é”®æ¥æé«˜ç¼–ç¨‹æ•ˆç‡ã€‚ä»¥ä¸‹æ˜¯ Sublime Text ä¸­ä¸€äº›å¸¸ç”¨çš„å¿«æ·é”®ã€‚

## åŸºæœ¬æ“ä½œ

- **æ‰“å¼€å‘½ä»¤é¢æ¿**ï¼š`Shift + Cmd + P`
- **æ§åˆ¶å°**ï¼š`Ctrl + ` (åå¼•å·)
- **æ–°å»ºæ ‡ç­¾é¡µ**ï¼š`Cmd + N`
- **åˆ‡æ¢æ ‡ç­¾é¡µï¼ˆé€šè¿‡æ•°å­—ï¼‰**ï¼š`Cmd + æ•°å­—`
- **åˆ†æˆä¸¤å±æ˜¾ç¤º**ï¼š`Cmd + Option + 2`

## æŸ¥æ‰¾ä¸æ›¿æ¢

- **æŸ¥æ‰¾æ–‡æœ¬**ï¼š`Cmd + F`
- **æŸ¥æ‰¾å¹¶æ›¿æ¢æ–‡æœ¬**ï¼š`Option + Cmd + F`
- **è·³è½¬åˆ°å‡½æ•°æˆ–æ–¹æ³•**ï¼š`Cmd + R`
- **æ·»åŠ /åˆ é™¤é€‰ä¸­è¡Œçš„æ³¨é‡Š**ï¼š`Cmd + /`

## ç¼–è¾‘ä¸æ ¼å¼åŒ–

- **æ™ºèƒ½ç¼©è¿›ï¼ˆå¢åŠ æˆ–å‡å°‘ç¼©è¿›ï¼‰**ï¼š`Cmd + [ æˆ– Cmd + ]`
- **æ˜¾ç¤º/éšè—ä¾§è¾¹æ **ï¼š`Cmd + K, B`
- **åˆ é™¤å…‰æ ‡å‰æ‰€æœ‰å­—ç¬¦ (Mac)**ï¼š`Cmd + Delete`

### JSON å’Œ HTML æ ¼å¼åŒ–

- **æ ¼å¼åŒ– JSON æ–‡ä»¶**ï¼š`Ctrl + Cmd + J`
- **æ ¼å¼åŒ– HTML æ–‡ä»¶**ï¼š`Shift + Cmd + H`

## å…·ä½“å‘½ä»¤åˆ—è¡¨

ä»¥ä¸‹æ˜¯ä¸€äº›å…·ä½“æ“ä½œå¯¹åº”çš„å¿«æ·é”®ï¼š

- **æ–‡ä»¶è·³è½¬**: `Cmd + T`
- **è¡Œå·è·³è½¬ (ç±»ä¼¼ Vim çš„ num + gg)**: `Ctrl + G`
- **å‡½æ•°/æ–¹æ³•è·³è½¬**: `Cmd + R`
- **ç»™é€‰ä¸­è¡Œæ·»åŠ æˆ–å»æ‰æ³¨é‡Š**: `Cmd + /`
- **åˆ é™¤å½“å‰è¡Œ**: `Ctrl + Shift + K`
- **è½¬æ¢ä¸ºå¤§å†™**: `Cmd + K, U`
- **è½¬æ¢ä¸ºå°å†™**: `Cmd + K, L`
- **ç²˜è´´å¹¶ç¼©è¿›æ–‡æœ¬**: `Cmd + Shift + V`

### é¡µé¢æ“ä½œ

- **æ–°å»ºé¡µé¢**ï¼š`Cmd + N`
- **åˆ‡æ¢åˆ°æŒ‡å®šé¡µ (é€šè¿‡æ•°å­—é”®)**ï¼š`Cmd + æ•°å­—`
- **æœç´¢è·³è½¬åˆ°å¯¹åº”é¡µ**ï¼š`Cmd + P`
- **å…³é—­é¡µé¢**ï¼š`Cmd + W`
- **åˆå¹¶ä¸€è¡Œ**: `Cmd + J`

### å¤åˆ¶ã€ç²˜è´´ä¸åˆ é™¤

- **é€‰ä¸­å½“å‰å•è¯ï¼Œç»§ç»­æ•²å¯ä»¥é€‰ä¸­å¤šä¸ªç›¸åŒå•è¯**ï¼š`Cmd + D`
- **é€‰æ‹©å½“å‰å…‰æ ‡æ•´è¡Œ**: `Cmd + L`
- **æ’¤é”€æ“ä½œ**ï¼š`Cmd + Z`
- **å¤åˆ¶æ–‡æœ¬**ï¼š`Cmd + C`
- **ç²˜è´´æ–‡æœ¬**ï¼š`Cmd + V`

### å…¶ä»–

- **ä¿å­˜æ–‡ä»¶**ï¼š`Cmd + S`
- **åˆ é™¤å…‰æ ‡å®šä½åˆ°å½“å‰è¡Œèµ·å§‹çš„ä¸€å—**: `Cmd + Delete`
- **ç¼©è¿›/å›ç¼©å½“å‰è¡Œ**: `Cmd+]` æˆ– `Cmd+[`
- **å‘ä¸‹å¼€è¾Ÿä¸€è¡Œ**: `Cmd + Enter`
- **å‘ä¸Šå¼€è¾Ÿä¸€è¡Œ**: `Cmd + Shift + Enter`
- **æŸ¥è¯¢å†…å®¹**ï¼š`Cmd + F`
- **å…¨å±€æŸ¥æ‰¾å¹¶æ›¿æ¢**: `Cmd + Shift + F`

### é€‰æ‹©æ“ä½œ

- **æŸ¥è¯¢åˆ°çš„å†…å®¹ä¸‹ä¸€ä¸ªåŒ¹é…é¡¹**ï¼š`Cmd + G`
- **å¤šç‚¹ç¼–è¾‘ï¼ˆé€šè¿‡é¼ æ ‡å³é”®ï¼‰**
- **è°ƒå‡ºæ§åˆ¶å°**ï¼š`Cmd + ~`
- **å‰å¾€åŒ¹é…çš„æ‹¬å·**ï¼š`Ctrl + M`

### å…‰æ ‡ç§»åŠ¨ä¸é€‰æ‹©

- **å…‰æ ‡å®šä½åˆ°å½“å‰è¡Œæœ€å‰ (Mac)**: `Cmd + å·¦ç®­å¤´`
  - åŠ ä¸Š `Shift`: é€‰ä¸­ä»å½“å‰ä½ç½®è‡³è¡Œé¦–çš„éƒ¨åˆ†
- **å…‰æ ‡å®šä½åˆ°å½“å‰è¡Œæœ€å**: `Cmd + å³ç®­å¤´`
  - åŠ ä¸Š `Shift`: é€‰ä¸­ä»å½“å‰ä½ç½®è‡³è¡Œå°¾çš„éƒ¨åˆ†
- **çºµå‘é€‰æ‹©ç¼–è¾‘ (Mac)**: `Option + å·¦é”®ç‚¹å‡»å¹¶æ‹–åŠ¨`

### å¯¼èˆªä¸åˆ‡æ¢æ ‡ç­¾é¡µ

- **è·³è½¬åˆ°æŒ‡å®šè¡Œå·**ï¼š`Ctrl + G`
- **åˆ‡æ¢å•ä¸ªæ ‡ç­¾é¡µï¼ˆå‘å‰å’Œå‘åï¼‰**:
  - `Ctrl + Tab`: åˆ‡æ¢è‡³ä¸‹ä¸€ä¸ªæ ‡ç­¾é¡µ
  - `Ctrl + Shift + Tab`: åˆ‡æ¢è‡³ä¸Šä¸€ä¸ªæ ‡ç­¾é¡µ

### åˆ é™¤æ“ä½œ

- **åˆ é™¤å…‰æ ‡å®šä½åˆ°å½“å‰å•è¯èµ·å§‹çš„ä¸€å— (PC)**: `Ctrl + Delete`

## [ç³»ç»Ÿçº§æ“ä½œä¸ç¬¬ä¸‰æ–¹è½¯ä»¶ï¼šmacOS å¿«æ·é”®å…¨è§£](https://blog.dong4j.site/posts/6dad3a8f.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

åœ¨ macOS æ“ä½œç³»ç»Ÿä¸­ï¼Œå¿«æ·é”®æ˜¯æé«˜å·¥ä½œå’Œç”Ÿæ´»æ•ˆç‡çš„é‡è¦å·¥å…·ä¹‹ä¸€ã€‚æŒæ¡è¿™äº›å¸¸ç”¨å¿«æ·é”®èƒ½è®©ä½ æ›´åŠ å¾—å¿ƒåº”æ‰‹åœ°æ“ä½œç”µè„‘ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç» macOS ç³»ç»Ÿã€åº”ç”¨ç¨‹åºä»¥åŠå¼€å‘å·¥å…·ç›¸å…³çš„å¿«æ·é”®ã€‚

## å¸¸ç”¨ macOS å¿«æ·é”®

### ç³»ç»Ÿçº§å¿«æ·é”®

1. **æ§åˆ¶ + shift + å…³æœºé”®** - è®© Mac è¿›å…¥ä¼‘çœ æ¨¡å¼ã€‚
2. **å¼€æœºæ—¶æŒ‰ä½ shift+enter** - å¿½ç•¥è‡ªå¯åŠ¨è½¯ä»¶ï¼Œç›´æ¥åŠ è½½ç³»ç»Ÿã€‚
3. **æ§åˆ¶ + f2** - åœ¨ä»»åŠ¡æ ï¼ˆDockï¼‰ä¸Šç§»åŠ¨ç„¦ç‚¹ã€‚
4. **æ§åˆ¶ + f3** - é€‰æ‹© dock ä¸­çš„åº”ç”¨æˆ–å›¾æ ‡ã€‚
5. **opt + cmd + å³ä¸Šè§’** - é”å®šå±å¹•ã€‚
6. **option + command + esc** - å¼ºåˆ¶é€€å‡ºæœªå“åº”çš„åº”ç”¨ç¨‹åºã€‚
7. **control + å³ä¸Šè§’** - è°ƒå‡ºå…³æœºå¸®åŠ©ç•Œé¢ã€‚
8. **Ctrl + å…³æœºé”®** - æ˜¾ç¤ºå…³æœºæç¤ºå¯¹è¯æ¡†ï¼Œå¯ä»¥å–æ¶ˆå…³é—­æ“ä½œã€‚
9. **Ctrl + Opt + å…³æœºé”®** - å®‰å…¨åœ°å…³é—­ Mac ç”µè„‘ã€‚
10. **Ctrl + Cmd + å…³æœºé”®** - é‡å¯ Mac ç”µè„‘ã€‚
11. **Shift + Ctrl + Opt + å…³æœºé”®** - ç«‹å³æ–­ç”µå…³é—­ç”µè„‘ï¼Œä¸è¿›è¡Œä»»ä½•ä¿å­˜æ“ä½œï¼Œè¯·è°¨æ…ä½¿ç”¨æ­¤å¿«æ·é”®ã€‚
12. **opt + `\`** - æ‰“å¼€ Finder çª—å£ã€‚
13. å½“æœ‰å¤–éƒ¨æ˜¾ç¤ºå™¨æ—¶ï¼Œå¯ä»¥é€šè¿‡æŒ‰ **control + `\`** å°†å½“å‰æ¿€æ´»çš„åº”ç”¨ç¨‹åºç§»åŠ¨åˆ°å¤–æ¥å±å¹•ä¸Šã€‚
14. ä½¿ç”¨ **control + 1 ~ 9** å¯ä»¥ç›´æ¥æ‰“å¼€ Dock æ ä¸­çš„åº”ç”¨ç¨‹åºã€‚

### è®¾ç½®.app --> é”®ç›˜ --> å¿«æ·é”®

- æ˜¾ç¤º mission control: **control + ä¸Šç®­å¤´ / option 4 æŒ‡ä¸Šæ»‘**
- æ‰“å¼€åº”ç”¨çª—å£ï¼š **control + ä¸‹ç®­å¤´ / option 4 æŒ‡å‘ä¸‹æ»‘åŠ¨**
- åˆ‡æ¢æ¡Œé¢ï¼š **control + å·¦/å³/1/2/3/4/5/6 æˆ–è€…ä½¿ç”¨ TotalSpaces2 æ’ä»¶çš„é€‰é¡¹ï¼Œå¯ä»¥ä½¿ç”¨ 4 æ‰‹æŒ‡ä¸Šä¸‹å·¦å³æ»‘åŠ¨**
- åˆ‡æ¢è¾“å…¥æ³•: **command + ç©ºæ ¼é”®**
- å°†æ–‡ä»¶æ·»åŠ åˆ° Yoink åº”ç”¨ï¼š**Hybrid (Ctrl+Opt+Cmd+Shift) + y**
- æ˜¾ç¤º Finder æœç´¢çª—å£:**option + command +ç©ºæ ¼**

## ç¬¬ä¸‰æ–¹è½¯ä»¶å¿«æ·é”®

### eudic.app

1. å±•ç¤º/éšè—çª—å£: **hybridï¼ˆControl+Option+Command+Shiftï¼‰+9**
2. ç¿»è¯‘é€‰ä¸­çš„å†…å®¹: **hybrid + 0**
3. å–è¯ï¼šæ§åˆ¶+é€‰é¡¹+å‘½ä»¤

### Karabiner.app

- å®šä¹‰äº† Hybrid ä½œä¸º Ctrl+Opt+Cmd+Shiftã€‚

1. ä½¿ç”¨ **right_shift + a/c/d/e/f/s/t/m** åˆ†åˆ«å¿«é€Ÿæ‰“å¼€ Activity Monitor, Chrome, Dash, Sublime Text, Finder, Safari, iTerm å’Œ MWeb åº”ç”¨ç¨‹åº.
2. åœ¨åº”ç”¨å†…åˆ‡æ¢æ ‡ç­¾é¡µ: **right_command + l/h**
3. è°ƒå‡º TextExpanderï¼š**hybrid + t**

### Alfred.app

1. æ‰“å¼€ Alfred ç•Œé¢ï¼š**option + ç©ºæ ¼é”®**
2. è®¿é—®å‰ªè´´æ¿å†å²è®°å½•ï¼šåŒå‡» command é”®ã€‚
3. æ‰“å¼€ iTunes è¿·ä½ æ’­æ”¾å™¨çª—å£: **hybrid + enter**
4. åœ¨ SnippetsLab ä¸­æœç´¢æ¡ç›®:**hybrid + s**

### Dropzone.app

1. å¿«é€Ÿå¯åŠ¨ Dropzoneï¼š**Hybrid + F12**

### Things.app

1. æ·»åŠ æ–°å¾…åŠäº‹é¡¹åˆ°åˆ—è¡¨ï¼š**hybrid + ç©ºæ ¼**

### Snappy.app

1. æˆªå–å±å¹•å¿«ç…§: **command + shift + 2**
2. å…³é—­ Snappy: command + W æˆ–è€…åŒå‡»
3. ç§»åŠ¨æˆªå›¾æˆ–é€‰æ‹©åŒºåŸŸï¼šå·¦é”®ç‚¹å‡»å¹¶æ‹–åŠ¨
4. æŒ‰åƒç´ ç§»åŠ¨é€‰åŒºï¼šæŒ‰ä½ altï¼Œç„¶åä¸Šä¸‹å·¦å³ç§»åŠ¨å…‰æ ‡ã€‚
5. è°ƒæ•´æˆªå±å¤§å°ï¼šæŒ‰ä½ alt+ctrlï¼Œç„¶åæ‹–åŠ¨è§’æˆ–è€…è¾¹æ¡†ã€‚
6. å¢åŠ /å‡å°‘æˆªå›¾çš„å°ºå¯¸ï¼šcommand + + æˆ–è€… -
7. æ›´æ”¹é€æ˜åº¦ï¼š0-9
8. æ¢å¤é»˜è®¤çŠ¶æ€ï¼šcommand 0

### TotalFinder æ’ä»¶

1. ä½¿ç”¨ **åŒå‡» control** æ‰“å¼€ Finder çª—å£.
2. ä½¿ç”¨ control+`å¿«æ·é”®æ¥æ‰“å¼€ finder

### CmdTap æ’ä»¶

1. ä½¿ç”¨**option + tab**åˆ‡æ¢åº”ç”¨ã€‚
2. ä½¿ç”¨**åŒå‡» option** åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªåº”ç”¨ç¨‹åº.

### HyperDock æ’ä»¶

- è°ƒæ•´çª—å£å¤§å°ï¼šhybrid+ æ–¹å‘é”®/æ•°å­—é”®ï¼ˆä¾‹å¦‚ï¼šå‘å·¦æˆ–å‘å³è°ƒæ•´ï¼‰
- è‡ªå®šä¹‰çª—å£å°ºå¯¸ï¼šåœ¨æ‹–åŠ¨æ—¶æŒ‰ä½ hybrid+ å·¦é”®

### Bartender æ’ä»¶

1. é€šè¿‡ **hybrid + b** æ˜¾ç¤ºéšè—çš„åº”ç”¨å›¾æ ‡ã€‚

### Sublime Text.appã€Idea.app å’Œ VSCode.app

æ‰€æœ‰è¿™ä¸‰ä¸ªæ–‡æœ¬ç¼–è¾‘å™¨/IDE éƒ½æä¾›äº†æ ¼å¼åŒ–ä»£ç çš„å¿«æ·é”®ï¼ˆä½¿ç”¨ä¸åŒçš„å‘½ä»¤ï¼‰ï¼Œä½†å®ƒä»¬éƒ½æ”¯æŒ **option+command+l** è¿›è¡Œå¿«é€Ÿæ ¼å¼åŒ–ã€‚

- åœ¨ Sublime ä¸­ï¼Œæ‚¨è¿˜éœ€è¦å…ˆè®¾ç½®æ–‡ä»¶æ‰©å±•åæ‰èƒ½ä½¿ç”¨è¯¥å¿«æ·æ–¹å¼ã€‚

## [å¿«é€Ÿä¸Šæ‰‹ iTerm2ï¼šæŒæ¡è¿™äº›å¿…å¤‡å¿«æ·é”®](https://blog.dong4j.site/posts/6bf37004.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

åœ¨ä½¿ç”¨ç»ˆç«¯æ¨¡æ‹Ÿå™¨å’Œ tmux æ—¶ï¼ŒæŒæ¡ä¸€äº›å¿«æ·é”®å¯ä»¥å¸®åŠ©ä½ æé«˜å·¥ä½œæ•ˆç‡ã€‚ä»¥ä¸‹æ˜¯ iTerm2 å’Œ tmux çš„ä¸€äº›å¸¸ç”¨å¿«æ·é”®ã€‚

## iTerm2 å¿«æ·é”®

### åŸºæœ¬æ“ä½œ

- **æ‰“å¼€/å…³é—­ iTerm**ï¼š`F12`
- **å¿«é€Ÿæ ‡è®°**ï¼š`Cmd+Shift+m`
- **å›åˆ°æ ‡è®°ä½ç½®**ï¼š`Cmd+Shift+j`

### æœç´¢å’Œå†å²è®°å½•

- **æ­£åˆ™è¡¨è¾¾å¼æœç´¢**ï¼š`Cmd+f`
- **å‰ªåˆ‡æ¿å†å²**ï¼š`Cmd+Shift+h`
- **æ˜¾ç¤ºå‘½ä»¤å†å²è®°å½•**ï¼š`Cmd+;`

### åˆ‡æ¢ Tab å’Œ Pane

- **åˆ‡æ¢ tab**: `Cmd+â†`, `Cmd+â†’`, `Cmd+{`, `Cmd+}`
- **æ–°å»º tab**: `Cmd+t`
- **é¡ºåºåˆ‡æ¢ pane**: `Cmd+[`, `Cmd+]`
- **æŒ‰æ–¹å‘åˆ‡æ¢ pane**: `Cmd+Option+æ–¹å‘é”®`

### åˆ‡åˆ†å±å¹•

- **æ°´å¹³åˆ‡åˆ†**: `Cmd+d`
- **å‚ç›´åˆ‡åˆ†**: `Cmd+Shift+d`

### å…¶ä»–å¿«æ·æ“ä½œ

- **é«˜äº®æ˜¾ç¤ºé¼ æ ‡æŒ‡é’ˆ**ï¼š`Cmd+/`
- **å¿«ç…§è¿”å›**: `Cmd+Option+b`

### æ–‡æœ¬ç¼–è¾‘ç›¸å…³

- `Ctrl+q`: æ¸…ç©ºå½“å‰è¡Œ
- `âŒƒ + u`: åˆ é™¤ä»å½“å‰ä½ç½®åˆ°è¡Œé¦–çš„å†…å®¹
- `âŒƒ + a`: ç§»åŠ¨åˆ°è¡Œé¦–
- `âŒƒ + e`: ç§»åŠ¨åˆ°è¡Œå°¾
- `âŒƒ + f`: å‘å‰ç§»åŠ¨ä¸€ä¸ªå­—ç¬¦
- `âŒƒ + b`: å‘åç§»åŠ¨ä¸€ä¸ªå­—ç¬¦
- `âŒƒ + p`: ä¸Šä¸€æ¡å‘½ä»¤
- `âŒƒ + n`: ä¸‹ä¸€æ¡å‘½ä»¤
- `âŒƒ + r`: æœç´¢å†å²å‘½ä»¤
- `âŒƒ + y`: å¬å›æœ€è¿‘åˆ é™¤çš„æ–‡å­—
- `âŒƒ + h`: åˆ é™¤å…‰æ ‡å‰çš„ä¸€ä¸ªå­—ç¬¦
- `âŒƒ + d`: åˆ é™¤å…‰æ ‡æŒ‡å‘çš„å­—ç¬¦
- `âŒƒ + w`: åˆ é™¤å…‰æ ‡å‰çš„ä¸€ä¸ªå•è¯
- `âŒƒ + k`: åˆ é™¤ä»å½“å‰ä½ç½®åˆ°è¡Œå°¾çš„å†…å®¹
- `âŒƒ + t`: äº¤æ¢å½“å‰å…‰æ ‡ä½ç½®å’Œå‰ä¸€ä¸ªå­—ç¬¦

### è¾“å…¥æ¨¡å¼

- **å¤§å†™å­—æ¯è¾“å…¥**ï¼š`Cmd+Shift+u`

## tmux å¿«æ·é”®

åœ¨ tmux ä¸­ï¼Œå¤§å¤šæ•°å¿«æ·æ“ä½œéƒ½éœ€å…ˆæŒ‰ `Ctrl+b` æ¿€æ´»ã€‚

### ç³»ç»Ÿæ“ä½œ

- **åˆ—å‡ºæ‰€æœ‰å¿«æ·é”®**: `?`
- **è„±ç¦»å½“å‰ä¼šè¯**: `d`
- **é€‰æ‹©è¦è„±ç¦»çš„ä¼šè¯**: `D`
- **æŒ‚èµ·å½“å‰ä¼šè¯**: `Ctrl+z`
- **å¼ºåˆ¶é‡ç»˜æœªè„±ç¦»çš„ä¼šè¯**: `r`
- **é€‰æ‹©å¹¶åˆ‡æ¢ä¼šè¯**: `s`
- **è¿›å…¥å‘½ä»¤è¡Œæ¨¡å¼**: `:`
  - ä¾‹å¦‚ï¼Œ`kill-server` å…³é—­æœåŠ¡å™¨
- **è¿›å…¥å¤åˆ¶æ¨¡å¼**ï¼ˆæ­¤æ—¶çš„æ“ä½œä¸ vi/emacs ç›¸åŒï¼‰ï¼š `[`
- **åˆ—å‡ºæç¤ºä¿¡æ¯ç¼“å­˜**: `~`

### çª—å£æ“ä½œ

- **åˆ›å»ºæ–°çª—å£**: `c`
- **å…³é—­å½“å‰çª—å£**: `&`
- **åˆ‡æ¢è‡³æŒ‡å®šçª—å£**: æŒ‰æ•°å­—é”® (`1` åˆ° `9`)
- **åˆ‡æ¢è‡³ä¸Šä¸€çª—å£**: `p`
- **åˆ‡æ¢è‡³ä¸‹ä¸€çª—å£**: `n`
- **åœ¨å‰åä¸¤ä¸ªçª—å£é—´äº’ç›¸åˆ‡æ¢**: `l`
- **é€šè¿‡çª—å£åˆ—è¡¨åˆ‡æ¢çª—å£**: `w`
- **é‡å‘½åå½“å‰çª—å£**: `,`
- **ä¿®æ”¹å½“å‰çª—å£ç¼–å·**ï¼ˆç›¸å½“äºçª—å£é‡æ–°æ’åºï¼‰: `.`
- **åœ¨æ‰€æœ‰çª—å£ä¸­æŸ¥æ‰¾æŒ‡å®šæ–‡æœ¬**: `f`

### é¢æ¿æ“ä½œ

- **å°†å½“å‰é¢æ¿å¹³åˆ†ä¸ºä¸Šä¸‹ä¸¤å—**: `"`
- **å°†å½“å‰é¢æ¿å¹³åˆ†ä¸ºå·¦å³ä¸¤å—**: `%`
- **å…³é—­å½“å‰é¢æ¿**: `x`
- **å°†å½“å‰é¢æ¿ç½®äºæ–°çª—å£**ï¼ˆæ–°å»ºä¸€ä¸ªçª—å£ï¼Œå…¶ä¸­ä»…åŒ…å«å½“å‰é¢æ¿ï¼‰: `!`
- **ä»¥ 1 ä¸ªå•å…ƒæ ¼ä¸ºå•ä½ç§»åŠ¨è¾¹ç¼˜è°ƒæ•´å½“å‰é¢æ¿å¤§å°**: `Ctrl+æ–¹å‘é”®`
- **ä»¥ 5 ä¸ªå•å…ƒæ ¼ä¸ºå•ä½ç§»åŠ¨è¾¹ç¼˜è°ƒæ•´å½“å‰é¢æ¿å¤§å°**: `Alt+æ–¹å‘é”®`
- **åœ¨é¢„ç½®çš„é¢æ¿å¸ƒå±€ä¸­å¾ªç¯åˆ‡æ¢**ï¼š`Space`
  - åŒ…æ‹¬ even-horizontal, even-vertical, main-horizontal, main-vertical, tiled
- **æ˜¾ç¤ºé¢æ¿ç¼–å·**: `q`
- **é€‰æ‹©ä¸‹ä¸€é¢æ¿ï¼ˆå½“å‰çª—å£ï¼‰**: `o`
- **ç§»åŠ¨å…‰æ ‡ä»¥é€‰æ‹©é¢æ¿**: æ–¹å‘é”®
- **å‘å‰ç½®æ¢å½“å‰é¢æ¿**: `{`
- **å‘åç½®æ¢å½“å‰é¢æ¿**: `}`
- **é€†æ—¶é’ˆæ—‹è½¬å½“å‰çª—å£çš„é¢æ¿**: `Alt+o`
- **é¡ºæ—¶é’ˆæ—‹è½¬å½“å‰çª—å£çš„é¢æ¿**: `Ctrl+o`

## [æ‰“é€ ä¸ªæ€§åŒ– IntelliJ IDEA ç¼–è¾‘ç¯å¢ƒ](https://blog.dong4j.site/posts/eb599575.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

IntelliJ IDEA æ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„é›†æˆå¼€å‘ç¯å¢ƒï¼ˆIDEï¼‰ï¼Œå®ƒæä¾›äº†ä¸°å¯Œçš„å¿«æ·é”®æ¥æé«˜ç¼–ç¨‹æ•ˆç‡ã€‚ä¸‹é¢æ˜¯ä¸€äº›å¸¸ç”¨çš„ç¼–è¾‘å™¨èƒŒæ™¯è‰²ã€è¡Œå·æ é¢œè‰²ä»¥åŠæ§åˆ¶å°èƒŒæ™¯è‰²çš„è®¾ç½®æ–¹æ³•ï¼ŒåŒæ—¶æ¶µç›–äº†è‡ªå®šä¹‰ä»£ç æŠ˜å å’Œä¸€äº› IDEA å¸¸ç”¨åŠè‡ªå®šä¹‰å¿«æ·é”®ã€‚

## è®¾ç½®ç¼–è¾‘å™¨é¢œè‰²

1. **ç¼–è¾‘å™¨èƒŒæ™¯è‰²**ï¼š
   - å‰å¾€ `Preference` -> `Editor` -> `Color & Fonts` -> `Editor` -> `General` -> `Text` -> `Default text`
2. **è¡Œå·æ çš„é¢œè‰²**ï¼š

   - å‰å¾€ `Preference` -> `Editor` -> `Color & Fonts` -> `General` -> `Editor` -> `Gutter background`

3. **æ§åˆ¶å°èƒŒæ™¯è‰²è®¾ç½®**ï¼š
   - åœ¨ `Setting` ä¸­æ‰¾åˆ° `Editor`ï¼Œç„¶åé€‰æ‹© `color Scheme` -> `console Colors`ã€‚å³ä¾§çš„ Console éƒ¨åˆ†å¯ä»¥è°ƒæ•´èƒŒæ™¯é¢œè‰²ã€‚
4. å…¶ä»–ç¼–è¾‘å™¨é¢œè‰²è®¾ç½®ï¼š
   - è°ƒæ•´å…‰æ ‡å½“å‰è¡Œé¢œè‰²ï¼šå‰å¾€ `Editor` -> `Colors & Fonts` -> `General` -> `Editor` -> `Caret row`
   - ä¿®æ”¹è¡ŒèƒŒæ™¯è‰²ï¼šå‰å¾€ `Editor` -> `Colors & Fonts` -> `General` -> `Gutter` -> `Background`

## è‡ªå®šä¹‰ä»£ç æŠ˜å 

åœ¨éœ€è¦è‡ªå®šä¹‰ä»£ç æŠ˜å çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¯­æ³•ï¼š

```java
//region æè¿°
Your code goes here...
//endregion
```

## IntelliJ IDEA å¸¸ç”¨å¿«æ·é”®

- **æ’å…¥**ï¼š`control+enter`
- **æ’é”™**ï¼š`option+enter`
- **ä¸‹æ–¹æ’å…¥ä¸€è¡Œ**ï¼š`shift+enter`
- **ä¸Šæ–¹æ’å…¥ä¸€è¡Œ**ï¼š`command + enter`
- **åˆ›å»ºæµ‹è¯•ç”¨ä¾‹**ï¼š`shift + command -- > åˆ›å»ºæµ‹è¯•ç”¨ä¾‹`
- **è¿è¡Œä»£ç **ï¼š `shift + control + r`
- **å¿«é€ŸæŠ˜å /å±•å¼€ä»£ç æ®µ**ï¼šä½¿ç”¨ `option + command + (+/-)`
- **å…³é—­/æ‰“å¼€å½“å‰æŠ˜å **ï¼š`command + >`
- **è¿”å›ä¸Šä¸€è·³è½¬ä½ç½®**ï¼š`command + [`
- **è·³åˆ°ä¸‹ä¸€ä¸ªä½ç½®**ï¼š`command + ]`

æ­¤å¤–ï¼Œè¿˜æœ‰ï¼š

- ç”Ÿæˆä»£ç æ¨¡æ¿ï¼š`shift+command+j`
- æŸ¥çœ‹æ–‡æ¡£ï¼šä½¿ç”¨ `F1`
- æœç´¢å…³é”®å­—ï¼šä½¿ç”¨ `shift+command+f`

### Debugging å¿«æ·é”®

- å¼€å§‹è°ƒè¯•ï¼š`control+d`
- è°ƒè¯•æ—¶æŸ¥çœ‹é€‰ä¸­å€¼ï¼š`alt+f8`
- å•æ­¥æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹ï¼š`f8`
- å¼ºåˆ¶è¿›å…¥ä»£ç ï¼š`alt+shift+f7`
- è¿è¡Œ Java ç±»ï¼ˆé debugï¼‰: `ctrl+shift+f10`

### ç¿»è¯‘å¿«æ·é”®

- é€‰ä¸­æ–‡æœ¬ç¿»è¯‘ï¼šä½¿ç”¨ `option + æ•°å­—é”®`
- å…¨å¥ç¿»è¯‘å¹¶æ›¿æ¢ï¼š`option+r`

## è‡ªå®šä¹‰ IntelliJ IDEA VM Options

åœ¨å¯åŠ¨ IntelliJ IDEA æ—¶å¯ä»¥è‡ªå®šä¹‰ VM é€‰é¡¹ï¼Œä»¥ä¼˜åŒ–æ€§èƒ½ï¼š

```properties
-Xverify:none # å…³é—­Javaå­—èŠ‚ç éªŒè¯, åŠ å¿«ç±»è£…å…¥é€Ÿåº¦
-server # å¯ç”¨æœåŠ¡å™¨æ¨¡å¼
-XX:+UseG1GC # ä½¿ç”¨ G1 åƒåœ¾å›æ”¶å™¨
-Dfile.encoding=UTF-8 # è®¾ç½®æ–‡ä»¶ç¼–ç ä¸ºUTF-8
-XX:MaxMetaspaceSize=512m # è®¾ç½®å…ƒç©ºé—´æœ€å¤§å¤§å°
-javaagent:JetbrainsCrack-3.1-release-enc.jar # å¯ç”¨ Jetbrains è£…é¥°å·¥å…·
```

### ä½¿ç”¨ HTTP ä»£ç†

è‹¥éœ€è¦è®¾ç½®å…¨å±€çš„ HTTP ä»£ç†ï¼Œè¯·åœ¨ `idea.exe.vmoptions` åŠ `idea64.exe.vmoptions` æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š

```properties
-DproxySet=true
-Dhttp.proxyHost=127.0.0.1 # è¿™é‡Œæ˜¯ä½ çš„ HTTP ä»£ç†æœåŠ¡å™¨åœ°å€
-Dhttp.proxyPort=1080 # è¿™é‡Œæ˜¯ä½ ä»£ç†çš„ç«¯å£å·
```

## [ä»å…¥é—¨åˆ°ç²¾é€šï¼šIDEA çš„æ‰€æœ‰å¿«æ·é”®æ±‡æ€»](https://blog.dong4j.site/posts/72a223e0.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## æ–‡ä»¶å’Œç¼–è¾‘ç›¸å…³

- **control+enter** - æ’å…¥(ä¸ alt+insert ç›¸åŒ)
- **option+enter** - æ’é”™(ä¸ alt+enter ç›¸åŒ)
- **shift+enter** - åœ¨å½“å‰è¡Œä¸‹é¢æ’å…¥æ–°è¡Œ
- **command + enter** - åœ¨å…‰æ ‡å‰ä¸€è¡Œæ’å…¥æ–°è¡Œ
- **shift + command** - åˆ›å»ºæµ‹è¯•ç”¨ä¾‹
- **shift + control + r** - è¿è¡Œé…ç½®çš„è¿è¡Œ/è°ƒè¯•ä»»åŠ¡
- **option + commmand + (+/-)** - å¿«é€ŸæŠ˜å ä»£ç æ®µæˆ–æ‰“å¼€æŠ˜å çš„éƒ¨åˆ† (Ctrl+Shift+/)
- **command + > æˆ– <** - å…³é—­æˆ–å±•å¼€å½“å‰æ–‡ä»¶å¤¹å†…çš„æ‰€æœ‰æŠ˜å éƒ¨åˆ†ï¼ˆä»…é’ˆå¯¹æ–‡ä»¶å¤¹ï¼‰
- **command + [ æˆ– ]** - è·³è½¬åˆ°ä¸Šæ¬¡ç¼–è¾‘çš„ä½ç½®
- **shift + command + F** - åœ¨é¡¹ç›®ä¸­æŸ¥æ‰¾å…³é”®å­—
- **option + command + l** - ä»£ç æ ¼å¼åŒ– (Ctrl+Alt+L)
- **shift+command+j** - æ’å…¥ä»£ç æ¨¡æ¿ï¼ˆLive Templatesï¼‰
- **command + j** - Acejump: å¿«é€Ÿå®šä½åˆ°è¡Œé¦–ã€å˜é‡æˆ–æ–¹æ³•ç­‰
- **shift + command + A** - åœ¨å…¨å±€èŒƒå›´å†…æŸ¥æ‰¾æ“ä½œæˆ–è®¾ç½®é€‰é¡¹
- **Class... æˆ– File...** - è·³è½¬åˆ°æŸä¸ªç±»æˆ–æ–‡ä»¶ (Ctrl+Shift+N)
- **File structure** - å¯è·³è½¬è‡³ä»£ç å†…éƒ¨çš„ç‰¹å®šéƒ¨åˆ†ï¼Œå¦‚å‡½æ•°ã€å˜é‡ç­‰ (Ctrl+F12)
- **Declaration** - å¿«é€Ÿå®šä½åˆ°æ‰€é€‰ç¬¦å·æˆ–ç±»å‹çš„å®šä¹‰å¤„ï¼ˆCtrl+Bï¼‰
- **Back/Front** - è¿”å›/å‰è¿›è‡³ä¸Šä¸€æ¬¡è·³è½¬çš„ä½ç½®
- **Search everywhere** - è·³è½¬è‡³ä»»æ„ä½ç½®
- **command + y** - å±•ç¤ºå½“å‰å…‰æ ‡æ‰€åœ¨å‡½æ•°æˆ–ç±»çš„å…¨éƒ¨å†…å®¹ (Alt+F7)
- **shift+f12** - å…³é—­æ‰€æœ‰éç¼–è¾‘åŒºåŸŸï¼Œå›åˆ°ç¼–è¾‘å™¨ç•Œé¢ï¼ˆCtrl+Shift+F12ï¼‰
- **cmd + e æˆ– cmd + shift + e** - è·³è½¬åˆ°æœ€è¿‘ä½¿ç”¨çš„æ–‡ä»¶æˆ–æœ€è¿‘ç¼–è¾‘è¿‡çš„æ–‡ä»¶
- **opt + f12** - æ‰“å¼€å‘½ä»¤è¡Œçª—å£ (Alt+F12)

## ä»£ç é‡æ„ä¸è°ƒè¯•ç›¸å…³

- **alt+command+v** - å¿«é€Ÿç”Ÿæˆæ–¹æ³•è¿”å›ç±»å‹ (Ctrl+Alt+V)
- **alt+command+m** - å°†é€‰ä¸­çš„ä»£ç æ®µæç‚¼æˆæ–°æ–¹æ³•(Refactor -> Extract Method) (Ctrl+Alt+M)
- **shift+f8** - è·³è½¬åˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹
- **f8** - å•æ­¥æ‰§è¡Œè°ƒè¯•ç¨‹åº
- **control+d** - å¼€å§‹æˆ–åœæ­¢è°ƒè¯•ä¼šè¯ï¼ˆDebugï¼‰
- **alt+f8** - åœ¨è¿è¡Œæ—¶æŸ¥çœ‹è¡¨è¾¾å¼çš„å€¼ (Eval Expression)
- **f7** - è¿›å…¥ä»£ç å†…éƒ¨çš„å‡½æ•° (Step Into)
- **alt+shift+f7** - å¼ºåˆ¶è¿›å…¥å‡½æ•°ï¼ˆForce Step intoï¼‰
- **ctrl+shift+f9** - é‡æ–°å¯åŠ¨å½“å‰ä¼šè¯(é»˜è®¤ä¸ºæœ€åä¸€ä¸ªè¿è¡Œè¿‡çš„ä¼šè¯) (Run)
- **ctrl+shift+f10** - åœ¨ IDEA ä¸­ç›´æ¥è¿è¡Œæˆ–è°ƒè¯• Java ç¨‹åº
- **command+f2** - åœæ­¢æ­£åœ¨æ‰§è¡Œçš„ä»£ç ï¼ˆåœæ­¢ä»»åŠ¡ï¼‰
- **control + h æˆ– control + opt + h** - æ˜¾ç¤ºæ–¹æ³•å±‚çº§å›¾ (Ctrl+H)
- **opt + cmd + U** - ç”Ÿæˆç±»ã€æ¥å£æˆ–æšä¸¾çš„ UML å›¾ (Alt+Insert -> Diagrams -> Class Diagram for File)

## æ–¹æ³•å’Œä½¿ç”¨ç›¸å…³

- **opt+f7 æˆ– opt+alt+f7** - æŸ¥æ‰¾å½“å‰å‡½æ•°æˆ–å˜é‡è¢«ä½¿ç”¨çš„æ‰€æœ‰åœ°æ–¹ï¼ˆFind Usagesï¼‰(Ctrl+F7)
- **ctrl+u** - è·³è½¬åˆ°çˆ¶ç±»æˆ–æ¥å£çš„å®šä¹‰å¤„ (Alt+Up/Down Arrows)

## ä¹¦ç­¾ä¸ä»»åŠ¡

- **f3** - æ–°å»ºä¸å¸¦æ ‡ç­¾çš„ä¹¦ç­¾
- **opt+f3** - æ–°å»ºå¸¦æ ‡ç­¾çš„ä¹¦ç­¾
- **cmd + f3** - æ‰“å¼€ä¹¦ç­¾æµè§ˆå™¨çª—å£ (Ctrl+F11)
- **opt+shift+n** - åœ¨å½“å‰æ–‡ä»¶ä¸­æ–°å»ºä»»åŠ¡æˆ–æ ‡è®°ä½ç½®ï¼ˆå¯¹äº CVS ç”¨æˆ·ï¼‰(Alt+Insert -> Task)

## æ–‡æ¡£æŸ¥çœ‹ç›¸å…³

- **f1** - æŸ¥çœ‹æ–‡æ¡£å¸®åŠ© (Quick Documentation Lookup) (Alt+Q)
- **shift+command+d** - åœ¨ Dash ä¸­å¿«é€ŸæŸ¥æ‰¾å¯¹åº”ç±»æˆ–æ–¹æ³•çš„æ–‡æ¡£

## ç¿»è¯‘åŠŸèƒ½å¿«æ·é”®

IntelliJ IDEA è¿˜æ”¯æŒå¤šç§è¯­è¨€çš„ç¿»è¯‘ã€‚

- **alt+1, 2 æˆ– 3** - æ‰§è¡Œé€‰ä¸­æ–‡æœ¬ç¿»è¯‘ï¼Œåˆ†åˆ«é€‰æ‹©æœ€å°èŒƒå›´ã€æœ€å¤§èŒƒå›´å’Œå•è¯çº§åˆ« (Alt+Shift+Insert)
- **alt+r** - å°†ç¿»è¯‘åçš„æ–‡æœ¬è‡ªåŠ¨æ›¿æ¢æ‰æºä»£ç 
- **alt+t** - ç¿»è¯‘ä¸€äº›ç•Œé¢å…ƒç´ å†…çš„æ–‡å­—ï¼ˆå¦‚æç¤ºæ°”æ³¡ç­‰ï¼‰
- **alt+0** - æ‰“å¼€ååº”çª—å£ï¼Œæ˜¾ç¤ºå·²ç¿»æ³½çš„å†…å®¹

## [å¸¸é‡æ± è¿ç§»å²ï¼šä»æ°¸ä¹…ä»£åˆ°å †ï¼ŒJVMå†…å­˜çš„å˜è¿](https://blog.dong4j.site/posts/4453ea00.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

å­—ç¬¦ä¸²å¸¸é‡å½’å¸¸é‡æ± ç®¡ç†ï¼Œé‚£æ¯”å¦‚ String str = "abc"; "abc" è¿™ä¸ªå¯¹è±¡æ˜¯æ”¾åœ¨å†…å­˜ä¸­çš„å“ªä¸ªä½ç½®ï¼Œæ˜¯å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­è¿˜æ˜¯å †ï¼Ÿ

â€è¿™å¥ä»£ç çš„ abc å½“ç„¶åœ¨å¸¸é‡æ± ä¸­ï¼Œåªæœ‰ new String("abc") è¿™ä¸ªå¯¹è±¡æ‰åœ¨å †ä¸­åˆ›å»ºâ€œï¼Œä»–ä»¬å¤§æ¦‚æ˜¯è¿™ä¹ˆå›ç­”ã€‚

â€œabcâ€è¿™ä¸ªä¸œè¥¿ï¼Œæ˜¯æ”¾åœ¨å¸¸é‡æ± ä¸­ï¼Œè¿™ä¸ªç­”æ¡ˆæ˜¯é”™è¯¯çš„ã€‚

**å­—ç¬¦ä¸²â€œabc" çš„æœ¬ä½“ã€å®ä¾‹ï¼Œåº”è¯¥æ˜¯å­˜åœ¨äº Java å †ä¸­ã€‚**

å¯èƒ½è¿˜çœŸçš„æœ‰éƒ¨åˆ†åŒå­¦å¯¹è¿™ä¸ªçŸ¥è¯†ç‚¹ä¸ç†Ÿæ‚‰ï¼Œä»Šå¤©å’Œå¤§å®¶èŠèŠå­—ç¬¦ä¸²è¿™ä¸ªé—®é¢˜ ~

åˆå­¦ Java æ—¶ï¼Œå­¦åˆ°å­—ç¬¦ä¸²è¿™ä¸€éƒ¨åˆ†ï¼Œæœ‰ä¸€æ®µä»£ç 

```java
String str1 = "hello";
String str2 = new String("hello");
å¤åˆ¶ä»£ç 
```

> ä¹¦ä¸Šçš„è§£é‡Šæ˜¯ï¼šæ‰§è¡Œç¬¬ä¸€è¡Œçš„æ—¶å€™ï¼Œå·²ç»æŠŠ "hello" å­—ç¬¦ä¸²æ”¾åˆ°äº†å¸¸é‡æ± ä¸­ï¼Œæ‰§è¡Œç¬¬äºŒè¡Œä»£ç æ—¶ï¼Œä¼šå°†å¸¸é‡æ± ä¸­å·²ç»å­˜åœ¨çš„ "hello" å¤åˆ¶ä¸€ä»½åˆ°å †å†…å­˜ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªçš„æ–°çš„ String å¯¹è±¡ã€‚è™½ç„¶å€¼ä¸€æ ·ï¼Œä½†ä»–ä»¬æ˜¯ä¸åŒçš„å¯¹è±¡ã€‚

å½“æ—¶çœ‹å®Œè¿™ä¸ªè§£é‡Šï¼Œæˆ‘äº§ç”Ÿäº†å¾ˆå¤šç–‘æƒ‘ã€‚å› ä¸ºåœ¨æ­¤ä¹‹å‰å·²ç»çŸ¥é“å­—ç¬¦ä¸²çš„åº•å±‚æ˜¯ char æ•°ç»„å®ç°çš„ã€‚æˆ‘å¾ˆç–‘æƒ‘ï¼š

- ä»– copy ä¸€ä»½è¿‡å»ï¼Œæ˜¯ copy äº† char æ•°ç»„å‘¢ï¼Ÿ
- è¿˜æ˜¯ copy æ•´ä¸ª String å¯¹è±¡ï¼Ÿ
- "hello" è¿™ä¸ªå¯¹è±¡å®ä¾‹çœŸçš„å­˜æ”¾åœ¨å¸¸é‡æ± ä¸­å—ï¼Ÿ

å½“æ—¶åœ¨ç½‘ä¸Šæœäº†ä¸€äº›æ–‡ç« å’Œç­”æ¡ˆï¼Œå„æœ‰è¯´è¾ï¼Œå¤§éƒ¨åˆ†å›ç­”éƒ½æ˜¯ "str" è¿™ä¸ªå¯¹è±¡åœ¨å¸¸é‡æ± ä¸­ï¼Œä½†ä¹Ÿæœ‰è®¤ä¸ºå­—ç¬¦ä¸²å¸¸é‡å®ä¾‹ï¼ˆæˆ–å«å¯¹è±¡ï¼‰æ˜¯åœ¨å †ä¸­åˆ›å»ºï¼Œåªæ˜¯å°†å…¶å¼•ç”¨æ”¾åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œäº¤ç»™å¸¸é‡æ± ç®¡ç†ã€‚

## JAVA å†…å­˜åŒºåŸŸ â€” è¿è¡Œæ—¶æ•°æ®åŒº

ç†æ¸…è¿™ä¸ªé—®é¢˜å‰ï¼Œéœ€è¦æ¢³ç†ä¸€ä¸‹å‰ç½®çŸ¥è¯†ã€‚

ä»ä¸€ä¸ªç»å…¸çš„ç¤ºæ„å›¾è®²èµ·ï¼Œä»¥ hotspot è™šæ‹Ÿæœºä¸ºä¾‹ï¼Œæ­¤å†…å­˜æ¨¡å‹éœ€å»ºç«‹åœ¨ JDK1.7 ä¹‹å‰çš„ç‰ˆæœ¬æ¥è®¨è®ºï¼ŒJDK1.7 ä¹‹åæœ‰æ‰€æ”¹å˜ï¼Œä½†æ˜¯åŸç†è¿˜æ˜¯ä¸€æ ·çš„ã€‚

![20241229154732_uaxPxuHQ.webp](https://cdn.dong4j.site/source/image/20241229154732_uaxPxuHQ.webp)

Java è™šæ‹Ÿæœºç®¡ç†çš„å†…å­˜æ˜¯è¿è¡Œæ—¶æ•°æ®åŒºé‚£ä¸€éƒ¨åˆ†ï¼Œç®€å•æ¦‚æ‹¬ä¸€ä¸‹å…¶ä¸­å„ä¸ªåŒºåŸŸçš„åŒºåˆ«ï¼š

- **è™šæ‹Ÿæœºæ ˆ**ï¼šçº¿ç¨‹ç§æœ‰ï¼Œç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹ç›¸åŒï¼Œå³æ¯æ¡çº¿ç¨‹éƒ½ä¸€ä¸ªç‹¬ç«‹çš„æ ˆï¼ˆVM Stackï¼‰ã€‚æ¯ä¸ªæ–¹æ³•æ‰§è¡Œæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æœ‰ä¸€æ¡çº¿ç¨‹æ‰§è¡Œäº†å¤šä¸ªæ–¹æ³•æ—¶ï¼Œå°±ä¼šæœ‰ä¸€ä¸ªæ ˆï¼Œæ ˆä¸­æœ‰å¤šä¸ªæ ˆå¸§ã€‚
- **æœ¬åœ°æ–¹æ³•æ ˆ**ï¼šçº¿ç¨‹ç§æœ‰
- **ç¨‹åºè®¡æ•°å™¨**ï¼šçº¿ç¨‹ç§æœ‰
- **å † Heap**ï¼šçº¿ç¨‹å…±äº«ï¼Œæ˜¯ Java è™šæ‹Ÿæœºæ‰€ç®¡ç†çš„å†…å­˜ä¸­æœ€å¤§çš„ä¸€å—ï¼Œåœ¨è™šæ‹Ÿæœºå¯åŠ¨æ—¶åˆ›å»ºã€‚æ­¤å†…å­˜åŒºåŸŸçš„å”¯ä¸€ç›®çš„å°±æ˜¯å­˜æ”¾å¯¹è±¡å®ä¾‹ï¼Œå‡ ä¹æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½åœ¨è¿™é‡Œåˆ†é…å†…å­˜ã€‚**åœ¨ Java è™šæ‹Ÿæœºè§„èŒƒä¸­çš„æè¿°æ˜¯ï¼šæ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ä»¥åŠæ•°ç»„éƒ½è¦åœ¨å †ä¸Šåˆ†é…ã€‚ **Â *ï¼ˆåŸæ–‡ï¼šThe heap is the runtime data area from which memory for all class instances and arrays is allocatedï¼‰* ä½†æœ‰ç‰¹æ®Šæƒ…å†µï¼Œéšç€ JIT ç¼–è¯‘å™¨çš„å‘å±•ï¼Œé€ƒé€¸åˆ†æå’Œæ ‡é‡æ›¿æ¢æŠ€æœ¯çš„é€æ¸æˆç†Ÿï¼Œå¯¹è±¡ä¹Ÿå¯ä»¥åœ¨**æ ˆä¸Š**åˆ†é…ã€‚å¦å¤–ï¼Œè™½è¯´å †æ˜¯çº¿ç¨‹å…±äº«ï¼Œä½†å…¶ä¸­ä¹Ÿå¯ä»¥åˆ’åˆ†å‡ºå¤šä¸ªçº¿ç¨‹ç§æœ‰çš„åˆ†é…ç¼“å†²åŒº _ï¼ˆThread Local Allocation Bufferï¼ŒTLABï¼‰_ã€‚
- **æ–¹æ³•åŒº**ï¼šçº¿ç¨‹å…±äº«ï¼Œå®ƒç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ã€‚

## JAVA çš„ä¸‰ç§å¸¸é‡æ± 

æ­¤å¤–ï¼ŒJava æœ‰ä¸‰ç§å¸¸é‡æ± ï¼Œå³**å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆåˆå«å…¨å±€å­—ç¬¦ä¸²æ± ï¼‰ã€class æ–‡ä»¶å¸¸é‡æ± ã€è¿è¡Œæ—¶å¸¸é‡æ± **ã€‚  
![20241229154732_i9lS5QCd.webp](https://cdn.dong4j.site/source/image/20241229154732_i9lS5QCd.webp)

**1. å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆä¹Ÿå«å…¨å±€å­—ç¬¦ä¸²æ± ã€string poolã€string literal poolï¼‰**

å­—ç¬¦ä¸²å¸¸é‡æ± åœ¨æ¯ä¸ª VM ä¸­åªæœ‰ä¸€ä»½ï¼Œä»–åœ¨å†…å­˜ä¸­çš„ä½ç½®å¦‚å›¾ï¼Œçº¢è‰²ç®­å¤´æ‰€æŒ‡å‘çš„åŒºåŸŸ Interned Strings

**2. è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆruntime constant poolï¼‰**

å½“ç¨‹åºè¿è¡Œåˆ°æŸä¸ªç±»æ—¶ï¼Œclass æ–‡ä»¶ä¸­çš„ä¿¡æ¯å°±ä¼šè¢«è§£æåˆ°å†…å­˜çš„æ–¹æ³•åŒºé‡Œçš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ã€‚çœ‹å›¾å¯æ¸…æ™°æ„ŸçŸ¥åˆ°æ¯ä¸€ä¸ªç±»è¢«åŠ è½½è¿›æ¥éƒ½ä¼šäº§ç”Ÿä¸€ä¸ª**è¿è¡Œæ—¶å¸¸é‡æ± **ï¼Œç”±æ­¤å¯çŸ¥ï¼Œæ¯ä¸ªç±»éƒ½æœ‰ä¸€ä¸ªè¿è¡Œæ—¶å¸¸é‡æ± ã€‚å®ƒåœ¨å†…å­˜ä¸­çš„ä½ç½®å¦‚å›¾ï¼Œè“è‰²ç®­å¤´æ‰€æŒ‡å‘çš„åŒºåŸŸï¼Œæ–¹æ³•åŒºä¸­çš„ Class Date ä¸­çš„è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRun-Time Constant Poolï¼‰

![20241229154732_qETfdsVS.webp](https://cdn.dong4j.site/source/image/20241229154732_qETfdsVS.webp)

**3. class æ–‡ä»¶å¸¸é‡æ± ï¼ˆclass constant poolï¼‰**

class å¸¸é‡æ± æ˜¯åœ¨ç¼–è¯‘åæ¯ä¸ª class æ–‡ä»¶éƒ½æœ‰çš„ï¼Œclass æ–‡ä»¶ä¸­é™¤äº†åŒ…å«ç±»çš„ç‰ˆæœ¬ã€å­—æ®µã€æ–¹æ³•ã€æ¥å£ç­‰æè¿°ä¿¡æ¯å¤–ï¼Œè¿˜æœ‰ä¸€é¡¹ä¿¡æ¯å°±æ˜¯ Â **å¸¸é‡æ± **ï¼ˆconstant pool tableï¼‰_ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘å™¨ç”Ÿæˆçš„å„ç§å­—é¢é‡ï¼ˆLiteralï¼‰å’Œç¬¦å·å¼•ç”¨ï¼ˆSymbolic Referencesï¼‰ã€‚_ å­—é¢é‡å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„å¸¸é‡æ¦‚å¿µï¼Œå¦‚æ–‡æœ¬å­—ç¬¦ä¸²ã€è¢«å£°æ˜ä¸º final çš„å¸¸é‡å€¼ç­‰. ä»–åœ¨ class æ–‡ä»¶ä¸­çš„ä½ç½®å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒConstant Pool ä¸­ã€‚

## ä¸ªäººç†è§£

```java
public static void main(String[] args) {
	String str = "hello";
}
å¤åˆ¶ä»£ç 
```

å›åˆ°ä¸€å¼€å§‹è¯´åˆ°çš„è¿™å¥ä»£ç ï¼Œå¯ä»¥æ¥æ€»ç»“ä¸€ä¸‹å®ƒçš„æ‰§è¡Œè¿‡ç¨‹äº†ã€‚

1. é¦–å…ˆï¼Œå­—é¢é‡ "hello" åœ¨ç¼–è¯‘æœŸï¼Œå°±ä¼šè¢«è®°å½•åœ¨ class æ–‡ä»¶çš„ Â **class å¸¸é‡æ± **ä¸­ã€‚
2. è€Œå½“ class æ–‡ä»¶è¢«åŠ è½½åˆ°å†…å­˜ä¸­åï¼ŒJVM å°±ä¼šå°† class å¸¸é‡æ± ä¸­çš„**å¤§éƒ¨åˆ†å†…å®¹å­˜æ”¾åˆ°è¿è¡Œæ—¶å¸¸é‡æ± **ä¸­ï¼Œä½†æ˜¯**å­—ç¬¦ä¸² "hello" çš„æœ¬ä½“**ï¼ˆå¯¹è±¡ï¼‰å’Œå…¶ä»–æ‰€æœ‰å¯¹è±¡ä¸€æ ·ï¼Œæ˜¯**ä¼šåœ¨å †ä¸­åˆ›å»º**ï¼Œ**å†å°†å¼•ç”¨æ”¾åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± **ï¼Œä¹Ÿå°±æ˜¯å›¾ä¸€çš„ Interned Strings çš„ä½ç½®ã€‚ï¼ˆRednaxelaFX çš„æ–‡ç« é‡Œï¼Œæµ‹è¯•ç»“æœæ˜¯åœ¨æ–°ç”Ÿä»£çš„ Eden åŒºã€‚ä½†å› ä¸ºä¸€ç›´æœ‰ä¸€ä¸ªå¼•ç”¨é©»ç•™åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œæ‰€ä»¥ä¸ä¼šè¢« GC æ¸…ç†æ‰ï¼‰
3. è€Œåˆ°äº† String str = "hello" è¿™æ­¥ï¼ŒJVM ä¼šå»å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼ŒJVM ä¼šåœ¨æ ˆä¸­çš„å±€éƒ¨å˜é‡è¡¨é‡Œåˆ›å»º str å˜é‡ï¼Œç„¶åæŠŠå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„ï¼ˆhello å¯¹è±¡çš„ï¼‰**å¼•ç”¨**å¤åˆ¶ç»™ str å˜é‡ã€‚

åœ¨ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹è¿™æœ¬ä¹¦ä¸­ä¹Ÿæœ‰å­—ç¬¦ä¸²ç›¸å…³çš„è§£é‡Šï¼Œä¸¾å…¶ä¸­å‡ ä¸ªä¾‹å­ï¼š

**ä¾‹å­ 1**

> ï¼ˆåŸæ–‡ï¼‰è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRuntime Constant Poolï¼‰æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ã€‚Class æ–‡ä»¶ä¸­é™¤äº†æœ‰ç±»çš„ç‰ˆæœ¬ã€å­—æ®µã€æ–¹æ³•ã€æ¥å£ç­‰æè¿°ä¿¡æ¯å¤–ï¼Œè¿˜æœ‰ä¸€é¡¹ä¿¡æ¯æ˜¯å¸¸é‡æ± ï¼ˆConstant Pool Tableï¼‰ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ï¼Œ**è¿™éƒ¨åˆ†å†…å®¹å°†åœ¨ç±»åŠ è½½åè¿›å…¥æ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­å­˜æ”¾ã€‚**

æœ€åä¸€å¥æè¿°ä¸å¤ªå‡†ç¡®ï¼Œç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡å¹¶ä¸æ˜¯å…¨éƒ¨è¿›å…¥æ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ã€‚**å­—ç¬¦ä¸²å­—é¢é‡å°±ä¸è¿›å…¥è¿è¡Œæ—¶å¸¸é‡æ± **ï¼Œè€Œæ˜¯**åœ¨å †ä¸­åˆ›å»ºäº†å¯¹è±¡**ï¼Œ**å†å°†å¼•ç”¨é©»ç•™åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ã€‚**

**ä¾‹å­ 2**

```java
//ä»£ç æ¸…å•2-7&emsp;String.internï¼ˆï¼‰è¿”å›å¼•ç”¨çš„æµ‹è¯•

public class RuntimeConstantPoolOOM{

	public static void mainï¼ˆString[]argsï¼‰{
		String str1=new StringBuilderï¼ˆ"è®¡ç®—æœº"ï¼‰.appendï¼ˆ"è½¯ä»¶"ï¼‰.toStringï¼ˆï¼‰ï¼›
		System.out.printlnï¼ˆstr1.internï¼ˆï¼‰==str1ï¼‰ï¼›
		String str2=new StringBuilderï¼ˆ"ja"ï¼‰.appendï¼ˆ"va"ï¼‰.toStringï¼ˆï¼‰ï¼›
		System.out.printlnï¼ˆstr2.internï¼ˆï¼‰==str2ï¼‰ï¼›
	}
}
å¤åˆ¶ä»£ç 
```

> ï¼ˆåŸæ–‡ï¼‰è¿™æ®µä»£ç åœ¨ JDK 1.6 ä¸­è¿è¡Œï¼Œä¼šå¾—åˆ°ä¸¤ä¸ª falseï¼Œè€Œåœ¨ JDK 1.7 ä¸­è¿è¡Œï¼Œä¼šå¾—åˆ°ä¸€ä¸ª true å’Œä¸€ä¸ª falseã€‚äº§ç”Ÿå·®å¼‚çš„åŸå› æ˜¯ï¼šåœ¨ JDK 1.6 ä¸­ï¼Œinternï¼ˆï¼‰æ–¹æ³•ä¼šæŠŠé¦–æ¬¡é‡åˆ°çš„å­—ç¬¦ä¸²å®ä¾‹å¤åˆ¶åˆ°æ°¸ä¹…ä»£ä¸­ï¼Œè¿”å›çš„ä¹Ÿæ˜¯æ°¸ä¹…ä»£ä¸­è¿™ä¸ªå­—ç¬¦ä¸²å®ä¾‹çš„å¼•ç”¨ï¼Œè€Œç”± StringBuilder åˆ›å»ºçš„å­—ç¬¦ä¸²å®ä¾‹åœ¨ Java å †ä¸Šï¼Œæ‰€ä»¥å¿…ç„¶ä¸æ˜¯åŒä¸€ä¸ªå¼•ç”¨ï¼Œå°†è¿”å› falseã€‚è€Œ JDK 1.7ï¼ˆä»¥åŠéƒ¨åˆ†å…¶ä»–è™šæ‹Ÿæœºï¼Œä¾‹å¦‚ JRockitï¼‰çš„ internï¼ˆï¼‰å®ç°ä¸ä¼šå†å¤åˆ¶å®ä¾‹ï¼Œåªæ˜¯åœ¨å¸¸é‡æ± ä¸­è®°å½•é¦–æ¬¡å‡ºç°çš„å®ä¾‹å¼•ç”¨ï¼Œå› æ­¤ internï¼ˆï¼‰è¿”å›çš„å¼•ç”¨å’Œç”± StringBuilder åˆ›å»ºçš„é‚£ä¸ªå­—ç¬¦ä¸²å®ä¾‹æ˜¯åŒä¸€ä¸ªã€‚å¯¹ str2 æ¯”è¾ƒè¿”å› false æ˜¯å› ä¸º â€œjavaâ€ è¿™ä¸ªå­—ç¬¦ä¸²åœ¨æ‰§è¡Œ StringBuilder.toStringï¼ˆï¼‰ä¹‹å‰å·²ç»å‡ºç°è¿‡ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å·²ç»æœ‰å®ƒçš„å¼•ç”¨äº†ï¼Œä¸ç¬¦åˆâ€œé¦–æ¬¡å‡ºç°â€çš„åŸåˆ™ï¼Œè€Œâ€œè®¡ç®—æœºè½¯ä»¶â€è¿™ä¸ªå­—ç¬¦ä¸²åˆ™æ˜¯é¦–æ¬¡å‡ºç°çš„ï¼Œå› æ­¤è¿”å› trueã€‚

åŸæ–‡è§£é‡Šä¹Ÿä¸å¤ªå‡†ç¡®ï¼Œæˆ‘è§‰å¾—åœ¨ JDK 1.6 ä¸­ï¼Œinternï¼ˆï¼‰å¹¶ä¸ä¼šæŠŠé¦–æ¬¡é‡åˆ°çš„å­—ç¬¦ä¸²å®ä¾‹å¤åˆ¶åˆ°æ°¸ä¹…ä»£ä¸­ï¼Œè€Œæ˜¯ä¼šå°†å®ä¾‹å†å¤åˆ¶ä¸€ä»½åˆ°å †ï¼ˆheapï¼‰ä¸­ï¼Œç„¶åå°†å…¶å¼•ç”¨æ”¾å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­è¿›è¡Œç®¡ç†ï¼Œæ‰€ä»¥æ­¤ä»£ç è¿”å› falseã€‚è€Œ JDK1.7 ä¸­çš„ internï¼ˆï¼‰ä¸ä¼šå†å¤åˆ¶å®ä¾‹ï¼Œç›´æ¥å°†é¦–æ¬¡é‡åˆ°çš„æ­¤å­—ç¬¦ä¸²å®ä¾‹çš„å¼•ç”¨ï¼Œæ”¾å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œäºæ˜¯è¿”å› trueã€‚å…³äºæ­¤è§‚ç‚¹ï¼Œè¿˜æ²¡çœ‹åˆ°å¤§ç¥æ–‡ç« å®é”¤ï¼Œæ¬¢è¿è®¨è®ºã€‚

æœ€åå†å»¶ä¼¸ä¸€ç‚¹ï¼Œå¤§å®¶éƒ½çŸ¥é“ï¼Œå­—ç¬¦ä¸²çš„ value æ˜¯ final ä¿®é¥°çš„ char æ•°ç»„ï¼Œé‚£ä¹ˆä»¥ä¸‹è¿™æ®µä»£ç ï¼š

```java
// private final char value[];
String str1 = "hello world";
String str2 = new String("hello world");
String str3 = new String("hello world");
å¤åˆ¶ä»£ç 
```

str1ã€str2ã€str3 ä¸‰ä¸ªå˜é‡æ‰€æŒ‡å‘çš„éƒ½æ˜¯ä¸åŒçš„å¯¹è±¡ã€‚ï¼ˆstr1 != str2 != str3ï¼‰

é‚£ä¹ˆï¼Œè¿™ä¸‰ä¸ªå¯¹è±¡é‡Œçš„ char æ•°ç»„æ˜¯å¦æ˜¯åŒä¸€ä¸ªæ•°ç»„ï¼Ÿç›¸ä¿¡å¤§å®¶éƒ½æœ‰ç­”æ¡ˆäº†ã€‚

---

æ­¤æ–‡æ‰€è®¨è®ºçš„ Java å†…å­˜æ¨¡å‹æ˜¯å»ºç«‹åœ¨ JDK1.7 ä¹‹å‰ã€‚JDK 7 å¼€å§‹ Hotspot è™šæ‹ŸæœºæŠŠå­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆInterned String ä½ç½®ï¼‰ä»æ°¸ä¹…ä»£ï¼ˆPermGenï¼‰æŒªåˆ° Heap å †ï¼ŒJDK 8 åˆå½»åº•å–æ¶ˆ PermGenï¼ŒæŠŠè¯¸å¦‚ class ä¹‹ç±»çš„å…ƒæ•°æ®éƒ½æŒªåˆ° GC å †ä¹‹å¤–ç®¡ç†ã€‚ä½†ä¸ç®¡æ€æ ·ï¼ŒåŸºæœ¬åŸç†è¿˜æ˜¯ä¸å˜çš„ï¼Œå­—é¢é‡ â€helloâ€œ ç­‰ä¾æ—§ä¸æ˜¯æ”¾åœ¨ Interned String ä¸­ã€‚

---

**æ¨èæ–‡ç« ï¼š**

- [è¯·åˆ«å†æ‹¿ â€œString s = new String("xyz"); åˆ›å»ºäº†å¤šå°‘ä¸ª String å®ä¾‹â€ æ¥é¢è¯•äº†å§](https://link.juejin.im/?target=https%3A%2F%2Frednaxelafx.iteye.com%2Fblog%2F774673)
- [å€Ÿ HSDB æ¥æ¢ç´¢ HotSpot VM çš„è¿è¡Œæ—¶æ•°æ®](https://link.juejin.im/?target=https%3A%2F%2Frednaxelafx.iteye.com%2Fblog%2F1847971)Â *ä½œè€…ï¼šRednaxelaFXï¼Œæ›¾ä¸ºã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹ææ¨èè¯­*
- [java ç”¨è¿™æ ·çš„æ–¹å¼ç”Ÿæˆå­—ç¬¦ä¸²ï¼šString str = "Hello"ï¼Œåˆ°åº•æœ‰æ²¡æœ‰åœ¨å †ä¸­åˆ›å»ºå¯¹è±¡ï¼Ÿ](https://link.juejin.im/?target=https%3A%2F%2Fwww.zhihu.com%2Fquestion%2F29884421%2Fanswer%2F113785601)Â - èƒ–å›çš„å›ç­” - çŸ¥ä¹

## [DockeråŸºç¡€æ•™ç¨‹ï¼šé•œåƒã€å®¹å™¨ä¸ä»“åº“](https://blog.dong4j.site/posts/fa8faa2e.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

# Docker å…¥é—¨æŒ‡å—

Docker æ˜¯ä¸€ä¸ªå¼€æºçš„åº”ç”¨å®¹å™¨å¼•æ“ï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿå°†è½¯ä»¶åŠå…¶è¿è¡Œæ—¶ç¯å¢ƒå°è£…èµ·æ¥ä»¥æ–¹ä¾¿åœ°è¿›è¡Œç§»æ¤å’Œéƒ¨ç½²ã€‚é€šè¿‡ä½¿ç”¨ Dockerï¼Œå¯ä»¥å¿«é€Ÿæ‰“åŒ…ã€å‘å¸ƒä»¥åŠè¿è¡Œåº”ç”¨ç¨‹åºåœ¨å‡ ä¹ä»»ä½•åœ°æ–¹ï¼ˆåŒ…æ‹¬ç‰©ç†æœºæˆ–è™šæ‹Ÿæœºä¸Šï¼‰ã€‚å®ƒåˆ©ç”¨ Linux å†…æ ¸çš„èµ„æºéš”ç¦»ç‰¹æ€§æ¥å®ç°è½»é‡çº§çš„æ“ä½œç³»ç»Ÿçº§è™šæ‹ŸåŒ–ï¼Œä½¿å¾—å¼€å‘äººå‘˜èƒ½å¤Ÿåˆ›å»ºå’Œç®¡ç†å®¹å™¨åŒ–çš„åº”ç”¨å’ŒæœåŠ¡ã€‚

## å®‰è£… Docker

### åœ¨ Ubuntu ä¸Šå®‰è£… Docker

1. æ›´æ–°åŒ…ç´¢å¼•ï¼š

```shell
$ sudo apt-get update
```

2. å®‰è£…å¿…è¦çš„è½¯ä»¶åŒ…ä»¥å…è®¸ `apt` ä½¿ç”¨ HTTPS æ¥è·å–å®‰å…¨å­˜å‚¨åº“ï¼š

```shell
$ sudo apt-get install apt-transport-https ca-certificates curl software-properties-common
```

3. æ·»åŠ  Docker çš„å®˜æ–¹ GPG å¯†é’¥:

```shell
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
```

4. åˆ©ç”¨è¯¥å¯†é’¥æ¥éªŒè¯ Docker å­˜å‚¨åº“ä¸­çš„æ‰€æœ‰è½¯ä»¶åŒ…çš„å®Œæ•´æ€§å’ŒçœŸå®æ€§ï¼š

```shell
$ sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
```

5. å†æ¬¡æ›´æ–°ä½ çš„å­˜å‚¨åº“ç´¢å¼•:

```shell
$ sudo apt-get update
```

6. å®‰è£… Docker CEï¼ˆCommunity Editionï¼‰ï¼š

```shell
$ sudo apt-get install docker-ce
```

7. éªŒè¯å®‰è£…æ˜¯å¦æˆåŠŸï¼Œè¿è¡Œä¸€ä¸ªç®€å•çš„å®¹å™¨æ¥è¾“å‡º "Hello from Docker" æ¶ˆæ¯ï¼š

```shell
$ sudo docker run hello-world
```

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œåˆ™ä½ å·²ç»æ­£ç¡®å®‰è£…äº† Dockerã€‚

### Windows å’Œ macOS å®‰è£…

å¯¹äº Windows æˆ– macOS ç”¨æˆ·ï¼Œå¯ä»¥ä¸‹è½½å¹¶ä½¿ç”¨ Docker Desktop for Mac æˆ– Docker Desktop for Windowsã€‚è¿™æä¾›äº†å›¾å½¢ç•Œé¢å’Œå‘½ä»¤è¡Œå·¥å…·æ¥ç®¡ç†å®¹å™¨ã€‚

## åŸºæœ¬æ¦‚å¿µä¸æœ¯è¯­

- **Imageï¼ˆé•œåƒï¼‰**ï¼šDocker é•œåƒæ˜¯ä¸€ä¸ªè½»é‡çº§ã€ç‹¬ç«‹çš„ã€åŒ…å«æ‰€æœ‰å¿…è¦çš„ä»£ç ä»¥åŠä¾èµ–å…³ç³»çš„æ‰“åŒ…æ–‡ä»¶ï¼Œå¯ä»¥ç”¨æ¥åˆ›å»ºå®¹å™¨ã€‚
- **Containerï¼ˆå®¹å™¨ï¼‰**ï¼šåŸºäºé•œåƒç”Ÿæˆçš„ä¸€ä¸ªè¿è¡Œå®ä¾‹ã€‚æ¯ä¸ªå®¹å™¨éƒ½æ‹¥æœ‰è‡ªå·±çš„ä¸€ç»„è¿›ç¨‹å’Œèµ„æºã€‚

- **Repositoryï¼ˆä»“åº“ï¼‰**ï¼šå­˜å‚¨å’Œå…±äº« Docker é•œåƒçš„åœ°æ–¹ã€‚

## åŸºæœ¬å‘½ä»¤

### æœç´¢é•œåƒ

```shell
$ docker search [image_name]
```

### ä¸‹è½½é•œåƒ

```shell
$ docker pull [image_name]
```

### åˆ—å‡ºæœ¬åœ°æ‰€æœ‰é•œåƒ

```shell
$ docker images
```

### è¿è¡Œå®¹å™¨

```shell
$ docker run -it --name my_container [image_name] /bin/bash
# æˆ–è€…ï¼Œå¯åŠ¨ä¸€ä¸ªåœ¨åå°è¿è¡Œçš„å®¹å™¨ï¼š
$ docker run -d --name my_container [image_name]
```

`-it`: äº¤äº’æ¨¡å¼åŠ ä¸Šåˆ†é…ç»ˆç«¯

### åˆ—å‡ºæ­£åœ¨è¿è¡Œçš„æ‰€æœ‰å®¹å™¨

```shell
$ docker ps
```

### åˆ—å‡ºæ‰€æœ‰å®¹å™¨ï¼ˆåŒ…æ‹¬å·²ç»åœæ­¢ï¼‰

```shell
$ docker ps -a
```

### è¿›å…¥ä¸€ä¸ªå·²å¯åŠ¨çš„å®¹å™¨å†…

```shell
$ docker exec -it [container_name] /bin/bash
```

`-it`: äº¤äº’æ¨¡å¼åŠ ä¸Šåˆ†é…ç»ˆç«¯

### æŸ¥çœ‹æ—¥å¿—

```shell
$ docker logs [container_id]
```

### åœæ­¢ä¸€ä¸ªè¿è¡Œä¸­çš„å®¹å™¨

```shell
$ docker stop [container_id]
```

### åˆ é™¤å®¹å™¨

```shell
$ docker rm [container_name]
```

å¦‚æœè¯¥å®¹å™¨æ­£åœ¨è¿è¡Œï¼Œéœ€è¦å…ˆåœæ­¢å®ƒã€‚

### åˆ é™¤é•œåƒ

```shell
$ docker rmi [image_name]
```

å¦‚æœè¯¥é•œåƒè¢«æŸä¸ªå®¹å™¨ä½¿ç”¨ï¼Œåˆ™å¿…é¡»å…ˆåˆ é™¤å…¶å…³è”çš„å®¹å™¨ã€‚å¯ä»¥ä½¿ç”¨`-f`å¼ºåˆ¶åˆ é™¤ã€‚

```shell
$ docker rmi -f [image_name]
```

## æ„å»ºè‡ªå·±çš„ Docker é•œåƒ

å‡è®¾ä½ æœ‰ä¸€ä¸ª Dockerfile æ–‡ä»¶æ¥æè¿°ä½ çš„åº”ç”¨ç¨‹åºï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ„å»ºä¸€ä¸ªé•œåƒï¼š

```shell
$ docker build -t my_image .
# å¦‚æœéœ€è¦æŒ‡å®šæ ‡ç­¾ï¼ˆtagï¼‰ï¼Œå¯ä»¥ä½¿ç”¨-tå‚æ•°
$ docker build --tag=my_image:version .
```

## Docker Compose

Docker Compose æ˜¯ç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨ Docker åº”ç”¨ç¨‹åºçš„å·¥å…·ã€‚é€šè¿‡ä¸€ä¸ªåä¸º`docker-compose.yml` çš„æ–‡ä»¶ï¼Œä½ å¯ä»¥æè¿°ä¸€ç»„æœåŠ¡ã€ç½‘ç»œåŠå·ã€‚

```yaml
version: "3"
services:
  web:
    build: .
    ports:
      - "5000:5000"
  redis:
    image: "redis:alpine"
```

åœ¨é…ç½®å¥½æ­¤æ–‡ä»¶åï¼š

- ä½¿ç”¨`docker-compose up` æ¥å¯åŠ¨æœåŠ¡ã€‚
- è‹¥è¦åœæ­¢å®¹å™¨ï¼Œå¯ä»¥è¿è¡Œ `docker-compose down`ã€‚

## [DockeråŸºé—®é¢˜è®°å½•](https://blog.dong4j.site/posts/79a8d4c5.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ä¸€ã€å‡çº§åˆ°æœ€æ–°ç‰ˆ

### 1. æ£€æŸ¥å½“å‰å·²å®‰è£…çš„ docker ç›¸å…³è½¯ä»¶åŒ…

```shell
rpm -qa | grep docker
```

### 2. å¸è½½æ—§ç‰ˆæœ¬

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¸è½½æ‰€æœ‰åˆ—å‡ºçš„ç›¸å…³è½¯ä»¶ï¼š

```shell
yum remove docker-<version>
yum remove docker-client-<version>
yum remove docker-common-<version>
# ç¤ºä¾‹:
# yum remove docker-1.13.1-53.git774336d.el7.centos.x86_64
```

### 3. å‡çº§åˆ°æœ€æ–°ç‰ˆ

ä½¿ç”¨ curl å‘½ä»¤å®‰è£…æœ€æ–°çš„ Docker ç‰ˆæœ¬:

```shell
curl -fsSL https://get.docker.com/ | sh
```

### 4. å¯åŠ¨å’Œè®¾ç½®å¼€æœºè‡ªå¯ Docker æœåŠ¡

- é‡å¯ Docker

```shell
systemctl restart docker
```

- è®¾ç½®å¯åŠ¨é¡¹ï¼Œç¡®ä¿ Docker åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œï¼š

```shell
systemctl enable docker
```

## äºŒã€è§£å†³å‡çº§åå®¹å™¨å¯åŠ¨é”™è¯¯

è‹¥ä»æ—§ç‰ˆæœ¬ï¼ˆå¦‚ 1.13.1ï¼‰ç›´æ¥å‡çº§åˆ°æ–°ç‰ˆæœ¬ï¼ˆä¾‹å¦‚ 18.06.1ï¼‰ï¼Œå¯èƒ½ä¼šé‡åˆ°å¦‚ä¸‹æŠ¥é”™ä¿¡æ¯ï¼Œå½“å°è¯•å¯åŠ¨æŸäº›ä½¿ç”¨`docker-runc`è¿è¡Œæ—¶åˆ›å»ºçš„å®¹å™¨æ—¶ï¼š

```shell
Error response from daemon: Unknown runtime specified docker-runc
```

è§£å†³æ–¹æ³•æ˜¯æœç´¢å¹¶æ›¿æ¢æ‰€æœ‰æåˆ°`docker-runc`ä¸º`runc`:

```shell
grep -rl 'docker-runc' /var/lib/docker/containers/ | xargs sed -i 's/docker-runc/runc/g'
systemctl restart docker
docker start f5eb78732bcc # å•ç‹¬é‡å¯å®¹å™¨
```

## ä¸‰ã€å®‰è£… Docker Compose

è‹¥æ‚¨çš„ç³»ç»Ÿæœªå®‰è£… Docker composeï¼Œæ‰§è¡Œä»¥ä¸‹æ­¥éª¤è¿›è¡Œå®‰è£…ï¼š

1. ç¡®è®¤ pip å·²æ­£ç¡®å®‰è£…ã€‚

```shell
pip -V
# è‹¥æ²¡æœ‰è¾“å‡ºï¼Œè¯·æŒ‰ç…§ä¸‹è¿°å‘½ä»¤è¿›è¡Œå®‰è£…:
yum -y install epel-release
yum -y install python-pip
pip install --upgrade pip
```

2. å®‰è£… Docker Compose æœ¬èº«ï¼š

```shell
pip install docker-compose
docker-compose -version # æ£€æŸ¥æ˜¯å¦æ­£ç¡®å®‰è£…äº†Docker Compose
```

## å››ã€Docker ç£ç›˜æ¸…ç†ä¸é•œåƒç®¡ç†

### ç³»ç»Ÿåƒåœ¾æ¸…ç†:

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¸…ç†ä¸éœ€è¦çš„å®¹å™¨ï¼Œç½‘ç»œå’Œé•œåƒç­‰ï¼š

```shell
docker system prune
```

æŸ¥çœ‹ Docker æ‰€å ç”¨çš„ç©ºé—´å¤§å°, ä½¿ç”¨:

```shell
docker system df
```

### é•œåƒæ–‡ä»¶å­˜å‚¨å’ŒåŠ è½½

- ä¿å­˜ Docker é•œåƒè‡³ tar æ–‡ä»¶:

```shell
docker save -o xxxx.tar {imageId}
```

- åŠ è½½å·²ä¿å­˜çš„é•œåƒ:

```shell
docker load -i xxxx.tar
```

## å…¶ä»–é—®é¢˜å¤„ç†

### MySQL æ–‡ä»¶ç›®å½•è®¾ç½®

å½“ä½¿ç”¨å¤–éƒ¨å­˜å‚¨è·¯å¾„æ—¶ï¼ŒåŠ¡å¿…æŒ‡å®š`/var/lib/mysql-files` çš„å®Œæ•´è·¯å¾„ã€‚ä¾‹å¦‚ï¼š

```shell
-v /home/mysql/mysql-files:/var/lib/mysql-files/
```

### Docker æƒé™é—®é¢˜:

å¯¹äºä¸€äº›éœ€è¦ root æƒé™çš„æ“ä½œï¼Œå¯ä»¥æ·»åŠ  `--privileged=true` å‚æ•°ã€‚

## äº”ã€æŸ¥çœ‹å®¹å™¨æ—¥å¿—ä¸è®¾ç½®è‡ªåŠ¨å¯åŠ¨

- æŸ¥çœ‹ Docker å®¹å™¨çš„æ—¥å¿—ä¿¡æ¯ï¼š

```shell
docker logs -t --tail=n [å®¹å™¨id]
```

è¦ç¡®ä¿ Docker å®¹å™¨åœ¨é‡å¯åä»èƒ½æ­£å¸¸è¿è¡Œ, å¯ä»¥åœ¨å¯åŠ¨æ—¶ä½¿ç”¨`--restart`å‚æ•°ï¼Œæ”¯æŒä»¥ä¸‹å€¼ï¼š

- `no`: ä¸å°è¯•é‡æ–°å¯åŠ¨å·²é€€å‡ºçš„å®¹å™¨ã€‚
- `on-failure[:N]`: å½“å®¹å™¨éé›¶çŠ¶æ€é€€å‡ºæ—¶æ‰é‡å¯ã€‚å¯é€‰åœ°é™åˆ¶ä¸ºæœ€å¤š N æ¬¡é‡å¯
- `always`: æ€»æ˜¯é‡å¯è¯¥å®¹å™¨

ä¾‹å¦‚:

```shell
docker run --restart=on-failure:10 redis # åœ¨å¤±è´¥åå°è¯•é‡æ–°å¯åŠ¨10æ¬¡ã€‚
```

å¦‚æœå·²ç»åˆ›å»ºäº†å®¹å™¨ä½†éœ€è¦æ›´æ”¹å…¶`--restart`ç­–ç•¥ï¼Œä½¿ç”¨æ›´æ–°å‘½ä»¤ï¼š

```shell
docker update --restart=always xxxxx_containername
```

## [JUnit4 å…¥é—¨ï¼šæŒæ¡ Java å•å…ƒæµ‹è¯•çš„è‰ºæœ¯](https://blog.dong4j.site/posts/6961d5gq.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

JUnit æ˜¯ä¸€ä¸ªå¼€æ”¾æºä»£ç çš„ Java æµ‹è¯•æ¡†æ¶ï¼Œç”¨äºç¼–å†™å’Œè¿è¡Œå¯é‡å¤çš„æµ‹è¯•ã€‚ä»–æ˜¯ç”¨äºå•å…ƒæµ‹è¯•æ¡†æ¶ä½“ç³» xUnit çš„ä¸€ä¸ªå®ä¾‹ï¼ˆç”¨äº java è¯­è¨€ï¼‰ã€‚

## ä¸ºä»€ä¹ˆä½¿ç”¨ Junit

æˆ‘ä»¬ä»¥å‰æµ‹è¯•ä¸€ä¸ªç±»çš„æ­¥éª¤:

1. æ–°å»ºä¸€ä¸ª test ç±»
2. åˆ›å»º main() æ–¹æ³•
3. åœ¨ main ç±» new ä¸€ä¸ªæˆ‘ä»¬è¦æµ‹è¯•çš„ç±»çš„å®ä¾‹
4. ç„¶åè°ƒç”¨è¿™ä¸ªç±»çš„æ–¹æ³•,è¾“å‡ºä¸€ä¸ªç»“æœ

å½“æµ‹è¯•çš„ç±»æœ‰å¤šä¸ªæ–¹æ³•æ—¶,æˆ‘ä»¬å¿…é¡»è°ƒç”¨æ‰€æœ‰çš„æ–¹æ³•,ä¸ºäº†ä¸è®©ä¸Šä¸€æ¬¡çš„æ–¹æ³•è°ƒç”¨å¯¹ä¸‹ä¸€æ¬¡çš„è°ƒç”¨äº§ç”Ÿå½±å“,æˆ‘ä»¬ä¼šåœ¨ new ä¸€ä¸ªå®ä¾‹å‡ºæ¥,æˆ–è€…å°†ä¸Šä¸€æ¬¡çš„ä»£ç æ³¨é‡Šæ‰.  
åˆ™å°†é€ æˆæ•´ä¸ªæµ‹è¯•ä»£ç çš„æ··ä¹±.  
è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¸Œæœ›å¦‚æœå¯ä»¥æœ‰å¤šä¸ª mian() æ–¹æ³•,æ¯ä¸ª main() æ–¹æ³•å†…åªè°ƒç”¨ä¸€ä¸ªéœ€è¦æµ‹è¯•çš„ç±»çš„æ–¹æ³•,  
è¿™æ ·æ˜¾å¾—è°ƒç†æ¸…æ™°.ä½†æ˜¯è¿™æ˜¯ä¸å¯èƒ½çš„,ä¸€ä¸ªç¨‹åºåªèƒ½æœ‰ä¸€ä¸ªå…¥å£

è¿™ä¸ªæ—¶å€™,Junit ç«™äº†å‡ºæ¥,å®ƒå¤§å£°çš„è¯´å®ƒå¯ä»¥åšåˆ°.

## æ€ä¹ˆä½¿ç”¨ Junit

ä¸»è¦æ­¥éª¤:

1. æ–°å»ºä¸€ä¸ª java é¡¹ç›®
2. åœ¨ src ä¸‹æ–°å»ºä¸€ä¸ª util åŒ…,ç¼–å†™ä¸€ä¸ªæ™®é€šçš„ç±»

```java
/**
 * å¯¹åç§°,åœ°å€ç­‰å­—ç¬¦ä¸²æ ¼å¼çš„å†…å®¹è¿›è¡Œæ ¼å¼æ£€æŸ¥
 * æˆ–è€…æ ¼å¼åŒ–çš„å·¥å…·ç±»
 */
public class WordDeanUtil {
	/**
	 * å°†Javaå¯¹è±¡åç§°(æ¯ä¸ªå•è¯çš„å¤´å­—ç¬¦å¤§å†™)æŒ‰ç…§
	 * æ•°æ®åº“å‘½åçš„ä¹ æƒ¯è¿›è¡Œæ ¼å¼åŒ–
	 * æ ¼å¼åŒ–åçš„æ•°æ®ä¸ºå°å†™å­—æ¯,å¹¶ä¸”ä½¿ç”¨ä¸‹åˆ’çº¿åˆ†å‰²å‘½åå•è¯
	 * ä¾‹å¦‚:employeeInfo-->employee_info
	 *
	 * @param name  Javaå¯¹è±¡åç§°
	 */
	public static String wordFormat4DB(String name){
        //ä½¿ç”¨ç»™å®šçš„æ­£åˆ™è¡¨è¾¾å¼åˆ›å»ºPatternå¯¹è±¡(å°†ç»™å®šçš„æ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘åˆ°æ¨¡å¼ä¸­ã€‚)
		Pattern p = Pattern.compile("[A-Z]");
        //åˆ›å»º å­—ç¬¦ä¸²å’Œæ¨¡å¼åŒ¹é…çš„åŒ¹é…å™¨
		Matcher m = p.matcher(name);
		StringBuffer sb = new StringBuffer();
        //æ‹¿ç€nameä¸­çš„å­—ç¬¦ä¸€ä¸ªä¸€ä¸ªçš„å»å’Œæ­£åˆ™è¡¨è¾¾å¼å¯¹æ¯”,æˆåŠŸè¿”å›true
		while(m.find()){
            //æ‰¾å¤§å†™å­—æ¯
            m.appendReplacement(sb, "_" + m.group());
		}
		return m.appendTail(sb).toString().toLowerCase();
	}
}
```

3. åœ¨ src ä¸‹æ–°å»ºä¸€ä¸ª tests æ–‡ä»¶å¤¹,å°†å®ƒè®¾ç½®ä¸ºæµ‹è¯•ä¸“ç”¨æ–‡ä»¶å¤¹
   - åœ¨å·¥ç¨‹åä¸ŠæŒ‰ f4
   - æ‰¾åˆ° Modules-->Sources
   - æ‰¾åˆ° tests æ–‡ä»¶å¤¹,ç„¶å Mark as Tests

![20241229154732_szYRVb9s.webp](https://cdn.dong4j.site/source/image/20241229154732_szYRVb9s.webp)

4. é€‰ä¸­æˆ‘ä»¬è¦æµ‹è¯•çš„ç±»çš„ç±»å,ç„¶å Ctrl+shift+t --> Create new test
5. é€‰æ‹© Junit4,ç„¶åé€‰æ‹©è¦æµ‹è¯•çš„ç±»çš„æ–¹æ³• (method),setUp å’Œ tearDown åé¢å†ä»‹ç»  
   ![20241229154732_CjwnCDQD.webp](https://cdn.dong4j.site/source/image/20241229154732_CjwnCDQD.webp)

6. ç‚¹å‡» OK å,å¦‚æœå‰é¢çš„ test æµ‹è¯•æ–‡ä»¶å¤¹æ²¡æœ‰å‡ºé”™çš„è¯,ä¼šåœ¨ tests æ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆä¸€ä¸ªåŒ…,è¿™ä¸ªåŒ…å’Œæˆ‘ä»¬è¦æµ‹è¯•çš„ç±»çš„åŒ…ä¸€æ ·,è¿˜æœ‰ä¸€ä¸ªä»¥æµ‹è¯•ç±»å +Test çš„ç±» (ä¸åŒçš„ IDE æœ‰ä¸åŒçš„è§„åˆ™,Myeclipse å°±æ˜¯åœ¨å‰é¢åŠ  test çš„),æˆ‘ä»¬ä¸»è¦åœ¨è¿™ä¸ªç±»ä¸­æ“ä½œ  
   (å•å…ƒæµ‹è¯•ä»£ç å’Œè¢«æµ‹è¯•ä»£ç ä½¿ç”¨ä¸€æ ·çš„åŒ…,ä¸åŒçš„ç›®å½•)

![20241229154732_2bT5TNG7.webp](https://cdn.dong4j.site/source/image/20241229154732_2bT5TNG7.webp)

7.  ä¸‹é¢æ¥å†™ä¸€ä¸ªç®€å•çš„æµ‹è¯•æ–¹æ³•  
    æµ‹è¯•æ–¹æ³•ä¹¦å†™è§„èŒƒ: - æµ‹è¯•æ–¹æ³•å¿…é¡»ä½¿ç”¨æ³¨è§£ org.junit.Test ä¿®é¥° - æµ‹è¯•æ–¹æ³•å¿…é¡»ä½¿ç”¨ public void ä¿®é¥°,è€Œä¸”ä¸èƒ½å¸¦æœ‰ä»»ä½•å‚æ•° - æµ‹è¯•æ–¹æ³•åä¸€èˆ¬ä»¥ test+ è¢«æµ‹è¯•çš„æ–¹æ³•åä¹¦å†™  
    ![20241229154732_EF3hDbgY.webp](https://cdn.dong4j.site/source/image/20241229154732_EF3hDbgY.webp)

        	- è¯´æ˜:
        		1. æˆ‘ä»¬åªéœ€è¦è¦è¿™ä¸ªæµ‹è¯•æ–¹æ³•å½“æˆä¸€ä¸ª main() æ–¹æ³•,åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢ä¹¦å†™æˆ‘ä»¬ä»¥å‰åœ¨ main() æ–¹æ³•å†…å†™è¿‡çš„æµ‹è¯•ä»£ç .
        			- new ä¸€ä¸ªæˆ‘ä»¬è¦æµ‹è¯•çš„ç±»çš„å®ä¾‹
        			- ç„¶åè°ƒç”¨è¿™ä¸ªç±»çš„æ–¹æ³•,è¾“å‡ºä¸€ä¸ªç»“æœ
        		2. åœ¨è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬åªæœ‰ä¸€ä¸ªéœ€è¦æµ‹è¯•çš„æ–¹æ³•,è€Œä¸”æ˜¯é™æ€çš„.æ‰€ä»¥ç›´æ¥å°±ä½¿ç”¨ç±»å + æ–¹æ³•åè°ƒç”¨æˆ‘ä»¬è¦æµ‹è¯•çš„æ–¹æ³•äº†
        		3. `assertEquals("employee_info",reslut)` çš„æ„æ€æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°æ—¶æˆ‘ä»¬èƒ½é¢„æµ‹çš„æƒ³è¦çš„ç»“æœ,ç¬¬äºŒä¸ªå‚æ•°æ˜¯æˆ‘ä»¬è¦æµ‹è¯•çš„æ–¹æ³•è¿”å›çš„ç»“æœ,å¦‚æœè¿™ä¸¤ä¸ªå­—ç¬¦ä¸²ç›¸åŒ,æ•´ä¸ªæµ‹è¯•é€šè¿‡.
        		4. æˆ‘ä»¬å®Œå…¨å¯ä»¥ä¸ä½¿ç”¨ Junit æä¾›çš„è¿™ä¸ªæ–¹æ³•
        			![20241229154732_cN5eJ3Gv.webp](https://cdn.dong4j.site/source/image/20241229154732_cN5eJ3Gv.webp)

        		5. assertEquals æ˜¯ç”± JUnit æä¾›çš„ä¸€ç³»åˆ—åˆ¤æ–­æµ‹è¯•ç»“æœæ˜¯å¦æ­£ç¡®çš„é™æ€æ–­è¨€æ–¹æ³•ï¼ˆä½äºç±» org.junit.Assert ä¸­ï¼‰ä¹‹ä¸€
        		6. Junit ç»™æˆ‘ä»¬æä¾›äº†å¤§é‡çš„é™æ€æ–¹æ³•è®©æˆ‘ä»¬ç¼–å†™å°‘é‡çš„ä»£ç å°±å¯ä»¥å®Œæˆæµ‹è¯•.æˆ‘ä»¬å¹²å˜›ä¸ç”¨å‘¢?

**å•å…ƒæµ‹è¯•ä¸æ˜¯ç”¨æ¥è¯æ˜ä½ æ˜¯å¯¹çš„,è€Œæ˜¯ä¸ºäº†è¯æ˜ä½ æ²¡æœ‰é”™**  
 è™½ç„¶ä¸Šé¢çš„æµ‹è¯•è¿è¡Œé€šè¿‡äº†,ä½†æ˜¯å¹¶ä¸ä»£è¡¨ä»£ç é€šè¿‡å•å…ƒæµ‹è¯•,å› ä¸ºå•å…ƒæµ‹è¯•ä¸æ˜¯è¯æ˜ä½ æ˜¯å¯¹çš„è€Œè®¾è®¡çš„,æˆ‘ä»¬å¾—æƒ³æ–¹è®¾æ³•æ¥è¯æ˜æˆ‘ä»¬çš„ä»£ç æ²¡æœ‰é”™.  
 æ‰€æœ‰æˆ‘ä»¬å¾—è€ƒè™‘åˆ°æ‰€æœ‰å¾—æƒ…å†µæ¥è¯æ˜æˆ‘ä»¬å¾—ä»£ç æ²¡æœ‰é”™è¯¯:

**ä¸Šä¸€ä¸ªæµ‹è¯•çš„è¡¥å……:**

1. æµ‹è¯• null æ—¶çš„å¤„ç†æƒ…å†µ
2. æµ‹è¯•ç©ºå­—ç¬¦ä¸²çš„å¤„ç†æƒ…å†µ
3. æµ‹è¯•å•é¦–å­—æ¯å¤§å†™æ—¶çš„æƒ…å†µ
4. æµ‹è¯•å¤šä¸ªç›¸è¿å­—æ¯å¤§å†™æ—¶çš„æƒ…å†µ

å®Œæˆæµ‹è¯•ä»£ç :

```java
public class WordDeanUtilTest {

    @Before
    public void setUp() throws Exception {
        System.out.println("æµ‹è¯•å¼€å§‹");
    }

    @After
    public void tearDown() throws Exception {
        System.out.println("æµ‹è¯•ç»“æŸ");
    }
    @Test
    public void testWordFormat4DB() {
        String target = "employeeInfo";
        String reslut = WordDeanUtil.wordFormat4DB(target);
        assertEquals("employee_info", reslut);
    }

    //æµ‹è¯•nullæ—¶çš„å¤„ç†æƒ…å†µ
    @Test
    public void wordFormat4DBNull(){
        String target = null;
        String reslut = WordDeanUtil.wordFormat4DB(target);
        assertNull(reslut);
    }

    //æµ‹è¯•ç©ºå­—ç¬¦ä¸²çš„å¤„ç†æƒ…å†µ
    @Test
    public void wordFormat4DBEmpty(){
        String target = "";
        String reslut = WordDeanUtil.wordFormat4DB(target);
        assertEquals("", reslut);
    }

    //æµ‹è¯•å½“é¦–å­—æ¯å¤§å†™æ—¶çš„å¤„ç†æƒ…å†µ
    @Test
    public void wordFormat4DBBegin() {
        String target = "EmployeeInfo";
        String reslut = WordDeanUtil.wordFormat4DB(target);
        assertEquals("employee_info", reslut);
    }

    //æµ‹è¯•å°¾å­—æ¯å¤§å†™æ—¶çš„å¤„ç†æƒ…å†µ
    @Test
    public void wordFormat4DBEnd() {
        String target = "employeeInfoA";
        String reslut = WordDeanUtil.wordFormat4DB(target);
        assertEquals("employee_info_a", reslut);
    }

    //æµ‹è¯•å¤šä¸ªé¡¹é“¾å­—æ¯å¤§å†™æ—¶çš„å¤„ç†æƒ…å†µ
    @Test
    public void wordFormat4DBTogether() {
        String target = "employeeAInfo";
        String reslut = WordDeanUtil.wordFormat4DB(target);
        assertEquals("employee_a_info", reslut);
    }
}
```

å†æ¬¡è¿è¡Œä¸Šé¢çš„æµ‹è¯•ä»£ç æ—¶,ä½ ä¼šå‘ç°æµ‹è¯•æœªé€šè¿‡  
![20241229154732_N6WdzrGS.webp](https://cdn.dong4j.site/source/image/20241229154732_N6WdzrGS.webp)

![20241229154732_YxaXWhDE.webp](https://cdn.dong4j.site/source/image/20241229154732_YxaXWhDE.webp)

æœ‰ä¸€ä¸ªç©ºæŒ‡é’ˆå¼‚å¸¸,ç”±æ­¤å¯è§æˆ‘ä»¬çš„ wordFormat4DB() æ–¹æ³•æ²¡æœ‰å¯¹ null åšå‡ºå¤„ç†  
è¿˜æœ‰ä¸€ä¸ªå¤„ç†ç»“æœå’Œæˆ‘ä»¬é¢„æœŸçš„ä¸ä¸€æ ·,è¿™å°±æ˜¯ä¸€ä¸ª bug,è¢« Junit æ‰¾å‡ºæ¥äº†

ä¿®æ”¹è¢«æµ‹è¯•çš„ä»£ç :

```java
public class WordDeanUtil {
	/**
	 * å°†Javaå¯¹è±¡åç§°(æ¯ä¸ªå•è¯çš„å¤´å­—ç¬¦å¤§å†™)æŒ‰ç…§
	 * æ•°æ®åº“å‘½åçš„ä¹ æƒ¯è¿›è¡Œæ ¼å¼åŒ–
	 * æ ¼å¼åŒ–åçš„æ•°æ®ä¸ºå°å†™å­—æ¯,å¹¶ä¸”ä½¿ç”¨ä¸‹åˆ’çº¿åˆ†å‰²å‘½åå•è¯
	 * ä¾‹å¦‚:employeeInfo-->employee_info
	 *
	 * @param name  Javaå¯¹è±¡åç§°
	 */
	public static String wordFormat4DB(String name){
		//å¢åŠ nulléªŒè¯
        if(name == null){
            return null;
        }
        //ä½¿ç”¨ç»™å®šçš„æ­£åˆ™è¡¨è¾¾å¼åˆ›å»ºPatternå¯¹è±¡(å°†ç»™å®šçš„æ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘åˆ°æ¨¡å¼ä¸­ã€‚)
		Pattern p = Pattern.compile("[A-Z]");
        //åˆ›å»º å­—ç¬¦ä¸²å’Œæ¨¡å¼åŒ¹é…çš„åŒ¹é…å™¨
		Matcher m = p.matcher(name);
		StringBuffer sb = new StringBuffer();
        //æ‹¿ç€nameä¸­çš„å­—ç¬¦ä¸€ä¸ªä¸€ä¸ªçš„å»å’Œæ­£åˆ™è¡¨è¾¾å¼å¯¹æ¯”,æˆåŠŸè¿”å›true
		while(m.find()){
			//å¢åŠ é¦–å­—æ¯å¤§å†™éªŒè¯
            if(m.start() != 0){
                m.appendReplacement(sb, ("_" + m.group()).toLowerCase());
            }

		}
		return m.appendTail(sb).toString().toLowerCase();
	}
}
```

å†æ¬¡è¿è¡Œ,æµ‹è¯•é€šè¿‡~~~~

---

## Junit æ·±å…¥ç†è§£

### Fixture

å½“ç¼–å†™æµ‹è¯•æ–¹æ³•æ—¶,å¿…é¡»å…ˆåˆå§‹åŒ–æ•°æ®,æ¯ä¸ªæµ‹è¯•æ–¹æ³•éƒ½éœ€è¦è¿™ä¹ˆåš,å°±ä¼šé€ æˆé‡å¤çš„ä»£ç ,æ‰€ä»¥ Junit æå‡ºäº† Fixture è§£å†³æ–¹æ¡ˆ  
Fixture:  
æ•´æ²»æ‰§è¡Œä¸€ä¸ªæˆ–è€…å¤šä¸ªæµ‹è¯•æ–¹æ³•æ—¶éœ€è¦çš„ä¸€ç³»åˆ—å…¬å…±èµ„æºæˆ–è€…æ•°æ®.

æ„æ€å°±æ˜¯åˆå§‹åŒ–å¤šä¸ªæµ‹è¯•æ–¹æ³•éƒ½éœ€è¦ä½¿ç”¨åˆ°çš„æ•°æ®

è®¾ç½® Fixture:

1. ä½¿ç”¨æ³¨è§£ org.junit.Before ä¿®é¥°ç”¨äºåˆå§‹åŒ–çš„æ–¹æ³•
2. ä½¿ç”¨æ³¨è§£ org.junit.After ä¿®é¥°ç”¨äºæ³¨é”€çš„æ–¹æ³•
3. ä¿è¯è¿™ä¸¤ç§æ–¹æ³•éƒ½æ˜¯ç”¨ public void ä¿®é¥°,è€Œä¸”ä¸èƒ½å¸¦ä»»ä½•å‚æ•°

æ–¹æ³•çº§åˆ«çš„ Fixture è®¾ç½®æ–¹æ³•:

```java
//åˆå§‹åŒ–æ–¹æ³•
@Before
public void init(){...}
//æ³¨é”€æ–¹æ³•
@After
public void destroy(){...}
```

åœ¨**æ¯ä¸ª**æµ‹è¯•æ–¹æ³•æ‰§è¡Œä¹‹å‰,éƒ½ä¼šæ‰§è¡Œ init æ–¹æ³•;  
æµ‹è¯•æ–¹æ³•æ‰§è¡Œå®Œæ¯•ä¹‹å,éƒ½ä¼šæ‰§è¡Œ destroy() æ–¹æ³•;  
è¿™ç§æ–¹å¼ä¿è¯äº†å„ä¸ªç‹¬ç«‹æµ‹è¯•ä¹‹é—´äº’ä¸å¹²æ‰°,ä¸€é¢å…¶ä»–æµ‹è¯•ä»£ç ä¿®æ”¹æµ‹è¯•ç¯å¢ƒæˆ–è€…æµ‹è¯•æ•°æ®å½±å“åˆ°å…¶ä»–æµ‹è¯•ä»£ç çš„å‡†ç¡®æ€§

æ–¹æ³•çº§åˆ« Fixture æ‰§è¡Œç¤ºæ„å›¾  
![20241229154732_4JtLsecj.webp](https://cdn.dong4j.site/source/image/20241229154732_4JtLsecj.webp)

ä¸‹é¢æ˜¯å…·ä½“çš„æµ‹è¯•ç»“æœ:  
![20241229154732_7WIqoyMi.webp](https://cdn.dong4j.site/source/image/20241229154732_7WIqoyMi.webp)

è·Ÿæè¿°çš„ä¸€æ ·~~~~

ä½†æ˜¯è¿™ç§æ–¹å¼æ•ˆç‡ä½ä¸‹,æ¯ä¸ªæµ‹è¯•æ–¹æ³•éƒ½è¦åˆå§‹åŒ–ä¸€æ¬¡,å…³é—­ä¸€æ¬¡,å¯¹æ•°æ®åº“è¿æ¥æ¥è¯´æ˜¯ä¸€åœºå™©æ¢¦;  
è€Œä¸”å¯¹äºä¸ä¼šå‘ç”Ÿå˜åŒ–çš„æµ‹è¯•ç¯å¢ƒæˆ–è€…æµ‹è¯•æ•°æ®æ¥è¯´,æ˜¯ä¸ä¼šå½±å“åˆ°æ‰§è¡Œç»“æœçš„,é¡µå°±æ²¡å¿…è¦æ¯æ¬¡éƒ½åˆå§‹åŒ–å’Œé”€æ¯;  
å› æ­¤ Junit4 å¼•å…¥äº† **çº§åˆ«çš„ Fixture è®¾ç½®æ–¹æ³•:**

1. ä½¿ç”¨æ³¨è§£ org.junit.BeforeClass ä¿®é¥°ç”¨äºåˆå§‹åŒ–çš„æ–¹æ³•
2. ä½¿ç”¨æ³¨è§£ org.junit.AfterClass ä¿®é¥°ç”¨äºæ³¨é”€çš„æ–¹æ³•
3. ä¿è¯è¿™ä¸¤ç§æ–¹æ³•éƒ½æ˜¯ç”¨ public static void ä¿®é¥°,è€Œä¸”ä¸èƒ½å¸¦ä»»ä½•å‚æ•°

ç±»çº§åˆ«çš„ Fixture ä»…ä¼šåœ¨æµ‹è¯•ç±»ä¸­æ‰€æœ‰æµ‹è¯•æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œåˆå§‹åŒ–,å¹¶ä¸”åœ¨å…¨éƒ¨æµ‹è¯•æ–¹æ³•æµ‹è¯•å®Œæ¯•åæ‰§è¡Œæ³¨é”€æ–¹æ³•

```java
@BeforeClass
public void static init(){...}
@AfterClass
public void static destroy(){...}
```

ä¸‹é¢æ˜¯å…·ä½“çš„æµ‹è¯•ç»“æœ:  
![20241229154732_SO1IaVeg.webp](https://cdn.dong4j.site/source/image/20241229154732_SO1IaVeg.webp)

### å¼‚å¸¸å’Œæ—¶é—´æµ‹è¯•

æ³¨è§£ org.junit.Test ä¸­æœ‰ä¸¤ä¸ªéå¸¸æœ‰ç”¨çš„å‚æ•°ï¼š expected å’Œ timeoutã€‚

#### expected

ä»£è¡¨æµ‹è¯•æ–¹æ³•æœŸæœ›æŠ›å‡ºæŒ‡å®šçš„å¼‚å¸¸ï¼Œå¦‚æœè¿è¡Œæµ‹è¯•å¹¶æ²¡æœ‰æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ï¼Œåˆ™ JUnit ä¼šè®¤ä¸ºè¿™ä¸ªæµ‹è¯•æ²¡æœ‰é€šè¿‡ã€‚è¿™ä¸ºéªŒ  
è¯è¢«æµ‹è¯•æ–¹æ³•åœ¨é”™è¯¯çš„æƒ…å†µä¸‹æ˜¯å¦ä¼šæŠ›å‡ºé¢„å®šçš„å¼‚å¸¸æä¾›äº†ä¾¿åˆ©ã€‚  
ä¸¾ä¾‹æ¥è¯´ï¼Œæ–¹æ³• supportDBChecker  
ç”¨äºæ£€æŸ¥ç”¨æˆ·ä½¿ç”¨çš„æ•°æ®åº“ç‰ˆæœ¬æ˜¯å¦åœ¨ç³»ç»Ÿçš„æ”¯æŒçš„èŒƒå›´ä¹‹å†…ï¼Œå¦‚æœç”¨æˆ·ä½¿ç”¨äº†ä¸è¢«æ”¯æŒçš„æ•°æ®åº“ç‰ˆæœ¬ï¼Œ  
åˆ™ä¼šæŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸ UnsupportedDBVersionExceptionã€‚æµ‹è¯•æ–¹æ³• supportDBChecker åœ¨æ•°æ®åº“ç‰ˆ  
æœ¬ä¸æ”¯æŒæ—¶æ˜¯å¦ä¼šæŠ›å‡ºæŒ‡å®šå¼‚å¸¸çš„å•å…ƒæµ‹è¯•æ–¹æ³•å¤§ä½“å¦‚ä¸‹ï¼š

```java
@Test(expected=UnsupportedDBVersionException.class)
public void unsupportedDBCheck(){
	â€¦â€¦
}
```

#### timeout

æŒ‡å®šè¢«æµ‹è¯•æ–¹æ³•è¢«å…è®¸è¿è¡Œçš„æœ€é•¿æ—¶é—´åº”è¯¥æ˜¯å¤šå°‘ï¼Œå¦‚æœ  
æµ‹è¯•æ–¹æ³•è¿è¡Œæ—¶é—´è¶…è¿‡äº†æŒ‡å®šçš„æ¯«ç§’æ•°ï¼Œåˆ™ JUnit è®¤ä¸ºæµ‹è¯•å¤±è´¥ã€‚è¿™ä¸ªå‚æ•°å¯¹äºæ€§èƒ½æµ‹è¯•æœ‰ä¸€å®šçš„å¸®åŠ©ã€‚  
ä¾‹å¦‚ï¼Œå¦‚æœè§£æä¸€ä»½è‡ªå®šä¹‰çš„ XML æ–‡æ¡£èŠ±è´¹äº†å¤šäº 1 ç§’çš„æ—¶é—´ï¼Œå°±éœ€è¦é‡æ–°è€ƒè™‘ XML ç»“æ„çš„è®¾è®¡ï¼Œ  
é‚£å•å…ƒæµ‹è¯•æ–¹æ³•å¯ä»¥è¿™æ ·æ¥å†™ï¼š

```java
@Test(timeout=1000)
public void selfXMLReader(){
â€¦â€¦
}
```

### å¿½ç•¥æµ‹è¯•æ–¹æ³•

JUnit æä¾›æ³¨è§£ org.junit.Ignore ç”¨äºæš‚æ—¶å¿½ç•¥æŸä¸ªæµ‹è¯•æ–¹æ³•ï¼Œå› ä¸ºæœ‰æ—¶å€™ç”±äºæµ‹è¯•ç¯å¢ƒå—é™ï¼Œå¹¶ä¸èƒ½  
ä¿è¯æ¯ä¸€ä¸ªæµ‹è¯•æ–¹æ³•éƒ½èƒ½æ­£ç¡®è¿è¡Œã€‚ä¾‹å¦‚ä¸‹é¢çš„ä»£ç ä¾¿è¡¨ç¤ºç”±äºæ²¡æœ‰äº†æ•°æ®åº“é“¾æ¥ï¼Œæç¤º JUnit å¿½ç•¥æµ‹è¯•æ–¹æ³• unsupportedDBCheckï¼š

```java
@Ignore(â€œdb is downâ€)
@Test(expected=UnsupportedDBVersionException.class)
public void unsupportedDBCheck(){
â€¦â€¦
}
```

ä½†æ˜¯ä¸€å®šè¦å°å¿ƒã€‚æ³¨è§£ org.junit.Ignore åªèƒ½ç”¨äºæš‚æ—¶çš„å¿½ç•¥æµ‹è¯•ï¼Œå¦‚æœéœ€è¦æ°¸è¿œå¿½ç•¥è¿™äº›æµ‹è¯•ï¼Œä¸€å®š  
è¦ç¡®è®¤è¢«æµ‹è¯•ä»£ç ä¸å†éœ€è¦è¿™äº›æµ‹è¯•æ–¹æ³•ï¼Œä»¥å…å¿½ç•¥å¿…è¦çš„æµ‹è¯•ç‚¹ã€‚

### æµ‹è¯•å¥—ä»¶

åœ¨å®é™…å¼€å‘ä¸­,å•å…ƒæµ‹è¯•ç±»ä¼šè¶Šæ¥è¶Šå¤š,è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†ä¸€ä¸ªä¸€ä¸ªçš„è¿è¡Œæµ‹è¯•ç±»å°±æ‚²å‰§äº†.  
æ‰€å¹¸çš„æ˜¯ Junit ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§æ‰¹é‡è¿è¡Œæµ‹è¯•ç±»çš„æ–¹æ³•,å«æµ‹è¯•å¥—ä»¶.  
å†™æ³•:

1. åˆ›å»ºä¸€ä¸ªç©ºç±»ä½œä¸ºæµ‹è¯•å¥—ä»¶çš„å…¥å£
2. ä½¿ç”¨æ³¨è§£ org.junit.ranner.RunWith å’Œ org.junit.runners.Suite.SuiteClasses ä¿®é¥°è¿™ä¸ªç©ºç±»
3. å°† org.junit.runners.Suite ä½œä¸ºå‚æ•°ä¼ å…¥æ³¨è§£ RunWith,ä»¥æç¤º Junit ä¸ºæ­¤ç±»ä½¿ç”¨å¥—ä»¶è¿è¡ŒæœŸæ‰§è¡Œ
4. å°†éœ€è¦æ”¾å…¥æ­¤æµ‹è¯•å¥—ä»¶çš„æµ‹è¯•ç±»ç»„æˆæ•°ç»„ä½œä¸ºæ³¨è§£ SuiteClasses çš„å‚æ•°
5. ä¿è¯è¿™ä¸ªç©ºç±»ä½¿ç”¨ public ä¿®é¥°,è€Œä¸”å­˜åœ¨å…¬å¼€çš„ä¸å¸¦ä»»ä½•å‚æ•°çš„æ„é€ å‡½æ•°

## JUnit å’Œ Ant

ant æä¾›äº†ä¸¤ä¸ª target ï¼š junit å’Œ junitreport è¿è¡Œæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ï¼Œå¹¶ç”Ÿæˆ html æ ¼å¼çš„æŠ¥è¡¨  
å…·ä½“æ“ä½œå¦‚ä¸‹ï¼š  
1.å°† junit.jar æ”¾åœ¨ ANT_HOMElib ç›®å½•ä¸‹  
2.ä¿®æ”¹ build.xml ï¼ŒåŠ å…¥å¦‚ä¸‹ å†…å®¹ï¼š  
-------------- One or more tests failed, check the report for detailâ€¦ -----------------------------  
è¿è¡Œ è¿™ä¸ª target ï¼Œant ä¼šè¿è¡Œæ¯ä¸ª TestCaseï¼Œåœ¨ report ç›®å½•ä¸‹å°±æœ‰äº† å¾ˆå¤š `TEST*.xml` å’Œ ä¸€äº›ç½‘é¡µæ‰“å¼€ report ç›®å½•ä¸‹çš„ index.html å°±å¯ä»¥çœ‹åˆ°å¾ˆç›´è§‚çš„æµ‹è¯•è¿è¡ŒæŠ¥å‘Šï¼Œä¸€ç›®äº†ç„¶ã€‚  
åœ¨ Eclipse ä¸­å¼€å‘ã€è¿è¡Œ JUnit æµ‹è¯•ç›¸å½“ç®€å•ã€‚å› ä¸º Eclipse æœ¬èº«é›†æˆäº† JUnit ç›¸å…³ç»„ä»¶ï¼Œå¹¶å¯¹ JUnit çš„è¿è¡Œæä¾›äº†æ— ç¼çš„æ”¯æŒã€‚

## æ€»ç»“

ä¸‹é¢æ˜¯ä¸€äº›å…·ä½“çš„ç¼–å†™æµ‹è¯•ä»£ç çš„æŠ€å·§æˆ–è¾ƒå¥½çš„å®è·µæ–¹æ³•ï¼š

1. ä¸è¦ç”¨ TestCase çš„æ„é€ å‡½æ•°åˆå§‹åŒ– Fixtureï¼Œè€Œè¦ç”¨ setUp() å’Œ tearDown() æ–¹æ³•ã€‚
2. ä¸è¦ä¾èµ–æˆ–å‡å®šæµ‹è¯•è¿è¡Œçš„é¡ºåºï¼Œå› ä¸º JUnit åˆ©ç”¨ Vector ä¿å­˜æµ‹è¯•æ–¹æ³•ã€‚æ‰€ä»¥ä¸åŒçš„å¹³å°ä¼šæŒ‰ä¸åŒçš„é¡ºåºä» Vector ä¸­å–å‡ºæµ‹è¯•æ–¹æ³•ã€‚
3. é¿å…ç¼–å†™æœ‰å‰¯ä½œç”¨çš„ TestCaseã€‚ä¾‹å¦‚ï¼šå¦‚æœéšåçš„æµ‹è¯•ä¾èµ–äºæŸäº›ç‰¹å®šçš„äº¤æ˜“æ•°æ®ï¼Œå°±ä¸è¦æäº¤äº¤æ˜“æ•°æ®ã€‚ç®€å•çš„å›æ»šå°±å¯ä»¥äº†ã€‚
4. å½“ç»§æ‰¿ä¸€ä¸ªæµ‹è¯•ç±»æ—¶ï¼Œè®°å¾—è°ƒç”¨çˆ¶ç±»çš„ setUp() å’Œ tearDown() æ–¹æ³•ã€‚
5. å°†æµ‹è¯•ä»£ç å’Œå·¥ä½œä»£ç æ”¾åœ¨ä¸€èµ·ï¼Œä¸€è¾¹åŒæ­¥ç¼–è¯‘å’Œæ›´æ–°ã€‚ï¼ˆä½¿ç”¨ Ant ä¸­æœ‰æ”¯æŒ junit çš„ task.ï¼‰
6. æµ‹è¯•ç±»å’Œæµ‹è¯•æ–¹æ³•åº”è¯¥æœ‰ä¸€è‡´çš„å‘½åæ–¹æ¡ˆã€‚å¦‚åœ¨å·¥ä½œç±»åå‰åŠ ä¸Š test ä»è€Œå½¢æˆæµ‹è¯•ç±»åã€‚
7. ç¡®ä¿æµ‹è¯•ä¸æ—¶é—´æ— å…³ï¼Œä¸è¦ä¾èµ–ä½¿ç”¨è¿‡æœŸçš„æ•°æ®è¿›è¡Œæµ‹è¯•ã€‚å¯¼è‡´åœ¨éšåçš„ç»´æŠ¤è¿‡ç¨‹ä¸­å¾ˆéš¾é‡ç°æµ‹è¯•ã€‚
8. å¦‚æœä½ ç¼–å†™çš„è½¯ä»¶é¢å‘å›½é™…å¸‚åœºï¼Œç¼–å†™æµ‹è¯•æ—¶è¦è€ƒè™‘å›½é™…åŒ–çš„å› ç´ ã€‚ä¸è¦ä»…ç”¨æ¯è¯­çš„ Locale è¿›è¡Œæµ‹è¯•ã€‚
9. å°½å¯èƒ½åœ°åˆ©ç”¨ JUnit æä¾›åœ° assert/fail æ–¹æ³•ä»¥åŠå¼‚å¸¸å¤„ç†çš„æ–¹æ³•ï¼Œå¯ä»¥ä½¿ä»£ç æ›´ä¸ºç®€æ´ã€‚
10. æµ‹è¯•è¦å°½å¯èƒ½åœ°å°ï¼Œæ‰§è¡Œé€Ÿåº¦å¿«ã€‚
11. ä¸è¦ç¡¬æ€§è§„å®šæ•°æ®æ–‡ä»¶çš„è·¯å¾„ã€‚
12. åˆ©ç”¨ Junit çš„è‡ªåŠ¨å¼‚å¸¸å¤„ç†ä¹¦å†™ç®€æ´çš„æµ‹è¯•ä»£ç   
    äº‹å®ä¸Šåœ¨ Junit ä¸­ä½¿ç”¨ try-catch æ¥æ•è·å¼‚å¸¸æ˜¯æ²¡æœ‰å¿…è¦çš„ï¼ŒJunit ä¼šè‡ªåŠ¨æ•è·å¼‚å¸¸ã€‚é‚£äº›æ²¡æœ‰è¢«æ•è·çš„å¼‚å¸¸å°±è¢«å½“æˆé”™è¯¯å¤„ç†ã€‚
13. å……åˆ†åˆ©ç”¨ Junit çš„ assert/fail æ–¹æ³•
    - assertSame() ç”¨æ¥æµ‹è¯•ä¸¤ä¸ªå¼•ç”¨æ˜¯å¦æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡
    - assertEquals() ç”¨æ¥æµ‹è¯•ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰
14. ç¡®ä¿æµ‹è¯•ä»£ç ä¸æ—¶é—´æ— å…³
15. ä½¿ç”¨æ–‡æ¡£ç”Ÿæˆå™¨åšæµ‹è¯•æ–‡æ¡£ã€‚

### junit3.x

1. ä½¿ç”¨ junit3.x ç‰ˆæœ¬è¿›è¡Œå•å…ƒæµ‹è¯•æ—¶ï¼Œæµ‹è¯•ç±»å¿…é¡»è¦ç»§æ‰¿äº TestCase çˆ¶ç±»ï¼›
2. æµ‹è¯•æ–¹æ³•éœ€è¦éµå¾ªçš„åŸåˆ™ï¼š
   - public çš„
   - void çš„
   - æ— æ–¹æ³•å‚æ•°
   - æ–¹æ³•åç§°å¿…é¡»ä»¥ test å¼€å¤´
3. ä¸åŒçš„ Test Case ä¹‹é—´ä¸€å®šè¦ä¿æŒå®Œå…¨çš„ç‹¬ç«‹æ€§ï¼Œä¸èƒ½æœ‰ä»»ä½•çš„å…³è”ã€‚
4. æˆ‘ä»¬è¦æŒæ¡å¥½æµ‹è¯•æ–¹æ³•çš„é¡ºåºï¼Œä¸èƒ½ä¾èµ–äºæµ‹è¯•æ–¹æ³•è‡ªå·±çš„æ‰§è¡Œé¡ºåºã€‚

demo:

```java
public class TestMyNumber extends TestCase {
	private MyNumber myNumber;
	public TestMyNumber(String name) {
		super(name);
	}
	// åœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•æ‰§è¡Œ [ä¹‹å‰] éƒ½ä¼šè¢«è°ƒç”¨
	@Override
	public void setUp() throws Exception {
		// System.out.println("æ¬¢è¿ä½¿ç”¨Junitè¿›è¡Œå•å…ƒæµ‹è¯•â€¦");
		myNumber = new MyNumber();
	}
	// åœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•æ‰§è¡Œ [ä¹‹å] éƒ½ä¼šè¢«è°ƒç”¨
	@Override
	public void tearDown() throws Exception {
		// System.out.println("Junitå•å…ƒæµ‹è¯•ç»“æŸâ€¦");
	}
	public void testDivideByZero() {
		Throwable te = null;
		try {
			myNumber.divide(6, 0);
			Assert.fail("æµ‹è¯•å¤±è´¥");
		} catch (Exception e) {
			e.printStackTrace();
			te = e;
		}
		Assert.assertEquals(Exception.class, te.getClass());
		Assert.assertEquals("é™¤æ•°ä¸èƒ½ä¸º 0 ", te.getMessage());
	}
}
```

### junit4.x

1. ä½¿ç”¨ junit4.x ç‰ˆæœ¬è¿›è¡Œå•å…ƒæµ‹è¯•æ—¶ï¼Œä¸ç”¨æµ‹è¯•ç±»ç»§æ‰¿ TestCase çˆ¶ç±»ï¼Œå› ä¸ºï¼Œjunit4.x å…¨é¢å¼•å…¥äº† Annotation æ¥æ‰§è¡Œæˆ‘ä»¬ç¼–å†™çš„æµ‹è¯•ã€‚[3]
2. junit4.x ç‰ˆæœ¬ï¼Œå¼•ç”¨äº†æ³¨è§£çš„æ–¹å¼ï¼Œè¿›è¡Œå•å…ƒæµ‹è¯•ï¼›
3. junit4.x ç‰ˆæœ¬æˆ‘ä»¬å¸¸ç”¨çš„æ³¨è§£ï¼š
   - @Before æ³¨è§£ï¼šä¸ junit3.x ä¸­çš„ setUp() æ–¹æ³•åŠŸèƒ½ä¸€æ ·ï¼Œåœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•ä¹‹å‰æ‰§è¡Œï¼›
   - @After æ³¨è§£ï¼šä¸ junit3.x ä¸­çš„ tearDown() æ–¹æ³•åŠŸèƒ½ä¸€æ ·ï¼Œåœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•ä¹‹åæ‰§è¡Œï¼›
   - @BeforeClass æ³¨è§£ï¼šåœ¨æ‰€æœ‰æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œï¼›
   - @AfterClass æ³¨è§£ï¼šåœ¨æ‰€æœ‰æ–¹æ³•æ‰§è¡Œä¹‹åæ‰§è¡Œï¼›
   - @Test(timeout = xxx) æ³¨è§£ï¼šè®¾ç½®å½“å‰æµ‹è¯•æ–¹æ³•åœ¨ä¸€å®šæ—¶é—´å†…è¿è¡Œå®Œï¼Œå¦åˆ™è¿”å›é”™è¯¯ï¼›
   - @Test(expected = Exception.class) æ³¨è§£ï¼šè®¾ç½®è¢«æµ‹è¯•çš„æ–¹æ³•æ˜¯å¦æœ‰å¼‚å¸¸æŠ›å‡ºã€‚æŠ›å‡ºå¼‚å¸¸ç±»å‹ä¸ºï¼šException.classï¼›
   - @Ignore æ³¨è§£ï¼šæ³¨é‡Šæ‰ä¸€ä¸ªæµ‹è¯•æ–¹æ³•æˆ–ä¸€ä¸ªç±»ï¼Œè¢«æ³¨é‡Šçš„æ–¹æ³•æˆ–ç±»ï¼Œä¸ä¼šè¢«æ‰§è¡Œã€‚

demo:

```java
public class TestMyNumber {
	private MyNumber myNumber;
	@BeforeClass
	// åœ¨æ‰€æœ‰æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œ
	public static void globalInit() {
		System.out.println("init all method...");
	}
	@AfterClass
	// åœ¨æ‰€æœ‰æ–¹æ³•æ‰§è¡Œä¹‹åæ‰§è¡Œ
	public static void globalDestory() {
		System.out.println("destory all method...");
	}
	@Before
	// åœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•ä¹‹å‰æ‰§è¡Œ
	public void setUp() {
		System.out.println("start setUp method");
		myNumber = new MyNumber();
	}
	@After
	// åœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•ä¹‹åæ‰§è¡Œ
	public void tearDown() {
		System.out.println("end tearDown method");
	}
	@Test(timeout=600)// è®¾ç½®é™å®šæµ‹è¯•æ–¹æ³•çš„è¿è¡Œæ—¶é—´ å¦‚æœè¶…å‡ºåˆ™è¿”å›é”™è¯¯
	public void testAdd() {
		System.out.println("testAdd method");
		int result = myNumber.add(2, 3);
		assertEquals(5, result);
	}
	@Test
	public void testSubtract() {
		System.out.println("testSubtract method");
		int result = myNumber.subtract(1, 2);
		assertEquals(-1, result);
	}
	@Test
	public void testMultiply() {
		System.out.println("testMultiply method");
		int result = myNumber.multiply(2, 3);
		assertEquals(6, result);
	}
	@Test
	public void testDivide() {
		System.out.println("testDivide method");
		int result = 0;
		try {
			result = myNumber.divide(6, 2);
		} catch (Exception e) {
			fail();
		}
			assertEquals(3, result);
	}
	@Test(expected = Exception.class)
	public void testDivide2() throws Exception {
		System.out.println("testDivide2 method");
		myNumber.divide(6, 0);
		fail("test Error");
	}
	public static void main(String[] args) {
	}
}
```

## [Maven å‘½ä»¤ç²¾è®²ï¼šä»å…¥é—¨åˆ°ç²¾é€š](https://blog.dong4j.site/posts/4f5fa1df.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## Maven æ·»åŠ  IntelliJ IDEA é¡¹ç›®æ–‡ä»¶

åœ¨ä½¿ç”¨ Maven æ„å»º Java é¡¹ç›®æ—¶ï¼Œè‹¥éœ€ç”Ÿæˆä¸ IntelliJ IDEA å…¼å®¹çš„é¡¹ç›®æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿›è¡Œï¼š

```bash
mvn idea:idea
```

**`idea:idea`** æ’ä»¶çš„ç›®æ ‡æ‰§è¡Œäº†å¦å¤–ä¸‰ä¸ªç›®æ ‡ï¼šprojectã€module å’Œ workspaceã€‚

- **`idea:project`**: ç”¨äºç”Ÿæˆ IntelliJ IDEA é¡¹ç›®çš„é…ç½®æ–‡ä»¶ï¼ˆ`*.ipr`ï¼‰ã€‚
- **`idea:module`**: ç”¨äºç”Ÿæˆ IntelliJ IDEA æ¨¡å—çš„é…ç½®æ–‡ä»¶ï¼ˆ`*.iml`ï¼‰ã€‚
- **`idea:workspace`**: ç”¨äºç”Ÿæˆå·¥ä½œåŒºæ–‡ä»¶ï¼ˆ`*.iws`ï¼‰ï¼Œæ­¤ç›®æ ‡åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ä¸ä¼šç›´æ¥ä½¿ç”¨ï¼Œå› ä¸ºé»˜è®¤ä¼šåŒ…å«åœ¨ `idea:idea` ä¸­ã€‚

## åˆ é™¤æŒ‡å®šä¾èµ–

å¦‚æœä½ æƒ³ä»æœ¬åœ°ä»“åº“ä¸­åˆ é™¤ç‰¹å®šç‰ˆæœ¬çš„ä¾èµ–ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
mvn com.xxx:xxx-assist-maven-plugin:2.0.0-SNAPSHOT:delete-v5-dependence -Dversion=1.7.1
```

æˆ–è€…é¦–å…ˆä¸‹è½½æŒ‡å®šçš„ä¾èµ–é¡¹ï¼Œç„¶ååˆ é™¤å®ƒï¼š

```bash
mvn dependency:get -Dartifact=com.xxx:xxx-assist-maven-plugin:2.0.0-SNAPSHOT
mvn com.xxx:xxx-assist-maven-plugin:2.0.0-SNAPSHOT:delete-v5-dependence -Dversion=1.7.1

# å¯¹äºå¦ä¸€ä¸ªç‰ˆæœ¬çš„ä¾èµ–é¡¹ä¹Ÿé€‚ç”¨ï¼š
mvn dependency:get -Dartifact=com.xxx:xxx-assist-maven-plugin:1.8.0-SNAPSHOT
mvn com.xxx:xxx-assist-maven-plugin:1.8.0-SNAPSHOT:delete-v5-dependence -Dversion=1.7.1
```

## è®¾ç½®æ—¥å¿—çº§åˆ«

å¦‚æœä½ æƒ³è°ƒæ•´ Maven çš„æ—¥å¿—è¾“å‡ºçº§åˆ«ï¼Œå¯ä»¥åœ¨æ‰§è¡Œ Maven å‘½ä»¤æ—¶æ·»åŠ  `-Dorg.slf4j.simpleLogger.defaultLogLevel` å‚æ•°ã€‚ä¾‹å¦‚ï¼š

```bash
mvn clean install -Dorg.slf4j.simpleLogger.defaultLogLevel=warn
```

è‹¥è¦æ°¸ä¹…è®¾ç½®æ—¥å¿—çº§åˆ«ï¼Œç¼–è¾‘ Maven æ‰§è¡Œè„šæœ¬ï¼ˆé€šå¸¸æ˜¯ `${MAVEN_HOME}/bin/mvn`ï¼‰ï¼Œå¹¶æ–°å¢ä»¥ä¸‹é…ç½®è¡Œï¼š

```shell
MAVEN_OPTS="-Dorg.slf4j.simpleLogger.defaultLogLevel=info"
```

æˆ–è€…åœ¨æ‰§è¡Œ `mvn` å‘½ä»¤æ—¶ä½¿ç”¨å‚æ•° `-q`, ä½†è¿™æ ·åªä¼šè¾“å‡ºé”™è¯¯ä¿¡æ¯ã€‚

## Maven å‚æ•°è¯´æ˜

Maven æä¾›äº†ä¸°å¯Œçš„å‘½ä»¤è¡Œå‚æ•°ï¼Œä»¥æ”¯æŒä¸åŒçš„æ„å»ºéœ€æ±‚ï¼š

- **æŒ‡å®š settings æ–‡ä»¶**:

```bash
mvn install --settings xxx.xml
```

ä¸Šè¿°å‘½ä»¤ä¸­ `xxx.xml` æ˜¯è‡ªå®šä¹‰çš„ settings é…ç½®æ–‡ä»¶è·¯å¾„ã€‚

- **æŒ‡å®š pom.xml æ–‡ä»¶**ï¼š

```bash
mvn install --file pom.xml
```

## ä¸æ”¹å˜åŸæœ‰ä¾èµ–ï¼Œå¼•å…¥æ–°ä¾èµ–

æœ‰æ—¶éœ€è¦åœ¨ä¸ä¿®æ”¹ç°æœ‰é¡¹ç›®é…ç½®çš„åŸºç¡€ä¸Šæ–°å¢ä¸€ä¸ªä¾èµ–ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ç¤ºä¾‹ XML ç»“æ„æ¥å®ç°ï¼š

```xml
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <!-- çˆ¶é¡¹ç›®çš„å®šä¹‰ -->
    <parent>
        <groupId>org.mapstruct</groupId>
        <artifactId>mapstruct-parent</artifactId>
        <version>1.1.0.RC1</version>
        <relativePath>../parent/pom.xml</relativePath>
    </parent>

    <!-- å½“å‰é¡¹ç›®çš„å®šä¹‰ -->
    <artifactId>mapstruct-jdk7</artifactId>
    <name>MapStruct Core JDK 7</name>
    <description>å·²å¼ƒç”¨çš„ MapStruct è‰ºæœ¯å“ï¼ŒåŒ…å«ç”¨äº JDK 8 åŠæ›´é«˜ç‰ˆæœ¬çš„æ³¨é‡Š - ç§»è‡³ mapstruct ä¸­ã€‚</description>

    <!-- åˆ†å‘ç®¡ç† -->
    <distributionManagement>
        <relocation>
            <artifactId>mapstruct</artifactId>
        </relocation>
    </distributionManagement>

</project>
```

## ä¾èµ–çš„ç‰ˆæœ¬èŒƒå›´è¯´æ˜

åœ¨ Maven ä¸­ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ç‰¹å®šçš„ç¬¦å·æ¥æŒ‡å®šä¾èµ–é¡¹çš„ç‰ˆæœ¬èŒƒå›´ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ç‰ˆæœ¬èŒƒå›´åŠå…¶å«ä¹‰ï¼š

- `[1.0]`ï¼šè¡¨ç¤ºç²¾ç¡®åŒ¹é… `1.0` ç‰ˆæœ¬ã€‚
- `[1.0,)` æˆ–è€… `[1.0,`ï¼šè¡¨ç¤ºä» 1.0 åŠå…¶ä¹‹åçš„æ‰€æœ‰ç‰ˆæœ¬ï¼Œå³ >= 1.0ã€‚
- `(1.0,)` æˆ–è€… `(1.0,` ï¼š è¡¨ç¤ºä»å¤§äº 1.0 çš„æ‰€æœ‰ç‰ˆæœ¬ã€‚

ä¾‹å¦‚ï¼š

```xml
<dependency>
    <groupId>org.twitter4j</groupId>
    <artifactId>twitter4j-core</artifactId>
    <version>[2.2,)</version>
</dependency>

<dependency>
    <groupId>org.twitter4j</groupId>
    <artifactId>twitter4j-stream</artifactId>
    <version>[2.2,)</version>
</dependency>
```

ä¸Šè¿°ä¾èµ–é¡¹è¡¨ç¤ºæˆ‘ä»¬ä½¿ç”¨ `twitter4j` çš„æ ¸å¿ƒåº“å’Œæµåª’ä½“åº“çš„ç‰ˆæœ¬å‡å¿…é¡»å¤§äºç­‰äº 2.2ã€‚

## Maven å¸®åŠ©å‘½ä»¤

### æ£€æŸ¥ Maven é…ç½®

- **æŸ¥çœ‹å½“å‰ Maven ç¯å¢ƒå¯ç”¨çš„æ–‡ä»¶**:
  ```bash
  mvn help:effective-settings
  ```
- **æŸ¥çœ‹å½“å‰é¡¹ç›®çš„ pom.xml é…ç½®ï¼ŒåŒ…æ‹¬æ‰€æœ‰ä¾èµ–é¡¹**ï¼š

  ```bash
  mvn help:effective-pom
  ```

- **æŸ¥çœ‹å½“å‰å¤„äºæ¿€æ´»çŠ¶æ€çš„ profile**:
  ```bash
  mvn help:active-profiles
  ```

### æ‰§è¡Œ Maven å‘½ä»¤æ—¶æŒ‡å®šé…ç½®æ–‡ä»¶

è‹¥ä½ æœ‰ä¸€ä¸ªè‡ªå®šä¹‰çš„ `settings.xml` æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æ‰§è¡Œå¸¦æœ‰ç‰¹å®šè®¾ç½®çš„ Maven ç›®æ ‡ï¼š

```bash
mvn -s <filepath> <goal>
```

ä¾‹å¦‚ï¼š

```bash
mvn -s ~/.m2/settings_local.xml clean deploy
```

### æŸ¥çœ‹ç¯å¢ƒè¯¦ç»†ä¿¡æ¯

- **æŸ¥çœ‹å½“å‰é¡¹ç›®çš„æ‰€æœ‰ mvn é…ç½®**:
  ```bash
  mvn -X
  ```
- **æ‰“å°æ‰€æœ‰å¯ç”¨çš„ç¯å¢ƒå˜é‡å’Œ Java ç³»ç»Ÿå±æ€§**ï¼š
  ```bash
  mvn help:system
  ```

## ä¾èµ–åˆ†æä¸æ ‘çŠ¶å±•ç¤º

ä¸ºäº†æ›´å¥½åœ°ç†è§£é¡¹ç›®çš„ä¾èµ–å…³ç³»ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥ç”Ÿæˆä¾èµ–é¡¹æ ‘ï¼š

```bash
mvn -X dependency:tree>tree.txt
```

è¿™å°†è¾“å‡ºé¡¹ç›®çš„æ‰€æœ‰ä¾èµ–é¡¹å¹¶å°†å…¶ä¿å­˜åˆ° `tree.txt` æ–‡ä»¶ä¸­ã€‚

## Maven ç¯å¢ƒå˜é‡å¼•ç”¨

### settings.xml å±æ€§

Maven æ”¯æŒé€šè¿‡ `settings.xml` æ–‡ä»¶ä¸­çš„å±æ€§æ¥å¼•ç”¨è®¾ç½®å€¼ï¼Œä¾‹å¦‚ï¼š

```xml
${settings.localRepository}
```

è¡¨ç¤ºæœ¬åœ°ä»“åº“çš„åœ°å€ã€‚

### Java ç³»ç»Ÿå±æ€§

æ‰€æœ‰ Java ç³»ç»Ÿå±æ€§éƒ½å¯ä»¥åœ¨ Maven ä¸­ä½¿ç”¨å¦‚ä¸‹è¯­æ³•å¼•ç”¨ï¼š

- ä½¿ç”¨ `mvn help:system` å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰çš„ Java ç³»ç»Ÿå±æ€§ã€‚
- é€šè¿‡ `System.getProperties()` æ–¹æ³•è·å–æ‰€æœ‰ Java å±æ€§ã€‚

ä¾‹å¦‚ï¼š

```xml
${user.home}
```

è¡¨ç¤ºç”¨æˆ·ç›®å½•ã€‚

### ç¯å¢ƒå˜é‡

å¯ä»¥é€šè¿‡ä»¥ `env.` å¼€å¤´çš„å±æ€§å¼•ç”¨ç¯å¢ƒå˜é‡ã€‚åŒæ ·åœ°ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„ç¯å¢ƒå˜é‡ï¼š

```bash
mvn help:system
```

å¦‚:

```xml
${env.JAVA_HOME}
```

ä»£è¡¨ JAVA_HOME ç¯å¢ƒå˜é‡å€¼ã€‚

## è§£å†³ç¼“å­˜ä¾èµ–é—®é¢˜

Maven æœ‰æ—¶ä¼šå°†è¿œç¨‹ä¾èµ–é¡¹ç¼“å­˜åœ¨æœ¬åœ°ä»“åº“ä¸­ï¼Œè¿™å¯èƒ½å¯¼è‡´æ— æ³•æ­£ç¡®æ›´æ–°ä¾èµ–ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥é‡‡å–ä»¥ä¸‹æªæ–½ï¼š

- **åˆ é™¤ç¼“å­˜ç›®å½•**ï¼š
  åˆ é™¤ `~/.m2/repository/` ç›®å½•æˆ–å…¶å­ç›®å½•ä¸‹çš„æ‰€æœ‰ `.lastUpdated` æ–‡ä»¶ã€‚
- **å¼ºåˆ¶æ›´æ–°å¿«ç…§ç‰ˆæœ¬æ’ä»¶æˆ–ä¾èµ–é¡¹**:
  åœ¨æ‰§è¡Œ Maven å‘½ä»¤æ—¶åŠ ä¸Š `-U` å‚æ•°ï¼Œå¦‚ï¼š

  ```bash
  mvn package -U
  ```

  æ­¤å‚æ•°ä¼šå¼ºåˆ¶ä»è¿œç¨‹ä»“åº“ä¸­è·å–æœ€æ–°ç‰ˆæœ¬ã€‚

- **è°ƒæ•´ updatePolicy å±æ€§**:
  å¯ä»¥åœ¨ `repository` çš„é…ç½®ä¸­æ–°å¢æˆ–ä¿®æ”¹ `updatePolicy` å±æ€§å€¼æ¥æ”¹å˜æ›´æ–°ç­–ç•¥ã€‚ä¾‹å¦‚ï¼Œè®¾ç½®ä¸º `always`ã€`daily`ï¼ˆé»˜è®¤ï¼‰ã€`interval:XXX` æˆ– `never`ã€‚

## Maven å‘½ä»¤ä¸‹è½½ jar

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ä»¥ä»è¿œç¨‹ä»“åº“ä¸‹è½½ç‰¹å®šçš„ Jar æ–‡ä»¶ï¼š

```bash
mvn dependency:get -DremoteRepositories=http://repo1.maven.org/maven2/ -DgroupId=org.benf -DartifactId=cfr -Dversion=0.139
```

### Maven ä¾èµ–é…ç½®ç¤ºä¾‹

```xml
<!-- https://mvnrepository.com/artifact/org.benf/cfr -->
<dependency>
    <groupId>org.benf</groupId>
    <artifactId>cfr</artifactId>
    <version>0.139</version>
</dependency>
```

## å®‰è£…ç¬¬ä¸‰æ–¹ jar åŒ…åˆ°æœ¬åœ°ä»“åº“

### å‘½ä»¤å®‰è£…

å°†ç¬¬ä¸‰æ–¹ Jar åŒ…æ·»åŠ è‡³æœ¬åœ° Maven ä»“åº“ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
mvn install:install-file -Dfile=jaråŒ…çš„ä½ç½® -DgroupId=ä¸Šé¢çš„groupId -DartifactId=ä¸Šé¢çš„artifactId -Dversion=ä¸Šé¢çš„version -Dpackaging=jar

# ç¤ºä¾‹å®‰è£… Java Memcached Jar åŒ…:
mvn install:install-file -Dfile=F:\comm\youboy\java_memcached-release_2.6.6\java_memcached-release_2.6.6.jar -DpomFile=F:\comm\youboy\java_memcached-release_2.6.6\pom.xml
```

### å®‰è£…åˆ°ç§æœ‰æœåŠ¡å™¨ï¼ˆç§æœï¼‰

è‹¥éœ€å°† Jar åŒ…éƒ¨ç½²è‡³å†…éƒ¨çš„ Maven ä»“åº“ï¼Œå¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
mvn deploy:deploy-file -DgroupId=com.xy.oracle -DartifactId=ojdbc14 -Dversion=10.2.0.4.0 -Dpackaging=jar -Dfile=E:\ojdbc14.jar -Durl=http://localhost:9090/nexus-2.2-01/content/repositories/thirdparty/ -DrepositoryId=thirdparty
```

å…¶ä¸­ï¼š

- `groupId` å’Œ `artifactId` æ„æˆè¯¥ Jar åŒ…åœ¨ pom.xml æ–‡ä»¶ä¸­çš„å”¯ä¸€æ ‡è¯†ã€‚
- `file` å‚æ•°è¡¨ç¤ºéœ€è¦ä¸Šä¼ çš„ Jar åŒ…çš„ç»å¯¹è·¯å¾„ã€‚
- `url` ä¸ºç§æœ‰ä»“åº“çš„ä½ç½®ï¼Œå¯åœ¨ Nexus ç•Œé¢ä¸­æ‰¾åˆ°ç›¸å…³è·¯å¾„é…ç½®ã€‚
- `repositoryId` æ˜¯æœåŠ¡å™¨ IDï¼Œåœ¨ Nexus é…ç½®ä¸­å¯ä»¥çœ‹åˆ°ã€‚

### å¿«é€Ÿå®‰è£…æˆ–ç•¥è¿‡æµ‹è¯•

1. ä½¿ç”¨å‘½ä»¤è·³è¿‡æµ‹è¯•ï¼š

   ```bash
   mvn install -Dmaven.test.skip=true
   ```

2. åœ¨ pom.xml æ–‡ä»¶ä¸­é€šè¿‡ `<properties>` æ ‡ç­¾æŒ‡å®šæ˜¯å¦è¿›è¡Œæµ‹è¯•ç¼–è¯‘ï¼Œå¦‚ï¼š

```xml
<properties>
    <skipTests>true</skipTests>
</properties>
```

æˆ–

```xml
<properties>
    <maven.test.skip>true</maven.test.skip>
</properties>
```

3. ä½¿ç”¨æ’ä»¶é…ç½®è·³è¿‡æµ‹è¯•ï¼š

```xml
<plugin>
  <groupId>org.apache.maven.plugins</groupId>
  <artifactId>maven-surefire-plugin</artifactId>
  <version>2.18.1</version>
  <configuration>
    <skipTests>true</skipTests>
  </configuration>
</plugin>
```

## Maven ä¾èµ–åˆ†æ

- æŸ¥çœ‹é¡¹ç›®å·²è§£æçš„ä¾èµ–ï¼š

```bash
mvn dependency:list
```

è¿™ä¼šè¾“å‡ºæ‰€æœ‰ç»è¿‡ Maven è§£æåçš„ä¾èµ–åˆ—è¡¨ã€‚

- è¾“å‡ºé¡¹ç›®çš„å®Œæ•´ä¾èµ–æ ‘è‡³æ–‡ä»¶ `tree.txt` ä¸­:

```bash
mvn dependency:tree > tree.txt
```

- åˆ†æä¾èµ–é¡¹å¹¶æ˜¾ç¤ºæœªå£°æ˜ä½†å·²ä½¿ç”¨çš„ä¾èµ–æˆ–å·²å£°æ˜ä½†æœªä½¿ç”¨çš„ä¾èµ–ï¼š

```bash
mvn dependency:analyze
```

è¯¥å‘½ä»¤çš„è¾“å‡ºé€šå¸¸ä¼šåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š

1. **Used undeclared dependencies**: è¡¨ç¤ºé¡¹ç›®ä¸­ä½¿ç”¨åˆ°å´æœªåœ¨ pom.xml ä¸­å£°æ˜çš„ä¾èµ–ã€‚
2. **Unused declared dependencies**: è¡¨ç¤ºé¡¹ç›®ä¸­è™½å£°æ˜ä½†å¹¶æœªä½¿ç”¨çš„ä¾èµ–ã€‚

- åˆ†æå†²çªçš„ jar åŒ…è·¯å¾„ï¼š

```bash
mvn dependency:tree -Dverbose -Dincludes=commons-logging:commons-loggging
```

æ­¤å‘½ä»¤å°†è¾“å‡ºæ‰€æœ‰æ¶‰åŠç‰¹å®šä¾èµ–åŒ…ï¼ˆå¦‚ `commons-logging`ï¼‰çš„å®Œæ•´ä¾èµ–è·¯å¾„ï¼Œè¿™å¯¹äºè§£å†³ç‰ˆæœ¬å†²çªç‰¹åˆ«æœ‰ç”¨ã€‚

### Maven ä½¿ç”¨ systemPath è­¦å‘Š

å½“ä½¿ç”¨ `<systemPath>` æ—¶ä¼šæ”¶åˆ°è­¦å‘Šï¼šâ€œjar should not point at files within the project directoryâ€ã€‚ä¸ºé¿å…è¿™ç§è­¦å‘ŠåŠæ½œåœ¨é—®é¢˜ï¼Œåº”è€ƒè™‘å°†ç¬¬ä¸‰æ–¹ jar åŒ…éƒ¨ç½²åˆ°å…¬å¸ä»“åº“æˆ–å®‰è£…åˆ°æœ¬åœ°ä»“åº“ã€‚

## dependencies å’Œ dependencyManagement çš„åŒºåˆ«

åœ¨é¡¶å±‚ pom ä¸­å®šä¹‰çš„ `<dependencies>` å’Œ `<dependencyManagement>` æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µï¼š

- **`<dependencies>`**ï¼šç›´æ¥ç®¡ç†é¡¹ç›®çš„ä¾èµ–é¡¹ã€‚
- **`<dependencyManagement>`**ï¼šä¸»è¦ç”¨æ¥ç»Ÿä¸€ç®¡ç†å­æ¨¡å—ä¸­ä¸åŒç‰ˆæœ¬çš„é—®é¢˜ï¼ŒæŒ‡å®šå­æ¨¡å—æ‰€ä½¿ç”¨çš„ä¾èµ–é¡¹çš„å…·ä½“ç‰ˆæœ¬å·ã€‚

### Maven Scope è§£é‡Š

åœ¨ Maven ä¸­ï¼Œé€šè¿‡ `scope` å±æ€§æ¥æ§åˆ¶ä¾èµ–çš„èŒƒå›´ã€‚ä»¥ä¸‹æ˜¯å¸¸ç”¨çš„å‡ ç§ç±»å‹åŠå…¶ä½¿ç”¨åœºæ™¯ï¼š

1. **compile**: é»˜è®¤æƒ…å†µä¸‹ç¼–è¯‘ã€æµ‹è¯•å’Œè¿è¡Œæ—¶éƒ½å¯è§ã€‚
2. **provided**: å®¹å™¨å·²æä¾›ï¼Œé€‚ç”¨äºå¦‚ servlet-api ç­‰å®¹å™¨å†…å»ºç»„ä»¶ï¼Œåœ¨æ‰“åŒ…æ—¶ä¸ä¼šåŒ…å«è¿™äº› jar åŒ…ã€‚
3. **runtime**: è¿è¡Œæ—¶éœ€è¦çš„ä¾èµ–é¡¹åœ¨ç¼–è¯‘é˜¶æ®µä¸éœ€è¦ï¼Œä½†æ‰“åŒ…æ—¶è¦åŒ…æ‹¬è¿›å»ï¼ˆä¾‹å¦‚ JDBC é©±åŠ¨ï¼‰ã€‚
4. **test**: æµ‹è¯•åœºæ™¯ä½¿ç”¨ï¼Œåªç”¨äºæµ‹è¯•ä»£ç ï¼Œå¹¶ä¸åœ¨æœ€ç»ˆçš„æ„å»ºè¾“å‡ºä¸­ã€‚
5. **system**: ç±»ä¼¼äº providedï¼Œä½†ç³»ç»ŸèŒƒå›´çš„ä¾èµ–å¿…é¡»é€šè¿‡ `<systemPath>` æ˜ç¡®æŒ‡å®šæœ¬åœ°è·¯å¾„ã€‚ç”±äºè¿™ç§æœºåˆ¶ä¸æ¨èä½¿ç”¨ï¼Œå› æ­¤é€šå¸¸å»ºè®®å°†åº“æ·»åŠ åˆ°æœ¬åœ°æˆ–ç»„ç»‡çº§çš„ Maven ä»“åº“ã€‚

### å®è·µå¿ƒå¾—

- `provided` çš„ä¾èµ–æ²¡æœ‰ä¼ é€’æ€§ã€‚
- `provided` å…·æœ‰ç»§æ‰¿æ€§ï¼Œåœ¨å¤šæ¨¡å—é¡¹ç›®ä¸­å¯ä»¥ç»Ÿä¸€é…ç½®é€šç”¨çš„ provided ä¾èµ–æ¥ç®€åŒ–å­é¡¹ç›®çš„ pom.xml æ–‡ä»¶å†…å®¹ã€‚

## ç»§æ‰¿ jar åŒ…ç¤ºä¾‹

åœ¨çˆ¶ pom ä¸­å®šä¹‰ä¾èµ–ç®¡ç†ï¼š

```xml
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>3.9</version>
            <scope>test</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

åœ¨å­æ¨¡å— pom.xml æ–‡ä»¶ä¸­ï¼Œåªéœ€å¼•ç”¨ï¼š

```xml
<dependencies>
  <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
  </dependency>
</dependencies>
```

### æ·»åŠ å¤–éƒ¨ä¾èµ–åŒ…

```xml
<dependency>
    <groupId>ldapjdk</groupId>
    <artifactId>ldapjdk</artifactId>
    <scope>system</scope>
    <version>1.0</version>
    <systemPath>${basedir}\src\lib\ldapjdk.jar</systemPath>
</dependency>
```

### åˆ›å»º Maven Web é¡¹ç›®

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„ web é¡¹ç›®çš„éª¨æ¶ï¼š

```bash
mvn archetype:generate -DgroupId=com.code -DartifactId=spring-web-project -DarchetypeArtifactId=maven-archetype-webapp

# æˆ–è€…ï¼Œåˆ›å»ºä¸€ä¸ªç®€å•çš„ Java åº”ç”¨ç¨‹åºæ¨¡æ¿:
mvn archetype:generate -DgroupId=com.code -DartifactId=redis-java -DarchetypeArtifactId=maven-archetype-helloworld
```

## [ä»é›¶å¼€å§‹æ„å»ºSpring Boot Starter](https://blog.dong4j.site/posts/6961d5da.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

spring boot ä¹‹æ‰€ä»¥èƒ½å¤Ÿè‡ªåŠ¨é…ç½® beanï¼Œæ˜¯é€šè¿‡åŸºäºæ¡ä»¶æ¥é…ç½® Bean çš„èƒ½åŠ›å®ç°çš„ã€‚

å¸¸ç”¨çš„æ¡ä»¶æ³¨è§£å¦‚ä¸‹

```
1. @ConditionalOnBeanï¼šå½“å®¹å™¨é‡Œå­˜åœ¨æŒ‡å®šçš„Beançš„æ¡ä»¶ä¸‹
2. @ConditionalOnClassï¼šå½“å‰ç±»è·¯å¾„ä¸‹å­˜åœ¨æŒ‡å®šçš„ç±»çš„æ¡ä»¶ä¸‹
3. @ConditionalOnExpressionï¼šåŸºäºSpELè¡¨è¾¾å¼ä½œä¸ºåˆ¤æ–­æ¡ä»¶
4. @ConditionalOnJavaï¼šåŸºäºJVMç‰ˆæœ¬ä½œä¸ºåˆ¤æ–­æ¡ä»¶
5. @ConditionalOnJndiï¼šåœ¨JNDIå­˜åœ¨çš„æ¡ä»¶ä¸‹æŸ¥æ‰¾æŒ‡å®šçš„ä½ç½®
6. @ConditionalOnMissingBeanï¼šå½“å®¹å™¨é‡Œæ²¡æœ‰æŒ‡å®šçš„Beançš„æ¡ä»¶ä¸‹
7. @ConditionalOnMissingClassï¼šå½“å‰ç±»è·¯å¾„ä¸‹æ²¡æœ‰æŒ‡å®šçš„ç±»çš„æ¡ä»¶ä¸‹
8. @ConditionalOnNotWebApplicationï¼šå½“å‰é¡¹ç›®ä¸æ˜¯webé¡¹ç›®çš„æ¡ä»¶ä¸‹
9. @ConditionalOnPropertyï¼šæŒ‡å®šçš„å±æ€§æ˜¯å¦æœ‰æŒ‡å®šçš„å€¼çš„æ¡ä»¶ä¸‹
10. @ConditionalOnResourceï¼šç±»è·¯å¾„ä¸‹æ˜¯å¦æœ‰æŒ‡å®šçš„å€¼
11. @ConditionalOnSingleCandidateï¼šæŒ‡å®šBeanåœ¨å®¹å™¨ä¸­åªæœ‰ä¸€ä¸ªï¼Œæˆ–è€…è™½ç„¶æœ‰å¤šä¸ªä½†æ˜¯æŒ‡å®šé¦–é€‰çš„Bean
12. @ConditionalOnWebApplicationï¼šå½“å‰é¡¹ç›®æ˜¯Webé¡¹ç›®çš„æ¡ä»¶ä¸‹
```

è¿™äº›æ³¨è§£éƒ½ç»„åˆäº†@Conditional æ³¨è§£ï¼Œåªæ˜¯ä½¿ç”¨äº†ä¸åŒçš„æ¡ä»¶ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ªè‡ªåŠ¨é…ç½®ï¼Œå¹¶ä¸”å°è£…æˆ starter pomã€‚

é¦–å…ˆåˆ›å»º maven å·¥ç¨‹ï¼Œå¯¼å…¥ä»¥ä¸‹ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-autoconfigure</artifactId>
    <version>1.3.8.RELEASE</version>
</dependency>
```

åˆ›å»º AuthorProperties ç±»ï¼Œä½œä¸ºé…ç½®ä¿¡æ¯çš„è½½ä½“

```java
import org.springframework.boot.context.properties.ConfigurationProperties;
@ConfigurationProperties(prefix="author")//æŒ‡å®šé…ç½®å†…å®¹çš„å‰ç¼€
public class AuthorProperties {
    private static final String NAME = "å¾®å„¿åšå®¢";
    private static final int AGE = 18;
    private String name = NAME;//é»˜è®¤ä¸ºå¾®å„¿åšå®¢
    private int age = AGE;//é»˜è®¤ä¸º18
}
```

åˆ›å»º AuthorService ç±»ï¼Œä½œä¸º Bean

```java
public class AuthorService {
    private String name;
    private int age;
}
```

åˆ›å»ºé…ç½®ç±» AuthorServiceAutoConfigurationï¼Œè´Ÿè´£é…ç½® Bean

```java
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;
import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration//å£°æ˜é…ç½®ç±»
@EnableConfigurationProperties(AuthorProperties.class)
@ConditionalOnClass(AuthorService.class)//ç±»è·¯å¾„ä¸‹å­˜åœ¨AuthorServiceç±»çš„æ¡ä»¶ä¸‹
@ConditionalOnProperty(prefix="author",value="enabled",matchIfMissing=true)//åœ¨å‰ç¼€ä¸ºauthorçš„é…ç½®ä¸ºenabledçš„æƒ…å†µä¸‹ï¼Œå³author=enabled,æ²¡æœ‰é…ç½®é»˜è®¤ä¸ºenabled
public class AuthorServiceAutoConfiguration {

    @Autowired
    private AuthorProperties authorProperties;

    @Bean
    @ConditionalOnMissingBean(AuthorService.class)//å®¹å™¨ä¸­æ²¡æœ‰AuthorServiceçš„Beançš„æ¡ä»¶ä¸‹é…ç½®è¯¥Bean
    public AuthorService authorService(){
        AuthorService authorService = new AuthorService();
        authorService.setName(authorProperties.getName());
        authorService.setAge(authorProperties.getAge());
        return authorService;
    }
}
```

è‹¥æƒ³è‡ªåŠ¨é…ç½®ç”Ÿæ•ˆï¼Œéœ€è¦æ³¨å†Œè‡ªåŠ¨é…ç½®ç±»ã€‚åœ¨ src/main/resources ä¸‹åˆ›å»º META-INF/spring.factories æ–‡ä»¶ï¼Œå¹¶å†™å…¥ä»¥ä¸‹å†…å®¹ï¼š

```lua
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
com.springboot.springboot_starter_hello.AuthorServiceAutoConfiguration
```

è‹¥æœ‰å¤šä¸ªè‡ªåŠ¨é…ç½®ç±»ï¼Œåˆ™ç”¨ "," éš”å¼€ï¼Œæ­¤å¤„`\` æ˜¯ä¸ºäº†æ¢è¡Œåä»èƒ½è¯»åˆ°å±æ€§ã€‚

ä»¥ä¸Šæ“ä½œå®Œæˆåæ‰§è¡Œ maven installã€‚

ç„¶ååœ¨ Spring Boot é¡¹ç›®ä¸­å¼•å…¥è¯¥ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>com.springboot</groupId>
    <artifactId>springboot-starter-hello</artifactId>
    <version>0.0.1-SNAPSHOT</version>
</dependency>
```

æ–°å»º AutoConfig ç±»ï¼š

```java
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.springboot.springboot_starter_hello.AuthorService;

@SpringBootApplication
@RestController
public class AutoConfig {

    @Autowired
    private AuthorService authorService;

    @RequestMapping("/")
    public String who(){
        return authorService.who();
    }

    public static void main(String[] args) {
        SpringApplication.run(AutoConfig.class, args);
    }
}
```

è¿è¡Œè¯¥ç±»ï¼Œè®¿é—® localhost:8080,å‡ºç°å¦‚ä¸‹ç»“æœï¼šname: å¾®å„¿åšå®¢,age:18

æ¥ä¸‹æ¥åœ¨ src/main/resources ä¸‹æ–°å»º application.properties æ–‡ä»¶ï¼Œå†™å…¥ä»¥ä¸‹å†…å®¹ï¼š

```
author.name=weare
author.age=19
```

é‡æ–°è¿è¡Œ AutoConfig ç±»ï¼šname:weare,age:19

## [æ•°æ®åº“ç›¸å…³çš„é›¶ç¢è®°å½•](https://blog.dong4j.site/posts/166cf996.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ä¸€ã€SQL Mode è®¾ç½®

### æŸ¥çœ‹å½“å‰ SQL æ¨¡å¼

ä¸ºäº†æŸ¥çœ‹ MySQL å½“å‰ä½¿ç”¨çš„ SQL æ¨¡å¼ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢ï¼š

```sql
SELECT @@sql_mode;
```

### ä¿®æ”¹ SQL æ¨¡å¼

- **ä¼šè¯çº§åˆ«è®¾ç½®**
  è‹¥è¦åœ¨å½“å‰ä¼šè¯ä¸­ä¸´æ—¶ä¿®æ”¹ SQL æ¨¡å¼ï¼Œå¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š
  ```sql
  SET sql_mode = 'STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
  ```
- **å…¨å±€è®¾ç½®**
  è‹¥è¦æ°¸ä¹…æ›´æ”¹ SQL æ¨¡å¼ï¼Œéœ€è¦åœ¨ MySQL çš„é…ç½®æ–‡ä»¶ï¼ˆå¦‚ `my.cnf` æˆ– `my.ini`ï¼‰ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š
  ```ini
  sql-mode = "STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION"
  ```

## äºŒã€ä¿®æ”¹æ•°æ®åº“å’Œè¡¨çš„å­—ç¬¦ç¼–ç 

### ä¿®æ”¹æ•´ä¸ªæ•°æ®åº“çš„ç¼–ç 

```sql
ALTER DATABASE nacos_config CHARACTER SET utf8mb4 COLLATE `utf8mb4_general_ci`;
```

### æ›´æ–°æŒ‡å®šè¡¨çš„å­—ç¬¦é›†

å¦‚æœéœ€è¦æ›´æ”¹ç‰¹å®šè¡¨çš„å­—ç¬¦è®¾ç½®ï¼Œå¯ä½¿ç”¨å¦‚ä¸‹ SQL è¯­å¥ï¼š

```sql
ALTER TABLE config_info CONVERT TO CHARACTER SET utf8mb4 COLLATE `utf8mb4_general_ci`;
-- å…¶ä»–è¡¨ç±»ä¼¼ä¿®æ”¹
```

è¯·æ ¹æ®å®é™…éœ€æ±‚å¯¹æ¯å¼ è¡¨æ‰§è¡Œç›¸åº”çš„å‘½ä»¤ã€‚

## ä¸‰ã€å­˜å‚¨è¡¨æƒ…ç¬¦å·æ”¯æŒ

ä¸ºäº†æ­£ç¡®åœ°æ˜¾ç¤ºå’Œä¿å­˜åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚è¡¨æƒ…ï¼‰çš„æ•°æ®ï¼Œç¡®ä¿æ•°æ®åº“åŠå…¶è¡¨ä½¿ç”¨å…¼å®¹çš„ç¼–ç ç±»å‹ã€‚ä¸€ç§æ–¹æ³•æ˜¯æ‰‹åŠ¨è®¾ç½®ï¼š

```sql
ALTER DATABASE database_name CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;
```

å¦ä¸€ç§æ˜¯åœ¨è¿æ¥æ± é…ç½®ä¸­æŒ‡å®šå­—ç¬¦é›†ï¼Œä¾‹å¦‚åœ¨ MyBatis é…ç½®æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹å±æ€§ï¼š

```java
@Bean(name = "dataSource")
@Primary
public DataSource dataSource() {
    DruidDataSource dataSource = new DruidDataSource();
    //...
    dataSource.setConnectionInitSqls(Arrays.asList("set names utf8mb4"));
}
```

æˆ–ç›´æ¥é€šè¿‡ SQL è¯­å¥è®¾ç½®å­—ç¬¦é›†:

```sql
SET NAMES 'utf8mb4';
```

åœ¨ MyBatis æ˜ å°„æ–‡ä»¶ä¸­å¯ä»¥ä½¿ç”¨ @Update æ³¨è§£æ¥æ‰§è¡Œæ­¤æ“ä½œï¼š

```xml
<update id="setCharsetToUtf8mb4">
    set names utf8mb4
</update>
```

## å››ã€å¤–ç½‘è®¿é—® MySQL æœåŠ¡å™¨

ä¸ºå…è®¸ä»å¤–éƒ¨ç½‘ç»œè®¿é—®æ•°æ®åº“ï¼Œéœ€æ›´æ”¹ MySQL ç”¨æˆ·çš„ `host` å±æ€§å¹¶è°ƒæ•´é˜²ç«å¢™è®¾ç½®ï¼š

1. ç™»å½•åˆ° MySQL å¹¶æ›´æ–°ç”¨æˆ·è¡¨ï¼š

```sql
mysql -u root -p1234;
use mysql;

update user set host='%' where user='root';
```

ç„¶ååˆ·æ–°æƒé™è®¾ç½®ä»¥ä½¿æ›´æ”¹ç”Ÿæ•ˆï¼š

```sql
FLUSH PRIVILEGES;
```

2. ç¼–è¾‘é…ç½®æ–‡ä»¶ `mysqld.cnf` å¹¶æ³¨é‡Šæ‰æˆ–åˆ é™¤ `bind-address = 127.0.0.1` è¡Œã€‚

3. ç¡®ä¿ MySQL çš„ç«¯å£ï¼ˆé»˜è®¤ä¸º 3306ï¼‰å·²å¼€æ”¾åœ¨é˜²ç«å¢™ä¸­ï¼š

```bash
sudo ufw allow 3306/tcp
```

## äº”ã€Oracle å’Œ MySQL æ‰¹é‡å¤„ç†ç¤ºä¾‹

### Oracle ä¸­çš„æ‰¹é‡æ’å…¥å’Œæ›´æ–°è¯­å¥

#### æ‰¹é‡æ’å…¥ç¤ºä¾‹ï¼š

```xml
<insert id="batchInsertUser" parameterType="java.util.ArrayList">
    INSERT ALL
    <foreach collection="list" item="userList" index="index">
       INTO USERINFO(userid,username) VALUES(#{userList.userid},#{userList.username})
    </foreach>
    SELECT 1 FROM DUAL
</insert>
```

#### æ‰¹é‡æ›´æ–°ç¤ºä¾‹ï¼š

```xml
<update id="batchUpdateUser" parameterType="java.util.ArrayList">
   <foreach collection="list" item="userlist" index="index" open="begin" close=";end;" separator=";">
      UPDATE USERINFO T SET
         T.USERID = #{userlist.userid,jdbcType=VARCHAR},
         T.USERNAME = #{userlist.username,jdbcType=VARCHAR}
      WHERE T.USERID = #{userlist.userid,jdbcType=VARCHAR}
   </foreach>
</update>
```

### MySQL ä¸­çš„æ‰¹é‡å¤„ç†è¯­å¥

#### æ’å…¥ç¤ºä¾‹ï¼š

```xml
<insert id="batchSave" parameterType="java.util.List">
    MERGE INTO RES_SCHOOL_CLUB t
    USING (
        <foreach collection="list" item="item" index="index" separator="union">
            select #{item.id,jdbcType=VARCHAR} ID,
                   #{item.clsSchoolId,jdbcType=VARCHAR} CLS_SCHOOL_ID,
                   #{item.originSchoolId,jdbcType=VARCHAR} ORIGIN_SCHOOL_ID,
                   #{item.resourceId,jdbcType=VARCHAR} RESOURCE_ID,
                   #{item.clsClubId,jdbcType=VARCHAR} CLS_CLUB_ID,
                   #{item.baseAreaId,jdbcType=VARCHAR} BASE_AREA_ID,
                   #{item.createTime,jdbcType=TIMESTAMP} CREATE_TIME
            from dual
        </foreach>
    ) t1 ON (t.CLS_SCHOOL_ID =  t1.CLS_SCHOOL_ID AND t.RESOURCE_ID = t1.RESOURCE_ID)
    WHEN MATCHED THEN UPDATE SET t.CREATE_TIME = t1.CREATE_TIME
    WHEN NOT MATCHED THEN INSERT(
        ID, CLS_SCHOOL_ID, ORIGIN_SCHOOL_ID, RESOURCE_ID, CLS_CLUB_ID, BASE_AREA_ID, CREATE_TIME
    ) VALUES (
        t1.ID, t1.CLS_SCHOOL_ID, t1.ORIGIN_SCHOOL_ID, t1.RESOURCE_ID, t1.CLS_CLUB_ID, t1.BASE_AREA_ID, t1.CREATE_TIME
)
</insert>
```

#### æ›´æ–°ç¤ºä¾‹ï¼š

```xml
<update id="updateBatchByListStat" parameterType="java.util.Map">
    update la_t_advfinished t1 set
        t1.list_stat='07',
        t1.modify_time=systimestamp where t1.id in(
            <foreach collection="ids" separator="," item="id">'${id}'</foreach>
        )
</update>
```

#### åˆ é™¤ç¤ºä¾‹ï¼š

```xml
<delete id="deleteAttractions" parameterType="java.util.List">
    delete from ATTRACTIONS WHERE id IN (
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item.id}
        </foreach>
    )
</delete>
```

## Oracle æ•°æ®åº“ä¸­çš„ä¸»é”®è‡ªå¢å®ç°

åœ¨ Oracle æ•°æ®åº“ä¸­ï¼Œå¯ä»¥ä½¿ç”¨åºåˆ—å’Œè§¦å‘å™¨æ¥æ¨¡æ‹Ÿè‡ªåŠ¨å¢é•¿çš„ IDã€‚é¦–å…ˆåˆ›å»ºä¸€ä¸ªåºåˆ—ï¼š

```sql
CREATE SEQUENCE seq_log_kl_s
MINVALUE 1
MAXVALUE 99999999999
START WITH 1
INCREMENT BY 1
CACHE 300
ORDER;
```

ç„¶åé€šè¿‡è§¦å‘å™¨åœ¨æ’å…¥æ“ä½œæ—¶ä½¿ç”¨åºåˆ—å€¼æ¥ç”Ÿæˆæ–°è®°å½•çš„ IDï¼š

```sql
CREATE OR REPLACE TRIGGER trg_seq_log_kl_s
BEFORE INSERT ON MS50_LOG.LOG_KNOWLEDGE_STAT
FOR EACH ROW
BEGIN
    SELECT seq_log_kl_s.NEXTVAL INTO :NEW.ID FROM DUAL;
END;
```

## åˆ†é¡µè®¡ç®—å…¬å¼

### è®¡ç®—å½“å‰é¡µçš„èµ·å§‹ç´¢å¼•ï¼š

```java
start = (currentPage - 1) * pageSize
```

å…¶ä¸­ï¼Œ`pageSize`ä¸ºæ¯é¡µæ˜¾ç¤ºçš„æ•°æ®æ¡æ•°ï¼›`currentPage`ä¸ºè¦è®¿é—®çš„é¡µé¢ç¼–å·ã€‚

### æ€»é¡µæ•°è®¡ç®—æ–¹æ³•ï¼š

æä¾› 5 ç§ä¸åŒçš„å†™æ³•æ¥å®ç°æ€»é¡µæ•°çš„è®¡ç®—åŠŸèƒ½ã€‚å‡è®¾å·²çŸ¥æ€»è®°å½•æ•°`totalCount`ä¸æ¯é¡µå¤§å°`pageSize`ï¼Œåˆ™ï¼š

1. `pageCount = (totalCount + pageSize - 1) / pageSize;`
2. `pageCount = (totalCount - 1) / pageSize + 1;`
3. `pageCount = (int)Math.Ceiling((double)totalCount / pageSize);`
4. `pageCount = totalCount%pageSize == 0 ? totalCount/pageSize : totalCount/pageSize + 1;`

### Oracle è·å–å‰ä¸€å¤©å’Œåä¸€å¤©æ—¶é—´ï¼š

è¦è·å–å½“å‰æ—¥æœŸçš„å‰ä¸€å¤©æˆ–åä¸€å¤©çš„æ—¶é—´æˆ³ï¼Œå¯ä½¿ç”¨ä»¥ä¸‹æŸ¥è¯¢è¯­å¥ï¼š

- **å‰ä¸€å¤©å¼€å§‹æ—¶åˆ»ï¼š**

```sql
SELECT to_date(to_char(TRUNC(SYSDATE - 1), 'yyyy-mm-dd') || '00:00:00', 'yyyy-mm-dd hh24:mi:ss')
FROM DUAL;
```

- **åä¸€å¤©æœ€åæ—¶åˆ»ï¼š**

```sql
SELECT to_date(to_char(TRUNC(SYSDATE + 1) - 1/86400, 'yyyy-mm-dd') || '23:59:59', 'yyyy-mm-dd hh24:mi:ss')
FROM DUAL;
```

## è§£å†³ Oracle é©±åŠ¨ç¨‹åºå·²è¿‡æ—¶é—®é¢˜

å½“é‡åˆ°`oracle.jdbc.driver.OracleDriver is deprecated.`è­¦å‘Šæ—¶ï¼Œéœ€è¦å°†`DriverClassName`ç”±`oracle.jdbc.driver.OracleDriver`æ›´æ–°ä¸º`oracle.jdbc.OracleDriver`ã€‚ä¾‹å¦‚ï¼š

```
jdbc:mysql://localhost:3306/testdb?useUnicode=true&characterEncoding=UTF-8&autoReconnect=true&serverTimezone=UTC
```

## MySQL æ•°æ®åº“ä¸­çš„æ‰¹é‡æ›´æ–°æ–¹æ³•

é™¤äº†å¸¸è§„çš„ MyBatis æ˜ å°„è¯­å¥å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨`REPLACE INTO`ã€`INSERT ... ON DUPLICATE KEY UPDATE`ç­‰æ–¹å¼å®Œæˆæ•°æ®é›†çš„æ‰¹é‡ä¿®æ”¹ä»»åŠ¡ã€‚è¿™äº›æ–¹æ³•å„æœ‰ä¼˜åŠ¿ï¼Œé€‚ç”¨äºä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚

- **REPLACE INTO**ï¼šæ›¿æ¢å·²å­˜åœ¨çš„è®°å½•æˆ–æ’å…¥æ–°è¡Œã€‚

  ```sql
  REPLACE INTO test_tbl (id,dr) VALUES (1,'2'),(2,'3');
  ```

- **INSERT ... ON DUPLICATE KEY UPDATE**ï¼šåœ¨é‡åˆ°é‡å¤é”®æ—¶æ›´æ–°ç°æœ‰è®°å½•çš„å€¼ï¼Œå¦åˆ™æ’å…¥æ–°æ•°æ®ã€‚
  ```sql
  INSERT INTO test_tbl (id,dr) VALUES (1,'4') ON DUPLICATE KEY UPDATE dr='5';
  ```

## MySQL å­—ç¬¦ä¸²å‡½æ•°

åœ¨ MySQL ä¸­ï¼Œæä¾›äº†å¤šç§å­—ç¬¦ä¸²å¤„ç†çš„å†…ç½®å‡½æ•°æ¥æ–¹ä¾¿ç”¨æˆ·æ“ä½œæ•°æ®ã€‚ä»¥ä¸‹ä»‹ç»å‡ ä¸ªå¸¸ç”¨çš„å­—ç¬¦ä¸²å¤„ç†å‡½æ•°ï¼š

### 1. substring() æˆªå–å­—ç¬¦ä¸²

- **åŠŸèƒ½**ï¼šç”¨äºä»æŒ‡å®šä½ç½®å¼€å§‹æˆªå–ä¸€å®šé•¿åº¦çš„å­—ç¬¦ä¸²ã€‚

  ```sql
  SELECT SUBSTRING('Hello, world!',3); // è¾“å‡º 'llo, world!'
  ```

### 2. find_in_set(str1, str2)

- **æè¿°**: æŸ¥æ‰¾ str1 åœ¨ç”¨é€—å·åˆ†éš”çš„ str2 ä¸­çš„ä½ç½®ï¼Œè¿”å›ä½ç½®ç´¢å¼•ã€‚

  ```sql
  SELECT FIND_IN_SET('a', 'a,b,c,d'); // è¾“å‡º 1
  ```

### 3. locate(substr, str)

- **åŠŸèƒ½**ï¼šå¦‚æœå­—ç¬¦ä¸²åŒ…å«å­ä¸²ï¼Œåˆ™è¿”å›å¤§äº 0 çš„ä½ç½®å€¼ï¼›å¦åˆ™è¿”å› 0ã€‚

```sql
UPDATE site SET url = CONCAT('http://',url) WHERE LOCATE('http://', url)=0;
```

ä»¥ä¸Šä»£ç ç”¨äºæ£€æŸ¥ site è¡¨ä¸­çš„ URL å­—æ®µæ˜¯å¦å«æœ‰'http://'ï¼Œå¦‚æœæ²¡æœ‰åˆ™åœ¨è¯¥å­—æ®µå¼€å¤´æ·»åŠ "http://"å‰ç¼€ã€‚

## æŸ¥çœ‹ MySQL è¯»å–é…ç½®æ–‡ä»¶çš„é¡ºåº

å¦‚æœæƒ³æŸ¥çœ‹ MySQL æœåŠ¡å™¨å¯åŠ¨æ—¶ä½¿ç”¨çš„é…ç½®æ–‡ä»¶è·¯å¾„åˆ—è¡¨ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
/usr/local/mysql/bin/mysqld --verbose --help | grep -A 1 'Default options'
```

æ­¤å‘½ä»¤å°†åˆ—å‡º MySQL é»˜è®¤åŠ è½½çš„æ‰€æœ‰é€‰é¡¹åŠå…¶å¯¹åº”çš„å€¼ã€‚

## MySQL æ•°æ®åº“æœ¬åœ°æ–‡ä»¶ä½ç½®

MySQL åœ¨ Linux ç³»ç»Ÿä¸Šå®‰è£…æ—¶ä¼šåœ¨`/usr/local/var/mysql`ç›®å½•ä¸‹åˆ›å»ºæ•°æ®åº“çš„æ•°æ®æ–‡ä»¶ï¼Œå…¶ä¸­ï¼š

- `.frm` æ–‡ä»¶åŒ…å«è¡¨ç»“æ„å®šä¹‰ã€‚
- `.ibd` æ–‡ä»¶æ˜¯å®é™…å­˜å‚¨æ•°æ®çš„æ–‡ä»¶ã€‚

### è·å–æ•°æ®åº“é©±åŠ¨ Class.forName()

åœ¨ Java ä¸­ä½¿ç”¨ JDBC è¿æ¥åˆ° MySQL ç­‰æ•°æ®åº“æ—¶ï¼Œé€šå¸¸ä¼šç”¨åˆ° `Class.forName()` æ–¹æ³•æ¥åŠ è½½æ•°æ®åº“é©±åŠ¨ç±»ã€‚æ­¤æ–¹æ³•ç”¨äºåŠ¨æ€åœ°å°†æŒ‡å®šçš„ç±»ï¼ˆå¦‚ MySQL JDBC é©±åŠ¨ï¼‰åŠ è½½è¿› Java è™šæ‹Ÿæœº (JVM)ï¼Œå¹¶æ‰§è¡Œé™æ€å—å†…çš„åˆå§‹åŒ–ä»£ç ã€‚

- **è¿”å›å€¼**ï¼š
  - `Class.forName("")` è¿”å›çš„æ˜¯æŒ‡å®šåç§°å¯¹åº”çš„ç±»å¯¹è±¡ã€‚
  - `Class.forName("").newInstance()` è¿”å›ä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œå¦‚æœè¯¥ç±»æœ‰å…¬å…±çš„æ— å‚æ•°æ„é€ å™¨ã€‚

### MySQL é©±åŠ¨å®ç°

MySQL JDBC é©±åŠ¨é€šè¿‡ç»§æ‰¿ `NonRegisteringDriver` ç±»å¹¶å®ç° `java.sql.Driver` æ¥å£æ¥æ³¨å†Œè‡ªèº«åˆ° `DriverManager` ï¼Œä»è€Œå¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å®ƒã€‚

```java
public class Driver extends NonRegisteringDriver implements java.sql.Driver {
    public Driver() throws SQLException {
        super();
    }

    static {
        try {
            DriverManager.registerDriver(new Driver());
        } catch (SQLException var1) {
            throw new RuntimeException("Can\'t register driver!");
        }
    }
}
```

### Java è°ƒç”¨å­˜å‚¨è¿‡ç¨‹

ä½¿ç”¨ `CallableStatement` è°ƒç”¨æ•°æ®åº“ä¸­çš„å­˜å‚¨è¿‡ç¨‹ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```java
// è·å– CallableStatement å¯¹è±¡
CallableStatement c = con.prepareCall("{call getCustomerName(?,?)}");
c.setString(1, "1"); // è®¾ç½®å‚æ•° 1 çš„å€¼ä¸ºå­—ç¬¦ä¸² '1'
c.registerOutParameter(2, java.sql.Types.VARCHAR); // æ³¨å†Œç¬¬äºŒä¸ªå‚æ•°ä¸ºè¾“å‡ºç±»å‹
c.execute(); // æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹

// è·å–æ‰§è¡Œç»“æœçš„è¿”å›å€¼ï¼Œè¿™é‡Œæ˜¯ VARCHAR ç±»å‹
String result = c.getString(2);
```

### MySQL æ—¥æœŸæ—¶é—´å‡½æ•°

MySQL æä¾›äº†å¤šç§æ—¥æœŸæ—¶é—´å‡½æ•°ï¼Œç”¨äºå¤„ç†å’Œæ“ä½œæ—¥æœŸå’Œæ—¶é—´ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„æ—¥æœŸæ—¶é—´å‡½æ•°ï¼š

- **NOW()**ï¼šè¿”å›å½“å‰æ—¥æœŸå’Œæ—¶é—´ã€‚

  ```sql
  SELECT NOW(); // è¾“å‡º '2023-10-01 12:34:56'
  ```

- **CURDATE()**ï¼šè¿”å›å½“å‰æ—¥æœŸã€‚

  ```sql
  SELECT CURDATE(); // è¾“å‡º '2023-10-01'
  ```

- **CURTIME()**ï¼šè¿”å›å½“å‰æ—¶é—´ã€‚

  ```sql

  ```

## [MavenåŸºç¡€æ•™ç¨‹ï¼šæ„å»ºè‡ªåŠ¨åŒ–å’Œä¾èµ–ç®¡ç†](https://blog.dong4j.site/posts/a6380364.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

Apache Maven æ˜¯ä¸€ä¸ªé¡¹ç›®ç®¡ç†å’Œæ„å»ºè‡ªåŠ¨åŒ–å·¥å…·ï¼Œä¸»è¦ç”¨äº Java é¡¹ç›®çš„æ„å»ºã€ä¾èµ–ç®¡ç†å’Œæ–‡æ¡£ç”Ÿæˆã€‚å®ƒé€šè¿‡å®šä¹‰é¡¹ç›®çš„é…ç½®æ–‡ä»¶ pom.xmlï¼ˆProject Object Modelï¼‰ï¼Œä½¿å¼€å‘è€…èƒ½å¤Ÿä»¥å£°æ˜å¼çš„æ–¹å¼æè¿°ä»–ä»¬çš„é¡¹ç›®ï¼Œä»è€Œç®€åŒ–äº†æ„å»ºè¿‡ç¨‹ã€‚

Maven æœ€é‡è¦çš„ç‰¹æ€§ä¹‹ä¸€æ˜¯å®ƒçš„æ’ä»¶ç³»ç»Ÿï¼Œæä¾›äº†ä¸°å¯Œçš„åŠŸèƒ½æ¥æ»¡è¶³å¼€å‘ä¸­å„ç§éœ€æ±‚ï¼Œå¦‚ç¼–è¯‘ä»£ç ã€è¿è¡Œæµ‹è¯•ã€æ‰“åŒ…å’Œéƒ¨ç½²åº”ç”¨ç­‰ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜æ”¯æŒå¤šç§é¡¹ç›®ç±»å‹ï¼ŒåŒ…æ‹¬ Java Web åº”ç”¨ã€å•å…ƒæµ‹è¯•ç­‰ï¼Œå¹¶ä¸”å¯ä»¥é›†æˆæŒç»­é›†æˆå·¥å…·ï¼ˆä¾‹å¦‚ Jenkinsï¼‰ä»¥å®ç°è‡ªåŠ¨åŒ–æ„å»ºã€‚

## å®‰è£… Maven

### Linux ç³»ç»Ÿï¼š

1. ä¸‹è½½æœ€æ–°çš„ Maven å‘è¡Œç‰ˆ:

   ```bash
   wget https://downloads.apache.org/maven/maven-3/3.3.3/binaries/apache-maven-3.3.3-bin.tar.gz
   ```

2. è§£å‹ä¸‹è½½çš„æ–‡ä»¶ï¼š

   ```bash
   tar -xzf apache-maven-3.3.3-bin.tar.gz
   mv apache-maven-3.3.3 /opt/maven
   ```

3. è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆç¼–è¾‘ `~/.bashrc` æˆ– `/etc/profile`ï¼‰:

   ```bash
   export M2_HOME=/opt/maven
   export PATH=$M2_HOME/bin:$PATH
   source ~/.bashrc # æˆ–è€… source /etc/profile
   ```

4. éªŒè¯ Maven æ˜¯å¦å®‰è£…æˆåŠŸï¼š

   ```bash
   mvn -v
   ```

### Windows ç³»ç»Ÿï¼š

1. è®¿é—®å®˜ç½‘ä¸‹è½½é¡µé¢å¹¶ä¸‹è½½æœ€æ–°ç‰ˆçš„ Mavenã€‚
2. è§£å‹ä¸‹è½½æ–‡ä»¶åˆ°ä¸€ä¸ªç›®å½•ï¼Œä¾‹å¦‚ `C:\Program Files\Apache Software Foundation\apache-maven-3.3.3`.
3. å°†è§£å‹ç¼©åçš„ Maven bin ç›®å½•æ·»åŠ åˆ°ç³»ç»Ÿç¯å¢ƒå˜é‡ Path ä¸­ï¼Œç¡®ä¿å‘½ä»¤è¡Œå¯ä»¥è¯†åˆ« mvn æŒ‡ä»¤ã€‚
   - å³é”®ç‚¹å‡»â€œæ­¤ç”µè„‘â€æˆ–â€œè®¡ç®—æœºâ€ï¼Œé€‰æ‹©å±æ€§ -> é«˜çº§ç³»ç»Ÿè®¾ç½® -> ç¯å¢ƒå˜é‡
   - åœ¨ç”¨æˆ·å˜é‡æˆ–ç³»ç»Ÿå˜é‡çš„ Path ä¸­æ·»åŠ  `C:\Program Files\Apache Software Foundation\apache-maven-3.3.3\bin`
4. æ‰“å¼€å‘½ä»¤æç¤ºç¬¦å¹¶è¾“å…¥ï¼š

   ```bash
   mvn -v
   ```

## Maven é¡¹ç›®ç»“æ„

ä¸€ä¸ªæ ‡å‡†çš„ Maven é¡¹ç›®åŒ…å«ä»¥ä¸‹å‡ éƒ¨åˆ†ï¼š

- **pom.xml**: é¡¹ç›®çš„é…ç½®æ–‡ä»¶ï¼Œå®šä¹‰äº†æ„å»ºè¿‡ç¨‹ä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚
- **src/main/java**: Java æºä»£ç ç›®å½•ã€‚
- **src/main/resources**: å­˜æ”¾é¡¹ç›®çš„èµ„æºæ–‡ä»¶ï¼ˆå¦‚å›¾ç‰‡ã€æ•°æ®åº“é…ç½®æ–‡ä»¶ç­‰ï¼‰ã€‚
- **src/test/java**: å•å…ƒæµ‹è¯•ä»£ç å­˜æ”¾ä½ç½®ã€‚
- **src/test/resources**: æµ‹è¯•é˜¶æ®µä½¿ç”¨çš„èµ„æºæ–‡ä»¶ã€‚

## åŸºæœ¬å‘½ä»¤

### é¡¹ç›®æ„å»º

```bash
mvn clean install # æ¸…ç†å¹¶å®‰è£…é¡¹ç›®ï¼Œå³ç¼–è¯‘ã€è¿è¡Œæµ‹è¯•å’Œæ‰“åŒ…ç­‰æ‰€æœ‰æ­¥éª¤
```

### å•ç‹¬æ‰§è¡ŒæŸä¸€æ­¥éª¤

- ç¼–è¯‘æºä»£ç :

  ```bash
  mvn compile
  ```

- æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼š

  ```bash
  mvn test
  ```

- ç”Ÿæˆ jar æ–‡ä»¶ï¼š

  ```bash
  mvn package
  ```

## pom.xml é…ç½®

### åŸºæœ¬å…ƒç´ å®šä¹‰

```xml
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <!-- é¡¹ç›®çš„åŸºæœ¬ä¿¡æ¯ -->
    <groupId>com.example</groupId>
    <artifactId>my-project</artifactId>
    <version>1.0-SNAPSHOT</version>

    <!-- ä¾èµ–ç®¡ç†ï¼Œåˆ—å‡ºæ‰€éœ€çš„æ‰€æœ‰åº“ -->
    <dependencies>
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>3.12</version>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <!-- æ’ä»¶é…ç½®ï¼Œç”¨äºè‡ªå®šä¹‰æ„å»ºè¿‡ç¨‹ -->
    <build>
      <plugins>
         <plugin>
           <groupId>org.apache.maven.plugins</groupId>
           <artifactId>maven-compiler-plugin</artifactId>
           <version>3.3.0</version>
           <configuration>
             <source>1.7</source>
             <target>1.7</target>
           </configuration>
         </plugin>
      </plugins>
    </build>

</project>
```

### æ’ä»¶é…ç½®

æ’ä»¶å…è®¸è‡ªå®šä¹‰ Maven çš„æ„å»ºç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬ç¼–è¯‘ã€æµ‹è¯•ã€æ‰“åŒ…ç­‰ã€‚ç¤ºä¾‹ä¸­å·²å±•ç¤ºå¦‚ä½•é…ç½®`maven-compiler-plugin`ã€‚

## ä½¿ç”¨ä»“åº“ç®¡ç†å™¨

ä¸ºäº†æé«˜ä¾èµ–ä¸‹è½½é€Ÿåº¦ï¼Œå»ºè®®è®¾ç½®æœ¬åœ°å’Œè¿œç¨‹ä»“åº“åœ°å€ï¼š

```xml
<repositories>
    <repository>
        <id>central</id>
        <url>https://repo.maven.apache.org/maven2/</url>
    </repository>
    <repository>
        <id>nexus</id>
        <url>http://your-nexus-server/repository/public-releases/</url>
    </repository>
</repositories>

<distributionManagement>
    <!-- é…ç½®å‘å¸ƒä»“åº“ -->
    <repository>
        <id>internal.repo</id>
        <name>Internal Repository</name>
        <url>http://localhost:8081/nexus/content/repositories/releases/</url>
    </repository>
    <snapshotRepository>
        <id>snapshots-repo</id>
        <name>Snapshots Repository</name>
        <url>http://localhost:8081/nexus/content/repositories/snapshots/</url>
    </snapshotRepository>
</distributionManagement>
```

## [è®©èµ„æºå…³é—­æ›´ç®€å•ï¼šJava 7 try-with-resources](https://blog.dong4j.site/posts/85a56b56.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})


[åŸæ–‡é“¾æ¥](http://tutorials.jenkov.com/java-exception-handling/try-with-resources.html "Try-with-resources in Java 7")ä½œè€…: Jakob Jenkov
è¯‘è€…: fangqiang08(fangqiang08@gmail.com)

## åˆ©ç”¨ Try-Catch-Finally ç®¡ç†èµ„æºï¼ˆæ—§çš„ä»£ç é£æ ¼ï¼‰

åœ¨ java7 ä»¥å‰, ç¨‹åºä¸­ä½¿ç”¨çš„èµ„æºéœ€è¦è¢«æ˜ç¡®åœ°å…³é—­, è¿™ä¸ªä½“éªŒæœ‰ç‚¹ç¹ç.

ä¸‹é¢çš„æ–¹æ³•è¯»å–æ–‡ä»¶, ç„¶åç”¨ System.out æ‰“å°:

```java
private static void printFile() throws IOException {
    InputStream input = null;

    try {
        input = <strong>new FileInputStream("file.txt")</strong>;

        int data = <strong>input.read()</strong>;
        while(data != -1){
            System.out.print((char) data);
            data = <strong>input.read()</strong>;
        }
    } finally {
        if(input != null){
            <strong>input.close()</strong>;
        }
    }
}
```

ä¸Šé¢ä»£ç ä¸­é»‘ä½“å­—çš„ç¨‹åºå¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸. æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„, try è¯­å¥å—ä¸­æœ‰ 3 ä¸ªåœ°æ–¹èƒ½æŠ›å‡ºå¼‚å¸¸, finally è¯­å¥å—ä¸­æœ‰ä¸€ä¸ªåœ°æ–¹ä¼šèƒ½å‡ºå¼‚å¸¸.

ä¸è®º try è¯­å¥å—ä¸­æ˜¯å¦æœ‰å¼‚å¸¸æŠ›å‡º, finally è¯­å¥å—å§‹ç»ˆä¼šè¢«æ‰§è¡Œ. è¿™æ„å‘³ç€, ä¸è®º try è¯­å¥å—ä¸­å‘ç”Ÿä»€ä¹ˆ, InputStream éƒ½ä¼šè¢«å…³é—­, æˆ–è€…è¯´éƒ½ä¼šè¯•å›¾è¢«å…³é—­.
å¦‚æœå…³é—­å¤±è´¥, InputStreamâ€™s close() æ–¹æ³•ä¹Ÿå¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸.

å‡è®¾ try è¯­å¥å—æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸, ç„¶å finally è¯­å¥å—è¢«æ‰§è¡Œ. åŒæ ·å‡è®¾ finally è¯­å¥å—ä¹ŸæŠ›å‡ºäº†ä¸€ä¸ªå¼‚å¸¸. é‚£ä¹ˆå“ªä¸ªå¼‚å¸¸ä¼šæ ¹æ®è°ƒç”¨æ ˆå¾€å¤–ä¼ æ’­ï¼Ÿ

å³ä½¿ try è¯­å¥å—ä¸­æŠ›å‡ºçš„å¼‚å¸¸ä¸å¼‚å¸¸ä¼ æ’­æ›´ç›¸å…³, æœ€ç»ˆè¿˜æ˜¯ finally è¯­å¥å—ä¸­æŠ›å‡ºçš„å¼‚å¸¸ä¼šæ ¹æ®è°ƒç”¨æ ˆå‘å¤–ä¼ æ’­.

åœ¨ java7 ä¸­, å¯¹äºä¸Šé¢çš„ä¾‹å­å¯ä»¥ç”¨ try-with-resource ç»“æ„è¿™æ ·å†™:

```java
private static void printFileJava7() throws IOException {

    try(FileInputStream input = new FileInputStream("file.txt")) {

        int data = input.read();
        while(data != -1){
            System.out.print((char) data);
            data = input.read();
        }
    }
}
```

æ³¨æ„æ–¹æ³•ä¸­çš„ç¬¬ä¸€è¡Œ:

```java
try(FileInputStream input = new FileInputStream("file.txt")) {
```

è¿™å°±æ˜¯ try-with-resource ç»“æ„çš„ç”¨æ³•. FileInputStream ç±»å‹å˜é‡å°±åœ¨ try å…³é”®å­—åé¢çš„æ‹¬å·ä¸­å£°æ˜. è€Œä¸”ä¸€ä¸ª FileInputStream ç±»å‹è¢«å®ä¾‹åŒ–å¹¶è¢«èµ‹ç»™äº†è¿™ä¸ªå˜é‡.

å½“ try è¯­å¥å—è¿è¡Œç»“æŸæ—¶, FileInputStream ä¼šè¢«è‡ªåŠ¨å…³é—­. è¿™æ˜¯å› ä¸º FileInputStream å®ç°äº† java ä¸­çš„ java.lang.AutoCloseable æ¥å£.
æ‰€æœ‰å®ç°äº†è¿™ä¸ªæ¥å£çš„ç±»éƒ½å¯ä»¥åœ¨ try-with-resources ç»“æ„ä¸­ä½¿ç”¨.

å½“ try-with-resources ç»“æ„ä¸­æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸, åŒæ—¶ FileInputStreami è¢«å…³é—­æ—¶ï¼ˆè°ƒç”¨äº†å…¶ close æ–¹æ³•ï¼‰ä¹ŸæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸, try-with-resources
ç»“æ„ä¸­æŠ›å‡ºçš„å¼‚å¸¸ä¼šå‘å¤–ä¼ æ’­, è€Œ FileInputStreami è¢«å…³é—­æ—¶æŠ›å‡ºçš„å¼‚å¸¸è¢«æŠ‘åˆ¶äº†. è¿™ä¸æ–‡ç« å¼€å§‹å¤„åˆ©ç”¨æ—§é£æ ¼ä»£ç çš„ä¾‹å­ï¼ˆåœ¨ finally è¯­å¥å—ä¸­å…³é—­èµ„æºï¼‰ç›¸å.

## ä½¿ç”¨å¤šä¸ªèµ„æº

ä½ å¯ä»¥åœ¨å—ä¸­ä½¿ç”¨å¤šä¸ªèµ„æºè€Œä¸”è¿™äº›èµ„æºéƒ½èƒ½è¢«è‡ªåŠ¨åœ°å…³é—­. ä¸‹é¢æ˜¯ä¾‹å­:

```java
private static void printFileJava7() throws IOException {

    try(  FileInputStream     input         = new FileInputStream("file.txt");
          BufferedInputStream bufferedInput = new BufferedInputStream(input)
    ) {

        int data = bufferedInput.read();
        while(data != -1){
            System.out.print((char) data);
    data = bufferedInput.read();
        }
    }
}
```

ä¸Šé¢çš„ä¾‹å­åœ¨ try å…³é”®å­—åçš„æ‹¬å·é‡Œåˆ›å»ºäº†ä¸¤ä¸ªèµ„æºâ€”â€”FileInputStream å’Œ BufferedInputStream. å½“ç¨‹åºè¿è¡Œç¦»å¼€ try è¯­å¥å—æ—¶, è¿™ä¸¤ä¸ªèµ„æºéƒ½ä¼šè¢«è‡ªåŠ¨å…³é—­.

è¿™äº›èµ„æºå°†æŒ‰ç…§ä»–ä»¬è¢«åˆ›å»ºé¡ºåºçš„é€†åºæ¥å…³é—­. é¦–å…ˆ BufferedInputStream ä¼šè¢«å…³é—­, ç„¶å FileInputStream ä¼šè¢«å…³é—­.

## è‡ªå®šä¹‰ AutoClosable å®ç°

è¿™ä¸ª try-with-resources ç»“æ„é‡Œä¸ä»…èƒ½å¤Ÿæ“ä½œ java å†…ç½®çš„ç±». ä½ ä¹Ÿå¯ä»¥åœ¨è‡ªå·±çš„ç±»ä¸­å®ç° java.lang.AutoCloseable æ¥å£, ç„¶ååœ¨ try-with-resources
ç»“æ„é‡Œä½¿ç”¨è¿™ä¸ªç±».

AutoClosable æ¥å£ä»…ä»…æœ‰ä¸€ä¸ªæ–¹æ³•, æ¥å£å®šä¹‰å¦‚ä¸‹:

```java
public interface AutoClosable {
    public void close() throws Exception;
}
```

ä»»ä½•å®ç°äº†è¿™ä¸ªæ¥å£çš„æ–¹æ³•éƒ½å¯ä»¥åœ¨ try-with-resources ç»“æ„ä¸­ä½¿ç”¨. ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­:

```java
public class MyAutoClosable implements AutoCloseable {

    public void doIt() {
        System.out.println("MyAutoClosable doing it!");
    }

    @Override
    public void close() throws Exception {
        System.out.println("MyAutoClosable closed!");
    }
}
```

doIt() æ˜¯æ–¹æ³•ä¸æ˜¯ AutoClosable æ¥å£ä¸­çš„ä¸€éƒ¨åˆ†, ä¹‹æ‰€ä»¥å®ç°è¿™ä¸ªæ–¹æ³•æ˜¯å› ä¸ºæˆ‘ä»¬æƒ³è¦è¿™ä¸ªç±»é™¤äº†å…³é—­æ–¹æ³•å¤–è¿˜èƒ½åšç‚¹å…¶ä»–äº‹.

ä¸‹é¢æ˜¯ MyAutoClosable åœ¨ try-with-resources ç»“æ„ä¸­ä½¿ç”¨çš„ä¾‹å­:

```java
private static void myAutoClosable() throws Exception {

    try(MyAutoClosable myAutoClosable = new MyAutoClosable()){
        myAutoClosable.doIt();
    }
}
```

å½“æ–¹æ³• myAutoClosable.doIt() è¢«è°ƒç”¨æ—¶, ä¸‹é¢æ˜¯æ‰“å°åˆ° System.out çš„è¾“å‡º:

```java
MyAutoClosable doing it!
MyAutoClosable closed!
```

é€šè¿‡ä¸Šé¢è¿™äº›ä½ å¯ä»¥çœ‹åˆ°, ä¸è®º try-catch ä¸­ä½¿ç”¨çš„èµ„æºæ˜¯è‡ªå·±åˆ›é€ çš„è¿˜æ˜¯ java å†…ç½®çš„ç±»å‹, try-with-resources éƒ½æ˜¯ä¸€ä¸ªèƒ½å¤Ÿç¡®ä¿èµ„æºèƒ½è¢«æ­£ç¡®åœ°å…³é—­çš„å¼ºå¤§æ–¹æ³•.

## [è‡ªå®šä¹‰Logbackè¾“å‡ºæ ¼å¼ï¼šæŒæ¡JSONæ—¥å¿—çš„å¥¥ç§˜](https://blog.dong4j.site/posts/d2b51e2a.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

è¯´åˆ° log4j, åŸºæœ¬äººäººéƒ½çŸ¥é“, ä½†æ˜¯ logback, ä¼°è®¡ç”¨çš„äººä¸å¤š, å…¶å®è¿™ä¸¤ä¸ªéƒ½æ˜¯ sl4j çš„å®ç°, è€Œä¸”æ˜¯ä¸€ä¸ªä½œè€…å†™çš„.

logback æ¯” log4j æ›´åŠ å¥½ç”¨, è€Œä¸”æ•ˆç‡æ›´é«˜.

å¦‚ä½•é…ç½® logback.

```xml
<dependency>
    <groupId>ch.qos.logback</groupId>
    <artifactId>logback-classic</artifactId>
    <version>1.1.3</version>
</dependency>
```

é…ç½®æ–‡ä»¶: logback.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<configuration scan="true" scanPeriod="10 minutes">
 <property name="LOG_HOME" value="d:/logs"/>

 <appender name="stdot" class="ch.qos.logback.core.ConsoleAppender">
  <layout class="ch.qos.logback.classic.PatternLayout">
   <pattern>%d{yyyy-MM-dd HH:mm:ss} [%p][%c][%M][%L]-> %m%n</pattern>
  </layout>
 </appender>
 <appender name="file" class="ch.qos.logback.core.rolling.RollingFileAppender">
  <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
   <FileNamePattern>${LOG_HOME}/log.%d{yyyy-MM-dd}(%i).log</FileNamePattern>
   <cleanHistoryOnStart>true</cleanHistoryOnStart>
   <TimeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
    <MaxFileSize>10MB</MaxFileSize>
   </TimeBasedFileNamingAndTriggeringPolicy>
  </rollingPolicy>
  <encoder>
    <charset>utf-8</charset>
    <pattern>%d{yyyy-MM-dd HH:mm:ss} [%p][%c][%M][%L]-> %m%n</pattern>
  </encoder>
  <append>false</append>
  <prudent>false</prudent>
 </appender>

 <logger name="org.mortbay.log" additivity="false"  level="ERROR">
       <appender-ref ref="stdot" />
 </logger>

 <logger name="org.mybatis.spring" additivity="false"  level="ERROR">
       <appender-ref ref="stdot" />
 </logger>

 <root level="debug">
  <appender-ref ref="stdot" />
  <appender-ref ref="file" />
 </root>

</configuration>
```

å°†è¿™ä¸ªæ–‡ä»¶æ”¾åˆ°èµ„æºç›®å½•æ ¹ç›®å½•ä¸‹, æœåŠ¡å™¨å¯åŠ¨æ—¶, logback ä¼šæ ¹æ® logback è¿™ä¸ªåç§°è‡ªå·±å»åŒ¹é…åŠ è½½

è¿™é‡Œå¦‚æœè¦è¾“å‡ºé¡¹ç›®ä¸­çš„ SQL å¾ˆç®€å•, åªéœ€è¦å°†æ—¥å¿—çº§åˆ«æ”¹æˆ debug å°±å¯ä»¥äº†ï¼ˆmybatis æ˜¯è¿™æ ·çš„, å…¶ä»–çš„æ²¡è¯•è¿‡ï¼‰

ä»Šå¤©ä¸»è¦è¯´çš„æ˜¯æ—¥å¿—æ ¼å¼

`%d{yyyy-MM-dd HH:mm:ss} [%p][%c][%M][%L]-> %m%n`

è¿™é‡Œå°±æ˜¯é…ç½®æ ¼å¼çš„, ä»¥ä¸‹æ˜¯å„ä¸ªå‚æ•°çš„è¯´æ˜

| å‚æ•° | è¯´æ˜                                                                                                                                                   |
| :--: | :----------------------------------------------------------------------------------------------------------------------------------------------------- |
|  %m  | è¾“å‡ºä»£ç ä¸­æŒ‡å®šçš„æ¶ˆæ¯                                                                                                                                   |
|  %p  | è¾“å‡ºä¼˜å…ˆçº§, å³ DEBUG, INFO, WARN, ERROR, FATAL                                                                                                         |
|  %r  | è¾“å‡ºè‡ªåº”ç”¨å¯åŠ¨åˆ°è¾“å‡ºè¯¥ log ä¿¡æ¯è€—è´¹çš„æ¯«ç§’æ•°                                                                                                            |
|  %c  | è¾“å‡ºæ‰€å±çš„ç±»ç›®, é€šå¸¸å°±æ˜¯æ‰€åœ¨ç±»çš„å…¨å                                                                                                                   |
|  %t  | è¾“å‡ºäº§ç”Ÿè¯¥æ—¥å¿—äº‹ä»¶çš„çº¿ç¨‹å                                                                                                                             |
|  %n  | è¾“å‡ºä¸€ä¸ªå›è½¦æ¢è¡Œç¬¦, Windows å¹³å°ä¸º `\r\n`, Unix å¹³å°ä¸º `\n`                                                                                            |
|  %d  | è¾“å‡ºæ—¥å¿—æ—¶é—´ç‚¹çš„æ—¥æœŸæˆ–æ—¶é—´, é»˜è®¤æ ¼å¼ä¸º ISO8601, ä¹Ÿå¯ä»¥åœ¨å…¶åæŒ‡å®šæ ¼å¼, æ¯”å¦‚: %d{yyy MMM dd HH:mm:ss,SSS}, è¾“å‡ºç±»ä¼¼: 2002 å¹´ 10 æœˆ 18 æ—¥ 22: 10: 28, 921 |
|  %l  | è¾“å‡ºæ—¥å¿—äº‹ä»¶çš„å‘ç”Ÿä½ç½®, åŒ…æ‹¬ç±»ç›®åã€å‘ç”Ÿçš„çº¿ç¨‹, ä»¥åŠåœ¨ä»£ç ä¸­çš„è¡Œæ•°. ä¸¾ä¾‹: Testlog4.main(TestLog4.java:10)                                              |

è¿™ä¸ªæ—¶å€™, æ—¥å¿—å°±ä¼šè¾“å‡º æ—¶é—´, æ—¥å¿—ä¼˜å…ˆçº§, ç±»å, æ–¹æ³•å, è¡Œæ•°, æ—¥å¿—å†…å®¹

åŸºæœ¬å°±æ˜¯è¿™æ ·çš„äº†

```
2016-09-02 14:45:53 [DEBUG][com.ulewo.mapper.SignInMapper.selectCount][debug][132]-> ==>  Preparing: select count(1) from ulewo_sign_in WHERE sign_date = DATE_FORMAT(?,'%Y-%m-%d')
2016-09-02 14:45:53 [DEBUG][com.ulewo.mapper.SignInMapper.selectCount][debug][132]-> ==> Parameters: 2016-09-02 14:45:53.098(Timestamp)
2016-09-02 14:45:53 [DEBUG][com.ulewo.mapper.SignInMapper.selectCount][debug][132]-> <==      Total: 1
```

è¿™é‡Œè¾“å‡ºäº† SQL.

ä¸ºä»€ä¹ˆè¦è®²è¾“å‡ºæ ¼å¼, æœ¬æ¥è¿™æ ·è¾“å‡ºæŒºå¥½çš„å‘€, æ˜¯çš„, ç°åœ¨åœ¨æˆ‘ä»¬çš„ç”Ÿäº§ç¯å¢ƒä¸­, æ€»å…±æœ‰ 16 å°æœåŠ¡å™¨, æœ‰æ—¶å€™æŸ¥é—®é¢˜, è¦ä¸€å°å°çš„æŸ¥, å› ä¸ºä¸çŸ¥é“è¯·æ±‚åˆ°åº•æ˜¯å¤§åˆ°é‚£ä¸ªæœåŠ¡å™¨ä¸Š,
è¿™æ ·æŸ¥é—®é¢˜éå¸¸çš„ç—›è‹¦, äºæ˜¯é¡¹ç›®å¼•å…¥äº† graylog ä¸€ä¸ªæ—¥å¿—æ”¶é›†å·¥å…·, å¯ä»¥å°†å„ä¸ªæœåŠ¡å™¨çš„æ—¥å¿—æ”¶é›†åˆ°ä¸€èµ·, è¿™æ ·æŸ¥é—®é¢˜å°±æ–¹ä¾¿å¤šäº†. ä½†æ˜¯ graylog è¦æ±‚æ—¥å¿—å¿…é¡»æ˜¯
json æ ¼å¼çš„, é‚£ä¹ˆæŒ‰ç…§æˆ‘ä¸Šé¢æ ¼å¼å°±æ— æ³•ä½¿ç”¨äº†, æ‰€ä»¥è¦ä¿®æ”¹æ—¥å¿—è¾“å‡ºæ ¼å¼.

æŸ¥äº†ä¸€ç•ªèµ„æ–™å‘ç°, åªè¦é‡å†™ ClassicConverter å’Œ PatternLayout è¿™ä¸¤ä¸ªç±»å°±å¯ä»¥äº†

**é‡æ–° Converter ç±»**

```java
public class NetbarLogerConvert extends ClassicConverter {

 long lastTimestamp = -1;
 String timestampStrCache = null;
 SimpleDateFormat simpleFormat = null;

 String businessName = null;

 static String hostName;
 static String localIp;

 static {
  InetAddress ia = null;
  try {
   ia = ia.getLocalHost();
   hostName = ia.getHostName();
   localIp = ia.getHostAddress();
  } catch (Exception e) {
   // TODO Auto-generated catch block
   e.printStackTrace();
  }
 }

 @Override
 public String convert(ILoggingEvent le) {
  LogObject log = new LogObject();
  log.setBusiness(businessName);
  log.setIp(localIp);
  log.setHostName(hostName);
  log.setTime(getTime(le));
  log.setLeave(le.getLevel().toString());
  log.setClassName(getFullyQualifiedName(le));
  log.setMethodName(getMethodName(le));
  log.setLine(getLineNumber(le));
  log.setMessage(le.getFormattedMessage());
  return JacksonUtil.writJson(log);
 }

 public void start() {
  businessName = getFirstOption();
  businessName = businessName == null ? "æœªè®¾ç½®äº§å“çº¿" : businessName;
  String datePattern = DateStyle.YYYY_MM_DD_HH_MM_SS.getValue();
  try {
   simpleFormat = new SimpleDateFormat(datePattern);
   // maximumCacheValidity =
   // CachedDateFormat.getMaximumCacheValidity(pattern);
  } catch (IllegalArgumentException e) {
   addWarn("Could not instantiate SimpleDateFormat with pattern " + datePattern, e);
   // default to the ISO8601 format
   simpleFormat = new SimpleDateFormat(CoreConstants.ISO8601_PATTERN);
  }
  List optionList = getOptionList();
  // if the option list contains a TZ option, then set it.
  if (optionList != null && optionList.size() > 1) {
   TimeZone tz = TimeZone.getTimeZone((String) optionList.get(1));
   simpleFormat.setTimeZone(tz);
  }
 }

 private String getTime(ILoggingEvent le) {
  long timestamp = le.getTimeStamp();
  synchronized (this) {
   // if called multiple times within the same millisecond
   // return cache value
   if (timestamp == lastTimestamp) {
    return timestampStrCache;
   } else {
    lastTimestamp = timestamp;
    // SimpleDateFormat is not thread safe.
    // See also http://jira.qos.ch/browse/LBCLASSIC-36
    timestampStrCache = simpleFormat.format(new Date(timestamp));
    return timestampStrCache;
   }
  }
 }

 private String getFullyQualifiedName(ILoggingEvent le) {

  StackTraceElement[] cda = le.getCallerData();
  if (cda != null && cda.length > 0) {
   return cda[0].getClassName();
  } else {
   return CallerData.NA;
  }
 }

 private String getLineNumber(ILoggingEvent le) {
  StackTraceElement[] cda = le.getCallerData();
  if (cda != null && cda.length > 0) {
   return Integer.toString(cda[0].getLineNumber());
  } else {
   return CallerData.NA;
  }
 }

 private String getMethodName(ILoggingEvent le) {
  StackTraceElement[] cda = le.getCallerData();
  if (cda != null && cda.length > 0) {
   return cda[0].getMethodName();
  } else {
   return CallerData.NA;
  }
 }

 public class LogObject {
  /**
   * äº§å“çº¿
   */
  private String business;
  /**
   * ä¸»æœºå
   */
  private String hostName;
  /**
   * IP
   */
  private String ip;
  /**
   * æ—¶é—´
   */
  private String time;
  /**
   * æ—¥å¿—çº§åˆ«
   */
  private String leave;
  /**
   * ç±»å
   */
  private String className;
  /**
   * æ–¹æ³•å
   */
  private String methodName;
  /**
   * è¡Œæ•°
   */
  private String line;
  /**
   * æ—¥å¿—å†…å®¹
   */
  private String message;

  public String getTime() {
   return time;
  }

  public void setTime(String time) {
   this.time = time;
  }

  public String getLeave() {
   return leave;
  }

  public void setLeave(String leave) {
   this.leave = leave;
  }

  public String getClassName() {
   return className;
  }

  public void setClassName(String className) {
   this.className = className;
  }

  public String getMethodName() {
   return methodName;
  }

  public void setMethodName(String methodName) {
   this.methodName = methodName;
  }

  public String getLine() {
   return line;
  }

  public void setLine(String line) {
   this.line = line;
  }

  public String getMessage() {
   return message;
  }

  public void setMessage(String message) {
   this.message = message;
  }

  public String getBusiness() {
   return business;
  }

  public void setBusiness(String business) {
   this.business = business;
  }

  public String getIp() {
   return ip;
  }

  public void setIp(String ip) {
   this.ip = ip;
  }

  public String getHostName() {
   return hostName;
  }

  public void setHostName(String hostName) {
   this.hostName = hostName;
  }

 }
}
```

**é‡å†™ layout ç±»**

```java
public class NetbarLoggerPatternLayout extends PatternLayout {
 static {
  defaultConverterMap.put("netbarLoggerPattern", NetbarLogerConvert.class.getName());
 }
}
```

è¿™é‡Œå¦‚ä½•è·å– æ–¹æ³•å, è¡Œæ•°, ç”šè‡³è¿˜æœ‰å…¶ä»–çš„ä¸€äº›ä¿¡æ¯å¯ä»¥å‚è€ƒ logback

è¿™ä¸ªç±»:

```java
public class PatternLayout extends PatternLayoutBase<ILoggingEvent> {

  public static final Map<String, String> defaultConverterMap = new HashMap<String, String>();

  static {

    defaultConverterMap.put("d", DateConverter.class.getName());
    defaultConverterMap.put("date", DateConverter.class.getName());

    defaultConverterMap.put("r", RelativeTimeConverter.class.getName());
    defaultConverterMap.put("relative", RelativeTimeConverter.class.getName());

    defaultConverterMap.put("level", LevelConverter.class.getName());
    defaultConverterMap.put("le", LevelConverter.class.getName());
    defaultConverterMap.put("p", LevelConverter.class.getName());

    defaultConverterMap.put("t", ThreadConverter.class.getName());
    defaultConverterMap.put("thread", ThreadConverter.class.getName());

    defaultConverterMap.put("lo", LoggerConverter.class.getName());
    defaultConverterMap.put("logger", LoggerConverter.class.getName());
    defaultConverterMap.put("c", LoggerConverter.class.getName());

    defaultConverterMap.put("m", MessageConverter.class.getName());
    defaultConverterMap.put("msg", MessageConverter.class.getName());
    defaultConverterMap.put("message", MessageConverter.class.getName());

    defaultConverterMap.put("C", ClassOfCallerConverter.class.getName());
    defaultConverterMap.put("class", ClassOfCallerConverter.class.getName());

    defaultConverterMap.put("M", MethodOfCallerConverter.class.getName());
    defaultConverterMap.put("method", MethodOfCallerConverter.class.getName());

    defaultConverterMap.put("L", LineOfCallerConverter.class.getName());
    defaultConverterMap.put("line", LineOfCallerConverter.class.getName());

    defaultConverterMap.put("F", FileOfCallerConverter.class.getName());
    defaultConverterMap.put("file", FileOfCallerConverter.class.getName());

    defaultConverterMap.put("X", MDCConverter.class.getName());
    defaultConverterMap.put("mdc", MDCConverter.class.getName());

    defaultConverterMap.put("ex", ThrowableProxyConverter.class.getName());
    defaultConverterMap.put("exception", ThrowableProxyConverter.class
        .getName());
    defaultConverterMap.put("throwable", ThrowableProxyConverter.class
        .getName());

    defaultConverterMap.put("xEx", ExtendedThrowableProxyConverter.class.getName());
    defaultConverterMap.put("xException", ExtendedThrowableProxyConverter.class
        .getName());
    defaultConverterMap.put("xThrowable", ExtendedThrowableProxyConverter.class
        .getName());

    defaultConverterMap.put("nopex", NopThrowableInformationConverter.class
        .getName());
    defaultConverterMap.put("nopexception",
        NopThrowableInformationConverter.class.getName());

    defaultConverterMap.put("cn", ContextNameAction.class.getName());
    defaultConverterMap.put("contextName", ContextNameConverter.class.getName());

    defaultConverterMap.put("caller", CallerDataConverter.class.getName());

    defaultConverterMap.put("marker", MarkerConverter.class.getName());

    defaultConverterMap.put("property", PropertyConverter.class.getName());


    defaultConverterMap.put("n", LineSeparatorConverter.class.getName());
  }

  public PatternLayout() {
    this.postCompileProcessor = new EnsureExceptionHandling();
  }

  public Map<String, String> getDefaultConverterMap() {
    return defaultConverterMap;
  }

  public String doLayout(ILoggingEvent event) {
    if (!isStarted()) {
      return CoreConstants.EMPTY_STRING;
    }
    return writeLoopOnConverters(event);
  }

}
```

è¿™é‡Œæœ‰å„ä¸ªå‚æ•° convert çš„å®ç°, ç›´æ¥æ‹·è´è¿‡æ¥å°±å¯ä»¥äº†.

ç„¶å logback è¿™é‡Œçš„é…ç½®ä¿®æ”¹ä¸‹

```
<appender name="stdot" class="ch.qos.logback.core.ConsoleAppender">
    <layout class="com.stnts.netbar.logger.NetbarLoggerPatternLayout">
    <pattern>%netbarLoggerPattern{XXX ç³»ç»Ÿ}</pattern>
    </layout>
</appender>
```

ä¸Šé¢ layout çš„ class æŒ‡å®šä¸ºä½ é‡å†™çš„ class,pattern ä¸­ç”¨ä½ è‡ªå·±å®šä¹‰çš„ pattern ååé¢å¤§æ‹¬å·æ˜¯å®šä¹‰äº§å“çº¿çš„

è¿™ä¸ªæ—¶å€™æ—¥å¿—å°±æ˜¯è¿™æ ·è¾“å‡ºçš„:

```
{"message":"[å¾®ä¿¡å…¬ä¼—å¸å·][å®šæ—¶åˆ·æ–° AccessToken çš„å®šæ—¶å™¨] redis ä¸­è·å–çš„ accessToken çš„è¿‡æœŸæ—¶é—´: 7200 ç§’","methodName":"refresh","className":"xxx.xxx.xxx.class","hostName":"pcname","time":"2016-09-02 14:40:00","leave":"INFO","line":"50","business":"xxxx ç³»ç»Ÿ","ip":"192.168.32.115"}
```

å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„ json äº†.

å½“ç„¶ä½ è§‰å¾—è¿™æ ·çš„æ—¥å¿—æ ¼å¼, ä½ çœ‹èµ·æ¥è¿˜ä¸èˆ’æœ, å¯ä»¥è‡ªå·±å»å®šä¹‰äº†.

## [æŒæ¡Log4jé…ç½®ï¼Œæ—¥å¿—ç®¡ç†æ›´é«˜æ•ˆï¼](https://blog.dong4j.site/posts/b533df62.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

```shell
###Â setÂ logÂ levelsÂ ###
log4j.rootLoggerÂ =Â debugÂ ,Â Â stdoutÂ ,Â Â DÂ ,Â Â E

###Â è¾“å‡ºåˆ°æ§åˆ¶å°Â ###
log4j.appender.stdoutÂ =Â org.apache.log4j.ConsoleAppender
log4j.appender.stdout.TargetÂ =Â System.out
log4j.appender.stdout.layoutÂ =Â org.apache.log4j.PatternLayout
log4j.appender.stdout.layout.ConversionPatternÂ =Â Â %d{ABSOLUTE}Â %5pÂ %c{Â 1Â }:%LÂ -Â %m%n

###Â è¾“å‡ºåˆ°æ—¥å¿—æ–‡ä»¶Â ###
log4j.appender.DÂ =Â org.apache.log4j.DailyRollingFileAppender
log4j.appender.D.FileÂ =Â logs/log.log
log4j.appender.D.AppendÂ =Â true
log4j.appender.D.ThresholdÂ =Â DEBUGÂ ##Â è¾“å‡ºDEBUGçº§åˆ«ä»¥ä¸Šçš„æ—¥å¿—
log4j.appender.D.layoutÂ =Â org.apache.log4j.PatternLayout
log4j.appender.D.layout.ConversionPatternÂ =Â %-d{yyyy-MM-ddÂ HH:mm:ss}Â Â [Â %t:%rÂ ]Â -Â [Â %pÂ ]Â Â %m%n

###Â ä¿å­˜å¼‚å¸¸ä¿¡æ¯åˆ°å•ç‹¬æ–‡ä»¶Â ###
log4j.appender.DÂ =Â org.apache.log4j.DailyRollingFileAppender
log4j.appender.D.FileÂ =Â logs/error.logÂ ##Â å¼‚å¸¸æ—¥å¿—æ–‡ä»¶å
log4j.appender.D.AppendÂ =Â true
log4j.appender.D.ThresholdÂ =Â ERRORÂ ##Â åªè¾“å‡ºERRORçº§åˆ«ä»¥ä¸Šçš„æ—¥å¿—!!!
log4j.appender.D.layoutÂ =Â org.apache.log4j.PatternLayout
log4j.appender.D.layout.ConversionPatternÂ =Â %-d{yyyy-MM-ddÂ HH:mm:ss}Â Â [Â %t:%rÂ ]Â -Â [Â %pÂ ]Â Â %m%n
```

## å‚æ•°æ„ä¹‰è¯´æ˜

### è¾“å‡ºçº§åˆ«çš„ç§ç±»

`ERRORã€WARNã€INFOã€DEBUG`

1. ERROR ä¸ºä¸¥é‡é”™è¯¯ ä¸»è¦æ˜¯ç¨‹åºçš„é”™è¯¯
2. WARN ä¸ºä¸€èˆ¬è­¦å‘Šï¼Œæ¯”å¦‚ session ä¸¢å¤±
3. INFO ä¸ºä¸€èˆ¬è¦æ˜¾ç¤ºçš„ä¿¡æ¯ï¼Œæ¯”å¦‚ç™»å½•ç™»å‡º
4. DEBUG ä¸ºç¨‹åºçš„è°ƒè¯•ä¿¡æ¯

### é…ç½®æ—¥å¿—ä¿¡æ¯è¾“å‡ºç›®çš„åœ°

`log4j.appender.appenderName = fully.qualified.name.of.appender.class`

1. org.apache.log4j.ConsoleAppenderï¼ˆæ§åˆ¶å°ï¼‰
2. org.apache.log4j.FileAppenderï¼ˆæ–‡ä»¶ï¼‰
3. org.apache.log4j.DailyRollingFileAppenderï¼ˆæ¯å¤©äº§ç”Ÿä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼‰
4. org.apache.log4j.RollingFileAppenderï¼ˆæ–‡ä»¶å¤§å°åˆ°è¾¾æŒ‡å®šå°ºå¯¸çš„æ—¶å€™äº§ç”Ÿä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼‰
5. org.apache.log4j.WriterAppenderï¼ˆå°†æ—¥å¿—ä¿¡æ¯ä»¥æµæ ¼å¼å‘é€åˆ°ä»»æ„æŒ‡å®šçš„åœ°æ–¹ï¼‰

### é…ç½®æ—¥å¿—ä¿¡æ¯çš„æ ¼å¼

`log4j.appender.appenderName.layout =fully.qualified.name.of.layout.class`

1. org.apache.log4j.HTMLLayoutï¼ˆä»¥ HTML è¡¨æ ¼å½¢å¼å¸ƒå±€ï¼‰ï¼Œ
2. org.apache.log4j.PatternLayoutï¼ˆå¯ä»¥çµæ´»åœ°æŒ‡å®šå¸ƒå±€æ¨¡å¼ï¼‰ï¼Œ
3. org.apache.log4j.SimpleLayoutï¼ˆåŒ…å«æ—¥å¿—ä¿¡æ¯çš„çº§åˆ«å’Œä¿¡æ¯å­—ç¬¦ä¸²ï¼‰ï¼Œ
4. org.apache.log4j.TTCCLayoutï¼ˆåŒ…å«æ—¥å¿—äº§ç”Ÿçš„æ—¶é—´ã€çº¿ç¨‹ã€ç±»åˆ«ç­‰ç­‰ä¿¡æ¯ï¼‰

### æ§åˆ¶å°é€‰é¡¹

Threshold=DEBUG: æŒ‡å®šæ—¥å¿—æ¶ˆæ¯çš„è¾“å‡ºæœ€ä½å±‚æ¬¡ã€‚  
ImmediateFlush=true: é»˜è®¤å€¼æ˜¯ true,æ„è°“ç€æ‰€æœ‰çš„æ¶ˆæ¯éƒ½ä¼šè¢«ç«‹å³è¾“å‡ºã€‚  
Target=System.err: é»˜è®¤æƒ…å†µä¸‹æ˜¯ï¼šSystem.out,æŒ‡å®šè¾“å‡ºæ§åˆ¶å°

#### FileAppender é€‰é¡¹

Threshold=DEBUF: æŒ‡å®šæ—¥å¿—æ¶ˆæ¯çš„è¾“å‡ºæœ€ä½å±‚æ¬¡ã€‚  
ImmediateFlush=true: é»˜è®¤å€¼æ˜¯ true,æ„è°“ç€æ‰€æœ‰çš„æ¶ˆæ¯éƒ½ä¼šè¢«ç«‹å³è¾“å‡ºã€‚  
File=mylog.txt: æŒ‡å®šæ¶ˆæ¯è¾“å‡ºåˆ° mylog.txt æ–‡ä»¶ã€‚  
Append=false: é»˜è®¤å€¼æ˜¯ true,å³å°†æ¶ˆæ¯å¢åŠ åˆ°æŒ‡å®šæ–‡ä»¶ä¸­ï¼Œfalse æŒ‡å°†æ¶ˆæ¯è¦†ç›–æŒ‡å®šçš„æ–‡ä»¶å†…å®¹ã€‚

#### RollingFileAppender é€‰é¡¹

Threshold=DEBUG: æŒ‡å®šæ—¥å¿—æ¶ˆæ¯çš„è¾“å‡ºæœ€ä½å±‚æ¬¡ã€‚  
ImmediateFlush=true: é»˜è®¤å€¼æ˜¯ true,æ„è°“ç€æ‰€æœ‰çš„æ¶ˆæ¯éƒ½ä¼šè¢«ç«‹å³è¾“å‡ºã€‚  
File=mylog.txt: æŒ‡å®šæ¶ˆæ¯è¾“å‡ºåˆ° mylog.txt æ–‡ä»¶ã€‚  
Append=false: é»˜è®¤å€¼æ˜¯ true,å³å°†æ¶ˆæ¯å¢åŠ åˆ°æŒ‡å®šæ–‡ä»¶ä¸­ï¼Œfalse æŒ‡å°†æ¶ˆæ¯è¦†ç›–æŒ‡å®šçš„æ–‡ä»¶å†…å®¹ã€‚  
MaxFileSize=100KB: åç¼€å¯ä»¥æ˜¯ KB, MB æˆ–è€…æ˜¯ GB. åœ¨æ—¥å¿—æ–‡ä»¶åˆ°è¾¾è¯¥å¤§å°æ—¶ï¼Œå°†ä¼šè‡ªåŠ¨æ»šåŠ¨ï¼Œå³å°†åŸæ¥çš„å†…å®¹ç§»åˆ° mylog.log.1 æ–‡ä»¶ã€‚  
MaxBackupIndex=2: æŒ‡å®šå¯ä»¥äº§ç”Ÿçš„æ»šåŠ¨æ–‡ä»¶çš„æœ€å¤§æ•°ã€‚

`log4j.appender.A1.layout.ConversionPattern=%-4r %-5p %d{yyyy-MM-dd HH:mm:ssS} %c %m%n`

### æ—¥å¿—ä¿¡æ¯æ ¼å¼ä¸­å‡ ä¸ªç¬¦å·æ‰€ä»£è¡¨çš„å«ä¹‰ï¼š

-X å·: X ä¿¡æ¯è¾“å‡ºæ—¶å·¦å¯¹é½ï¼›  
%p: è¾“å‡ºæ—¥å¿—ä¿¡æ¯ä¼˜å…ˆçº§ï¼Œå³ DEBUGï¼ŒINFOï¼ŒWARNï¼ŒERRORï¼ŒFATAL,  
%d: è¾“å‡ºæ—¥å¿—æ—¶é—´ç‚¹çš„æ—¥æœŸæˆ–æ—¶é—´ï¼Œé»˜è®¤æ ¼å¼ä¸º ISO8601ï¼Œä¹Ÿå¯ä»¥åœ¨å…¶åæŒ‡å®šæ ¼å¼ï¼Œæ¯”å¦‚ï¼š%d{yyy MMM dd HH:mm:ss,SSS}ï¼Œè¾“å‡ºç±»ä¼¼ï¼š2002 å¹´ 10 æœˆ 18 æ—¥ 22ï¼š10ï¼š28ï¼Œ921  
%r: è¾“å‡ºè‡ªåº”ç”¨å¯åŠ¨åˆ°è¾“å‡ºè¯¥ log ä¿¡æ¯è€—è´¹çš„æ¯«ç§’æ•°  
%c: è¾“å‡ºæ—¥å¿—ä¿¡æ¯æ‰€å±çš„ç±»ç›®ï¼Œé€šå¸¸å°±æ˜¯æ‰€åœ¨ç±»çš„å…¨å  
%t: è¾“å‡ºäº§ç”Ÿè¯¥æ—¥å¿—äº‹ä»¶çš„çº¿ç¨‹å  
%l: è¾“å‡ºæ—¥å¿—äº‹ä»¶çš„å‘ç”Ÿä½ç½®ï¼Œç›¸å½“äº%C.%M(%F:%L) çš„ç»„åˆ,åŒ…æ‹¬ç±»ç›®åã€å‘ç”Ÿçš„çº¿ç¨‹ï¼Œä»¥åŠåœ¨ä»£ç ä¸­çš„è¡Œæ•°ã€‚ä¸¾ä¾‹ï¼šTestlog4.main (TestLog4.java:10)  
%x: è¾“å‡ºå’Œå½“å‰çº¿ç¨‹ç›¸å…³è”çš„ NDC(åµŒå¥—è¯Šæ–­ç¯å¢ƒ),å°¤å…¶ç”¨åˆ°åƒ java servlets è¿™æ ·çš„å¤šå®¢æˆ·å¤šçº¿ç¨‹çš„åº”ç”¨ä¸­ã€‚  
%%: è¾“å‡ºä¸€ä¸ª "%" å­—ç¬¦  
%F: è¾“å‡ºæ—¥å¿—æ¶ˆæ¯äº§ç”Ÿæ—¶æ‰€åœ¨çš„æ–‡ä»¶åç§°  
%L: è¾“å‡ºä»£ç ä¸­çš„è¡Œå·  
%m: è¾“å‡ºä»£ç ä¸­æŒ‡å®šçš„æ¶ˆæ¯,äº§ç”Ÿçš„æ—¥å¿—å…·ä½“ä¿¡æ¯  
%n: è¾“å‡ºä¸€ä¸ªå›è½¦æ¢è¡Œç¬¦ï¼ŒWindows å¹³å°ä¸º "/r/n"ï¼ŒUnix å¹³å°ä¸º "/n" è¾“å‡ºæ—¥å¿—ä¿¡æ¯æ¢è¡Œ

å¯ä»¥åœ¨% ä¸æ¨¡å¼å­—ç¬¦ä¹‹é—´åŠ ä¸Šä¿®é¥°ç¬¦æ¥æ§åˆ¶å…¶æœ€å°å®½åº¦ã€æœ€å¤§å®½åº¦ã€å’Œæ–‡æœ¬çš„å¯¹é½æ–¹å¼ã€‚å¦‚ï¼š

1. %20cï¼šæŒ‡å®šè¾“å‡º category çš„åç§°ï¼Œæœ€å°çš„å®½åº¦æ˜¯ 20ï¼Œå¦‚æœ category çš„åç§°å°äº 20 çš„è¯ï¼Œé»˜è®¤çš„æƒ…å†µä¸‹å³å¯¹é½ã€‚
2. %-20c: æŒ‡å®šè¾“å‡º category çš„åç§°ï¼Œæœ€å°çš„å®½åº¦æ˜¯ 20ï¼Œå¦‚æœ category çš„åç§°å°äº 20 çš„è¯ï¼Œ"-" å·æŒ‡å®šå·¦å¯¹é½ã€‚
3. %.30c: æŒ‡å®šè¾“å‡º category çš„åç§°ï¼Œæœ€å¤§çš„å®½åº¦æ˜¯ 30ï¼Œå¦‚æœ category çš„åç§°å¤§äº 30 çš„è¯ï¼Œå°±ä¼šå°†å·¦è¾¹å¤šå‡ºçš„å­—ç¬¦æˆªæ‰ï¼Œä½†å°äº 30 çš„è¯ä¹Ÿä¸ä¼šæœ‰ç©ºæ ¼ã€‚
4. %20.30c: å¦‚æœ category çš„åç§°å°äº 20 å°±è¡¥ç©ºæ ¼ï¼Œå¹¶ä¸”å³å¯¹é½ï¼Œå¦‚æœå…¶åç§°é•¿äº 30 å­—ç¬¦ï¼Œå°±ä»å·¦è¾¹è¾ƒè¿œè¾“å‡ºçš„å­—ç¬¦æˆªæ‰ã€‚

## æ–‡ä»¶é…ç½® Sample1

```shell
log4j.rootLogger=DEBUG,A1,R
# ConsoleAppender è¾“å‡º
log4j.appender.A1=org.apache.log4j.ConsoleAppender
log4j.appender.A1.layout=org.apache.log4j.PatternLayout
log4j.appender.A1.layout.ConversionPattern=%-d{yyyy-MM-dd HH:mm:ss,SSS} [%c]-[%p] %m%n
# File è¾“å‡º ä¸€å¤©ä¸€ä¸ªæ–‡ä»¶,è¾“å‡ºè·¯å¾„å¯ä»¥å®šåˆ¶,ä¸€èˆ¬åœ¨æ ¹è·¯å¾„ä¸‹
log4j.appender.R=org.apache.log4j.DailyRollingFileAppender
log4j.appender.R.File=blog_log.txt
log4j.appender.R.MaxFileSize=500KB
log4j.appender.R.MaxBackupIndex=10
log4j.appender.R.layout=org.apache.log4j.PatternLayout
log4j.appender.R.layout.ConversionPattern=%d{yyyy-MM-dd HH:mm:ss,SSS} [%t] [%c] [%p] - %m%n
```

## æ–‡ä»¶é…ç½® Sample2

```shell
ä¸‹é¢ç»™å‡ºçš„Log4Jé…ç½®æ–‡ä»¶å®ç°äº†è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œæ–‡ä»¶ï¼Œå›æ»šæ–‡ä»¶ï¼Œå‘é€æ—¥å¿—é‚®ä»¶ï¼Œè¾“å‡ºåˆ°æ•°æ®åº“æ—¥å¿—è¡¨ï¼Œè‡ªå®šä¹‰æ ‡ç­¾ç­‰å…¨å¥—åŠŸèƒ½ã€‚
log4j.rootLogger=DEBUG,CONSOLE,A1,im
#DEBUG,CONSOLE,FILE,ROLLING_FILE,MAIL,DATABASE
log4j.addivity.org.apache=true
###################
# Console Appender
###################
log4j.appender.CONSOLE=org.apache.log4j.ConsoleAppender
log4j.appender.Threshold=DEBUG
log4j.appender.CONSOLE.Target=System.out
log4j.appender.CONSOLE.layout=org.apache.log4j.PatternLayout
log4j.appender.CONSOLE.layout.ConversionPattern=[framework] %d - %c -%-4r [%t] %-5p %c %x - %m%n
#log4j.appender.CONSOLE.layout.ConversionPattern=[start]%d{DATE}[DATE]%n%p[PRIORITY]%n%x[NDC]%n%t[THREAD] n%c[CATEGORY]%n%m[MESSAGE]%n%n
#####################
# File Appender
#####################
log4j.appender.FILE=org.apache.log4j.FileAppender
log4j.appender.FILE.File=file.log
log4j.appender.FILE.Append=false
log4j.appender.FILE.layout=org.apache.log4j.PatternLayout
log4j.appender.FILE.layout.ConversionPattern=[framework] %d - %c -%-4r [%t] %-5p %c %x - %m%n
# Use this layout for LogFactor 5 analysis
########################
# Rolling File
########################
log4j.appender.ROLLING_FILE=org.apache.log4j.RollingFileAppender
log4j.appender.ROLLING_FILE.Threshold=ERROR
log4j.appender.ROLLING_FILE.File=rolling.log
log4j.appender.ROLLING_FILE.Append=true
log4j.appender.ROLLING_FILE.MaxFileSize=10KB
log4j.appender.ROLLING_FILE.MaxBackupIndex=1
log4j.appender.ROLLING_FILE.layout=org.apache.log4j.PatternLayout
log4j.appender.ROLLING_FILE.layout.ConversionPattern=[framework] %d - %c -%-4r [%t] %-5p %c %x - %m%n
####################
# Socket Appender
####################
log4j.appender.SOCKET=org.apache.log4j.RollingFileAppender
log4j.appender.SOCKET.RemoteHost=localhost
log4j.appender.SOCKET.Port=5001
log4j.appender.SOCKET.LocationInfo=true
# Set up for Log Facter 5
log4j.appender.SOCKET.layout=org.apache.log4j.PatternLayout
log4j.appender.SOCET.layout.ConversionPattern=[start]%d{DATE}[DATE]%n%p[PRIORITY]%n%x[NDC]%n%t[THREAD]%n%c[CATEGORY]%n%m[MESSAGE]%n%n
########################
# Log Factor 5 Appender
########################
log4j.appender.LF5_APPENDER=org.apache.log4j.lf5.LF5Appender
log4j.appender.LF5_APPENDER.MaxNumberOfRecords=2000
########################
# SMTP Appender
#######################
log4j.appender.MAIL=org.apache.log4j.net.SMTPAppender
log4j.appender.MAIL.Threshold=FATAL
log4j.appender.MAIL.BufferSize=10
log4j.appender.MAIL.From=chenyl@yeqiangwei.com
log4j.appender.MAIL.SMTPHost=mail.hollycrm.com
log4j.appender.MAIL.Subject=Log4J Message
log4j.appender.MAIL.To=chenyl@yeqiangwei.com
log4j.appender.MAIL.layout=org.apache.log4j.PatternLayout
log4j.appender.MAIL.layout.ConversionPattern=[framework] %d - %c -%-4r [%t] %-5p %c %x - %m%n
########################
# JDBC Appender
#######################
log4j.appender.DATABASE=org.apache.log4j.jdbc.JDBCAppender
log4j.appender.DATABASE.URL=jdbc:mysql://localhost:3306/test
log4j.appender.DATABASE.driver=com.mysql.jdbc.Driver
log4j.appender.DATABASE.user=root
log4j.appender.DATABASE.password=
log4j.appender.DATABASE.sql=INSERT INTO LOG4J (Message) VALUES ('[framework] %d - %c -%-4r [%t] %-5p %c %x - %m%n')
log4j.appender.DATABASE.layout=org.apache.log4j.PatternLayout
log4j.appender.DATABASE.layout.ConversionPattern=[framework] %d - %c -%-4r [%t] %-5p %c %x - %m%n
log4j.appender.A1=org.apache.log4j.DailyRollingFileAppender
log4j.appender.A1.File=SampleMessages.log4j
log4j.appender.A1.DatePattern=yyyyMMdd-HH'.log4j'
log4j.appender.A1.layout=org.apache.log4j.xml.XMLLayout
###################
#è‡ªå®šä¹‰Appender
###################
log4j.appender.im = net.cybercorlin.util.logger.appender.IMAppender
log4j.appender.im.host = mail.cybercorlin.net
log4j.appender.im.username = username
log4j.appender.im.password = password
log4j.appender.im.recipient = corlin@yeqiangwei.com
log4j.appender.im.layout=org.apache.log4j.PatternLayout
log4j.appender.im.layout.ConversionPattern =[framework] %d - %c -%-4r [%t] %-5p %c %x - %m%n
```

### é«˜çº§ä½¿ç”¨

å®éªŒç›®çš„ï¼š

1.  æŠŠ FATAL çº§é”™è¯¯å†™å…¥ 2000NT æ—¥å¿—
2.  WARNï¼ŒERRORï¼ŒFATAL çº§é”™è¯¯å‘é€ email é€šçŸ¥ç®¡ç†å‘˜  
    3.å…¶ä»–çº§åˆ«çš„é”™è¯¯ç›´æ¥åœ¨åå°è¾“å‡º

å®éªŒæ­¥éª¤ï¼š

è¾“å‡ºåˆ° 2000NT æ—¥å¿—

1.  æŠŠ Log4j å‹ç¼©åŒ…é‡Œçš„ NTEventLogAppender.dll æ‹·åˆ° WINNT/SYSTEM32 ç›®å½•ä¸‹
2.  å†™é…ç½®æ–‡ä»¶ log4j.properties

```shell
# åœ¨2000ç³»ç»Ÿæ—¥å¿—è¾“å‡º
log4j.logger.NTlog=FATAL, A8
# APPENDER A8
log4j.appender.A8=org.apache.log4j.nt.NTEventLogAppender
log4j.appender.A8.Source=JavaTest
log4j.appender.A8.layout=org.apache.log4j.PatternLayout
log4j.appender.A8.layout.ConversionPattern=%-4r %-5p [%t] %37c %3x - %m%n
```

3.è°ƒç”¨ä»£ç ï¼š

```shell
Logger logger2 = Logger.getLogger("NTlog"); //è¦å’Œé…ç½®æ–‡ä»¶ä¸­è®¾ç½®çš„åå­—ç›¸åŒ
logger2.debug("debug!!!");
logger2.info("info!!!");
logger2.warn("warn!!!");
logger2.error("error!!!");
//åªæœ‰è¿™ä¸ªé”™è¯¯æ‰ä¼šå†™å…¥2000æ—¥å¿—
logger2.fatal("fatal!!!");
```

### å‘é€ email é€šçŸ¥ç®¡ç†å‘˜

```java
// 1. é¦–å…ˆä¸‹è½½JavaMailå’ŒJAF,
http://java.sun.com/j2ee/ja/javamail/index.html
http://java.sun.com/beans/glasgow/jaf.html
åœ¨é¡¹ç›®ä¸­å¼•ç”¨mail.jarå’Œactivation.jarã€‚

// 2. å†™é…ç½®æ–‡ä»¶
# å°†æ—¥å¿—å‘é€åˆ°email
log4j.logger.MailLog=WARN,A5
#  APPENDER A5
log4j.appender.A5=org.apache.log4j.net.SMTPAppender
log4j.appender.A5.BufferSize=5
log4j.appender.A5.To=chunjie@yeqiangwei.com
log4j.appender.A5.From=error@yeqiangwei.com
log4j.appender.A5.Subject=ErrorLog
log4j.appender.A5.SMTPHost=smtp.263.net
log4j.appender.A5.layout=org.apache.log4j.PatternLayout
log4j.appender.A5.layout.ConversionPattern=%-4r %-5p [%t] %37c %3x - %m%n

// 3.è°ƒç”¨ä»£ç ï¼šæŠŠæ—¥å¿—å‘é€åˆ°mail
Logger logger3 = Logger.getLogger("MailLog");
logger3.warn("warn!!!");
logger3.error("error!!!");
logger3.fatal("fatal!!!");
```

### åœ¨åå°è¾“å‡ºæ‰€æœ‰ç±»åˆ«çš„é”™è¯¯

```java
1. å†™é…ç½®æ–‡ä»¶
# åœ¨åå°è¾“å‡º
log4j.logger.console=DEBUG, A1
# APPENDER A1
log4j.appender.A1=org.apache.log4j.ConsoleAppender
log4j.appender.A1.layout=org.apache.log4j.PatternLayout
log4j.appender.A1.layout.ConversionPattern=%-4r %-5p [%t] %37c %3x - %m%n
2ï¼è°ƒç”¨ä»£ç 
Logger logger1 = Logger.getLogger("console");
logger1.debug("debug!!!");
logger1.info("info!!!");
logger1.warn("warn!!!");
logger1.error("error!!!");
logger1.fatal("fatal!!!");
```

å…¨éƒ¨é…ç½®æ–‡ä»¶ï¼šlog4j.properties

```shell
# åœ¨åå°è¾“å‡º
log4j.logger.console=DEBUG, A1
# APPENDER A1
log4j.appender.A1=org.apache.log4j.ConsoleAppender
log4j.appender.A1.layout=org.apache.log4j.PatternLayout
log4j.appender.A1.layout.ConversionPattern=%-4r %-5p [%t] %37c %3x - %m%n
# åœ¨2000ç³»ç»Ÿæ—¥å¿—è¾“å‡º
log4j.logger.NTlog=FATAL, A8
# APPENDER A8
log4j.appender.A8=org.apache.log4j.nt.NTEventLogAppender
log4j.appender.A8.Source=JavaTest
log4j.appender.A8.layout=org.apache.log4j.PatternLayout
log4j.appender.A8.layout.ConversionPattern=%-4r %-5p [%t] %37c %3x - %m%n
# å°†æ—¥å¿—å‘é€åˆ°email
log4j.logger.MailLog=WARN,A5
#  APPENDER A5
log4j.appender.A5=org.apache.log4j.net.SMTPAppender
log4j.appender.A5.BufferSize=5
log4j.appender.A5.To=chunjie@yeqiangwei.com
log4j.appender.A5.From=error@yeqiangwei.com
log4j.appender.A5.Subject=ErrorLog
log4j.appender.A5.SMTPHost=smtp.263.net
log4j.appender.A5.layout=org.apache.log4j.PatternLayout
log4j.appender.A5.layout.ConversionPattern=%-4r %-5p [%t] %37c %3x - %m%n
```

### å…¨éƒ¨ä»£ç ï¼šLog4jTest.java

```java
public class Log4jTest {
    public static void main(String args[]) {
        PropertyConfigurator.configure("log4j.properties");
        //åœ¨åå°è¾“å‡º
        Logger logger1 = Logger.getLogger("console");
        logger1.debug("debug!!!");
        logger1.info("info!!!");
        logger1.warn("warn!!!");
        logger1.error("error!!!");
        logger1.fatal("fatal!!!");
        //åœ¨NTç³»ç»Ÿæ—¥å¿—è¾“å‡º
        Logger logger2 = Logger.getLogger("NTlog");
        //NTEventLogAppender nla = new NTEventLogAppender();
        logger2.debug("debug!!!");
        logger2.info("info!!!");
        logger2.warn("warn!!!");
        logger2.error("error!!!");
        //åªæœ‰è¿™ä¸ªé”™è¯¯æ‰ä¼šå†™å…¥2000æ—¥å¿—
        logger2.fatal("fatal!!!");
        //æŠŠæ—¥å¿—å‘é€åˆ°mail
        Logger logger3 = Logger.getLogger("MailLog");
        //SMTPAppender sa = new SMTPAppender();
        logger3.warn("warn!!!");
        logger3.error("error!!!");
        logger3.fatal("fatal!!!");
    }
}
```

å†™åœ¨æœåŠ¡å™¨è·¯å¾„çš„é…ç½®å¦‚ä¸‹:

```
log4j.logger.iplog= INFO, infoFile6
log4j.appender.infoFile6=org.apache.log4j.FileAppender
log4j.appender.infoFile6.File=${catalina.base}/logs/ipFilter.log
log4j.appender.infoFile6.layout=org.apache.log4j.PatternLayout
log4j.appender.infoFile6.layout.ConversionPattern=%m %d{yyyy-MM-dd HH:mm:ss} %n
log4j.appender.infoFile6.encoding=UTF-8
```

## [è½»æ¾æŒæ¡Javaæ•°æ®åº“æ“ä½œï¼šJDBCå…¥é—¨](https://blog.dong4j.site/posts/5a428776.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

åœ¨ Java ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ JDBCï¼ˆJava Database Connectivityï¼‰æ¥è¿æ¥ã€æŸ¥è¯¢å’Œæ“ä½œå…³ç³»å‹æ•°æ®åº“ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªè¯¦ç»†çš„æŒ‡å—ï¼Œå±•ç¤ºå¦‚ä½•è¿›è¡ŒåŸºæœ¬çš„æ•°æ®åº“æ“ä½œï¼ŒåŒ…æ‹¬è¿æ¥åˆ° MySQL æœåŠ¡å™¨ã€æ‰§è¡Œ SQL è¯­å¥ä»¥åŠé¢„å¤„ç†æ•°æ®ã€‚

## æ•°æ®åº“æ“ä½œçš„åŸºæœ¬æ­¥éª¤ï¼š

### 1. å¯¼å…¥å¿…è¦çš„åŒ…

```java
import java.sql.*;
```

### 2. å®šä¹‰ä¸€ä¸ªä¸»ç±»æ¥åˆå§‹åŒ–å’Œæµ‹è¯•æ•°æ®åº“æ“ä½œ

#### åŸºæœ¬çš„æ•°æ®åº“è¿æ¥ä¸æŸ¥è¯¢ï¼š

é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€äº›åŸºæœ¬çš„å˜é‡ç”¨äºå­˜å‚¨æ•°æ®åº“çš„ä¿¡æ¯ã€‚

```java
public class DataBasePractice {

    public static void main(String[] args) {
        Connection con = null;

        // MySQLé©±åŠ¨ç¨‹åºå
        String driver = "com.mysql.jdbc.Driver";
        // æ•°æ®åº“URL
        String url = "jdbc:mysql://localhost:3306/mydata";
        // ç”¨æˆ·åå’Œå¯†ç 
        String user = "root";
        String password = "root";

        try {
            Class.forName(driver);

            con = DriverManager.getConnection(url, user, password);
            if (!con.isClosed()) System.out.println("Succeeded connecting to the Database!");

            Statement statement = con.createStatement();

            // SQLæŸ¥è¯¢è¯­å¥
            ResultSet rs = statement.executeQuery("select * from student");

            String name, id;
            while(rs.next()){
                name = rs.getString("stuname").trim();
                id = rs.getString("stuid").trim();

                // å­—ç¬¦é›†è½¬æ¢ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
                name = new String(name.getBytes("ISO-8859-1"), "gb2312");

                System.out.println(id + "\t" + name);
            }
        } catch (ClassNotFoundException e) {
            System.out.println("Sorry, can't find the Driver!");
            e.printStackTrace();
        } catch (SQLException e) {
            // æ•°æ®åº“è¿æ¥å¤±è´¥å¼‚å¸¸å¤„ç†
            e.printStackTrace();
        } finally{
            try{
                if(con != null)
                    con.close();
            }catch(SQLException se){
                se.printStackTrace();
            }

            System.out.println("æ•°æ®åº“æ•°æ®æˆåŠŸè·å–ï¼ï¼");
        }

    }
}
```

### 3. ä½¿ç”¨`PreparedStatement`è¿›è¡Œé¢„å¤„ç†æ“ä½œ

#### æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤æ•°æ®ï¼š

```java
// å‡è®¾åœ¨ä¸»ç±»ä¸­å·²ç»æœ‰äº†ä¸€ä¸ªConnection conå¯¹è±¡ã€‚
try {
    // æ’å…¥æ–°è®°å½•åˆ°studentè¡¨
    PreparedStatement psql = con.prepareStatement("insert into student values(?,?)");
    psql.setInt(1, 8);
    psql.setString(2, "xiaogang");
    psql.executeUpdate();

    // æ›´æ–°æ•°æ®
    psql = con.prepareStatement("update student set stuname = ? where stuid = ?");
    psql.setString(1,"xiaowang");
    psql.setInt(2, 10);
    psql.executeUpdate();

    // åˆ é™¤è®°å½•
    psql = con.prepareStatement("delete from student where stuid = ?");
    psql.setInt(1, 5);
    psql.executeUpdate();

    System.out.println("æ‰§è¡Œå¢åŠ ã€ä¿®æ”¹ã€åˆ é™¤åçš„æ•°æ®");
    res = psql.executeQuery();
    while(res.next()){
        name = res.getString("stuname").trim();
        id = res.getString("stuid").trim();

        // å­—ç¬¦é›†è½¬æ¢ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
        name = new String(name.getBytes("ISO-8859-1"), "gb2312");

        System.out.println(id + "\t" + name);
    }
} catch (SQLException e) {
    e.printStackTrace();
}
```

## ç¯å¢ƒå‡†å¤‡

### æ•°æ®åº“é…ç½®å±æ€§æ–‡ä»¶`db.properties`

è¯¥é…ç½®æ–‡ä»¶ä¸­åŒ…å«å¿…è¦çš„æ•°æ®åº“è¿æ¥å‚æ•°ï¼Œå¦‚é©±åŠ¨åç§°ã€URL åœ°å€ç­‰ã€‚

```properties
# Oracle è¿æ¥ä¿¡æ¯
driver=oracle.jdbc.driver.OracleDriver
url=jdbc:oracle:thin:@localhost:1521:vill
username=vill
password=villvill

# MySQL è¿æ¥ä¿¡æ¯ï¼ˆæ³¨é‡ŠçŠ¶æ€ï¼‰
# driver=com.mysql.cj.jdbc.Driver # ä½¿ç”¨æœ€æ–°MySQLé©±åŠ¨ç‰ˆæœ¬
# url=jdbc:mysql://localhost:3306/vill?useSSL=false&serverTimezone=UTC
# username=root
# password=root
```

### å®ç”¨å·¥å…·ç±»`DBUtil.java`

è¯¥ç±»æä¾›äº†ä¸€ä¸ªé™æ€çš„æ•°æ®åº“è¿æ¥è·å–æ–¹æ³•ï¼Œå¹¶åœ¨ç¨‹åºç»“æŸæ—¶å…³é—­æ‰€æœ‰æ•°æ®åº“ç›¸å…³èµ„æºï¼ˆå¦‚è¿æ¥ã€è¯­å¥ç­‰ï¼‰ã€‚

```java
import java.io.IOException;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.Statement;
import java.util.Properties;

/**
 * æ•°æ®åº“æ“ä½œå·¥å…·ç±»ï¼Œå°è£…äº†åˆ›å»ºå’Œé‡Šæ”¾æ•°æ®åº“è¿æ¥çš„é€»è¾‘ã€‚
 */
public class DBUtil {

    // é™æ€å˜é‡ç”¨äºä¿å­˜ä»é…ç½®æ–‡ä»¶è¯»å–åˆ°çš„æ•°æ®
    private static String driver, url, user, pwd;

    // ä½¿ç”¨é™æ€å—åˆå§‹åŒ–è¿™äº›å˜é‡
    static {
        try {
            Properties properties = new Properties();
            properties.load(DBUtil.class.getClassLoader().getResourceAsStream("vill/util/db.properties")); // åŠ è½½èµ„æºè·¯å¾„ä¸‹çš„å±æ€§æ–‡ä»¶
            driver = properties.getProperty("driver");
            url = properties.getProperty("url");
            user = properties.getProperty("username"); // è¯»å–é…ç½®çš„ç”¨æˆ·åå’Œå¯†ç ä¿¡æ¯
            pwd = properties.getProperty("password");
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    /**
     * è·å–ä¸æ•°æ®åº“å»ºç«‹çš„è¿æ¥ã€‚
     *
     * @return æ•°æ®åº“è¿æ¥å¯¹è±¡ï¼Œå¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™è¿”å›nullã€‚
     */
    public static Connection getConnection() throws Exception{
        Class.forName(driver); // åŠ¨æ€åŠ è½½é©±åŠ¨
        return DriverManager.getConnection(url, user, pwd);
    }

    /**
     * å…³é—­æ‰€æœ‰ä¸æ•°æ®åº“ç›¸å…³çš„èµ„æºï¼šåŒ…æ‹¬ç»“æœé›†ã€è¯­å¥å’Œè¿æ¥ç­‰ã€‚
     *
     * @param conn æ•°æ®åº“è¿æ¥å¯¹è±¡
     * @param stm  SQLæ‰§è¡Œè¯­å¥å¯¹è±¡
     * @param rs   æŸ¥è¯¢ç»“æœé›†å¯¹è±¡
     */
    public static void closeConnection(Connection conn, Statement stm, ResultSet rs) {
        try {
            if (conn != null)
                conn.close();
            if (stm != null)
                stm.close();
            if (rs != null)
                rs.close();
        } catch (Exception e) {
            // æ•è·å¼‚å¸¸ï¼Œé˜²æ­¢èµ„æºé‡Šæ”¾è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ä¸­æ–­ç¨‹åºè¿è¡Œ
            e.printStackTrace();
        }
    }

    public static void main(String[] args) {
        try {
            System.out.println(new DBUtil().getConnection().getClass().getName());
        } catch (Exception e) {
            e.printStackTrace();  // è¾“å‡ºå¼‚å¸¸ä¿¡æ¯ä»¥ä¾¿è°ƒè¯•
        }
    }
}
```

### å®ç°è§£æ

1. **é…ç½®æ–‡ä»¶è¯»å–**
   - åˆ©ç”¨`Properties`ç±»ä»èµ„æºè·¯å¾„ä¸­åŠ è½½å¹¶è§£æ`.properties`æ ¼å¼çš„å±æ€§æ–‡ä»¶ï¼Œä»è€Œå¾—åˆ°æ•°æ®åº“è¿æ¥æ‰€éœ€çš„é©±åŠ¨å’Œ URL ç­‰å‚æ•°ã€‚
2. **æ•°æ®åº“è¿æ¥è·å–æ–¹æ³•**
   - `getConnection()`ï¼šé¦–å…ˆé€šè¿‡åå°„æœºåˆ¶åŠ¨æ€åœ°æ³¨å†Œæ•°æ®åº“é©±åŠ¨ï¼ˆå¦‚ Oracle æˆ– MySQLï¼‰ï¼Œç„¶åä½¿ç”¨è¿™äº›é…ç½®ä¿¡æ¯å»ºç«‹ä¸æ•°æ®åº“çš„å®é™…è¿æ¥ã€‚
3. **èµ„æºç®¡ç†**
   - ä¸ºäº†é˜²æ­¢å†…å­˜æ³„æ¼ï¼Œ`closeConnection()`æä¾›äº†å…³é—­æ•°æ®åº“æ“ä½œè¿‡ç¨‹ä¸­å¯èƒ½æ‰“å¼€çš„å¤šç§ç±»å‹å¯¹è±¡çš„åŠŸèƒ½ã€‚è¿™åŒ…æ‹¬ä½†ä¸é™äº`ResultSet`, `Statement`ä»¥åŠæœ€åæ˜¯`Connection`æœ¬èº«ã€‚
4. **å¼‚å¸¸å¤„ç†**
   - åœ¨`getConnection()`å’Œ`closeConnection()`æ–¹æ³•ä¸­å‡å­˜åœ¨æ•è·å¹¶æ‰“å°é”™è¯¯ä¿¡æ¯çš„æœºåˆ¶ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿å³ä½¿åœ¨èµ„æºé‡Šæ”¾å¤±è´¥çš„æƒ…å†µä¸‹ï¼Œç¨‹åºä¹Ÿèƒ½ç»§ç»­æ‰§è¡Œï¼Œå¹¶ä¸”å¼€å‘è€…èƒ½æ˜ç¡®çœ‹åˆ°é—®é¢˜å‘ç”Ÿçš„ä½ç½®ã€‚

### æ³¨æ„äº‹é¡¹

- ç¡®ä¿ä½ çš„é¡¹ç›®åŒ…å«äº†æ‰€ä½¿ç”¨çš„ JDBC é©±åŠ¨åº“ï¼ˆä¾‹å¦‚ Oracle æˆ– MySQL çš„ JDBC jar æ–‡ä»¶ï¼‰ã€‚
- é…ç½®æ–‡ä»¶`db.properties`åº”æ”¾ç½®äºé¡¹ç›®çš„ç±»è·¯å¾„ä¸­ï¼Œä»¥ä¾¿é€šè¿‡`ClassLoader.getResourceAsStream()`æ­£ç¡®åŠ è½½ã€‚
- å»ºè®®ä½¿ç”¨ try-with-resources è¯­å¥æ¥ç®€åŒ–èµ„æºç®¡ç†å’Œå¼‚å¸¸å¤„ç†é€»è¾‘ã€‚

## [æ·±å…¥æµ…å‡ºï¼šJavaæ—¥å¿—ç³»ç»Ÿçš„æ¼”å˜](https://blog.dong4j.site/posts/10ce2820.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## Logging System

[Log4j](http://logging.apache.org/log4j/)

è¾ƒæ—©å‡ºç°çš„æ¯”è¾ƒæˆåŠŸçš„æ—¥å¿—ç³»ç»Ÿæ˜¯ Log4j.
Log4j å¼€åˆ›çš„æ—¥å¿—ç³»ç»Ÿæ¨¡å‹ï¼ˆLogger/Appender/Levelï¼‰è¡Œä¹‹æœ‰æ•ˆ, å¹¶ä¸€ç›´å»¶ç”¨è‡³ä»Š.

[JUL](http://download.oracle.com/javase/6/docs/technotes/guides/logging/overview.html)

JDK1.4 æ˜¯ç¬¬ä¸€ä¸ªè‡ªå¸¦æ—¥å¿—ç³»ç»Ÿçš„ JDK, ç®€ç§°ï¼ˆJULï¼‰.
JUL å¹¶æ²¡æœ‰æ˜æ˜¾çš„ä¼˜åŠ¿æ¥æˆ˜èƒœ Log4j, åè€Œé€ æˆäº†æ ‡å‡†çš„æ··ä¹± â€”â€” é‡‡ç”¨ä¸åŒæ—¥å¿—ç³»ç»Ÿçš„åº”ç”¨ç¨‹åºæ— æ³•å’Œè°å…±å­˜.

[Logback](http://logback.qos.ch/)
æ˜¯è¾ƒæ–°çš„æ—¥å¿—ç³»ç»Ÿ.
å®ƒæ˜¯ Log4j çš„ä½œè€…å¸å–å¤šå¹´çš„ç»éªŒæ•™è®­ä»¥åé‡æ–°åšå‡ºçš„ä¸€å¥—ç³»ç»Ÿ. å®ƒçš„ä½¿ç”¨æ›´æ–¹ä¾¿, åŠŸèƒ½æ›´å¼º, è€Œä¸”æ€§èƒ½ä¹Ÿæ›´é«˜.
Logback ä¸èƒ½å•ç‹¬ä½¿ç”¨, å¿…é¡»é…åˆæ—¥å¿—æ¡†æ¶ SLF4J æ¥ä½¿ç”¨.

## Logging Framework

[JCL (Jakarta Commons Logging)](http://commons.apache.org/logging/)

è¿™æ˜¯ç›®å‰æœ€æµè¡Œçš„ä¸€ä¸ªæ—¥å¿—æ¡†æ¶, ç”± Apache Jakarta ç¤¾åŒºæä¾›.
Spring æ¡†æ¶ã€è®¸å¤šè€åº”ç”¨éƒ½ä¾èµ–äº JCL.

[SLF4J](http://www.slf4j.org/)

è¿™æ˜¯ä¸€ä¸ªæœ€æ–°çš„æ—¥å¿—æ¡†æ¶, ç”± Log4j çš„ä½œè€…æ¨å‡º.
SLF4J æä¾›äº†æ–°çš„ API, ç‰¹åˆ«ç”¨æ¥é…åˆ Logback çš„æ–°åŠŸèƒ½. ä½† SLF4J åŒæ ·å…¼å®¹ Log4j.
(å…¨ç§°æ˜¯ Simple Loging Facade For Java) æ˜¯ä¸€ä¸ªä¸º Java ç¨‹åºæä¾›æ—¥å¿—è¾“å‡ºçš„ç»Ÿä¸€æ¥å£, å¹¶ä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„æ—¥å¿—å®ç°æ–¹æ¡ˆ, å°±å¥½åƒæˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„ JDBC ä¸€æ ·,
åªæ˜¯ä¸€ç§è§„åˆ™è€Œå·². å› æ­¤å•ç‹¬çš„ slf4j æ˜¯ä¸èƒ½å·¥ä½œçš„, å®ƒå¿…é¡»æ­é…å…¶ä»–å…·ä½“çš„æ—¥å¿—å®ç°æ–¹æ¡ˆ, æ¯”å¦‚ apache çš„ org.apache.log4j.Logger, jdk è‡ªå¸¦çš„
java.util.logging.Logger ç­‰ç­‰.

å…¶ä¸­å¯¹ä¸ jar åŒ…:

1. slf4j-log4j12-x.x.x.jar æ˜¯ä½¿ç”¨ org.apache.log4j.Logger æä¾›çš„é©±åŠ¨
2. slf4j-jdk14-x.x.x.jar æ˜¯ä½¿ç”¨ java.util.logging æä¾›çš„é©±åŠ¨
3. slf4j-simple-x.x.x.jar ç›´æ¥ç»‘å®š System.err
4. slf4j-jcl-x.x.x.jar æ˜¯ä½¿ç”¨ commons-logging æä¾›çš„é©±åŠ¨
5. logback-classic-x.x.x.jar æ˜¯ä½¿ç”¨ logback æä¾›çš„é©±åŠ¨

## Commons-logging+log4j

ç»å…¸çš„ä¸€ä¸ªæ—¥å¿—å®ç°æ–¹æ¡ˆ. å‡ºç°åœ¨å„ç§æ¡†æ¶é‡Œ. å¦‚ spring ã€webx ã€ibatis ç­‰ç­‰. ç›´æ¥ä½¿ç”¨ log4j å³å¯æ»¡è¶³æˆ‘ä»¬çš„æ—¥å¿—æ–¹æ¡ˆ. ä½†æ˜¯ä¸€èˆ¬ä¸ºäº†é¿å…ç›´æ¥ä¾èµ–å…·ä½“çš„æ—¥å¿—å®ç°,
ä¸€èˆ¬éƒ½æ˜¯ç»“åˆ commons-logging æ¥å®ç°. å¸¸è§ä»£ç å¦‚ä¸‹:

```java
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
private static Log logger = LogFactory.getLog(CommonsLoggingTest.class);
```

ä»£ç ä¸Š, æ²¡æœ‰ä¾èµ–ä»»ä½•çš„ log4j å†…éƒ¨çš„ç±». é‚£ä¹ˆ log4j æ˜¯å¦‚ä½•è¢«è£…è½½çš„ï¼Ÿ
Log æ˜¯ä¸€ä¸ªæ¥å£å£°æ˜. LogFactory çš„å†…éƒ¨ä¼šå»è£…è½½å…·ä½“çš„æ—¥å¿—ç³»ç»Ÿ, å¹¶è·å¾—å®ç°è¯¥ Log æ¥å£çš„å®ç°ç±». è€Œå†…éƒ¨æœ‰ä¸€ä¸ª Log4JLogger å®ç°ç±»å¯¹ Log æ¥å£åŒæ—¶å†…éƒ¨æä¾›äº†å¯¹
log4j logger çš„ä»£ç†. LogFactory å†…éƒ¨è£…è½½æ—¥å¿—ç³»ç»Ÿæµç¨‹:

1. é¦–å…ˆ, å¯»æ‰¾ org.apache.commons.logging.LogFactory å±æ€§é…ç½®
2. å¦åˆ™, åˆ©ç”¨ JDK1.3 å¼€å§‹æä¾›çš„ service å‘ç°æœºåˆ¶, ä¼šæ‰«æ classpah ä¸‹çš„ META-INF/services/org.apache.commons.logging.LogFactory æ–‡ä»¶,
   è‹¥æ‰¾åˆ°åˆ™è£…è½½é‡Œé¢çš„é…ç½®, ä½¿ç”¨é‡Œé¢çš„é…ç½®.
3. å¦åˆ™, ä» Classpath é‡Œå¯»æ‰¾ commons-logging.properties , æ‰¾åˆ°åˆ™æ ¹æ®é‡Œé¢çš„é…ç½®åŠ è½½.
4. å¦åˆ™, ä½¿ç”¨é»˜è®¤çš„é…ç½®: å¦‚æœèƒ½æ‰¾åˆ° Log4j åˆ™é»˜è®¤ä½¿ç”¨ log4j å®ç°, å¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ JDK14Logger å®ç°, å†æ²¡æœ‰åˆ™ä½¿ç”¨ commons-logging å†…éƒ¨æä¾›çš„
   SimpleLog å®ç°.

ä»ä¸Šè¿°åŠ è½½æµç¨‹æ¥çœ‹, å¦‚æœæ²¡æœ‰åšä»»ä½•é…ç½®, åªè¦å¼•å…¥äº† log4j å¹¶åœ¨ classpath é…ç½®äº† log4j.xml , åˆ™ commons-logging å°±ä¼šä½¿ log4j ä½¿ç”¨æ­£å¸¸,
è€Œä»£ç é‡Œä¸éœ€è¦ä¾èµ–ä»»ä½• log4j çš„ä»£ç .

## Commons-logging+log4j+slf4j

å¦‚æœåœ¨åŸæœ‰ commons-logging ç³»ç»Ÿé‡Œ, å¦‚æœè¦è¿ç§»åˆ° slf4j, ä½¿ç”¨ slf4j æ›¿æ¢ commons-logging , ä¹Ÿæ˜¯å¯ä»¥åšåˆ°çš„. åŸç†ä½¿ç”¨åˆ°äº†ä¸Šè¿° commons-logging
åŠ è½½çš„ç¬¬äºŒç‚¹. éœ€è¦å¼•å…¥ org.slf4j.jcl-over-slf4j-1.5.6.jar . è¿™ä¸ª jar åŒ…æä¾›äº†ä¸€ä¸ªæ¡¥æ¥, è®©åº•å±‚å®ç°æ˜¯åŸºäº slf4j . åŸç†æ˜¯åœ¨è¯¥ jar åŒ…é‡Œå­˜æ”¾äº†é…ç½®
`META-INF/services/org.apache.commons.logging.LogFactory =org.apache.commons.logging.impl.SLF4JLogFactory`,
è€Œ commons-logging åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šæ‰¾åˆ°è¿™ä¸ª serviceId , å¹¶æŠŠå®ƒä½œä¸º LogFactory .

å®Œæˆæ¡¥æ¥å, é‚£ä¹ˆé‚£ä¹ˆç®€å•æ—¥å¿—é—¨é¢ SLF4J å†…éƒ¨åˆæ˜¯å¦‚ä½•æ¥è£…è½½åˆé€‚çš„ log å‘¢ï¼Ÿ

åŸç†æ˜¯ SLF4J ä¼šåœ¨ç¼–è¯‘æ—¶ä¼šç»‘å®š import org.slf4j.impl.StaticLoggerBinder; è¯¥ç±»é‡Œé¢å®ç°å¯¹å…·ä½“æ—¥å¿—æ–¹æ¡ˆçš„ç»‘å®šæ¥å…¥. ä»»ä½•ä¸€ç§åŸºäº slf4j
çš„å®ç°éƒ½è¦æœ‰ä¸€ä¸ªè¿™ä¸ªç±». å¦‚:
org.slf4j.slf4j-log4j12-1.5.6: æä¾›å¯¹ log4j çš„ä¸€ç§é€‚é…å®ç°.
Org.slf4j.slf4j-simple-1.5.6: æ˜¯ä¸€ç§ simple å®ç°, ä¼šå°† log ç›´æ¥æ‰“åˆ°æ§åˆ¶å°.
â€¦â€¦

é‚£ä¹ˆè¿™ä¸ªåœ°æ–¹å°±è¦æ³¨æ„äº†: å¦‚æœæœ‰ä»»æ„ä¸¤ä¸ªå®ç° slf4j çš„åŒ…åŒæ—¶å‡ºç°, é‚£å°±æœ‰å¯èƒ½é…¿å°±æ‚²å‰§, ä½ å¯èƒ½ä¼šå‘ç°æ—¥å¿—ä¸è§äº†ã€æˆ–éƒ½æ‰“åˆ°æ§åˆ¶å°äº†. åŸå› æ˜¯è¿™ä¸¤ä¸ª jar
åŒ…é‡Œéƒ½æœ‰å„è‡ªçš„ org.slf4j.impl.StaticLoggerBinder , ç¼–è¯‘æ—¶å€™ç»‘å®šçš„æ˜¯å“ªä¸ªæ˜¯ä¸ç¡®å®šçš„. è¿™ä¸ªåœ°æ–¹è¦ç‰¹åˆ«æ³¨æ„ï¼ï¼å‡ºç°è¿‡å‡ æ¬¡å› ä¸ºè¿™ä¸ªå¯¼è‡´æ—¥å¿—é”™ä¹±çš„é—®é¢˜.

## ç®€å•ä½¿ç”¨ log4j

**Maven ä¾èµ–**

```xml
<dependency>
  <groupId>log4j</groupId>
  <artifactId>log4j</artifactId>
  <version>1.2.9</version>
</dependency>
```

**log4j.properties é…ç½®**

```properties
### set log levels ###
log4j.rootLogger = debug ,  stdout

### è¾“å‡ºåˆ°æ§åˆ¶å° ###
log4j.appender.stdout = org.apache.log4j.ConsoleAppender
log4j.appender.stdout.Target = System.out
log4j.appender.stdout.layout = org.apache.log4j.PatternLayout
log4j.appender.stdout.layout.ConversionPattern = %-d{yyyy-MM-dd HH:mm:ss}  [%t:%r] - [%p]  %m%n

### è¾“å‡ºåˆ°æ—¥å¿—æ–‡ä»¶ ###
log4j.appender.D = org.apache.log4j.DailyRollingFileAppender
log4j.appender.D.File = logs/log.log
log4j.appender.D.Append = true
log4j.appender.D.Threshold = DEBUG ## è¾“å‡º DEBUG çº§åˆ«ä»¥ä¸Šçš„æ—¥å¿—
log4j.appender.D.layout = org.apache.log4j.PatternLayout
log4j.appender.D.layout.ConversionPattern = %-d{yyyy-MM-dd HH:mm:ss}  [%t:%r] - [%p]  %m%n

### ä¿å­˜å¼‚å¸¸ä¿¡æ¯åˆ°å•ç‹¬æ–‡ä»¶ ###
log4j.appender.D = org.apache.log4j.DailyRollingFileAppender
log4j.appender.D.File = logs/error.log ## å¼‚å¸¸æ—¥å¿—æ–‡ä»¶å
log4j.appender.D.Append = true
log4j.appender.D.Threshold = ERROR ## åªè¾“å‡º ERROR çº§åˆ«ä»¥ä¸Šçš„æ—¥å¿—!!!
log4j.appender.D.layout = org.apache.log4j.PatternLayout
log4j.appender.D.layout.ConversionPattern = %-d{yyyy-MM-dd HH:mm:ss}  [%t:%r] - [%p]  %m%n
```

```java
public static void main(String[] args) throws Exception {
        Logger logger = Logger.getLogger(UserDaoTest.class);
        logger.debug("å¼€å§‹");
        example2();
        logger.debug("ç»“æŸ");
    }
```

## ç®€å•ä½¿ç”¨ log4j2

**Maven ä¾èµ–**

```xml
<dependency>
    <groupId>org.apache.logging.log4j</groupId>
    <artifactId>log4j-api</artifactId>
    <version>2.6.2</version>
</dependency>
<dependency>
    <groupId>org.apache.logging.log4j</groupId>
    <artifactId>log4j-core</artifactId>
    <version>2.6.2</version>
</dependency>
```

**log4j2.xml é…ç½®**

```xml
<?xml version="1.0" encoding="UTF-8"?>

<!--
    status : è¿™ä¸ªç”¨äºè®¾ç½® log4j2 è‡ªèº«å†…éƒ¨çš„ä¿¡æ¯è¾“å‡º, å¯ä»¥ä¸è®¾ç½®, å½“è®¾ç½®æˆ trace æ—¶, ä¼šçœ‹åˆ° log4j2 å†…éƒ¨å„ç§è¯¦ç»†è¾“å‡º
    monitorInterval : Log4j èƒ½å¤Ÿè‡ªåŠ¨æ£€æµ‹ä¿®æ”¹é…ç½®æ–‡ä»¶å’Œé‡æ–°é…ç½®æœ¬èº«, è®¾ç½®é—´éš”ç§’æ•°.
-->
<Configuration status="WARN" monitorInterval="600">

    <Properties>
        <!-- é…ç½®æ—¥å¿—æ–‡ä»¶è¾“å‡ºç›®å½• -->
        <Property name="LOG_HOME">/Users/hanhan.zhang/logs</Property>
    </Properties>

    <Appenders>

        <!-- è¿™ä¸ªè¾“å‡ºæ§åˆ¶å°çš„é…ç½® -->
        <Console name="Console" target="SYSTEM_OUT">
            <!-- æ§åˆ¶å°åªè¾“å‡º level åŠä»¥ä¸Šçº§åˆ«çš„ä¿¡æ¯ (onMatch), å…¶ä»–çš„ç›´æ¥æ‹’ç» (onMismatch) -->
            <ThresholdFilter level="trace" onMatch="ACCEPT" onMismatch="DENY"/>
            <!-- è¾“å‡ºæ—¥å¿—çš„æ ¼å¼ -->
            <PatternLayout pattern="%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level %class{36} %L %M - %msg%xEx%n"/>
        </Console>

        <!-- è®¾ç½®æ—¥å¿—æ ¼å¼å¹¶é…ç½®æ—¥å¿—å‹ç¼©æ ¼å¼ (service.log. å¹´ä»½.gz) -->
        <RollingRandomAccessFile name="service_appender"
                                 immediateFlush="false" fileName="${LOG_HOME}/service.log"
                                 filePattern="${LOG_HOME}/service.log.%d{yyyy-MM-dd}.log.gz">
            <!--
                %d{yyyy-MM-dd HH:mm:ss, SSS} : æ—¥å¿—ç”Ÿäº§æ—¶é—´
                %p : æ—¥å¿—è¾“å‡ºæ ¼å¼
                %c : logger çš„åç§°
                %m : æ—¥å¿—å†…å®¹, å³ logger.info("message")
                %n : æ¢è¡Œç¬¦
                %C : Java ç±»å
                %L : æ—¥å¿—è¾“å‡ºæ‰€åœ¨è¡Œæ•°
                %M : æ—¥å¿—è¾“å‡ºæ‰€åœ¨æ–¹æ³•å
                hostName : æœ¬åœ°æœºå™¨å
                hostAddress : æœ¬åœ° ip åœ°å€
             -->
            <PatternLayout>
                <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level %class{36} %L %M -- %msg%xEx%n</pattern>
            </PatternLayout>
            <Policies>
                <TimeBasedTriggeringPolicy interval="1" modulate="true" />
            </Policies>
        </RollingRandomAccessFile>


        <!-- DEBUG æ—¥å¿—æ ¼å¼ -->
        <RollingRandomAccessFile name="service_debug_appender"
                                 immediateFlush="false" fileName="${LOG_HOME}/service.log"
                                 filePattern="${LOG_HOME}/service.log.%d{yyyy-MM-dd}.debug.gz">
            <PatternLayout>
                <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level %class{36} %L %M -- %msg%xEx%n</pattern>
            </PatternLayout>
            <Policies>
                <TimeBasedTriggeringPolicy interval="1" modulate="true" />
            </Policies>
        </RollingRandomAccessFile>
    </Appenders>

    <Loggers>
        <!-- é…ç½®æ—¥å¿—çš„æ ¹èŠ‚ç‚¹ -->
        <root level="debug">
            <appender-ref ref="Console"/>
        </root>

        <!-- ç¬¬ä¸‰æ–¹æ—¥å¿—ç³»ç»Ÿ -->
        <logger name="org.springframework.core" level="info"/>
        <logger name="org.springframework.beans" level="info"/>
        <logger name="org.springframework.context" level="info"/>
        <logger name="org.springframework.web" level="info"/>
        <logger name="org.jboss.netty" level="warn"/>
        <logger name="org.apache.http" level="warn"/>

        <!-- æ—¥å¿—å®ä¾‹ (info), å…¶ä¸­'service-log'ç»§æ‰¿ root, ä½†æ˜¯ root å°†æ—¥å¿—è¾“å‡ºæ§åˆ¶å°, è€Œ'service-log'å°†æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶, é€šè¿‡å±æ€§'additivity="false"'å°†'service-log'çš„
             çš„æ—¥å¿—ä¸å†è¾“å‡ºåˆ°æ§åˆ¶å° -->
        <logger name="service_log" level="info" includeLocation="true" additivity="true">
            <appender-ref ref="service_appender"/>
        </logger>

        <!-- æ—¥å¿—å®ä¾‹ (debug) -->
        <logger name="service_log" level="debug" includeLocation="true" additivity="false">
            <appender-ref ref="service_debug_appender"/>
        </logger>

    </Loggers>

</Configuration>
```

```java
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
private static Logger logger_ = LogManager.getLogger(DateUtils2Joda.class);
```

## ç®€å•ä½¿ç”¨ slf4j

**pom**
slf4j-simple ä¸­åŒ…å«äº† slf4j-api

```java
private static final org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(HelloAspect.class);
```

```xml
<dependency>
    <groupId>org.slf4j</groupId>
    <artifactId>slf4j-simple</artifactId>
    <version>1.7.7</version>
</dependency>
```

## log4j + slf4j é…ç½®

1. slf4j-api:Simple Logging Facade for Java-api, ä¸º Java æä¾›çš„ç®€å•æ—¥å¿— Facade. Facade: é—¨é¢, æ›´åº•å±‚ä¸€ç‚¹è¯´å°±æ˜¯æ¥å£. slf4j å…¥å£å°±æ˜¯ä¼—å¤šæ¥å£çš„é›†åˆ,
   ä»–ä¸è´Ÿè´£å…·ä½“çš„æ—¥å¿—å®ç°, åªåœ¨ç¼–è¯‘æ—¶è´Ÿè´£å¯»æ‰¾åˆé€‚çš„æ—¥å¿—ç³»ç»Ÿè¿›è¡Œç»‘å®š.
2. slf4j-log4j12: é“¾æ¥ slf4j-api å’Œ log4j ä¸­é—´çš„é€‚é…å™¨. å®ƒå®ç°äº† slf4j-api ä¸­ StaticLoggerBinder æ¥å£, ä»è€Œä½¿å¾—åœ¨ç¼–è¯‘æ—¶ç»‘å®šçš„æ˜¯
   slf4j-log4j12 çš„ getSingleton() æ–¹æ³•.
3. log4j: è¿™ä¸ªæ˜¯å…·ä½“çš„æ—¥å¿—ç³»ç»Ÿ. é€šè¿‡ slf4j-log4j12 åˆå§‹åŒ– Log4j, è¾¾åˆ°æœ€ç»ˆæ—¥å¿—çš„è¾“å‡º.

**pom**
å¦‚æœæ²¡æœ‰æ›´é«˜ç‰ˆæœ¬çš„ slf4j-api å’Œ log4j è¦æ±‚, åˆ™åªæ·»åŠ ç¬¬ä¸€æ¡ä¾èµ–å°±å¯ä»¥, å› ä¸º slf4j-log4j12 ä¾èµ–ä¼šåŒ…å« slf4j-api å’Œ log4j ä¾èµ–

```xml
<dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-log4j12</artifactId>
            <version>1.7.21</version>
        </dependency>
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-api</artifactId>
            <version>1.7.22</version>
        </dependency>
        <dependency>
            <groupId>log4j</groupId>
            <artifactId>log4j</artifactId>
            <version>1.2.17</version>
        </dependency>
```

**log4j.properties (log4j.xml)**

```
log4j.rootLogger=debug,consoleAppender,fileAppender
log4j.category.ETTAppLogger=debug, ettAppLogFile
log4j.appender.consoleAppender=org.apache.log4j.ConsoleAppender
log4j.appender.consoleAppender.Threshold=TRACE
log4j.appender.consoleAppender.layout=org.apache.log4j.PatternLayout
log4j.appender.consoleAppender.layout.ConversionPattern=%-d{yyyy-MM-dd HH:mm:ss SSS} ->[%t]--[%-5p]--[%c{1}]--%m%n
log4j.appender.fileAppender=org.apache.log4j.DailyRollingFileAppender
log4j.appender.fileAppender.File=c:/temp/nstd/debug1.log
log4j.appender.fileAppender.DatePattern='_'yyyy-MM-dd'.log'
log4j.appender.fileAppender.Threshold=TRACE
log4j.appender.fileAppender.Encoding=BIG5
log4j.appender.fileAppender.layout=org.apache.log4j.PatternLayout
log4j.appender.fileAppender.layout.ConversionPattern=%-d{yyyy-MM-dd HH:mm:ss SSS}-->[%t]--[%-5p]--[%c{1}]--%m%n
log4j.appender.ettAppLogFile=org.apache.log4j.DailyRollingFileAppender
log4j.appender.ettAppLogFile.File=c:/temp/nstd/ettdebug.log
log4j.appender.ettAppLogFile.DatePattern='_'yyyy-MM-dd'.log'
log4j.appender.ettAppLogFile.Threshold=DEBUG
log4j.appender.ettAppLogFile.layout=org.apache.log4j.PatternLayout
log4j.appender.ettAppLogFile.layout.ConversionPattern=%-d{yyyy-MM-dd HH:mm:ss SSS}-->[%t]--[%-5p]--[%c{1}]--%m%n
```

### slf4j å·¥ä½œåŸç†

slf4j-api ä½œä¸º slf4j çš„æ¥å£ç±», ä½¿ç”¨åœ¨ç¨‹åºä»£ç ä¸­, è¿™ä¸ªåŒ…æä¾›äº†ä¸€ä¸ª Logger ç±»å’Œ LoggerFactory ç±», Logger ç±»ç”¨æ¥æ‰“æ—¥å¿—, LoggerFactory ç±»ç”¨æ¥è·å–
Logger;slf4j-log4j æ˜¯è¿æ¥ slf4j å’Œ log4j çš„æ¡¥æ¢, æ€ä¹ˆè¿æ¥çš„å‘¢ï¼Ÿæˆ‘ä»¬çœ‹çœ‹ slf4j çš„ LoggerFactory ç±»çš„ getLogger å‡½æ•°çš„æºç :

```java
/**
* Return a logger named according to the name parameter using the statically
* bound {@link ILoggerFactory} instance.
*
* @param name
*          The name of the logger.
* @return logger
*/
public static Logger getLogger(String name) {
     ILoggerFactory iLoggerFactory = getILoggerFactory();
     return iLoggerFactory.getLogger(name);
}

/**
* Return a logger named corresponding to the class passed as parameter, using
* the statically bound {@link ILoggerFactory} instance.
*
* @param clazz
*          the returned logger will be named after clazz
* @return logger
*/
public static Logger getLogger(Class clazz) {
    return getLogger(clazz.getName());
}

/**
* Return the {@link ILoggerFactory} instance in use.
*
* <p>
* ILoggerFactory instance is bound with this class at compile time.
*
* @return the ILoggerFactory instance in use
*/
public static ILoggerFactory getILoggerFactory() {
     if (INITIALIZATION_STATE == UNINITIALIZED) {
       INITIALIZATION_STATE = ONGOING_INITILIZATION;
       performInitialization();

     }
     switch (INITIALIZATION_STATE) {
     case SUCCESSFUL_INITILIZATION:
       return StaticLoggerBinder.getSingleton().getLoggerFactory();
     case NOP_FALLBACK_INITILIZATION:
       return NOP_FALLBACK_FACTORY;
     case FAILED_INITILIZATION:
       throw new IllegalStateException(UNSUCCESSFUL_INIT_MSG);
     case ONGOING_INITILIZATION:
       // support re-entrant behavior.
       // See also http://bugzilla.slf4j.org/show_bug.cgi?id=106
       return TEMP_FACTORY;
     }
     throw new IllegalStateException("Unreachable code");
}
```

æŸ¥æ‰¾åˆ°ç°åœ¨, æˆ‘ä»¬å‘ç° LoggerFactory.getLogger() é¦–å…ˆè·å–ä¸€ä¸ª ILoggerFactory æ¥å£, ç„¶åä½¿ç”¨è¯¥æ¥å£è·å–å…·ä½“çš„ Logger. è·å– ILoggerFactory
çš„æ—¶å€™ç”¨åˆ°äº†ä¸€ä¸ª StaticLoggerBinder ç±», ä»”ç»†ç ”ç©¶æˆ‘ä»¬ä¼šå‘ç° StaticLoggerBinder è¿™ä¸ªç±»å¹¶ä¸æ˜¯ slf4j-api è¿™ä¸ªåŒ…ä¸­çš„ç±», è€Œæ˜¯ slf4j-log4j åŒ…ä¸­çš„ç±»,
è¿™ä¸ªç±»å°±æ˜¯ä¸€ä¸ªä¸­é—´ç±», å®ƒç”¨æ¥å°†æŠ½è±¡çš„ slf4j å˜æˆå…·ä½“çš„ log4j, ä¹Ÿå°±æ˜¯è¯´å…·ä½“è¦ä½¿ç”¨ä»€ä¹ˆæ ·çš„æ—¥å¿—å®ç°æ–¹æ¡ˆ, å°±å¾—é è¿™ä¸ª StaticLoggerBinder ç±».

```java
/**
* The ILoggerFactory instance returned by the {@link #getLoggerFactory}
* method should always be the same object
*/
private final ILoggerFactory loggerFactory;

private StaticLoggerBinder() {
     loggerFactory = new Log4jLoggerFactory();
     try {
       Level level = Level.TRACE;
     } catch (NoSuchFieldError nsfe) {
       Util.report("This version of SLF4J requires log4j version 1.2.12 or later. See also http://www.slf4j.org/codes.html#log4j_version");
     }
}

public ILoggerFactory getLoggerFactory() {
     return loggerFactory;
}

public String getLoggerFactoryClassStr() {
     return loggerFactoryClassStr;
}
```

å¯ä»¥çœ‹åˆ° slf4j-log4j ä¸­çš„ StaticLoggerBinder ç±»åˆ›å»ºçš„ ILoggerFactory å…¶å®æ˜¯ä¸€ä¸ª org.slf4j.impl.Log4jLoggerFactory, è¿™ä¸ªç±»çš„ getLogger
å‡½æ•°ä»£ç å¦‚ä¸‹:

```java
/*
 * (non-Javadoc)
 *
 * @see org.slf4j.ILoggerFactory#getLogger(java.lang.String)
 */
public Logger getLogger(String name) {
    Logger slf4jLogger = null;
    // protect against concurrent access of loggerMap
    synchronized (this) {
        slf4jLogger = (Logger) loggerMap.get(name);
        if (slf4jLogger == null) {
         org.apache.log4j.Logger log4jLogger;
         if(name.equalsIgnoreCase(Logger.ROOT_LOGGER_NAME)) {
            log4jLogger = LogManager.getRootLogger();
         } else {
            log4jLogger = LogManager.getLogger(name);
         }
         slf4jLogger = new Log4jLoggerAdapter(log4jLogger);
         loggerMap.put(name, slf4jLogger);
        }
    }
    return slf4jLogger;
}
```

å°±åœ¨å…¶ä¸­åˆ›å»ºäº†çœŸæ­£çš„ org.apache.log4j.Logger, ä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦çš„å…·ä½“çš„æ—¥å¿—å®ç°æ–¹æ¡ˆçš„ Logger ç±». å°±è¿™æ ·, æ•´ä¸ªç»‘å®šè¿‡ç¨‹å°±å®Œæˆäº†.

## log4j2 + slf4j é…ç½®

Log4j 1.x åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹å‡ºç°æ­»é”å¯¼è‡´ cpu ä½¿ç”¨ç‡å¼‚å¸¸é£™å‡, è€Œ Log4j2.0 åŸºäº LMAX Disruptor çš„å¼‚æ­¥æ—¥å¿—åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ€§èƒ½ä¼šè¿œè¿œä¼˜äº Log4j 1.x å’Œ
logbackï¼ˆå®˜æ–¹æ•°æ®æ˜¯ 10 å€ä»¥ä¸Šï¼‰, è¿™é‡Œåˆ†äº« slf4j + Log4j2 çš„ä½¿ç”¨æ–¹æ³•.

**pom é…ç½®**

åˆ é™¤ä»¥å¾€ä¾èµ– Log4j1.x çš„ä¾èµ–é¡¹, æ¯”å¦‚ slf4j-log4j12ã€log4j ç­‰åŒ….
å¯ä»¥åˆ°é¡¹ç›®çš„æ ¹ç›®å½•, æ‰§è¡Œ: mvn dependency:tree > tree.log , æŸ¥çœ‹ä¹‹å cat tree.log | grep log4j æŸ¥æ‰¾.

```xml
<exclusions>
    <exclusion>
        <groupId>org.slf4j</groupId>
        <artifactId>slf4j-log4j12</artifactId>
    </exclusion>
    <exclusion>
        <groupId>log4j</groupId>
        <artifactId>log4j</artifactId>
    </exclusion>
</exclusions>
```

ç„¶ååœ¨å·¥ç¨‹çš„ pom.xml æ–°å¢ä»¥ä¸‹ log4j2 çš„ä¾èµ–å…³ç³»:

```xml
<!-- Logging use log4j2-->
<dependency>
    <groupId>org.slf4j</groupId>
    <artifactId>slf4j-api</artifactId>
    <version>1.7.13</version>
</dependency>
<dependency>
    <groupId>org.slf4j</groupId>
    <artifactId>jcl-over-slf4j</artifactId>
    <version>1.7.13</version>
    <scope>runtime</scope>
</dependency>

<!-- æ ¸å¿ƒ log4j2jar åŒ… -->
<dependency>
    <groupId>org.apache.logging.log4j</groupId>
    <artifactId>log4j-api</artifactId>
    <version>2.4.1</version>
</dependency>
<dependency>
    <groupId>org.apache.logging.log4j</groupId>
    <artifactId>log4j-core</artifactId>
    <version>2.4.1</version>
</dependency>
<!-- ç”¨äºä¸ slf4j ä¿æŒæ¡¥æ¥ -->
<dependency>
    <groupId>org.apache.logging.log4j</groupId>
    <artifactId>log4j-slf4j-impl</artifactId>
    <version>2.4.1</version>
</dependency>
<!--web å·¥ç¨‹éœ€è¦åŒ…å« log4j-web, é web å·¥ç¨‹ä¸éœ€è¦ -->
<dependency>
    <groupId>org.apache.logging.log4j</groupId>
    <artifactId>log4j-web</artifactId>
    <version>2.4.1</version>
    <scope>runtime</scope>
</dependency>

<!-- éœ€è¦ä½¿ç”¨ log4j2 çš„ AsyncLogger éœ€è¦åŒ…å« disruptor-->
<dependency>
    <groupId>com.lmax</groupId>
    <artifactId>disruptor</artifactId>
    <version>3.2.0</version>
</dependency>
```

**web.xml**
web å·¥ç¨‹çš„ web.xml æ–‡ä»¶ä¸­æ·»åŠ ï¼ˆServlet3.0 ä¸éœ€è¦ï¼‰:

```xml
<!--log4j2-->
<!-- å¯¹äº log4j2, Servlet2.5 ä»¥å‰çš„ç‰ˆæœ¬éœ€è¦ -->
<listener>
    <listener-class>org.apache.logging.log4j.web.Log4jServletContextListener</listener-class>
</listener>
<filter>
    <filter-name>log4jServletFilter</filter-name>
    <filter-class>org.apache.logging.log4j.web.Log4jServletFilter</filter-class>
</filter>
<filter-mapping>
    <filter-name>log4jServletFilter</filter-name>
    <url-pattern>/*</url-pattern>
    <dispatcher>REQUEST</dispatcher>
    <dispatcher>FORWARD</dispatcher>
    <dispatcher>INCLUDE</dispatcher>
    <dispatcher>ERROR</dispatcher>
</filter-mapping>
<context-param>
    <param-name>log4jConfiguration</param-name>
    <param-value>/WEB-INF/classes/log4j2.xml</param-value>
</context-param>
```

**log4j2.xml**

```xml
<?xml version="1.0" encoding="UTF-8"?>

<Configuration status="off" monitorInterval="1800">

    <properties>
        <property name="LOG_HOME">/opt/logs/gct/shoppromo/logs</property>
        <property name="ERROR_LOG_FILE_NAME">error</property>
    </properties>


    <Appenders>
        <Console name="Console" target="SYSTEM_OUT">
            <PatternLayout pattern="%d %-5p (%F:%L) - %m%n" />
        </Console>

        <RollingRandomAccessFile name="ErrorLog"
                                 fileName="${LOG_HOME}/${ERROR_LOG_FILE_NAME}.log"
                                 filePattern="${LOG_HOME}/${ERROR_LOG_FILE_NAME}.log.%d{yyyy-MM-dd}.gz">
            <PatternLayout
                    pattern="%d %-5p (%F:%L) - %m%n"/>
            <Policies>
                <TimeBasedTriggeringPolicy/>
                <SizeBasedTriggeringPolicy size="100 MB"/>
            </Policies>
            <DefaultRolloverStrategy max="20"/>
        </RollingRandomAccessFile>

    </Appenders>

    <Loggers>
        <!-- 3rdparty Loggers -->
        <logger name="org.springframework.core" level="info">
        </logger>
        <logger name="org.springframework.beans" level="info">
        </logger>
        <logger name="org.springframework.context" level="info">
        </logger>
        <logger name="org.springframework.web" level="info">
        </logger>

        <logger name="com.meituan.gct.shop.promo" level="error" includeLocation="true" additivity="false">
            <appender-ref ref="ErrorLog"/>
            <appender-ref ref="Console"/>
        </logger>

        <root level="info" includeLocation="true">
            <appender-ref ref="Console"/>
        </root>
    </Loggers>
</Configuration>
```

## logback + slf4j é…ç½®

Logback åˆ†ä¸ºä¸‰ä¸ªæ¨¡å—: logback-core, logback-classic, logback-access

1. logback-core æ˜¯æ ¸å¿ƒï¼›
2. logback-classic æ”¹å–„äº† log4j, ä¸”è‡ªèº«å®ç°äº† SLF4J API, æ‰€ä»¥å³ä½¿ç”¨ Logback ä½ ä»ç„¶å¯ä»¥ä½¿ç”¨å…¶ä»–çš„æ—¥å¿—å®ç°, å¦‚åŸå§‹çš„ Log4J, java.util.logging
   ç­‰ï¼›
3. logback-access è®©ä½ æ–¹ä¾¿çš„è®¿é—®æ—¥å¿—ä¿¡æ¯, å¦‚é€šè¿‡ http çš„æ–¹å¼

**pom**

```xml
<dependency>
    <groupId>org.slf4j</groupId>
    <artifactId>slf4j-api</artifactId>
    <version>1.7.24</version>
    <type>jar</type>
    <scope>compile</scope>
</dependency>
<dependency>
    <groupId>ch.qos.logback</groupId>
    <artifactId>logback-core</artifactId>
    <version>1.1.11</version>
    <type>jar</type>
</dependency>
<dependency>
    <groupId>ch.qos.logback</groupId>
    <artifactId>logback-classic</artifactId>
    <version>1.1.11</version>
    <type>jar</type>
</dependency>
```

**é…ç½®æ–‡ä»¶**

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<configuration>
    <!-- æ§åˆ¶å°è¾“å‡ºæ—¥å¿— -->
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{mm:ss} %-5level %logger{36} >>> %msg%n</pattern>
        </encoder>
    </appender>
    <!-- æ¯å¤©ç”Ÿæˆä¸€ä¸ªæ—¥å¿—æ–‡ä»¶, ä¿å­˜ 30 å¤©çš„æ—¥å¿—æ–‡ä»¶. -->
    <appender name="DayFile" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>logs/logFile.%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder>
            <pattern>%-4relative [%thread] %-5level %logger{35} - %msg%n</pattern>
        </encoder>
    </appender>
    <!-- æŒ‡å®š logger name ä¸ºåŒ…åæˆ–ç±»å…¨å æŒ‡å®šçº§åˆ« additivity è®¾ç½®æ˜¯å¦ä¼ é€’åˆ° root logger -->
    <logger name="slf4j" level="INFO" additivity="false">
        <appender-ref ref="STDOUT"/>
        <appender-ref ref="DayFile"/>
    </logger>
    <!--slf4j2 åŒ…ä¸‹çš„ç±»åœ¨ ERROR çº§åˆ«æ—¶å€™ä¼ é€’åˆ° root logger ä¸­ -->
    <logger name="slf4j2" level="ERROR" />
    <!-- æ ¹ logger æ§åˆ¶ -->
    <root level="WARN">
        <appender-ref ref="STDOUT" />
    </root>
</configuration>
```

## log4j è½¬ logback é…ç½®

**pom**

```xml
<!-- logback æ—¥å¿—é…ç½®å¼€å§‹ -->
 <dependency>
         <groupId>ch.qos.logback</groupId>
         <artifactId>logback-core</artifactId>
         <version>1.1.2</version>
 </dependency>
 <dependency>
         <groupId>ch.qos.logback</groupId>
         <artifactId>logback-access</artifactId>
         <version>1.1.2</version>
 </dependency>
 <dependency>
         <groupId>ch.qos.logback</groupId>
         <artifactId>logback-classic</artifactId>
         <version>1.1.2</version>
 </dependency>
 <dependency>
         <groupId>org.slf4j</groupId>
         <artifactId>log4j-over-slf4j</artifactId>
         <version>1.7.7</version>
 </dependency>
<!-- logback æ—¥å¿—é…ç½®ç»“æŸ -->
```

åˆ é™¤ src ä¸‹çš„ log4j.properties æ–‡ä»¶, åœ¨ src ä¸‹åˆ›å»º logback.xml é…ç½®æ–‡ä»¶

## Spring Framework ä¾èµ– SLF4J

## æ€»ç»“

**slf4j æ¡¥æ¥åˆ°å…·ä½“æ—¥å¿—**

å¯ä»¥çœ‹åˆ° slf4j ä¸å…·ä½“æ—¥å¿—æ¡†æ¶ç»“åˆçš„æ–¹æ¡ˆæœ‰å¾ˆå¤šç§. å½“ç„¶, æ¯ç§æ–¹æ¡ˆçš„æœ€ä¸Šå±‚ï¼ˆç»¿è‰²çš„åº”ç”¨å±‚ï¼‰éƒ½æ˜¯ç»Ÿä¸€çš„, å®ƒä»¬å‘ä¸‹éƒ½æ˜¯ç›´æ¥è°ƒç”¨ slf4j æä¾›çš„
APIï¼ˆæµ…è“è‰²çš„æŠ½è±¡ API å±‚ï¼‰, ä¾èµ– slf4j-api.jar. ç„¶å slf4j API å‘ä¸‹å†æ€ä¹ˆåšå°±éå¸¸è‡ªç”±äº†, å‡ ä¹å¯ä»¥ä½¿ç”¨æ‰€æœ‰çš„å…·ä½“æ—¥å¿—æ¡†æ¶. æ³¨æ„å›¾ä¸­çš„ç¬¬äºŒå±‚æ˜¯æµ…è“è‰²çš„,
çœ‹å·¦ä¸‹è§’çš„å›¾ä¾‹å¯çŸ¥è¿™ä»£è¡¨æŠ½è±¡æ—¥å¿— API, ä¹Ÿå°±æ˜¯è¯´å®ƒä»¬ä¸æ˜¯å…·ä½“å®ç°. å¦‚æœåƒå·¦è¾¹ç¬¬ä¸€ç§æ–¹æ¡ˆé‚£æ ·ä¸‹å±‚æ²¡æœ‰è·Ÿä»»ä½•å…·ä½“æ—¥å¿—æ¡†æ¶å®ç°ç›¸ç»“åˆ,
é‚£ä¹ˆæ—¥å¿—æ˜¯æ— æ³•è¾“å‡ºæ¥çš„ï¼ˆè¿™é‡Œä¸ç¡®å®šæ˜¯å¦å¯èƒ½ä¼šé»˜è®¤è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼‰.
å›¾ä¸­ç¬¬ä¸‰å±‚æ˜æ˜¾å°±ä¸å¦‚ç¬¬ä¸€ã€äºŒå±‚é‚£ä¹ˆæ•´é½åˆ’ä¸€äº†, å› ä¸ºè¿™é‡Œå·²ç»å¼€å§‹æ¶‰åŠåˆ°äº†å…·ä½“çš„æ—¥å¿—æ¡†æ¶.
é¦–å…ˆçœ‹ç¬¬ä¸‰å±‚ä¸­é—´çš„ä¸¤ä¸ªæ¹–è“è‰²å—, è¿™æ˜¯é€‚é…å±‚, ä¹Ÿå°±æ˜¯æ¡¥æ¥å™¨. å·¦è¾¹çš„ slf4j-log4j12.jar æ¡¥æ¥å™¨çœ‹åå­—å°±çŸ¥é“æ˜¯ slf4j åˆ° log4j çš„æ¡¥æ¥å™¨, åŒæ ·, å³è¾¹çš„
slf4j-jdk14.jar å°±æ˜¯ slf4j åˆ° Java åŸç”Ÿæ—¥å¿—å®ç°çš„æ¡¥æ¥å™¨äº†. å®ƒä»¬çš„ä¸‹ä¸€å±‚åˆ†åˆ«æ˜¯å¯¹åº”çš„æ—¥å¿—æ¡†æ¶å®ç°, log4j çš„å®ç°ä»£ç æ˜¯ log4j.jar, è€Œ jul
å®ç°ä»£ç å·²ç»åŒ…å«åœ¨äº† JVM runtime ä¸­, ä¸éœ€è¦å•ç‹¬çš„ jar åŒ….
å†çœ‹ç¬¬ä¸‰å±‚å…¶ä½™çš„ä¸‰ä¸ªæ·±è“è‰²å—. å®ƒä»¬ä¸‰ä¸ªä¹Ÿæ˜¯å…·ä½“çš„æ—¥å¿—æ¡†æ¶å®ç°, ä½†æ˜¯å´ä¸éœ€è¦æ¡¥æ¥å™¨, å› ä¸ºå®ƒä»¬æœ¬èº«å°±å·²ç»ç›´æ¥å®ç°äº† slf4j API. slf4j-simple.jar å’Œ
slf4j-nop.jar è¿™ä¸¤ä¸ªä¸ç”¨å¤šè¯´, çœ‹åå­—å°±çŸ¥é“ä¸€ä¸ªæ˜¯ slf4j çš„ç®€å•å®ç°, ä¸€ä¸ªæ˜¯ slf4j çš„ç©ºå®ç°, å¹³æ—¶ç”¨å¤„ä¹Ÿä¸å¤§. è€Œ logback ä¹‹æ‰€ä»¥ä¹Ÿå®ç°äº† slf4j
API, æ®è¯´æ˜¯å› ä¸º logback å’Œ slf4j å‡ºè‡ªåŒä¸€äººä¹‹æ‰‹, è¿™äººåŒæ—¶ä¹Ÿæ˜¯ log4j çš„ä½œè€….
ç¬¬ä¸‰å±‚æ‰€æœ‰çš„ç°è‰² jar åŒ…éƒ½å¸¦æœ‰çº¢æ¡†, è¿™è¡¨ç¤ºå®ƒä»¬éƒ½ç›´æ¥å®ç°äº† slf4j API, åªæ˜¯æ¹–è“è‰²çš„æ¡¥æ¥å™¨å¯¹ slf4j API çš„å®ç°å¹¶ä¸æ˜¯ç›´æ¥è¾“å‡ºæ—¥å¿—, è€Œæ˜¯è½¬å»è°ƒç”¨åˆ«çš„æ—¥å¿—æ¡†æ¶çš„
API.

**å…¶ä»–æ—¥å¿—æ¡†æ¶è½¬è°ƒå› slf4j**

ä¸Šå›¾å±•ç¤ºäº†ç›®å‰ä¸ºæ­¢èƒ½å®‰å…¨åœ°ä»åˆ«çš„æ—¥å¿—æ¡†æ¶ API è½¬è°ƒå› slf4j çš„æ‰€æœ‰ä¸‰ç§æƒ…å½¢.
ä»¥å·¦ä¸Šè§’ç¬¬ä¸€ç§æƒ…å½¢ä¸ºä¾‹, å½“ slf4j åº•å±‚æ¡¥æ¥åˆ° logback æ¡†æ¶çš„æ—¶å€™, ä¸Šå±‚å…è®¸æ¡¥æ¥å› slf4j çš„æ—¥å¿—æ¡†æ¶ API æœ‰ log4j å’Œ jul. jcl è™½ç„¶ä¸æ˜¯ä»€ä¹ˆæ—¥å¿—æ¡†æ¶çš„å…·ä½“å®ç°,
ä½†æ˜¯å®ƒçš„ API ä»ç„¶æ˜¯èƒ½å¤Ÿè¢«è½¬è°ƒå› slf4j çš„. è¦æƒ³å®ç°è½¬è°ƒ, æ–¹æ³•å°±æ˜¯å›¾ä¸Šåˆ—å‡ºçš„ç”¨ç‰¹å®šçš„æ¡¥æ¥å™¨ jar æ›¿æ¢æ‰åŸæœ‰çš„æ—¥å¿—æ¡†æ¶ jar. éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œä¸åŒ…å«
logback API åˆ° slf4j API çš„è½¬è°ƒ, å› ä¸º logback æœ¬æ¥å°±æ˜¯ slf4j API çš„å®ç°.
çœ‹å®Œä¸‰ç§æƒ…å½¢ä»¥å, ä¼šå‘ç°å‡ ä¹æ‰€æœ‰å…¶ä»–æ—¥å¿—æ¡†æ¶çš„ API, åŒ…æ‹¬ jcl çš„ API, éƒ½èƒ½å¤Ÿéšæ„çš„è½¬è°ƒå› slf4j. ä½†æ˜¯æœ‰ä¸€ä¸ªå”¯ä¸€çš„é™åˆ¶å°±æ˜¯è½¬è°ƒå› slf4j çš„æ—¥å¿—æ¡†æ¶ä¸èƒ½è·Ÿ
slf4j å½“å‰æ¡¥æ¥åˆ°çš„æ—¥å¿—æ¡†æ¶ç›¸åŒ. è¿™ä¸ªé™åˆ¶å°±æ˜¯ä¸ºäº†é˜²æ­¢ A-to-B.jar è·Ÿ B-to-A.jar åŒæ—¶å‡ºç°åœ¨ç±»è·¯å¾„ä¸­, ä»è€Œå¯¼è‡´ A å’Œ B ä¸€ç›´ä¸åœåœ°äº’ç›¸é€’å½’è°ƒç”¨,
æœ€åå †æ ˆæº¢å‡º. ç›®å‰è¿™ä¸ªé™åˆ¶å¹¶ä¸æ˜¯é€šè¿‡æŠ€æœ¯ä¿è¯çš„, ä»…ä»…é å¼€å‘è€…è‡ªå·±ä¿è¯, è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ slf4j å®˜ç½‘ä¸Šè¦å¼ºè°ƒæ‰€æœ‰åˆç†çš„æ–¹å¼åªæœ‰ä¸Šå›¾çš„ä¸‰ç§æƒ…å½¢.
åˆ°è¿™é‡Œ, åœ¨å¼€å§‹æ‰€å±•ç¤ºçš„é‚£ä¸ªå¼‚å¸¸çš„åŸç†åŸºæœ¬å·²ç»æ¸…æ¥šäº†. æ­¤å¤–, é€šè¿‡ä¸Šå›¾è¿˜å¯ä»¥çœ‹å‡ºå¯èƒ½ä¼šå‡ºç°ç±»ä¼¼å¼‚å¸¸çš„ç»„åˆä¸ä»…ä»…æ˜¯ log4j-over-slf4j å’Œ
slf4j-log4j12, slf4j å®˜ç½‘è¿˜æŒ‡å‡ºäº†å¦å¤–ä¸€å¯¹: jcl-over-slf4j.jar å’Œ slf4j-jcl.jar

## [Servlet æ–¹æ³•å¤§æ­ç§˜ï¼šsendRedirect vs forward](https://blog.dong4j.site/posts/a886bfdb.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})


## sendRedirect()æ–¹æ³•å’Œ forward() æ–¹æ³•çš„åŒºåˆ«

### sendRedirect() æ–¹æ³•åŸç†

1. å®¢æˆ·ç«¯å‘é€è¯·æ±‚, Servlet1 åšå‡ºå¤„ç†.
2. Servlet1 è°ƒç”¨ sendReadirect() æ–¹æ³•, å°†å®¢æˆ·ç«¯çš„è¯·æ±‚é‡æ–°å®šä½åˆ° Servlet2.
3. å®¢æˆ·ç«¯æµè§ˆå™¨è®¿é—® Servlet2.
4. Servlet2 å¯¹å®¢æˆ·ç«¯æµè§ˆå™¨åšå‡ºå“åº”.

### forward() æ–¹æ³•åŸç†

1. å®¢æˆ·ç«¯å‘é€è¯·æ±‚, Servlet1 åšå‡ºå¤„ç†.
2. Servlet1 è°ƒç”¨ forward() æ–¹æ³•, å°†è¯·æ±‚è½¬å‘ç»™ Servlet2 æ¥å¤„ç†è¯·æ±‚, ä¸ºå®¢æˆ·ç«¯æœåŠ¡.
3. Servlet2 å¯¹å®¢æˆ·ç«¯æµè§ˆå™¨åšå‡ºå“åº”.

#### åŒºåˆ«

1. å®šä½ä¸è½¬å‘
   - sendRedirect(): é‡æ–°å®šä½åˆ°å¦å¤–ä¸€ä¸ªèµ„æºæ¥å¤„ç†è¯·æ±‚, URL ä¼šé‡æ–°å®šä½, è®©å®¢æˆ·ç«¯é‡æ–°è®¿é—®å¦å¤–ä¸€ä¸ªèµ„æº.
   - forward(): è½¬å‘åˆ°å¦å¤–ä¸€ä¸ªèµ„æºæ¥å¤„ç†è¯·æ±‚. URL ä¸ä¼šå˜åŒ–. éšè—äº†å¤„ç†å¯¹è±¡çš„å˜åŒ–.
2. å¤„ç†è¯·æ±‚çš„èµ„æºçš„èŒƒå›´
   sendReadirect(): å¯ä»¥è·¨ WEB åº”ç”¨ç¨‹åºå’ŒæœåŠ¡å™¨é‡æ–°å®šä½èµ„æºæ¥å¤„ç†è¯·æ±‚.
   forward(): åªèƒ½åœ¨åº”ç”¨ç¨‹åºå†…éƒ¨è½¬å‘.

## encodeURL()å’Œ encodeRedirectURL() çš„åŒºåˆ«

å½“ç”¨ URL é‡å†™æ–¹å¼æ¥ç®¡ç† Session çš„æ—¶å€™, é€šè¿‡ä»¥ä¸Šä¸¤ä¸ªæ–¹æ³•æŠŠ session ID å†™åˆ° URL ä¸­.
ä¸åŒç‚¹æ˜¯: ä¸¤ä¸ªæ–¹æ³•ç¡®å®šæ˜¯å¦éœ€è¦åŒ…å« session ID çš„é€»è¾‘ä¸åŒ.
åœ¨è°ƒç”¨ HttpServletResponse.sendRedirect å‰, åº”è¯¥å…ˆè°ƒç”¨ encodeRedirectURL() æ–¹æ³•, å¦åˆ™å¯èƒ½ä¼šä¸¢å¤± Sesssion ä¿¡æ¯.

1. `java.lang.String encodeRedirectURL(java.lang.String url)`
   å¯¹ sendRedirect æ–¹æ³•ä½¿ç”¨çš„æŒ‡å®š URL è¿›è¡Œç¼–ç . å¦‚æœä¸éœ€è¦ç¼–ç , å°±ç›´æ¥è¿”å›è¿™ä¸ª URL. ä¹‹æ‰€ä»¥æä¾›è¿™ä¸ªé™„åŠ çš„ç¼–ç æ–¹æ³•, æ˜¯å› ä¸ºåœ¨ redirect çš„æƒ…å†µä¸‹,
   å†³å®šæ˜¯å¦å¯¹ URL è¿›è¡Œç¼–ç  çš„è§„åˆ™å’Œä¸€èˆ¬æƒ…å†µæœ‰æ‰€ä¸åŒ. æ‰€ç»™çš„ URL å¿…é¡»æ˜¯ä¸€ä¸ªç»å¯¹ URL. ç›¸å¯¹ URL ä¸èƒ½è¢«æ¥æ”¶, ä¼šæŠ› å‡ºä¸€ä¸ª
   IllegalArgumentException. æ‰€æœ‰æä¾›ç»™ sendRedirect æ–¹æ³•çš„ URL éƒ½åº”é€šè¿‡ è¿™ä¸ªæ–¹æ³•è¿è¡Œ, è¿™æ ·æ‰èƒ½ç¡®ä¿ä¼šè¯è·Ÿè¸ªèƒ½å¤Ÿåœ¨æ‰€æœ‰æµè§ˆå™¨ä¸­æ­£å¸¸è¿è¡Œ.

2. `java.lang.String encodeURL(java.lang.String url)`
   å¯¹åŒ…å« session ID çš„ URL è¿›è¡Œç¼–ç . å¦‚æœä¸éœ€è¦ç¼–ç , å°±ç›´æ¥è¿”å›è¿™ä¸ª URL. Servlet å¼• æ“å¿…é¡»æä¾› URL ç¼–ç æ–¹æ³•, å› ä¸ºåœ¨æœ‰äº›æƒ…å†µä¸‹, æˆ‘ä»¬å°†ä¸å¾—ä¸é‡å†™
   URL, ä¾‹å¦‚, åœ¨å“åº”å¯¹åº”çš„ è¯·æ±‚ä¸­åŒ…å«ä¸€ä¸ªæœ‰æ•ˆçš„ session, ä½†æ˜¯è¿™ä¸ª session ä¸èƒ½è¢«é URL çš„ï¼ˆä¾‹å¦‚ cookieï¼‰çš„æ‰‹ æ®µæ¥ç»´æŒ. æ‰€æœ‰æä¾›ç»™ Servlet çš„
   URL éƒ½åº”é€šè¿‡è¿™ä¸ªæ–¹æ³•è¿è¡Œ, è¿™æ ·æ‰èƒ½ç¡®ä¿ä¼šè¯è·Ÿè¸ªèƒ½å¤Ÿ åœ¨æ‰€æœ‰æµè§ˆå™¨ä¸­æ­£å¸¸è¿è¡Œ.

## seAttribute ä¸ s etParameter çš„åŒºåˆ«

getAttribute è¡¨ç¤ºä» request èŒƒå›´å–å¾—è®¾ç½®çš„å±æ€§, å¿…é¡»è¦å…ˆ setAttribute è®¾ç½®å±æ€§, æ‰èƒ½é€šè¿‡ getAttribute æ¥å–å¾—, è®¾ç½®ä¸å–å¾—çš„ä¸º Object å¯¹è±¡ç±»å‹
getParameter è¡¨ç¤ºæ¥æ”¶å‚æ•°, å‚æ•°ä¸ºé¡µé¢æäº¤çš„å‚æ•°, åŒ…æ‹¬: è¡¨å•æäº¤çš„å‚æ•°ã€URL é‡å†™ï¼ˆå°±æ˜¯ xxx?id=1 ä¸­çš„ idï¼‰ä¼ çš„å‚æ•°ç­‰, å› æ­¤è¿™ä¸ªå¹¶æ²¡æœ‰è®¾ç½®å‚æ•°çš„æ–¹æ³•ï¼ˆæ²¡æœ‰
setParameterï¼‰, è€Œä¸”æ¥æ”¶å‚æ•°è¿”å›çš„ä¸æ˜¯ Object, è€Œæ˜¯ String ç±»å‹

HttpServletRequest ç±»æ—¢æœ‰ getAttribute()æ–¹æ³•, ä¹Ÿç”± getParameter() æ–¹æ³•, è¿™ä¸¤ä¸ªæ–¹æ³•æœ‰ä»¥ä¸‹åŒºåˆ«:

- HttpServletRequest ç±»æœ‰ setAttribute()æ–¹æ³•, è€Œæ²¡æœ‰ setParameter() æ–¹æ³•
- å½“ä¸¤ä¸ª Web ç»„ä»¶ä¹‹é—´ä¸ºé“¾æ¥å…³ç³»æ—¶, è¢«é“¾æ¥çš„ç»„ä»¶é€šè¿‡ getParameter() æ–¹æ³•æ¥è·å¾—è¯·æ±‚å‚æ•°, ä¾‹å¦‚å‡å®š welcome.jsp å’Œ authenticate.jsp ä¹‹é—´ä¸ºé“¾æ¥å…³ç³»,
  welcome.jsp ä¸­æœ‰ä»¥ä¸‹ä»£ç :

```html
<a href="authenticate.jsp?username=weiqin">authenticate.jsp </a>
```

æˆ–è€…:

```html
<form name="form1" method="post" action="authenticate.jsp">
  è¯·è¾“å…¥ç”¨æˆ·å§“å: <input type="text" name="username" />
  <input type="submit" name="Submit" value="æäº¤" />
</form>
```

åœ¨ authenticate.jsp ä¸­é€šè¿‡ request.getParameter("username") æ–¹æ³•æ¥è·å¾—è¯·æ±‚å‚æ•° username:
`<% String username=request.getParameter("username"); %>`

- å½“ä¸¤ä¸ª Web ç»„ä»¶ä¹‹é—´ä¸ºè½¬å‘å…³ç³»æ—¶, è½¬å‘ç›®æ ‡ç»„ä»¶é€šè¿‡ getAttribute() æ–¹æ³•æ¥å’Œè½¬å‘æºç»„ä»¶å…±äº« request èŒƒå›´å†…çš„æ•°æ®. å‡å®š authenticate.jsp å’Œ
  hello.jsp ä¹‹é—´ä¸ºè½¬å‘å…³ç³». authenticate.jsp å¸Œæœ›å‘ hello.jsp ä¼ é€’å½“å‰çš„ç”¨æˆ·åå­—, å¦‚ä½•ä¼ é€’è¿™ä¸€æ•°æ®å‘¢ï¼Ÿå…ˆåœ¨ authenticate.jsp ä¸­è°ƒç”¨
  setAttribute() æ–¹æ³•:

```xml
<%
String username=request.getParameter("username");
request.setAttribute("username", username);
%>
<jsp:forward page="hello.jsp" />
```

åœ¨ hello.jsp ä¸­é€šè¿‡ getAttribute() æ–¹æ³•è·å¾—ç”¨æˆ·åå­—:

```xml
<% String username=(String)request.getAttribute("username"); %>
Hello: <%=username %>
```

ä»æ›´æ·±çš„å±‚æ¬¡è€ƒè™‘

- request.getParameter()æ–¹æ³•ä¼ é€’çš„æ•°æ®, ä¼šä» Web å®¢æˆ·ç«¯ä¼ åˆ° Web æœåŠ¡å™¨ç«¯, ä»£è¡¨ HTTP è¯·æ±‚æ•°æ®. request.getParameter() æ–¹æ³•è¿”å› String ç±»å‹çš„æ•°æ®.
- request.setAttribute()å’Œ getAttribute() æ–¹æ³•ä¼ é€’çš„æ•°æ®åªä¼šå­˜åœ¨äº Web å®¹å™¨å†…éƒ¨, åœ¨å…·æœ‰è½¬å‘å…³ç³»çš„ Web ç»„ä»¶ä¹‹é—´å…±äº«. è¿™ä¸¤ä¸ªæ–¹æ³•èƒ½å¤Ÿè®¾ç½®
  Object ç±»å‹çš„å…±äº«æ•°æ®.
- request.getParameter()å–å¾—æ˜¯é€šè¿‡å®¹å™¨çš„å®ç°æ¥å–å¾—é€šè¿‡ç±»ä¼¼ post, get ç­‰æ–¹å¼ä¼ å…¥çš„æ•°æ®, request.setAttribute() å’Œ getAttribute() åªæ˜¯åœ¨ web
  å®¹å™¨å†…éƒ¨æµè½¬, ä»…ä»…æ˜¯è¯·æ±‚å¤„ç†é˜¶æ®µ, è¿™ä¸ªçš„ç¡®æ˜¯æ­£è§£.
- getAttribute()æ˜¯è¿”å›å¯¹è±¡, getParameter() è¿”å›å­—ç¬¦ä¸²
- request.getAttribute()æ–¹æ³•è¿”å› request èŒƒå›´å†…å­˜åœ¨çš„å¯¹è±¡, è€Œ request.getParameter() æ–¹æ³•æ˜¯è·å– http æäº¤è¿‡æ¥çš„æ•°æ®.

## [Javaç¨‹åºå‘˜å¿…å¤‡æŠ€èƒ½ï¼šæ€§èƒ½ä¼˜åŒ–çš„35ä¸ªå®ç”¨æŠ€å·§](https://blog.dong4j.site/posts/692bb3c4.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})


ä»£ç ä¼˜åŒ–, ä¸€ä¸ªå¾ˆé‡è¦çš„è¯¾é¢˜. å¯èƒ½æœ‰äº›äººè§‰å¾—æ²¡ç”¨, ä¸€äº›ç»†å°çš„åœ°æ–¹æœ‰ä»€ä¹ˆå¥½ä¿®æ”¹çš„, æ”¹ä¸ä¸æ”¹å¯¹äºä»£ç çš„è¿è¡Œæ•ˆç‡æœ‰ä»€ä¹ˆå½±å“å‘¢ï¼Ÿ
è¿™ä¸ªé—®é¢˜æˆ‘æ˜¯è¿™ä¹ˆè€ƒè™‘çš„, å°±åƒå¤§æµ·é‡Œé¢çš„é²¸é±¼ä¸€æ ·, å®ƒåƒä¸€æ¡å°è™¾ç±³æœ‰ç”¨å—ï¼Ÿæ²¡ç”¨, ä½†æ˜¯, åƒçš„å°è™¾ç±³ä¸€å¤šä¹‹å, é²¸é±¼å°±è¢«å–‚é¥±äº†.
ä»£ç ä¼˜åŒ–ä¹Ÿæ˜¯ä¸€æ ·, å¦‚æœé¡¹ç›®ç€çœ¼äºå°½å¿«æ—  BUG ä¸Šçº¿, é‚£ä¹ˆæ­¤æ—¶å¯ä»¥æŠ“å¤§æ”¾å°, ä»£ç çš„ç»†èŠ‚å¯ä»¥ä¸ç²¾æ‰“ç»†ç£¨.
å¦‚æœæœ‰è¶³å¤Ÿçš„æ—¶é—´å¼€å‘ã€ç»´æŠ¤ä»£ç , è¿™æ—¶å€™å°±å¿…é¡»è€ƒè™‘æ¯ä¸ªå¯ä»¥ä¼˜åŒ–çš„ç»†èŠ‚äº†, ä¸€ä¸ªä¸€ä¸ªç»†å°çš„ä¼˜åŒ–ç‚¹ç´¯ç§¯èµ·æ¥, å¯¹äºä»£ç çš„è¿è¡Œæ•ˆç‡ç»å¯¹æ˜¯æœ‰æå‡çš„.

## ä»£ç ä¼˜åŒ–çš„ç›®æ ‡æ˜¯

1. å‡å°ä»£ç çš„ä½“ç§¯
2. æé«˜ä»£ç è¿è¡Œçš„æ•ˆç‡

## ä»£ç ä¼˜åŒ–ç»†èŠ‚:

### 1. å°½é‡æŒ‡å®šç±»ã€æ–¹æ³•çš„ final ä¿®é¥°ç¬¦

å¸¦æœ‰ final ä¿®é¥°ç¬¦çš„ç±»æ˜¯ä¸å¯æ´¾ç”Ÿçš„. åœ¨ Java æ ¸å¿ƒ API ä¸­, æœ‰è®¸å¤šåº”ç”¨ final çš„ä¾‹å­, ä¾‹å¦‚ java.lang.String, æ•´ä¸ªç±»éƒ½æ˜¯ final çš„.
ä¸ºç±»æŒ‡å®š final ä¿®é¥°ç¬¦å¯ä»¥è®©ç±»ä¸å¯ä»¥è¢«ç»§æ‰¿, ä¸ºæ–¹æ³•æŒ‡å®š final ä¿®é¥°ç¬¦å¯ä»¥è®©æ–¹æ³•ä¸å¯ä»¥è¢«é‡å†™. å¦‚æœæŒ‡å®šäº†ä¸€ä¸ªç±»ä¸º final, åˆ™è¯¥ç±»æ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯
final çš„.
Java ç¼–è¯‘å™¨ä¼šå¯»æ‰¾æœºä¼šå†…è”æ‰€æœ‰çš„ final æ–¹æ³•, å†…è”å¯¹äºæå‡ Java è¿è¡Œæ•ˆç‡ä½œç”¨é‡å¤§, å…·ä½“å‚è§ Java è¿è¡ŒæœŸä¼˜åŒ–. æ­¤ä¸¾èƒ½å¤Ÿä½¿æ€§èƒ½å¹³å‡æé«˜ 50%.

### 2. å°½é‡é‡ç”¨å¯¹è±¡

ç‰¹åˆ«æ˜¯ String å¯¹è±¡çš„ä½¿ç”¨, å‡ºç°å­—ç¬¦ä¸²è¿æ¥æ—¶åº”è¯¥ä½¿ç”¨ StringBuilder/StringBuffer ä»£æ›¿.
ç”±äº Java è™šæ‹Ÿæœºä¸ä»…è¦èŠ±æ—¶é—´ç”Ÿæˆå¯¹è±¡, ä»¥åå¯èƒ½è¿˜éœ€è¦èŠ±æ—¶é—´å¯¹è¿™äº›å¯¹è±¡è¿›è¡Œåƒåœ¾å›æ”¶å’Œå¤„ç†, å› æ­¤, ç”Ÿæˆè¿‡å¤šçš„å¯¹è±¡å°†ä¼šç»™ç¨‹åºçš„æ€§èƒ½å¸¦æ¥å¾ˆå¤§çš„å½±å“.
ã€å°½å¯èƒ½ä½¿ç”¨å±€éƒ¨å˜

### 3. å°½å¯èƒ½ä½¿ç”¨å±€éƒ¨å˜é‡

è°ƒç”¨æ–¹æ³•æ—¶ä¼ é€’çš„å‚æ•°ä»¥åŠåœ¨è°ƒç”¨ä¸­åˆ›å»ºçš„ä¸´æ—¶å˜é‡éƒ½ä¿å­˜åœ¨æ ˆä¸­é€Ÿåº¦è¾ƒå¿«, å…¶ä»–å˜é‡, å¦‚é™æ€å˜é‡ã€å®ä¾‹å˜é‡ç­‰, éƒ½åœ¨å †ä¸­åˆ›å»º, é€Ÿåº¦è¾ƒæ…¢.
å¦å¤–, æ ˆä¸­åˆ›å»ºçš„å˜é‡, éšç€æ–¹æ³•çš„è¿è¡Œç»“æŸ, è¿™äº›å†…å®¹å°±æ²¡äº†, ä¸éœ€è¦é¢å¤–çš„åƒåœ¾å›æ”¶.

4. åŠæ—¶å…³é—­æµ
   Java ç¼–ç¨‹è¿‡ç¨‹ä¸­, è¿›è¡Œæ•°æ®åº“è¿æ¥ã€I/O æµæ“ä½œæ—¶åŠ¡å¿…å°å¿ƒ, åœ¨ä½¿ç”¨å®Œæ¯•å, åŠæ—¶å…³é—­ä»¥é‡Šæ”¾èµ„æº.
   å› ä¸ºå¯¹è¿™äº›å¤§å¯¹è±¡çš„æ“ä½œä¼šé€ æˆç³»ç»Ÿå¤§çš„å¼€é”€, ç¨æœ‰ä¸æ…, å°†ä¼šå¯¼è‡´ä¸¥é‡çš„åæœ.

5. å°½é‡å‡å°‘å¯¹å˜é‡çš„é‡å¤è®¡ç®—
   æ˜ç¡®ä¸€ä¸ªæ¦‚å¿µ, å¯¹æ–¹æ³•çš„è°ƒç”¨, å³ä½¿æ–¹æ³•ä¸­åªæœ‰ä¸€å¥è¯­å¥, ä¹Ÿæ˜¯æœ‰æ¶ˆè€—çš„, åŒ…æ‹¬åˆ›å»ºæ ˆå¸§ã€è°ƒç”¨æ–¹æ³•æ—¶ä¿æŠ¤ç°åœºã€è°ƒç”¨æ–¹æ³•å®Œæ¯•æ—¶æ¢å¤ç°åœºç­‰.
   æ‰€ä»¥ä¾‹å¦‚ä¸‹é¢çš„æ“ä½œ:

```java
for (int i = 0; i < list.size(); i++){
...
}
```

å»ºè®®æ›¿æ¢ä¸º:

```java
for (int i = 0, int length = list.size(); i < length; i++){
        ...
}
```

è¿™æ ·, åœ¨ list.size() å¾ˆå¤§çš„æ—¶å€™, å°±å‡å°‘äº†å¾ˆå¤šçš„æ¶ˆè€—

6. å°½é‡é‡‡ç”¨æ‡’åŠ è½½çš„ç­–ç•¥, å³åœ¨éœ€è¦çš„æ—¶å€™æ‰åˆ›å»º
   ä¾‹å¦‚:

```java
String str = "aaa";if (i == 1){
    list.add(str);
}
```

å»ºè®®æ›¿æ¢ä¸º:

```java
if (i == 1){
	String str = "aaa";
list.add(str);
}
```

7. æ…ç”¨å¼‚å¸¸
   å¼‚å¸¸å¯¹æ€§èƒ½ä¸åˆ©. æŠ›å‡ºå¼‚å¸¸é¦–å…ˆè¦åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡, Throwable æ¥å£çš„æ„é€ å‡½æ•°è°ƒç”¨åä¸º fillInStackTrace()çš„æœ¬åœ°åŒæ­¥æ–¹æ³•, fillInStackTrace()
   æ–¹æ³•æ£€æŸ¥å †æ ˆ, æ”¶é›†è°ƒç”¨è·Ÿè¸ªä¿¡æ¯.
   åªè¦æœ‰å¼‚å¸¸è¢«æŠ›å‡º, Java è™šæ‹Ÿæœºå°±å¿…é¡»è°ƒæ•´è°ƒç”¨å †æ ˆ, å› ä¸ºåœ¨å¤„ç†è¿‡ç¨‹ä¸­åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡. å¼‚å¸¸åªèƒ½ç”¨äºé”™è¯¯å¤„ç†, ä¸åº”è¯¥ç”¨æ¥æ§åˆ¶ç¨‹åºæµç¨‹.

8. ä¸è¦åœ¨å¾ªç¯ä¸­ä½¿ç”¨ tryâ€¦catchâ€¦, åº”è¯¥æŠŠå…¶æ”¾åœ¨æœ€å¤–å±‚
   é™¤éä¸å¾—å·². å¦‚æœæ¯«æ— ç†ç”±åœ°è¿™ä¹ˆå†™äº†, åªè¦ä½ çš„é¢†å¯¼èµ„æ·±ä¸€ç‚¹ã€æœ‰å¼ºè¿«ç—‡ä¸€ç‚¹, å…«æˆå°±è¦éª‚ä½ ä¸ºä»€ä¹ˆå†™å‡ºè¿™ç§åƒåœ¾ä»£ç æ¥äº†

9. å¦‚æœèƒ½ä¼°è®¡åˆ°å¾…æ·»åŠ çš„å†…å®¹é•¿åº¦, ä¸ºåº•å±‚ä»¥æ•°ç»„æ–¹å¼å®ç°çš„é›†åˆã€å·¥å…·ç±»æŒ‡å®šåˆå§‹é•¿åº¦
   æ¯”å¦‚ ArrayListã€LinkedLlistã€StringBuilderã€StringBufferã€HashMapã€HashSet ç­‰ç­‰, ä»¥ StringBuilder ä¸ºä¾‹:

- StringBuilder()// é»˜è®¤åˆ†é… 16 ä¸ªå­—ç¬¦çš„ç©ºé—´
- StringBuilder(int size)// é»˜è®¤åˆ†é… size ä¸ªå­—ç¬¦çš„ç©ºé—´
- StringBuilder(String str)// é»˜è®¤åˆ†é… 16 ä¸ªå­—ç¬¦ +str.length() ä¸ªå­—ç¬¦ç©ºé—´

å¯ä»¥é€šè¿‡ç±»ï¼ˆè¿™é‡ŒæŒ‡çš„ä¸ä»…ä»…æ˜¯ä¸Šé¢çš„ StringBuilderï¼‰çš„æ¥è®¾å®šå®ƒçš„åˆå§‹åŒ–å®¹é‡, è¿™æ ·å¯ä»¥æ˜æ˜¾åœ°æå‡æ€§èƒ½.

æ¯”å¦‚ StringBuilder å§, length è¡¨ç¤ºå½“å‰çš„ StringBuilder èƒ½ä¿æŒçš„å­—ç¬¦æ•°é‡. å› ä¸ºå½“ StringBuilder è¾¾åˆ°æœ€å¤§å®¹é‡çš„æ—¶å€™, å®ƒä¼šå°†è‡ªèº«å®¹é‡å¢åŠ åˆ°å½“å‰çš„
2 å€å†åŠ  2.

æ— è®ºä½•æ—¶åªè¦ StringBuilder è¾¾åˆ°å®ƒçš„æœ€å¤§å®¹é‡, å®ƒå°±ä¸å¾—ä¸åˆ›å»ºä¸€ä¸ªæ–°çš„å­—ç¬¦æ•°ç»„ç„¶åå°†æ—§çš„å­—ç¬¦æ•°ç»„å†…å®¹æ‹·è´åˆ°æ–°å­—ç¬¦æ•°ç»„ä¸­â€”- è¿™æ˜¯ååˆ†è€—è´¹æ€§èƒ½çš„ä¸€ä¸ªæ“ä½œ.
è¯•æƒ³, å¦‚æœèƒ½é¢„ä¼°åˆ°å­—ç¬¦æ•°ç»„ä¸­å¤§æ¦‚è¦å­˜æ”¾ 5000 ä¸ªå­—ç¬¦è€Œä¸æŒ‡å®šé•¿åº¦, æœ€æ¥è¿‘ 5000 çš„ 2 æ¬¡å¹‚æ˜¯ 4096, æ¯æ¬¡æ‰©å®¹åŠ çš„ 2 ä¸ç®¡, é‚£ä¹ˆ:

ï¼ˆ1ï¼‰åœ¨ 4096 çš„åŸºç¡€ä¸Š, å†ç”³è¯· 8194 ä¸ªå¤§å°çš„å­—ç¬¦æ•°ç»„, åŠ èµ·æ¥ç›¸å½“äºä¸€æ¬¡ç”³è¯·äº† 12290 ä¸ªå¤§å°çš„å­—ç¬¦æ•°ç»„, å¦‚æœä¸€å¼€å§‹èƒ½æŒ‡å®š 5000 ä¸ªå¤§å°çš„å­—ç¬¦æ•°ç»„,
å°±èŠ‚çœäº†ä¸€å€ä»¥ä¸Šçš„ç©ºé—´

ï¼ˆ2ï¼‰æŠŠåŸæ¥çš„ 4096 ä¸ªå­—ç¬¦æ‹·è´åˆ°æ–°çš„çš„å­—ç¬¦æ•°ç»„ä¸­å»

è¿™æ ·, æ—¢æµªè´¹å†…å­˜ç©ºé—´åˆé™ä½ä»£ç è¿è¡Œæ•ˆç‡. æ‰€ä»¥, ç»™åº•å±‚ä»¥æ•°ç»„å®ç°çš„é›†åˆã€å·¥å…·ç±»è®¾ç½®ä¸€ä¸ªåˆç†çš„åˆå§‹åŒ–å®¹é‡æ˜¯é”™ä¸äº†çš„, è¿™ä¼šå¸¦æ¥ç«‹ç«¿è§å½±çš„æ•ˆæœ.

ä½†æ˜¯, æ³¨æ„, åƒ HashMap è¿™ç§æ˜¯ä»¥æ•°ç»„ + é“¾è¡¨å®ç°çš„é›†åˆ, åˆ«æŠŠåˆå§‹å¤§å°å’Œä½ ä¼°è®¡çš„å¤§å°è®¾ç½®å¾—ä¸€æ ·, å› ä¸ºä¸€ä¸ª table ä¸Šåªè¿æ¥ä¸€ä¸ªå¯¹è±¡çš„å¯èƒ½æ€§å‡ ä¹ä¸º 0.

åˆå§‹å¤§å°å»ºè®®è®¾ç½®ä¸º 2 çš„ N æ¬¡å¹‚, å¦‚æœèƒ½ä¼°è®¡åˆ°æœ‰ 2000 ä¸ªå…ƒç´ , è®¾ç½®æˆ new HashMap(128)ã€new HashMap(256) éƒ½å¯ä»¥.

10. å½“å¤åˆ¶å¤§é‡æ•°æ®æ—¶, ä½¿ç”¨ System.arraycopy() å‘½ä»¤
11. ä¹˜æ³•å’Œé™¤æ³•ä½¿ç”¨ç§»ä½æ“ä½œ
    ä¾‹å¦‚:

```java
for (val = 0; val < 100000; val += 5){
	a = val * 8;
	b = val / 2;
}
```

ç”¨ç§»ä½æ“ä½œå¯ä»¥æå¤§åœ°æé«˜æ€§èƒ½, å› ä¸ºåœ¨è®¡ç®—æœºåº•å±‚, å¯¹ä½çš„æ“ä½œæ˜¯æœ€æ–¹ä¾¿ã€æœ€å¿«çš„, å› æ­¤å»ºè®®ä¿®æ”¹ä¸º:

```java
for (val = 0; val < 100000; val += 5){
	a = val << 3;
	b = val >> 1;
}
```

ç§»ä½æ“ä½œè™½ç„¶å¿«, ä½†æ˜¯å¯èƒ½ä¼šä½¿ä»£ç ä¸å¤ªå¥½ç†è§£, å› æ­¤æœ€å¥½åŠ ä¸Šç›¸åº”çš„æ³¨é‡Š.

12. å¾ªç¯å†…ä¸è¦ä¸æ–­åˆ›å»ºå¯¹è±¡å¼•ç”¨
    ä¾‹å¦‚:

```java
for (int i = 1; i <= count; i++){
	Object obj = new Object();
}
```

è¿™ç§åšæ³•ä¼šå¯¼è‡´å†…å­˜ä¸­æœ‰ count ä»½ Object å¯¹è±¡å¼•ç”¨å­˜åœ¨, count å¾ˆå¤§çš„è¯, å°±è€—è´¹å†…å­˜äº†, å»ºè®®ä¸ºæ”¹ä¸º:

```java
Object obj = null;
for (int i = 0; i <= count; i++) {
	obj = new Object();
}
```

è¿™æ ·çš„è¯, å†…å­˜ä¸­åªæœ‰ä¸€ä»½ Object å¯¹è±¡å¼•ç”¨, æ¯æ¬¡ new Object() çš„æ—¶å€™, Object å¯¹è±¡å¼•ç”¨æŒ‡å‘ä¸åŒçš„ Object ç½¢äº†, ä½†æ˜¯å†…å­˜ä¸­åªæœ‰ä¸€ä»½,
è¿™æ ·å°±å¤§å¤§èŠ‚çœäº†å†…å­˜ç©ºé—´äº†.

13. åŸºäºæ•ˆç‡å’Œç±»å‹æ£€æŸ¥çš„è€ƒè™‘, åº”è¯¥å°½å¯èƒ½ä½¿ç”¨ array, æ— æ³•ç¡®å®šæ•°ç»„å¤§å°æ—¶æ‰ä½¿ç”¨ ArrayList ç”¨

14. å°½é‡ä½¿ç”¨ HashMapã€ArrayListã€StringBuilder, é™¤éçº¿ç¨‹å®‰å…¨éœ€è¦, å¦åˆ™ä¸æ¨èä½¿ç”¨ Hashtableã€Vectorã€StringBuffer, åä¸‰è€…ç”±äºä½¿ç”¨åŒæ­¥æœºåˆ¶è€Œå¯¼è‡´äº†æ€§èƒ½å¼€é”€æŸ¥çš„è€ƒè™‘,
    åº”è¯¥å°½å¯èƒ½ä½¿ç”¨ array, æ— æ³•ç¡®å®šæ•°ç»„å¤§

15. ä¸è¦å°†æ•°ç»„å£°æ˜ä¸º public static final
    å› ä¸ºè¿™æ¯«æ— æ„ä¹‰, è¿™æ ·åªæ˜¯å®šä¹‰äº†å¼•ç”¨ä¸º static final, æ•°ç»„çš„å†…å®¹è¿˜æ˜¯å¯ä»¥éšæ„æ”¹å˜çš„, å°†æ•°ç»„å£°æ˜ä¸º public æ›´æ˜¯ä¸€ä¸ªå®‰å…¨æ¼æ´, è¿™æ„å‘³ç€è¿™ä¸ªæ•°ç»„å¯ä»¥è¢«å¤–éƒ¨ç±»æ‰€æ”¹å˜

16. å°½é‡åœ¨åˆé€‚çš„åœºåˆä½¿ç”¨å•ä¾‹
    ä½¿ç”¨å•ä¾‹å¯ä»¥å‡è½»åŠ è½½çš„è´Ÿæ‹…ã€ç¼©çŸ­åŠ è½½çš„æ—¶é—´ã€æé«˜åŠ è½½çš„æ•ˆç‡, ä½†å¹¶ä¸æ˜¯æ‰€æœ‰åœ°æ–¹éƒ½é€‚ç”¨äºå•ä¾‹, ç®€å•æ¥è¯´, å•ä¾‹ä¸»è¦é€‚ç”¨äºä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢:

- æ§åˆ¶èµ„æºçš„ä½¿ç”¨, é€šè¿‡çº¿ç¨‹åŒæ­¥æ¥æ§åˆ¶èµ„æºçš„å¹¶å‘è®¿é—®
- æ§åˆ¶å®ä¾‹çš„äº§ç”Ÿ, ä»¥è¾¾åˆ°èŠ‚çº¦èµ„æºçš„ç›®çš„
- æ§åˆ¶æ•°æ®çš„å…±äº«, åœ¨ä¸å»ºç«‹ç›´æ¥å…³è”çš„æ¡ä»¶ä¸‹, è®©å¤šä¸ªä¸ç›¸å…³çš„è¿›ç¨‹æˆ–çº¿ç¨‹ä¹‹é—´å®ç°é€šä¿¡

17. å°½é‡é¿å…éšæ„ä½¿ç”¨é™æ€å˜é‡
    è¦çŸ¥é“, å½“æŸä¸ªå¯¹è±¡è¢«å®šä¹‰ä¸º static çš„å˜é‡æ‰€å¼•ç”¨, é‚£ä¹ˆ gc é€šå¸¸æ˜¯ä¸ä¼šå›æ”¶è¿™ä¸ªå¯¹è±¡æ‰€å æœ‰çš„å †å†…å­˜çš„, å¦‚:

```java
public class A{
	private static B b = new B();
}
```

æ­¤æ—¶é™æ€å˜é‡ b çš„ç”Ÿå‘½å‘¨æœŸä¸ A ç±»ç›¸åŒ, å¦‚æœ A ç±»ä¸è¢«å¸è½½, é‚£ä¹ˆå¼•ç”¨ B æŒ‡å‘çš„ B å¯¹è±¡ä¼šå¸¸é©»å†…å­˜, ç›´åˆ°ç¨‹åºç»ˆæ­¢

18. åŠæ—¶æ¸…é™¤ä¸å†éœ€è¦çš„ä¼šè¯
    ä¸ºäº†æ¸…é™¤ä¸å†æ´»åŠ¨çš„ä¼šè¯, è®¸å¤šåº”ç”¨æœåŠ¡å™¨éƒ½æœ‰é»˜è®¤çš„ä¼šè¯è¶…æ—¶æ—¶é—´, ä¸€èˆ¬ä¸º 30 åˆ†é’Ÿ.
    å½“åº”ç”¨æœåŠ¡å™¨éœ€è¦ä¿å­˜æ›´å¤šçš„ä¼šè¯æ—¶, å¦‚æœå†…å­˜ä¸è¶³, é‚£ä¹ˆæ“ä½œç³»ç»Ÿä¼šæŠŠéƒ¨åˆ†æ•°æ®è½¬ç§»åˆ°ç£ç›˜.
    åº”ç”¨æœåŠ¡å™¨ä¹Ÿå¯èƒ½æ ¹æ® MRUï¼ˆæœ€è¿‘æœ€é¢‘ç¹ä½¿ç”¨ï¼‰ç®—æ³•æŠŠéƒ¨åˆ†ä¸æ´»è·ƒçš„ä¼šè¯è½¬å‚¨åˆ°ç£ç›˜, ç”šè‡³å¯èƒ½æŠ›å‡ºå†…å­˜ä¸è¶³çš„å¼‚å¸¸.
    å¦‚æœä¼šè¯è¦è¢«è½¬å‚¨åˆ°ç£ç›˜, é‚£ä¹ˆå¿…é¡»è¦å…ˆè¢«åºåˆ—åŒ–, åœ¨å¤§è§„æ¨¡é›†ç¾¤ä¸­, å¯¹å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–çš„ä»£ä»·æ˜¯å¾ˆæ˜‚è´µçš„.
    å› æ­¤, å½“ä¼šè¯ä¸å†éœ€è¦æ—¶, åº”å½“åŠæ—¶è°ƒç”¨ HttpSession çš„ invalidate() æ–¹æ³•æ¸…é™¤ä¼šè¯.

19. å®ç° RandomAccess æ¥å£çš„é›†åˆæ¯”å¦‚ ArrayList, åº”å½“ä½¿ç”¨æœ€æ™®é€šçš„ for å¾ªç¯è€Œä¸æ˜¯ foreach å¾ªç¯æ¥éå†
    è¿™æ˜¯ JDK æ¨èç»™ç”¨æˆ·çš„. JDK API å¯¹äº RandomAccess æ¥å£çš„è§£é‡Šæ˜¯: å®ç° RandomAccess æ¥å£ç”¨æ¥è¡¨æ˜å…¶æ”¯æŒå¿«é€Ÿéšæœºè®¿é—®.
    æ­¤æ¥å£çš„ä¸»è¦ç›®çš„æ˜¯å…è®¸ä¸€èˆ¬çš„ç®—æ³•æ›´æ”¹å…¶è¡Œä¸º, ä»è€Œå°†å…¶åº”ç”¨åˆ°éšæœºæˆ–è¿ç»­è®¿é—®åˆ—è¡¨æ—¶èƒ½æä¾›è‰¯å¥½çš„æ€§èƒ½.
    å®é™…ç»éªŒè¡¨æ˜, å®ç° RandomAccess æ¥å£çš„ç±»å®ä¾‹, å‡å¦‚æ˜¯éšæœºè®¿é—®çš„, ä½¿ç”¨æ™®é€š for å¾ªç¯æ•ˆç‡å°†é«˜äºä½¿ç”¨ foreach å¾ªç¯.
    åè¿‡æ¥, å¦‚æœæ˜¯é¡ºåºè®¿é—®çš„, åˆ™ä½¿ç”¨ Iterator ä¼šæ•ˆç‡æ›´é«˜. å¯ä»¥ä½¿ç”¨ç±»ä¼¼å¦‚ä¸‹çš„ä»£ç ä½œåˆ¤æ–­:

```java
if (list instanceof RandomAccess){
	for (int i = 0; i < list.size(); i++){}
}else{
	Iterator<?> iterator = list.iterable();
	while (iterator.hasNext()){
		iterator.next()
		}
}
```

foreach å¾ªç¯çš„åº•å±‚å®ç°åŸç†å°±æ˜¯è¿­ä»£å™¨ Iterator, å‚è§ Java è¯­æ³•ç³– 1: å¯å˜é•¿åº¦å‚æ•°ä»¥åŠ foreach å¾ªç¯åŸç†.
æ‰€ä»¥ååŠå¥â€åè¿‡æ¥, å¦‚æœæ˜¯é¡ºåºè®¿é—®çš„, åˆ™ä½¿ç”¨ Iterator ä¼šæ•ˆç‡æ›´é«˜â€çš„æ„æ€å°±æ˜¯é¡ºåºè®¿é—®çš„é‚£äº›ç±»å®ä¾‹, ä½¿ç”¨ foreach å¾ªç¯å»éå†.

20. ä½¿ç”¨åŒæ­¥ä»£ç å—æ›¿ä»£åŒæ­¥æ–¹æ³•
    è¿™ç‚¹åœ¨å¤šçº¿ç¨‹æ¨¡å—ä¸­çš„ synchronized é”æ–¹æ³•å—ä¸€æ–‡ä¸­å·²ç»è®²å¾—å¾ˆæ¸…æ¥šäº†, é™¤éèƒ½ç¡®å®šä¸€æ•´ä¸ªæ–¹æ³•éƒ½æ˜¯éœ€è¦è¿›è¡ŒåŒæ­¥çš„, å¦åˆ™å°½é‡ä½¿ç”¨åŒæ­¥ä»£ç å—,
    é¿å…å¯¹é‚£äº›ä¸éœ€è¦è¿›è¡ŒåŒæ­¥çš„ä»£ç ä¹Ÿè¿›è¡Œäº†åŒæ­¥, å½±å“äº†ä»£ç æ‰§è¡Œæ•ˆç‡.

21. å°†å¸¸é‡å£°æ˜ä¸º static final, å¹¶ä»¥å¤§å†™å‘½å
    è¿™æ ·åœ¨ç¼–è¯‘æœŸé—´å°±å¯ä»¥æŠŠè¿™äº›å†…å®¹æ”¾å…¥å¸¸é‡æ± ä¸­, é¿å…è¿è¡ŒæœŸé—´è®¡ç®—ç”Ÿæˆå¸¸é‡çš„å€¼. å¦å¤–, å°†å¸¸é‡çš„åå­—ä»¥å¤§å†™å‘½åä¹Ÿå¯ä»¥æ–¹ä¾¿åŒºåˆ†å‡ºå¸¸é‡ä¸å˜é‡

22. ä¸è¦åˆ›å»ºä¸€äº›ä¸ä½¿ç”¨çš„å¯¹è±¡, ä¸è¦å¯¼å…¥ä¸€äº›ä¸ä½¿ç”¨çš„ç±»
    è¿™æ¯«æ— æ„ä¹‰, å¦‚æœä»£ç ä¸­å‡ºç°â€The value of the local variable i is not usedâ€ã€â€The import java.util is never usedâ€, é‚£ä¹ˆè¯·åˆ é™¤è¿™äº›æ— ç”¨çš„å†…å®¹

23. ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­é¿å…ä½¿ç”¨åå°„
    å…³äº, è¯·å‚è§åå°„. åå°„æ˜¯ Java æä¾›ç»™ç”¨æˆ·ä¸€ä¸ªå¾ˆå¼ºå¤§çš„åŠŸèƒ½, åŠŸèƒ½å¼ºå¤§å¾€å¾€æ„å‘³ç€æ•ˆç‡ä¸é«˜.
    ä¸å»ºè®®åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ä½¿ç”¨å°¤å…¶æ˜¯é¢‘ç¹ä½¿ç”¨åå°„æœºåˆ¶, ç‰¹åˆ«æ˜¯ Method çš„ invoke æ–¹æ³•.
    å¦‚æœç¡®å®æœ‰å¿…è¦, ä¸€ç§å»ºè®®æ€§çš„åšæ³•æ˜¯å°†é‚£äº›éœ€è¦é€šè¿‡åå°„åŠ è½½çš„ç±»åœ¨é¡¹ç›®å¯åŠ¨çš„æ—¶å€™é€šè¿‡åå°„å®ä¾‹åŒ–å‡ºä¸€ä¸ªå¯¹è±¡å¹¶æ”¾å…¥å†…å­˜â€”- ç”¨æˆ·åªå…³å¿ƒå’Œå¯¹ç«¯äº¤äº’çš„æ—¶å€™è·å–æœ€å¿«çš„å“åº”é€Ÿåº¦,
    å¹¶ä¸å…³å¿ƒå¯¹ç«¯çš„é¡¹ç›®å¯åŠ¨èŠ±å¤šä¹…æ—¶é—´.

24. ä½¿ç”¨æ•°æ®åº“è¿æ¥æ± å’Œçº¿ç¨‹æ± 
    è¿™ä¸¤ä¸ªæ± éƒ½æ˜¯ç”¨äºé‡ç”¨å¯¹è±¡çš„, å‰è€…å¯ä»¥é¿å…é¢‘ç¹åœ°æ‰“å¼€å’Œå…³é—­è¿æ¥, åè€…å¯ä»¥é¿å…é¢‘ç¹åœ°åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹

25. ä½¿ç”¨å¸¦ç¼“å†²çš„è¾“å…¥è¾“å‡ºæµè¿›è¡Œ IO æ“ä½œ
    å¸¦ç¼“å†²çš„è¾“å…¥è¾“å‡ºæµ, å³ BufferedReaderã€BufferedWriterã€BufferedInputStreamã€BufferedOutputStream, è¿™å¯ä»¥æå¤§åœ°æå‡ IO æ•ˆç‡

26. é¡ºåºæ’å…¥å’Œéšæœºè®¿é—®æ¯”è¾ƒå¤šçš„åœºæ™¯ä½¿ç”¨ ArrayList, å…ƒç´ åˆ é™¤å’Œä¸­é—´æ’å…¥æ¯”è¾ƒå¤šçš„åœºæ™¯ä½¿ç”¨ LinkedList
    è¿™ä¸ª, ç†è§£ ArrayList å’Œ LinkedList çš„åŸç†å°±çŸ¥é“äº†

27. ä¸è¦è®© public æ–¹æ³•ä¸­æœ‰å¤ªå¤šçš„å½¢å‚
    public æ–¹æ³•å³å¯¹å¤–æä¾›çš„æ–¹æ³•, å¦‚æœç»™è¿™äº›æ–¹æ³•å¤ªå¤šå½¢å‚çš„è¯ä¸»è¦æœ‰ä¸¤ç‚¹åå¤„:

- è¿åäº†é¢å‘å¯¹è±¡çš„ç¼–ç¨‹æ€æƒ³, Java è®²æ±‚ä¸€åˆ‡éƒ½æ˜¯å¯¹è±¡, å¤ªå¤šçš„å½¢å‚, å’Œé¢å‘å¯¹è±¡çš„ç¼–ç¨‹æ€æƒ³å¹¶ä¸å¥‘åˆ
- å‚æ•°å¤ªå¤šåŠ¿å¿…å¯¼è‡´æ–¹æ³•è°ƒç”¨çš„å‡ºé”™æ¦‚ç‡å¢åŠ 

è‡³äºè¿™ä¸ªâ€å¤ªå¤šâ€æŒ‡çš„æ˜¯å¤šå°‘ä¸ª, 3ã€4 ä¸ªå§.
æ¯”å¦‚æˆ‘ä»¬ç”¨ JDBC å†™ä¸€ä¸ª insertStudentInfo æ–¹æ³•, æœ‰ 10 ä¸ªå­¦ç”Ÿä¿¡æ¯å­—æ®µè¦æ’å¦‚ Student è¡¨ä¸­, å¯ä»¥æŠŠè¿™ 10 ä¸ªå‚æ•°å°è£…åœ¨ä¸€ä¸ªå®ä½“ç±»ä¸­, ä½œä¸º insert
æ–¹æ³•çš„å½¢å‚

28. å­—ç¬¦ä¸²å˜é‡å’Œå­—ç¬¦ä¸²å¸¸é‡ equals çš„æ—¶å€™å°†å­—ç¬¦ä¸²å¸¸é‡å†™åœ¨å‰é¢
    è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„å°æŠ€å·§äº†, å¦‚æœæœ‰ä»¥ä¸‹ä»£ç :

```java
String str = "123";
if (str.equals("123")) {
	...
}
```

å»ºè®®ä¿®æ”¹ä¸º:

```java
String str = "123";
	if ("123".equals(str)){
		...
}
```

è¿™ä¹ˆåšä¸»è¦æ˜¯å¯ä»¥é¿å…ç©ºæŒ‡é’ˆå¼‚å¸¸

29. è¯·çŸ¥é“, åœ¨ java ä¸­ if (i == 1) å’Œ if (1 == i) æ˜¯æ²¡æœ‰åŒºåˆ«çš„, ä½†ä»é˜…è¯»ä¹ æƒ¯ä¸Šè®², å»ºè®®ä½¿ç”¨å‰è€…
    å¹³æ—¶æœ‰äººé—®, â€if (i == 1)â€å’Œâ€if (1== i)â€æœ‰æ²¡æœ‰åŒºåˆ«, è¿™å°±è¦ä» C/C++ è®²èµ·.
    åœ¨ C/C++ ä¸­, â€if (i == 1)â€åˆ¤æ–­æ¡ä»¶æˆç«‹, æ˜¯ä»¥ 0 ä¸é 0 ä¸ºåŸºå‡†çš„, 0 è¡¨ç¤º false, é 0 è¡¨ç¤º true, å¦‚æœæœ‰è¿™ä¹ˆä¸€æ®µä»£ç :

```java
int i = 2;
if (i == 1){
	...
}else{
...
}
```

C/C++ åˆ¤æ–­â€i==1â€³ä¸æˆç«‹, æ‰€ä»¥ä»¥ 0 è¡¨ç¤º, å³ false. ä½†æ˜¯å¦‚æœ:

```java
int i = 2;
if (i = 1) {
  ...
}else{
  ...
}
```

ä¸‡ä¸€ç¨‹åºå‘˜ä¸€ä¸ªä¸å°å¿ƒ, æŠŠâ€if (i == 1)â€å†™æˆâ€if (i = 1)â€, è¿™æ ·å°±æœ‰é—®é¢˜äº†.
åœ¨ if ä¹‹å†…å°† i èµ‹å€¼ä¸º 1, if åˆ¤æ–­é‡Œé¢çš„å†…å®¹é 0, è¿”å›çš„å°±æ˜¯ true äº†, ä½†æ˜¯æ˜æ˜ i ä¸º 2, æ¯”è¾ƒçš„å€¼æ˜¯ 1, åº”è¯¥è¿”å›çš„ false.

è¿™ç§æƒ…å†µåœ¨ C/C++ çš„å¼€å‘ä¸­æ˜¯å¾ˆå¯èƒ½å‘ç”Ÿçš„å¹¶ä¸”ä¼šå¯¼è‡´ä¸€äº›éš¾ä»¥ç†è§£çš„é”™è¯¯äº§ç”Ÿ, æ‰€ä»¥, ä¸ºäº†é¿å…å¼€å‘è€…åœ¨ if è¯­å¥ä¸­ä¸æ­£ç¡®çš„èµ‹å€¼æ“ä½œ, å»ºè®®å°† if
è¯­å¥å†™ä¸º:

```java
int i = 2;
if (1 == i) {
	 ...
 }else{
	  ...
  }
```

è¿™æ ·, å³ä½¿å¼€å‘è€…ä¸å°å¿ƒå†™æˆäº†â€1 = iâ€, C/C++ ç¼–è¯‘å™¨ä¹Ÿå¯ä»¥ç¬¬ä¸€æ—¶é—´æ£€æŸ¥å‡ºæ¥, å› ä¸ºæˆ‘ä»¬å¯ä»¥å¯¹ä¸€ä¸ªå˜é‡èµ‹å€¼ i ä¸º 1, ä½†æ˜¯ä¸èƒ½å¯¹ä¸€ä¸ªå¸¸é‡èµ‹å€¼ 1 ä¸º i.

ä½†æ˜¯, åœ¨ Java ä¸­, C/C++ è¿™ç§â€if (i = 1)â€çš„è¯­æ³•æ˜¯ä¸å¯èƒ½å‡ºç°çš„, å› ä¸ºä¸€æ—¦å†™äº†è¿™ç§è¯­æ³•, Java å°±ä¼šç¼–è¯‘æŠ¥é”™â€Type mismatch: cannot convert from int
to booleanâ€.

ä½†æ˜¯, å°½ç®¡ Java çš„â€if (i == 1)â€å’Œâ€if (1 == i)â€åœ¨è¯­ä¹‰ä¸Šæ²¡æœ‰ä»»ä½•åŒºåˆ«, ä½†æ˜¯ä»é˜…è¯»ä¹ æƒ¯ä¸Šè®², å»ºè®®ä½¿ç”¨å‰è€…ä¼šæ›´å¥½äº›

30. ä¸è¦å¯¹æ•°ç»„ä½¿ç”¨ toString() æ–¹æ³•
    çœ‹ä¸€ä¸‹å¯¹æ•°ç»„ä½¿ç”¨ toString() æ‰“å°å‡ºæ¥çš„æ˜¯ä»€ä¹ˆ:

```java
public static void main(String[] args){
	int[] is = new int[]{1, 2, 3};
	System.out.println(is.toString());
}

ç»“æœæ˜¯:
[I@18a992f
```

æœ¬æ„æ˜¯æƒ³æ‰“å°å‡ºæ•°ç»„å†…å®¹, å´æœ‰å¯èƒ½å› ä¸ºæ•°ç»„å¼•ç”¨ is ä¸ºç©ºè€Œå¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸.
ä¸è¿‡è™½ç„¶å¯¹æ•°ç»„ toString()æ²¡æœ‰æ„ä¹‰, ä½†æ˜¯å¯¹é›†åˆ toString() æ˜¯å¯ä»¥æ‰“å°å‡ºé›†åˆé‡Œé¢çš„å†…å®¹çš„, å› ä¸ºé›†åˆçš„çˆ¶ç±» `AbstractCollections<E>` é‡å†™äº† Object
çš„ toString() æ–¹æ³•.

31. ä¸è¦å¯¹è¶…å‡ºèŒƒå›´çš„åŸºæœ¬æ•°æ®ç±»å‹åšå‘ä¸‹å¼ºåˆ¶è½¬å‹
    è¿™ç»ä¸ä¼šå¾—åˆ°æƒ³è¦çš„ç»“æœ:

```java
public static void main(String[] args){
	long l = 12345678901234L;
	int i = (int)l;
	System.out.println(i);
}
```

æˆ‘ä»¬å¯èƒ½æœŸæœ›å¾—åˆ°å…¶ä¸­çš„æŸå‡ ä½, ä½†æ˜¯ç»“æœå´æ˜¯:
1942892530

è§£é‡Šä¸€ä¸‹. Java ä¸­ long æ˜¯ 8 ä¸ªå­—èŠ‚ 64 ä½çš„, æ‰€ä»¥ 12345678901234 åœ¨è®¡ç®—æœºä¸­çš„è¡¨ç¤ºåº”è¯¥æ˜¯:
0000 0000 0000 0000 0000 1011 0011 1010 0111 0011 1100 1110 0010 1111 1111 0010
ä¸€ä¸ª int å‹æ•°æ®æ˜¯ 4 ä¸ªå­—èŠ‚ 32 ä½çš„, ä»ä½ä½å–å‡ºä¸Šé¢è¿™ä¸²äºŒè¿›åˆ¶æ•°æ®çš„å‰ 32 ä½æ˜¯:
0111 0011 1100 1110 0010 1111 1111 0010
è¿™ä¸²äºŒè¿›åˆ¶è¡¨ç¤ºä¸ºåè¿›åˆ¶ 1942892530, æ‰€ä»¥å°±æ˜¯æˆ‘ä»¬ä¸Šé¢çš„æ§åˆ¶å°ä¸Šè¾“å‡ºçš„å†…å®¹. ä»è¿™ä¸ªä¾‹å­ä¸Šè¿˜èƒ½é¡ºä¾¿å¾—åˆ°ä¸¤ä¸ªç»“è®º:

- æ•´å‹é»˜è®¤çš„æ•°æ®ç±»å‹æ˜¯ int, long l = 12345678901234L, è¿™ä¸ªæ•°å­—å·²ç»è¶…å‡ºäº† int çš„èŒƒå›´äº†, æ‰€ä»¥æœ€åæœ‰ä¸€ä¸ª L, è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª long å‹æ•°. é¡ºä¾¿,
  æµ®ç‚¹å‹çš„é»˜è®¤ç±»å‹æ˜¯ double, æ‰€ä»¥å®šä¹‰ float çš„æ—¶å€™è¦å†™æˆâ€"float f = 3.5fâ€
- æ¥ä¸‹æ¥å†å†™ä¸€å¥â€int ii = l + i;â€ä¼šæŠ¥é”™, å› ä¸º long + int æ˜¯ä¸€ä¸ª long, ä¸èƒ½èµ‹å€¼ç»™ int

32. å…¬ç”¨çš„é›†åˆç±»ä¸­ä¸ä½¿ç”¨çš„æ•°æ®ä¸€å®šè¦åŠæ—¶ remove æ‰
    å¦‚æœä¸€ä¸ªé›†åˆç±»æ˜¯å…¬ç”¨çš„ï¼ˆä¹Ÿå°±æ˜¯è¯´ä¸æ˜¯æ–¹æ³•é‡Œé¢çš„å±æ€§ï¼‰, é‚£ä¹ˆè¿™ä¸ªé›†åˆé‡Œé¢çš„å…ƒç´ æ˜¯ä¸ä¼šè‡ªåŠ¨é‡Šæ”¾çš„, å› ä¸ºå§‹ç»ˆæœ‰å¼•ç”¨æŒ‡å‘å®ƒä»¬.

æ‰€ä»¥, å¦‚æœå…¬ç”¨é›†åˆé‡Œé¢çš„æŸäº›æ•°æ®ä¸ä½¿ç”¨è€Œä¸å» remove æ‰å®ƒä»¬, é‚£ä¹ˆå°†ä¼šé€ æˆè¿™ä¸ªå…¬ç”¨é›†åˆä¸æ–­å¢å¤§, ä½¿å¾—ç³»ç»Ÿæœ‰å†…å­˜æ³„éœ²çš„éšæ‚£.

33. æŠŠä¸€ä¸ªåŸºæœ¬æ•°æ®ç±»å‹è½¬ä¸ºå­—ç¬¦ä¸², åŸºæœ¬æ•°æ®ç±»å‹.toString()æ˜¯æœ€å¿«çš„æ–¹å¼ã€String.valueOf( æ•°æ®) æ¬¡ä¹‹ã€æ•°æ® +â€" æœ€æ…¢
    æŠŠä¸€ä¸ªåŸºæœ¬æ•°æ®ç±»å‹è½¬ä¸ºä¸€èˆ¬æœ‰ä¸‰ç§æ–¹å¼, æˆ‘æœ‰ä¸€ä¸ª Integer å‹æ•°æ® i, å¯ä»¥ä½¿ç”¨ i.toString()ã€String.valueOf(i)ã€i+â€" ä¸‰ç§æ–¹å¼, ä¸‰ç§æ–¹å¼çš„æ•ˆç‡å¦‚ä½•,
    çœ‹ä¸€ä¸ªæµ‹è¯•:

```java
public static void main(String[] args){
	int loopTime = 50000;
	Integer i = 0;
	long startTime = System.currentTimeMillis();
	for (int j = 0; j < loopTime; j++){
		String str = String.valueOf(i);
	}
	System.out.println("String.valueOf(): " + (System.currentTimeMillis() - startTime) + "ms");
	startTime = System.currentTimeMillis();
	for (int j = 0; j < loopTime; j++){
		String str = i.toString();
	}
	System.out.println("Integer.toString(): " + (System.currentTimeMillis() - startTime) + "ms");
	startTime = System.currentTimeMillis();
	for (int j = 0; j < loopTime; j++){
		String str = i + "";
	}
	System.out.println("i + \"\": " + (System.currentTimeMillis() - startTime) + "ms");
}
```

è¿è¡Œç»“æœä¸º:
String.valueOf(): 11ms Integer.toString(): 5ms i + "": 25ms
æ‰€ä»¥ä»¥åé‡åˆ°æŠŠä¸€ä¸ªåŸºæœ¬æ•°æ®ç±»å‹è½¬ä¸º String çš„æ—¶å€™, ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨ toString() æ–¹æ³•. è‡³äºä¸ºä»€ä¹ˆ, å¾ˆç®€å•:

1.String.valueOf()æ–¹æ³•åº•å±‚è°ƒç”¨äº† Integer.toString() æ–¹æ³•, ä½†æ˜¯ä¼šåœ¨è°ƒç”¨å‰åšç©ºåˆ¤æ–­
2.Integer.toString() æ–¹æ³•å°±ä¸è¯´äº†, ç›´æ¥è°ƒç”¨äº†
3.i + â€œâ€åº•å±‚ä½¿ç”¨äº† StringBuilder å®ç°, å…ˆç”¨ append æ–¹æ³•æ‹¼æ¥, å†ç”¨ toString() æ–¹æ³•è·å–å­—ç¬¦ä¸²

ä¸‰è€…å¯¹æ¯”ä¸‹æ¥, æ˜æ˜¾æ˜¯ 2 æœ€å¿«ã€1 æ¬¡ä¹‹ã€3 æœ€æ…¢

34. ä½¿ç”¨æœ€æœ‰æ•ˆç‡çš„æ–¹å¼å»éå† Map
    éå† Map çš„æ–¹å¼æœ‰å¾ˆå¤š, é€šå¸¸åœºæ™¯ä¸‹æˆ‘ä»¬éœ€è¦çš„æ˜¯éå† Map ä¸­çš„ Key å’Œ Value, é‚£ä¹ˆæ¨èä½¿ç”¨çš„ã€æ•ˆç‡æœ€é«˜çš„æ–¹å¼æ˜¯:

```java
public static void main(String[] args){
	HashMap<String, String> hm = new HashMap<String, String>();
	hm.put("111", "222");
	Set<Map.Entry<String, String>> entrySet = hm.entrySet();
	Iterator<Map.Entry<String, String>> iter = entrySet.iterator();
	while (iter.hasNext()){
		Map.Entry<String, String> entry = iter.next();
		System.out.println(entry.getKey() + "\t" + entry.getValue());
	}
}
```

å¦‚æœä½ åªæ˜¯æƒ³éå†ä¸€ä¸‹è¿™ä¸ª Map çš„ key å€¼, é‚£ç”¨ `Set<String> keySet = hm.keySet();` ä¼šæ¯”è¾ƒåˆé€‚ä¸€äº›

35. å¯¹èµ„æºçš„ close()å»ºè®®åˆ†å¼€æ“ä½œ 35ã€å¯¹èµ„æºçš„ close() å»ºè®®åˆ†å¼€æ“ä½œ
    æ„æ€æ˜¯, æ¯”å¦‚æˆ‘æœ‰è¿™ä¹ˆä¸€æ®µä»£ç :

```java
try{
	XXX.close();
	YYY.close();
}catch (Exception e){
	...
}
```

å»ºè®®ä¿®æ”¹ä¸º:

```java
try{
		XXX.close();
	}catch (Exception e) {
		... }try{
		YYY.close();
	}catch (Exception e) {...}
```

è™½ç„¶æœ‰äº›éº»çƒ¦, å´èƒ½é¿å…èµ„æºæ³„éœ². æˆ‘ä»¬æƒ³, å¦‚æœæ²¡æœ‰ä¿®æ”¹è¿‡çš„ä»£ç , ä¸‡ä¸€ XXX.close() æŠ›å¼‚å¸¸äº†, é‚£ä¹ˆå°±è¿›å…¥äº† cath å—ä¸­äº†.

YYY.close() ä¸ä¼šæ‰§è¡Œ, YYY è¿™å—èµ„æºå°±ä¸ä¼šå›æ”¶äº†, ä¸€ç›´å ç”¨ç€, è¿™æ ·çš„ä»£ç ä¸€å¤š, æ˜¯å¯èƒ½å¼•èµ·èµ„æºå¥æŸ„æ³„éœ²çš„. è€Œæ”¹ä¸ºä¸‹é¢çš„å†™æ³•ä¹‹å, å°±ä¿è¯äº†æ— è®ºå¦‚ä½•
XXX å’Œ YYY éƒ½ä¼šè¢« close æ‰.

## [JVM å†…å­˜æ–°ç¯‡ç« ï¼šä»æŒä¹…ä»£åˆ°å…ƒç©ºé—´](https://blog.dong4j.site/posts/7f48a7fb.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})


### æŒä¹…ä»£

æŒä¹…ä»£ä¸­åŒ…å«äº†è™šæ‹Ÿæœºä¸­æ‰€æœ‰å¯é€šè¿‡åå°„è·å–åˆ°çš„æ•°æ®, æ¯”å¦‚ Class å’Œ Method å¯¹è±¡. ä¸åŒçš„ Java è™šæ‹Ÿæœºä¹‹é—´å¯èƒ½ä¼šè¿›è¡Œç±»å…±äº«, å› æ­¤æŒä¹…ä»£åˆåˆ†ä¸ºåªè¯»åŒºå’Œè¯»å†™åŒº.

JVM ç”¨äºæè¿°åº”ç”¨ç¨‹åºä¸­ç”¨åˆ°çš„ç±»å’Œæ–¹æ³•çš„å…ƒæ•°æ®ä¹Ÿå­˜å‚¨åœ¨æŒä¹…ä»£ä¸­. JVM è¿è¡Œæ—¶ä¼šç”¨åˆ°å¤šå°‘æŒä¹…ä»£çš„ç©ºé—´å–å†³äºåº”ç”¨ç¨‹åºç”¨åˆ°äº†å¤šå°‘ç±». é™¤æ­¤ä¹‹å¤–, Java SE
åº“ä¸­çš„ç±»å’Œæ–¹æ³•ä¹Ÿéƒ½å­˜å‚¨åœ¨è¿™é‡Œ.

å¦‚æœ JVM å‘ç°æœ‰çš„ç±»å·²ç»ä¸å†éœ€è¦äº†, å®ƒä¼šå»å›æ”¶ï¼ˆå¸è½½ï¼‰è¿™äº›ç±», å°†å®ƒä»¬çš„ç©ºé—´é‡Šæ”¾å‡ºæ¥ç»™å…¶å®ƒç±»ä½¿ç”¨. Full GC ä¼šè¿›è¡ŒæŒä¹…ä»£çš„å›æ”¶.

- JVM ä¸­ç±»çš„å…ƒæ•°æ®åœ¨ Java å †ä¸­çš„å­˜å‚¨åŒºåŸŸ.
- Java ç±»å¯¹åº”çš„ HotSpot è™šæ‹Ÿæœºä¸­çš„å†…éƒ¨è¡¨ç¤ºä¹Ÿå­˜å‚¨åœ¨è¿™é‡Œ.
- ç±»çš„å±‚çº§ä¿¡æ¯, å­—æ®µ, åå­—.
- æ–¹æ³•çš„ç¼–è¯‘ä¿¡æ¯åŠå­—èŠ‚ç .
- å˜é‡
- å¸¸é‡æ± å’Œç¬¦å·è§£æ

#### æŒä¹…ä»£çš„å¤§å°

- å®ƒçš„ä¸Šé™æ˜¯ MaxPermSize, é»˜è®¤æ˜¯ 64M
- Java å †ä¸­çš„è¿ç»­åŒºåŸŸ : å¦‚æœå­˜å‚¨åœ¨éè¿ç»­çš„å †ç©ºé—´ä¸­çš„è¯, è¦å®šä½å‡ºæŒä¹…ä»£åˆ°æ–°å¯¹è±¡çš„å¼•ç”¨éå¸¸å¤æ‚å¹¶ä¸”è€—æ—¶. å¡è¡¨ï¼ˆcard tableï¼‰, æ˜¯ä¸€ç§è®°å¿†é›†ï¼ˆRemembered
  Setï¼‰, å®ƒç”¨æ¥è®°å½•æŸä¸ªå†…å­˜ä»£ä¸­æ™®é€šå¯¹è±¡æŒ‡é’ˆï¼ˆoopsï¼‰çš„ä¿®æ”¹.
- æŒä¹…ä»£ç”¨å®Œå, ä¼šæŠ›å‡º OutOfMemoryError "PermGen space" å¼‚å¸¸. è§£å†³æ–¹æ¡ˆ: åº”ç”¨ç¨‹åºæ¸…ç†å¼•ç”¨æ¥è§¦å‘ç±»å¸è½½ï¼›å¢åŠ  MaxPermSize çš„å¤§å°.
- éœ€è¦å¤šå¤§çš„æŒä¹…ä»£ç©ºé—´å–å†³äºç±»çš„æ•°é‡, æ–¹æ³•çš„å¤§å°, ä»¥åŠå¸¸é‡æ± çš„å¤§å°.

#### ä¸ºä»€ä¹ˆç§»é™¤æŒä¹…ä»£

- å®ƒçš„å¤§å°æ˜¯åœ¨å¯åŠ¨æ—¶å›ºå®šå¥½çš„â€”â€”å¾ˆéš¾è¿›è¡Œè°ƒä¼˜. -XX:MaxPermSize, è®¾ç½®æˆå¤šå°‘å¥½å‘¢ï¼Ÿ
- HotSpot çš„å†…éƒ¨ç±»å‹ä¹Ÿæ˜¯ Java å¯¹è±¡: å®ƒå¯èƒ½ä¼šåœ¨ Full GC ä¸­è¢«ç§»åŠ¨, åŒæ—¶å®ƒå¯¹åº”ç”¨ä¸é€æ˜, ä¸”æ˜¯éå¼ºç±»å‹çš„, éš¾ä»¥è·Ÿè¸ªè°ƒè¯•,
  è¿˜éœ€è¦å­˜å‚¨å…ƒæ•°æ®çš„å…ƒæ•°æ®ä¿¡æ¯ï¼ˆmeta-metadataï¼‰.
- ç®€åŒ– Full GC: æ¯ä¸€ä¸ªå›æ”¶å™¨æœ‰ä¸“é—¨çš„å…ƒæ•°æ®è¿­ä»£å™¨.
- å¯ä»¥åœ¨ GC ä¸è¿›è¡Œæš‚åœçš„æƒ…å†µä¸‹å¹¶å‘åœ°é‡Šæ”¾ç±»æ•°æ®.
- ä½¿å¾—åŸæ¥å—é™äºæŒä¹…ä»£çš„ä¸€äº›æ”¹è¿›æœªæ¥æœ‰å¯èƒ½å®ç°

#### é‚£ä¹ˆ JVM çš„å…ƒæ•°æ®éƒ½å»å“ªå„¿äº†ï¼Ÿ

### å…ƒç©ºé—´ (metaspace)

æŒä¹…ä»£çš„ç©ºé—´è¢«å½»åº•åœ°åˆ é™¤äº†, å®ƒè¢«ä¸€ä¸ªå«å…ƒç©ºé—´çš„åŒºåŸŸæ‰€æ›¿ä»£äº†. æŒä¹…ä»£åˆ é™¤äº†ä¹‹å, å¾ˆæ˜æ˜¾, JVM ä¼šå¿½ç•¥ PermSize å’Œ MaxPermSize è¿™ä¸¤ä¸ªå‚æ•°,
è¿˜æœ‰å°±æ˜¯ä½ å†ä¹Ÿçœ‹ä¸åˆ° java.lang.OutOfMemoryError: PermGen error çš„å¼‚å¸¸äº†.

JDK 8 çš„ HotSpot JVM ç°åœ¨ä½¿ç”¨çš„æ˜¯æœ¬åœ°å†…å­˜æ¥è¡¨ç¤ºç±»çš„å…ƒæ•°æ®, è¿™ä¸ªåŒºåŸŸå°±å«åšå…ƒç©ºé—´.

å…ƒç©ºé—´çš„ç‰¹ç‚¹:

- å……åˆ†åˆ©ç”¨äº† Java è¯­è¨€è§„èŒƒä¸­çš„å¥½å¤„: ç±»åŠç›¸å…³çš„å…ƒæ•°æ®çš„ç”Ÿå‘½å‘¨æœŸä¸ç±»åŠ è½½å™¨çš„ä¸€è‡´.
- æ¯ä¸ªåŠ è½½å™¨æœ‰ä¸“é—¨çš„å­˜å‚¨ç©ºé—´
- åªè¿›è¡Œçº¿æ€§åˆ†é…
- ä¸ä¼šå•ç‹¬å›æ”¶æŸä¸ªç±»
- çœæ‰äº† GC æ‰«æåŠå‹ç¼©çš„æ—¶é—´
- å…ƒç©ºé—´é‡Œçš„å¯¹è±¡çš„ä½ç½®æ˜¯å›ºå®šçš„
- å¦‚æœ GC å‘ç°æŸä¸ªç±»åŠ è½½å™¨ä¸å†å­˜æ´»äº†, ä¼šæŠŠç›¸å…³çš„ç©ºé—´æ•´ä¸ªå›æ”¶æ‰

#### å…ƒç©ºé—´çš„å†…å­˜åˆ†é…æ¨¡å‹

- ç»å¤§å¤šæ•°çš„ç±»å…ƒæ•°æ®çš„ç©ºé—´éƒ½ä»æœ¬åœ°å†…å­˜ä¸­åˆ†é…
- ç”¨æ¥æè¿°ç±»å…ƒæ•°æ®çš„ç±»ä¹Ÿè¢«åˆ é™¤äº†
- åˆ†å…ƒæ•°æ®åˆ†é…äº†å¤šä¸ªè™šæ‹Ÿå†…å­˜ç©ºé—´
- ç»™æ¯ä¸ªç±»åŠ è½½å™¨åˆ†é…ä¸€ä¸ªå†…å­˜å—çš„åˆ—è¡¨. å—çš„å¤§å°å–å†³äºç±»åŠ è½½å™¨çš„ç±»å‹; sun / åå°„ / ä»£ç†å¯¹åº”çš„ç±»åŠ è½½å™¨çš„å—ä¼šå°ä¸€äº›
- å½’è¿˜å†…å­˜å—, é‡Šæ”¾å†…å­˜å—åˆ—è¡¨
- ä¸€æ—¦å…ƒç©ºé—´çš„æ•°æ®è¢«æ¸…ç©ºäº†, è™šæ‹Ÿå†…å­˜çš„ç©ºé—´ä¼šè¢«å›æ”¶æ‰
- å‡å°‘ç¢ç‰‡çš„ç­–ç•¥

æˆ‘ä»¬æ¥çœ‹ä¸‹ JVM æ˜¯å¦‚ä½•ç»™å…ƒæ•°æ®åˆ†é…è™šæ‹Ÿå†…å­˜çš„ç©ºé—´çš„

ä½ å¯ä»¥çœ‹åˆ°è™šæ‹Ÿå†…å­˜ç©ºé—´æ˜¯å¦‚ä½•åˆ†é…çš„ (vs1,vs2,vs3) , ä»¥åŠç±»åŠ è½½å™¨çš„å†…å­˜å—æ˜¯å¦‚ä½•åˆ†é…çš„. CL æ˜¯ Class Loader çš„ç¼©å†™.

#### ç†è§£ mark å’Œ klass æŒ‡é’ˆ

è¦æƒ³ç†è§£ä¸‹é¢è¿™å¼ å›¾, ä½ å¾—ææ¸…æ¥šè¿™äº›æŒ‡é’ˆéƒ½æ˜¯ä»€ä¹ˆä¸œè¥¿.

JVM ä¸­, æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªæŒ‡å‘å®ƒè‡ªèº«ç±»çš„æŒ‡é’ˆ, ä¸è¿‡è¿™ä¸ªæŒ‡é’ˆåªæ˜¯æŒ‡å‘å…·ä½“çš„å®ç°ç±», è€Œä¸æ˜¯æ¥å£æˆ–è€…æŠ½è±¡ç±».

å¯¹äº 32 ä½çš„ JVM:

`_mark` : 4 å­—èŠ‚å¸¸é‡

`_klass`: æŒ‡å‘ç±»çš„ 4 å­—èŠ‚æŒ‡é’ˆ å¯¹è±¡çš„å†…å­˜å¸ƒå±€ä¸­çš„ç¬¬äºŒä¸ªå­—æ®µ (`_klass`, åœ¨ 32 ä½ JVM ä¸­, ç›¸å¯¹å¯¹è±¡åœ¨å†…å­˜ä¸­çš„ä½ç½®çš„åç§»é‡æ˜¯ 4, 64 ä½çš„æ˜¯ 8)
æŒ‡å‘çš„æ˜¯å†…å­˜ä¸­å¯¹è±¡çš„ç±»å®šä¹‰.

64 ä½çš„ JVM:

`_mark` : 8 å­—èŠ‚å¸¸é‡

`_klass`: æŒ‡å‘ç±»çš„ 8 å­—èŠ‚çš„æŒ‡é’ˆ

å¼€å¯äº†æŒ‡é’ˆå‹ç¼©çš„ 64 ä½ JVM: `_mark` : 8 å­—èŠ‚å¸¸é‡

`_klass`: æŒ‡å‘ç±»çš„ 4 å­—èŠ‚çš„æŒ‡é’ˆ

#### Java å¯¹è±¡çš„å†…å­˜å¸ƒå±€

ç±»æŒ‡é’ˆå‹ç¼©ç©ºé—´ï¼ˆCompressed Class Pointer Spaceï¼‰

åªæœ‰æ˜¯ 64 ä½å¹³å°ä¸Šå¯ç”¨äº†ç±»æŒ‡é’ˆå‹ç¼©æ‰ä¼šå­˜åœ¨è¿™ä¸ªåŒºåŸŸ. å¯¹äº 64 ä½å¹³å°, ä¸ºäº†å‹ç¼© JVM å¯¹è±¡ä¸­çš„ `_klass` æŒ‡é’ˆçš„å¤§å°, å¼•å…¥äº†ç±»æŒ‡é’ˆå‹ç¼©ç©ºé—´ï¼ˆCompressed
Class Pointer Spaceï¼‰.

å‹ç¼©æŒ‡é’ˆåçš„å†…å­˜å¸ƒå±€

æŒ‡é’ˆå‹ç¼©æ¦‚è¦

- 64 ä½å¹³å°ä¸Šé»˜è®¤æ‰“å¼€
- ä½¿ç”¨ - XX:+UseCompressedOops å‹ç¼©å¯¹è±¡æŒ‡é’ˆ "oops" æŒ‡çš„æ˜¯æ™®é€šå¯¹è±¡æŒ‡é’ˆ ("ordinary" object pointers). Java å †ä¸­å¯¹è±¡æŒ‡é’ˆä¼šè¢«å‹ç¼©æˆ 32 ä½.
  ä½¿ç”¨å †åŸºåœ°å€ï¼ˆå¦‚æœå †åœ¨ä½ 26G å†…å­˜ä¸­çš„è¯, åŸºåœ°å€ä¸º 0ï¼‰

- ä½¿ç”¨ - XX:+UseCompressedClassPointers é€‰é¡¹æ¥å‹ç¼©ç±»æŒ‡é’ˆ

- å¯¹è±¡ä¸­æŒ‡å‘ç±»å…ƒæ•°æ®çš„æŒ‡é’ˆä¼šè¢«å‹ç¼©æˆ 32 ä½

- ç±»æŒ‡é’ˆå‹ç¼©ç©ºé—´ä¼šæœ‰ä¸€ä¸ªåŸºåœ°å€

#### å…ƒç©ºé—´å’Œç±»æŒ‡é’ˆå‹ç¼©ç©ºé—´çš„åŒºåˆ«

- ç±»æŒ‡é’ˆå‹ç¼©ç©ºé—´åªåŒ…å«ç±»çš„å…ƒæ•°æ®, æ¯”å¦‚ InstanceKlass, ArrayKlass ä»…å½“æ‰“å¼€äº† UseCompressedClassPointers é€‰é¡¹æ‰ç”Ÿæ•ˆ ä¸ºäº†æé«˜æ€§èƒ½, Java
  ä¸­çš„è™šæ–¹æ³•è¡¨ä¹Ÿå­˜æ”¾åˆ°è¿™é‡Œ è¿™é‡Œåˆ°åº•å­˜æ”¾å“ªäº›å…ƒæ•°æ®çš„ç±»å‹, ç›®å‰ä»åœ¨å‡å°‘

- å…ƒç©ºé—´åŒ…å«ç±»çš„å…¶å®ƒæ¯”è¾ƒå¤§çš„å…ƒæ•°æ®, æ¯”å¦‚æ–¹æ³•, å­—èŠ‚ç , å¸¸é‡æ± ç­‰.

### å…ƒç©ºé—´çš„è°ƒä¼˜

ä½¿ç”¨ - XX:MaxMetaspaceSize å‚æ•°å¯ä»¥è®¾ç½®å…ƒç©ºé—´çš„æœ€å¤§å€¼, é»˜è®¤æ˜¯æ²¡æœ‰ä¸Šé™çš„, ä¹Ÿå°±æ˜¯è¯´ä½ çš„ç³»ç»Ÿå†…å­˜ä¸Šé™æ˜¯å¤šå°‘å®ƒå°±æ˜¯å¤šå°‘. -XX:MetaspaceSize
é€‰é¡¹æŒ‡å®šçš„æ˜¯å…ƒç©ºé—´çš„åˆå§‹å¤§å°, å¦‚æœæ²¡æœ‰æŒ‡å®šçš„è¯, å…ƒç©ºé—´ä¼šæ ¹æ®åº”ç”¨ç¨‹åºè¿è¡Œæ—¶çš„éœ€è¦åŠ¨æ€åœ°è°ƒæ•´å¤§å°.

#### MaxMetaspaceSize çš„è°ƒä¼˜

- -XX:MaxMetaspaceSize={unlimited}
- å…ƒç©ºé—´çš„å¤§å°å—é™äºä½ æœºå™¨çš„å†…å­˜
- é™åˆ¶ç±»çš„å…ƒæ•°æ®ä½¿ç”¨çš„å†…å­˜å¤§å°, ä»¥å…å‡ºç°è™šæ‹Ÿå†…å­˜åˆ‡æ¢ä»¥åŠæœ¬åœ°å†…å­˜åˆ†é…å¤±è´¥. å¦‚æœæ€€ç–‘æœ‰ç±»åŠ è½½å™¨å‡ºç°æ³„éœ², åº”å½“ä½¿ç”¨è¿™ä¸ªå‚æ•°ï¼›32 ä½æœºå™¨ä¸Š,
  å¦‚æœåœ°å€ç©ºé—´å¯èƒ½ä¼šè¢«è€—å°½, ä¹Ÿåº”å½“è®¾ç½®è¿™ä¸ªå‚æ•°.
- å…ƒç©ºé—´çš„åˆå§‹å¤§å°æ˜¯ 21Mâ€”â€”è¿™æ˜¯ GC çš„åˆå§‹çš„é«˜æ°´ä½çº¿, è¶…è¿‡è¿™ä¸ªå¤§å°ä¼šè¿›è¡Œ Full GC æ¥è¿›è¡Œç±»çš„å›æ”¶.
- å¦‚æœå¯åŠ¨å GC è¿‡äºé¢‘ç¹, è¯·å°†è¯¥å€¼è®¾ç½®å¾—å¤§ä¸€äº›
- å¯ä»¥è®¾ç½®æˆå’ŒæŒä¹…ä»£ä¸€æ ·çš„å¤§å°, ä»¥ä¾¿æ¨è¿Ÿ GC çš„æ‰§è¡Œæ—¶é—´

#### CompressedClassSpaceSize çš„è°ƒä¼˜

- åªæœ‰å½“ - XX:+UseCompressedClassPointers å¼€å¯äº†æ‰æœ‰æ•ˆ
- -XX:CompressedClassSpaceSize=1G
- ç”±äºè¿™ä¸ªå¤§å°åœ¨å¯åŠ¨çš„æ—¶å€™å°±å›ºå®šäº†çš„, å› æ­¤æœ€å¥½è®¾ç½®å¾—å¤§ç‚¹.
- æ²¡æœ‰ä½¿ç”¨åˆ°çš„è¯ä¸è¦è¿›è¡Œè®¾ç½®
- JVM åç»­å¯èƒ½ä¼šè®©è¿™ä¸ªåŒºå¯ä»¥åŠ¨æ€çš„å¢é•¿. ä¸éœ€è¦æ˜¯è¿ç»­çš„åŒºåŸŸ, åªè¦ä»åŸºåœ°å€å¯è¾¾å°±è¡Œï¼›å¯èƒ½ä¼šå°†æ›´å¤šçš„ç±»å…ƒä¿¡æ¯æ”¾å›åˆ°å…ƒç©ºé—´ä¸­ï¼›æœªæ¥ä¼šåŸºäº
  PredictedLoadedClassCount çš„å€¼æ¥è‡ªåŠ¨çš„è®¾ç½®è¯¥ç©ºé—´çš„å¤§å°

#### å…ƒç©ºé—´çš„ä¸€äº›å·¥å…·

- jmap -permstat æ”¹æˆäº† jmap -clstats. å®ƒç”¨æ¥æ‰“å° Java å †çš„ç±»åŠ è½½å™¨çš„ç»Ÿè®¡æ•°æ®. å¯¹æ¯ä¸€ä¸ªç±»åŠ è½½å™¨, ä¼šè¾“å‡ºå®ƒçš„åå­—, æ˜¯å¦å­˜æ´», åœ°å€, çˆ¶ç±»åŠ è½½å™¨,
  ä»¥åŠå®ƒå·²ç»åŠ è½½çš„ç±»çš„æ•°é‡åŠå¤§å°. é™¤æ­¤ä¹‹å¤–, é©»ç•™çš„å­—ç¬¦ä¸²ï¼ˆinternï¼‰çš„æ•°é‡åŠå¤§å°ä¹Ÿä¼šæ‰“å°å‡ºæ¥.
- jstat -gc, è¿™ä¸ªå‘½ä»¤è¾“å‡ºçš„æ˜¯å…ƒç©ºé—´çš„ä¿¡æ¯è€ŒéæŒä¹…ä»£çš„
- jcmd GC.class_stats æä¾›ç±»å…ƒæ•°æ®å¤§å°çš„è¯¦ç»†ä¿¡æ¯. ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½å¯åŠ¨ç¨‹åºæ—¶éœ€è¦åŠ ä¸Š - XX:+UnlockDiagnosticVMOptions é€‰é¡¹.

#### æé«˜ GC çš„æ€§èƒ½

å¦‚æœä½ ç†è§£äº†å…ƒç©ºé—´çš„æ¦‚å¿µ, å¾ˆå®¹æ˜“å‘ç° GC çš„æ€§èƒ½å¾—åˆ°äº†æå‡.

- Full GC ä¸­, å…ƒæ•°æ®æŒ‡å‘å…ƒæ•°æ®çš„é‚£äº›æŒ‡é’ˆéƒ½ä¸ç”¨å†æ‰«æäº†. å¾ˆå¤šå¤æ‚çš„å…ƒæ•°æ®æ‰«æçš„ä»£ç ï¼ˆå°¤å…¶æ˜¯ CMS é‡Œé¢çš„é‚£äº›ï¼‰éƒ½åˆ é™¤äº†.
- å…ƒç©ºé—´åªæœ‰å°‘é‡çš„æŒ‡é’ˆæŒ‡å‘ Java å †. è¿™åŒ…æ‹¬: ç±»çš„å…ƒæ•°æ®ä¸­æŒ‡å‘ java/lang/Class å®ä¾‹çš„æŒ‡é’ˆ; æ•°ç»„ç±»çš„å…ƒæ•°æ®ä¸­, æŒ‡å‘ java/lang/Class é›†åˆçš„æŒ‡é’ˆ.
- æ²¡æœ‰å…ƒæ•°æ®å‹ç¼©çš„å¼€é”€
- å‡å°‘äº†æ ¹å¯¹è±¡çš„æ‰«æï¼ˆä¸å†æ‰«æè™šæ‹Ÿæœºé‡Œé¢çš„å·²åŠ è½½ç±»çš„å­—å…¸ä»¥åŠå…¶å®ƒçš„å†…éƒ¨å“ˆå¸Œè¡¨ï¼‰
- å‡å°‘äº† Full GC çš„æ—¶é—´
- G1 å›æ”¶å™¨ä¸­, å¹¶å‘æ ‡è®°é˜¶æ®µå®Œæˆåå¯ä»¥è¿›è¡Œç±»çš„å¸è½½

#### æ€»ç»“

- Hotspot ä¸­çš„å…ƒæ•°æ®ç°åœ¨å­˜å‚¨åˆ°äº†å…ƒç©ºé—´é‡Œ. mmap ä¸­çš„å†…å­˜å—çš„ç”Ÿå‘½å‘¨æœŸä¸ç±»åŠ è½½å™¨çš„ä¸€è‡´.
- ç±»æŒ‡é’ˆå‹ç¼©ç©ºé—´ï¼ˆCompressed class pointer spaceï¼‰ç›®å‰ä»ç„¶æ˜¯å›ºå®šå¤§å°çš„, ä½†å®ƒçš„ç©ºé—´è¾ƒå¤§
- å¯ä»¥è¿›è¡Œå‚æ•°çš„è°ƒä¼˜, ä¸è¿‡è¿™ä¸æ˜¯å¿…éœ€çš„.
- æœªæ¥å¯èƒ½ä¼šå¢åŠ å…¶å®ƒçš„ä¼˜åŒ–åŠæ–°ç‰¹æ€§. æ¯”å¦‚, åº”ç”¨ç¨‹åºç±»æ•°æ®å…±äº«ï¼›æ–°ç”Ÿä»£ GC ä¼˜åŒ–, G1 å›æ”¶å™¨è¿›è¡Œç±»çš„å›æ”¶ï¼›å‡å°‘å…ƒæ•°æ®çš„å¤§å°, ä»¥åŠ JVM å†…éƒ¨å¯¹è±¡çš„å†…å­˜å ç”¨é‡.

## [ä»é›¶å¼€å§‹ï¼šJUnit4.x çš„å®è·µæŒ‡å—](https://blog.dong4j.site/posts/64d008b.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})


## ä¸ºä»€ä¹ˆä½¿ç”¨ Junit

æˆ‘ä»¬ä»¥å‰æµ‹è¯•ä¸€ä¸ªç±»çš„æ­¥éª¤:

1. æ–°å»ºä¸€ä¸ª test ç±»
2. åˆ›å»º main() æ–¹æ³•
3. åœ¨ main ç±» new ä¸€ä¸ªæˆ‘ä»¬è¦æµ‹è¯•çš„ç±»çš„å®ä¾‹
4. ç„¶åè°ƒç”¨è¿™ä¸ªç±»çš„æ–¹æ³•, è¾“å‡ºä¸€ä¸ªç»“æœ

å½“æµ‹è¯•çš„ç±»æœ‰å¤šä¸ªæ–¹æ³•æ—¶, æˆ‘ä»¬å¿…é¡»è°ƒç”¨æ‰€æœ‰çš„æ–¹æ³•, ä¸ºäº†ä¸è®©ä¸Šä¸€æ¬¡çš„æ–¹æ³•è°ƒç”¨å¯¹ä¸‹ä¸€æ¬¡çš„è°ƒç”¨äº§ç”Ÿå½±å“, æˆ‘ä»¬ä¼šåœ¨ new ä¸€ä¸ªå®ä¾‹å‡ºæ¥, æˆ–è€…å°†ä¸Šä¸€æ¬¡çš„ä»£ç æ³¨é‡Šæ‰.
åˆ™å°†é€ æˆæ•´ä¸ªæµ‹è¯•ä»£ç çš„æ··ä¹±.
è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¸Œæœ›å¦‚æœå¯ä»¥æœ‰å¤šä¸ª mian()æ–¹æ³•, æ¯ä¸ª main() æ–¹æ³•å†…åªè°ƒç”¨ä¸€ä¸ªéœ€è¦æµ‹è¯•çš„ç±»çš„æ–¹æ³•,
è¿™æ ·æ˜¾å¾—è°ƒç†æ¸…æ™°. ä½†æ˜¯è¿™æ˜¯ä¸å¯èƒ½çš„, ä¸€ä¸ªç¨‹åºåªèƒ½æœ‰ä¸€ä¸ªå…¥å£

è¿™ä¸ªæ—¶å€™, Junit ç«™äº†å‡ºæ¥, å®ƒå¤§å£°çš„è¯´å®ƒå¯ä»¥åšåˆ°.

## æ€ä¹ˆä½¿ç”¨ Junit

ä¸»è¦æ­¥éª¤:

1. æ–°å»ºä¸€ä¸ª java é¡¹ç›®
2. åœ¨ src ä¸‹æ–°å»ºä¸€ä¸ª util åŒ…, ç¼–å†™ä¸€ä¸ªæ™®é€šçš„ç±»

```java
/**
 * å¯¹åç§°, åœ°å€ç­‰å­—ç¬¦ä¸²æ ¼å¼çš„å†…å®¹è¿›è¡Œæ ¼å¼æ£€æŸ¥
 * æˆ–è€…æ ¼å¼åŒ–çš„å·¥å…·ç±»
 * @author CodeA
 */
public class WordDeanUtil {
	/**
	 * å°† Java å¯¹è±¡åç§° (æ¯ä¸ªå•è¯çš„å¤´å­—ç¬¦å¤§å†™) æŒ‰ç…§
	 * æ•°æ®åº“å‘½åçš„ä¹ æƒ¯è¿›è¡Œæ ¼å¼åŒ–
	 * æ ¼å¼åŒ–åçš„æ•°æ®ä¸ºå°å†™å­—æ¯, å¹¶ä¸”ä½¿ç”¨ä¸‹åˆ’çº¿åˆ†å‰²å‘½åå•è¯
	 * ä¾‹å¦‚:employeeInfo-->employee_info
	 *
	 * @param name  Java å¯¹è±¡åç§°
	 */
	public static String wordFormat4DB(String name){
        // ä½¿ç”¨ç»™å®šçš„æ­£åˆ™è¡¨è¾¾å¼åˆ›å»º Pattern å¯¹è±¡ (å°†ç»™å®šçš„æ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘åˆ°æ¨¡å¼ä¸­.)
		Pattern p = Pattern.compile("[A-Z]");
        // åˆ›å»º å­—ç¬¦ä¸²å’Œæ¨¡å¼åŒ¹é…çš„åŒ¹é…å™¨
		Matcher m = p.matcher(name);
		StringBuffer sb = new StringBuffer();
        // æ‹¿ç€ name ä¸­çš„å­—ç¬¦ä¸€ä¸ªä¸€ä¸ªçš„å»å’Œæ­£åˆ™è¡¨è¾¾å¼å¯¹æ¯”, æˆåŠŸè¿”å› true
		while(m.find()){
            // æ‰¾å¤§å†™å­—æ¯
            m.appendReplacement(sb,  "_" + m.group());
		}
		return m.appendTail(sb).toString().toLowerCase();
	}
}
```

3. åœ¨ src ä¸‹æ–°å»ºä¸€ä¸ª tests æ–‡ä»¶å¤¹, å°†å®ƒè®¾ç½®ä¸ºæµ‹è¯•ä¸“ç”¨æ–‡ä»¶å¤¹
   - åœ¨å·¥ç¨‹åä¸ŠæŒ‰ f4
   - æ‰¾åˆ° Modules-->Sources
   - æ‰¾åˆ° tests æ–‡ä»¶å¤¹, ç„¶å Mark as Tests

![20241229154732_DLDvtPTF.webp](https://cdn.dong4j.site/source/image/20241229154732_DLDvtPTF.webp)

4. é€‰ä¸­æˆ‘ä»¬è¦æµ‹è¯•çš„ç±»çš„ç±»å, ç„¶å Ctrl+shift+t --> Create new test
5. é€‰æ‹© Junit4, ç„¶åé€‰æ‹©è¦æµ‹è¯•çš„ç±»çš„æ–¹æ³• (method), setUp å’Œ tearDown åé¢å†ä»‹ç»

![20241229154732_Jghwc7S9.webp](https://cdn.dong4j.site/source/image/20241229154732_Jghwc7S9.webp)

6. ç‚¹å‡» OK å, å¦‚æœå‰é¢çš„ test æµ‹è¯•æ–‡ä»¶å¤¹æ²¡æœ‰å‡ºé”™çš„è¯, ä¼šåœ¨ tests æ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆä¸€ä¸ªåŒ…, è¿™ä¸ªåŒ…å’Œæˆ‘ä»¬è¦æµ‹è¯•çš„ç±»çš„åŒ…ä¸€æ ·, è¿˜æœ‰ä¸€ä¸ªä»¥æµ‹è¯•ç±»å
   +Test çš„ç±» (ä¸åŒçš„ IDE æœ‰ä¸åŒçš„è§„åˆ™, Myeclipse å°±æ˜¯åœ¨å‰é¢åŠ  test çš„), æˆ‘ä»¬ä¸»è¦åœ¨è¿™ä¸ªç±»ä¸­æ“ä½œ
   (å•å…ƒæµ‹è¯•ä»£ç å’Œè¢«æµ‹è¯•ä»£ç ä½¿ç”¨ä¸€æ ·çš„åŒ…, ä¸åŒçš„ç›®å½•)

![20241229154732_fWUaDcLs.webp](https://cdn.dong4j.site/source/image/20241229154732_fWUaDcLs.webp)

7. ä¸‹é¢æ¥å†™ä¸€ä¸ªç®€å•çš„æµ‹è¯•æ–¹æ³•
   æµ‹è¯•æ–¹æ³•ä¹¦å†™è§„èŒƒ:
   - æµ‹è¯•æ–¹æ³•å¿…é¡»ä½¿ç”¨æ³¨è§£ org.junit.Test ä¿®é¥°
   - æµ‹è¯•æ–¹æ³•å¿…é¡»ä½¿ç”¨ public void ä¿®é¥°, è€Œä¸”ä¸èƒ½å¸¦æœ‰ä»»ä½•å‚æ•°
   - æµ‹è¯•æ–¹æ³•åä¸€èˆ¬ä»¥ test+ è¢«æµ‹è¯•çš„æ–¹æ³•åä¹¦å†™

![20241229154732_YCpaDQtm.webp](https://cdn.dong4j.site/source/image/20241229154732_YCpaDQtm.webp)

- è¯´æ˜:

1. æˆ‘ä»¬åªéœ€è¦è¦è¿™ä¸ªæµ‹è¯•æ–¹æ³•å½“æˆä¸€ä¸ª main()æ–¹æ³•, åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢ä¹¦å†™æˆ‘ä»¬ä»¥å‰åœ¨ main() æ–¹æ³•å†…å†™è¿‡çš„æµ‹è¯•ä»£ç .

- new ä¸€ä¸ªæˆ‘ä»¬è¦æµ‹è¯•çš„ç±»çš„å®ä¾‹
- ç„¶åè°ƒç”¨è¿™ä¸ªç±»çš„æ–¹æ³•, è¾“å‡ºä¸€ä¸ªç»“æœ

2. åœ¨è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬åªæœ‰ä¸€ä¸ªéœ€è¦æµ‹è¯•çš„æ–¹æ³•, è€Œä¸”æ˜¯é™æ€çš„. æ‰€ä»¥ç›´æ¥å°±ä½¿ç”¨ç±»å + æ–¹æ³•åè°ƒç”¨æˆ‘ä»¬è¦æµ‹è¯•çš„æ–¹æ³•äº†
3. `assertEquals("employee_info", reslut)` çš„æ„æ€æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°æ—¶æˆ‘ä»¬èƒ½é¢„æµ‹çš„æƒ³è¦çš„ç»“æœ, ç¬¬äºŒä¸ªå‚æ•°æ˜¯æˆ‘ä»¬è¦æµ‹è¯•çš„æ–¹æ³•è¿”å›çš„ç»“æœ, å¦‚æœè¿™ä¸¤ä¸ªå­—ç¬¦ä¸²ç›¸åŒ,
   æ•´ä¸ªæµ‹è¯•é€šè¿‡.
4. æˆ‘ä»¬å®Œå…¨å¯ä»¥ä¸ä½¿ç”¨ Junit æä¾›çš„è¿™ä¸ªæ–¹æ³•
   ![20241229154732_AxkWTz3W.webp](https://cdn.dong4j.site/source/image/20241229154732_AxkWTz3W.webp)

5. assertEquals æ˜¯ç”± JUnit æä¾›çš„ä¸€ç³»åˆ—åˆ¤æ–­æµ‹è¯•ç»“æœæ˜¯å¦æ­£ç¡®çš„é™æ€æ–­è¨€æ–¹æ³•ï¼ˆä½äºç±» org.junit.Assert ä¸­ï¼‰ä¹‹ä¸€
6. Junit ç»™æˆ‘ä»¬æä¾›äº†å¤§é‡çš„é™æ€æ–¹æ³•è®©æˆ‘ä»¬ç¼–å†™å°‘é‡çš„ä»£ç å°±å¯ä»¥å®Œæˆæµ‹è¯•. æˆ‘ä»¬å¹²å˜›ä¸ç”¨å‘¢?

**å•å…ƒæµ‹è¯•ä¸æ˜¯ç”¨æ¥è¯æ˜ä½ æ˜¯å¯¹çš„, è€Œæ˜¯ä¸ºäº†è¯æ˜ä½ æ²¡æœ‰é”™**

è™½ç„¶ä¸Šé¢çš„æµ‹è¯•è¿è¡Œé€šè¿‡äº†, ä½†æ˜¯å¹¶ä¸ä»£è¡¨ä»£ç é€šè¿‡å•å…ƒæµ‹è¯•, å› ä¸ºå•å…ƒæµ‹è¯•ä¸æ˜¯è¯æ˜ä½ æ˜¯å¯¹çš„è€Œè®¾è®¡çš„, æˆ‘ä»¬å¾—æƒ³æ–¹è®¾æ³•æ¥è¯æ˜æˆ‘ä»¬çš„ä»£ç æ²¡æœ‰é”™.
æ‰€æœ‰æˆ‘ä»¬å¾—è€ƒè™‘åˆ°æ‰€æœ‰å¾—æƒ…å†µæ¥è¯æ˜æˆ‘ä»¬å¾—ä»£ç æ²¡æœ‰é”™è¯¯:

**ä¸Šä¸€ä¸ªæµ‹è¯•çš„è¡¥å……:**

1. æµ‹è¯• null æ—¶çš„å¤„ç†æƒ…å†µ
2. æµ‹è¯•ç©ºå­—ç¬¦ä¸²çš„å¤„ç†æƒ…å†µ
3. æµ‹è¯•å•é¦–å­—æ¯å¤§å†™æ—¶çš„æƒ…å†µ
4. æµ‹è¯•å¤šä¸ªç›¸è¿å­—æ¯å¤§å†™æ—¶çš„æƒ…å†µ

å®Œæˆæµ‹è¯•ä»£ç :

```java
public class WordDeanUtilTest {

    @Before
    public void setUp() throws Exception {
        System.out.println("æµ‹è¯•å¼€å§‹");
    }

    @After
    public void tearDown() throws Exception {
        System.out.println("æµ‹è¯•ç»“æŸ");
    }
    @Test
    public void testWordFormat4DB() {
        String target = "employeeInfo";
        String reslut = WordDeanUtil.wordFormat4DB(target);
        assertEquals("employee_info",  reslut);
    }

    // æµ‹è¯• null æ—¶çš„å¤„ç†æƒ…å†µ
    @Test
    public void wordFormat4DBNull(){
        String target = null;
        String reslut = WordDeanUtil.wordFormat4DB(target);
        assertNull(reslut);
    }

    // æµ‹è¯•ç©ºå­—ç¬¦ä¸²çš„å¤„ç†æƒ…å†µ
    @Test
    public void wordFormat4DBEmpty(){
        String target = "";
        String reslut = WordDeanUtil.wordFormat4DB(target);
        assertEquals("",  reslut);
    }

    // æµ‹è¯•å½“é¦–å­—æ¯å¤§å†™æ—¶çš„å¤„ç†æƒ…å†µ
    @Test
    public void wordFormat4DBBegin() {
        String target = "EmployeeInfo";
        String reslut = WordDeanUtil.wordFormat4DB(target);
        assertEquals("employee_info",  reslut);
    }

    // æµ‹è¯•å°¾å­—æ¯å¤§å†™æ—¶çš„å¤„ç†æƒ…å†µ
    @Test
    public void wordFormat4DBEnd() {
        String target = "employeeInfoA";
        String reslut = WordDeanUtil.wordFormat4DB(target);
        assertEquals("employee_info_a",  reslut);
    }

    // æµ‹è¯•å¤šä¸ªé¡¹é“¾å­—æ¯å¤§å†™æ—¶çš„å¤„ç†æƒ…å†µ
    @Test
    public void wordFormat4DBTogether() {
        String target = "employeeAInfo";
        String reslut = WordDeanUtil.wordFormat4DB(target);
        assertEquals("employee_a_info",  reslut);
    }
}
```

å†æ¬¡è¿è¡Œä¸Šé¢çš„æµ‹è¯•ä»£ç æ—¶, ä½ ä¼šå‘ç°æµ‹è¯•æœªé€šè¿‡

![20241229154732_kSvPKuvR.webp](https://cdn.dong4j.site/source/image/20241229154732_kSvPKuvR.webp)

![20241229154732_nU9WauPf.webp](https://cdn.dong4j.site/source/image/20241229154732_nU9WauPf.webp)

æœ‰ä¸€ä¸ªç©ºæŒ‡é’ˆå¼‚å¸¸, ç”±æ­¤å¯è§æˆ‘ä»¬çš„ wordFormat4DB() æ–¹æ³•æ²¡æœ‰å¯¹ null åšå‡ºå¤„ç†
è¿˜æœ‰ä¸€ä¸ªå¤„ç†ç»“æœå’Œæˆ‘ä»¬é¢„æœŸçš„ä¸ä¸€æ ·, è¿™å°±æ˜¯ä¸€ä¸ª bug, è¢« Junit æ‰¾å‡ºæ¥äº†

ä¿®æ”¹è¢«æµ‹è¯•çš„ä»£ç :

```java
public class WordDeanUtil {
	/**
	 * å°† Java å¯¹è±¡åç§° (æ¯ä¸ªå•è¯çš„å¤´å­—ç¬¦å¤§å†™) æŒ‰ç…§
	 * æ•°æ®åº“å‘½åçš„ä¹ æƒ¯è¿›è¡Œæ ¼å¼åŒ–
	 * æ ¼å¼åŒ–åçš„æ•°æ®ä¸ºå°å†™å­—æ¯, å¹¶ä¸”ä½¿ç”¨ä¸‹åˆ’çº¿åˆ†å‰²å‘½åå•è¯
	 * ä¾‹å¦‚:employeeInfo-->employee_info
	 *
	 * @param name  Java å¯¹è±¡åç§°
	 */
	public static String wordFormat4DB(String name){
		// å¢åŠ  null éªŒè¯
        if(name == null){
            return null;
        }
        // ä½¿ç”¨ç»™å®šçš„æ­£åˆ™è¡¨è¾¾å¼åˆ›å»º Pattern å¯¹è±¡ (å°†ç»™å®šçš„æ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘åˆ°æ¨¡å¼ä¸­.)
		Pattern p = Pattern.compile("[A-Z]");
        // åˆ›å»º å­—ç¬¦ä¸²å’Œæ¨¡å¼åŒ¹é…çš„åŒ¹é…å™¨
		Matcher m = p.matcher(name);
		StringBuffer sb = new StringBuffer();
        // æ‹¿ç€ name ä¸­çš„å­—ç¬¦ä¸€ä¸ªä¸€ä¸ªçš„å»å’Œæ­£åˆ™è¡¨è¾¾å¼å¯¹æ¯”, æˆåŠŸè¿”å› true
		while(m.find()){
			// å¢åŠ é¦–å­—æ¯å¤§å†™éªŒè¯
            if(m.start() != 0){
                m.appendReplacement(sb,  ("_" + m.group()).toLowerCase());
            }

		}
		return m.appendTail(sb).toString().toLowerCase();
	}
}
```

å†æ¬¡è¿è¡Œ, æµ‹è¯•é€šè¿‡ ~~~~

---

## Junit æ·±å…¥ç†è§£

### Fixture

å½“ç¼–å†™æµ‹è¯•æ–¹æ³•æ—¶, å¿…é¡»å…ˆåˆå§‹åŒ–æ•°æ®, æ¯ä¸ªæµ‹è¯•æ–¹æ³•éƒ½éœ€è¦è¿™ä¹ˆåš, å°±ä¼šé€ æˆé‡å¤çš„ä»£ç , æ‰€ä»¥ Junit æå‡ºäº† Fixture è§£å†³æ–¹æ¡ˆ
Fixture:
æ•´æ²»æ‰§è¡Œä¸€ä¸ªæˆ–è€…å¤šä¸ªæµ‹è¯•æ–¹æ³•æ—¶éœ€è¦çš„ä¸€ç³»åˆ—å…¬å…±èµ„æºæˆ–è€…æ•°æ®.

æ„æ€å°±æ˜¯åˆå§‹åŒ–å¤šä¸ªæµ‹è¯•æ–¹æ³•éƒ½éœ€è¦ä½¿ç”¨åˆ°çš„æ•°æ®

è®¾ç½® Fixture:

1. ä½¿ç”¨æ³¨è§£ org.junit.Before ä¿®é¥°ç”¨äºåˆå§‹åŒ–çš„æ–¹æ³•
2. ä½¿ç”¨æ³¨è§£ org.junit.After ä¿®é¥°ç”¨äºæ³¨é”€çš„æ–¹æ³•
3. ä¿è¯è¿™ä¸¤ç§æ–¹æ³•éƒ½æ˜¯ç”¨ public void ä¿®é¥°, è€Œä¸”ä¸èƒ½å¸¦ä»»ä½•å‚æ•°

æ–¹æ³•çº§åˆ«çš„ Fixture è®¾ç½®æ–¹æ³•:

```java
// åˆå§‹åŒ–æ–¹æ³•
@Before
public void init(){...}
// æ³¨é”€æ–¹æ³•
@After
public void destroy(){...}
```

åœ¨ **æ¯ä¸ª** æµ‹è¯•æ–¹æ³•æ‰§è¡Œä¹‹å‰, éƒ½ä¼šæ‰§è¡Œ init æ–¹æ³•;
æµ‹è¯•æ–¹æ³•æ‰§è¡Œå®Œæ¯•ä¹‹å, éƒ½ä¼šæ‰§è¡Œ destroy() æ–¹æ³•;
è¿™ç§æ–¹å¼ä¿è¯äº†å„ä¸ªç‹¬ç«‹æµ‹è¯•ä¹‹é—´äº’ä¸å¹²æ‰°, ä¸€é¢å…¶ä»–æµ‹è¯•ä»£ç ä¿®æ”¹æµ‹è¯•ç¯å¢ƒæˆ–è€…æµ‹è¯•æ•°æ®å½±å“åˆ°å…¶ä»–æµ‹è¯•ä»£ç çš„å‡†ç¡®æ€§

æ–¹æ³•çº§åˆ« Fixture æ‰§è¡Œç¤ºæ„å›¾

![20241229154732_Lt3nYDKp.webp](https://cdn.dong4j.site/source/image/20241229154732_Lt3nYDKp.webp)

ä¸‹é¢æ˜¯å…·ä½“çš„æµ‹è¯•ç»“æœ:

![20241229154732_kaHthhOm.webp](https://cdn.dong4j.site/source/image/20241229154732_kaHthhOm.webp)

è·Ÿæè¿°çš„ä¸€æ · ~~~~

ä½†æ˜¯è¿™ç§æ–¹å¼æ•ˆç‡ä½ä¸‹, æ¯ä¸ªæµ‹è¯•æ–¹æ³•éƒ½è¦åˆå§‹åŒ–ä¸€æ¬¡, å…³é—­ä¸€æ¬¡, å¯¹æ•°æ®åº“è¿æ¥æ¥è¯´æ˜¯ä¸€åœºå™©æ¢¦;
è€Œä¸”å¯¹äºä¸ä¼šå‘ç”Ÿå˜åŒ–çš„æµ‹è¯•ç¯å¢ƒæˆ–è€…æµ‹è¯•æ•°æ®æ¥è¯´, æ˜¯ä¸ä¼šå½±å“åˆ°æ‰§è¡Œç»“æœçš„, é¡µå°±æ²¡å¿…è¦æ¯æ¬¡éƒ½åˆå§‹åŒ–å’Œé”€æ¯;
å› æ­¤ Junit4 å¼•å…¥äº† **çº§åˆ«çš„ Fixture è®¾ç½®æ–¹æ³•:**

1. ä½¿ç”¨æ³¨è§£ org.junit.BeforeClass ä¿®é¥°ç”¨äºåˆå§‹åŒ–çš„æ–¹æ³•
2. ä½¿ç”¨æ³¨è§£ org.junit.AfterClass ä¿®é¥°ç”¨äºæ³¨é”€çš„æ–¹æ³•
3. ä¿è¯è¿™ä¸¤ç§æ–¹æ³•éƒ½æ˜¯ç”¨ public static void ä¿®é¥°, è€Œä¸”ä¸èƒ½å¸¦ä»»ä½•å‚æ•°

ç±»çº§åˆ«çš„ Fixture ä»…ä¼šåœ¨æµ‹è¯•ç±»ä¸­æ‰€æœ‰æµ‹è¯•æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œåˆå§‹åŒ–, å¹¶ä¸”åœ¨å…¨éƒ¨æµ‹è¯•æ–¹æ³•æµ‹è¯•å®Œæ¯•åæ‰§è¡Œæ³¨é”€æ–¹æ³•

```java
@BeforeClass
public void static init(){...}
@AfterClass
public void static destroy(){...}
```

ä¸‹é¢æ˜¯å…·ä½“çš„æµ‹è¯•ç»“æœ:

![20241229154732_B5IRCONd.webp](https://cdn.dong4j.site/source/image/20241229154732_B5IRCONd.webp)

### å¼‚å¸¸å’Œæ—¶é—´æµ‹è¯•

æ³¨è§£ org.junit.Test ä¸­æœ‰ä¸¤ä¸ªéå¸¸æœ‰ç”¨çš„å‚æ•°: expected å’Œ timeout.

#### expected

ä»£è¡¨æµ‹è¯•æ–¹æ³•æœŸæœ›æŠ›å‡ºæŒ‡å®šçš„å¼‚å¸¸, å¦‚æœè¿è¡Œæµ‹è¯•å¹¶æ²¡æœ‰æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸, åˆ™ JUnit ä¼šè®¤ä¸ºè¿™ä¸ªæµ‹è¯•æ²¡æœ‰é€šè¿‡. è¿™ä¸ºéªŒ
è¯è¢«æµ‹è¯•æ–¹æ³•åœ¨é”™è¯¯çš„æƒ…å†µä¸‹æ˜¯å¦ä¼šæŠ›å‡ºé¢„å®šçš„å¼‚å¸¸æä¾›äº†ä¾¿åˆ©.
ä¸¾ä¾‹æ¥è¯´, æ–¹æ³• supportDBChecker
ç”¨äºæ£€æŸ¥ç”¨æˆ·ä½¿ç”¨çš„æ•°æ®åº“ç‰ˆæœ¬æ˜¯å¦åœ¨ç³»ç»Ÿçš„æ”¯æŒçš„èŒƒå›´ä¹‹å†…, å¦‚æœç”¨æˆ·ä½¿ç”¨äº†ä¸è¢«æ”¯æŒçš„æ•°æ®åº“ç‰ˆæœ¬,
åˆ™ä¼šæŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸ UnsupportedDBVersionException. æµ‹è¯•æ–¹æ³• supportDBChecker åœ¨æ•°æ®åº“ç‰ˆ
æœ¬ä¸æ”¯æŒæ—¶æ˜¯å¦ä¼šæŠ›å‡ºæŒ‡å®šå¼‚å¸¸çš„å•å…ƒæµ‹è¯•æ–¹æ³•å¤§ä½“å¦‚ä¸‹:

```java
@Test(expected=UnsupportedDBVersionException.class)
public void unsupportedDBCheck(){
	â€¦â€¦
}
```

#### timeout

æŒ‡å®šè¢«æµ‹è¯•æ–¹æ³•è¢«å…è®¸è¿è¡Œçš„æœ€é•¿æ—¶é—´åº”è¯¥æ˜¯å¤šå°‘, å¦‚æœ
æµ‹è¯•æ–¹æ³•è¿è¡Œæ—¶é—´è¶…è¿‡äº†æŒ‡å®šçš„æ¯«ç§’æ•°, åˆ™ JUnit è®¤ä¸ºæµ‹è¯•å¤±è´¥. è¿™ä¸ªå‚æ•°å¯¹äºæ€§èƒ½æµ‹è¯•æœ‰ä¸€å®šçš„å¸®åŠ©.
ä¾‹å¦‚, å¦‚æœè§£æä¸€ä»½è‡ªå®šä¹‰çš„ XML æ–‡æ¡£èŠ±è´¹äº†å¤šäº 1 ç§’çš„æ—¶é—´, å°±éœ€è¦é‡æ–°è€ƒè™‘ XML ç»“æ„çš„è®¾è®¡,
é‚£å•å…ƒæµ‹è¯•æ–¹æ³•å¯ä»¥è¿™æ ·æ¥å†™:

```java
@Test(timeout=1000)
public void selfXMLReader(){
â€¦â€¦
}
```

### å¿½ç•¥æµ‹è¯•æ–¹æ³•

JUnit æä¾›æ³¨è§£ org.junit.Ignore ç”¨äºæš‚æ—¶å¿½ç•¥æŸä¸ªæµ‹è¯•æ–¹æ³•, å› ä¸ºæœ‰æ—¶å€™ç”±äºæµ‹è¯•ç¯å¢ƒå—é™, å¹¶ä¸èƒ½
ä¿è¯æ¯ä¸€ä¸ªæµ‹è¯•æ–¹æ³•éƒ½èƒ½æ­£ç¡®è¿è¡Œ. ä¾‹å¦‚ä¸‹é¢çš„ä»£ç ä¾¿è¡¨ç¤ºç”±äºæ²¡æœ‰äº†æ•°æ®åº“é“¾æ¥, æç¤º JUnit å¿½ç•¥æµ‹è¯•æ–¹æ³• unsupportedDBCheck:

```java
@Ignore(â€œdb is downâ€)
@Test(expected=UnsupportedDBVersionException.class)
public void unsupportedDBCheck(){
â€¦â€¦
}
```

ä½†æ˜¯ä¸€å®šè¦å°å¿ƒ. æ³¨è§£ org.junit.Ignore åªèƒ½ç”¨äºæš‚æ—¶çš„å¿½ç•¥æµ‹è¯•, å¦‚æœéœ€è¦æ°¸è¿œå¿½ç•¥è¿™äº›æµ‹è¯•, ä¸€å®š
è¦ç¡®è®¤è¢«æµ‹è¯•ä»£ç ä¸å†éœ€è¦è¿™äº›æµ‹è¯•æ–¹æ³•, ä»¥å…å¿½ç•¥å¿…è¦çš„æµ‹è¯•ç‚¹.

### æµ‹è¯•å¥—ä»¶

åœ¨å®é™…å¼€å‘ä¸­, å•å…ƒæµ‹è¯•ç±»ä¼šè¶Šæ¥è¶Šå¤š, è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†ä¸€ä¸ªä¸€ä¸ªçš„è¿è¡Œæµ‹è¯•ç±»å°±æ‚²å‰§äº†.
æ‰€å¹¸çš„æ˜¯ Junit ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§æ‰¹é‡è¿è¡Œæµ‹è¯•ç±»çš„æ–¹æ³•, å«æµ‹è¯•å¥—ä»¶.
å†™æ³•:

1. åˆ›å»ºä¸€ä¸ªç©ºç±»ä½œä¸ºæµ‹è¯•å¥—ä»¶çš„å…¥å£
2. ä½¿ç”¨æ³¨è§£ org.junit.ranner.RunWith å’Œ org.junit.runners.Suite.SuiteClasses ä¿®é¥°è¿™ä¸ªç©ºç±»
3. å°† org.junit.runners.Suite ä½œä¸ºå‚æ•°ä¼ å…¥æ³¨è§£ RunWith, ä»¥æç¤º Junit ä¸ºæ­¤ç±»ä½¿ç”¨å¥—ä»¶è¿è¡ŒæœŸæ‰§è¡Œ
4. å°†éœ€è¦æ”¾å…¥æ­¤æµ‹è¯•å¥—ä»¶çš„æµ‹è¯•ç±»ç»„æˆæ•°ç»„ä½œä¸ºæ³¨è§£ SuiteClasses çš„å‚æ•°
5. ä¿è¯è¿™ä¸ªç©ºç±»ä½¿ç”¨ public ä¿®é¥°, è€Œä¸”å­˜åœ¨å…¬å¼€çš„ä¸å¸¦ä»»ä½•å‚æ•°çš„æ„é€ å‡½æ•°

## JUnit å’Œ Ant

ant æä¾›äº†ä¸¤ä¸ª target : junit å’Œ junitreport è¿è¡Œæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹, å¹¶ç”Ÿæˆ html æ ¼å¼çš„æŠ¥è¡¨
å…·ä½“æ“ä½œå¦‚ä¸‹:

1. å°† junit.jar æ”¾åœ¨ ANT_HOMElib ç›®å½•ä¸‹
2. ä¿®æ”¹ build.xml , åŠ å…¥å¦‚ä¸‹ å†…å®¹:
   -------------- One or more tests failed, check the report for detail... -----------------------------
   è¿è¡Œ è¿™ä¸ª target , ant ä¼šè¿è¡Œæ¯ä¸ª TestCase, åœ¨ report ç›®å½•ä¸‹å°±æœ‰äº† å¾ˆå¤š `TEST*.xml` å’Œ ä¸€äº›ç½‘é¡µæ‰“å¼€ report ç›®å½•ä¸‹çš„ index.html
   å°±å¯ä»¥çœ‹åˆ°å¾ˆç›´è§‚çš„æµ‹è¯•è¿è¡ŒæŠ¥å‘Š, ä¸€ç›®äº†ç„¶.
   åœ¨ Eclipse ä¸­å¼€å‘ã€è¿è¡Œ JUnit æµ‹è¯•ç›¸å½“ç®€å•. å› ä¸º Eclipse æœ¬èº«é›†æˆäº† JUnit ç›¸å…³ç»„ä»¶, å¹¶å¯¹ JUnit çš„è¿è¡Œæä¾›äº†æ— ç¼çš„æ”¯æŒ.

## æ€»ç»“

ä¸‹é¢æ˜¯ä¸€äº›å…·ä½“çš„ç¼–å†™æµ‹è¯•ä»£ç çš„æŠ€å·§æˆ–è¾ƒå¥½çš„å®è·µæ–¹æ³•:

1. ä¸è¦ç”¨ TestCase çš„æ„é€ å‡½æ•°åˆå§‹åŒ– Fixture, è€Œè¦ç”¨ setUp()å’Œ tearDown() æ–¹æ³•.
2. ä¸è¦ä¾èµ–æˆ–å‡å®šæµ‹è¯•è¿è¡Œçš„é¡ºåº, å› ä¸º JUnit åˆ©ç”¨ Vector ä¿å­˜æµ‹è¯•æ–¹æ³•. æ‰€ä»¥ä¸åŒçš„å¹³å°ä¼šæŒ‰ä¸åŒçš„é¡ºåºä» Vector ä¸­å–å‡ºæµ‹è¯•æ–¹æ³•.
3. é¿å…ç¼–å†™æœ‰å‰¯ä½œç”¨çš„ TestCase. ä¾‹å¦‚: å¦‚æœéšåçš„æµ‹è¯•ä¾èµ–äºæŸäº›ç‰¹å®šçš„äº¤æ˜“æ•°æ®, å°±ä¸è¦æäº¤äº¤æ˜“æ•°æ®. ç®€å•çš„å›æ»šå°±å¯ä»¥äº†.
4. å½“ç»§æ‰¿ä¸€ä¸ªæµ‹è¯•ç±»æ—¶, è®°å¾—è°ƒç”¨çˆ¶ç±»çš„ setUp()å’Œ tearDown() æ–¹æ³•.
5. å°†æµ‹è¯•ä»£ç å’Œå·¥ä½œä»£ç æ”¾åœ¨ä¸€èµ·, ä¸€è¾¹åŒæ­¥ç¼–è¯‘å’Œæ›´æ–°. ï¼ˆä½¿ç”¨ Ant ä¸­æœ‰æ”¯æŒ junit çš„ task.ï¼‰
6. æµ‹è¯•ç±»å’Œæµ‹è¯•æ–¹æ³•åº”è¯¥æœ‰ä¸€è‡´çš„å‘½åæ–¹æ¡ˆ. å¦‚åœ¨å·¥ä½œç±»åå‰åŠ ä¸Š test ä»è€Œå½¢æˆæµ‹è¯•ç±»å.
7. ç¡®ä¿æµ‹è¯•ä¸æ—¶é—´æ— å…³, ä¸è¦ä¾èµ–ä½¿ç”¨è¿‡æœŸçš„æ•°æ®è¿›è¡Œæµ‹è¯•. å¯¼è‡´åœ¨éšåçš„ç»´æŠ¤è¿‡ç¨‹ä¸­å¾ˆéš¾é‡ç°æµ‹è¯•.
8. å¦‚æœä½ ç¼–å†™çš„è½¯ä»¶é¢å‘å›½é™…å¸‚åœº, ç¼–å†™æµ‹è¯•æ—¶è¦è€ƒè™‘å›½é™…åŒ–çš„å› ç´ . ä¸è¦ä»…ç”¨æ¯è¯­çš„ Locale è¿›è¡Œæµ‹è¯•.
9. å°½å¯èƒ½åœ°åˆ©ç”¨ JUnit æä¾›åœ° assert/fail æ–¹æ³•ä»¥åŠå¼‚å¸¸å¤„ç†çš„æ–¹æ³•, å¯ä»¥ä½¿ä»£ç æ›´ä¸ºç®€æ´.
10. æµ‹è¯•è¦å°½å¯èƒ½åœ°å°, æ‰§è¡Œé€Ÿåº¦å¿«.
11. ä¸è¦ç¡¬æ€§è§„å®šæ•°æ®æ–‡ä»¶çš„è·¯å¾„.
12. åˆ©ç”¨ Junit çš„è‡ªåŠ¨å¼‚å¸¸å¤„ç†ä¹¦å†™ç®€æ´çš„æµ‹è¯•ä»£ç 
    äº‹å®ä¸Šåœ¨ Junit ä¸­ä½¿ç”¨ try-catch æ¥æ•è·å¼‚å¸¸æ˜¯æ²¡æœ‰å¿…è¦çš„, Junit ä¼šè‡ªåŠ¨æ•è·å¼‚å¸¸. é‚£äº›æ²¡æœ‰è¢«æ•è·çš„å¼‚å¸¸å°±è¢«å½“æˆé”™è¯¯å¤„ç†.
13. å……åˆ†åˆ©ç”¨ Junit çš„ assert/fail æ–¹æ³•
    - assertSame() ç”¨æ¥æµ‹è¯•ä¸¤ä¸ªå¼•ç”¨æ˜¯å¦æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡
    - assertEquals() ç”¨æ¥æµ‹è¯•ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰
14. ç¡®ä¿æµ‹è¯•ä»£ç ä¸æ—¶é—´æ— å…³
15. ä½¿ç”¨æ–‡æ¡£ç”Ÿæˆå™¨åšæµ‹è¯•æ–‡æ¡£.

### junit3.x

1. ä½¿ç”¨ junit3.x ç‰ˆæœ¬è¿›è¡Œå•å…ƒæµ‹è¯•æ—¶, æµ‹è¯•ç±»å¿…é¡»è¦ç»§æ‰¿äº TestCase çˆ¶ç±»ï¼›
2. æµ‹è¯•æ–¹æ³•éœ€è¦éµå¾ªçš„åŸåˆ™:
   - public çš„
   - void çš„
   - æ— æ–¹æ³•å‚æ•°
   - æ–¹æ³•åç§°å¿…é¡»ä»¥ test å¼€å¤´
3. ä¸åŒçš„ Test Case ä¹‹é—´ä¸€å®šè¦ä¿æŒå®Œå…¨çš„ç‹¬ç«‹æ€§, ä¸èƒ½æœ‰ä»»ä½•çš„å…³è”.
4. æˆ‘ä»¬è¦æŒæ¡å¥½æµ‹è¯•æ–¹æ³•çš„é¡ºåº, ä¸èƒ½ä¾èµ–äºæµ‹è¯•æ–¹æ³•è‡ªå·±çš„æ‰§è¡Œé¡ºåº.

demo:

```java
public class TestMyNumber extends TestCase {
	private MyNumber myNumber;
	public TestMyNumber(String name) {
		super(name);
	}
	// åœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•æ‰§è¡Œ [ä¹‹å‰] éƒ½ä¼šè¢«è°ƒç”¨
	@Override
	public void setUp() throws Exception {
		// System.out.println("æ¬¢è¿ä½¿ç”¨Junitè¿›è¡Œå•å…ƒæµ‹è¯•â€¦");
		myNumber = new MyNumber();
	}
	// åœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•æ‰§è¡Œ [ä¹‹å] éƒ½ä¼šè¢«è°ƒç”¨
	@Override
	public void tearDown() throws Exception {
		// System.out.println("Junitå•å…ƒæµ‹è¯•ç»“æŸâ€¦");
	}
	public void testDivideByZero() {
		Throwable te = null;
		try {
			myNumber.divide(6,  0);
			Assert.fail("æµ‹è¯•å¤±è´¥");
		} catch (Exception e) {
			e.printStackTrace();
			te = e;
		}
		Assert.assertEquals(Exception.class,  te.getClass());
		Assert.assertEquals("é™¤æ•°ä¸èƒ½ä¸º 0 ",  te.getMessage());
	}
}
```

### junit4.x

1. ä½¿ç”¨ junit4.x ç‰ˆæœ¬è¿›è¡Œå•å…ƒæµ‹è¯•æ—¶, ä¸ç”¨æµ‹è¯•ç±»ç»§æ‰¿ TestCase çˆ¶ç±», å› ä¸º, junit4.x å…¨é¢å¼•å…¥äº† Annotation æ¥æ‰§è¡Œæˆ‘ä»¬ç¼–å†™çš„æµ‹è¯•. [3]
2. junit4.x ç‰ˆæœ¬, å¼•ç”¨äº†æ³¨è§£çš„æ–¹å¼, è¿›è¡Œå•å…ƒæµ‹è¯•ï¼›
3. junit4.x ç‰ˆæœ¬æˆ‘ä»¬å¸¸ç”¨çš„æ³¨è§£:
   - @Before æ³¨è§£: ä¸ junit3.x ä¸­çš„ setUp() æ–¹æ³•åŠŸèƒ½ä¸€æ ·, åœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•ä¹‹å‰æ‰§è¡Œï¼›
   - @After æ³¨è§£: ä¸ junit3.x ä¸­çš„ tearDown() æ–¹æ³•åŠŸèƒ½ä¸€æ ·, åœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•ä¹‹åæ‰§è¡Œï¼›
   - @BeforeClass æ³¨è§£: åœ¨æ‰€æœ‰æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œï¼›
   - @AfterClass æ³¨è§£: åœ¨æ‰€æœ‰æ–¹æ³•æ‰§è¡Œä¹‹åæ‰§è¡Œï¼›
   - @Test(timeout = xxx) æ³¨è§£: è®¾ç½®å½“å‰æµ‹è¯•æ–¹æ³•åœ¨ä¸€å®šæ—¶é—´å†…è¿è¡Œå®Œ, å¦åˆ™è¿”å›é”™è¯¯ï¼›
   - @Test(expected = Exception.class) æ³¨è§£: è®¾ç½®è¢«æµ‹è¯•çš„æ–¹æ³•æ˜¯å¦æœ‰å¼‚å¸¸æŠ›å‡º. æŠ›å‡ºå¼‚å¸¸ç±»å‹ä¸º: Exception.classï¼›
   - @Ignore æ³¨è§£: æ³¨é‡Šæ‰ä¸€ä¸ªæµ‹è¯•æ–¹æ³•æˆ–ä¸€ä¸ªç±», è¢«æ³¨é‡Šçš„æ–¹æ³•æˆ–ç±», ä¸ä¼šè¢«æ‰§è¡Œ.

demo:

```java
public class TestMyNumber {
	private MyNumber myNumber;
	@BeforeClass
	// åœ¨æ‰€æœ‰æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œ
	public static void globalInit() {
		System.out.println("init all method...");
	}
	@AfterClass
	// åœ¨æ‰€æœ‰æ–¹æ³•æ‰§è¡Œä¹‹åæ‰§è¡Œ
	public static void globalDestory() {
		System.out.println("destory all method...");
	}
	@Before
	// åœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•ä¹‹å‰æ‰§è¡Œ
	public void setUp() {
		System.out.println("start setUp method");
		myNumber = new MyNumber();
	}
	@After
	// åœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•ä¹‹åæ‰§è¡Œ
	public void tearDown() {
		System.out.println("end tearDown method");
	}
	@Test(timeout=600)// è®¾ç½®é™å®šæµ‹è¯•æ–¹æ³•çš„è¿è¡Œæ—¶é—´ å¦‚æœè¶…å‡ºåˆ™è¿”å›é”™è¯¯
	public void testAdd() {
		System.out.println("testAdd method");
		int result = myNumber.add(2,  3);
		assertEquals(5,  result);
	}
	@Test
	public void testSubtract() {
		System.out.println("testSubtract method");
		int result = myNumber.subtract(1,  2);
		assertEquals(-1,  result);
	}
	@Test
	public void testMultiply() {
		System.out.println("testMultiply method");
		int result = myNumber.multiply(2,  3);
		assertEquals(6,  result);
	}
	@Test
	public void testDivide() {
		System.out.println("testDivide method");
		int result = 0;
		try {
			result = myNumber.divide(6,  2);
		} catch (Exception e) {
			fail();
		}
			assertEquals(3,  result);
	}
	@Test(expected = Exception.class)
	public void testDivide2() throws Exception {
		System.out.println("testDivide2 method");
		myNumber.divide(6,  0);
		fail("test Error");
	}
	public static void main(String[] args) {
	}
}
```

## [Javaé¢è¯•å¿…çŸ¥ï¼šfinalã€finallyå’Œfinalizeçš„åŒºåˆ«è§£æ](https://blog.dong4j.site/posts/c8f7e252.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})


## Hibernate çš„ç†è§£

1. é¢å‘å¯¹è±¡è®¾è®¡çš„è½¯ä»¶å†…éƒ¨è¿è¡Œè¿‡ç¨‹å¯ä»¥ç†è§£æˆå°±æ˜¯åœ¨ä¸æ–­åˆ›å»ºå„ç§æ–°å¯¹è±¡ã€å»ºç«‹å¯¹è±¡ä¹‹é—´çš„å…³ç³», è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•æ¥æ”¹å˜å„ä¸ªå¯¹è±¡çš„çŠ¶æ€å’Œå¯¹è±¡æ¶ˆäº¡çš„è¿‡ç¨‹,
   ä¸ç®¡ç¨‹åºè¿è¡Œçš„è¿‡ç¨‹å’Œæ“ä½œæ€ä¹ˆæ ·, æœ¬è´¨ä¸Šéƒ½æ˜¯è¦å¾—åˆ°ä¸€ä¸ªç»“æœ, ç¨‹åºä¸Šä¸€ä¸ªæ—¶åˆ»å’Œä¸‹ä¸€ä¸ªæ—¶åˆ»çš„è¿è¡Œç»“æœçš„å·®å¼‚å°±è¡¨ç°åœ¨å†…å­˜ä¸­çš„å¯¹è±¡çŠ¶æ€å‘ç”Ÿäº†å˜åŒ–.
2. ä¸ºäº†åœ¨å…³æœºå’Œå†…å­˜ç©ºé—´ä¸å¤Ÿçš„çŠ¶å†µä¸‹, ä¿æŒç¨‹åºçš„è¿è¡ŒçŠ¶æ€, éœ€è¦å°†å†…å­˜ä¸­çš„å¯¹è±¡çŠ¶æ€ä¿å­˜åˆ°æŒä¹…åŒ–è®¾å¤‡å’Œä»æŒä¹…åŒ–è®¾å¤‡ä¸­æ¢å¤å‡ºå¯¹è±¡çš„çŠ¶æ€,
   é€šå¸¸éƒ½æ˜¯ä¿å­˜åˆ°å…³ç³»æ•°æ®åº“æ¥ä¿å­˜å¤§é‡å¯¹è±¡ä¿¡æ¯. ä» Java ç¨‹åºçš„è¿è¡ŒåŠŸèƒ½ä¸Šæ¥è®², ä¿å­˜å¯¹è±¡çŠ¶æ€çš„åŠŸèƒ½ç›¸æ¯”ç³»ç»Ÿè¿è¡Œçš„å…¶ä»–åŠŸèƒ½æ¥è¯´, åº”è¯¥æ˜¯ä¸€ä¸ªå¾ˆä¸èµ·çœ¼çš„é™„å±åŠŸèƒ½,
   java é‡‡ç”¨ jdbc æ¥å®ç°è¿™ä¸ªåŠŸèƒ½, è¿™ä¸ªä¸èµ·çœ¼çš„åŠŸèƒ½å´è¦ç¼–å†™å¤§é‡çš„ä»£ç , è€Œåšçš„äº‹æƒ…ä»…ä»…æ˜¯ä¿å­˜å¯¹è±¡å’Œæ¢å¤å¯¹è±¡, å¹¶ä¸”é‚£äº›å¤§é‡çš„ jdbc ä»£ç å¹¶æ²¡æœ‰ä»€ä¹ˆæŠ€æœ¯å«é‡,
   åŸºæœ¬ä¸Šæ˜¯é‡‡ç”¨ä¸€å¥—ä¾‹è¡Œå…¬äº‹çš„æ ‡å‡†ä»£ç æ¨¡æ¿æ¥ç¼–å†™, æ˜¯ä¸€ç§è‹¦æ´»å’Œé‡å¤æ€§çš„å·¥ä½œ.
3. é€šè¿‡æ•°æ®åº“ä¿å­˜ java ç¨‹åºè¿è¡Œæ—¶äº§ç”Ÿçš„å¯¹è±¡å’Œæ¢å¤å¯¹è±¡, å…¶å®å°±æ˜¯å®ç°äº† java å¯¹è±¡ä¸å…³ç³»æ•°æ®åº“è®°å½•çš„æ˜ å°„å…³ç³», ç§°ä¸º ORMï¼ˆå³ Object Relation
   Mappingï¼‰, äººä»¬å¯ä»¥é€šè¿‡å°è£… JDBC ä»£ç æ¥å®ç°äº†è¿™ç§åŠŸèƒ½, å°è£…å‡ºæ¥çš„äº§å“ç§°ä¹‹ä¸º ORM æ¡†æ¶, Hibernate å°±æ˜¯å…¶ä¸­çš„ä¸€ç§æµè¡Œ ORM æ¡†æ¶. ä½¿ç”¨
   Hibernate æ¡†æ¶, ä¸ç”¨å†™ JDBC ä»£ç , ä»…ä»…æ˜¯è°ƒç”¨ä¸€ä¸ª save æ–¹æ³•, å°±å¯ä»¥å°†å¯¹è±¡ä¿å­˜åˆ°å…³ç³»æ•°æ®åº“ä¸­, ä»…ä»…æ˜¯è°ƒç”¨ä¸€ä¸ª get æ–¹æ³•, å°±å¯ä»¥ä»æ•°æ®åº“ä¸­åŠ è½½å‡ºä¸€ä¸ªå¯¹è±¡.
4. ä½¿ç”¨ Hibernate çš„åŸºæœ¬æµç¨‹æ˜¯: é…ç½® Configuration å¯¹è±¡ã€äº§ç”Ÿ SessionFactoryã€åˆ›å»º session å¯¹è±¡, å¯åŠ¨äº‹åŠ¡, å®Œæˆ CRUD æ“ä½œ, æäº¤äº‹åŠ¡, å…³é—­
   session.
5. ä½¿ç”¨ Hibernate æ—¶, å…ˆè¦é…ç½® hibernate.cfg.xml æ–‡ä»¶, å…¶ä¸­é…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯å’Œæ–¹è¨€ç­‰, è¿˜è¦ä¸ºæ¯ä¸ªå®ä½“é…ç½®ç›¸åº”çš„ hbm.xml æ–‡ä»¶,
   hibernate.cfg.xml æ–‡ä»¶ä¸­éœ€è¦ç™»è®°æ¯ä¸ª hbm.xml æ–‡ä»¶.
6. åœ¨åº”ç”¨ Hibernate æ—¶, é‡ç‚¹è¦äº†è§£ Session çš„ç¼“å­˜åŸç†, çº§è”, å»¶è¿ŸåŠ è½½å’Œ hql æŸ¥è¯¢.

## Spring çš„ç†è§£

1. Spring å®ç°äº†å·¥å‚æ¨¡å¼çš„å·¥å‚ç±»ï¼ˆåœ¨è¿™é‡Œæœ‰å¿…è¦è§£é‡Šæ¸…æ¥šä»€ä¹ˆæ˜¯å·¥å‚æ¨¡å¼ï¼‰, è¿™ä¸ªç±»åä¸º BeanFactoryï¼ˆå®é™…ä¸Šæ˜¯ä¸€ä¸ªæ¥å£ï¼‰, åœ¨ç¨‹åºä¸­é€šå¸¸ BeanFactory çš„å­ç±»
   ApplicationContext. Spring ç›¸å½“äºä¸€ä¸ªå¤§çš„å·¥å‚ç±», åœ¨å…¶é…ç½®æ–‡ä»¶ä¸­é€šè¿‡ `<bean>` å…ƒç´ é…ç½®ç”¨äºåˆ›å»ºå®ä¾‹å¯¹è±¡çš„ç±»åå’Œå®ä¾‹å¯¹è±¡çš„å±æ€§.
2. Spring æä¾›äº†å¯¹ IOC è‰¯å¥½æ”¯æŒ, IOC æ˜¯ä¸€ç§ç¼–ç¨‹æ€æƒ³, æ˜¯ä¸€ç§æ¶æ„è‰ºæœ¯, åˆ©ç”¨è¿™ç§æ€æƒ³å¯ä»¥å¾ˆå¥½åœ°å®ç°æ¨¡å—ä¹‹é—´çš„è§£è€¦. IOC ä¹Ÿç§°ä¸º DIï¼ˆDepency
   Injectionï¼‰, ä»€ä¹ˆå«ä¾èµ–æ³¨å…¥å‘¢ï¼Ÿ
   è­¬å¦‚,

   ```java

   Class Programmer
       {
       Computer computer = null;
       public void code()
       {
       // Computer computer = new IBMComputer();
       // Computer computer = beanfacotry.getComputer();
       computer.write();
       }
       public void setComputer(Computer computer)
       {
       this.computer = computer;
       }
   }
   ```

å¦å¤–ä¸¤ç§æ–¹å¼éƒ½ç”±ä¾èµ–, ç¬¬ä¸€ä¸ªç›´æ¥ä¾èµ–äºç›®æ ‡ç±», ç¬¬äºŒä¸ªæŠŠä¾èµ–è½¬ç§»åˆ°å·¥å‚ä¸Š, ç¬¬ä¸‰ä¸ªå½»åº•ä¸ç›®æ ‡å’Œå·¥å‚è§£è€¦äº†. åœ¨ spring çš„é…ç½®æ–‡ä»¶ä¸­é…ç½®ç‰‡æ®µå¦‚ä¸‹:

```xml
<bean id=â€computerâ€ class=â€cn.itcast.interview.Computerâ€>
</bean>
<bean id=â€programmerâ€ class=â€cn.itcast.interview.Programmerâ€>
	<property name=â€computerâ€  ref=â€computerâ€></property>
</bean>
```

3. Spring æä¾›äº†å¯¹ AOP æŠ€æœ¯çš„è‰¯å¥½å°è£…, AOP ç§°ä¸ºé¢å‘åˆ‡é¢ç¼–ç¨‹, å°±æ˜¯ç³»ç»Ÿä¸­æœ‰å¾ˆå¤šå„ä¸ç›¸å¹²çš„ç±»çš„æ–¹æ³•, åœ¨è¿™äº›ä¼—å¤šæ–¹æ³•ä¸­è¦åŠ å…¥æŸç§ç³»ç»ŸåŠŸèƒ½çš„ä»£ç ,
   ä¾‹å¦‚, åŠ å…¥æ—¥å¿—, åŠ å…¥æƒé™åˆ¤æ–­, åŠ å…¥å¼‚å¸¸å¤„ç†, è¿™ç§åº”ç”¨ç§°ä¸º AOP. å®ç° AOP åŠŸèƒ½é‡‡ç”¨çš„æ˜¯ä»£ç†æŠ€æœ¯, å®¢æˆ·ç«¯ç¨‹åºä¸å†è°ƒç”¨ç›®æ ‡, è€Œè°ƒç”¨ä»£ç†ç±»,
   ä»£ç†ç±»ä¸ç›®æ ‡ç±»å¯¹å¤–å…·æœ‰ç›¸åŒçš„æ–¹æ³•å£°æ˜, æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥å®ç°ç›¸åŒçš„æ–¹æ³•å£°æ˜, ä¸€æ˜¯å®ç°ç›¸åŒçš„æ¥å£, äºŒæ˜¯ä½œä¸ºç›®æ ‡çš„å­ç±»åœ¨, JDK ä¸­é‡‡ç”¨ Proxy
   ç±»äº§ç”ŸåŠ¨æ€ä»£ç†çš„æ–¹å¼ä¸ºæŸä¸ªæ¥å£ç”Ÿæˆå®ç°ç±», å¦‚æœè¦ä¸ºæŸä¸ªç±»ç”Ÿæˆå­ç±», åˆ™å¯ä»¥ç”¨ CGLI B. åœ¨ç”Ÿæˆçš„ä»£ç†ç±»çš„æ–¹æ³•ä¸­åŠ å…¥ç³»ç»ŸåŠŸèƒ½å’Œè°ƒç”¨ç›®æ ‡ç±»çš„ç›¸åº”æ–¹æ³•,
   ç³»ç»ŸåŠŸèƒ½çš„ä»£ç†ä»¥ Advice å¯¹è±¡è¿›è¡Œæä¾›, æ˜¾ç„¶è¦åˆ›å»ºå‡ºä»£ç†å¯¹è±¡, è‡³å°‘éœ€è¦ç›®æ ‡ç±»å’Œ Advice ç±». spring æä¾›äº†è¿™ç§æ”¯æŒ, åªéœ€è¦åœ¨ spring
   é…ç½®æ–‡ä»¶ä¸­é…ç½®è¿™ä¸¤ä¸ªå…ƒç´ å³å¯å®ç°ä»£ç†å’Œ aop åŠŸèƒ½, ä¾‹å¦‚,

```xml
<bean id=â€proxyâ€ type=â€org.spring.framework.aop.ProxyBeanFactoryâ€>
	<property name=â€targetâ€ ref=â€â€></property>
	<property name=â€advisorâ€ ref=â€â€></property>
</bean>
```

## iBatis ä¸ Hibernate æœ‰ä»€ä¹ˆä¸åŒ?

ç›¸åŒç‚¹:
å±è”½ jdbc api çš„åº•å±‚è®¿é—®ç»†èŠ‚, ä½¿ç”¨æˆ‘ä»¬ä¸ç”¨ä¸ jdbc api æ‰“äº¤é“, å°±å¯ä»¥è®¿é—®æ•°æ®.
jdbc api ç¼–ç¨‹æµç¨‹å›ºå®š, è¿˜å°† sql è¯­å¥ä¸ java ä»£ç æ··æ‚åœ¨äº†ä¸€èµ·, ç»å¸¸éœ€è¦æ‹¼å‡‘ sql è¯­å¥, ç»†èŠ‚å¾ˆç¹ç.
ibatis çš„å¥½å¤„: å±è”½ jdbc api çš„åº•å±‚è®¿é—®ç»†èŠ‚ï¼›å°† sql è¯­å¥ä¸ java ä»£ç è¿›è¡Œåˆ†ç¦»; æä¾›äº†å°†ç»“æœé›†è‡ªåŠ¨å°è£…ç§°ä¸ºå®ä½“å¯¹è±¡å’Œå¯¹è±¡çš„é›†åˆçš„åŠŸèƒ½,
queryForList è¿”å›å¯¹è±¡é›†åˆ, ç”¨ queryForObject è¿”å›å•ä¸ªå¯¹è±¡ï¼›æä¾›äº†è‡ªåŠ¨å°†å®ä½“å¯¹è±¡çš„å±æ€§ä¼ é€’ç»™ sql è¯­å¥çš„å‚æ•°.

Hibernate æ˜¯ä¸€ä¸ªå…¨è‡ªåŠ¨çš„ orm æ˜ å°„å·¥å…·, å®ƒå¯ä»¥è‡ªåŠ¨ç”Ÿæˆ sql è¯­å¥,ibatis éœ€è¦æˆ‘ä»¬è‡ªå·±åœ¨ xml é…ç½®æ–‡ä»¶ä¸­å†™ sql è¯­å¥, hibernate è¦æ¯” ibatis
åŠŸèƒ½è´Ÿè´£å’Œå¼ºå¤§å¾ˆå¤š. å› ä¸º hibernate è‡ªåŠ¨ç”Ÿæˆ sql è¯­å¥, æˆ‘ä»¬æ— æ³•æ§åˆ¶è¯¥è¯­å¥, æˆ‘ä»¬å°±æ— æ³•å»å†™ç‰¹å®šçš„é«˜æ•ˆç‡çš„ sql. å¯¹äºä¸€äº›ä¸å¤ªå¤æ‚çš„ sql æŸ¥è¯¢,
hibernate å¯ä»¥å¾ˆå¥½å¸®æˆ‘ä»¬å®Œæˆ, ä½†æ˜¯, å¯¹äºç‰¹åˆ«å¤æ‚çš„æŸ¥è¯¢, hibernate å°±å¾ˆéš¾é€‚åº”äº†, è¿™æ—¶å€™ç”¨ ibatis å°±æ˜¯ä¸é”™çš„é€‰æ‹©, å› ä¸º ibatis è¿˜æ˜¯ç”±æˆ‘ä»¬è‡ªå·±å†™
sql è¯­å¥.

# finalã€finally å’Œ finalize çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

è¿™æ˜¯ä¸€é“å†ç»å…¸ä¸è¿‡çš„é¢è¯•é¢˜äº†, æˆ‘ä»¬åœ¨å„ä¸ªå…¬å¸çš„é¢è¯•é¢˜ä¸­å‡ ä¹éƒ½èƒ½çœ‹åˆ°å®ƒçš„èº«å½±. finalã€finally å’Œ finalize è™½ç„¶é•¿å¾—åƒå­ªç”Ÿä¸‰å…„å¼Ÿä¸€æ ·,
ä½†æ˜¯å®ƒä»¬çš„å«ä¹‰å’Œç”¨æ³•å´æ˜¯å¤§ç›¸å¾„åº­. è¿™ä¸€æ¬¡æˆ‘ä»¬å°±ä¸€èµ·æ¥å›é¡¾ä¸€ä¸‹è¿™æ–¹é¢çš„çŸ¥è¯†.

**_final å…³é”®å­—_**

æˆ‘ä»¬é¦–å…ˆæ¥è¯´è¯´ final. å®ƒå¯ä»¥ç”¨äºä»¥ä¸‹å››ä¸ªåœ°æ–¹:

1. å®šä¹‰å˜é‡, åŒ…æ‹¬é™æ€çš„å’Œéé™æ€çš„.
2. å®šä¹‰æ–¹æ³•çš„å‚æ•°.
3. å®šä¹‰æ–¹æ³•.
4. å®šä¹‰ç±».

æˆ‘ä»¬ä¾æ¬¡æ¥å›é¡¾ä¸€ä¸‹æ¯ç§æƒ…å†µä¸‹ final çš„ä½œç”¨. é¦–å…ˆæ¥çœ‹ç¬¬ä¸€ç§æƒ…å†µ, å¦‚æœ final ä¿®é¥°çš„æ˜¯ä¸€ä¸ªåŸºæœ¬ç±»å‹, å°±è¡¨ç¤ºè¿™ä¸ªå˜é‡è¢«èµ‹äºˆçš„å€¼æ˜¯ä¸å¯å˜ çš„,
å³å®ƒæ˜¯ä¸ªå¸¸é‡ï¼›å¦‚æœ final ä¿®é¥°çš„æ˜¯ä¸€ä¸ªå¯¹è±¡, å°±è¡¨ç¤ºè¿™ä¸ªå˜é‡è¢«èµ‹äºˆçš„å¼•ç”¨æ˜¯ä¸å¯å˜çš„, è¿™é‡Œéœ€è¦æé†’å¤§å®¶æ³¨æ„çš„æ˜¯, ä¸å¯æ”¹å˜çš„åªæ˜¯è¿™ä¸ªå˜é‡æ‰€ä¿å­˜çš„ å¼•ç”¨,
å¹¶ä¸æ˜¯è¿™ä¸ªå¼•ç”¨æ‰€æŒ‡å‘çš„å¯¹è±¡. åœ¨ç¬¬äºŒç§æƒ…å†µä¸‹, final çš„å«ä¹‰ä¸ç¬¬ä¸€ç§æƒ…å†µç›¸åŒ. å®é™…ä¸Šå¯¹äºå‰ä¸¤ç§æƒ…å†µ, æœ‰ä¸€ç§æ›´è´´åˆ‡çš„è¡¨è¿° final çš„å«ä¹‰çš„æ è¿°, é‚£å°±æ˜¯,
å¦‚æœä¸€ä¸ªå˜é‡æˆ–æ–¹æ³•å‚æ•°è¢« final ä¿®é¥°, å°±è¡¨ç¤ºå®ƒåªèƒ½è¢«èµ‹å€¼ä¸€æ¬¡, ä½†æ˜¯ JAVA è™šæ‹Ÿæœºä¸ºå˜é‡è®¾å®šçš„é»˜è®¤å€¼ä¸è®°ä½œä¸€æ¬¡èµ‹å€¼.

è¢« final ä¿®é¥°çš„å˜é‡å¿…é¡»è¢«åˆå§‹åŒ–. åˆå§‹åŒ–çš„æ–¹å¼æœ‰ä»¥ä¸‹å‡ ç§:

1. åœ¨å®šä¹‰çš„æ—¶å€™åˆå§‹åŒ–.
2. final å˜é‡å¯ä»¥åœ¨åˆå§‹åŒ–å—ä¸­åˆå§‹åŒ–, ä¸å¯ä»¥åœ¨é™æ€åˆå§‹åŒ–å—ä¸­åˆå§‹åŒ–.
3. é™æ€ final å˜é‡å¯ä»¥åœ¨é™æ€åˆå§‹åŒ–å—ä¸­åˆå§‹åŒ–, ä¸å¯ä»¥åœ¨åˆå§‹åŒ–å—ä¸­åˆå§‹åŒ–.
4. final å˜é‡è¿˜å¯ä»¥åœ¨ç±»çš„æ„é€ å™¨ä¸­åˆå§‹åŒ–, ä½†æ˜¯é™æ€ final å˜é‡ä¸å¯ä»¥.

é€šè¿‡ä¸‹é¢çš„ä»£ç å¯ä»¥éªŒè¯ä»¥ä¸Šçš„è§‚ç‚¹:

```java
public class FinalTest {
    // åœ¨å®šä¹‰æ—¶åˆå§‹åŒ–
    public final int A = 10;

    public final int B;
    // åœ¨åˆå§‹åŒ–å—ä¸­åˆå§‹åŒ–
    {
        B = 20;
    }

    // éé™æ€ final å˜é‡ä¸èƒ½åœ¨é™æ€åˆå§‹åŒ–å—ä¸­åˆå§‹åŒ–
    // public final int C;
    // static {
    // C = 30;
    // }

    // é™æ€å¸¸é‡, åœ¨å®šä¹‰æ—¶åˆå§‹åŒ–
    public static final int STATIC_D = 40;

    public static final int STATIC_E;
    // é™æ€å¸¸é‡, åœ¨é™æ€åˆå§‹åŒ–å—ä¸­åˆå§‹åŒ–
    static {
        STATIC_E = 50;
    }

    // é™æ€å˜é‡ä¸èƒ½åœ¨åˆå§‹åŒ–å—ä¸­åˆå§‹åŒ–
    // public static final int STATIC_F;
    // {
    // STATIC_F = 60;
    // }

    public final int G;

    // é™æ€ final å˜é‡ä¸å¯ä»¥åœ¨æ„é€ å™¨ä¸­åˆå§‹åŒ–
    // public static final int STATIC_H;

    // åœ¨æ„é€ å™¨ä¸­åˆå§‹åŒ–
    public FinalTest() {
        G = 70;
        // é™æ€ final å˜é‡ä¸å¯ä»¥åœ¨æ„é€ å™¨ä¸­åˆå§‹åŒ–
        // STATIC_H = 80;

        // ç»™ final çš„å˜é‡ç¬¬äºŒæ¬¡èµ‹å€¼æ—¶, ç¼–è¯‘ä¼šæŠ¥é”™
        // A = 99;
        // STATIC_D = 99;
    }

    // final å˜é‡æœªè¢«åˆå§‹åŒ–, ç¼–è¯‘æ—¶å°±ä¼šæŠ¥é”™
    // public final int I;

    // é™æ€ final å˜é‡æœªè¢«åˆå§‹åŒ–, ç¼–è¯‘æ—¶å°±ä¼šæŠ¥é”™
    // public static final int STATIC_J;
}
```

æˆ‘ä»¬è¿è¡Œä¸Šé¢çš„ä»£ç ä¹‹åå‡ºäº†å¯ä»¥å‘ç° final å˜é‡ï¼ˆå¸¸é‡ï¼‰å’Œé™æ€ final å˜é‡ï¼ˆé™æ€å¸¸é‡ï¼‰æœªè¢«åˆå§‹åŒ–æ—¶, ç¼–è¯‘ä¼šæŠ¥é”™.

ç”¨ final ä¿®é¥°çš„å˜é‡ï¼ˆå¸¸é‡ï¼‰æ¯”é final çš„å˜é‡ï¼ˆæ™®é€šå˜é‡ï¼‰æ‹¥æœ‰æ›´é«˜çš„æ•ˆç‡, å› æ­¤æˆ‘ä»¬åœ¨å®é™…ç¼–ç¨‹ä¸­åº”è¯¥å°½å¯èƒ½å¤šçš„ç”¨å¸¸é‡æ¥ä»£æ›¿æ™®é€šå˜é‡, è¿™ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ç¼–ç¨‹ä¹ æƒ¯.

å½“ final ç”¨æ¥å®šä¹‰ä¸€ä¸ªæ–¹æ³•æ—¶, ä¼šæœ‰ä»€ä¹ˆæ•ˆæœå‘¢ï¼Ÿæ­£å¦‚å¤§å®¶æ‰€çŸ¥, å®ƒè¡¨ç¤ºè¿™ä¸ªæ–¹æ³•ä¸å¯ä»¥è¢«å­ç±»é‡å†™, ä½†æ˜¯å®ƒè¿™ä¸å½±å“å®ƒè¢«å­ç±»ç»§æ‰¿.
æˆ‘ä»¬å†™æ®µä»£ç æ¥éªŒè¯ä¸€ä¸‹:

```java
class ParentClass {
    public final void TestFinal() {
        System.out.println("çˆ¶ç±» -- è¿™æ˜¯ä¸€ä¸ª final æ–¹æ³•");
    }
}

public class SubClass extends ParentClass {
    /**
     * å­ç±»æ— æ³•é‡å†™ï¼ˆoverrideï¼‰çˆ¶ç±»çš„ final æ–¹æ³•, å¦åˆ™ç¼–è¯‘æ—¶ä¼šæŠ¥é”™
     */
    // public void TestFinal() {
    // System.out.println("å­ç±» -- é‡å†™ final æ–¹æ³•");
    // }

    public static void main(String[] args) {
        SubClass sc = new SubClass();
        sc.TestFinal();
    }
}
```

è¿™é‡Œéœ€è¦ç‰¹æ®Šè¯´æ˜çš„æ˜¯, å…·æœ‰ private è®¿é—®æƒé™çš„æ–¹æ³•ä¹Ÿå¯ä»¥å¢åŠ  final ä¿®é¥°, ä½†æ˜¯ç”±äºå­ç±»æ— æ³•ç»§æ‰¿ private æ–¹æ³•, å› æ­¤ä¹Ÿæ— æ³•é‡å†™ å®ƒ. ç¼–è¯‘å™¨åœ¨å¤„ç†
private æ–¹æ³•æ—¶, æ˜¯æŒ‰ç…§ final æ–¹æ³•æ¥å¯¹å¾…çš„, è¿™æ ·å¯ä»¥æé«˜è¯¥æ–¹æ³•è¢«è°ƒç”¨æ—¶çš„æ•ˆç‡. ä¸è¿‡å­ç±»ä»ç„¶å¯ä»¥å®šä¹‰åŒçˆ¶ç±»ä¸­çš„ private æ–¹æ³•å…·æœ‰åŒæ ·ç»“æ„çš„æ–¹æ³•,
ä½†æ˜¯è¿™å¹¶ä¸ä¼šäº§ç”Ÿé‡å†™çš„æ•ˆæœ, è€Œä¸”å®ƒä»¬ä¹‹é—´ä¹Ÿä¸å­˜åœ¨å¿…ç„¶è”ç³».

æœ€åæˆ‘ä»¬å†æ¥å›é¡¾ä¸€ä¸‹ final ç”¨äºç±»çš„æƒ…å†µ. è¿™ä¸ªå¤§å®¶åº”è¯¥ä¹Ÿå¾ˆç†Ÿæ‚‰äº†, å› ä¸ºæˆ‘ä»¬æœ€å¸¸ç”¨çš„ String ç±»å°±æ˜¯ final çš„. ç”±äº final ç±»ä¸å… è®¸è¢«ç»§æ‰¿,
ç¼–è¯‘å™¨åœ¨å¤„ç†æ—¶æŠŠå®ƒçš„æ‰€æœ‰æ–¹æ³•éƒ½å½“ä½œ final çš„, å› æ­¤ final ç±»æ¯”æ™®é€šç±»æ‹¥æœ‰æ›´é«˜çš„æ•ˆç‡. final çš„ç±»çš„æ‰€æœ‰æ–¹æ³•éƒ½ä¸èƒ½è¢«é‡å†™, ä½†è¿™å¹¶ä¸ è¡¨ç¤º final
çš„ç±»çš„å±æ€§ï¼ˆå˜é‡ï¼‰å€¼ä¹Ÿæ˜¯ä¸å¯æ”¹å˜çš„, è¦æƒ³åšåˆ° final ç±»çš„å±æ€§å€¼ä¸å¯æ”¹å˜, å¿…é¡»ç»™å®ƒå¢åŠ  final ä¿®é¥°, è¯·çœ‹ä¸‹é¢çš„ä¾‹å­:

```java
public final class FinalTest {

    int i = 10;

    public static void main(String[] args) {
        FinalTest ft = new FinalTest();
        ft.i = 99;
        System.out.println(ft.i);
    }
}
```

è¿è¡Œä¸Šé¢çš„ä»£ç è¯•è¯•çœ‹, ç»“æœæ˜¯ 99, è€Œä¸æ˜¯åˆå§‹åŒ–æ—¶çš„ 10.

**_finally è¯­å¥_**

æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·å›é¡¾ä¸€ä¸‹ finally çš„ç”¨æ³•. è¿™ä¸ªå°±æ¯”è¾ƒç®€å•äº†, å®ƒåªèƒ½ç”¨åœ¨ try/catch è¯­å¥ä¸­, å¹¶ä¸”é™„å¸¦ç€ä¸€ä¸ªè¯­å¥å—, è¡¨ç¤ºè¿™æ®µè¯­å¥æœ€ç»ˆæ€»æ˜¯è¢«æ‰§è¡Œ.
è¯·çœ‹ä¸‹é¢çš„ä»£ç :

```java
public final class FinallyTest {
    public static void main(String[] args) {
        try {
            throw new NullPointerException();
        } catch (NullPointerException e) {
            System.out.println("ç¨‹åºæŠ›å‡ºäº†å¼‚å¸¸");
        } finally {
            System.out.println("æ‰§è¡Œäº† finally è¯­å¥å—");
        }
    }
}
```

è¿è¡Œç»“æœè¯´æ˜äº† finally çš„ä½œç”¨:

1. ç¨‹åºæŠ›å‡ºäº†å¼‚å¸¸
2. æ‰§è¡Œäº† finally è¯­å¥å—

è¯·å¤§å®¶æ³¨æ„, æ•è·ç¨‹åºæŠ›å‡ºçš„å¼‚å¸¸ä¹‹å, æ—¢ä¸åŠ å¤„ç†, ä¹Ÿä¸ç»§ç»­å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸, å¹¶ä¸æ˜¯è‰¯å¥½çš„ç¼–ç¨‹ä¹ æƒ¯, å®ƒæ©ç›–äº†ç¨‹åºæ‰§è¡Œä¸­å‘ç”Ÿçš„é”™è¯¯, è¿™é‡Œåªæ˜¯æ–¹ä¾¿æ¼”ç¤º,
è¯·ä¸è¦å­¦ä¹ .

é‚£ä¹ˆ, æœ‰æ²¡æœ‰ä¸€ç§æƒ…å†µä½¿ finally è¯­å¥å—å¾—ä¸åˆ°æ‰§è¡Œå‘¢ï¼Ÿå¤§å®¶å¯èƒ½æƒ³åˆ°äº† returnã€continueã€break è¿™ä¸‰ä¸ªå¯ä»¥æ‰“ä¹±ä»£ç é¡ºåºæ‰§è¡Œè¯­å¥çš„è§„å¾‹. é‚£æˆ‘ä»¬å°±æ¥è¯•è¯•çœ‹,
è¿™ä¸‰ä¸ªè¯­å¥æ˜¯å¦èƒ½å½±å“ finally è¯­å¥å—çš„æ‰§è¡Œ:

```java
public final class FinallyTest {

    // æµ‹è¯• return è¯­å¥
    public ReturnClass testReturn() {
        try {
            return new ReturnClass();
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            System.out.println("æ‰§è¡Œäº† finally è¯­å¥");
        }
        return null;
    }

    // æµ‹è¯• continue è¯­å¥
    public void testContinue() {
        for (int i = 0; i < 3; i++) {
            try {
                System.out.println(i);
                if (i == 1) {
                    continue;
                }
            } catch (Exception e) {
                e.printStackTrace();
            } finally {
                System.out.println("æ‰§è¡Œäº† finally è¯­å¥");
            }
        }
    }

    // æµ‹è¯• break è¯­å¥
    public void testBreak() {
        for (int i = 0; i < 3; i++) {
            try {
                System.out.println(i);
                if (i == 1) {
                    break;
                }
            } catch (Exception e) {
                e.printStackTrace();
            } finally {
                System.out.println("æ‰§è¡Œäº† finally è¯­å¥");
            }
        }
    }

    public static void main(String[] args) {
        FinallyTest ft = new FinallyTest();
        // æµ‹è¯• return è¯­å¥
        ft.testReturn();
        System.out.println();
        // æµ‹è¯• continue è¯­å¥
        ft.testContinue();
        System.out.println();
        // æµ‹è¯• break è¯­å¥
        ft.testBreak();
    }
}

class ReturnClass {
    public ReturnClass() {
        System.out.println("æ‰§è¡Œäº† return è¯­å¥");
    }
}
```

ä¸Šé¢è¿™æ®µä»£ç çš„è¿è¡Œç»“æœå¦‚ä¸‹:

```
æ‰§è¡Œäº† return è¯­å¥
æ‰§è¡Œäº† finally è¯­å¥
0
æ‰§è¡Œäº† finally è¯­å¥
1
æ‰§è¡Œäº† finally è¯­å¥
2
æ‰§è¡Œäº† finally è¯­å¥
0
æ‰§è¡Œäº† finally è¯­å¥
1
æ‰§è¡Œäº† finally è¯­å¥
```

å¾ˆæ˜æ˜¾, returnã€continue å’Œ break éƒ½æ²¡èƒ½é˜»æ­¢ finally è¯­å¥å—çš„æ‰§è¡Œ. ä»è¾“å‡ºçš„ç»“æœæ¥çœ‹, return è¯­å¥ä¼¼ä¹åœ¨ finally è¯­å¥å—ä¹‹å‰æ‰§è¡Œäº†,
äº‹å®çœŸçš„å¦‚æ­¤å—ï¼Ÿæˆ‘ä»¬æ¥æƒ³æƒ³çœ‹, return è¯­å¥çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ˜¯é€€å‡ºå½“å‰çš„æ–¹æ³•, å¹¶å°†å€¼æˆ–å¯¹è±¡è¿”å›. å¦‚æœ finally è¯­å¥å—æ˜¯åœ¨ return è¯­å¥ä¹‹åæ‰§è¡Œçš„, é‚£ä¹ˆ
return è¯­å¥è¢«æ‰§è¡Œåå°±å·²ç»é€€å‡ºå½“å‰æ–¹æ³•äº†, finally è¯­å¥å—åˆå¦‚ä½•èƒ½è¢«æ‰§è¡Œå‘¢ï¼Ÿå›  æ­¤, æ­£ç¡®çš„æ‰§è¡Œé¡ºåºåº”è¯¥æ˜¯è¿™æ ·çš„: ç¼–è¯‘å™¨åœ¨ç¼–è¯‘ return new
ReturnClass(); æ—¶, å°†å®ƒåˆ†æˆäº†ä¸¤ä¸ªæ­¥éª¤, new ReturnClass() å’Œ return, å‰ä¸€ä¸ªåˆ›å»ºå¯¹è±¡çš„è¯­å¥æ˜¯åœ¨ finally è¯­å¥å—ä¹‹å‰è¢«æ‰§è¡Œçš„, è€Œåä¸€ä¸ª return
è¯­å¥æ˜¯åœ¨ finally è¯­ å¥å—ä¹‹åæ‰§è¡Œçš„, ä¹Ÿå°±æ˜¯è¯´ finally è¯­å¥å—æ˜¯åœ¨ç¨‹åºé€€å‡ºæ–¹æ³•ä¹‹å‰è¢«æ‰§è¡Œçš„. åŒæ ·, finally è¯­å¥å—æ˜¯åœ¨å¾ªç¯è¢«è·³è¿‡ï¼ˆcontinueï¼‰å’Œä¸­æ–­
ï¼ˆbreakï¼‰ä¹‹å‰è¢«æ‰§è¡Œçš„.

**_finalize æ–¹æ³•_**

æœ€å, æˆ‘ä»¬å†æ¥çœ‹çœ‹ finalize, å®ƒæ˜¯ä¸€ä¸ªæ–¹æ³•, å±äº java.lang.Object ç±», å®ƒçš„å®šä¹‰å¦‚ä¸‹:

`protected void finalize() throws Throwable { }  `

ä¼—æ‰€å‘¨çŸ¥, finalize() æ–¹æ³•æ˜¯ GCï¼ˆgarbage collectorï¼‰è¿è¡Œæœºåˆ¶çš„ä¸€éƒ¨åˆ†, å…³äº GC çš„çŸ¥è¯†æˆ‘ä»¬å°†åœ¨åç»­çš„ç« èŠ‚ä¸­æ¥å›é¡¾.

åœ¨æ­¤æˆ‘ä»¬åªè¯´è¯´ finalize() æ–¹æ³•çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

finalize() æ–¹æ³•æ˜¯åœ¨ GC æ¸…ç†å®ƒæ‰€ä»å±çš„å¯¹è±¡æ—¶è¢«è°ƒç”¨çš„, å¦‚æœæ‰§è¡Œå®ƒçš„è¿‡ç¨‹ä¸­æŠ›å‡ºäº†æ— æ³•æ•è·çš„å¼‚å¸¸ï¼ˆuncaught exceptionï¼‰, GC å°†ç»ˆæ­¢å¯¹æ”¹å¯¹è±¡çš„æ¸…ç†,
å¹¶ä¸”è¯¥å¼‚å¸¸ä¼šè¢«å¿½ç•¥ï¼›ç›´åˆ°ä¸‹ä¸€æ¬¡ GC å¼€å§‹æ¸…ç†è¿™ä¸ªå¯¹è±¡æ—¶, å®ƒçš„ finalize() ä¼šè¢«å†æ¬¡è°ƒç”¨.

è¯·çœ‹ä¸‹é¢çš„ç¤ºä¾‹:

```java
public final class FinallyTest {
    // é‡å†™ finalize() æ–¹æ³•
    protected void finalize() throws Throwable {
        System.out.println("æ‰§è¡Œäº† finalize() æ–¹æ³•");
    }

    public static void main(String[] args) {
        FinallyTest ft = new FinallyTest();
        ft = null;
        System.gc();
    }
}
```

è¿è¡Œç»“æœå¦‚ä¸‹:

- æ‰§è¡Œäº† finalize() æ–¹æ³•

ç¨‹åºè°ƒç”¨äº† java.lang.System ç±»çš„ gc()æ–¹æ³•, å¼•èµ· GC çš„æ‰§è¡Œ, GC åœ¨æ¸…ç† ft å¯¹è±¡æ—¶è°ƒç”¨äº†å®ƒçš„ finalize() æ–¹æ³•, å› æ­¤æ‰æœ‰äº†ä¸Šé¢çš„è¾“å‡ºç»“æœ. è°ƒç”¨
System.gc() ç­‰åŒäºè°ƒç”¨ä¸‹é¢è¿™è¡Œä»£ç :

`Runtime.getRuntime().gc();  `

è°ƒç”¨å®ƒä»¬çš„ä½œç”¨åªæ˜¯å»ºè®®åƒåœ¾æ”¶é›†å™¨ï¼ˆGCï¼‰å¯åŠ¨, æ¸…ç†æ— ç”¨çš„å¯¹è±¡é‡Šæ”¾å†…å­˜ç©ºé—´, ä½†æ˜¯ GC çš„å¯åŠ¨å¹¶ä¸æ˜¯ä¸€å®šçš„, è¿™ç”± JAVA è™šæ‹Ÿæœºæ¥å†³å®š. ç›´åˆ° JAVA è™šæ‹Ÿæœºåœæ­¢è¿è¡Œ,
æœ‰äº›å¯¹è±¡çš„ finalize() å¯èƒ½éƒ½æ²¡æœ‰è¢«è¿è¡Œè¿‡, é‚£ä¹ˆæ€æ ·ä¿è¯æ‰€æœ‰å¯¹è±¡çš„è¿™ä¸ªæ–¹æ³•åœ¨ JAVA è™šæ‹Ÿæœºåœæ­¢è¿è¡Œä¹‹å‰ä¸€å®šè¢«è°ƒç”¨ å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æˆ‘ä»¬å¯ä»¥è°ƒç”¨ System
ç±»çš„å¦ä¸€ä¸ªæ–¹æ³•:

```java
public static void runFinalizersOnExit(boolean value) {
    //other code
}
```

ç»™è¿™ä¸ªæ–¹æ³•ä¼ å…¥ true å°±å¯ä»¥ä¿è¯å¯¹è±¡çš„ finalize() æ–¹æ³•åœ¨ JAVA è™šæ‹Ÿæœºåœæ­¢è¿è¡Œå‰ä¸€å®šè¢«è¿è¡Œäº†, ä¸è¿‡é—æ†¾çš„æ˜¯è¿™ä¸ªæ–¹æ³•æ˜¯ä¸å®‰å…¨çš„, å®ƒä¼šå¯¼è‡´æœ‰ç”¨çš„å¯¹è±¡
finalize() è¢«è¯¯è°ƒç”¨, å› æ­¤å·²ç»ä¸è¢«èµæˆä½¿ç”¨äº†.

ç”±äº finalize() å±äº Object ç±», å› æ­¤æ‰€æœ‰ç±»éƒ½æœ‰è¿™ä¸ªæ–¹æ³•, Object çš„ä»»æ„å­ç±»éƒ½å¯ä»¥é‡å†™ï¼ˆoverrideï¼‰è¯¥æ–¹æ³•, åœ¨å…¶ä¸­é‡Šæ”¾ç³»ç»Ÿèµ„æºæˆ–è€…åšå…¶å®ƒçš„æ¸…ç†å·¥ä½œ,
å¦‚å…³é—­è¾“å…¥è¾“å‡ºæµ.

é€šè¿‡ä»¥ä¸ŠçŸ¥è¯†çš„å›é¡¾, æˆ‘æƒ³å¤§å®¶å¯¹äº finalã€finallyã€finalize çš„ç”¨æ³•åŒºåˆ«å·²ç»å¾ˆæ¸…æ¥šäº†.

## [JavaåŸºç¡€ï¼šä¸€äº›å¸¸ç”¨ä»£ç ç‰‡æ®µ](https://blog.dong4j.site/posts/b3298821.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})


## è·å–ç¯å¢ƒå˜é‡

```java
System.getenv("PATH");
System.getenv("JAVA_HOME");
```

## è·å–ç³»ç»Ÿå±æ€§

```java
System.getProperty("pencil color");  // å¾—åˆ°å±æ€§å€¼
java -Dpencil color=green
System.getProperty("java.specification.version");  // å¾—åˆ° Java ç‰ˆæœ¬å·
Properties p = System.getProperties();  // å¾—åˆ°æ‰€æœ‰å±æ€§å€¼
p.list(System.out);
```

## String Tokenizer

```java
// èƒ½å¤ŸåŒæ—¶è¯†åˆ«, å’Œ |
StringTokenizer st = new StringTokenizer("Hello, World|of|Java", ", |");
while (st.hasMoreElements()) {
    st.nextToken();
}

// æŠŠåˆ†éš”ç¬¦è§†ä¸º token
StringTokenizer st = new StringTokenizer("Hello, World|of|Java", ", |",  true);
```

## StringBuffer(åŒæ­¥) å’Œ StringBuilder(éåŒæ­¥)

```java
StringBuilder sb = new StringBuilder();
sb.append("Hello");
sb.append("World");
sb.toString();
new StringBuffer(a).reverse();  // åè½¬å­—ç¬¦ä¸²
```

## æ•°å­—

```java
// æ•°å­—ä¸å¯¹è±¡ä¹‹é—´äº’ç›¸è½¬æ¢ - Integer è½¬ int
Integer.intValue();

// æµ®ç‚¹æ•°çš„èˆå…¥
Math.round()

// æ•°å­—æ ¼å¼åŒ–
NumberFormat

// æ•´æ•° -> äºŒè¿›åˆ¶å­—ç¬¦ä¸²
toBinaryString()æˆ– valueOf()

// æ•´æ•° -> å…«è¿›åˆ¶å­—ç¬¦ä¸²
toOctalString()

// æ•´æ•° -> åå…­è¿›åˆ¶å­—ç¬¦ä¸²
toHexString()

// æ•°å­—æ ¼å¼åŒ–ä¸ºç½—é©¬æ•°å­—
RomanNumberFormat()

// éšæœºæ•°
Random r = new Random();
r.nextDouble();
r.nextInt();
```

## æ—¥æœŸå’Œæ—¶é—´

```java
// æŸ¥çœ‹å½“å‰æ—¥æœŸ
Date today = new Date();
Calendar.getInstance().getTime();

// æ ¼å¼åŒ–é»˜è®¤åŒºåŸŸæ—¥æœŸè¾“å‡º
DateFormat df = DateFormat.getInstance();
df.format(today);

// æ ¼å¼åŒ–åˆ¶å®šåŒºåŸŸæ—¥æœŸè¾“å‡º
DateFormat df_cn = DateFormat.getDateInstance(DateFormat.FULL, Locale.CHINA);
String now = df_cn.format(today);

// æŒ‰è¦æ±‚æ ¼å¼æ‰“å°æ—¥æœŸ
SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd hh:mm:ss");
sdf.format(today);

// è®¾ç½®å…·ä½“æ—¥æœŸ
GregorianCalendar d1 = new GregorianCalendar(2009, 05, 06);  // 6 æœˆ 6 æ—¥
GregorianCalendar d2 = new GregorianCalendar();  // ä»Šå¤©
Calendar d3 = Calendar.getInstance();  // ä»Šå¤©
d1.getTime();  // Calendar æˆ– GregorianCalendar è½¬æˆ Date æ ¼å¼
d3.set(Calendar.YEAR, 1999);
d3.set(Calendar.MONTH, Calendar.APRIL);
d3.set(Calendar.DAY_OF_MONTH, 12);

// å­—ç¬¦ä¸²è½¬æ—¥æœŸ
SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd hh:mm:ss");
Date now = sdf.parse(String);

// æ—¥æœŸåŠ å‡
Date now = new Date();
long t = now.getTime();
t += 700*24*60*60*1000;
Date then = new Date(t);

Calendar now = Calendar.getInstance();
now.add(Calendar.YEAR, -2);

// è®¡ç®—æ—¥æœŸé—´éš” (è½¬æ¢æˆ long æ¥è®¡ç®—)
today.getTime()- old.getTime();

// æ¯”è¾ƒæ—¥æœŸ
Date ç±»å‹, å°±ä½¿ç”¨ equals(), before(), after() æ¥è®¡ç®—
long ç±»å‹, å°±ä½¿ç”¨ ==, <, > æ¥è®¡ç®—

// ç¬¬å‡ æ—¥
ä½¿ç”¨ Calendar çš„ get() æ–¹æ³•
Calendar c = Calendar.getInstance();
c.get(Calendar.YEAR);

// è®°å½•è€—æ—¶
long start = System.currentTimeMillis();
long end = System.currentTimeMillis();
long elapsed = end - start;
System.nanoTime();  // æ¯«ç§’

// é•¿æ•´å½¢è½¬æ¢æˆç§’
Double.toString(t/1000D);
```

## ç»“æ„åŒ–æ•°æ®

```java
// æ•°ç»„æ‹·è´
System.arrayCopy(oldArray, 0, newArray, 0, oldArray.length);

// ArrayList
add(Object o)  // åœ¨æœ«å°¾æ·»åŠ ç»™å®šå…ƒç´ 
add(int i, Object o)  // åœ¨æŒ‡å®šä½ç½®æ’å…¥ç»™å®šå…ƒç´ 
clear()  // ä»é›†åˆä¸­åˆ é™¤å…¨éƒ¨å…ƒç´ 
Contains(Object o)  // å¦‚æœ Vector åŒ…å«ç»™å®šå…ƒç´ , è¿”å›çœŸå€¼
get(int i)  // è¿”å›æŒ‡å®šä½ç½®çš„å¯¹è±¡å¥æŸ„
indexOf(Object o)  // å¦‚æœæ‰¾åˆ°ç»™å®šå¯¹è±¡, åˆ™è¿”å›å…¶ç´¢å¼•å€¼ï¼›å¦åˆ™, è¿”å› -1
remove(Object o)  // æ ¹æ®å¼•ç”¨åˆ é™¤å¯¹è±¡
remove(int i)  // æ ¹æ®ä½ç½®åˆ é™¤å¯¹è±¡
toArray()  // è¿”å›åŒ…å«é›†åˆå¯¹è±¡çš„æ•°ç»„

// Iterator
List list = new ArrayList();
Iterator it = list.iterator();
while (it.hasNext())
Object o = it.next();

// é“¾è¡¨
LinkedList list = new LinkedList();
ListIterator it = list.listIterator();
while (it.hasNext())
Object o = it.next();

// HashMap
HashMap<String, String> hm = new HashMap<String, String>();
hm.get(key);  // é€šè¿‡ key å¾—åˆ° value
hm.put("No1", "Hexinyu");
hm.put("No2", "Sean");
// æ–¹æ³• 1: è·å–å…¨éƒ¨é”®å€¼
Iterator<String> it = hm.values().iterator();
while (it.hasNext()) {
    String myKey = it.next();
    String myValue = hm.get(myKey);
}
// æ–¹æ³• 2: è·å–å…¨éƒ¨é”®å€¼
for (String key : hm.keySet()) {
    String myKey = key;
    String myValue = hm.get(myKey);
}

// Preferences - ä¸ç³»ç»Ÿç›¸å…³çš„ç”¨æˆ·è®¾ç½®, ç±»ä¼¼å - å€¼å¯¹
Preferences prefs = Preferences.userNodeForPackage(ArrayDemo.class);
String text = prefs.get("textFontName", "lucida-bright");
String display = prefs.get("displayFontName", "lucida-balckletter");
System.out.println(text);
System.out.println(display);
// ç”¨æˆ·è®¾ç½®äº†æ–°å€¼, å­˜å‚¨å›å»
prefs.put("textFontName", "new-bright");
prefs.put("displayFontName", "new-balckletter");

// Properties - ç±»ä¼¼å - å€¼å¯¹, key å’Œ value ä¹‹é—´, å¯ä»¥ç”¨"=", ":"æˆ–ç©ºæ ¼åˆ†éš”, ç”¨"#"å’Œ"!"æ³¨é‡Š
InputStream in = MediationServer.class.getClassLoader().getResourceAsStream("msconfig.properties");
Properties prop = new Properties();
prop.load(in);
in.close();
prop.setProperty(key, value);
prop.getProperty(key);

// æ’åº
1. æ•°ç»„: Arrays.sort(strings);
2. List: Collections.sort(list);
3. è‡ªå®šä¹‰ç±»: class SubComp implements Comparator
    ç„¶åä½¿ç”¨ Arrays.sort(strings, new SubComp())

// ä¸¤ä¸ªæ¥å£
1. java.lang.Comparable: æä¾›å¯¹è±¡çš„è‡ªç„¶æ’åº, å†…ç½®äºç±»ä¸­
   int compareTo(Object o);
    boolean equals(Object o2);
2. java.util.Comparator: æä¾›ç‰¹å®šçš„æ¯”è¾ƒæ–¹æ³•
   int compare(Object o1, Object o2)

// é¿å…é‡å¤æ’åº, å¯ä»¥ä½¿ç”¨ TreeMap
TreeMap sorted = new TreeMap(unsortedHashMap);

// æ’é™¤é‡å¤å…ƒç´ 
Hashset hs - new HashSet();

// æœç´¢å¯¹è±¡
binarySearch(): å¿«é€ŸæŸ¥è¯¢ - Arrays, Collections
contains(): çº¿å‹æœç´¢ - ArrayList, HashSet, Hashtable, linkedList, Properties, Vector
containsKey(): æ£€æŸ¥é›†åˆå¯¹è±¡æ˜¯å¦åŒ…å«ç»™å®š - HashMap, Hashtable, Properties, TreeMap
containsValue(): ä¸»é”® ( æˆ–ç»™å®šå€¼) - HashMap, Hashtable, Properties, TreeMap
indexOf(): è‹¥æ‰¾åˆ°ç»™å®šå¯¹è±¡, è¿”å›å…¶ä½ç½® - ArrayList, linkedList, List, Stack, Vector
search(): çº¿å‹æœç´  - Stack

// é›†åˆè½¬æ•°ç»„
toArray();

// é›†åˆæ€»ç»“
Collection: Set - HashSet, TreeSet
Collection: List - ArrayList, Vector, LinkedList
Map: HashMap, HashTable, TreeMap
```

## æ³›å‹ä¸ foreach

```java
// æ³›å‹
List<String> myList = new ArrayList<String>();

// foreach
for (String s : myList) {
    System.out.println(s);
}
```

## é¢å‘å¯¹è±¡

```java
// toString() æ ¼å¼åŒ–
public class ToStringWith {
    int x, y;
    public ToStringWith(int anX, int aY) {
        x = anX;
        y = aY;
    }
    public String toString() {
        return "ToStringWith[" + x + "," + y + "]";
    }
    public static void main(String[] args) {
        System.out.println(new ToStringWith(43, 78));
    }
}

// è¦†ç›– equals æ–¹æ³•
public boolean equals(Object o) {
    if (o == this)  // ä¼˜åŒ–
        return true;
    if (!(o instanceof EqualsDemo))  // å¯æŠ•å°„åˆ°è¿™ä¸ªç±»
        return false;
    EqualsDemo other = (EqualsDemo)o;  // ç±»å‹è½¬æ¢
    if (int1 != other.int1)  // æŒ‰å­—æ®µæ¯”è¾ƒ
        return false;
    if (!obj1.equals(other.obj1))
        return false;
    return true;
}

// è¦†ç›– hashcode æ–¹æ³•
private volatile int hashCode = 0;  // å»¶è¿Ÿåˆå§‹åŒ–
public int hashCode() {
    if (hashCode == 0) {
        int result = 17;
        result = 37 * result + areaCode;
    }
    return hashCode;
}

// Clone æ–¹æ³•
è¦å…‹éš†å¯¹è±¡, å¿…é¡»å…ˆåšä¸¤æ­¥: 1. è¦†ç›–å¯¹è±¡çš„ clone() æ–¹æ³•; 2. å®ç°ç©ºçš„ Cloneable æ¥å£
public class Clone1 implements Cloneable {
    public Object clone() {
        return super.clone();
    }
}

// Finalize æ–¹æ³•
Object f = new Object() {
    public void finalize() {
        System.out.println("Running finalize()");
    }
};
Runtime.getRuntime().addShutdownHook(new Thread() {
    public void run() {
        System.out.println("Running Shutdown Hook");
    }
});
åœ¨è°ƒç”¨ System.exit(0); çš„æ—¶å€™, è¿™ä¸¤ä¸ªæ–¹æ³•å°†è¢«æ‰§è¡Œ

// Singleton æ¨¡å¼
// å®ç° 1
public class MySingleton() {
    public static final MySingleton INSTANCE = new MySingleton();
    private MySingleton(){}
}
// å®ç° 2
public class MySingleton() {
    public static MySingleton instance = new MySingleton();
    private MySingleton(){}
    public static MySingleton getInstance() {
        return instance;
    }
}

// è‡ªå®šä¹‰å¼‚å¸¸
Exception: ç¼–è¯‘æ—¶æ£€æŸ¥
RuntimeException: è¿è¡Œæ—¶æ£€æŸ¥
public class MyException extends RuntimeException {
    public MyException() {
        super();
    }
    public MyException(String msg) {
        super(msg);
    }
}
```

## è¾“å…¥å’Œè¾“å‡º

```java
// Stream, Reader, Writer
Stream: å¤„ç†å­—èŠ‚æµ
Reader/Writer: å¤„ç†å­—ç¬¦, é€šç”¨ Unicode

// ä»æ ‡å‡†è¾“å…¥è®¾å¤‡è¯»æ•°æ®
1. ç”¨ System.in çš„ BufferedInputStream() è¯»å–å­—èŠ‚
    int b = System.in.read();
      System.out.println("Read data: " + (char)b);  // å¼ºåˆ¶è½¬æ¢ä¸ºå­—ç¬¦
2. BufferedReader è¯»å–æ–‡æœ¬
    å¦‚æœä» Stream è½¬æˆ Reader, ä½¿ç”¨ InputStreamReader ç±»
    BufferedReader is = new BufferedReader(new
      InputStreamReader(System.in));
      String inputLine;
      while ((inputLine = is.readLine()) != null) {
          System.out.println(inputLine);
          int val = Integer.parseInt(inputLine);  // å¦‚æœ inputLine ä¸ºæ•´æ•°
    }
      is.close();

// å‘æ ‡å‡†è¾“å‡ºè®¾å¤‡å†™æ•°æ®
1. ç”¨ System.out çš„ println() æ‰“å°æ•°æ®
2. ç”¨ PrintWriter æ‰“å°
    PrintWriter pw = new PrintWriter(System.out);
      pw.println("The answer is " + myAnswer + " at this time.");

// Formatter ç±»
æ ¼å¼åŒ–æ‰“å°å†…å®¹
Formatter fmtr = new Formatter();
fmtr.format("%1$04d - the year of %2$f", 1951, Math.PI);
æˆ–è€… System.out.printf(); æˆ–è€… System.out.format();

// åŸå§‹æ‰«æ
void doFile(Reader is) {
    int c;
    while ((c = is.read()) != -1) {
        System.out.println((char)c);
    }
}

// Scanner æ‰«æ
Scanner å¯ä»¥è¯»å– File, InputStream, String, Readable
try {
    Scanner scan = new Scanner(new File("a.txt"));
    while (scan.hasNext()) {
        String s = scan.next();
    }
    } catch (FileNotFoundException e) {
        e.printStackTrace();
    }
}

// è¯»å–æ–‡ä»¶
BufferedReader is = new BufferedReader(new FileReader("myFile.txt"));
BufferedOutputStream bos = new BufferedOutputStream(new FileOutputStream("bytes.bat"));
is.close();
bos.close();

// å¤åˆ¶æ–‡ä»¶
BufferedIutputStream is = new BufferedIutputStream(new FileIutputStream("oldFile.txt"));
BufferedOutputStream os = new BufferedOutputStream(new FileOutputStream("newFile.txt"));
int b;
while ((b = is.read()) != -1) {
    os.write(b);
}
is.close();
os.close();

// æ–‡ä»¶è¯»å…¥å­—ç¬¦ä¸²
StringBuffer sb = new StringBuffer();
char[] b = new char[8192];
int n;
// è¯»ä¸€ä¸ªå—, å¦‚æœæœ‰å­—ç¬¦, åŠ å…¥ç¼“å†²åŒº
while ((n = is.read(b)) > 0) {
    sb.append(b, 0, n);
}
return sb.toString();

// é‡å®šå‘æ ‡å‡†æµ
String logfile = "error.log";
System.setErr(new PrintStream(new FileOutputStream(logfile)));

// è¯»å†™ä¸åŒå­—ç¬¦é›†æ–‡æœ¬
BufferedReader chinese = new BufferedReader(new InputStreamReader(new FileInputStream("chinese.txt"), "ISO8859_1"));
PrintWriter standard = new PrintWriter(new OutputStreamWriter(new FileOutputStream("standard.txt"), "UTF-8"));

// è¯»å–äºŒè¿›åˆ¶æ•°æ®
DataOutputStream os = new DataOutputStream(new FileOutputStream("a.txt"));
os.writeInt(i);
os.writeDouble(d);
os.close();

// ä»æŒ‡å®šä½ç½®è¯»æ•°æ®
RandomAccessFile raf = new RandomAccessFile(fileName, "r");  // r è¡¨ç¤ºå·²åªè¯»æ‰“å¼€
raf.seek(15);  // ä» 15 å¼€å§‹è¯»
raf.readInt();
raf.radLine();

// ä¸²è¡ŒåŒ–å¯¹è±¡
å¯¹è±¡ä¸²è¡ŒåŒ–, å¿…é¡»å®ç° Serializable æ¥å£
// ä¿å­˜æ•°æ®åˆ°ç£ç›˜
ObjectOutputStream os = new ObjectOutputStream(new BufferedOutputStream(new FileOutputStream(FILENAME)));
os.writeObject(serialObject);
os.close();
// è¯»å‡ºæ•°æ®
ObjectInputStream is = new ObjectInputStream(new FileInputStream(FILENAME));
is.readObject();
is.close();

// è¯»å†™ Jar æˆ– Zip æ–‡æ¡£
ZipFile zippy = new ZipFile("a.jar");
Enumeration all = zippy.entries();  // æšä¸¾å€¼åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶æ¸…å•
while (all.hasMoreElements()) {
    ZipEntry entry = (ZipEntry)all.nextElement();
    if (entry.isFile())
        println("Directory: " + entry.getName());

    // è¯»å†™æ–‡ä»¶
    FileOutputStream os = new FileOutputStream(entry.getName());
    InputStream is = zippy.getInputStream(entry);
    int n = 0;
    byte[] b = new byte[8092];
    while ((n = is.read(b)) > 0) {
        os.write(b, 0, n);
        is.close();
        os.close();
    }
}

// è¯»å†™ gzip æ–‡æ¡£
FileInputStream fin = new FileInputStream(FILENAME);
GZIPInputStream gzis = new GZIPInputStream(fin);
InputStreamReader xover = new InputStreamReader(gzis);
BufferedReader is = new BufferedReader(xover);
String line;
while ((line = is.readLine()) != null)
    System.out.println("Read: " + line);
```

## ç›®å½•å’Œæ–‡ä»¶æ“ä½œ

```java
// è·å–æ–‡ä»¶ä¿¡æ¯
exists(): å¦‚æœæ–‡ä»¶å­˜åœ¨, è¿”å› true
getCanonicalPath(): è·å–å…¨å
getName(): æ–‡ä»¶å
getParent(): çˆ¶ç›®å½•
canRead(): å¦‚æœæ–‡ä»¶å¯è¯», è¿”å› true
canWrite(): å¦‚æœæ–‡ä»¶å¯å†™, è¿”å› true
lastModified(): æ–‡ä»¶æ›´æ–°æ—¶é—´
length(): æ–‡ä»¶å¤§å°
isFile(): å¦‚æœæ˜¯æ–‡ä»¶, è¿”å› true
ifDirectory(): å¦‚æœæ˜¯ç›®å½•, è¿”å› true
è¦è°ƒç”¨æ–‡ä»¶çš„è¿™äº›æ–¹æ³•, å¿…é¡»
File f = new File(fileName);

// åˆ›å»ºæ–‡ä»¶
File f = new File("c:\\test\\mytest.txt");
f.createNewFile();  // åˆ›å»º mytest.txt æ–‡ä»¶åˆ° test ç›®å½•ä¸‹

// ä¿®æ”¹æ–‡ä»¶å
File f = new File("c:\\test\\mytest.txt");
f.renameTo(new File("c:\\test\\google.txt"));
æŠŠ mytest.txt ä¿®æ”¹æˆ google.txt

// åˆ é™¤æ–‡ä»¶
File f = new File("c:\\test\\mytest.txt");
f.delete();

// ä¸´æ—¶æ–‡ä»¶
File f = new File("C:\\test");  // æŒ‡å®šä¸€ä¸ªæ–‡ä»¶å¤¹
// åœ¨ test æ–‡ä»¶å¤¹ä¸­åˆ›å»º foo å‰ç¼€, tmp åç¼€çš„ä¸´æ—¶æ–‡ä»¶
File tmp = File.createTempFile("foo", "tmp", f);
tmp.deleteOnExit();  // åœ¨ç¨‹åºç»“æŸæ—¶åˆ é™¤è¯¥ä¸´æ—¶æ–‡ä»¶

// æ›´æ”¹æ–‡ä»¶å±æ€§
setReadOnly(): è®¾ç½®ä¸ºåªè¯»
setlastModified(): è®¾ç½®æœ€åæ›´æ”¹æ—¶é—´

// åˆ—å‡ºå½“å‰æ–‡ä»¶å¤¹çš„æ–‡ä»¶åˆ—è¡¨
String[] dir = new java.io.File(".").list();
java.util.Arrays.sort(dir);
for (int i = 0; i < dir.length; i++) {
    System.out.println(dir[i]);
}

// è¿‡æ»¤æ–‡ä»¶åˆ—è¡¨
class OnlyJava implements FilenameFilter {
    public boolean accept(File dir, String s) {
        if (s.endsWith(".java") || s.endsWith(".class") || s.endsWith(".jar"))
            return true;
    }
}

// è·å–æ ¹ç›®å½•
File[] rootDir = File.listRoots();
for (int i = 0; i < rootDir.length; i++) {
    System.out.println(rootDir[i]);
}

// åˆ›å»ºæ–°ç›®å½•
new File("/home/ian/bin").mkdir();  // å¦‚æœ"/home/ian"å­˜åœ¨, åˆ™å¯ä»¥åˆ›å»º bin ç›®å½•
new File("/home/ian/bin").mkdirs();  // å¦‚æœ"/home/ian"ä¸å­˜åœ¨, ä¼šåˆ›å»ºæ‰€æœ‰çš„ç›®å½•
```

## å›½é™…åŒ–å’Œæœ¬åœ°åŒ–

```java
// I18N èµ„æº
ResourceBundle rb = ResourceBundle.getBundle("Menus");
String label = rb.getString("exit.label");
// ResourceBundle ç›¸å½“äºåå€¼å¯¹, è·å– Menus æŒ‰é’®çš„åŒºåŸŸå±æ€§
Menus_cn.properties: ä¸åŒåŒºåŸŸçš„å±æ€§æ–‡ä»¶

// åˆ—å‡ºæœ‰æ•ˆåŒºåŸŸ
Locale[] list = Locale.getAvailableLocales()ï¼›

// æŒ‡å®šåŒºåŸŸ
Locale cnLocale = Locale.CHINA;

// è®¾ç½®é»˜è®¤åŒºåŸŸ
Locale.setDefault(Locale.CHINA);

// æ ¼å¼åŒ–æ¶ˆæ¯
public class MessageFormatDemo {
    static Object[] data = {
        new java.util.Date(),
        "myfile.txt",
        "could nto be opened"
    };
    public static void main(String[] args) {
        String result = MessageFormat.format("At {0,time} on {0,date}, {1} {2}.", data);
        System.out.println(result);
    }
}
è¾“å‡º: At 10:10:08 on 2009-6-18, myfile.txt could nto be opened.

// ä»èµ„æºæ–‡ä»¶ä¸­è¯»æ¶ˆæ¯
Widgets.properties åœ¨ com.sean.cook.chap11 ä¸‹
ResourceBundle rb = ResourceBundle.getBundle("com.sean.cook.chap11.Widgets");
String propt = rb.getString("filedialogs.cantopen.string");
String result = MessageFormat.format(rb.getString("filedialogs.cantopen.format"), data);
```

## ç½‘ç»œå®¢æˆ·ç«¯

```java
// è®¿é—®æœåŠ¡å™¨
Socket socket = new Socket("127.0.0.1", 8080);
// todo something
socket.close();

// æŸ¥æ‰¾ç½‘ç»œåœ°å€
InetAddress.getByName(hostName).getHostAddress()); // æ ¹æ®ä¸»æœºåå¾—åˆ° IP åœ°å€
InetAddress.getByName(ipAddr).getHostName()); // æ ¹æ® IP åœ°å€å¾—åˆ°ä¸»æœºå

// è¿æ¥å…·ä½“å¼‚å¸¸
UnknownHostException
NoRouteToHostException
ConnectException

// Socket è¯»å†™æ–‡æœ¬æ•°æ®
BufferedReader in = new BufferedReader(new InputStreamReader(socket.getInputStream()));
String remoteTime = in.readline();
PrintWriter out = new PrintWriter(socket.getOutputStream(), true);
out.print("send message to client \r\n");
out.flush();

// Socket è¯»å†™äºŒè¿›åˆ¶æ•°æ®
DataInputStream in = new DataInputStream(new BufferedInputStream(socket.getInputStream()));
long remoteTime = (long)(in.readUnsignedByte() << 24);
DataOutputStream out = new DataOutputStream(socket.getOutputStream(), true);

// Socket è¯»å†™ä¸²è¡ŒåŒ–æ•°æ®
ObjectInputStream in = new ObjectInputStream(new BufferedInputStream(socket.getInputStream()));
Object o = in.readObject();
if (o instanceof Date) // éªŒè¯å¯¹è±¡ç±»å‹
ObjectOutputStream out = new ObjectOutputStream(socket.getOutputStream(), true);

// UDP æ•°æ®æŠ¥
private final static int PACKET_SIZE = 1024;

String host = "EV001B389673DE";
InetAddress serverAddr = InetAddress.getByName(host);
DatagramSocket socket = new DatagramSocket();
byte[] buffer = new byte[PACKET_SIZE]; // åˆ†é…æ•°æ®ç¼“å†²ç©ºé—´
DatagramPacket packet = new DatagramPacket(buffer, PACKET_SIZE, serverAddr, 8080);
packet.setLength(PACKET_SIZE-1); // è®¾ç½®æ•°æ®é•¿åº¦
socket.send(packet);
socket.receive(packet); // æ¥æ”¶æ•°æ®
```

## æœåŠ¡å™¨ç«¯: Socket

```java
// åˆ›å»º ServerSocket
ServerSocket serverSocket;
Socket clientSocket;

serverSocket = new ServerSocket(9999);
while ((clientSocket = serverSocket.accept()) != null) {
    System.out.println("Accept from client " + s.getInetAddress());
    s.close();
}

// ç›‘å¬å†…éƒ¨ç½‘
public static final short PORT = 9999;
public static final String INSIDE_HOST = "acmewidgets-inside"; // ç½‘ç»œæ¥å£å
public static final int BACKLOG = 10; // å¾…å‘æ•°
serverSocket = new ServerSocket(PORT, BACKLOG, InetAddress.getByName(INSIDE_HOST));

// è¿”å›ç›¸åº”å¯¹è±¡
ServerSocket serverSocket =  new ServerSocket(9999);;
Socket clientSocket;
BufferedReader in = null;
PrintWriter out = null;
while (true) {
    clientSocket = serverSocket.accept();
    in = new BufferedReader(new InputStreamReader(clientSocket.getInputStream(), "8859_1"));
    out = new PrintWriter(new OutputStreamWriter(clientSocket.getOutputStream(), "8859_1"), true);
    String echoLine;
    while ((echoLine = in.readLine()) != null) {
        System.out.println("Read " + echoLine);
        out.print(echoLine + "\r\n");
    }
}
ä»¥ä¸Šä¾‹å­è¿”å›å­—ç¬¦ä¸², å¦‚æœè¿”å›äºŒè¿›åˆ¶, åˆ™ä½¿ç”¨ DataOutputStreamï¼›è¿”å›å¯¹è±¡, ä½¿ç”¨ ObjectOutputStream

// å¤„ç†å¤šå®¢æˆ·ç«¯
éœ€è¦æŠŠæ¥æ”¶æ•°æ®çš„å¤„ç†æ”¾å…¥å¤šçº¿ç¨‹ä¸­
public class EchoServerThreaded {
    public static final int ECHOPORT = 7;
    public static final int NUM_THREADS = 4;

    public static void main(String[] av) {
        new EchoServerThreaded(ECHOPORT, NUM_THREADS);
    }

    public EchoServerThreaded2(int port, int numThreads) {
        ServerSocket servSock;
        Socket clientSocket;
        try {
            servSock = new ServerSocket(ECHOPORT);
        } catch(IOException e) {
            throw new RuntimeException("Could not create ServerSocket " + e);
        }
        for (int i = 0; i < numThreads; i++) {
            new Handler(servSock, i).start();
        }
    }
}
class Handler extends Thread {
    ServerSocket servSock;
    int threadNumber;

    Handler(ServerSocket s, int i) {
        super();
        servSock = s;
        threadNumber = i;
        setName("Thread " + threadNumber);
    }

    public void run() {
        while (true) {
            try {
                System.out.println(getName() + " waiting");
                Socket clientSocket;
                synchronized (servSock) {
                    clientSocket = servSock.accept();
                }
                System.out.println(getName() + " starting, IP=" + clientSocket.getInetAddress());
                BufferedReader is = new BufferedReader(new InputStreamReader(
                    clientSocket.getInputStream()));
                PrintStream os = new PrintStream(clientSocket.getOutputStream(), true);
                String line;
                while ((line = is.readLine()) != null) {
                    os.print(line + "\r\n");
                    os.flush();
                }
                System.out.println(getName() + " ENDED ");
                clientSocket.close();
            } catch (IOException ex) {
                System.out.println(getName() + ": IO Error on socket " + ex);
                return;
            }
        }
    }
}

// ä½¿ç”¨ SSL å’Œ JSSE ä¿æŠ¤ Web æœåŠ¡å™¨
SSLServerSocketFactory ssf = (SSLServerSocketFactory)SSLServerSocketFactory.getDefault()ï¼›
ServerSocket serverSocket = ssf.createServerSocket(8080);

// Log4j
Level çº§åˆ«: DEBUG < INFO < WARN < ERROR < FATAL < OFF
Appender: è¾“å‡ºä¿¡æ¯
ConsoleAppender: è¾“å‡ºæ§åˆ¶å° System.out

// æ‰¾åˆ°ç½‘ç»œæ¥å£
Enumeration list = NetworkInterface.getNetworkInterfaces();
while (list.hasMoreElements()) {
    NetworkInterface iface = (NetworkInterface)list.nextElement();
    System.out.println(iface.getDisplayName());
    Enumeration addrs = iface.getInetAddresses();
    while (addrs.hasMoreElements()) {
        InetAddress addr = (InetAddress)addrs.nextElement();
        System.out.println(addr);
    }
}
```

## Java Mail

```java
// å‘é€ Mail
protected String msgRecIp = "hxydream@163.com";
protected String msgSubject = "babytree";
protected String msgCc = "nobody@erewhon.com";
protected String msgBody = "test body";
protected Session session;
protected Message msg;

public void doSend() {
    // åˆ›å»ºå±æ€§æ–‡ä»¶
    Properties props = new Properties();
    props.put("mail.smtp.host", "mailhost");
    // åˆ›å»º Session å¯¹è±¡
    session = Session.getDefaultInstance(props, null);
    session.setDebug(true);
    msg = new MimeMessage(session); // åˆ›å»ºé‚®ä»¶
    msg. setFrom(new InternetAddress("nobody@host.domain"));
    InternetAddress toAddr = new InternetAddress(msgRecIp);
    msg.addRecipient(Message.RecipientType.TO, toAddr);
    InternetAddress ccAddr = new InternetAddress(msgCc);
    msg.addRecipient(Message.RecipientType.CC, ccAddr);
    msg.setSubject(msgSubject);
    msg.setText(msgBody);
    Transport.send(msg);
}

// å‘é€ MIME é‚®ä»¶
Multipart mp = new MimeMultipart();
BodyPart textPart = new MimeBodyPart();
textPart.setText(message_body);  // è®¾ç½®ç±»å‹"text/plain"
BodyPart pixPart = new MimeBodyPart();
pixPart.setContent(html_data, "text/html");
mp.addBodyPart(textPart);
mp.addBodyPart(pixPart);
mesg.setContent(mp);
Transport.send(mesg);

// è¯» Mail
Store store = session.getStore(protocol);
store.connect(host, user, password);
Folder rf;
rf = store.getFolder(root);
rf = store.getDefaultFolder();
rf.open(Folder.READ_WRITE);
```

## æ•°æ®åº“è®¿é—®

```java
// JDO
Properties p = new Properties();
p.load(new FileInputStream("jdo.properties"));
PersistenceManagerFactory pmf = JDOHelper.getPersistenceManagerFactory(p);
PersistenceManager pm = pmf.getPersistenceManager();
// æäº¤æ•°æ®
pm.currentTransaction().begin();
if (o instanceof Collection) {
    pm.makePersistentAll((Collection) o);
} else {
    pm.makePersistent(o);
}
pm.currentTransaction().commit();
pm.close();
// å–å‡ºæ•°æ®
Object[] data = new Object[3];
pm.retrieveAll(data);
for (int i = 0; i < data.length; i++) {
    System.out.println(data[i]);
}
pm.close();

// æ•°æ®æ“ä½œ
Class clz = Class.forName("oracle.jdbc.driver.OracleDriver");
String dbUrl = "jdbc:oracle:thin:@192.168.0.23:1521#:nms";
Connection conn = DriverManager.getConnection(dbUrl, "su", "1234");
Statement stmt = conn.createStatement();
ResultSet rs = stmt.executeQuery("select * from pmtable");
while (rs.next()) {
    String name = rs.getString(1);
    String otherName = rs.getString("name");
}

// ä½¿ç”¨ PreparedStatement æé«˜æ€§èƒ½, é™¤äº†æŸ¥è¯¢, éƒ½ä½¿ç”¨ executeUpdate æ‰§è¡Œæ“ä½œ
PreparedStatement pstmt = conn.prepareStatement("select * from pmtable where name = ?");
pstmt.setString(1, "sean");
ResultSet rs = pstmt.executeQuery();

// è°ƒç”¨å­˜å‚¨è¿‡ç¨‹
CallableStatement cs = conn.prepareCall("{ call ListDefunctUsers }");
ResultSet rs = cs.executeQuery();

// æ˜¾ç¤ºæ•°æ®åº“è¡¨ä¿¡æ¯
DatabaseMetaData meta = conn.getMetaData();
meta.getDatabaseProductName();
meta.getDatabaseProductVersion();
meta.getDefaultTransactionIsolation();
```

## XML

```java
/*
    SAX: åœ¨è¯»å–æ–‡æ¡£æå–ç›¸åº”çš„æ ‡è®°äº‹ä»¶ (å…ƒç´ èµ·å§‹ã€å…ƒç´ ç»“æŸã€æ–‡æ¡£èµ·å§‹)
    DOM: åœ¨å†…å­˜ä¸­æ„é€ ä¸æ–‡æ¡£ä¸­å…ƒç´ ç›¸åº”çš„æ ‘, å¯ä»¥éå†ã€æœç´¢ã€ä¿®æ”¹
    DTD: éªŒè¯æ–‡æ¡£æ˜¯å¦æ­£ç¡®
    JAXP: ç”¨äº XML å¤„ç†çš„ Java API
    Castor: å¼€æºé¡¹ç›®, ç”¨äº Java å¯¹è±¡ä¸ XML æ˜ å°„
*/
// ä»å¯¹è±¡ä¸­ç”Ÿæˆ XML
private final static String FILENAME = "serial.xml";
public static void main(String[] args) throws IOException {
    String a = "hard work and best callback";
    new SerialDemoXML().write(a);
    new SerialDemoXML().dump();
}
public void write(Object obj) throws IOException {
    XMLEncoder os = new XMLEncoder(new BufferedOutputStream(new FileOutputStream(FILENAME)));
    os.writeObject(obj);
    os.close();
}
public void dump() throws IOException {
    XMLDecoder out = new XMLDecoder(new BufferedInputStream(new FileInputStream(FILENAME)));
    System.out.println(out.readObject());
    out.close();
}
serial.xml æ ¼å¼å†…å®¹å¦‚ä¸‹:
<?xml version="1.0" encoding="UTF-8"?>
<java version="1.6.0_02" class="java.beans.XMLDecoder">
    <string>hard work and best callback</string>
</java>
æ§åˆ¶å°è¾“å‡º
hard work and best callback

// XSLT è½¬æ¢ XML
XSLT å¯ä»¥ç”¨æ¥å¯¹è¾“å‡ºæ ¼å¼è¿›è¡Œå„ç§æ§åˆ¶
Transformer tx = TransformerFactory.newInstance().newTransformer(new StreamSource("people.xml"));
tx.transform(new StreamSource("people.xml"), new StreamResult("people.html"));

// ç”¨ SAX è§£æ XML - ä¸»è¦ç”¨äºæŸ¥æ‰¾å…³é”®å…ƒç´ , ä¸ç”¨å…¨æ–‡éå†
public SaxLister() throws SAXException, IOException {
    XMLReader parser = XMLReaderFactory.createXMLReader("org.apache.xerces.parsers.SAXParser");
    parser.setContentHandler(new PeopleHandler());
    parser.parse("C:\\StudySource\\javacooksrc2\\xml\\people.xml");
}
class PeopleHandler extends DefaultHandler {
    boolean parent = false;
    boolean kids = false;
    public void startElement(String nsURI, String localName, String rawName, Attributes attr) throws SAXException {
        System.out.println("startElement: " +  localName + "," + rawName);
        if (rawName.equalsIgnoreCase("name"))
            parent = true;
        if (rawName.equalsIgnoreCase("children"))
        kids = true;
    }
    public void characters(char[] ch, int start, int length) {
        if (parent) {
            System.out.println("Parent: " + new String(ch, start, length));
            parent = false;
        } else if (kids) {
            System.out.println("Children: " + new String(ch, start, length));
            kids = false;
        }
    }
    public PeopleHandler() throws SAXException {
        super();
    }
}

// DOM è§£æ XML - éå†æ•´ä¸ªæ ‘
String uri = "file:" + new File("C:\\StudySource\\javacooksrc2\\xml\\people.xml").getAbsolutePath();
DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
DocumentBuilder builder = factory.newDocumentBuilder();
Document doc = builder.parse(uri);
NodeList nodes = doc.getChildNodes();
for (int i = 0; i < nodes.getLength(); i++) {
    Node n = nodes.item(i);
    switch (n.getNodeType()) {
    case Node.ELEMENT_NODE:
        // todo
        break;
    case Node.TEXT_NODE:
        // todo
        break;
    }
}

// ä½¿ç”¨ DTD æˆ–è€… XSD éªŒè¯
å®šä¹‰å¥½ DTD æˆ– XSD æ–‡ä»¶
XmlDocument doc = XmlDocument.createXmlDocument(uri, true);

// ç”¨ DOM ç”Ÿæˆ XML
DocumentBuilderFactory fact = DocumentBuilderFactory.newInstance();
DocumentBuilder parser = fact.newDocumentBuilder();
Document doc = parser.newDocument();
Node root = doc.createElement("Poem");
doc.appendChild(root);
Node stanza = doc.createElement("Stanza");
root.appendChild(stanza);
Node line = doc.createElement("Line");
stanza.appendChild(line);
line.appendChild(doc.createTextNode("Once, upon a midnight dreary"));
line = doc.createElement("Line");
stanza.appendChild(line);
line.appendChild(doc.createTextNode("While I pondered, weak and weary"));
```

## RMI

```java
a. å®šä¹‰å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡æ¥å£
public interface RemoteDate extends Remote {
    public Date getRemoteDate() throws RemoteException;
    public final static String LOOKUPNAME = "RemoteDate";
}

b. ç¼–å†™ RMI æœåŠ¡å™¨
public class RemoteDateImpl extends UnicastRemoteObject implements RemoteDate {
    public RemoteDateImpl() throws RemoteException {
        super();
    }
    public Date getRemoteDate() throws RemoteException {
        return new Date();
    }
}
RemoteDateImpl im = new RemoteDateImpl();
System.out.println("DateServer starting...");
Naming.rebind(RemoteDate.LOOKUPNAME, im);
System.out.println("DateServer ready.");

c. è¿è¡Œ rmic ç”Ÿæˆ stub
javac RemoteDateImpl.java
rmic RemoteDateImpl

d. ç¼–å†™å®¢æˆ·ç«¯
netConn = (RemoteDate)Naming.lookup(RemoteDate.LOOKUPNAME);
Date today = netConn.getRemoteDate();
System.out.println(today.toString());

e. ç¡®ä¿ RMI æ³¨å†Œè¡¨è¿è¡Œ
rmiregistry

f. å¯åŠ¨æœåŠ¡å™¨
java RemoteDateImpl

g. è¿è¡Œå®¢æˆ·ç«¯
java DateClient


// 19. åŒ…å’ŒåŒ…è£…æœºåˆ¶
    jar cvf /tmp/test.jar .  // å½“å‰ç›®å½•å‹ç¼©åˆ° test.jar ä¸­
    jar xvf /tmp/test.jar  // æŠŠ test.jar è§£å‹åˆ°å½“å‰ç›®å½•
    ä»æŒ‡å®š class è¿è¡Œ jar æ–‡ä»¶
    a. Main-Class: HelloWord  // æ³¨æ„ä¸­é—´æœ‰ä¸€ä¸ªç©ºæ ¼
    b. jar cvmf manifest.mf hello.jar HelloWorld.class
    c. java -jar hello.jar
*/
// åœæ­¢çº¿ç¨‹ - ä¸è¦ä½¿ç”¨ stop() æ–¹æ³•
private boolean done = false;
public void run() {
    while (!done) {
        // todo
    }
}
public void shutDown() {
    done = true;
}
å¯ä»¥è°ƒç”¨ shutDown() æ–¹æ³•æ¥ç»“æŸçº¿ç¨‹

// å¦‚æœè¯»å– IO çš„æ—¶å€™å‡ºç°å µå¡, é‚£ä¹ˆå¯ä»¥ä½¿ç”¨ä¸‹é¢æ–¹æ³•
public void shutDown() throws IOException {
    if (io != null)
        io.close();
}

// å¯åŠ¨ä¸€çº¿ç¨‹, ç­‰å¾…æ§åˆ¶å°è¾“å…¥, ä½¿ç”¨ join() æ–¹æ³•æ¥æš‚åœå½“å‰çº¿ç¨‹, ç›´åˆ°å…¶ä»–çº¿ç¨‹è°ƒç”¨
Thread t = new Thread() {
    public void run() {
        System.out.println("Reading");
        try {
            System.in.read();
        } catch (IOException e) {
            System.err.println(e);
        }
        System.out.println("Thread finished.");
    }
};
System.out.println("Starting");
t.start();
System.out.println("Joining");
try {
    t.join();
} catch (InterruptedException e) {
    System.out.println("Who dares imterrupt my sleep?");
}
System.out.println("Main finished.");

// åŠ é”ä¿è¯åŒæ­¥
Lock lock = new ReentrantLock();
try {
    lock.lock();
    // todo
} finally {
    lock.unlock();
}

çº¿ç¨‹é€šä¿¡ wait(), notify(), notifyAll()
ç”Ÿäº§è€… - æ¶ˆè´¹è€…æ¨¡å¼
Executors
```

## Java çº¿ç¨‹

```java
// åœæ­¢çº¿ç¨‹ - ä¸è¦ä½¿ç”¨ stop() æ–¹æ³•
private boolean done = false;
public void run() {
    while (!done) {
        // todo
    }
}
public void shutDown() {
    done = true;
}
å¯ä»¥è°ƒç”¨ shutDown() æ–¹æ³•æ¥ç»“æŸçº¿ç¨‹

// å¦‚æœè¯»å– IO çš„æ—¶å€™å‡ºç°å µå¡, é‚£ä¹ˆå¯ä»¥ä½¿ç”¨ä¸‹é¢æ–¹æ³•
public void shutDown() throws IOException {
    if (io != null)
        io.close();
}

// å¯åŠ¨ä¸€çº¿ç¨‹, ç­‰å¾…æ§åˆ¶å°è¾“å…¥, ä½¿ç”¨ join() æ–¹æ³•æ¥æš‚åœå½“å‰çº¿ç¨‹, ç›´åˆ°å…¶ä»–çº¿ç¨‹è°ƒç”¨
Thread t = new Thread() {
    public void run() {
        System.out.println("Reading");
        try {
            System.in.read();
        } catch (IOException e) {
            System.err.println(e);
        }
        System.out.println("Thread finished.");
    }
};
System.out.println("Starting");
t.start();
System.out.println("Joining");
try {
    t.join();
} catch (InterruptedException e) {
    System.out.println("Who dares imterrupt my sleep?");
}
System.out.println("Main finished.");

// åŠ é”ä¿è¯åŒæ­¥
Lock lock = new ReentrantLock();
try {
    lock.lock();
    // todo
} finally {
    lock.unlock();
}

çº¿ç¨‹é€šä¿¡ wait(), notify(), notifyAll()
ç”Ÿäº§è€… - æ¶ˆè´¹è€…æ¨¡å¼
Executors
```

## å†…çœæˆ–â€œå‘½ä»¤ç±»çš„ç±»â€

```java
// åå°„
Class c = Class.forName("java.lang.String");
Constructor[] cons = c.getConstructors();
for (int i = 0; i < cons.length; i++) {
    System.out.println(cons[i].toString());
}
Method[] meths = c.getMethods();
for (int i = 0; i < meths.length; i++) {
    System.out.println(meths[i].toString());
}

// åŠ¨æ€è£…è½½ç±»
Class c = Class.forName("java.lang.String");
Object obj = c.newInstance();

// é€šè¿‡åå°„è°ƒç”¨ç±»çš„æ–¹æ³•
class X {
    public void master(String s) {
        System.out.println("Working on \"" + s + "\"");
    }
}
Class clx = X.class;
Class[] argTypes = {String.class};
Method worker = clx.getMethod("master", argTypes);
Object[] theData = {"Chocolate chips"};
worker.invoke(new X(), theData);
è¾“å‡º: Working on "Chocolate chips"
```

## Java ä¸å…¶ä»–è¯­è¨€çš„ç»“åˆ

```java
// æ‰§è¡Œ CMD å‘½ä»¤, åœ¨ Eclipse æ§åˆ¶å°è¾“å‡º
Process p = Runtime.getRuntime().exec("C:/StudySource/ver.cmd");
p.waitFor(); // ç­‰å¾…å‘½ä»¤æ‰§è¡Œå®Œ
BufferedReader br = new BufferedReader(new InputStreamReader(p.getInputStream()));
String s;
while ((s = br.readLine()) != null)
    System.out.println(s);

// è°ƒç”¨ Jython - è®¡ç®— 22.0/7
BSFManager manager = new BSFManager();
String[] fntypes = {".py"};
manager.registerScriptingEngine("jython", "org.apache.bsf.engines.jython.JythonEngine", fntypes);
Object r = manager.eval("jython", "testString", 0, 0, "22.0/7");
System.out.println("Result type is " + r.getClass().getName());
System.out.println("Result value is " + r);

// è°ƒç”¨ C++, ä½¿ç”¨ JNI
```

## [Jaç¼–ç¨‹ï¼šçŸ¥è¯†ç‚¹æ€»ç»“äºŒ](https://blog.dong4j.site/posts/569377f1.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})


## equals çš„å†™æ³•

```java
public boolean equals(Object o){
    if(this == o) return true;
    if(o == null) return false;
    if(!o instanceof strudent) return false;
    student s = (student)o;
    if(s.name.equals(this.name) && s.age == this.age) return true;
    else return false;
}
```

## è¯´è¯´ & å’Œ && çš„åŒºåˆ«.

& å’Œ && éƒ½å¯ä»¥ç”¨ä½œé€»è¾‘ä¸çš„è¿ç®—ç¬¦, è¡¨ç¤ºé€»è¾‘ä¸ï¼ˆandï¼‰, å½“è¿ç®—ç¬¦ä¸¤è¾¹çš„è¡¨è¾¾å¼çš„ç»“æœéƒ½ä¸º true æ—¶, æ•´ä¸ªè¿ç®—ç»“æœæ‰ä¸º true, å¦åˆ™, åªè¦æœ‰ä¸€æ–¹ä¸º false,
åˆ™ç»“æœä¸º false.
&& è¿˜å…·æœ‰çŸ­è·¯çš„åŠŸèƒ½, å³å¦‚æœç¬¬ä¸€ä¸ªè¡¨è¾¾å¼ä¸º false, åˆ™ä¸å†è®¡ç®—ç¬¬äºŒä¸ªè¡¨è¾¾å¼, ä¾‹å¦‚, å¯¹äº if(str != null && !str.equals(â€œâ€)) è¡¨è¾¾å¼, å½“ str ä¸º
null æ—¶, åé¢çš„è¡¨è¾¾å¼ä¸ä¼šæ‰§è¡Œ, æ‰€ä»¥ä¸ä¼šå‡ºç° NullPointerException å¦‚æœå°† && æ”¹ä¸º &, åˆ™ä¼šæŠ›å‡º NullPointerException å¼‚å¸¸. If(x==33 & ++y>0) y
ä¼šå¢é•¿, If(x==33 && ++y>0) ä¸ä¼šå¢é•¿
& è¿˜å¯ä»¥ç”¨ä½œä½è¿ç®—ç¬¦, å½“ & æ“ä½œç¬¦ä¸¤è¾¹çš„è¡¨è¾¾å¼ä¸æ˜¯ boolean ç±»å‹æ—¶, & è¡¨ç¤ºæŒ‰ä½ä¸æ“ä½œ, æˆ‘ä»¬é€šå¸¸ä½¿ç”¨ 0x0f æ¥ä¸ä¸€ä¸ªæ•´æ•°è¿›è¡Œ & è¿ç®—, æ¥è·å–è¯¥æ•´æ•°çš„æœ€ä½
4 ä¸ª bit ä½, ä¾‹å¦‚, 0x31 & 0x0f çš„ç»“æœä¸º 0x01.

å¤‡æ³¨: è¿™é“é¢˜å…ˆè¯´ä¸¤è€…çš„å…±åŒç‚¹, å†è¯´å‡º && å’Œ & çš„ç‰¹æ®Šä¹‹å¤„, å¹¶åˆ—ä¸¾ä¸€äº›ç»å…¸çš„ä¾‹å­æ¥è¡¨æ˜è‡ªå·±ç†è§£é€å½»æ·±å…¥ã€å®é™…ç»éªŒä¸°å¯Œ.

## short s1 = 1; s1 = s1 + 1; æœ‰ä»€ä¹ˆé”™? short s1 = 1; s1 += 1; æœ‰ä»€ä¹ˆé”™?

å¯¹äº short s1 = 1; s1 = s1 + 1; ç”±äº s1+1 è¿ç®—æ—¶ä¼šè‡ªåŠ¨æå‡è¡¨è¾¾å¼çš„ç±»å‹, æ‰€ä»¥ç»“æœæ˜¯ int å‹, å†èµ‹å€¼ç»™ short ç±»å‹ s1 æ—¶, ç¼–è¯‘å™¨å°†æŠ¥å‘Šéœ€è¦å¼ºåˆ¶è½¬æ¢ç±»å‹çš„é”™è¯¯.
å¯¹äº short s1 = 1; s1 += 1; ç”±äº += æ˜¯ java è¯­è¨€è§„å®šçš„è¿ç®—ç¬¦, java ç¼–è¯‘å™¨ä¼šå¯¹å®ƒè¿›è¡Œç‰¹æ®Šå¤„ç†, å› æ­¤å¯ä»¥æ­£ç¡®ç¼–è¯‘.

## char å‹å˜é‡ä¸­èƒ½ä¸èƒ½å­˜è´®ä¸€ä¸ªä¸­æ–‡æ±‰å­—? ä¸ºä»€ä¹ˆ?

char å‹å˜é‡æ˜¯ç”¨æ¥å­˜å‚¨ Unicode ç¼–ç çš„å­—ç¬¦çš„, unicode ç¼–ç å­—ç¬¦é›†ä¸­åŒ…å«äº†æ±‰å­—, æ‰€ä»¥, char å‹å˜é‡ä¸­å½“ç„¶å¯ä»¥å­˜å‚¨æ±‰å­—å•¦. ä¸è¿‡, å¦‚æœæŸä¸ªç‰¹æ®Šçš„æ±‰å­—æ²¡æœ‰è¢«åŒ…å«åœ¨
unicode ç¼–ç å­—ç¬¦é›†ä¸­, é‚£ä¹ˆ, è¿™ä¸ª char å‹å˜é‡ä¸­å°±ä¸èƒ½å­˜å‚¨è¿™ä¸ªç‰¹æ®Šæ±‰å­—. è¡¥å……è¯´æ˜: unicode ç¼–ç å ç”¨ä¸¤ä¸ªå­—èŠ‚, æ‰€ä»¥, char ç±»å‹çš„å˜é‡ä¹Ÿæ˜¯å ç”¨ä¸¤ä¸ªå­—èŠ‚.

## ä½¿ç”¨ final å…³é”®å­—ä¿®é¥°ä¸€ä¸ªå˜é‡æ—¶, æ˜¯å¼•ç”¨ä¸èƒ½å˜, è¿˜æ˜¯å¼•ç”¨çš„å¯¹è±¡ä¸èƒ½å˜ï¼Ÿ

ä½¿ç”¨ final å…³é”®å­—ä¿®é¥°ä¸€ä¸ªå˜é‡æ—¶, æ˜¯æŒ‡å¼•ç”¨å˜é‡ä¸èƒ½å˜, å¼•ç”¨å˜é‡æ‰€æŒ‡å‘çš„å¯¹è±¡ä¸­çš„å†…å®¹è¿˜æ˜¯å¯ä»¥æ”¹å˜çš„. ä¾‹å¦‚, å¯¹äºå¦‚ä¸‹è¯­å¥:
final StringBuffer a=new StringBuffer("immutable"); æ‰§è¡Œå¦‚ä¸‹è¯­å¥å°†æŠ¥å‘Šç¼–è¯‘æœŸé”™è¯¯:
a=new StringBuffer(""); ä½†æ˜¯, æ‰§è¡Œå¦‚ä¸‹è¯­å¥åˆ™å¯ä»¥é€šè¿‡ç¼–è¯‘:
a.append("broken!");

æœ‰äººåœ¨å®šä¹‰æ–¹æ³•çš„å‚æ•°æ—¶, å¯èƒ½æƒ³é‡‡ç”¨å¦‚ä¸‹å½¢å¼æ¥é˜»æ­¢æ–¹æ³•å†…éƒ¨ä¿®æ”¹ä¼ è¿›æ¥çš„å‚æ•°å¯¹è±¡:
public void method(final StringBuffer param)
{
}
å®é™…ä¸Š, è¿™æ˜¯åŠä¸åˆ°çš„, åœ¨è¯¥æ–¹æ³•å†…éƒ¨ä»ç„¶å¯ä»¥å¢åŠ å¦‚ä¸‹ä»£ç æ¥ä¿®æ”¹å‚æ•°å¯¹è±¡:
param.append("a");

## "=="å’Œ equals æ–¹æ³•ç©¶ç«Ÿæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

== æ“ä½œç¬¦ä¸“é—¨ç”¨æ¥æ¯”è¾ƒä¸¤ä¸ªå˜é‡çš„å€¼æ˜¯å¦ç›¸ç­‰, ä¹Ÿå°±æ˜¯ç”¨äºæ¯”è¾ƒå˜é‡æ‰€å¯¹åº”çš„å†…å­˜ä¸­æ‰€å­˜å‚¨çš„æ•°å€¼æ˜¯å¦ç›¸åŒ, è¦æ¯”è¾ƒä¸¤ä¸ªåŸºæœ¬ç±»å‹çš„æ•°æ®æˆ–ä¸¤ä¸ªå¼•ç”¨å˜é‡æ˜¯å¦ç›¸ç­‰,
åªèƒ½ç”¨ == æ“ä½œç¬¦.
å¦‚æœä¸€ä¸ªå˜é‡æŒ‡å‘çš„æ•°æ®æ˜¯å¯¹è±¡ç±»å‹çš„, é‚£ä¹ˆ, è¿™æ—¶å€™æ¶‰åŠäº†ä¸¤å—å†…å­˜, å¯¹è±¡æœ¬èº«å ç”¨ä¸€å—å†…å­˜ï¼ˆå †å†…å­˜ï¼‰, å˜é‡ä¹Ÿå ç”¨ä¸€å—å†…å­˜, ä¾‹å¦‚ Objet obj = new
Object(); å˜é‡ obj æ˜¯ä¸€ä¸ªå†…å­˜, new Object() æ˜¯å¦ä¸€ä¸ªå†…å­˜, æ­¤æ—¶, å˜é‡ obj æ‰€å¯¹åº”çš„å†…å­˜ä¸­å­˜å‚¨çš„æ•°å€¼å°±æ˜¯å¯¹è±¡å ç”¨çš„é‚£å—å†…å­˜çš„é¦–åœ°å€.
å¯¹äºæŒ‡å‘å¯¹è±¡ç±»å‹çš„å˜é‡, å¦‚æœè¦æ¯”è¾ƒä¸¤ä¸ªå˜é‡æ˜¯å¦æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡, å³è¦çœ‹è¿™ä¸¤ä¸ªå˜é‡æ‰€å¯¹åº”çš„å†…å­˜ä¸­çš„æ•°å€¼æ˜¯å¦ç›¸ç­‰, è¿™æ—¶å€™å°±éœ€è¦ç”¨ == æ“ä½œç¬¦è¿›è¡Œæ¯”è¾ƒ.
equals æ–¹æ³•æ˜¯ç”¨äºæ¯”è¾ƒä¸¤ä¸ªç‹¬ç«‹å¯¹è±¡çš„å†…å®¹æ˜¯å¦ç›¸åŒ, å°±å¥½æ¯”å»æ¯”è¾ƒä¸¤ä¸ªäººçš„é•¿ç›¸æ˜¯å¦ç›¸åŒ, å®ƒæ¯”è¾ƒçš„ä¸¤ä¸ªå¯¹è±¡æ˜¯ç‹¬ç«‹çš„. ä¾‹å¦‚, å¯¹äºä¸‹é¢çš„ä»£ç :
String a=new String("foo");
String b=new String("foo");
ä¸¤æ¡ new è¯­å¥åˆ›å»ºäº†ä¸¤ä¸ªå¯¹è±¡, ç„¶åç”¨ a,b è¿™ä¸¤ä¸ªå˜é‡åˆ†åˆ«æŒ‡å‘äº†å…¶ä¸­ä¸€ä¸ªå¯¹è±¡, è¿™æ˜¯ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡, å®ƒä»¬çš„é¦–åœ°å€æ˜¯ä¸åŒçš„, å³ a å’Œ b ä¸­å­˜å‚¨çš„æ•°å€¼æ˜¯ä¸ç›¸åŒçš„,
æ‰€ä»¥, è¡¨è¾¾å¼ a==b å°†è¿”å› false, è€Œè¿™ä¸¤ä¸ªå¯¹è±¡ä¸­çš„å†…å®¹æ˜¯ç›¸åŒçš„, æ‰€ä»¥, è¡¨è¾¾å¼ a.equals(b) å°†è¿”å› true.
åœ¨å®é™…å¼€å‘ä¸­, æˆ‘ä»¬ç»å¸¸è¦æ¯”è¾ƒä¼ é€’è¿›è¡Œæ¥çš„å­—ç¬¦ä¸²å†…å®¹æ˜¯å¦ç­‰, ä¾‹å¦‚, String input = â€¦;input.equals(â€œquitâ€), è®¸å¤šäººç¨ä¸æ³¨æ„å°±ä½¿ç”¨ == è¿›è¡Œæ¯”è¾ƒäº†,
è¿™æ˜¯é”™è¯¯çš„, éšä¾¿ä»ç½‘ä¸Šæ‰¾å‡ ä¸ªé¡¹ç›®å®æˆ˜çš„æ•™å­¦è§†é¢‘çœ‹çœ‹, é‡Œé¢å°±æœ‰å¤§é‡è¿™æ ·çš„é”™è¯¯. è®°ä½, å­—ç¬¦ä¸²çš„æ¯”è¾ƒåŸºæœ¬ä¸Šéƒ½æ˜¯ä½¿ç”¨ equals æ–¹æ³•.
å¦‚æœä¸€ä¸ªç±»æ²¡æœ‰è‡ªå·±å®šä¹‰ equals æ–¹æ³•, é‚£ä¹ˆå®ƒå°†ç»§æ‰¿ Object ç±»çš„ equals æ–¹æ³•, Object ç±»çš„ equals æ–¹æ³•çš„å®ç°ä»£ç å¦‚ä¸‹:
boolean equals(Object o){
return this==o;
}
è¿™è¯´æ˜, å¦‚æœä¸€ä¸ªç±»æ²¡æœ‰è‡ªå·±å®šä¹‰ equals æ–¹æ³•, å®ƒé»˜è®¤çš„ equals æ–¹æ³•ï¼ˆä» Object ç±»ç»§æ‰¿çš„ï¼‰å°±æ˜¯ä½¿ç”¨ == æ“ä½œç¬¦, ä¹Ÿæ˜¯åœ¨æ¯”è¾ƒä¸¤ä¸ªå˜é‡æŒ‡å‘çš„å¯¹è±¡æ˜¯å¦æ˜¯åŒä¸€å¯¹è±¡,
è¿™æ—¶å€™ä½¿ç”¨ equals å’Œä½¿ç”¨ == ä¼šå¾—åˆ°åŒæ ·çš„ç»“æœ, å¦‚æœæ¯”è¾ƒçš„æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„å¯¹è±¡åˆ™æ€»è¿”å› false. å¦‚æœä½ ç¼–å†™çš„ç±»å¸Œæœ›èƒ½å¤Ÿæ¯”è¾ƒè¯¥ç±»åˆ›å»ºçš„ä¸¤ä¸ªå®ä¾‹å¯¹è±¡çš„å†…å®¹æ˜¯å¦ç›¸åŒ,
é‚£ä¹ˆä½ å¿…é¡»è¦†ç›– equals æ–¹æ³•, ç”±ä½ è‡ªå·±å†™ä»£ç æ¥å†³å®šåœ¨ä»€ä¹ˆæƒ…å†µå³å¯è®¤ä¸ºä¸¤ä¸ªå¯¹è±¡çš„å†…å®¹æ˜¯ç›¸åŒçš„.

## é™æ€å˜é‡å’Œå®ä¾‹å˜é‡çš„åŒºåˆ«ï¼Ÿ

åœ¨è¯­æ³•å®šä¹‰ä¸Šçš„åŒºåˆ«: é™æ€å˜é‡å‰è¦åŠ  static å…³é”®å­—, è€Œå®ä¾‹å˜é‡å‰åˆ™ä¸åŠ .
åœ¨ç¨‹åºè¿è¡Œæ—¶çš„åŒºåˆ«: å®ä¾‹å˜é‡å±äºæŸä¸ªå¯¹è±¡çš„å±æ€§, å¿…é¡»åˆ›å»ºäº†å®ä¾‹å¯¹è±¡, å…¶ä¸­çš„å®ä¾‹å˜é‡æ‰ä¼šè¢«åˆ†é…ç©ºé—´, æ‰èƒ½ä½¿ç”¨è¿™ä¸ªå®ä¾‹å˜é‡. é™æ€å˜é‡ä¸å±äºæŸä¸ªå®ä¾‹å¯¹è±¡,
è€Œæ˜¯å±äºç±», æ‰€ä»¥ä¹Ÿç§°ä¸ºç±»å˜é‡, åªè¦ç¨‹åºåŠ è½½äº†ç±»çš„å­—èŠ‚ç , ä¸ç”¨åˆ›å»ºä»»ä½•å®ä¾‹å¯¹è±¡, é™æ€å˜é‡å°±ä¼šè¢«åˆ†é…ç©ºé—´, é™æ€å˜é‡å°±å¯ä»¥è¢«ä½¿ç”¨äº†. æ€»ä¹‹,
å®ä¾‹å˜é‡å¿…é¡»åˆ›å»ºå¯¹è±¡åæ‰å¯ä»¥é€šè¿‡è¿™ä¸ªå¯¹è±¡æ¥ä½¿ç”¨, é™æ€å˜é‡åˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨ç±»åæ¥å¼•ç”¨.
ä¾‹å¦‚, å¯¹äºä¸‹é¢çš„ç¨‹åº, æ— è®ºåˆ›å»ºå¤šå°‘ä¸ªå®ä¾‹å¯¹è±¡, æ°¸è¿œéƒ½åªåˆ†é…äº†ä¸€ä¸ª staticVar å˜é‡, å¹¶ä¸”æ¯åˆ›å»ºä¸€ä¸ªå®ä¾‹å¯¹è±¡, è¿™ä¸ª staticVar å°±ä¼šåŠ  1ï¼›ä½†æ˜¯,
æ¯åˆ›å»ºä¸€ä¸ªå®ä¾‹å¯¹è±¡, å°±ä¼šåˆ†é…ä¸€ä¸ª instanceVar, å³å¯èƒ½åˆ†é…å¤šä¸ª instanceVar, å¹¶ä¸”æ¯ä¸ª instanceVar çš„å€¼éƒ½åªè‡ªåŠ äº† 1 æ¬¡.

```java
public class VariantTest{
		public static int staticVar = 0;
		public int instanceVar = 0;
		public VariantTest(){
			staticVar++;
			instanceVar++;
			System.out.println(â€œstaticVar=â€ + staticVar + â€,instanceVar=â€ + instanceVar);
		}
}
```

## æ˜¯å¦å¯ä»¥ä»ä¸€ä¸ª static æ–¹æ³•å†…éƒ¨å‘å‡ºå¯¹é static æ–¹æ³•çš„è°ƒç”¨ï¼Ÿ

ä¸å¯ä»¥. å› ä¸ºé static æ–¹æ³•æ˜¯è¦ä¸å¯¹è±¡å…³è”åœ¨ä¸€èµ·çš„, å¿…é¡»åˆ›å»ºä¸€ä¸ªå¯¹è±¡å, æ‰å¯ä»¥åœ¨è¯¥å¯¹è±¡ä¸Šè¿›è¡Œæ–¹æ³•è°ƒç”¨, è€Œ static æ–¹æ³•è°ƒç”¨æ—¶ä¸éœ€è¦åˆ›å»ºå¯¹è±¡,
å¯ä»¥ç›´æ¥è°ƒç”¨. ä¹Ÿå°±æ˜¯è¯´, å½“ä¸€ä¸ª static æ–¹æ³•è¢«è°ƒç”¨æ—¶, å¯èƒ½è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•å®ä¾‹å¯¹è±¡, å¦‚æœä»ä¸€ä¸ª static æ–¹æ³•ä¸­å‘å‡ºå¯¹é static æ–¹æ³•çš„è°ƒç”¨, é‚£ä¸ªé
static æ–¹æ³•æ˜¯å…³è”åˆ°å“ªä¸ªå¯¹è±¡ä¸Šçš„å‘¢ï¼Ÿè¿™ä¸ªé€»è¾‘æ— æ³•æˆç«‹, æ‰€ä»¥, ä¸€ä¸ª static æ–¹æ³•å†…éƒ¨å‘å‡ºå¯¹é static æ–¹æ³•çš„è°ƒç”¨.

## Math.round(11.5) ç­‰æ–¼å¤šå°‘? Math.round(-11.5) ç­‰æ–¼å¤šå°‘?

Math ç±»ä¸­æä¾›äº†ä¸‰ä¸ªä¸å–æ•´æœ‰å…³çš„æ–¹æ³•: ceilã€floorã€round, è¿™äº›æ–¹æ³•çš„ä½œç”¨ä¸å®ƒä»¬çš„è‹±æ–‡åç§°çš„å«ä¹‰ç›¸å¯¹åº”, ä¾‹å¦‚, ceil çš„è‹±æ–‡æ„ä¹‰æ˜¯å¤©èŠ±æ¿,
è¯¥æ–¹æ³•å°±è¡¨ç¤ºå‘ä¸Šå–æ•´, æ‰€ä»¥, Math.ceil(11.3) çš„ç»“æœä¸º 12,Math.ceil(-11.3) çš„ç»“æœæ˜¯ -11ï¼›floor çš„è‹±æ–‡æ„ä¹‰æ˜¯åœ°æ¿, è¯¥æ–¹æ³•å°±è¡¨ç¤ºå‘ä¸‹å–æ•´, æ‰€ä»¥,
Math.floor(11.6) çš„ç»“æœä¸º 11,Math.floor(-11.6) çš„ç»“æœæ˜¯ -12ï¼›æœ€éš¾æŒæ¡çš„æ˜¯ round æ–¹æ³•, å®ƒè¡¨ç¤ºâ€œå››èˆäº”å…¥â€, ç®—æ³•ä¸º Math.floor(x+0.5), å³å°†åŸæ¥çš„æ•°å­—åŠ ä¸Š
0.5 åå†å‘ä¸‹å–æ•´, æ‰€ä»¥, Math.round(11.5) çš„ç»“æœä¸º 12, Math.round(-11.5) çš„ç»“æœä¸º -11.

## ç±»çš„åŠ è½½æœºåˆ¶

ç±»åˆå§‹åŒ–æ—¶æœº: åªæœ‰å½“å¯¹ç±»çš„ä¸»åŠ¨ä½¿ç”¨çš„æ—¶å€™æ‰ä¼šå¯¼è‡´ç±»çš„åˆå§‹åŒ–, ç±»çš„ä¸»åŠ¨ä½¿ç”¨åŒ…æ‹¬ä»¥ä¸‹å…­ç§:

- åˆ›å»ºç±»çš„å®ä¾‹, ä¹Ÿå°±æ˜¯ new çš„æ–¹å¼
- è®¿é—®æŸä¸ªç±»æˆ–æ¥å£çš„é™æ€å˜é‡, æˆ–è€…å¯¹è¯¥é™æ€å˜é‡èµ‹å€¼
- è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•
- åå°„ï¼ˆå¦‚ Class.forName(â€œcom.shengsiyuan.Testâ€)ï¼‰
- åˆå§‹åŒ–æŸä¸ªç±»çš„å­ç±», åˆ™å…¶çˆ¶ç±»ä¹Ÿä¼šè¢«åˆå§‹åŒ–
- Java è™šæ‹Ÿæœºå¯åŠ¨æ—¶è¢«æ ‡æ˜ä¸ºå¯åŠ¨ç±»çš„ç±»ï¼ˆJava Testï¼‰, ç›´æ¥ä½¿ç”¨ java.exe å‘½ä»¤æ¥è¿è¡ŒæŸä¸ªä¸»ç±»

åœ¨å¦‚ä¸‹å‡ ç§æƒ…å†µä¸‹, Java è™šæ‹Ÿæœºå°†ç»“æŸç”Ÿå‘½å‘¨æœŸ

- æ‰§è¡Œäº† System.exit() æ–¹æ³•
- ç¨‹åºæ­£å¸¸æ‰§è¡Œç»“æŸ
- ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°äº†å¼‚å¸¸æˆ–é”™è¯¯è€Œå¼‚å¸¸ç»ˆæ­¢
- ç”±äºæ“ä½œç³»ç»Ÿå‡ºç°é”™è¯¯è€Œå¯¼è‡´ Java è™šæ‹Ÿæœºè¿›ç¨‹ç»ˆæ­¢

**å¯åŠ¨ç±»åŠ è½½å™¨**
Bootstrap ClassLoader, è´Ÿè´£åŠ è½½å­˜æ”¾åœ¨ `JDK\jre\lib`(JDK ä»£è¡¨ JDK çš„å®‰è£…ç›®å½•, ä¸‹åŒ) ä¸‹, æˆ–è¢« -Xbootclasspath å‚æ•°æŒ‡å®šçš„è·¯å¾„ä¸­çš„, å¹¶ä¸”èƒ½è¢«è™šæ‹Ÿæœºè¯†åˆ«çš„ç±»åº“ï¼ˆå¦‚
rt.jar, æ‰€æœ‰çš„ `java.*` å¼€å¤´çš„ç±»å‡è¢« Bootstrap ClassLoader åŠ è½½ï¼‰. å¯åŠ¨ç±»åŠ è½½å™¨æ˜¯æ— æ³•è¢« Java ç¨‹åºç›´æ¥å¼•ç”¨çš„.

**æ‰©å±•ç±»åŠ è½½å™¨**
Extension ClassLoader, è¯¥åŠ è½½å™¨ç”± sun.misc.Launcher$ExtClassLoader å®ç°, å®ƒè´Ÿè´£åŠ è½½ `JDK\jre\lib\ext` ç›®å½•ä¸­, æˆ–è€…ç”± java.ext.dirs
ç³»ç»Ÿå˜é‡æŒ‡å®šçš„è·¯å¾„ä¸­çš„æ‰€æœ‰ç±»åº“ï¼ˆå¦‚ `javax.*` å¼€å¤´çš„ç±»ï¼‰, å¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨æ‰©å±•ç±»åŠ è½½å™¨.

**åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨**
Application ClassLoader, è¯¥ç±»åŠ è½½å™¨ç”± sun.misc.Launcher$AppClassLoader æ¥å®ç°, å®ƒè´Ÿè´£åŠ è½½ç”¨æˆ·ç±»è·¯å¾„ï¼ˆClassPathï¼‰æ‰€æŒ‡å®šçš„ç±», å¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥ç±»åŠ è½½å™¨,
å¦‚æœåº”ç”¨ç¨‹åºä¸­æ²¡æœ‰è‡ªå®šä¹‰è¿‡è‡ªå·±çš„ç±»åŠ è½½å™¨, ä¸€èˆ¬æƒ…å†µä¸‹è¿™ä¸ªå°±æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨.

### åŒäº²å§”æ´¾æ¨¡å‹

åŒäº²å§”æ´¾æ¨¡å‹çš„å·¥ä½œæµç¨‹æ˜¯: å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½çš„è¯·æ±‚, å®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±», è€Œæ˜¯æŠŠè¯·æ±‚å§”æ‰˜ç»™çˆ¶åŠ è½½å™¨å»å®Œæˆ, ä¾æ¬¡å‘ä¸Š, å› æ­¤,
æ‰€æœ‰çš„ç±»åŠ è½½è¯·æ±‚æœ€ç»ˆéƒ½åº”è¯¥è¢«ä¼ é€’åˆ°é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ä¸­, åªæœ‰å½“çˆ¶åŠ è½½å™¨åœ¨å®ƒçš„æœç´¢èŒƒå›´ä¸­æ²¡æœ‰æ‰¾åˆ°æ‰€éœ€çš„ç±»æ—¶, å³æ— æ³•å®Œæˆè¯¥åŠ è½½, å­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½è¯¥ç±».

**åŒäº²å§”æ´¾æœºåˆ¶**

1. å½“ AppClassLoader åŠ è½½ä¸€ä¸ª class æ—¶, å®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±», è€Œæ˜¯æŠŠç±»åŠ è½½è¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨ ExtClassLoader å»å®Œæˆ.
2. å½“ ExtClassLoader åŠ è½½ä¸€ä¸ª class æ—¶, å®ƒé¦–å…ˆä¹Ÿä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±», è€Œæ˜¯æŠŠç±»åŠ è½½è¯·æ±‚å§”æ´¾ç»™ BootStrapClassLoader å»å®Œæˆ.
3. å¦‚æœ BootStrapClassLoader åŠ è½½å¤±è´¥ï¼ˆä¾‹å¦‚åœ¨ $JAVA_HOME/jre/lib é‡ŒæœªæŸ¥æ‰¾åˆ°è¯¥ classï¼‰, ä¼šä½¿ç”¨ ExtClassLoader æ¥å°è¯•åŠ è½½ï¼›
4. è‹¥ ExtClassLoader ä¹ŸåŠ è½½å¤±è´¥, åˆ™ä¼šä½¿ç”¨ AppClassLoader æ¥åŠ è½½, å¦‚æœ AppClassLoader ä¹ŸåŠ è½½å¤±è´¥, åˆ™ä¼šæŠ¥å‡ºå¼‚å¸¸ ClassNotFoundException.

```java
public Class<?> loadClass(String name)throws ClassNotFoundException {
            return loadClass(name, false);
    }
    protected synchronized Class<?> loadClass(String name, boolean resolve)throws ClassNotFoundException {
            // é¦–å…ˆåˆ¤æ–­è¯¥ç±»å‹æ˜¯å¦å·²ç»è¢«åŠ è½½
            Class c = findLoadedClass(name);
            if (c == null) {
                // å¦‚æœæ²¡æœ‰è¢«åŠ è½½, å°±å§”æ‰˜ç»™çˆ¶ç±»åŠ è½½æˆ–è€…å§”æ´¾ç»™å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½
                try {
                    if (parent != null) {
                         // å¦‚æœå­˜åœ¨çˆ¶ç±»åŠ è½½å™¨, å°±å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨åŠ è½½
                        c = parent.loadClass(name, false);
                    } else {
                    // å¦‚æœä¸å­˜åœ¨çˆ¶ç±»åŠ è½½å™¨, å°±æ£€æŸ¥æ˜¯å¦æ˜¯ç”±å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½çš„ç±», é€šè¿‡è°ƒç”¨æœ¬åœ°æ–¹æ³• native Class findBootstrapClass(String name)
                        c = findBootstrapClass0(name);
                    }
                } catch (ClassNotFoundException e) {
                 // å¦‚æœçˆ¶ç±»åŠ è½½å™¨å’Œå¯åŠ¨ç±»åŠ è½½å™¨éƒ½ä¸èƒ½å®ŒæˆåŠ è½½ä»»åŠ¡, æ‰è°ƒç”¨è‡ªèº«çš„åŠ è½½åŠŸèƒ½
                    c = findClass(name);
                }
            }
            if (resolve) {
                resolveClass(c);
            }
            return c;
        }
```

**åŒäº²å§”æ´¾æ¨¡å‹æ„ä¹‰**

- ç³»ç»Ÿç±»é˜²æ­¢å†…å­˜ä¸­å‡ºç°å¤šä»½åŒæ ·çš„å­—èŠ‚ç 
- ä¿è¯ Java ç¨‹åºå®‰å…¨ç¨³å®šè¿è¡Œ

**è‡ªå®šä¹‰åŠ è½½å™¨**

```java
package com.neo.classloader;
import java.io.*;

public class MyClassLoader extends ClassLoader {
    private String root;
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        byte[] classData = loadClassData(name);
        if (classData == null) {
            throw new ClassNotFoundException();
        } else {
            return defineClass(name, classData, 0, classData.length);
        }
    }

    private byte[] loadClassData(String className) {
        String fileName = root + File.separatorChar
                + className.replace('.', File.separatorChar) + ".class";
        try {
            InputStream ins = new FileInputStream(fileName);
            ByteArrayOutputStream baos = new ByteArrayOutputStream();
            int bufferSize = 1024;
            byte[] buffer = new byte[bufferSize];
            int length = 0;
            while ((length = ins.read(buffer)) != -1) {
                baos.write(buffer, 0, length);
            }
            return baos.toByteArray();
        } catch (IOException e) {
            e.printStackTrace();
        }
        return null;
    }
    public String getRoot() {
        return root;
    }
    public void setRoot(String root) {
        this.root = root;
    }
    public static void main(String[] args)  {
        MyClassLoader classLoader = new MyClassLoader();
        classLoader.setRoot("E:\\temp");
        Class<?> testClass = null;
        try {
            testClass = classLoader.loadClass("com.neo.classloader.Test2");
            Object object = testClass.newInstance();
            System.out.println(object.getClass().getClassLoader());
        } catch (ClassNotFoundException e) {
            e.printStackTrace();
        } catch (InstantiationException e) {
            e.printStackTrace();
        } catch (IllegalAccessException e) {
            e.printStackTrace();
        }
    }
}
```

## è¿›ç¨‹é—´çš„é€šä¿¡

1. ç®¡é“ (pipe)
2. æœ‰åç®¡é“ (namedpipe)
3. ä¿¡å·é‡ (semophore)
4. æ¶ˆæ¯é˜Ÿåˆ— (messagequeue)
5. ä¿¡å· (sinal)
6. å…±äº«å†…å­˜ (shared memory)
7. å¥—æ¥å­— (socket)

## çº¿ç¨‹é—´çš„é€šä¿¡

1. é”æœºåˆ¶: åŒ…æ‹¬äº’æ–¥é”ã€æ¡ä»¶å˜é‡ã€è¯»å†™é”
   - äº’æ–¥é”æä¾›äº†ä»¥æ’ä»–æ–¹å¼é˜²æ­¢æ•°æ®ç»“æ„è¢«å¹¶å‘ä¿®æ”¹çš„æ–¹æ³•.
   - è¯»å†™é”å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å…±äº«æ•°æ®, è€Œå¯¹å†™æ“ä½œæ˜¯äº’æ–¥çš„.
   - æ¡ä»¶å˜é‡å¯ä»¥ä»¥åŸå­çš„æ–¹å¼é˜»å¡è¿›ç¨‹, ç›´åˆ°æŸä¸ªç‰¹å®šæ¡ä»¶ä¸ºçœŸä¸ºæ­¢. å¯¹æ¡ä»¶çš„æµ‹è¯•æ˜¯åœ¨äº’æ–¥é”çš„ä¿æŠ¤ä¸‹è¿›è¡Œçš„. æ¡ä»¶å˜é‡å§‹ç»ˆä¸äº’æ–¥é”ä¸€èµ·ä½¿ç”¨.
2. ä¿¡å·é‡æœºåˆ¶ (Semaphore): åŒ…æ‹¬æ— åçº¿ç¨‹ä¿¡å·é‡å’Œå‘½åçº¿ç¨‹ä¿¡å·é‡
3. ä¿¡å·æœºåˆ¶ (Signal): ç±»ä¼¼è¿›ç¨‹é—´çš„ä¿¡å·å¤„ç†
   çº¿ç¨‹é—´çš„é€šä¿¡ç›®çš„ä¸»è¦æ˜¯ç”¨äºçº¿ç¨‹åŒæ­¥, æ‰€ä»¥çº¿ç¨‹æ²¡æœ‰åƒè¿›ç¨‹é€šä¿¡ä¸­çš„ç”¨äºæ•°æ®äº¤æ¢çš„é€šä¿¡æœºåˆ¶.

## å†™ clone() æ–¹æ³•æ—¶, é€šå¸¸éƒ½æœ‰ä¸€è¡Œä»£ç , æ˜¯ä»€ä¹ˆï¼Ÿ

clone æœ‰ç¼ºçœè¡Œä¸º, `super.clone();` å› ä¸ºé¦–å…ˆè¦æŠŠçˆ¶ç±»ä¸­çš„æˆå‘˜å¤åˆ¶åˆ°ä½, ç„¶åæ‰æ˜¯å¤åˆ¶è‡ªå·±çš„æˆå‘˜

## éé™æ€å†…éƒ¨ç±»åˆå§‹åŒ–æ–¹å¼

Outer outer = new Outer();
outer.inner inner = outer.new Inner();

## é™æ€å†…éƒ¨ç±»åˆå§‹åŒ–æ–¹å¼

Outer.Inner inner = new Outer.Inner();

## Stringã€StringBuffer ä¸ StringBuilder ä¹‹é—´åŒºåˆ«

- StringBuilder > StringBuffer > String
- StringBuilder: çº¿ç¨‹éå®‰å…¨çš„
- StringBuffer: çº¿ç¨‹å®‰å…¨çš„
- String è¦†ç›–äº† equals æ–¹æ³•å’Œ hashCode æ–¹æ³•, è€Œ StringBuffer,StringBuilder æ²¡æœ‰è¦†ç›– equals æ–¹æ³•å’Œ hashCode æ–¹æ³•, æ‰€ä»¥, å°†
  StringBuffer,StringBuilder å¯¹è±¡å­˜å‚¨è¿› Java é›†åˆç±»ä¸­æ—¶ä¼šå‡ºç°é—®é¢˜.

## length å’Œ length()å’Œ size()

æ•°ç»„æ˜¯ length å±æ€§
å­—ç¬¦ä¸²æ˜¯ length() æ–¹æ³•
é›†åˆæ˜¯ size() æ–¹æ³•

## String s="a"+"b"+"c"+"d";

```java
String s1 = "a";
String s2 = s1 + "b";
String s3 = "a" + "b";
System.out.println(s2 == "ab"); // false
System.out.println(s3 == "ab"); // true
String s = "a" + "b" + "c" + "d";
// javac ç¼–è¯‘å¯ä»¥å¯¹å­—ç¬¦ä¸²å¸¸é‡ç›´æ¥ç›¸åŠ çš„è¡¨è¾¾å¼è¿›è¡Œä¼˜åŒ–, ä¸å¿…è¦ç­‰åˆ°è¿è¡ŒæœŸå»è¿›è¡ŒåŠ æ³•è¿ç®—å¤„ç†,
// è€Œæ˜¯åœ¨ç¼–è¯‘æ—¶å»æ‰å…¶ä¸­çš„åŠ å·, ç›´æ¥å°†å…¶ç¼–è¯‘æˆä¸€ä¸ªè¿™äº›å¸¸é‡ç›¸è¿çš„ç»“æœ.
System.out.println(s == "abcd"); // true
```

## final, finally, finalize çš„åŒºåˆ«.

[finalã€finally å’Œ finalize çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ](mweblib://14837192590620)

### final

- final å…³é”®å­—å¯ä»¥ç”¨äºæˆå‘˜å˜é‡ã€æœ¬åœ°å˜é‡ã€æ–¹æ³•ä»¥åŠç±».
- final æˆå‘˜å˜é‡å¿…é¡»åœ¨å£°æ˜çš„æ—¶å€™åˆå§‹åŒ–æˆ–è€…åœ¨æ„é€ å™¨ä¸­åˆå§‹åŒ–, å¦åˆ™å°±ä¼šæŠ¥ç¼–è¯‘é”™è¯¯.
- ä½ ä¸èƒ½å¤Ÿå¯¹ final å˜é‡å†æ¬¡èµ‹å€¼.
- æœ¬åœ°å˜é‡å¿…é¡»åœ¨å£°æ˜æ—¶èµ‹å€¼.
- åœ¨åŒ¿åç±»ä¸­æ‰€æœ‰å˜é‡éƒ½å¿…é¡»æ˜¯ final å˜é‡.
- final æ–¹æ³•ä¸èƒ½è¢«é‡å†™.
- final ç±»ä¸èƒ½è¢«ç»§æ‰¿.
- final å…³é”®å­—ä¸åŒäº finally å…³é”®å­—, åè€…ç”¨äºå¼‚å¸¸å¤„ç†.
- final å…³é”®å­—å®¹æ˜“ä¸ finalize() æ–¹æ³•ææ··, åè€…æ˜¯åœ¨ Object ç±»ä¸­å®šä¹‰çš„æ–¹æ³•, æ˜¯åœ¨åƒåœ¾å›æ”¶ä¹‹å‰è¢« JVM è°ƒç”¨çš„æ–¹æ³•.
- æ¥å£ä¸­å£°æ˜çš„æ‰€æœ‰å˜é‡æœ¬èº«æ˜¯ final çš„.
- final å’Œ abstract è¿™ä¸¤ä¸ªå…³é”®å­—æ˜¯åç›¸å…³çš„, final ç±»å°±ä¸å¯èƒ½æ˜¯ abstract çš„.
- final æ–¹æ³•åœ¨ç¼–è¯‘é˜¶æ®µç»‘å®š, ç§°ä¸ºé™æ€ç»‘å®š (static binding).
- æ²¡æœ‰åœ¨å£°æ˜æ—¶åˆå§‹åŒ– final å˜é‡çš„ç§°ä¸ºç©ºç™½ final å˜é‡ (blank final variable), å®ƒä»¬å¿…é¡»åœ¨æ„é€ å™¨ä¸­åˆå§‹åŒ–, æˆ–è€…è°ƒç”¨ this() åˆå§‹åŒ–. ä¸è¿™ä¹ˆåšçš„è¯,
  ç¼–è¯‘å™¨ä¼šæŠ¥é”™â€œfinal å˜é‡ (å˜é‡å) éœ€è¦è¿›è¡Œåˆå§‹åŒ–â€.
- å°†ç±»ã€æ–¹æ³•ã€å˜é‡å£°æ˜ä¸º final èƒ½å¤Ÿæé«˜æ€§èƒ½, è¿™æ · JVM å°±æœ‰æœºä¼šè¿›è¡Œä¼°è®¡, ç„¶åä¼˜åŒ–.
- final ä¿®é¥°çš„å¼•ç”¨å˜é‡çš„æŒ‡é’ˆä¸å¯å˜, ä½†æ˜¯å¼•ç”¨å¯¹è±¡ä¸­çš„å€¼æ˜¯å¯ä»¥æ”¹å˜çš„

å†…å­˜å±éšœé—®é¢˜

### finally

finally æ˜¯å¼‚å¸¸å¤„ç†è¯­å¥ç»“æ„çš„ä¸€éƒ¨åˆ†, è¡¨ç¤ºæ€»æ˜¯æ‰§è¡Œ.  
**return çš„å…ˆåé—®é¢˜**

```java
public class Test {
    public static void main(String[] args) {
        System.out.println(test());
    }
    private static int test() {
        int x = 1;
        try {
            return x;
        } finally {
            ++x;
        }
    }
}
```

è¿”å› 1
åœ¨æ‰§è¡Œåˆ° return x æ—¶, å·²ç»å°†å€¼è¿”å›, æ”¾å…¥åˆ°å†…å­˜æ ˆä¸­, finally åªæ˜¯æ‰§è¡Œäº† +1 æ“ä½œ, å¹¶æ²¡æœ‰æ”¹å˜å†…å­˜æ ˆä¸­çš„å€¼

```java
public class Test {
    public static void main(String[] args) {
        System.out.println(test());
    }
    private static int test() {
        int x = 1;
        try {
            return x;
        } finally {
            return ++x;
        }
    }
}
```

è¿”å› 2
finally ä¿å­˜ç¨‹åºä¼šæ‰§è¡Œ, ç¬¬ä¸€ä¸ª return è¿”å›å€¼, æ”¾å…¥å†…å­˜æ ˆä¸­, ç„¶å finally å†æ¬¡è¿”å›å€¼, è¦†ç›–åŸæ¥çš„å€¼

```java
public class Test1 {
    public static void main(String[] args) {
        // TODO Auto-generated method stub
        System.out.println(test());
    }

    private static int test() {
        try {
            return func1();
        } finally {
            return func2();
        }
    }

    private static int func1() {
        System.out.println("func1");
        return 1;
    }

    private static int func2() {
        System.out.println("func2");
        return 2;
    }
}
```

è¿”å›ç»“æœ

```
func1
func2
2
```

### finalize

finalize() æ˜¯ Object ç±»çš„ä¸€ä¸ªæ–¹æ³•, åœ¨åƒåœ¾æ”¶é›†å™¨æ‰§è¡Œçš„æ—¶å€™ä¼šè°ƒç”¨è¢«å›æ”¶å¯¹è±¡çš„æ­¤æ–¹æ³•, å¯ä»¥è¦†ç›–æ­¤æ–¹æ³•æä¾›åƒåœ¾æ”¶é›†æ—¶çš„å…¶ä»–èµ„æºå›æ”¶, ä¾‹å¦‚å…³é—­æ–‡ä»¶ç­‰.
JVM ä¸ä¿è¯æ­¤æ–¹æ³•æ€»è¢«è°ƒç”¨
å¹¶ä¸” finalize() åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡, æ‰€ä»¥å¯¹è±¡æœ‰å¯èƒ½è¢«å¤æ´»ä¸€æ¬¡

```java
public class CanReliveObj {
    private static CanReliveObj obj;

    @Override
    protected void finalize() throws Throwable {
        super.finalize();
        System.out.println("CanReliveObj finalize called");
        obj = this;
    }

    @Override
    public String toString() {
        return "I am CanReliveObj";
    }

    public static void main(String[] args) throws InterruptedException {
        obj = new CanReliveObj();
        obj = null; // å¯å¤æ´»
        System.gc();
        Thread.sleep(1000);
        if (obj == null) {
            System.out.println("obj æ˜¯ null");
        } else {
            System.out.println("obj å¯ç”¨");
        }
        System.out.println("ç¬¬äºŒæ¬¡gc");
        obj = null; // ä¸å¯å¤æ´»
        System.gc();
        Thread.sleep(1000);
        if (obj == null) {
            System.out.println("obj æ˜¯ null");
        } else {
            System.out.println("obj å¯ç”¨");
        }
    }
}
```

è¿”å›ç»“æœ

```
CanReliveObj finalize called
obj å¯ç”¨
ç¬¬äºŒæ¬¡ gc
obj æ˜¯ null
```

## stop()å’Œ suspend() æ–¹æ³•ä¸ºä½•ä¸æ¨èä½¿ç”¨ï¼Ÿ

åå¯¹ä½¿ç”¨ stop(), æ˜¯å› ä¸ºå®ƒä¸å®‰å…¨.

> å®ƒä¼šè§£é™¤ç”±çº¿ç¨‹è·å–çš„æ‰€æœ‰é”å®š, è€Œä¸”å¦‚æœå¯¹è±¡å¤„äºä¸€ç§ä¸è¿è´¯çŠ¶æ€, é‚£ä¹ˆå…¶ä»–çº¿ç¨‹èƒ½åœ¨é‚£ç§çŠ¶æ€ä¸‹æ£€æŸ¥å’Œä¿®æ”¹å®ƒä»¬. ç»“æœå¾ˆéš¾æ£€æŸ¥å‡ºçœŸæ­£çš„é—®é¢˜æ‰€åœ¨.

suspend() æ–¹æ³•å®¹æ˜“å‘ç”Ÿæ­»é”.

> è°ƒç”¨ suspend() çš„æ—¶å€™, ç›®æ ‡çº¿ç¨‹ä¼šåœä¸‹æ¥, ä½†å´ä»ç„¶æŒæœ‰åœ¨è¿™ä¹‹å‰è·å¾—çš„é”å®š.
> æ­¤æ—¶, å…¶ä»–ä»»ä½•çº¿ç¨‹éƒ½ä¸èƒ½è®¿é—®é”å®šçš„èµ„æº, é™¤éè¢«"æŒ‚èµ·"çš„çº¿ç¨‹æ¢å¤è¿è¡Œ.
> å¯¹ä»»ä½•çº¿ç¨‹æ¥è¯´, å¦‚æœå®ƒä»¬æƒ³æ¢å¤ç›®æ ‡çº¿ç¨‹, åŒæ—¶åˆè¯•å›¾ä½¿ç”¨ä»»ä½•ä¸€ä¸ªé”å®šçš„èµ„æº, å°±ä¼šé€ æˆæ­»é”. æ‰€ä»¥ä¸åº”è¯¥ä½¿ç”¨ suspend(), è€Œåº”åœ¨è‡ªå·±çš„ Thread
> ç±»ä¸­ç½®å…¥ä¸€ä¸ªæ ‡å¿—, æŒ‡å‡ºçº¿ç¨‹åº”è¯¥æ´»åŠ¨è¿˜æ˜¯æŒ‚èµ·. è‹¥æ ‡å¿—æŒ‡å‡ºçº¿ç¨‹åº”è¯¥æŒ‚èµ·, ä¾¿ç”¨ wait()å‘½å…¶è¿›å…¥ç­‰å¾…çŠ¶æ€. è‹¥æ ‡å¿—æŒ‡å‡ºçº¿ç¨‹åº”å½“æ¢å¤, åˆ™ç”¨ä¸€ä¸ª notify()
> é‡æ–°å¯åŠ¨çº¿ç¨‹.

## sleep()å’Œ wait() æœ‰ä»€ä¹ˆåŒºåˆ«?

sleep å°±æ˜¯æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ä¸»åŠ¨è®©å‡º cpu, cpu å»æ‰§è¡Œå…¶ä»–çº¿ç¨‹, åœ¨ sleep æŒ‡å®šçš„æ—¶é—´è¿‡å, cpu æ‰ä¼šå›åˆ°è¿™ä¸ªçº¿ç¨‹ä¸Šç»§ç»­å¾€ä¸‹æ‰§è¡Œ, å¦‚æœå½“å‰çº¿ç¨‹è¿›å…¥äº†åŒæ­¥é”,
sleep æ–¹æ³•å¹¶ä¸ä¼šé‡Šæ”¾é”, å³ä½¿å½“å‰çº¿ç¨‹ä½¿ç”¨ sleep æ–¹æ³•è®©å‡ºäº† cpu, ä½†å…¶ä»–è¢«åŒæ­¥é”æŒ¡ä½äº†çš„çº¿ç¨‹ä¹Ÿæ— æ³•å¾—åˆ°æ‰§è¡Œ. wait æ˜¯æŒ‡åœ¨ä¸€ä¸ªå·²ç»è¿›å…¥äº†åŒæ­¥é”çš„çº¿ç¨‹å†…,
è®©è‡ªå·±æš‚æ—¶è®©å‡ºåŒæ­¥é”, ä»¥ä¾¿å…¶ä»–æ­£åœ¨ç­‰å¾…æ­¤é”çš„çº¿ç¨‹å¯ä»¥å¾—åˆ°åŒæ­¥é”å¹¶è¿è¡Œ, åªæœ‰å…¶ä»–çº¿ç¨‹è°ƒç”¨äº† notify æ–¹æ³•ï¼ˆnotify å¹¶ä¸é‡Šæ”¾é”, åªæ˜¯å‘Šè¯‰è°ƒç”¨è¿‡ wait
æ–¹æ³•çš„çº¿ç¨‹å¯ä»¥å»å‚ä¸è·å¾—é”çš„ç«äº‰äº†, ä½†ä¸æ˜¯é©¬ä¸Šå¾—åˆ°é”, å› ä¸ºé”è¿˜åœ¨åˆ«äººæ‰‹é‡Œ, åˆ«äººè¿˜æ²¡é‡Šæ”¾. å¦‚æœ notify æ–¹æ³•åé¢çš„ä»£ç è¿˜æœ‰å¾ˆå¤š, éœ€è¦è¿™äº›ä»£ç æ‰§è¡Œå®Œåæ‰ä¼šé‡Šæ”¾é”,
å¯ä»¥åœ¨ notfiy æ–¹æ³•åå¢åŠ ä¸€ä¸ªç­‰å¾…å’Œä¸€äº›ä»£ç , çœ‹çœ‹æ•ˆæœï¼‰, è°ƒç”¨ wait æ–¹æ³•çš„çº¿ç¨‹å°±ä¼šè§£é™¤ wait çŠ¶æ€å’Œç¨‹åºå¯ä»¥å†æ¬¡å¾—åˆ°é”åç»§ç»­å‘ä¸‹è¿è¡Œ

```java
public class MultiThread {
    public static void main(String[] args) {
        new Thread(new Thread1()).start();
        try {
            Thread.sleep(10);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        new Thread(new Thread2()).start();
    }

    private static class Thread1 implements Runnable {
        @Override
        public void run() {
            // ç”±äºè¿™é‡Œçš„ Thread1 å’Œä¸‹é¢çš„ Thread2 å†…éƒ¨ run æ–¹æ³•è¦ç”¨åŒä¸€å¯¹è±¡ä½œä¸ºç›‘è§†å™¨,
            // æˆ‘ä»¬è¿™é‡Œä¸èƒ½ç”¨ this, å› ä¸ºåœ¨ Thread2 é‡Œé¢çš„ this å’Œè¿™ä¸ª Thread1 çš„ this ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡. æˆ‘ä»¬ç”¨ MultiThread.class è¿™ä¸ªå­—èŠ‚ç å¯¹è±¡,
            // å½“å‰è™šæ‹Ÿæœºé‡Œå¼•ç”¨è¿™ä¸ªå˜é‡æ—¶, æŒ‡å‘çš„éƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡.
            synchronized (MultiThread.class) {
                System.out.println("enter thread1...");
                System.out.println("thread1 is waiting");
                try {
                    // é‡Šæ”¾é”æœ‰ä¸¤ç§æ–¹å¼, ç¬¬ä¸€ç§æ–¹å¼æ˜¯ç¨‹åºè‡ªç„¶ç¦»å¼€ç›‘è§†å™¨çš„èŒƒå›´, ä¹Ÿå°±æ˜¯ç¦»å¼€äº† synchronized å…³é”®å­—ç®¡è¾–çš„ä»£ç èŒƒå›´,
                    // å¦ä¸€ç§æ–¹å¼å°±æ˜¯åœ¨ synchronized å…³é”®å­—ç®¡è¾–çš„ä»£ç å†…éƒ¨è°ƒç”¨ç›‘è§†å™¨å¯¹è±¡çš„ wait æ–¹æ³•. è¿™é‡Œ, ä½¿ç”¨ wait æ–¹æ³•é‡Šæ”¾é”.
                    MultiThread.class.wait();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println("thread1 is going on...");
                System.out.println("thread1 is being over!");
            }
        }

    }

    private static class Thread2 implements Runnable {
        @Override
        public void run() {
            synchronized (MultiThread.class) {
                System.out.println("enter thread2...");
                System.out.println("thread2 notify other thread can release wait status..");
                // ç”±äº notify æ–¹æ³•å¹¶ä¸é‡Šæ”¾é”,  å³ä½¿ thread2 è°ƒç”¨ä¸‹é¢çš„ sleep æ–¹æ³•ä¼‘æ¯äº† 10 æ¯«ç§’,
                // ä½† thread1 ä»ç„¶ä¸ä¼šæ‰§è¡Œ, å› ä¸º thread2 æ²¡æœ‰é‡Šæ”¾é”, æ‰€ä»¥ Thread1 æ— æ³•å¾—ä¸åˆ°é”.
                MultiThread.class.notify();
                System.out.println("thread2 is sleeping ten millisecond...");
                try {
                    Thread.sleep(10);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println("thread2 is going on...");
                System.out.println("thread2 is being over!");
            }
        }
    }
}
```

## å¤šçº¿ç¨‹æœ‰å‡ ç§å®ç°æ–¹æ³•? åŒæ­¥æœ‰å‡ ç§å®ç°æ–¹æ³•?

å¤šçº¿ç¨‹æœ‰ä¸¤ç§å®ç°æ–¹æ³•, åˆ†åˆ«æ˜¯ç»§æ‰¿ Thread ç±»ä¸å®ç° Runnable æ¥å£
åŒæ­¥çš„å®ç°æ–¹é¢æœ‰ä¸¤ç§, åˆ†åˆ«æ˜¯ synchronized,wait ä¸ notify
wait(): ä½¿ä¸€ä¸ªçº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€, å¹¶ä¸”é‡Šæ”¾æ‰€æŒæœ‰çš„å¯¹è±¡çš„ lock.  
sleep(): ä½¿ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹å¤„äºç¡çœ çŠ¶æ€, æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•, è°ƒç”¨æ­¤æ–¹æ³•è¦æ•æ‰ InterruptedException å¼‚å¸¸.  
notify(): å”¤é†’ä¸€ä¸ªå¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹, æ³¨æ„çš„æ˜¯åœ¨è°ƒç”¨æ­¤æ–¹æ³•çš„æ—¶å€™, å¹¶ä¸èƒ½ç¡®åˆ‡çš„å”¤é†’æŸä¸€ä¸ªç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹, è€Œæ˜¯ç”± JVM ç¡®å®šå”¤é†’å“ªä¸ªçº¿ç¨‹,
è€Œä¸”ä¸æ˜¯æŒ‰ä¼˜å…ˆçº§.  
Allnotity(): å”¤é†’æ‰€æœ‰å¤„å…¥ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹, æ³¨æ„å¹¶ä¸æ˜¯ç»™æ‰€æœ‰å”¤é†’çº¿ç¨‹ä¸€ä¸ªå¯¹è±¡çš„é”, è€Œæ˜¯è®©å®ƒä»¬ç«äº‰.

## å½“ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ä¸€ä¸ªå¯¹è±¡çš„ä¸€ä¸ª synchronized æ–¹æ³•å, å…¶å®ƒçº¿ç¨‹æ˜¯å¦å¯è¿›å…¥æ­¤å¯¹è±¡çš„å…¶å®ƒæ–¹æ³•?

åˆ†å‡ ç§æƒ…å†µ:

1. å…¶ä»–æ–¹æ³•å‰æ˜¯å¦åŠ äº† synchronized å…³é”®å­—, å¦‚æœæ²¡åŠ , åˆ™èƒ½.
2. å¦‚æœè¿™ä¸ªæ–¹æ³•å†…éƒ¨è°ƒç”¨äº† wait, åˆ™å¯ä»¥è¿›å…¥å…¶ä»– synchronized æ–¹æ³•.
3. å¦‚æœå…¶ä»–ä¸ªæ–¹æ³•éƒ½åŠ äº† synchronized å…³é”®å­—, å¹¶ä¸”å†…éƒ¨æ²¡æœ‰è°ƒç”¨ wait, åˆ™ä¸èƒ½.
4. å¦‚æœå…¶ä»–æ–¹æ³•æ˜¯ static, å®ƒç”¨çš„åŒæ­¥é”æ˜¯å½“å‰ç±»çš„å­—èŠ‚ç , ä¸éé™æ€çš„æ–¹æ³•ä¸èƒ½åŒæ­¥, å› ä¸ºéé™æ€çš„æ–¹æ³•ç”¨çš„æ˜¯ this.

## Java é”çš„ç§ç±»

1. è‡ªæ—‹é”

```java
public class SpinLock {
  private AtomicReference<Thread> sign =new AtomicReference<>();
  public void lock(){
        Thread current = Thread.currentThread();
        while(!sign.compareAndSet(null, current)){
        }
}
public void unlock (){
    Thread current = Thread.currentThread();
    sign.compareAndSet(current, null);
  }
}
```

2. è‡ªæ—‹é”çš„å…¶ä»–ç§ç±»
3. é˜»å¡é”

   - synchronized å…³é”®å­—ï¼ˆå…¶ä¸­çš„é‡é‡é”ï¼‰
   - ReentrantLock

     ```java
     Lock lock = new ReentrantLock();
     lock.lock();
     try {
         // update object state
     }
     finally {
         lock.unlock();
     }
     ```

   - `Object.wait()/notify()`
   - `LockSupport.park()/unpart()`

4. å¯é‡å…¥é”
   - ReentrantLockÃŸ
5. è¯»å†™é”
6. äº’æ–¥é”
7. æ‚²è§‚é”
8. ä¹è§‚é”
9. å…¬å¹³é”
10. éå…¬å¹³é”
11. åå‘é”
12. å¯¹è±¡é”
13. çº¿ç¨‹é”
14. é”ç²—åŒ–
15. è½»é‡çº§é”
16. é”æ¶ˆé™¤
17. é”è†¨èƒ€
18. ä¿¡å·é‡

## ç®€è¿° synchronized å’Œ java.util.concurrent.locks.Lock çš„å¼‚åŒ ï¼Ÿ

ä¸»è¦ç›¸åŒç‚¹: Lock èƒ½å®Œæˆ synchronized æ‰€å®ç°çš„æ‰€æœ‰åŠŸèƒ½
ä¸»è¦ä¸åŒç‚¹: Lock æœ‰æ¯” synchronized æ›´ç²¾ç¡®çš„çº¿ç¨‹è¯­ä¹‰å’Œæ›´å¥½çš„æ€§èƒ½. synchronized ä¼šè‡ªåŠ¨é‡Šæ”¾é”, è€Œ Lock ä¸€å®šè¦æ±‚ç¨‹åºå‘˜æ‰‹å·¥é‡Šæ”¾, å¹¶ä¸”å¿…é¡»åœ¨
finally ä»å¥ä¸­é‡Šæ”¾. Lock è¿˜æœ‰æ›´å¼ºå¤§çš„åŠŸèƒ½, ä¾‹å¦‚, å®ƒçš„ tryLock æ–¹æ³•å¯ä»¥éé˜»å¡æ–¹å¼å»æ‹¿é”.

```java
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;
public class ThreadTest {
    private int j;
    private Lock lock = new ReentrantLock();
    public static void main(String[] args) {
        ThreadTest tt = new ThreadTest();
        for (int i = 0; i < 2; i++) {
            new Thread(tt.new Adder()).start();
            new Thread(tt.new Subtractor()).start();
        }
    }
    private class Subtractor implements Runnable {
        public void run() {
            while (true) {
                synchronized (ThreadTest.this) {
                    System.out.println("j--=" + j--);
                }
                // lock.lock();
                // try {
                //    System.out.println("j--=" + j--);
                // } finally {
                //    lock.unlock();
                // }
            }
        }
    }
    private class Adder implements Runnable {
        public void run() {
            while (true) {
                synchronized (ThreadTest.this) {
                    System.out.println("j++=" + j++);
                }
                // lock.lock();
                // try {
                //    System.out.println("j++=" + j++);
                // } finally {
                //    lock.unlock();
                // }
            }
        }
    }
}
```

## è®¾è®¡ 4 ä¸ªçº¿ç¨‹, å…¶ä¸­ä¸¤ä¸ªçº¿ç¨‹æ¯æ¬¡å¯¹ j å¢åŠ  1, å¦å¤–ä¸¤ä¸ªçº¿ç¨‹å¯¹ j æ¯æ¬¡å‡å°‘ 1. å†™å‡ºç¨‹åº.

```java
public class ThreadTest1 {
    private int j;

    public static void main(String args[]) {
        ThreadTest1 tt  = new ThreadTest1();
        Inc         inc = tt.new Inc();
        Dec         dec = tt.new Dec();
        for (int i = 0; i < 2; i++) {
            Thread t = new Thread(inc);
            t.start();
            t = new Thread(dec);
            t.start();
        }
    }

    class Inc implements Runnable {
        public void run() {
            for (int i = 0; i < 2; i++) {
                inc();
            }
        }
    }

    class Dec implements Runnable {
        public void run() {
            for (int i = 0; i < 2; i++) {
                dec();
            }
        }
    }

    private synchronized void inc() {
        j++;
        System.out.println(Thread.currentThread().getName() + "-inc:" + j);
    }

    private synchronized void dec() {
        j--;
        System.out.println(Thread.currentThread().getName() + "-dec:" + j);
    }
}
```

## å­çº¿ç¨‹å¾ªç¯ 2 æ¬¡, æ¥ç€ä¸»çº¿ç¨‹å¾ªç¯ 5 æ¬¡, æ¥ç€åˆå›åˆ°å­çº¿ç¨‹å¾ªç¯ 2 æ¬¡, æ¥ç€å†å›åˆ°ä¸»çº¿ç¨‹åˆå¾ªç¯ 5 æ¬¡, å¦‚æ­¤å¾ªç¯ 5 æ¬¡, è¯·å†™å‡ºç¨‹åº.

```java
public class ThreadTest2 {
    public static void main(String[] args) {
        new ThreadTest2().init();
    }
    public void init() {
        final Business business = new Business();
        new Thread(
            new Runnable() {
                public void run() {
                    for (int i = 0; i < 5; i++) {
                        // æ‰§è¡Œå­çº¿ç¨‹
                        business.subThread(i);
                    }
                }
            }
        ).start();

        for (int i = 0; i < 5; i++) {
            business.mainThread(i);
        }
    }

    private class Business {
        boolean flag = true;// è¿™é‡Œç›¸å½“äºå®šä¹‰äº†æ§åˆ¶è¯¥è°æ‰§è¡Œçš„ä¸€ä¸ªä¿¡å·ç¯

        // ä¸»çº¿ç¨‹å¼€å§‹æ‰§è¡Œ ç”±äº flag=false ç›´æ¥è¾“å‡º 5 æ¬¡
        public synchronized void mainThread(int i) {
            if (flag)
                try {
                    this.wait();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }

            for (int j = 0; j < 5; j++) {
                System.out.println(Thread.currentThread().getName() + ":i=" + i + ",j=" + j);
            }
            flag = true;
            // å”¤é†’å­çº¿ç¨‹
            this.notify();
        }

        // å¤šä¸ªçº¿ç¨‹æ‰§è¡Œæ­¤æ®µä»£ç æ—¶, è·å¾—é”çš„æ‰èƒ½è¿›å…¥æ‰§è¡Œ
        // å­çº¿ç¨‹å…ˆè·å¾—é”, ç„¶åä¿¡å·ä¸º true, æ‰§è¡Œè¾“å‡º 2 æ¬¡, æœ€åä¿¡å·, å”¤é†’å…¶ä»–çº¿ç¨‹

        // ç¬¬äºŒä¸ªçº¿ç¨‹è¿›å…¥æ—¶, ç”±äº flag= false è¿›å…¥é˜»å¡çŠ¶æ€
        public synchronized void subThread(int i) {
            if (!flag) {
                try {
                    this.wait();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            // æ‰§è¡Œ 2 æ¬¡å­çº¿ç¨‹
            for (int j = 0; j < 2; j++) {
                System.out.println(Thread.currentThread().getName() + ":i=" + i + ",j=" + j);
            }
            // å­çº¿ç¨‹æ‰§è¡Œå®Œäº†, å°†ä¿¡å·è®¾ç½®ä¸ºå…³é—­
            flag = false;
            // å”¤é†’å¦å¤–çš„çº¿ç¨‹
            this.notify();
        }
    }
}
```

```java
public class ThreadTest3 {
    private static boolean flag = false;

    public static void main(String[] args) {
        new Thread(
            new Runnable() {
                public void run() {
                    for (int i = 0; i < 5; i++) {
                        synchronized (ThreadTest3.class) {
                            // ç¬¬äºŒä¸ªå­çº¿ç¨‹è¦ç­‰åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œå®Œä¸€æ¬¡åæ‰èƒ½æ‰§è¡Œ
                            if (flag) {
                                try {
                                    ThreadTest3.class.wait();
                                } catch (InterruptedException e) {
                                    e.printStackTrace();
                                }
                            }
                            for (int j = 0; j < 2; j++) {
                                System.out.println(
                                        Thread.currentThread().getName() +
                                                "i=" + i + ",j=" + j);
                            }
                            flag = true;
                            ThreadTest3.class.notify();
                        }
                    }
                }
            }
        ).start();

        for (int i = 0; i < 5; i++) {
            synchronized (ThreadTest3.class) {
                if (!flag) {
                    try {
                        ThreadTest3.class.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                for (int j = 0; j < 5; j++) {
                    System.out.println(
                            Thread.currentThread().getName() +
                                    "i=" + i + ",j=" + j);
                }
                flag = false;
                ThreadTest3.class.notify();
            }
        }
    }
}
```

```java
import java.util.concurrent.Executors;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;
import java.util.concurrent.locks.Condition;

public class ThreadTest4 {
    private static Lock      lock               = new ReentrantLock();
    private static Condition subThreadCondition = lock.newCondition();
    private static boolean   flag               = true;

    public static void main(String[] args) {
        ExecutorService threadPool = Executors.newFixedThreadPool(3);
        threadPool.execute(new Runnable() {
            public void run() {
                for (int i = 0; i < 5; i++) {
                    // è·å¾—é”
                    lock.lock();
                    try {
                        if (!flag)
                            subThreadCondition.await();
                        for (int j = 0; j < 2; j++) {
                            System.out.println(Thread.currentThread().getName() + ",j=" + j);
                        }
                        flag = false;
                        subThreadCondition.signal();
                    } catch (Exception e) {
                    } finally {
                        lock.unlock();
                    }
                }
            }
        });
        threadPool.shutdown();
        for (int i = 0; i < 5; i++) {
            lock.lock();
            try {
                if (flag)
                    subThreadCondition.await();
                for (int j = 0; j < 5; j++) {
                    System.out.println(Thread.currentThread().getName() + ",j=" + j);
                }
                flag = true;
                subThreadCondition.signal();
            } catch (Exception e) {
            } finally {
                lock.unlock();
            }
        }
    }
}
```

## æ•°æ®åº“é©±åŠ¨ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ Class.forName()

åœ¨ Java å¼€å‘ç‰¹åˆ«æ˜¯æ•°æ®åº“å¼€å‘ä¸­, ç»å¸¸ä¼šç”¨åˆ° Class.forName()è¿™ä¸ªæ–¹æ³•. é€šè¿‡æŸ¥è¯¢ Java Documentation æˆ‘ä»¬ä¼šå‘ç°ä½¿ç”¨ Class.forName()
é™æ€æ–¹æ³•çš„ç›®çš„æ˜¯ä¸ºäº†åŠ¨æ€åŠ è½½ç±». åœ¨åŠ è½½å®Œæˆå, ä¸€èˆ¬è¿˜è¦è°ƒç”¨ Class ä¸‹çš„ newInstance() é™æ€æ–¹æ³•æ¥å®ä¾‹åŒ–å¯¹è±¡ä»¥ä¾¿æ“ä½œ. å› æ­¤, å•å•ä½¿ç”¨
Class.forName() æ˜¯åŠ¨æ€åŠ è½½ç±»æ˜¯æ²¡æœ‰ç”¨çš„, å…¶æœ€ç»ˆç›®çš„æ˜¯ä¸ºäº†å®ä¾‹åŒ–å¯¹è±¡.
Class.forName("") è¿”å›çš„æ˜¯ç±»
Class.forName("").newInstance() è¿”å›çš„æ˜¯ object
åˆšæ‰æåˆ°, Class.forName(""); çš„ä½œç”¨æ˜¯è¦æ±‚ JVM æŸ¥æ‰¾å¹¶åŠ è½½æŒ‡å®šçš„ç±», å¦‚æœåœ¨ç±»ä¸­æœ‰é™æ€åˆå§‹åŒ–å™¨çš„è¯, JVM å¿…ç„¶ä¼šæ‰§è¡Œè¯¥ç±»çš„é™æ€ä»£ç  æ®µ. è€Œåœ¨ JDBC
è§„èŒƒä¸­æ˜ç¡®è¦æ±‚è¿™ä¸ª Driver ç±»å¿…é¡»å‘ DriverManager æ³¨å†Œè‡ªå·±, å³ä»»ä½•ä¸€ä¸ª JDBC Driver çš„ Driver ç±»çš„ä»£ç éƒ½å¿…é¡»ç±»ä¼¼å¦‚ä¸‹:
public class MyJDBCDriver implements Driver {static {DriverManager.registerDriver(new MyJDBCDriver());}} æ—¢ç„¶åœ¨é™æ€åˆå§‹åŒ–å™¨çš„ä¸­å·²ç»è¿›è¡Œäº†æ³¨å†Œ,
æ‰€ä»¥æˆ‘ä»¬åœ¨ä½¿ç”¨ JDBC æ—¶åªéœ€è¦ Class.forName(XXX.XXX); å°±å¯ä»¥äº†.

```
we just want to load the driver to jvm only, but not need to user the instance of driver, so call Class.forName(xxx.xx.xx) is enough,
if you call Class.forName(xxx.xx.xx).newInstance(), the result will same as calling Class.forName(xxx.xx.xx),
because Class.forName(xxx.xx.xx).newInstance() will load driver first, and then create instance,
but the instacne you will never use in usual, so you need not to create it.
```

æ€»ç»“: jdbc æ•°æ®åº“é©±åŠ¨ç¨‹åºæœ€ç»ˆçš„ç›®çš„, æ˜¯ä¸ºäº†ç¨‹åºå‘˜èƒ½æ‹¿åˆ°æ•°æ®åº“è¿æ¥, è€Œè¿›è¡Œ jdbc è§„èŒƒçš„æ•°æ®åº“æ“ä½œ. æ‹¿åˆ°è¿æ¥çš„è¿‡ç¨‹æ˜¯ä¸éœ€è¦ä½ è‡ªå·±æ¥å®ä¾‹åŒ–é©±åŠ¨ç¨‹åºçš„,
è€Œæ˜¯é€šè¿‡ DriverManger.getConnection(string str); . å› æ­¤ä¸€èˆ¬æƒ…å†µä¸‹, å¯¹äºç¨‹åºå‘˜æ¥è¯´, é™¤éç‰¹åˆ«éœ€æ±‚, æ˜¯ä¸ä¼šè‡ªå·±å»å®ä¾‹åŒ–ä¸€ä¸ªæ•°æ®åº“é©±åŠ¨ä½¿ç”¨é‡Œé¢çš„æ–¹æ³•çš„.

## [Javaé¢è¯•å¿…çŸ¥ï¼šHashMapåŸç†ä¸å¸¸è§é—®é¢˜è§£ç­”](https://blog.dong4j.site/posts/b944ce65.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## Java é›†åˆ

- Collection
  - List
    - LinkedList
    - ArrayList
    - CopyOnWriteArrayList
    - Vetor
      - Stack
  - Set
    - HashSet
    - LinkedHashSet
    - TreeSet
    - CopyOnWriteArraySet
- Map
  - ConcurrentHashMap
  - ConcurrentShipListMap
  - EnumMap
  - HashMap
  - HashTable
  - LinkedHashMap
  - Properties
  - TreeMap
  - WeakHashMap

## å•çº¿ç¨‹é›†åˆ

### List

#### ArrayList

![20241229154732_bANP5iIE.webp](https://cdn.dong4j.site/source/image/20241229154732_bANP5iIE.webp)

- åº•å±‚åŸºäºæ³›å‹æ•°ç»„
- å®ƒå…è®¸æ‰€æœ‰å…ƒç´ ï¼ŒåŒ…æ‹¬ null
- ArrayList å®é™…ä¸Šæ˜¯é€šè¿‡ä¸€ä¸ªæ•°ç»„å»ä¿å­˜æ•°æ®çš„ã€‚å½“æˆ‘ä»¬æ„é€  ArrayList æ—¶ï¼›è‹¥ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°ï¼Œåˆ™ ArrayList çš„é»˜è®¤å®¹é‡å¤§å°æ˜¯ 10ã€‚
- å½“ ArrayList å®¹é‡ä¸è¶³ä»¥å®¹çº³å…¨éƒ¨å…ƒç´ æ—¶ï¼ŒArrayList ä¼šé‡æ–°è®¾ç½®å®¹é‡ï¼šæ–°çš„å®¹é‡ =â€œ(åŸå§‹å®¹é‡ x3)/2 + 1â€ã€‚
- ArrayList çš„å…‹éš†å‡½æ•°ï¼Œå³æ˜¯å°†å…¨éƒ¨å…ƒç´ å…‹éš†åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ã€‚
- ArrayList å®ç° java.io.Serializable çš„æ–¹å¼ã€‚å½“å†™å…¥åˆ°è¾“å‡ºæµæ—¶ï¼Œå…ˆå†™å…¥â€œå®¹é‡â€ï¼Œå†ä¾æ¬¡å†™å…¥â€œæ¯ä¸€ä¸ªå…ƒç´ â€ï¼›å½“è¯»å‡ºè¾“å…¥æµæ—¶ï¼Œå…ˆè¯»å–â€œå®¹é‡â€ï¼Œå†ä¾æ¬¡è¯»å–â€œæ¯ä¸€ä¸ªå…ƒç´ â€ã€‚

##### éå†æ–¹å¼

ä½¿ç”¨è¿­ä»£å™¨éå†

```java
Integer value = null;
Iterator iter = list.iterator();
while (iter.hasNext()) {
    value = (Integer)iter.next();
}
```

ä½¿ç”¨ RandomAccess æä¾›çš„ get()æ–¹æ³•éå† ( æœ€å¿«)

```java
Integer value = null;
int size = list.size();
for (int i=0; i<size; i++) {
    value = (Integer)list.get(i);
}
```

foreach

```java
Integer value = null;
for (Integer integ:list) {
    value = integ;
}
```

#### LinkedList

![20241229154732_feIHBVEY.webp](https://cdn.dong4j.site/source/image/20241229154732_feIHBVEY.webp)

- LinkedList æ˜¯ä¸€ä¸ªç»§æ‰¿äº AbstractSequentialList çš„åŒå‘é“¾è¡¨ã€‚å®ƒä¹Ÿå¯ä»¥è¢«å½“ä½œå †æ ˆã€é˜Ÿåˆ—æˆ–åŒç«¯é˜Ÿåˆ—è¿›è¡Œæ“ä½œã€‚
- LinkedList å®ç° List æ¥å£ï¼Œèƒ½å¯¹å®ƒè¿›è¡Œé˜Ÿåˆ—æ“ä½œã€‚
- LinkedList å®ç° Deque æ¥å£ï¼Œå³èƒ½å°† LinkedList å½“ä½œåŒç«¯é˜Ÿåˆ—ä½¿ç”¨ã€‚
- LinkedList å®ç°äº† Cloneable æ¥å£ï¼Œå³è¦†ç›–äº†å‡½æ•° clone()ï¼Œèƒ½å…‹éš†ã€‚
- LinkedList å®ç° java.io.Serializable æ¥å£ï¼Œè¿™æ„å‘³ç€ LinkedList æ”¯æŒåºåˆ—åŒ–ï¼Œèƒ½é€šè¿‡åºåˆ—åŒ–å»ä¼ è¾“ã€‚
- LinkedList æ˜¯éåŒæ­¥çš„ã€‚

##### éå†æ–¹å¼

```java
import java.util.List;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.NoSuchElementException;

/*
 * @desc æµ‹è¯• LinkedList çš„å‡ ç§éå†æ–¹å¼å’Œæ•ˆç‡
 *
 * @author skywang
 */
public class LinkedListThruTest {
    public static void main(String[] args) {
        // é€šè¿‡ Iterator éå† LinkedList
        iteratorLinkedListThruIterator(getLinkedList()) ;

        // é€šè¿‡å¿«é€Ÿéšæœºè®¿é—®éå† LinkedList
        iteratorLinkedListThruForeach(getLinkedList()) ;

        // é€šè¿‡ for å¾ªç¯çš„å˜ç§æ¥è®¿é—®éå† LinkedList
        iteratorThroughFor2(getLinkedList()) ;

        // é€šè¿‡ PollFirst() éå† LinkedList
        iteratorThroughPollFirst(getLinkedList()) ;

        // é€šè¿‡ PollLast() éå† LinkedList
        iteratorThroughPollLast(getLinkedList()) ;

        // é€šè¿‡ removeFirst() éå† LinkedList
        iteratorThroughRemoveFirst(getLinkedList()) ;

        // é€šè¿‡ removeLast() éå† LinkedList
        iteratorThroughRemoveLast(getLinkedList()) ;
    }

    private static LinkedList getLinkedList() {
        LinkedList llist = new LinkedList();
        for (int i=0; i<100000; i++)
            llist.addLast(i);

        return llist;
    }
    /**
     * é€šè¿‡å¿«è¿­ä»£å™¨éå† LinkedList
     */
    private static void iteratorLinkedListThruIterator(LinkedList<Integer> list) {
        if (list == null)
            return ;

        // è®°å½•å¼€å§‹æ—¶é—´
        long start = System.currentTimeMillis();

        for(Iterator iter = list.iterator(); iter.hasNext();)
            iter.next();

        // è®°å½•ç»“æŸæ—¶é—´
        long end = System.currentTimeMillis();
        long interval = end - start;
        System.out.println("iteratorLinkedListThruIteratorï¼š" + interval+" ms");
    }

    /**
     * é€šè¿‡å¿«é€Ÿéšæœºè®¿é—®éå† LinkedList
     */
    private static void iteratorLinkedListThruForeach(LinkedList<Integer> list) {
        if (list == null)
            return ;

        // è®°å½•å¼€å§‹æ—¶é—´
        long start = System.currentTimeMillis();

        int size = list.size();
        for (int i=0; i<size; i++) {
            list.get(i);
        }
        // è®°å½•ç»“æŸæ—¶é—´
        long end = System.currentTimeMillis();
        long interval = end - start;
        System.out.println("iteratorLinkedListThruForeachï¼š" + interval+" ms");
    }

    /**
     * é€šè¿‡å¦å¤–ä¸€ç§ for å¾ªç¯æ¥éå† LinkedList
     */
    private static void iteratorThroughFor2(LinkedList<Integer> list) {
        if (list == null)
            return ;

        // è®°å½•å¼€å§‹æ—¶é—´
        long start = System.currentTimeMillis();

        for (Integer integ:list)
            ;

        // è®°å½•ç»“æŸæ—¶é—´
        long end = System.currentTimeMillis();
        long interval = end - start;
        System.out.println("iteratorThroughFor2ï¼š" + interval+" ms");
    }

    /**
     * é€šè¿‡ pollFirst() æ¥éå† LinkedList
     */
    private static void iteratorThroughPollFirst(LinkedList<Integer> list) {
        if (list == null)
            return ;

        // è®°å½•å¼€å§‹æ—¶é—´
        long start = System.currentTimeMillis();
        while(list.pollFirst() != null)
            ;

        // è®°å½•ç»“æŸæ—¶é—´
        long end = System.currentTimeMillis();
        long interval = end - start;
        System.out.println("iteratorThroughPollFirstï¼š" + interval+" ms");
    }

    /**
     * é€šè¿‡ pollLast() æ¥éå† LinkedList
     */
    private static void iteratorThroughPollLast(LinkedList<Integer> list) {
        if (list == null)
            return ;

        // è®°å½•å¼€å§‹æ—¶é—´
        long start = System.currentTimeMillis();
        while(list.pollLast() != null)
            ;

        // è®°å½•ç»“æŸæ—¶é—´
        long end = System.currentTimeMillis();
        long interval = end - start;
        System.out.println("iteratorThroughPollLastï¼š" + interval+" ms");
    }

    /**
     * é€šè¿‡ removeFirst() æ¥éå† LinkedList
     */
    private static void iteratorThroughRemoveFirst(LinkedList<Integer> list) {
        if (list == null)
            return ;

        // è®°å½•å¼€å§‹æ—¶é—´
        long start = System.currentTimeMillis();
        try {
            while(list.removeFirst() != null)
                ;
        } catch (NoSuchElementException e) {
        }

        // è®°å½•ç»“æŸæ—¶é—´
        long end = System.currentTimeMillis();
        long interval = end - start;
        System.out.println("iteratorThroughRemoveFirstï¼š" + interval+" ms");
    }

    /**
     * é€šè¿‡ removeLast() æ¥éå† LinkedList
     */
    private static void iteratorThroughRemoveLast(LinkedList<Integer> list) {
        if (list == null)
            return ;

        // è®°å½•å¼€å§‹æ—¶é—´
        long start = System.currentTimeMillis();
        try {
            while(list.removeLast() != null)
                ;
        } catch (NoSuchElementException e) {
        }

        // è®°å½•ç»“æŸæ—¶é—´
        long end = System.currentTimeMillis();
        long interval = end - start;
        System.out.println("iteratorThroughRemoveLastï¼š" + interval+" ms");
    }
}
```

è¿”å›ç»“æœ

```java
iteratorLinkedListThruIteratorï¼š8 ms
iteratorLinkedListThruForeachï¼š3724 ms
iteratorThroughFor2ï¼š5 ms
iteratorThroughPollFirstï¼š8 ms
iteratorThroughPollLastï¼š6 ms
iteratorThroughRemoveFirstï¼š2 ms
iteratorThroughRemoveLastï¼š2 ms
```

- é‡‡ç”¨ ArrayList å¯¹éšæœºè®¿é—®æ¯”è¾ƒå¿«ï¼Œè€Œ for å¾ªç¯ä¸­çš„ get() æ–¹æ³•ï¼Œé‡‡ç”¨çš„å³æ˜¯éšæœºè®¿é—®çš„æ–¹æ³•ï¼Œå› æ­¤åœ¨ ArrayList é‡Œï¼Œfor å¾ªç¯è¾ƒå¿«
- é‡‡ç”¨ LinkedList åˆ™æ˜¯é¡ºåºè®¿é—®æ¯”è¾ƒå¿«ï¼Œiterator ä¸­çš„ next() æ–¹æ³•ï¼Œé‡‡ç”¨çš„å³æ˜¯é¡ºåºè®¿é—®çš„æ–¹æ³•ï¼Œå› æ­¤åœ¨ LinkedList é‡Œï¼Œä½¿ç”¨ iterator è¾ƒå¿«
- ä»æ•°æ®ç»“æ„è§’åº¦åˆ†æ,for å¾ªç¯é€‚åˆè®¿é—®é¡ºåºç»“æ„, å¯ä»¥æ ¹æ®ä¸‹æ ‡å¿«é€Ÿè·å–æŒ‡å®šå…ƒç´ . è€Œ Iterator é€‚åˆè®¿é—®é“¾å¼ç»“æ„, å› ä¸ºè¿­ä»£å™¨æ˜¯é€šè¿‡ next()å’Œ Pre()
  æ¥å®šä½çš„. å¯ä»¥è®¿é—®æ²¡æœ‰é¡ºåºçš„é›†åˆ.

#### Vector

![20241229154732_61WSEF2R.webp](https://cdn.dong4j.site/source/image/20241229154732_61WSEF2R.webp)

- çº¿ç¨‹å®‰å…¨
- Vector å®é™…ä¸Šæ˜¯é€šè¿‡ä¸€ä¸ªæ•°ç»„å»ä¿å­˜æ•°æ®çš„ã€‚å½“æˆ‘ä»¬æ„é€  Vecotr æ—¶ï¼›è‹¥ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°ï¼Œåˆ™ Vector çš„é»˜è®¤å®¹é‡å¤§å°æ˜¯ 10ã€‚
- å½“ Vector å®¹é‡ä¸è¶³ä»¥å®¹çº³å…¨éƒ¨å…ƒç´ æ—¶ï¼ŒVector çš„å®¹é‡ä¼šå¢åŠ ã€‚è‹¥å®¹é‡å¢åŠ ç³»æ•° >0ï¼Œåˆ™å°†å®¹é‡çš„å€¼å¢åŠ â€œå®¹é‡å¢åŠ ç³»æ•°â€ï¼›å¦åˆ™ï¼Œå°†å®¹é‡å¤§å°å¢åŠ ä¸€å€ã€‚
- Vector çš„å…‹éš†å‡½æ•°ï¼Œå³æ˜¯å°†å…¨éƒ¨å…ƒç´ å…‹éš†åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ã€‚

##### éå†æ–¹å¼

```java
import java.util.*;

/*
 * @desc Vector éå†æ–¹å¼å’Œæ•ˆç‡çš„æµ‹è¯•ç¨‹åºã€‚
 *
 * @author skywang
 */
public class VectorRandomAccessTest {

    public static void main(String[] args) {
        Vector vec= new Vector();
        for (int i=0; i<100000; i++)
            vec.add(i);
        iteratorThroughRandomAccess(vec) ;
        iteratorThroughIterator(vec) ;
        iteratorThroughFor2(vec) ;
        iteratorThroughEnumeration(vec) ;

    }

    private static void isRandomAccessSupported(List list) {
        if (list instanceof RandomAccess) {
            System.out.println("RandomAccess implemented!");
        } else {
            System.out.println("RandomAccess not implemented!");
        }

    }

    public static void iteratorThroughRandomAccess(List list) {

        long startTime;
        long endTime;
        startTime = System.currentTimeMillis();
        for (int i=0; i<list.size(); i++) {
            list.get(i);
        }
        endTime = System.currentTimeMillis();
        long interval = endTime - startTime;
        System.out.println("iteratorThroughRandomAccessï¼š" + interval+" ms");
    }

    public static void iteratorThroughIterator(List list) {

        long startTime;
        long endTime;
        startTime = System.currentTimeMillis();
        for(Iterator iter = list.iterator(); iter.hasNext();) {
            iter.next();
        }
        endTime = System.currentTimeMillis();
        long interval = endTime - startTime;
        System.out.println("iteratorThroughIteratorï¼š" + interval+" ms");
    }


    public static void iteratorThroughFor2(List list) {

        long startTime;
        long endTime;
        startTime = System.currentTimeMillis();
        for(Object obj:list)
            ;
        endTime = System.currentTimeMillis();
        long interval = endTime - startTime;
        System.out.println("iteratorThroughFor2ï¼š" + interval+" ms");
    }

    public static void iteratorThroughEnumeration(Vector vec) {

        long startTime;
        long endTime;
        startTime = System.currentTimeMillis();
        for(Enumeration enu = vec.elements(); enu.hasMoreElements();) {
            enu.nextElement();
        }
        endTime = System.currentTimeMillis();
        long interval = endTime - startTime;
        System.out.println("iteratorThroughEnumerationï¼š" + interval+" ms");
    }
}
```

è¿”å›ç»“æœ

```
iteratorThroughRandomAccessï¼š6 ms
iteratorThroughIteratorï¼š9 ms
iteratorThroughFor2ï¼š8 ms
iteratorThroughEnumerationï¼š7 ms
```

#### List æ€»ç»“

![20241229154732_5CbHHEoz.webp](https://cdn.dong4j.site/source/image/20241229154732_5CbHHEoz.webp)

- List æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒç»§æ‰¿äº Collection çš„æ¥å£ã€‚å®ƒä»£è¡¨ç€æœ‰åºçš„é˜Ÿåˆ—ã€‚
- AbstractList æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒç»§æ‰¿äº AbstractCollectionã€‚AbstractList å®ç° List æ¥å£ä¸­é™¤ size()ã€get(int location) ä¹‹å¤–çš„å‡½æ•°ã€‚
- AbstractSequentialList æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒç»§æ‰¿äº AbstractListã€‚AbstractSequentialList å®ç°äº†â€œé“¾è¡¨ä¸­ï¼Œæ ¹æ® index ç´¢å¼•å€¼æ“ä½œé“¾è¡¨çš„å…¨éƒ¨å‡½æ•°â€ã€‚
- ArrayList, LinkedList, Vector, Stack æ˜¯ List çš„ 4 ä¸ªå®ç°ç±»ã€‚
  - ArrayList æ˜¯ä¸€ä¸ªæ•°ç»„é˜Ÿåˆ—ï¼Œç›¸å½“äºåŠ¨æ€æ•°ç»„ã€‚å®ƒç”±æ•°ç»„å®ç°ï¼Œéšæœºè®¿é—®æ•ˆç‡é«˜ï¼Œéšæœºæ’å…¥ã€éšæœºåˆ é™¤æ•ˆç‡ä½ã€‚
  - LinkedList æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚å®ƒä¹Ÿå¯ä»¥è¢«å½“ä½œå †æ ˆã€é˜Ÿåˆ—æˆ–åŒç«¯é˜Ÿåˆ—è¿›è¡Œæ“ä½œã€‚LinkedList éšæœºè®¿é—®æ•ˆç‡ä½ï¼Œä½†éšæœºæ’å…¥ã€éšæœºåˆ é™¤æ•ˆç‡ä½ã€‚
  - Vector æ˜¯çŸ¢é‡é˜Ÿåˆ—ï¼Œå’Œ ArrayList ä¸€æ ·ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªåŠ¨æ€æ•°ç»„ï¼Œç”±æ•°ç»„å®ç°ã€‚ä½†æ˜¯ ArrayList æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œè€Œ Vector æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
  - Stack æ˜¯æ ˆï¼Œå®ƒç»§æ‰¿äº Vectorã€‚å®ƒçš„ç‰¹æ€§æ˜¯ï¼šå…ˆè¿›åå‡º (FILO, First In Last Out)ã€‚

##### ä½¿ç”¨ç‰¹ç‚¹

å¦‚æœæ¶‰åŠåˆ°â€œæ ˆâ€ã€â€œé˜Ÿåˆ—â€ã€â€œé“¾è¡¨â€ç­‰æ“ä½œï¼Œåº”è¯¥è€ƒè™‘ç”¨ Listï¼Œå…·ä½“çš„é€‰æ‹©å“ªä¸ª Listï¼Œæ ¹æ®ä¸‹é¢çš„æ ‡å‡†æ¥å–èˆã€‚

- å¯¹äºéœ€è¦å¿«é€Ÿæ’å…¥ï¼Œåˆ é™¤å…ƒç´ ï¼Œåº”è¯¥ä½¿ç”¨ LinkedListã€‚
- å¯¹äºéœ€è¦å¿«é€Ÿéšæœºè®¿é—®å…ƒç´ ï¼Œåº”è¯¥ä½¿ç”¨ ArrayListã€‚
- å¯¹äºâ€œå•çº¿ç¨‹ç¯å¢ƒâ€ æˆ–è€… â€œå¤šçº¿ç¨‹ç¯å¢ƒï¼Œä½† List ä»…ä»…åªä¼šè¢«å•ä¸ªçº¿ç¨‹æ“ä½œâ€ï¼Œæ­¤æ—¶åº”è¯¥ä½¿ç”¨éåŒæ­¥çš„ç±» (å¦‚ ArrayList)ã€‚
- å¯¹äºâ€œå¤šçº¿ç¨‹ç¯å¢ƒï¼Œä¸” List å¯èƒ½åŒæ—¶è¢«å¤šä¸ªçº¿ç¨‹æ“ä½œâ€ï¼Œæ­¤æ—¶ï¼Œåº”è¯¥ä½¿ç”¨åŒæ­¥çš„ç±» (å¦‚ Vector)ã€‚

##### ArrayList å’Œ LinkedList æ¯”è¾ƒ

**LinkedList ä¸­æ’å…¥å…ƒç´ å¾ˆå¿«ï¼Œè€Œ ArrayList ä¸­æ’å…¥å…ƒç´ å¾ˆæ…¢ï¼**

> LinkedList: é€šè¿‡ add(int index, E element) å‘ LinkedList æ’å…¥å…ƒç´ æ—¶ã€‚å…ˆæ˜¯åœ¨åŒå‘é“¾è¡¨ä¸­æ‰¾åˆ°è¦æ’å…¥èŠ‚ç‚¹çš„ä½ç½® indexï¼›æ‰¾åˆ°ä¹‹åï¼Œå†æ’å…¥ä¸€ä¸ªæ–°èŠ‚ç‚¹ã€‚
> åŒå‘é“¾è¡¨æŸ¥æ‰¾ index ä½ç½®çš„èŠ‚ç‚¹æ—¶ï¼Œæœ‰ä¸€ä¸ªåŠ é€ŸåŠ¨ä½œï¼šè‹¥ index < åŒå‘é“¾è¡¨é•¿åº¦çš„ 1/2ï¼Œåˆ™ä»å‰å‘åæŸ¥æ‰¾; å¦åˆ™ï¼Œä»åå‘å‰æŸ¥æ‰¾ã€‚

> ArrayList: ensureCapacity(size+1) çš„ä½œç”¨æ˜¯â€œç¡®è®¤ ArrayList çš„å®¹é‡ï¼Œè‹¥å®¹é‡ä¸å¤Ÿï¼Œåˆ™å¢åŠ å®¹é‡ã€‚â€
> çœŸæ­£è€—æ—¶çš„æ“ä½œæ˜¯ System.arraycopy(elementData, index, elementData, index + 1, size - index);

> System.arraycopy(elementData, index, elementData, index + 1, size - index); ä¼šç§»åŠ¨ index ä¹‹åæ‰€æœ‰å…ƒç´ å³å¯ã€‚è¿™å°±æ„å‘³ç€ï¼ŒArrayList çš„ add(int
> index, E element) å‡½æ•°ï¼Œä¼šå¼•èµ· index ä¹‹åæ‰€æœ‰å…ƒç´ çš„æ”¹å˜ï¼

**LinkedList ä¸­éšæœºè®¿é—®å¾ˆæ…¢ï¼Œè€Œ ArrayList ä¸­éšæœºè®¿é—®å¾ˆå¿«**

> LinkedList: é€šè¿‡ get(int index) è·å– LinkedList ç¬¬ index ä¸ªå…ƒç´ æ—¶ã€‚å…ˆæ˜¯åœ¨åŒå‘é“¾è¡¨ä¸­æ‰¾åˆ°è¦ index ä½ç½®çš„å…ƒç´ ï¼›æ‰¾åˆ°ä¹‹åå†è¿”å›ã€‚
> åŒå‘é“¾è¡¨æŸ¥æ‰¾ index ä½ç½®çš„èŠ‚ç‚¹æ—¶ï¼Œæœ‰ä¸€ä¸ªåŠ é€ŸåŠ¨ä½œï¼šè‹¥ index < åŒå‘é“¾è¡¨é•¿åº¦çš„ 1/2ï¼Œåˆ™ä»å‰å‘åæŸ¥æ‰¾; å¦åˆ™ï¼Œä»åå‘å‰æŸ¥æ‰¾ã€‚

> ArrayList: é€šè¿‡ get(int index) è·å– ArrayList ç¬¬ index ä¸ªå…ƒç´ æ—¶ã€‚ç›´æ¥è¿”å›æ•°ç»„ä¸­ index ä½ç½®çš„å…ƒç´ ï¼Œè€Œä¸éœ€è¦åƒ LinkedList ä¸€æ ·è¿›è¡ŒæŸ¥æ‰¾ã€‚

##### Vector å’Œ ArrayList æ¯”è¾ƒ

ç›¸åŒä¹‹å¤„:

- å®ƒä»¬éƒ½ç»§æ‰¿äº AbstractListï¼Œå¹¶ä¸”å®ç° List æ¥å£ã€‚

```java
// ArrayList çš„å®šä¹‰
public class ArrayList<E> extends AbstractList<E>
implements List<E>, RandomAccess, Cloneable, java.io.Serializable
// Vector çš„å®šä¹‰
public class Vector<E> extends AbstractList<E>
implements List<E>, RandomAccess, Cloneable, java.io.Serializable {}

````

- å®ƒä»¬éƒ½å®ç°äº† RandomAccess å’Œ Cloneable æ¥å£
- å®ƒä»¬éƒ½æ˜¯é€šè¿‡æ•°ç»„å®ç°çš„ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯åŠ¨æ€æ•°ç»„
- å®ƒä»¬çš„é»˜è®¤æ•°ç»„å®¹é‡æ˜¯ 10
- å®ƒä»¬éƒ½æ”¯æŒ Iterator å’Œ listIterator éå†

ä¸åŒä¹‹å¤„:

- çº¿ç¨‹å®‰å…¨æ€§ä¸ä¸€æ ·,ArrayList é€‚ç”¨äºå•çº¿ç¨‹ï¼ŒVector é€‚ç”¨äºå¤šçº¿ç¨‹
- æ„é€ å‡½æ•°ä¸ªæ•°ä¸åŒ
- å®¹é‡å¢åŠ æ–¹å¼ä¸åŒ
    - é€ä¸ªæ·»åŠ å…ƒç´ æ—¶ï¼Œè‹¥ ArrayList å®¹é‡ä¸è¶³æ—¶ï¼Œâ€œæ–°çš„å®¹é‡â€=â€œ(åŸå§‹å®¹é‡ x3)/2 + 1â€ã€‚
    - Vector
        - å¢é•¿ç³»æ•° > 0 æ—¶ :â€œæ–°çš„å®¹é‡â€=â€œåŸå§‹å®¹é‡ + å¢é•¿ç³»æ•°â€
        - å¢é•¿ç³»æ•° <= 0 æ—¶: â€œæ–°çš„å®¹é‡â€=â€œåŸå§‹å®¹é‡ x 2â€
-  å¯¹ Enumeration çš„æ”¯æŒä¸åŒã€‚Vector æ”¯æŒé€šè¿‡ Enumeration å»éå†ï¼Œè€Œ List ä¸æ”¯æŒ

### Map

- Map æ˜¯æ˜ å°„æ¥å£ï¼ŒMap ä¸­å­˜å‚¨çš„å†…å®¹æ˜¯é”®å€¼å¯¹ (key-value)ã€‚
- AbstractMap æ˜¯ç»§æ‰¿äº Map çš„æŠ½è±¡ç±»ï¼Œå®ƒå®ç°äº† Map ä¸­çš„å¤§éƒ¨åˆ† APIã€‚å…¶å®ƒ Map çš„å®ç°ç±»å¯ä»¥é€šè¿‡ç»§æ‰¿ AbstractMap æ¥å‡å°‘é‡å¤ç¼–ç ã€‚
- SortedMap æ˜¯ç»§æ‰¿äº Map çš„æ¥å£ã€‚SortedMap ä¸­çš„å†…å®¹æ˜¯æ’åºçš„é”®å€¼å¯¹ï¼Œæ’åºçš„æ–¹æ³•æ˜¯é€šè¿‡æ¯”è¾ƒå™¨ (Comparator)ã€‚
- NavigableMap æ˜¯ç»§æ‰¿äº SortedMap çš„æ¥å£ã€‚ç›¸æ¯”äº SortedMapï¼ŒNavigableMap æœ‰ä¸€ç³»åˆ—çš„å¯¼èˆªæ–¹æ³•ï¼›å¦‚"è·å–å¤§äº/ç­‰äºæŸå¯¹è±¡çš„é”®å€¼å¯¹"ã€â€œè·å–å°äº / ç­‰äºæŸå¯¹è±¡çš„é”®å€¼å¯¹â€ç­‰ç­‰ã€‚
- TreeMap ç»§æ‰¿äº AbstractMapï¼Œä¸”å®ç°äº† NavigableMap æ¥å£ï¼›å› æ­¤ï¼ŒTreeMap ä¸­çš„å†…å®¹æ˜¯â€œæœ‰åºçš„é”®å€¼å¯¹â€ï¼
- HashMap ç»§æ‰¿äº AbstractMapï¼Œä½†æ²¡å®ç° NavigableMap æ¥å£ï¼›å› æ­¤ï¼ŒHashMap çš„å†…å®¹æ˜¯â€œé”®å€¼å¯¹ï¼Œä½†ä¸ä¿è¯æ¬¡åºâ€ï¼
- Hashtable è™½ç„¶ä¸æ˜¯ç»§æ‰¿äº AbstractMapï¼Œä½†å®ƒç»§æ‰¿äº Dictionary(Dictionary ä¹Ÿæ˜¯é”®å€¼å¯¹çš„æ¥å£)ï¼Œè€Œä¸”ä¹Ÿå®ç° Map æ¥å£ï¼›å› æ­¤ï¼ŒHashtable çš„å†…å®¹ä¹Ÿæ˜¯â€œé”®å€¼å¯¹ï¼Œä¹Ÿä¸ä¿è¯æ¬¡åºâ€ã€‚ä½†å’Œ HashMap ç›¸æ¯”ï¼ŒHashtable æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè€Œä¸”å®ƒæ”¯æŒé€šè¿‡ Enumeration å»éå†ã€‚
- WeakHashMap ç»§æ‰¿äº AbstractMapã€‚å®ƒå’Œ HashMap çš„é”®ç±»å‹ä¸åŒï¼ŒWeakHashMap çš„é”®æ˜¯â€œå¼±é”®â€ã€‚

åœ¨ JDK1.6 ä¸­, æ–°æ·»åŠ çš„èŠ‚ç‚¹æ˜¯æ”¾åœ¨å¤´èŠ‚ç‚¹, JDK1.8 åˆ™æ˜¯æ”¾åœ¨å°¾èŠ‚ç‚¹çš„
JDK1.8 ä¸­, å¦‚æœé“¾è¡¨è¶³å¤Ÿå¤§æ—¶, å°†è‡ªåŠ¨è½¬æ¢æˆçº¢é»‘æ ‘ä¿å­˜

#### API

```java
abstract void                 clear()
abstract boolean              containsKey(Object key)
abstract boolean              containsValue(Object value)
abstract Set<Entry<K, V>>     entrySet()
abstract boolean              equals(Object object)
abstract V                    get(Object key)
abstract int                  hashCode()
abstract boolean              isEmpty()
abstract Set<K>               keySet()
abstract V                    put(K key, V value)
abstract void                 putAll(Map<? extends K, ? extends V> map)
abstract V                    remove(Object key)
abstract int                  size()
abstract Collection<V>        values()
````

è¯´æ˜ï¼š

- Map æä¾›æ¥å£åˆ†åˆ«ç”¨äºè¿”å› é”®é›†ã€å€¼é›†æˆ–é”® - å€¼æ˜ å°„å…³ç³»é›†ã€‚
  - entrySet() ç”¨äºè¿”å›é”® - å€¼é›†çš„ Set é›†åˆ
  - keySet() ç”¨äºè¿”å›é”®é›†çš„ Set é›†åˆ
  - values() ç”¨æˆ·è¿”å›å€¼é›†çš„ Collection é›†åˆ
- å› ä¸º Map ä¸­ä¸èƒ½åŒ…å«é‡å¤çš„é”®ï¼›æ¯ä¸ªé”®æœ€å¤šåªèƒ½æ˜ å°„åˆ°ä¸€ä¸ªå€¼ã€‚æ‰€ä»¥ï¼Œé”® - å€¼é›†ã€é”®é›†éƒ½æ˜¯ Setï¼Œå€¼é›†æ—¶ Collectionã€‚
- Map æä¾›äº†â€œé”® - å€¼å¯¹â€ã€â€œæ ¹æ®é”®è·å–å€¼â€ã€â€œåˆ é™¤é”®â€ã€â€œè·å–å®¹é‡å¤§å°â€ç­‰æ–¹æ³•ã€‚

#### HashMap

HashMap æ˜¯ä¸€ä¸ªæ•£åˆ—è¡¨ï¼Œå®ƒå­˜å‚¨çš„å†…å®¹æ˜¯é”®å€¼å¯¹ (key-value) æ˜ å°„ã€‚
HashMap ç»§æ‰¿äº AbstractMapï¼Œå®ç°äº† Mapã€Cloneableã€java.io.Serializable æ¥å£ã€‚
HashMap çš„å®ç°ä¸æ˜¯åŒæ­¥çš„ï¼Œè¿™æ„å‘³ç€å®ƒä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å®ƒçš„ keyã€value éƒ½å¯ä»¥ä¸º nullã€‚æ­¤å¤–ï¼ŒHashMap ä¸­çš„æ˜ å°„ä¸æ˜¯æœ‰åºçš„ã€‚

HashMap çš„å®ä¾‹æœ‰ä¸¤ä¸ªå‚æ•°å½±å“å…¶æ€§èƒ½ï¼šâ€œåˆå§‹å®¹é‡â€ å’Œ â€œåŠ è½½å› å­â€ã€‚å®¹é‡ æ˜¯å“ˆå¸Œè¡¨ä¸­æ¡¶çš„æ•°é‡ï¼Œåˆå§‹å®¹é‡ åªæ˜¯å“ˆå¸Œè¡¨åœ¨åˆ›å»ºæ—¶çš„å®¹é‡ã€‚åŠ è½½å› å­
æ˜¯å“ˆå¸Œè¡¨åœ¨å…¶å®¹é‡è‡ªåŠ¨å¢åŠ ä¹‹å‰å¯ä»¥è¾¾åˆ°å¤šæ»¡çš„ä¸€ç§å°ºåº¦ã€‚å½“å“ˆå¸Œè¡¨ä¸­çš„æ¡ç›®æ•°è¶…å‡ºäº†åŠ è½½å› å­ä¸å½“å‰å®¹é‡çš„ä¹˜ç§¯æ—¶ï¼Œåˆ™è¦å¯¹è¯¥å“ˆå¸Œè¡¨è¿›è¡Œ rehash
æ“ä½œï¼ˆå³é‡å»ºå†…éƒ¨æ•°æ®ç»“æ„ï¼‰ï¼Œä»è€Œå“ˆå¸Œè¡¨å°†å…·æœ‰å¤§çº¦ä¸¤å€çš„æ¡¶æ•°ã€‚
é€šå¸¸ï¼Œé»˜è®¤åŠ è½½å› å­æ˜¯ 0.75, è¿™æ˜¯åœ¨æ—¶é—´å’Œç©ºé—´æˆæœ¬ä¸Šå¯»æ±‚ä¸€ç§æŠ˜è¡·ã€‚åŠ è½½å› å­è¿‡é«˜è™½ç„¶å‡å°‘äº†ç©ºé—´å¼€é”€ï¼Œä½†åŒæ—¶ä¹Ÿå¢åŠ äº†æŸ¥è¯¢æˆæœ¬ï¼ˆåœ¨å¤§å¤šæ•° HashMap ç±»çš„æ“ä½œä¸­ï¼ŒåŒ…æ‹¬
get å’Œ put æ“ä½œï¼Œéƒ½åæ˜ äº†è¿™ä¸€ç‚¹ï¼‰ã€‚åœ¨è®¾ç½®åˆå§‹å®¹é‡æ—¶åº”è¯¥è€ƒè™‘åˆ°æ˜ å°„ä¸­æ‰€éœ€çš„æ¡ç›®æ•°åŠå…¶åŠ è½½å› å­ï¼Œä»¥ä¾¿æœ€å¤§é™åº¦åœ°å‡å°‘ rehash
æ“ä½œæ¬¡æ•°ã€‚å¦‚æœåˆå§‹å®¹é‡å¤§äºæœ€å¤§æ¡ç›®æ•°é™¤ä»¥åŠ è½½å› å­ï¼Œåˆ™ä¸ä¼šå‘ç”Ÿ rehash æ“ä½œã€‚

![20241229154732_a4vnHC05.webp](https://cdn.dong4j.site/source/image/20241229154732_a4vnHC05.webp)

```java
package java.util;
import java.io.*;

public class HashMap<K,V>
    extends AbstractMap<K,V>
    implements Map<K,V>, Cloneable, Serializable
{

    // é»˜è®¤çš„åˆå§‹å®¹é‡æ˜¯ 16ï¼Œå¿…é¡»æ˜¯ 2 çš„å¹‚ã€‚
    static final int DEFAULT_INITIAL_CAPACITY = 16;

    // æœ€å¤§å®¹é‡ï¼ˆå¿…é¡»æ˜¯ 2 çš„å¹‚ä¸”å°äº 2 çš„ 30 æ¬¡æ–¹ï¼Œä¼ å…¥å®¹é‡è¿‡å¤§å°†è¢«è¿™ä¸ªå€¼æ›¿æ¢ï¼‰
    static final int MAXIMUM_CAPACITY = 1 << 30;

    // é»˜è®¤åŠ è½½å› å­
    static final float DEFAULT_LOAD_FACTOR = 0.75f;

    // å­˜å‚¨æ•°æ®çš„ Entry æ•°ç»„ï¼Œé•¿åº¦æ˜¯ 2 çš„å¹‚ã€‚
    // HashMap æ˜¯é‡‡ç”¨æ‹‰é“¾æ³•å®ç°çš„ï¼Œæ¯ä¸€ä¸ª Entry æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨
    transient Entry[] table;

    // HashMap çš„å¤§å°ï¼Œå®ƒæ˜¯ HashMap ä¿å­˜çš„é”®å€¼å¯¹çš„æ•°é‡
    transient int size;

    // HashMap çš„é˜ˆå€¼ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒæ•´ HashMap çš„å®¹é‡ï¼ˆthreshold = å®¹é‡ * åŠ è½½å› å­ï¼‰
    int threshold;

    // åŠ è½½å› å­å®é™…å¤§å°
    final float loadFactor;

    // HashMap è¢«æ”¹å˜çš„æ¬¡æ•°
    transient volatile int modCount;

    // æŒ‡å®šâ€œå®¹é‡å¤§å°â€å’Œâ€œåŠ è½½å› å­â€çš„æ„é€ å‡½æ•°
    public HashMap(int initialCapacity, float loadFactor) {
        if (initialCapacity < 0)
            throw new IllegalArgumentException("Illegal initial capacity: " +
                                               initialCapacity);
        // HashMap çš„æœ€å¤§å®¹é‡åªèƒ½æ˜¯ MAXIMUM_CAPACITY
        if (initialCapacity > MAXIMUM_CAPACITY)
            initialCapacity = MAXIMUM_CAPACITY;
        if (loadFactor <= 0 || Float.isNaN(loadFactor))
            throw new IllegalArgumentException("Illegal load factor: " +
                                               loadFactor);

        // æ‰¾å‡ºâ€œå¤§äº initialCapacityâ€çš„æœ€å°çš„ 2 çš„å¹‚
        int capacity = 1;
        while (capacity < initialCapacity)
            capacity <<= 1;

        // è®¾ç½®â€œåŠ è½½å› å­â€
        this.loadFactor = loadFactor;
        // è®¾ç½®â€œHashMap é˜ˆå€¼â€ï¼Œå½“ HashMap ä¸­å­˜å‚¨æ•°æ®çš„æ•°é‡è¾¾åˆ° threshold æ—¶ï¼Œå°±éœ€è¦å°† HashMap çš„å®¹é‡åŠ å€ã€‚
        threshold = (int)(capacity * loadFactor);
        // åˆ›å»º Entry æ•°ç»„ï¼Œç”¨æ¥ä¿å­˜æ•°æ®
        table = new Entry[capacity];
        init();
    }


    // æŒ‡å®šâ€œå®¹é‡å¤§å°â€çš„æ„é€ å‡½æ•°
    public HashMap(int initialCapacity) {
        this(initialCapacity, DEFAULT_LOAD_FACTOR);
    }

    // é»˜è®¤æ„é€ å‡½æ•°ã€‚
    public HashMap() {
        // è®¾ç½®â€œåŠ è½½å› å­â€
        this.loadFactor = DEFAULT_LOAD_FACTOR;
        // è®¾ç½®â€œHashMap é˜ˆå€¼â€ï¼Œå½“ HashMap ä¸­å­˜å‚¨æ•°æ®çš„æ•°é‡è¾¾åˆ° threshold æ—¶ï¼Œå°±éœ€è¦å°† HashMap çš„å®¹é‡åŠ å€ã€‚
        threshold = (int)(DEFAULT_INITIAL_CAPACITY * DEFAULT_LOAD_FACTOR);
        // åˆ›å»º Entry æ•°ç»„ï¼Œç”¨æ¥ä¿å­˜æ•°æ®
        table = new Entry[DEFAULT_INITIAL_CAPACITY];
        init();
    }

    // åŒ…å«â€œå­ Mapâ€çš„æ„é€ å‡½æ•°
    public HashMap(Map<? extends K, ? extends V> m) {
        this(Math.max((int) (m.size() / DEFAULT_LOAD_FACTOR) + 1,
                      DEFAULT_INITIAL_CAPACITY), DEFAULT_LOAD_FACTOR);
        // å°† m ä¸­çš„å…¨éƒ¨å…ƒç´ é€ä¸ªæ·»åŠ åˆ° HashMap ä¸­
        putAllForCreate(m);
    }

    static int hash(int h) {
        h ^= (h >>> 20) ^ (h >>> 12);
        return h ^ (h >>> 7) ^ (h >>> 4);
    }

    // è¿”å›ç´¢å¼•å€¼
    // h & (length-1) ä¿è¯è¿”å›å€¼çš„å°äº length
    static int indexFor(int h, int length) {
        return h & (length-1);
    }

    public int size() {
        return size;
    }

    public boolean isEmpty() {
        return size == 0;
    }

    // è·å– key å¯¹åº”çš„ value
    public V get(Object key) {
        if (key == null)
            return getForNullKey();
        // è·å– key çš„ hash å€¼
        int hash = hash(key.hashCode());
        // åœ¨â€œè¯¥ hash å€¼å¯¹åº”çš„é“¾è¡¨â€ä¸ŠæŸ¥æ‰¾â€œé”®å€¼ç­‰äº keyâ€çš„å…ƒç´ 
        for (Entry<K,V> e = table[indexFor(hash, table.length)];
             e != null;
             e = e.next) {
            Object k;
            if (e.hash == hash && ((k = e.key) == key || key.equals(k)))
                return e.value;
        }
        return null;
    }

    // è·å–â€œkey ä¸º nullâ€çš„å…ƒç´ çš„å€¼
    // HashMap å°†â€œkey ä¸º nullâ€çš„å…ƒç´ å­˜å‚¨åœ¨ table[0] ä½ç½®ï¼
    private V getForNullKey() {
        for (Entry<K,V> e = table[0]; e != null; e = e.next) {
            if (e.key == null)
                return e.value;
        }
        return null;
    }

    // HashMap æ˜¯å¦åŒ…å« key
    public boolean containsKey(Object key) {
        return getEntry(key) != null;
    }

    // è¿”å›â€œé”®ä¸º keyâ€çš„é”®å€¼å¯¹
    final Entry<K,V> getEntry(Object key) {
        // è·å–å“ˆå¸Œå€¼
        // HashMap å°†â€œkey ä¸º nullâ€çš„å…ƒç´ å­˜å‚¨åœ¨ table[0] ä½ç½®ï¼Œâ€œkey ä¸ä¸º nullâ€çš„åˆ™è°ƒç”¨ hash() è®¡ç®—å“ˆå¸Œå€¼
        int hash = (key == null) ? 0 : hash(key.hashCode());
        // åœ¨â€œè¯¥ hash å€¼å¯¹åº”çš„é“¾è¡¨â€ä¸ŠæŸ¥æ‰¾â€œé”®å€¼ç­‰äº keyâ€çš„å…ƒç´ 
        for (Entry<K,V> e = table[indexFor(hash, table.length)];
             e != null;
             e = e.next) {
            Object k;
            if (e.hash == hash &&
                ((k = e.key) == key || (key != null && key.equals(k))))
                return e;
        }
        return null;
    }

    // å°†â€œkey-valueâ€æ·»åŠ åˆ° HashMap ä¸­
    public V put(K key, V value) {
        // è‹¥â€œkey ä¸º nullâ€ï¼Œåˆ™å°†è¯¥é”®å€¼å¯¹æ·»åŠ åˆ° table[0] ä¸­ã€‚
        if (key == null)
            return putForNullKey(value);
        // è‹¥â€œkey ä¸ä¸º nullâ€ï¼Œåˆ™è®¡ç®—è¯¥ key çš„å“ˆå¸Œå€¼ï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°è¯¥å“ˆå¸Œå€¼å¯¹åº”çš„é“¾è¡¨ä¸­ã€‚
        int hash = hash(key.hashCode());
        int i = indexFor(hash, table.length);
        for (Entry<K,V> e = table[i]; e != null; e = e.next) {
            Object k;
            // è‹¥â€œè¯¥ keyâ€å¯¹åº”çš„é”®å€¼å¯¹å·²ç»å­˜åœ¨ï¼Œåˆ™ç”¨æ–°çš„ value å–ä»£æ—§çš„ valueã€‚ç„¶åé€€å‡ºï¼
            if (e.hash == hash && ((k = e.key) == key || key.equals(k))) {
                V oldValue = e.value;
                e.value = value;
                e.recordAccess(this);
                return oldValue;
            }
        }

        // è‹¥â€œè¯¥ keyâ€å¯¹åº”çš„é”®å€¼å¯¹ä¸å­˜åœ¨ï¼Œåˆ™å°†â€œkey-valueâ€æ·»åŠ åˆ° table ä¸­
        modCount++;
        addEntry(hash, key, value, i);
        return null;
    }

    // putForNullKey()çš„ä½œç”¨æ˜¯å°†â€œkey ä¸º nullâ€é”®å€¼å¯¹æ·»åŠ åˆ° table[0] ä½ç½®
    private V putForNullKey(V value) {
        for (Entry<K,V> e = table[0]; e != null; e = e.next) {
            if (e.key == null) {
                V oldValue = e.value;
                e.value = value;
                e.recordAccess(this);
                return oldValue;
            }
        }
        // è¿™é‡Œçš„å®Œå…¨ä¸ä¼šè¢«æ‰§è¡Œåˆ°!
        modCount++;
        addEntry(0, null, value, 0);
        return null;
    }

    // åˆ›å»º HashMap å¯¹åº”çš„â€œæ·»åŠ æ–¹æ³•â€ï¼Œ
    // å®ƒå’Œ put()ä¸åŒã€‚putForCreate() æ˜¯å†…éƒ¨æ–¹æ³•ï¼Œå®ƒè¢«æ„é€ å‡½æ•°ç­‰è°ƒç”¨ï¼Œç”¨æ¥åˆ›å»º HashMap
    // è€Œ put() æ˜¯å¯¹å¤–æä¾›çš„å¾€ HashMap ä¸­æ·»åŠ å…ƒç´ çš„æ–¹æ³•ã€‚
    private void putForCreate(K key, V value) {
        int hash = (key == null) ? 0 : hash(key.hashCode());
        int i = indexFor(hash, table.length);

        // è‹¥è¯¥ HashMap è¡¨ä¸­å­˜åœ¨â€œé”®å€¼ç­‰äº keyâ€çš„å…ƒç´ ï¼Œåˆ™æ›¿æ¢è¯¥å…ƒç´ çš„ value å€¼
        for (Entry<K,V> e = table[i]; e != null; e = e.next) {
            Object k;
            if (e.hash == hash &&
                ((k = e.key) == key || (key != null && key.equals(k)))) {
                e.value = value;
                return;
            }
        }

        // è‹¥è¯¥ HashMap è¡¨ä¸­ä¸å­˜åœ¨â€œé”®å€¼ç­‰äº keyâ€çš„å…ƒç´ ï¼Œåˆ™å°†è¯¥ key-value æ·»åŠ åˆ° HashMap ä¸­
        createEntry(hash, key, value, i);
    }

    // å°†â€œmâ€ä¸­çš„å…¨éƒ¨å…ƒç´ éƒ½æ·»åŠ åˆ° HashMap ä¸­ã€‚
    // è¯¥æ–¹æ³•è¢«å†…éƒ¨çš„æ„é€  HashMap çš„æ–¹æ³•æ‰€è°ƒç”¨ã€‚
    private void putAllForCreate(Map<? extends K, ? extends V> m) {
        // åˆ©ç”¨è¿­ä»£å™¨å°†å…ƒç´ é€ä¸ªæ·»åŠ åˆ° HashMap ä¸­
        for (Iterator<? extends Map.Entry<? extends K, ? extends V>> i = m.entrySet().iterator(); i.hasNext(); ) {
            Map.Entry<? extends K, ? extends V> e = i.next();
            putForCreate(e.getKey(), e.getValue());
        }
    }

    // é‡æ–°è°ƒæ•´ HashMap çš„å¤§å°ï¼ŒnewCapacity æ˜¯è°ƒæ•´åçš„å•ä½
    void resize(int newCapacity) {
        Entry[] oldTable = table;
        int oldCapacity = oldTable.length;
        if (oldCapacity == MAXIMUM_CAPACITY) {
            threshold = Integer.MAX_VALUE;
            return;
        }

        // æ–°å»ºä¸€ä¸ª HashMapï¼Œå°†â€œæ—§ HashMapâ€çš„å…¨éƒ¨å…ƒç´ æ·»åŠ åˆ°â€œæ–° HashMapâ€ä¸­ï¼Œ
        // ç„¶åï¼Œå°†â€œæ–° HashMapâ€èµ‹å€¼ç»™â€œæ—§ HashMapâ€ã€‚
        Entry[] newTable = new Entry[newCapacity];
        transfer(newTable);
        table = newTable;
        threshold = (int)(newCapacity * loadFactor);
    }

    // å°† HashMap ä¸­çš„å…¨éƒ¨å…ƒç´ éƒ½æ·»åŠ åˆ° newTable ä¸­
    void transfer(Entry[] newTable) {
        Entry[] src = table;
        int newCapacity = newTable.length;
        for (int j = 0; j < src.length; j++) {
            Entry<K,V> e = src[j];
            if (e != null) {
                src[j] = null;
                do {
                    Entry<K,V> next = e.next;
                    int i = indexFor(e.hash, newCapacity);
                    e.next = newTable[i];
                    newTable[i] = e;
                    e = next;
                } while (e != null);
            }
        }
    }

    // å°†"m"çš„å…¨éƒ¨å…ƒç´ éƒ½æ·»åŠ åˆ° HashMap ä¸­
    public void putAll(Map<? extends K, ? extends V> m) {
        // æœ‰æ•ˆæ€§åˆ¤æ–­
        int numKeysToBeAdded = m.size();
        if (numKeysToBeAdded == 0)
            return;

        // è®¡ç®—å®¹é‡æ˜¯å¦è¶³å¤Ÿï¼Œ
        // è‹¥â€œå½“å‰å®é™…å®¹é‡ < éœ€è¦çš„å®¹é‡â€ï¼Œåˆ™å°†å®¹é‡ x2ã€‚
        if (numKeysToBeAdded > threshold) {
            int targetCapacity = (int)(numKeysToBeAdded / loadFactor + 1);
            if (targetCapacity > MAXIMUM_CAPACITY)
                targetCapacity = MAXIMUM_CAPACITY;
            int newCapacity = table.length;
            while (newCapacity < targetCapacity)
                newCapacity <<= 1;
            if (newCapacity > table.length)
                resize(newCapacity);
        }

        // é€šè¿‡è¿­ä»£å™¨ï¼Œå°†â€œmâ€ä¸­çš„å…ƒç´ é€ä¸ªæ·»åŠ åˆ° HashMap ä¸­ã€‚
        for (Iterator<? extends Map.Entry<? extends K, ? extends V>> i = m.entrySet().iterator(); i.hasNext(); ) {
            Map.Entry<? extends K, ? extends V> e = i.next();
            put(e.getKey(), e.getValue());
        }
    }

    // åˆ é™¤â€œé”®ä¸º keyâ€å…ƒç´ 
    public V remove(Object key) {
        Entry<K,V> e = removeEntryForKey(key);
        return (e == null ? null : e.value);
    }

    // åˆ é™¤â€œé”®ä¸º keyâ€çš„å…ƒç´ 
    final Entry<K,V> removeEntryForKey(Object key) {
        // è·å–å“ˆå¸Œå€¼ã€‚è‹¥ key ä¸º nullï¼Œåˆ™å“ˆå¸Œå€¼ä¸º 0ï¼›å¦åˆ™è°ƒç”¨ hash() è¿›è¡Œè®¡ç®—
        int hash = (key == null) ? 0 : hash(key.hashCode());
        int i = indexFor(hash, table.length);
        Entry<K,V> prev = table[i];
        Entry<K,V> e = prev;

        // åˆ é™¤é“¾è¡¨ä¸­â€œé”®ä¸º keyâ€çš„å…ƒç´ 
        // æœ¬è´¨æ˜¯â€œåˆ é™¤å•å‘é“¾è¡¨ä¸­çš„èŠ‚ç‚¹â€
        while (e != null) {
            Entry<K,V> next = e.next;
            Object k;
            if (e.hash == hash &&
                ((k = e.key) == key || (key != null && key.equals(k)))) {
                modCount++;
                size--;
                if (prev == e)
                    table[i] = next;
                else
                    prev.next = next;
                e.recordRemoval(this);
                return e;
            }
            prev = e;
            e = next;
        }

        return e;
    }

    // åˆ é™¤â€œé”®å€¼å¯¹â€
    final Entry<K,V> removeMapping(Object o) {
        if (!(o instanceof Map.Entry))
            return null;

        Map.Entry<K,V> entry = (Map.Entry<K,V>) o;
        Object key = entry.getKey();
        int hash = (key == null) ? 0 : hash(key.hashCode());
        int i = indexFor(hash, table.length);
        Entry<K,V> prev = table[i];
        Entry<K,V> e = prev;

        // åˆ é™¤é“¾è¡¨ä¸­çš„â€œé”®å€¼å¯¹ eâ€
        // æœ¬è´¨æ˜¯â€œåˆ é™¤å•å‘é“¾è¡¨ä¸­çš„èŠ‚ç‚¹â€
        while (e != null) {
            Entry<K,V> next = e.next;
            if (e.hash == hash && e.equals(entry)) {
                modCount++;
                size--;
                if (prev == e)
                    table[i] = next;
                else
                    prev.next = next;
                e.recordRemoval(this);
                return e;
            }
            prev = e;
            e = next;
        }

        return e;
    }

    // æ¸…ç©º HashMapï¼Œå°†æ‰€æœ‰çš„å…ƒç´ è®¾ä¸º null
    public void clear() {
        modCount++;
        Entry[] tab = table;
        for (int i = 0; i < tab.length; i++)
            tab[i] = null;
        size = 0;
    }

    // æ˜¯å¦åŒ…å«â€œå€¼ä¸º valueâ€çš„å…ƒç´ 
    public boolean containsValue(Object value) {
    // è‹¥â€œvalue ä¸º nullâ€ï¼Œåˆ™è°ƒç”¨ containsNullValue() æŸ¥æ‰¾
    if (value == null)
            return containsNullValue();

    // è‹¥â€œvalue ä¸ä¸º nullâ€ï¼Œåˆ™æŸ¥æ‰¾ HashMap ä¸­æ˜¯å¦æœ‰å€¼ä¸º value çš„èŠ‚ç‚¹ã€‚
    Entry[] tab = table;
        for (int i = 0; i < tab.length ; i++)
            for (Entry e = tab[i] ; e != null ; e = e.next)
                if (value.equals(e.value))
                    return true;
    return false;
    }

    // æ˜¯å¦åŒ…å« null å€¼
    private boolean containsNullValue() {
    Entry[] tab = table;
        for (int i = 0; i < tab.length ; i++)
            for (Entry e = tab[i] ; e != null ; e = e.next)
                if (e.value == null)
                    return true;
    return false;
    }

    // å…‹éš†ä¸€ä¸ª HashMapï¼Œå¹¶è¿”å› Object å¯¹è±¡
    public Object clone() {
        HashMap<K,V> result = null;
        try {
            result = (HashMap<K,V>)super.clone();
        } catch (CloneNotSupportedException e) {
            // assert false;
        }
        result.table = new Entry[table.length];
        result.entrySet = null;
        result.modCount = 0;
        result.size = 0;
        result.init();
        // è°ƒç”¨ putAllForCreate() å°†å…¨éƒ¨å…ƒç´ æ·»åŠ åˆ° HashMap ä¸­
        result.putAllForCreate(this);

        return result;
    }

    // Entry æ˜¯å•å‘é“¾è¡¨ã€‚
    // å®ƒæ˜¯ â€œHashMap é“¾å¼å­˜å‚¨æ³•â€å¯¹åº”çš„é“¾è¡¨ã€‚
    // å®ƒå®ç°äº† Map.Entry æ¥å£ï¼Œå³å®ç° getKey(), getValue(), setValue(V value), equals(Object o), hashCode() è¿™äº›å‡½æ•°
    static class Entry<K,V> implements Map.Entry<K,V> {
        final K key;
        V value;
        // æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
        Entry<K,V> next;
        final int hash;

        // æ„é€ å‡½æ•°ã€‚
        // è¾“å…¥å‚æ•°åŒ…æ‹¬"å“ˆå¸Œå€¼(h)", "é”®(k)", "å€¼(v)", "ä¸‹ä¸€èŠ‚ç‚¹(n)"
        Entry(int h, K k, V v, Entry<K,V> n) {
            value = v;
            next = n;
            key = k;
            hash = h;
        }

        public final K getKey() {
            return key;
        }

        public final V getValue() {
            return value;
        }

        public final V setValue(V newValue) {
            V oldValue = value;
            value = newValue;
            return oldValue;
        }

        // åˆ¤æ–­ä¸¤ä¸ª Entry æ˜¯å¦ç›¸ç­‰
        // è‹¥ä¸¤ä¸ª Entry çš„â€œkeyâ€å’Œâ€œvalueâ€éƒ½ç›¸ç­‰ï¼Œåˆ™è¿”å› trueã€‚
        // å¦åˆ™ï¼Œè¿”å› false
        public final boolean equals(Object o) {
            if (!(o instanceof Map.Entry))
                return false;
            Map.Entry e = (Map.Entry)o;
            Object k1 = getKey();
            Object k2 = e.getKey();
            if (k1 == k2 || (k1 != null && k1.equals(k2))) {
                Object v1 = getValue();
                Object v2 = e.getValue();
                if (v1 == v2 || (v1 != null && v1.equals(v2)))
                    return true;
            }
            return false;
        }

        // å®ç° hashCode()
        public final int hashCode() {
            return (key==null   ? 0 : key.hashCode()) ^
                   (value==null ? 0 : value.hashCode());
        }

        public final String toString() {
            return getKey() + "=" + getValue();
        }

        // å½“å‘ HashMap ä¸­æ·»åŠ å…ƒç´ æ—¶ï¼Œç»˜è°ƒç”¨ recordAccess()ã€‚
        // è¿™é‡Œä¸åšä»»ä½•å¤„ç†
        void recordAccess(HashMap<K,V> m) {
        }

        // å½“ä» HashMap ä¸­åˆ é™¤å…ƒç´ æ—¶ï¼Œç»˜è°ƒç”¨ recordRemoval()ã€‚
        // è¿™é‡Œä¸åšä»»ä½•å¤„ç†
        void recordRemoval(HashMap<K,V> m) {
        }
    }

    // æ–°å¢ Entryã€‚å°†â€œkey-valueâ€æ’å…¥æŒ‡å®šä½ç½®ï¼ŒbucketIndex æ˜¯ä½ç½®ç´¢å¼•ã€‚
    void addEntry(int hash, K key, V value, int bucketIndex) {
        // ä¿å­˜â€œbucketIndexâ€ä½ç½®çš„å€¼åˆ°â€œeâ€ä¸­
        Entry<K,V> e = table[bucketIndex];
        // è®¾ç½®â€œbucketIndexâ€ä½ç½®çš„å…ƒç´ ä¸ºâ€œæ–° Entryâ€ï¼Œ
        // è®¾ç½®â€œeâ€ä¸ºâ€œæ–° Entry çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹â€
        table[bucketIndex] = new Entry<K,V>(hash, key, value, e);
        // è‹¥ HashMap çš„å®é™…å¤§å° ä¸å°äº â€œé˜ˆå€¼â€ï¼Œåˆ™è°ƒæ•´ HashMap çš„å¤§å°
        if (size++ >= threshold)
            resize(2 * table.length);
    }

    // åˆ›å»º Entryã€‚å°†â€œkey-valueâ€æ’å…¥æŒ‡å®šä½ç½®ï¼ŒbucketIndex æ˜¯ä½ç½®ç´¢å¼•ã€‚
    // å®ƒå’Œ addEntry çš„åŒºåˆ«æ˜¯ï¼š
    // (01) addEntry() ä¸€èˆ¬ç”¨åœ¨ æ–°å¢ Entry å¯èƒ½å¯¼è‡´â€œHashMap çš„å®é™…å®¹é‡â€è¶…è¿‡â€œé˜ˆå€¼â€çš„æƒ…å†µä¸‹ã€‚
    //   ä¾‹å¦‚ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª HashMapï¼Œç„¶åä¸æ–­é€šè¿‡ put() å‘ HashMap ä¸­æ·»åŠ å…ƒç´ ï¼›
    // put()æ˜¯é€šè¿‡ addEntry() æ–°å¢ Entry çš„ã€‚
    //   åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸çŸ¥é“ä½•æ—¶â€œHashMap çš„å®é™…å®¹é‡â€ä¼šè¶…è¿‡â€œé˜ˆå€¼â€ï¼›
    //   å› æ­¤ï¼Œéœ€è¦è°ƒç”¨ addEntry()
    // (02) createEntry() ä¸€èˆ¬ç”¨åœ¨ æ–°å¢ Entry ä¸ä¼šå¯¼è‡´â€œHashMap çš„å®é™…å®¹é‡â€è¶…è¿‡â€œé˜ˆå€¼â€çš„æƒ…å†µä¸‹ã€‚
    //   ä¾‹å¦‚ï¼Œæˆ‘ä»¬è°ƒç”¨ HashMapâ€œå¸¦æœ‰ Mapâ€çš„æ„é€ å‡½æ•°ï¼Œå®ƒç»˜å°† Map çš„å…¨éƒ¨å…ƒç´ æ·»åŠ åˆ° HashMap ä¸­ï¼›
    // ä½†åœ¨æ·»åŠ ä¹‹å‰ï¼Œæˆ‘ä»¬å·²ç»è®¡ç®—å¥½â€œHashMap çš„å®¹é‡å’Œé˜ˆå€¼â€ã€‚ä¹Ÿå°±æ˜¯ï¼Œå¯ä»¥ç¡®å®šâ€œå³ä½¿å°† Map ä¸­
    // çš„å…¨éƒ¨å…ƒç´ æ·»åŠ åˆ° HashMap ä¸­ï¼Œéƒ½ä¸ä¼šè¶…è¿‡ HashMap çš„é˜ˆå€¼â€ã€‚
    //   æ­¤æ—¶ï¼Œè°ƒç”¨ createEntry() å³å¯ã€‚
    void createEntry(int hash, K key, V value, int bucketIndex) {
        // ä¿å­˜â€œbucketIndexâ€ä½ç½®çš„å€¼åˆ°â€œeâ€ä¸­
        Entry<K,V> e = table[bucketIndex];
        // è®¾ç½®â€œbucketIndexâ€ä½ç½®çš„å…ƒç´ ä¸ºâ€œæ–° Entryâ€ï¼Œ
        // è®¾ç½®â€œeâ€ä¸ºâ€œæ–° Entry çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹â€
        table[bucketIndex] = new Entry<K,V>(hash, key, value, e);
        size++;
    }

    // HashIterator æ˜¯ HashMap è¿­ä»£å™¨çš„æŠ½è±¡å‡ºæ¥çš„çˆ¶ç±»ï¼Œå®ç°äº†å…¬å…±äº†å‡½æ•°ã€‚
    // å®ƒåŒ…å«â€œkey è¿­ä»£å™¨ (KeyIterator)â€ã€â€œValue è¿­ä»£å™¨ (ValueIterator)â€å’Œâ€œEntry è¿­ä»£å™¨ (EntryIterator)â€3 ä¸ªå­ç±»ã€‚
    private abstract class HashIterator<E> implements Iterator<E> {
        // ä¸‹ä¸€ä¸ªå…ƒç´ 
        Entry<K,V> next;
        // expectedModCount ç”¨äºå®ç° fast-fail æœºåˆ¶ã€‚
        int expectedModCount;
        // å½“å‰ç´¢å¼•
        int index;
        // å½“å‰å…ƒç´ 
        Entry<K,V> current;

        HashIterator() {
            expectedModCount = modCount;
            if (size > 0) { // advance to first entry
                Entry[] t = table;
                // å°† next æŒ‡å‘ table ä¸­ç¬¬ä¸€ä¸ªä¸ä¸º null çš„å…ƒç´ ã€‚
                // è¿™é‡Œåˆ©ç”¨äº† index çš„åˆå§‹å€¼ä¸º 0ï¼Œä» 0 å¼€å§‹ä¾æ¬¡å‘åéå†ï¼Œç›´åˆ°æ‰¾åˆ°ä¸ä¸º null çš„å…ƒç´ å°±é€€å‡ºå¾ªç¯ã€‚
                while (index < t.length && (next = t[index++]) == null)
                    ;
            }
        }

        public final boolean hasNext() {
            return next != null;
        }

        // è·å–ä¸‹ä¸€ä¸ªå…ƒç´ 
        final Entry<K,V> nextEntry() {
            if (modCount != expectedModCount)
                throw new ConcurrentModificationException();
            Entry<K,V> e = next;
            if (e == null)
                throw new NoSuchElementException();

            // æ³¨æ„ï¼ï¼ï¼
            // ä¸€ä¸ª Entry å°±æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨
            // è‹¥è¯¥ Entry çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œå°±å°† next æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹;
            // å¦åˆ™ï¼Œå°† next æŒ‡å‘ä¸‹ä¸€ä¸ªé“¾è¡¨ (ä¹Ÿæ˜¯ä¸‹ä¸€ä¸ª Entry) çš„ä¸ä¸º null çš„èŠ‚ç‚¹ã€‚
            if ((next = e.next) == null) {
                Entry[] t = table;
                while (index < t.length && (next = t[index++]) == null)
                    ;
            }
            current = e;
            return e;
        }

        // åˆ é™¤å½“å‰å…ƒç´ 
        public void remove() {
            if (current == null)
                throw new IllegalStateException();
            if (modCount != expectedModCount)
                throw new ConcurrentModificationException();
            Object k = current.key;
            current = null;
            HashMap.this.removeEntryForKey(k);
            expectedModCount = modCount;
        }

    }

    // value çš„è¿­ä»£å™¨
    private final class ValueIterator extends HashIterator<V> {
        public V next() {
            return nextEntry().value;
        }
    }

    // key çš„è¿­ä»£å™¨
    private final class KeyIterator extends HashIterator<K> {
        public K next() {
            return nextEntry().getKey();
        }
    }

    // Entry çš„è¿­ä»£å™¨
    private final class EntryIterator extends HashIterator<Map.Entry<K,V>> {
        public Map.Entry<K,V> next() {
            return nextEntry();
        }
    }

    // è¿”å›ä¸€ä¸ªâ€œkey è¿­ä»£å™¨â€
    Iterator<K> newKeyIterator()   {
        return new KeyIterator();
    }
    // è¿”å›ä¸€ä¸ªâ€œvalue è¿­ä»£å™¨â€
    Iterator<V> newValueIterator()   {
        return new ValueIterator();
    }
    // è¿”å›ä¸€ä¸ªâ€œentry è¿­ä»£å™¨â€
    Iterator<Map.Entry<K,V>> newEntryIterator()   {
        return new EntryIterator();
    }

    // HashMap çš„ Entry å¯¹åº”çš„é›†åˆ
    private transient Set<Map.Entry<K,V>> entrySet = null;

    // è¿”å›â€œkey çš„é›†åˆâ€ï¼Œå®é™…ä¸Šè¿”å›ä¸€ä¸ªâ€œKeySet å¯¹è±¡â€
    public Set<K> keySet() {
        Set<K> ks = keySet;
        return (ks != null ? ks : (keySet = new KeySet()));
    }

    // Key å¯¹åº”çš„é›†åˆ
    // KeySet ç»§æ‰¿äº AbstractSetï¼Œè¯´æ˜è¯¥é›†åˆä¸­æ²¡æœ‰é‡å¤çš„ Keyã€‚
    private final class KeySet extends AbstractSet<K> {
        public Iterator<K> iterator() {
            return newKeyIterator();
        }
        public int size() {
            return size;
        }
        public boolean contains(Object o) {
            return containsKey(o);
        }
        public boolean remove(Object o) {
            return HashMap.this.removeEntryForKey(o) != null;
        }
        public void clear() {
            HashMap.this.clear();
        }
    }

    // è¿”å›â€œvalue é›†åˆâ€ï¼Œå®é™…ä¸Šè¿”å›çš„æ˜¯ä¸€ä¸ª Values å¯¹è±¡
    public Collection<V> values() {
        Collection<V> vs = values;
        return (vs != null ? vs : (values = new Values()));
    }

    // â€œvalue é›†åˆâ€
    // Values ç»§æ‰¿äº AbstractCollectionï¼Œä¸åŒäºâ€œKeySet ç»§æ‰¿äº AbstractSetâ€ï¼Œ
    // Values ä¸­çš„å…ƒç´ èƒ½å¤Ÿé‡å¤ã€‚å› ä¸ºä¸åŒçš„ key å¯ä»¥æŒ‡å‘ç›¸åŒçš„ valueã€‚
    private final class Values extends AbstractCollection<V> {
        public Iterator<V> iterator() {
            return newValueIterator();
        }
        public int size() {
            return size;
        }
        public boolean contains(Object o) {
            return containsValue(o);
        }
        public void clear() {
            HashMap.this.clear();
        }
    }

    // è¿”å›â€œHashMap çš„ Entry é›†åˆâ€
    public Set<Map.Entry<K,V>> entrySet() {
        return entrySet0();
    }

    // è¿”å›â€œHashMap çš„ Entry é›†åˆâ€ï¼Œå®ƒå®é™…æ˜¯è¿”å›ä¸€ä¸ª EntrySet å¯¹è±¡
    private Set<Map.Entry<K,V>> entrySet0() {
        Set<Map.Entry<K,V>> es = entrySet;
        return es != null ? es : (entrySet = new EntrySet());
    }

    // EntrySet å¯¹åº”çš„é›†åˆ
    // EntrySet ç»§æ‰¿äº AbstractSetï¼Œè¯´æ˜è¯¥é›†åˆä¸­æ²¡æœ‰é‡å¤çš„ EntrySetã€‚
    private final class EntrySet extends AbstractSet<Map.Entry<K,V>> {
        public Iterator<Map.Entry<K,V>> iterator() {
            return newEntryIterator();
        }
        public boolean contains(Object o) {
            if (!(o instanceof Map.Entry))
                return false;
            Map.Entry<K,V> e = (Map.Entry<K,V>) o;
            Entry<K,V> candidate = getEntry(e.getKey());
            return candidate != null && candidate.equals(e);
        }
        public boolean remove(Object o) {
            return removeMapping(o) != null;
        }
        public int size() {
            return size;
        }
        public void clear() {
            HashMap.this.clear();
        }
    }

    // java.io.Serializable çš„å†™å…¥å‡½æ•°
    // å°† HashMap çš„â€œæ€»çš„å®¹é‡ï¼Œå®é™…å®¹é‡ï¼Œæ‰€æœ‰çš„ Entryâ€éƒ½å†™å…¥åˆ°è¾“å‡ºæµä¸­
    private void writeObject(java.io.ObjectOutputStream s)
        throws IOException
    {
        Iterator<Map.Entry<K,V>> i =
            (size > 0) ? entrySet0().iterator() : null;

        // Write out the threshold, loadfactor, and any hidden stuff
        s.defaultWriteObject();

        // Write out number of buckets
        s.writeInt(table.length);

        // Write out size (number of Mappings)
        s.writeInt(size);

        // Write out keys and values (alternating)
        if (i != null) {
            while (i.hasNext()) {
            Map.Entry<K,V> e = i.next();
            s.writeObject(e.getKey());
            s.writeObject(e.getValue());
            }
        }
    }


    private static final long serialVersionUID = 362498820763181265L;

    // java.io.Serializable çš„è¯»å–å‡½æ•°ï¼šæ ¹æ®å†™å…¥æ–¹å¼è¯»å‡º
    // å°† HashMap çš„â€œæ€»çš„å®¹é‡ï¼Œå®é™…å®¹é‡ï¼Œæ‰€æœ‰çš„ Entryâ€ä¾æ¬¡è¯»å‡º
    private void readObject(java.io.ObjectInputStream s)
         throws IOException, ClassNotFoundException
    {
        // Read in the threshold, loadfactor, and any hidden stuff
        s.defaultReadObject();

        // Read in number of buckets and allocate the bucket array;
        int numBuckets = s.readInt();
        table = new Entry[numBuckets];

        init();  // Give subclass a chance to do its thing.

        // Read in size (number of Mappings)
        int size = s.readInt();

        // Read the keys and values, and put the mappings in the HashMap
        for (int i=0; i<size; i++) {
            K key = (K) s.readObject();
            V value = (V) s.readObject();
            putForCreate(key, value);
        }
    }

    // è¿”å›â€œHashMap æ€»çš„å®¹é‡â€
    int   capacity(){return table.length;}
    // è¿”å›â€œHashMap çš„åŠ è½½å› å­â€
    float loadFactor(){return loadFactor;}
}
```

##### éå†

éå† HashMap çš„é”®å€¼å¯¹:

```java
// å‡è®¾ map æ˜¯ HashMap å¯¹è±¡
// map ä¸­çš„ key æ˜¯ String ç±»å‹ï¼Œvalue æ˜¯ Integer ç±»å‹
Integer integ = null;
Iterator iter = map.entrySet().iterator();
while(iter.hasNext()) {
    Map.Entry entry = (Map.Entry)iter.next();
    // è·å– key
    key = (String)entry.getKey();
        // è·å– value
    integ = (Integer)entry.getValue();
}
```

éå† HashMap çš„é”®

```java
// å‡è®¾ map æ˜¯ HashMap å¯¹è±¡
// map ä¸­çš„ key æ˜¯ String ç±»å‹ï¼Œvalue æ˜¯ Integer ç±»å‹
String key = null;
Integer integ = null;
Iterator iter = map.keySet().iterator();
while (iter.hasNext()) {
        // è·å– key
    key = (String)iter.next();
        // æ ¹æ® keyï¼Œè·å– value
    integ = (Integer)map.get(key);
}
```

éå† HashMap çš„å€¼

```java
// å‡è®¾ map æ˜¯ HashMap å¯¹è±¡
// map ä¸­çš„ key æ˜¯ String ç±»å‹ï¼Œvalue æ˜¯ Integer ç±»å‹
Integer value = null;
Collection c = map.values();
Iterator iter= c.iterator();
while (iter.hasNext()) {
    value = (Integer)iter.next();
}
```

#### EnumMap

#### LinkedHashMap

#### TreeMap

- TreeMap æ˜¯ä¸€ä¸ªæœ‰åºçš„ key-value é›†åˆï¼Œå®ƒæ˜¯é€šè¿‡çº¢é»‘æ ‘å®ç°çš„ã€‚
- TreeMap ç»§æ‰¿äº AbstractMapï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ª Mapï¼Œå³ä¸€ä¸ª key-value é›†åˆã€‚
- TreeMap å®ç°äº† NavigableMap æ¥å£ï¼Œæ„å‘³ç€å®ƒæ”¯æŒä¸€ç³»åˆ—çš„å¯¼èˆªæ–¹æ³•ã€‚æ¯”å¦‚è¿”å›æœ‰åºçš„ key é›†åˆã€‚
- TreeMap å®ç°äº† Cloneable æ¥å£ï¼Œæ„å‘³ç€å®ƒèƒ½è¢«å…‹éš†ã€‚
- TreeMap å®ç°äº† java.io.Serializable æ¥å£ï¼Œæ„å‘³ç€å®ƒæ”¯æŒåºåˆ—åŒ–ã€‚

TreeMap åŸºäºçº¢é»‘æ ‘ï¼ˆRed-Black treeï¼‰å®ç°ã€‚è¯¥æ˜ å°„æ ¹æ®å…¶é”®çš„è‡ªç„¶é¡ºåºè¿›è¡Œæ’åºï¼Œæˆ–è€…æ ¹æ®åˆ›å»ºæ˜ å°„æ—¶æä¾›çš„ Comparator è¿›è¡Œæ’åºï¼Œå…·ä½“å–å†³äºä½¿ç”¨çš„æ„é€ æ–¹æ³•ã€‚
TreeMap çš„åŸºæœ¬æ“ä½œ containsKeyã€getã€put å’Œ remove çš„æ—¶é—´å¤æ‚åº¦æ˜¯ log(n) ã€‚
å¦å¤–ï¼ŒTreeMap æ˜¯éåŒæ­¥çš„ã€‚ å®ƒçš„ iterator æ–¹æ³•è¿”å›çš„è¿­ä»£å™¨æ˜¯ fail-fastl çš„ã€‚

![20241229154732_r35xXS3I.webp](https://cdn.dong4j.site/source/image/20241229154732_r35xXS3I.webp)

- TreeMap å®ç°ç»§æ‰¿äº AbstractMapï¼Œå¹¶ä¸”å®ç°äº† NavigableMap æ¥å£ã€‚
- TreeMap çš„æœ¬è´¨æ˜¯ R-B Tree(çº¢é»‘æ ‘)ï¼Œå®ƒåŒ…å«å‡ ä¸ªé‡è¦çš„æˆå‘˜å˜é‡ï¼š root, size, comparatorã€‚root æ˜¯çº¢é»‘æ•°çš„æ ¹èŠ‚ç‚¹ã€‚å®ƒæ˜¯ Entry ç±»å‹ï¼ŒEntry
  æ˜¯çº¢é»‘æ•°çš„èŠ‚ç‚¹ï¼Œå®ƒåŒ…å«äº†çº¢é»‘æ•°çš„ 6 ä¸ªåŸºæœ¬ç»„æˆæˆåˆ†ï¼škey(é”®)ã€value(å€¼)ã€left(å·¦å­©å­)ã€right(å³å­©å­)ã€parent(çˆ¶èŠ‚ç‚¹)ã€color(é¢œè‰²)ã€‚Entry èŠ‚ç‚¹æ ¹æ®
  key è¿›è¡Œæ’åºï¼ŒEntry èŠ‚ç‚¹åŒ…å«çš„å†…å®¹ä¸º valueã€‚
- çº¢é»‘æ•°æ’åºæ—¶ï¼Œæ ¹æ® Entry ä¸­çš„ key è¿›è¡Œæ’åºï¼›Entry ä¸­çš„ key æ¯”è¾ƒå¤§å°æ˜¯æ ¹æ®æ¯”è¾ƒå™¨ comparator æ¥è¿›è¡Œåˆ¤æ–­çš„ã€‚
- size æ˜¯çº¢é»‘æ•°ä¸­èŠ‚ç‚¹çš„ä¸ªæ•°ã€‚

#### WeakHashMap

- WeakHashMap ç»§æ‰¿äº AbstractMapï¼Œå®ç°äº† Map æ¥å£ã€‚
- å’Œ HashMap ä¸€æ ·ï¼ŒWeakHashMap ä¹Ÿæ˜¯ä¸€ä¸ªæ•£åˆ—è¡¨ï¼Œå®ƒå­˜å‚¨çš„å†…å®¹ä¹Ÿæ˜¯é”®å€¼å¯¹ (key-value) æ˜ å°„ï¼Œè€Œä¸”é”®å’Œå€¼éƒ½å¯ä»¥æ˜¯ nullã€‚
- ä¸è¿‡ WeakHashMap çš„é”®æ˜¯â€œå¼±é”®â€ã€‚åœ¨ WeakHashMap ä¸­ï¼Œå½“æŸä¸ªé”®ä¸å†æ­£å¸¸ä½¿ç”¨æ—¶ï¼Œä¼šè¢«ä» WeakHashMap
  ä¸­è¢«è‡ªåŠ¨ç§»é™¤ã€‚æ›´ç²¾ç¡®åœ°è¯´ï¼Œå¯¹äºä¸€ä¸ªç»™å®šçš„é”®ï¼Œå…¶æ˜ å°„çš„å­˜åœ¨å¹¶ä¸é˜»æ­¢åƒåœ¾å›æ”¶å™¨å¯¹è¯¥é”®çš„ä¸¢å¼ƒï¼Œè¿™å°±ä½¿è¯¥é”®æˆä¸ºå¯ç»ˆæ­¢çš„ï¼Œè¢«ç»ˆæ­¢ï¼Œç„¶åè¢«å›æ”¶ã€‚æŸä¸ªé”®è¢«ç»ˆæ­¢æ—¶ï¼Œå®ƒå¯¹åº”çš„é”®å€¼å¯¹ä¹Ÿå°±ä»æ˜ å°„ä¸­æœ‰æ•ˆåœ°ç§»é™¤äº†ã€‚

  è¿™ä¸ªâ€œå¼±é”®â€çš„åŸç†å‘¢ï¼Ÿå¤§è‡´ä¸Šå°±æ˜¯ï¼Œé€šè¿‡ WeakReference å’Œ ReferenceQueue å®ç°çš„ã€‚ WeakHashMap çš„ key æ˜¯â€œå¼±é”®â€ï¼Œå³æ˜¯ WeakReference
  ç±»å‹çš„ï¼›ReferenceQueue æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå®ƒä¼šä¿å­˜è¢« GC å›æ”¶çš„â€œå¼±é”®â€ã€‚å®ç°æ­¥éª¤æ˜¯ï¼š

- æ–°å»º WeakHashMapï¼Œå°†â€œé”®å€¼å¯¹â€æ·»åŠ åˆ° WeakHashMap ä¸­ã€‚
  å®é™…ä¸Šï¼ŒWeakHashMap æ˜¯é€šè¿‡æ•°ç»„ table ä¿å­˜ Entry(é”®å€¼å¯¹)ï¼›æ¯ä¸€ä¸ª Entry å®é™…ä¸Šæ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œå³ Entry æ˜¯é”®å€¼å¯¹é“¾è¡¨ã€‚
- å½“æŸâ€œå¼±é”®â€ä¸å†è¢«å…¶å®ƒå¯¹è±¡å¼•ç”¨ï¼Œå¹¶è¢« GC å›æ”¶æ—¶ã€‚åœ¨ GC å›æ”¶è¯¥â€œå¼±é”®â€æ—¶ï¼Œè¿™ä¸ªâ€œå¼±é”®â€ä¹ŸåŒæ—¶ä¼šè¢«æ·»åŠ åˆ° ReferenceQueue(queue) é˜Ÿåˆ—ä¸­ã€‚
- å½“ä¸‹ä¸€æ¬¡æˆ‘ä»¬éœ€è¦æ“ä½œ WeakHashMap æ—¶ï¼Œä¼šå…ˆåŒæ­¥ table å’Œ queueã€‚table ä¸­ä¿å­˜äº†å…¨éƒ¨çš„é”®å€¼å¯¹ï¼Œè€Œ queue ä¸­ä¿å­˜è¢« GC å›æ”¶çš„é”®å€¼å¯¹ï¼›åŒæ­¥å®ƒä»¬ï¼Œå°±æ˜¯åˆ é™¤
  table ä¸­è¢« GC å›æ”¶çš„é”®å€¼å¯¹ã€‚

![20241229154732_agKVej1M.webp](https://cdn.dong4j.site/source/image/20241229154732_agKVej1M.webp)

- WeakHashMap ç»§æ‰¿äº AbstractMapï¼Œå¹¶ä¸”å®ç°äº† Map æ¥å£ã€‚
- WeakHashMap æ˜¯å“ˆå¸Œè¡¨ï¼Œä½†æ˜¯å®ƒçš„é”®æ˜¯"å¼±é”®"ã€‚WeakHashMap ä¸­ä¿æŠ¤å‡ ä¸ªé‡è¦çš„æˆå‘˜å˜é‡ï¼štable, size, threshold, loadFactor, modCount, queueã€‚
- table æ˜¯ä¸€ä¸ª Entry[] æ•°ç»„ç±»å‹ï¼Œè€Œ Entry å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ã€‚å“ˆå¸Œè¡¨çš„"key-value é”®å€¼å¯¹"éƒ½æ˜¯å­˜å‚¨åœ¨ Entry æ•°ç»„ä¸­çš„ã€‚
- size æ˜¯ Hashtable çš„å¤§å°ï¼Œå®ƒæ˜¯ Hashtable ä¿å­˜çš„é”®å€¼å¯¹çš„æ•°é‡ã€‚
- threshold æ˜¯ Hashtable çš„é˜ˆå€¼ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒæ•´ Hashtable çš„å®¹é‡ã€‚threshold çš„å€¼ =`å®¹é‡*åŠ è½½å› å­`ã€‚
- loadFactor å°±æ˜¯åŠ è½½å› å­ã€‚
- modCount æ˜¯ç”¨æ¥å®ç° fail-fast æœºåˆ¶çš„
- queue ä¿å­˜çš„æ˜¯â€œå·²è¢« GC æ¸…é™¤â€çš„â€œå¼±å¼•ç”¨çš„é”®â€ã€‚

#### Map æ€»ç»“

- Map æ˜¯â€œé”®å€¼å¯¹â€æ˜ å°„çš„æŠ½è±¡æ¥å£ã€‚
- AbstractMap å®ç°äº† Map ä¸­çš„ç»å¤§éƒ¨åˆ†å‡½æ•°æ¥å£ã€‚å®ƒå‡å°‘äº†â€œMap çš„å®ç°ç±»â€çš„é‡å¤ç¼–ç ã€‚
- SortedMap æœ‰åºçš„â€œé”®å€¼å¯¹â€æ˜ å°„æ¥å£ã€‚
- NavigableMap æ˜¯ç»§æ‰¿äº SortedMap çš„ï¼Œæ”¯æŒå¯¼èˆªå‡½æ•°çš„æ¥å£ã€‚
- HashMap, Hashtable, TreeMap, WeakHashMap è¿™ 4 ä¸ªç±»æ˜¯â€œé”®å€¼å¯¹â€æ˜ å°„çš„å®ç°ç±»ã€‚å®ƒä»¬å„æœ‰åŒºåˆ«ï¼
  - HashMap æ˜¯åŸºäºâ€œæ‹‰é“¾æ³•â€å®ç°çš„æ•£åˆ—è¡¨ã€‚ä¸€èˆ¬ç”¨äºå•çº¿ç¨‹ç¨‹åºä¸­ã€‚
  - Hashtable ä¹Ÿæ˜¯åŸºäºâ€œæ‹‰é“¾æ³•â€å®ç°çš„æ•£åˆ—è¡¨ã€‚å®ƒä¸€èˆ¬ç”¨äºå¤šçº¿ç¨‹ç¨‹åºä¸­ã€‚
  - WeakHashMap ä¹Ÿæ˜¯åŸºäºâ€œæ‹‰é“¾æ³•â€å®ç°çš„æ•£åˆ—è¡¨ï¼Œå®ƒä¸€èˆ¬ä¹Ÿç”¨äºå•çº¿ç¨‹ç¨‹åºä¸­ã€‚ç›¸æ¯” HashMapï¼ŒWeakHashMap ä¸­çš„é”®æ˜¯â€œå¼±é”®â€ï¼Œå½“â€œå¼±é”®â€è¢« GC
    å›æ”¶æ—¶ï¼Œå®ƒå¯¹åº”çš„é”®å€¼å¯¹ä¹Ÿä¼šè¢«ä» WeakHashMap ä¸­åˆ é™¤ï¼›è€Œ HashMap ä¸­çš„é”®æ˜¯å¼ºé”®ã€‚
  - TreeMap æ˜¯æœ‰åºçš„æ•£åˆ—è¡¨ï¼Œå®ƒæ˜¯é€šè¿‡çº¢é»‘æ ‘å®ç°çš„ã€‚å®ƒä¸€èˆ¬ç”¨äºå•çº¿ç¨‹ä¸­å­˜å‚¨æœ‰åºçš„æ˜ å°„ã€‚

##### HashMap å’Œ Hashtable å¼‚åŒ

ç›¸åŒç‚¹:
HashMap å’Œ Hashtable éƒ½æ˜¯å­˜å‚¨â€œé”®å€¼å¯¹ (key-value)â€çš„æ•£åˆ—è¡¨ï¼Œè€Œä¸”éƒ½æ˜¯é‡‡ç”¨æ‹‰é“¾æ³•å®ç°çš„ã€‚
å­˜å‚¨çš„æ€æƒ³éƒ½æ˜¯ï¼šé€šè¿‡ table æ•°ç»„å­˜å‚¨ï¼Œæ•°ç»„çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ª Entryï¼›è€Œä¸€ä¸ª Entry å°±æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ï¼ŒEntry é“¾è¡¨ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹å°±ä¿å­˜äº† key-value
é”®å€¼å¯¹æ•°æ®ã€‚

**æ·»åŠ  key-value é”®å€¼å¯¹**ï¼šé¦–å…ˆï¼Œæ ¹æ® key å€¼è®¡ç®—å‡ºå“ˆå¸Œå€¼ï¼Œå†è®¡ç®—å‡ºæ•°ç»„ç´¢å¼• (å³ï¼Œè¯¥ key-value åœ¨ table ä¸­çš„ç´¢å¼•)ã€‚ç„¶åï¼Œæ ¹æ®æ•°ç»„ç´¢å¼•æ‰¾åˆ° Entry(
å³ï¼Œå•å‘é“¾è¡¨ )ï¼Œå†éå†å•å‘é“¾è¡¨ï¼Œå°† key å’Œé“¾è¡¨ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„ key è¿›è¡Œå¯¹æ¯”ã€‚è‹¥ key å·²ç»å­˜åœ¨ Entry é“¾è¡¨ä¸­ï¼Œåˆ™ç”¨è¯¥ value å€¼å–ä»£æ—§çš„ value å€¼ï¼›è‹¥ key
ä¸å­˜åœ¨ Entry é“¾è¡¨ä¸­ï¼Œåˆ™æ–°å»ºä¸€ä¸ª key-value èŠ‚ç‚¹ï¼Œå¹¶å°†è¯¥èŠ‚ç‚¹æ’å…¥ Entry é“¾è¡¨çš„è¡¨å¤´ä½ç½®ã€‚
**åˆ é™¤ key-value é”®å€¼å¯¹**ï¼šåˆ é™¤é”®å€¼å¯¹ï¼Œç›¸æ¯”äºâ€œæ·»åŠ é”®å€¼å¯¹â€æ¥è¯´ï¼Œç®€å•å¾ˆå¤šã€‚é¦–å…ˆï¼Œè¿˜æ˜¯æ ¹æ® key è®¡ç®—å‡ºå“ˆå¸Œå€¼ï¼Œå†è®¡ç®—å‡ºæ•°ç»„ç´¢å¼• ( å³ï¼Œè¯¥ key-value åœ¨
table ä¸­çš„ç´¢å¼• )ã€‚ç„¶åï¼Œæ ¹æ®ç´¢å¼•æ‰¾å‡º Entry( å³ï¼Œå•å‘é“¾è¡¨)ã€‚è‹¥èŠ‚ç‚¹ key-value å­˜åœ¨ä¸é“¾è¡¨ Entry ä¸­ï¼Œåˆ™åˆ é™¤é“¾è¡¨ä¸­çš„èŠ‚ç‚¹å³å¯ã€‚

ä¸åŒç‚¹:

- HashMap ç»§æ‰¿äº AbstractMapï¼Œå®ç°äº† Mapã€Cloneableã€java.io.Serializable æ¥å£ã€‚
- Hashtable ç»§æ‰¿äº Dictionaryï¼Œå®ç°äº† Mapã€Cloneableã€java.io.Serializable æ¥å£ã€‚
- Hashtable çš„å‡ ä¹æ‰€æœ‰å‡½æ•°éƒ½æ˜¯åŒæ­¥çš„ï¼Œå³å®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ”¯æŒå¤šçº¿ç¨‹ã€‚
- HashMap çš„å‡½æ•°åˆ™æ˜¯éåŒæ­¥çš„ï¼Œå®ƒä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚è‹¥è¦åœ¨å¤šçº¿ç¨‹ä¸­ä½¿ç”¨ HashMapï¼Œéœ€è¦æˆ‘ä»¬é¢å¤–çš„è¿›è¡ŒåŒæ­¥å¤„ç†ã€‚ å¯¹ HashMap çš„åŒæ­¥å¤„ç†å¯ä»¥ä½¿ç”¨
  Collections ç±»æä¾›çš„ synchronizedMap é™æ€æ–¹æ³•ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨ JDK 5.0 ä¹‹åæä¾›çš„ java.util.concurrent åŒ…é‡Œçš„ ConcurrentHashMap ç±»ã€‚
- HashMap çš„ keyã€value éƒ½å¯ä»¥ä¸º nullã€‚
- Hashtable çš„ keyã€value éƒ½ä¸å¯ä»¥ä¸º nullã€‚
- HashMap åªæ”¯æŒ Iterator(è¿­ä»£å™¨) éå†ã€‚
- Hashtable æ”¯æŒ Iterator(è¿­ä»£å™¨) å’Œ Enumeration(æšä¸¾å™¨) ä¸¤ç§æ–¹å¼éå†ã€‚
- é€šè¿‡ Iterator è¿­ä»£å™¨éå†æ—¶ï¼Œéå†çš„é¡ºåºä¸åŒ,HashMap æ˜¯â€œä»å‰å‘åâ€çš„éå†æ•°ç»„,Hashtabl æ˜¯â€œä»åå¾€å‰â€çš„éå†æ•°ç»„
- HashMap é»˜è®¤çš„å®¹é‡å¤§å°æ˜¯ 16ï¼›å¢åŠ å®¹é‡æ—¶ï¼Œæ¯æ¬¡å°†å®¹é‡å˜ä¸ºâ€œåŸå§‹å®¹é‡ x2â€ã€‚
- Hashtable é»˜è®¤çš„å®¹é‡å¤§å°æ˜¯ 11ï¼›å¢åŠ å®¹é‡æ—¶ï¼Œæ¯æ¬¡å°†å®¹é‡å˜ä¸ºâ€œåŸå§‹å®¹é‡ x2 + 1â€ã€‚
- HashMap æ·»åŠ å…ƒç´ æ—¶ï¼Œæ˜¯ä½¿ç”¨è‡ªå®šä¹‰çš„å“ˆå¸Œç®—æ³•ã€‚
- Hashtable æ²¡æœ‰è‡ªå®šä¹‰å“ˆå¸Œç®—æ³•ï¼Œè€Œç›´æ¥é‡‡ç”¨çš„ key çš„ hashCode()ã€‚

##### HashMap å’Œ WeakHashMap å¼‚åŒ

ç›¸åŒç‚¹:

- å®ƒä»¬éƒ½æ˜¯æ•£åˆ—è¡¨ï¼Œå­˜å‚¨çš„æ˜¯â€œé”®å€¼å¯¹â€æ˜ å°„ã€‚
- å®ƒä»¬éƒ½ç»§æ‰¿äº AbstractMapï¼Œå¹¶ä¸”å®ç° Map åŸºç¡€ã€‚
- å®ƒä»¬çš„æ„é€ å‡½æ•°éƒ½ä¸€æ ·ã€‚
- å®ƒä»¬éƒ½åŒ…æ‹¬ 4 ä¸ªæ„é€ å‡½æ•°ï¼Œè€Œä¸”å‡½æ•°çš„å‚æ•°éƒ½ä¸€æ ·ã€‚
- é»˜è®¤çš„å®¹é‡å¤§å°æ˜¯ 16ï¼Œé»˜è®¤çš„åŠ è½½å› å­æ˜¯ 0.75ã€‚
- å®ƒä»¬çš„â€œé”®â€å’Œâ€œå€¼â€éƒ½å…è®¸ä¸º nullã€‚
- å®ƒä»¬éƒ½æ˜¯â€œéåŒæ­¥çš„â€ã€‚

ä¸åŒç‚¹:

- HashMap å®ç°äº† Cloneable å’Œ Serializable æ¥å£ï¼Œè€Œ WeakHashMap æ²¡æœ‰ã€‚
- HashMap çš„â€œé”®â€æ˜¯â€œå¼ºå¼•ç”¨ (StrongReference)â€ï¼Œè€Œ WeakHashMap çš„é”®æ˜¯â€œå¼±å¼•ç”¨ (WeakReference)â€

##### Collections.synchronizedMap å’Œ ConcurrentHashMap

Map m = Collections.synchronizedMap(new HashMap());

ä½¿ç”¨ Collections å·¥å…·ç±»çš„ synchronizedMap åŒ…è£…ä¸€ä¸ªåŒæ­¥çš„ HashMap
é€‚ç”¨äºå¹¶å‘é‡å°çš„æƒ…å†µ
å®ƒçš„åŸç†æ˜¯å°† HashMap åŒ…è£…åœ¨è¿™ä¸ªç±»ä¸­, ç„¶ååœ¨ HashMap çš„æ¯ä¸ªæ“ä½œéƒ½åŠ ä¸Š synchronized

````java
private final Map<K,V> m;     // Backing Map
        final Object      mutex;        // Object on which to synchronize

        SynchronizedMap(Map<K,V> m) {
            if (m==null)
                throw new NullPointerException();
            this.m = m;
            mutex = this;
        }

        SynchronizedMap(Map<K,V> m, Object mutex) {
            this.m = m;
            this.mutex = mutex;
        }

        public int size() {
            synchronized (mutex) {return m.size();}
        }
        public boolean isEmpty() {
            synchronized (mutex) {return m.isEmpty();}
        }
        public boolean containsKey(Object key) {
            synchronized (mutex) {return m.containsKey(key);}
        }
        public boolean containsValue(Object value) {
            synchronized (mutex) {return m.containsValue(value);}
        }
        public V get(Object key) {
            synchronized (mutex) {return m.get(key);}
        }

        public V put(K key, V value) {
            synchronized (mutex) {return m.put(key, value);}
        }
        public V remove(Object key) {
            synchronized (mutex) {return m.remove(key);}
        }
        public void putAll(Map<? extends K, ? extends V> map) {
            synchronized (mutex) {m.putAll(map);}
        }
        public void clear() {
            synchronized (mutex) {m.clear();}
        }
    ```

ComcurrentHashMap

```java
public V put(K key, V value) {
        Segment<K,V> s;
        if (value == null)
            throw new NullPointerException();
        int hash = hash(key);
        int j = (hash >>> segmentShift) & segmentMask;
        if ((s = (Segment<K,V>)UNSAFE.getObject          // nonvolatile; recheck
             (segments, (j << SSHIFT) + SBASE))== null) //  in ensureSegment
            s = ensureSegment(j);
        return s.put(key, hash, value, false);
    }
````

åœ¨ ConcurrentHashMap å†…éƒ¨æœ‰ä¸€ä¸ª Segment æ®µï¼Œå®ƒå°†å¤§çš„ HashMap åˆ‡åˆ†æˆè‹¥å¹²ä¸ªæ®µï¼ˆå°çš„ HashMapï¼‰ï¼Œç„¶åè®©æ•°æ®åœ¨æ¯ä¸€æ®µä¸Š Hashï¼Œè¿™æ ·å¤šä¸ªçº¿ç¨‹åœ¨ä¸åŒæ®µä¸Šçš„
Hash æ“ä½œä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥åªéœ€è¦åŒæ­¥åŒä¸€ä¸ªæ®µä¸Šçš„çº¿ç¨‹å°±å¯ä»¥äº†ï¼Œè¿™æ ·å®ç°äº†é”çš„åˆ†ç¦»ï¼Œå¤§å¤§å¢åŠ äº†å¹¶å‘é‡ã€‚

åœ¨ä½¿ç”¨ ConcurrentHashMap.size æ—¶ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸ºå®ƒè¦ç»Ÿè®¡æ¯ä¸ªæ®µçš„æ•°æ®å’Œï¼Œåœ¨è¿™ä¸ªæ—¶å€™ï¼Œè¦æŠŠæ¯ä¸€ä¸ªæ®µéƒ½åŠ ä¸Šé”ï¼Œç„¶åå†åšæ•°æ®ç»Ÿè®¡ã€‚è¿™ä¸ªå°±æ˜¯æŠŠé”åˆ†ç¦»åçš„å°å°å¼Šç«¯ï¼Œä½†æ˜¯
size æ–¹æ³•åº”è¯¥æ˜¯ä¸ä¼šè¢«é«˜é¢‘ç‡è°ƒç”¨çš„æ–¹æ³•ã€‚

![20241229154732_RZWdx7ak.webp](https://cdn.dong4j.site/source/image/20241229154732_RZWdx7ak.webp)

#### å¼ºå¼•ç”¨, è½¯å¼•ç”¨, å¼±å¼•ç”¨, è™šå¼•ç”¨

### Set

![20241229154732_eus534la.webp](https://cdn.dong4j.site/source/image/20241229154732_eus534la.webp)

Set éƒ½æ˜¯åŸºäº Map å®ç°çš„ , HashSet æ˜¯é€šè¿‡ HashMap å®ç°çš„ï¼ŒTreeSet æ˜¯é€šè¿‡ TreeMap å®ç°çš„

#### HashSet

![20241229154732_NWia6SZS.webp](https://cdn.dong4j.site/source/image/20241229154732_NWia6SZS.webp)

```java
public class HashSet<E>
       extends AbstractSet<E>
       implements Set<E>, Cloneable, java.io.Serializable
   {
       static final long serialVersionUID = -5024744406713321676L;

       // HashSet æ˜¯é€šè¿‡ map(HashMap å¯¹è±¡) ä¿å­˜å†…å®¹çš„
      private transient HashMap<E,Object> map;

      // PRESENT æ˜¯å‘ map ä¸­æ’å…¥ key-value å¯¹åº”çš„ value
     // å› ä¸º HashSet ä¸­åªéœ€è¦ç”¨åˆ° keyï¼Œè€Œ HashMap æ˜¯ key-value é”®å€¼å¯¹ï¼›
      // æ‰€ä»¥ï¼Œå‘ map ä¸­æ·»åŠ é”®å€¼å¯¹æ—¶ï¼Œé”®å€¼å¯¹çš„å€¼å›ºå®šæ˜¯ PRESENT
      private static final Object PRESENT = new Object();

      // é»˜è®¤æ„é€ å‡½æ•°
      public HashSet() {
          // è°ƒç”¨ HashMap çš„é»˜è®¤æ„é€ å‡½æ•°ï¼Œåˆ›å»º map
          map = new HashMap<E,Object>();
      }
      ....
}
```

#### éå†æ–¹å¼

é€šè¿‡ Iterator éå† HashSet

```java
// å‡è®¾ set æ˜¯ HashSet å¯¹è±¡
for(Iterator iterator = set.iterator();
       iterator.hasNext();) {
    iterator.next();
}
```

é€šè¿‡ for-each éå† HashSet

```java
// å‡è®¾ set æ˜¯ HashSet å¯¹è±¡ï¼Œå¹¶ä¸” set ä¸­å…ƒç´ æ˜¯ String ç±»å‹
String[] arr = (String[])set.toArray(new String[0]);
for (String str:arr)
    System.out.printf("for each : %s\n", str);
```

#### TreeSet

##### éå†æ–¹å¼

```java
for(Iterator iter = set.iterator(); iter.hasNext();) {
    iter.next();
}
for(Iterator iter = set.descendingIterator(); iter.hasNext();) {
    iter.next();
}
// å‡è®¾ set æ˜¯ TreeSet å¯¹è±¡ï¼Œå¹¶ä¸” set ä¸­å…ƒç´ æ˜¯ String ç±»å‹
String[] arr = (String[])set.toArray(new String[0]);
for (String str:arr)
    System.out.printf("for each : %s\n", str);
```

TreeSet ä¸æ”¯æŒå¿«é€Ÿéšæœºéå†ï¼Œåªèƒ½é€šè¿‡è¿­ä»£å™¨è¿›è¡Œéå†ï¼

### java.util.Arrays

Array æ˜¯ Java ç‰¹æœ‰çš„æ•°ç»„, è€Œ Arrays æ˜¯å¤„ç†æ•°æ®çš„å·¥å…·ç±»

- Arrays.asListï¼šå¯ä»¥ä» Array è½¬æ¢æˆ Listã€‚å¯ä»¥ä½œä¸ºå…¶ä»–é›†åˆç±»å‹æ„é€ å™¨çš„å‚æ•°ã€‚
- Arrays.binarySearchï¼šåœ¨ä¸€ä¸ªå·²æ’åºçš„æˆ–è€…å…¶ä¸­ä¸€æ®µä¸­å¿«é€ŸæŸ¥æ‰¾ã€‚
- Arrays.copyOfï¼šå¦‚æœä½ æƒ³æ‰©å¤§æ•°ç»„å®¹é‡åˆä¸æƒ³æ”¹å˜å®ƒçš„å†…å®¹çš„æ—¶å€™å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ã€‚
- Arrays.copyOfRangeï¼šå¯ä»¥å¤åˆ¶æ•´ä¸ªæ•°ç»„æˆ–å…¶ä¸­çš„ä¸€éƒ¨åˆ†ã€‚
- Arrays.deepEqualsã€Arrays.deepHashCodeï¼šArrays.equals/hashCode çš„é«˜çº§ç‰ˆæœ¬ï¼Œæ”¯æŒå­æ•°ç»„çš„æ“ä½œã€‚
- Arrays.equalsï¼šå¦‚æœä½ æƒ³è¦æ¯”è¾ƒä¸¤ä¸ªæ•°ç»„æ˜¯å¦ç›¸ç­‰ï¼Œåº”è¯¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•è€Œä¸æ˜¯æ•°ç»„å¯¹è±¡ä¸­çš„ equals æ–¹æ³•ï¼ˆæ•°ç»„å¯¹è±¡ä¸­æ²¡æœ‰é‡å†™ equals()
  æ–¹æ³•ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•ä¹‹æ¯”è¾ƒå¼•ç”¨è€Œä¸æ¯”è¾ƒå†…å®¹ï¼‰ã€‚è¿™ä¸ªæ–¹æ³•é›†åˆäº† Java 5 çš„è‡ªåŠ¨è£…ç®±å’Œæ— å‚å˜é‡çš„ç‰¹æ€§ï¼Œæ¥å®ç°å°†ä¸€ä¸ªå˜é‡å¿«é€Ÿåœ°ä¼ ç»™ equals()
  æ–¹æ³•â€”â€”æ‰€ä»¥è¿™ä¸ªæ–¹æ³•åœ¨æ¯”è¾ƒäº†å¯¹è±¡çš„ç±»å‹ä¹‹åæ˜¯ç›´æ¥ä¼ å€¼è¿›å»æ¯”è¾ƒçš„ã€‚
- Arrays.fillï¼šç”¨ä¸€ä¸ªç»™å®šçš„å€¼å¡«å……æ•´ä¸ªæ•°ç»„æˆ–å…¶ä¸­çš„ä¸€éƒ¨åˆ†ã€‚
- Arrays.hashCodeï¼šç”¨æ¥æ ¹æ®æ•°ç»„çš„å†…å®¹è®¡ç®—å…¶å“ˆå¸Œå€¼ï¼ˆæ•°ç»„å¯¹è±¡çš„ hashCode() ä¸å¯ç”¨ï¼‰ã€‚è¿™ä¸ªæ–¹æ³•é›†åˆäº† Java 5 çš„è‡ªåŠ¨è£…ç®±å’Œæ— å‚å˜é‡çš„ç‰¹æ€§ï¼Œæ¥å®ç°å°†ä¸€ä¸ªå˜é‡å¿«é€Ÿåœ°ä¼ ç»™
  Arrays.hashcode æ–¹æ³•â€”â€”åªæ˜¯ä¼ å€¼è¿›å»ï¼Œä¸æ˜¯å¯¹è±¡ã€‚
- Arrays.sortï¼šå¯¹æ•´ä¸ªæ•°ç»„æˆ–è€…æ•°ç»„çš„ä¸€éƒ¨åˆ†è¿›è¡Œæ’åºã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•ç”¨ç»™å®šçš„æ¯”è¾ƒå™¨å¯¹å¯¹è±¡æ•°ç»„è¿›è¡Œæ’åºã€‚
- Arrays.toStringï¼šæ‰“å°æ•°ç»„çš„å†…å®¹ã€‚

å¦‚æœæƒ³è¦å¤åˆ¶æ•´ä¸ªæ•°ç»„æˆ–å…¶ä¸­ä¸€éƒ¨åˆ†åˆ°å¦ä¸€ä¸ªæ•°ç»„ï¼Œå¯ä»¥è°ƒç”¨ System.arraycopy æ–¹æ³•ã€‚æ­¤æ–¹æ³•ä»æºæ•°ç»„ä¸­æŒ‡å®šçš„ä½ç½®å¤åˆ¶æŒ‡å®šä¸ªæ•°çš„å…ƒç´ åˆ°ç›®æ ‡æ•°ç»„é‡Œã€‚è¿™æ— ç–‘æ˜¯ä¸€ä¸ªç®€ä¾¿çš„æ–¹æ³•ã€‚ï¼ˆæœ‰æ—¶å€™ç”¨
ByteBuffer bulk å¤åˆ¶ä¼šæ›´å¿«ã€‚

### java.util.Collections

### fail-fast é—®é¢˜

> fail-fast æœºåˆ¶æ˜¯ java é›†åˆ (Collection) ä¸­çš„ä¸€ç§é”™è¯¯æœºåˆ¶ã€‚å½“å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªé›†åˆçš„å†…å®¹è¿›è¡Œæ“ä½œæ—¶ï¼Œå°±å¯èƒ½ä¼šäº§ç”Ÿ fail-fast äº‹ä»¶ã€‚
> ä¾‹å¦‚ï¼šå½“æŸä¸€ä¸ªçº¿ç¨‹ A é€šè¿‡ iterator å»éå†æŸé›†åˆçš„è¿‡ç¨‹ä¸­ï¼Œè‹¥è¯¥é›†åˆçš„å†…å®¹è¢«å…¶ä»–çº¿ç¨‹æ‰€æ”¹å˜äº†ï¼›é‚£ä¹ˆçº¿ç¨‹ A è®¿é—®é›†åˆæ—¶ï¼Œå°±ä¼šæŠ›å‡º
> ConcurrentModificationException å¼‚å¸¸ï¼Œäº§ç”Ÿ fail-fast äº‹ä»¶ã€‚

#### å‘ç”ŸåŸå› 

åœ¨è°ƒç”¨ next()å’Œ remove() æ—¶ï¼Œéƒ½ä¼šæ‰§è¡Œ checkForComodification()ã€‚è‹¥ â€œmodCount ä¸ç­‰äº expectedModCountâ€ï¼Œåˆ™æŠ›å‡º ConcurrentModificationException
å¼‚å¸¸ï¼Œäº§ç”Ÿ fail-fast äº‹ä»¶ã€‚

#### è§£å†³æ–¹æ³•

åªéœ€è¦å°† ArrayList æ›¿æ¢æˆ java.util.concurrent åŒ…ä¸‹å¯¹åº”çš„ç±»å³å¯ã€‚
å³ï¼Œå°†ä»£ç 
`private static List<String> list = new ArrayList<String>();`
æ›¿æ¢ä¸º
`private static List<String> list = new CopyOnWriteArrayList<String>();

#### è§£å†³åŸç†

- å’Œ ArrayList ç»§æ‰¿äº AbstractList ä¸åŒï¼ŒCopyOnWriteArrayList æ²¡æœ‰ç»§æ‰¿äº AbstractListï¼Œå®ƒä»…ä»…åªæ˜¯å®ç°äº† List æ¥å£ã€‚
- ArrayList çš„ iterator() å‡½æ•°è¿”å›çš„ Iterator æ˜¯åœ¨ AbstractList ä¸­å®ç°çš„ï¼›è€Œ CopyOnWriteArrayList æ˜¯è‡ªå·±å®ç° Iteratorã€‚
- ArrayList çš„ Iterator å®ç°ç±»ä¸­è°ƒç”¨ next()æ—¶ï¼Œä¼šâ€œè°ƒç”¨ checkForComodification() æ¯”è¾ƒâ€˜expectedModCountâ€™å’Œâ€˜modCountâ€™çš„å¤§å°â€ï¼›ä½†æ˜¯ï¼ŒCopyOnWriteArrayList
  çš„ Iterator å®ç°ç±»ä¸­ï¼Œæ²¡æœ‰æ‰€è°“çš„ checkForComodification()ï¼Œæ›´ä¸ä¼šæŠ›å‡º ConcurrentModificationException å¼‚å¸¸ï¼

## å¹¶å‘é›†åˆ

### List

#### CopyOnWriteArrayList

### Set

#### ConcurrentSkipListSet

#### CopyOnWriteArraySet

### Map

#### ConcurrentHashMap

#### ConcurrentSkipListMap

## é›†åˆé—®é¢˜

### Iterater å’Œ ListIterator ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

- ä½¿ç”¨ Iterator æ¥éå† Set å’Œ List é›†åˆï¼Œè€Œ ListIterator åªèƒ½éå† Listã€‚
- iterator åªå¯ä»¥å‘å‰éå†ï¼Œè€Œ LIstIterator å¯ä»¥åŒå‘éå†ã€‚
- ListIterator ä» Iterator æ¥å£ç»§æ‰¿ï¼Œç„¶åæ·»åŠ äº†ä¸€äº›é¢å¤–çš„åŠŸèƒ½ï¼Œæ¯”å¦‚æ·»åŠ ä¸€ä¸ªå…ƒç´ ã€æ›¿æ¢ä¸€ä¸ªå…ƒç´ ã€è·å–å‰é¢æˆ–åé¢å…ƒç´ çš„ç´¢å¼•ä½ç½®ã€‚

### é€šè¿‡è¿­ä»£å™¨ fail-fast å±æ€§ï¼Œä½ æ˜ç™½äº†ä»€ä¹ˆï¼Ÿ

æ¯æ¬¡æˆ‘ä»¬å°è¯•è·å–ä¸‹ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™ï¼ŒIterator fail-fast å±æ€§æ£€æŸ¥å½“å‰é›†åˆç»“æ„é‡Œçš„ä»»ä½•æ”¹åŠ¨ã€‚å¦‚æœå‘ç°ä»»ä½•æ”¹åŠ¨ï¼Œå®ƒæŠ›å‡º
ConcurrentModificationExceptionã€‚Collection ä¸­æ‰€æœ‰ Iterator çš„å®ç°éƒ½æ˜¯æŒ‰ fail-fast æ¥è®¾è®¡çš„ï¼ˆConcurrentHashMap å’Œ CopyOnWriteArrayList
è¿™ç±»å¹¶å‘é›†åˆç±»é™¤å¤–ï¼‰ã€‚

### fail-fast ä¸ fail-safe æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

Iterator çš„ fail-fast å±æ€§ä¸å½“å‰çš„é›†åˆå…±åŒèµ·ä½œç”¨ï¼Œå› æ­¤å®ƒä¸ä¼šå—åˆ°é›†åˆä¸­ä»»ä½•æ”¹åŠ¨çš„å½±å“ã€‚Java.util åŒ…ä¸­çš„æ‰€æœ‰é›†åˆç±»éƒ½è¢«è®¾è®¡ä¸º fail-fast çš„ï¼Œè€Œ
java.util.concurrent ä¸­çš„é›†åˆç±»éƒ½ä¸º fail-safe çš„ã€‚Fail-fast è¿­ä»£å™¨æŠ›å‡º ConcurrentModificationExceptionï¼Œè€Œ fail-safe è¿­ä»£å™¨ä»ä¸æŠ›å‡º
ConcurrentModificationExceptionã€‚

### UnsupportedOperationException æ˜¯ä»€ä¹ˆï¼Ÿ

UnsupportedOperationException æ˜¯ç”¨äºè¡¨æ˜æ“ä½œä¸æ”¯æŒçš„å¼‚å¸¸ã€‚åœ¨ JDK ç±»ä¸­å·²è¢«å¤§é‡è¿ç”¨ï¼Œåœ¨é›†åˆæ¡†æ¶ java.util.Collections.UnmodifiableCollection
å°†ä¼šåœ¨æ‰€æœ‰ add å’Œ remove æ“ä½œä¸­æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ã€‚

### åœ¨ Java ä¸­ï¼ŒHashMap æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

HashMap åœ¨ Map.Entry é™æ€å†…éƒ¨ç±»å®ç°ä¸­å­˜å‚¨ key-value å¯¹ã€‚HashMap ä½¿ç”¨å“ˆå¸Œç®—æ³•ï¼Œåœ¨ put å’Œ get æ–¹æ³•ä¸­ï¼Œå®ƒä½¿ç”¨ hashCode()å’Œ equals() æ–¹æ³•ã€‚å½“æˆ‘ä»¬é€šè¿‡ä¼ é€’
key-value å¯¹è°ƒç”¨ put æ–¹æ³•çš„æ—¶å€™ï¼ŒHashMap ä½¿ç”¨ Key hashCode() å’Œå“ˆå¸Œç®—æ³•æ¥æ‰¾å‡ºå­˜å‚¨ key-value å¯¹çš„ç´¢å¼•ã€‚Entry å­˜å‚¨åœ¨ LinkedList ä¸­ï¼Œæ‰€ä»¥å¦‚æœå­˜åœ¨
entryï¼Œå®ƒä½¿ç”¨ equals() æ–¹æ³•æ¥æ£€æŸ¥ä¼ é€’çš„ key æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œå®ƒä¼šè¦†ç›– valueï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ entry ç„¶åä¿å­˜ã€‚å½“æˆ‘ä»¬é€šè¿‡ä¼ é€’
key è°ƒç”¨ get æ–¹æ³•æ—¶ï¼Œå®ƒå†æ¬¡ä½¿ç”¨ hashCode()æ¥æ‰¾åˆ°æ•°ç»„ä¸­çš„ç´¢å¼•ï¼Œç„¶åä½¿ç”¨ equals() æ–¹æ³•æ‰¾å‡ºæ­£ç¡®çš„ Entryï¼Œç„¶åè¿”å›å®ƒçš„å€¼ã€‚ä¸‹é¢çš„å›¾ç‰‡è§£é‡Šäº†è¯¦ç»†å†…å®¹ã€‚

å…¶å®ƒå…³äº HashMap æ¯”è¾ƒé‡è¦çš„é—®é¢˜æ˜¯å®¹é‡ã€è´Ÿè·ç³»æ•°å’Œé˜€å€¼è°ƒæ•´ã€‚HashMap é»˜è®¤çš„åˆå§‹å®¹é‡æ˜¯ 32ï¼Œè´Ÿè·ç³»æ•°æ˜¯ 0.75ã€‚é˜€å€¼æ˜¯ä¸ºè´Ÿè·ç³»æ•°ä¹˜ä»¥å®¹é‡ï¼Œæ— è®ºä½•æ—¶æˆ‘ä»¬å°è¯•æ·»åŠ ä¸€ä¸ª
entryï¼Œå¦‚æœ map çš„å¤§å°æ¯”é˜€å€¼å¤§çš„æ—¶å€™ï¼ŒHashMap ä¼šå¯¹ map çš„å†…å®¹è¿›è¡Œé‡æ–°å“ˆå¸Œï¼Œä¸”ä½¿ç”¨æ›´å¤§çš„å®¹é‡ã€‚å®¹é‡æ€»æ˜¯ 2 çš„å¹‚ï¼Œæ‰€ä»¥å¦‚æœä½ çŸ¥é“ä½ éœ€è¦å­˜å‚¨å¤§é‡çš„
key-value å¯¹ï¼Œæ¯”å¦‚ç¼“å­˜ä»æ•°æ®åº“é‡Œé¢æ‹‰å–çš„æ•°æ®ï¼Œä½¿ç”¨æ­£ç¡®çš„å®¹é‡å’Œè´Ÿè·ç³»æ•°å¯¹ HashMap è¿›è¡Œåˆå§‹åŒ–æ˜¯ä¸ªä¸é”™çš„åšæ³•ã€‚

### hashCode()å’Œ equals() æ–¹æ³•æœ‰ä½•é‡è¦æ€§ï¼Ÿ

HashMap ä½¿ç”¨ Key å¯¹è±¡çš„ hashCode()å’Œ equals() æ–¹æ³•å»å†³å®š key-value å¯¹çš„ç´¢å¼•ã€‚å½“æˆ‘ä»¬è¯•ç€ä» HashMap
ä¸­è·å–å€¼çš„æ—¶å€™ï¼Œè¿™äº›æ–¹æ³•ä¹Ÿä¼šè¢«ç”¨åˆ°ã€‚å¦‚æœè¿™äº›æ–¹æ³•æ²¡æœ‰è¢«æ­£ç¡®åœ°å®ç°ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸¤ä¸ªä¸åŒ Key ä¹Ÿè®¸ä¼šäº§ç”Ÿç›¸åŒçš„ hashCode()å’Œ equals() è¾“å‡ºï¼ŒHashMap
å°†ä¼šè®¤ä¸ºå®ƒä»¬æ˜¯ç›¸åŒçš„ï¼Œç„¶åè¦†ç›–å®ƒä»¬ï¼Œè€ŒéæŠŠå®ƒä»¬å­˜å‚¨åˆ°ä¸åŒçš„åœ°æ–¹ã€‚åŒæ ·çš„ï¼Œæ‰€æœ‰ä¸å…è®¸å­˜å‚¨é‡å¤æ•°æ®çš„é›†åˆç±»éƒ½ä½¿ç”¨ hashCode()å’Œ equals()
å»æŸ¥æ‰¾é‡å¤ï¼Œæ‰€ä»¥æ­£ç¡®å®ç°å®ƒä»¬éå¸¸é‡è¦ã€‚equals()å’Œ hashCode() çš„å®ç°åº”è¯¥éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š

- å¦‚æœ o1.equals(o2) ä¸º trueï¼Œé‚£ä¹ˆ o1.hashCode()== o2.hashCode() æ€»æ˜¯ä¸º true çš„ã€‚
- å¦‚æœ o1.hashCode()== o2.hashCode()ï¼Œå¹¶ä¸æ„å‘³ç€ o1.equals(o2) ä¼šä¸º trueã€‚

### å¦‚ä½•å†³å®šé€‰ç”¨ HashMap è¿˜æ˜¯ TreeMapï¼Ÿ

å¯¹äºåœ¨ Map ä¸­æ’å…¥ã€åˆ é™¤å’Œå®šä½å…ƒç´ è¿™ç±»æ“ä½œï¼ŒHashMap æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚ç„¶è€Œï¼Œå‡å¦‚ä½ éœ€è¦å¯¹ä¸€ä¸ªæœ‰åºçš„ key é›†åˆè¿›è¡Œéå†ï¼ŒTreeMap æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚åŸºäºä½ çš„
collection çš„å¤§å°ï¼Œä¹Ÿè®¸å‘ HashMap ä¸­æ·»åŠ å…ƒç´ ä¼šæ›´å¿«ï¼Œå°† map æ¢ä¸º TreeMap è¿›è¡Œæœ‰åº key çš„éå†ã€‚

### Comparable å’Œ Comparator æ¥å£æ˜¯ä»€ä¹ˆï¼Ÿ

å¦‚æœæˆ‘ä»¬æƒ³ä½¿ç”¨ Array æˆ– Collection çš„æ’åºæ–¹æ³•æ—¶ï¼Œéœ€è¦åœ¨è‡ªå®šä¹‰ç±»é‡Œå®ç° Java æä¾› Comparable æ¥å£ã€‚Comparable æ¥å£æœ‰ compareTo(T OBJ)
æ–¹æ³•ï¼Œå®ƒè¢«æ’åºæ–¹æ³•æ‰€ä½¿ç”¨ã€‚æˆ‘ä»¬åº”è¯¥é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œå¦‚æœâ€œthisâ€å¯¹è±¡æ¯”ä¼ é€’çš„å¯¹è±¡å‚æ•°æ›´å°ã€ç›¸ç­‰æˆ–æ›´å¤§æ—¶ï¼Œå®ƒè¿”å›ä¸€ä¸ªè´Ÿæ•´æ•°ã€0
æˆ–æ­£æ•´æ•°ã€‚ä½†æ˜¯ï¼Œåœ¨å¤§å¤šæ•°å®é™…æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æƒ³æ ¹æ®ä¸åŒå‚æ•°è¿›è¡Œæ’åºã€‚æ¯”å¦‚ï¼Œä½œä¸ºä¸€ä¸ª CEOï¼Œæˆ‘æƒ³å¯¹é›‡å‘˜åŸºäºè–ªèµ„è¿›è¡Œæ’åºï¼Œä¸€ä¸ª HR æƒ³åŸºäºå¹´é¾„å¯¹ä»–ä»¬è¿›è¡Œæ’åºã€‚è¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦ä½¿ç”¨
Comparator æ¥å£çš„æƒ…æ™¯ï¼Œå› ä¸º Comparable.compareTo(Object o) æ–¹æ³•å®ç°åªèƒ½åŸºäºä¸€ä¸ªå­—æ®µè¿›è¡Œæ’åºï¼Œæˆ‘ä»¬ä¸èƒ½æ ¹æ®å¯¹è±¡æ’åºçš„éœ€è¦é€‰æ‹©å­—æ®µã€‚
Comparator æ¥å£çš„ compare(Object o1, Object o2) æ–¹æ³•çš„å®ç°éœ€è¦ä¼ é€’ä¸¤ä¸ªå¯¹è±¡å‚æ•°ï¼Œè‹¥ç¬¬ä¸€ä¸ªå‚æ•°æ¯”ç¬¬äºŒä¸ªå°ï¼Œè¿”å›è´Ÿæ•´æ•°ï¼›è‹¥ç¬¬ä¸€ä¸ªç­‰äºç¬¬äºŒä¸ªï¼Œè¿”å›
0ï¼›è‹¥ç¬¬ä¸€ä¸ªæ¯”ç¬¬äºŒä¸ªå¤§ï¼Œè¿”å›æ­£æ•´æ•°ã€‚

### å½“ä¸€ä¸ªé›†åˆè¢«ä½œä¸ºå‚æ•°ä¼ é€’ç»™ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œå¦‚ä½•æ‰å¯ä»¥ç¡®ä¿å‡½æ•°ä¸èƒ½ä¿®æ”¹å®ƒï¼Ÿ

åœ¨ä½œä¸ºå‚æ•°ä¼ é€’ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ **Collections.unmodifiableCollection(Collection c)** æ–¹æ³•åˆ›å»ºä¸€ä¸ªåªè¯»é›†åˆï¼Œè¿™å°†ç¡®ä¿æ”¹å˜é›†åˆçš„ä»»ä½•æ“ä½œéƒ½ä¼šæŠ›å‡º
UnsupportedOperationExceptionã€‚

### å¤§å†™çš„ O æ˜¯ä»€ä¹ˆï¼Ÿä¸¾å‡ ä¸ªä¾‹å­ï¼Ÿ

å¤§å†™çš„ O æè¿°çš„æ˜¯ï¼Œå°±æ•°æ®ç»“æ„ä¸­çš„ä¸€ç³»åˆ—å…ƒç´ è€Œè¨€ï¼Œä¸€ä¸ªç®—æ³•çš„æ€§èƒ½ã€‚Collection ç±»å°±æ˜¯å®é™…çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬é€šå¸¸åŸºäºæ—¶é—´ã€å†…å­˜å’Œæ€§èƒ½ï¼Œä½¿ç”¨å¤§å†™çš„ O
æ¥é€‰æ‹©é›†åˆå®ç°ã€‚
æ¯”å¦‚ï¼š
ä¾‹å­ 1ï¼šArrayList çš„ get(index i) æ˜¯ä¸€ä¸ªå¸¸é‡æ—¶é—´æ“ä½œï¼Œå®ƒä¸ä¾èµ– list ä¸­å…ƒç´ çš„æ•°é‡ã€‚æ‰€ä»¥å®ƒçš„æ€§èƒ½æ˜¯ O(1)ã€‚
ä¾‹å­ 2ï¼šä¸€ä¸ªå¯¹äºæ•°ç»„æˆ–åˆ—è¡¨çš„çº¿æ€§æœç´¢çš„æ€§èƒ½æ˜¯ O(n)ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦éå†æ‰€æœ‰çš„å…ƒç´ æ¥æŸ¥æ‰¾éœ€è¦çš„å…ƒç´ ã€‚

### ä¸ Java é›†åˆæ¡†æ¶ç›¸å…³çš„æœ‰å“ªäº›æœ€å¥½çš„å®è·µï¼Ÿ

- æ ¹æ®éœ€è¦é€‰æ‹©æ­£ç¡®çš„é›†åˆç±»å‹ã€‚æ¯”å¦‚ï¼Œå¦‚æœæŒ‡å®šäº†å¤§å°ï¼Œæˆ‘ä»¬ä¼šé€‰ç”¨ Array è€Œé ArrayListã€‚å¦‚æœæˆ‘ä»¬æƒ³æ ¹æ®æ’å…¥é¡ºåºéå†ä¸€ä¸ª Mapï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨
  TreeMapã€‚å¦‚æœæˆ‘ä»¬ä¸æƒ³é‡å¤ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ Setã€‚
- ä¸€äº›é›†åˆç±»å…è®¸æŒ‡å®šåˆå§‹å®¹é‡ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿä¼°è®¡åˆ°å­˜å‚¨å…ƒç´ çš„æ•°é‡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒï¼Œå°±é¿å…äº†é‡æ–°å“ˆå¸Œæˆ–å¤§å°è°ƒæ•´ã€‚
- åŸºäºæ¥å£ç¼–ç¨‹ï¼Œè€ŒéåŸºäºå®ç°ç¼–ç¨‹ï¼Œå®ƒå…è®¸æˆ‘ä»¬åæ¥è½»æ˜“åœ°æ”¹å˜å®ç°ã€‚
- æ€»æ˜¯ä½¿ç”¨ç±»å‹å®‰å…¨çš„æ³›å‹ï¼Œé¿å…åœ¨è¿è¡Œæ—¶å‡ºç° ClassCastExceptionã€‚
- ä½¿ç”¨ JDK æä¾›çš„ä¸å¯å˜ç±»ä½œä¸º Map çš„ keyï¼Œå¯ä»¥é¿å…è‡ªå·±å®ç° hashCode()å’Œ equals()ã€‚
- å°½å¯èƒ½ä½¿ç”¨ Collections å·¥å…·ç±»ï¼Œæˆ–è€…è·å–åªè¯»ã€åŒæ­¥æˆ–ç©ºçš„é›†åˆï¼Œè€Œéç¼–å†™è‡ªå·±çš„å®ç°ã€‚å®ƒå°†ä¼šæé«˜ä»£ç é‡ç”¨æ€§ï¼Œå®ƒæœ‰ç€æ›´å¥½çš„ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

### HashMap è¿ç¯é—®é¢˜

#### ä½ ç”¨è¿‡ HashMap å—ï¼Ÿä»€ä¹ˆæ˜¯ HashMapï¼Ÿä½ ä¸ºä»€ä¹ˆç”¨åˆ°å®ƒï¼Ÿ

HashMap å¯ä»¥æ¥å— null é”®å€¼å’Œå€¼ï¼Œè€Œ Hashtable åˆ™ä¸èƒ½ï¼›
HashMap æ˜¯é synchronized;HashMap å¾ˆå¿«ï¼›
ä»¥åŠ HashMap å‚¨å­˜çš„æ˜¯é”®å€¼å¯¹ç­‰ç­‰ã€‚

### ä½ çŸ¥é“ HashMap çš„å·¥ä½œåŸç†å—ï¼Ÿ ä½ çŸ¥é“ HashMap çš„ get() æ–¹æ³•çš„å·¥ä½œåŸç†å—ï¼Ÿ

HashMap æ˜¯åŸºäº hashing çš„åŸç†ï¼Œæˆ‘ä»¬ä½¿ç”¨ put(key, value) å­˜å‚¨å¯¹è±¡åˆ° HashMap ä¸­ï¼Œä½¿ç”¨ get(key) ä» HashMap ä¸­è·å–å¯¹è±¡ã€‚
å½“æˆ‘ä»¬ç»™ put()æ–¹æ³•ä¼ é€’é”®å’Œå€¼æ—¶ï¼Œæˆ‘ä»¬å…ˆå¯¹é”®è°ƒç”¨ hashCode() æ–¹æ³•ï¼Œè¿”å›çš„ hashCode ç”¨äºæ‰¾åˆ° bucket ä½ç½®æ¥å‚¨å­˜ Entry å¯¹è±¡ã€‚

### å½“ä¸¤ä¸ªå¯¹è±¡çš„ hashcode ç›¸åŒä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

hashcode ç›¸åŒï¼Œæ‰€ä»¥å®ƒä»¬çš„ bucket ä½ç½®ç›¸åŒï¼Œâ€˜ç¢°æ’â€™ä¼šå‘ç”Ÿã€‚
å› ä¸º HashMap ä½¿ç”¨é“¾è¡¨å­˜å‚¨å¯¹è±¡ï¼Œè¿™ä¸ª Entry(åŒ…å«æœ‰é”®å€¼å¯¹çš„ Map.Entry å¯¹è±¡) ä¼šå­˜å‚¨åœ¨é“¾è¡¨ä¸­ã€‚

### å¦‚æœä¸¤ä¸ªé”®çš„ hashcode ç›¸åŒï¼Œä½ å¦‚ä½•è·å–å€¼å¯¹è±¡ï¼Ÿ

å½“æˆ‘ä»¬è°ƒç”¨ get() æ–¹æ³•ï¼ŒHashMap ä¼šä½¿ç”¨é”®å¯¹è±¡çš„ hashcode æ‰¾åˆ° bucket ä½ç½®ï¼Œç„¶åè·å–å€¼å¯¹è±¡ã€‚
é¢è¯•å®˜æé†’ä»–å¦‚æœæœ‰ä¸¤ä¸ªå€¼å¯¹è±¡å‚¨å­˜åœ¨åŒä¸€ä¸ª bucketï¼Œä»–ç»™å‡ºç­”æ¡ˆ:
å°†ä¼šéå†é“¾è¡¨ç›´åˆ°æ‰¾åˆ°å€¼å¯¹è±¡ã€‚é¢è¯•å®˜ä¼šé—®å› ä¸ºä½ å¹¶æ²¡æœ‰å€¼å¯¹è±¡å»æ¯”è¾ƒï¼Œä½ æ˜¯å¦‚ä½•ç¡®å®šç¡®å®šæ‰¾åˆ°å€¼å¯¹è±¡çš„ï¼Ÿé™¤éé¢è¯•è€…ç›´åˆ° HashMap åœ¨é“¾è¡¨ä¸­å­˜å‚¨çš„æ˜¯é”®å€¼å¯¹ï¼Œå¦åˆ™ä»–ä»¬ä¸å¯èƒ½å›ç­”å‡ºè¿™ä¸€é¢˜ã€‚

å…¶ä¸­ä¸€äº›è®°å¾—è¿™ä¸ªé‡è¦çŸ¥è¯†ç‚¹çš„é¢è¯•è€…ä¼šè¯´ï¼Œæ‰¾åˆ° bucket ä½ç½®ä¹‹åï¼Œä¼šè°ƒç”¨ keys.equals() æ–¹æ³•å»æ‰¾åˆ°é“¾è¡¨ä¸­æ­£ç¡®çš„èŠ‚ç‚¹ï¼Œæœ€ç»ˆæ‰¾åˆ°è¦æ‰¾çš„å€¼å¯¹è±¡ã€‚å®Œç¾çš„ç­”æ¡ˆï¼

è®¸å¤šæƒ…å†µä¸‹ï¼Œé¢è¯•è€…ä¼šåœ¨è¿™ä¸ªç¯èŠ‚ä¸­å‡ºé”™ï¼Œå› ä¸ºä»–ä»¬æ··æ·†äº† hashCode()å’Œ equals() æ–¹æ³•ã€‚å› ä¸ºåœ¨æ­¤ä¹‹å‰ hashCode()å±¡å±¡å‡ºç°ï¼Œè€Œ equals()
æ–¹æ³•ä»…ä»…åœ¨è·å–å€¼å¯¹è±¡çš„æ—¶å€™æ‰å‡ºç°ã€‚ä¸€äº›ä¼˜ç§€çš„å¼€å‘è€…ä¼šæŒ‡å‡ºä½¿ç”¨ä¸å¯å˜çš„ã€å£°æ˜ä½œ final çš„å¯¹è±¡ï¼Œå¹¶ä¸”é‡‡ç”¨åˆé€‚çš„ equals()å’Œ hashCode()
æ–¹æ³•çš„è¯ï¼Œå°†ä¼šå‡å°‘ç¢°æ’çš„å‘ç”Ÿï¼Œæé«˜æ•ˆç‡ã€‚ä¸å¯å˜æ€§ä½¿å¾—èƒ½å¤Ÿç¼“å­˜ä¸åŒé”®çš„ hashcodeï¼Œè¿™å°†æé«˜æ•´ä¸ªè·å–å¯¹è±¡çš„é€Ÿåº¦ï¼Œä½¿ç”¨ Stringï¼ŒInterger è¿™æ ·çš„ wrapper
ç±»ä½œä¸ºé”®æ˜¯éå¸¸å¥½çš„é€‰æ‹©ã€‚

### å¦‚æœ HashMap çš„å¤§å°è¶…è¿‡äº†è´Ÿè½½å› å­ (load factor) å®šä¹‰çš„å®¹é‡ï¼Œæ€ä¹ˆåŠï¼Ÿ

é»˜è®¤çš„è´Ÿè½½å› å­å¤§å°ä¸º 0.75ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä¸€ä¸ª map å¡«æ»¡äº† 75% çš„ bucket æ—¶å€™ï¼Œå’Œå…¶å®ƒé›†åˆç±» (å¦‚ ArrayList ç­‰) ä¸€æ ·ï¼Œå°†ä¼šåˆ›å»ºåŸæ¥ HashMap å¤§å°çš„ä¸¤å€çš„
bucket æ•°ç»„ï¼Œæ¥é‡æ–°è°ƒæ•´ map çš„å¤§å°ï¼Œå¹¶å°†åŸæ¥çš„å¯¹è±¡æ”¾å…¥æ–°çš„ bucket æ•°ç»„ä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹å«ä½œ rehashingï¼Œå› ä¸ºå®ƒè°ƒç”¨ hash æ–¹æ³•æ‰¾åˆ°æ–°çš„ bucket ä½ç½®ã€‚

### ä½ äº†è§£é‡æ–°è°ƒæ•´ HashMap å¤§å°å­˜åœ¨ä»€ä¹ˆé—®é¢˜å—ï¼Ÿ

å¯èƒ½äº§ç”Ÿæ¡ä»¶ç«äº‰ (race condition)ã€‚
å½“é‡æ–°è°ƒæ•´ HashMap å¤§å°çš„æ—¶å€™ï¼Œç¡®å®å­˜åœ¨æ¡ä»¶ç«äº‰ï¼Œå› ä¸ºå¦‚æœä¸¤ä¸ªçº¿ç¨‹éƒ½å‘ç° HashMap éœ€è¦é‡æ–°è°ƒæ•´å¤§å°äº†ï¼Œå®ƒä»¬ä¼šåŒæ—¶è¯•ç€è°ƒæ•´å¤§å°ã€‚åœ¨è°ƒæ•´å¤§å°çš„è¿‡ç¨‹ä¸­ï¼Œå­˜å‚¨åœ¨é“¾è¡¨ä¸­çš„å…ƒç´ çš„æ¬¡åºä¼šåè¿‡æ¥ï¼Œå› ä¸ºç§»åŠ¨åˆ°æ–°çš„
bucket ä½ç½®çš„æ—¶å€™ï¼ŒHashMap å¹¶ä¸ä¼šå°†å…ƒç´ æ”¾åœ¨é“¾è¡¨çš„å°¾éƒ¨ï¼Œè€Œæ˜¯æ”¾åœ¨å¤´éƒ¨ï¼Œè¿™æ˜¯ä¸ºäº†é¿å…å°¾éƒ¨éå† (tail traversing)
ã€‚å¦‚æœæ¡ä»¶ç«äº‰å‘ç”Ÿäº†ï¼Œé‚£ä¹ˆå°±æ­»å¾ªç¯äº†ã€‚è¿™ä¸ªæ—¶å€™ï¼Œä½ å¯ä»¥è´¨é—®é¢è¯•å®˜ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆå¥‡æ€ªï¼Œè¦åœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸‹ä½¿ç”¨ HashMap å‘¢

### ä¸ºä»€ä¹ˆ String, Interger è¿™æ ·çš„ wrapper ç±»é€‚åˆä½œä¸ºé”®ï¼Ÿ

String, Interger è¿™æ ·çš„ wrapper ç±»ä½œä¸º HashMap çš„é”®æ˜¯å†é€‚åˆä¸è¿‡äº†ï¼Œè€Œä¸” String æœ€ä¸ºå¸¸ç”¨ã€‚å› ä¸º String æ˜¯ä¸å¯å˜çš„ï¼Œä¹Ÿæ˜¯ final çš„ï¼Œè€Œä¸”å·²ç»é‡å†™äº†
equals()å’Œ hashCode() æ–¹æ³•äº†ã€‚å…¶ä»–çš„ wrapper ç±»ä¹Ÿæœ‰è¿™ä¸ªç‰¹ç‚¹ã€‚ä¸å¯å˜æ€§æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºä¸ºäº†è¦è®¡ç®— hashCode()ï¼Œå°±è¦é˜²æ­¢é”®å€¼æ”¹å˜ï¼Œå¦‚æœé”®å€¼åœ¨æ”¾å…¥æ—¶å’Œè·å–æ—¶è¿”å›ä¸åŒçš„
hashcode çš„è¯ï¼Œé‚£ä¹ˆå°±ä¸èƒ½ä» HashMap ä¸­æ‰¾åˆ°ä½ æƒ³è¦çš„å¯¹è±¡ã€‚ä¸å¯å˜æ€§è¿˜æœ‰å…¶ä»–çš„ä¼˜ç‚¹å¦‚çº¿ç¨‹å®‰å…¨ã€‚å¦‚æœä½ å¯ä»¥ä»…ä»…é€šè¿‡å°†æŸä¸ª field å£°æ˜æˆ final å°±èƒ½ä¿è¯
hashCode æ˜¯ä¸å˜çš„ï¼Œé‚£ä¹ˆè¯·è¿™ä¹ˆåšå§ã€‚å› ä¸ºè·å–å¯¹è±¡çš„æ—¶å€™è¦ç”¨åˆ° equals()å’Œ hashCode() æ–¹æ³•ï¼Œé‚£ä¹ˆé”®å¯¹è±¡æ­£ç¡®çš„é‡å†™è¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯éå¸¸é‡è¦çš„ã€‚å¦‚æœä¸¤ä¸ªä¸ç›¸ç­‰çš„å¯¹è±¡è¿”å›ä¸åŒçš„
hashcode çš„è¯ï¼Œé‚£ä¹ˆç¢°æ’çš„å‡ ç‡å°±ä¼šå°äº›ï¼Œè¿™æ ·å°±èƒ½æé«˜ HashMap çš„æ€§èƒ½ã€‚

### æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„å¯¹è±¡ä½œä¸ºé”®å—ï¼Ÿ

è¿™æ˜¯å‰ä¸€ä¸ªé—®é¢˜çš„å»¶ä¼¸ã€‚å½“ç„¶ä½ å¯èƒ½ä½¿ç”¨ä»»ä½•å¯¹è±¡ä½œä¸ºé”®ï¼Œåªè¦å®ƒéµå®ˆäº† equals()å’Œ hashCode() æ–¹æ³•çš„å®šä¹‰è§„åˆ™ï¼Œå¹¶ä¸”å½“å¯¹è±¡æ’å…¥åˆ° Map
ä¸­ä¹‹åå°†ä¸ä¼šå†æ”¹å˜äº†ã€‚å¦‚æœè¿™ä¸ªè‡ªå®šä¹‰å¯¹è±¡æ—¶ä¸å¯å˜çš„ï¼Œé‚£ä¹ˆå®ƒå·²ç»æ»¡è¶³äº†ä½œä¸ºé”®çš„æ¡ä»¶ï¼Œå› ä¸ºå½“å®ƒåˆ›å»ºä¹‹åå°±å·²ç»ä¸èƒ½æ”¹å˜äº†ã€‚

### æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ CocurrentHashMap æ¥ä»£æ›¿ Hashtable å—ï¼Ÿ

è¿™æ˜¯å¦å¤–ä¸€ä¸ªå¾ˆçƒ­é—¨çš„é¢è¯•é¢˜ï¼Œå› ä¸º ConcurrentHashMap è¶Šæ¥è¶Šå¤šäººç”¨äº†ã€‚æˆ‘ä»¬çŸ¥é“ Hashtable æ˜¯ synchronized çš„ï¼Œä½†æ˜¯ ConcurrentHashMap
åŒæ­¥æ€§èƒ½æ›´å¥½ï¼Œå› ä¸ºå®ƒä»…ä»…æ ¹æ®åŒæ­¥çº§åˆ«å¯¹ map çš„ä¸€éƒ¨åˆ†è¿›è¡Œä¸Šé”ã€‚ConcurrentHashMap å½“ç„¶å¯ä»¥ä»£æ›¿ HashTableï¼Œä½†æ˜¯ HashTable æä¾›æ›´å¼ºçš„çº¿ç¨‹å®‰å…¨æ€§ã€‚

- hashing çš„æ¦‚å¿µ
- HashMap ä¸­è§£å†³ç¢°æ’çš„æ–¹æ³•
- equals()å’Œ hashCode() çš„åº”ç”¨ï¼Œä»¥åŠå®ƒä»¬åœ¨ HashMap ä¸­çš„é‡è¦æ€§
- ä¸å¯å˜å¯¹è±¡çš„å¥½å¤„
- HashMap å¤šçº¿ç¨‹çš„æ¡ä»¶ç«äº‰
- é‡æ–°è°ƒæ•´ HashMap çš„å¤§å°

## æ€»ç»“

HashMap åŸºäº hashing åŸç†ï¼Œæˆ‘ä»¬é€šè¿‡ put()å’Œ get() æ–¹æ³•å‚¨å­˜å’Œè·å–å¯¹è±¡ã€‚å½“æˆ‘ä»¬å°†é”®å€¼å¯¹ä¼ é€’ç»™ put()æ–¹æ³•æ—¶ï¼Œå®ƒè°ƒç”¨é”®å¯¹è±¡çš„ hashCode() æ–¹æ³•æ¥è®¡ç®—
hashcodeï¼Œè®©åæ‰¾åˆ° bucket ä½ç½®æ¥å‚¨å­˜å€¼å¯¹è±¡ã€‚å½“è·å–å¯¹è±¡æ—¶ï¼Œé€šè¿‡é”®å¯¹è±¡çš„ equals() æ–¹æ³•æ‰¾åˆ°æ­£ç¡®çš„é”®å€¼å¯¹ï¼Œç„¶åè¿”å›å€¼å¯¹è±¡ã€‚HashMap
ä½¿ç”¨é“¾è¡¨æ¥è§£å†³ç¢°æ’é—®é¢˜ï¼Œå½“å‘ç”Ÿç¢°æ’äº†ï¼Œå¯¹è±¡å°†ä¼šå‚¨å­˜åœ¨é“¾è¡¨çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸­ã€‚ HashMap åœ¨æ¯ä¸ªé“¾è¡¨èŠ‚ç‚¹ä¸­å‚¨å­˜é”®å€¼å¯¹å¯¹è±¡ã€‚
å½“ä¸¤ä¸ªä¸åŒçš„é”®å¯¹è±¡çš„ hashcode ç›¸åŒæ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ å®ƒä»¬ä¼šå‚¨å­˜åœ¨åŒä¸€ä¸ª bucket ä½ç½®çš„é“¾è¡¨ä¸­ã€‚é”®å¯¹è±¡çš„ equals() æ–¹æ³•ç”¨æ¥æ‰¾åˆ°é”®å€¼å¯¹ã€‚

## [JavaåŸºç¡€ï¼šçŸ¥è¯†ç‚¹æ€»ç»“ä¸€](https://blog.dong4j.site/posts/b89d16dd.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## serializable çš„æ„ä¹‰

1. æ¯”å¦‚è¯´ä½ çš„å†…å­˜ä¸å¤Ÿç”¨äº†, é‚£è®¡ç®—æœºå°±è¦å°†å†…å­˜é‡Œé¢çš„ä¸€éƒ¨åˆ†å¯¹è±¡æš‚æ—¶çš„ä¿å­˜åˆ°ç¡¬ç›˜ä¸­, ç­‰åˆ°è¦ç”¨çš„æ—¶å€™å†è¯»å…¥åˆ°å†…å­˜ä¸­, ç¡¬ç›˜çš„é‚£éƒ¨åˆ†å­˜å‚¨ç©ºé—´å°±æ˜¯æ‰€è°“çš„è™šæ‹Ÿå†…å­˜.
   åœ¨æ¯”å¦‚è¿‡ä½ è¦å°†æŸä¸ªç‰¹å®šçš„å¯¹è±¡ä¿å­˜åˆ°æ–‡ä»¶ä¸­, æˆ‘éš”å‡ å¤©åœ¨æŠŠå®ƒæ‹¿å‡ºæ¥ç”¨, é‚£ä¹ˆè¿™æ—¶å€™å°±è¦å®ç° Serializable æ¥å£ï¼›
2. åœ¨è¿›è¡Œ java çš„ Socket ç¼–ç¨‹çš„æ—¶å€™, ä½ æœ‰æ—¶å€™å¯èƒ½è¦ä¼ è¾“æŸä¸€ç±»çš„å¯¹è±¡, é‚£ä¹ˆä¹Ÿå°±è¦å®ç° Serializable æ¥å£ï¼›æœ€å¸¸è§çš„ä½ ä¼ è¾“ä¸€ä¸ªå­—ç¬¦ä¸², å®ƒæ˜¯ JDK
   é‡Œé¢çš„ç±», ä¹Ÿå®ç°äº† Serializable æ¥å£, æ‰€ä»¥å¯ä»¥åœ¨ç½‘ç»œä¸Šä¼ è¾“.
3. å¦‚æœè¦é€šè¿‡è¿œç¨‹çš„æ–¹æ³•è°ƒç”¨ï¼ˆRMIï¼‰å»è°ƒç”¨ä¸€ä¸ªè¿œç¨‹å¯¹è±¡çš„æ–¹æ³•, å¦‚åœ¨è®¡ç®—æœº A ä¸­è°ƒç”¨å¦ä¸€å°è®¡ç®—æœº B çš„å¯¹è±¡çš„æ–¹æ³•, é‚£ä¹ˆä½ éœ€è¦é€šè¿‡ JNDI æœåŠ¡è·å–è®¡ç®—æœº
   B ç›®æ ‡å¯¹è±¡çš„å¼•ç”¨, å°†å¯¹è±¡ä» B ä¼ é€åˆ° A, å°±éœ€è¦å®ç°åºåˆ—åŒ–æ¥å£.

ä¾‹å¦‚:

åœ¨ web å¼€å‘ä¸­, å¦‚æœå¯¹è±¡è¢«ä¿å­˜åœ¨äº† Session ä¸­, tomcat åœ¨é‡å¯æ—¶è¦æŠŠ Session å¯¹è±¡åºåˆ—åŒ–åˆ°ç¡¬ç›˜, è¿™ä¸ªå¯¹è±¡å°±å¿…é¡»å®ç° Serializable æ¥å£.

å¦‚æœå¯¹è±¡è¦ç»è¿‡åˆ†å¸ƒå¼ç³»ç»Ÿ è¿›è¡Œç½‘ç»œä¼ è¾“æˆ–é€šè¿‡ rmi ç­‰è¿œç¨‹è°ƒç”¨, è¿™å°±éœ€è¦åœ¨ç½‘ç»œä¸Šä¼ è¾“å¯¹è±¡, è¢«ä¼ è¾“çš„å¯¹è±¡å°±å¿… é¡»å®ç° Serializable æ¥å£.

## å•ä¾‹æ¨¡å¼

1. æ‡’æ±‰æ¨¡å¼
2. é¥¿æ±‰æ¨¡å¼
3. åŒæ­¥é”
4. åŒé”æœºåˆ¶
5. æšä¸¾å®ç°
6. é™æ€å†…éƒ¨ç±»å®ç°

å› ä¸ºåŠ è½½å¤–éƒ¨ç±»æ—¶, æ˜¯ä¸ä¼šåŠ è½½å†…éƒ¨ç±»çš„

```java
// ä¸€ä¸ªå»¶è¿Ÿå®ä¾‹åŒ–çš„å†…éƒ¨ç±»çš„å•ä¾‹æ¨¡å¼
public final class Singleton {
    // ä¸€ä¸ªå†…éƒ¨ç±»çš„å®¹å™¨, è°ƒç”¨ getInstance æ—¶, JVM åŠ è½½è¿™ä¸ªç±»
    private static final class SingletonHolder {
        static final Singleton singleton =  new Singleton();
    }
    private Singleton(){}
    public static Singleton getInstance() {
        return SingletonHolder.singleton;
    }
 }
```

**é˜²æ­¢åå°„å®ä¾‹åŒ–å¯¹è±¡**
åˆ©ç”¨åå°„ç”Ÿæˆå¯¹è±¡

```java
// ä½¿ç”¨åå°„ç ´åå•ä¾‹æ¨¡å¼
Class c = Class.forName(Singleton.class.getName());
Constructor constructor = c.getDeclaredConstructor();
constructor.setAccessible(true);
Singleton singleton = (Singleton)ct.newInstance();
```

è°ƒç”¨ç§æœ‰æ„é€ æ–¹æ³•æŠ›å‡ºå¼‚å¸¸
**é˜²æ­¢ååºåˆ—åŒ–å®ä¾‹åŒ–å¯¹è±¡**

```java
import java.io.Serializable;
/**
 * Created by hollis on 16/2/5.
 * ä½¿ç”¨åŒé‡æ ¡éªŒé”æ–¹å¼å®ç°å•ä¾‹
 */
public class Singleton implements Serializable{
    private volatile static Singleton singleton;
    private Singleton (){}
    public static Singleton getSingleton() {
        if (singleton == null) {
            synchronized (Singleton.class) {
                if (singleton == null) {
                    singleton = new Singleton();
                }
            }
        }
        return singleton;
    }
}
```

```java
public class SerializableDemo1 {
    // ä¸ºäº†ä¾¿äºç†è§£, å¿½ç•¥å…³é—­æµæ“ä½œåŠåˆ é™¤æ–‡ä»¶æ“ä½œ. çœŸæ­£ç¼–ç æ—¶åƒä¸‡ä¸è¦å¿˜è®°
    // Exception ç›´æ¥æŠ›å‡º
    public static void main(String[] args) throws IOException, ClassNotFoundException {
        // Write Obj to file
        ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream("tempFile"));
        oos.writeObject(Singleton.getSingleton());
        // Read Obj from file
        File file = new File("tempFile");
        ObjectInputStream ois =  new ObjectInputStream(new FileInputStream(file));
        Singleton newInstance = (Singleton) ois.readObject();
        // åˆ¤æ–­æ˜¯å¦æ˜¯åŒä¸€ä¸ªå¯¹è±¡
        System.out.println(newInstance == Singleton.getSingleton());
    }
}
```

é˜²æ­¢åºåˆ—åŒ–ååºåˆ—åŒ–ç ´åå•ä¾‹çš„æ–¹æ³•:
æ·»åŠ  readResolve æ–¹æ³•

```java
private Object readResolve() {
        return singleton;
    }
```

åˆ©ç”¨æšä¸¾åˆ›å»ºå•ä¾‹

```java
/**
* Singleton pattern example using Java Enumj
*/
public enum EasySingleton{
    INSTANCE;
}
```

**ä½¿ç”¨åå°„ç ´è§£æšä¸¾å•ä¾‹:**
è¿è¡Œç»“æœæ˜¯æŠ›å‡ºå¼‚å¸¸: `Exception in thread "main" java.lang.NoSuchMethodException: cn.xing.test.Weekday.<init>()`
æ˜æ˜ Weekday æœ‰ä¸€ä¸ªæ— å‚çš„æ„é€ å‡½æ•°, ä¸ºä½•ä¸èƒ½é€šè¿‡æš´åŠ›åå°„è®¿é—®?
æœ€æ–°çš„ Java Language Specification (Â§8.9) è§„å®š: Reflective instantiation of enum types is prohibited. è¿™æ˜¯ java è¯­è¨€çš„å†…ç½®è§„èŒƒ.

**ä½¿ç”¨ clone ç ´è§£æšä¸¾å•ä¾‹**
æ‰€æœ‰çš„æšä¸¾ç±»éƒ½ç»§æ‰¿è‡ª java.lang.Enum ç±», è€Œä¸æ˜¯ Object ç±». åœ¨ java.lang.Enum ç±»ä¸­ clone æ–¹æ³•å¦‚ä¸‹:

```java
protected final Object clone() throws CloneNotSupportedException {
    throw new CloneNotSupportedException();
}
```

è°ƒç”¨è¯¥æ–¹æ³•å°†æŠ›å‡ºå¼‚å¸¸, ä¸” final æ„å‘³ç€å­ç±»ä¸èƒ½é‡å†™ clone æ–¹æ³•, æ‰€ä»¥é€šè¿‡ clone æ–¹æ³•è·å–æ–°çš„å¯¹è±¡æ˜¯ä¸å¯å–çš„.

**ä½¿ç”¨åºåˆ—åŒ–ç ´è§£æšä¸¾å•ä¾‹**
java.lang.Enum ç±»çš„ readObject æ–¹æ³•å¦‚ä¸‹:

```java
private void readObject(ObjectInputStream in) throws IOException,
        ClassNotFoundException {
            throw new InvalidObjectException("can't deserialize enum");
}
private void readObjectNoData() throws ObjectStreamException {
        throw new InvalidObjectException("can't deserialize enum");
}
```

åŒæš´åŠ›åå°„ä¸€æ ·, Java Language Specification (Â§8.9) æœ‰ç€è¿™æ ·çš„è§„å®š: the special treatment by the serialization mechanism ensures that
duplicate instances are never created as a result of deserialization.

## fork/join

![20241229154732_FBhCkAUC.webp](https://cdn.dong4j.site/source/image/20241229154732_FBhCkAUC.webp)

fork/join ç±»ä¼¼ MapReduce ç®—æ³•, ä¸¤è€…åŒºåˆ«æ˜¯: Fork/Join åªæœ‰åœ¨å¿…è¦æ—¶å¦‚ä»»åŠ¡éå¸¸å¤§çš„æƒ…å†µä¸‹æ‰åˆ†å‰²æˆä¸€ä¸ªä¸ªå°ä»»åŠ¡, è€Œ MapReduce æ€»æ˜¯åœ¨å¼€å§‹æ‰§è¡Œç¬¬ä¸€æ­¥è¿›è¡Œåˆ†å‰².
çœ‹æ¥, Fork/Join æ›´é€‚åˆä¸€ä¸ª JVM å†…çº¿ç¨‹çº§åˆ«, è€Œ MapReduce é€‚åˆåˆ†å¸ƒå¼ç³»ç»Ÿ.

## NIO å’Œ AIO

NIO :

1. NIO ä¼šå°†æ•°æ®å‡†å¤‡å¥½å, å†äº¤ç”±åº”ç”¨è¿›è¡Œå¤„ç†, æ•°æ®çš„è¯»å– / å†™å…¥è¿‡ç¨‹ä¾ç„¶åœ¨åº”ç”¨çº¿ç¨‹ä¸­å®Œæˆ, åªæ˜¯å°†ç­‰å¾…çš„æ—¶é—´å‰¥ç¦»åˆ°å•ç‹¬çš„çº¿ç¨‹ä¸­å».
2. èŠ‚çœæ•°æ®å‡†å¤‡æ—¶é—´ï¼ˆå› ä¸º Selector å¯ä»¥å¤ç”¨ï¼‰

AIO:

1. è¯»å®Œäº†å†é€šçŸ¥æˆ‘
2. ä¸ä¼šåŠ å¿« IO, åªæ˜¯åœ¨è¯»å®Œåè¿›è¡Œé€šçŸ¥
3. ä½¿ç”¨å›è°ƒå‡½æ•°, è¿›è¡Œä¸šåŠ¡å¤„ç†

## åºåˆ—åŒ–å’Œååºåˆ—åŒ–

- åªæœ‰å®ç°äº† Serializable å’Œ Externalizable æ¥å£çš„ç±»çš„å¯¹è±¡æ‰èƒ½è¢«åºåˆ—åŒ–. Externalizable æ¥å£ç»§æ‰¿è‡ª Serializable æ¥å£, å®ç° Externalizable
  æ¥å£çš„ç±»å®Œå…¨ç”±è‡ªèº«æ¥æ§åˆ¶åºåˆ—åŒ–çš„è¡Œä¸º, è€Œä»…å®ç° Serializable æ¥å£çš„ç±»å¯ä»¥é‡‡ç”¨é»˜è®¤çš„åºåˆ—åŒ–æ–¹å¼ .
- é»˜è®¤å®ç° Serializable æ¥å£çš„åºåˆ—åŒ–æ˜¯å¯¹äºä¸€ä¸ªç±»çš„é static, é transient çš„å®ä¾‹å˜é‡è¿›è¡Œåºåˆ—åŒ–ä¸ååºåˆ—åŒ–. åˆšåˆšä¸Šé¢ä¹Ÿè¯´äº†, å¦‚æœè¦å¯¹ static
  å®ä¾‹å˜é‡è¿›è¡Œåºåˆ—åŒ–å°±è¦ä½¿ç”¨ Externalizable æ¥å£, æ‰‹åŠ¨å®ç°.
- serialVersionUID çš„ä½œç”¨
- çˆ¶ç±»çš„åºåˆ—åŒ–
  - è¦æƒ³å°†çˆ¶ç±»å¯¹è±¡ä¹Ÿåºåˆ—åŒ–, å°±éœ€è¦è®©çˆ¶ç±»ä¹Ÿå®ç° Serializable æ¥å£. å¦‚æœçˆ¶ç±»ä¸å®ç°çš„è¯çš„, å°±éœ€è¦æœ‰é»˜è®¤çš„æ— å‚çš„æ„é€ å‡½æ•°. åœ¨çˆ¶ç±»æ²¡æœ‰å®ç°
    Serializable æ¥å£æ—¶, è™šæ‹Ÿæœºæ˜¯ä¸ä¼šåºåˆ—åŒ–çˆ¶å¯¹è±¡çš„, è€Œä¸€ä¸ª Java å¯¹è±¡çš„æ„é€ å¿…é¡»å…ˆæœ‰çˆ¶å¯¹è±¡, æ‰æœ‰å­å¯¹è±¡, ååºåˆ—åŒ–ä¹Ÿä¸ä¾‹å¤–. æ‰€ä»¥ååºåˆ—åŒ–æ—¶,
    ä¸ºäº†æ„é€ çˆ¶å¯¹è±¡, åªèƒ½è°ƒç”¨çˆ¶ç±»çš„æ— å‚æ„é€ å‡½æ•°ä½œä¸ºé»˜è®¤çš„çˆ¶å¯¹è±¡. å› æ­¤å½“æˆ‘ä»¬å–çˆ¶å¯¹è±¡çš„å˜é‡å€¼æ—¶, å®ƒçš„å€¼æ˜¯è°ƒç”¨çˆ¶ç±»æ— å‚æ„é€ å‡½æ•°åçš„å€¼. å¦‚æœä½ 
    kao è™‘åˆ°è¿™ç§åºåˆ—åŒ–çš„æƒ…å†µ, åœ¨çˆ¶ç±»æ— å‚æ„é€ å‡½æ•°ä¸­å¯¹å˜é‡è¿›è¡Œåˆå§‹åŒ–, å¦åˆ™çš„è¯, çˆ¶ç±»å˜é‡å€¼éƒ½æ˜¯é»˜è®¤å£°æ˜çš„å€¼, å¦‚ int å‹çš„é»˜è®¤æ˜¯ 0, string
    å‹çš„é»˜è®¤æ˜¯ null.
- å…³é”®å­— transient
- å½“æŒä¹…åŒ–å¯¹è±¡æ—¶, å¯èƒ½æœ‰ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡æ•°æ®æˆå‘˜, æˆ‘ä»¬ä¸æƒ³ç”¨ serialization æœºåˆ¶æ¥ä¿å­˜å®ƒ. ä¸ºäº†åœ¨ä¸€ä¸ªç‰¹å®šå¯¹è±¡çš„ä¸€ä¸ªåŸŸä¸Šå…³é—­ serialization,
  å¯ä»¥åœ¨è¿™ä¸ªåŸŸå‰åŠ ä¸Šå…³é”®å­— transient.
  transient æ˜¯ Java è¯­è¨€çš„å…³é”®å­—, ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªåŸŸä¸æ˜¯è¯¥å¯¹è±¡åºåˆ—åŒ–çš„ä¸€éƒ¨åˆ†. å½“ä¸€ä¸ªå¯¹è±¡è¢«åºåˆ—åŒ–çš„æ—¶å€™, transient å‹å˜é‡çš„å€¼ä¸åŒ…æ‹¬åœ¨åºåˆ—åŒ–çš„è¡¨ç¤ºä¸­,
  ç„¶è€Œé transient å‹çš„å˜é‡æ˜¯è¢«åŒ…æ‹¬è¿›å»çš„

## Integer

```java
int i = 0;
Integer j = new Integer(0);
System.out.println(i==j);
System.out.println(j.equals(i));
```

åœ¨ JDK1.5 ä»¥å‰, ä¼šæŠ¥é”™
åœ¨ JDK1.5 å, ç”±äºå¼•å…¥äº†è‡ªåŠ¨è£…ç®±å’Œæ‹†ç®±, ä¼šè¾“å…¥ true,true

## è¿›åˆ¶

å¦‚æœä¸‹åˆ—çš„å…¬å¼æˆç«‹: 78+78=123. åˆ™é‡‡ç”¨çš„æ˜¯ï¼ˆï¼‰è¿›åˆ¶è¡¨ç¤ºçš„?
è§£æä¸€:
è®¾è¿›åˆ¶æ•°ä¸º x, æ ¹æ®é¢˜è®¾å…¬å¼å±•å¼€ä¸º 7*x+8+7*x+8=1*x^2+2*x+3, ç”±äºè¿›åˆ¶æ•°å¿…é¡»ä¸ºæ­£æ•´æ•°, å¾—åˆ° x=13.
è§£æäºŒ:
ç­‰å¼å·¦è¾¹ä¸ªä½æ•°ç›¸åŠ ä¸º 16, ç­‰å¼å³è¾¹ä¸ªä½æ•°ä¸º 3, å³ 16 mod x=3, x=13.

## == å’Œ equals

```java
String i = "0";
String j = new String("0");
System.out.println(i==j); // æ¯”å€¼
System.out.println(j.equals(i)); // æ¯”å†…å®¹
```

false,true

## å¼ºå¼•ç”¨ è½¯å¼•ç”¨ å¼±å¼•ç”¨ è™šå¼•ç”¨

### å¼ºå¼•ç”¨

- å¦‚æœä¸€ä¸ªå¯¹è±¡å…·æœ‰å¼ºå¼•ç”¨, GC ç»ä¸ä¼šå›æ”¶å®ƒï¼›
- å½“å†…å­˜ç©ºé—´ä¸è¶³, JVM å®æ„¿æŠ›å‡º OutOfMemoryError é”™è¯¯.
- ä¸€èˆ¬ new å‡ºæ¥çš„å¯¹è±¡éƒ½æ˜¯å¼ºå¼•ç”¨, å¦‚ä¸‹

```java
// å¼ºå¼•ç”¨
User strangeReference=new User();
```

> ä»¥å‰æˆ‘ä»¬ä½¿ç”¨çš„å¤§éƒ¨åˆ†å¼•ç”¨å®é™…ä¸Šéƒ½æ˜¯å¼ºå¼•ç”¨, è¿™æ˜¯ä½¿ç”¨æœ€æ™®éçš„å¼•ç”¨. å¦‚æœä¸€ä¸ªå¯¹è±¡å…·æœ‰å¼ºå¼•ç”¨, é‚£å°±ç±»ä¼¼äºå¿…ä¸å¯å°‘çš„ç”Ÿæ´»ç”¨å“, åƒåœ¾å›æ”¶å™¨ç»ä¸ä¼šå›æ”¶å®ƒ.
> å½“å†…å­˜ç©º é—´ä¸è¶³, Java è™šæ‹Ÿæœºå®æ„¿æŠ›å‡º OutOfMemoryError é”™è¯¯, ä½¿ç¨‹åºå¼‚å¸¸ç»ˆæ­¢, ä¹Ÿä¸ä¼šé éšæ„å›æ”¶å…·æœ‰å¼ºå¼•ç”¨çš„å¯¹è±¡æ¥è§£å†³å†…å­˜ä¸è¶³é—®é¢˜.

### è½¯å¼•ç”¨

å¦‚æœä¸€ä¸ªå¯¹è±¡å…·æœ‰è½¯å¼•ç”¨, å½“å†…å­˜ç©ºé—´ä¸è¶³, GC ä¼šå›æ”¶è¿™äº›å¯¹è±¡çš„å†…å­˜, ä½¿ç”¨è½¯å¼•ç”¨æ„å»ºæ•æ„Ÿæ•°æ®çš„ç¼“å­˜.  
åœ¨ JVM ä¸­, è½¯å¼•ç”¨æ˜¯å¦‚ä¸‹å®šä¹‰çš„, å¯ä»¥é€šè¿‡ä¸€ä¸ªæ—¶é—´æˆ³æ¥å›æ”¶, ä¸‹é¢å¼•è‡ª JVM:

```java
public class SoftReference<T> extends Reference<T> {

  /**
    * Timestamp clock, updated by the garbage collector
    */
  static private long clock;

  /**
    * Timestamp updated by each invocation of the get method.  The VM may use
    * this field when selecting soft references to be cleared, but it is not
    * required to do so.
    */
  private long timestamp;

  /**
    * Creates a new soft reference that refers to the given object.  The new
    * reference is not registered with any queue.
    *
    * @param referent object the new soft reference will refer to
    */
  public SoftReference(T referent) {
      super(referent);
      this.timestamp = clock;
  }

  /**
    * Creates a new soft reference that refers to the given object and is
    * registered with the given queue.
    *
    * @param referent object the new soft reference will refer to
    * @param q the queue with which the reference is to be registered,
    *          or <tt>null</tt> if registration is not required
    *
    */
  public SoftReference(T referent, ReferenceQueue<? super T> q) {
      super(referent, q);
      this.timestamp = clock;
  }

  /**
    * Returns this reference object's referent.  If this reference object has
    * been cleared, either by the program or by the garbage collector, then
    * this method returns <code>null</code>.
    *
    * @return   The object to which this reference refers, or
    *           <code>null</code> if this reference object has been cleared
    */
  public T get() {
      T o = super.get();
      if (o != null && this.timestamp != clock)
          this.timestamp = clock;
      return o;
  }
}
```

è½¯å¼•ç”¨çš„å£°æ˜çš„å€ŸåŠ©å¼ºå¼•ç”¨æˆ–è€…åŒ¿åå¯¹è±¡, ä½¿ç”¨æ³›å‹ SoftReferenceï¼›å¯ä»¥é€šè¿‡ get æ–¹æ³•è·å¾—å¼ºå¼•ç”¨. å…·ä½“å¦‚ä¸‹:

```java
// è½¯å¼•ç”¨
SoftReference<User>softReference=new SoftReference<User>(new User());
strangeReference=softReference.get();// é€šè¿‡ get æ–¹æ³•è·å¾—å¼ºå¼•ç”¨
```

å¦‚æœä¸€ä¸ªå¯¹è±¡åªå…·æœ‰è½¯å¼•ç”¨, é‚£å°±ç±»ä¼¼äºå¯æœ‰å¯ç‰©çš„ç”Ÿæ´»ç”¨å“. å¦‚æœå†…å­˜ç©ºé—´è¶³å¤Ÿ, åƒåœ¾å›æ”¶å™¨å°±ä¸ä¼šå›æ”¶å®ƒ, å¦‚æœå†…å­˜ç©ºé—´ä¸è¶³äº†, å°±ä¼šå›æ”¶è¿™äº›å¯¹è±¡çš„å†…å­˜.
åªè¦åƒåœ¾å›æ”¶å™¨æ²¡æœ‰å›æ”¶å®ƒ, è¯¥å¯¹è±¡å°±å¯ä»¥è¢«ç¨‹åºä½¿ç”¨. è½¯å¼•ç”¨å¯ç”¨æ¥å®ç°å†…å­˜æ•æ„Ÿçš„é«˜é€Ÿç¼“å­˜.
è½¯å¼•ç”¨å¯ä»¥å’Œä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ï¼ˆReferenceQueueï¼‰è”åˆä½¿ç”¨, å¦‚æœè½¯å¼•ç”¨æ‰€å¼•ç”¨çš„å¯¹è±¡è¢«åƒåœ¾å›æ”¶, JAVA è™šæ‹Ÿæœºå°±ä¼šæŠŠè¿™ä¸ªè½¯å¼•ç”¨åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­.

### å¼±å¼•ç”¨

å¦‚æœä¸€ä¸ªå¯¹è±¡å…·æœ‰å¼±å¼•ç”¨, åœ¨ GC çº¿ç¨‹æ‰«æå†…å­˜åŒºåŸŸçš„è¿‡ç¨‹ä¸­, ä¸ç®¡å½“å‰å†…å­˜ç©ºé—´è¶³å¤Ÿä¸å¦, éƒ½ä¼šå›æ”¶å†…å­˜, ä½¿ç”¨å¼±å¼•ç”¨ æ„å»ºéæ•æ„Ÿæ•°æ®çš„ç¼“å­˜.  
åœ¨ JVM ä¸­, å¼±å¼•ç”¨æ˜¯å¦‚ä¸‹å®šä¹‰çš„, ä¸‹é¢å¼•è‡ª JVM:

```java
public class WeakReference<T> extends Reference<T> {
  /**
    * Creates a new weak reference that refers to the given object.  The new
    * reference is not registered with any queue.
    *
    * @param referent object the new weak reference will refer to
    */
  public WeakReference(T referent) {
      super(referent);
  }

  /**
    * Creates a new weak reference that refers to the given object and is
    * registered with the given queue.
    *
    * @param referent object the new weak reference will refer to
    * @param q the queue with which the reference is to be registered,
    *          or <tt>null</tt> if registration is not required
    */
  public WeakReference(T referent, ReferenceQueue<? super T> q) {
      super(referent, q);
  }
}
```

å¼±å¼•ç”¨çš„å£°æ˜çš„å€ŸåŠ©å¼ºå¼•ç”¨æˆ–è€…åŒ¿åå¯¹è±¡, ä½¿ç”¨æ³›å‹ `WeakReference<T>`, å…·ä½“å¦‚ä¸‹:

```java
// å¼±å¼•ç”¨
WeakReference<User>weakReference=new WeakReference<User>(new User());
```

å¦‚æœä¸€ä¸ªå¯¹è±¡åªå…·æœ‰å¼±å¼•ç”¨, é‚£å°±ç±»ä¼¼äºå¯æœ‰å¯ç‰©çš„ç”Ÿæ´»ç”¨å“. å¼±å¼•ç”¨ä¸è½¯å¼•ç”¨çš„åŒºåˆ«åœ¨äº: åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡æ‹¥æœ‰æ›´çŸ­æš‚çš„ç”Ÿå‘½å‘¨æœŸ. åœ¨åƒåœ¾å›æ”¶å™¨çº¿ç¨‹æ‰«æå®ƒ
æ‰€ç®¡è¾–çš„å†…å­˜åŒºåŸŸçš„è¿‡ç¨‹ä¸­, ä¸€æ—¦å‘ç°äº†åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡, ä¸ç®¡å½“å‰å†…å­˜ç©ºé—´è¶³å¤Ÿä¸å¦, éƒ½ä¼šå›æ”¶å®ƒçš„å†…å­˜. ä¸è¿‡, ç”±äºåƒåœ¾å›æ”¶å™¨æ˜¯ä¸€ä¸ªä¼˜å…ˆçº§å¾ˆä½çš„çº¿ç¨‹,
å› æ­¤ä¸ä¸€å®šä¼šå¾ˆå¿«å‘ç°é‚£äº›åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡.  
å¼±å¼•ç”¨å¯ä»¥å’Œä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ï¼ˆReferenceQueueï¼‰è”åˆä½¿ç”¨, å¦‚æœå¼±å¼•ç”¨æ‰€å¼•ç”¨çš„å¯¹è±¡è¢«åƒåœ¾å›æ”¶, Java è™šæ‹Ÿæœºå°±ä¼šæŠŠè¿™ä¸ªå¼±å¼•ç”¨åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­.

### è™šå¼•ç”¨

å¦‚æœä¸€ä¸ªå¯¹è±¡ä»…æŒæœ‰è™šå¼•ç”¨, åœ¨ä»»ä½•æ—¶å€™éƒ½å¯èƒ½è¢«åƒåœ¾å›æ”¶, è™šå¼•ç”¨ä¸è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨çš„ä¸€ä¸ªåŒºåˆ«åœ¨äº: è™šå¼•ç”¨å¿…é¡»å’Œå¼•ç”¨é˜Ÿåˆ—è”åˆä½¿ç”¨, è™šå¼•ç”¨ä¸»è¦ç”¨æ¥ **è·Ÿè¸ªå¯¹è±¡è¢«åƒåœ¾å›æ”¶çš„æ´»åŠ¨**.  
åœ¨ JVM ä¸­, è™šå¼•ç”¨æ˜¯å¦‚ä¸‹å®šä¹‰çš„, ä¸‹é¢å¼•è‡ª JVM:

```java
public class PhantomReference<T> extends Reference<T> {

  /**
    * Returns this reference object's referent.  Because the referent of a
    * phantom reference is always inaccessible, this method always returns
    * <code>null</code>.
    *
    * @return  <code>null</code>
    */
  public T get() {
      return null;
  }

  /**
    * Creates a new phantom reference that refers to the given object and
    * is registered with the given queue.
    *
    * <p> It is possible to create a phantom reference with a <tt>null</tt>
    * queue, but such a reference is completely useless: Its <tt>get</tt>
    * method will always return null and, since it does not have a queue, it
    * will never be enqueued.
    *
    * @param referent the object the new phantom reference will refer to
    * @param q the queue with which the reference is to be registered,
    *          or <tt>null</tt> if registration is not required
    */
  public PhantomReference(T referent, ReferenceQueue<? super T> q) {
      super(referent, q);
  }
}
```

è™šå¼•ç”¨ `PhantomReference<T>` çš„å£°æ˜çš„å€ŸåŠ©å¼ºå¼•ç”¨æˆ–è€…åŒ¿åå¯¹è±¡, ç»“åˆæ³›å‹ `ReferenceQueue<T>` åˆå§‹åŒ–, å…·ä½“å¦‚ä¸‹:

```java
// è™šå¼•ç”¨
PhantomReference<User> phantomReference=new PhantomReference<User>(new User(),
```

"è™šå¼•ç”¨"é¡¾åæ€ä¹‰, å°±æ˜¯å½¢åŒè™šè®¾, ä¸å…¶ä»–å‡ ç§å¼•ç”¨éƒ½ä¸åŒ, è™šå¼•ç”¨å¹¶ä¸ä¼šå†³å®šå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ. å¦‚æœä¸€ä¸ªå¯¹è±¡ä»…æŒæœ‰è™šå¼•ç”¨, é‚£ä¹ˆå®ƒå°±å’Œæ²¡æœ‰ä»»ä½•å¼•ç”¨ä¸€æ ·,
åœ¨ä»»ä½•æ—¶å€™éƒ½å¯èƒ½è¢«åƒåœ¾å›æ”¶.
è™šå¼•ç”¨ä¸»è¦ç”¨æ¥ **è·Ÿè¸ªå¯¹è±¡è¢«åƒåœ¾å›æ”¶çš„æ´»åŠ¨**. è™šå¼•ç”¨ä¸è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨çš„ä¸€ä¸ªåŒºåˆ«åœ¨äº: è™šå¼•ç”¨å¿…é¡»å’Œå¼•ç”¨é˜Ÿåˆ—ï¼ˆReferenceQueueï¼‰è”åˆä½¿ç”¨. å½“åƒ
åœ¾å›æ”¶å™¨å‡†å¤‡å›æ”¶ä¸€ä¸ªå¯¹è±¡æ—¶, å¦‚æœå‘ç°å®ƒè¿˜æœ‰è™šå¼•ç”¨, å°±ä¼šåœ¨å›æ”¶å¯¹è±¡çš„å†…å­˜ä¹‹å‰, æŠŠè¿™ä¸ªè™šå¼•ç”¨åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­. ç¨‹åºå¯ä»¥é€šè¿‡åˆ¤æ–­å¼•ç”¨é˜Ÿåˆ—ä¸­æ˜¯
å¦å·²ç»åŠ å…¥äº†è™šå¼•ç”¨, æ¥äº†è§£
è¢«å¼•ç”¨çš„å¯¹è±¡æ˜¯å¦å°†è¦è¢«åƒåœ¾å›æ”¶. ç¨‹åºå¦‚æœå‘ç°æŸä¸ªè™šå¼•ç”¨å·²ç»è¢«åŠ å…¥åˆ°å¼•ç”¨é˜Ÿåˆ—, é‚£ä¹ˆå°±å¯ä»¥åœ¨æ‰€å¼•ç”¨çš„å¯¹è±¡çš„å†…å­˜è¢«å›æ”¶ä¹‹å‰é‡‡å–å¿…è¦çš„è¡ŒåŠ¨.

```java
import java.lang.ref.*;
import java.util.HashSet;
import java.util.Set;

class User {

    private String name;

    public User()
    {}

    public User(String name)
    {
        this.name=name;
    }

    @Override
    public String toString() {
        return name;
    }

    public void finalize(){
        System.out.println("Finalizing ... "+name);
    }
}

/**
 * Created by jinxu on 15-4-25.
 */
public class ReferenceDemo {

    private static ReferenceQueue<User> referenceQueue = new ReferenceQueue<User>();
    private static final int size = 10;

    public static void checkQueue(){
       /* Reference<? extends User> reference = null;
        while((reference = referenceQueue.poll())!=null){
            System.out.println("In queue : "+reference.get());
        }*/
        Reference<? extends User> reference = referenceQueue.poll();
        if(reference!=null){
            System.out.println("In queue : "+reference.get());
        }
    }

    public static void testSoftReference()
    {
        Set<SoftReference<User>> softReferenceSet = new HashSet<SoftReference<User>>();
        for (int i = 0; i < size; i++) {
            SoftReference<User> ref = new SoftReference<User>(new User("Soft " + i), referenceQueue);
            System.out.println("Just created: " + ref.get());
            softReferenceSet.add(ref);
        }
        System.gc();
        checkQueue();
    }

    public static void testWeaKReference()
    {
        Set<WeakReference<User>> weakReferenceSet = new HashSet<WeakReference<User>>();
        for (int i = 0; i < size; i++) {
            WeakReference<User> ref = new WeakReference<User>(new User("Weak " + i), referenceQueue);
            System.out.println("Just created: " + ref.get());
            weakReferenceSet.add(ref);
        }
        System.gc();
        checkQueue();
    }

    public static void testPhantomReference()
    {
        Set<PhantomReference<User>> phantomReferenceSet = new HashSet<PhantomReference<User>>();
        for (int i = 0; i < size; i++) {
            PhantomReference<User> ref =
                    new PhantomReference<User>(new User("Phantom " + i), referenceQueue);
            System.out.println("Just created: " + ref.get());
            phantomReferenceSet.add(ref);
        }
        System.gc();
        checkQueue();
    }

    public static void main(String[] args) {
        testSoftReference();
        testWeaKReference();
        testPhantomReference();
    }
}
```

## è°ˆè°ˆ, Java GC æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™, å¯¹ä»€ä¹ˆä¸œè¥¿, åšäº†ä»€ä¹ˆäº‹æƒ…

åœ°çƒäººéƒ½çŸ¥é“, Java æœ‰ä¸ªä¸œè¥¿å«åƒåœ¾æ”¶é›†å™¨, å®ƒè®©åˆ›å»ºçš„å¯¹è±¡ä¸éœ€è¦åƒ c/cpp é‚£æ · deleteã€free æ‰, ä½ èƒ½ä¸èƒ½è°ˆè°ˆ, GC æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™, å¯¹ä»€ä¹ˆä¸œè¥¿,
åšäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿ

**ä¸€. å›ç­”: ä»€ä¹ˆæ—¶å€™?**

1. **ç³»ç»Ÿç©ºé—²çš„æ—¶å€™**.
   åˆ†æ: è¿™ç§å›ç­”å¤§çº¦å  30%, é‡åˆ°çš„è¯ä¸€èˆ¬æˆ‘å°±ä¼šå‡†å¤‡è½¬å‘åˆ«çš„è¯é¢˜, è­¬å¦‚ç®—æ³•ã€è­¬å¦‚ SSH çœ‹çœ‹èƒ½å¦å‘æ˜ä¸€äº›ä»–æ“…é•¿çš„å…¶ä»–æ–¹é¢.
2. **ç³»ç»Ÿè‡ªèº«å†³å®š, ä¸å¯é¢„æµ‹çš„æ—¶é—´ / è°ƒç”¨ System.gc() çš„æ—¶å€™.**
   åˆ†æ: è¿™ç§å›ç­”å¤§çº¦å  55%, å¤§éƒ¨åˆ†åº”å±Šç”Ÿéƒ½èƒ½å›ç­”åˆ°è¿™ä¸ªç­”æ¡ˆ, èµ·ç ä¸èƒ½ç®—é”™è¯¯æ˜¯å§, åç»­åº”å½“ç»†åˆ†ä¸€ä¸‹åˆ°åº•æ˜¯è¯­è¨€è¡¨è¿°å¯¼è‡´ç­”æ¡ˆå¤ªç¬¼ç»Ÿ,
   è¿˜æ˜¯æœ¬èº«å°±åªæœ‰è¿™æ ·ä¸€ä¸ªæ¨¡ç³Šçš„è®¤è¯†.
3. **èƒ½è¯´å‡ºæ–°ç”Ÿä»£ã€è€å¹´ä»£ç»“æ„, èƒ½æå‡º minor gc/full gc**
   åˆ†æ: åˆ°äº†è¿™ä¸ªå±‚æ¬¡, åŸºæœ¬ä¸Šèƒ½è¯´å¯¹ GC è¿ä½œæœ‰æ¦‚å¿µä¸Šçš„äº†è§£, è­¬å¦‚çœ‹è¿‡ã€Šæ·±å…¥ JVM è™šæ‹Ÿæœºã€‹ä¹‹ç±»çš„. è¿™éƒ¨åˆ†ä¸è¶³ 10%.
4. **èƒ½è¯´æ˜ minor gc/full gc çš„è§¦å‘æ¡ä»¶ã€OOM çš„è§¦å‘æ¡ä»¶, é™ä½ GC çš„è°ƒä¼˜çš„ç­–ç•¥**.

> åˆ†æ: åˆ—ä¸¾ä¸€äº›æˆ‘æœŸæœ›çš„å›ç­”: eden æ»¡äº† minor gc, å‡åˆ°è€å¹´ä»£çš„å¯¹è±¡å¤§äºè€å¹´ä»£å‰©ä½™ç©ºé—´ full gc, æˆ–è€…å°äºæ—¶è¢« HandlePromotionFailure å‚æ•°å¼ºåˆ¶
> full gcï¼›gc ä¸é gc æ—¶é—´è€—æ—¶è¶…è¿‡äº† GCTimeRatioï¼ˆGC æ—¶é—´å æ€»æ—¶é—´çš„æ¯”ç‡, é»˜è®¤å€¼ä¸º 99, å³å…è®¸ 1% çš„ GC æ—¶é—´, ä»…åœ¨ä½¿ç”¨ Parallel Scavenge
> æ”¶é›†å™¨æ—¶ç”Ÿæ•ˆï¼‰çš„é™åˆ¶å¼•å‘ OOM, è°ƒä¼˜è¯¸å¦‚é€šè¿‡ NewRatio æ§åˆ¶æ–°ç”Ÿä»£è€å¹´ä»£æ¯”ä¾‹, é€šè¿‡ MaxTenuringThreshold æ§åˆ¶è¿›å…¥è€å¹´å‰ç”Ÿå­˜æ¬¡æ•°ç­‰â€¦â€¦èƒ½å›ç­”é“è¿™ä¸ªé˜¶æ®µå°±ä¼šç»™æˆ‘å¸¦æ¥æ¯”è¾ƒé«˜çš„æœŸæœ›äº†,
> å½“ç„¶é¢è¯•çš„æ—¶å€™æ­£å¸¸äººéƒ½ä¸ä¼šè®°å¾—æ¯ä¸ªå‚æ•°çš„æ‹¼å†™, æˆ‘è‡ªå·±å†™è¿™æ®µè¯çš„æ—¶å€™ä¹Ÿæ˜¯ç¿»è¿‡æ‰‹å†Œçš„. å›ç­”é“è¿™éƒ¨åˆ†çš„å°äº 2%.
> æ€»ç»“: ç¨‹åºå‘˜ä¸èƒ½å…·ä½“æ§åˆ¶æ—¶é—´, ç³»ç»Ÿåœ¨ä¸å¯é¢„æµ‹çš„æ—¶é—´è°ƒç”¨ System.gc() å‡½æ•°çš„æ—¶å€™ï¼›å½“ç„¶å¯ä»¥é€šè¿‡è°ƒä¼˜, ç”¨ NewRatio æ§åˆ¶ newObject å’Œ oldObject
> çš„æ¯”ä¾‹,
> ç”¨ MaxTenuringThreshold æ§åˆ¶è¿›å…¥ oldObject çš„æ¬¡æ•°, ä½¿å¾— oldObject å­˜å‚¨ç©ºé—´å»¶è¿Ÿè¾¾åˆ° full gc, ä»è€Œä½¿å¾—è®¡æ—¶å™¨å¼•å‘ gc æ—¶é—´å»¶è¿Ÿ OOM çš„æ—¶é—´å»¶è¿Ÿ,
> ä»¥å»¶é•¿å¯¹è±¡ç”Ÿå­˜æœŸ.

**äºŒ. å›ç­”: å¯¹ä»€ä¹ˆä¸œè¥¿**

1. ä¸ä½¿ç”¨çš„å¯¹è±¡.
   åˆ†æ: ç›¸å½“äºæ²¡æœ‰å›ç­”, é—®é¢˜å°±æ˜¯åœ¨é—®ä»€ä¹ˆå¯¹è±¡æ‰æ˜¯â€œä¸ä½¿ç”¨çš„å¯¹è±¡â€. å¤§çº¦å  30%.
   2 . è¶…å‡ºä½œç”¨åŸŸçš„å¯¹è±¡ / å¼•ç”¨è®¡æ•°ä¸ºç©ºçš„å¯¹è±¡.
   åˆ†æ: è¿™ 2 ä¸ªå›ç­”ç«™äº† 60%, ç›¸å½“é«˜çš„æ¯”ä¾‹, ä¼°è®¡å­¦æ ¡æ•™ java çš„æ—¶å€™è€å¸ˆå°±æ˜¯è¿™æ ·æ•™çš„. ç¬¬ä¸€ä¸ªå›ç­”æ²¡æœ‰è§£å†³æˆ‘çš„ç–‘é—®, gc
   åˆ°åº•æ€ä¹ˆåˆ¤æ–­å“ªäº›å¯¹è±¡åœ¨ä¸åœ¨ä½œç”¨åŸŸçš„ï¼Ÿè‡³äºå¼•ç”¨è®¡æ•°æ¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯æ”¶é›†çš„, æˆ‘å¯ä»¥ä¼šè¡¥å……ä¸€ä¸ªä¸‹é¢è¿™ä¸ªä¾‹å­è®©é¢è¯•è€…åˆ†æä¸€ä¸‹
2. **ä» gc root å¼€å§‹æœç´¢, æœç´¢ä¸åˆ°çš„å¯¹è±¡.**
   åˆ†æ: æ ¹å¯¹è±¡æŸ¥æ‰¾ã€æ ‡è®°å·²ç»ç®—æ˜¯ä¸é”™äº†, å°äº 5% çš„äººå¯ä»¥å›ç­”é“è¿™æ­¥, ä¼°è®¡æ˜¯å¼•ç”¨è®¡æ•°çš„æ–¹å¼å¤ªâ€œæ·±å…¥æ°‘å¿ƒâ€äº†. åŸºæœ¬å¯ä»¥å¾—åˆ°è¿™ä¸ªé—®é¢˜å…¨éƒ¨åˆ†æ•°.
   PS: æœ‰é¢è¯•è€…åœ¨è¿™ä¸ªé—®è¡¥å……å¼ºå¼•ç”¨ï¼ˆç±»ä¼¼ new Object(), åªè¦å¼ºå¼•ç”¨è¿˜åœ¨å°±ä¸ä¼šè¢«å›æ”¶ï¼‰ã€å¼±å¼•ç”¨ï¼ˆè¿˜æœ‰ç”¨ä½†å¹¶éå¿…é¡»çš„å¯¹è±¡, åœ¨ç³»ç»Ÿå°†è¦å‘ç”Ÿ OOM ä¹‹å‰,
   æ‰ä¼šå°†è¿™äº›å¯¹è±¡å›æ”¶ï¼‰ã€è½¯å¼•ç”¨ï¼ˆåªèƒ½ç”Ÿå­˜åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†ä¹‹å‰ï¼‰ã€å¹»å½±å¼•ç”¨ï¼ˆæ— æ³•é€šè¿‡å¹»å½±å¼•ç”¨å¾—åˆ°å¯¹è±¡, å’Œå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ— å…³,
   å”¯ä¸€ç›®çš„å°±æ˜¯èƒ½åœ¨è¿™ä¸ªå¯¹è±¡è¢«å›æ”¶æ—¶æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ï¼‰åŒºåˆ«ç­‰, ä¸æ˜¯æˆ‘æƒ³é—®çš„ç­”æ¡ˆ, ä½†å¯ä»¥åŠ åˆ†.
3. ä» root æœç´¢ä¸åˆ°, è€Œä¸”ç»è¿‡ç¬¬ä¸€æ¬¡æ ‡è®°ã€æ¸…ç†å, ä»ç„¶æ²¡æœ‰å¤æ´»çš„å¯¹è±¡.
   åˆ†æ: æˆ‘æœŸå¾…çš„ç­”æ¡ˆ. ä½†æ˜¯çš„ç¡®å¾ˆå°‘é¢è¯•è€…ä¼šå›ç­”åˆ°è¿™ä¸€ç‚¹, æ‰€ä»¥åœ¨æˆ‘å¿ƒä¸­å›ç­”é“ç¬¬ 3 ç‚¹æˆ‘å°±ç»™å…¨éƒ¨åˆ†æ•°.

> è¶…å‡ºäº†ä½œç”¨åŸŸæˆ–å¼•ç”¨è®¡æ•°ä¸ºç©ºçš„å¯¹è±¡ï¼›ä» gc root å¼€å§‹æœç´¢æ‰¾ä¸åˆ°çš„å¯¹è±¡, è€Œä¸”ç»è¿‡ä¸€æ¬¡æ ‡è®°ã€æ¸…ç†, ä»ç„¶æ²¡æœ‰å¤æ´»çš„å¯¹è±¡.

**ä¸‰. å›ç­”: åšä»€ä¹ˆ**

1. åˆ é™¤ä¸ä½¿ç”¨çš„å¯¹è±¡, è…¾å‡ºå†…å­˜ç©ºé—´.
   åˆ†æ: åŒé—®é¢˜ 2 ç¬¬ä¸€ç‚¹. 40%.
2. è¡¥å……ä¸€äº›è¯¸å¦‚åœæ­¢å…¶ä»–çº¿ç¨‹æ‰§è¡Œã€è¿è¡Œ finalize ç­‰çš„è¯´æ˜.
   åˆ†æ: èµ·ç æŠŠé—®é¢˜å…·ä½“åŒ–äº†ä¸€äº›, å¦‚æœåƒç­”æ¡ˆ 1 é‚£æ ·æˆ‘å¾ˆéš¾åœ¨å›ç­”ä¸­æ‰¾åˆ°è¯é¢˜ç»§ç»­å±•å¼€, å¤§çº¦å  40% çš„äºº.
3. èƒ½è¯´å‡ºè¯¸å¦‚æ–°ç”Ÿä»£åšçš„æ˜¯å¤åˆ¶æ¸…ç†ã€from survivorã€to survivor æ˜¯å¹²å•¥ç”¨çš„ã€è€å¹´ä»£åšçš„æ˜¯æ ‡è®°æ¸…ç†ã€æ ‡è®°æ¸…ç†åç¢ç‰‡è¦ä¸è¦æ•´ç†ã€å¤åˆ¶æ¸…ç†å’Œæ ‡è®°æ¸…ç†æœ‰æœ‰ä»€ä¹ˆä¼˜åŠ£åŠ¿ç­‰.
   åˆ†æ: ä¹Ÿæ˜¯çœ‹è¿‡ã€Šæ·±å…¥ JVM è™šæ‹Ÿæœºã€‹çš„åŸºæœ¬éƒ½èƒ½å›ç­”é“è¿™ä¸ªç¨‹åº¦, å…¶å®åˆ°è¿™ä¸ªç¨‹åº¦æˆ‘å·²ç»æ¯”è¾ƒæœŸå¾…äº†. åŒæ ·å°äº 10%.
4. é™¤äº† 3 å¤–, è¿˜èƒ½è®²æ¸…æ¥šä¸²è¡Œã€å¹¶è¡Œï¼ˆæ•´ç† / ä¸æ•´ç†ç¢ç‰‡ï¼‰ã€CMS ç­‰æœé›†å™¨å¯ä½œç”¨çš„å¹´ä»£ã€ç‰¹ç‚¹ã€ä¼˜åŠ£åŠ¿, å¹¶ä¸”èƒ½è¯´æ˜æ§åˆ¶ / è°ƒæ•´æ”¶é›†å™¨é€‰æ‹©çš„æ–¹å¼.

> æ€»ç»“: åˆ é™¤ä¸ä½¿ç”¨çš„å¯¹è±¡, å›æ”¶å†…å­˜ç©ºé—´ï¼›è¿è¡Œé»˜è®¤çš„ finalize, JVM ç”¨ from survivorã€to survivor å¯¹å®ƒè¿›è¡Œæ ‡è®°æ¸…ç†, å¯¹è±¡åºåˆ—åŒ–åä¹Ÿå¯ä»¥ä½¿å®ƒå¤æ´».

## [GitåŸºç¡€å‘½ä»¤å…¨è§£æï¼šæŒæ¡ç‰ˆæœ¬æ§åˆ¶çš„è‰ºæœ¯](https://blog.dong4j.site/posts/6952e88b.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## .gitignore è§„åˆ™å†™æ³•

.gitignore æ–‡ä»¶ç”¨äºæŒ‡å®šå“ªäº›ç±»å‹çš„æ–‡ä»¶åº”è¢« Git å¿½ç•¥ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„å¿½ç•¥è§„åˆ™ï¼š

1. **åœ¨å·²å¿½ç•¥æ–‡ä»¶å¤¹ä¸­ä¸å¿½ç•¥ç‰¹å®šçš„å­æ–‡ä»¶å¤¹**ï¼š

```
/node_modules/*
!/node_modules/layer/
```

2. **åœ¨å·²å¿½ç•¥æ–‡ä»¶å¤¹ä¸­ä¸å¿½ç•¥ç‰¹å®šçš„æ–‡ä»¶**ï¼š

```
/node_modules/*
!/node_modules/layer/layer.js
```

æ³¨æ„ï¼šè¦ä½¿è¿™äº›è§„åˆ™ç”Ÿæ•ˆï¼Œè¢«å¿½ç•¥çš„æ–‡ä»¶æˆ–ç›®å½•éœ€è¦ä»¥ `/*` ç»“å°¾ã€‚æ­¤å¤–ï¼Œè¯·å‚è€ƒä»¥ä¸‹è§„åˆ™å†™æ³•ï¼š

- ä»¥æ–œæ  `/` å¼€å¤´è¡¨ç¤ºç›®å½•ï¼›
- æ˜Ÿå· `*` å¯åŒ¹é…å¤šä¸ªå­—ç¬¦ï¼›
- é—®å· `?` åŒ¹é…å•ä¸ªå­—ç¬¦ï¼›
- æ–¹æ‹¬å· `[]` å†…åŒ…å«å•ä¸ªå­—ç¬¦çš„åŒ¹é…åˆ—è¡¨ï¼›
- å¤§å¹å· `!` è¡¨ç¤ºä¸å¿½ç•¥ï¼ˆè·Ÿè¸ªï¼‰åŒ¹é…åˆ°çš„æ–‡ä»¶æˆ–ç›®å½•ï¼›

## å–æ¶ˆè·Ÿè¸ªå·²ç‰ˆæœ¬æ§åˆ¶çš„æ–‡ä»¶

ä½ å¯ä»¥ä½¿ç”¨ `git update-index --assume-unchanged <file>` å‘½ä»¤æ¥å–æ¶ˆå¯¹ä¸€ä¸ªæ–‡ä»¶çš„è·Ÿè¸ªã€‚è¿™é€‚ç”¨äºä½ å¸Œæœ›æš‚æ—¶åœæ­¢ Git ç›‘æ§ç‰¹å®šæ–‡ä»¶å˜åŠ¨çš„æƒ…å†µã€‚

```bash
git update-index --assume-unchanged your_file_path
```

## ä»ç‰ˆæœ¬åº“ä¸­åˆ é™¤æ–‡ä»¶æˆ–ç›®å½•

å¦‚æœä½ æƒ³å°†æŸä¸ªç›®å½•ï¼ˆå¦‚ `app/test`ï¼‰ä» Git ä»“åº“ä¸­ç§»é™¤ä½†ä¸åˆ é™¤æœ¬åœ°çš„æ–‡ä»¶ï¼Œä½ å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œæ“ä½œï¼š

1. **æŸ¥çœ‹è¦åˆ é™¤çš„åˆ—è¡¨**ï¼š
   ```bash
   git rm -r -n --cached app/test
   ```
2. **æ‰§è¡Œå®é™…åˆ é™¤**ï¼š

   ```bash
   git rm -r --cached app/test
   ```

3. ä¿®æ”¹ `.gitignore` æ–‡ä»¶ï¼Œå¢åŠ å¿½ç•¥è§„åˆ™ä»¥é˜²æ­¢ Git å†æ¬¡è·Ÿè¸ªè¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œåœ¨ `.gitignore` æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š

   ```markdown
   /app/test/
   ```

4. **æäº¤æ›´æ”¹**ï¼š

   ```bash
   git commit -m "ä¸å†è·Ÿè¸ªtestæ–‡ä»¶å¤¹"
   ```

5. å¦‚æœæœ‰è¿œç¨‹åˆ†æ”¯ï¼Œå°†æ”¹åŠ¨æ¨é€åˆ°è¿œç¨‹ã€‚

å¦‚æœä½ åŒæ—¶æƒ³è¦åˆ é™¤æœ¬åœ°çš„æµ‹è¯•ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

1. **æŸ¥çœ‹è¦åˆ é™¤çš„å†…å®¹**ï¼š
   ```bash
   git rm -r -n test
   ```
2. **æ‰§è¡Œå®é™…åˆ é™¤**ï¼š
   ```bash
   git rm -r test
   ```

## åˆ›å»ºå’Œæ¨é€æ ‡ç­¾

### åˆ›å»ºæ ‡ç­¾

```bash
git tag <tag_name>
```

æˆ–è€…å¸¦æœ‰æè¿°ä¿¡æ¯çš„æ ‡ç­¾ï¼š

```bash
git tag -a v0.1 -m "ç‰ˆæœ¬ 0.1 å‘å¸ƒ" d5a65e9
-a: æŒ‡å®šæ ‡ç­¾åï¼›-m: æä¾›é™„æ³¨è¯´æ˜
```

### æŸ¥çœ‹æ‰€æœ‰æ ‡ç­¾

ç›´æ¥è¿è¡Œ `git tag` å‘½ä»¤å³å¯æŸ¥çœ‹å½“å‰å·¥ä½œåŒºçš„æ‰€æœ‰æ ‡ç­¾ã€‚

### æŸ¥çœ‹ç‰¹å®šæ ‡ç­¾çš„æè¿°ä¿¡æ¯

```bash
git show <tag_name>
```

### æ¨é€æ ‡ç­¾

#### å•ä¸ªæ ‡ç­¾

```bash
git push origin <tag_name>
```

#### æ‰€æœ‰æ ‡ç­¾

ä½¿ç”¨ä»¥ä¸‹ä»»æ„ä¸€ç§å‘½ä»¤æ¥æ¨é€æ‰€æœ‰çš„æ ‡ç­¾ï¼š

```bash
git push --tags
æˆ–è€…
git push origin --tags
```

## åˆ é™¤æ ‡ç­¾

åˆ é™¤æœ¬åœ°æ ‡ç­¾ï¼š

```bash
git tag -d <tag_name>
```

è¿œç¨‹æ ‡ç­¾çš„åˆ é™¤éœ€è¦é€šè¿‡ `git push` å‘½ä»¤æ¥å®Œæˆï¼Œå…·ä½“æ“ä½œä¸ºï¼š

```bash
git push origin :refs/tags/<tag_name>
```

ä¾‹å¦‚ï¼šè¦åˆ é™¤åä¸º "V3.0.1-Release" çš„æ ‡ç­¾ï¼š

```bash
git push origin :refs/tags/V3.0.1-Release
```

## åŒæ­¥æ ‡ç­¾

ä¸ºäº†åŒæ­¥ä½ çš„æœ¬åœ°å’Œè¿œç¨‹ä»“åº“çš„æ ‡ç­¾ï¼Œå¯ä»¥å…ˆåœ¨æœ¬åœ°åˆ é™¤æ‰€æœ‰æ—§æ ‡ç­¾åé‡æ–°æ‹‰å–æ‰€æœ‰çš„æœ€æ–°æ ‡ç­¾ã€‚

```bash
# åˆ é™¤æœ¬åœ°æ‰€æœ‰æ ‡ç­¾
git tag -l | xargs git tag -d

# ä»è¿œç¨‹ä»“åº“æ‹‰å–æ¶ˆé™¤ä¸å†å­˜åœ¨çš„å¼•ç”¨ï¼ˆåˆ†æ”¯æˆ–æ ‡ç­¾ï¼‰
git fetch origin --prune

# æ‹‰å–å¹¶æ›´æ–°æ ‡ç­¾
git fetch origin --tags
```

## Git ç»Ÿè®¡æäº¤æ¬¡æ•°åŠä»£ç é‡å˜åŒ–

ç»Ÿè®¡æŒ‡å®šä½œè€…çš„æäº¤æ¬¡æ•°ï¼š

```bash
git log --author=æŸäººå --since="èµ·å§‹æ—¶é—´ï¼Œå¦‚ï¼š2019-01-01" --no-merges | grep -e 'commit [a-zA-Z0-9]*' | wc -l
```

ç»Ÿè®¡æŒ‡å®šä½œè€…å¢åŠ å’Œåˆ é™¤çš„ä»£ç é‡ï¼š

```bash
git log --author=æŸäººå --pretty=tformat: --numstat | awk '{ add += $1; subs += $2; loc += $1 - $2 } END { printf "æ·»åŠ è¡Œæ•°ï¼š %s, åˆ é™¤è¡Œæ•°ï¼š %sï¼Œæ€»è¡Œæ•°å˜åŒ–ï¼š%s\n", add, subs, loc }' -
```

## åŒæ—¶å‘å¤šå¤„æ¨é€ä»£ç 

### æ·»åŠ ç¬¬äºŒä¸ªè¿œç¨‹åœ°å€

å¦‚æœä½ å¸Œæœ›ä½ çš„é¡¹ç›®å¯ä»¥åŒæ—¶æ¨é€åˆ°å¤šä¸ªè¿œç¨‹ä»“åº“ï¼Œé¦–å…ˆéœ€è¦æ·»åŠ é¢å¤–çš„è¿œç¨‹åœ°å€ã€‚ä¾‹å¦‚ï¼š

```bash
git remote set-url --add origin git@github.com:morethink/programming.git
```

ç„¶åä½ å¯ä»¥é€šè¿‡ `git remote -v` æŸ¥çœ‹æ‰€æœ‰çš„è¿œç«¯åˆ†æ”¯åŠå…¶å¯¹åº”åœ°å€ã€‚

### åŒæ—¶æ¨é€è‡³å¤šä¸ªè¿œç¨‹

ä¸€æ—¦ä½ è®¾ç½®äº†å¤šä¸ªè¿œç¨‹ä»“åº“ï¼Œå½“ä½ æ‰§è¡Œ `git push origin master` æ—¶ï¼ŒGit ä¼šè‡ªåŠ¨å°†ä»£ç æ¨é€åˆ°æ‰€æœ‰å·²é…ç½®çš„è¿œç¨‹ä»“åº“ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š

```bash
Everything up-to-date
Everything up-to-date
```

## å¼ºåˆ¶æäº¤æ›´æ”¹

æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½éœ€è¦å¼ºåˆ¶æ¨é€æˆ‘ä»¬çš„æ”¹åŠ¨åˆ°è¿œç¨‹åˆ†æ”¯ï¼ˆå°¤å…¶æ˜¯å½“æˆ‘ä»¬æœ¬åœ°ç‰ˆæœ¬è¾ƒæ–°æˆ–å¸Œæœ›è¦†ç›–è¿œç¨‹ç‰ˆæœ¬æ—¶ï¼‰ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨ `git push` å‘½ä»¤çš„ `-f` æˆ– `--force` é€‰é¡¹ï¼š

```bash
git push origin master --force
```

## å…‹éš†æŒ‡å®šæ ‡ç­¾çš„ä»“åº“

å¦‚æœæƒ³è¦å…‹éš†ä¸€ä¸ªç‰¹å®šæ ‡ç­¾çš„ä»“åº“ï¼Œå¯ä»¥ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š

```bash
git clone --branch [tagsæ ‡ç­¾] [gitåœ°å€]
```

ä¾‹å¦‚ï¼šå°†æŸæ ‡ç­¾ä¸‹çš„ä»£ç åº“æ‹‰å–åˆ°æœ¬åœ°

```bash
git clone --branch v2.0.3 https://github.com/example/project.git
```

## é…ç½®ä»£ç†å’Œå–æ¶ˆä»£ç†è®¾ç½®

æœ‰æ—¶å€™ä¸ºäº†è®¿é—®è¿œç¨‹ä»“åº“ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦é…ç½® HTTP/HTTPS çš„ä»£ç†æœåŠ¡å™¨ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿›è¡Œè®¾ç½®ï¼š

è®¾ç½®ä»£ç†ï¼š

```bash
git config --global http.proxy 'socks5://127.0.0.1:$ç«¯å£å·'
```

æˆ–è€…å¯¹äº https çš„è¯·æ±‚ï¼š

```bash
git config --global https.proxy 'socks5://127.0.0.1:$ç«¯å£å·'
```

å–æ¶ˆä»£ç†è®¾ç½®ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç§»é™¤å…¨å±€é…ç½®ä¸­çš„ http å’Œ https ä»£ç†ï¼š

```bash
git config --global --unset http.proxy
git config --global --unset https.proxy
```

æˆ–è€…åˆ›å»ºä¸€äº›åˆ«åæ¥ç®€åŒ–æ“ä½œï¼š

```bash
alias fuckgit="git config --global http.proxy 'socks5://127.0.0.1:8889' && git config --global https.proxy 'socks5://127.0.0.1:8889'"
alias unfuckgit="git config --global --unset http.proxy && git config --global --unset https.proxy"
```

## åˆå§‹åŒ–é¡¹ç›®å¹¶ä¸Šä¼ åˆ° GitHub

ä¸ºäº†ä½¿ç”¨ Gitï¼Œä½ éœ€è¦é¦–å…ˆå…¨å±€è®¾ç½®ç”¨æˆ·ä¿¡æ¯ï¼š

```bash
# è®¾ç½®ç”¨æˆ·åå’Œé‚®ç®±
git config --global user.name "dong4j"
git config --global user.email "dong4j@gmail.com"
```

ç„¶åæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œæ“ä½œï¼š

1. è¿›å…¥ä½ çš„é¡¹ç›®ç›®å½•ï¼Œå¹¶åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ Git ä»“åº“ã€‚
2. æ·»åŠ ä½ æƒ³è¦ç‰ˆæœ¬æ§åˆ¶çš„æ–‡ä»¶åˆ°æš‚å­˜åŒºï¼ˆstaging areaï¼‰ã€‚
3. æäº¤æ›´æ”¹å¹¶æ·»åŠ æè¿°ä¿¡æ¯ã€‚

```bash
git init
git add fileName
git commit -m 'è¯´æ˜'
```

æ¥ç€ï¼Œå°†æœ¬åœ°ä»“åº“ä¸ GitHub ä¸Šçš„æ–°å»ºä»“åº“å…³è”èµ·æ¥ï¼š

```bash
# å…³è”è¿œç¨‹ä»“åº“
git remote add origin git@github.com:dong4j/dubbo_demo.git
```

æœ€åä¸Šä¼ ä½ çš„ä»£ç åˆ° GitHubï¼š

```bash
git push -u origin master
```

### å¼ºåˆ¶æäº¤æ›´æ”¹å¹¶åŒæ­¥æœ¬åœ°åˆ†æ”¯

ä½ å¯ä»¥ä½¿ç”¨ç›¸åŒçš„æ–¹å¼æ¨é€æ›´æ–°ï¼Œå¹¶ä¸”åœ¨å¿…è¦æ—¶å¼ºåˆ¶è¦†ç›–è¿œç¨‹çš„ç‰ˆæœ¬ã€‚

```bash
# åŒæ­¥æœ¬åœ°ä¸è¿œç¨‹ä»“åº“
git pull origin master
```

æˆ–è€…å¦‚æœéœ€è¦å¼ºåˆ¶æ¨é€æ›´æ”¹ï¼Œåˆ™ä½¿ç”¨ï¼š

```bash
git push -u origin master --force
```

## åˆ›å»ºåŠåŒæ­¥åˆ†æ”¯

åˆ›å»ºæ–°åˆ†æ”¯çš„æ“ä½œç›¸å½“ç®€å•ï¼š

```bash
# åˆ›å»ºå¹¶åˆ‡æ¢åˆ°æ–°çš„åˆ†æ”¯
git checkout -b new_branch_name
```

ä¹‹åï¼Œä½ å¯ä»¥å°†è¿™ä¸ªæœ¬åœ°åˆ†æ”¯æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼Œå¹¶å°†å…¶ä¸ä¸€ä¸ªè¿œç«¯åˆ†æ”¯å…³è”èµ·æ¥ã€‚å®Œæˆè¿™äº›æ“ä½œåï¼Œä½ å°±å¯ä»¥åœ¨ GitHub ä¸Šçœ‹åˆ°ä½ çš„åˆ†æ”¯äº†ã€‚

## å¤„ç†å¤§å°å†™ä¸åŒ¹é…çš„æ–‡ä»¶å

å¦‚æœéœ€è¦ä¿®æ”¹æ–‡ä»¶åä¸­çš„å¤§å°å†™ï¼ˆè¿™é€šå¸¸æ˜¯ä¸€ä¸ªæ•æ„Ÿçš„æ“ä½œï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
git mv --force filename.java FileName.java
```

## ç§»é™¤ç‰ˆæœ¬æ§åˆ¶ä¸‹çš„æŸä¸ªæ–‡ä»¶æˆ–ç›®å½•

å¦‚æœä½ æƒ³è¦ç§»é™¤æŸç‰¹å®šæ–‡ä»¶æˆ–è€…æ•´ä¸ªç›®å½•çš„ Git è·Ÿè¸ªä¿¡æ¯ï¼Œä½ å¯ä»¥é‡‡ç”¨å¦‚ä¸‹çš„æ­¥éª¤ï¼š

é¦–å…ˆï¼Œåœ¨ä¸å®é™…åˆ é™¤ä»»ä½•å†…å®¹çš„æƒ…å†µä¸‹é¢„è§ˆå°†è¦æ‰§è¡Œçš„æ“ä½œï¼š

```bash
# ä»…æ˜¾ç¤ºå°†ä¼šè¢«å¿½ç•¥çš„å†…å®¹åˆ—è¡¨ï¼ˆ-n å‚æ•°ï¼‰
git rm -r -n --cached "bin/"
```

ç„¶åæ‰§è¡Œæœ€ç»ˆå‘½ä»¤æ¥ç§»é™¤ Git è·Ÿè¸ªï¼š

```bash
git rm -r --cached "bin/"      // ç§»é™¤ç›®å½•çš„Gitè·Ÿè¸ªä¿¡æ¯ï¼Œä½†ä¿ç•™æ–‡ä»¶åœ¨æœ¬åœ°ã€‚
git commit -m" remove bin folder all file out of control"
```

æœ€åå°†å˜æ›´æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼š

```bash
git push origin master
```

## ä¿®æ”¹æ–‡ä»¶å¤¹åç§°æˆ–ç§»é™¤ç‰ˆæœ¬æ§åˆ¶ä¸‹çš„ç©ºæ–‡ä»¶å¤¹

æ·»åŠ  .gitkeep æ–‡ä»¶è‡³æ‰€æœ‰æœªè¢« Git è·Ÿè¸ªçš„ç©ºæ–‡ä»¶å¤¹ï¼š

```bash
find . âˆ’type d âˆ’empty -and âˆ’not âˆ’regex ./\.git.âˆ— -exec touch {}/.gitkeep \;
```

## åˆ é™¤è¿œç«¯åˆ†æ”¯

è¦åˆ é™¤è¿œç¨‹ä»“åº“ä¸­çš„ä¸€ä¸ªç‰¹å®šåˆ†æ”¯ï¼Œè¯·éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

1. æŸ¥çœ‹æ‰€æœ‰æœ¬åœ°åŠè¿œç¨‹åˆ†æ”¯ã€‚
2. å¦‚æœéœ€è¦ï¼Œå…ˆåœ¨æœ¬åœ°ç§»é™¤æŒ‡å®šçš„åˆ†æ”¯ã€‚
3. ä½¿ç”¨ `git push` å‘½ä»¤ä»åŸå§‹è¿œç¨‹ä»“åº“ä¸­åˆ é™¤è¯¥åˆ†æ”¯ã€‚

```bash
# æŸ¥çœ‹æ‰€æœ‰æœ¬åœ°å’Œè¿œç¨‹åˆ†æ”¯ï¼ˆ-a è¡¨ç¤ºæ‰€æœ‰ï¼‰
git branch -a

# åˆ é™¤æœ¬åœ°åˆ†æ”¯
git branch -d branchname

# ä»è¿œç«¯åˆ é™¤ä¸€ä¸ªåˆ†æ”¯
git push origin :branchname
```

## ä¿®æ”¹è¿œç¨‹ä»“åº“çš„åœ°å€

ä¿®æ”¹ Git è¿œç¨‹ä»“åº“åœ°å€æœ‰å‡ ç§æ–¹å¼ï¼š

1. ä½¿ç”¨ `set-url` å‘½ä»¤ï¼š
   ```bash
   git remote set-url origin [æ–°çš„URL]
   ```
2. åˆ é™¤æ—§çš„è¿œç«¯å¹¶é‡æ–°æ·»åŠ ä¸€ä¸ªæ–°è¿œç«¯ï¼š

   ```bash
   git remote rm origin
   git remote add origin [æ–°çš„URL]
   ```

3. ç›´æ¥ä¿®æ”¹ `.git/config` æ–‡ä»¶ï¼Œå®šä½åˆ°æ­£ç¡®çš„éƒ¨åˆ†å¹¶æ›´æ–° URLã€‚

## ä¿®æ”¹æ–‡ä»¶åå¤§å°å†™

è‹¥éœ€æ”¹å˜æ–‡ä»¶åç§°çš„å¤§å°å†™ï¼ˆè¯·æ³¨æ„è¿™åœ¨æŸäº›ç³»ç»Ÿä¸Šå¯èƒ½ä¸ä¼šç”Ÿæ•ˆï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ï¼š

```bash
git mv --force filename.java FileName.java
```

è¿™æ ·å¯ä»¥åœ¨ä¿ç•™å†å²è®°å½•çš„åŒæ—¶æ›´æ”¹æ–‡ä»¶åå­—ã€‚

## [æŒæ¡Gitæ ¸å¿ƒæŠ€èƒ½ï¼šå¿…å¤‡çš„å‘½ä»¤å’Œæ“ä½œ](https://blog.dong4j.site/posts/858a1037.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## æ–°å»ºä»£ç åº“

åœ¨å¼€å§‹ä»»ä½•é¡¹ç›®å‰ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ä»£ç åº“ã€‚è¿™å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®Œæˆï¼š

```bash
# åœ¨å½“å‰ç›®å½•åˆ›å»ºæ–°çš„gitä»“åº“
$ git init
# åˆå§‹åŒ–ä¸€ä¸ªæ–°ç›®å½•ä½œä¸ºGitä»£ç åº“ï¼ˆå¦‚æœè¿™ä¸ªç›®å½•å·²å­˜åœ¨ï¼‰
$ git init [project-name]
# å…‹éš†è¿œç¨‹ä»£ç åº“è‡³æœ¬åœ°
$ git clone [url]
```

### æ³¨æ„äº‹é¡¹ï¼š

- è¯·ç¡®ä¿é€‰æ‹©åˆé€‚çš„ä½ç½®å’Œé¡¹ç›®åç§°ï¼Œé¿å…ä¸ç°æœ‰æ–‡ä»¶æˆ–ç›®å½•å†²çªã€‚
- å¦‚æœè¦å…‹éš†ä¸€ä¸ªé¡¹ç›®ï¼Œè¯·ç¡®è®¤ä½ æœ‰è®¿é—®æƒé™ä»¥åŠæ‰€é€‰ URL æ˜¯æ­£ç¡®çš„ã€‚

## é…ç½®

é…ç½® Git æœ‰åŠ©äºç¡®ä¿ä½ åœ¨æäº¤æ—¶ä¿¡æ¯å‡†ç¡®ä¸”ä¸€è‡´ï¼š

```bash
# æŸ¥çœ‹å½“å‰Gitçš„å…¨å±€é…ç½®
$ git config --list
# ç¼–è¾‘æœ¬åœ°æˆ–å…¨çƒçš„gitconfigæ–‡ä»¶
$ git config -e [--global]
# è®¾ç½®æäº¤ä»£ç æ—¶çš„åŸºæœ¬ç”¨æˆ·ä¿¡æ¯ï¼ˆæ¨èä½¿ç”¨--globalï¼‰
$ git config [--global] user.name "[name]"
$ git config [--global] user.email "[email address]"
```

### æ³¨æ„äº‹é¡¹ï¼š

- ä½¿ç”¨`--global`æ ‡å¿—è®¾ç½®é…ç½®é¡¹ï¼Œå¯ä»¥ç¡®ä¿åœ¨æ‰€æœ‰é¡¹ç›®ä¸­éƒ½ä¿æŒä¸€è‡´æ€§ã€‚
- ç¡®ä¿ä½ çš„ç”¨æˆ·åå’Œé‚®ç®±æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œå¹¶ä¸”ä¸ä½ åœ¨ä»£ç æ‰˜ç®¡å¹³å°ä¸Šä½¿ç”¨çš„è´¦æˆ·ä¿¡æ¯ä¸€è‡´ã€‚

## å¢åŠ /åˆ é™¤æ–‡ä»¶

è¿™äº›å‘½ä»¤ç”¨äºç®¡ç†ä»“åº“ä¸­çš„æ–‡ä»¶ï¼š

```bash
# æ·»åŠ æŒ‡å®šæ–‡ä»¶åˆ°æš‚å­˜åŒº
$ git add [file1] [file2] ...
# å°†ç›®å½•åŠå…¶å­ç›®å½•çš„æ‰€æœ‰æ›´æ”¹æ·»åŠ åˆ°æš‚å­˜åŒº
$ git add [dir]
# å°†å·¥ä½œåŒºä¸­æ‰€æœ‰çš„æ”¹åŠ¨éƒ½æäº¤è‡³æš‚å­˜åŒºï¼ˆåŒ…æ‹¬æ–°æ·»å’Œä¿®æ”¹è¿‡çš„æ–‡ä»¶ï¼‰
$ git add .
# ä½¿ç”¨äº¤äº’æ¨¡å¼ï¼Œæ¯æ¬¡å˜æ›´å‰æç¤ºç¡®è®¤æ˜¯å¦è¦å°†è¯¥æ–‡ä»¶çš„éƒ¨åˆ†æˆ–å…¨éƒ¨å˜æ›´æäº¤ï¼ˆå¯é€‰ï¼‰
$ git add -p
# ä»å·¥ä½œåŒºåˆ é™¤æ–‡ä»¶ï¼Œå¹¶å°†è¿™æ¬¡åˆ é™¤æ”¾å…¥æš‚å­˜åŒº
$ git rm [file1] [file2] ...
# åœæ­¢è¿½è¸ªæŒ‡å®šæ–‡ä»¶ï¼Œä½†ä¿ç•™åœ¨æœ¬åœ°ï¼ˆä¸ä»ç£ç›˜ä¸­åˆ é™¤ï¼‰
$ git rm --cached [file]
# æ›´æ”¹æ–‡ä»¶åå¹¶å°†å…¶æ›´æ”¹æäº¤åˆ°æš‚å­˜åŒº
$ git mv [file-original] [file-renamed]
```

### æ³¨æ„äº‹é¡¹ï¼š

- ä½¿ç”¨`git add .`æ—¶è¦ç‰¹åˆ«å°å¿ƒï¼Œç¡®ä¿ä½ äº†è§£æ‰€æœ‰å˜åŒ–ã€‚
- åœ¨æ‰§è¡Œ`rm`å‘½ä»¤å‰ï¼Œæœ€å¥½å…ˆç¡®è®¤è¢«åˆ é™¤çš„æ–‡ä»¶æ˜¯å¦æ˜¯ä½ æƒ³è¦ç§»é™¤çš„ã€‚

## ä»£ç æäº¤

è¿™äº›å‘½ä»¤ç”¨äºå°†æš‚å­˜åŒºçš„å†…å®¹æäº¤åˆ°æœ¬åœ°ä»“åº“ä¸­ï¼š

```bash
# æäº¤æš‚å­˜åŒºçš„æ‰€æœ‰æ›´æ”¹è‡³ä»“åº“ï¼ˆéœ€è¦å¡«å†™ä¸€æ¡commitä¿¡æ¯ï¼‰
$ git commit -m [message]
# æäº¤ç‰¹å®šæ–‡ä»¶æˆ–ç›®å½•è‡³ä»“åº“ï¼Œé™„å¸¦æ¶ˆæ¯
$ git commit [file1] [file2] ... -m [message]
# ç›´æ¥æäº¤å·¥ä½œåŒºå†…æ‰€æœ‰å·²è¿½è¸ªè¿‡çš„æ”¹åŠ¨è‡³ä»“åº“åŒº
$ git commit -a
# åœ¨commitæ—¶æ˜¾ç¤ºè¯¦ç»†å˜æ›´ä¿¡æ¯ï¼ˆdiffï¼‰
$ git commit -v
# ä½¿ç”¨æ–°çš„commitè¦†ç›–ä¸Šä¸€æ¬¡çš„æäº¤ï¼Œé€‚ç”¨äºæ²¡æœ‰å®é™…å†…å®¹å˜åŒ–ä½†éœ€ä¿®æ”¹commitä¿¡æ¯çš„æƒ…å†µ
$ git commit --amend -m [message]
# å¯¹ç‰¹å®šæ–‡ä»¶è¿›è¡ŒäºŒæ¬¡æäº¤ï¼ˆåœ¨å·²æœ‰çš„commitåŸºç¡€ä¸Šï¼‰
$ git commit --amend [file1] [file2] ...
```

### æ³¨æ„äº‹é¡¹ï¼š

- ä½¿ç”¨`git commit --amend`ä»…å½“æ²¡æœ‰æ¨é€è¿‡ä»£ç æ—¶æ˜¯å®‰å…¨çš„ï¼Œå¦åˆ™å¯èƒ½ä¼šå¼•èµ·å†²çªã€‚
- æäº¤ä¿¡æ¯åº”ç®€æ˜æ‰¼è¦ä¸”å…·æœ‰æè¿°æ€§ã€‚

## åˆ†æ”¯

åˆ†æ”¯ç®¡ç†å¯¹äºå¤§å‹é¡¹ç›®æ¥è¯´è‡³å…³é‡è¦ï¼š

```bash
# åˆ—å‡ºæ‰€æœ‰æœ¬åœ°åˆ†æ”¯åç§°
$ git branch
# æŸ¥çœ‹è¿œç¨‹ä»“åº“çš„æ‰€æœ‰åˆ†æ”¯åŠå…¶æœ€æ–°æäº¤è®°å½•
$ git branch -r
# æ˜¾ç¤ºæ‰€æœ‰æœ¬åœ°å’Œè¿œç¨‹åˆ†æ”¯åˆ—è¡¨
$ git branch -a
# åœ¨å½“å‰ç›®å½•åˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯ï¼Œä½†ä¸åˆ‡æ¢åˆ°è¯¥åˆ†æ”¯ä¸Š
$ git branch [branch-name]
# åˆ›å»ºå¹¶ç«‹å³æ£€æŸ¥å‡ºæ–°çš„åˆ†æ”¯ï¼ˆç›¸å½“äºæ‰§è¡Œä¸¤æ¬¡å‘½ä»¤ï¼‰
$ git checkout -b [branch]
# æ ¹æ®ç‰¹å®šçš„commitå»ºç«‹ä¸€ä¸ªæ–°çš„åˆ†æ”¯
$ git branch [branch] [commit]
# è¿œç¨‹åˆ†æ”¯çš„è¿½è¸ªå…³ç³»é…ç½®
$ git branch --track [branch] [remote-branch]
# åˆ‡æ¢åˆ°æŒ‡å®šçš„åˆ†æ”¯ï¼Œå¹¶æ›´æ–°å·¥ä½œç›®å½•ä¸­çš„æ–‡ä»¶
$ git checkout [branch-name]
# å¿«é€Ÿåˆ‡æ¢å›ä¹‹å‰æ´»è·ƒè¿‡çš„æœ€åä¸€ä¸ªåˆ†æ”¯
$ git checkout -
# ä¸ºç°æœ‰æœ¬åœ°åˆ†æ”¯å’Œè¿œç¨‹ä»“åº“ä¸Šçš„ä¸€ä¸ªåˆ†æ”¯å»ºç«‹è¿½è¸ªå…³ç³»
$ git branch --set-upstream-to=[remote/branch] [local-branch]
# åˆå¹¶æŒ‡å®šåˆ†æ”¯çš„å†…å®¹åˆ°å½“å‰å·¥ä½œåŒºä¸­
$ git merge [branch]
# ä»å…¶ä»–æäº¤å¼•å…¥å˜æ›´è‡³å½“å‰åˆ†æ”¯ï¼ˆä¸ä¼šä¿®æ”¹å†å²è®°å½•ï¼‰
$ git cherry-pick [commit]
# åˆ é™¤æœ¬åœ°çš„åˆ†æ”¯
$ git branch -d [branch-name]
# ç§»é™¤è¿œç¨‹ä»“åº“ä¸Šçš„ä¸€ä¸ªåˆ†æ”¯
$ git push origin --delete [branch-name] æˆ–è€…
git branch -dr [remote/branch]
```

### æ³¨æ„äº‹é¡¹ï¼š

- åˆ‡æ¢åˆ†æ”¯å‰ï¼Œè¯·ç¡®ä¿ä½ å·²ä¿å­˜å¹¶æäº¤æ‰€æœ‰æ›´æ”¹ã€‚
- åˆ é™¤åˆ†æ”¯æ—¶åŠ¡å¿…è°¨æ…ï¼Œè¿™å°†æ°¸ä¹…ç§»é™¤æ‰€æœ‰æœªæ¨é€çš„å˜æ›´ã€‚

## æ ‡ç­¾

æ ‡ç­¾ç”¨äºæ ‡è®°é‡è¦çš„ç‰ˆæœ¬æˆ–é‡Œç¨‹ç¢‘ï¼š

```bash
# æ˜¾ç¤ºå…¨éƒ¨æ ‡ç­¾åˆ—è¡¨
$ git tag
# åœ¨å½“å‰æäº¤åˆ›å»ºä¸€ä¸ªè½»é‡çº§æ ‡ç­¾ï¼ˆé»˜è®¤ï¼‰
$ git tag [tag]
# åˆ›å»ºä¸€ä¸ªå¸¦æœ‰æ³¨é‡Šä¿¡æ¯çš„é™„å¸¦å¯¹è±¡å¼•ç”¨çš„æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰
$ git tag -a [tag] -m "blablabla"
# åˆ é™¤æœ¬åœ°çš„æ ‡ç­¾
$ git tag -d [tag]
# åœ¨è¿œç¨‹ä»“åº“ä¸­åˆ é™¤æ ‡ç­¾ï¼Œéœ€è¦å…ˆæ¨é€åç§»é™¤
$ git push origin --delete [tagName]
# æŸ¥çœ‹æŒ‡å®šæ ‡ç­¾çš„ä¿¡æ¯åŠå…¶æäº¤å†å²è®°å½•
$ git show [tag]
# å°†æ‰€æœ‰æœ¬åœ°æ ‡ç­¾æ¨é€åˆ°è¿œç¨‹
$ git push [remote] --tags
# ä¹Ÿå¯ä»¥æŒ‡å®šè¦æ¨é€çš„æŸä¸ªæ ‡ç­¾
$ git push [remote] [tagname]
```

### æ³¨æ„äº‹é¡¹ï¼š

- åˆ é™¤æ ‡ç­¾æ—¶éœ€è¦å°å¿ƒï¼Œç¡®ä¿ä½ ä¸éœ€è¦è¿™ä¸ªç‰ˆæœ¬çš„å†å²è®°å½•ã€‚
- æ¨é€æ ‡ç­¾ä¹‹å‰ï¼Œè¯·ç¡®è®¤è¯¥æ“ä½œä¸ä¼šè¦†ç›–ä»»ä½•é‡è¦çš„å†å²æ ‡è®°ã€‚

## æŸ¥çœ‹ä¿¡æ¯

è¿™äº›å‘½ä»¤ç”¨äºæ£€æŸ¥ä»“åº“çš„çŠ¶æ€å’Œå˜åŒ–ï¼š

```bash
# æ˜¾ç¤ºå·¥ä½œåŒºä¸­å“ªäº›æ–‡ä»¶æœ‰å˜æ›´æˆ–å°šæœªè¿½è¸ªï¼ˆgit statusï¼‰
$ git status
# ä»¥æ—¶é—´çº¿å½¢å¼å±•ç¤ºå½“å‰åˆ†æ”¯çš„å†å²è®°å½•ï¼ˆå¯ä»¥ä½¿ç”¨å„ç§æ ¼å¼åŒ–é€‰é¡¹ï¼Œå¦‚--pretty=format:ç­‰ï¼‰
$ git log
# å±•ç¤ºæ¯æ¬¡æäº¤çš„å·®å¼‚åŠå…¶æ¶‰åŠçš„æ–‡ä»¶åˆ—è¡¨ï¼ˆgit log --statï¼‰
$ git log --stat
# æŸ¥æ‰¾åŒ…å«æŸä¸ªå…³é”®è¯çš„commitå†å²çºªå½•
$ git log -S [keyword]
# æ˜¾ç¤ºè‡ªæŒ‡å®šæ ‡ç­¾ä»¥æ¥çš„æ‰€æœ‰å˜æ›´ï¼Œæ¯æ¡è®°å½•ä¸€è¡Œï¼ˆgit log tag...HEAD --pretty=format:%sï¼‰
$ git log [tag] HEAD --pretty=format:%s
# ç­›é€‰å¹¶æ˜¾ç¤ºç¬¦åˆç‰¹å®šæ¨¡å¼æˆ–æ–‡æœ¬çš„æäº¤ä¿¡æ¯æ‘˜è¦ï¼ˆ--grep=featureç›¸å½“äº-S featureä½†åŒ¹é…æ‰€æœ‰æ–‡ä»¶è€Œéä»…é™äºå•ä¸ªæ–‡ä»¶ï¼‰
$ git log [tag] HEAD --grep feature
# æŸ¥çœ‹æŸæ–‡ä»¶åœ¨ä¸åŒç‰ˆæœ¬ä¹‹é—´çš„å˜æ›´å†å²ï¼ŒåŒ…æ‹¬åç§°æ›´æ”¹è®°å½•ï¼ˆgit whatchangedç­‰åŒäºlog --followä½†ä»¥æ›´ç®€æ´çš„æ–¹å¼å±•ç¤ºï¼‰
$ git log --follow [file]
$ git whatchanged [file]
# ä»¥diffçš„å½¢å¼è¾“å‡ºæŒ‡å®šæ–‡ä»¶çš„è¯¦ç»†æäº¤å†å²è®°å½•
$ git log -p [file]
# æ˜¾ç¤ºæœ€è¿‘äº”æ¬¡æäº¤ä¿¡æ¯ï¼Œæ ¼å¼ç®€ç»ƒï¼ˆgit log -5ç›¸å½“äºlog --oneline --no-walk HEAD^5..HEADï¼‰
$ git log -5 --pretty --oneline
# ç»Ÿè®¡æ‰€æœ‰æäº¤è€…çš„æ´»è·ƒåº¦æ’åå’Œæäº¤æ€»æ•°ï¼ˆç±»ä¼¼shortlogä½†æ˜¾ç¤ºä½œè€…åè€Œécommit hashï¼‰
$ git shortlog -sn
# æŸ¥æ‰¾å¹¶åˆ—å‡ºæŸä¸ªæ–‡ä»¶çš„ä¿®æ”¹è€…åŠå…¶æœ€åä¸€æ¬¡ç¼–è¾‘æ—¶é—´
$ git blame [file]
# æ¯”è¾ƒå·¥ä½œç›®å½•ä¸æš‚å­˜åŒºä¹‹é—´çš„å·®å¼‚ï¼Œæ˜¾ç¤ºå°šæœªæ·»åŠ è‡³æš‚å­˜æˆ–å·²ç§»é™¤çš„å†…å®¹ï¼ˆgit diffç­‰åŒäºdiff-index --cached HEAD --ï¼‰
$ git diff
# æ˜¾ç¤ºæš‚å­˜åŒºç›¸è¾ƒäºä¸Šä¸€ä¸ªæäº¤çš„ä¿®æ”¹å†…å®¹ï¼ˆgit diff --stagedï¼‰
$ git diff --cached [file]
# å¯¹æ¯”å·¥ä½œåŒºä¸­çš„æ–‡ä»¶ä¸æœ€è¿‘ä¸€æ¬¡commitçš„å·®å¼‚ï¼ˆgit diff HEAD...ï¼‰
$ git diff HEAD
# ç”Ÿæˆä¸¤ä¸ªåˆ†æ”¯ä¹‹é—´çš„diffæŠ¥å‘Šï¼Œå±•ç¤ºå®ƒä»¬åˆå¹¶åå¯èƒ½äº§ç”Ÿçš„å†²çªæˆ–åŒºåˆ«
$ git diff [first-branch]...[second-branch]
# ç»Ÿè®¡æŸæ®µæ—¶é—´å†…çš„ä»£ç å˜æ›´è¡Œæ•°ï¼ˆæ¯”å¦‚ä»Šå¤©çš„å·¥ä½œé‡ï¼‰
$ git diff --shortstat "@{0 day ago}"
# æŸ¥çœ‹æŸä¸ªcommitçš„è¯¦ç»†ä¿¡æ¯å’Œæäº¤å†…å®¹
$ git show [commit]
# åˆ—å‡ºæŒ‡å®šcommitæ‰€æ¶‰åŠçš„æ‰€æœ‰æ–‡ä»¶åˆ—è¡¨ï¼Œä¸æ˜¾ç¤ºå·®å¼‚æˆ–å…ƒæ•°æ®
$ git show --name-only [commit]
# æ˜¾ç¤ºæŸæ¬¡ç‰¹å®šç‰ˆæœ¬ä¸­æŸæ–‡ä»¶çš„å†…å®¹ï¼ˆgit cat-file blobç­‰ä»·äºshowï¼‰
$ git show [commit]:[filename]
# æŸ¥çœ‹æœ€è¿‘å‡ æ¬¡æœ¬åœ°æäº¤è®°å½•ç®€è¦ä¿¡æ¯
$ git reflog
```

### æ³¨æ„äº‹é¡¹ï¼š

- ä½¿ç”¨`git log`æŸ¥çœ‹å†å²æ—¶ï¼Œå¯ä»¥ç»“åˆå„ç§å‚æ•°å’Œé€‰é¡¹æ¥å®šåˆ¶è¾“å‡ºå†…å®¹ã€‚
- `git blame`æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œä½†é¢‘ç¹ä½¿ç”¨å¯èƒ½ä¼šå¯¹æ€§èƒ½äº§ç”Ÿå½±å“ã€‚

## è¿œç¨‹åŒæ­¥

è¿œç¨‹æ“ä½œæ˜¯ä¸å›¢é˜Ÿæˆå‘˜å…±äº«ä»£ç çš„å…³é”®ï¼š

```bash
# ä»è¿œç¨‹ä»“åº“ä¸‹è½½æœ€æ–°å˜åŠ¨åˆ°æœ¬åœ°æš‚å­˜åŒºï¼ˆä¸ä¼šåˆå¹¶åˆ°å·¥ä½œç›®å½•ï¼‰
$ git fetch [remote]
# æ˜¾ç¤ºæ‰€æœ‰å·²é…ç½®çš„è¿œç¨‹ä»“åº“åŠå…¶URLç­‰ä¿¡æ¯
$ git remote -v
# æŸ¥çœ‹ç‰¹å®šè¿œç¨‹åˆ†æ”¯çš„æ‰€æœ‰é…ç½®è¯¦æƒ…
$ git remote show [remote]
# æ·»åŠ æ–°çš„è¿œç¨‹ä»“åº“ï¼Œå¹¶æŒ‡å®šåˆ«åæˆ–ç®€ç§°ç”¨äºåç»­æ“ä½œ
$ git remote add [shortname] [url]
# ä»è¿œç¨‹ä»“åº“ä¸‹è½½æœ€æ–°ä»£ç å¹¶åˆå¹¶åˆ°æœ¬åœ°åˆ†æ”¯ï¼ˆé€šå¸¸ä¸pullå‘½ä»¤ç»“åˆä½¿ç”¨ï¼‰
$ git pull [remote] [branch]
# åŒæ­¥æœ¬åœ°æŒ‡å®šåˆ†æ”¯è‡³å¯¹åº”çš„è¿œç¨‹åˆ†æ”¯ï¼Œç¡®ä¿ä¸¤è€…ä¸€è‡´
$ git push [remote] [branch]
# å¼ºåˆ¶æ¨é€å½“å‰åˆ†æ”¯çš„æ›´æ”¹è‡³è¿œç¨‹ä»“åº“ï¼Œå¿½ç•¥ä»»ä½•å¯èƒ½å­˜åœ¨çš„å†²çªæˆ–é—®é¢˜
$ git push [remote] --force
# å°†æ‰€æœ‰æœ¬åœ°åˆ†æ”¯åŒæ­¥æ¨é€åˆ°è¿œç¨‹æœåŠ¡å™¨ä¸Šï¼ˆgit push --allç­‰åŒäºéå†æ‰€æœ‰åˆ†æ”¯å¹¶æ‰§è¡Œpushå‘½ä»¤ï¼‰
$ git push [remote] --all
# æŒ‡å®šå°†æœ¬åœ°masteråˆ†æ”¯æ¨é€è‡³è¿œç¨‹ä»“åº“çš„ä¸»å¹²åˆ†æ”¯ï¼Œé¦–æ¬¡æ¨é€æ—¶è®¾ç½®é»˜è®¤å…³è”å…³ç³»
$ git push -u origin master
```

### æ³¨æ„äº‹é¡¹ï¼š

- å¼ºåˆ¶æ¨é€åˆ°è¿œç¨‹é€šå¸¸æ„å‘³ç€è¦†ç›–ä»–äººçš„å·¥ä½œï¼ŒåŠ¡å¿…åœ¨æ²Ÿé€šåè¿›è¡Œã€‚
- ä½¿ç”¨`git pull`ä¹‹å‰ï¼Œæœ€å¥½å…ˆç¡®ä¿è‡ªå·±çš„ä»£ç å·²å®Œå…¨æäº¤ã€‚

## æ’¤é”€æ“ä½œ

è¿™äº›å‘½ä»¤ç”¨äºæ’¤é”€é”™è¯¯çš„æ›´æ”¹æˆ–æ¢å¤ç‰¹å®šçŠ¶æ€ï¼š

```bash
# ä»æš‚å­˜åŒºè¿˜åŸæŒ‡å®šæ–‡ä»¶è‡³å·¥ä½œç›®å½•ï¼ˆç›¸å½“äºcheckoutï¼‰
$ git checkout [file]
# å°†ç‰¹å®šcommitä¸­æŸä¸ªæ–‡ä»¶çš„çŠ¶æ€é‡ç½®åˆ°æš‚å­˜åŒºï¼ŒåŒæ—¶ä¿ç•™å…¶åœ¨å·¥ä½œç›®å½•ä¸­çš„å½“å‰ç‰ˆæœ¬
$ git checkout [commit] [file]
# è¿˜åŸæ‰€æœ‰å·²æ·»åŠ åˆ°æš‚å­˜åŒºçš„å˜æ›´è‡³å·¥ä½œåŒº
$ git checkout .
# ä»…å°†æŒ‡å®šæ–‡ä»¶ä»æš‚å­˜åŒºæ¢å¤è‡³ä¸Šä¸€æ¬¡æäº¤çŠ¶æ€ï¼ˆä¿æŒå·¥ä½œåŒºä¸å˜ï¼‰
$ git reset [file]
# åŒæ—¶é‡ç½®æš‚å­˜åŒºå’Œå·¥ä½œåŒºï¼Œä½¿å¾—ä¸ä¸Šä¸€æ¬¡commitå®Œå…¨ä¸€è‡´
$ git reset --hard
# å°†å½“å‰åˆ†æ”¯çš„æŒ‡å‘å›æº¯åˆ°æŸä¸ªcommitï¼Œå¹¶åŒæ­¥æ›´æ–°æš‚å­˜åŒºï¼Œä½†ä¿ç•™å·¥ä½œç›®å½•ä¸­çš„æœ€æ–°ä¿®æ”¹ï¼ˆä¸æ¨èæ­¤æ“ä½œï¼‰
$ git reset [commit]
# å¼ºåˆ¶é‡ç½®å½“å‰HEADè‡³æŒ‡å®šcommitçŠ¶æ€ï¼Œè¦†ç›–æ‰€æœ‰æœªæäº¤è¿‡çš„æ”¹åŠ¨ä¸”ä¸ç•™è®°å½•
$ git reset --hard [commit]
# ä»…å°†åˆ†æ”¯çš„æŒ‡å‘ç§»åŠ¨åˆ°æŸä¸ªå†å²ä½ç½®ï¼ŒåŒæ—¶ä¿æŒæš‚å­˜åŒºå’Œå·¥ä½œç›®å½•ä¸­çš„å…¨éƒ¨ä¿®æ”¹
$ git reset --keep [commit]
# åˆ›å»ºä¸€ä¸ªæ–°çš„commitç”¨äºæ’¤é”€ä¹‹å‰çš„ä¸€ä¸ªæˆ–å¤šä¸ªæ›´æ”¹ï¼ˆgit revertç­‰åŒäºåˆ›å»ºæ–°æäº¤è€Œä¸ä»…ä»…æ˜¯å›æ»šï¼‰
$ git revert [commit]
# æš‚æ—¶å­˜å‚¨å°šæœªæäº¤çš„æ›´æ”¹è‡³æ ˆä¸­ï¼Œä»¥ä¾¿ç¨åæ¢å¤ä½¿ç”¨
$ git stash
# å°†æœ€æ–°çš„stashå¼¹å‡ºå¹¶åº”ç”¨äºå·¥ä½œåŒº
$ git stash pop
```

### æ³¨æ„äº‹é¡¹ï¼š

- `git reset --hard`æ˜¯ä¸€ä¸ªå±é™©çš„æ“ä½œï¼Œè¯·ç¡®ä¿äº†è§£å…¶å½±å“åå†æ‰§è¡Œã€‚
- ä½¿ç”¨`revert`å‘½ä»¤å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ commit æ¥æ’¤é”€ç‰¹å®šçš„æ›´æ”¹ï¼Œé€‚åˆéœ€è¦è®°å½•å†å²çš„æƒ…å†µã€‚

## å…¶ä»–

è¿˜æœ‰ä¸€äº›é¢å¤–çš„åŠŸèƒ½å’Œæ“ä½œï¼š

```bash
# ç”Ÿæˆä¸€ä¸ªå‹ç¼©æ–‡ä»¶åŒ…ç”¨äºå‘å¸ƒæˆ–åˆ†å‘ä»£ç 
$ git archive
```

### æ³¨æ„äº‹é¡¹ï¼š

- `git archive`æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œç‰¹åˆ«æ˜¯å½“ä½ éœ€è¦åˆ›å»ºå½’æ¡£ç‰ˆè€Œä¸å¸¦ä»»ä½• Git å…ƒæ•°æ®æ—¶ã€‚

## [è½»æ¾æŒæ¡SSHæœåŠ¡é…ç½®ï¼šUbuntuå…¥é—¨å¿…å­¦æŠ€èƒ½](https://blog.dong4j.site/posts/ab98e58e.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

åœ¨ Ubuntu ç³»ç»Ÿçš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œç†Ÿç»ƒæŒæ¡å›¾å½¢ç•Œé¢ä¸å‘½ä»¤è¡Œæ¨¡å¼çš„åˆ‡æ¢ï¼Œä»¥åŠé…ç½® SSH æœåŠ¡æ˜¯éå¸¸æœ‰ç”¨çš„æŠ€èƒ½ã€‚ä¸‹é¢æˆ‘å°†åˆ†äº«ä¸€äº›åŸºæœ¬çš„æ“ä½œæ­¥éª¤ï¼Œå¸®åŠ© Ubuntu åˆå­¦è€…ä»¬æ›´å¥½åœ°ç®¡ç†è‡ªå·±çš„ç³»ç»Ÿã€‚

## å›¾å½¢ç•Œé¢ä¸å‘½ä»¤è¡Œæ¨¡å¼åˆ‡æ¢

åœ¨ Ubuntu ç³»ç»Ÿä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å¿«æ·é”®åœ¨å›¾å½¢ç•Œé¢å’Œå‘½ä»¤è¡Œæ¨¡å¼ä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼š

- **åˆ‡æ¢åˆ°å‘½ä»¤è¡Œæ¨¡å¼**ï¼šä½¿ç”¨ `Ctrl + Alt + F2` åˆ° `F6`ã€‚æ¯ä¸ªç»„åˆé”®ä¼šæ‰“å¼€ä¸€ä¸ªæ–°çš„å‘½ä»¤è¡Œç•Œé¢ã€‚
- **åˆ‡æ¢å›å›¾å½¢ç•Œé¢**ï¼šä½¿ç”¨ `Ctrl + Alt + F7`ã€‚

## å®‰è£… openssh-server

ä¸ºäº†èƒ½å¤Ÿè¿œç¨‹ç™»å½•åˆ°ä½ çš„ Ubuntu ç³»ç»Ÿï¼Œä½ éœ€è¦å®‰è£… openssh-serverã€‚

1. é¦–å…ˆï¼Œæ›´æ–°ä½ çš„ç³»ç»ŸåŒ…åˆ—è¡¨ï¼š
   ```bash
   sudo apt-get update
   ```
2. æ¥ç€ï¼Œå®‰è£… openssh-serverï¼š
   ```bash
   sudo apt-get install openssh-server
   ```

## æŸ¥çœ‹å’Œå¼€å¯ SSH æœåŠ¡

å®‰è£…å®Œæˆåï¼Œä½ å¯ä»¥æ£€æŸ¥ SSH æœåŠ¡æ˜¯å¦å·²ç»å¼€å¯ã€‚

1. æŸ¥çœ‹å½“å‰è¿è¡Œçš„è¿›ç¨‹ï¼Œç¡®è®¤ SSH æœåŠ¡æ˜¯å¦åœ¨è¿è¡Œï¼š
   ```bash
   sudo ps -e | grep ssh
   ```
2. å¦‚æœ SSH æœåŠ¡æ²¡æœ‰è¿è¡Œï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯åŠ¨å®ƒï¼š
   ```bash
   sudo service ssh start
   ```

## æŸ¥çœ‹ç³»ç»Ÿ IP åœ°å€

åœ¨é…ç½® SSH æœåŠ¡ä¹‹å‰ï¼Œä½ å¯èƒ½éœ€è¦çŸ¥é“ä½ çš„ç³»ç»Ÿ IP åœ°å€ã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼š

```bash
ifconfig
```

## ä¿®æ”¹ SSH é…ç½®æ–‡ä»¶

ä¸ºäº†å…è®¸ root ç”¨æˆ·é€šè¿‡ SSH ç™»å½•ï¼Œä½ éœ€è¦ä¿®æ”¹ SSH çš„é…ç½®æ–‡ä»¶ã€‚

1. æ‰“å¼€ç»ˆç«¯çª—å£ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼š
   ```bash
   sudo gedit /etc/ssh/sshd_config
   ```
2. åœ¨æ‰“å¼€çš„ç¼–è¾‘å™¨ä¸­ï¼Œæ‰¾åˆ°ä»¥ä¸‹è¡Œï¼š
   ```
   PermitRootLogin without-password
   ```
   åœ¨è¿™ä¸€è¡Œçš„å‰é¢åŠ ä¸Š `#` å·ï¼Œå°†å…¶æ³¨é‡Šæ‰ã€‚
3. åœ¨æ–‡ä»¶çš„åˆé€‚ä½ç½®ï¼ˆé€šå¸¸æ˜¯æ–‡ä»¶çš„æœ«å°¾ï¼‰ï¼Œæ·»åŠ ä»¥ä¸‹è¡Œï¼š
   ```
   PermitRootLogin yes
   ```
4. ä¿å­˜æ–‡ä»¶å¹¶å…³é—­ç¼–è¾‘å™¨ã€‚è¿™æ ·ï¼Œä½ å°±å…è®¸äº† root ç”¨æˆ·é€šè¿‡ SSH ç™»å½•ã€‚

## ç»“è¯­

é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œä½ ç°åœ¨åº”è¯¥èƒ½å¤Ÿç†Ÿç»ƒåœ°åœ¨ Ubuntu ç³»ç»Ÿçš„å›¾å½¢ç•Œé¢å’Œå‘½ä»¤è¡Œæ¨¡å¼ä¹‹é—´åˆ‡æ¢ï¼Œå¹¶ä¸”æˆåŠŸé…ç½®äº† SSH æœåŠ¡ã€‚è¿™äº›æŠ€èƒ½å°†å¸®åŠ©ä½ æ›´å¥½åœ°ç®¡ç†å’Œè¿œç¨‹è®¿é—®ä½ çš„ Ubuntu ç³»ç»Ÿã€‚å¦‚æœä½ æ˜¯ Ubuntu æ–°æ‰‹ï¼Œè¿™äº›æ“ä½œå°†æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¼€å§‹ã€‚ç»§ç»­æ¢ç´¢å’Œå­¦ä¹ ï¼Œç¥ä½ åœ¨ Ubuntu çš„ä¸–ç•Œæ—…ç¨‹æ„‰å¿«ï¼

## [æŒæ¡Javaæ³›å‹çš„åŠ›é‡ï¼šä»åŸºç¡€åˆ°é«˜çº§ç”¨æ³•](https://blog.dong4j.site/posts/28ed4a7f.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

# æ·±å…¥ç†è§£æ³›å‹

## ä»€ä¹ˆæ˜¯æ³›å‹

**æ³›å‹å°±æ˜¯å˜é‡ç±»å‹çš„å‚æ•°åŒ–**ã€‚  
åœ¨ä½¿ç”¨æ³›å‹å‰ï¼Œå­˜å…¥é›†åˆä¸­çš„å…ƒç´ å¯ä»¥æ˜¯ä»»ä½•ç±»å‹çš„ï¼Œå½“ä»é›†åˆä¸­å–å‡ºæ—¶ï¼Œæ‰€æœ‰çš„å…ƒç´ éƒ½æ˜¯ Object ç±»å‹ï¼Œéœ€è¦è¿›è¡Œå‘ä¸‹çš„å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œè½¬æ¢åˆ°ç‰¹å®šçš„ç±»å‹ã€‚è€Œå¼ºåˆ¶ç±»å‹è½¬æ¢å®¹æ˜“å¼•èµ·è¿è¡Œæ—¶é”™è¯¯ã€‚  
æ³›å‹ç±»å‹å‚æ•°åªèƒ½è¢«ç±»æˆ–æ¥å£ç±»å‹èµ‹å€¼ï¼Œä¸èƒ½è¢«åŸç”Ÿæ•°æ®ç±»å‹èµ‹å€¼ï¼ŒåŸç”Ÿæ•°æ®ç±»å‹éœ€è¦ä½¿ç”¨å¯¹åº”çš„åŒ…è£…ç±»ã€‚

1. ä¸é€‚ç”¨æ³›å‹

   ```java
   class Test {
       private Object ob; // å®šä¹‰ä¸€ä¸ªé€šç”¨ç±»å‹æˆå‘˜
       public Test(Object ob) {
           this.ob = ob;
       }
       public Object getOb() {
           return ob;
       }
       public void setOb(Object ob) {
           this.ob = ob;
       }
       public void showTyep() {
           System.out.println("Tçš„å®é™…ç±»å‹æ˜¯: " + ob.getClass().getName());
       }
   }
   public class TestDemo {
       public static void main(String[] args) {
           // å®šä¹‰ç±»Gen2çš„ä¸€ä¸ªIntegerç‰ˆæœ¬
           Test intOb = new Test(new Integer(88));
           intOb.showTyep();
           int i = (Integer) intOb.getOb();
           System.out.println("value= " + i);
           System.out.println("---------------------------------");
           // å®šä¹‰ç±»Gen2çš„ä¸€ä¸ªStringç‰ˆæœ¬
           Test strOb = new Test("Hello Gen!");
           strOb.showTyep();
           String s = (String) strOb.getOb();
           System.out.println("value= " + s);
           }
   }
   ```

2. ä½¿ç”¨æ³›å‹

   ```java
   class Test<T> {
       private T ob; // å®šä¹‰æ³›å‹æˆå‘˜å˜é‡
       public Test(T ob) {
           this.ob = ob;
       }
       public T getOb() {
           return ob;
       }
       public void setOb(T ob) {
           this.ob = ob;
       }
       public void showType() {
           System.out.println("Tçš„å®é™…ç±»å‹æ˜¯: " + ob.getClass().getName());
       }
   }
   public class TestDemo {
       public static void main(String[] args) {
           // å®šä¹‰æ³›å‹ç±»Gençš„ä¸€ä¸ªIntegerç‰ˆæœ¬
           Test<Integer> intOb = new Test<Integer>(88);
           intOb.showType();
           int i = intOb.getOb();
           System.out.println("value= " + i);
           System.out.println("----------------------------------");
           // å®šä¹‰æ³›å‹ç±»Gençš„ä¸€ä¸ªStringç‰ˆæœ¬
           Test<String> strOb = new Test<String>("Hello Gen!");
           strOb.showType();
           String s = strOb.getOb();
           System.out.println("value= " + s);
           }
   }
   ```

   ```
   T çš„å®é™…ç±»å‹æ˜¯:
   java.lang.Integer
   value= 88

   T çš„å®é™…ç±»å‹æ˜¯:
   java.lang.String
   value= Hello Gen!
   ```

## æ·±å…¥

æœ‰ä¸¤ä¸ªç±»å¦‚ä¸‹ï¼Œè¦æ„é€ ä¸¤ä¸ªç±»çš„å¯¹è±¡ï¼Œå¹¶æ‰“å°å‡ºå„è‡ªçš„æˆå‘˜ xã€‚

```java
public class StringDemo {
    private String x;
    public StringDemo(String x) {
        this.x = x;
    }
    public String getX() {
        return x;
    }
    public void setX(String x) {
        this.x = x;
    }
}
public class DoubleDemo {
    private Double x;
    public DoubleDemo(Double x) {
        this.x = x;
    }
    public Double getX() {
        return x;
    }
    public void setX(Double x) {
        this.x = x;
    }
}
```

**é‡æ„**

å› ä¸ºä¸Šé¢çš„ç±»ä¸­ï¼Œæˆå‘˜å’Œæ–¹æ³•çš„é€»è¾‘éƒ½ä¸€æ ·ï¼Œå°±æ˜¯ç±»å‹ä¸ä¸€æ ·ï¼Œå› æ­¤è€ƒè™‘é‡æ„ã€‚Object æ˜¯æ‰€æœ‰ç±»çš„çˆ¶ç±»ï¼Œå› æ­¤å¯ä»¥è€ƒè™‘ç”¨ Object åšä¸ºæˆå‘˜ç±»å‹ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°é€šç”¨äº†ï¼Œå®é™…ä¸Šå°±æ˜¯ â€œObject æ³›å‹â€.

```java
public class ObjectDemo {
    private Object x;
    public ObjectDemo(Object x) {
        this.x = x;
    }
    public Object getX() {
        return x;
    }
    public void setX(Object x) {
        this.x = x;
    }
}
public class ObjectDemoDemo {
    public static void main(String args[]) {
        ObjectDemo strDemo = new ObjectDemo(new StringDemo("Hello Generics!"));
        ObjectDemo douDemo = new ObjectDemo(new DoubleDemo(new Double("33")));
        ObjectDemo objDemo = new ObjectDemo(new Object());
        System.out.println("strFoo.getX=" + (StringDemo) strDemo.getX());
        System.out.println("douFoo.getX=" + (DoubleDemo) douDemo.getX());
        System.out.println("objFoo.getX=" + objDemo.getX());
    }
}
```

```
è¿è¡Œç»“æœå¦‚ä¸‹ï¼š
strDemo.getX=StringDemo@5d748654
douDemo.getX=DoubleDemo@d1f24bb
objDemo.getX=java.lang.Object@19821f
```

åœ¨ Java 5 ä¹‹å‰ï¼Œä¸ºäº†è®©ç±»æœ‰é€šç”¨æ€§ï¼Œå¾€å¾€å°†å‚æ•°ç±»å‹ã€è¿”å›ç±»å‹è®¾ç½®ä¸º Object ç±»å‹ï¼Œå½“è·å–è¿™äº›è¿”å›ç±»å‹æ¥ä½¿ç”¨æ—¶å€™ï¼Œå¿…é¡»å°†å…¶ â€œå¼ºåˆ¶â€ è½¬æ¢ä¸ºåŸæœ‰çš„ç±»å‹æˆ–è€…æ¥å£ï¼Œç„¶åæ‰å¯ä»¥è°ƒç”¨å¯¹è±¡ä¸Šçš„æ–¹æ³•ã€‚

å¼ºåˆ¶ç±»å‹è½¬æ¢å¾ˆéº»çƒ¦ï¼Œæˆ‘è¿˜è¦äº‹å…ˆçŸ¥é“å„ä¸ª Object å…·ä½“ç±»å‹æ˜¯ä»€ä¹ˆï¼Œæ‰èƒ½åšå‡ºæ­£ç¡®è½¬æ¢ã€‚å¦åˆ™ï¼Œè¦æ˜¯è½¬æ¢çš„ç±»å‹ä¸å¯¹ï¼Œæ¯”å¦‚å°† â€œHello Generics!â€ å­—ç¬¦ä¸²å¼ºåˆ¶è½¬æ¢ä¸º Double, é‚£ä¹ˆç¼–è¯‘çš„æ—¶å€™ä¸ä¼šæŠ¥é”™ï¼Œå¯æ˜¯è¿è¡Œçš„æ—¶å€™å°±æŒ‚äº†ã€‚é‚£æœ‰æ²¡æœ‰ä¸å¼ºåˆ¶è½¬æ¢çš„åŠæ³• ---- æœ‰ï¼Œæ”¹ç”¨ Java5 æ³›å‹æ¥å®ç°ã€‚

```java
class GenericsTest<T> {
    private T x;
    public GenericsTest(T x) {
        this.x = x;
    }
    public T getX() {
        return x;
    }
    public void setX(T x) {
        this.x = x;
    }
}

public class GenericsTestDemo {
    public static void main(String args[]) {
        GenericsTest<String> strFoo = new GenericsTest<String>("Hello Generics!");
        GenericsTest<Double> douFoo = new GenericsTest<Double>(new Double("33"));
        GenericsTest<Object> objFoo = new GenericsTest<Object>(new Object());
        System.out.println("strTest.getX=" + strTest.getX());
        System.out.println("douTest.getX=" + douTest.getX());
        System.out.println("objTest.getX=" + objTest.getX());
    }
}
```

```
è¿è¡Œç»“æœï¼š
strTest.getX=Hello Generics!
douTest.getX=33.0
objTest.getX=java.lang.Object@19821f
```

å’Œä½¿ç”¨ â€œObject æ³›å‹â€ æ–¹å¼å®ç°ç»“æœçš„å®Œå…¨ä¸€æ ·ï¼Œä½†æ˜¯è¿™ä¸ª Demo ç®€å•å¤šäº†ï¼Œé‡Œé¢æ²¡æœ‰å¼ºåˆ¶ç±»å‹è½¬æ¢ä¿¡æ¯ã€‚  
ä¸‹é¢è§£é‡Šä¸€ä¸‹ä¸Šé¢æ³›å‹ç±»çš„è¯­æ³•ï¼š

ä½¿ç”¨ æ¥å£°æ˜ä¸€ä¸ªç±»å‹æŒæœ‰è€…åç§°ï¼Œç„¶åå°±å¯ä»¥æŠŠ T å½“ä½œä¸€ä¸ªç±»å‹ä»£è¡¨æ¥å£°æ˜æˆå‘˜ã€å‚æ•°å’Œè¿”å›å€¼ç±»å‹ã€‚  
å½“ç„¶ T ä»…ä»…æ˜¯ä¸ªåå­—ï¼Œè¿™ä¸ªåå­—å¯ä»¥è‡ªè¡Œå®šä¹‰ã€‚

class GenericsTest å£°æ˜äº†ä¸€ä¸ªæ³›å‹ç±»ï¼Œè¿™ä¸ª T æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œå®é™…ä¸Šç›¸å½“äº Object ç±»å‹ï¼Œå®é™…ä¸Šç›¸å½“äº class GenericsTestã€‚

ä¸ Object æ³›å‹ç±»ç›¸æ¯”ï¼Œä½¿ç”¨æ³›å‹æ‰€å®šä¹‰çš„ç±»åœ¨å£°æ˜å’Œæ„é€ å®ä¾‹çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ â€œ<å®é™…ç±»å‹>â€ æ¥ä¸€å¹¶æŒ‡å®šæ³›å‹ç±»å‹æŒæœ‰è€…çš„çœŸå®ç±»å‹ã€‚  
ç±»å¦‚  
`GenericsTest<Double> douTest=new GenericsTest<Double>(new Double("33"));`

å½“ç„¶ï¼Œä¹Ÿå¯ä»¥åœ¨æ„é€ å¯¹è±¡çš„æ—¶å€™ä¸ä½¿ç”¨å°–æ‹¬å·æŒ‡å®šæ³›å‹ç±»å‹çš„çœŸå®ç±»å‹ï¼Œä½†æ˜¯ä½ åœ¨ä½¿ç”¨è¯¥å¯¹è±¡çš„æ—¶å€™ï¼Œå°±éœ€è¦å¼ºåˆ¶è½¬æ¢äº†ã€‚  
æ¯”å¦‚ï¼š`GenericsTest douTest=new GenericsTest(new Double("33"));`

å®é™…ä¸Šï¼Œå½“æ„é€ å¯¹è±¡æ—¶ä¸æŒ‡å®šç±»å‹ä¿¡æ¯çš„æ—¶å€™ï¼Œé»˜è®¤ä¼šä½¿ç”¨ Object ç±»å‹ï¼Œè¿™ä¹Ÿæ˜¯è¦å¼ºåˆ¶è½¬æ¢çš„åŸå› .

## é«˜çº§ç”¨æ³•

**é™åˆ¶æ³›å‹**

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œç”±äºæ²¡æœ‰é™åˆ¶ class GenericsTest ç±»å‹æŒæœ‰è€… T çš„èŒƒå›´ï¼Œå®é™…ä¸Šè¿™é‡Œçš„é™å®šç±»å‹ç›¸å½“äº Objectï¼Œè¿™å’Œ â€œObject æ³›å‹â€ å®è´¨æ˜¯ä¸€æ ·çš„ã€‚

æ¯”å¦‚æˆ‘ä»¬è¦é™åˆ¶ T ä¸ºé›†åˆæ¥å£ç±»å‹ã€‚åªéœ€è¦è¿™ä¹ˆåšï¼š  
`class GenericsTest<T extends Collection>`

è¿™æ ·ç±»ä¸­çš„æ³›å‹ T åªèƒ½æ˜¯ Collection æ¥å£çš„å®ç°ç±»ï¼Œä¼ å…¥é Collection æ¥å£ç¼–è¯‘ä¼šå‡ºé”™ã€‚

æ³¨æ„ï¼š è¿™é‡Œçš„é™å®šä½¿ç”¨å…³é”®å­— extendsï¼Œåé¢å¯ä»¥æ˜¯ç±»ä¹Ÿå¯ä»¥æ˜¯æ¥å£ã€‚

ä½†è¿™é‡Œçš„ extends å·²ç»ä¸æ˜¯ç»§æ‰¿çš„å«ä¹‰äº†ï¼Œ  
**åº”è¯¥ç†è§£ä¸º T ç±»å‹æ˜¯å®ç° Collection æ¥å£çš„ç±»å‹**ï¼Œæˆ–è€… **T æ˜¯ç»§æ‰¿äº† XX ç±»çš„ç±»å‹**ã€‚

ä¸‹é¢ç»§ç»­å¯¹ä¸Šé¢çš„ä¾‹å­æ”¹è¿›ï¼Œæˆ‘åªè¦å®ç°äº†é›†åˆæ¥å£çš„ç±»å‹ï¼š

```java
public class CollectionGenTest<T extends Collection> {
    private T x;
    public CollectionGenTest(T x) {
        this.x = x;
    }
    public T getX() {
        return x;
    }
    public void setX(T x) {
        this.x = x;
    }
}
```

å®ä¾‹åŒ–çš„æ—¶å€™å¯ä»¥è¿™ä¹ˆå†™

```java
public class CollectionGenTestDemo {
    public static void main(String args[]) {
        CollectionGenTest<ArrayList> listTest = new CollectionGenTest<ArrayList>(new ArrayList(10));
        System.out.println(listTest.getX().size());
    }
}
```

**å¤šæ¥å£é™åˆ¶**

è™½ç„¶ Java æ³›å‹ç®€å•çš„ç”¨ extends ç»Ÿä¸€çš„è¡¨ç¤ºäº†åŸæœ‰çš„ extends å’Œ implements çš„æ¦‚å¿µï¼Œä½†ä»è¦éµå¾ªåº”ç”¨çš„ä½“ç³»ï¼ŒJava åªèƒ½ç»§æ‰¿ä¸€ä¸ªç±»ï¼Œä½†å¯ä»¥å®ç°å¤šä¸ªæ¥å£ï¼Œæ‰€ä»¥ä½ çš„æŸä¸ªç±»å‹éœ€è¦ç”¨ extends é™å®šï¼Œä¸”æœ‰å¤šç§ç±»å‹çš„æ—¶å€™ï¼Œåªèƒ½å­˜åœ¨ä¸€ä¸ªæ˜¯ç±»ï¼Œå¹¶ä¸”ç±»å†™åœ¨ç¬¬ä¸€ä½ï¼Œæ¥å£åˆ—åœ¨åé¢ï¼Œä¹Ÿå°±æ˜¯ï¼š

```
<T extends SomeClass & interface1 & interface2 & interface3>
```

è¿™é‡Œçš„ä¾‹å­ä»…æ¼”ç¤ºäº†æ³›å‹æ–¹æ³•çš„ç±»å‹é™å®šï¼Œå¯¹äºæ³›å‹ç±»ä¸­ç±»å‹å‚æ•°çš„é™åˆ¶ç”¨å®Œå…¨ä¸€æ ·çš„è§„åˆ™ï¼Œåªæ˜¯åŠ åœ¨ç±»å£°æ˜çš„å¤´éƒ¨ï¼Œå¦‚ï¼š

```java
public class Demo<T extends Comparable & Serializable> {
    // Tç±»å‹å°±å¯ä»¥ç”¨Comparableå£°æ˜çš„æ–¹æ³•å’ŒSeriablizableæ‰€æ‹¥æœ‰çš„ç‰¹æ€§äº†
}
```

**é€šé…ç¬¦æ³›å‹**

ä¸ºäº†è§£å†³ç±»å‹è¢«é™åˆ¶æ­»äº†ä¸èƒ½åŠ¨æ€æ ¹æ®å®ä¾‹æ¥ç¡®å®šçš„ç¼ºç‚¹ï¼Œå¼•å…¥äº† â€œé€šé…ç¬¦æ³›å‹â€ï¼Œé’ˆå¯¹ä¸Šé¢çš„ä¾‹å­ï¼Œä½¿ç”¨é€šé…æ³›å‹æ ¼å¼ä¸º <? extends Collection>

"?" ä»£è¡¨æœªçŸ¥ç±»å‹ï¼Œè¿™ä¸ªç±»å‹æ˜¯å®ç° Collection æ¥å£ã€‚é‚£ä¹ˆä¸Šé¢å®ç°çš„æ–¹å¼å¯ä»¥å†™ä¸ºï¼š

```java
public class CollectionGenTestDemo {
    public static void main(String args[]) {
        CollectionGenTest<?> listTest= new CollectionGenTest<ArrayList>(new ArrayList());
        System.out.println("å®ä¾‹åŒ–æˆåŠŸ!");
    }
}
```

1. å¦‚æœåªæŒ‡å®šäº† <?>ï¼Œè€Œæ²¡æœ‰ extendsï¼Œåˆ™é»˜è®¤æ˜¯å…è®¸ Object åŠå…¶ä¸‹çš„ä»»ä½• Java ç±»äº†ã€‚ä¹Ÿå°±æ˜¯ä»»æ„ç±»ã€‚
2. é€šé…ç¬¦æ³›å‹ä¸å•å¯ä»¥å‘ä¸Šé™åˆ¶ï¼Œå¦‚ <? extends Collection>ï¼Œè¿˜å¯ä»¥å‘ä¸‹é™åˆ¶ï¼Œå¦‚ <? super Double>ï¼Œè¡¨ç¤ºç±»å‹åªèƒ½æ¥å— Double åŠå…¶ä¸Šå±‚çˆ¶ç±»ç±»å‹ï¼Œå¦‚ Numberã€Object ç±»å‹çš„å®ä¾‹ã€‚
3. æ³›å‹ç±»å®šä¹‰å¯ä»¥æœ‰å¤šä¸ªæ³›å‹å‚æ•°ï¼Œä¸­é—´ç”¨é€—å·éš”å¼€ï¼Œè¿˜å¯ä»¥å®šä¹‰æ³›å‹æ¥å£ï¼Œæ³›å‹æ–¹æ³•ã€‚è¿™äº›éƒ½ä¸æ³›å‹ç±»ä¸­æ³›å‹çš„ä½¿ç”¨è§„åˆ™ç±»ä¼¼ã€‚

### æ³›å‹æ–¹æ³•

æ˜¯å¦æ‹¥æœ‰æ³›å‹æ–¹æ³•ï¼Œä¸å…¶æ‰€åœ¨çš„ç±»æ˜¯å¦æ³›å‹æ²¡æœ‰å…³ç³»ã€‚è¦å®šä¹‰æ³›å‹æ–¹æ³•ï¼Œåªéœ€å°†æ³›å‹å‚æ•°åˆ—è¡¨ç½®äºè¿”å›å€¼å‰ã€‚å¦‚:

```java
public class ExampleA {
    private <T> void f(T x) {
        System.out.println(x.getClass().getName());
    }

    public static void main(String[] args) {
        ExampleA ea = new ExampleA();
        ea.f(" ");
        ea.f(10);
        ea.f('a');
        ea.f(ea);
    }
}
```

ä½¿ç”¨æ³›å‹æ–¹æ³•æ—¶ï¼Œä¸å¿…æŒ‡æ˜å‚æ•°ç±»å‹ï¼Œç¼–è¯‘å™¨ä¼šè‡ªå·±æ‰¾å‡ºå…·ä½“çš„ç±»å‹ã€‚æ³›å‹æ–¹æ³•é™¤äº†å®šä¹‰ä¸åŒï¼Œè°ƒç”¨å°±åƒæ™®é€šæ–¹æ³•ä¸€æ ·ã€‚

éœ€è¦æ³¨æ„ï¼Œä¸€ä¸ª static æ–¹æ³•ï¼Œæ— æ³•è®¿é—®æ³›å‹ç±»çš„ç±»å‹å‚æ•°ï¼Œæ‰€ä»¥ï¼Œè‹¥è¦ static æ–¹æ³•éœ€è¦ä½¿ç”¨æ³›å‹èƒ½åŠ›ï¼Œå¿…é¡»ä½¿å…¶æˆä¸ºæ³›å‹æ–¹æ³•ã€‚  
æ¯”å¦‚ï¼š

```java
public class Demo{
    public static <T> T test(T a){
        return a;
    }
}
```

**List<?> å’Œ List çš„åŒºåˆ«**

ç±»å‹å‚æ•° "" å’Œæ— ç•Œé€šé…ç¬¦ "<?>"

**å£°æ˜ä¸€ä¸ªæ³›å‹ç±»æˆ–æ³›å‹æ–¹æ³•ã€‚**  
**<?> ä½¿ç”¨æ³›å‹ç±»æˆ–æ³›å‹æ–¹æ³•ã€‚**

<https://www.zhihu.com/question/31429113>

**Java æ³›å‹ <? super T> ä¸­ super æ€ä¹ˆ ç†è§£ï¼Ÿä¸ extends æœ‰ä½•ä¸åŒ**

<https://www.zhihu.com/question/20400700/answer/117464182>

## [GitåŸºç¡€å…¥é—¨ï¼šä»å®‰è£…åˆ°é«˜çº§å®æˆ˜æŒ‡å—](https://blog.dong4j.site/posts/8d8f656a.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

Git æ˜¯ä¸€ç§åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿï¼Œå®ƒå¹¿æ³›ç”¨äºè½¯ä»¶å¼€å‘å’Œé¡¹ç›®ç®¡ç†é¢†åŸŸï¼Œæä¾›äº†ä¸€ä¸ªç®€å•é«˜æ•ˆçš„å·¥å…·æ¥è·Ÿè¸ªæ–‡ä»¶çš„ä¿®æ”¹è®°å½•ï¼Œå¹¶å…è®¸å¤šä¸ªå¼€å‘è€…åä½œã€‚æœ¬æ–‡æ¡£å°†ä»åŸºç¡€çŸ¥è¯†å¼€å§‹ä»‹ç»ï¼Œé€æ­¥æ·±å…¥åˆ°é«˜çº§ç”¨æ³•ã€‚

## 1. å®‰è£… Git

### Linux:

åœ¨å¤§å¤šæ•° Linux å‘è¡Œç‰ˆä¸­å¯ä»¥ç›´æ¥é€šè¿‡åŒ…ç®¡ç†å™¨å®‰è£… Gitã€‚

```bash
sudo apt-get update && sudo apt-get install git #å¯¹äºDebian/Ubuntuç”¨æˆ·
```

æˆ–è€…

```bash
sudo yum install git #å¯¹äºCentOS/RHELç”¨æˆ·
```

### Windows å’Œ macOSï¼š

å»ºè®®ä»å®˜ç½‘ä¸‹è½½ Git æœ€æ–°ç‰ˆæœ¬çš„å®‰è£…ç¨‹åºè¿›è¡Œå®‰è£…ï¼šhttps://git-scm.com/downloads

## 2. é…ç½® Git

åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨å‰ï¼Œéœ€è¦é…ç½®ä½ çš„ç”¨æˆ·åå’Œé‚®ç®±ã€‚è¿™æ˜¯é‡è¦çš„è¯†åˆ«ä¿¡æ¯ã€‚

```bash
git config --global user.name "Your Name"
git config --global user.email you@example.com
```

å¯ä»¥æŸ¥çœ‹å·²æœ‰çš„é…ç½®ï¼š

```bash
git config --list
```

## 3. åˆå§‹åŒ– Git ä»“åº“

åœ¨å½“å‰ç›®å½•ä¸‹åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ä»“åº“æˆ–æ£€æŸ¥ä¸€ä¸ªç°å­˜çš„ä»“åº“æ˜¯å¦å­˜åœ¨ã€‚

```bash
# åœ¨æ–°ç›®å½•ä¸­åˆ›å»ºæ–°çš„ Git ä»“åº“
mkdir new_repo && cd $_
git init

# æ£€æŸ¥ç°æœ‰ç›®å½•æ˜¯å¦ä¸º Git ä»“åº“
git rev-parse --is-inside-work-tree
```

## 4. åŸºæœ¬æ“ä½œ

### æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº

```bash
git add <file>
# æˆ–è€…å°†æ•´ä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶æ·»åŠ è¿›æ¥
git add .
```

### æäº¤æ›´æ”¹

æäº¤å·²æ·»åŠ åˆ°æš‚å­˜åŒºçš„å˜æ›´ã€‚

```bash
git commit -m "Initial commit"
```

## 5. æŸ¥çœ‹çŠ¶æ€å’Œå†å²è®°å½•

æ£€æŸ¥ä»“åº“çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬æœªè·Ÿè¸ªã€ä¿®æ”¹ç­‰ä¿¡æ¯ã€‚

```bash
git status
```

æŸ¥çœ‹æäº¤æ—¥å¿—ä»¥äº†è§£é¡¹ç›®çš„å†å²ã€‚

```bash
git log
# æˆ–è€…æ›´è¯¦ç»†çš„è¾“å‡º
git log --oneline --graph --decorate --all
```

## 6. åˆ†æ”¯ç®¡ç†

### åˆ›å»ºæ–°åˆ†æ”¯å¹¶åˆ‡æ¢è‡³è¯¥åˆ†æ”¯

```bash
git branch featureA # åˆ›å»ºæ–°çš„åˆ†æ”¯ featureA
git checkout featureA # åˆ‡æ¢åˆ° featureA
# æˆ–è€…ç»“åˆå‘½ä»¤ä¸€èµ·ä½¿ç”¨ï¼š
git checkout -b featureB
```

### åˆå¹¶åˆ†æ”¯

å°†ä¸€ä¸ªåˆ†æ”¯åˆå¹¶åˆ°å½“å‰å·¥ä½œåŒºã€‚

```bash
git merge featureA
```

## 7. è¿œç¨‹ä»“åº“æ“ä½œ

### å…‹éš†è¿œç¨‹ä»“åº“

å…‹éš†ä¸€ä¸ªé¡¹ç›®è‡³æœ¬åœ°ã€‚

```bash
git clone <remote-repo-url>
# æŒ‡å®šä¸€ä¸ªä¸åŒçš„ç›®å½•åï¼š
git clone <remote-repo-url> my_project_name
```

### æ¨é€ä»£ç åˆ°è¿œç¨‹åˆ†æ”¯

å°†æœ¬åœ°æ›´æ”¹æ¨é€åˆ°è¿œç¨‹ä¸»åˆ†æ”¯ï¼ˆmain/masterï¼‰æˆ–ä»»ä½•å…¶ä»–åˆ†æ”¯ã€‚

```bash
git push origin main # æ¨é€åˆ°åä¸º "main" çš„è¿œç¨‹åˆ†æ”¯
# å¦‚æœéœ€è¦æ¨é€ä¸€ä¸ªæ–°åˆ›å»ºçš„åˆ†æ”¯ï¼š
git push -u origin featureA
```

### æ‹‰å–æ›´æ–°

ä»è¿œç¨‹ä»“åº“æ‹‰å–æœ€æ–°çš„ä»£ç åˆ°æœ¬åœ°ã€‚

```bash
git pull origin main
```

## 8. è§£å†³å†²çª

å½“åˆå¹¶æˆ–æ‹‰å–æ—¶é‡åˆ°æ–‡ä»¶å†²çªï¼Œéœ€æ‰‹åŠ¨è§£å†³ã€‚ç¼–è¾‘ç›¸å…³æ–‡ä»¶åæ·»åŠ å¹¶æäº¤å˜æ›´ã€‚

```bash
# æ·»åŠ è§£å†³çš„æ–‡ä»¶
git add .
# æäº¤æ›´æ”¹
git commit -m "Resolved conflicts in file"
```

è¯¦ç»†æŸ¥çœ‹å†²çªå†…å®¹å¯ç›´æ¥æ‰“å¼€æ–‡ä»¶æŸ¥çœ‹æ ‡è®°ï¼Œæˆ–ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·å¦‚ï¼š

```bash
git diff --name-status
```

## 9. å…¶ä»–æœ‰ç”¨çš„å‘½ä»¤å’ŒåŠŸèƒ½

- æŸ¥çœ‹è¿œç¨‹ä»“åº“è¯¦æƒ…ï¼š`git remote -v`
- åˆ é™¤æœ¬åœ°åˆ†æ”¯ï¼ˆä¸ä¼šä»è¿œç¨‹åˆ é™¤ï¼‰ï¼š`git branch -d featureB`
- æ’¤é”€å¯¹æš‚å­˜åŒºçš„ä¿®æ”¹ï¼š`git reset HEAD <file>`
- æ¢å¤å·¥ä½œç›®å½•ä¸­çš„æ–‡ä»¶åˆ°ä¸Šæ¬¡æäº¤çš„çŠ¶æ€ï¼š`git checkout -- <file>`

## 10. ä½¿ç”¨ Git çš„æœ€ä½³å®è·µ

### åˆ†æ”¯ç­–ç•¥

é‡‡ç”¨æ˜ç¡®çš„å·¥ä½œæµï¼Œå¦‚ GitFlow æˆ– GitHub Flowã€‚

- **GitFlow**: ä¸»åˆ†æ”¯ç»´æŠ¤ç¨³å®šç‰ˆæœ¬ï¼Œå¼€å‘åœ¨å…¶ä»–ç‹¬ç«‹çš„åˆ†æ”¯ä¸­è¿›è¡Œï¼›åŠŸèƒ½å®Œæˆåå†åˆå¹¶è‡³å¼€å‘ä¸»åˆ†æ”¯ï¼ˆdevelopï¼‰ã€‚
- **GitHub Flow**: æ‰€æœ‰å·¥ä½œéƒ½åœ¨éä¸»åˆ†æ”¯ä¸Šå®Œæˆï¼Œå¹¶é€šè¿‡æ‹‰å–è¯·æ±‚ï¼ˆpull requestï¼‰çš„æ–¹å¼æå‡ºåˆå¹¶åˆ°ä¸»åˆ†æ”¯ã€‚

### è‰¯å¥½çš„æäº¤ä¿¡æ¯

ç¡®ä¿æ¯æ¬¡æäº¤éƒ½åŒ…å«æœ‰æ„ä¹‰çš„ä¿¡æ¯ï¼Œä»¥ä¾¿äºä»–äººç†è§£å…¶ç›®çš„å’Œå†…å®¹ã€‚éµå¾ªæ ‡å‡†æ ¼å¼ï¼š

```
fix: ä¿®æ”¹é”™è¯¯
feat: æ·»åŠ æ–°ç‰¹æ€§
docs: æ›´æ–°æ–‡æ¡£
```

## [Nginxå…¥é—¨å¿…å¤‡ï¼šé«˜æ•ˆWebæœåŠ¡å™¨çš„æ¢ç´¢ä¹‹æ—…](https://blog.dong4j.site/posts/d73767c3.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

Nginxï¼ˆå‘éŸ³ä¸º â€œEngine-Xâ€ï¼‰æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ HTTP å’Œåå‘ä»£ç†æœåŠ¡å™¨ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ª IMAP/POP3 ä»£ç†æœåŠ¡å™¨ã€‚ç”±ä¿„ç½—æ–¯å·¥ç¨‹å¸ˆ Igor Sysoev å¼€å‘ï¼Œæœ€æ—©å‘å¸ƒäº 2004 å¹´ã€‚Nginx çš„è½»é‡å’Œé«˜å¹¶å‘å¤„ç†èƒ½åŠ›è®©å®ƒåœ¨é«˜æµé‡ç½‘ç«™ä¸­è¿…é€Ÿæµè¡Œï¼Œç›®å‰è¢«å¹¿æ³›ç”¨äºå„ç±»æœåŠ¡å™¨ç¯å¢ƒä¸­ã€‚

## ä¸ºä»€ä¹ˆé€‰æ‹© Nginxï¼Ÿ

Nginx å…·æœ‰ä»¥ä¸‹ä¸»è¦ä¼˜åŠ¿ï¼š

1. **é«˜å¹¶å‘æ€§èƒ½**ï¼šNginx é‡‡ç”¨äº‹ä»¶é©±åŠ¨ï¼ˆå¼‚æ­¥ï¼‰çš„éé˜»å¡æ¶æ„ï¼Œèƒ½å¤Ÿé«˜æ•ˆå¤„ç†æˆåƒä¸Šä¸‡çš„å¹¶å‘è¿æ¥ï¼Œç‰¹åˆ«é€‚åˆé«˜æµé‡åº”ç”¨ã€‚
2. **èµ„æºæ•ˆç‡**ï¼šä¸å…¶ä»–æœåŠ¡å™¨ï¼ˆå¦‚ Apacheï¼‰ç›¸æ¯”ï¼ŒNginx å ç”¨çš„å†…å­˜å’Œ CPU èµ„æºæ›´å°‘ï¼Œæä¾›æ›´å¥½çš„èµ„æºåˆ©ç”¨ç‡ã€‚
3. **åŠŸèƒ½ä¸°å¯Œ**ï¼šNginx æ”¯æŒé™æ€æ–‡ä»¶æœåŠ¡ã€åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ã€ç¼“å­˜ã€SSL/TLS åŠ å¯†ç­‰åŠŸèƒ½ï¼Œé€‚ç”¨å¤šç§åœºæ™¯ã€‚
4. **é«˜åº¦å¯æ‰©å±•**ï¼šNginx æ”¯æŒæ¨¡å—åŒ–é…ç½®ï¼Œå¯é€šè¿‡æ¨¡å—æ‰©å±•åŠŸèƒ½ã€‚å…¶é…ç½®æ–‡ä»¶ç®€å•æ˜äº†ï¼Œä¾¿äºç®¡ç†å’Œæ‰©å±•ã€‚

## Nginx çš„åº”ç”¨åœºæ™¯

Nginx å…·å¤‡å¤šç§åº”ç”¨åœºæ™¯ï¼Œå¸¸è§çš„åŒ…æ‹¬ï¼š

1. **é™æ€æ–‡ä»¶æœåŠ¡å™¨**ï¼šé€‚åˆé™æ€å†…å®¹ï¼ˆå¦‚ HTMLã€CSSã€JavaScriptã€å›¾ç‰‡å’Œè§†é¢‘ï¼‰çš„é«˜æ•ˆåˆ†å‘ã€‚
2. **åå‘ä»£ç†æœåŠ¡å™¨**ï¼šä½œä¸ºä»£ç†æœåŠ¡å™¨ï¼ŒNginx æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚å¹¶è½¬å‘åˆ°åç«¯æœåŠ¡å™¨ï¼ˆå¦‚åº”ç”¨æœåŠ¡å™¨ã€æ•°æ®åº“æœåŠ¡å™¨ï¼‰ã€‚
3. **è´Ÿè½½å‡è¡¡**ï¼šåœ¨å¤šä¸ªåç«¯æœåŠ¡å™¨ä¹‹é—´åˆ†é…æµé‡ï¼Œä»¥å®ç°å‡åŒ€è´Ÿè½½ï¼Œæå‡æ€§èƒ½å’Œå¯é æ€§ã€‚
4. **ç¼“å­˜æœåŠ¡å™¨**ï¼šNginx å¯ä»¥ç¼“å­˜é™æ€å’ŒåŠ¨æ€å†…å®¹ï¼Œæé«˜é¡µé¢åŠ è½½é€Ÿåº¦ï¼Œå‡è½»åç«¯æœåŠ¡å™¨è´Ÿè½½ã€‚
5. **Web åº”ç”¨åŠ é€Ÿ**ï¼šé€šè¿‡ SSL/TLS åŠ é€Ÿã€å‹ç¼©ã€ç¼“å­˜ç­‰åŠŸèƒ½æå‡ç½‘ç«™æ€§èƒ½ã€‚
6. **é‚®ä»¶ä»£ç†æœåŠ¡å™¨**ï¼šæ”¯æŒ IMAPã€POP3 å’Œ SMTP åè®®çš„ä»£ç†ã€‚

## Nginx çš„å®‰è£…

åœ¨å¤§å¤šæ•°ç³»ç»Ÿä¸Šï¼ŒNginx éƒ½å¯ä»¥é€šè¿‡åŒ…ç®¡ç†å™¨ç›´æ¥å®‰è£…ã€‚

- **Ubuntu/Debian**:

  ```bash
  sudo apt update
  sudo apt install nginx
  ```

- **CentOS/RHEL**:

  ```bash
  sudo yum install nginx
  ```

- **macOS**ï¼ˆä½¿ç”¨ Homebrewï¼‰:

  ```bash
  brew install nginx
  ```

å®‰è£…å®Œæˆåï¼Œå¯ä»¥å¯åŠ¨ Nginx æœåŠ¡ï¼š

```bash
sudo systemctl start nginx  # Ubuntu/CentOS ç­‰ç°ä»£å‘è¡Œç‰ˆ
```

éªŒè¯ Nginx æ˜¯å¦è¿è¡Œï¼š

```
curl -I http://localhost
```

å¦‚æœ Nginx è¿è¡Œæ­£å¸¸ï¼Œç»ˆç«¯ä¼šæ˜¾ç¤ºçŠ¶æ€ä»£ç  200 OKã€‚

## Nginx çš„æ ¸å¿ƒé…ç½®

Nginx çš„ä¸»è¦é…ç½®æ–‡ä»¶é€šå¸¸ä½äº /etc/nginx/nginx.confï¼ˆåœ¨ä¸åŒæ“ä½œç³»ç»Ÿå¯èƒ½æœ‰æ‰€ä¸åŒï¼‰ï¼Œæ ¸å¿ƒé…ç½®ç”±è‹¥å¹²â€œå—â€ç»„æˆï¼ŒåŒ…æ‹¬ eventsã€httpã€serverã€location ç­‰ã€‚

é…ç½®æ–‡ä»¶ç»“æ„

```
# å…¨å±€é…ç½®
user www-data;
worker_processes auto;

# äº‹ä»¶é…ç½®
events {
    worker_connections 1024;
}

# HTTP é…ç½®
http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    # æœåŠ¡å™¨é…ç½®
    server {
        listen       80;
        server_name  example.com;

        # è·¯å¾„åŒ¹é…
        location / {
            root   /var/www/html;
            index  index.html index.htm;
        }

        # åå‘ä»£ç†
        location /api/ {
            proxy_pass http://backend_server;
        }
    }
}
```

â€¢ å…¨å±€é…ç½®ï¼šè®¾ç½®ç”¨æˆ·æƒé™ã€å·¥ä½œè¿›ç¨‹æ•°ç­‰ã€‚
â€¢ äº‹ä»¶å—ï¼šè®¾ç½®å·¥ä½œè¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°ç­‰ã€‚
â€¢ HTTP å—ï¼šåŒ…å«é™æ€æ–‡ä»¶å¤„ç†ã€ç¼“å­˜ã€å‹ç¼©ç­‰ã€‚
â€¢ Server å—ï¼šè®¾ç½®æœåŠ¡å™¨çš„åŸŸåã€ç«¯å£ç­‰ã€‚
â€¢ Location å—ï¼šå®šä¹‰ä¸åŒ URL è·¯å¾„çš„å¤„ç†æ–¹å¼ã€‚

## å¸¸ç”¨çš„ Nginx åŠŸèƒ½é…ç½®

### 1. é™æ€æ–‡ä»¶æœåŠ¡

Nginx å¯ç›´æ¥ä½œä¸ºé™æ€æ–‡ä»¶æœåŠ¡å™¨ï¼Œé€šè¿‡ location æŒ‡å®šç›®å½•æ¥æä¾›æ–‡ä»¶æœåŠ¡ï¼š

```
server {
    listen 80;
    server_name example.com;

    location / {
        root /var/www/html;
        index index.html index.htm;
    }
}
```

### 2. åå‘ä»£ç†

åå‘ä»£ç†æ˜¯ Nginx çš„é‡è¦åŠŸèƒ½ï¼Œå¸¸ç”¨äºå°†è¯·æ±‚è½¬å‘åˆ°åç«¯æœåŠ¡å™¨ï¼š

```
location /api/ {
    proxy_pass http://backend_server;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}
```

åœ¨ä¸Šè¿°é…ç½®ä¸­ï¼Œ/api/ è·¯å¾„ä¸‹çš„è¯·æ±‚ä¼šè¢«è½¬å‘åˆ° http://backend_serverã€‚

### 3. è´Ÿè½½å‡è¡¡

Nginx æ”¯æŒå¤šç§è´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆå¦‚è½®è¯¢ã€IP å“ˆå¸Œï¼‰ï¼Œç”¨äºåˆ†å‘è¯·æ±‚åˆ°å¤šä¸ªåç«¯æœåŠ¡å™¨ï¼š

```
http {
    upstream backend_servers {
        server backend1.example.com;
        server backend2.example.com;
    }

    server {
        listen 80;
        location / {
            proxy_pass http://backend_servers;
        }
    }
}
```

### 4. ç¼“å­˜è®¾ç½®

ç¼“å­˜å¯ä»¥å¤§å¹…æå‡æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜æµé‡ç½‘ç«™ä¸Šã€‚Nginx å¯ä»¥ç¼“å­˜åå‘ä»£ç†çš„å†…å®¹ï¼š

```
proxy_cache_path /data/nginx/cache levels=1:2 keys_zone=my_cache:10m max_size=10g;
server {
    location / {
        proxy_cache my_cache;
        proxy_pass http://backend_server;
        proxy_cache_valid 200 1h;
    }
}
```

### 5. SSL/TLS é…ç½®

Nginx æä¾›å¼ºå¤§çš„ SSL/TLS æ”¯æŒï¼Œç”¨äºåŠ å¯†ç½‘ç«™æµé‡ï¼š

```
server {
    listen 443 ssl;
    server_name example.com;

    ssl_certificate /etc/nginx/ssl/example.com.crt;
    ssl_certificate_key /etc/nginx/ssl/example.com.key;

    location / {
        root /var/www/html;
    }
}
```

## Nginx æ€§èƒ½ä¼˜åŒ–

1. è°ƒæ•´å·¥ä½œè¿›ç¨‹æ•°ï¼šworker_processes åº”è®¾ç½®ä¸º CPU çš„æ ¸å¿ƒæ•°ï¼Œä»¥æœ€å¤§åŒ–æ€§èƒ½ã€‚
2. ä¼˜åŒ–è¿æ¥æ•°ï¼šworker_connections æ§åˆ¶æ¯ä¸ªè¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°ï¼Œé€šå¸¸è®¾ç½®ä¸º 1024 æˆ–æ›´é«˜ã€‚
3. å¯ç”¨ Gzip å‹ç¼©ï¼šå¯ä»¥é€šè¿‡ gzip on; å¯ç”¨å†…å®¹å‹ç¼©ï¼Œå‡å°‘å¸¦å®½å ç”¨ã€‚
4. ç¼“å­˜é™æ€æ–‡ä»¶ï¼šåˆ©ç”¨ expires æŒ‡ä»¤è®¾ç½®ç¼“å­˜æ—¶é—´ï¼Œä»¥å‡å°‘é‡å¤è¯·æ±‚ã€‚

## å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 1. Nginx å¯åŠ¨å¤±è´¥

æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨é”™è¯¯ï¼š

```
sudo nginx -t
```

### 2. 502 Bad Gateway é”™è¯¯

é€šå¸¸æ˜¯ç”±äºåç«¯æœåŠ¡å™¨ä¸å¯è¾¾æˆ–é…ç½®é”™è¯¯å¯¼è‡´ï¼Œæ£€æŸ¥ proxy_pass åœ°å€æ˜¯å¦æ­£ç¡®ï¼Œç¡®ä¿åç«¯æœåŠ¡è¿è¡Œæ­£å¸¸ã€‚

### 3. è®¿é—®è¿‡æ…¢

å¯ä»¥é€šè¿‡å¯ç”¨ç¼“å­˜ã€Gzip å‹ç¼©æˆ–å‡çº§ç¡¬ä»¶èµ„æºæ¥ä¼˜åŒ–æ€§èƒ½ã€‚

## Nginx ä¸ Apache çš„å¯¹æ¯”

## Nginx ä¸ Apache çš„å¯¹æ¯”

| ç‰¹æ€§               | Nginx                                       | Apache                                 |
| ------------------ | ------------------------------------------- | -------------------------------------- |
| **æ¶æ„**           | äº‹ä»¶é©±åŠ¨ã€å¼‚æ­¥                              | çº¿ç¨‹/è¿›ç¨‹é©±åŠ¨                          |
| **æ€§èƒ½**           | é«˜å¹¶å‘å¤„ç†ï¼Œæ€§èƒ½ä¼˜ç§€                        | é€‚åˆå°è§„æ¨¡å¹¶å‘ï¼Œæ€§èƒ½è¾ƒä½               |
| **é™æ€æ–‡ä»¶å¤„ç†**   | é«˜æ•ˆï¼Œé€‚åˆå¤§é‡å¹¶å‘è¯·æ±‚                      | ç›¸å¯¹è¾ƒæ…¢ï¼Œé€‚åˆå°‘é‡é™æ€æ–‡ä»¶è¯·æ±‚         |
| **åŠ¨æ€å†…å®¹å¤„ç†**   | é€šå¸¸é€šè¿‡ FastCGIã€ä»£ç†å®ç°                  | åŸç”Ÿæ”¯æŒï¼ˆå¦‚é€šè¿‡ `mod_php`ï¼‰           |
| **å†…å­˜å’Œèµ„æºå ç”¨** | å ç”¨å°‘ï¼Œèµ„æºåˆ©ç”¨æ•ˆç‡é«˜                      | å ç”¨ç›¸å¯¹è¾ƒå¤š                           |
| **é…ç½®æ–‡ä»¶**       | ç®€æ´ï¼Œæ¨¡å—åŒ–ï¼Œæ˜“äºç®¡ç†                      | é…ç½®è¾ƒä¸ºå¤æ‚ï¼Œéœ€è¦æ‰‹åŠ¨è°ƒæ•´             |
| **è´Ÿè½½å‡è¡¡**       | åŸç”Ÿæ”¯æŒå¤šç§è´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆè½®è¯¢ã€IP å“ˆå¸Œç­‰ï¼‰ | éœ€è¦é¢å¤–çš„æ¨¡å—æ”¯æŒï¼ˆå¦‚ `mod_proxy`ï¼‰   |
| **SSL/TLS æ”¯æŒ**   | å¼ºå¤§ä¸”é«˜æ•ˆ                                  | éœ€è¦é¢å¤–é…ç½®æˆ–æ¨¡å—æ”¯æŒï¼ˆå¦‚ `mod_ssl`ï¼‰ |
| **åå‘ä»£ç†**       | æ”¯æŒå¹¶è¡Œå¤„ç†ï¼Œæ€§èƒ½å‡ºè‰²                      | é€šè¿‡ `mod_proxy` å®ç°åå‘ä»£ç†åŠŸèƒ½      |
| **æ¨¡å—æ‰©å±•æ€§**     | é€šè¿‡ç¼–è¯‘æ—¶é€‰æ‹©æ¨¡å—ï¼ŒåŠ¨æ€åŠ è½½æœ‰é™            | æ”¯æŒå¤§é‡ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œçµæ´»é…ç½®           |
| **å¹³å°å…¼å®¹æ€§**     | æ”¯æŒç±» Unix å’Œ Windows ç³»ç»Ÿ                 | æ”¯æŒç±» Unix å’Œ Windows ç³»ç»Ÿ            |
| **ç¤¾åŒºä¸æ”¯æŒ**     | ç¤¾åŒºæ´»è·ƒï¼Œæ–‡æ¡£å®Œå–„                          | ç¤¾åŒºåºå¤§ï¼Œæ”¯æŒèŒƒå›´å¹¿                   |
| **ä½¿ç”¨åœºæ™¯**       | é«˜æµé‡ã€å¹¶å‘ã€è´Ÿè½½å‡è¡¡å’Œç¼“å­˜                | ä¼ ç»Ÿçš„ Web æœåŠ¡å™¨å’ŒåŠ¨æ€å†…å®¹å¤„ç†        |

## [SQL åŸºç¡€ï¼šå¸¸ç”¨çš„ SQæ“ä½œ](https://blog.dong4j.site/posts/ac8eb277.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## 1. SQL è¿æ¥æ“ä½œç®€ä»‹

åœ¨æ•°æ®åº“æŸ¥è¯¢ä¸­ï¼Œ`JOIN` æ“ä½œæ˜¯ä¸€ç§éå¸¸å¼ºå¤§çš„å·¥å…·ã€‚å®ƒå…è®¸æˆ‘ä»¬å°†æ¥è‡ªä¸åŒè¡¨çš„æ•°æ®ç»“åˆèµ·æ¥ã€‚ä¸‹é¢æ˜¯å‡ ç§å¸¸è§çš„ `JOIN` ç±»å‹åŠå…¶ç”¨é€”ï¼š

- **INNER JOIN**ï¼ˆå†…è¿æ¥ï¼‰ï¼šè¿”å›ä¸¤ä¸ªè¡¨ä¸­åŒ¹é…çš„è¡Œã€‚
- **LEFT JOIN**ï¼ˆå·¦è¿æ¥ï¼‰ï¼šè¿”å›å·¦è¡¨æ‰€æœ‰è®°å½•ï¼Œå³è¡¨æ— åŒ¹é…æ—¶è¿”å› NULLã€‚
- **RIGHT JOIN**ï¼ˆå³è¿æ¥ï¼‰ï¼šè¿”å›å³è¡¨æ‰€æœ‰è®°å½•ï¼Œå·¦è¡¨æ— åŒ¹é…æ—¶è¿”å› NULLã€‚

## 2. ä½¿ç”¨ CASE WHEN åœ¨ SQL ä¸­å¤„ç†æ¡ä»¶é€»è¾‘

åœ¨ SQL æŸ¥è¯¢ä¸­ï¼Œ`CASE WHEN` æ˜¯ä¸€ç§å¼ºå¤§çš„å·¥å…·ï¼Œå®ƒå…è®¸ä½ åœ¨æŸ¥è¯¢ç»“æœä¸­æ ¹æ®ç‰¹å®šæ¡ä»¶æ·»åŠ ä¸åŒçš„å€¼ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š

```sql
SELECT *,
       CASE
           WHEN (A - B) = 0 THEN 'T'
           WHEN (A - B) < 0 THEN 'WRONG'
           ELSE CASE WHEN (A IS NULL OR B IS NULL) THEN 'F' ELSE 'T' END
       END
FROM ä¸´æ—¶è¡¨;
```

æ­¤æŸ¥è¯¢è¿”å›äº†åŸå§‹åˆ—ä»¥åŠä¸€ä¸ªæ–°åˆ—ï¼Œè¯¥åˆ—åŸºäºæ¡ä»¶ `A - B` çš„å€¼ã€‚

## 3. åˆ é™¤å…·æœ‰é‡å¤ `shop_id` è®°å½•çš„è¡Œ

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½éœ€è¦åˆ é™¤å…·æœ‰é‡å¤ `shop_id` çš„è®°å½•ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨å­æŸ¥è¯¢æ¥æŸ¥æ‰¾å…·æœ‰å¤šä¸ªç›¸åŒ `shop_id` çš„è®°å½•å¹¶åˆ é™¤å®ƒä»¬çš„ç¤ºä¾‹ï¼š

```sql
DELETE FROM ec_shop_bg_image
WHERE shop_id NOT IN (
    SELECT MAX(shop_id)
    FROM ec_shop_bg_image
    GROUP BY shop_id
    HAVING COUNT(shop_id) > 1
);
```

è¿™æ®µä»£ç é€šè¿‡é¦–å…ˆæ‰¾åˆ°æ¯ä¸ª `shop_id` çš„æœ€å¤§å€¼ï¼Œç„¶åä»åŸè¡¨ä¸­åˆ é™¤é™¤äº†è¿™äº›æœ€å¤§å€¼ä¹‹å¤–çš„æ‰€æœ‰è®°å½•ã€‚

## 4. è®¾ç½®å’ŒæŸ¥çœ‹ SQL æ¨¡å¼

åœ¨ MySQL ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ `SET sql_mode` æ¥è®¾ç½®æ•°æ®åº“çš„è¿è¡Œæ¨¡å¼ã€‚ä¸€ä¸ªå¸¸ç”¨çš„æ¨¡å¼æ˜¯ `ONLY_FULL_GROUP_BY`ï¼Œå®ƒè¦æ±‚åœ¨ `GROUP BY` åé¢æ˜¾å¼åˆ—å‡ºæ‰€æœ‰é€‰å®šçš„åˆ—ã€‚ä¸‹é¢æ˜¯å¦‚ä½•æŸ¥çœ‹å’Œè®¾ç½®è¿™ä¸ªæ¨¡å¼çš„ç¤ºä¾‹ï¼š

```sql
-- æŸ¥çœ‹ SQL æ¨¡å¼
SELECT version(), @@sql_mode;

-- è®¾ç½® SQL æ¨¡å¼
SET sql_mode = 'STRICT_TRANS_TABLES';
```

## 5. åœ¨ XML ä¸­é¿å… `<=>` é”™è¯¯

å½“å¤„ç†åŒ…å« SQL è¯­å¥çš„ XML æ•°æ®æ—¶ï¼Œåº”ä½¿ç”¨ `<![CDATA[ ... ]]>` æ¥é¿å…ä¸ XML æ ‡ç­¾å†²çªçš„æƒ…å†µã€‚

```xml
<![CDATA[
SELECT * FROM user WHERE name = #{name};
]]>
```

## 6. æ¨¡ç³ŠæŸ¥è¯¢çš„ä½¿ç”¨

åœ¨ SQL ä¸­æ‰§è¡Œæ¨¡ç³ŠæŸ¥è¯¢æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ `LIKE` å’Œ `%` é€šé…ç¬¦æ¥æŸ¥æ‰¾åŒ¹é…ç‰¹å®šæ¨¡å¼çš„æ•°æ®ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š

```sql
LIKE CONCAT('%', #{name} ,'%');
```

è¿™ä¸ªè¡¨è¾¾å¼ä¼šæ‰¾åˆ°æ‰€æœ‰ä»¥æŒ‡å®šåç§°å¼€å¤´çš„è¡Œã€‚

## 7. ä½¿ç”¨ mycli å·¥å…·æŸ¥è¯¢æ•°æ®åº“

`mycli` æ˜¯ä¸€ä¸ªäº¤äº’å¼å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºè¿æ¥ MySQL æ•°æ®åº“å¹¶æ‰§è¡ŒæŸ¥è¯¢ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ `mycli` çš„ç¤ºä¾‹ï¼š

```bash
mycli -h localhost -u root æ•°æ®åº“å
```

ç„¶åï¼Œä½ å¯ä»¥è¾“å…¥ SQL æŸ¥è¯¢æ¥è·å–æ•°æ®ã€‚

## 8. MyBatis åŠ¨æ€ SQL ä¸­çš„ #{ } å’Œ ${ } åŒºåˆ«

åœ¨ä½¿ç”¨ MyBatis è¿›è¡ŒåŠ¨æ€ SQL ç¼–å†™æ—¶ï¼Œç†è§£ `#{ }` å’Œ `${ }` çš„åŒºåˆ«éå¸¸é‡è¦ã€‚ä»¥ä¸‹æ˜¯å®ƒä»¬çš„ä¸»è¦åŒºåˆ«ï¼š

- **`#{ }`**: è§£æä¸ºä¸€ä¸ª JDBC é¢„ç¼–è¯‘è¯­å¥ï¼ˆprepared statementï¼‰çš„å‚æ•°æ ‡è®°ç¬¦ã€‚å®ƒæä¾›äº†é¢„å¤„ç†å’Œå‚æ•°æ›¿æ¢çš„åŠŸèƒ½ï¼Œä»¥é˜²æ­¢ SQL æ³¨å…¥ã€‚

  ```sql
  select * from user where name = #{name};
  ```

  è§£æä¸ºï¼š

  ```sql
  select * from user where name = ?;
  ```

- **`${ }`**: ä»…ä»…ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²æ›¿æ¢ã€‚åœ¨åŠ¨æ€ SQL è§£æé˜¶æ®µå°†ä¼šè¿›è¡Œå˜é‡æ›¿æ¢ã€‚

  ```sql
  select * from user where name = ${name};
  ```

  è§£æä¸ºï¼š

  ```sql
  select * from user where name = 'ruhua';
  ```

## 9. ä½¿ç”¨ MyBatis åŠ¨æ€ SQL çš„æœ€ä½³å®è·µ

åœ¨ç¼–å†™ MyBatis åŠ¨æ€ SQL æ—¶ï¼Œéµå¾ªä»¥ä¸‹æœ€ä½³å®è·µï¼š

- **ä¼˜å…ˆä½¿ç”¨ `#{ }`**: å½“ä½ æ­£åœ¨å¤„ç†å‚æ•°æ—¶ã€‚
- **ä»…å½“éœ€è¦å­—ç¬¦ä¸²æ›¿æ¢æ—¶ä½¿ç”¨ `${ }`**: ä¾‹å¦‚è¡¨åæˆ–åˆ—åã€‚

- **é¿å…åœ¨è¡¨åä½œä¸ºå˜é‡æ—¶ä½¿ç”¨ `#{ }`**: å› ä¸ºè¿™ä¼šå¸¦ä¸Šå•å¼•å·ï¼Œå¯¼è‡´è¯­æ³•é”™è¯¯ã€‚

é€šè¿‡éµå¾ªè¿™äº›æœ€ä½³å®è·µï¼Œä½ å¯ä»¥åˆ›å»ºå®‰å…¨ã€é«˜æ•ˆä¸”æ˜“äºç»´æŠ¤çš„åŠ¨æ€ SQLã€‚

## MyBatisï¼šå•ä¸ªå‚æ•°å’Œå¤šä¸ªå‚æ•°çš„ä¾‹å­

åœ¨ MyBatis ä¸­ï¼Œä½ å¯ä»¥å®šä¹‰æ¥å£æ–¹æ³•æ¥æ‰§è¡Œæ•°æ®åº“æ“ä½œï¼Œå¹¶é€šè¿‡ XML æ˜ å°„æ–‡ä»¶å°†è¿™äº›æ–¹æ³•æ˜ å°„åˆ°å®é™…çš„ SQL è¯­å¥ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•å¤„ç†å•ä¸ªå’Œå¤šä¸ªå‚æ•°çš„ä¾‹å­ã€‚

### å•ä¸ªå‚æ•°

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ¥å£æ–¹æ³• `getAgeById`ï¼Œå®ƒæ ¹æ®ç”¨æˆ· ID æŸ¥è¯¢ç”¨æˆ·çš„å¹´é¾„ï¼š

```java
// æ¥å£æ–¹æ³•
int getAgeById(Integer id);
```

å¯¹åº”çš„ XML æ˜ å°„æ–‡ä»¶ä¸­çš„ SQL è¯­å¥å¦‚ä¸‹ï¼š

```xml
<select id="getAgeById" resultType="Integer">
    select age from user where user_id = #{id}
</select>
```

### å¤šä¸ªå‚æ•°

å½“éœ€è¦ä¼ é€’å¤šä¸ªå‚æ•°æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ `@Param` æ³¨è§£æ¥æŒ‡å®šæ¯ä¸ªå‚æ•°çš„åç§°ã€‚ä¾‹å¦‚ï¼Œ`login` æ–¹æ³•ï¼š

```java
// æ¥å£æ–¹æ³•
User login(@Param("username") String username, @Param("password") String password);
```

å¯¹åº”çš„ XML æ˜ å°„æ–‡ä»¶ï¼š

```xml
<select id="login" resultMap="BaseResultMap">
    select *
    from user
    where username = #{username} and password = #{password}
</select>
```

## MyBatis åŠ¨æ€ SQL å¤„ç†æ•°ç»„å‚æ•°å’Œ List å‚æ•°

åœ¨å¤„ç†æ•°ç»„æˆ– List ç±»å‹çš„å‚æ•°æ—¶ï¼ŒMyBatis æä¾›äº† `foreach` å…ƒç´ æ¥æ„å»º SQL æŸ¥è¯¢ã€‚ä¸‹é¢æ˜¯å¦‚ä½•ä½¿ç”¨ `foreach` æ¥å¤„ç†è¿™ä¸¤ç§ç±»å‹çš„ä¾‹å­ã€‚

### æ•°ç»„å‚æ•°

å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªæ¥å£æ–¹æ³• `selectByIds` æ¥å—ä¸€ä¸ªæ•´å‹æ•°ç»„ä½œä¸º IDï¼š

```java
// æ¥å£æ–¹æ³•
ArrayList<User> selectByIds(Integer[] ids);
```

å¯¹åº”çš„ XML æ˜ å°„æ–‡ä»¶ä¸­çš„ SQL è¯­å¥ï¼š

```xml
<select id="selectByIds" resultMap="BaseResultMap">
    select *
    from user
    where id in
    <foreach item="item" index="index" collection="array" open="(" separator="," close=")">
        #{item}
    </foreach>
</select>
```

### List å‚æ•°

å¦‚æœ `ids` æ˜¯ä¸€ä¸ª List ç±»å‹ï¼š

```java
// æ¥å£æ–¹æ³•
ArrayList<User> selectByIds(List<Integer> ids);
```

å¯¹åº”çš„ XML æ˜ å°„æ–‡ä»¶ä¸­çš„ SQL è¯­å¥ï¼š

```xml
<select id="selectByIds" resultMap="BaseResultMap">
    Select
    <include refid="Base_Column_List" />
    from jria where ID in
    <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
          #{item}
      </foreach>
  </select>
```

## [Shellè„šæœ¬å…¥é—¨ï¼šLinuxæ–‡ä»¶ç®¡ç†ç³»ç»Ÿç§˜ç±](https://blog.dong4j.site/posts/10f60db1.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## é€šè¿‡ç«¯å£å·è·å–å¯¹åº”çš„ PID

```bash
/usr/sbin/lsof -n -P -t -i :$TOMCAT_WEB_PORT
```

## æ ¹æ®åç§°è·å– PID

```bash
ps -ef | grep -w java |  grep -v grep | awk '{print $2}'

-w å…¨åŒ¹é…åå­—
-v å¿½ç•¥åå­—
```

## tar

```
.tar.gz å’Œ .tgz
è§£å‹ï¼štar zxvf FileName.tar.gz
å‹ç¼©ï¼štar zcvf FileName.tar.gz DirName
```

## shell æ‰§è¡Œå¤šä¸ªå‘½ä»¤

1. æ¯ä¸ªå‘½ä»¤ä¹‹é—´ç”¨ `;` éš”å¼€
   è¯´æ˜ï¼šå„å‘½ä»¤çš„æ‰§è¡Œç»™æœï¼Œä¸ä¼šå½±å“å…¶å®ƒå‘½ä»¤çš„æ‰§è¡Œã€‚æ¢å¥è¯è¯´ï¼Œå„ä¸ªå‘½ä»¤éƒ½ä¼šæ‰§è¡Œï¼Œ
   ä½†ä¸ä¿è¯æ¯ä¸ªå‘½ä»¤éƒ½æ‰§è¡ŒæˆåŠŸã€‚

2. æ¯ä¸ªå‘½ä»¤ä¹‹é—´ç”¨ `&&` éš”å¼€
   è¯´æ˜ï¼šè‹¥å‰é¢çš„å‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œæ‰ä¼šå»æ‰§è¡Œåé¢çš„å‘½ä»¤ã€‚è¿™æ ·å¯ä»¥ä¿è¯æ‰€æœ‰çš„å‘½ä»¤æ‰§è¡Œå®Œæ¯•åï¼Œæ‰§è¡Œè¿‡ç¨‹éƒ½æ˜¯æˆåŠŸçš„ã€‚

3. æ¯ä¸ªå‘½ä»¤ä¹‹é—´ç”¨ `||` éš”å¼€
   è¯´æ˜ï¼š||æ˜¯æˆ–çš„æ„æ€ï¼Œåªæœ‰å‰é¢çš„å‘½ä»¤æ‰§è¡Œå¤±è´¥åæ‰å»æ‰§è¡Œä¸‹ä¸€æ¡å‘½ä»¤ï¼Œç›´åˆ°æ‰§è¡ŒæˆåŠŸ
   ä¸€æ¡å‘½ä»¤ä¸ºæ­¢

## æŸ¥çœ‹å†å²å‘½ä»¤

```bash
history | awk '{print $2}' | sort | uniq -c | sort -rn | head -10
```

## æ‰¹é‡æ€è¿›ç¨‹

```bash
ps -ef|grep LOCAL=NO | grep -v grep | awk '{print $2}' |xargs kill -9
```

ç®¡é“ç¬¦ "|" ç”¨æ¥éš”å¼€ä¸¤ä¸ªå‘½ä»¤ï¼Œç®¡é“ç¬¦å·¦è¾¹å‘½ä»¤çš„è¾“å‡ºä¼šä½œä¸ºç®¡é“ç¬¦å³è¾¹å‘½ä»¤çš„è¾“å…¥ã€‚ä¸‹é¢è¯´è¯´ç”¨ç®¡é“ç¬¦è”æ¥èµ·æ¥çš„

å‡ ä¸ªå‘½ä»¤ï¼š

- "ps - ef": æ˜¯ Red Hat é‡ŒæŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹çš„å‘½ä»¤ã€‚è¿™æ—¶æ£€ç´¢å‡ºçš„è¿›ç¨‹å°†ä½œä¸ºä¸‹ä¸€æ¡å‘½ä»¤ "grep LOCAL=NO" çš„è¾“å…¥ã€‚
- "grep LOCAL=NO" : çš„è¾“å‡ºç»“æœæ˜¯ï¼Œæ‰€æœ‰å«æœ‰å…³é”®å­— "LOCAL=NO" çš„è¿›ç¨‹ï¼Œè¿™æ˜¯ Oracle æ•°æ®åº“ä¸­è¿œç¨‹è¿æ¥è¿›ç¨‹çš„å…±åŒç‰¹ç‚¹ã€‚
- "grep -v grep" : æ˜¯åœ¨åˆ—å‡ºçš„è¿›ç¨‹ä¸­å»é™¤å«æœ‰å…³é”®å­— "grep" çš„è¿›ç¨‹ã€‚
- "xargs kill -9" : ä¸­çš„ xargs å‘½ä»¤æ˜¯ç”¨æ¥æŠŠå‰é¢å‘½ä»¤çš„è¾“å‡ºç»“æœï¼ˆPIDï¼‰ä½œä¸º "kill -9" å‘½ä»¤çš„å‚æ•°ï¼Œå¹¶æ‰§è¡Œè¯¥ä»¤ã€‚
- "kill -9" : ä¼šå¼ºè¡Œæ€æ‰æŒ‡å®šè¿›ç¨‹ï¼Œè¿™æ ·å°±æˆåŠŸæ¸…é™¤äº† oracle çš„æ‰€æœ‰è¿œç¨‹è¿æ¥è¿›ç¨‹ã€‚å…¶å®ƒç±»ä¼¼çš„ä»»åŠ¡ï¼Œåªéœ€è¦ä¿®æ”¹ "grep LOCAL=NO" ä¸­çš„å…³é”®å­—éƒ¨åˆ†å°±å¯ä»¥äº†ã€‚

```bash
ps -ef|grep /usr/local/apache-tomcat-document/|grep -v grep|cut -c 9-15|xargs kill -9
```

## æ‰¹é‡åˆ é™¤

### 1. åˆ é™¤æŒ‡å®šæ–‡ä»¶

è¦åˆ é™¤ä¸€ä¸ªç‰¹å®šåç§°çš„æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ `rm` å‘½ä»¤ï¼š

```bash
rm æ–‡ä»¶å
```

å¦‚æœè¦åˆ é™¤ä¸€ä¸ªç›®å½•åŠè¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å’Œå­ç›®å½•ï¼Œå¯ä»¥å¸¦ä¸Š `-r` æˆ– `-R` é€‰é¡¹ï¼ˆå®ƒä»¬æ˜¯ç­‰ä»·çš„ï¼‰ï¼š

```bash
rm -rf ç›®å½•å
```

### 2. ä½¿ç”¨ `find` å‘½ä»¤

`find` å‘½ä»¤å¯ä»¥ç”¨æ¥æŸ¥æ‰¾æ–‡ä»¶æˆ–ç›®å½•ã€‚ç»“åˆå…¶ä»–å‘½ä»¤å¦‚ `grep` æˆ– `awk`ï¼Œä½ å¯ä»¥è¿›ä¸€æ­¥ç­›é€‰å‡ºéœ€è¦åˆ é™¤çš„æ–‡ä»¶ã€‚

ä¾‹å¦‚ï¼Œè¦åˆ é™¤å½“å‰ç›®å½•ä¸‹æ‰€æœ‰ `.txt` æ–‡ä»¶ï¼Œé™¤äº† `test.txt`ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
rm `ls *.txt | egrep -v 'test.txt'`
```

æˆ–è€…ä½¿ç”¨ `awk`ï¼š

```bash
rm `ls *.txt | awk '{if($0 != "test.txt") print $0}'`
```

è¦æ’é™¤å¤šä¸ªæ–‡ä»¶ï¼Œä½ å¯ä»¥ç”¨ç®¡é“ç¬¦ `|` ç»“åˆ `egrep` å‘½ä»¤ï¼š

```bash
rm `ls *.txt | egrep -v '(test.txt|fff.txt|ppp.txt)'`
```

### 3. åˆ é™¤æ—¥å¿—æ–‡ä»¶

å¦‚æœä½ éœ€è¦åˆ é™¤ç‰¹å®šæ—¥æœŸèŒƒå›´å†…çš„ `.log` æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ `find` å’Œ `grep`ï¼š

```bash
rm -f `find . -name '*.log' | grep '2010-09-06.log'`
```

### 4. åˆ é™¤ç›®å½•ä¸‹çš„æ‰€æœ‰ `.exe` æ–‡ä»¶

è¦åˆ é™¤æŒ‡å®šç›®å½•ä¸‹æ‰€æœ‰çš„ `.exe` æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
find . -name '*.exe' -type f -print -exec rm -rf {} ;
```

åœ¨è¿™ä¸ªå‘½ä»¤ä¸­ï¼š

- `.` è¡¨ç¤ºä»å½“å‰ç›®å½•å¼€å§‹é€’å½’æŸ¥æ‰¾ã€‚
- `-name '*.exe'` æ ¹æ®åç§°æ¥æŸ¥æ‰¾ï¼Œè¦æŸ¥æ‰¾æ‰€æœ‰ä»¥ `.exe` ç»“å°¾çš„æ–‡ä»¶æˆ–ç›®å½•ã€‚
- `-type f` æŸ¥æ‰¾çš„ç±»å‹ä¸ºæ–‡ä»¶ã€‚
- `-print` è¾“å‡ºæŸ¥æ‰¾çš„æ–‡ä»¶ç›®å½•åã€‚
- `-exec rm -rf {} ;` æ‰§è¡Œåˆ é™¤æŒ‡ä»¤ã€‚

### 5. åˆ é™¤æŒ‡å®šç›®å½•ä¸‹çš„ `.svn` ç›®å½•

è¦åˆ é™¤æŒ‡å®šç›®å½•ä¸‹æ‰€æœ‰çš„ `.svn` ç›®å½•ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
find è¦æŸ¥æ‰¾çš„ç›®å½•å -name .svn | xargs rm -rf
```

æˆ–è€…ï¼š

```bash
find -type d | grep '.svn$' | xargs rm -r
```

è¿™ä¸ªå‘½ä»¤é€šè¿‡ `grep` æŸ¥æ‰¾åŒ…å« `.svn` çš„ç›®å½•ï¼Œç„¶åä½¿ç”¨ `xargs` ä¼ é€’ç»™ `rm -rf` å‘½ä»¤è¿›è¡Œåˆ é™¤ã€‚

### 6. ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼

åœ¨å¤„ç†æ–‡ä»¶æ—¶ï¼Œç»å¸¸éœ€è¦ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥ç²¾ç¡®åŒ¹é…æ–‡ä»¶åã€‚`egrep` æ˜¯ `grep` çš„ä¸€ä¸ªæ‰©å±•ç‰ˆæœ¬ï¼Œå®ƒæ”¯æŒæ­£åˆ™è¡¨è¾¾å¼å…ƒå­—ç¬¦ï¼Œå¦‚ `+`, `?`, `|`, `()` ç­‰ã€‚

ä¾‹å¦‚ï¼Œè¦åˆ é™¤å½“å‰ç›®å½•ä¸‹æ‰€æœ‰åŒ…å« "test" æˆ– "fff" æˆ– "ppp" çš„ `.txt` æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
rm `find . -name '*.txt' | egrep -v '(test.txt|fff.txt|ppp.txt)'`
```

### 7. æ³¨æ„äº‹é¡¹

åœ¨ä½¿ç”¨ `rm` å’Œ `find` å‘½ä»¤æ—¶è¦æ ¼å¤–å°å¿ƒï¼Œå› ä¸ºè¿™äº›æ“ä½œæ˜¯ä¸å¯é€†çš„ã€‚åœ¨æ‰§è¡Œåˆ é™¤æ“ä½œä¹‹å‰ï¼Œè¯·ç¡®ä¿æœ‰è¶³å¤Ÿçš„å¤‡ä»½ï¼Œå¹¶ä¸”å·²ç»ç¡®è®¤äº†æ­£ç¡®çš„æ–‡ä»¶å’Œç›®å½•ã€‚

## find å‘½ä»¤ä½¿ç”¨è¯´æ˜

### ç”¨æ³•

`find path -option [ -print ] [ -exec -ok command ] {} \;`

### ä½¿ç”¨è¯´æ˜

å°†æ¡£æ¡ˆç³»ç»Ÿå†…ç¬¦åˆ expression çš„æ¡£æ¡ˆåˆ—å‡ºæ¥ã€‚ä½ å¯ä»¥æŒ‡å®šæ¡£æ¡ˆçš„åç§°ã€ç±»åˆ«ã€æ—¶é—´ã€å¤§å°ã€æƒé™ç­‰ä¸åŒèµ„è®¯çš„ç»„åˆï¼Œåªæœ‰å®Œå…¨ç›¸ç¬¦çš„æ‰ä¼šè¢«åˆ—å‡ºæ¥ã€‚find æ ¹æ®ä¸‹åˆ—è§„åˆ™åˆ¤æ–­ path å’Œ expressionï¼Œåœ¨å‘½ä»¤åˆ—ä¸Šç¬¬ä¸€ä¸ª `-`ã€`(`ã€`)`ã€`!` ä¹‹å‰çš„éƒ¨ä»½ä¸º pathï¼Œä¹‹åçš„æ˜¯ expressionã€‚å¦‚æœ path æ˜¯ç©ºå­—ä¸²åˆ™ä½¿ç”¨å½“å‰è·¯å¾„ï¼Œå¦‚æœ expression æ˜¯ç©ºå­—ä¸²åˆ™ä½¿ç”¨ `-print` ä¸ºé»˜è®¤ expressionã€‚
expression ä¸­å¯ä½¿ç”¨çš„é€‰é¡¹æœ‰äºŒä¸‰åä¸ªä¹‹å¤šï¼Œåœ¨æ­¤åªä»‹ç»æœ€å¸¸ç”¨çš„éƒ¨åˆ†ã€‚

- `-mount`, `-xdev`: åªæ£€æŸ¥å’ŒæŒ‡å®šç›®å½•åœ¨åŒä¸€ä¸ªæ¡£æ¡ˆç³»ç»Ÿä¸‹çš„æ¡£æ¡ˆï¼Œé¿å…åˆ—å‡ºå…¶ä»–æ¡£æ¡ˆç³»ç»Ÿä¸­çš„æ¡£æ¡ˆ
- `-amin n`: åœ¨è¿‡å» n åˆ†é’Ÿå†…è¢«è¯»å–è¿‡
- `-anewer file`: æ¯”æ¡£æ¡ˆ file æ›´æ™šè¢«è¯»å–è¿‡çš„æ¡£æ¡ˆ
- `-atime n`: åœ¨è¿‡å» n å¤©è¿‡è¯»å–è¿‡çš„æ¡£æ¡ˆ
- `-cmin n`: åœ¨è¿‡å» n åˆ†é’Ÿå†…è¢«ä¿®æ”¹è¿‡
- `-cnewer file`: æ¯”æ¡£æ¡ˆ file æ›´æ–°çš„æ¡£æ¡ˆ
- `-ctime n`: åœ¨è¿‡å» n å¤©è¿‡ä¿®æ”¹è¿‡çš„æ¡£æ¡ˆ
- `-empty`: ç©ºçš„æ¡£æ¡ˆ
- `-gid n` æˆ– `-group name`: gid æ˜¯ n æˆ–æ˜¯ group åç§°æ˜¯ name
- `-ipath p`, `-path p`: è·¯å¾„åç§°ç¬¦åˆ p çš„æ¡£æ¡ˆï¼Œipath ä¼šå¿½ç•¥å¤§å°å†™
- `-name name`, `-iname name`: æ¡£æ¡ˆåç§°ç¬¦åˆ name çš„æ¡£æ¡ˆã€‚iname ä¼šå¿½ç•¥å¤§å°å†™
- `-size n`: æ¡£æ¡ˆå¤§å°æ˜¯ n å•ä½ï¼Œb ä»£è¡¨ 512 ä½å…ƒç»„çš„åŒºå—ï¼Œc è¡¨ç¤ºå­—å…ƒæ•°ï¼Œk è¡¨ç¤º kilo bytesï¼Œw æ˜¯äºŒä¸ªä½å…ƒç»„ã€‚
- `-type c`: æ¡£æ¡ˆç±»å‹æ˜¯ c çš„æ¡£æ¡ˆã€‚
  - `d`: ç›®å½•
  - `c`: å­—å‹è£…ç½®æ¡£æ¡ˆ
  - `b`: åŒºå—è£…ç½®æ¡£æ¡ˆ
  - `p`: å…·åè´®åˆ—
  - `f`: ä¸€èˆ¬æ¡£æ¡ˆ
  - `l`: ç¬¦å·è¿ç»“
  - `s`: socket
- `-pid n`: process id æ˜¯ n çš„æ¡£æ¡ˆ
  ä½ å¯ä»¥ä½¿ç”¨ `()` å°†è¿ç®—å¼åˆ†éš”ï¼Œå¹¶ä½¿ç”¨ä¸‹åˆ—è¿ç®—ã€‚
- `exp1 -and exp2`
- `! expr`
- `-not expr`
- `exp1 -or exp2`
- `exp1, exp2`

### èŒƒä¾‹

å°†å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸‹æ‰€æœ‰æ‰©å±•åæ˜¯ `.c` çš„æ¡£æ¡ˆåˆ—å‡ºæ¥ã€‚

```bash
find . -name "*.c"
```

å°†å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸­æ‰€æœ‰ä¸€èˆ¬æ¡£æ¡ˆåˆ—å‡ºã€‚

```bash
find . -type f
```

å°†å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸‹æ‰€æœ‰æœ€è¿‘ 20 åˆ†é’Ÿå†…æ›´æ–°è¿‡çš„æ¡£æ¡ˆåˆ—å‡ºã€‚

```bash
find . -ctime -20
```

æŸ¥æ‰¾å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ä¸­åŒ…å«å­—ç¬¦ä¸² `xxx` çš„æ–‡ä»¶ï¼Œå¹¶åˆ†é¡µæ˜¾ç¤ºã€‚

```bash
find . -name "*" -exec grep 'xxx' {} \; -print | more
```

æ³¨æ„ï¼šåœ¨æœ€åä¸€ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä¿®å¤äº†å‘½ä»¤ä¸­çš„é”™è¯¯ï¼Œå°† `xxx` æ›¿æ¢ä¸º `'xxx'`ï¼Œå¹¶åœ¨ `grep` å‘½ä»¤åé¢æ·»åŠ äº†åæ–œæ  `\` æ¥è½¬ä¹‰åˆ†å·ã€‚

## ${} é»˜è®¤å€¼

```bash
#!/bin/bash
# è„šæœ¬åç§°
SCRIPT=$(basename$0)

# ä½¿ç”¨å‡½æ•°æ£€æŸ¥å‚æ•°
function usage() {
    echo -e "\nUSAGE: $SCRIPT file\n"
    exit 1
}

# æ£€æŸ¥æ˜¯å¦æä¾›äº†æ–‡ä»¶å
if [ -z "$1" ]; then
    usage
fi

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
FILENAME="$1"
if [ ! -f "$FILENAME" ]; then
    echo "Error: File '$FILENAME' does not exist."
    usage
fi

# é€è¡Œè¯»å–æ–‡ä»¶å¹¶æ‰§è¡Œ wget
while read -r LINE; do
    wget "$LINE"
done < "$FILENAME"

```

æ‰§è¡Œ

```
./shellæ–‡ä»¶å.sh è¯»å–çš„æ–‡ä»¶
```

## [Spring Boot å…¥é—¨æŒ‡å—ï¼šä»åŸºç¡€åˆ°å®è·µ](https://blog.dong4j.site/posts/f2cb7e19.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## Spring Boot ä¸ºä»€ä¹ˆå»ºè®®å°† main ç±»æ”¾åœ¨æ‰€æœ‰ç±»æ‰€åœ¨åŒ…çš„é¡¶å±‚

> é€šå¸¸å»ºè®®å°†åº”ç”¨çš„ main ç±»æ”¾åˆ°å…¶ä»–ç±»æ‰€åœ¨åŒ…çš„é¡¶å±‚ (root package)ï¼Œå¹¶ å°† @EnableAutoConfiguration æ³¨è§£åˆ°ä½ çš„ main ç±»ä¸Šï¼Œè¿™æ ·å°±éšå¼åœ°å®šä¹‰äº†ä¸€ä¸ª åŸºç¡€çš„åŒ…æœç´¢è·¯å¾„ï¼ˆsearch packageï¼‰ï¼Œä»¥æœç´¢æŸäº›ç‰¹å®šçš„æ³¨è§£å®ä½“ï¼ˆæ¯”å¦‚ @Serviceï¼Œ@Component ç­‰ï¼‰ ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª JPA åº”ç”¨ï¼ŒSpring å°† æœç´¢ @EnableAutoConfiguration æ³¨è§£çš„ç±»æ‰€åœ¨åŒ…ä¸‹çš„ @Entity å®ä½“ã€‚

é‡‡ç”¨ root package æ–¹å¼ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨ @ComponentScan æ³¨è§£è€Œä¸éœ€è¦æŒ‡ å®š basePackage å±æ€§ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ @SpringBootApplication æ³¨è§£ï¼Œåªè¦å°† main ç±»æ”¾åˆ° root package ä¸­ã€‚

@SpringBootApplication ç­‰åŒäº**ä»¥é»˜è®¤å±æ€§**ä½¿ç”¨ä¸€ä¸‹æ³¨è§£:

1. @EnableAutoConfiguration
2. @ComponentScan æ‰«ææ‰€æœ‰ Spring ç»„ä»¶ (@Component , @Service , @Repository , @Controller)ï¼ŒåŒ…æ‹¬ @Configuration ç±»ã€‚
3. @Configuration

**è‡ªå®šä¹‰å±æ€§**  
@SpringBootApplication(exclude = {}, excludeName = {}, scanBasePackages = {}, scanBasePackageClasses = {})

## æ„é€ å™¨æ³¨å…¥

1. @Autowired å¯çœç•¥
2. æ³¨å…¥çš„ bean å¯ä»¥ä¸º final

```java
@Service
public class DatabaseAccountService implements AccountService {
	private final RiskAssessor riskAssessor;
	@Autowired
	public DatabaseAccountService(RiskAssessor riskAssessor) {
		this.riskAssessor = riskAssessor;
	}
}
```

## å¼€å‘è€…å·¥å…·

```xml
<!-- çƒ­éƒ¨ç½² -->
<!-- devtoolså¯ä»¥å®ç°é¡µé¢çƒ­éƒ¨ç½²ï¼ˆå³é¡µé¢ä¿®æ”¹åä¼šç«‹å³ç”Ÿæ•ˆï¼Œè¿™ä¸ªå¯ä»¥ç›´æ¥åœ¨application.propertiesæ–‡ä»¶ä¸­é…ç½®spring.thymeleaf.cache=falseæ¥å®ç°ï¼‰ -->
<!-- å®ç°ç±»æ–‡ä»¶çƒ­éƒ¨ç½²ï¼ˆç±»æ–‡ä»¶ä¿®æ”¹åä¸ä¼šç«‹å³ç”Ÿæ•ˆï¼‰ï¼Œå®ç°å¯¹å±æ€§æ–‡ä»¶çš„çƒ­éƒ¨ç½²ã€‚ -->
<!-- å³devtoolsä¼šç›‘å¬classpathä¸‹çš„æ–‡ä»¶å˜åŠ¨ï¼Œå¹¶ä¸”ä¼šç«‹å³é‡å¯åº”ç”¨ï¼ˆå‘ç”Ÿåœ¨ä¿å­˜æ—¶æœºï¼‰ï¼Œæ³¨æ„ï¼šå› ä¸ºå…¶é‡‡ç”¨çš„è™šæ‹Ÿæœºæœºåˆ¶ï¼Œè¯¥é¡¹é‡å¯æ˜¯å¾ˆå¿«çš„ -->
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-devtools</artifactId>
  <!-- optional=true,ä¾èµ–ä¸ä¼šä¼ é€’ï¼Œè¯¥é¡¹ç›®ä¾èµ–devtoolsï¼›ä¹‹åä¾èµ–booté¡¹ç›®çš„é¡¹ç›®å¦‚æœæƒ³è¦ä½¿ç”¨devtoolsï¼Œéœ€è¦é‡æ–°å¼•å…¥ -->
  <optional>true</optional>
</dependency>
```

application.properties é…ç½®

```
#æ·»åŠ é‚£ä¸ªç›®å½•çš„æ–‡ä»¶éœ€è¦restart
spring.devtools.restart.additional-paths=src/main/java
#æ’é™¤é‚£ä¸ªç›®å½•çš„æ–‡ä»¶ä¸éœ€è¦restart
spring.devtools.restart.exclude=static/**,public/**
```

> åœ¨è¿è¡Œä¸€ä¸ªå®Œæ•´çš„ï¼Œæ‰“åŒ…è¿‡çš„åº”ç”¨æ—¶ï¼Œå¼€å‘è€…å·¥å…·ï¼ˆdevtoolsï¼‰ä¼šè¢«è‡ªåŠ¨ç¦ç”¨ã€‚ å¦‚æœåº”ç”¨ä½¿ç”¨ java -jar æˆ–ç‰¹æ®Šçš„ç±»åŠ è½½å™¨å¯åŠ¨ï¼Œéƒ½ä¼šè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªäº§å“çº§çš„åº” ç”¨ï¼ˆproduction applicationï¼‰ï¼Œä»è€Œç¦ç”¨å¼€å‘è€…å·¥å…·ã€‚ä¸ºäº†é˜²æ­¢ devtools ä¼ é€’åˆ°é¡¹ ç›®ä¸­çš„å…¶ä»–æ¨¡å—ï¼Œè®¾ç½®è¯¥ä¾èµ–çº§åˆ«ä¸º optional æ˜¯ä¸ªä¸é”™çš„å®è·µ

**Spring Loaded æˆ– JRebel é¡¹ç›®**

<http://blog.csdn.net/JE_GE/article/details/53326525>  
<http://blog.csdn.net/isea533/article/details/70495714>

## spring boot è¿œç¨‹è°ƒè¯•

## FailureAnalyzer

<https://docs.spring.io/spring-boot/docs/2.0.0.M5/reference/htmlsingle/#howto-failure-analyzer>

## è‡ªå®šä¹‰ Banner

## è‡ªå®šä¹‰ SpringApplication

```java
public static void main(String[] args) {
		SpringApplication app = new SpringApplication(MySpringConfig.uration.class);
		app.setBannerMode(Banner.Mode.OFF);
		app.run(args);
	}
```

## Application äº‹ä»¶å’Œç›‘å¬å™¨

## Admin ç‰¹æ€§

> é€šè¿‡è®¾ç½® spring.application.admin.enabled å±æ€§å¯ä»¥å¯ç”¨ç®¡ç†ç›¸å…³çš„ ï¼ˆadmin-relatedï¼‰ç‰¹æ€§ï¼Œè¿™å°†æš´éœ² SpringApplicationAdminMXBean åˆ°å¹³å° çš„ MBeanServer ï¼Œä½ å¯ä»¥ä½¿ç”¨è¯¥ç‰¹æ€§è¿œç¨‹ç®¡ç† Spring Boot åº”ç”¨ï¼Œè¿™å¯¹ä»»ä½• service åŒ…è£…å™¨ï¼ˆwrapperï¼‰å®ç°ä¹Ÿæœ‰ç”¨ã€‚

æ³¨ é€šè¿‡ local.server.port å¯ä»¥è·å–è¯¥åº”ç”¨è¿è¡Œçš„ HTTP ç«¯å£ã€‚å¯ç”¨è¯¥ç‰¹æ€§æ—¶éœ€ è¦æ³¨æ„ MBean ä¼šæš´éœ²ä¸€ä¸ªæ–¹æ³•å»å…³é—­åº”ç”¨ã€‚

## Application å±æ€§æ–‡ä»¶

1. å½“å‰ç›®å½•ä¸‹çš„ /config å­ç›®å½•ã€‚
2. å½“å‰ç›®å½•ã€‚
3. classpath ä¸‹çš„ /config åŒ…ã€‚
4. classpath æ ¹è·¯å¾„ï¼ˆrootï¼‰ã€‚

## é…ç½®æ–‡ä»¶

é€šè¿‡è®¾ç½®å¯åŠ¨å‚æ•°æ¥é€‰æ‹©ç¯å¢ƒ, åªéœ€è¦æ‰“ä¸€æ¬¡åŒ…, å°±å¯ä»¥åœ¨ä¸åŒç¯å¢ƒè¿è¡Œ

## æ—¥å¿—

Spring Boot é»˜è®¤æ—¥å¿—æ¡†æ¶ä¸º logback, é»˜è®¤æ§åˆ¶å°è¾“å‡º

æ ¹æ®æ—¥å¿—é…ç½®æ–‡ä»¶çš„åç§°é€‰æ‹©æ—¥å¿—ç³»ç»Ÿ

| æ—¥å¿—ç³»ç»Ÿ                | å®šåˆ¶é…ç½®                                                            |
| ----------------------- | ------------------------------------------------------------------- |
| Logback                 | logback-spring.xml logback-spring.groovy logback.xml logback.groovy |
| Log4j                   | log4j.properties log4j.xml                                          |
| Log4j2                  | log4j2-spring.xml log4j2.xml                                        |
| JDK (Java Util Logging) | logging.properties                                                  |

## [Javaå¹¶å‘ç¼–ç¨‹çš„åˆ©å™¨ï¼švolatileçš„å…³é”®æŠ€å·§å’Œåº”ç”¨](https://blog.dong4j.site/posts/da43da6e.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

**volatile å…³é”®å­—çš„ 2 å±‚å«ä¹‰:**

> ç”¨ volatile ä¿®é¥°çš„å˜é‡ï¼Œçº¿ç¨‹åœ¨æ¯æ¬¡ä½¿ç”¨å˜é‡çš„æ—¶å€™ï¼Œéƒ½ä¼šè¯»å–å˜é‡ä¿®æ”¹åçš„æœ€æ–°çš„å€¼.  
> ä½œä¸ºæŒ‡ä»¤å…³é”®å­—ï¼Œç¡®ä¿æœ¬æ¡æŒ‡ä»¤ä¸ä¼šå› ç¼–è¯‘å™¨çš„ä¼˜åŒ–è€Œçœç•¥ï¼Œä¸”è¦æ±‚æ¯æ¬¡ç›´æ¥è¯»å€¼.

## å¯è§æ€§

å¯è§æ€§æ˜¯æŒ‡ å½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†ä¸€ä¸ªå…±äº«å˜é‡,å…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹åˆ»å¾—çŸ¥è¿™ä¸ªä¿®æ”¹.  
è¿™é‡Œæœ‰å¿…è¦äº†è§£ä¸€ä¸‹ Java çš„å†…å­˜æ¨¡å‹

![20241229154732_UNw0TFwI.webp](https://cdn.dong4j.site/source/image/20241229154732_UNw0TFwI.webp)

è¢« volatile ä¿®é¥°çš„å˜é‡,å½“çº¿ç¨‹éœ€è¦ä½¿ç”¨è¿™ä¸ªå˜é‡æ—¶,å›å»ä¸»å†…å­˜ä¸­è¯»å–,ç„¶ååŠ è½½åˆ°è‡ªå·±çš„å·¥ä½œçº¿ç¨‹ä¸­,  
å·¥ä½œçº¿ç¨‹ä¸­çš„å˜é‡åªæ˜¯ä¸»å­˜å˜é‡çš„ä¸€ä¸ªæ‹·è´,å½“ä½¿ç”¨å®Œè¿™ä¸ªå˜é‡å,ä¼šåˆ·æ–°ä¼šä¸»å­˜ä¸­.

![20241229154732_Lg19Egdh.webp](https://cdn.dong4j.site/source/image/20241229154732_Lg19Egdh.webp)

å½“æ•°æ®ä¸­ä¸»å†…å­˜å¤åˆ¶åˆ°å·¥ä½œå†…å­˜å­˜å‚¨æ—¶,å¿…é¡»å‡ºç°ä¸¤ä¸ªåŠ¨ä½œ:

1. ç”±ä¸»å†…å­˜æ‰§è¡Œçš„ read æ“ä½œ
2. æœ‰å·¥ä½œå†…å­˜æ‰§è¡Œç›¸åº”çš„ load æ“ä½œ

å½“æ•°æ®ä»å·¥ä½œå†…å­˜æ‹·è´åˆ°ä¸»å†…å­˜æ—¶,ä¹Ÿä¼šæœ‰ä¸¤ä¸ªæ“ä½œ:

1. ç”¨å·¥ä½œå†…å­˜æ‰§è¡Œçš„ store æ“ä½œ
2. ç”¨ä¸»å†…å­˜æ‰§è¡Œç›¸åº”çš„ write æ“ä½œ

volatile çš„ç‰¹æ®Šè§„åˆ™å°±æ˜¯ readã€loadã€use å¿…é¡»è¿ç»­å‡ºç°ã€‚assignã€storeã€write åŠ¨ä½œå¿…é¡»è¿ç»­å‡ºç°ã€‚æ‰€ä»¥ä½¿ç”¨ volatile å˜é‡èƒ½å¤Ÿä¿è¯å¿…é¡»å…ˆä»ä¸»å†…å­˜åˆ·æ–°æœ€æ–°çš„å€¼ï¼Œæ¯æ¬¡ä¿®æ”¹åå¿…é¡»ç«‹å³åŒæ­¥å›ä¸»å†…å­˜å½“ä¸­ã€‚

æ‰€ä»¥ colatile çš„å¯è§æ€§å¾ˆé€‚åˆç”¨æ¥æ§åˆ¶å¹¶å‘:

```java
public class VolatileDemo {
	private static volatile boolean flag;
	public static void shutdown(){
		flag=true;
	}
	public static void main(String[] args) throws InterruptedException{
		VolatileDemo m = new VolatileDemo();
		for(int i=0;i<20;i++){
			new Thread(new Runnable() {
				public void run() {
					while(!flag){
						  System.out.println("aaa");
					}
				}
			}).start();
		}
		Thread.sleep(2000);
		shutdown();
	}
}
```

å½“è°ƒç”¨ shutdown() æ—¶,èƒ½ä¿è¯æ‰€æœ‰çº¿ç¨‹ç«‹åˆ»åœæ­¢.

## volatile çš„ç¦æ­¢æŒ‡ä»¤é‡æ’åº

æŒ‡ä»¤é‡æ’æ˜¯ ç¼–è¯‘å™¨å’Œ cup åœ¨ä¸å½±å“æ‰§è¡Œç»“æœçš„æƒ…å†µä¸‹,è¿›è¡Œçš„ä¸€ç§ä¼˜åŒ–ç­–ç•¥.

> åœ¨ Java ä¸­æ™®éçš„å˜é‡ä»…ä»…ä¼šä¿è¯åœ¨è¯¥æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€æœ‰ä¾èµ–çš„èµ‹å€¼ç»“æœçš„åœ°æ–¹éƒ½èƒ½è·å–åˆ°æ­£ç¡®çš„ç»“æœï¼Œè€Œä¸èƒ½ä¿è¯å˜é‡èµ‹å€¼æ“ä½œçš„é¡ºåºä¸ç¨‹åºä»£ç ä¸­çš„æ‰§è¡Œé¡ºåºä¸€è‡´ã€‚å› ä¸ºåœ¨ä¸€ä¸ªçº¿ç¨‹çš„æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­æ— æ³•æ„ŸçŸ¥åˆ°è¿™ç‚¹ï¼Œè¿™ä¹Ÿå°±æ˜¯ Java å†…å­˜æ¨¡å‹ä¸­æè¿°çš„æ‰€è°“â€œçº¿ç¨‹å†…è¡¨ç°ä¸ºä¸²è¡Œçš„è¯­ä¹‰â€ã€‚

### æœ‰åºæ€§

è®¡ç®—æœºåœ¨æ‰§è¡Œä»£ç æ—¶,ä¸ä¸€å®šæŒ‰ç…§ç¨‹åºçš„é¡ºåºæ¥æ‰§è¡Œ.

```java
class OrderExample {
	int a = 0;
	boolean flag = false;
	public void writer() {
		a = 1;
		flag = true;
	}
	public void reader() {
		if (flag) {
			int i = a +1;
		}
	}
}
```

æ¯”å¦‚ä¸Šè¿°ä»£ç ï¼Œä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«è¢«ä¸¤ä¸ªçº¿ç¨‹è°ƒç”¨ã€‚  
æŒ‰ç…§å¸¸ç†ï¼Œå†™çº¿ç¨‹åº”è¯¥å…ˆæ‰§è¡Œ a=1ï¼Œå†æ‰§è¡Œ flag=trueã€‚  
å½“è¯»çº¿ç¨‹è¿›è¡Œè¯»çš„æ—¶å€™ï¼Œi=2ï¼›  
ä½†æ˜¯å› ä¸º a=1 å’Œ flag=trueï¼Œå¹¶æ²¡æœ‰é€»è¾‘ä¸Šçš„å…³è”ã€‚  
æ‰€ä»¥æœ‰å¯èƒ½æ‰§è¡Œçš„é¡ºåºé¢ å€’ï¼Œæœ‰å¯èƒ½å…ˆæ‰§è¡Œ flag=trueï¼Œå†æ‰§è¡Œ a=1ã€‚  
è¿™æ—¶å½“ flag=true æ—¶ï¼Œåˆ‡æ¢åˆ°è¯»çº¿ç¨‹ï¼Œæ­¤æ—¶ a=1 è¿˜æ²¡æœ‰æ‰§è¡Œï¼Œé‚£ä¹ˆè¯»çº¿ç¨‹å°† i=1ã€‚

**æŒ‡ä»¤é‡æ’å¯ä»¥ä½¿æµæ°´çº¿æ›´åŠ é¡ºç•…**

å½“ç„¶æŒ‡ä»¤é‡æ’çš„åŸåˆ™æ˜¯ä¸èƒ½ç ´åä¸²è¡Œç¨‹åºçš„è¯­ä¹‰ï¼Œä¾‹å¦‚ a=1,b=a+1ï¼Œè¿™ç§æŒ‡ä»¤å°±ä¸ä¼šé‡æ’äº†ï¼Œå› ä¸ºé‡æ’çš„ä¸²è¡Œç»“æœå’ŒåŸå…ˆçš„ä¸åŒã€‚

åœ¨ Java é‡Œé¢ï¼Œå¯ä»¥é€šè¿‡ volatile å…³é”®å­—æ¥ä¿è¯ä¸€å®šçš„â€œæœ‰åºæ€§â€ã€‚å¦å¤–å¯ä»¥é€šè¿‡ synchronized å’Œ Lock æ¥ä¿è¯æœ‰åºæ€§ï¼Œå¾ˆæ˜¾ç„¶ï¼Œsynchronized å’Œ Lock ä¿è¯æ¯ä¸ªæ—¶åˆ»æ˜¯æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œç›¸å½“äºæ˜¯è®©çº¿ç¨‹é¡ºåºæ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œè‡ªç„¶å°±ä¿è¯äº†æœ‰åºæ€§ã€‚

### Happen-Before

Java å†…å­˜æ¨¡å‹å…·å¤‡ä¸€äº›å…ˆå¤©çš„â€œæœ‰åºæ€§â€ï¼Œå³ä¸éœ€è¦é€šè¿‡ä»»ä½•æ‰‹æ®µå°±èƒ½å¤Ÿå¾—åˆ°ä¿è¯çš„æœ‰åºæ€§ï¼Œè¿™ä¸ªé€šå¸¸ä¹Ÿç§°ä¸º happen-before åŸåˆ™ã€‚å¦‚æœä¸¤ä¸ªæ“ä½œçš„æ‰§è¡Œæ¬¡åºæ— æ³•ä» happen-before åŸåˆ™æ¨å¯¼å‡ºæ¥ï¼Œé‚£ä¹ˆå®ƒä»¬å°±ä¸èƒ½ä¿è¯å®ƒä»¬çš„æœ‰åºæ€§ï¼Œè™šæ‹Ÿæœºå¯ä»¥éšæ„åœ°å¯¹å®ƒä»¬è¿›è¡Œé‡æ’åºã€‚

- ç¨‹åºé¡ºåºåŸåˆ™ï¼šä¸€ä¸ªçº¿ç¨‹å†…ä¿è¯è¯­ä¹‰çš„ä¸²è¡Œæ€§ (å†™åœ¨å‰é¢çš„å…ˆå‘ç”Ÿ,ç”¨æ¥ä¿è¯å•çº¿ç¨‹ç»“æœçš„æ­£ç¡®æ€§)
- volatile è§„åˆ™ï¼švolatile å˜é‡çš„å†™ï¼Œå…ˆå‘ç”Ÿäºè¯»ï¼Œè¿™ä¿è¯äº† volatile å˜é‡çš„å¯è§æ€§
- é”è§„åˆ™ï¼šè§£é”ï¼ˆunlockï¼‰å¿…ç„¶å‘ç”Ÿåœ¨éšåçš„åŠ é”ï¼ˆlockï¼‰å‰
- ä¼ é€’æ€§ï¼šA å…ˆäº Bï¼ŒB å…ˆäº Cï¼Œé‚£ä¹ˆ A å¿…ç„¶å…ˆäº C
- çº¿ç¨‹çš„ start() æ–¹æ³•å…ˆäºå®ƒçš„æ¯ä¸€ä¸ªåŠ¨ä½œ
- çº¿ç¨‹çš„æ‰€æœ‰æ“ä½œå…ˆäºçº¿ç¨‹çš„ç»ˆç»“ï¼ˆThread.join()ï¼‰
- çº¿ç¨‹çš„ä¸­æ–­ï¼ˆinterrupt()ï¼‰å…ˆäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç 
- å¯¹è±¡çš„æ„é€ å‡½æ•°æ‰§è¡Œç»“æŸå…ˆäº finalize() æ–¹æ³•

**ä¸ºä»€ä¹ˆ Happen-Before åŸåˆ™ä¸è¢«æŒ‡ä»¤é‡æ’å½±å“?**  
ä¾‹å¦‚ä½ è®©ä¸€ä¸ª volatile çš„ integer è‡ªå¢ï¼ˆi++ï¼‰ï¼Œå…¶å®è¦åˆ†æˆ 3 æ­¥ï¼š1ï¼‰è¯»å– volatile å˜é‡å€¼åˆ° localï¼› 2ï¼‰å¢åŠ å˜é‡çš„å€¼ï¼›3ï¼‰æŠŠ local çš„å€¼å†™å›ï¼Œè®©å…¶å®ƒçš„çº¿ç¨‹å¯è§ã€‚è¿™ 3 æ­¥çš„ jvm æŒ‡ä»¤ä¸ºï¼š

```
mov
0xc(%r10),%r8d
 ; Load
inc
 %r8d           ; Increment
mov
 %r8d,0xc(%r10)
 ; Store
lock
 addl $0x0,(%rsp)
 ; StoreLoad Barrier
```

StoreLoad Barrier å°±æ˜¯å†…å­˜å±éšœ

> å†…å­˜å±éšœï¼ˆmemory barrierï¼‰æ˜¯ä¸€ä¸ª CPU æŒ‡ä»¤ã€‚åŸºæœ¬ä¸Šï¼Œå®ƒæ˜¯è¿™æ ·ä¸€æ¡æŒ‡ä»¤ï¼š
>
> 1.  ç¡®ä¿ä¸€äº›ç‰¹å®šæ“ä½œæ‰§è¡Œçš„é¡ºåºï¼›
> 2.  å½±å“ä¸€äº›æ•°æ®çš„å¯è§æ€§ (å¯èƒ½æ˜¯æŸäº›æŒ‡ä»¤æ‰§è¡Œåçš„ç»“æœ)ã€‚  
>     ç¼–è¯‘å™¨å’Œ CPU å¯ä»¥åœ¨ä¿è¯è¾“å‡ºç»“æœä¸€æ ·çš„æƒ…å†µä¸‹å¯¹æŒ‡ä»¤é‡æ’åºï¼Œä½¿æ€§èƒ½å¾—åˆ°ä¼˜åŒ–ã€‚  
>     æ’å…¥ä¸€ä¸ªå†…å­˜å±éšœï¼Œç›¸å½“äºå‘Šè¯‰ CPU å’Œç¼–è¯‘å™¨å…ˆäºè¿™ä¸ªå‘½ä»¤çš„å¿…é¡»å…ˆæ‰§è¡Œï¼Œåäºè¿™ä¸ªå‘½ä»¤çš„å¿…é¡»åæ‰§è¡Œã€‚  
>     å†…å­˜å±éšœå¦ä¸€ä¸ªä½œç”¨æ˜¯å¼ºåˆ¶æ›´æ–°ä¸€æ¬¡ä¸åŒ CPU çš„ç¼“å­˜ã€‚  
>     ä¾‹å¦‚ï¼Œä¸€ä¸ªå†™å±éšœä¼šæŠŠè¿™ä¸ªå±éšœå‰å†™å…¥çš„æ•°æ®åˆ·æ–°åˆ°ç¼“å­˜ï¼Œè¿™æ ·ä»»ä½•è¯•å›¾è¯»å–è¯¥æ•°æ®çš„çº¿ç¨‹å°†å¾—åˆ°æœ€æ–°å€¼ï¼Œè€Œä¸ç”¨è€ƒè™‘åˆ°åº•æ˜¯è¢«å“ªä¸ª cpu æ ¸å¿ƒæˆ–è€…å“ªé¢— CPU æ‰§è¡Œçš„ã€‚

**å†…å­˜å±éšœå’Œ volatile çš„å…³ç³»**  
ä¸Šé¢çš„è™šæ‹ŸæœºæŒ‡ä»¤é‡Œé¢æœ‰æåˆ°ï¼Œå¦‚æœä½ çš„å­—æ®µæ˜¯ volatileï¼ŒJava å†…å­˜æ¨¡å‹å°†åœ¨å†™æ“ä½œåæ’å…¥ä¸€ä¸ª**å†™å±éšœæŒ‡ä»¤**ï¼Œåœ¨è¯»æ“ä½œå‰æ’å…¥ä¸€ä¸ª**è¯»å±éšœæŒ‡ä»¤**ã€‚  
è¿™æ„å‘³ç€å¦‚æœä½ å¯¹ä¸€ä¸ª volatile å­—æ®µè¿›è¡Œå†™æ“ä½œï¼Œä½ å¿…é¡»çŸ¥é“ï¼š

1. ä¸€æ—¦ä½ å®Œæˆå†™å…¥ï¼Œä»»ä½•è®¿é—®è¿™ä¸ªå­—æ®µçš„çº¿ç¨‹å°†ä¼šå¾—åˆ°æœ€æ–°çš„å€¼ã€‚
2. åœ¨ä½ å†™å…¥å‰ï¼Œä¼šä¿è¯æ‰€æœ‰ä¹‹å‰å‘ç”Ÿçš„äº‹å·²ç»å‘ç”Ÿï¼Œå¹¶ä¸”ä»»ä½•æ›´æ–°è¿‡çš„æ•°æ®å€¼ä¹Ÿæ˜¯å¯è§çš„ï¼Œå› ä¸ºå†…å­˜å±éšœä¼šæŠŠä¹‹å‰çš„å†™å…¥å€¼éƒ½åˆ·æ–°åˆ°ç¼“å­˜ã€‚

æ˜ç™½äº†å†…å­˜å±éšœè¿™ä¸ª CPU æŒ‡ä»¤ï¼Œå›åˆ°å‰é¢çš„ JVM æŒ‡ä»¤ï¼šä» load åˆ° use åˆ° assign åˆ° store åˆ°å†…å­˜å±éšœï¼Œä¸€å…± 4 æ­¥ï¼Œå…¶ä¸­æœ€åä¸€æ­¥ jvm è®©è¿™ä¸ªæœ€æ–°çš„å˜é‡çš„å€¼åœ¨æ‰€æœ‰çº¿ç¨‹å¯è§ï¼Œä¹Ÿå°±æ˜¯æœ€åä¸€æ­¥è®©æ‰€æœ‰çš„ CPU å†…æ ¸éƒ½è·å¾—äº†æœ€æ–°çš„å€¼ï¼Œä½†ä¸­é—´çš„å‡ æ­¥ï¼ˆä» Load åˆ° Storeï¼‰æ˜¯ä¸å®‰å…¨çš„ï¼Œä¸­é—´å¦‚æœå…¶ä»–çš„ CPU ä¿®æ”¹äº†å€¼å°†ä¼šä¸¢å¤±ã€‚

### volatile ç¦æ­¢æŒ‡ä»¤é‡æ’çš„ä¸¤å±‚å«ä¹‰

1. å½“ç¨‹åºæ‰§è¡Œåˆ° volatile å˜é‡çš„è¯»æ“ä½œæˆ–è€…å†™æ“ä½œæ—¶,åœ¨å…¶å‰é¢çš„æ“ä½œè‚¯å®šå·²ç»å…¨éƒ¨è¿›è¡Œ,ä¸”ç»“æœå¯¹åé¢çš„æ“ä½œå¯è§; ä¸”åé¢çš„æ“ä½œè¿˜æ²¡æœ‰è¿›è¡Œ;
2. åœ¨è¿›è¡ŒæŒ‡ä»¤ä¼˜åŒ–æ—¶,ä¸èƒ½å°†å¯¹ volatile å˜é‡çš„è®¿é—®è¯­å¥æ”¾åœ¨æ°”å€™æ‰§è¡Œ,ä¹Ÿä¸èƒ½æŠŠ volatile å˜é‡åé¢çš„è¯­å¥æ”¾åœ¨å…¶å‰é¢æ‰§è¡Œ.

```java
//xã€yä¸ºévolatileå˜é‡
//flagä¸ºvolatileå˜é‡
x = 2;          //è¯­å¥1
y = 0;          //è¯­å¥2
flag = true;  //è¯­å¥3
x = 4;          //è¯­å¥4
y = -1;         //è¯­å¥5
```

ç”±äº flag å˜é‡ä¸º volatile å˜é‡ï¼Œé‚£ä¹ˆåœ¨è¿›è¡ŒæŒ‡ä»¤é‡æ’åºçš„è¿‡ç¨‹çš„æ—¶å€™ï¼Œä¸ä¼šå°†è¯­å¥ 3 æ”¾åˆ°è¯­å¥ 1ã€è¯­å¥ 2 å‰é¢ï¼Œä¹Ÿä¸ä¼šè®²è¯­å¥ 3 æ”¾åˆ°è¯­å¥ 4ã€è¯­å¥ 5 åé¢ã€‚ä½†æ˜¯è¦æ³¨æ„è¯­å¥ 1 å’Œè¯­å¥ 2 çš„é¡ºåºã€è¯­å¥ 4 å’Œè¯­å¥ 5 çš„é¡ºåºæ˜¯ä¸ä½œä»»ä½•ä¿è¯çš„ã€‚

å¹¶ä¸” volatile å…³é”®å­—èƒ½ä¿è¯ï¼Œæ‰§è¡Œåˆ°è¯­å¥ 3 æ—¶ï¼Œè¯­å¥ 1 å’Œè¯­å¥ 2 å¿…å®šæ˜¯æ‰§è¡Œå®Œæ¯•äº†çš„ï¼Œä¸”è¯­å¥ 1 å’Œè¯­å¥ 2 çš„æ‰§è¡Œç»“æœå¯¹è¯­å¥ 3ã€è¯­å¥ 4ã€è¯­å¥ 5 æ˜¯å¯è§çš„

## vloatile çš„å¹¶å‘é—®é¢˜

volatile èƒ½ä¿è¯å¯è§æ€§å’Œç¦æ­¢æŒ‡ä»¤é‡æ’,ä½†æ˜¯å´ä¸èƒ½ä¿è¯åŸå­æ€§,  
å…¶å®é€šè¿‡ä¸Šé¢çš„åˆ†æä¹Ÿèƒ½å¾—å‡ºè¿™ä¸ªç»“è®º.

æ¯”å¦‚ i++ æ“ä½œ:

1. è¯»å– volatile å˜é‡å€¼åˆ°å½“å‰çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­
2. è¿›è¡Œ i+1 è®¡ç®—
3. å°†å·¥ä½œå†…å­˜ä¸­çš„å€¼å†™ä¼šåˆ°ä¸»å†…å­˜,è®©å…¶ä»–çº¿ç¨‹å¯è§

ç°åœ¨æœ‰ 2 ä¸ªçº¿ç¨‹åŒæ—¶å¯¹ volatile å˜é‡è¿›è¡Œæ“ä½œ,  
å½“ç¬¬ä¸€ä¸ªå˜é‡ä»ä¸»å†…å­˜ä¸­è¯»å–äº†å˜é‡,ä½†æ˜¯è¿˜æœªè¿›è¡Œ i+1 æ“ä½œ,  
æ­¤æ—¶ç¬¬äºŒä¸ªçº¿ç¨‹ä¹Ÿä»ä¸»å­˜ä¸­è¯»å–äº†è¿™ä¸ªå˜é‡,ä½†æ˜¯å’Œçº¿ç¨‹ä¸€è¯»å–çš„å€¼ä¸€æ ·,å› ä¸ºçº¿ç¨‹ä¸€è¿˜æœªå°†è®¡ç®—è¿‡çš„å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­,æ­¤æ—¶ 2 ä¸ªçº¿ç¨‹éƒ½å¯¹å˜é‡è¿›è¡Œ +1 æ“ä½œ,ç„¶ååˆ·æ–°åˆ°ä¸»å†…å­˜,æ­¤æ—¶,ä¸»å†…å­˜ä¸­çš„å€¼åªæ˜¯åšäº†ä¸€æ¬¡ +1 æ“ä½œ,è€Œä¸æ˜¯ 2 æ¬¡.

**æŸä¸ªçº¿ç¨‹å°†ä¸€ä¸ªå…±äº«å€¼ä¼˜åŒ–åˆ°äº†å†…å­˜ä¸­ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹å°†è¿™ä¸ªå…±äº«å€¼ä¼˜åŒ–åˆ°äº†ç¼“å­˜ä¸­ï¼Œå½“ä¿®æ”¹å†…å­˜ä¸­å€¼çš„æ—¶å€™ï¼Œç¼“å­˜ä¸­çš„å€¼æ˜¯ä¸çŸ¥é“è¿™ä¸ªä¿®æ”¹çš„ã€‚**

## [ã€ŠLog4j 2 å®˜æ–¹æ–‡æ¡£ã€‹å¤šä½™æ€§ï¼ˆAdditivityï¼‰](https://blog.dong4j.site/posts/d6e26bb5.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

å¦‚æœæˆ‘ä»¬å¸Œæœ›è¾“å‡º `com.foo.Bar` çš„ TRACE ç­‰çº§çš„æ—¥å¿—ï¼Œè€Œä¸åƒå½±å“å…¶ä»–æ—¥å¿—çš„è¾“å‡ºã€‚ç®€å•çš„æ”¹å˜æ—¥å¿—ç­‰çº§æ˜¯ä¸èƒ½è¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„ç›®çš„ï¼›ä½†æ˜¯ä¿®æ”¹ä¹Ÿå¾ˆç®€å•ï¼Œåªè¦æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªæ–°çš„ Logger å®šä¹‰å°±å¯ä»¥è¾¾åˆ°ç›®æ ‡ã€‚

```xml
<Logger name="com.foo.Bar" level="TRACE"/>
<Root level="ERROR">
  <AppenderRef ref="STDOUT">
</Root>
```

è¿™ä¸ªé…ç½®è¾¾åˆ°äº†æˆ‘ä»¬æƒ³è¦çš„ç›®æ ‡ï¼Œæ‰€æœ‰ `com.foo.Bar` çš„æ—¥å¿—éƒ½ä¼šè¢«è¾“å‡ºï¼Œè€Œå…¶ä»–ç»„ä»¶çš„æ—¥å¿—ä»…ä»…ä¼šè¾“å‡º `ERROR` ç­‰çº§çš„æ—¥å¿—ã€‚

åœ¨ä¸Šé¢çš„ä¾‹å­ï¼Œæ‰€æœ‰ `com.foo.Bar` çš„æ—¥å¿—éƒ½ä¼šè¢«è¾“å‡ºåˆ°æ§åˆ¶å°ã€‚è¿™æ˜¯å› ä¸ºä¸º `com.foo.Bar`Â  é…ç½®çš„ `Logger` æ²¡æœ‰è®¾å®šä»»ä½•çš„ `Appender`ã€‚

è¯·çœ‹å¦‚ä¸‹çš„é…ç½®

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Configuration status="WARN">
  <Appenders>
    <Console name="Console" target="SYSTEM_OUT">
      <PatternLayout pattern="%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"/>
    </Console>
  </Appenders>
  <Loggers>
    <Logger name="com.foo.Bar" level="trace">
      <AppenderRef ref="Console"/>
    </Logger>
    <Root level="error">
      <AppenderRef ref="Console"/>
    </Root>
  </Loggers>
</Configuration>
```

å°†ä¼šè¾“å‡º

```
17:13:01.540 [main] TRACE com.foo.Bar - entry
17:13:01.540 [main] TRACE com.foo.Bar - entry
17:13:01.540 [main] ERROR com.foo.Bar - Did it again!
17:13:01.540 [main] TRACE com.foo.Bar - exit (false)
17:13:01.540 [main] TRACE com.foo.Bar - exit (false)
17:13:01.540 [main] ERROR MyApp - Didn't do it.
```

æ³¨æ„ `com.foo.bar` çš„ `TRACE` æ—¥å¿—è¢«è¾“å‡ºäº†ä¸¤æ¬¡ã€‚

é¦–å…ˆ `com.foo.Bar` å…³è”çš„ `Logger` æ‰§è¡Œäº†ä¸€æ¬¡ï¼Œç›´æ¥è¾“å‡ºåˆ°æ§åˆ¶å°ã€‚æ¥ä¸‹æ¥è¿™ä¸ª `Logger` çš„çˆ¶èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ `Root Logge`r æ‰§è¡Œäº†å¦ä¸€æ¬¡è¾“å‡ºï¼Œè¿™æ˜¯å› ä¸ºæ—¥å¿—åœ¨ `com.foo.Bar` å·²ç»è¢«è¾“å‡ºï¼Œæ‰€ä»¥ä¹Ÿä¼šè¢«çˆ¶è‡ªåŠ¨è¾“å‡ºåˆ°æ§åˆ¶å°ã€‚è¿™å°±æ˜¯**å¤šä½™æ€§**ï¼Œæœ‰çš„æ—¶å€™**å¤šä½™æ€§**çš„ç¡®æ˜¯éå¸¸ä¾¿æ·çš„åŠŸèƒ½ï¼ˆå‰é¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¢åŠ äº†ä¸€ä¸ª `Logger`ï¼Œä½†æ˜¯æ²¡æœ‰è®¾ç½® `Appender`ï¼Œä½†æ˜¯å´æ­£å¸¸å·¥ä½œäº†ï¼‰ï¼Œæœ‰çš„æ—¶å€™å´ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œå› æ­¤è¿™ä¸ªåŠŸèƒ½åœ¨ `Logger` ä¸­æ˜¯å¯ä»¥é€šè¿‡ `additivity` çš„å±æ€§è¿›è¡Œå…³é—­çš„ï¼ˆè®¾ç½®æˆ falseï¼‰ã€‚

> è¯‘è€…æ³¨ï¼š
>
> é¦–å…ˆ Additivity çš„ç¡®ä¸çŸ¥é“è¯¥ç¿»è¯‘æˆä»€ä¹ˆæ›´åˆé€‚ï¼Œæ„Ÿè§‰ä»€ä¹ˆâ€œé™„åŠ æ€§â€â€œé¢å¤–æ€§â€éƒ½ä¸æ˜¯å¾ˆåˆé€‚ï¼Œæœ€åè§‰å¾—â€œå¤šä½™æ€§â€æ›´è´´åˆ‡äº›ï¼Œå¦‚æœæœ‰å¥½çš„å»ºè®®æœ›æŒ‡æ­£ã€‚
>
> å…¶æ¬¡è¿™ä¸ª**å¤šä½™æ€§**çš„ç‰¹ç‚¹ï¼Œä¸ªäººè®¤ä¸ºä¸»è¦æ˜¯è®©æˆ‘ä»¬ä½¿ç”¨ `Log4j2` çš„æ—¶å€™ä¸ç”¨ä¸ºæ¯ä¸€ä¸ª Logger æŒ‡å®š `Appender` æ–¹ä¾¿é…ç½®ï¼›å½“ç„¶å¦‚æœæƒ³å•ç‹¬æŒ‡å®š `Appender`ï¼Œ`Log4j2` ä¹Ÿæ˜¯æ”¯æŒçš„ã€‚è€Œä¸”å¯ä»¥è®¾ç½®å¼€å…³ã€‚

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Configuration status="WARN">
  <Appenders>
    <Console name="Console" target="SYSTEM_OUT">
      <PatternLayout pattern="%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"/>
    </Console>
  </Appenders>
  <Loggers>
    <Logger name="com.foo.Bar" level="trace" additivity="false">
      <AppenderRef ref="Console"/>
    </Logger>
    <Root level="error">
      <AppenderRef ref="Console"/>
    </Root>
  </Loggers>
</Configuration>
```

ä¸Šé¢é…ç½®çš„è¾“å‡ºï¼ˆè¯‘è€…çš„è¾“å‡ºï¼‰ï¼š

```
16:41:37.116 [main] TRACE com.foo.Bar - Enter
16:41:37.118 [main] ERROR com.foo.Bar - Did it again!
16:41:37.119 [main] TRACE com.foo.Bar - Exit with(false)
16:41:37.119 [main] ERROR com.foo.MyApp - Didn't do it.
```

ä¸€æ—¦ä¸€ä¸ªæ—¥å¿—è¾“å‡ºåˆ°ä¸€ä¸ª `Logger`ï¼Œè¿™ä¸ª `Logger` çš„ `additivity` è®¾ç½®ä¸º `false`ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¥å¿—ä¸ä¼šå†ç»§ç»­å‘çˆ¶ `Logger` è¿›è¡Œä¼ é€’ï¼Œå¿½ç•¥å…¶ä»– `Logger` çš„ `additivity` çš„è®¾ç½®ã€‚

## [å¦‚ä½•æ›´å®‰å…¨åœ°åˆ é™¤æ–‡ä»¶ï¼šä½¿ç”¨è‡ªå®šä¹‰`rmtrash`è„šæœ¬](https://blog.dong4j.site/posts/ae39e951.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œ`rm` å‘½ä»¤æ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§çš„å·¥å…·ï¼Œå®ƒå¯ä»¥æ°¸ä¹…åˆ é™¤æ–‡ä»¶å’Œç›®å½•ã€‚ç„¶è€Œï¼Œè¿™ç§å¼ºå¤§çš„èƒ½åŠ›ä¹Ÿå¸¦æ¥äº†é£é™©ï¼Œå› ä¸ºä¸€æ—¦æ–‡ä»¶è¢«åˆ é™¤ï¼Œå°±å¾ˆéš¾æ¢å¤ã€‚ä¸ºäº†é˜²æ­¢å› è¯¯æ“ä½œè€Œä¸¢å¤±é‡è¦æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„å›æ”¶ç«™æ¥ä¿å­˜è¢«åˆ é™¤çš„æ–‡ä»¶ã€‚ä»¥ä¸‹æ˜¯å®ç°è¿™ä¸€åŠŸèƒ½çš„è¯¦ç»†æ­¥éª¤å’Œè„šæœ¬ã€‚

## èƒŒæ™¯

ä½œä¸º Ubuntu çš„ç”¨æˆ·ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦åœ¨å‘½ä»¤è¡Œä¸‹æ‰§è¡Œæ–‡ä»¶åˆ é™¤æ“ä½œã€‚ä½†æ˜¯ï¼Œå‘½ä»¤è¡Œä¸‹çš„ `rm` å‘½ä»¤ä¸€æ—¦æ‰§è¡Œï¼Œè¢«åˆ é™¤çš„æ–‡ä»¶å‡ ä¹ä¸å¯èƒ½æ¢å¤ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªç®€å•çš„è„šæœ¬ï¼Œå°†åˆ é™¤æ“ä½œæ”¹ä¸ºç§»åŠ¨æ“ä½œï¼Œä»è€Œå®ç°äº†ä¸€ä¸ªç±»ä¼¼äº Windows ç³»ç»Ÿä¸­å›æ”¶ç«™çš„åŠŸèƒ½ã€‚

## è„šæœ¬ä»‹ç»

ä¸‹é¢æä¾›çš„è„šæœ¬ `rmtrash` å¯ä»¥ä½œä¸º `rm` å‘½ä»¤çš„æ›¿ä»£å“ã€‚å®ƒå°†ç”¨æˆ·æŒ‡å®šçš„æ–‡ä»¶æˆ–ç›®å½•ç§»åŠ¨åˆ°ä¸€ä¸ªç‰¹å®šçš„â€œå›æ”¶ç«™â€ç›®å½•ä¸­ï¼Œè€Œä¸æ˜¯ç›´æ¥åˆ é™¤å®ƒä»¬ã€‚è¿™æ ·ï¼Œå¦‚æœéœ€è¦ï¼Œç”¨æˆ·å¯ä»¥ä»å›æ”¶ç«™ä¸­æ¢å¤è¿™äº›æ–‡ä»¶ã€‚

### è„šæœ¬åŠŸèƒ½

- **ç§»åŠ¨æ–‡ä»¶åˆ°å›æ”¶ç«™**ï¼šè€Œä¸æ˜¯ç›´æ¥åˆ é™¤æ–‡ä»¶ï¼Œè„šæœ¬ä¼šå°†å®ƒä»¬ç§»åŠ¨åˆ°ç”¨æˆ·å®¶ç›®å½•ä¸‹çš„ `.rmtrash/` ç›®å½•ã€‚
- **è®°å½•åˆ é™¤æ“ä½œ**ï¼šè„šæœ¬ä¼šè®°å½•æ‰€æœ‰åˆ é™¤æ“ä½œçš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬åˆ é™¤çš„æ–‡ä»¶è·¯å¾„å’Œæ—¶é—´ï¼Œä»¥ä¾¿äºæ¢å¤ã€‚
- **æ¢å¤æ–‡ä»¶**ï¼šå¯ä»¥ä»å›æ”¶ç«™ä¸­æ¢å¤æ–‡ä»¶åˆ°åŸå§‹ä½ç½®ã€‚
- **æ¸…ç©ºå›æ”¶ç«™**ï¼šå½“ç¡®è®¤ä¸å†éœ€è¦å›æ”¶ç«™ä¸­çš„æ–‡ä»¶æ—¶ï¼Œå¯ä»¥æ¸…ç©ºå›æ”¶ç«™ã€‚
- **æŸ¥çœ‹å›æ”¶ç«™å†…å®¹**ï¼šå¯ä»¥åˆ—å‡ºå›æ”¶ç«™ä¸­çš„æ‰€æœ‰æ–‡ä»¶å’Œç›®å½•ã€‚
- **è¯¦ç»†æ—¥å¿—**ï¼šå¯ä»¥æŸ¥çœ‹å·²åˆ é™¤æ–‡ä»¶çš„è¯¦ç»†æ—¥å¿—ã€‚

## è„šæœ¬

```shell
#!/bin/bash

###trashç›®å½•define
realrm="/bin/rm"
trash_dir=~/.rmtrash/
trash_log=~/.rmtrash.log
###åˆ¤æ–­trashç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
if [ ! -d $trash_dir ] ;then
	mkdir -v $trash_dir
fi

####function define
###usage function
rm_usage () {
	cat <<EOF
Usage1: `basename $0` file1 [file2] [dir3] [....] åˆ é™¤æ–‡ä»¶æˆ–ç›®å½•, å¹¶å°†å®ƒä»¬ç§»åŠ¨åˆ° rmtrash å›æ”¶ç«™
Usage2: rm         file1 [file2] [dir3] [....] åˆ é™¤æ–‡ä»¶æˆ–ç›®å½•, å¹¶å°†å®ƒä»¬ç§»åŠ¨åˆ° rmtrash å›æ”¶ç«™
        rm is alias to `basename $0`.
options:
	-f  ç§»åŠ¨ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶åˆ° rmtrash å›æ”¶ç«™
	-r  ç§»åŠ¨ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶åˆ° rmtrash å›æ”¶ç«™
	-fr ç§»åŠ¨ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶åˆ° rmtrash å›æ”¶ç«™
	-rf ç§»åŠ¨ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶åˆ° rmtrash å›æ”¶ç«™
	-R  å°†æ‰€é€‰æ–‡ä»¶ä» rmtrash å›æ”¶ç«™æ¢å¤åˆ°åŸè·¯å¾„
	-l  åˆ—å‡º rmtrash å›æ”¶ç«™çš„å†…å®¹
	-i  æ˜¾ç¤ºå·²åˆ é™¤æ–‡ä»¶å†å²çš„è¯¦ç»†æ—¥å¿—
	-d  æ ¹æ®ç”¨æˆ·è¾“å…¥çš„æ–‡ä»¶åä»å›æ”¶ç«™åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶
	-e  æ¸…ç©º rmtrash å›æ”¶ç«™
	-h  æ˜¾ç¤ºæ­¤å¸®åŠ©èœå•
EOF
}


###rm mv function
rm_mv () {
	echo ----------------------------
	now=`date +%Y%m%d_%H:%M:%S`
	dupfix=.`date +%Y%m%d%H%M%S`
	###å°†ç”¨æˆ·è¾“å…¥çš„æ–‡ä»¶å¾ªç¯mvåˆ°trashä¸­
	###for file in $file_list ;do
		#echo $file
		###æå–ç”¨æˆ·è¾“å…¥å‚æ•°çš„æ–‡ä»¶åã€ç›®å½•åï¼Œæ‹¼å‡ºç»å¯¹è·¯å¾„
		file_name=`basename $file`
		file_dir=$(cd `dirname $file`;pwd)
		file_fullpath=$file_dir/$file_name
		###åˆ¤æ–­è¦åˆ é™¤çš„æ–‡ä»¶æˆ–è€…ç›®å½•å¤§å°æ˜¯å¦è¶…è¿‡2G
		#echo file_fullpath: $file_fullpath
		#if [[ "$file_fullpath" == "/*" ]];then
		#	echo action deny!
		#else
		####åˆ¤æ–­å³å°†åˆ é™¤çš„æ–‡ä»¶åœ¨trashç›®å½•é‡Œæ˜¯å¦å·²å­˜åœ¨
		if [[ `ls $trash_dir|grep ^${file_name}$` ]];then
			##å·²å­˜åœ¨ï¼Œæ–‡ä»¶åé‡å¤ï¼Œéœ€è¦renameï¼Œæƒ³åŸå§‹åçš„åŸºç¡€ä¸ŠåŠ åç¼€
			trash_dest_path=$trash_dir$file_name$dupfix
			echo trashç›®å½•é‡Œå·²å­˜åœ¨$file_name,éœ€è¦rename $file_name$dupfix
		else
			##ä¸é‡åï¼Œç›´æ¥æŒ‰åŸå§‹æ–‡ä»¶åä¿å­˜
			trash_dest_path=$trash_dir$file_name
		fi
			###mvæˆåŠŸè®°å½•log,è®°å½•åˆ é™¤æ—¶çš„æ–‡ä»¶ã€ç›®å½•çš„è·¯å¾„ç­‰ä¿¡æ¯åˆ°logï¼Œä»¥ä¾¿æ¢å¤æ•°æ®
			mv $file_fullpath $trash_dest_path && \
			echo $now `whoami` moved from $file_fullpath to $trash_dest_path >> $trash_log && \
			echo -e "\033[31m\033[05m $file ä» $file_fullpath è¢«åˆ é™¤\033[0m"
			#cat $trash_log
		#fi
	###done
}

###rm list function
rm_list () {
	echo ----------------------------
	echo list trash_dir contents:
	ls $trash_dir
}


###rm restore function
rm_restore () {
	echo ----------------------------
	echo -en "è¯·é€‰æ‹©è¦æ¢å¤çš„æ–‡ä»¶å(å¤šä¸ªæ–‡ä»¶ä¸­é—´ç©ºæ ¼åˆ†éš”,å–æ¶ˆctl+c):"
	read reply
	for file in $reply ;do
		###åˆ¤æ–­åŸå§‹ä½ç½®çš„æ˜¯å¦æœ‰åŒåæ–‡ä»¶å­˜åœ¨
		originalpath=`cat $trash_log|grep /$file$|awk  '{print $5}'`
		if [[ `ls $originalpath` ]];then
			echo -en "originalpath:$originalpath å·²ç»å­˜åœ¨ã€‚æ˜¯å¦ç»§ç»­è¦†ç›–(y/n):"
			read ack
			if   [[ $ack == y ]];then
				echo restore:
			elif [[ $ack == n ]];then
				echo bye && exit
			else
				echo è¾“å…¥éæ³• && exit
			fi
		fi
		###
		mv $trash_dir$file  $originalpath && \
		###linuxå’Œmacä¸‹sedçš„ç”¨æ³•æœ‰ç»†å¾®å·®åˆ«ï¼Œæ•…éœ€é€šè¿‡æ“ä½œç³»ç»Ÿç±»å‹è¿›è¡Œé€‰æ‹©å¯¹åº”çš„sedæ ¼å¼
		if [[ $os_type == Darwin ]];then
			sed -i .bak "/\/$file$/d" $trash_log
			echo os_type=Darwin
		elif [[ $os_type == Linux ]];then
			sed -i.bak "/\/$file$/d" $trash_log
			echo os_type=Linux
		fi && \
		echo -e  "\033[32m\033[05m$file ä» $originalpath æ¢å¤æˆåŠŸ\033[0m"
	done
}

### rm show delete log function
rm_infolog () {
	echo ----------------------------
	echo detailed deleted file log:
	cat $trash_log
}


###rm empty trash function
rm_empty () {
	echo ----------------------------
	echo -en "ç©ºå›æ”¶ç«™ï¼Œå›æ”¶ç«™ä¸­çš„æ‰€æœ‰å¤‡ä»½å°†è¢«åˆ é™¤ï¼Œæ˜¯å¦ç»§ç»­(y/n):"
	read ack
	if   [[ $ack == y ]];then
		echo begin to empty trash:
	elif [[ $ack == n ]];then
		echo bye && exit
	else
		echo è¾“å…¥éæ³• && exit
	fi
	/bin/rm -fr ${trash_dir} && \
	echo >$trash_log && \
	echo -e "\033[31m\033[05m åƒåœ¾æ¡¶å·²ç»è¢«æ¸…ç©ºäº†\033[0m"
}

###rm delete function
rm_delete () {
	echo ----------------------------
	echo -en "è¯·é€‰æ‹©trashä¸­è¦åˆ é™¤çš„æ–‡ä»¶å(å¤šä¸ªæ–‡ä»¶ä¸­é—´ç©ºæ ¼åˆ†éš”,å–æ¶ˆctl+c):"
	read reply
		for file in $reply ;do
			###if file exist then delete it from trash
			if [[ `ls ${trash_dir}$file` ]];then
				/bin/rm -fr ${trash_dir}$file && \
				###linuxå’Œmacä¸‹sedçš„ç”¨æ³•æœ‰ç»†å¾®å·®åˆ«ï¼Œæ•…éœ€é€šè¿‡æ“ä½œç³»ç»Ÿç±»å‹è¿›è¡Œé€‰æ‹©å¯¹åº”çš„sedæ ¼å¼
				if [[ $os_type == Darwin ]];then
					sed -i .bak "/\/$file$/d" $trash_log
					echo os_type=Darwin
				elif [[ $os_type == Linux ]];then
					sed -i.bak "/\/$file$/d" $trash_log
					echo os_type=Linux
				fi && \
					echo -e  "\033[32m\033[05m$file ä» ${trash_dir}$file è¢«åˆ é™¤\033[0m"
			else
				echo $file is not exist in $trash_dir
			fi
		done
}


###è·¨åˆ†åŒºçš„é—®é¢˜

#####ä¸»ç¨‹åºå¼€å§‹
###å‚æ•°ä¸ªæ•°ä¸º0ï¼Œè¾“å‡ºhelp
if [ $# -eq 0 ] ;then rm_usage ;fi
###æ ¹æ®ç”¨æˆ·è¾“å…¥é€‰é¡¹æ‰§è¡Œç›¸åº”åŠ¨ä½œ
###é€šè¿‡éæ˜¾ç¤ºçš„æ–¹å¼(åŠ å…¥fré€‰é¡¹ï¼Œä½†åœ¨caseé‡Œä¸åšåŒ¹é…æ“ä½œï¼Œé‡åˆ°å«-fr/-rf/-f/-ræ—¶ç›´æ¥åˆ é™¤)æ”¯æŒå¾ˆå¤šç”¨æˆ·çš„ä½¿ç”¨ä¹ æƒ¯rm -fr file,rm -rf file
while getopts lRiedhfr option ;do
case "$option" in
		l) rm_list;;
		R) rm_list
		   rm_restore;;
		i) rm_infolog;;
		h) rm_usage;;
		e) rm_empty;;
		d) rm_list
		   rm_delete;;
		\?)rm_usage
		   exit 1;;
	esac
done
shift $((OPTIND-1))

###å°†æ–‡ä»¶åçš„å‚æ•°ä¾æ¬¡ä¼ é€’ç»™rm_mvå‡½æ•°
while [ $# -ne 0 ];do
	file=$1
	echo file=$file
	rm_mv
	shift
done

```

### å®‰è£…è„šæœ¬

1. å°†ä¸Šé¢çš„è„šæœ¬ä¿å­˜ä¸ºä¸€ä¸ªæ–‡ä»¶ï¼Œä¾‹å¦‚ `rmtrash`ã€‚
2. å°†è¯¥è„šæœ¬ç§»åŠ¨åˆ° `/usr/local/bin/` ç›®å½•ä¸‹ï¼Œä½¿å…¶å…¨å±€å¯æ‰§è¡Œï¼š

   ```bash
   sudo mv rmtrash /usr/local/bin/
   sudo chmod +x /usr/local/bin/rmtrash
   ```

3. ä½¿ç”¨åˆ«åæ›¿æ¢åŸ `rm` å‘½ä»¤ï¼š

   ```bash
   alias rm='rmtrash'
   ```

   å°†ä¸Šè¿°åˆ«åæ·»åŠ åˆ°ä½ çš„ `.bashrc` æˆ– `.bash_profile` æ–‡ä»¶ä¸­ï¼Œä»¥ä¾¿åœ¨æ¯æ¬¡ç™»å½•æ—¶è‡ªåŠ¨è®¾ç½®ã€‚

### ä½¿ç”¨è„šæœ¬

ç°åœ¨ï¼Œä½ å¯ä»¥åƒä½¿ç”¨ `rm` å‘½ä»¤ä¸€æ ·ä½¿ç”¨ `rmtrash`ã€‚ä¾‹å¦‚ï¼Œåˆ é™¤ä¸€ä¸ªæ–‡ä»¶ï¼š

```bash
rm file.txt
```

è¿™å°†æŠŠ `file.txt` ç§»åŠ¨åˆ°å›æ”¶ç«™ï¼Œè€Œä¸æ˜¯ç›´æ¥åˆ é™¤å®ƒã€‚

### æ¢å¤æ–‡ä»¶

å¦‚æœä½ æƒ³ä»å›æ”¶ç«™æ¢å¤æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ `-R` é€‰é¡¹ï¼š

```bash
rm -R file.txt
```

è¿™å°†æç¤ºä½ é€‰æ‹©è¦æ¢å¤çš„æ–‡ä»¶ã€‚

### æ¸…ç©ºå›æ”¶ç«™

å½“ä½ ç¡®å®šå›æ”¶ç«™ä¸­çš„æ–‡ä»¶ä¸å†éœ€è¦æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ `-e` é€‰é¡¹æ¸…ç©ºå›æ”¶ç«™ï¼š

```bash
rm -e
```

## [Log4j2æ·±åº¦å‰–æï¼šä»åŸºç¡€åˆ°å¼‚æ­¥ä¼˜åŒ–](https://blog.dong4j.site/posts/d9189394.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

> Apache Log4j 2 æ˜¯å¯¹ Log4j çš„å‡çº§ï¼Œå®ƒæ¯”å…¶å‰èº« Log4j 1.x æä¾›äº†é‡å¤§æ”¹è¿›ï¼Œå¹¶æä¾›äº† Logback ä¸­å¯ç”¨çš„è®¸å¤šæ”¹è¿›ï¼ŒåŒæ—¶ä¿®å¤äº† Logback æ¶æ„ä¸­çš„ä¸€äº›å›ºæœ‰é—®é¢˜ã€‚

log4j2 æ˜¯ log4j 1.x çš„å‡çº§ç‰ˆï¼Œå‚è€ƒäº† logback çš„ä¸€äº›ä¼˜ç§€çš„è®¾è®¡ï¼Œå¹¶ä¸”ä¿®å¤äº†ä¸€äº›é—®é¢˜ï¼Œå› æ­¤å¸¦æ¥äº†ä¸€äº›é‡å¤§çš„æå‡ï¼Œä¸»è¦æœ‰ï¼š

ä¸»è¦ç‰¹ç‚¹

![20241229154732_VGcdp3Tk.webp](https://cdn.dong4j.site/source/image/20241229154732_VGcdp3Tk.webp)

- å¼‚å¸¸å¤„ç†ï¼Œåœ¨çš„ logback ä¸­ï¼Œè¿½åŠ ç¨‹åºä¸­çš„å¼‚å¸¸ä¸ä¼šè¢«åº”ç”¨æ„ŸçŸ¥åˆ°ï¼Œä½†æ˜¯åœ¨ log4j2 ä¸­ï¼Œæä¾›äº†ä¸€äº›å¼‚å¸¸å¤„ç†æœºåˆ¶ã€‚
- æ€§èƒ½æå‡ï¼Œlog4j2 ç›¸æ¯”äº log4j 1 å’Œ logback éƒ½å…·æœ‰å¾ˆæ˜æ˜¾çš„æ€§èƒ½æå‡ï¼Œåé¢ä¼šæœ‰å®˜æ–¹æµ‹è¯•çš„æ•°æ®ã€‚
- è‡ªåŠ¨é‡è½½é…ç½®ï¼Œå‚è€ƒäº†çš„ logback çš„è®¾è®¡ï¼Œå½“ç„¶ä¼šæä¾›è‡ªåŠ¨åˆ·æ–°å‚æ•°é…ç½®ï¼Œæœ€å®ç”¨çš„å°±æ˜¯æˆ‘ä»¬åœ¨ç”Ÿäº§ä¸Šå¯ä»¥åŠ¨æ€çš„ä¿®æ”¹æ—¥å¿—çš„çº§åˆ«è€Œä¸éœ€è¦é‡å¯åº”ç”¨ - é‚£å¯¹ç›‘æ§æ¥è¯´ï¼Œæ˜¯éå¸¸æ•æ„Ÿçš„ã€‚
- æ— åƒåœ¾æœºåˆ¶ï¼Œlog4j2 åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œéƒ½å¯ä»¥ä½¿ç”¨å…¶è®¾è®¡çš„ä¸€å¥—æ— åƒåœ¾æœºåˆ¶ï¼Œé¿å…é¢‘ç¹çš„æ—¥å¿—æ”¶é›†å¯¼è‡´çš„ jvm gcã€‚

### ä¸€äº›æ¦‚å¿µ

ä¹‹å‰çœ‹å®˜æ–¹æ–‡æ¡£æ‘˜æŠ„äº†ä¸€äº›æ¦‚å¿µï¼Œè¿™é‡Œæ‡’å¾—ç¿»è¯‘äº†ï¼Œä½¿ç”¨çš„ log4j çš„éƒ½åº”è¯¥æ¸…æ¥šï¼Œè¿™é‡Œåªæ˜¯æ ‡è®°ä¸‹ã€‚

![20241229154732_2lG4dJzx.webp](https://cdn.dong4j.site/source/image/20241229154732_2lG4dJzx.webp)

#### ä¸¾ä¸ªæ —å­

```xml
<Configuration status="debug" packages="org.apache.logging.log4j.test">
  <Properties>
    <Property name="filename">target/test.log</Property>
  </Properties>
  <Filter type="ThresholdFilter" level="trace"/>
  <Appenders>
    <Appender type="Console" name="STDOUT">
      <Layout type="PatternLayout" pattern="%m MDC%X%n"/>
      <Filters>
        <Filter type="MarkerFilter" marker="FLOW" onMatch="DENY" onMismatch="NEUTRAL"/>
        <Filter type="MarkerFilter" marker="EXCEPTION" onMatch="DENY" onMismatch="ACCEPT"/>
      </Filters>
    </Appender>
    <Appender type="Console" name="FLOW">
      <Layout type="PatternLayout" pattern="%C{1}.%M %m %ex%n"/><!-- class and line number -->
      <Filters>
        <Filter type="MarkerFilter" marker="FLOW" onMatch="ACCEPT" onMismatch="NEUTRAL"/>
        <Filter type="MarkerFilter" marker="EXCEPTION" onMatch="ACCEPT" onMismatch="DENY"/>
      </Filters>
    </Appender>
    <Appender type="File" name="File" fileName="${filename}">
      <Layout type="PatternLayout">
        <Pattern>%d %p %C{1.} [%t] %m%n</Pattern>
      </Layout>
    </Appender>
  </Appenders>

  <Loggers>
    <Logger name="org.apache.logging.log4j.test1" level="debug" additivity="false">
      <Filter type="ThreadContextMapFilter">
        <KeyValuePair key="test" value="123"/>
      </Filter>
      <AppenderRef ref="STDOUT"/>
    </Logger>
    <Logger name="org.apache.logging.log4j.test2" level="debug" additivity="false">
      <AppenderRef ref="File"/>
    </Logger>
    <Root level="trace">
      <AppenderRef ref="STDOUT"/>
    </Root>
  </Loggers>
</Configuration>

```

## å¼‚æ­¥æ—¥å¿—

log4j2 æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯å¼‚æ­¥æ—¥å¿—ï¼Œå…¶æ€§èƒ½çš„æå‡ä¸»è¦ä¹Ÿæ˜¯ä»å¼‚æ­¥æ—¥å¿—ä¸­å—ç›Šï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ log4j2 çš„å¼‚æ­¥æ—¥å¿—ã€‚

Log4j2 æä¾›äº†ä¸¤ç§å®ç°æ—¥å¿—çš„æ–¹å¼ï¼Œä¸€ä¸ªæ˜¯é€šè¿‡ AsyncAppenderï¼Œä¸€ä¸ªæ˜¯é€šè¿‡ AsyncLoggerï¼Œåˆ†åˆ«å¯¹åº”å‰é¢æˆ‘ä»¬è¯´çš„è¿½åŠ ç¨‹åºç»„ä»¶å’Œè®°å½•å™¨ç»„ä»¶ã€‚æ³¨æ„è¿™æ˜¯ä¸¤ç§ä¸åŒçš„å®ç°æ–¹å¼ï¼Œåœ¨è®¾è®¡å’Œæºç ä¸Šéƒ½æ˜¯ä¸åŒçš„ä½“ç°ã€‚

### AsyncAppender æ–¹å¼

> AsyncAppender æ¥å—å¯¹å…¶ä»– Appender çš„å¼•ç”¨ï¼Œå¹¶ä½¿ LogEvents åœ¨å•ç‹¬çš„ Thread ä¸Šå†™å…¥å®ƒä»¬ã€‚è¯·æ³¨æ„ï¼Œå†™å…¥è¿™äº› Appender æ—¶çš„å¼‚å¸¸å°†ä»åº”ç”¨ç¨‹åºä¸­éšè—ã€‚åº”è¯¥åœ¨å®ƒå¼•ç”¨çš„ appender ä¹‹åé…ç½® AsyncAppender ä»¥å…è®¸å®ƒæ­£ç¡®å…³é—­ã€‚  
> é»˜è®¤æƒ…å†µä¸‹ï¼ŒAsyncAppender ä½¿ç”¨ java.util.concurrent.ArrayBlockingQueueï¼Œå®ƒä¸éœ€è¦ä»»ä½•å¤–éƒ¨åº“ã€‚è¯·æ³¨æ„ï¼Œå¤šçº¿ç¨‹åº”ç”¨ç¨‹åºåœ¨ä½¿ç”¨æ­¤ appender æ—¶åº”å°å¿ƒï¼šé˜»å¡é˜Ÿåˆ—å®¹æ˜“å—åˆ°é”äº‰ç”¨çš„å½±å“ï¼Œå¹¶ä¸”æˆ‘ä»¬çš„æµ‹è¯•è¡¨æ˜ï¼Œå½“æ›´å¤šçº¿ç¨‹åŒæ—¶è®°å½•æ—¶æ€§èƒ½å¯èƒ½ä¼šå˜å·®ã€‚è€ƒè™‘ä½¿ç”¨æ— é”å¼‚æ­¥è®°å½•å™¨ä»¥è·å¾—æœ€ä½³æ€§èƒ½ã€‚

AsyncAppender æ˜¯é€šè¿‡å¼•ç”¨åˆ«çš„ Appender æ¥å®ç°çš„ï¼Œå½“æœ‰æ—¥å¿—äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œä¼šå¼€å¯å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†å®ƒä»¬ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœåœ¨ Appender çš„æ—¶å€™å‡ºç°å¼‚å¸¸ï¼Œå¯¹åº”ç”¨æ¥è¯´æ˜¯æ— æ³•æ„ŸçŸ¥çš„.AsyncAppender åº”è¯¥åœ¨å®ƒå¼•ç”¨çš„ Appender ä¹‹åé…ç½®ï¼Œé»˜è®¤ä½¿ç”¨ java.util.concurrent.ArrayBlockingQueue å®ç°è€Œä¸éœ€è¦å…¶å®ƒå¤–éƒ¨çš„ç±»åº“ã€‚å½“ä½¿ç”¨æ­¤ Appender çš„æ—¶å€™ï¼Œåœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸‹éœ€è¦æ³¨æ„ï¼Œé˜»å¡é˜Ÿåˆ—å®¹æ˜“å—åˆ°é”äº‰ç”¨çš„å½±å“ï¼Œè¿™å¯èƒ½ä¼šå¯¹æ€§èƒ½äº§ç”Ÿå½±å“ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬åº”è¯¥è€ƒè™‘ä½¿ç”¨æ— æ‰€çš„å¼‚æ­¥è®°å½•å™¨ï¼ˆAsyncLoggerï¼‰ã€‚

#### ä¸¾ä¸ªæ —å­

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Configuration status="warn" name="MyApp" packages="">
  <Appenders>
    <File name="MyFile" fileName="logs/app.log">
      <PatternLayout>
        <Pattern>%d %p %c{1.} [%t] %m%n</Pattern>
      </PatternLayout>
    </File>
    <Async name="Async">
      <AppenderRef ref="MyFile"/>
    </Async>
  </Appenders>
  <Loggers>
    <Root level="error">
      <AppenderRef ref="Async"/>
    </Root>
  </Loggers>
</Configuration>

```

AsyncAppender æœ‰ä¸€äº›é…ç½®é¡¹ï¼Œå¦‚ä¸‹ï¼š

![20241229154732_DE0JrUkE.webp](https://cdn.dong4j.site/source/image/20241229154732_DE0JrUkE.webp)

é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€äº›å…¶ä»–çš„ç»†èŠ‚ï¼Œå¦‚æœæ„Ÿå…´è¶£å¯ä»¥å‚è€ƒå®˜ç½‘æ–‡æ¡£ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€åˆ—ä¸¾äº†ã€‚

### AsyncLogger æ–¹å¼

AsyncLogger æ‰æ˜¯ log4j2 çš„é‡å¤´æˆï¼Œä¹Ÿæ˜¯å®˜æ–¹æ¨èçš„å¼‚æ­¥æ–¹å¼ã€‚å®ƒå¯ä»¥ä½¿å¾—è°ƒç”¨ Logger.log è¿”å›çš„æ›´å¿«ã€‚ä½ å¯ä»¥æœ‰ä¸¤ç§é€‰æ‹©ï¼šå…¨å±€å¼‚æ­¥å’Œæ··åˆå¼‚æ­¥ã€‚

- **å¼‚æ­¥å…¨å±€**å°±æ˜¯ï¼Œæ‰€æœ‰çš„æ—¥å¿—éƒ½å¼‚æ­¥çš„è®°å½•ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸Šä¸ç”¨åšä»»ä½•æ”¹åŠ¨ï¼Œåªéœ€è¦åœ¨ JVM å¯åŠ¨çš„æ—¶å€™å¢åŠ ä¸€ä¸ªå‚æ•°;
- **å¼‚æ­¥æ··åˆ**å°±æ˜¯ï¼Œä½ å¯ä»¥åœ¨åº”ç”¨ä¸­åŒæ—¶ä½¿ç”¨åŒæ­¥æ—¥å¿—å’Œå¼‚æ­¥æ—¥å¿—ï¼Œè¿™ä½¿å¾—æ—¥å¿—çš„é…ç½®æ–¹å¼æ›´åŠ çµæ´»ã€‚å› ä¸º Log4j çš„æ–‡æ¡£ä¸­ä¹Ÿè¯´äº†ï¼Œè™½ç„¶ Log4j2 æä¾›ä»¥ä¸€å¥—å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œå¯ä»¥è¦†ç›–å¤§éƒ¨åˆ†çš„çŠ¶æ€ï¼Œä½†æ˜¯è¿˜æ˜¯ä¼šæœ‰ä¸€å°éƒ¨åˆ†çš„ç‰¹æ®Šæƒ…å†µæ˜¯æ— æ³•å®Œå…¨å¤„ç†çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬å¦‚æœæ˜¯è®°å½•å®¡è®¡æ—¥å¿—ï¼Œé‚£ä¹ˆå®˜æ–¹å°±æ¨èä½¿ç”¨åŒæ­¥æ—¥å¿—çš„æ–¹å¼ï¼Œè€Œå¯¹äºå…¶ä»–çš„ä¸€äº›ä»…ä»…æ˜¯è®°å½•ä¸€ä¸ªç¨‹åºæ—¥å¿—çš„åœ°æ–¹ï¼Œä½¿ç”¨å¼‚æ­¥æ—¥å¿—å°†å¤§å¹…æå‡æ€§èƒ½ï¼Œå‡å°‘å¯¹åº”ç”¨æœ¬èº«çš„å½±å“ã€‚æ··åˆå¼‚æ­¥çš„æ–¹å¼éœ€è¦é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶æ¥å®ç°ï¼Œä½¿ç”¨ AsyncLogger æ ‡è®°é…ç½®ã€‚

#### ä¸¾ä¸ªæ —å­

**å…¨å±€å¼‚æ­¥**

é…ç½®æ–‡ä»¶ä¸ç”¨åŠ¨ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>

<!-- Don't forget to set system property
-Dlog4j2.contextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector
     to make all loggers asynchronous. -->

<Configuration status="WARN">
  <Appenders>
    <!-- Async Loggers will auto-flush in batches, so switch off immediateFlush. -->
    <RandomAccessFile name="RandomAccessFile" fileName="async.log" immediateFlush="false" append="false">
      <PatternLayout>
        <Pattern>%d %p %c{1.} [%t] %m %ex%n</Pattern>
      </PatternLayout>
    </RandomAccessFile>
  </Appenders>
  <Loggers>
    <Root level="info" includeLocation="false">
      <AppenderRef ref="RandomAccessFile"/>
    </Root>
  </Loggers>
</Configuration>

```

åœ¨ç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶å€™ï¼Œå¢åŠ å…¨å±€å‚æ•°é…ç½®ï¼š

```java
System.setProperty("log4j2.contextSelector, "org.apache.logging.log4j.core.async.AsyncLoggerContextSelector");

```

ä½ å¯ä»¥åœ¨ä½ ç¬¬ä¸€æ¬¡è·å–è®°å½•å™¨ä¹‹å‰è®¾ç½®ï¼Œä¹Ÿå¯ä»¥åŠ è½½ JVM å¯åŠ¨å‚æ•°é‡Œï¼Œç±»ä¼¼

```shell
java -Dog4j2.contextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector

```

**æ··åˆå¼‚æ­¥**

æ··åˆå¼‚æ­¥åªéœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>

<!-- No need to set system property "log4j2.contextSelector" to any value
     when using <asyncLogger> or <asyncRoot>. -->

<Configuration status="WARN">
  <Appenders>
    <!-- Async Loggers will auto-flush in batches, so switch off immediateFlush. -->
    <RandomAccessFile name="RandomAccessFile" fileName="asyncWithLocation.log"
              immediateFlush="false" append="false">
      <PatternLayout>
        <Pattern>%d %p %class{1.} [%t] %location %m %ex%n</Pattern>
      </PatternLayout>
    </RandomAccessFile>
  </Appenders>
  <Loggers>
    <!-- pattern layout actually uses location, so we need to include it -->
    <AsyncLogger name="com.foo.Bar" level="trace" includeLocation="true">
      <AppenderRef ref="RandomAccessFile"/>
    </AsyncLogger>
    <Root level="info" includeLocation="true">
      <AppenderRef ref="RandomAccessFile"/>
    </Root>
  </Loggers>
</Configuration>

```

åœ¨ä¸Šé¢ç¤ºä¾‹çš„é…ç½®ä¸­ï¼Œroot logger å°±æ˜¯åŒæ­¥çš„ï¼Œä½†æ˜¯ com.foo.Bar çš„ logger å°±æ˜¯å¼‚æ­¥çš„ã€‚

### ä½¿ç”¨ Log4j çš„æ—¥å¿—çš„æ³¨æ„äº‹é¡¹

åœ¨ä½¿ç”¨å¼‚æ­¥æ—¥å¿—çš„æ—¶å€™éœ€è¦æ³¨æ„ä¸€äº›äº‹é¡¹ï¼Œå¦‚ä¸‹ï¼š

1. ä¸è¦åŒæ—¶ä½¿ç”¨ AsyncAppender å’Œ AsyncLoggerï¼Œä¹Ÿå°±æ˜¯åœ¨é…ç½®ä¸­ä¸è¦åœ¨é…ç½®è¿½åŠ ç¨‹åºçš„æ—¶å€™ï¼Œä½¿ç”¨å¼‚æ­¥æ ‡è¯†çš„åŒæ—¶ï¼Œåˆé…ç½® AsyncLoggerï¼Œè¿™ä¸ä¼šæŠ¥é”™ï¼Œä½†æ˜¯å¯¹äºæ€§èƒ½æå‡æ²¡æœ‰ä»»ä½•å¥½å¤„ã€‚
2. ä¸è¦åœ¨å¼€å¯äº†å…¨å±€åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œä»ç„¶ä½¿ç”¨ AsyncAppender å’Œ AsyncLoggerã€‚è¿™å’Œä¸Šä¸€æ¡æ˜¯åŒä¸€ä¸ªæ„æ€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä½¿ç”¨å¼‚æ­¥æ—¥å¿—ï¼ŒAsyncAppenderï¼ŒAsyncLogger å’Œå…¨å±€æ—¥å¿—ï¼Œä¸è¦åŒæ—¶å‡ºç°ã€‚
3. å¦‚æœä¸æ˜¯ååˆ†å¿…é¡»ï¼Œä¸ç®¡æ˜¯åŒæ­¥å¼‚æ­¥ï¼Œéƒ½è®¾ç½® immediateFlush ä¸ºå‡ï¼Œè¿™ä¼šå¯¹æ€§èƒ½æå‡æœ‰å¾ˆå¤§å¸®åŠ©ã€‚

4ï¼Œå¦‚æœä¸æ˜¯ç¡®å®éœ€è¦ï¼Œä¸è¦æ‰“å°ä½ç½®ä¿¡æ¯ï¼Œæ¯”å¦‚ HTML çš„ä½ç½®ï¼Œæˆ–è€…æ¨¡å¼æ¨¡å¼é‡Œçš„ï¼…C æˆ– $ classï¼Œï¼…F æˆ–ï¼…æ–‡ä»¶ï¼Œï¼…l æˆ–ï¼…ä½ç½®ï¼Œï¼…L æˆ–ï¼…è¡Œï¼Œï¼…M æˆ–ï¼…æ–¹æ³•ï¼Œç­‰ï¼Œå› ä¸º Log4j éœ€è¦åœ¨æ‰“å°æ—¥å¿—çš„æ—¶å€™åšä¸€æ¬¡æ ˆçš„å¿«ç…§æ‰èƒ½è·å–è¿™äº›ä¿¡æ¯ï¼Œè¿™å¯¹äºæ€§èƒ½æ¥è¯´æ˜¯ä¸ªæå¤§çš„æŸè€—ã€‚

## æ€§èƒ½æå‡

å…³äºæ€§èƒ½æµ‹è¯•ï¼Œå¤§å®¶å¯ä»¥ç›´å¥”å®˜ç½‘ï¼Œå“ªé‡Œæœ‰å¾ˆè¯¦ç»†çš„æ•°æ®ï¼Œè¿™é‡Œç»™ä¸ªå›¾ï¼š

![20241229154732_wKN6woCU.webp](https://cdn.dong4j.site/source/image/20241229154732_wKN6woCU.webp)

![20241229154732_odaxOX5b.webp](https://cdn.dong4j.site/source/image/20241229154732_odaxOX5b.webp)

è™½ç„¶æˆ‘æµ‹ä¸‹æ¥ï¼Œåœ¨ immediateFlush è®¾ç½®ä¸ºå‡çš„æƒ…å†µä¸‹ï¼ŒåŒæ­¥å¼‚æ­¥å·®ä¸äº†å¤šå°‘ï¼Œä½†å¯èƒ½æ˜¯æˆ‘çš„æµ‹è¯•æ¡ä»¶ä¸ç¬¦åˆå®˜æ–¹çš„ï¼Œä»è®¾è®¡å’ŒåŸç†ä¸Šæ¥è¯´ï¼Œå¼‚æ­¥æ—¥å¿—ï¼Œæ— ç–‘æ˜¯ä¸ªæœ€ä¼˜çš„é€‰æ‹©ã€‚

## å°ç»“

æ€»çš„æ¥è¯´ï¼Œçœ‹äº†ä¸€éçš„ log4j çš„å®˜ç½‘æ–‡æ¡£ï¼Œå¯¹æ—¥å¿—ç³»ç»Ÿæœ‰äº†ä¸ªæ¯”è¾ƒå…¨é¢çš„äº†è§£ï¼Œä»¥å‰åªæ˜¯å¤åˆ¶é…ç½®æ¥æ”¹æ”¹ï¼Œæ²¡å…³æ³¨è¿‡å¾ˆå¤šç»†èŠ‚ï¼Œè¿™æ¬¡ç®—æ˜¯æ‰«ç›²äº†ä¸€æ¬¡ã€‚æ–‡ç« ä¹Ÿåªæ˜¯åšäº†ä¸ªä»‹ç»ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œè¿˜æ˜¯è¦ç»†ç»†ç ”ç©¶ä¸‹é…ç½®ã€‚

å¦å¤–ï¼Œä¸ªäººè§‰å¾—å¼‚æ­¥æ¨¡å¼æ— éå°±æ˜¯åœ¨åŸæ¥åŒæ­¥å†™ç›˜çš„å‰æä¸‹ï¼Œå¢åŠ æ¶ˆæ¯é˜Ÿåˆ—ä½œä¸ºç¼“å­˜ï¼Œæˆ–è€…äº¤ä¸ªå¦ä¸€ä¸ªçº¿ç¨‹å»åšï¼Œè¿™ç†è®ºä¸Šé™¤äº†å¸¦æ¥ä¸€äº›é¢å¤–çš„ï¼Œè¾ƒå°çš„ CPU å’Œå†…å­˜çš„å¼€é”€ï¼Œåº”è¯¥ä¼šåœ¨é«˜æµé‡çš„æ—¶å€™å¸¦æ¥ä¸å°çš„æ€§èƒ½æå‡ï¼Œå¯¹æ¯”ä¸‹æ¥ï¼Œlog4j2 æ— ç–‘æ˜¯å½“ä¸‹æœ€å€¼å¾—ä½¿ç”¨çš„æ—¥å¿—ç»„ä»¶æ¥ï¼Œä¸”å¯ä»¥ä½¿ç”¨å…¶å¼‚æ­¥æ¨¡å¼ã€‚

å½“ç„¶äº†ï¼Œä¹Ÿä¸èƒ½è¯´å¼‚æ­¥å°±ä¸€å®šå¥½ï¼Œå¦‚æœæ—¥å¿—çš„æµé‡ä¸æ˜¯ç‰¹åˆ«å¤§ï¼Œç£ç›˜æ€§èƒ½åˆè·Ÿå¾—ä¸Šï¼Œæ²¡æœ‰å¿…è¦ä¸€å®šä½¿ç”¨å¼‚æ­¥æ—¥å¿—ã€‚

## [Node.js ç‰ˆæœ¬ç®¡ç†ï¼šä»å…¥é—¨åˆ°ç²¾é€š](https://blog.dong4j.site/posts/19e627d5.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œæ—¶ç¯å¢ƒï¼Œå¹¿æ³›ç”¨äºæ„å»ºç½‘ç»œåº”ç”¨ç¨‹åºã€‚å®ƒå…è®¸å¼€å‘è€…ä½¿ç”¨ JavaScript æ¥ç¼–å†™æœåŠ¡å™¨ç«¯ä»£ç ã€‚æœ¬æ–‡å°†ä¸ºä½ æä¾› Node.js çš„å…¥é—¨æ­¥éª¤ä»¥åŠä¸€äº›å®ç”¨å·¥å…·çš„ä½¿ç”¨ã€‚

## å®‰è£… Node.js

### 1. å®‰è£… n æ¨¡å—

é¦–å…ˆï¼Œä½ éœ€è¦å®‰è£… `n` æ¨¡å—ï¼Œè¿™æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼Œå¯ä»¥æ–¹ä¾¿åœ°ç®¡ç†å¤šä¸ª Node.js ç‰ˆæœ¬ã€‚

```bash
sudo npm install -g n
```

### 2. æ›´æ–°åˆ°æœ€æ–°ç¨³å®šç‰ˆ

ä½¿ç”¨ `n` å¯ä»¥è½»æ¾å‡çº§åˆ°æœ€æ–°çš„ Node.js ç¨³å®šç‰ˆï¼š

```bash
sudo n stable
```

### 3. å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬

å¦‚æœä½ æƒ³è¦å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ Node.jsï¼Œæ— è®ºæ˜¯ç¨³å®šç‰ˆè¿˜æ˜¯é•¿æœŸæ”¯æŒï¼ˆLTSï¼‰ç‰ˆï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
sudo n latest
```

### 4. å®‰è£…æŒ‡å®šç‰ˆæœ¬

`n` è¿˜å…è®¸ä½ å®‰è£…ä»»æ„å†å²ç‰ˆæœ¬çš„ Node.jsã€‚ä½ å¯ä»¥ä½¿ç”¨ç‰ˆæœ¬å·æ¥å‡çº§åˆ°ç‰¹å®šçš„ç‰ˆæœ¬ï¼š

```bash
sudo n v0.10.26 æˆ– sudo n 0.10.26
```

### 5. åˆ‡æ¢ç‰ˆæœ¬

è¦åˆ‡æ¢åˆ°æŸä¸ªç‰¹å®šçš„ Node.js ç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
sudo n 7.10.0
```

### 6. åˆ é™¤æŒ‡å®šç‰ˆæœ¬

å¦‚æœä½ æƒ³è¦åˆ é™¤ä¸€ä¸ªä¸å†éœ€è¦çš„æ—§ç‰ˆæœ¬çš„ Node.jsï¼Œå¯ä»¥ä½¿ç”¨ `rm` å‘½ä»¤ï¼š

```bash
sudo n rm 7.10.0
```

### 7. ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬è¿è¡Œè„šæœ¬

å½“ä½ éœ€è¦ä½¿ç”¨æŸä¸ªç‰¹å®šç‰ˆæœ¬çš„ Node.js æ¥æ‰§è¡Œè„šæœ¬æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ `use` å‘½ä»¤ï¼š

```bash
n use 7.10.0 some.js
```

## ä½¿ç”¨ http-server æ¨¡å—

http-server æ˜¯ä¸€ä¸ªç®€å•çš„é™æ€æ–‡ä»¶æœåŠ¡å™¨æ¨¡å—ï¼Œä½ å¯ä»¥å°†å®ƒå®‰è£…åˆ°ä½ çš„é¡¹ç›®ä¸­æ¥æ–¹ä¾¿åœ°æµ‹è¯•å’Œéƒ¨ç½²ç½‘ç«™ã€‚

### å®‰è£… http-server

é¦–å…ˆï¼Œç¡®ä¿ä½ æœ‰ä¸€ä¸ª Node.js ç¯å¢ƒã€‚ç„¶åï¼Œåœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
npm install -g http-server
```

### å¯åŠ¨æœåŠ¡

ä¸€æ—¦å®‰è£…å®Œæ¯•ï¼Œä½ å¯ä»¥åœ¨ä»»ä½•ç›®å½•ä¸‹å¯åŠ¨ä¸€ä¸ªç®€å•çš„ Web æœåŠ¡å™¨ã€‚å‡è®¾å½“å‰ç›®å½•ä¸º `project`ï¼Œä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ¥å¯åŠ¨æœåŠ¡ï¼š

```bash
http-server .
```

è¿™å°†ä½¿å¾—ä½ çš„æµè§ˆå™¨èƒ½å¤Ÿè®¿é—® `127.0.0.1:8080` æ¥æŸ¥çœ‹ä½ çš„é™æ€æ–‡ä»¶ã€‚

## ä½¿ç”¨ nvm ç®¡ç† Node.js ç‰ˆæœ¬

`nvm`ï¼ˆNode Version Managerï¼‰æ˜¯ä¸€ä¸ªæµè¡Œçš„å·¥å…·ï¼Œç”¨äºåœ¨å•ä¸ªç³»ç»Ÿä¸Šå®‰è£…å¤šä¸ª Node.js ç‰ˆæœ¬å¹¶åˆ‡æ¢å®ƒä»¬ã€‚ä¸‹é¢æ˜¯å¦‚ä½•ä½¿ç”¨å®ƒï¼š

### å®‰è£… nvm

é¦–å…ˆï¼Œä½ éœ€è¦ä» GitHub å…‹éš† `nvm` çš„æºä»£ç ä»“åº“åˆ°ä½ çš„ç³»ç»Ÿä¸­ã€‚

```bash
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
```

### å®‰è£…æŒ‡å®šç‰ˆæœ¬

å®‰è£…ç‰¹å®šçš„ Node.js ç‰ˆæœ¬ï¼š

```bash
nvm install v10
```

### åˆ‡æ¢ç‰ˆæœ¬

åˆ‡æ¢åˆ°å·²å®‰è£…çš„ç‰¹å®šç‰ˆæœ¬ï¼š

```bash
nvm use v10
```

## [æŒæ¡ CentOS ç¯å¢ƒä¸‹çš„ Python æŠ€å·§](https://blog.dong4j.site/posts/44bde9f9.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

åœ¨ Linux ç³»ç»Ÿä¸­ï¼ŒPython æ˜¯ä¸€ä¸ªéå¸¸æµè¡Œçš„ç¼–ç¨‹è¯­è¨€ï¼Œè¢«å¹¿æ³›åº”ç”¨äº Web å¼€å‘ã€æ•°æ®åˆ†æã€äººå·¥æ™ºèƒ½ç­‰å¤šä¸ªé¢†åŸŸã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ CentOS æ“ä½œç³»ç»Ÿä¸­å®‰è£…å’Œé…ç½® Python ç¯å¢ƒã€‚

## å®‰è£…æ­¥éª¤

### 1. è§£å‹ Python åŒ…

é¦–å…ˆï¼Œä½ éœ€è¦ä¸‹è½½ Python çš„æºä»£ç åŒ…å¹¶å°†å…¶è§£å‹åˆ°ä½ çš„æœåŠ¡å™¨ä¸Šã€‚ç”±äºä½ è¦æ±‚ä¸ä½¿ç”¨å¤–éƒ¨å·¥å…·å®‰è£… Pythonï¼Œæˆ‘ä»¬å°†æ‰‹åŠ¨è¿›è¡Œè¿™ä¸€æ­¥ã€‚

```bash
# å‡è®¾ä½ å·²ç»ä¸‹è½½äº† Python çš„æºç å‹ç¼©åŒ…åˆ° /usr/local/src ç›®å½•ä¸‹
tar -xzf Python-3.8.x.tar.gz -C /usr/local/src
```

### 2. è¿›å…¥è§£å‹åçš„æ–‡ä»¶å¤¹

æ¥ä¸‹æ¥ï¼Œè¿›å…¥ Python çš„æºä»£ç ç›®å½•ï¼š

```bash
cd /usr/local/src/Python-3.8.x
```

### 3. é…ç½®å’Œå®‰è£… Python

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œ configure è„šæœ¬æ¥é…ç½® Python çš„ç¼–è¯‘é€‰é¡¹ã€‚å¦‚æœä½ éœ€è¦æŒ‡å®šå®‰è£…ç›®å½•ï¼Œå¯ä»¥æ·»åŠ  `--prefix` å‚æ•°ã€‚

```bash
./configure --prefix=/opt/python38
make && make install
```

è¿™ä¸ªæ­¥éª¤ä¼šç¼–è¯‘å¹¶å®‰è£… Python åˆ°æŒ‡å®šçš„ç›®å½• `/opt/python38`ã€‚

## æŸ¥çœ‹å·²å®‰è£…çš„æ¨¡å—

è¿›å…¥ Python äº¤äº’ç¯å¢ƒï¼š

```bash
python3
```

ç„¶åï¼Œä½¿ç”¨ `help("modules")` å‘½ä»¤æ¥æŸ¥çœ‹æ‰€æœ‰å·²ç»å®‰è£…çš„ Python æ¨¡å—ã€‚

## æŸ¥çœ‹ pip ç‰ˆæœ¬

è¦æŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸Šå®‰è£…çš„ pip ç‰ˆæœ¬ï¼Œå¯ä»¥ç›´æ¥åœ¨å‘½ä»¤è¡Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
pip -V
```

æˆ–è€…ï¼Œå¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Python 3.x ç‰ˆæœ¬ï¼Œä½ å¯èƒ½éœ€è¦ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
python3 -m pip -V
```

## ä½¿ç”¨ httpstat æ¨¡å—æµ‹è¯• HTTP å“åº”

`httpstat` æ˜¯ä¸€ä¸ª Python æ¨¡å—ï¼Œå¯ä»¥ç”¨æ¥æ£€æŸ¥ HTTP è¯·æ±‚çš„å“åº”ã€‚ä¸‹é¢æ˜¯å¦‚ä½•ä½¿ç”¨å®ƒæ¥æµ‹è¯•ä¸€ä¸ªæœ¬åœ°æœåŠ¡çš„ä¾‹å­ï¼š

```bash
export HTTPSTAT_SHOW_BODY=true
python /path/to/httpstat.py http://127.0.0.1:8080/json
```

ç¡®ä¿å°† `/path/to/httpstat.py` æ›¿æ¢ä¸º `httpstat.py` æ–‡ä»¶çš„æ­£ç¡®è·¯å¾„ã€‚

## è‡ªåŠ¨ç”Ÿæˆå’Œå®‰è£… requirements.txt ä¾èµ–

åœ¨å¤„ç† Python é¡¹ç›®æ—¶ï¼Œ`requirements.txt` æ–‡ä»¶æ˜¯éå¸¸é‡è¦çš„ã€‚å®ƒåˆ—å‡ºäº†é¡¹ç›®ä¾èµ–çš„æ‰€æœ‰æ¨¡å—åŠå…¶ç‰ˆæœ¬å·ã€‚ä»¥ä¸‹æ˜¯è‡ªåŠ¨åˆ›å»ºå’Œä½¿ç”¨è¿™ä¸ªæ–‡ä»¶çš„æ–¹æ³•ï¼š

### ç”Ÿæˆ requirements.txt æ–‡ä»¶

```bash
pip freeze > requirements.txt
```

### å®‰è£… requirements.txt åˆ—å‡ºçš„ä¾èµ–

```bash
pip install -r requirements.txt
```

è¿™æ ·ï¼Œä½ å°±å¯ä»¥ç¡®ä¿åœ¨ä¸åŒçš„ç¯å¢ƒä¸­ä½¿ç”¨ç›¸åŒç‰ˆæœ¬çš„ä¾èµ–é¡¹ã€‚

## è¿è¡Œç®€å•çš„ Web æœåŠ¡å™¨

Python å†…ç½®äº†ä¸€ä¸ªéå¸¸æ–¹ä¾¿çš„ HTTP æœåŠ¡å™¨æ¨¡å— `SimpleHTTPServer`ï¼Œå¯ä»¥ç”¨æ¥å¿«é€Ÿæµ‹è¯•ä½ çš„æœ¬åœ°æ–‡ä»¶ã€‚ä¸‹é¢æ˜¯å¦‚ä½•å¯åŠ¨ä¸€ä¸ªç®€å•çš„ HTTP æœåŠ¡å™¨çš„ç¤ºä¾‹ï¼š

```bash
python -m SimpleHTTPServer 7777
```

æˆ–è€…ä½¿ç”¨ Python 3.x ç‰ˆæœ¬ï¼š

```bash
python -m http.server 7777
```

è¿™äº›å‘½ä»¤å°†åœ¨ä½ æŒ‡å®šçš„ç«¯å£ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯ 7777ï¼‰ä¸Šå¯åŠ¨ä¸€ä¸ªç®€å•çš„ HTTP æœåŠ¡å™¨ã€‚ä½ å¯ä»¥é€šè¿‡æµè§ˆå™¨æˆ–å·¥å…·å¦‚ Postman æ¥è®¿é—®è¿™ä¸ªæœåŠ¡å™¨ã€‚

## [Redis æ•°æ®ç»“æ„è¯¦è§£ï¼šä»åŸºæœ¬åˆ°é«˜çº§](https://blog.dong4j.site/posts/ae6109b1.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

Redis æ˜¯ä¸€ä¸ªå¼€æºçš„å†…å­˜æ•°æ®ç»“æ„å­˜å‚¨ç³»ç»Ÿï¼Œå®ƒæä¾›äº†å¤šç§æ•°æ®ç±»å‹å’Œä¸°å¯Œçš„æ“ä½œå‘½ä»¤ï¼Œä½¿å¾—å®ƒåœ¨å¤„ç†å¿«é€Ÿè¯»å†™å’Œé«˜å¹¶å‘åœºæ™¯ä¸‹è¡¨ç°å‡ºè‰²ã€‚ä¸‹é¢å°†è¯¦ç»†ä»‹ç» Redis çš„ä¸»è¦ç‰¹æ€§å’Œåº”ç”¨åœºæ™¯ã€‚

## 1. æ”¯æŒæŒä¹…åŒ–

### RDB æŒä¹…åŒ–

RDB æ˜¯ Redis çš„æœ¬åœ°æŒä¹…åŒ–æ–¹å¼ï¼Œé€šè¿‡å‘¨æœŸæ€§åœ°å°†å†…å­˜ä¸­çš„æ•°æ®å†™å…¥ç£ç›˜æ¥ä¿å­˜æ•°æ®çŠ¶æ€ã€‚åœ¨ `redis.conf` é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®å®šæ—¶ä»»åŠ¡æˆ–æ‰‹åŠ¨è§¦å‘ RDB å¿«ç…§ã€‚

### AOF æŒä¹…åŒ–

AOFï¼ˆAppend Only Fileï¼‰æ˜¯å¦ä¸€ç§æŒä¹…åŒ–æ–¹æ³•ï¼Œå®ƒè®°å½•æ¯æ¬¡å†™æ“ä½œåˆ°æ–‡ä»¶ä¸­ã€‚å½“ Redis é‡å¯æ—¶ï¼Œå®ƒä¼šé‡æ–°æ‰§è¡Œè¿™äº›å‘½ä»¤æ¥é‡å»ºæ•°æ®çŠ¶æ€ã€‚å¼€å¯ AOF æŒä¹…åŒ–å¯¹äºé˜²æ­¢æ•°æ®ä¸¢å¤±éå¸¸æœ‰ç”¨ï¼Œä½†å®ƒå¯èƒ½ä¼šæ¶ˆè€—æ›´å¤šç£ç›˜ç©ºé—´ã€‚

## 2. ä¸°å¯Œçš„æ•°æ®ç±»å‹

Redis æ”¯æŒå¤šç§æ•°æ®ç±»å‹ï¼ŒåŒ…æ‹¬ï¼š

- **String**ï¼šæœ€ç®€å•çš„é”®å€¼å¯¹å­˜å‚¨ã€‚
- **List**ï¼šåˆ—è¡¨ï¼Œå¯ä»¥ç”¨äºæ¶ˆæ¯é˜Ÿåˆ—ç­‰åœºæ™¯ã€‚
- **Set**ï¼šé›†åˆï¼Œæ”¯æŒæˆå‘˜çš„å”¯ä¸€æ€§å’Œæ“ä½œå¦‚æ±‚äº¤é›†ã€å¹¶é›†ç­‰ã€‚
- **Sorted Set**ï¼šæœ‰åºé›†åˆï¼Œå¸¸ç”¨äºæ’è¡Œæ¦œåº”ç”¨ã€‚
- **Hash**ï¼šå“ˆå¸Œè¡¨ï¼Œé€‚åˆç”¨äºå­˜å‚¨ç»“æ„åŒ–æ•°æ®ã€‚

è¿™äº›æ•°æ®ç±»å‹æä¾›äº†é«˜æ•ˆçš„æ•°æ®ç»“æ„å’Œä¸°å¯Œçš„æ“ä½œå‘½ä»¤ï¼Œä½¿å¾— Redis å¯ä»¥é€‚åº”å„ç§ä¸åŒçš„åœºæ™¯å’Œéœ€æ±‚ã€‚

## 3. é«˜æ€§èƒ½

Redis ä»¥å†…å­˜æ“ä½œä¸ºä¸»ï¼Œå…¶è¯»å†™é€Ÿåº¦è¿œè¿œè¶…è¿‡ä¼ ç»Ÿçš„ç£ç›˜å­˜å‚¨ç³»ç»Ÿã€‚å®ƒå‡å°‘äº†ç£å¤´å¯»é“ã€æ•°æ®è¯»å–ç­‰å¼€é”€ï¼Œå› æ­¤åœ¨éœ€è¦é«˜é€Ÿè¯»å†™æ“ä½œçš„åœºæ™¯ä¸‹éå¸¸æœ‰ç”¨ã€‚

## 4. Replicationï¼ˆå¤åˆ¶ï¼‰

Redis æ”¯æŒä¸»ä»å¤åˆ¶ï¼Œå…è®¸ä»ä¸€ä¸ªä¸»èŠ‚ç‚¹åŒæ­¥æ•°æ®åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªä»èŠ‚ç‚¹ã€‚è¿™ç§å¤åˆ¶æ–¹å¼ç±»ä¼¼äº MySQL çš„ä¸»ä»å¤åˆ¶ï¼Œå¯ä»¥ä¿è¯æ•°æ®çš„å†—ä½™å’Œé«˜å¯ç”¨æ€§ã€‚Redis ä¸»ä»å¤åˆ¶çš„è¿‡ç¨‹æ˜¯å¢é‡å¤åˆ¶ï¼Œå³åªå¤åˆ¶ä¸»èŠ‚ç‚¹çš„å†™å‘½ä»¤åˆ°ä»èŠ‚ç‚¹ã€‚

## 5. æ›´æ–°å¿«

Redis æ˜¯ä¸€ä¸ªæ´»è·ƒçš„å¼€æºé¡¹ç›®ï¼Œå…¶ç‰ˆæœ¬æ›´æ–°é¢‘ç‡è¾ƒé«˜ã€‚è¿™å¾—ç›Šäº Redis ä½œè€…çš„ç§¯æç»´æŠ¤å’Œç¤¾åŒºçš„è´¡çŒ®ã€‚Redis çš„æœ€æ–°ç‰ˆæœ¬é€šå¸¸ä¼šä¿®å¤å·²çŸ¥é—®é¢˜å¹¶å¼•å…¥æ–°çš„åŠŸèƒ½ã€‚

## 6. å…è®¸è¿œç¨‹è®¿é—®

é»˜è®¤æƒ…å†µä¸‹ï¼ŒRedis åªå…è®¸æœ¬æœºè®¿é—®ã€‚å¦‚æœä½ éœ€è¦è¿œç¨‹è®¿é—® Redisï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ `redis.conf` æ–‡ä»¶ä¸­çš„ `bind` å‚æ•°æ¥å¼€å¯è¿œç¨‹è¿æ¥ã€‚ä¾‹å¦‚ï¼š

```bash
bind 127.0.0.1
```

å¯ä»¥å°†ä¸Šè¿°é…ç½®æ”¹ä¸ºï¼š

```bash
# bind 127.0.0.1
# å¯ä»¥æ›¿æ¢ä¸ºå…è®¸çš„ IP åœ°å€ï¼Œå¦‚ bind 192.168.1.100
```

æ­¤å¤–ï¼ŒRedis è¿˜å¯ä»¥é€šè¿‡ `protected-mode` å‚æ•°æ¥æ§åˆ¶æ˜¯å¦å¼€å¯ä¿æŠ¤æ¨¡å¼ã€‚

## 7. Redis éªŒè¯

å¦‚æœä½ éœ€è¦å®‰å…¨åœ°è®¿é—® Redisï¼Œå¯ä»¥ä½¿ç”¨å¯†ç éªŒè¯ã€‚åœ¨å¯åŠ¨ Redis æœåŠ¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ `-a` å‚æ•°æŒ‡å®šå¯†ç ï¼š

```bash
redis-server -a å¯†ç 
```

åœ¨å®¢æˆ·ç«¯è¿æ¥ Redis æ—¶ï¼Œä¹Ÿéœ€è¦æä¾›æ­£ç¡®çš„å¯†ç æ‰èƒ½æˆåŠŸè¿æ¥ã€‚

## 8. Redis Sdiff å‘½ä»¤

Redis çš„ `Sdiff` å‘½ä»¤ç”¨äºè¿”å›ç»™å®šé›†åˆä¹‹é—´çš„å·®é›†ã€‚è¿™ä¸ªå‘½ä»¤å¯ä»¥ç”¨æ¥æ‰¾å‡ºä¸åŒé›†åˆä¹‹é—´ä¸å…±æœ‰çš„å…ƒç´ ã€‚

## 9. æ‰¹é‡åˆ é™¤æŒ‡å®šå‰ç¼€çš„ key

å¦‚æœä½ éœ€è¦æ‰¹é‡åˆ é™¤å…·æœ‰ç‰¹å®šå‰ç¼€çš„é”®ï¼Œå¯ä»¥ä½¿ç”¨ `keys` å‘½ä»¤é…åˆç®¡é“ï¼ˆpipeï¼‰å’Œ `del` å‘½ä»¤æ¥å®ç°ï¼š

```bash
redis-cli -h 172.31.205.58 -p 6379 keys 'mobileprefix:*' | xargs redis-cli -h 172.31.205.58 -p 6379 del
```

## [RESTful API å…¥é—¨æŒ‡å—ï¼šä»æ¦‚å¿µåˆ°å®æˆ˜](https://blog.dong4j.site/posts/1fce8c1c.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

**RESTful API æ˜¯ä¸€ç§ç½‘ç»œåº”ç”¨æ¶æ„é£æ ¼ï¼Œå¼ºè°ƒé€šè¿‡ç»Ÿä¸€çš„æ¥å£å’Œèµ„æºæ“ä½œè®¾è®¡ APIã€‚å®ƒä½¿ç”¨ HTTP åè®®ä¸­çš„ä¸åŒæ–¹æ³•æ¥åˆ›å»ºã€è¯»å–ã€æ›´æ–°å’Œåˆ é™¤èµ„æºï¼Œè®©å¼€å‘è€…å’Œç”¨æˆ·èƒ½å¤Ÿç›´è§‚åœ°ç†è§£å’Œæ“ä½œåº”ç”¨ç¨‹åºã€‚**

### RESTful API è®¾è®¡åŸåˆ™

#### 1. èµ„æºå¯¼å‘

RESTful API ä»¥èµ„æºä¸ºä¸­å¿ƒè¿›è¡Œè®¾è®¡ã€‚æ¯ä¸ªèµ„æºéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ URIï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡è¿™ä¸ª URI è®¿é—®ç›¸åº”çš„èµ„æºã€‚

- **URL ç¤ºä¾‹**:
  - GET /zoosï¼šæŸ¥çœ‹æ‰€æœ‰åŠ¨ç‰©å›­
  - POST /zoosï¼šåˆ›å»ºä¸€ä¸ªæ–°åŠ¨ç‰©å›­
  - GET /zoos/1ï¼šè·å–æŒ‡å®šåŠ¨ç‰©å›­çš„ä¿¡æ¯

#### 2. æ–¹æ³•ä½¿ç”¨

RESTful API ä½¿ç”¨ HTTP åè®®ä¸­çš„ä¸åŒæ–¹æ³•æ¥æ‰§è¡Œä¸åŒçš„æ“ä½œï¼š

- **GET**ï¼šä»æœåŠ¡å™¨æ£€ç´¢èµ„æºã€‚
- **POST**ï¼šåœ¨æœåŠ¡å™¨ä¸Šæ–°å»ºä¸€ä¸ªèµ„æºã€‚
- **PUT**ï¼šæ›´æ–°èµ„æºï¼ˆå®¢æˆ·ç«¯æä¾›æ”¹å˜åçš„å®Œæ•´èµ„æºï¼‰ã€‚
- **PATCH**ï¼šéƒ¨åˆ†æ›´æ–°èµ„æºï¼ˆå®¢æˆ·ç«¯æä¾›æ”¹å˜çš„å±æ€§ï¼‰ã€‚
- **DELETE**ï¼šåˆ é™¤èµ„æºã€‚

#### 3. çŠ¶æ€ç ä½¿ç”¨

RESTful API ä½¿ç”¨æ ‡å‡†çš„ HTTP çŠ¶æ€ç æ¥è¡¨ç¤ºè¯·æ±‚çš„ç»“æœï¼š

- 200 OKï¼šæˆåŠŸæ£€ç´¢æ•°æ®
- 201 Createdï¼šåˆ›å»ºæ–°èµ„æºæˆåŠŸ
- 204 No Contentï¼šåˆ é™¤æˆ–æ›´æ–°èµ„æºåï¼Œå“åº”ä½“ä¸ºç©º
- 400 Bad Requestï¼šå®¢æˆ·ç«¯è¯·æ±‚æœ‰è¯¯
- 404 Not Foundï¼šèµ„æºä¸å­˜åœ¨

#### 4. å†…å®¹ç±»å‹å’Œç¼–ç 

`consumes` å’Œ `produces` ç”¨äºæŒ‡å®šè¯·æ±‚å’Œè¿”å›çš„æ•°æ®æ ¼å¼ï¼š

- `consumes`: æŒ‡å®šå¤„ç†è¯·æ±‚çš„æäº¤å†…å®¹ç±»å‹ï¼Œå¦‚ application/json, text/htmlã€‚
- `produces`: æŒ‡å®šè¿”å›å€¼ç±»å‹ï¼Œä¸ä»…å¯ä»¥è®¾ç½®è¿”å›å€¼ç±»å‹ï¼Œè¿˜å¯ä»¥è®¾å®šè¿”å›å€¼çš„å­—ç¬¦ç¼–ç ã€‚

### å®ä¾‹è§£æ

ä»¥ä¸‹æ˜¯ä¸€äº› RESTful API çš„å®é™…åº”ç”¨ç¤ºä¾‹ï¼š

#### åŠ¨ç‰©å›­èµ„æºæ“ä½œ

- **è·å–æ‰€æœ‰åŠ¨ç‰©å›­**:

  - HTTP æ–¹æ³•: GET
  - URI: `/zoos`

- **åˆ›å»ºä¸€ä¸ªæ–°åŠ¨ç‰©å›­**:

  - HTTP æ–¹æ³•: POST
  - URI: `/zoos`

- **è·å–æŒ‡å®šåŠ¨ç‰©å›­ä¿¡æ¯**:

  - HTTP æ–¹æ³•: GET
  - URI: `/zoos/1`

- **æ›´æ–°æŒ‡å®šåŠ¨ç‰©å›­ä¿¡æ¯**:

  - HTTP æ–¹æ³•: PUT
  - URI: `/zoos/1`

- **éƒ¨åˆ†æ›´æ–°æŒ‡å®šåŠ¨ç‰©å›­ä¿¡æ¯**:

  - HTTP æ–¹æ³•: PATCH
  - URI: `/zoos/1`

- **åˆ é™¤ç‰¹å®šåŠ¨ç‰©å›­**:
  - HTTP æ–¹æ³•: DELETE
  - URI: `/zoos/1`

#### å‘˜å·¥èµ„æºæ“ä½œ

- **è·å–æŒ‡å®šåŠ¨ç‰©å›­çš„å‘˜å·¥åˆ—è¡¨**:

  - HTTP æ–¹æ³•: GET
  - URI: `/zoos/1/employees`

- **ä¸ºæŒ‡å®šåŠ¨ç‰©å›­æ·»åŠ æ–°å‘˜å·¥**:
  - HTTP æ–¹æ³•: POST
  - URI: `/zoos/1/employees`

#### åŠ¨ç‰©èµ„æºæ“ä½œ

- **è·å–æ‰€æœ‰åŠ¨ç‰©ä¿¡æ¯**:

  - HTTP æ–¹æ³•: GET
  - URI: `/animals`

- **åˆ›å»ºä¸€ä¸ªæ–°çš„åŠ¨ç‰©**:

  - HTTP æ–¹æ³•: POST
  - URI: `/animals`

- **æ›´æ–°ç‰¹å®šåŠ¨ç‰©çš„ä¿¡æ¯ï¼ˆå…¨é‡ï¼‰**:
  - HTTP æ–¹æ³•: PUT
  - URI: `/animals/1`

#### ç¥¨åŠ¡èµ„æºæ“ä½œ

- **è·å–æ‰€æœ‰ç¥¨åŠ¡ä¿¡æ¯**:

  - HTTP æ–¹æ³•: GET
  - URI: `/tickets`

- **æŸ¥çœ‹æŸä¸ªå…·ä½“çš„ç¥¨åŠ¡ä¿¡æ¯**:

  - HTTP æ–¹æ³•: GET
  - URI: `/tickets/12`

- **æ–°å»ºä¸€ä¸ªç¥¨åŠ¡ä¿¡æ¯**:

  - HTTP æ–¹æ³•: POST
  - URI: `/tickets`

- **æ›´æ–°ç‰¹å®šç¥¨åŠ¡ä¿¡æ¯**:

  - HTTP æ–¹æ³•: PUT
  - URI: `/tickets/12`

- **åˆ é™¤æŸä¸ªç‰¹å®šçš„ç¥¨åŠ¡ä¿¡æ¯**:
  - HTTP æ–¹æ³•: DELETE
  - URI: `/tickets/12`

### æ€»ç»“

RESTful API è®¾è®¡åº”éµå¾ªèµ„æºå¯¼å‘ã€æ–¹æ³•ä½¿ç”¨è§„èŒƒã€çŠ¶æ€ç çš„åˆç†åˆ†é…ä»¥åŠå†…å®¹ç±»å‹å’Œç¼–ç çš„è®¾ç½®ç­‰åŸåˆ™ã€‚è¿™äº›æœ€ä½³å®è·µæœ‰åŠ©äºåˆ›å»ºæ¸…æ™°ã€æ˜“äºç†è§£å’Œä½¿ç”¨çš„ APIï¼Œä»è€Œæå‡å¼€å‘æ•ˆç‡å’Œç”¨æˆ·ä½“éªŒã€‚

## [ä»é›¶å¼€å§‹ï¼šæŒæ¡Webä¼šè¯ç®¡ç†çš„å››ç§æ–¹å¼](https://blog.dong4j.site/posts/b1cd2b93.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

Web æœåŠ¡å™¨ä¸€æ—¦å‘å‡ºå“åº”,ä¸€ä¸ªè¯·æ±‚å“åº”è¿‡ç¨‹å°±ç»“æŸäº†.  
å½“å†æ¬¡å‘å‡ºè¯·æ±‚æ—¶,Web æœåŠ¡å™¨ä¸è®°å¾—æ›¾å°±åšè¿‡çš„è¯·æ±‚,ä¹Ÿä¸è®°å¾—ç»™ç”¨æˆ·å‘å‡ºè¿‡å“åº”.,è¿™å°±æ˜¯ http çš„æ— çŠ¶æ€æ¨¡å¼

å½“éœ€è¦è·¨å¤šä¸ªè¯·æ±‚éœ€è¦ä¿ç•™ä¸å®¢æˆ·ç«¯ä¼šè¯çŠ¶æ€æ—¶,æˆ‘ä»¬æœ‰ 4 ç§è§£å†³æ–¹æ¡ˆ

## è¡¨å•éšè—å­—æ®µ

`<input type="hidden" name="userName" value="â€¦">`  
ä½œç”¨:

1. å¯¹ç”¨æˆ·åœ¨ç½‘ä¸Šçš„è®¿é—®è¿›è¡Œä¼šè¯è·Ÿè¸ª
2. ä¸ºæœåŠ¡å™¨æä¾›é¢„å®šä¹‰çš„è¾“å…¥
3. å­˜å‚¨åŠ¨æ€äº§ç”Ÿçš„ç½‘é¡µçš„ä¸Šä¸‹æ–‡ä¿¡æ¯

ç¼ºç‚¹: åªæœ‰å½“æ¯ä¸ªç½‘é¡µæ˜¯åŠ¨æ€ç”Ÿæˆçš„æ‰æœ‰æ•ˆ

## Cookie

å°†æ•°æ®å·²é”®å€¼å¯¹çš„å½¢å¼é€šè¿‡å“åº”ä¿å­˜åœ¨å®¢æˆ·ç«¯  
æ–¹æ³•:

1. Cookie(name,value)
2. get/setComment(String comment): æ³¨é‡Š
3. get/setDomain(String domainPattern): å¾—åˆ°/è®¾ç½®åº”ç”¨ Cookie çš„åŸŸ
4. setMaxAge(int lifetime) è®¾ç½®è¿‡æœŸæ—¶é—´,é»˜è®¤ä¸ºè´Ÿæ•°,è¡¨ç¤ºåœ¨å…³é—­æµè§ˆå™¨åè¿‡æœŸ
5. getMaxAge()
6. get/setName(String name)
7. get/setValue(String value)

å°† Cookie å‘é€åˆ°å®¢æˆ·ç«¯çš„æ­¥éª¤

1. åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ª Cookie
2. ä½¿ç”¨ setXXX æ–¹æ³•è®¾ç½® Cookie çš„å¯é€‰å±æ€§
3. ä½¿ç”¨ HttpServletResponse å¯¹è±¡çš„ addCookie() æ–¹æ³•å°† Cookie æ’å…¥åˆ°å“åº”å¤´ä¸­

è¯»å–å®¢æˆ·ç«¯ä¼ é€’è¿‡æ¥çš„ Cookie çš„æ­¥éª¤

1. ä½¿ç”¨ HttpServletRequset å¯¹è±¡çš„ getCookie æ–¹æ³•è¿”å›ä¸€ä¸ª Cookie å¯¹è±¡æ•°ç»„
2. Servlet éå†è¯¥æ•°ç»„ (getName()),ç›´åˆ°æ‰¾åˆ°åç§°ç›¸åŒ¹é…çš„ Cookie å€¼

## Session

åœ¨æœåŠ¡å™¨ç«¯ä¸ºå®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„ Session å¯¹è±¡,ç”¨äºå­˜æ”¾æ•°æ®.  
åœ¨åˆ›å»º Session å¯¹è±¡çš„åŒæ—¶,æœåŠ¡å™¨ä¼šä¸ºè¯¥å¯¹è±¡åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„ SesionID,å­˜å‚¨åœ¨å®¢æˆ·ç«¯çš„ Cookie å½“ä¸­

HttpSession æ¥å£ä¸­çš„æ–¹æ³•

1. get/setAttribute(String key,Object obj)
2. removeAttribute(String key)
3. getCreationTime() : è¿”å›ç¬¬ä¸€æ¬¡åˆ›å»ºä¼šè¯çš„æ—¶é—´
4. getLastAccessedTime() : è¿”å›å®¹å™¨æœ€åä¸€æ¬¡å¾—åˆ°è¯¥ä¼šè¯ ID çš„è¯·æ±‚æ—¶é—´
5. get/setMaxInactiveInterval(int time) : å­˜æ´»æ—¶é—´
6. invalidate(): ç»“æŸä¼šè¯
7. getId()

### ä¼šè¯è¶…æ—¶ç®¡ç†

ç»“æŸä¼šè¯çš„ 3 ç§æƒ…å†µ

1. æœåŠ¡å™¨é‡å¯æˆ–å´©æºƒ
2. è°ƒç”¨ invalidate() æ–¹æ³•
3. ä¼šè¯è¶…æ—¶

åœ¨ web.xml ä¸­è®¾ç½®ä¼šè¯æ—¶é—´  
å•ä½æ˜¯åˆ†é’Ÿ

```xml
<session-config>
	<session-timeout>15</session-timeout>
</session-config>
```

åœ¨ç¨‹åºä¸­è®¾ç½®è¶…æ—¶æ—¶é—´çš„å•ä½æ˜¯ç§’

### Application å’Œ Session åŸŸèŒƒå›´çš„å±æ€§

Application

```java
ServletContext sc = this.getServletConfig().getServletContext();
```

### Session æŒä¹…åŒ–

Tomcat æä¾›çš„ 2 ä¸ªç±»æ¥ç®¡ç† Session å¯¹è±¡

1. StandardManager(é»˜è®¤)
   - å½“æœåŠ¡å™¨å…³é—­æˆ–åº”ç”¨é‡æ–°åŠ è½½çš„æ—¶å€™åœ¨ work/Catalina/localhost/web/åº”ç”¨å ä¸‹åˆ›å»ºåä¸º session.ser çš„æ–‡ä»¶,å°† session ä¿¡æ¯å†™å…¥,å½“å® å¹¸åŠ è½½æˆ–é‡å¯æ—¶è¯»å–è¿™ä¸ªæ–‡ä»¶,ç„¶ååˆ é™¤
2. PersistentManager

## URL é‡å†™

ç”±äº Session ä¾èµ–äº Cookie,å½“æµè§ˆå™¨å…³é—­ Cookie æ—¶å°†ä¸èƒ½ä½¿ç”¨ Cookie å’Œ Session,å½“è¿™ç§æƒ…å†µå‘ç”Ÿæ—¶,URL é‡å†™å°±æ´¾ä¸Šç”¨åœºäº†.  
URL é‡å†™æ˜¯å°† SessionID å†™å…¥åˆ° URL å½“ä¸­,å°±ä¸éœ€è¦ Cookie ä¿å­˜ SessionID

URL;jsessionid=id;

é‡å®šå‘ä¸­ä½¿ç”¨ URL é‡å†™

```java
HttpSession session = requset.getSession();
String url = resquest.encodeRedirectURL("/aa/bb.html");
request.sendRedirect(url);
```

encodeURL() æ˜¯æœ¬åº”ç”¨çº§åˆ«çš„ï¼ŒencodeRedirectURL() æ˜¯è·¨åº”ç”¨çš„ã€‚

1. response.encodeRedirectURL(url) æ˜¯ä¸€ä¸ªè¿›è¡Œ URL é‡å†™çš„æ–¹æ³•ï¼Œ ä½¿ç”¨è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ä¸ºäº†åœ¨åŸæ¥çš„ url åé¢è¿½åŠ ä¸Š Jsessionid ã€‚ ç›®çš„æ˜¯ä¿è¯å³ä½¿åœ¨å®¢æˆ·ç«¯æµè§ˆå™¨ç¦æ­¢äº† cookie çš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨ç«¯ä»ç„¶èƒ½å¤Ÿå¯¹å…¶è¿›è¡Œäº‹åŠ¡è·Ÿè¸ª.
2. response.sendRedirect(url) æ˜¯ä¸€ä¸ª url é‡å®šå‘çš„æ–¹æ³•ï¼Œ æœåŠ¡å™¨ç«¯çš„é€šè¿‡è¯¥æ–¹æ³•ï¼Œâ€œå‘Šè¯‰â€å®¢æˆ·ç«¯çš„æµè§ˆå™¨å»è®¿é—® url æ‰€æŒ‡å‘çš„èµ„æº

## æ€»ç»“

Http åè®®ä½¿ç”¨çš„æ˜¯æ— çŠ¶æ€è¿æ¥
ç›¸å½“äºæ¯ä¸€ä¸ªè¯·æ±‚éƒ½æ˜¯æ¥è‡ªäºæ–°å®¢æˆ·
æœåŠ¡å™¨ä¸ä¿å­˜å®¢æˆ·çš„ä¿¡æ¯

è§£å†³æ–¹æ¡ˆ

1. è¡¨å•éšè—å­—æ®µ hidden
   ç¼ºç‚¹ :
   ç±»å‹è¢«é™åˆ¶,åªèƒ½ä½¿ç”¨å­—ç¬¦ä¸²
   è¦ä¸€å±‚ä¸€å±‚çš„ä¼ é€’,å¯¹ä¸éœ€è¦ä½¿ç”¨ä¿¡æ¯çš„ç½‘é¡µä¹Ÿéœ€è¦ä½¿ç”¨ hidden

2. Cookie (å®¢æˆ·ç«¯)

```java
Cookie cookie = new Cookie("cool","tiger");
addCookie();
```

3. Session (æœåŠ¡ç«¯)
   SessionID å­˜åˆ°å®¢æˆ·ç«¯çš„ Cookie ä¸­

4. URL é‡å†™
   æŠŠ SessionID åŠ åˆ° URL åé¢

## [Spring MVC ä¼˜åŒ–ï¼šæ•æ„Ÿè¯è¿‡æ»¤ä¸TokenéªŒè¯çš„é›†æˆ](https://blog.dong4j.site/posts/f335982.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

### APP æœåŠ¡ç«¯çš„ Token éªŒè¯

é€šè¿‡æ‹¦æˆªå™¨å¯¹ä½¿ç”¨äº† @Authorization æ³¨è§£çš„æ–¹æ³•è¿›è¡Œè¯·æ±‚æ‹¦æˆªï¼Œä» http header ä¸­å–å‡º token ä¿¡æ¯ï¼ŒéªŒè¯å…¶æ˜¯å¦åˆæ³•ã€‚éæ³•ç›´æ¥è¿”å› 401 é”™è¯¯ï¼Œåˆæ³•å°† token å¯¹åº”çš„ user key å­˜å…¥ request ä¸­åç»§ç»­æ‰§è¡Œã€‚å…·ä½“å®ç°ä»£ç ï¼š

```java
public boolean preHandle(HttpServletRequest request,
                         HttpServletResponse response, Object handler) throws Exception {
    //å¦‚æœä¸æ˜¯æ˜ å°„åˆ°æ–¹æ³•ç›´æ¥é€šè¿‡
    if (!(handler instanceof HandlerMethod)) {
        return true;
    }
    HandlerMethod handlerMethod = (HandlerMethod) handler;
    Method method = handlerMethod.getMethod();
    //ä»headerä¸­å¾—åˆ°token
    String token = request.getHeader(httpHeaderName);
    if (token != null && token.startsWith(httpHeaderPrefix) && token.length() > 0) {
        token = token.substring(httpHeaderPrefix.length());
        //éªŒè¯token
        String key = manager.getKey(token);
        if (key != null) {
            //å¦‚æœtokenéªŒè¯æˆåŠŸï¼Œå°†tokenå¯¹åº”çš„ç”¨æˆ·idå­˜åœ¨requestä¸­ï¼Œä¾¿äºä¹‹åæ³¨å…¥
            request.setAttribute(REQUEST_CURRENT_KEY, key);
            return true;
        }
    }
    //å¦‚æœéªŒè¯tokenå¤±è´¥ï¼Œå¹¶ä¸”æ–¹æ³•æ³¨æ˜äº†Authorizationï¼Œè¿”å›401é”™è¯¯
    if (method.getAnnotation(Authorization.class) != null) {
        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
        response.setCharacterEncoding("gbk");
        response.getWriter().write(unauthorizedErrorMessage);
        response.getWriter().close();
        return false;
    }
    //ä¸ºäº†é˜²æ­¢ä»¥æŸç§ç›´æ¥åœ¨REQUEST_CURRENT_KEYå†™å…¥keyï¼Œå°†å…¶è®¾ä¸ºnull
    request.setAttribute(REQUEST_CURRENT_KEY, null);
    return true;
}
```

é€šè¿‡æ‹¦æˆªå™¨åï¼Œä½¿ç”¨è§£æå™¨å¯¹ä¿®é¥°äº† @CurrentUser çš„å‚æ•°è¿›è¡Œæ³¨å…¥ã€‚ä» request ä¸­å–å‡ºä¹‹å‰å­˜å…¥çš„ user keyï¼Œå¾—åˆ°å¯¹åº”çš„ user å¯¹è±¡å¹¶æ³¨å…¥åˆ°å‚æ•°ä¸­ã€‚å…·ä½“å®ç°ä»£ç ï¼š

```java
@Override
public boolean supportsParameter(MethodParameter parameter) {
    Class clazz;
    try {
        clazz = Class.forName(userModelClass);
    } catch (ClassNotFoundException e) {
        return false;
    }
    //å¦‚æœå‚æ•°ç±»å‹æ˜¯Userå¹¶ä¸”æœ‰CurrentUseræ³¨è§£åˆ™æ”¯æŒ
    if (parameter.getParameterType().isAssignableFrom(clazz) &&
            parameter.hasParameterAnnotation(CurrentUser.class)) {
        return true;
    }
    return false;
}

@Override
public Object resolveArgument(MethodParameter parameter, ModelAndViewContainer mavContainer, NativeWebRequest webRequest, WebDataBinderFactory binderFactory) throws Exception {
    //å–å‡ºé‰´æƒæ—¶å­˜å…¥çš„ç™»å½•ç”¨æˆ·Id
    Object object = webRequest.getAttribute(AuthorizationInterceptor.REQUEST_CURRENT_KEY, RequestAttributes.SCOPE_REQUEST);
    if (object != null) {
        String key = String.valueOf(object);
        //ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å¹¶è¿”å›
        Object userModel = userModelRepository.getCurrentUser(key);
        if (userModel != null) {
            return userModel;
        }
        //æœ‰keyä½†æ˜¯å¾—ä¸åˆ°ç”¨æˆ·ï¼ŒæŠ›å‡ºå¼‚å¸¸
        throw new MissingServletRequestPartException(AuthorizationInterceptor.REQUEST_CURRENT_KEY);
    }
    //æ²¡æœ‰keyå°±ç›´æ¥è¿”å›null
    return null;
}
```

### ä½¿ç”¨åˆ«åæ¥å—å¯¹è±¡çš„å‚æ•°

è¯·æ±‚ä¸­çš„å‚æ•°åå’Œä»£ç ä¸­å®šä¹‰çš„å‚æ•°åä¸åŒæ˜¯å¾ˆå¸¸è§çš„æƒ…å†µï¼Œå¯¹äºè¿™ç§æƒ…å†µ[spring](http://lib.csdn.net/base/javaee "Java EEçŸ¥è¯†åº“")æä¾›äº†å‡ ç§åŸç”Ÿçš„æ–¹æ³•ï¼š

å¯¹äº @RequestParam å¯ä»¥ç›´æ¥æŒ‡å®š value å€¼ä¸ºåˆ«åï¼ˆ @RequestHeader ä¹Ÿæ˜¯ä¸€æ ·ï¼‰ï¼Œä¾‹å¦‚ï¼š

```java
public String home(@RequestParam("user_id") long userId) {
    return "hello " + userId;
}
```

å¯¹äº @RequestBody ï¼Œç”±äºå…¶ä½¿ä½¿ç”¨ Jackson å°† Json è½¬æ¢ä¸ºå¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ @JsonProperty çš„ value æŒ‡å®šåˆ«åï¼Œä¾‹å¦‚ï¼š

```java
public String home(@RequestBody User user) {
    return "hello " + user.getUserId();
}

class User {
    @JsonProperty("user_id")
    private long userId;
}
```

ä½†æ˜¯ä½¿ç”¨å¯¹è±¡çš„å±æ€§æ¥å—å‚æ•°æ—¶ï¼Œå°±æ— æ³•ç›´æ¥é€šè¿‡ä¸Šé¢çš„åŠæ³•æŒ‡å®šåˆ«åäº†ï¼Œä¾‹å¦‚ï¼š

```java
public String home(User user) {
    return "hello " + user.getUserId();
}
```

è¿™æ—¶å€™éœ€è¦ä½¿ç”¨ DataBinder æ‰‹åŠ¨ç»‘å®šå±æ€§å’Œåˆ«åï¼Œæˆ‘åœ¨ StackOverFlow ä¸Šæ‰¾åˆ°çš„ Â [è¿™ç¯‡æ–‡ç« ](http://stackoverflow.com/questions/8986593/how-to-customize-parameter-names-when-binding-spring-mvc-command-objects)Â  æ˜¯ä¸ªä¸é”™çš„åŠæ³•ï¼Œè¿™é‡Œå°±ä¸é‡å¤é€ è½®å­äº†ã€‚

### å…³é—­é»˜è®¤é€šè¿‡è¯·æ±‚çš„åç¼€ååˆ¤æ–­ Content-Type

ä¹‹å‰æ¥æ‰‹çš„é¡¹ç›®çš„å¼€å‘ä¹ æƒ¯æ˜¯ä½¿ç”¨.html ä½œä¸ºè¯·æ±‚çš„åç¼€åï¼Œè¿™åœ¨ Struts2 ä¸Šæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼ˆå› ä¸ºæœ¬èº« Struts2 å¤„ç† Json çš„å‡ ç§æ–¹æ³•å°±éƒ½å¾ˆçƒ‚ï¼‰ã€‚ä½†æ˜¯æˆ‘æ¥æ‰‹æ¢æˆ Spring MVC åï¼Œä½¿ç”¨ @ResponseBody è¿”å›å¯¹è±¡æ—¶å°±ä¼šæŠ¥æ‰¾ä¸åˆ°è½¬æ¢å™¨é”™è¯¯ã€‚

è¿™æ˜¯å› ä¸º Spring MVC é»˜è®¤ä¼šå°†åç¼€åä¸º.html çš„è¯·æ±‚çš„ Content-Type è®¤ä¸ºæ˜¯ text/html ï¼Œè€Œ @ResponseBody è¿”å›çš„ Content-Type æ˜¯ application/json ï¼Œæ²¡æœ‰ä»»ä½•ä¸€ç§è½¬æ¢å™¨æ”¯æŒè¿™æ ·çš„è½¬æ¢ã€‚æ‰€ä»¥éœ€è¦æ‰‹åŠ¨å°†é€šè¿‡åç¼€ååˆ¤æ–­ Content-Type çš„è®¾ç½®å…³æ‰ï¼Œå¹¶å°†é»˜è®¤çš„ Content-Type è®¾ç½®ä¸º application/json ï¼š

```java
@Configuration
public class WebMvcConfig extends WebMvcConfigurerAdapter {

    @Override
    public void configureContentNegotiation(ContentNegotiationConfigurer configurer) {
        configurer.favorPathExtension(false).
                defaultContentType(MediaType.APPLICATION_JSON);
    }
}
```

### æ›´æ”¹é»˜è®¤çš„ Json åºåˆ—åŒ–æ–¹æ¡ˆ

é¡¹ç›®ä¸­æœ‰æ—¶å€™ä¼šæœ‰è‡ªå·±ç‹¬ç‰¹çš„ Json åºåˆ—åŒ–æ–¹æ¡ˆï¼Œä¾‹å¦‚æ¯”è¾ƒå¸¸ç”¨çš„ä½¿ç”¨ 0 / 1 æ›¿ä»£ false / true ï¼Œæˆ–æ˜¯é€šè¿‡ "" ä»£æ›¿ null ï¼Œç”±äº @ResponseBody é»˜è®¤ä½¿ç”¨çš„æ˜¯ MappingJackson2HttpMessageConverter ï¼Œåªéœ€è¦å°†è‡ªå·±å®ç°çš„ ObjectMapper ä¼ å…¥è¿™ä¸ªè½¬æ¢å™¨ï¼š

```java
public class CustomObjectMapper extends ObjectMapper {

    public CustomObjectMapper() {
        super();
        this.getSerializerProvider().setNullValueSerializer(new JsonSerializer<Object>() {
            @Override
            public void serialize(Object value, JsonGenerator jgen, SerializerProvider provider) throws IOException {
                jgen.writeString("");
            }
        });
        SimpleModule module = new SimpleModule();
        module.addSerializer(boolean.class, new JsonSerializer<Boolean>() {
            @Override
            public void serialize(Boolean value, JsonGenerator jgen, SerializerProvider provider) throws IOException {
                jgen.writeNumber(value ? 1 : 0);
            }
        });
        this.registerModule(module);
    }
}
```

### è‡ªåŠ¨åŠ å¯†/è§£å¯†è¯·æ±‚ä¸­çš„ Json

æ¶‰åŠåˆ° @RequestBody å’Œ @ResponseBody çš„ç±»å‹è½¬æ¢é—®é¢˜ä¸€èˆ¬éƒ½åœ¨ MappingJackson2HttpMessageConverter ä¸­è§£å†³ï¼Œæƒ³è¦è‡ªåŠ¨åŠ å¯†/è§£å¯†åªéœ€è¦ç»§æ‰¿è¿™ä¸ªç±»å¹¶é‡å†™ readInternal / writeInternal æ–¹æ³•å³å¯ï¼š

```java
@Override
protected Object readInternal(Class<?> clazz, HttpInputMessage inputMessage) throws IOException, HttpMessageNotReadableException {
    //è§£å¯†
    String json = AESUtil.decrypt(inputMessage.getBody());
    JavaType javaType = getJavaType(clazz, null);
    //è½¬æ¢
    return this.objectMapper.readValue(json, javaType);
}

@Override
protected void writeInternal(Object object, HttpOutputMessage outputMessage) throws IOException, HttpMessageNotWritableException {
    //ä½¿ç”¨Jacksonçš„ObjectMapperå°†Javaå¯¹è±¡è½¬æ¢æˆJson String
    ObjectMapper mapper = new ObjectMapper();
    String json = mapper.writeValueAsString(object);
    //åŠ å¯†
    String result = AESUtil.encrypt(json);
    //è¾“å‡º
    outputMessage.getBody().write(result.getBytes());
}
```

### åŸºäºæ³¨è§£çš„æ•æ„Ÿè¯è¿‡æ»¤åŠŸèƒ½

é¡¹ç›®éœ€è¦å¯¹ç”¨æˆ·å‘å¸ƒçš„å†…å®¹è¿›è¡Œè¿‡æ»¤ï¼Œå°†å…¶ä¸­çš„æ•æ„Ÿè¯æ›¿æ¢ä¸º `*` ç­‰ç‰¹æ®Šå­—ç¬¦ã€‚å¤§éƒ¨åˆ† Web é¡¹ç›®åœ¨å¤„ç†è¿™æ–¹é¢éœ€æ±‚æ—¶éƒ½ä¼šé€‰æ‹©è¿‡æ»¤å™¨ï¼ˆ Filter ï¼‰ï¼Œåœ¨è¿‡æ»¤å™¨ä¸­å°† Request åŒ…ä¸Šä¸€å±‚ Wrapper ï¼Œå¹¶é‡å†™å…¶ getParameter ç­‰æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š

```java
public class SafeTextRequestWrapper extends HttpServletRequestWrapper {
    public SafeTextRequestWrapper(HttpServletRequest req) {
        super(req);
    }

    @Override
    public Map<String, String[]> getParameterMap() {
        Map<String, String[]> paramMap = super.getParameterMap();
        for (String[] values : paramMap.values()) {
            for (int i = 0; i < values.length; i++) {
                values[i] = SensitiveUtil.filter(values[i]);
            }
        }
        return paramMap ;
    }

    @Override
    public String getParameter(String name) {
        return SensitiveUtil.filter(super.getParameter(name));
    }
}

public class SafeTextFilter implements Filter {
    @Override
    public void init(FilterConfig filterConfig) throws ServletException {

    }

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
        SafeTextRequestWrapper safeTextRequestWrapper = new SafeTextRequestWrapper((HttpServletRequest) request);
        chain.doFilter(safeTextRequestWrapper, response);
    }

    @Override
    public void destroy() {

    }
}
```

ä½†æ˜¯è¿™æ ·åšä¼šæœ‰ä¸€äº›æ˜æ˜¾çš„é—®é¢˜ï¼Œæ¯”å¦‚æ— æ³•æ§åˆ¶å…·ä½“å¯¹å“ªäº›ä¿¡æ¯è¿›è¡Œè¿‡æ»¤ã€‚å¦‚æœç”¨æˆ·æ³¨å†Œçš„é‚®ç®±æˆ–æ˜¯å¯†ç ä¸­ä¹Ÿå¸¦æœ‰ fuck ä¹‹ç±»çš„æ•æ„Ÿè¯ï¼Œé‚£å°±å±äºè¯¯ä¼¤äº†ã€‚

æ‰€ä»¥æ”¹ç”¨ Spring MVC çš„ Formatter è¿›è¡Œæ‹“å±•ï¼Œåªéœ€è¦åœ¨ @RequestParam çš„å‚æ•°ä¸Šä½¿ç”¨ @SensitiveFormat æ³¨è§£ï¼ŒSpring MVC å°±ä¼šåœ¨æ³¨å…¥è¯¥å±æ€§æ—¶è‡ªåŠ¨è¿›è¡Œæ•æ„Ÿè¯è¿‡æ»¤ã€‚æ—¢æ–¹ä¾¿åˆä¸ä¼šè¯¯ä¼¤ï¼Œå®ç°æ–¹æ³•å¦‚ä¸‹ï¼š

å£°æ˜ @SensitiveFormat æ³¨è§£ï¼š

```java
@Target({ElementType.FIELD, ElementType.PARAMETER})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface SensitiveFormat {
}
```

åˆ›å»º SensitiveFormatter ç±»ã€‚å®ç° Formatter æ¥å£ï¼Œé‡å†™ parse æ–¹æ³•ï¼ˆå°†æ¥æ”¶åˆ°çš„å†…å®¹è½¬æ¢æˆå¯¹è±¡çš„æ–¹æ³•ï¼‰ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­å¯¹æ¥æ”¶å†…å®¹è¿›è¡Œè¿‡æ»¤ï¼š

```java
public class SensitiveFormatter implements Formatter<String> {
    @Override
    public String parse(String text, Locale locale) throws ParseException {
        return SensitiveUtil.filter(text);
    }

    @Override
    public String print(String object, Locale locale) {
        return object;
    }
}
```

åˆ›å»º SensitiveFormatAnnotationFormatterFactory ç±»ï¼Œå®ç° AnnotationFormatterFactory æ¥å£ï¼Œå°† @SensitiveFormat ä¸ SensitiveFormatter ç»‘å®šï¼š

```java
public class SensitiveFormatAnnotationFormatterFactory implements AnnotationFormatterFactory<SensitiveFormat> {

    @Override
    public Set<Class<?>> getFieldTypes() {
        Set<Class<?>> fieldTypes = new HashSet<>();
        fieldTypes.add(String.class);
        return fieldTypes;
    }

    @Override
    public Printer<?> getPrinter(SensitiveFormat annotation, Class<?> fieldType) {
        return new SensitiveFormatter();
    }

    @Override
    public Parser<?> getParser(SensitiveFormat annotation, Class<?> fieldType) {
        return new SensitiveFormatter();
    }
}
```

æœ€åå°† SensitiveFormatAnnotationFormatterFactory æ³¨å†Œåˆ° Spring MVC ä¸­ï¼š

```java
@Configuration
public class WebMvcConfig extends WebMvcConfigurerAdapter {

    @Override
    public void addFormatters(FormatterRegistry registry) {
        registry.addFormatterForFieldAnnotation(new SensitiveFormatAnnotationFormatterFactory());
        super.addFormatters(registry);
    }
}
```

### è®°å½•è¯·æ±‚çš„è¿”å›å†…å®¹

è¿™é‡Œæä¾›ä¸€ç§æ¯”è¾ƒé€šç”¨çš„æ–¹æ³•ï¼ŒåŸºäºè¿‡æ»¤å™¨å®ç°ï¼Œæ‰€ä»¥åœ¨é Spring MVC çš„é¡¹ç›®ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚

é¦–å…ˆå¯¼å…¥ commons-io ï¼š

```java
<dependency>
  <groupId>commons-io</groupId>
  <artifactId>commons-io</artifactId>
  <version>2.4</version>
</dependency>
```

éœ€è¦ç”¨åˆ°è¿™ä¸ªåº“ä¸­çš„ TeeOutputStream ï¼Œè¿™ä¸ªç±»å¯ä»¥å°†ä¸€ä¸ªå°†å†…å®¹åŒæ—¶è¾“å‡ºåˆ°ä¸¤ä¸ªåˆ†æ”¯çš„è¾“å‡ºæµï¼Œå°†å…¶å°è£…ä¸º ServletOutputStream ï¼š

```java
public class TeeServletOutputStream extends ServletOutputStream {

    private final TeeOutputStream teeOutputStream;

    public TeeServletOutputStream(OutputStream one, OutputStream two) {
        this.teeOutputStream = new TeeOutputStream(one, two);
    }

    @Override
    public boolean isReady() {
        return false;
    }

    @Override
    public void setWriteListener(WriteListener listener) {

    }

    @Override
    public void write(int b) throws IOException {
        this.teeOutputStream.write(b);
    }

    @Override
    public void flush() throws IOException {
        super.flush();
        this.teeOutputStream.flush();
    }

    @Override
    public void close() throws IOException {
        super.close();
        this.teeOutputStream.close();
    }
}
```

ç„¶ååˆ›å»ºä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œå°†åŸæœ‰çš„ response çš„ getOutputStream æ–¹æ³•é‡å†™ï¼š

```java
public class LoggingFilter implements Filter {

    private static final Logger LOGGER = LoggerFactory.getLogger(LoggingFilter.class);

    @Override
    public void init(FilterConfig filterConfig) throws ServletException {

    }

    public void doFilter(ServletRequest request, final ServletResponse response, FilterChain chain) throws IOException, ServletException {
        final ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();

        HttpServletResponseWrapper responseWrapper = new HttpServletResponseWrapper((HttpServletResponse) response) {

            private TeeServletOutputStream teeServletOutputStream;

            @Override
            public ServletOutputStream getOutputStream() throws IOException {
                return new TeeServletOutputStream(super.getOutputStream(), byteArrayOutputStream);
            }
        };
        chain.doFilter(request, responseWrapper);
        String responseLog = byteArrayOutputStream.toString();
        if (LOGGER.isInfoEnabled() && !StringUtil.isEmpty(responseLog)) {
            LOGGER.info(responseLog);
        }
    }

    @Override
    public void destroy() {

    }
}
```

å°† super.getOutputStream() å’Œ ByteArrayOutputStream åˆ†åˆ«ä½œä¸ºä¸¤ä¸ªåˆ†æ”¯æµï¼Œå‰è€…ä¼šå°†å†…å®¹è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œåè€…ä½¿ç”¨ toString æ–¹æ³•å³å¯è·å¾—è¾“å‡ºå†…å®¹ã€‚

## [åŸºäº Spring çš„ Token é‰´æƒç³»ç»Ÿæ­å»ºæ•™ç¨‹](https://blog.dong4j.site/posts/2c481faa.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

### ä»€ä¹ˆæ˜¯ REST

REST (Representational State Transfer) æ˜¯ä¸€ç§è½¯ä»¶æ¶æ„é£æ ¼ã€‚å®ƒå°†æœåŠ¡ç«¯çš„ä¿¡æ¯å’ŒåŠŸèƒ½ç­‰æ‰€æœ‰äº‹ç‰©ç»Ÿç§°ä¸ºèµ„æºï¼Œå®¢æˆ·ç«¯çš„è¯·æ±‚å®é™…å°±æ˜¯å¯¹èµ„æºè¿›è¡Œæ“ä½œï¼Œå®ƒçš„ä¸»è¦ç‰¹ç‚¹æœ‰ï¼š - æ¯ä¸€ä¸ªèµ„æºéƒ½ä¼šå¯¹åº”ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„ url - å®¢æˆ·ç«¯é€šè¿‡ HTTP çš„ GETã€POSTã€PUTã€DELETE è¯·æ±‚æ–¹æ³•å¯¹èµ„æºè¿›è¡ŒæŸ¥è¯¢ã€åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤æ“ä½œ - å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„äº¤äº’å¿…é¡»æ˜¯æ— çŠ¶æ€çš„

### ä½¿ç”¨ Token è¿›è¡Œèº«ä»½é‰´æƒ

ç½‘ç«™åº”ç”¨ä¸€èˆ¬ä½¿ç”¨ Session è¿›è¡Œç™»å½•ç”¨æˆ·ä¿¡æ¯çš„å­˜å‚¨åŠéªŒè¯ï¼Œè€Œåœ¨ç§»åŠ¨ç«¯ä½¿ç”¨ Token åˆ™æ›´åŠ æ™®éã€‚å®ƒä»¬ä¹‹é—´å¹¶æ²¡æœ‰å¤ªå¤§åŒºåˆ«ï¼ŒToken æ¯”è¾ƒåƒæ˜¯ä¸€ä¸ªæ›´åŠ ç²¾ç®€çš„è‡ªå®šä¹‰çš„ Sessionã€‚Session çš„ä¸»è¦åŠŸèƒ½æ˜¯ä¿æŒä¼šè¯ä¿¡æ¯ï¼Œè€Œ Token åˆ™åªç”¨äºç™»å½•ç”¨æˆ·çš„èº«ä»½é‰´æƒã€‚æ‰€ä»¥åœ¨ç§»åŠ¨ç«¯ä½¿ç”¨ Token ä¼šæ¯”ä½¿ç”¨ Session æ›´åŠ ç®€æ˜“å¹¶ä¸”æœ‰æ›´é«˜çš„å®‰å…¨æ€§ï¼ŒåŒæ—¶ä¹Ÿæ›´åŠ ç¬¦åˆ RESTful ä¸­æ— çŠ¶æ€çš„å®šä¹‰ã€‚

### äº¤äº’æµç¨‹

1. å®¢æˆ·ç«¯é€šè¿‡ç™»å½•è¯·æ±‚æäº¤ç”¨æˆ·åå’Œå¯†ç ï¼ŒæœåŠ¡ç«¯éªŒè¯é€šè¿‡åç”Ÿæˆä¸€ä¸ª Token ä¸è¯¥ç”¨æˆ·è¿›è¡Œå…³è”ï¼Œå¹¶å°† Token è¿”å›ç»™å®¢æˆ·ç«¯ã€‚
2. å®¢æˆ·ç«¯åœ¨æ¥ä¸‹æ¥çš„è¯·æ±‚ä¸­éƒ½ä¼šæºå¸¦ Tokenï¼ŒæœåŠ¡ç«¯é€šè¿‡è§£æ Token æ£€æŸ¥ç™»å½•çŠ¶æ€ã€‚
3. å½“ç”¨æˆ·é€€å‡ºç™»å½•ã€å…¶ä»–ç»ˆç«¯ç™»å½•åŒä¸€è´¦å·ï¼ˆè¢«é¡¶å·ï¼‰ã€é•¿æ—¶é—´æœªè¿›è¡Œæ“ä½œæ—¶ Token ä¼šå¤±æ•ˆï¼Œè¿™æ—¶ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•ã€‚

### ç¨‹åºç¤ºä¾‹

æœåŠ¡ç«¯ç”Ÿæˆçš„ Token ä¸€èˆ¬ä¸ºéšæœºçš„éé‡å¤å­—ç¬¦ä¸²ï¼Œæ ¹æ®åº”ç”¨å¯¹å®‰å…¨æ€§çš„ä¸åŒè¦æ±‚ï¼Œä¼šå°†å…¶æ·»åŠ æ—¶é—´æˆ³ï¼ˆé€šè¿‡æ—¶é—´åˆ¤æ–­ Token æ˜¯å¦è¢«ç›—ç”¨ï¼‰æˆ– url ç­¾åï¼ˆé€šè¿‡è¯·æ±‚åœ°å€åˆ¤æ–­ Token æ˜¯å¦è¢«ç›—ç”¨ï¼‰ååŠ å¯†è¿›è¡Œä¼ è¾“ã€‚åœ¨æœ¬æ–‡ä¸­ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œä»…æ˜¯å°† User Id ä¸ Token ä»¥ `_` è¿›è¡Œæ‹¼æ¥ã€‚

```java
/**
 * Token çš„ Model ç±»ï¼Œå¯ä»¥å¢åŠ å­—æ®µæé«˜å®‰å…¨æ€§ï¼Œä¾‹å¦‚æ—¶é—´æˆ³ã€url ç­¾å
 */
public class TokenModel {

    // ç”¨æˆ· id
    private long userId;

    // éšæœºç”Ÿæˆçš„ uuid
    private String token;

    public TokenModel (long userId, String token) {
        this.userId = userId;
        this.token = token;
    }

    public long getUserId () {
        return userId;
    }

    public void setUserId (long userId) {
        this.userId = userId;
    }

    public String getToken () {
        return token;
    }

    public void setToken (String token) {
        this.token = token;
    }
}
```

Redis æ˜¯ä¸€ä¸ª Key-Value ç»“æ„çš„å†…å­˜æ•°æ®åº“ï¼Œç”¨å®ƒç»´æŠ¤ User Id å’Œ Token çš„æ˜ å°„è¡¨ä¼šæ¯”ä¼ ç»Ÿæ•°æ®åº“é€Ÿåº¦æ›´å¿«ï¼Œè¿™é‡Œä½¿ç”¨ Spring-Data-Redis å°è£…çš„ TokenManager å¯¹ Token è¿›è¡ŒåŸºç¡€æ“ä½œï¼š

```java
/**
 * å¯¹ token è¿›è¡Œæ“ä½œçš„æ¥å£
 */
public interface TokenManager {

    /**
     * åˆ›å»ºä¸€ä¸ª token å…³è”ä¸ŠæŒ‡å®šç”¨æˆ·
     * @param userId æŒ‡å®šç”¨æˆ·çš„ id
     * @return ç”Ÿæˆçš„ token
     */
    public TokenModel createToken (long userId);

    /**
     * æ£€æŸ¥ token æ˜¯å¦æœ‰æ•ˆ
     * @param model token
     * @return æ˜¯å¦æœ‰æ•ˆ
     */
    public boolean checkToken (TokenModel model);

    /**
     * ä»å­—ç¬¦ä¸²ä¸­è§£æ token
     * @param authentication åŠ å¯†åçš„å­—ç¬¦ä¸²
     * @return
     */
    public TokenModel getToken (String authentication);

    /**
     * æ¸…é™¤ token
     * @param userId ç™»å½•ç”¨æˆ·çš„ id
     */
    public void deleteToken (long userId);

}

/**
 * é€šè¿‡ Redis å­˜å‚¨å’ŒéªŒè¯ token çš„å®ç°ç±»
 */
@Component
public class RedisTokenManager implements TokenManager {

    private RedisTemplate redis;

    @Autowired
    public void setRedis (RedisTemplate redis) {
        this.redis = redis;
        // æ³›å‹è®¾ç½®æˆ Long åå¿…é¡»æ›´æ”¹å¯¹åº”çš„åºåˆ—åŒ–æ–¹æ¡ˆ
        redis.setKeySerializer (new JdkSerializationRedisSerializer ());
    }

    public TokenModel createToken (long userId) {
        // ä½¿ç”¨ uuid ä½œä¸ºæº token
        String token = UUID.randomUUID ().toString ().replace ("-", "");
        TokenModel model = new TokenModel (userId, token);
        // å­˜å‚¨åˆ° redis å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´
        redis.boundValueOps (userId).set (token, Constants.TOKEN_EXPIRES_HOUR, TimeUnit.HOURS);
        return model;
    }

    public TokenModel getToken (String authentication) {
        if (authentication == null || authentication.length () == 0) {
            return null;
        }
        String [] param = authentication.split ("_");
        if (param.length != 2) {
            return null;
        }
        // ä½¿ç”¨ userId å’Œæº token ç®€å•æ‹¼æ¥æˆçš„ tokenï¼Œå¯ä»¥å¢åŠ åŠ å¯†æªæ–½
        long userId = Long.parseLong (param [0]);
        String token = param [1];
        return new TokenModel (userId, token);
    }

    public boolean checkToken (TokenModel model) {
        if (model == null) {
            return false;
        }
        String token = redis.boundValueOps (model.getUserId ()).get ();
        if (token == null || !token.equals (model.getToken ())) {
            return false;
        }
        // å¦‚æœéªŒè¯æˆåŠŸï¼Œè¯´æ˜æ­¤ç”¨æˆ·è¿›è¡Œäº†ä¸€æ¬¡æœ‰æ•ˆæ“ä½œï¼Œå»¶é•¿ token çš„è¿‡æœŸæ—¶é—´
        redis.boundValueOps (model.getUserId ()).expire (Constants.TOKEN_EXPIRES_HOUR, TimeUnit.HOURS);
        return true;
    }

    public void deleteToken (long userId) {
        redis.delete (userId);
    }
}
```

RESTful ä¸­æ‰€æœ‰è¯·æ±‚çš„æœ¬è´¨éƒ½æ˜¯å¯¹èµ„æºè¿›è¡Œ CRUD æ“ä½œï¼Œæ‰€ä»¥ç™»å½•å’Œé€€å‡ºç™»å½•ä¹Ÿå¯ä»¥æŠ½è±¡ä¸ºå¯¹ä¸€ä¸ª Token èµ„æºçš„åˆ›å»ºå’Œåˆ é™¤ï¼Œæ ¹æ®è¯¥æƒ³æ³•åˆ›å»º Controllerï¼š

```java
/**
 * è·å–å’Œåˆ é™¤ token çš„è¯·æ±‚åœ°å€ï¼Œåœ¨ Restful è®¾è®¡ä¸­å…¶å®å°±å¯¹åº”ç€ç™»å½•å’Œé€€å‡ºç™»å½•çš„èµ„æºæ˜ å°„
 */
@RestController
@RequestMapping ("/tokens")
public class TokenController {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private TokenManager tokenManager;

    @RequestMapping (method = RequestMethod.POST)
    public ResponseEntity login (@RequestParam String username, @RequestParam String password) {
        Assert.notNull (username, "username can not be empty");
        Assert.notNull (password, "password can not be empty");

        User user = userRepository.findByUsername (username);
        if (user == null || // æœªæ³¨å†Œ
                !user.getPassword ().equals (password)) { // å¯†ç é”™è¯¯
            // æç¤ºç”¨æˆ·åæˆ–å¯†ç é”™è¯¯
            return new ResponseEntity (ResultModel.error (ResultStatus.USERNAME_OR_PASSWORD_ERROR), HttpStatus.NOT_FOUND);
        }
        // ç”Ÿæˆä¸€ä¸ª tokenï¼Œä¿å­˜ç”¨æˆ·ç™»å½•çŠ¶æ€
        TokenModel model = tokenManager.createToken (user.getId ());
        return new ResponseEntity (ResultModel.ok (model), HttpStatus.OK);
    }

    @RequestMapping (method = RequestMethod.DELETE)
    @Authorization
    public ResponseEntity logout (@CurrentUser User user) {
        tokenManager.deleteToken (user.getId ());
        return new ResponseEntity (ResultModel.ok (), HttpStatus.OK);
    }

}
```

è¿™ä¸ª Controller ä¸­æœ‰ä¸¤ä¸ªè‡ªå®šä¹‰çš„æ³¨è§£åˆ†åˆ«æ˜¯`@Authorization`å’Œ`@CurrentUser`ï¼Œå…¶ä¸­`@Authorization`ç”¨äºè¡¨ç¤ºè¯¥æ“ä½œéœ€è¦ç™»å½•åæ‰èƒ½è¿›è¡Œï¼š

```java
/**Â Â *Â åœ¨ Controller çš„æ–¹æ³•ä¸Šä½¿ç”¨æ­¤æ³¨è§£ï¼Œè¯¥æ–¹æ³•åœ¨æ˜ å°„æ—¶ä¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Œæœªç™»å½•è¿”å› 401 é”™è¯¯Â Â *Â @authorÂ ScienJusÂ Â *Â @dateÂ 2015/7/31.Â Â */Â @Target (ElementType.METHOD)Â @Retention (RetentionPolicy.RUNTIME)Â publicÂ @interfaceÂ AuthorizationÂ {Â }/**
 * åœ¨ Controller çš„æ–¹æ³•ä¸Šä½¿ç”¨æ­¤æ³¨è§£ï¼Œè¯¥æ–¹æ³•åœ¨æ˜ å°„æ—¶ä¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Œæœªç™»å½•è¿”å› 401 é”™è¯¯
 */
@Target (ElementType.METHOD)
@Retention (RetentionPolicy.RUNTIME)
public @interface Authorization {
}
```

è¿™é‡Œä½¿ç”¨ Spring çš„æ‹¦æˆªå™¨å®Œæˆè¿™ä¸ªåŠŸèƒ½ï¼Œè¯¥æ‹¦æˆªå™¨ä¼šæ£€æŸ¥æ¯ä¸€ä¸ªè¯·æ±‚æ˜ å°„çš„æ–¹æ³•æ˜¯å¦æœ‰`@Authorization`æ³¨è§£ï¼Œå¹¶ä½¿ç”¨ TokenManager éªŒè¯ Tokenï¼Œå¦‚æœéªŒè¯å¤±è´¥ç›´æ¥è¿”å› 401 çŠ¶æ€ç ï¼ˆæœªæˆæƒï¼‰ï¼š

```java
/**
 * è‡ªå®šä¹‰æ‹¦æˆªå™¨ï¼Œåˆ¤æ–­æ­¤æ¬¡è¯·æ±‚æ˜¯å¦æœ‰æƒé™
 */
@Component
public class AuthorizationInterceptor extends HandlerInterceptorAdapter {

    @Autowired
    private TokenManager manager;

    public boolean preHandle (HttpServletRequest request,
                             HttpServletResponse response, Object handler) throws Exception {
        // å¦‚æœä¸æ˜¯æ˜ å°„åˆ°æ–¹æ³•ç›´æ¥é€šè¿‡
        if (!(handler instanceof HandlerMethod)) {
            return true;
        }
        HandlerMethod handlerMethod = (HandlerMethod) handler;
        Method method = handlerMethod.getMethod ();
        // ä» header ä¸­å¾—åˆ° token
        String authorization = request.getHeader (Constants.AUTHORIZATION);
        // éªŒè¯ token
        TokenModel model = manager.getToken (authorization);
        if (manager.checkToken (model)) {
            // å¦‚æœ token éªŒè¯æˆåŠŸï¼Œå°† token å¯¹åº”çš„ç”¨æˆ· id å­˜åœ¨ request ä¸­ï¼Œä¾¿äºä¹‹åæ³¨å…¥
            request.setAttribute (Constants.CURRENT_USER_ID, model.getUserId ());
            return true;
        }
        // å¦‚æœéªŒè¯ token å¤±è´¥ï¼Œå¹¶ä¸”æ–¹æ³•æ³¨æ˜äº† Authorizationï¼Œè¿”å› 401 é”™è¯¯
        if (method.getAnnotation (Authorization.class) != null) {
            response.setStatus (HttpServletResponse.SC_UNAUTHORIZED);
            return false;
        }
        return true;
    }
}
```

`@CurrentUser`æ³¨è§£å®šä¹‰åœ¨æ–¹æ³•çš„å‚æ•°ä¸­ï¼Œè¡¨ç¤ºè¯¥å‚æ•°æ˜¯ç™»å½•ç”¨æˆ·å¯¹è±¡ã€‚è¿™é‡ŒåŒæ ·ä½¿ç”¨äº† Spring çš„è§£æå™¨å®Œæˆå‚æ•°æ³¨å…¥ï¼š

```java
/**
 * åœ¨ Controller çš„æ–¹æ³•å‚æ•°ä¸­ä½¿ç”¨æ­¤æ³¨è§£ï¼Œè¯¥æ–¹æ³•åœ¨æ˜ å°„æ—¶ä¼šæ³¨å…¥å½“å‰ç™»å½•çš„ User å¯¹è±¡
 */
@Target (ElementType.PARAMETER)
@Retention (RetentionPolicy.RUNTIME)
public @interface CurrentUser {
}

/**
 * å¢åŠ æ–¹æ³•æ³¨å…¥ï¼Œå°†å«æœ‰ CurrentUser æ³¨è§£çš„æ–¹æ³•å‚æ•°æ³¨å…¥å½“å‰ç™»å½•ç”¨æˆ·
 */
@Component
public class CurrentUserMethodArgumentResolver implements HandlerMethodArgumentResolver {

    @Autowired
    private UserRepository userRepository;

    @Override
    public boolean supportsParameter (MethodParameter parameter) {
        // å¦‚æœå‚æ•°ç±»å‹æ˜¯ User å¹¶ä¸”æœ‰ CurrentUser æ³¨è§£åˆ™æ”¯æŒ
        if (parameter.getParameterType ().isAssignableFrom (User.class) &&
                parameter.hasParameterAnnotation (CurrentUser.class)) {
            return true;
        }
        return false;
    }

    @Override
    public Object resolveArgument (MethodParameter parameter, ModelAndViewContainer mavContainer, NativeWebRequest webRequest, WebDataBinderFactory binderFactory) throws Exception {
        // å–å‡ºé‰´æƒæ—¶å­˜å…¥çš„ç™»å½•ç”¨æˆ· Id
        Long currentUserId = (Long) webRequest.getAttribute (Constants.CURRENT_USER_ID, RequestAttributes.SCOPE_REQUEST);
        if (currentUserId != null) {
            // ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å¹¶è¿”å›
            return userRepository.findOne (currentUserId);
        }
        throw new MissingServletRequestPartException (Constants.CURRENT_USER_ID);
    }
}
```

### ä¸€äº›ç»†èŠ‚

- ç™»å½•è¯·æ±‚ä¸€å®šè¦ä½¿ç”¨ HTTPSï¼Œå¦åˆ™æ— è®º Token åšçš„å®‰å…¨æ€§å¤šå¥½å¯†ç æ³„éœ²äº†ä¹Ÿæ˜¯ç™½æ­
- Token çš„ç”Ÿæˆæ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œä¾‹å¦‚æ¯”è¾ƒçƒ­é—¨çš„æœ‰ JWTï¼ˆJSON Web Tokensï¼‰ã€OAuth ç­‰ã€‚

## [@Autowired å’Œ @Resourceï¼šå“ªç§æ–¹å¼æ›´é€‚åˆä½ çš„é¡¹ç›®ï¼Ÿ](https://blog.dong4j.site/posts/499585b.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

1. **ä½œç”¨**: ä¸¤è€…éƒ½å¯ä»¥ç”¨æ¥è£…é… beanï¼Œå¯ä»¥å†™åœ¨å­—æ®µä¸Šæˆ–å†™åœ¨ setter æ–¹æ³•ä¸Šã€‚
2. **é»˜è®¤æ³¨å…¥æ–¹å¼**:
   - **@Autowired (Spring æ³¨è§£)**: é»˜è®¤æŒ‰ç±»å‹ (byType) æ³¨å…¥ã€‚
   - **@Resource (J2EE æ³¨è§£)**: é»˜è®¤æŒ‰åç§° (byName) æ³¨å…¥ã€‚
3. **required å±æ€§**:
   - **@Autowired**: é»˜è®¤è¦æ±‚ä¾èµ–å¯¹è±¡å¿…é¡»å­˜åœ¨ï¼Œå¯ä»¥è®¾ç½® required=false å…è®¸ null å€¼ã€‚
   - **@Resource**: é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰¾ä¸åˆ°åŒ¹é…çš„ bean ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚
4. **æŒ‡å®šåç§°**:
   - **@Autowired**: å¯ä»¥ç»“åˆ @Qualifier æ³¨è§£æŒ‡å®š bean çš„åç§°ã€‚
   - **@Resource**: å¯ä»¥ç›´æ¥åœ¨æ³¨è§£ä¸­é€šè¿‡ name å±æ€§æŒ‡å®š bean çš„åç§°ã€‚
5. **ä»£ç ç¤ºä¾‹**:

```java
// ä½¿ç”¨ @Autowired
@Autowired
@Qualifier("baseDao")
private BaseDao baseDao;
// ä½¿ç”¨ @Resource
@Resource(name="baseDao")
private BaseDao baseDao;
```

## Spring æ³¨è§£ @Resource å’Œ @Autowired åŒºåˆ«å¯¹æ¯”

1. **å…±åŒç‚¹**:
   - ä¸¤è€…éƒ½å¯ä»¥å†™åœ¨å­—æ®µå’Œ setter æ–¹æ³•ä¸Šã€‚
   - å¦‚æœéƒ½å†™åœ¨å­—æ®µä¸Šï¼Œåˆ™ä¸éœ€è¦å†å†™ setter æ–¹æ³•ã€‚
2. **ä¸åŒç‚¹**:
   - **@Autowired**:
     - é»˜è®¤æŒ‰ç±»å‹ (byType) æ³¨å…¥ã€‚
     - å¯ä»¥è®¾ç½® required å±æ€§å…è®¸ null å€¼ã€‚
     - å¯ä»¥ç»“åˆ @Qualifier æ³¨è§£æŒ‡å®š bean çš„åç§°ã€‚
   - **@Resource**:
     - é»˜è®¤æŒ‰åç§° (byName) æ³¨å…¥ã€‚
     - å¯ä»¥ç›´æ¥åœ¨æ³¨è§£ä¸­é€šè¿‡ name å±æ€§æŒ‡å®š bean çš„åç§°ã€‚
     - ä¹Ÿå¯ä»¥é€šè¿‡ type å±æ€§æŒ‰ç±»å‹æ³¨å…¥ã€‚
     - å¦‚æœæ—¢ä¸æŒ‡å®š name ä¹Ÿä¸æŒ‡å®š typeï¼Œåˆ™é»˜è®¤æŒ‰ byName æ³¨å…¥ã€‚
3. **æ³¨å…¥é¡ºåº**:
   - **@Resource**:
     1. å¦‚æœæŒ‡å®šäº† name å’Œ typeï¼Œåˆ™æŸ¥æ‰¾å”¯ä¸€åŒ¹é…çš„ beanã€‚
     2. å¦‚æœæŒ‡å®šäº† nameï¼Œåˆ™æŸ¥æ‰¾åç§°åŒ¹é…çš„ beanã€‚
     3. å¦‚æœæŒ‡å®šäº† typeï¼Œåˆ™æŸ¥æ‰¾ç±»å‹åŒ¹é…çš„ beanã€‚
     4. å¦‚æœæ—¢ä¸æŒ‡å®š name ä¹Ÿä¸æŒ‡å®š typeï¼Œåˆ™å…ˆæŒ‰ byName æ³¨å…¥ï¼Œæ‰¾ä¸åˆ°åˆ™æŒ‰ byType æ³¨å…¥ã€‚

## æ€»ç»“

- **é€‰æ‹©å»ºè®®**:
  - å¦‚æœæ›´å€¾å‘äºæŒ‰ç±»å‹æ³¨å…¥ï¼Œå»ºè®®ä½¿ç”¨ @Autowiredã€‚
  - å¦‚æœæ›´å€¾å‘äºæŒ‰åç§°æ³¨å…¥ï¼Œæˆ–è€…å¸Œæœ›å‡å°‘ä¸ Spring çš„è€¦åˆï¼Œå»ºè®®ä½¿ç”¨ @Resourceã€‚
- **ä½¿ç”¨åœºæ™¯**:
  _ @Autowired é€‚ç”¨äºå¤§å¤šæ•°æƒ…å†µï¼Œå°¤å…¶æ˜¯åœ¨ä¾èµ–ç±»å‹æ˜ç¡®çš„åœºæ™¯ä¸‹ã€‚
  _ @Resource é€‚ç”¨äºä¾èµ–åç§°æ˜ç¡®çš„åœºæ™¯ï¼Œæˆ–è€…å¸Œæœ›å‡å°‘ä¸ Spring è€¦åˆçš„åœºæ™¯ã€‚
  å¸Œæœ›ä»¥ä¸Šä¿¡æ¯å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ï¼

## [ä»é›¶å¼€å§‹ï¼šIntelliJ IDEA ä¸­æ„å»º SpringMVC+Spring+MyBatis é¡¹ç›®](https://blog.dong4j.site/posts/aca063f7.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

ä½¿ç”¨ Intellij idea æ•´åˆ SpringMVC+Spring+Mybatis æ¡†æ¶,åŸºäº Annotation.

## intellij é…ç½®

1.æ–°å»ºä¸€ä¸ª Spring å·¥ç¨‹,å‹¾é€‰ SpringMVC å’Œ Web Application æ”¯æŒ,ä¸é€‰æ‹©ä¸‹è½½ jar åŒ…,è€Œæ˜¯è‡ªå·±å¯¼å…¥ jar åŒ…

![20241229154732_3vhq41x6.webp](https://cdn.dong4j.site/source/image/20241229154732_3vhq41x6.webp)

2.æ–°å»ºå¥½é¡¹ç›®ä¹‹åçš„åŒ…ç»“æ„å¦‚ä¸‹:

![20241229154732_KQqH4hJT.webp](https://cdn.dong4j.site/source/image/20241229154732_KQqH4hJT.webp)

3.åœ¨ WEB-INF ç›®å½•ä¸‹æ–°å»º classes å’Œ lib è¿™ 2 ä¸ªæ–‡ä»¶å¤¹  
F4 è¿›å…¥é¡¹ç›®è®¾ç½®é¡µé¢.  
a. è®¾ç½®ç¼–è¯‘åçš„ class æ–‡ä»¶è¾“å‡ºè·¯å¾„

![20241229154732_NgDzUonq.webp](https://cdn.dong4j.site/source/image/20241229154732_NgDzUonq.webp)

b. å°† lib æ·»åŠ åˆ°æ„å»ºè·¯å¾„ä¸­

![2015-11-23_12-35-15.gif](https://cdn.dong4j.site/source/image/2015-11-23_12-35-15.gif)

c. æ·»åŠ  Tomcat jar åŒ…

![2015-11-23_12-37-18.gif](https://cdn.dong4j.site/source/image/2015-11-23_12-37-18.gif)

4.é…ç½® Tomcat æœåŠ¡å™¨  
 å› ä¸ºä»¥å‰è®¾ç½®è¿‡é»˜è®¤é…ç½®,è¿™é‡Œå°±ç®€å•çš„è®¾ç½®ä¸€ä¸‹å°±å¯ä»¥äº†

![2015-11-23_12-39-56.gif](https://cdn.dong4j.site/source/image/2015-11-23_12-39-56.gif)

5.å°†éœ€è¦çš„ jar åŒ…å¤åˆ¶åˆ° lib æ–‡ä»¶å¤¹ä¸‹

![20241229154732_97GweWsL.webp](https://cdn.dong4j.site/source/image/20241229154732_97GweWsL.webp)

---

## xml é…ç½®

1.åœ¨ src ç›®å½•ä¸‹æ–°å»º:  
 spring-mvc.xml SpringMVC ä½¿ç”¨  
 spring-config.xml Spring å®¹å™¨ä½¿ç”¨  
 mybatis-config.xml Mybatis é…ç½®æ–‡ä»¶

2.web.xml çš„é…ç½®  
 a.é…ç½® SpringMVC çš„æ ¸å¿ƒæ§åˆ¶å™¨ï¼Œå‘ŠçŸ¥ mySpring-cofnig.xml çš„å­˜åœ¨  
 b.é…ç½® Spring å®¹å™¨çš„ç›‘å¬å™¨ å½“æœåŠ¡å™¨å¯åŠ¨æ—¶åŠ è½½ spring å®¹å™¨

```xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"
         version="3.1">

    <!--é…ç½®Springå®¹å™¨çš„ç›‘å¬å™¨,ç”¨äºåŠ è½½Springå®¹å™¨-->
    <listener>
        <listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>
    </listener>
    <context-param>
        <param-name>contextConfigLocation</param-name>
        <param-value>classpath:spring-config.xml</param-value>
    </context-param>

    <!--é…ç½®å‰ç«¯æ§åˆ¶å™¨ SpringMVC-->
    <servlet>
        <servlet-name>spring</servlet-name>
        <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>
        <init-param>
            <param-name>contextConfigLocation</param-name>
            <param-value>classpath:spring-mvc.xml</param-value>
        </init-param>
        <load-on-startup>1</load-on-startup>
    </servlet>
    <servlet-mapping>
        <servlet-name>spring</servlet-name>
        <url-pattern>*.spring</url-pattern>
    </servlet-mapping>

    <!-- è®¾ç½®session -->
    <session-config>
        <session-timeout>15</session-timeout>
    </session-config>

    <welcome-file-list>
        <welcome-file>login.jsp</welcome-file>
        <welcome-file>index.html</welcome-file>
    </welcome-file-list>
</web-app>
```

å¯åŠ¨æœåŠ¡å™¨,å¦‚æœæ²¡æŠ¥é”™,æˆ‘ä»¬ç»§ç»­

---

### å®ç°æœ€ç®€å•çš„ç™»å½•åŠŸèƒ½,ä½¿ç”¨ spring-mvc.xml

å®¢æˆ·ç«¯è¯·æ±‚ -->controller  
åœ¨ src ä¸‹æ–°å»ºéœ€è¦çš„åŒ…  
![20241229154732_CJkpw0wZ.webp](https://cdn.dong4j.site/source/image/20241229154732_CJkpw0wZ.webp)

bean: å®ä½“ bean  
controller: ä¸šåŠ¡æ§åˆ¶å™¨  
mapper: ç›¸å½“äºä¸€èµ·çš„ dao,ç”¨æ¥æ”¾ mapper.xml æ˜ å°„æ–‡ä»¶å’Œå¯¹è¡¨çš„æ“ä½œæ¥å£ç±»  
service: ä¸šåŠ¡æ¥å£å’Œä¸šåŠ¡æ¥å£å®ç°ç±»  
util: å·¥å…·åŒ…

1.bean ç±»å’Œæ•°æ®åº“è¡¨ä¿¡æ¯

```java
package com.code.ssm.bean;
import java.io.Serializable;
public class UserBean implements Serializable{
    private static final long serialVersionUID = 9018124883408166898L;
    private int id;
    private String username;
    private String password;
    private int account;
    public UserBean() {}
    public UserBean(String username, String password, int account) {
        this.username = username;
        this.password = password;
        this.account = account;
    }
    public int getId() {return id;}
    public void setId(int id) {this.id = id;}
    public String getUsername() {return username;}
    public void setUsername(String username) {this.username = username;}
    public String getPassword() {return password;}
    public void setPassword(String password) {this.password = password;}
    public int getAccount() {return account;}
    public void setAccount(int account) {this.account = account;}
    @Override
    public String toString() {
        return "UserBean{" +
                "id=" + id +
                ", username='" + username + '\'' +
                ", password='" + password + '\'' +
                ", account=" + account +
                '}';
    }
}
```

```sql
-- ----------------------------
-- Table structure for t_user
-- ----------------------------
DROP TABLE IF EXISTS `t_user`;
CREATE TABLE `t_user` (
  `pk_id` int(11) NOT NULL AUTO_INCREMENT,
  `f_name` varchar(255) DEFAULT NULL,
  `f_pwd` varchar(255) DEFAULT NULL,
  `f_account` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`pk_id`)
) ENGINE=InnoDB AUTO_INCREMENT=12 DEFAULT CHARSET=utf8;

-- ----------------------------
-- Records of t_user
-- ----------------------------
INSERT INTO `t_user` VALUES ('1', 'updatrezhang3', '12345', '3000');
INSERT INTO `t_user` VALUES ('2', 'updatrezhang3', '12345', '3000');
INSERT INTO `t_user` VALUES ('3', 'zhang3', '12345', '1000');
INSERT INTO `t_user` VALUES ('4', 'zhang4', '12345', '3000');
```

2.spring-mvc.xml é…ç½®

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
	http://www.springframework.org/schema/beans/spring-beans-4.2.xsd
	http://www.springframework.org/schema/context
	http://www.springframework.org/schema/context/spring-context-4.2.xsd">

    <!--å¼€å¯æ³¨è§£-->
    <context:annotation-config/>
    <!-- è‡ªåŠ¨æ‰«æcontrolleråŒ…ä¸‹çš„æ‰€æœ‰ç±»ï¼Œä½¿å…¶è®¤ä¸ºspring mvcçš„æ§åˆ¶å™¨ -->
    <context:component-scan base-package="com.code.ssm.controller"/>

    <!-- ViewREsolverè§†å›¾è§£æå™¨ ç”¨äºå°†è¿”å›çš„ModelAndViewå¯¹è±¡è¿›è¡Œåˆ†ç¦» -->
    <bean class="org.springframework.web.servlet.view.UrlBasedViewResolver">
        <property name="viewClass"
                  value="org.springframework.web.servlet.view.JstlView"/>
        <property name="prefix" value="/"/>
        <property name="suffix" value=".jsp"/>
    </bean>

</beans>
```

3.æ–°å»º LoginController.java

```java
package com.code.ssm.controller;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
@Controller
public class LoginController {
	@RequestMapping("/login")
	public String login(String username, String password) {
		System.out.println(username +"  " + password);
		return null;
	}
}
```

4.åœ¨ WEB-INF ç›®å½•ä¸‹æ–°å»º login.jsp æ–‡ä»¶

```html
<%@ page language="java" pageEncoding="utf-8"%> <%@ taglib prefix="spring"
uri="http://www.springframework.org/tags" %> <%@ taglib prefix="springForm"
uri="http://www.springframework.org/tags/form" %> <% String path =
request.getContextPath(); String basePath = request.getScheme() + "://" +
request.getServerName() + ":" + request.getServerPort() + path + "/"; %>

<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <base href="<%=basePath%>" />
    <title>My JSP 'login.jsp' starting page</title>
  </head>
  <body>
    <form method="post" action="login.spring" name="loginForm">
      <p><input type="text" name="username" /></p>
      <p><input type="password" name="password" /></p>
      <p><input type="submit" value="login" name="subBtn" /></p>
    </form>
  </body>
</html>
```

5.æ‰“å¼€æœåŠ¡å™¨,ç™»å½• `http://localhost:8080/SSM/login.jsp`  
éšä¾¿è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ,æäº¤ä¹‹åçœ‹æ§åˆ¶å°æ˜¯å¦è¾“å‡º,å¦‚æœæ­£ç¡®è¾“å‡º,æˆ‘ä»¬ç»§ç»­

**æ€»ç»“ä¸€ä¸‹:**

1.åœ¨ web.xml ä¸­é…ç½® spring å®¹å™¨ç›‘å¬å™¨,å½“æœåŠ¡å™¨å¯åŠ¨æ—¶åŠ è½½ spring-config.xml,å¼€å¯ spring å®¹å™¨  
2.åœ¨ web.xml ä¸­é…ç½®å‰ç«¯æ§åˆ¶å™¨ DispatcherServlet,æ‹¦æˆªå…¨éƒ¨ä»¥.spring ç»“å°¾çš„è¯·æ±‚,ç„¶ååˆ†å‘ç»™ controller,  
3.åœ¨ spring-mvc.xml ä¸­é…ç½®å¼€å¯æ³¨è§£,è‡ªåŠ¨æ‰«æ@RequestMapping æ³¨è§£,  
@Controller: å‘ŠçŸ¥ spring å®¹å™¨è¿™æ˜¯ä¸€ä¸ªæ§åˆ¶å™¨ç»„ä»¶;@RequestMapping("/login"): å‘ŠçŸ¥è¯¥æ–¹æ³•æ—¶é’ˆå¯¹/login è¯·æ±‚çš„å¤„ç†æ–¹æ³•

---

### ä½¿ç”¨ spring-config.xml,è®© spring å®¹å™¨æ¥ç®¡ç† bean ä¹‹é—´çš„å…³ç³»

ä¸Šé¢åªæ˜¯å®ç°äº† spring_mvc çš„åŠŸèƒ½,æ¥ä¸‹æ¥å®ç° Controller-->Service  
1.spring-config.xml é…ç½®

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">

    <!--è‡ªåŠ¨æ‰«æ annotationæ³¨è§£,è®©springå®¹å™¨çŸ¥é“å“ªäº›éœ€è¦è®©å®ƒæ¥ç®¡ç†-->
    <!--å¯åŠ¨springå®¹å™¨æ—¶,æ ¹æ®annotationè‡ªåŠ¨æ‰«æ,ç„¶åå®ä¾‹åŒ–bean,æ³¨å…¥ä¾èµ–å…³ç³»-->
    <context:component-scan base-package="com.code.ssm">
        <context:exclude-filter type="regex" expression=".(mapper|service.imp)"/>
    </context:component-scan>
</beans>
```

2.æ–°å»º UserService.java å’Œå®ç°ç±» UserServiceImp.java

```java
//UserService.java
package com.code.ssm.service;
import com.code.ssm.bean.UserBean;
public interface UserService {
	UserBean login(String username, String password);
}
```

```java
//UserServiceImp.java
package com.code.ssm.service.imp;
import com.code.ssm.bean.UserBean;
import com.code.ssm.service.UserService;
import org.springframework.stereotype.Service;
//å‘ŠçŸ¥springå®¹å™¨,æˆ‘æ˜¯loginControllerç±»çš„ä¾èµ–
@Service("userService")
public class UserServiceImp implements UserService {
	@Override
	public UserBean login(String username, String password) {
	   System.out.println(username + "  " + password);
		return null;
	}
}
```

3.å‘ LoginController ä¸­æ³¨å…¥ UserServiceImp ä¾èµ–

```java
package com.code.ssm.controller;
import com.code.ssm.service.UserService;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import javax.annotation.Resource;
@Controller
public class LoginController {
    ////å°†UserServiceçš„å®ç°ç±»æ³¨å…¥åˆ°controllerä¸­
	@Resource(name="userService")
	private UserService userService;
	@RequestMapping("/login")
	public String login(String username, String password) {
	   //è°ƒç”¨login()æ–¹æ³•
		userService.login(username,password);
		return null;
	}
}
```

4.æ‰“å¼€æœåŠ¡å™¨,ç™»å½• `http://localhost:8080/SSM/login.jsp`  
éšä¾¿è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ,æäº¤ä¹‹åçœ‹æ§åˆ¶å°æ˜¯å¦è¾“å‡º,å¦‚æœæ­£ç¡®è¾“å‡º,æˆ‘ä»¬ç»§ç»­

---

**æ€»ç»“ä¸€ä¸‹:**  
1.åœ¨ spring-config.xml ä¸­é…ç½®è‡ªåŠ¨æ‰«æ,æ‰«æåŒ…ä¸‹é¢çš„æ³¨è§£,ç®¡ç† bean ä¹‹é—´çš„ä¾èµ–å…³ç³»

### å®ç°æ•°æ®åº“è¿æ¥

controller-->service-->dao  
1.åœ¨ mapper åŒ…ä¸‹æ–°å»º UserMapper.java

```java
package com.code.ssm.mapper;
import com.code.ssm.bean.UserBean;
import org.apache.ibatis.annotations.Param;
public interface UserMapper {
	UserBean getUserByNamePwd(@Param("username") String username, @Param("password") String password);
}
```

2.åœ¨ mapper åŒ…ä¸‹æ–°å»º UserMapper.xml æ˜ å°„æ–‡ä»¶

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.code.ssm.mapper.UserMapper">
    <!-- ç»“æœæ˜ å°„ -->
    <resultMap id="userMapper" type="UserBean">
        <id property="id" column="pk_id" javaType="int"/>
        <result property="username" column="f_username" javaType="java.lang.String"/>
        <result property="password" column="f_password" javaType="java.lang.String"/>
        <result property="account" column="f_account" javaType="int"/>
    </resultMap>

    <select id="getUserByNamePwd" resultMap="userMapper">
        SELECT *
        FROM t_user
        WHERE f_name = #{username} AND f_pwd = #{password}
    </select>
</mapper>
```

3.åœ¨ spring-config.xml ä¸­é…ç½®æ•°æ®æºå’Œ SessionFactory

```xml
<!-- é…ç½®æ•°æ®æº -->
       <!--<context:property-placeholder location="classpath:datasource.properties" />-->
       <!--æˆ–è€…åœ¨mybatis.xmlä¸­é…ç½®æˆ–è€…å¼•å…¥datasource.propertiesæ–‡ä»¶-->
       <bean id="dataSource" class="org.springframework.jdbc.datasource.DriverManagerDataSource">
              <property name="driverClassName" value="com.mysql.jdbc.Driver"/>
              <property name="url" value="jdbc:mysql://localhost:3306/test"/>
              <property name="username" value="code"/>
              <property name="password" value="8998"/>
       </bean>

       <!--é…ç½®SessionFactory è¿™æ˜¯mybatis-spring.jaråŒ…ä¸­çš„ç±»-->
       <bean id="sessionFactory" class="org.mybatis.spring.SqlSessionFactoryBean">
              <property name="dataSource" ref="dataSource"/>
              <!--å¼•å…¥mybatis.xmlæ–‡ä»¶-->
              <property name="configLocation" value="classpath:mybatis-config.xml"/>
       </bean>
       <!--springè‡ªåŠ¨æŸ¥æ‰¾mybatisä¸‹çš„ç±» è¿™æ˜¯mybatis-spring.jaråŒ…ä¸­çš„ç±»-->
        <bean class="org.mybatis.spring.mapper.MapperScannerConfigurer">
            <property name="basePackage" value="com.code.ssm.mapper"/>
            <property name="sqlSessionFactoryBeanName" value="sessionFactory"/>
        </bean>
```

3.é…ç½® mybatis-config.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration PUBLIC "-//mybatis.org/DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd" >
<configuration>
    <!-- è‡ªåŠ¨æ‰«æåŒ…ï¼Œç”¨ç±»åä½œåˆ«å -->
    <typeAliases>
        <package name="com.code.ssm.bean"/>
    </typeAliases>
</configuration>
```

4.ä¿®æ”¹ UserServiceImp.java

```java
package com.code.ssm.service.imp;

import com.code.ssm.bean.UserBean;
import com.code.ssm.mapper.UserMapper;
import com.code.ssm.service.UserService;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;

@Service("userService")
public class UserServiceImp implements UserService{
    //æ³¨å…¥ä¾èµ–
    @Resource
    private UserMapper userMapper;
    @Override
    public UserBean login(String username, String password) {
        return userMapper.getUserByNamePwd(username,password);
    }
}
```

5.ä¿®æ”¹ LoginController.java

```java
package com.code.ssm.controller;
import com.code.ssm.bean.UserBean;
import com.code.ssm.service.UserService;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import javax.annotation.Resource;
@Controller
public class LoginController {
    @Resource(name="userService")
    private UserService userService;
    @RequestMapping("/login")
    public String login(String username, String password){
        UserBean userBean =  userService.login(username,password);
        if(userBean != null) return "success";
        else return "login";
    }
}
```

6.æ‰“å¼€æœåŠ¡å™¨,ç™»å½• `http://localhost:8080/SSM/login.jsp`

è¾“å…¥æ­£ç¡®çš„ç”¨æˆ·åå’Œå¯†ç ,è·³è½¬åˆ° success.jsp é¡µé¢åˆ™æˆåŠŸ.æ•´ä¸ªè¿‡ç¨‹ç»“æŸ

## [5åˆ†é’ŸæŒæ¡ï¼šRESTful APIçš„å¼‚å¸¸å¤„ç†è‰ºæœ¯](https://blog.dong4j.site/posts/954087b4.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## SpringMVC

### SimpleMappingExceptionResolver

åœ¨ Spring çš„é…ç½®æ–‡ä»¶ applicationContext.xml ä¸­å¢åŠ ä»¥ä¸‹å†…å®¹ï¼š

```xml
<bean class="org.springframework.web.servlet.handler.SimpleMappingExceptionResolver">
    <!-- å®šä¹‰é»˜è®¤çš„å¼‚å¸¸å¤„ç†é¡µé¢ï¼Œå½“è¯¥å¼‚å¸¸ç±»å‹çš„æ³¨å†Œæ—¶ä½¿ç”¨ -->
    <property name="defaultErrorView" value="error"></property>
    <!-- å®šä¹‰å¼‚å¸¸å¤„ç†é¡µé¢ç”¨æ¥è·å–å¼‚å¸¸ä¿¡æ¯çš„å˜é‡åï¼Œé»˜è®¤åä¸º exception -->
    <property name="exceptionAttribute" value="ex"></property>
    <!-- å®šä¹‰éœ€è¦ç‰¹æ®Šå¤„ç†çš„å¼‚å¸¸ï¼Œç”¨ç±»åæˆ–å®Œå…¨è·¯å¾„åä½œä¸º keyï¼Œå¼‚å¸¸ä¹Ÿé¡µåä½œä¸ºå€¼ -->
    <property name="exceptionMappings">
        <props>
            <prop key="cn.basttg.core.exception.BusinessException">error-business</prop>
            <prop key="cn.basttg.core.exception.ParameterException">error-parameter</prop>

            <!-- è¿™é‡Œè¿˜å¯ä»¥ç»§ç»­æ‰©å±•å¯¹ä¸åŒå¼‚å¸¸ç±»å‹çš„å¤„ç† -->
        </props>
    </property>
</bean>
```

ä½¿ç”¨ SimpleMappingExceptionResolver è¿›è¡Œå¼‚å¸¸å¤„ç†ï¼Œå…·æœ‰é›†æˆç®€å•ã€æœ‰è‰¯å¥½çš„æ‰©å±•æ€§ã€å¯¹å·²æœ‰ä»£ç æ²¡æœ‰å…¥ä¾µæ€§ç­‰ä¼˜ç‚¹ï¼Œä½†è¯¥æ–¹æ³•ä»…èƒ½è·å–åˆ°å¼‚å¸¸ä¿¡æ¯ï¼Œè‹¥åœ¨å‡ºç°å¼‚å¸¸æ—¶ï¼Œå¯¹éœ€è¦è·å–é™¤å¼‚å¸¸ä»¥å¤–çš„æ•°æ®çš„æƒ…å†µä¸é€‚ç”¨ã€‚

### HandlerExceptionResolver

1. å¢åŠ  HandlerExceptionResolver æ¥å£çš„å®ç°ç±» MyExceptionHandlerï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
public class MyExceptionHandler implements HandlerExceptionResolver {
    private static final Logger LOGGER = LoggerFactory.getLogger(MyExceptionHandler.class);
    public ModelAndView resolveException(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) {
        try(PrintWriter writer = new PrintWriter(response.getWriter(), true)){
            if (ex instanceof DataValidateException) {
                writer.println(ex.getMessage());
            } else if (ex instanceof RuntimeException){
                writer.println(ex.getMessage());
                LOGGER.error("Errors.OPTION_ERROR", ex);
            }
        } catch (IOException e) {
            LOGGER.error("getWriter error ", e);
        }
        return null;
    }
}

```

2. åœ¨ Spring çš„é…ç½®æ–‡ä»¶ applicationContext.xml ä¸­å¢åŠ ä»¥ä¸‹å†…å®¹ï¼š

```xml
<bean id="exceptionHandler" class="com.xxx.server.web.interceptor.MyExceptionHandler"/>
```

ä½¿ç”¨å®ç° HandlerExceptionResolver æ¥å£çš„å¼‚å¸¸å¤„ç†å™¨è¿›è¡Œå¼‚å¸¸å¤„ç†ï¼Œå…·æœ‰é›†æˆç®€å•ã€æœ‰è‰¯å¥½çš„æ‰©å±•æ€§ã€å¯¹å·²æœ‰ä»£ç æ²¡æœ‰å…¥ä¾µæ€§ç­‰ä¼˜ç‚¹ï¼ŒåŒæ—¶ï¼Œåœ¨å¼‚å¸¸å¤„ç†æ—¶èƒ½è·å–å¯¼è‡´å‡ºç°å¼‚å¸¸çš„å¯¹è±¡ï¼Œæœ‰åˆ©äºæä¾›æ›´è¯¦ç»†çš„å¼‚å¸¸å¤„ç†ä¿¡æ¯

### @ExceptionHandler

1. å¢åŠ  BaseController ç±»ï¼Œå¹¶åœ¨ç±»ä¸­ä½¿ç”¨ @ExceptionHandler æ³¨è§£å£°æ˜å¼‚å¸¸å¤„ç†ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
@ExceptionHandler
    public String exp(HttpServletRequest request, HttpServletResponse response, Exception ex) {
        try(PrintWriter writer = new PrintWriter(response.getWriter(), true)){
            if (ex instanceof DataValidateException) {
                writer.println(ex.getMessage());
            } else if (ex instanceof SSDBHelperException){
                writer.println(Errors.OPTION_ERROR);
            } else {
                // æœªçŸ¥å¼‚å¸¸éƒ½æŠ¥æœåŠ¡å™¨å¼‚å¸¸
                writer.println(RespCode.EX_SERVER_INNER.getMessage());
                LOGGER.error("Errors.OPTION_ERROR", ex);
            }
        } catch (IOException e) {
            LOGGER.error("getWriter error ", e);
        }
        return null;
    }
```

2. ä¿®æ”¹ä»£ç ï¼Œä½¿æ‰€æœ‰éœ€è¦å¼‚å¸¸å¤„ç†çš„ Controller éƒ½ç»§æ‰¿è¯¥ç±»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œä¿®æ”¹åçš„ TestController ç±»ç»§æ‰¿äº BaseController

ä½¿ç”¨ @ExceptionHandler æ³¨è§£å®ç°å¼‚å¸¸å¤„ç†ï¼Œå…·æœ‰é›†æˆç®€å•ã€æœ‰æ‰©å±•æ€§å¥½ï¼ˆåªéœ€è¦å°†è¦å¼‚å¸¸å¤„ç†çš„ Controller ç±»ç»§æ‰¿äº BaseController å³å¯ï¼‰ã€ä¸éœ€è¦é™„åŠ  Spring é…ç½®ç­‰ä¼˜ç‚¹ï¼Œä½†è¯¥æ–¹æ³•å¯¹å·²æœ‰ä»£ç å­˜åœ¨å…¥ä¾µæ€§ï¼ˆéœ€è¦ä¿®æ”¹å·²æœ‰ä»£ç ï¼Œä½¿ç›¸å…³ç±»ç»§æ‰¿äº BaseControllerï¼‰ï¼Œåœ¨å¼‚å¸¸å¤„ç†æ—¶ä¸èƒ½è·å–é™¤å¼‚å¸¸ä»¥å¤–çš„æ•°æ®

### @ControllerAdvice

å…¨å±€å¼‚å¸¸å¤„ç†ç±»

```java
@ControllerAdvice
public class GlobalExceptionHandler {
 private Logger logger = LoggerFactory.getLogger(GlobalExceptionHandler.class);

 @ResponseBody  # è¿”å› json æ•°æ®
 @ExceptionHandler(Exception.class)
 public Object handleException(Exception e) {
     logger.error(ExceptionUtils.getFullStackTrace(e));  // è®°å½•é”™è¯¯ä¿¡æ¯
     String msg = e.getMessage();
     if (msg == null || msg.equals("")) {
         msg = "æœåŠ¡å™¨å‡ºé”™";
     }
     JSONObject jsonObject = new JSONObject();
     jsonObject.put("message", msg);
     return jsonObject;
 }
}
```

@ExceptionHandler è¡¨ç¤ºè¯¥æ–¹æ³•å¯ä»¥å¤„ç†çš„å¼‚å¸¸ï¼Œå¯ä»¥å¤šä¸ªï¼Œæ¯”å¦‚  
@ExceptionHandler({ NullPointerException.class, DataAccessException.class})  
ä¹Ÿå¯ä»¥é’ˆå¯¹ä¸åŒçš„å¼‚å¸¸å†™ä¸åŒçš„æ–¹æ³•ã€‚@ExceptionHandler(Exception.class) å¯ä»¥å¤„ç†æ‰€æœ‰çš„å¼‚å¸¸ç±»å‹ã€‚

#### @ControllerAdvice å’Œ @PropertySource

##### @ControllerAdvice

@ ControllerAdvice æ˜¯ä¸€ä¸ª @ Componentï¼Œç”¨äºå®šä¹‰ @ ExceptionHandler çš„ï¼Œ@InitBinder å’Œ @ModelAttribute æ–¹æ³•ï¼Œé€‚ç”¨äºæ‰€æœ‰ä½¿ç”¨ @ RequestMapping æ–¹æ³•ã€‚ Spring4 ä¹‹å‰ï¼Œ@ ControllerAdvice åœ¨åŒä¸€è°ƒåº¦çš„ Servlet ä¸­ååŠ©æ‰€æœ‰æ§åˆ¶å™¨ã€‚Spring4 å·²ç»æ”¹å˜ï¼š@ ControllerAdvice æ”¯æŒé…ç½®æ§åˆ¶å™¨çš„å­é›†ï¼Œè€Œé»˜è®¤çš„è¡Œä¸ºä»ç„¶å¯ä»¥åˆ©ç”¨ã€‚

åœ¨ Spring4 ä¸­ï¼Œ @ControllerAdvice é€šè¿‡ annotations(), basePackageClasses(), basePackages() æ–¹æ³•å®šåˆ¶ç”¨äºé€‰æ‹©æ§åˆ¶å™¨å­é›†ï¼š

```java
@ControllerAdvice(annotations = RestController.class)
class ApiExceptionHandlerAdvice {

Â Â Â  /**
Â Â Â Â  * Handle exceptions thrown by handlers.
Â Â Â Â  */
Â Â Â  @ExceptionHandler(value = Exception.class)
Â Â Â  @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
Â Â Â  @ResponseBody
Â Â Â  public ApiError exception(Exception exception, WebRequest request) {
Â Â Â Â Â Â Â  return new ApiError(Throwables.getRootCause(exception).getMessage());
Â Â Â  }
}
```

##### @PropertySource

Spring 4 æ˜¯å’Œ @Configuration ååŒï¼Œæä¾›ä¸€ä¸ªå¢åŠ  name/value å±æ€§çš„é…ç½®æ–¹å¼ã€‚

```java
@Configuration
@**PropertySource**("classpath:/datasource.properties")
public class DefaultDataSourceConfig implements DataSourceConfig {

Â Â Â  @Autowired
Â Â Â  private Environment env;

Â Â Â  @Override
Â Â Â  @Bean
Â Â Â  public DataSource dataSource() {
Â Â Â Â Â Â Â  DriverManagerDataSource dataSource = new DriverManagerDataSource();
Â Â Â Â Â Â Â  dataSource.setDriverClassName(env.getRequiredProperty("dataSource.driverClassName"));
Â Â Â Â Â Â Â  dataSource.setUrl(env.getRequiredProperty("dataSource.url"));
Â Â Â Â Â Â Â  dataSource.setUsername(env.getRequiredProperty("dataSource.username"));
Â Â Â Â Â Â Â  dataSource.setPassword(env.getRequiredProperty("dataSource.password"));
Â Â Â Â Â Â Â  return dataSource;
Â Â Â  }
}
```

## RESTEasy

RESTEasy æ˜¯ JBoss æä¾›çš„ä¸€ä¸ª Restful åŸºç¡€æ¡†æ¶ï¼Œä½¿ç”¨å®ƒæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ„å»ºæˆ‘ä»¬çš„ Restful æœåŠ¡ï¼Œè€Œä¸”å®ƒä¹Ÿå®Œå…¨ç¬¦åˆ Â [Java](http://lib.csdn.net/base/java "Java çŸ¥è¯†åº“")Â  çš„ JAX-RS2.0 æ ‡å‡†ï¼Œå¾ˆå¤šç¬¬ä¸‰æ–¹ Restful æ¡†æ¶ä¹Ÿéƒ½æ˜¯åŸºäº RESTEasy å¼€å‘çš„ã€‚

åœ¨ä»»ä½•æ¡†æ¶ä¸­éƒ½ä¸å¯é¿å…çš„æ¶‰åŠåˆ°å¼‚å¸¸å¤„ç†ï¼ŒRestful æ¡†æ¶ä¹Ÿæ˜¯å¦‚æ­¤ã€‚æŒ‰ç…§æˆ‘ä»¬ä¸€èˆ¬ä¼ ç»Ÿå¼‚å¸¸å¤„ç†æ–¹å¼ï¼Œåœ¨ Restful çš„æœ€å¤–å±‚ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šå¯¹æ‰€æœ‰çš„ä¸šåŠ¡è°ƒç”¨éƒ½åŠ ä¸Š try catchï¼Œä»¥å…å¼‚å¸¸è¢«ç”¨æˆ·æ¥æ”¶åˆ°ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰è¿™ä¹ˆä¸€ä¸ª Restful æœåŠ¡ï¼š

```java
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.core.Response;
import org.jboss.resteasy.spi.validation.ValidateRequest;

@Path("/rest")
public class UserApi
{
    @Autowire
    UserService userService;
    @Path("/users/{id}")
    @GET
    @ValidateRequest
    public Response getUserBId  ( @PathParam("id") String id ) throws RuntimeException
    {
        try{
            User user=userService.getUser(id);
        } catch(IllegalArgumentException e) {
            //if exception occured
            return Response.status(Status.BAD_REQUEST).entity(exception.getMessage()).build();
        } catch(Exception e) {
            //if exception occured
            return Response.status(Status.BAD_REQUEST).entity(exception.getMessage()).build();
        }
        //if success
        return Response.ok().entity("User with ID " + id + " found !!").build();
    }
}
```

ä¸Šé¢ UserApi æ¥å£ä¸­çš„ getUserBId() æ–¹æ³•è°ƒç”¨äº† userService.getUser() æœåŠ¡ï¼Œè¿™ä¸ªæœåŠ¡ä¼šæŠ›å‡ºä¸€äº›å¼‚å¸¸ï¼ŒUserApi éœ€è¦æ•è·å¼‚å¸¸å¹¶è¿”å›å®¢æˆ·çš„ä¸€ä¸ªé”™è¯¯çš„å“åº”ã€‚è¿˜æœ‰ä¸€ç‚¹æˆ‘ä»¬ä¸€èˆ¬ä¼šåœ¨ API å±‚ catch ä¸€ä¸ª Exception å¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯æ•è·æ‰€æœ‰å¯èƒ½å‘ç”Ÿçš„å¼‚å¸¸æƒ…å†µï¼Œä»¥å…å‰ç«¯å‡ºç°ä¸å‹å¥½çš„é”™è¯¯æç¤ºã€‚

è¿™ä¹ˆåšä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬çš„æ¥å£ä¸åªæ˜¯ä¸€ä¸ªï¼Œæ¯ä¸ªæ¥å£éœ€è¦è¿›è¡Œ try catch æ¥å¤„ç†å¼‚å¸¸ï¼Œè¿™ä¹ˆåšæ˜¾ç„¶ä¸ç¬¦åˆæˆ‘ä»¬çš„ç¼–ç¨‹æ€æƒ³ï¼Œæˆ‘ä»¬å¸Œæœ›æŠŠæ‰€æœ‰å¼‚å¸¸é›†ä¸­åˆ°ä¸€ä¸ªåœ°æ–¹å¤„ç†ã€‚

å¦‚æœæˆ‘ä»¬çš„ Restful æ¡†æ¶æ˜¯åŸºäº RESTEasy çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ ExceptionMapper æ¥å®ç°ä¸€ä¸ªé€šç”¨å¼‚å¸¸å¤„ç†ç±»ã€‚

### ExceptionMapper

ExceptionMapper æ˜¯ provider çš„ä¸€ä¸ªåè®®ï¼Œå®ƒä¼šå°† Java çš„å¼‚å¸¸æ˜ å°„åˆ° Response å¯¹è±¡ã€‚æ‰€ä»¥è¦è¿›è¡Œé€šç”¨å¼‚å¸¸å¤„ç†ï¼Œæˆ‘ä»¬åªéœ€è¦å†™ä¸€ä¸ªç±»æ¥å®ç° ExceptionMapper æ¥å£ï¼Œå¹¶æŠŠå®ƒå£°æ˜ä¸ºä¸€ä¸ª provider å³å¯ï¼š

```java
import javax.ws.rs.core.Response;
import javax.ws.rs.core.Response.Status;
import javax.ws.rs.ext.ExceptionMapper;
import javax.ws.rs.ext.Provider;

@Provider
public class MyApplicationExceptionHandler implements ExceptionMapper<MyApplicationException>
{
    @Override
    public Response toResponse(Exception exception)
    {
        return Response.status(Status.BAD_REQUEST).entity(exception.getMessage()).build();
    }
}
```

ä¸Šé¢çš„ ExceptionMapper çš„å®ç°å·²ç»å†™å¥½äº†ï¼Œä¸‹é¢æˆ‘ä»¬å†™ä¸ª Restful API æ¥ [æµ‹è¯•](http://lib.csdn.net/base/softwaretest "è½¯ä»¶æµ‹è¯•çŸ¥è¯†åº“") ä¸‹ï¼š

```java
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.core.Response;
import org.jboss.resteasy.spi.validation.ValidateRequest;

@Path("/rest")
public class UserApi
{
    @Autowire
    UserService userService;
    @Path("/users/{id}")
    @GET
    @ValidateRequest
    public Response getUserBId  ( @PathParam("id") String id ) throws RuntimeException
    {
        try{
            User user=userService.getUser(id);
        } catch(IllegalArgumentException e) {
           throw new RuntimeException("id is not a number !!");
        }
        return Response.ok().entity("User with ID " + id + " found !!").build();
    }
}
```

åœ¨è¿™ä¸ªæ¥å£ä¸­ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å¯¹å¼‚å¸¸åšç‰¹æ®Šå¤„ç†ï¼Œä¹Ÿæ²¡æœ‰ catch ä¸€ä¸ª Exception å¼‚å¸¸ï¼Œä»…ä»…æ˜¯æŠŠå¼‚å¸¸æŠ›å‡ºï¼Œè€Œæ‰€æœ‰çš„å¼‚å¸¸å¤„ç†éƒ½é›†ä¸­åœ¨äº† MyApplicationExceptionHandler ä¸­ã€‚

## [ä¸‰å±‚æ¶æ„çš„é­…åŠ›ï¼šç•Œé¢å±‚ã€ä¸šåŠ¡é€»è¾‘å±‚ä¸æ•°æ®è®¿é—®å±‚](https://blog.dong4j.site/posts/a13702d6.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## æ¡†æ¶æ¨¡å¼å’Œè®¾è®¡æ¨¡å¼çš„åŒºåˆ«

æœ‰å¾ˆå¤šç¨‹åºå‘˜å¾€å¾€æŠŠæ¡†æ¶æ¨¡å¼å’Œè®¾è®¡æ¨¡å¼æ··æ·†ï¼Œè®¤ä¸º MVC æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ã€‚å®é™…ä¸Šå®ƒä»¬å®Œå…¨æ˜¯ä¸åŒçš„æ¦‚å¿µã€‚  
æ¡†æ¶ã€è®¾è®¡æ¨¡å¼è¿™ä¸¤ä¸ªæ¦‚å¿µæ€»å®¹æ˜“è¢«æ··æ·†ï¼Œå…¶å®å®ƒä»¬ä¹‹é—´è¿˜æ˜¯æœ‰åŒºåˆ«çš„ã€‚æ¡†æ¶é€šå¸¸æ˜¯ä»£ç é‡ç”¨ï¼Œè€Œè®¾è®¡æ¨¡å¼æ˜¯è®¾è®¡é‡ç”¨ï¼Œæ¶æ„åˆ™ä»‹äºä¸¤è€…ä¹‹é—´ï¼Œéƒ¨åˆ†ä»£ç é‡ç”¨ï¼Œéƒ¨åˆ†è®¾è®¡é‡ç”¨ï¼Œæœ‰æ—¶åˆ†æä¹Ÿå¯é‡ç”¨ã€‚åœ¨è½¯ä»¶ç”Ÿäº§ä¸­æœ‰ä¸‰ç§çº§åˆ«çš„é‡ç”¨ï¼šå†…éƒ¨é‡ç”¨ï¼Œå³åœ¨åŒä¸€åº”ç”¨ä¸­èƒ½å…¬å…±ä½¿ç”¨çš„æŠ½è±¡å—; ä»£ç é‡ç”¨ï¼Œå³å°†é€šç”¨æ¨¡å—ç»„åˆæˆåº“æˆ–å·¥å…·é›†ï¼Œä»¥ä¾¿åœ¨å¤šä¸ªåº”ç”¨å’Œé¢†åŸŸéƒ½èƒ½ä½¿ç”¨ï¼›åº”ç”¨æ¡†æ¶çš„é‡ç”¨ï¼Œå³ä¸ºä¸“ç”¨é¢†åŸŸæä¾›é€šç”¨çš„æˆ–ç°æˆçš„åŸºç¡€ç»“æ„ï¼Œä»¥è·å¾—æœ€é«˜çº§åˆ«çš„é‡ç”¨æ€§ã€‚  
æ¡†æ¶ä¸è®¾è®¡æ¨¡å¼è™½ç„¶ç›¸ä¼¼ï¼Œä½†å´æœ‰ç€æ ¹æœ¬çš„ä¸åŒã€‚è®¾è®¡æ¨¡å¼æ˜¯å¯¹åœ¨æŸç§ç¯å¢ƒä¸­åå¤å‡ºç°çš„é—®é¢˜ä»¥åŠè§£å†³è¯¥é—®é¢˜çš„æ–¹æ¡ˆçš„æè¿°ï¼Œå®ƒæ¯”æ¡†æ¶æ›´æŠ½è±¡ï¼›æ¡†æ¶å¯ä»¥ç”¨ä»£ç è¡¨ç¤ºï¼Œä¹Ÿèƒ½ç›´æ¥æ‰§è¡Œæˆ–å¤ç”¨ï¼Œè€Œå¯¹æ¨¡å¼è€Œè¨€åªæœ‰å®ä¾‹æ‰èƒ½ç”¨ä»£ç è¡¨ç¤º; è®¾è®¡æ¨¡å¼æ˜¯æ¯”æ¡†æ¶æ›´å°çš„å…ƒç´ ï¼Œä¸€ä¸ªæ¡†æ¶ä¸­å¾€å¾€å«æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªè®¾è®¡æ¨¡å¼ï¼Œæ¡†æ¶æ€»æ˜¯é’ˆå¯¹æŸä¸€ç‰¹å®šåº”ç”¨é¢†åŸŸï¼Œä½†åŒä¸€æ¨¡å¼å´å¯é€‚ç”¨äºå„ç§åº”ç”¨ã€‚å¯ä»¥è¯´ï¼Œæ¡†æ¶æ˜¯è½¯ä»¶ï¼Œè€Œè®¾è®¡æ¨¡å¼æ˜¯è½¯ä»¶çš„çŸ¥è¯†ã€‚  
æ¡†æ¶æ¨¡å¼æœ‰å“ªäº›ï¼Ÿ  
MVCã€MTVã€MVPã€CBDã€ORM ç­‰ç­‰ï¼›  
æ¡†æ¶æœ‰å“ªäº›ï¼Ÿ  
C++ è¯­è¨€çš„ QTã€MFCã€gtkï¼ŒJava è¯­è¨€çš„ SSH ã€SSIï¼Œphp è¯­è¨€çš„ smarty(MVC æ¨¡å¼)ï¼Œpython è¯­è¨€çš„ django(MTV æ¨¡å¼) ç­‰ç­‰  
è®¾è®¡æ¨¡å¼æœ‰å“ªäº›ï¼Ÿ  
å·¥å‚æ¨¡å¼ã€é€‚é…å™¨æ¨¡å¼ã€ç­–ç•¥æ¨¡å¼ç­‰ç­‰  
ç®€è€Œè¨€ä¹‹ï¼šè®¾è®¡æ¨¡å¼æ˜¯å¤§æ™ºæ…§ï¼Œç”¨æ¥å¯¹è½¯ä»¶è®¾è®¡è¿›è¡Œåˆ†å·¥ï¼›æ¡†æ¶æ¨¡å¼æ˜¯å°æŠ€å·§ï¼Œå¯¹å…·ä½“é—®é¢˜æå‡ºè§£å†³æ–¹æ¡ˆï¼Œä»¥æé«˜ä»£ç å¤ç”¨ç‡ï¼Œé™ä½è€¦åˆåº¦ã€‚

## MVC æ¡†æ¶ (MVC æ¨¡å¼)

SUN å…¬å¸æ¨å‡º JSP æŠ€æœ¯åæ¨èçš„ä¸¤ç§ web åº”ç”¨å¼€å‘æ¨¡å¼:

1. JSP + JavaBean (Model1)  
   ![20241229154732_vap4M5ys.webp](https://cdn.dong4j.site/source/image/20241229154732_vap4M5ys.webp)

   > 1. åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼ŒJSP é¡µé¢ç‹¬è‡ªå“åº”è¯·æ±‚å¹¶å°†å¤„ç†ç»“æœè¿”å›å®¢æˆ·ï¼Œæ‰€æœ‰çš„æ•°æ®åº“æ“ä½œé€šè¿‡ JavaBean æ¥å®ç°ã€‚
   > 2. å¤§é‡åœ°ä½¿ç”¨è¿™ç§æ¨¡å¼ï¼Œå¸¸ä¼šå¯¼è‡´åœ¨ JSP é¡µé¢ä¸­åµŒå…¥å¤§é‡çš„ Java ä»£ç ï¼Œå½“éœ€è¦å¤„ç†çš„å•†ä¸šé€»è¾‘éå¸¸å¤æ‚æ—¶ï¼Œè¿™ç§æƒ…å†µå°±ä¼šå˜å¾—å¾ˆç³Ÿç³•ã€‚å¤§é‡çš„ Java ä»£ç ä½¿å¾— JSP é¡µé¢å˜å¾—éå¸¸è‡ƒè‚¿ã€‚å‰ç«¯çš„é¡µé¢è®¾è®¡äººå‘˜ç¨æœ‰ä¸æ…ï¼Œå°±æœ‰å¯èƒ½ç ´åå…³ç³»åˆ°å•†ä¸šé€»è¾‘çš„ä»£ç ã€‚
   > 3. è¿™ç§æƒ…å†µåœ¨å¤§å‹é¡¹ç›®ä¸­ç»å¸¸å‡ºç°ï¼Œé€ æˆäº†ä»£ç å¼€å‘å’Œç»´æŠ¤çš„å›°éš¾ï¼ŒåŒæ—¶ä¼šå¯¼è‡´é¡¹ç›®ç®¡ç†çš„å›°éš¾ã€‚å› æ­¤è¿™ç§æ¨¡å¼åªé€‚ç”¨äºä¸­å°è§„æ¨¡çš„é¡¹ç›®ã€‚
   > 4. JSP+JavaBean æ¨¡å¼é€‚åˆå¼€å‘ä¸šåŠ¡é€»è¾‘ä¸å¤ªå¤æ‚çš„ web åº”ç”¨ç¨‹åºï¼Œè¿™ç§æ¨¡å¼ä¸‹ï¼ŒJavaBean ç”¨äºå°è£…ä¸šåŠ¡æ•°æ®ï¼ŒJSP å³è´Ÿè´£å¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œåˆæ˜¾ç¤ºæ•°æ®ã€‚

2. JSP + Servlet + JavaBean (Model2) --> MVC  
   ![20241229154732_WW8coFNM.webp](https://cdn.dong4j.site/source/image/20241229154732_WW8coFNM.webp)
   > MVC å…¨åæ˜¯ Model View Controllerï¼Œæ˜¯æ¨¡å‹ (model)ï¼è§†å›¾ (view)ï¼æ§åˆ¶å™¨ (controller) çš„ç¼©å†™ï¼Œä¸€ç§è½¯ä»¶è®¾è®¡å…¸èŒƒï¼Œç”¨ä¸€ç§ä¸šåŠ¡é€»è¾‘ã€æ•°æ®ã€ç•Œé¢æ˜¾ç¤ºåˆ†ç¦»çš„æ–¹æ³•ç»„ç»‡ä»£ç ï¼Œå°†ä¸šåŠ¡é€»è¾‘èšé›†åˆ°ä¸€ä¸ªéƒ¨ä»¶é‡Œé¢ï¼Œåœ¨æ”¹è¿›å’Œä¸ªæ€§åŒ–å®šåˆ¶ç•Œé¢åŠç”¨æˆ·äº¤äº’çš„åŒæ—¶ï¼Œä¸éœ€è¦é‡æ–°ç¼–å†™ä¸šåŠ¡é€»è¾‘ã€‚MVC è¢«ç‹¬ç‰¹çš„å‘å±•èµ·æ¥ç”¨äºæ˜ å°„ä¼ ç»Ÿçš„è¾“å…¥ã€å¤„ç†å’Œè¾“å‡ºåŠŸèƒ½åœ¨ä¸€ä¸ªé€»è¾‘çš„å›¾å½¢åŒ–ç”¨æˆ·ç•Œé¢çš„ç»“æ„ä¸­ã€‚

MVC æ˜¯ä¸€ä¸ªæ¡†æ¶æ¨¡å¼ï¼Œå®ƒå¼ºåˆ¶æ€§çš„ä½¿åº”ç”¨ç¨‹åºçš„è¾“å…¥ã€å¤„ç†å’Œè¾“å‡ºåˆ†å¼€ã€‚ä½¿ç”¨ MVC åº”ç”¨ç¨‹åºè¢«åˆ†æˆä¸‰ä¸ªæ ¸å¿ƒéƒ¨ä»¶ï¼šæ¨¡å‹ã€è§†å›¾ã€æ§åˆ¶å™¨ã€‚å®ƒä»¬å„è‡ªå¤„ç†è‡ªå·±çš„ä»»åŠ¡ã€‚

1. æ¨¡å‹éƒ¨åˆ†åŒ…å«äº†åº”ç”¨ç¨‹åºçš„ä¸šåŠ¡é€»è¾‘å’Œä¸šåŠ¡æ•°æ®
   - å°è£…åº”ç”¨çŠ¶æ€ -->æ•°æ®å°è£… (vo)
   - å“åº”çŠ¶æ€æŸ¥è¯¢ -->è·å–æ•°æ® (vo)
   - æš´éœ²åº”ç”¨çš„åŠŸèƒ½ -->é€»è¾‘å±‚ API
2. è§†å›¾éƒ¨åˆ†å°è£…äº†åº”ç”¨ç¨‹åºçš„è¾“å‡ºå½¢å¼
   - äº§ç”Ÿ html å“åº” -->å±•ç¤ºæ•°æ®
   - è¯·æ±‚æ¨¡å‹çš„æ›´æ–° -->è§¦å‘äº‹ä»¶
   - æä¾› html form ç”¨äºç”¨æˆ·è¯·æ±‚ -->äººæœºäº¤äº’
3. æ§åˆ¶å™¨éƒ¨åˆ†è´Ÿè´£åè°ƒæ¨¡å‹å’Œè§†å›¾,æ ¹æ®ç”¨æˆ·è¯·æ±‚æ¥é€‰æ‹©è¦è°ƒç”¨å“ªä¸ªæ¨¡å‹æ¥å¤„ç†ä¸šåŠ¡,ä»¥åŠè¿½è¸ªç”±å“ªä¸ªè§†å›¾ä¸ºç”¨æˆ·åšå‡ºåº”ç­”
   - æ¥æ”¶å¹¶éªŒè¯ http è¯·æ±‚çš„æ•°æ® -->æ”¶é›†æ•°æ®,å°è£…æ•°æ®
   - å°†ç”¨æˆ·æ•°æ®ä¸æ¨¡å‹çš„æ›´æ–°ç›¸æ˜ å°„ -->è°ƒç”¨é€»è¾‘å±‚ API
   - é€‰æ‹©ç”¨äºå“åº”çš„è§†å›¾ -->æ ¹æ®è¿”å›å€¼é€‰æ‹©ä¸‹ä¸€ä¸ªé¡µé¢

Servlet = Java + html -->æ‹¼å­—ç¬¦å¤ªéº»çƒ¦  
JSP = html + java è„šæœ¬ -->é¡µé¢å’Œé€»è¾‘å¤ªè¿‡äºæ··æ‚

ä½¿ç”¨çº¯ jsp å†™ web åº”ç”¨æ—¶,åœ¨ jsp é¡µé¢ä¸Šå†™çš„ä»£ç å¤ªå¤š,å°¤å…¶æ˜¯æ§åˆ¶ä»£ç ,é¡µé¢å’Œé€»è¾‘æ··æ‚åœ¨ä¸€èµ·,å› æ­¤éœ€è¦å¼•å…¥ä¸€ä¸ªä¸­é—´å±‚ -->æ§åˆ¶å™¨æ¥æ§åˆ¶å¤„ç†æ§åˆ¶ä»£ç 

![20241229154732_sNGiJBH5.webp](https://cdn.dong4j.site/source/image/20241229154732_sNGiJBH5.webp)

MVC çš„ç»„ä»¶å…³ç³»å›¾æè¿°äº†æ¨¡å‹,è§†å›¾,æ§åˆ¶å™¨çš„äº¤äº’å…³ç³»

1. é¦–å…ˆæ˜¯å±•ç¤ºè§†å›¾ç»™ç”¨æˆ·,ç”¨æˆ·åœ¨è¿™ä¸ªè§†å›¾ä¸Šè¿›è¡Œæ“ä½œ,å¹¶å¡«å†™ä¸€äº›ä¸šåŠ¡æ•°æ®
2. ç„¶åç”¨æˆ·ç‚¹å‡»æäº¤æŒ‰é’®,å‘å‡ºè¯·æ±‚ (login.av-->LoginServlet)
3. è§†å›¾å‘å‡ºçš„è¯·æ±‚ä¼šè¢«æ§åˆ¶å™¨æ‹¦æˆª,è¯·æ±‚ä¸­åŒ…å«äº†æƒ³è¦å®Œæˆä»€ä¹ˆæ ·çš„ä¸šåŠ¡åŠŸèƒ½å’Œç›¸å…³æ•°æ® (ä» request ä¸­å–å¾—è¡¨å•æ•°æ®)
4. æ§åˆ¶å™¨ä¼šå¤„ç†ç”¨æˆ·è¯·æ±‚,ä¼šæŠŠè¯·æ±‚ä¸­çš„æ•°æ®è¿›è¡Œå°è£… (å°è£…æˆä¸€ä¸ª JavaBean),ç„¶åé€‰æ‹©è°ƒç”¨åˆé€‚çš„æ¨¡å‹,è¯·æ±‚æ¨¡å‹è¿›è¡ŒçŠ¶æ€æ›´æ–° (è°ƒç”¨é€»è¾‘å±‚ API,æ ¹æ®ä¸åŒçš„è¿”å›ç»“æœè°ƒç”¨è°ƒç”¨ä¸åŒçš„é¡µé¢æ˜¾ç¤ºä¿¡æ¯),ç„¶åé€‰æ‹©æ¥ä¸‹æ¥è¦å±•ç¤ºç»™ç”¨æˆ·çš„è§†å›¾
5. æ¨¡å‹ä¼šå»å¤„ç†ç”¨æˆ·è¯·æ±‚çš„ä¸šåŠ¡åŠŸèƒ½,åŒæ—¶è¿›è¡Œæ¨¡å‹çŠ¶æ€çš„ç»´æŠ¤å’Œæ›´æ–°
6. å½“æ¨¡å‹çŠ¶æ€æ”¹å˜çš„æ—¶å€™,æ¨¡å‹ä¼šé€šçŸ¥ç›¸åº”çš„è§†å›¾å‘Šè¯‰è‡ªå·±å‘ç”Ÿäº†æ”¹å˜
7. è§†å›¾æ¥æ”¶åˆ°æ¨¡å‹çš„é€šçŸ¥å,ä¼šå‘æ¨¡å‹è¿›è¡ŒçŠ¶æ€æŸ¥è¯¢,è·å–éœ€è¦å±•ç¤ºçš„æ•°æ®,ç„¶åæŒ‰ç…§æœ¬èº«çš„å±•ç¤ºæ–¹å¼,æŠŠè¿™äº›æ•°æ®å±•ç¤ºå‡ºæ¥,ç­‰å¾…ç”¨æˆ·çš„ä¸‹ä¸€æ¬¡è¯·æ±‚.

### Model2 å¼€å‘æ­¥éª¤

1. å®šä¹‰ä¸€ç³»åˆ— Bean æ¥è¡¨ç¤ºæ•°æ®
2. ä½¿ç”¨ Servlet å¤„ç†è¯·æ±‚
3. åœ¨ Servlet ä¸­å¡«å……æ•°æ®
4. åœ¨ Servlet ä¸­,å°† Bean å­˜å‚¨åˆ°è¯·æ±‚,ä¼šè¯æˆ–è€… Applaction ä½œç”¨åŸŸä¸­
5. å°†è¯·æ±‚è½¬å‘åˆ° jsp é¡µé¢
6. åœ¨ jsp é¡µé¢ä¸­,ä» Bean ä¸­æå–æ•°æ®

## ä¸‰å±‚æ¶æ„

ä¸‰å±‚æ¶æ„ (3-tier architecture) é€šå¸¸æ„ä¹‰ä¸Šçš„ä¸‰å±‚æ¶æ„å°±æ˜¯å°†æ•´ä¸ªä¸šåŠ¡åº”ç”¨åˆ’åˆ†ä¸ºï¼šç•Œé¢å±‚ï¼ˆUser Interface layerï¼‰ã€ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆBusiness Logic Layerï¼‰ã€æ•°æ®è®¿é—®å±‚ï¼ˆData access layerï¼‰ã€‚åŒºåˆ†å±‚æ¬¡çš„ç›®çš„å³ä¸ºäº†â€œé«˜å†…èšä½è€¦åˆâ€çš„æ€æƒ³ã€‚åœ¨è½¯ä»¶ä½“ç³»æ¶æ„è®¾è®¡ä¸­ï¼Œåˆ†å±‚å¼ç»“æ„æ˜¯æœ€å¸¸è§ï¼Œä¹Ÿæ˜¯æœ€é‡è¦çš„ä¸€ç§ç»“æ„ã€‚å¾®è½¯æ¨èçš„åˆ†å±‚å¼ç»“æ„ä¸€èˆ¬åˆ†ä¸ºä¸‰å±‚ï¼Œä»ä¸‹è‡³ä¸Šåˆ†åˆ«ä¸ºï¼šæ•°æ®è®¿é—®å±‚ã€ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆåˆæˆ–ç§°ä¸ºé¢†åŸŸå±‚ï¼‰ã€è¡¨ç¤ºå±‚ã€‚

![20241229154732_TxieTy0r.webp](https://cdn.dong4j.site/source/image/20241229154732_TxieTy0r.webp)

## [ä½¿ç”¨Spring MVCä¸MyBatiså®ç°ç”¨æˆ·æ•°æ®ç®¡ç†ï¼ŒåŒ…æ‹¬æ³¨å†Œã€åˆ†é¡µå’Œåˆ é™¤](https://blog.dong4j.site/posts/22eab19d.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

SSH æ•´åˆæ—¶å®ç°äº†ç®€å•çš„ç™»å½•åŠŸèƒ½,è¿™æ¬¡å®ç°ç®€å•çš„æ³¨å†ŒåŠŸèƒ½.  
éœ€è¦æ”¹åŠ¨çš„åœ°æ–¹ä¸‹é¢ä¼šæåˆ°,æ²¡æœ‰æåˆ°çš„åœ°æ–¹å°±ä¸æ”¹åŠ¨

## è¦æ±‚

1.ç™»å½• register.jsp é¡µé¢,å¡«å…¥å¿…è¦ä¿¡æ¯,ç‚¹å‡»æ³¨å†Œ;  
2.å¦‚æœæˆåŠŸ,è·³è½¬åˆ° success.jsp,å¹¶æ˜¾ç¤ºå‡ºæ‰€æœ‰çš„ç”¨æˆ·ä¿¡æ¯;  
3.å¦‚æœæ³¨å†Œå¤±è´¥,åˆ™è·³è½¬åˆ° error.jsp é¡µé¢  
4.å®ç°åˆ†é¡µåŠŸèƒ½,å®ç°åˆ é™¤åŠŸèƒ½

## å®ç°

1.æ–°å»º t_user è¡¨

```sql
-- ----------------------------
-- Table structure for t_user
-- ----------------------------
DROP TABLE IF EXISTS `t_user`;
CREATE TABLE `t_user` (
  `user_id` int(11) NOT NULL AUTO_INCREMENT,
  `f_name` varchar(255) DEFAULT NULL,
  `f_password` varchar(255) DEFAULT NULL,
  `f_age` int(11) DEFAULT NULL,
  `f_sex` varchar(255) DEFAULT NULL,
  `f_city` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`user_id`)
) ENGINE=InnoDB AUTO_INCREMENT=87 DEFAULT CHARSET=utf8;

-- ----------------------------
-- Records of t_user
-- ----------------------------
INSERT INTO `t_user` VALUES ('14', 'rooterger', 'dus', '23', 'rth', 'jngfnm');
INSERT INTO `t_user` VALUES ('31', 'root2', 'dus010', '234', 'erh', 'tyjty');
INSERT INTO `t_user` VALUES ('32', 'er', 'du010', '23', 'rth', 'tym');
INSERT INTO `t_user` VALUES ('33', 'rootehr', 'trj', '23', 'segv', 'rtj');
INSERT INTO `t_user` VALUES ('34', 'refw', 'dus82010', '23', 'erg', 'tg');
INSERT INTO `t_user` VALUES ('45', 'ergrth', 'tyj', '2', 'tyj', 'erh');
INSERT INTO `t_user` VALUES ('53', 'ergfgnfgn', 'erg', '213', 'erg', 'gfnfg');
INSERT INTO `t_user` VALUES ('54', 'ghn', 'ghmghm', '213', 'ghm', 'fgn');
INSERT INTO `t_user` VALUES ('55', 'hj,', 'hj,', '324', 'jh,', 'rtbh');
INSERT INTO `t_user` VALUES ('56', 'erg', 'erg', '23', 'erg', 'fdbfgn');
INSERT INTO `t_user` VALUES ('74', 'tgym', 'ghm', '234', 'hgmghm', 'ghm');
INSERT INTO `t_user` VALUES ('76', 'dfbfd', 'dfb', '23', 'dfb', 'dfnb');
INSERT INTO `t_user` VALUES ('77', 'edhrtjytjk', 'hykm', '23', 'edb', 'dfb');
INSERT INTO `t_user` VALUES ('79', 'dfnb', 'fgn', '234', 'fgn', 'fn');
INSERT INTO `t_user` VALUES ('80', 'yuk', 'yukm', '32', 'db', 'fgn');
INSERT INTO `t_user` VALUES ('81', 'rthrthtrh', 'rth', '234', 'rthrt', 'rtnghm');
INSERT INTO `t_user` VALUES ('82', 'fgngffgn', 'fgnfgn', '23', 'sv', 'fgn');
INSERT INTO `t_user` VALUES ('84', 'dfbdf', 'dfnf', '32', 'gngfn', 'gfm');
INSERT INTO `t_user` VALUES ('85', 'ergergtyj', 'tyjkyk', '2', 'wefwe', 'rthntj');
INSERT INTO `t_user` VALUES ('86', 'fgnfgfgmhgm', 'hgmgh', '32', 'sdv', 'fgnghm');
```

2.æ–°å»º UserBean.java

```java
package com.code.ssm.bean;
import java.io.Serializable;
public class UserBean implements Serializable{
    private static final long serialVersionUID = -6971764181923020401L;
    private int id;
    private String username;
    private String password;
    private int age;
    private String sex;
    private String city;
    public UserBean() {}
    public UserBean(String username, String password, int age, String sex, String city) {
        this.username = username;
        this.password = password;
        this.age = age;
        this.sex = sex;
        this.city = city;
    }
    public int getId() {return id;}
    public void setId(int id) {this.id = id;}
    public String getUsername() {return username;}
    public void setUsername(String username) {this.username = username;}
    public String getPassword() {return password;}
    public void setPassword(String password) {this.password = password;}
    public int getAge() {return age;}
    public void setAge(int age) {this.age = age;}
    public String getSex() { return sex;}
    public void setSex(String sex) {this.sex = sex;}
    public String getCity() {return city;}
    public void setCity(String city) {this.city = city;}

    @Override
    public String toString() {
        return "UserBean{" +
                "id=" + id +
                ", username='" + username + '\'' +
                ", password='" + password + '\'' +
                ", age=" + age +
                ", sex='" + sex + '\'' +
                ", city='" + city + '\'' +
                '}';
    }
}
```

3.æ–°å»º UserMapper.java

```java
package com.code.ssm.mapper;
import com.code.ssm.bean.UserBean;
import org.apache.ibatis.annotations.Param;
import java.util.List;
public interface UserMapper {
    List<UserBean> getUserByName(@Param("username")String username);
    int addUser(UserBean userBean);
    List<UserBean> getAllUsers();
    //åˆ†é¡µå®ç°
    List<UserBean> getAllUsersLimit(@Param("pageNow")int pageNow,@Param("pageSize")int pageSize);
    int getCounts();
    int delUser(@Param("id") int id);
}
```

4.æ–°å»º UserMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.code.ssm.mapper.UserMapper">

    <!-- ç»“æœæ˜ å°„ -->
    <resultMap id="userMap" type="UserBean" >
        <id property="id" column="user_id" javaType="int"/>
        <result property="username" column="f_name" javaType="java.lang.String"/>
        <result property="password" column="f_password" javaType="java.lang.String"/>
        <result property="age" column="f_age" javaType="int"/>
        <result property="sex" column="f_sex" javaType="java.lang.String"/>
        <result property="city" column="f_city" javaType="java.lang.String"/>
    </resultMap>

    <insert id="addUser">
        insert into t_user(f_name,f_password,f_age,f_sex,f_city) values(#{username},#{password},#{age},#{sex},#{city})
    </insert>
    <delete id="delUser">
        delete from t_user where user_id=#{id}
    </delete>
    <select id="getUserByName" resultType="com.code.ssm.bean.UserBean">
        select * from t_user where f_name=#{username}
    </select>
    <select id="getAllUsers" resultMap="userMap">
        select * from t_user
    </select>
    <select id="getAllUsersLimit" resultMap="userMap">
        select * from t_user limit #{pageNow},#{pageSize}
    </select>
    <select id="getCounts" resultType="java.lang.Integer">
        select count(*) from t_user
    </select>
</mapper>
```

5.UserService.java

```java
package com.code.ssm.service;
import com.code.ssm.bean.UserBean;
import java.util.List;
public interface UserService {
    public boolean register(UserBean userBean);
    public List<UserBean> getAllUsers(int pageNow, int pageSize);
    public boolean delUser(int id);
    int getCounts();
}
```

6.UserServiceImp.java

```java
package com.code.ssm.service.imp;

import com.code.ssm.bean.UserBean;
import com.code.ssm.mapper.UserMapper;
import com.code.ssm.service.UserService;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.util.List;

@Service("userService")
public class UserServiceImp implements UserService {
    @Resource
    private UserMapper userMapper;
    @Override
    public boolean register(UserBean userBean) {
        if(userMapper.getUserByName(userBean.getUsername()).size() == 0){
            userMapper.addUser(userBean);
            return true;
        }else return false;
    }
    @Override
    public List<UserBean> getAllUsers(int pageNow,int pageSize) {
        int a = (pageNow - 1) * pageSize;
        return userMapper.getAllUsersLimit(a,pageSize);
    }
    @Override
    public boolean delUser(int id) {
        return 1 == userMapper.delUser(id);
    }
    @Override
    public int getCounts() {
        return userMapper.getCounts();
    }
}
```

7.å¯¼å…¥ jQuery+bootstrap åŒ…  
8.æ–°å»º register.jsp

```html
<%@ page contentType = "text/html;charset=UTF-8" pageEncoding = "UTF-8" language
= "java" %>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>æ³¨å†Œ</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/fort.css" />
    <style>
      a {
        font-size: 16px;
        color: white;
      }
    </style>
  </head>

  <body>
    <h1>æ³¨å†Œ</h1>
    <div class="form-wrapper">
      <%--é¡¶éƒ¨é¢œè‰²æ¡--%>
      <div class="top"><div class="colors"></div></div>
      <form name="form" action="register.spring" method="POST">
        <div class="form">
          <div class="form-item">
            <input
              type="text"
              name="username"
              required="required"
              placeholder="ç”¨æˆ·å"
              autocomplete="off"
            />
          </div>
          <div class="form-item">
            <input
              type="password"
              name="password"
              required="required"
              placeholder="å¯†ç "
              autocomplete="off"
            />
          </div>
          <div class="form-item">
            <input
              type="text"
              name="sex"
              required="required"
              placeholder="æ€§åˆ«"
              autocomplete="off"
            />
          </div>
          <div class="form-item">
            <input
              type="text"
              name="age"
              required="required"
              placeholder="å¹´é¾„"
              autocomplete="off"
            />
          </div>
          <div class="form-item">
            <input
              type="text"
              name="city"
              required="required"
              placeholder="ç±è´¯"
              autocomplete="off"
            />
          </div>
          <div class="button-panel">
            <input type="submit" class="button" title="Register" value="æ³¨å†Œ" />
          </div>
        </div>
      </form>
    </div>

    <script src="js/jquery-1.11.3.min.js"></script>
    <script src="js/fort.js"></script>
    <script>
      sections();
    </script>
  </body>
</html>
```

9.æ¥ä¸‹æ¥å¼€å§‹ Controller çš„ä¹¦å†™  
ç”±äºä½¿ç”¨äº† ajax å¼‚æ­¥åŠ è½½è¡¨æ ¼æ•°æ®,æ‰€ä»¥éœ€è¦å¯¼å…¥å°† Bean è½¬æ¢æˆ json æ•°æ®æ ¼å¼çš„å·¥å…·åŒ…  
fastjson-1.1.15.jar  
jsoup-1.8.1.jar

```java
package com.code.ssm.controller;

import com.alibaba.fastjson.JSONArray;
import com.code.ssm.bean.UserBean;
import com.code.ssm.service.UserService;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.io.PrintWriter;
import java.util.List;
@Controller
public class UserController {
    //åˆ†é¡µå¤§å°
    private static final int PAGESIZE = 5;
    @Resource(name="userService")
    private UserService userService;
    @RequestMapping("/register")
    //å½“è¯·æ±‚register.springæ—¶,è‡ªåŠ¨å°†è¡¨å•ä¸­çš„æ•°æ®å°è£…æˆUserBeanå¯¹è±¡,å‰ææ˜¯æ§ä»¶nameå±æ€§è¦å’ŒUserBeanå±æ€§åç›¸åŒ
    public String register(UserBean userBean, HttpServletRequest request){
        //è°ƒç”¨register()å®ç°å‘æ•°æ®åº“ä¸­æ·»åŠ æ•°æ®
        //å…ˆæ‰§è¡ŒæŸ¥è¯¢,å¦‚æœæ•°æ®åº“ä¸­æœ‰åŒåçš„æ•°æ®,åˆ™æ³¨å†Œå¤±è´¥,è·³è½¬åˆ°error.jsp
        //å¦‚æœæ²¡æœ‰ç›¸åŒæ•°æ®,åˆ™æ‰§è¡Œinsertè¯­å¥,è·³è½¬åˆ°success.jsp
        //è¿™æ—¶å°†å†æ¬¡æŸ¥è¯¢æ•°æ®åº“,è¿”å›æ‰€æœ‰çš„ç”¨æˆ·ä¿¡æ¯(åˆ†é¡µ)
        if(userService.register(userBean)){
            //åˆå§‹åŒ–æ€»é¡µæ•°
            int counts = userService.getCounts();
            int pageNum = (int)Math.ceil(counts / (PAGESIZE * 1.0));
            //å¾—åˆ°åˆ†é¡µæ•°æ®
            List<UserBean> allUsers = userService.getAllUsers(1,PAGESIZE);
            //æ”¾requset
            //request.setAttribute("pageNum",pageNum);
            //æ”¾sessionéƒ½ä¸€æ ·
            request.getSession().setAttribute("pageNum",pageNum);
            //åˆå§‹åŒ–å½“å‰é¡µä¸ºç¬¬ä¸€é¡µ
            request.setAttribute("pageNow",1);
            //å°†æ‰€æœ‰ç”¨æˆ·æ•°æ®è¿”å›ç»™jspæ˜¾ç¤º
            request.getSession().setAttribute("allUsers",allUsers);
            return "success";
        }else return "error";
    }

    //åˆ†é¡µè¯·æ±‚æ•°æ®
    @RequestMapping("/limitPage")
    //å½“ç‚¹å‡»ä¸‹ä¸€ä¸ª/ä¸Šä¸€é¡µ/æŒ‰é¡µæ•°è·³è½¬æ—¶è°ƒç”¨æ­¤æ–¹æ³•
    public void limitPage(HttpServletRequest request,HttpServletResponse response) throws IOException {
        //å…ˆå¾—åˆ°å½“å‰é¡µæ•°
        int pageNow = Integer.parseInt(request.getParameter("pageNow"));
        //æ ¹æ®å½“å‰é¡µåœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢æ•°æ®
        List<UserBean> allUsers = userService.getAllUsers(pageNow,PAGESIZE);
        PrintWriter out = response.getWriter();
        //å°†Listè½¬æ¢æˆjsonæ ¼å¼æ•°æ®
        out.print(JSONArray.toJSONString(allUsers,true));
    }

    //å½“ç‚¹å‡»"åˆ é™¤"æ˜¯è°ƒç”¨æ­¤æ–¹æ³•
    @RequestMapping(value = "/delUser")
    public void delUser(HttpServletRequest request,HttpServletResponse response,  @RequestParam("id")int id) throws IOException {
        PrintWriter out = response.getWriter();
        if(userService.delUser(id)){
            //åˆ é™¤ä¹‹åæ€»é¡µæ•°è¦å˜
            int counts = userService.getCounts();
            int pageNum = (int)Math.ceil(counts / (PAGESIZE * 1.0));
            int pageNow = Integer.parseInt(request.getParameter("pageNow"));
            List<UserBean> allUsers = userService.getAllUsers(pageNow,PAGESIZE);
            //å°†æ€»é¡µæ•°æ”¾åˆ°é›†åˆä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ 
            //å› ä¸ºæ˜¯ajaxå±€éƒ¨åŠ è½½è¡¨æ ¼,è¿™é‡Œå°†å˜åŒ–åçš„æ€»é¡µæ•°æ”¾åˆ°äº†æ•°æ®é›†åˆä¸­ä¸€èµ·ä¼ å›ç»™jsp
            //åœ¨jspä¸­å–é›†åˆæœ€åä¸€ä¸ªå…ƒç´ ,ç„¶åæ‹†åˆ†æ•°æ®å°±å¯ä»¥å¾—åˆ°æ€»é¡µæ•°
            UserBean pageNumBean = new UserBean();
            pageNumBean.setUsername("pageNum&" + pageNum);
            allUsers.add(pageNumBean);
            out.print(JSONArray.toJSONString(allUsers,true));
        }else out.print("'message':'failed'");
    }
}
```

10.æ–°å»º success.jsp

```html
<%-- Created by IntelliJ IDEA. User: Code.Ai To change this template use File |
Settings | File Templates. --%> <%@ page contentType="text/html;charset=UTF-8"
pageEncoding="UTF-8" language="java" %> <%@ taglib prefix = "c" uri =
"http://java.sun.com/jsp/jstl/core" %>
<html>
  <head>
    <title>success</title>
    <link rel="stylesheet" href="./bootstrap/css/bootstrap.min.css" />
    <link
      href="./bootstrap/css/bootstrap-datetimepicker.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./css/index.css" />
  </head>
  <body>
    <div class="container-fluid">
      <!--æ ‡é¢˜-->
      <div class="row-fluid">
        <div class="span12">
          <h3 class="text-center" style="color: white">å…¨éƒ¨ç”¨æˆ·ä¿¡æ¯</h3>
        </div>
      </div>
      <!--è¡¨æ ¼-->

      <div
        class="row-fluid table-responsive"
        style="border: solid;background-color: white"
      >
        <table class="table   table-bordered">
          <tr>
            <th class="col-md-2">å§“å</th>
            <th class="col-md-2">å¹´é¾„</th>
            <th class="col-md-2">æ€§åˆ«</th>
            <th class="col-md-3">ç±è´¯</th>
            <th class="col-md-3">æ“ä½œ</th>
          </tr>
        </table>

        <div
          id="tableTD"
          class="row-fluid"
          style="overflow-y: auto;height: 208px;margin-top: -20px;background-color: white"
        >
          <table id="table" class="table  table-bordered  table-condensed">
            <c:forEach
              items="${sessionScope.allUsers}"
              var="user"
              <%--ç‚¹å‡»è¡¨æ ¼è¡Œæ”¹å˜é¢œè‰²--%
            >
              <tr onclick="select(this,'#selectID')">
                <input type="hidden" value="${user.id}" />
                <td class="col-md-2">${user.username}</td>
                <td class="col-md-2">${user.age}</td>
                <td class="col-md-2">${user.sex}</td>
                <td class="col-md-3">${user.city}</td>
                <td class="col-md-3">
                  <a href="#" id="${user.id}" onclick="delUser(this)">åˆ é™¤</a>
                </td>
              </tr>
            </c:forEach>
          </table>
          <input type="hidden" value="-1" id="selectID" name="selectID" />
        </div>

        <%--åˆ†é¡µæŒ‰é’®--%>
        <div class="row-fluid">
          <div class="span12">
            <div>
              <button
                id="previousPage"
                class="btn btn-sm"
                type="button"
                style="line-height:0px"
              >
                <span class="glyphicon glyphicon-chevron-left"></span>
              </button>
              <input
                id="pageNow"
                type="text"
                style="width: 40px;height: 20px"
                value="${requestScope.pageNow}"
              />
              <label id="pageNum">/${sessionScope.pageNum}</label>
              <button
                id="go"
                class="btn btn-sm"
                type="button"
                style="line-height:0px"
              >
                <span class="glyphicon glyphicon-step-forward"></span>
              </button>
              <button
                id="nextPage"
                class="btn  btn-sm"
                type="button"
                style="line-height:0px"
              >
                <span class="glyphicon glyphicon-chevron-right"></span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script type="text/javascript" src="./js/jquery-1.11.3.min.js"></script>
    <script
      type="text/javascript"
      src="./bootstrap/js/bootstrap.min.js"
    ></script>
    <script
      type="text/javascript"
      src="./bootstrap/js/bootstrap-table.js"
    ></script>
    <script
      type="text/javascript"
      src="./bootstrap/js/bootstrap-datetimepicker.js"
      charset="UTF-8"
    ></script>
    <script
      type="text/javascript"
      src="./bootstrap/js/locales/bootstrap-datetimepicker.zh-CN.js"
      charset="UTF-8"
    ></script>
    <script type="text/javascript" src="./js/index.js"></script>

    <script type="text/javascript" src="./js/ajaxfileupload.js"></script>
    <script type="text/javascript" src="./js/uploadPreview.min.js"></script>

    <script type="text/javascript">
      //å…¨å±€
      var pageNow = parseInt($("#pageNow").val());
      var pageNum = parseInt(${sessionScope.pageNum});

      function delUser(obj){
          var id = obj.id;
          $.ajax({
              type: 'POST',
              url: 'delUser.spring',
              data: {'id': id,'pageNow':pageNow},
              cache: false,
              //ä¸èƒ½ç”¨json
              dataType: 'text',
              success: function (data) {
                  var jsonObj = eval("("+ data+")");
                  if(jsonObj.message == "failed"){
                      alert("åˆ é™¤å¤±è´¥");
                  }else{
                      //åˆ é™¤å•è¡Œ
                      //obj.parentNode.parentNode.parentNode.removeChild(obj.parentNode.parentNode);
                      //è®¾ç½®æ€»é¡µæ•° åœ¨é›†åˆä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ çš„usernameä¸­
                      var arrayObj =  jsonObj[jsonObj.length - 1].username.split("&");
                      pageNum = arrayObj[1];
                      $("#pageNum").text("/"+pageNum);
                      $("#table").empty();
                      for (var i = 0; i < jsonObj.length; i++) {
                          $("#table").append(
                                  "<tr>" +
                                  "<td class = 'col-md-2' >"+  jsonObj[i].username+"</td>" +
                                  "<td class = 'col-md-2' >"+  jsonObj[i].age+"</td>" +
                                  "<td class = 'col-md-2' >" + jsonObj[i].sex + "</td>" +
                                  "<td class = 'col-md-3' >" + jsonObj[i].city + "</td>" +
                                  "<td class = 'col-md-3' >" + "<a href='#' id= " + jsonObj[i].id +" onclick='delUser(this)'>åˆ é™¤</a>" + "</td>" +
                                  "</tr>");
                      }
                  }
              }
          });
          return false;
      }

      /**************************************************************************/

      //ä¸Šä¸€é¡µäº‹ä»¶
      $("#previousPage").click(function () {
          if (pageNow > 1){
              pageNow = pageNow -1 ;
              $.ajax({
                  type: "GET",
                  url: "limitPage.spring",
                  data: { "pageNow": pageNow},
                  dataType: 'text',
                  success: function (data) {
                      $("#pageNow").val(pageNow);
                      var jsonObj = eval("(" + data + ")");
                      $("#table").empty();
                      for (var i = 0; i < jsonObj.length; i++) {
                          $("#table").append(
                                  "<tr>" +
                                  "<td class = 'col-md-2' >"+  jsonObj[i].username+"</td>" +
                                  "<td class = 'col-md-2' >"+  jsonObj[i].age+"</td>" +
                                  "<td class = 'col-md-2' >" + jsonObj[i].sex + "</td>" +
                                  "<td class = 'col-md-3' >" + jsonObj[i].city + "</td>" +
                                  "<td class = 'col-md-3' >" + "<a href='#' id= " + jsonObj[i].id +" onclick='delUser(this)'>åˆ é™¤</a>" + "</td>" +
                                  "</tr>");
                      }
                  }
              })
          }
          else alert("å·²æ˜¯ç¬¬ä¸€é¡µï¼");
      });

      //ä¸‹ä¸€é¡µäº‹ä»¶
      $("#nextPage").click(function () {
          if (pageNow < pageNum){
              pageNow = pageNow + 1;
              $.ajax({
                  type: "GET",
                  url: "limitPage.spring",
                  data: { "pageNow": pageNow},
                  dataType: 'text',
                  success: function (data) {
                      $("#pageNow").val(pageNow);
                      var jsonObj = eval("(" + data + ")");
                      $("#table").empty();
                      for (var i = 0; i < jsonObj.length; i++) {
                          $("#table").append(
                                  "<tr>" +
                                  "<td class = 'col-md-2' >"+  jsonObj[i].username+"</td>" +
                                  "<td class = 'col-md-2' >"+  jsonObj[i].age+"</td>" +
                                  "<td class = 'col-md-2' >" + jsonObj[i].sex + "</td>" +
                                  "<td class = 'col-md-3' >" + jsonObj[i].city + "</td>" +
                                  "<td class = 'col-md-3' >" + "<a href='#' id= " + jsonObj[i].id +" onclick='delUser(this)'>åˆ é™¤</a>" + "</td>" +
                                  "</tr>");
                      }
                  }
              })
          }

          else alert("å·²æ˜¯æœ€åä¸€é¡µï¼");
      });

      //è·³è½¬åˆ°æŒ‡å®šé¡µç‚¹å‡»äº‹ä»¶
      $("#go").click(function () {
          var num = parseInt($("#pageNow").val());
          if(num <= pageNum){
              $.ajax({
                  type: "GET",
                  url: "limitPage.spring",
                  data: {"pageNow": num},
                  dataType: 'text',
                  success: function (data) {
                      pageNow = num;
                      var jsonObj = eval("(" + data + ")");
                      $("#table").empty();
                      for (var i = 0; i < jsonObj.length; i++) {
                          $("#table").append(
                                  "<tr>" +
                                  "<td class = 'col-md-2' >"+  jsonObj[i].username+"</td>" +
                                  "<td class = 'col-md-2' >"+  jsonObj[i].age+"</td>" +
                                  "<td class = 'col-md-2' >" + jsonObj[i].sex + "</td>" +
                                  "<td class = 'col-md-3' >" + jsonObj[i].city + "</td>" +
                                  "<td class = 'col-md-3' >" + "<a href='#' id= " + jsonObj[i].id +" onclick='delUser(this)'>åˆ é™¤</a>" + "</td>" +
                                  "</tr>");
                      }
                  }
              })
          }else alert("è¶…å‡ºæ€»é¡µæ•°");
      });
    </script>
  </body>
</html>
```

## æ•ˆæœ

ç”±äºæ²¡æœ‰é…ç½®ç¼–ç è¿‡æ»¤å™¨,æ‰€ä»¥æ·»åŠ è¿›å»çš„æ˜¯ä¹±ç 

## [Mybatiså…¥é—¨äº”ï¼šæ¢ç´¢Mapper Javaæ¥å£ä¸Mapå‚æ•°çš„çµæ´»ç»“åˆ](https://blog.dong4j.site/posts/7bb33d78.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

1.mapper.xml é…ç½®

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.code.mapper.StudentMapper">

    <!-- å¼€å¯äºŒçº§ç¼“å­˜ -->
    <cache size="1024" flushInterval="6000" readOnly="true" eviction="LRU"></cache>
    <!-- å¼•ç”¨å¦ä¸€ä¸ªæ˜ å°„æ–‡ä»¶ä¸­é…ç½®çš„äºŒçº§ç¼“å­˜ -->
    <!-- <cache-ref namespace="com.code.mapper.UserMapper"/> -->

    <resultMap type="StudentBean" id="studentMap">
        <id property="id" column="student_id" javaType="int"/>
        <result property="name" column="f_name" javaType="java.lang.String"/>
        <result property="age" column="f_age" javaType="int"/>
        <result property="className" column="f_classes" javaType="java.lang.String"/>
        <result property="java" column="f_java" javaType="int"/>
        <result property="db" column="f_db" javaType="int"/>
        <result property="web" column="f_web" javaType="int"/>
        <result property="html" column="f_html" javaType="int"/>
    </resultMap>

    <!--
        ifæ¡ä»¶:
        åœ¨æ¡ä»¶ä¸ªæ•°ä¸ç¡®å®šçš„æ—¶å€™ä½¿ç”¨
        æ¯”å¦‚æ ¹æ®å„ç§‘åˆ†æ•°è¿›è¡ŒæŸ¥è¯¢(ç”¨æˆ·å¯é€‰æ‹©æŸ¥è¯¢å“ªå‡ ä¸ªä»¥åŠåˆ†æ•°çº¿å¤§äºå¤šå°‘)
        ä¼ é€’è¿‡æ¥çš„å‚æ•°æ˜¯ä¸€ä¸ªMap,åœ¨Mapä¸­å…ƒç´ æ˜¯ <ç§‘ç›®,åˆ†æ•°>
     -->
    <select id="findStudentByCondition" parameterType="java.util.Map" resultMap="studentMap">
        select * from t_student where 1=1
        <if test="java != null">
            and f_java &gt;= #{java}
        </if>
        <if test="web != null">
            and f_web &gt;= #{web}
        </if>
        <if test="db != null">
            and f_db &gt;= #{db}
        </if>
        <if test="html != null">
            and f_html &gt;= #{html}
        </if>
    </select>

    <!--
        whereæ¡ä»¶:ä¸“é—¨ç”¨äºæŸ¥è¯¢,å¯ä»¥åµŒå¥—ifæ¡ä»¶ä½¿ç”¨
        1. è‡ªåŠ¨åŠ ä¸Šwhereè¯­å¥ä»¥and/orå¼€å¤´,è‡ªåŠ¨åˆ é™¤ç¬¬ä¸€ä¸ªandæˆ–or
        å¦‚æœ
     -->
    <select id="findStudentByCondition2" parameterType="java.util.Map" resultMap="studentMap">
        select * from t_student
        <where>
            <if test="java != null">
                and f_java &gt;= #{java}
            </if>
            <if test="web != null">
                and f_web &gt;= #{web}
            </if>
            <if test="db != null">
                and f_db &gt;= #{db}
            </if>
            <if test="html != null">
                and f_html &gt;= #{html}
            </if>
        </where>
    </select>

    <!--
        ä¸whereåŠŸèƒ½ç±»ä¼¼,æä¾›äº†å‰ç¼€å’Œåç¼€çš„åŠŸèƒ½
     -->
    <select id="findStudentByCondition3" parameterType="java.util.Map" resultMap="studentMap">
        select * from t_student
        <trim prefix="where" prefixOverrides="and">
            <if test="java != null">
                and f_java &gt;= #{java}
            </if>
            <if test="web != null">
                and f_web &gt;= #{web}
            </if>
            <if test="db != null">
                and f_db &gt;= #{db}
            </if>
            <if test="html != null">
                and f_html &gt;= #{html}
            </if>
        </trim>
    </select>

    <!-- æ ¹æ®Mapé›†åˆä¸­å·²æœ‰çš„keyæ¥æ›´æ–°æ•°æ®è¡¨,ä¸éœ€è¦æ›´æ–°å…¨éƒ¨çš„æ•°æ®è¡¨ -->
    <update id="updateStudentByCondition" parameterType="java.util.Map">
        update t_student
        <trim prefix="set" suffixOverrides=",">
            <if test="java != null">
                f_java = #{java},
            </if>
            <if test="web != null">
                f_web = #{web},
            </if>
            <if test="db != null">
                f_db = #{db},
            </if>
            <if test="html != null">
                f_html = #{html},
            </if>
        </trim>
        <if test="id != null">
            where student_id = #{id}
        </if>
    </update>

    <!--
        setæ¡ä»¶:ä¸“é—¨ç”¨äºupdateè¯­å¥
        å½“ä¸ºä¿®æ”¹çš„å­—æ®µæ•°ç›®ä¸ç¡®å®šæ—¶ä½¿ç”¨
        è‡ªåŠ¨åŠ ä¸Šset,è‡ªåŠ¨å»æ‰æœ€åä¸€ä¸ªé€—å·
     -->
    <update id="updateStudentByCondition2" parameterType="java.util.Map">
        update t_student
        <set>
            <if test="java != null">
                f_java = #{java},
            </if>
            <if test="web != null">
                f_web = #{web},
            </if>
            <if test="db != null">
                f_db = #{db},
            </if>
            <if test="html != null">
                f_html = #{html},
            </if>
        </set>
        <if test="id != null">
            where student_id = #{id}
        </if>
    </update>

    <!--
        ä¸»è¦ç”¨äºæŸ¥è¯¢inçš„æƒ…å†µ
     -->
    <select id="findStudentInClass"  resultMap="studentMap">
        select * from t_student
            <if test="classes != null">
                <where>
                    f_classes in
                    <foreach item="className" collection="classes"
                        open="(" separator="," close=")">
                        #{className}
                    </foreach>
                </where>
            </if>

    </select>

    <!--
        choose:é€‚ç”¨äºæ¡ä»¶ä¸ªæ•°ä¸å˜,ä½†æ˜¯æ¡ä»¶é¡¹æ”¹å˜çš„æŸ¥è¯¢
     -->
    <select id="findStudentByOneCondition" resultMap="studentMap">
        select * from t_student
        <choose>
            <when test="condition == 'name'">
                where f_name like #{value}
            </when>
            <when test="condition == 'age'">
                where f_age = #{value}
            </when>
            <when test="condition == 'className'">
                where f_classes like '%${value}%'
            </when>
            <otherwise>
                where student_id > 0
            </otherwise>
        </choose>
    </select>

    <select id="findStudentByOneCondition2" parameterType="java.util.Map" resultMap="studentMap">
        select * from t_student
        <choose>
            <when test="condition == 'name'">
                where f_name like #{value}
            </when>
            <when test="condition == 'age'">
                where f_age = #{value}
            </when>
            <when test="condition == 'className'">
                where f_classes like '%${value}%'
            </when>
            <otherwise>
                where student_id > 0
            </otherwise>
        </choose>
    </select>

</mapper>
```

2.ç¼–å†™ mapper.java

```java
package com.code.mapper;
import java.util.List;
import org.apache.ibatis.annotations.Param;
import com.code.bean.UserBean;
public interface UserMapper {
	public int addUser(@Param("user")UserBean user);
	public int deleteUserByID(@Param("userID")int userID);
	public int updateUserNameByID(@Param("name")String name, @Param("id")int id);
	public int updateUserByID(@Param("user")UserBean user,@Param("id")int id);
	public UserBean getUserByID(@Param("id")int id);
	public List<UserBean> getAllUsers(@Param("colName")String colName);
	public List<UserBean> getAllUsersLikeName(@Param("name")String name);
}
```

**å½“ä½¿ç”¨ Map åšä¸ºå‚æ•°æ—¶ï¼Œå¯ä»¥ç”¨ `_parameter.containsKey`(å˜é‡å)æ¥åˆ¤ æ–­ map ä¸­æ˜¯å¦åŒ…å«æœ‰äº›å˜é‡ï¼š**

```xml
<select id="selectRule" parameterType="Map" resultType="com.ourangel.weixin.domain.Rule">
    SELECT ruleId,msgType,event,respId,reqValue,firstRespId,createDate,yn
    FROM oal_tb_rule
    WHERE yn = 1
    <if test="_parameter.containsKey('msgType')">
        AND msgType = #{msgType,jdbcType=VARCHAR})
    </if>
    <if test="_parameter.containsKey('event')">
        AND event = #{event,jdbcType=VARCHAR})
    </if>
</select>
```

## [MyBatisäºŒçº§ç¼“å­˜å®æˆ˜æ•™ç¨‹](https://blog.dong4j.site/posts/66515f3d.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

æ­£å¦‚å¤§å¤šæ•°æŒä¹…å±‚æ¡†æ¶ä¸€æ ·ï¼ŒMyBatis åŒæ ·æä¾›äº†ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜çš„æ”¯æŒ

1. ä¸€çº§ç¼“å­˜: åŸºäº PerpetualCache çš„ HashMap æœ¬åœ°ç¼“å­˜ï¼Œå…¶å­˜å‚¨ä½œç”¨åŸŸä¸º Sessionï¼Œå½“ Session flush æˆ– close ä¹‹åï¼Œè¯¥ Session ä¸­çš„æ‰€æœ‰ Cache å°±å°†æ¸…ç©ºã€‚
2. äºŒçº§ç¼“å­˜ä¸ä¸€çº§ç¼“å­˜å…¶æœºåˆ¶ç›¸åŒï¼Œé»˜è®¤ä¹Ÿæ˜¯é‡‡ç”¨ PerpetualCacheï¼ŒHashMap å­˜å‚¨ï¼Œä¸åŒåœ¨äºå…¶å­˜å‚¨ä½œç”¨åŸŸä¸º Mapper(Namespace)ï¼Œå¹¶ä¸”å¯è‡ªå®šä¹‰å­˜å‚¨æºï¼Œå¦‚ Ehcacheã€‚
3. å¯¹äºç¼“å­˜æ•°æ®æ›´æ–°æœºåˆ¶ï¼Œå½“æŸä¸€ä¸ªä½œç”¨åŸŸ (ä¸€çº§ç¼“å­˜ Session/äºŒçº§ç¼“å­˜ Namespaces) çš„è¿›è¡Œäº† C/U/D æ“ä½œåï¼Œé»˜è®¤è¯¥ä½œç”¨åŸŸä¸‹æ‰€æœ‰ select ä¸­çš„ç¼“å­˜å°†è¢« clearã€‚

### ä¸€çº§ç¼“å­˜æµ‹è¯•

```java
import me.gacl.domain.User;
import me.gacl.util.MyBatisUtil;
import org.apache.ibatis.session.SqlSession;
import org.junit.Test;

/**
 * æµ‹è¯•ä¸€çº§ç¼“å­˜
 */
public class TestOneLevelCache {

    /*
     * ä¸€çº§ç¼“å­˜: ä¹Ÿå°±Sessionçº§çš„ç¼“å­˜(é»˜è®¤å¼€å¯)
     */
    @Test
    public void testCache1() {
        SqlSession session = MyBatisUtil.getSqlSession();
        String statement = "me.gacl.mapping.userMapper.getUser";
        User user = session.selectOne(statement, 1);
        System.out.println(user);

        /*
         * ä¸€çº§ç¼“å­˜é»˜è®¤å°±ä¼šè¢«ä½¿ç”¨
         */
        user = session.selectOne(statement, 1);
        System.out.println(user);
        session.close();
        /*
         1. å¿…é¡»æ˜¯åŒä¸€ä¸ªSession,å¦‚æœsessionå¯¹è±¡å·²ç»close()è¿‡äº†å°±ä¸å¯èƒ½ç”¨äº†
         */
        session = MyBatisUtil.getSqlSession();
        user = session.selectOne(statement, 1);
        System.out.println(user);

        /*
         2. æŸ¥è¯¢æ¡ä»¶æ˜¯ä¸€æ ·çš„
         */
        user = session.selectOne(statement, 2);
        System.out.println(user);

        /*
         3. æ²¡æœ‰æ‰§è¡Œè¿‡session.clearCache()æ¸…ç†ç¼“å­˜
         */
        //session.clearCache();
        user = session.selectOne(statement, 2);
        System.out.println(user);

        /*
         4. æ²¡æœ‰æ‰§è¡Œè¿‡å¢åˆ æ”¹çš„æ“ä½œ(è¿™äº›æ“ä½œéƒ½ä¼šæ¸…ç†ç¼“å­˜)
         */
        session.update("me.gacl.mapping.userMapper.updateUser",
                new User(2, "user", 23));
        user = session.selectOne(statement, 2);
        System.out.println(user);
    }
}

```

### äºŒçº§ç¼“å­˜æµ‹è¯•

å¼€å¯äºŒçº§ç¼“å­˜ï¼Œåœ¨ userMapper.xml æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®

```xml
<mapper namespace="me.gacl.mapping.userMapper">
<!-- å¼€å¯äºŒçº§ç¼“å­˜ -->
<cache/>
```

```java
import me.gacl.domain.User;
import me.gacl.util.MyBatisUtil;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.junit.Test;
/**
 * @author
 * æµ‹è¯•äºŒçº§ç¼“å­˜
 */
public class TestTwoLevelCache {
    /*
     * æµ‹è¯•äºŒçº§ç¼“å­˜
     * ä½¿ç”¨ä¸¤ä¸ªä¸åŒçš„SqlSessionå¯¹è±¡å»æ‰§è¡Œç›¸åŒæŸ¥è¯¢æ¡ä»¶çš„æŸ¥è¯¢ï¼Œç¬¬äºŒæ¬¡æŸ¥è¯¢æ—¶ä¸ä¼šå†å‘é€SQLè¯­å¥ï¼Œè€Œæ˜¯ç›´æ¥ä»ç¼“å­˜ä¸­å–å‡ºæ•°æ®
     */
    @Test
    public void testCache2() {
        String statement = "me.gacl.mapping.userMapper.getUser";
        SqlSessionFactory factory = MyBatisUtil.getSqlSessionFactory();
        //å¼€å¯ä¸¤ä¸ªä¸åŒçš„SqlSession
        SqlSession session1 = factory.openSession();
        SqlSession session2 = factory.openSession();
        //ä½¿ç”¨äºŒçº§ç¼“å­˜æ—¶ï¼ŒUserç±»å¿…é¡»å®ç°ä¸€ä¸ªSerializableæ¥å£===> User implements Serializable
        User user = session1.selectOne(statement, 1);
        session1.commit();//ä¸æ‡‚ä¸ºå•¥ï¼Œè¿™ä¸ªåœ°æ–¹ä¸€å®šè¦æäº¤äº‹åŠ¡ä¹‹åäºŒçº§ç¼“å­˜æ‰ä¼šèµ·ä½œç”¨
        System.out.println("user="+user);
        //ç”±äºä½¿ç”¨çš„æ˜¯ä¸¤ä¸ªä¸åŒçš„SqlSessionå¯¹è±¡ï¼Œæ‰€ä»¥å³ä½¿æŸ¥è¯¢æ¡ä»¶ç›¸åŒï¼Œä¸€çº§ç¼“å­˜ä¹Ÿä¸ä¼šå¼€å¯ä½¿ç”¨
        user = session2.selectOne(statement, 1);
        //session2.commit();
        System.out.println("user2="+user);
    }
}
```

### æ€»ç»“

1. æ˜ å°„è¯­å¥æ–‡ä»¶ä¸­çš„æ‰€æœ‰ select è¯­å¥å°†ä¼šè¢«ç¼“å­˜ã€‚  
   ã€€ã€€ 2. æ˜ å°„è¯­å¥æ–‡ä»¶ä¸­çš„æ‰€æœ‰ insertï¼Œupdate å’Œ delete è¯­å¥ä¼šåˆ·æ–°ç¼“å­˜ã€‚  
   ã€€ã€€ 3. ç¼“å­˜ä¼šä½¿ç”¨ Least Recently Usedï¼ˆLRUï¼Œæœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ï¼‰ç®—æ³•æ¥æ”¶å›ã€‚  
   ã€€ã€€ 4. ç¼“å­˜ä¼šæ ¹æ®æŒ‡å®šçš„æ—¶é—´é—´éš”æ¥åˆ·æ–°ã€‚  
   ã€€ã€€ 5. ç¼“å­˜ä¼šå­˜å‚¨ 1024 ä¸ªå¯¹è±¡

cache æ ‡ç­¾å¸¸ç”¨å±æ€§ï¼š

```xml
<cache
eviction="FIFO"  <!--å›æ”¶ç­–ç•¥ä¸ºå…ˆè¿›å…ˆå‡º-->
flushInterval="60000" <!--è‡ªåŠ¨åˆ·æ–°æ—¶é—´60s-->
size="512" <!--æœ€å¤šç¼“å­˜512ä¸ªå¼•ç”¨å¯¹è±¡-->
readOnly="true"/> <!--åªè¯»-->
```

## [MyBatis ä¸€å¯¹å¤šã€ä¸€å¯¹ä¸€æŸ¥è¯¢è¯¦è§£ä¸é…ç½®ç¤ºä¾‹](https://blog.dong4j.site/posts/2a833323.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ä¸€å¯¹ä¸€å…³è”

1.è¦æ±‚  
å‡è®¾ä¸€é—´æˆ¿å­åªæœ‰ä¸€æŠŠé”,è¦æ±‚é€šè¿‡é”æ‰¾åˆ°æˆ¿å­  
2.åˆ›å»ºè¡¨å’Œæ•°æ®

```sql
SET FOREIGN_KEY_CHECKS=0;

-- ----------------------------
-- Table structure for t_lock
-- ----------------------------
DROP TABLE IF EXISTS `t_lock`;
CREATE TABLE `t_lock` (
  `lock_id` int(11) NOT NULL AUTO_INCREMENT,
  `f_type` varchar(255) DEFAULT NULL,
  `fk_home_id` int(11) DEFAULT NULL,
  PRIMARY KEY (`lock_id`),
  KEY `fk_home_id` (`fk_home_id`),
  CONSTRAINT `t_lock_ibfk_1` FOREIGN KEY (`fk_home_id`) REFERENCES `t_home` (`home_id`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;

-- ----------------------------
-- Records of t_lock
-- ----------------------------
INSERT INTO `t_lock` VALUES ('1', 'é˜²ç›—é”', '2');
INSERT INTO `t_lock` VALUES ('2', 'é“é”', '1');
INSERT INTO `t_lock` VALUES ('3', 'é“œé”', '3');
-- ----------------------------
-- Table structure for t_home
-- ----------------------------
DROP TABLE IF EXISTS `t_home`;
CREATE TABLE `t_home` (
  `home_id` int(11) NOT NULL AUTO_INCREMENT,
  `f_address` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`home_id`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;

-- ----------------------------
-- Records of t_home
-- ----------------------------
INSERT INTO `t_home` VALUES ('1', '1å·å®¶åº­');
INSERT INTO `t_home` VALUES ('2', '2å·å®¶åº­');
INSERT INTO `t_home` VALUES ('3', '3å·å®¶åº­');
```

3.å®šä¹‰å®ä½“ç±»

- HomeBean.java

```java
package com.code.bean;
public class HomeBean {
    private int id;
    private String address;
    public int getId() {
        return id;
    }
    public void setId(int id) {
        this.id = id;
    }
    public String getAddress() {
        return address;
    }
    public void setAddress(String address) {
        this.address = address;
    }
    @Override
    public String toString() {
        return "HomeBean [id=" + id + ", address=" + address + "]";
    }
}
```

- LockBean.java

```java
package com.code.bean;

import java.util.ArrayList;
import java.util.List;
public class LockBean {
    private int id;
    private String type;
    /**
    * lockè¡¨ä¸­æœ‰ä¸€ä¸ªfk_home_idå­—æ®µ,
    * æ‰€ä»¥åœ¨lockä¸­å®šä¹‰ä¸€ä¸ªmyHomeå±æ€§,
    * ç”¨æ¥ç»´æŠ¤2ä¸ªè¡¨ä¹‹é—´ä¸€å¯¹ä¸€å…³ç³»
    * é€šè¿‡è¿™ä¸ªå±æ€§å°±å¯ä»¥çŸ¥é“è¿™æŠŠé”æ­»å“ªå®¶çš„
    */
    private HomeBean myHome;
    public int getId() {
        return id;
    }
    public void setId(int id) {
        this.id = id;
    }
    public String getType() {
        return type;
    }
    public void setType(String type) {
        this.type = type;
    }
    public HomeBean getMyHome() {
        return myHome;
    }
    public void setMyHome(HomeBean myHome) {
        this.myHome = myHome;
    }
    @Override
    public String toString() {
        return "LockBean [id=" + id + ", type=" + type + ", myHome=" + myHome
                + ", keyLst=" + keyLst + "]";
    }
}
```

4.å®šä¹‰ sql æ˜ å°„æ–‡ä»¶ lockMapper.xml

```xml

<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.code.mapper.LockMapper">

    <!--
        æ ¹æ®lockidæŸ¥è¯¢homeä¿¡æ¯
        ##1. è¿è¡¨æŸ¥è¯¢
        select * from t_lock l,t_home h where l.fk_home_id=h.home_id and l.lock_id=1;
        ##2. æ‰§è¡Œä¸¤æ¬¡æŸ¥è¯¢
        select fk_home_id from t_lock where lock_id=1;
        select * from t_home where home_id=(ä¸Šä¸€æ¬¡çš„ç»“æœ);
    -->

    <!--
        æ–¹å¼ä¸€:åµŒå¥—æŸ¥è¯¢:ä½¿ç”¨åµŒå¥—ç»“æœæ˜ å°„æ¥å¤„ç†é‡å¤çš„è”åˆç»“æœçš„å­é›†
                å°è£…è”è¡¨æŸ¥è¯¢çš„æ•°æ®(å»é™¤é‡å¤çš„æ•°æ®)
    -->
    <resultMap id="lockMapWithHome1" type="LockBean">
        <id property="id" column="lock_id" javaType="int"/>
        <result property="type" column="f_type" javaType="string"/>
        <association  property="myHome"  javaType="HomeBean" >
            <id property="id" column="home_id"/>
            <result property="address" column="f_address"/>
        </association>
    </resultMap>

    <select id="getHomeByLock" resultMap="lockMapWithHome1">
        select * from t_lock l,t_home h where l.fk_home_id=h.home_id and l.lock_id=#{id};
    </select>

    <!--  æ–¹å¼äºŒï¼šåµŒå¥—æŸ¥è¯¢ï¼šé€šè¿‡æ‰§è¡Œå¦å¤–ä¸€ä¸ªSQLæ˜ å°„è¯­å¥æ¥è¿”å›é¢„æœŸçš„å¤æ‚ç±»å‹
        select fk_home_id from t_lock where lock_id=1;
        select * from t_home where home_id=(ä¸Šä¸€æ¬¡çš„ç»“æœ);
    -->
    <resultMap id="lockMapWithHome2" type="LockBean">
        <id property="id" column="lock_id" javaType="int"/>
        <result property="type" column="f_type" javaType="string"/>
        <association  property="myHome" column="fk_home_id" javaType="HomeBean" select="getHomeByLock"/>
    </resultMap>

    <select id="getHomeByLock" resultMap="com.code.mapper.HomeMapper.homeMap">
        select * from t_home where home_id = #{0}
    </select>
</mapper>
```

db.propertiespe æ–‡ä»¶

```
jdbc.driver=com.mysql.jdbc.Driver
jdbc.url=jdbc:mysql://localhost:3306/mybatis?useUnicode=true&characterEncoding=UTF-8
jdbc.username=code
jdbc.password=8998
```

mybatis-config.xml é…ç½®

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration PUBLIC "-//mybatis.org/DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd" >

<configuration>
    <!--ä½¿ç”¨æ•°æ®åº“è¿æ¥é…ç½®æ–‡ä»¶-->
    <properties resource="datasource.properties"/>

    <!--è‡ªåŠ¨æ‰«æåŒ…,ç”¨ç±»ååšåˆ«å-->
    <typeAliases>
        <package name="com.code.bean1"/>
    </typeAliases>
    <!-- ç»™Beanå¯¹è±¡èµ·åˆ«å -->
    <!-- ä¸€ä¸ªä¸ªæŒ‡å®šåˆ«å-->
    <!--<typeAliases>-->
        <!--<typeAlias type="com.lovo.bean.UserBean" alias="UserBean"/>-->
    <!--</typeAliases>-->

    <!--é…ç½®JDBCç¯å¢ƒ-->
    <environments default="development">
        <environment id="development">
            <!-- type="JDBC" ä»£è¡¨ç›´æ¥ä½¿ç”¨JDBCçš„æäº¤å›æ»šæ¥åšäº‹åŠ¡ -->
            <!-- type="MANAGED" ä»£è¡¨ä½¿ç”¨å¤–éƒ¨å®¹å™¨ï¼ˆSpringï¼‰æ“ä½œäº‹åŠ¡ -->
            <transactionManager type="JDBC"/>
            <dataSource type="POOLED">
                <property name="driver" value="${jdbc.driver}"/>
                <property name="url" value="${jdbc.url}"/>
                <property name="username" value="${jdbc.username}"/>
                <property name="password" value="${jdbc.password}"/>
            </dataSource>
        </environment>
    </environments>

    <!--å‘ŠçŸ¥æ˜ å°„æ–‡ä»¶-->
    <mappers>
        <package name="com/code/mapper"/>
    </mappers>
    <!-- å‘ŠçŸ¥Mapperæ–‡ä»¶çš„å­˜åœ¨ -->
    <!--
        ä¸€å„ä¸ªå‘ŠçŸ¥æ˜ å°„æ–‡ä»¶
        <mappers>
            <mapper resource="com/lovo/mapper/UserMapper.xml"/>
        </mappers>
    -->
</configuration>
```

DBUtil.java è·Ÿä»¥å‰çš„ä¸€æ ·

5.MyBatis ä¸€å¯¹ä¸€å…³è”æŸ¥è¯¢æ€»ç»“  
MyBatis ä¸­ä½¿ç”¨ association æ ‡ç­¾æ¥è§£å†³ä¸€å¯¹ä¸€çš„å…³è”æŸ¥è¯¢ï¼Œassociation æ ‡ç­¾å¯ç”¨çš„å±æ€§å¦‚ä¸‹ï¼š

    * property:å¯¹è±¡å±æ€§çš„åç§°
    * javaType:å¯¹è±¡å±æ€§çš„ç±»å‹
    * column:æ‰€å¯¹åº”çš„å¤–é”®å­—æ®µåç§°
    * select:ä½¿ç”¨å¦ä¸€ä¸ªæŸ¥è¯¢å°è£…çš„ç»“æœ

## ä¸€å¯¹ä¸€åŒå‘å…³è”å…³ç³»

åªéœ€è¦åœ¨ home ä¸­é¡µè®¾ç½®ä¸€ä¸ª lockBean çš„å±æ€§å³å¯  
é€šè¿‡ homeid æ‰¾åˆ° lock è·Ÿé€šè¿‡ lockid æ‰¾ home çš„é…ç½®ç›¸åŒ

## ä¸€å¯¹å¤šå…³è”å…³ç³»

ä¸€ä¸ª lock å¯ä»¥æœ‰å¤šæŠŠé’¥åŒ™  
ä¹Ÿæœ‰ 2 ä¸­é…ç½®æ–¹å¼  
åªéœ€è¦å°† association æ¢æˆ collection

```xml
<resultMap  id="lockMapWithKey" type="LockBean">
  		<id property="id" column="lock_id" javaType="int"/>
  		<result property="type" column="f_type" javaType="java.lang.String"/>
  		<collection property="keyLst" ofType="KeyBean" column="lock_id" select="getAllKeyByLock">
  		</collection>
  	</resultMap>
```

7.MyBatis ä¸€å¯¹å¤šå…³è”æŸ¥è¯¢æ€»ç»“  
MyBatis ä¸­ä½¿ç”¨ collection æ ‡ç­¾æ¥è§£å†³ä¸€å¯¹å¤šçš„å…³è”æŸ¥è¯¢ï¼ŒofType å±æ€§æŒ‡å®šé›†åˆä¸­å…ƒç´ çš„å¯¹è±¡ç±»å‹ã€‚

## ç»§æ‰¿å…³è”å…³ç³»

ä½¿ç”¨ discriminator

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.code.mapper.PetMapper">

   <resultMap type="com.code.bean.PetBean" id="petMap">
		<id property="id" column="pet_id" javaType="int" />
		<result property="name" column="f_name" javaType="java.lang.String" />
		<discriminator javaType="java.lang.String" column="f_type">
		 <case value="dog" resultType="com.code.bean.DogBean">
		  <result property="boneNumber" column="f_boneNumber" javaType="int"/>
		 </case>
		<case value="cat" resultType="com.code.bean.CatBean">
		 <result property="fishNumber" column="f_fishNumber" javaType="int"/>
		 <result property="mouseNumber" column="f_mouseNumber" javaType="int"/>
		</case>

		<case value="duck" resultType="com.code.bean.DuckBean">
		 <result property="fishNumber" column="f_fishNumber" javaType="int"/>
		</case>
		</discriminator>
	</resultMap>


	<select id="getPetById" parameterType="int" resultMap="petMap">
	  select * from t_pet where pet_id=#{petId}
	</select>

	<select id="getAllPet" resultMap="petMap">
	 select * from t_pet
	</select>
</mapper>

```

## [MyBatis CRUDæ“ä½œæŒ‡å—](https://blog.dong4j.site/posts/68dfa52e.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

ä¸Šä¸€èŠ‚ä¸­å¯¹ Mybatis çš„åŸºæœ¬æ“ä½œæœ‰äº†åˆæ­¥çš„äº†è§£,  
è¿™ä¸€èŠ‚ä¸­å°†ä½¿ç”¨ Mybatis å¯¹æ•°æ®è¡¨è¿›è¡Œç®€å•çš„ CRUD æ“ä½œ.  
ä½¿ç”¨çš„æµ‹è¯•ç¯å¢ƒå’Œä¸Šä¸€ç¯‡åšå®¢ä¸€æ ·.

## ä½¿ç”¨ Mybatis å¯¹è¡¨æ‰§è¡Œ CRUD æ“ä½œ -- åŸºäº XML å®ç°

1.å®šä¹‰ UserMapper.java

```java
package com.code.mapper;
import com.code.bean.UserBean;
import org.apache.ibatis.annotations.Param;
import java.util.List;

public interface UserMapper {
    //æ ¹æ®IDæŸ¥æ‰¾ç”¨æˆ·
    UserBean getUserById(@Param("userID")int userID);
    //æ·»åŠ ç”¨æˆ·
    int addUser(@Param("userBean")UserBean userBean);
    //åˆ é™¤ç”¨æˆ·
    int deleteUser(@Param("userID")int userID);
    //ä¿®æ”¹ç”¨æˆ·
    int updateUser(@Param("userBean")UserBean userBean);
    //æŸ¥è¯¢å…¨éƒ¨ç”¨æˆ·
    List<UserBean> getAllUsers();
    //æŸ¥è¯¢å…¨éƒ¨ç”¨æˆ·,æ¨¡ç³ŠæŸ¥è¯¢
    List<UserBean> getAllUsersLikeName(@Param("name")String name);
}
```

2.å®šä¹‰ sql æ˜ å°„æ–‡ä»¶  
userMapper.xml æ–‡ä»¶å†…å®¹å¦‚ä¸‹:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<!--
    ä¸ºè¿™ä¸ªmapperæŒ‡å®šä¸€ä¸ªå”¯ä¸€çš„namespaceï¼Œ
    è¿™æ ·å°±èƒ½å¤Ÿä¿è¯namespaceçš„å€¼æ˜¯å”¯ä¸€çš„
-->
<mapper namespace="com.code.mapper.UserMapper">
    <!--
        è¿™é‡Œæ˜¯å½“æ•°æ®è¡¨å­—æ®µåå’Œå®ä½“ç±»å±æ€§åä¸ä¸€è‡´æ—¶å°†ä»–ä»¬ä¸€ä¸€å¯¹åº”
    -->
    <resultMap id="userBean" type="UserBean">
        <id property="id" column="user_id" javaType="int"/>
        <result property="name" column="f_name" javaType="string"/>
        <result property="age" column="f_age" javaType="int"/>
    </resultMap>

    <!--æŒ‰idæŸ¥æ‰¾ç”¨æˆ·-->
    <select id="getUserById" resultMap="userBean" parameterType="int">
        select * from t_user where user_id = #{userID}
    </select>

    <!--æ·»åŠ ç”¨æˆ·-->
    <!--
        å½“ä¸ºå‚æ•°è®¾ç½®åˆ«åæ—¶(userBean),ä½¿ç”¨ åˆ«å.å±æ€§å æ¥å–å€¼;
        å¦‚æœä¼ å…¥çš„å‚æ•°æ˜¯ä¸€ä¸ªBeanå¯¹è±¡æˆ–è€…Mapå¯¹è±¡,å¯ä»¥ä¸ç”¨è®¾ç½®åˆ«å,
        è‡ªåŠ¨æ ¹æ®å±æ€§åå–å€¼
    -->
    <insert id="addUser" parameterType="UserBean" keyProperty="userBean.id" useGeneratedKeys="true">
        insert into t_user values(null,#{userBean.name},#{userBean.age})
    </insert>
    <!--åˆ é™¤ç”¨æˆ·-->
    <delete id="deleteUser">
        delete from t_user where user_id = #{userID}
    </delete>
    <!--ä¿®æ”¹ç”¨æˆ·-->
    <update id="updateUser">
        update t_user set f_name = #{userBean.name},f_age = #{userBean.age} where user_id=#{userBean.id}
    </update>
    <!--æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·-->
    <select id="getAllUsers" resultMap="userBean">
        select * from t_user
    </select>
    <select id="getAllUsersLikeName" resultMap="userBean">
        select * from t_user where f_name like '%${name}%'
    </select>
</mapper>
```

3.æµ‹è¯•ç±»

```java
package com.code.test;

import com.code.bean.UserBean;
import com.code.mapper.UserMapper;
import com.code.util.DBUtil;
import org.apache.ibatis.session.SqlSession;
import org.junit.Test;
import java.util.List;

public class Test2 {
    @Test
    public void addUserTest() {
        SqlSession sqlSession = DBUtil.getSession();
        UserMapper userMapper = sqlSession.getMapper(UserMapper.class);
        UserBean   newUser    = new UserBean("å¼ ä¸‰", 26);
        System.out.println(userMapper.addUser(newUser));
        //æ‰‹åŠ¨æäº¤äº‹ç‰©
        sqlSession.commit();
        System.out.println(newUser.getId());
        //å…³é—­session
        sqlSession.close();
    }

    @Test
    public void delUserTest() {
        SqlSession sqlSession = DBUtil.getSession();
        UserMapper userMapper = sqlSession.getMapper(UserMapper.class);
        System.out.println(userMapper.deleteUser(2));
        sqlSession.commit();
        sqlSession.close();
    }

    @Test
    public void updateUserTest() {
        SqlSession sqlSession = DBUtil.getSession();
        UserMapper userMapper = sqlSession.getMapper(UserMapper.class);
        UserBean   updateUser = new UserBean(1, "æå››", 25);
        System.out.println(userMapper.updateUser(updateUser));
        ;
        sqlSession.commit();
        sqlSession.close();
    }

    @Test
    public void getAllUsersTest() {
        SqlSession     sqlSession = DBUtil.getSession();
        UserMapper     userMapper = sqlSession.getMapper(UserMapper.class);
        List<UserBean> allUsers   = userMapper.getAllUsers();
        System.out.println(allUsers);
    }

    @Test
    public void getAllUsersLikeNameTest() {
        SqlSession     sqlSession = DBUtil.getSession();
        UserMapper     userMapper = sqlSession.getMapper(UserMapper.class);
        List<UserBean> allUsers   = userMapper.getAllUsersLikeName("c");
        System.out.println(allUsers);
    }
}

```

## ä½¿ç”¨ Mybatis å¯¹è¡¨æ‰§è¡Œ CRUD æ“ä½œ -- åŸºäº Annotation å®ç°

1.UserMapper.java

```java
package com.code.mapper;
/**
 * @author Code.Ai (Email: Code.Ai@outlook.com)
 * @link http://blog.csdn.net/codeai
 * @date 2015/11/19
 * @version 0.1
 * @describe ç”¨äºæ“ä½œæ•°æ®åº“çš„æ¥å£
 */

import com.code.bean.UserBean;
import org.apache.ibatis.annotations.*;

import java.util.List;

/**
 * éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæˆ‘ä»¬ä¸éœ€è¦é’ˆå¯¹UserMapperIæ¥å£å»ç¼–å†™å…·ä½“çš„å®ç°ç±»ä»£ç ï¼Œ
 * è¿™ä¸ªå…·ä½“çš„å®ç°ç±»ç”±MyBatiså¸®æˆ‘ä»¬åŠ¨æ€æ„å»ºå‡ºæ¥ï¼Œæˆ‘ä»¬åªéœ€è¦ç›´æ¥æ‹¿æ¥ä½¿ç”¨å³å¯ã€‚
 */

public interface UserMapper {
    //æ ¹æ®IDæŸ¥æ‰¾ç”¨æˆ·
    @Select("select * from t_user where user_id = #{userID}")
    UserBean getUserById(@Param("userID") int userID);
    //æ·»åŠ ç”¨æˆ·
    @Insert("insert into t_user values(null,#{userBean.name},#{userBean.age})")
    int addUser(@Param("userBean") UserBean userBean);
    //åˆ é™¤ç”¨æˆ·
    @Delete(" delete from t_user where user_id = #{userID}")
    int deleteUser(@Param("userID") int userID);
    //ä¿®æ”¹ç”¨æˆ·
    @Update(" update t_user set f_name = #{userBean.name},f_age = #{userBean.age} where user_id=#{userBean.id}")
    int updateUser(@Param("userBean") UserBean userBean);
    //æŸ¥è¯¢å…¨éƒ¨ç”¨æˆ·
    @Select("select * from t_user")
    List<UserBean> getAllUsers();
    //æŸ¥è¯¢å…¨éƒ¨ç”¨æˆ·,æ¨¡ç³ŠæŸ¥è¯¢
    @Select("select * from t_user where f_name like '%${name}%'")
    List<UserBean> getAllUsersLikeName(@Param("name") String name);
}
```

## å°†æ•°æ®åº“è¿æ¥é…ç½®ä¿¡æ¯å†™å…¥åˆ° properties æ–‡ä»¶ä¸­

1.db.properties

```
driver=com.mysql.jdbc.Driver
url=jdbc:mysql://localhost:3306/mybatis
name=code
password=8998
```

2.åœ¨ mybatis ä¸­å¼•å…¥ db.properties æ–‡ä»¶

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <!-- Continue going here -->
    <environments default="development">
        <environment id="development">
            <transactionManager type="JDBC"/>
            <dataSource type="POOLED">
                <property name="driver" value="${driver}"/>
                <property name="url" value="${url}"/>
                <property name="username" value="${name}"/>
                <property name="password" value="${password}"/>
            </dataSource>
        </environment>
    </environments>
</configuration>
```

## ä¸ºå®ä½“ç±»å®šä¹‰åˆ«å,ç®€åŒ– sql æ˜ å°„æ–‡ä»¶çš„å¼•ç”¨

ä¹‹å‰å·²ç»é…ç½®è¿‡  
1.åœ¨ mybatis-config.xml æ–‡ä»¶ä¸­é…ç½®å¦‚ä¸‹

```xml
<typeAliases>
    <typeAlias type="com.code.bean.UserBean" alias="UserBean"/>
</typeAliases>
```

2.ç¬¬äºŒç§æ–¹å¼:

```xml
<!-- é…ç½®å®ä½“ç±»çš„åˆ«åï¼Œé…ç½®å®ä½“ç±»åˆ«åçš„ç›®çš„æ˜¯ä¸ºäº†åœ¨å¼•ç”¨å®ä½“ç±»æ—¶å¯ä»¥ä½¿ç”¨å®ä½“ç±»çš„åˆ«åæ¥ä»£æ›¿å®ä½“ç±»ï¼Œè¾¾åˆ°ç®€å†™çš„ç›®çš„ -->
    <typeAliases>
        <!-- ä¸ºcom.code.beanåŒ…ä¸‹çš„æ‰€æœ‰å®ä½“ç±»é…ç½®åˆ«åï¼ŒMyBatisé»˜è®¤çš„è®¾ç½®åˆ«åçš„æ–¹å¼å°±æ˜¯å»é™¤ç±»æ‰€åœ¨çš„åŒ…åçš„ç®€å•çš„ç±»åæ¯”å¦‚com.code.bean.UserBeanè¿™ä¸ªå®ä½“ç±»çš„åˆ«åå°±ä¼šè¢«è®¾ç½®æˆUserBean
         -->
        <package name="com.code.bean"/>
    </typeAliases>
```

## è§£å†³å­—æ®µåå’Œå®ä½“ç±»å±æ€§åä¸ç›¸åŒé€ æˆæŸ¥è¯¢ä¸åˆ°ç»“æœ

è§£å†³åŠæ³•ä¸€:  
é€šè¿‡åœ¨æŸ¥è¯¢çš„ sql è¯­å¥ä¸­å®šä¹‰å­—æ®µåçš„åˆ«åï¼Œè®©å­—æ®µåçš„åˆ«åå’Œå®ä½“ç±»çš„å±æ€§åä¸€è‡´ï¼Œè¿™æ ·å°±å¯ä»¥è¡¨çš„å­—æ®µåå’Œå®ä½“ç±»çš„å±æ€§åä¸€ä¸€å¯¹åº”ä¸Šäº†ï¼Œè¿™ç§æ–¹å¼æ˜¯é€šè¿‡åœ¨ sql è¯­å¥ä¸­å®šä¹‰åˆ«åæ¥è§£å†³å­—æ®µåå’Œå±æ€§åçš„æ˜ å°„å…³ç³»çš„ã€‚

```sql
select user_id id,f_name name, f_age age from t_user where user_id=#{userID}
```

è§£å†³åŠæ³•äºŒ:  
é€šè¿‡<resultMap>æ¥æ˜ å°„å­—æ®µåå’Œå®ä½“ç±»å±æ€§åçš„ä¸€ä¸€å¯¹åº”å…³ç³»ã€‚è¿™ç§æ–¹å¼æ˜¯ä½¿ç”¨ MyBatis æä¾›çš„è§£å†³æ–¹å¼æ¥è§£å†³å­—æ®µåå’Œå±æ€§åçš„æ˜ å°„å…³ç³»çš„ã€‚

```xml
<resultMap id="userBean" type="UserBean">
        <id property="id" column="user_id" javaType="int"/>
        <result property="name" column="f_name" javaType="string"/>
        <result property="age" column="f_age" javaType="int"/>
    </resultMap>
```

## [MyBatis å…¥é—¨å¿…å¤‡ï¼šå¦‚ä½•é…ç½®å’Œè¿è¡Œç¬¬ä¸€ä¸ªç¨‹åº](https://blog.dong4j.site/posts/535f8b87.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

MyBatis æœ¬æ˜¯ apache çš„ä¸€ä¸ªå¼€æºé¡¹ç›® iBatis, 2010 å¹´è¿™ä¸ªé¡¹ç›®ç”± apache software foundation è¿ç§»åˆ°äº† google codeï¼Œå¹¶ä¸”æ”¹åä¸º MyBatis ã€‚2013 å¹´ 11 æœˆè¿ç§»åˆ° Githubã€‚

iBATIS ä¸€è¯æ¥æºäºâ€œinternetâ€å’Œâ€œabatisâ€çš„ç»„åˆï¼Œæ˜¯ä¸€ä¸ªåŸºäº Java çš„æŒä¹…å±‚æ¡†æ¶ã€‚iBATIS æä¾›çš„æŒä¹…å±‚æ¡†æ¶åŒ…æ‹¬ SQL Maps å’Œ Data Access Objectsï¼ˆDAOï¼‰

MyBatis æ˜¯ä¸€ä¸ªæ”¯æŒæ™®é€š SQL æŸ¥è¯¢ï¼Œå­˜å‚¨è¿‡ç¨‹å’Œé«˜çº§æ˜ å°„çš„ä¼˜ç§€æŒä¹…å±‚æ¡†æ¶ã€‚MyBatis æ¶ˆé™¤äº†å‡ ä¹æ‰€æœ‰çš„ JDBC ä»£ç å’Œå‚æ•°çš„æ‰‹å·¥è®¾ç½®ä»¥åŠå¯¹ç»“æœé›†çš„æ£€ç´¢å°è£…ã€‚MyBatis å¯ä»¥ä½¿ç”¨ç®€å•çš„ XML æˆ–æ³¨è§£ç”¨äºé…ç½®å’ŒåŸå§‹æ˜ å°„ï¼Œå°†æ¥å£å’Œ Java çš„ POJOï¼ˆPlain Old Java Objectsï¼Œæ™®é€šçš„ Java å¯¹è±¡ï¼‰æ˜ å°„æˆæ•°æ®åº“ä¸­çš„è®°å½•ã€‚

## Mybatis å¿«é€Ÿå…¥é—¨

### å‡†å¤‡å¼€å‘ç¯å¢ƒ

1. åˆ›å»ºæµ‹è¯•é¡¹ç›®,æ™®é€šçš„ Java é¡¹ç›®æˆ–è€… JavaWeb é¡¹ç›®å‡å¯
2. æ·»åŠ ç›¸åº”çš„ jar åŒ…

   - Mybatis æ ¸å¿ƒåŒ… mybatis-3.30.jar
   - æ•°æ®åº“é©±åŠ¨ mysql-connector-5.1.19-bin.jar

3. åˆ›å»ºæ•°æ®åº“å’Œè¡¨

```sql
create table `t_user` (
  `user_id` int(11) not null auto_increment,
  `f_name` varchar(255) default null,
  `f_age` int(11) default null,
  primary key (`user_id`)
) engine=InnoDB default charset=utf-8
insert into  t_user(f_name,f_age) values('CODE',26);
insert into  t_user(f_name,f_age) values('array',26);
```

### ä½¿ç”¨ Mybatis æŸ¥è¯¢è¡¨ä¸­æ•°æ®

1. æ·»åŠ  Mybatis é…ç½®æ–‡ä»¶ mybatis-config.xml

```sql
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <!-- Continue going here -->
    <!--ç»™Beanèµ·åˆ«å,å°±ä¸ç”¨æ¯æ¬¡éƒ½è¦å†™ä¸€é•¿ä¸²çš„å…¨ç±»åäº†-->
    <typeAliases>
        <typeAlias type="com.code.bean.UserBean" alias="UserBean"/>
    </typeAliases>
    <environments default="development">
        <environment id="development">
            <transactionManager type="JDBC"/>
            <dataSource type="POOLED">
                <property name="driver" value="com.mysql.jdbc.Driver"/>
                <property name="url" value="jdbc:mysql://localhost:3306/mybatis"/>
                <property name="username" value="code"/>
                <property name="password" value="8998"/>
            </dataSource>
        </environment>
    </environments>

</configuration>
```

2. å»ºç«‹å®ä½“ Bean

```java
package com.code.bean;
public class UserBean {
    private int id;
    private String name;
    private int age;
    public UserBean() {
    }
    public UserBean(String name, int age) {
        this.name = name;
        this.age = age;
    }
    public UserBean(int id, String name, int age) {
        this.id = id;
        this.name = name;
        this.age = age;
    }
    public int getId() {
        return id;
    }
    public void setId(int id) {
        this.id = id;
    }
    public String getName() {
        return name;
    }
    public void setName(String name) {
        this.name = name;
    }
    public int getAge() {
        return age;
    }
    public void setAge(int age) {
        this.age = age;
    }
    @Override
    public String toString() {
        return "UserBean{" +
                "id=" + id +
                ", name='" + name + '\'' +
                ", age=" + age +
                '}';
    }
}
```

3. å»ºç«‹æ“ä½œæ•°æ®è¡¨çš„ sql æ˜ å°„æ–‡ä»¶ userMapper.xml

- åˆ›å»ºä¸€ä¸ªåŒ… com.code.mapper,ç”¨æ¥æ”¾æ˜ å°„æ–‡ä»¶å’Œ xxxMapper.java
- UserMapper.java

```java
package com.code.mapper;
import com.code.bean.UserBean;
import org.apache.ibatis.annotations.Param;
public interface UserMapper {
	   //@Paramä¸ºå‚æ•°è®¾ç½®åˆ«å,åœ¨selectè¯­å¥çš„å°±ç”¨å†™ #{0} äº†,è€Œæ˜¯ #{userID}
	   UserBean getUserById(@Param("userID")int userID);
}
```

- userMapper.xml é…ç½®

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<!--
    ä¸ºè¿™ä¸ªmapperæŒ‡å®šä¸€ä¸ªå”¯ä¸€çš„namespaceï¼Œ
    è¿™æ ·å°±èƒ½å¤Ÿä¿è¯namespaceçš„å€¼æ˜¯å”¯ä¸€çš„
-->
<mapper namespace="com.code.mapper.UserMapper">
    <!--
        è¿™é‡Œæ˜¯å½“æ•°æ®è¡¨å­—æ®µåå’Œå®ä½“ç±»å±æ€§åä¸ä¸€è‡´æ—¶å°†ä»–ä»¬ä¸€ä¸€å¯¹åº”
    -->
    <resultMap id="userBean" type="UserBean">
        <id property="id" column="user_id" javaType="int"/>
        <result property="name" column="f_name" javaType="string"/>
        <result property="age" column="f_age" javaType="int"/>
    </resultMap>
    <!--
         æ ¹æ®idæŸ¥è¯¢å¾—åˆ°ä¸€ä¸ªuserå¯¹è±¡
     -->
    <!--
         åœ¨selectæ ‡ç­¾ä¸­ç¼–å†™æŸ¥è¯¢çš„SQLè¯­å¥ï¼Œ è®¾ç½®selectæ ‡ç­¾çš„idå±æ€§ä¸ºgetUserï¼Œidå±æ€§å€¼å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œä¸èƒ½å¤Ÿé‡å¤.
         è¿™é‡Œçš„idæ˜¯UserMapperæ¥å£ä¸­çš„æ–¹æ³•å
         ä½¿ç”¨parameterTypeå±æ€§æŒ‡æ˜æŸ¥è¯¢æ—¶ä½¿ç”¨çš„å‚æ•°ç±»å‹ï¼ŒresultTypeå±æ€§æŒ‡æ˜æŸ¥è¯¢è¿”å›çš„ç»“æœé›†ç±»å‹
         resultType="com.code.bean.UserBean"å°±è¡¨ç¤ºå°†æŸ¥è¯¢ç»“æœå°è£…æˆä¸€ä¸ªUserBeanç±»çš„å¯¹è±¡è¿”å›
         å¦‚æœå®ä½“ç±»å±æ€§å’Œæ•°æ®è¡¨å­—æ®µåå­—ä¸ç›¸åŒ,åˆ™é€šè¿‡resultMapæŒ‡å®š
    -->
    <select id="getUserById" resultMap="userBean" parameterType="int">
        select * from t_user where user_id = #{userID}
    </select>
</mapper>
```

4. åœ¨é…ç½®æ–‡ä»¶ä¸­æ³¨å†Œæ˜ å°„æ–‡ä»¶

- åœ¨ mybaits-config.xml æ–‡ä»¶ä¸­æ·»åŠ 

```xml
<mappers>
        <!--
            æ³¨å†ŒuserMapper.xmlæ–‡ä»¶ï¼Œ
            userMapper.xmlä½äºcom.code.mapperè¿™ä¸ªåŒ…ä¸‹ï¼Œ
            æ‰€ä»¥resourceå†™æˆcom/code/mapper/userMapper.xml
        -->
	<mapper resource="com/code/mapper/userMapper.xml"/>
</mappers>
```

5. æ–°å»ºä¸€ä¸ª DBUtil.java å·¥å…·ç±»,ä½äº com.code.util åŒ…ä¸‹

```java
package com.code.util;

import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;

import java.io.IOException;
import java.io.InputStream;

public class DBUtil {
    private static SqlSessionFactory sqlSessionFactory;

    //åˆå§‹åŒ–
    static {
        InputStream in = null;
        try {
            //åŠ è½½é…ç½®æ–‡ä»¶
            in = Resources.getResourceAsStream("mybatis-config.xml");
            //å¾—åˆ°sqlSessionFactoryå·¥å‚
            sqlSessionFactory = new SqlSessionFactoryBuilder().build(in);
        } catch (IOException e) {
            e.printStackTrace();
        } finally {
            try {
                if (in != null) {
                    in.close();
                }
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }

    public static SqlSession getSession() {
        //è¿”å›èƒ½æ‰§è¡Œæ˜ å°„æ–‡ä»¶ä¸­sqlçš„sqlSession
        return sqlSessionFactory.openSession();
    }
}

```

6. ç¼–å†™æµ‹è¯•ä»£ç ,æ‰§è¡Œ select æ“ä½œ

```java
package com.code.test;

import com.code.bean.UserBean;
import com.code.mapper.UserMapper;
import com.code.util.DBUtil;
import org.apache.ibatis.session.SqlSession;
import org.junit.Test;

public class Test1 {
    @Test
    public void testGetUserById(){
        SqlSession sqlSession = DBUtil.getSession();
        UserMapper userMapper =  sqlSession.getMapper(UserMapper.class);
        UserBean userBean = userMapper.getUserById(1);
        System.out.println(userBean);
    }
}
```

## [ä»é›¶å¼€å§‹ï¼šæ·±å…¥ç†è§£Hibernateæ¡†æ¶çš„å¥¥ç§˜](https://blog.dong4j.site/posts/f0fe1ae8.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

Hibernate æ¡†æ¶ä¸»è¦æ˜¯å®ç°æ•°æ®åº“ä¸å®ä½“ç±»é—´çš„æ˜ å°„ï¼Œä½¿çš„æ“ä½œå®ä½“ç±»ç›¸å½“ä¸æ“ä½œ hibernate æ¡†æ¶ã€‚  
 åªè¦å®ä½“ç±»å†™å¥½é…ç½®æ–‡ä»¶é…å¥½ï¼Œå°±èƒ½å®ç°å’Œæ•°æ®åº“çš„æ˜ å°„ï¼Œå…¶ä¸­å®ä½“ç±»å¯¹åº”è¡¨ï¼Œç±»çš„å±æ€§å¯¹åº”æ•°æ®åº“çš„è¡¨å­—æ®µã€‚ è¿™æ ·å°±ä¸ç”¨ç®¡æ•°æ®åº“çš„ç›¸å…³æ“ä½œäº†ã€‚

## ä»€ä¹ˆæ˜¯ Hibernate

å¦‚ä»Š,å¤§å¤šæ•°æ˜¯å…³ç³»å‹æ•°æ®åº“,è€Œ Java æ˜¯é¢å‘å¯¹è±¡çš„ç¼–ç¨‹è¯­è¨€,ä½¿ç”¨é¢å‘å¯¹è±¡çš„è¯­è¨€ç»“åˆå…³ç³»å‹æ•°æ®åº“ç›¸å½“éº»çƒ¦,æ‰€ä»¥æœ‰äº† Hibernate  
Hibernate å°†å¯¹è±¡æ¨¡å‹å’ŒåŸºäº sql çš„å…³ç³»æ¨¡å‹æ˜ å°„èµ·æ¥,ä½¿å¾—å¼€å‘è€…å¯ä»¥é‡‡ç”¨é¢å‘å¯¹è±¡çš„æ–¹å¼å¼€å‘ç¨‹åº.  
Hibernate æ˜¯å…³ç³»å‹æ•°æ®åº“å’Œé¢å‘å¯¹è±¡çš„ç¨‹åºè®¾è®¡è¯­è¨€ä¹‹é—´çš„æ¡¥æ¢,å®ƒå…è®¸å¼€å‘è€…ä½¿ç”¨é¢å‘å¯¹è±¡çš„è¯­è¨€æ“ä½œå…³ç³»å‹æ•°æ®åº“  
ä»¥å‰æ˜¯åº”ç”¨ç¨‹åºç›´æ¥è®¿é—®åº•å±‚æ•°æ®åº“,è€Œé‡‡ç”¨ ORM æ¡†æ¶ä¹‹å,åº”ç”¨ç¨‹åºä»¥é¢å‘å¯¹è±¡çš„æ–¹å¼æ“ä½œæŒä¹…åŒ–å¯¹è±¡,è€Œ ORM æ¡†æ¶åˆ™å°†è¿™äº›é¢å‘å¯¹è±¡çš„æ“ä½œè½¬æ¢ä¸ºåº•å±‚çš„ SQL æ“ä½œ.

## Hibernate å’Œ JDBC

1. jdbc çš„ä¼˜ç‚¹å’Œç¼ºç‚¹

   - ç¼ºç‚¹
     - æŸ¥è¯¢ä»£ç ç‰¹åˆ«ç¹ç
     - é‡å¤æ€§ä»£ç ç‰¹åˆ«å¤šï¼Œé¢‘ç¹çš„ try,catch
     - æ•°æ®çš„ç¼“å­˜
     - sql çš„ç§»æ¤æ€§ä¸å¥½
   - ä¼˜ç‚¹
     - é€Ÿåº¦æ¯”è¾ƒå¿«
     - æŠŠæ§æ€§æ¯”è¾ƒå¥½

2. ormapping æ¡†æ¶ï¼šæ•°æ®åº“çš„æ“ä½œæ¡†æ¶
   - ä¼˜ç‚¹
     - æ¯”è¾ƒç®€å•
     - æ•°æ®ç¼“å­˜ï¼šä¸€çº§ç¼“å­˜ äºŒçº§ç¼“å­˜ æŸ¥è¯¢ç¼“å­˜
     - ç§»æ¤æ€§æ¯”è¾ƒå¥½
   - ç¼ºç‚¹
     - å› ä¸º sql è¯­å¥æ˜¯ hibernate å†…éƒ¨ç”Ÿæˆçš„ï¼Œæ‰€ä»¥ç¨‹åºå‘˜å¹²é¢„ä¸äº†ï¼Œä¸å¯æ§
     - å¦‚æœæ•°æ®åº“ç‰¹åˆ«å¤§ï¼Œä¸é€‚åˆç”¨ hibernate

### .hbm.xml(æ˜ å°„æ–‡ä»¶)

ç±»ä¸è¡¨çš„å¯¹åº”å…³ç³»  
 ç±»ä¸Šçš„å±æ€§çš„åç§°å’Œè¡¨ä¸­çš„å­—æ®µçš„åç§°å¯¹åº”å…³ç³»  
 ç±»ä¸Šçš„å±æ€§çš„ç±»å‹å’Œè¡¨ä¸­çš„å­—æ®µçš„ç±»å‹å¯¹åº”å…³ç³»  
 æŠŠä¸€å¯¹å¤šå’Œå¤šå¯¹å¤šçš„å…³ç³»è½¬åŒ–æˆé¢å‘å¯¹è±¡çš„å…³ç³»

### Hibernate.cfg.xml(é…ç½®æ–‡ä»¶)

hibernate çš„é…ç½®æ–‡ä»¶ï¼š  
 ä½œç”¨æ˜¯ç”¨æ¥è¿æ¥æ•°æ®åº“çš„

## hibernate çš„ç»„æˆéƒ¨åˆ†

1. æŒä¹…åŒ–ç±»

- å®ç°å¯¹åº”çš„åºåˆ—åŒ–æ¥å£
- å¿…é¡»æœ‰é»˜è®¤çš„æ„é€ å‡½æ•°
- æŒä¹…åŒ–ç±»çš„å±æ€§ä¸èƒ½ä½¿ç”¨å…³é”®å­—

2. hibernate çš„æµç¨‹
   - Configuraction
     - åŠ è½½äº†é…ç½®æ–‡ä»¶
   - SessionFactory
     - é…ç½®æ–‡ä»¶çš„ä¿¡æ¯ã€æ˜ å°„æ–‡ä»¶çš„ä¿¡æ¯ã€æŒä¹…åŒ–ç±»çš„ä¿¡æ¯
   - Session  
      1ã€crud çš„æ“ä½œéƒ½æ˜¯ç”± session å®Œæˆçš„  
      2ã€äº‹åŠ¡æ˜¯ç”± session å¼€å¯çš„  
      3ã€ä¸¤ä¸ªä¸åŒçš„ session åªèƒ½ç”¨å„è‡ªçš„äº‹åŠ¡  
      4ã€session å†³å®šäº†å¯¹è±¡çš„çŠ¶æ€  
      5ã€åˆ›å»ºå®Œä¸€ä¸ª sessionï¼Œç›¸å½“äºæ‰“å¼€äº†ä¸€ä¸ªæ•°æ®åº“çš„é“¾æ¥
   - Transaction  
      1ã€äº‹åŠ¡é»˜è®¤ä¸æ˜¯è‡ªåŠ¨æäº¤çš„  
      2ã€å¿…é¡»ç”± session å¼€å¯  
      3ã€å¿…é¡»å’Œå½“å‰çš„ session ç»‘å®š (ä¸¤ä¸ª session ä¸å¯èƒ½å…±ç”¨ä¸€ä¸ªäº‹åŠ¡)
3. å¯¹è±¡çš„çŠ¶æ€çš„è½¬åŒ–
4. hibernate çš„åŸç†ï¼š  
    æ ¹æ®å®¢æˆ·ç«¯çš„ä»£ç ï¼Œå‚ç…§æ˜ å°„æ–‡ä»¶ï¼Œç”Ÿæˆ sql è¯­å¥ï¼Œåˆ©ç”¨ jdbc æŠ€æœ¯è¿›è¡Œæ•°æ®åº“çš„æ“ä½œ

## Hibernate æ ¸å¿ƒå¼€å‘æ¥å£

1. Configuration configure() configure(String é…ç½®æ–‡ä»¶è·¯å¾„)

   - è¯»å–é…ç½®æ–‡ä»¶
   - é€šè¿‡é…ç½®æ–‡ä»¶äº§ç”Ÿæ•°æ®åº“è¿æ¥
   - äº§ç”Ÿ SessionFactory

2. SessionFactory ç»´æŠ¤æ•°æ®åº“è¿æ¥æ± 

   - sessionFactory.opeSession()
     - å¾—åˆ°ä¸€ä¸ªæ–°çš„ session
   - sessionFactory.getCurrentSession()
     - å¦‚æœå½“å‰ç¯å¢ƒ (çº¿ç¨‹) ä¸­æœ‰ session,åˆ™ç›´æ¥ä½¿ç”¨,å¦åˆ™æ‰“å¼€ä¸€ä¸ªæ–°çš„ session
     - ä¸éœ€è¦å†™ session.close()
     - å½“ session.commit() ä¹‹å,session è‡ªåŠ¨å…³é—­
     - ç•Œå®šäº‹åŠ¡è¾¹ç•Œ
     - current-session_context_class(JTA thread )
       - thread ä½¿ç”¨ connection æœ¬èº«æ•°æ®åº“ä¸­
       - JTA(Java Transaction API) éœ€è¦ application service æ”¯æŒ
         - è·¨æœåŠ¡å™¨äº‹åŠ¡ç®¡ç†
         - åˆ†å¸ƒå¼äº‹åŠ¡ (è·¨æ•°æ®åº“äº‹åŠ¡,è·¨æœåŠ¡å™¨äº‹åŠ¡)

3. å¯¹è±¡çš„ä¸‰ç§çŠ¶æ€

   - ç¬æ—¶ (Transient)
     - new å‡ºæ¥æ—¶,å†…å­˜ä¸­æœ‰,ç¼“å­˜æ²¡æœ‰,æ•°æ®åº“æ²¡æœ‰ (id)
   - æŒä¹…åŒ– (persistent)
     - save() saveOrUpdate()
     - ç¼“å­˜æœ‰,æ•°æ®åº“æœ‰ (id)
   - æ‰˜ç®¡ (Detached)
     - evict()
     - close()
     - clear()
     - ç¼“å­˜æ²¡æœ‰ (å·²ç»è¢«é”€æ¯äº†),æ•°æ®åº“æœ‰ (id)

- åŒºåˆ«:
  - æœ‰æ²¡æœ‰ id transient
  - id æ˜¯å¦åœ¨æ•°æ®åº“ä¸­ persistens
  - æ˜¯å¦åœ¨å†…å­˜ä¸­ (Session ç¼“å­˜)

4. Session ç®¡ç†ä¸€ä¸ªæ•°æ®åº“çš„ä»»åŠ¡å•å…ƒ,æ‰§è¡Œ CRUD æ“ä½œ  
   Session ç¼“å­˜  
   session å¯¹è±¡ä¸­æœ‰ä¸€ä¸ª map  
   key æ˜¯ id,value æ˜¯æŒä¹…åŒ–å¯¹è±¡çš„å¼•ç”¨.  
    get å’Œ load çš„åŒºåˆ« - ä¸å­˜åœ¨å¯¹åº”è®°å½•æ—¶ get è¿”å› null - load æŠ¥å¼‚å¸¸ - load è¿”å›ä»£ç†å¯¹è±¡,ç­‰åˆ°çœŸæ­£è¦ä½¿ç”¨å¯¹è±¡çš„å†…å®¹æ—¶æ‰å‘å‡º sql è¯­å¥ - get ç›´æ¥ä»æ•°æ®åº“åŠ è½½,ä¸ä¼šå»¶è¿Ÿ - éƒ½ä¼šå…ˆåˆ°ç¼“å­˜ä¸­æŸ¥è¯¢,å¦‚æœæ²¡æœ‰æ‰è¿›æ•°æ®åº“æŸ¥

5. ä»£ç†æ¨¡å¼  
   javassist -->ç›´æ¥ç”ŸæˆäºŒè¿›åˆ¶ç   
   åŠ¨æ€æ”¹å˜ç±»çš„ç»“æ„ï¼Œæˆ–è€…åŠ¨æ€ç”Ÿæˆç±»ã€‚

ä¸ºä»€ä¹ˆé‚£ä¸ª id å¿…é¡»æ˜¯ serializable æ¥å£äº†

hibernate ä¸çŸ¥é“æˆ‘ä»¬æ ‡è¯†ç¬¦çš„ç±»å‹æ˜¯ä»€ä¹ˆ,æ‰€ä»¥ç”¨ä¸€ä¸ªæ¥å£ç±»å‹ä½œä¸ºä¸€ä¸ªå‚æ•°,åªè¦å®ç°äº† serializable çš„æ•°æ®ç±»å‹éƒ½å¯ä»¥ä½œä¸ºå‚æ•°ä¼ è¿›å…¥,ç„¶åä¸‹åˆæˆ‘é—®çš„æ˜¯ä¸ºä»€ä¹ˆæˆ‘çš„ç±»æ²¡æœ‰å®ç° serializable æ¥å£,ä¹Ÿèƒ½ä¼  id è¿›å»,è¿™è·Ÿç±»æ²¡å…³ç³»,åªè¦å‚æ•°æ˜¯ serializable çš„å®ç°å°±å¯ä»¥äº†,æ­£å¥½ç©¿çš„å‚æ•°æ˜¯ int,å®ƒè‡ªåŠ¨åŒ…è£…ä¸º Integer äº†,ç„¶å Integer å®ç°äº† serializable æ¥å£

update æ–¹æ³•

- ç”¨æ¥æ›´æ–° detached å¯¹è±¡,,æ›´æ–°å®Œæˆè½¬ä¸º persistent çŠ¶æ€
- æ›´æ–° transient å¯¹è±¡ä¼šæŠ¥é”™
- æ›´æ–°è‡ªå·±è®¾å®šçš„ id çš„ transient å¯¹è±¡å¯ä»¥ (å‰ææ˜¯æ•°æ®åº“æœ‰å¯¹åº”çš„æ•°æ®è®°å½•)
- æ›´æ–°éƒ¨åˆ†æ›´æ”¹çš„å­—æ®µ

  è§£å†³æ›´æ–°ä¸€ä¸ªå­—æ®µ,hibernate å…¶ä»–å­—æ®µä¹Ÿä¼šæ›´æ–°çš„é—®é¢˜

O/R Mapping -->å¯¹è±¡å…³ç³»æ˜ å°„  
å°†ç¨‹åºä¸­çš„ java å¯¹è±¡å’Œä½¿ç”¨çš„å…³ç³»å‹æ•°æ®åº“ä¸­çš„è¡¨å¯¹åº”  
ä½¿ç”¨å…ƒæ•°æ® (æè¿°æ•°æ®æ ¼å¼çš„æ•°æ®) æè¿°å¯¹è±¡å’Œæ•°æ®åº“é—´çš„æ˜ å°„

å¥½å¤„:

1. ç§»æ¤æ€§å¥½
2. ç®€å•
3. ä½¿ç”¨ç¼“å­˜æŠ€æœ¯

ä¸ºä»€ä¹ˆé›†åˆç±»å‹çš„å±æ€§åªèƒ½å®šä¹‰ä¸ºæ¥å£ç±»å‹  
Hibernate åº•å±‚æ²¡æœ‰ä½¿ç”¨ JCF æ¡†æ¶ä¸­çš„å®ç°ç±»,è€Œæ˜¯ä½¿ç”¨ Apache è‡ªå·±çš„é›†åˆå®ç°ç±»

å¿…é¡»æä¾›ä¸€ä¸ªæ ‡ç¤ºå±æ€§å’Œæ•°æ®è¡¨çš„ä¸»é”®å¯¹åº”  
å› ä¸º Hibernate æ˜¯é€šè¿‡ç”¨æ ‡è¯†ç¬¦å’Œè¡¨ä¸­çš„ä¸»é”®å¯¹åº”,ä»è€Œåˆ¤å®šæ˜¯è¡¨ä¸­çš„å“ªæ¡è®°å½•

get å’Œ load æ–¹æ³•åŒºåˆ«

1. å½“æŸ¥è¯¢ä¸€ä¸ªä¸å­˜åœ¨çš„å¯¹è±¡æ—¶,get æ–¹æ³•è¿”å› null,load ä¸è¿”å› null,è€Œæ˜¯ç›´æ¥æŠ›å‡º ObjectNotFound çš„å¼‚å¸¸
2. get æ–¹æ³•ä¸æ”¯æŒå»¶è¿ŸåŠ è½½;load æ”¯æŒ

## Hibernate å®ä½“å…³ç³»æ˜ å°„

1. one-to-one
   - å”¯ä¸€å¤–é”®å…³è”
   - ä¸»é”®å…³è”
2. one-to-maney
   - å•é¡¹å…³è”
   - åŒå‘å…³è”
3. maney-to-maney
4. ç»§æ‰¿

æ˜ å°„æ–‡ä»¶ä¸­ class æœ‰å‡ ä¸ªå…ƒç´ ä¾èµ–äºå±æ€§çš„ä¸ªæ•°  
è° to è°  
å‰é¢æ˜¯å½“å‰å¯¹è±¡.åé¢æ˜¯å…³è”å¯¹è±¡

cascade çº§è”æ“ä½œ  
å¯¹å½“å‰å¯¹è±¡çš„æ“ä½œä¹Ÿä¼šå‘ç”Ÿåœ¨å…³è”å¯¹è±¡ä¸Š

get æ–¹æ³•çš„æ€§èƒ½ä¼˜åŒ–  
å¯¹äºå¼•ç”¨å¯¹è±¡,hibernate é»˜è®¤æ˜¯å»¶è¿ŸåŠ è½½

## 1-N å•å‘å…³è”

ç”¨æˆ· ç”¨æˆ·åœ°å€ (å®¶åº­,å…¬å¸)  
1 ç«¯æœ‰ N ç«¯çš„é›†åˆå¯¹è±¡  
é€šè¿‡ 1 ç«¯æ‰¾ N ç«¯  
å¤–é”®åœ¨ N ç«¯

åœ¨ Hibernate ä¸­ï¼Œå„è¡¨çš„æ˜ å°„æ–‡ä»¶â€¦.hbm.xml å¯ä»¥é€šè¿‡å·¥å…·ç”Ÿæˆï¼Œä¾‹å¦‚åœ¨ä½¿ç”¨ MyEclipse å¼€å‘æ—¶ï¼Œå®ƒæä¾›äº†è‡ªåŠ¨ç”Ÿæˆæ˜ å°„æ–‡ä»¶çš„å·¥å…·ã€‚æœ¬èŠ‚ç®€å•çš„è®²è¿°ä¸€ä¸‹è¿™äº›é…ç½®æ–‡ä»¶çš„é…ç½®ã€‚

é…ç½®æ–‡ä»¶çš„åŸºæœ¬ç»“æ„å¦‚ä¸‹ï¼š

```xml
<?xml version="1.0" encoding='UTF-8'?>
<!DOCTYPE hibernate-mapping PUBLIC
"-//Hibernate/Hibernate Mapping DTD 3.0//EN"
"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd" >
<hibernate-mapping package="åŒ…å">
    <class name="ç±»å" table="è¡¨å">
        <id name="ä¸»é”®åœ¨javaç±»ä¸­çš„å­—æ®µå" column="å¯¹åº”è¡¨ä¸­å­—æ®µ" type="ç±»å‹ ">
            <generator class="ä¸»é”®ç”Ÿæˆç­–ç•¥"/>
        </id>
        <property name="å®ä½“beanå±æ€§å" type="å±æ€§ç±»å‹" column="å¯¹åº”å­—æ®µå"></property>
         â€¦â€¦
    </class>
</hibernate-mapping>
```

1.ä¸»é”®ï¼ˆidï¼‰  
 Hibernate çš„ä¸»é”®ç”Ÿæˆç­–ç•¥æœ‰å¦‚ä¸‹å‡ ç§ï¼š  
1)assigned  
 ä¸»é”®ç”±å¤–éƒ¨ç¨‹åºè´Ÿè´£ç”Ÿæˆï¼Œåœ¨ save() ä¹‹å‰å¿…é¡»æŒ‡å®šä¸€ä¸ªã€‚Hibernate ä¸è´Ÿè´£ç»´æŠ¤ä¸»é”®ç”Ÿæˆã€‚ä¸ Hibernate å’Œåº•å±‚æ•°æ®åº“éƒ½æ— å…³ï¼Œå¯ä»¥è·¨æ•°æ®åº“ã€‚åœ¨å­˜å‚¨å¯¹è±¡å‰ï¼Œå¿…é¡»è¦ä½¿ç”¨ä¸»é”®çš„ setter æ–¹æ³•ç»™ä¸»é”®èµ‹å€¼ï¼Œè‡³äºè¿™ä¸ªå€¼æ€ä¹ˆç”Ÿæˆï¼Œå®Œå…¨ç”±è‡ªå·±å†³å®šï¼Œè¿™ç§æ–¹æ³•åº”è¯¥å°½é‡é¿å…ã€‚

```xml
<id name="id" column="id">
    <generator class="assigned" />
</id>
```

â€œidâ€æ˜¯è‡ªå®šä¹‰çš„ç­–ç•¥åï¼Œäººä¸ºèµ·çš„åå­—ï¼Œåé¢å‡ç”¨â€œudâ€è¡¨ç¤ºã€‚  
ç‰¹ç‚¹ï¼šå¯ä»¥è·¨æ•°æ®åº“ï¼Œäººä¸ºæ§åˆ¶ä¸»é”®ç”Ÿæˆï¼Œåº”å°½é‡é¿å…ã€‚

2. hilo  
   hiloï¼ˆé«˜ä½ä½æ–¹å¼ high lowï¼‰æ˜¯ hibernate ä¸­æœ€å¸¸ç”¨çš„ä¸€ç§ç”Ÿæˆæ–¹å¼ï¼Œéœ€è¦ä¸€å¼ é¢å¤–çš„è¡¨ä¿å­˜ hi çš„å€¼ã€‚ä¿å­˜ hi å€¼çš„è¡¨è‡³å°‘æœ‰ä¸€æ¡è®°å½•ï¼ˆåªä¸ç¬¬ä¸€æ¡è®°å½•æœ‰å…³ï¼‰ï¼Œå¦åˆ™ä¼šå‡ºç°é”™è¯¯ã€‚å¯ä»¥è·¨æ•°æ®åº“ã€‚

```xml
<id name="id" column="id">
    <generator class="hilo">
        <param name="table">hibernate_hilo</param> æŒ‡å®šä¿å­˜hiå€¼çš„è¡¨å
        <param name="column">next_hi</param> æŒ‡å®šä¿å­˜hiå€¼çš„åˆ—å
        <param name="max_lo">100</param> æŒ‡å®šä½ä½çš„æœ€å¤§å€¼
    </generator>
</id>
```

ä¹Ÿå¯ä»¥çœç•¥ table å’Œ column é…ç½®ï¼Œå…¶é»˜è®¤çš„è¡¨ä¸º hibernate_unique_keyï¼Œåˆ—ä¸º next_hi  
hilo ç”Ÿæˆå™¨ç”Ÿæˆä¸»é”®çš„è¿‡ç¨‹ï¼ˆä»¥ hibernate_unique_key è¡¨ï¼Œnext_hi åˆ—ä¸ºä¾‹ï¼‰ï¼š

1. è·å¾— hi å€¼ï¼šè¯»å–å¹¶è®°å½•æ•°æ®åº“çš„ hibernate_unique_key è¡¨ä¸­ next_hi å­—æ®µçš„å€¼ï¼Œæ•°æ®åº“ä¸­æ­¤å­—æ®µå€¼åŠ  1 ä¿å­˜ã€‚
2. è·å¾— lo å€¼ï¼šä» 0 åˆ° max_lo å¾ªç¯å–å€¼ï¼Œå·®å€¼ä¸º 1ï¼Œå½“å€¼ä¸º max_lo å€¼æ—¶ï¼Œé‡æ–°è·å– hi å€¼ï¼Œç„¶å lo å€¼ç»§ç»­ä» 0 åˆ° max_lo å¾ªç¯ã€‚
3. æ ¹æ®å…¬å¼ hi _ (max_lo + 1) + lo è®¡ç®—ç”Ÿæˆä¸»é”®å€¼ã€‚  
   æ³¨æ„ï¼šå½“ hi å€¼æ˜¯ 0 çš„æ—¶å€™ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå€¼ä¸æ˜¯ 0_(max_lo+1)+0=0ï¼Œè€Œæ˜¯ lo è·³è¿‡ 0 ä» 1 å¼€å§‹ï¼Œç›´æ¥æ˜¯ 1ã€2ã€3â€¦â€¦

é‚£ max_lo é…ç½®å¤šå¤§åˆé€‚å‘¢ï¼Ÿ  
è¿™è¦æ ¹æ®å…·ä½“æƒ…å†µè€Œå®šï¼Œå¦‚æœç³»ç»Ÿä¸€èˆ¬ä¸é‡å¯ï¼Œè€Œä¸”éœ€è¦ç”¨æ­¤è¡¨å»ºç«‹å¤§é‡çš„ä¸»é”®ï¼Œå¯ä»¥å§ max_lo é…ç½®å¤§ä¸€ç‚¹ï¼Œè¿™æ ·å¯ä»¥å‡å°‘è¯»å–æ•°æ®è¡¨çš„æ¬¡æ•°ï¼Œæé«˜æ•ˆç‡ï¼›åä¹‹ï¼Œå¦‚æœæœåŠ¡å™¨ç»å¸¸é‡å¯ï¼Œå¯ä»¥å§ max_lo é…ç½®å°ä¸€ç‚¹ï¼Œå¯ä»¥é¿å…æ¯æ¬¡é‡å¯ä¸»é”®ä¹‹é—´çš„é—´éš”å¤ªå¤§ï¼Œé€ æˆä¸»é”®å€¼ä¸»é”®ä¸è¿è´¯ã€‚  
ç‰¹ç‚¹ï¼šè·¨æ•°æ®åº“ï¼Œhilo ç®—æ³•ç”Ÿæˆçš„æ ‡å¿—åªèƒ½åœ¨ä¸€ä¸ªæ•°æ®åº“ä¸­ä¿è¯å”¯ä¸€ã€‚

3. seqhilo  
   ä¸ hilo ç±»ä¼¼ï¼Œé€šè¿‡ hi/lo ç®—æ³•å®ç°çš„ä¸»é”®ç”Ÿæˆæœºåˆ¶ï¼Œåªæ˜¯å°† hilo ä¸­çš„æ•°æ®è¡¨æ¢æˆäº†åºåˆ— sequenceï¼Œéœ€è¦æ•°æ®åº“ä¸­å…ˆåˆ›å»º sequenceï¼Œé€‚ç”¨äºæ”¯æŒ sequence çš„æ•°æ®åº“ï¼Œå¦‚ Oracleã€‚

```xml
<id name="id" column="id">
    <generator class="seqhilo">
        <param name="sequence">hibernate_seq</param>
        <param name="max_lo">100</param>
    </generator>
</id>
```

ç‰¹ç‚¹ï¼šä¸ hilo ç±»ä¼¼ï¼Œåªèƒ½åœ¨æ”¯æŒåºåˆ—çš„æ•°æ®åº“ä¸­ä½¿ç”¨ã€‚

4. increment  
   ç”± Hibernate ä»æ•°æ®åº“ä¸­å–å‡ºä¸»é”®çš„æœ€å¤§å€¼ï¼ˆæ¯ä¸ª session åªå– 1 æ¬¡ï¼‰ï¼Œä»¥è¯¥å€¼ä¸ºåŸºç¡€ï¼Œæ¯æ¬¡å¢é‡ä¸º 1ï¼Œåœ¨å†…å­˜ä¸­ç”Ÿæˆä¸»é”®ï¼Œä¸ä¾èµ–äºåº•å±‚çš„æ•°æ®åº“ï¼Œå› æ­¤å¯ä»¥è·¨æ•°æ®åº“ã€‚

```xml
<id name="id" column="id">
    <generator class="increment" />
</id>
```

Hibernate è°ƒç”¨ org.hibernate.id.IncrementGenerator ç±»é‡Œé¢çš„ generate() æ–¹æ³•ï¼Œä½¿ç”¨ select max(idColumnName) from tableName è¯­å¥è·å–ä¸»é”®æœ€å¤§å€¼ã€‚è¯¥æ–¹æ³•è¢«å£°æ˜æˆäº† synchronizedï¼Œæ‰€ä»¥åœ¨ä¸€ä¸ªç‹¬ç«‹çš„ Java è™šæ‹Ÿæœºå†…éƒ¨æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œç„¶è€Œï¼Œåœ¨å¤šä¸ª JVM åŒæ—¶å¹¶å‘è®¿é—®æ•°æ®åº“ select max æ—¶å°±å¯èƒ½å–å‡ºç›¸åŒçš„å€¼ï¼Œå† insert å°±ä¼šå‘ç”Ÿ Dumplicate entry çš„é”™è¯¯ã€‚æ‰€ä»¥åªèƒ½æœ‰ä¸€ä¸ª Hibernate åº”ç”¨è¿›ç¨‹è®¿é—®æ•°æ®åº“ï¼Œå¦åˆ™å°±å¯èƒ½äº§ç”Ÿä¸»é”®å†²çªï¼Œæ‰€ä»¥ä¸é€‚åˆå¤šè¿›ç¨‹å¹¶å‘æ›´æ–°æ•°æ®åº“ï¼Œé€‚åˆå•ä¸€è¿›ç¨‹è®¿é—®æ•°æ®åº“ï¼Œä¸èƒ½ç”¨äºç¾¤é›†ç¯å¢ƒã€‚  
å®˜æ–¹æ–‡æ¡£ï¼šåªæœ‰åœ¨æ²¡æœ‰å…¶ä»–è¿›ç¨‹å¾€åŒä¸€å¼ è¡¨ä¸­æ’å…¥æ•°æ®æ—¶æ‰èƒ½ä½¿ç”¨ï¼Œåœ¨é›†ç¾¤ä¸‹ä¸è¦ä½¿ç”¨ã€‚  
ç‰¹ç‚¹ï¼šè·¨æ•°æ®åº“ï¼Œä¸é€‚åˆå¤šè¿›ç¨‹å¹¶å‘æ›´æ–°æ•°æ®åº“ï¼Œé€‚åˆå•ä¸€è¿›ç¨‹è®¿é—®æ•°æ®åº“ï¼Œä¸èƒ½ç”¨äºç¾¤é›†ç¯å¢ƒã€‚

5. identity  
   identity ç”±åº•å±‚æ•°æ®åº“ç”Ÿæˆæ ‡è¯†ç¬¦ã€‚identity æ˜¯ç”±æ•°æ®åº“è‡ªå·±ç”Ÿæˆçš„ï¼Œä½†è¿™ä¸ªä¸»é”®å¿…é¡»è®¾ç½®ä¸ºè‡ªå¢é•¿ï¼Œä½¿ç”¨ identity çš„å‰ææ¡ä»¶æ˜¯åº•å±‚æ•°æ®åº“æ”¯æŒè‡ªåŠ¨å¢é•¿å­—æ®µç±»å‹ï¼Œå¦‚ DB2ã€SQL Serverã€MySQLã€Sybase å’Œ HypersonicSQL ç­‰ï¼ŒOracle è¿™ç±»æ²¡æœ‰è‡ªå¢å­—æ®µçš„åˆ™ä¸æ”¯æŒã€‚

```xml
<id name="id" column="id">
    <generator class="identity" />
</id>
```

ä¾‹ï¼šå¦‚æœä½¿ç”¨ MySQL æ•°æ®åº“ï¼Œåˆ™ä¸»é”®å­—æ®µå¿…é¡»è®¾ç½®æˆ auto_incrementã€‚  
id int(11) primary key auto_increment  
ç‰¹ç‚¹ï¼šåªèƒ½ç”¨åœ¨æ”¯æŒè‡ªåŠ¨å¢é•¿çš„å­—æ®µæ•°æ®åº“ä¸­ä½¿ç”¨ï¼Œå¦‚ MySQLã€‚

6. sequence  
   é‡‡ç”¨æ•°æ®åº“æä¾›çš„ sequence æœºåˆ¶ç”Ÿæˆä¸»é”®ï¼Œéœ€è¦æ•°æ®åº“æ”¯æŒ sequenceã€‚å¦‚ oralceã€DBã€SAP DBã€PostgerSQLã€McKoi ä¸­çš„ sequenceã€‚MySQL è¿™ç§ä¸æ”¯æŒ sequence çš„æ•°æ®åº“åˆ™ä¸è¡Œï¼ˆå¯ä»¥ä½¿ç”¨ identityï¼‰ã€‚

```xml
<generator class="sequence">
    <param name="sequence">hibernate_id</param>
</generator>
```

<param name="sequence">hibernate_id</param> æŒ‡å®šsequenceçš„åç§°
Hibernateç”Ÿæˆä¸»é”®æ—¶ï¼ŒæŸ¥æ‰¾sequenceå¹¶èµ‹ç»™ä¸»é”®å€¼ï¼Œä¸»é”®å€¼ç”±æ•°æ®åº“ç”Ÿæˆï¼ŒHibernateä¸è´Ÿè´£ç»´æŠ¤ï¼Œä½¿ç”¨æ—¶å¿…é¡»å…ˆåˆ›å»ºä¸€ä¸ªsequenceï¼Œå¦‚æœä¸æŒ‡å®šsequenceåç§°ï¼Œåˆ™ä½¿ç”¨Hibernateé»˜è®¤çš„sequenceï¼Œåç§°ä¸ºhibernate_sequenceï¼Œå‰æè¦åœ¨æ•°æ®åº“ä¸­åˆ›å»ºè¯¥sequenceã€‚
ç‰¹ç‚¹ï¼šåªèƒ½åœ¨æ”¯æŒåºåˆ—çš„æ•°æ®åº“ä¸­ä½¿ç”¨ï¼Œå¦‚Oracleã€‚

7. native  
   native ç”± hibernate æ ¹æ®ä½¿ç”¨çš„æ•°æ®åº“è‡ªè¡Œåˆ¤æ–­é‡‡ç”¨ identityã€hiloã€sequence å…¶ä¸­ä¸€ç§ä½œä¸ºä¸»é”®ç”Ÿæˆæ–¹å¼ï¼Œçµæ´»æ€§å¾ˆå¼ºã€‚å¦‚æœèƒ½æ”¯æŒ identity åˆ™ä½¿ç”¨ identityï¼Œå¦‚æœæ”¯æŒ sequence åˆ™ä½¿ç”¨ sequenceã€‚  
   ä¾‹å¦‚ MySQL ä½¿ç”¨ identityï¼ŒOracle ä½¿ç”¨ sequence  
   æ³¨æ„ï¼šå¦‚æœ Hibernate è‡ªåŠ¨é€‰æ‹© sequence æˆ–è€… hiloï¼Œåˆ™æ‰€æœ‰çš„è¡¨çš„ä¸»é”®éƒ½ä¼šä» Hibernate é»˜è®¤çš„ sequence æˆ– hilo è¡¨ä¸­å–ã€‚å¹¶ä¸”ï¼Œæœ‰çš„æ•°æ®åº“å¯¹äºé»˜è®¤æƒ…å†µä¸»é”®ç”Ÿæˆæµ‹è¯•çš„æ”¯æŒï¼Œæ•ˆç‡å¹¶ä¸æ˜¯å¾ˆé«˜ã€‚  
   ä½¿ç”¨ sequence æˆ– hilo æ—¶ï¼Œå¯ä»¥åŠ å…¥å‚æ•°ï¼ŒæŒ‡å®š sequence åç§°æˆ– hi å€¼è¡¨åç§°ç­‰ï¼Œå¦‚

<param name="sequence">hibernate_id</param>
ç‰¹ç‚¹ï¼šæ ¹æ®æ•°æ®åº“è‡ªåŠ¨é€‰æ‹©ï¼Œé¡¹ç›®ä¸­å¦‚æœç”¨åˆ°å¤šä¸ªæ•°æ®åº“æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œä½¿ç”¨æ—¶éœ€è¦è®¾ç½®è¡¨çš„è‡ªå¢å­—æ®µæˆ–å»ºç«‹åºåˆ—ï¼Œå»ºç«‹è¡¨ç­‰ã€‚

8. uuid  
   UUIDï¼šUniversally Unique Identifierï¼Œæ˜¯æŒ‡åœ¨ä¸€å°æœºå™¨ä¸Šç”Ÿæˆçš„æ•°å­—ï¼Œå®ƒä¿è¯å¯¹åœ¨åŒä¸€æ—¶ç©ºä¸­çš„æ‰€æœ‰æœºå™¨éƒ½æ˜¯å”¯ä¸€çš„ã€‚æŒ‰ç…§å¼€æ”¾è½¯ä»¶åŸºé‡‘ä¼š (OSF) åˆ¶å®šçš„æ ‡å‡†è®¡ç®—ï¼Œç”¨åˆ°äº†ä»¥å¤ªç½‘å¡åœ°å€ã€çº³ç§’çº§æ—¶é—´ã€èŠ¯ç‰‡ ID ç å’Œè®¸å¤šå¯èƒ½çš„æ•°å­—ï¼Œæ ‡å‡†çš„ UUID æ ¼å¼ä¸ºï¼š  
   xxxxxxxx-xxxx-xxxx-xxxxxx-xxxxxxxxxx (8-4-4-4-12)  
   å…¶ä¸­æ¯ä¸ª x æ˜¯ 0-9 æˆ– a-f èŒƒå›´å†…çš„ä¸€ä¸ªåå…­è¿›åˆ¶çš„æ•°å­—ã€‚  
   Hibernate åœ¨ä¿å­˜å¯¹è±¡æ—¶ï¼Œç”Ÿæˆä¸€ä¸ª UUID å­—ç¬¦ä¸²ä½œä¸ºä¸»é”®ï¼Œä¿è¯äº†å”¯ä¸€æ€§ï¼Œä½†å…¶å¹¶æ— ä»»ä½•ä¸šåŠ¡é€»è¾‘æ„ä¹‰ï¼Œåªèƒ½ä½œä¸ºä¸»é”®ï¼Œå”¯ä¸€ç¼ºç‚¹é•¿åº¦è¾ƒå¤§ï¼Œ32 ä½ï¼ˆHibernate å°† UUID ä¸­é—´çš„â€œ-â€åˆ é™¤äº†ï¼‰çš„å­—ç¬¦ä¸²ï¼Œå ç”¨å­˜å‚¨ç©ºé—´å¤§ï¼Œä½†æ˜¯æœ‰ä¸¤ä¸ªå¾ˆé‡è¦çš„ä¼˜ç‚¹ï¼ŒHibernate åœ¨ç»´æŠ¤ä¸»é”®æ—¶ï¼Œä¸ç”¨å»æ•°æ®åº“æŸ¥è¯¢ï¼Œä»è€Œæé«˜æ•ˆç‡ï¼Œè€Œä¸”å®ƒæ˜¯è·¨æ•°æ®åº“çš„ï¼Œä»¥ååˆ‡æ¢æ•°æ®åº“æå…¶æ–¹ä¾¿ã€‚  
   ç‰¹ç‚¹ï¼šuuid é•¿åº¦å¤§ï¼Œå ç”¨ç©ºé—´å¤§ï¼Œè·¨æ•°æ®åº“ï¼Œä¸ç”¨è®¿é—®æ•°æ®åº“å°±ç”Ÿæˆä¸»é”®å€¼ï¼Œæ‰€ä»¥æ•ˆç‡é«˜ä¸”èƒ½ä¿è¯å”¯ä¸€æ€§ï¼Œç§»æ¤éå¸¸æ–¹ä¾¿ï¼Œæ¨èä½¿ç”¨ã€‚

9. guid  
   GUIDï¼šGlobally Unique Identifier å…¨çƒå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œä¹Ÿç§°ä½œ UUIDï¼Œæ˜¯ä¸€ä¸ª 128 ä½é•¿çš„æ•°å­—ï¼Œç”¨ 16 è¿›åˆ¶è¡¨ç¤ºã€‚ç®—æ³•çš„æ ¸å¿ƒæ€æƒ³æ˜¯ç»“åˆæœºå™¨çš„ç½‘å¡ã€å½“åœ°æ—¶é—´ã€ä¸€ä¸ªéšå³æ•°æ¥ç”Ÿæˆ GUIDã€‚ä»ç†è®ºä¸Šè®²ï¼Œå¦‚æœä¸€å°æœºå™¨æ¯ç§’äº§ç”Ÿ 10000000 ä¸ª GUIDï¼Œåˆ™å¯ä»¥ä¿è¯ï¼ˆæ¦‚ç‡æ„ä¹‰ä¸Šï¼‰3240 å¹´ä¸é‡å¤ã€‚  
   Hibernate åœ¨ç»´æŠ¤ä¸»é”®æ—¶ï¼Œå…ˆæŸ¥è¯¢æ•°æ®åº“ï¼Œè·å¾—ä¸€ä¸ª uuid å­—ç¬¦ä¸²ï¼Œè¯¥å­—ç¬¦ä¸²å°±æ˜¯ä¸»é”®å€¼ï¼Œè¯¥å€¼å”¯ä¸€ï¼Œç¼ºç‚¹é•¿åº¦è¾ƒå¤§ï¼Œæ”¯æŒæ•°æ®åº“æœ‰é™ï¼Œä¼˜ç‚¹åŒ uuidï¼Œè·¨æ•°æ®åº“ï¼Œä½†æ˜¯ä»ç„¶éœ€è¦è®¿é—®æ•°æ®åº“ã€‚  
   æ³¨æ„ï¼šé•¿åº¦å› æ•°æ®åº“ä¸åŒè€Œä¸åŒ  
   MySQL ä¸­ä½¿ç”¨ select uuid() è¯­å¥è·å¾—çš„ä¸º 36 ä½ï¼ˆåŒ…å«æ ‡å‡†æ ¼å¼çš„â€œ-â€ï¼‰  
   Oracle ä¸­ï¼Œä½¿ç”¨ select rawtohex(sys_guid()) from dual è¯­å¥è·å¾—çš„ä¸º 32 ä½ï¼ˆä¸åŒ…å«â€œ-â€ï¼‰  
   ç‰¹ç‚¹ï¼šéœ€è¦æ•°æ®åº“æ”¯æŒæŸ¥è¯¢ uuidï¼Œç”Ÿæˆæ—¶éœ€è¦æŸ¥è¯¢æ•°æ®åº“ï¼Œæ•ˆç‡æ²¡æœ‰ uuid é«˜ï¼Œæ¨èä½¿ç”¨ uuidã€‚

10. foreign  
    ä½¿ç”¨å¦å¤–ä¸€ä¸ªç›¸å…³è”çš„å¯¹è±¡çš„ä¸»é”®ä½œä¸ºè¯¥å¯¹è±¡ä¸»é”®ã€‚ä¸»è¦ç”¨äºä¸€å¯¹ä¸€å…³ç³»ä¸­ã€‚

```xml
<id name="id" column="id">
    <generator class="foreign">
        <param name="property">user</param>
    </generator>
</id>
<one-to-one name="user" class="domain.User" constrained="true" />
```

è¯¥ä¾‹ä½¿ç”¨ domain.User çš„ä¸»é”®ä½œä¸ºæœ¬ç±»æ˜ å°„çš„ä¸»é”®ã€‚  
ç‰¹ç‚¹ï¼šå¾ˆå°‘ä½¿ç”¨ï¼Œå¤§å¤šç”¨åœ¨ä¸€å¯¹ä¸€å…³ç³»ä¸­ã€‚ã€‚

2.æ™®é€šå±æ€§ï¼ˆpropertyï¼‰  
 å¼€å‘äººå‘˜å¯ä»¥æ‰“å¼€ç½‘å€ï¼š<http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd>  
æ¥æŸ¥çœ‹ hibernate3.0 çš„ dtd ä¿¡æ¯ï¼Œå¯çœ‹åˆ° property çš„å®šä¹‰å¦‚ä¸‹ï¼š

<!ELEMENT property (meta*,(column|formula)*,type?)>

                    <!ATTLIST property name CDATA #REQUIRED>
                    <!ATTLIST property node CDATA #IMPLIED>
                    <!ATTLIST property access CDATA #IMPLIED>
                    <!ATTLIST property type CDATA #IMPLIED>
                    <!ATTLIST property column CDATA #IMPLIED>
                    <!ATTLIST property length CDATA #IMPLIED>
                    <!ATTLIST property precision CDATA #IMPLIED>
                    <!ATTLIST property scale CDATA #IMPLIED>
                    <!ATTLIST property not-null (true|false) #IMPLIED>
                    <!ATTLIST property unique (true|false) "false">
                    <!ATTLIST property unique-key CDATA #IMPLIED>
                    <!ATTLIST property index CDATA #IMPLIED>                                                                                  <!-- include the columns spanned by this property in an index -->
                    <!ATTLIST property update (true|false) #IMPLIED>
                    <!ATTLIST property insert (true|false) #IMPLIED>
                    <!ATTLIST property optimistic-lock (true|false) "true">          <!-- only supported for properties of a class (not component) -->
                    <!ATTLIST property formula CDATA #IMPLIED>
                    <!ATTLIST property lazy (true|false) "false">
    <!ATTLIST property generated (never|insert|always) "never">
       å®ƒçš„å„å±æ€§ä¸­æ¯”è¾ƒå¸¸ç”¨çš„æœ‰ï¼šnameï¼ˆå¯¹åº”çš„javaç±»çš„å±æ€§åç§°ï¼‰ã€columnï¼ˆå¯¹åº”çš„è¡¨ä¸­çš„å­—æ®µï¼‰ã€tyopeï¼ˆå±æ€§çš„ç±»å‹ï¼Œeg.java.lang.Stringï¼‰ã€not-nullï¼ˆè®¾ç½®è¯¥å±æ€§æ˜¯å¦ä¸ºç©ºï¼Œä¸ºtrueæ—¶è¡¨ç¤ºéç©ºï¼Œé»˜è®¤ä¸ºfalseï¼‰å’Œlength(å­—æ®µçš„é•¿åº¦é™åˆ¶)ã€‚

Eg1. <property name="accessname" column="accessName" type="java.lang.String" not-null="true" />  
Eg2. <property name="state" column="state" type="java.lang.Byte" not-null="true" />  
Eg3. <property name="description" column="description" type="java.lang.String" />

3.ä¸€å¯¹å¤šå…³ç³»ï¼ˆ`<many-to-oneâ€¦/>å’Œ<setâ€¦></set>`ï¼‰  
 ä¸€å¯¹å¤šå…³ç³»ä¸€èˆ¬æ˜¯ç”¨åœ¨ä¸€ä¸ªè¡¨ä¸å¦ä¸€ä¸ªè¡¨å­˜åœ¨å¤–é”®å…³è”çš„æ—¶å€™ï¼Œä¾‹å¦‚ç”¨æˆ·è¡¨çš„ç»„ç»‡ id ä¸ç»„ç»‡è¡¨å­˜åœ¨å¤–é”®å…³è”ï¼Œåˆ™â€œä¸€â€æ–¹ä¸ºç»„ç»‡è¡¨ï¼Œâ€œå¤šâ€æ–¹ä¸ºç”¨æˆ·è¡¨ï¼Œå› ä¸ºä¸€ä¸ªç»„ç»‡å¯ä»¥åŒ…å«å¤šä¸ªç”¨æˆ·ï¼Œè€Œä¸€ä¸ªç”¨æˆ·åªèƒ½éš¶å±äºä¸€ä¸ªç»„ç»‡ã€‚  
å¯¹äºå­˜åœ¨ä¸€å¯¹å¤šå…³ç³»å’Œå¤šå¯¹ä¸€å…³ç³»çš„åŒæ–¹ï¼Œéœ€è¦åœ¨â€¦hbm.xml ä¸­è¿›è¡Œç›¸åº”é…ç½®ï¼Œè¿™æ—¶åœ¨â€œä¸€â€æ–¹ï¼ˆä¾‹å¦‚ï¼šç»„ç»‡ï¼‰éœ€è¦åœ¨æ˜ å°„æ–‡ä»¶ä¸­æ·»åŠ <setâ€¦></set>å…ƒç´ ï¼Œå› ä¸ºå®ƒåŒ…å«å¤šä¸ªâ€œå¤šâ€æ–¹çš„å¯¹è±¡ï¼Œä¸€èˆ¬çš„æ ¼å¼å¦‚ä¸‹ï¼š

```xml
<set name="javaæ˜ å°„ç±»ä¸­å¯¹åº”çš„å±æ€§" inverse="true" lazy="true">
<key column="è¡¨ä¸­å¯¹åº”å­—æ®µ"/>
<one-to-many class="å¤šæ–¹çš„ç±»"/>
</set>
```

â€œå¤šâ€æ–¹ï¼ˆä¾‹å¦‚ï¼šç”¨æˆ·ï¼‰éš¶å±äºä¸€ä¸ªâ€œä¸€â€æ–¹å¯¹è±¡ï¼Œä¸€èˆ¬çš„æ ¼å¼å¦‚ä¸‹ï¼š  
<many-to-one name="javaæ˜ å°„ç±»ä¸­å¯¹åº”çš„å±æ€§" column="è¡¨ä¸­å¯¹åº”å­—æ®µ" class="ç±»å" not-null="true" />

4.ä¸€å¯¹ä¸€å…³ç³»ï¼ˆ`<one-to-oneâ€¦/>`ï¼‰  
ä¸€å¯¹ä¸€å…³ç³»ç›¸å¯¹ä¸€å¯¹å¤šå…³ç³»æ¥è¯´æ¯”è¾ƒå°‘è§ï¼Œä½†ä¹Ÿåœ¨æŸäº›æƒ…å†µä¸‹è¦ç”¨åˆ°ï¼Œä¾‹å¦‚æœ‰ä¸€ä¸ªç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯è¡¨ï¼ˆUSERï¼‰å’Œä¸€ä¸ªç”¨æˆ·çš„å¯†ç è¡¨ï¼ˆPASSWDï¼‰å°±å­˜åœ¨ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚ä¸‹é¢æ¥çœ‹ä¸€ä¸‹ä¸€å¯¹ä¸€å…³ç³»åœ¨ Hibernate çš„é…ç½®ã€‚  
å…¶ä¸­ä¸»è¡¨ï¼ˆeg. ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯è¡¨ï¼‰çš„é…ç½®å¦‚ä¸‹ï¼š

```xml
<one-to-one name="ä¸»è¡¨å¯¹è±¡ä¸­å­è¡¨å¯¹è±¡çš„å±æ€§å" class="å­è¡¨å¯¹è±¡çš„ç±»å" cascade="save-update"/>
```

å­è¡¨ï¼ˆeg. ç”¨æˆ·çš„å¯†ç è¡¨ï¼‰çš„é…ç½®å¦‚ä¸‹ï¼š

```xml
<one-to-one name="å­è¡¨å¯¹è±¡ä¸­ä¸»è¡¨å¯¹è±¡çš„å±æ€§å" class="ä¸»è¡¨å¯¹è±¡çš„ç±»å" constrained="true" />
```

5.å¤šå¯¹å¤šå…³ç³»ï¼ˆ<many-to-manyâ€¦/>ï¼‰  
åœ¨æ•°æ®åº“è®¾è®¡æ—¶ï¼Œä¸€èˆ¬å°†å¤šå¯¹å¤šå…³ç³»è½¬æ¢ä¸ºä¸¤ä¸ªä¸€å¯¹å¤šï¼ˆæˆ–å¤šå¯¹ä¸€ï¼‰å…³ç³»ï¼Œä¾‹å¦‚åœ¨åŸºäºè§’è‰²çš„æƒé™ç³»ç»Ÿä¸­ï¼Œç”¨æˆ·å’Œè§’è‰²å­˜åœ¨çš„å…³ç³»å°±æ˜¯å…¸å‹çš„å¤šå¯¹å¤šå…³ç³»ï¼Œå³ä¸€ä¸ªç”¨æˆ·å¯ä»¥å…·æœ‰å¤šä¸ªè§’è‰²ï¼Œè€Œä¸€ä¸ªè§’è‰²åˆå¯ä»¥ä¸ºå¤šä¸ªç”¨æˆ·æ‰€æœ‰ï¼Œä¸€èˆ¬åœ¨è®¾è®¡æ—¶ï¼Œéƒ½ä¼šåŠ ä¸€ä¸ªç”¨æˆ·ä¸è§’è‰²çš„å…³è”è¡¨ï¼Œè¯¥è¡¨ä¸ç”¨æˆ·è¡¨ä»¥åŠè§’è‰²è¡¨éƒ½å­˜åœ¨å¤–é”®å…³è”ã€‚  
åœ¨æœ¬å°èŠ‚ä¸­è®²è¿°çš„æ˜¯æ²¡æœ‰åˆ†è§£çš„å¤šå¯¹å¤šå…³ç³»åœ¨ Hibernate ä¸­å¦‚ä½•é…ç½®ã€‚è®¾ç½®æ ¼å¼å¦‚ä¸‹ï¼š

```xml
<set name="javaå¯¹è±¡çš„å±æ€§å" table="è¡¨å" cascade="all" outer-join="false">
<key column="è¡¨çš„å¯¹åº”å­—æ®µ"/>
<many-to-many class="å¦ä¸€ä¸ªè¡¨çš„å¯¹è±¡ç±»" column="å¦ä¸€ä¸ªè¡¨çš„å­—æ®µ"/>
</set>
```

6.å®Œæ•´å®ä¾‹  
åœ¨æœ¬å°èŠ‚ä¸­ä¸¾ä¸€äº›.hbm.xml æ˜ å°„æ–‡ä»¶çš„ä¾‹å­ï¼Œè®©å¼€å‘äººå‘˜å¯¹å…¶æœ‰ä¸€ä¸ªæ„Ÿæ€§çš„è®¤è¯†ã€‚æ¥ä¸‹æ¥è®²è¿°ä¸€ä¸ªç”¨æˆ·è¡¨ï¼ˆtbl_userï¼‰ã€ç”¨æˆ·ä¸è§’è‰²å…³è”è¡¨ï¼ˆtbl_user_roleï¼‰ã€è§’è‰²è¡¨ï¼ˆtbl_roleï¼‰ä»¥åŠç»„ç»‡è¡¨ï¼ˆtbl_organizationï¼‰çš„ä¾‹å­ã€‚

ï¼ˆ1ï¼‰tbl_user

```xml
<?xml version="1.0" encoding='UTF-8'?>
<!DOCTYPE hibernate-mapping PUBLIC
 "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd" >
<hibernate-mapping package="com.amigo.dao.pojo">
    <class name="User" table="tbl_user">
        <id name="loginname" column="loginName" type="java.lang.String">
            <generator class="assigned"/>
        </id>
        <property name="name" column="name" type="java.lang.String" not-null="true" />
        <property name="password" column="password" type="java.lang.String" not-null="true" />
        <property name="mobile" column="mobile" type="java.lang.String" />
        <property name="telephone" column="telephone" type="java.lang.String" />
        <property name="email" column="email" type="java.lang.String" />
        <property name="createtime" column="createTime" type="java.util.Date" not-null="true" />
        <property name="lastlogintime" column="lastLoginTime" type="java.util.Date" />
        <property name="logintimes" column="loginTimes" type="java.lang.Long" not-null="true" />
        <property name="state" column="state" type="java.lang.Byte" not-null="true" />
        <property name="description" column="description" type="java.lang.String" />
        <many-to-one name="organization" column="orgId" class="Organization" not-null="true" />
        <set name="userRoleSet" inverse="true" cascade="all-delete-orphan" lazy="true">
            <key column="loginName"/>
            <one-to-many class="UserRole"/>
        </set>
</hibernate-mapping>
```

ï¼ˆ2ï¼‰tbl_organization

```xml
<?xml version="1.0" encoding='UTF-8'?>
<!DOCTYPE hibernate-mapping PUBLIC
"-//Hibernate/Hibernate Mapping DTD 3.0//EN"
"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd" >
<hibernate-mapping package="com.amigo.dao.pojo">
    <class name="Organization" table="tbl_organization">
        <id name="orgid" column="orgId" type="java.lang.Long">
            <generator class="native"/>
        </id>
        <property name="parentorgid" column="parentOrgId" type="java.lang.Long" not-null="true" />
        <property name="orgname" column="orgName" type="java.lang.String" not-null="true" />
        <property name="orgfullname" column="orgFullName" type="java.lang.String" />
        <property name="orglevel" column="orgLevel" type="java.lang.Integer" not-null="true" />
        <property name="state" column="state" type="java.lang.Byte" not-null="true" />
        <property name="description" column="description" type="java.lang.String" />
        <property name="creator" column="creator" type="java.lang.String" />
        <property name="createtime" column="createTime" type="java.util.Date" />
        <set name="userSet" inverse="true" lazy="true">
            <key column="orgId"/>
            <one-to-many class="User"/>
        </set>
    </class>
</hibernate-mapping>
```

ï¼ˆ3ï¼‰tbl_user_role

```xml
<?xml version="1.0" encoding='UTF-8'?>
<!DOCTYPE hibernate-mapping PUBLIC
"-//Hibernate/Hibernate Mapping DTD 3.0//EN"
"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd" >
<hibernate-mapping package="com.cotel.netvote.dao.model">
    <class name="UserRole" table="tbl_user_role">
        <id name="urid" column="urId" type="java.lang.Integer">
            <generator class="native"/>
        </id>
        <many-to-one name="role" column="roleId" class="Role" not-null="true" />
        <many-to-one name="user" column="loginName" class="User" not-null="true" />
    </class>
</hibernate-mapping>
```

ï¼ˆ4ï¼‰`tbl_role`

```xml
<?xml version="1.0" encoding='UTF-8'?>
<!DOCTYPE hibernate-mapping PUBLIC
"-//Hibernate/Hibernate Mapping DTD 3.0//EN"
 "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd" >
<hibernate-mapping package="com.cotel.netvote.dao.model">
    <class name="Role" table="tbl_role">
        <id name="roleid" column="roleId" type="java.lang.Integer">
            <generator class="native"/>
        </id>
        <property name="rolename" column="roleName" type="java.lang.String" not-null="true" />
        <property name="createdate" column="createDate" type="java.util.Date" not-null="true" />
        <property name="description" column="description" type="java.lang.String" />
        <set name="userRoleSet" inverse="true" lazy="true" cascade="all">
            <key column="roleId"/>
            <one-to-many class="UserRole"/>
        </set>
    </class>
</hibernate-mapping>
```

```xml
<!--æ ‡å‡†çš„XMLæ–‡ä»¶çš„èµ·å§‹è¡Œï¼Œversion='1.0'è¡¨æ˜XMLçš„ç‰ˆæœ¬ï¼Œencoding='gb2312'è¡¨æ˜XMLæ–‡ä»¶çš„ç¼–ç æ–¹å¼-->
                <?xml version='1.0' encoding='gb2312'?>
<!--è¡¨æ˜è§£ææœ¬XMLæ–‡ä»¶çš„DTDæ–‡æ¡£ä½ç½®ï¼ŒDTDæ˜¯Document Type Definition çš„ç¼©å†™,å³æ–‡æ¡£ç±»å‹çš„å®šä¹‰,XMLè§£æå™¨ä½¿ç”¨DTDæ–‡æ¡£æ¥æ£€æŸ¥XMLæ–‡ä»¶çš„åˆæ³•æ€§ã€‚hibernate.sourceforge.net/hibernate-configuration-3.0dtdå¯ä»¥åœ¨Hibernate3.1.3è½¯ä»¶åŒ…ä¸­çš„src\org\hibernateç›®å½•ä¸­æ‰¾åˆ°æ­¤æ–‡ä»¶-->
<!DOCTYPE hibernate-configuration PUBLIC
          "-//Hibernate/Hibernate Configuration DTD 3.0//EN"
          "http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd">
    <!--å£°æ˜Hibernateé…ç½®æ–‡ä»¶çš„å¼€å§‹-->
    <hibernate-configuration>
    <!--è¡¨æ˜ä»¥ä¸‹çš„é…ç½®æ˜¯é’ˆå¯¹session-factoryé…ç½®çš„ï¼ŒSessionFactoryæ˜¯Hibernateä¸­çš„ä¸€ä¸ªç±»ï¼Œè¿™ä¸ªç±»ä¸»è¦è´Ÿè´£ä¿å­˜HIbernateçš„é…ç½®ä¿¡æ¯ï¼Œä»¥åŠå¯¹Sessionçš„æ“ä½œ-->
      <session-factory>
      <!--é…ç½®æ•°æ®åº“çš„é©±åŠ¨ç¨‹åºï¼ŒHibernateåœ¨è¿æ¥æ•°æ®åº“æ—¶ï¼Œéœ€è¦ç”¨åˆ°æ•°æ®åº“çš„é©±åŠ¨ç¨‹åº-->
          <property name="hibernate.connection.driver_class">com.mysql.jdbc.Driver </property>
      <!--è®¾ç½®æ•°æ®åº“çš„è¿æ¥url:jdbc:mysql://localhost/hibernate,å…¶ä¸­localhostè¡¨ç¤ºmysqlæœåŠ¡å™¨åç§°ï¼Œæ­¤å¤„ä¸ºæœ¬æœºï¼Œ    hibernateæ˜¯æ•°æ®åº“å-->
            <property name="hibernate.connection.url">jdbc:mysql://localhost/hibernate </hibernate>
    <!--è¿æ¥æ•°æ®åº“æ˜¯ç”¨æˆ·å-->
          <property name="hibernate.connection.username">root </property>
          <!--è¿æ¥æ•°æ®åº“æ˜¯å¯†ç -->
          <property name="hibernate.connection.password">123456 </property>
          <!--æ•°æ®åº“è¿æ¥æ± çš„å¤§å°-->
          <property name="hibernate.connection.pool.size">20 </property>
        <!--æ˜¯å¦åœ¨åå°æ˜¾ç¤ºHibernateç”¨åˆ°çš„SQLè¯­å¥ï¼Œå¼€å‘æ—¶è®¾ç½®ä¸ºtrueï¼Œä¾¿äºå·®é”™ï¼Œç¨‹åºè¿è¡Œæ—¶å¯ä»¥åœ¨Eclipseçš„æ§åˆ¶å°æ˜¾ç¤ºHibernateçš„æ‰§è¡ŒSqlè¯­å¥ã€‚é¡¹ç›®éƒ¨ç½²åå¯ä»¥è®¾ç½®ä¸ºfalseï¼Œæé«˜è¿è¡Œæ•ˆç‡-->
        <property name="hibernate.show_sql">true </property>
        <!--jdbc.fetch_sizeæ˜¯æŒ‡Hibernateæ¯æ¬¡ä»æ•°æ®åº“ä¸­å–å‡ºå¹¶æ”¾åˆ°JDBCçš„Statementä¸­çš„è®°å½•æ¡æ•°ã€‚Fetch Sizeè®¾çš„è¶Šå¤§ï¼Œè¯»æ•°æ®åº“çš„æ¬¡æ•°è¶Šå°‘ï¼Œé€Ÿåº¦è¶Šå¿«ï¼ŒFetch Sizeè¶Šå°ï¼Œè¯»æ•°æ®åº“çš„æ¬¡æ•°è¶Šå¤šï¼Œé€Ÿåº¦è¶Šæ…¢-->
        <property name="jdbc.fetch_size">50 </property>
        <!--jdbc.batch_sizeæ˜¯æŒ‡Hibernateæ‰¹é‡æ’å…¥,åˆ é™¤å’Œæ›´æ–°æ—¶æ¯æ¬¡æ“ä½œçš„è®°å½•æ•°ã€‚Batch Sizeè¶Šå¤§ï¼Œæ‰¹é‡æ“ä½œçš„å‘æ•°æ®åº“å‘é€Sqlçš„æ¬¡æ•°è¶Šå°‘ï¼Œé€Ÿåº¦å°±è¶Šå¿«ï¼ŒåŒæ ·è€—ç”¨å†…å­˜å°±è¶Šå¤§-->
        <property name="jdbc.batch_size">23 </property>
        <!--jdbc.use_scrollable_resultsetæ˜¯å¦å…è®¸Hibernateç”¨JDBCçš„å¯æ»šåŠ¨çš„ç»“æœé›†ã€‚å¯¹åˆ†é¡µçš„ç»“æœé›†ã€‚å¯¹åˆ†é¡µæ—¶çš„è®¾ç½®éå¸¸æœ‰å¸®åŠ©-->
        <property name="jdbc.use_scrollable_resultset">false </property>
        <!--connection.useUnicodeè¿æ¥æ•°æ®åº“æ—¶æ˜¯å¦ä½¿ç”¨Unicodeç¼–ç -->
        <property name="Connection.useUnicode">true </property>
        <!--connection.characterEncodingè¿æ¥æ•°æ®åº“æ—¶æ•°æ®çš„ä¼ è¾“å­—ç¬¦é›†ç¼–ç æ–¹å¼ï¼Œæœ€å¥½è®¾ç½®ä¸ºgbkï¼Œç”¨gb2312æœ‰çš„å­—ç¬¦ä¸å…¨-->
    <property name="connection.characterEncoding">gbk </property>

        <!--hibernate.dialect åªæ˜¯Hibernateä½¿ç”¨çš„æ•°æ®åº“æ–¹è¨€,å°±æ˜¯è¦ç”¨Hibernateè¿æ¥é‚£ç§ç±»å‹çš„æ•°æ®åº“æœåŠ¡å™¨ã€‚-->
          <property name="hibernate.dialect">org.hibernate.dialect.MySQLDialect </property>
        <!--æŒ‡å®šæ˜ å°„æ–‡ä»¶ä¸ºâ€œhibernate/ch1/UserInfo.hbm.xmlâ€-->
          <mapping resource="org/mxg/UserInfo.hbm.xml">
  </session-factory>
  </hibernate-configuration>



  <bean id="dataSource"
  class="org.apache.commons.dbcp.BasicDataSource"
  destroy-method="close">
//è¿æ¥é©±åŠ¨
  <property name="driverClassName" value="${jdbc.driverClassName}" />
//è¿æ¥url,
<property name="url" value="${jdbc.url}" />
//è¿æ¥ç”¨æˆ·å
  <property name="username" value="${jdbc.username}" />
//è¿æ¥å¯†ç 
  <property name="password" value="${jdbc.password}" />
</bean>

<bean id="hbSessionFactory"
  class="org.springframework.orm.hibernate3.annotation.AnnotationSessionFactoryBean">
  <property name="dataSource" ref="dataSource" />
  <property name="configLocation">
//hibernateé…ç½®æ–‡ä»¶ä½ç½®
  <value>WEB-INF/hibernate.cfg.xml </value>
  </property>
  <property name="configurationClass"
  value="org.hibernate.cfg.AnnotationConfiguration" />
  <property name="hibernateProperties">
  <props>
  //é’ˆå¯¹oracleæ•°æ®åº“çš„æ–¹è¨€,ç‰¹å®šçš„å…³ç³»æ•°æ®åº“ç”Ÿæˆä¼˜åŒ–çš„SQL
    <prop key="hibernate.dialect">
    org.hibernate.dialect.OracleDialect
    </prop>
  //é€‰æ‹©HQLè§£æå™¨çš„å®ç°
    <prop key="hibernate.query.factory_class">
    org.hibernate.hql.ast.ASTQueryTranslatorFactory
    </prop>
    //æ˜¯å¦åœ¨æ§åˆ¶å°æ‰“å°sqlè¯­å¥
    <prop key="hibernate.show_sql">true </prop>
    //åœ¨Hibernateç³»ç»Ÿå‚æ•°ä¸­hibernate.use_outer_joinè¢«æ‰“å¼€çš„æƒ…å†µä¸‹,è¯¥å‚æ•°ç”¨æ¥å…è®¸ä½¿ç”¨outer joinæ¥è½½å…¥æ­¤é›†åˆçš„æ•°æ®ã€‚
    <prop key="hibernate.use_outer_join">true </prop>
  //é»˜è®¤æ‰“å¼€ï¼Œå¯ç”¨cglibåå°„ä¼˜åŒ–ã€‚cglibæ˜¯ç”¨æ¥åœ¨Hibernateä¸­åŠ¨æ€ç”ŸæˆPOå­—èŠ‚ç çš„ï¼Œæ‰“å¼€ä¼˜åŒ–å¯ä»¥åŠ å¿«å­—èŠ‚ç æ„é€ çš„é€Ÿåº¦
  <prop key="hibernate.cglib.use_reflection_optimizer">true </prop>
  //è¾“å‡ºæ ¼å¼åŒ–åçš„sql,æ›´æ–¹ä¾¿æŸ¥çœ‹
  <prop key="hibernate.format_sql">true </prop>
  //â€œuseUnicodeâ€å’Œâ€œcharacterEncodingâ€å†³å®šäº†å®ƒæ˜¯å¦åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ä¼ è¾“è¿‡ç¨‹ä¸­è¿›è¡ŒEncodeï¼Œä»¥åŠå¦‚ä½•è¿›è¡ŒEncode
  <prop key="hibernate.connection.useUnicode">true </prop>
  //å…è®¸æŸ¥è¯¢ç¼“å­˜, ä¸ªåˆ«æŸ¥è¯¢ä»ç„¶éœ€è¦è¢«è®¾ç½®ä¸ºå¯ç¼“å­˜çš„.
  <prop key="hibernate.cache.use_query_cache">false </prop>
  <prop key="hibernate.default_batch_fetch_size">16 </prop>
    //è¿æ¥æ± çš„æœ€å¤§æ´»åŠ¨ä¸ªæ•°
    <prop key="hibernate.dbcp.maxActive">100 </prop>
  //å½“è¿æ¥æ± ä¸­çš„è¿æ¥å·²ç»è¢«è€—å°½çš„æ—¶å€™ï¼ŒDBCPå°†æ€æ ·å¤„ç†(0 = å¤±è´¥,1 = ç­‰å¾…,2  =  å¢é•¿)
    <prop key="hibernate.dbcp.whenExhaustedAction">1 </prop>
    //æœ€å¤§ç­‰å¾…æ—¶é—´
    <prop key="hibernate.dbcp.maxWait">1200 </prop>
    //æ²¡æœ‰äººç”¨è¿æ¥çš„æ—¶å€™ï¼Œæœ€å¤§é—²ç½®çš„è¿æ¥ä¸ªæ•°
    <prop key="hibernate.dbcp.maxIdle">10 </prop>
    ##ä»¥ä¸‹æ˜¯å¯¹prepared statementçš„å¤„ç†ï¼ŒåŒä¸Šã€‚
    <prop key="hibernate.dbcp.ps.maxActive">100 </prop>
    <prop key="hibernate.dbcp.ps.whenExhaustedAction">1 </prop>
    <prop key="hibernate.dbcp.ps.maxWait">1200 </prop>
    <prop key="hibernate.dbcp.ps.maxIdle">10 </prop>
  </props>
  </property>
</bean>
```

## [æ¢ç´¢Spring MVCæ³¨è§£é©±åŠ¨ï¼šä»åŸºç¡€åˆ°é«˜çº§](https://blog.dong4j.site/posts/aab1eaf1.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})ver)

å¤šä¸ª Spring é…ç½®æ–‡ä»¶å¤„ç†

1.  é‡‡ç”¨é€—å·å°†å¤šä¸ªé…ç½®æ–‡ä»¶åˆ†å¼€
2.  ä½¿ç”¨é€šé…ç¬¦

å¼€å¯æ³¨è§£:
`<mvc:annotation-driven>`
å¼€å¯è‡ªåŠ¨æ‰«æ
`<context:component-scan base-package="åŒ…"`

ä½¿ç”¨ Annotation ä¸ç”¨ä½¿ç”¨ç»§æ‰¿çˆ¶ç±»æˆ–è€…å®ç°æ¥å£

RequestMapping

1. value
2. params -->å¯¹è¯·æ±‚å‚æ•°è¿›è¡Œè¿‡æ»¤
3. method -->ä»£è¡¨è¯·æ±‚æ–¹å¼ é€šè¿‡æäº¤æ–¹å¼è¿›è¡Œè¿‡æ»¤è¯·æ±‚

è¯·æ±‚å¤„ç†æ–¹æ³•å¯ä»¥æ¥å—å‚æ•°
HttpServletRequest
HttpServletRespones
HttpServletSession

@RequsetParam æ³¨è§£

restful
representational state transfer
è¡¨ç°å±‚çŠ¶æ€è½¬ç§»

è¯·æ±‚å¤„ç†æ–¹æ³•å¯ä»¥è¿”å›çš„å€¼

## æ•°æ®ç»‘å®š

1. åŸºæœ¬æ•°æ®ç±»å‹,String String[]ç»‘å®š
   - åªéœ€è¦è®© jsp ä¸­çš„ name å€¼å’Œ controller ä¸­çš„å±æ€§åç›¸åŒå³å¯
2. ç»‘å®šåˆ°ä¸€ä¸ª Bean å½“ä¸­å»
   - åªè¦ä¿è¯ Bean ä¸­å±æ€§çš„åå­—å’Œè¡¨å•æ•°æ®çš„ name ä¸€æ ·
3. List ç»‘å®š

## ç±»å‹è½¬æ¢

@InitBinber
Converter-->ç±»å‹è½¬æ¢å™¨

## è¾“å…¥éªŒè¯

Hibernate Validator

## æ–‡ä»¶ä¸Šä¼ 

## æ‹¦æˆªå™¨

å®ç° HandlerInterceptor

1. perHandler -->Controller å‰
2. postHandler -->Controller å
3. alterCompletion -->ä¸€èˆ¬è¿›è¡Œä¸€äº›æ¸…ç†å·¥ä½œ

ç»§æ‰¿ HandlerInterptorAdaptor

## [Spring å…¥é—¨ï¼šEJB vs Spring å®¹å™¨å¤§æ¯”æ‹¼](https://blog.dong4j.site/posts/90f41285.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

1. EJB ç¼ºç‚¹  
   EJB ç³Ÿç³•çš„ä»£ç å’Œä»£ç æ¡†æ¶  
   åˆ†å¸ƒå¼æ¨¡å‹æ»¥ç”¨  
   å•å…ƒæµ‹è¯•éš¾ä»¥å®ç°  
   ä¸è¦çš„å¤æ‚åº¦å¯¼è‡´æ€§èƒ½é™ä½  
   å®¹å™¨çš„å¯ç§»æ¤æ€§

2. é‡é‡çº§å®¹å™¨ç¼ºç‚¹  
   å¸¦æœ‰ä¾µå…¥æ€§çš„ API(ä»£ç ä¾èµ–äº EJB)  
   å¯¹å®¹å™¨çš„ä¾èµ– (ä»£ç ä¸èƒ½å† EJB å®¹å™¨ä¹‹å¤–å·¥ä½œ)  
   æä¾›å›ºå®šçš„ä¸€ç»„æœºèƒ½,ä¸å…·å¤‡é…ç½®èƒ½åŠ›  
   ä¸åŒçš„äº§å“,éƒ¨ç½²è¿‡ç¨‹ä¸åŒ,ä¸æ˜“é€šç”¨  
   å¯åŠ¨æ—¶é—´é•¿

è½»é‡çº§å®¹å™¨:  
3. Spring å®¹å™¨  
è´Ÿè´£ POJO çš„ç”Ÿæˆå’Œç»‘å®šå…³ç³»

IoC å’Œ AOP  
å®¹å™¨çš„åŠŸæ•ˆç”± IoC å®Œæˆ  
æ ¹æ® Web åº”ç”¨,å°åº”ç”¨,æ¡Œé¢ç¨‹åºçš„ä¸åŒ,å¯¹å®¹å™¨çš„ä¾èµ–ç¨‹åº¦ä¸åŒ  
Spring å°†ç®¡ç†çš„ Bean ä½œä¸º POJO è¿›è¡Œæ§åˆ¶,é€šè¿‡ AOP Interceptor èƒ½å¤Ÿå¢å¼ºå…¶ä»–åŠŸèƒ½

Spring æ¡†æ¶å›¾

1. Spring AOP
2. Spring ORM
3. Spring DAO
4. Spring Web
5. Spring Context
6. Spring Web MVC
7. Spring Core

## IoC<-->DI æ§åˆ¶åè½¬<-->ä¾èµ–æ³¨å…¥

æ•´ä¸ªåº”ç”¨ç¨‹åºçš„è¡¨ç°ç»“æœæ˜¯ç”±å¤–éƒ¨å®¹å™¨çš„ **é…ç½®** æ¥æ§åˆ¶æ•´ä¸ªåº”ç”¨ç¨‹åºçš„è¿è¡Œæ•ˆæœ  
åœ¨ç³»ç»Ÿè¿è¡Œæ—¶,ç”±å®¹å™¨ (æ“ä½œç³»ç»Ÿ) å°†ä¾èµ–å…³ç³» (USB å¤–éƒ¨è®¾å¤‡) æ³¨å…¥åˆ°ç»„ä»¶ä¸­

ä½œç”¨:

1. åè°ƒå„ç»„ä»¶é—´ç›¸äº’çš„ä¾èµ–å…³ç³»,åŒæ—¶å¤§å¤§æé«˜äº†ç»„ä»¶çš„å¯ç§»æ¤æ€§
2. å…¶å®å°±æ˜¯åœ¨è°ƒç”¨ Service æ˜¯é€šè¿‡æ¥å£æŒ‡å‘å®ç°,æŠŠé‚£ä¸ªå®ç°ç±»å†™åˆ°äº†é…ç½®æ–‡ä»¶ä¸­,åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™åŠ¨æ€çš„é€šè¿‡é…ç½®æ–‡ä»¶æ¥æ‰¾åˆ°åˆ°åº•è¦å®ç°é‚£ä¸ªæ¥å£å®ç°ç±»; é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶å°±å¯ä»¥å®ç°ç»„ä»¶çš„å¯æ‰©å±•æ€§ (ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„å®ç°ç±»å)

Spring API  
Bean å·¥å‚  
å…ˆè¯»å–é…ç½®æ–‡ä»¶  
ç„¶åè°ƒç”¨ getBean(),ç„¶åäº§ç”Ÿ Bean å¯¹è±¡

æ‰€æœ‰çš„å®¹å™¨è´Ÿè´£åˆ›å»º Bean å¯¹è±¡,è´Ÿè´£é”€æ¯å•ä¾‹çš„ Bean,éå•ä¾‹çš„ä¸è´Ÿè´£é”€æ¯

åœ¨æ•´ä¸ªåº”ç”¨ä¸­,å‡ºäº† DTO å¯¹è±¡,å…¶ä»– bean å…¨éƒ¨ç”± Spring ç®¡ç†

spring é…ç½®æ–‡ä»¶ä¸­çš„ id å±æ€§å’Œ name å±æ€§çš„åŒºåˆ«  
id å±æ€§åªå…è®¸ä½¿ç”¨æ•°å­—,å­—æ¯,ä¸‹åˆ’çº¿å’Œ $,è€Œä¸”æ•°å­—ä¸èƒ½å¼€å¤´;  
name å±æ€§å¯ä»¥éšä¾¿  
æ‰€æœ‰å½“éœ€è¦å…¶ä»–ç‰¹æ®Šå­—ç¬¦ä½œä¸ºåå­—æ˜¯å¿…é¡»ä½¿ç”¨ name

## AOP

é¢å‘åˆ‡é¢ (æ–¹å‘) ç¼–ç¨‹  
é€šè¿‡åŠ¨æ€ä»£ç†å®ç°  
ä¸€ä¸ªå¯¹è±¡è¿è¡Œèµ·æ¥å,å¯ä»¥åŠ¨æ€çš„æ·»åŠ æ‰§è¡Œä»£ç  (å±æ€§,æ–¹æ³•)  
ä½†æ˜¯ java åªèƒ½åœ¨æ–¹æ³•å‰åæ·»åŠ ä»£ç ,å› ä¸º java å¹¶ä¸æ˜¯å®Œå…¨çš„åŠ¨æ€è¯­è¨€

## IoC

ç”¨ç™½è¯æ¥è®²ï¼Œå°±æ˜¯ç”±å®¹å™¨æ§åˆ¶ç¨‹åºä¹‹é—´çš„å…³ç³»ï¼Œè€Œéä¼ ç»Ÿå®ç°ä¸­ï¼Œç”±ç¨‹åºä»£ç ç›´æ¥æ“æ§ã€‚è¿™ä¹Ÿå°±æ˜¯æ‰€è°“â€œæ§åˆ¶åè½¬â€çš„æ¦‚å¿µæ‰€åœ¨ï¼šæ§åˆ¶æƒç”±åº”ç”¨ä»£ç ä¸­è½¬åˆ°äº†å¤–éƒ¨å®¹å™¨ï¼Œæ§åˆ¶æƒçš„è½¬ç§»ï¼Œæ˜¯æ‰€è°“åè½¬

## DI

å³ç»„ä»¶ä¹‹é—´çš„ä¾èµ–å…³ç³»ç”±å®¹å™¨åœ¨è¿è¡ŒæœŸå†³å®šï¼Œå½¢è±¡çš„æ¥è¯´ï¼Œå³ç”±å®¹å™¨åŠ¨æ€çš„å°†æŸç§ä¾èµ–å…³ç³»æ³¨å…¥åˆ°ç»„ä»¶ä¹‹ä¸­ã€‚

## [RabbitMQåŸºç¡€æ•™ç¨‹ï¼šFanoutäº¤æ¢å™¨ä¸å¤šæ¶ˆè´¹è€…æ¨¡å‹](https://blog.dong4j.site/posts/e954a744.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

ä½¿ç”¨åœºæ™¯ï¼šå‘å¸ƒã€è®¢é˜…æ¨¡å¼ï¼Œå‘é€ç«¯å‘é€å¹¿æ’­æ¶ˆæ¯ï¼Œå¤šä¸ªæ¥æ”¶ç«¯æ¥æ”¶ã€‚

å‰é¢æˆ‘ä»¬å®ç°äº†å·¥ä½œé˜Ÿåˆ—ï¼Œå¹¶ä¸”æˆ‘ä»¬çš„å·¥ä½œé˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªä»»åŠ¡åªä¼šå‘ç»™ä¸€ä¸ªå·¥ä½œè€…ï¼Œé™¤éæŸä¸ªå·¥ä½œè€…æœªå®Œæˆä»»åŠ¡æ„å¤–è¢«æ€æ­»ï¼Œä¼šè½¬å‘ç»™å¦å¤–çš„å·¥ä½œè€…ã€‚è¿™ç¯‡åšå®¢ä¸­ï¼Œæˆ‘ä»¬ä¼šåšä¸€äº›æ”¹å˜ï¼Œå°±æ˜¯æŠŠä¸€ä¸ªæ¶ˆæ¯å‘ç»™å¤šä¸ªæ¶ˆè´¹è€…ï¼Œè¿™ç§æ¨¡å¼ç§°ä¹‹ä¸ºå‘å¸ƒ/è®¢é˜…ï¼ˆç±»ä¼¼è§‚å¯Ÿè€…æ¨¡å¼ï¼‰ã€‚

ä¸ºäº†éªŒè¯è¿™ç§æ¨¡å¼ï¼Œæˆ‘ä»¬å‡†å¤‡æ„å»ºä¸€ä¸ªç®€å•çš„æ—¥å¿—ç³»ç»Ÿã€‚è¿™ä¸ªç³»ç»ŸåŒ…å«ä¸¤ç±»ç¨‹åºï¼Œä¸€ç±»ç¨‹åºå‘åŠ¨æ—¥å¿—ï¼Œå¦ä¸€ç±»ç¨‹åºæ¥æ”¶å’Œå¤„ç†æ—¥å¿—ã€‚  
Â Â Â Â Â Â Â Â  åœ¨æˆ‘ä»¬çš„æ—¥å¿—ç³»ç»Ÿä¸­ï¼Œæ¯ä¸€ä¸ªè¿è¡Œçš„æ¥æ”¶è€…ç¨‹åºéƒ½ä¼šæ”¶åˆ°æ—¥å¿—ã€‚ç„¶åæˆ‘ä»¬å®ç°ï¼Œä¸€ä¸ªæ¥æ”¶è€…å°†æ¥æ”¶åˆ°çš„æ•°æ®å†™åˆ°ç¡¬ç›˜ä¸Šï¼Œä¸æ­¤åŒæ—¶ï¼Œå¦ä¸€ä¸ªæ¥æ”¶è€…æŠŠæ¥æ”¶åˆ°çš„æ¶ˆæ¯å±•ç°åœ¨å±å¹•ä¸Šã€‚  
Â Â Â Â Â Â Â Â  æœ¬è´¨ä¸Šæ¥è¯´ï¼Œå°±æ˜¯å‘å¸ƒçš„æ—¥å¿—æ¶ˆæ¯ä¼šè½¬å‘ç»™æ‰€æœ‰çš„æ¥æ”¶è€…ã€‚

## è½¬å‘å™¨ï¼ˆExchangesï¼‰

å‰é¢çš„åšå®¢ä¸­æˆ‘ä»¬ä¸»è¦çš„ä»‹ç»éƒ½æ˜¯å‘é€è€…å‘é€æ¶ˆæ¯ç»™é˜Ÿåˆ—ï¼Œæ¥æ”¶è€…ä»é˜Ÿåˆ—æ¥æ”¶æ¶ˆæ¯ã€‚ä¸‹é¢æˆ‘ä»¬ä¼šå¼•å…¥**Exchanges**ï¼Œå±•ç¤º RabbitMQ çš„å®Œæ•´çš„æ¶ˆæ¯æ¨¡å‹ã€‚  
RabbitMQ æ¶ˆæ¯æ¨¡å‹çš„æ ¸å¿ƒç†å¿µæ˜¯ç”Ÿäº§è€…æ°¸è¿œä¸ä¼šç›´æ¥å‘é€ä»»ä½•æ¶ˆæ¯ç»™é˜Ÿåˆ—ï¼Œä¸€èˆ¬çš„æƒ…å†µç”Ÿäº§è€…ç”šè‡³ä¸çŸ¥é“æ¶ˆæ¯åº”è¯¥å‘é€åˆ°å“ªäº›é˜Ÿåˆ—ã€‚  
ç›¸åçš„ï¼Œç”Ÿäº§è€…åªèƒ½å‘é€æ¶ˆæ¯ç»™è½¬å‘å™¨ï¼ˆExchangeï¼‰ã€‚è½¬å‘å™¨æ˜¯éå¸¸ç®€å•çš„ï¼Œä¸€è¾¹æ¥æ”¶ä»ç”Ÿäº§è€…å‘æ¥çš„æ¶ˆæ¯ï¼Œå¦ä¸€è¾¹æŠŠæ¶ˆæ¯æ¨é€åˆ°é˜Ÿåˆ—ä¸­ã€‚è½¬å‘å™¨å¿…é¡»æ¸…æ¥šçš„çŸ¥é“æ¶ˆæ¯å¦‚ä½•å¤„ç†å®ƒæ”¶åˆ°çš„æ¯ä¸€æ¡æ¶ˆæ¯ã€‚æ˜¯å¦åº”è¯¥è¿½åŠ åˆ°ä¸€ä¸ªæŒ‡å®šçš„é˜Ÿåˆ—ï¼Ÿæ˜¯å¦åº”è¯¥è¿½åŠ åˆ°å¤šä¸ªé˜Ÿåˆ—ï¼Ÿæˆ–è€…æ˜¯å¦åº”è¯¥ä¸¢å¼ƒï¼Ÿè¿™äº›è§„åˆ™é€šè¿‡è½¬å‘å™¨çš„ç±»å‹è¿›è¡Œå®šä¹‰ã€‚

ä¸‹é¢åˆ—å‡ºä¸€äº›å¯ç”¨çš„è½¬å‘å™¨ç±»å‹ï¼š

### Direct

å®Œå…¨æ ¹æ® key è¿›è¡ŒæŠ•é€’

ä»»ä½•å‘é€åˆ° Direct Exchange çš„æ¶ˆæ¯éƒ½ä¼šè¢«è½¬å‘åˆ° RouteKey ä¸­æŒ‡å®šçš„ Queueã€‚

1. ä¸€èˆ¬æƒ…å†µå¯ä»¥ä½¿ç”¨ rabbitMQ è‡ªå¸¦çš„ Exchangeï¼šâ€"(è¯¥ Exchange çš„åå­—ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œä¸‹æ–‡ç§°å…¶ä¸º default Exchange)ã€‚
2. è¿™ç§æ¨¡å¼ä¸‹ä¸éœ€è¦å°† Exchange è¿›è¡Œä»»ä½•ç»‘å®š (binding) æ“ä½œ
3. æ¶ˆæ¯ä¼ é€’æ—¶éœ€è¦ä¸€ä¸ªâ€œRouteKeyâ€ï¼Œå¯ä»¥ç®€å•çš„ç†è§£ä¸ºè¦å‘é€åˆ°çš„é˜Ÿåˆ—åå­—ã€‚
4. å¦‚æœ vhost ä¸­ä¸å­˜åœ¨ RouteKey ä¸­æŒ‡å®šçš„é˜Ÿåˆ—åï¼Œåˆ™è¯¥æ¶ˆæ¯ä¼šè¢«æŠ›å¼ƒã€‚

### Topic

å¯¹ key è¿›è¡Œæ¨¡å¼åŒ¹é…åè¿›è¡ŒæŠ•é€’

ä»»ä½•å‘é€åˆ° Topic Exchange çš„æ¶ˆæ¯éƒ½ä¼šè¢«è½¬å‘åˆ°æ‰€æœ‰å…³å¿ƒ RouteKey ä¸­æŒ‡å®šè¯é¢˜çš„ Queue ä¸Š

1. è¿™ç§æ¨¡å¼è¾ƒä¸ºå¤æ‚ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯æ¯ä¸ªé˜Ÿåˆ—éƒ½æœ‰å…¶å…³å¿ƒçš„ä¸»é¢˜ï¼Œæ‰€æœ‰çš„æ¶ˆæ¯éƒ½å¸¦æœ‰ä¸€ä¸ªâ€œæ ‡é¢˜â€(RouteKey)ï¼ŒExchange ä¼šå°†æ¶ˆæ¯è½¬å‘åˆ°æ‰€æœ‰å…³æ³¨ä¸»é¢˜èƒ½ä¸ RouteKey æ¨¡ç³ŠåŒ¹é…çš„é˜Ÿåˆ—ã€‚
2. è¿™ç§æ¨¡å¼éœ€è¦ RouteKeyï¼Œä¹Ÿè®¸è¦æå‰ç»‘å®š Exchange ä¸ Queueã€‚
3. åœ¨è¿›è¡Œç»‘å®šæ—¶ï¼Œè¦æä¾›ä¸€ä¸ªè¯¥é˜Ÿåˆ—å…³å¿ƒçš„ä¸»é¢˜ï¼Œå¦‚â€œ#.log.#â€è¡¨ç¤ºè¯¥é˜Ÿåˆ—å…³å¿ƒæ‰€æœ‰æ¶‰åŠ log çš„æ¶ˆæ¯ (ä¸€ä¸ª RouteKey ä¸ºâ€MQ.log.errorâ€çš„æ¶ˆæ¯ä¼šè¢«è½¬å‘åˆ°è¯¥é˜Ÿåˆ—)ã€‚
4. â€œ#â€è¡¨ç¤º 0 ä¸ªæˆ–è‹¥å¹²ä¸ªå…³é”®å­—ï¼Œâ€œ_â€è¡¨ç¤ºä¸€ä¸ªå…³é”®å­—ã€‚å¦‚â€œlog._â€èƒ½ä¸â€œlog.warnâ€åŒ¹é…ï¼Œæ— æ³•ä¸â€œlog.warn.timeoutâ€åŒ¹é…ï¼›ä½†æ˜¯â€œlog.#â€èƒ½ä¸ä¸Šè¿°ä¸¤è€…åŒ¹é…ã€‚
5. åŒæ ·ï¼Œå¦‚æœ Exchange æ²¡æœ‰å‘ç°èƒ½å¤Ÿä¸ RouteKey åŒ¹é…çš„ Queueï¼Œåˆ™ä¼šæŠ›å¼ƒæ­¤æ¶ˆæ¯ã€‚

### Headers

### Fanout

ä¸éœ€è¦ key,é‡‡å–å¹¿æ’­æ¨¡å¼ï¼Œä¸€ä¸ªæ¶ˆæ¯è¿›æ¥æ—¶ï¼ŒæŠ•é€’åˆ°ä¸è¯¥äº¤æ¢æœºç»‘å®šçš„æ‰€æœ‰é˜Ÿåˆ—ã€‚

ä»»ä½•å‘é€åˆ° Fanout Exchange çš„æ¶ˆæ¯éƒ½ä¼šè¢«è½¬å‘åˆ°ä¸è¯¥ Exchange ç»‘å®š (Binding) çš„æ‰€æœ‰ Queue ä¸Šã€‚

1. å¯ä»¥ç†è§£ä¸ºè·¯ç”±è¡¨çš„æ¨¡å¼
2. è¿™ç§æ¨¡å¼ä¸éœ€è¦ RouteKey
3. è¿™ç§æ¨¡å¼éœ€è¦æå‰å°† Exchange ä¸ Queue è¿›è¡Œç»‘å®šï¼Œä¸€ä¸ª Exchange å¯ä»¥ç»‘å®šå¤šä¸ª Queueï¼Œä¸€ä¸ª Queue å¯ä»¥åŒå¤šä¸ª Exchange è¿›è¡Œç»‘å®šã€‚
4. å¦‚æœæ¥å—åˆ°æ¶ˆæ¯çš„ Exchange æ²¡æœ‰ä¸ä»»ä½• Queue ç»‘å®šï¼Œåˆ™æ¶ˆæ¯ä¼šè¢«æŠ›å¼ƒã€‚

ç›®å‰æˆ‘ä»¬å…³æ³¨æœ€åä¸€ä¸ª fanoutï¼Œå£°æ˜è½¬å‘å™¨ç±»å‹çš„ä»£ç ï¼š  
`channel.exchangeDeclare("logs","fanout");`  
fanout ç±»å‹è½¬å‘å™¨ç‰¹åˆ«ç®€å•ï¼ŒæŠŠæ‰€æœ‰å®ƒä»‹ç»åˆ°çš„æ¶ˆæ¯ï¼Œå¹¿æ’­åˆ°æ‰€æœ‰å®ƒæ‰€çŸ¥é“çš„é˜Ÿåˆ—ã€‚ä¸è¿‡è¿™æ­£æ˜¯æˆ‘ä»¬å‰è¿°çš„æ—¥å¿—ç³»ç»Ÿæ‰€éœ€è¦çš„ã€‚

### åŒ¿åè½¬å‘å™¨ï¼ˆnameless exchangeï¼‰

å‰é¢è¯´åˆ°ç”Ÿäº§è€…åªèƒ½å‘é€æ¶ˆæ¯ç»™è½¬å‘å™¨ï¼ˆExchangeï¼‰ï¼Œä½†æ˜¯æˆ‘ä»¬å‰ä¸¤ç¯‡åšå®¢ä¸­çš„ä¾‹å­å¹¶æ²¡æœ‰ä½¿ç”¨åˆ°è½¬å‘å™¨ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªé»˜è®¤çš„è½¬å‘å™¨ï¼Œå®ƒçš„æ ‡è¯†ç¬¦ä¸ºâ€â€ã€‚ä¹‹å‰å‘é€æ¶ˆæ¯çš„ä»£ç ï¼š  
`channel.basicPublish("", QUEUE_NAME,MessageProperties.PERSISTENT_TEXT_PLAIN, message.getBytes());`  
ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºè½¬å‘å™¨çš„åç§°ï¼Œæˆ‘ä»¬è®¾ç½®ä¸ºâ€â€ : å¦‚æœå­˜åœ¨ routingKeyï¼ˆç¬¬äºŒä¸ªå‚æ•°ï¼‰ï¼Œæ¶ˆæ¯ç”± routingKey å†³å®šå‘é€åˆ°å“ªä¸ªé˜Ÿåˆ—ã€‚  
ç°åœ¨æˆ‘ä»¬å¯ä»¥æŒ‡å®šæ¶ˆæ¯å‘é€åˆ°çš„è½¬å‘å™¨ï¼š  
`channel.basicPublish( "logs","", null, message.getBytes());`

### ä¸´æ—¶é˜Ÿåˆ—ï¼ˆTemporary queuesï¼‰

å‰é¢çš„åšå®¢ä¸­æˆ‘ä»¬éƒ½ä¸ºé˜Ÿåˆ—æŒ‡å®šäº†ä¸€ä¸ªç‰¹å®šçš„åç§°ã€‚èƒ½å¤Ÿä¸ºé˜Ÿåˆ—å‘½åå¯¹æˆ‘ä»¬æ¥è¯´æ˜¯å¾ˆå…³é”®çš„ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šæ¶ˆè´¹è€…ä¸ºæŸä¸ªé˜Ÿåˆ—ã€‚å½“æˆ‘ä»¬å¸Œæœ›åœ¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é—´å…±äº«é˜Ÿåˆ—æ—¶ï¼Œä¸ºé˜Ÿåˆ—å‘½åæ˜¯å¾ˆé‡è¦çš„ã€‚ä¸è¿‡ï¼Œå¯¹äºæˆ‘ä»¬çš„æ—¥å¿—ç³»ç»Ÿæˆ‘ä»¬å¹¶ä¸å…³å¿ƒé˜Ÿåˆ—çš„åç§°ã€‚æˆ‘ä»¬æƒ³è¦æ¥æ”¶åˆ°æ‰€æœ‰çš„æ¶ˆæ¯ï¼Œè€Œä¸”æˆ‘ä»¬ä¹Ÿåªå¯¹å½“å‰æ­£åœ¨ä¼ é€’çš„æ•°æ®çš„æ„Ÿå…´è¶£ã€‚ä¸ºäº†æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œéœ€è¦åšä¸¤ä»¶äº‹ï¼š

1. æ— è®ºä»€ä¹ˆæ—¶é—´è¿æ¥åˆ° Rabbit æˆ‘ä»¬éƒ½éœ€è¦ä¸€ä¸ªæ–°çš„ç©ºçš„é˜Ÿåˆ—ã€‚ä¸ºäº†å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨éšæœºæ•°åˆ›å»ºé˜Ÿåˆ—ï¼Œæˆ–è€…æ›´å¥½çš„ï¼Œè®©æœåŠ¡å™¨ç»™æˆ‘ä»¬æä¾›ä¸€ä¸ªéšæœºçš„åç§°ã€‚
2. ä¸€æ—¦æ¶ˆè´¹è€…ä¸ Rabbit æ–­å¼€ï¼Œæ¶ˆè´¹è€…æ‰€æ¥æ”¶çš„é‚£ä¸ªé˜Ÿåˆ—åº”è¯¥è¢«è‡ªåŠ¨åˆ é™¤ã€‚Java ä¸­æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ queueDeclare() æ–¹æ³•ï¼Œä¸ä¼ é€’ä»»ä½•å‚æ•°ï¼Œæ¥åˆ›å»ºä¸€ä¸ªéæŒä¹…çš„ã€å”¯ä¸€çš„ã€è‡ªåŠ¨åˆ é™¤çš„é˜Ÿåˆ—ä¸”é˜Ÿåˆ—åç§°ç”±æœåŠ¡å™¨éšæœºäº§ç”Ÿã€‚  
   `String queueName = channel.queueDeclare().getQueue();`ä¸€èˆ¬æƒ…å†µè¿™ä¸ªåç§°ä¸ amq.gen-JzTY20BRgKO-HjmUJj0wLg ç±»ä¼¼ã€‚

### ç»‘å®šï¼ˆBindingsï¼‰

æˆ‘ä»¬å·²ç»åˆ›å»ºäº†ä¸€ä¸ª fanout è½¬å‘å™¨å’Œé˜Ÿåˆ—ï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦é€šè¿‡ binding å‘Šè¯‰è½¬å‘å™¨æŠŠæ¶ˆæ¯å‘é€ç»™æˆ‘ä»¬çš„é˜Ÿåˆ—ã€‚  
`channel.queueBind(queueName, â€œlogsâ€, â€â€)` å‚æ•° 1ï¼šé˜Ÿåˆ—åç§° ï¼›å‚æ•° 2ï¼šè½¬å‘å™¨åç§°

### å®Œæ•´çš„ä¾‹å­

ç”Ÿäº§è€…:

```java
public class EmitLog {
    private final static String EXCHANGE_NAME = "ex_log";

    public static void main(String[] args) throws IOException {
        // åˆ›å»ºè¿æ¥å’Œé¢‘é“
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        Connection connection = factory.newConnection();
        Channel    channel    = connection.createChannel();
        // å£°æ˜è½¬å‘å™¨å’Œç±»å‹
        channel.exchangeDeclare(EXCHANGE_NAME, "fanout");

        String message = new Date().toLocaleString() + " : log something";
        // å¾€è½¬å‘å™¨ä¸Šå‘é€æ¶ˆæ¯
        channel.basicPublish(EXCHANGE_NAME, "", null, message.getBytes());

        System.out.println(" [x] Sent '" + message + "'");

        channel.close();
        connection.close();
    }
}
```

æ¶ˆè´¹è€… 1:

```java
public class ReceiveLogsToSave {
    private final static String EXCHANGE_NAME = "ex_log";

    public static void main(String[] argv) throws java.io.IOException,
            java.lang.InterruptedException {
        // åˆ›å»ºè¿æ¥å’Œé¢‘é“
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        Connection connection = factory.newConnection();
        Channel    channel    = connection.createChannel();

        channel.exchangeDeclare(EXCHANGE_NAME, "fanout");
        // åˆ›å»ºä¸€ä¸ªéæŒä¹…çš„ã€å”¯ä¸€çš„ä¸”è‡ªåŠ¨åˆ é™¤çš„é˜Ÿåˆ—
        String queueName = channel.queueDeclare().getQueue();
        // ä¸ºè½¬å‘å™¨æŒ‡å®šé˜Ÿåˆ—ï¼Œè®¾ç½®binding
        channel.queueBind(queueName, EXCHANGE_NAME, "");

        System.out.println(" [*] Waiting for messages. To exit press CTRL+C");

        QueueingConsumer consumer = new QueueingConsumer(channel);
        // æŒ‡å®šæ¥æ”¶è€…ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºè‡ªåŠ¨åº”ç­”ï¼Œæ— éœ€æ‰‹åŠ¨åº”ç­”
        channel.basicConsume(queueName, true, consumer);

        while (true) {
            QueueingConsumer.Delivery delivery = consumer.nextDelivery();
            String                    message  = new String(delivery.getBody());

            print2File(message);
        }
    }

    private static void print2File(String msg) {
        try {
            String dir = ReceiveLogsToSave.class.getClassLoader().getResource("").getPath();
            System.out.println(dir);
            String logFileName = new SimpleDateFormat("yyyy-MM-dd")
                    .format(new Date());
            File             file = new File(dir, logFileName + ".txt");
            FileOutputStream fos  = new FileOutputStream(file, true);
            fos.write((msg + "\r\n").getBytes());
            fos.flush();
            fos.close();
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

æ¶ˆè´¹è€… 2:

```java
public class ReceiveLogsToConsole {
    private final static String EXCHANGE_NAME = "ex_log";

    public static void main(String[] argv) throws java.io.IOException,
            java.lang.InterruptedException {
        // åˆ›å»ºè¿æ¥å’Œé¢‘é“
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        Connection connection = factory.newConnection();
        Channel    channel    = connection.createChannel();
        channel.exchangeDeclare(EXCHANGE_NAME, "fanout");
        // åˆ›å»ºä¸€ä¸ªéæŒä¹…çš„ã€å”¯ä¸€çš„ä¸”è‡ªåŠ¨åˆ é™¤çš„é˜Ÿåˆ—
        String queueName = channel.queueDeclare().getQueue();
        // ä¸ºè½¬å‘å™¨æŒ‡å®šé˜Ÿåˆ—ï¼Œè®¾ç½®binding
        channel.queueBind(queueName, EXCHANGE_NAME, "");
        System.out.println(" [*] Waiting for messages. To exit press CTRL+C");
        QueueingConsumer consumer = new QueueingConsumer(channel);
        // æŒ‡å®šæ¥æ”¶è€…ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºè‡ªåŠ¨åº”ç­”ï¼Œæ— éœ€æ‰‹åŠ¨åº”ç­”
        channel.basicConsume(queueName, true, consumer);
        while (true) {
            QueueingConsumer.Delivery delivery = consumer.nextDelivery();
            String                    message  = new String(delivery.getBody());
            System.out.println(" [x] Received '" + message + "'");
        }
    }
}
```

## [ä»è½®è¯¢åˆ°å…¬å¹³ï¼šRabbitMQçš„æ¶ˆæ¯é˜Ÿåˆ—ç­–ç•¥](https://blog.dong4j.site/posts/ab083149.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

> å·¥ä½œé˜Ÿåˆ—çš„ä¸»è¦ä»»åŠ¡æ˜¯ï¼šé¿å…ç«‹åˆ»æ‰§è¡Œèµ„æºå¯†é›†å‹ä»»åŠ¡ï¼Œç„¶åå¿…é¡»ç­‰å¾…å…¶å®Œæˆã€‚ç›¸ååœ°ï¼Œæˆ‘ä»¬è¿›è¡Œä»»åŠ¡è°ƒåº¦ï¼šæˆ‘ä»¬æŠŠä»»åŠ¡å°è£…ä¸ºæ¶ˆæ¯å‘é€ç»™é˜Ÿåˆ—ã€‚å·¥ä½œè¿›è¡Œåœ¨åå°è¿è¡Œå¹¶ä¸æ–­çš„ä»é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡ç„¶åæ‰§è¡Œã€‚å½“ä½ è¿è¡Œäº†å¤šä¸ªå·¥ä½œè¿›ç¨‹æ—¶ï¼Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å°†ä¼šè¢«å·¥ä½œè¿›ç¨‹å…±äº«æ‰§è¡Œã€‚  
> è¿™æ ·çš„æ¦‚å¿µåœ¨ web åº”ç”¨ä¸­æå…¶æœ‰ç”¨ï¼Œå½“åœ¨å¾ˆçŸ­çš„ HTTP è¯·æ±‚é—´éœ€è¦æ‰§è¡Œå¤æ‚çš„ä»»åŠ¡

ç”Ÿäº§è€…:

```java
public class NewTask {
    //é˜Ÿåˆ—åç§°
    private final static String QUEUE_NAME = "workqueue";
    public static void main(String[] args) throws IOException
    {
        //åˆ›å»ºè¿æ¥å’Œé¢‘é“
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        Connection connection = factory.newConnection();
        Channel    channel    = connection.createChannel();
        //å£°æ˜é˜Ÿåˆ—
        channel.queueDeclare(QUEUE_NAME, false, false, false, null);
        //å‘é€10æ¡æ¶ˆæ¯ï¼Œä¾æ¬¡åœ¨æ¶ˆæ¯åé¢é™„åŠ 1-10ä¸ªç‚¹
        for (int i = 0; i < 10; i++)
        {
            String dots = "";
            for (int j = 0; j <= i; j++)
            {
                dots += ".";
            }
            String message = "helloworld" + dots+dots.length();
            channel.basicPublish("", QUEUE_NAME, null, message.getBytes());
            System.out.println(" [x] Sent '" + message + "'");
        }
        //å…³é—­é¢‘é“å’Œèµ„æº
        channel.close();
        connection.close();
    }
}
```

æ¶ˆè´¹è€… 1:

```java
public class Work_1 {
    //é˜Ÿåˆ—åç§°
    private final static String QUEUE_NAME = "workqueue";

    public static void main(String[] argv) throws java.io.IOException,
            java.lang.InterruptedException
    {
        //åŒºåˆ†ä¸åŒå·¥ä½œè¿›ç¨‹çš„è¾“å‡º
        int hashCode = Work.class.hashCode();
        //åˆ›å»ºè¿æ¥å’Œé¢‘é“
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        Connection connection = factory.newConnection();
        Channel    channel    = connection.createChannel();
        //å£°æ˜é˜Ÿåˆ—
        channel.queueDeclare(QUEUE_NAME, false, false, false, null);
        System.out.println(hashCode
                                   + " [*] Waiting for messages. To exit press CTRL+C");
        QueueingConsumer consumer = new QueueingConsumer(channel);
        // æŒ‡å®šæ¶ˆè´¹é˜Ÿåˆ—
        // å…³é—­æ¶ˆæ¯åº”ç­”æœºåˆ¶
        boolean ack = true;
        channel.basicConsume(QUEUE_NAME, ack, consumer);
        while (true)
        {
            QueueingConsumer.Delivery delivery = consumer.nextDelivery();
            String message = new String(delivery.getBody());
            System.out.println(hashCode + " [x] Received '" + message + "'");
            doWork(message);
            System.out.println(hashCode + " [x] Done");
        }
    }

    /**
     * æ¯ä¸ªç‚¹è€—æ—¶1s
     * @param task
     * @throws InterruptedException
     */
    private static void doWork(String task) throws InterruptedException
    {
        for (char ch : task.toCharArray())
        {
            if (ch == '.')
                Thread.sleep(1000);
        }
    }
}

```

æ¶ˆè´¹è€… 2:

```java
public class Work_2 {
    //é˜Ÿåˆ—åç§°
    private final static String QUEUE_NAME = "workqueue";

    public static void main(String[] argv) throws java.io.IOException,
            java.lang.InterruptedException
    {
        //åŒºåˆ†ä¸åŒå·¥ä½œè¿›ç¨‹çš„è¾“å‡º
        int hashCode = Work.class.hashCode();
        //åˆ›å»ºè¿æ¥å’Œé¢‘é“
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        Connection connection = factory.newConnection();
        Channel    channel    = connection.createChannel();
        //å£°æ˜é˜Ÿåˆ—
        channel.queueDeclare(QUEUE_NAME, false, false, false, null);
        System.out.println(hashCode
                                   + " [*] Waiting for messages. To exit press CTRL+C");
        QueueingConsumer consumer = new QueueingConsumer(channel);
        // æŒ‡å®šæ¶ˆè´¹é˜Ÿåˆ—
        // å…³é—­æ¶ˆæ¯åº”ç­”æœºåˆ¶
        boolean ack = true;
        channel.basicConsume(QUEUE_NAME, ack, consumer);
        while (true)
        {
            QueueingConsumer.Delivery delivery = consumer.nextDelivery();
            String message = new String(delivery.getBody());
            System.out.println(hashCode + " [x] Received '" + message + "'");
            doWork(message);
            System.out.println(hashCode + " [x] Done");
        }
    }

    /**
     * æ¯ä¸ªç‚¹è€—æ—¶1s
     * @param task
     * @throws InterruptedException
     */
    private static void doWork(String task) throws InterruptedException
    {
        for (char ch : task.toCharArray())
        {
            if (ch == '.')
                Thread.sleep(1000);
        }
    }
}
```

æ‰§è¡Œç»“æœ  
æ¶ˆè´¹è€… 1:  
`

```
895328852 [*] Waiting for messages. To exit press CTRL+C
895328852 [x] Received 'helloworld.1'
895328852 [x] Done
895328852 [x] Received 'helloworldâ€¦3'
895328852 [x] Done
895328852 [x] Received 'helloworldâ€¦..5'
895328852 [x] Done
895328852 [x] Received 'helloworldâ€¦â€¦.7'
895328852 [x] Done
895328852 [x] Received 'helloworldâ€¦â€¦â€¦9'
```

æ¶ˆè´¹è€… 2:

```
1581781576 [*] Waiting for messages. To exit press CTRL+C
1581781576 [x] Received 'helloworld..2'
1581781576 [x] Done
1581781576 [x] Received 'helloworldâ€¦.4'
1581781576 [x] Done
1581781576 [x] Received 'helloworldâ€¦â€¦6'
1581781576 [x] Done
1581781576 [x] Received 'helloworldâ€¦â€¦..8'
1581781576 [x] Done
1581781576 [x] Received 'helloworldâ€¦â€¦â€¦.10'
1581781576 [x] Done
```

### å€¼å¾—æ³¨æ„çš„å‡ ç‚¹

1. é»˜è®¤çš„ï¼ŒRabbitMQ ä¼šä¸€ä¸ªä¸€ä¸ªçš„å‘é€ä¿¡æ¯ç»™ä¸‹ä¸€ä¸ªæ¶ˆè´¹è€… (consumer)ï¼Œè€Œä¸è€ƒè™‘æ¯ä¸ªä»»åŠ¡çš„æ—¶é•¿ç­‰ç­‰ï¼Œä¸”æ˜¯**ä¸€æ¬¡æ€§åˆ†é…**ï¼Œå¹¶éä¸€ä¸ªä¸€ä¸ªåˆ†é…ã€‚å¹³å‡çš„æ¯ä¸ªæ¶ˆè´¹è€…å°†ä¼šè·å¾—ç›¸ç­‰æ•°é‡çš„æ¶ˆæ¯ã€‚è¿™æ ·åˆ†å‘æ¶ˆæ¯çš„æ–¹å¼å«åš**round-robin**,å³**è½®è¯¢è°ƒåº¦**ã€‚
2. æ‰§è¡Œä¸€ä¸ªä»»åŠ¡éœ€è¦èŠ±è´¹å‡ ç§’é’Ÿã€‚ä½ å¯èƒ½ä¼šæ‹…å¿ƒå½“ä¸€ä¸ªå·¥ä½œè€…åœ¨æ‰§è¡Œä»»åŠ¡æ—¶å‘ç”Ÿä¸­æ–­ã€‚æˆ‘ä»¬ä¸Šé¢çš„ä»£ç ï¼Œä¸€æ—¦ RabbItMQ äº¤ä»˜äº†ä¸€ä¸ªä¿¡æ¯ç»™æ¶ˆè´¹è€…ï¼Œä¼šé©¬ä¸Šä»å†…å­˜ä¸­ç§»é™¤è¿™ä¸ªä¿¡æ¯ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ€æ­»æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„æŸä¸ªå·¥ä½œè€…ï¼Œæˆ‘ä»¬ä¼šä¸¢å¤±å®ƒæ­£åœ¨å¤„ç†çš„ä¿¡æ¯ã€‚æˆ‘ä»¬ä¹Ÿä¼šä¸¢å¤±å·²ç»è½¬å‘ç»™è¿™ä¸ªå·¥ä½œè€…ä¸”å®ƒè¿˜æœªæ‰§è¡Œçš„æ¶ˆæ¯ã€‚
3. å½“æˆ‘ä»¬æ€æ­»ä¸€ä¸ªæ­£åœ¨å·¥ä½œçš„è¿›ç¨‹æ—¶,åˆ†é…ç»™è¯¥è¿›ç¨‹çš„ä»»åŠ¡å°±ä¸ä¼šæ‰§è¡Œ,ä»è€Œä¸¢å¤±æ¶ˆæ¯.ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µå‘ç”Ÿ, RabbitMQ ä½¿ç”¨äº†æ¶ˆæ¯åº”ç­”ï¼ˆmessage acknowledgments),æ¶ˆè´¹è€…å‘é€åº”ç­”ç»™ RabbitMQï¼Œå‘Šè¯‰å®ƒä¿¡æ¯å·²ç»è¢«æ¥æ”¶å’Œå¤„ç†ï¼Œç„¶å RabbitMQ å¯ä»¥è‡ªç”±çš„è¿›è¡Œä¿¡æ¯åˆ é™¤ã€‚

## æ¶ˆæ¯åº”ç­”æœºåˆ¶ ï¼ˆmessage acknowledgmentsï¼‰

å¦‚æœæ¶ˆè´¹è€…è¢«æ€æ­»è€Œæ²¡æœ‰å‘é€åº”ç­”ï¼ŒRabbitMQ ä¼šè®¤ä¸ºè¯¥ä¿¡æ¯æ²¡æœ‰è¢«å®Œå…¨çš„å¤„ç†ï¼Œç„¶åå°†ä¼š**é‡æ–°è½¬å‘ç»™åˆ«çš„æ¶ˆè´¹è€…**ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥ç¡®è®¤ä¿¡æ¯ä¸ä¼šè¢«ä¸¢å¤±ï¼Œå³ä½¿æ¶ˆè€…å¶å°”è¢«æ€æ­»ã€‚  
è¿™ç§æœºåˆ¶å¹¶æ²¡æœ‰è¶…æ—¶æ—¶é—´è¿™ä¹ˆä¸€è¯´ï¼ŒRabbitMQ åªæœ‰åœ¨æ¶ˆè´¹è€…è¿æ¥æ–­å¼€æ—¶é‡æ–°è½¬å‘æ­¤ä¿¡æ¯ã€‚å¦‚æœæ¶ˆè´¹è€…å¤„ç†ä¸€ä¸ªä¿¡æ¯éœ€è¦è€—è´¹ç‰¹åˆ«ç‰¹åˆ«é•¿çš„æ—¶é—´æ˜¯å…è®¸çš„ã€‚

boolean ack = false; // å¼€å¯æ¶ˆæ¯åº”ç­”  
ä¿®æ”¹åçš„è¾“å‡ºç»“æœ:  
æ¶ˆè´¹è€… 1:(ä¸­é€”ä¸­æ–­)

```
895328852 [*] Waiting for messages. To exit press CTRL+C
895328852 [x] Received 'helloworld.1'
895328852 [x] Done
895328852 [x] Received 'helloworldâ€¦3'
```

Process finished with exit code 130

æ¶ˆè´¹è€… 2:

```
1581781576 [*] Waiting for messages. To exit press CTRL+C
1581781576 [x] Received 'helloworld..2'
1581781576 [x] Done
1581781576 [x] Received 'helloworldâ€¦.4'
1581781576 [x] Done
1581781576 [x] Received 'helloworldâ€¦â€¦6'
1581781576 [x] Done
1581781576 [x] Received 'helloworldâ€¦â€¦..8'
1581781576 [x] Done
1581781576 [x] Received 'helloworldâ€¦â€¦â€¦.10'
1581781576 [x] Done
1581781576 [x] Received 'helloworld.1'
1581781576 [x] Done
1581781576 [x] Received 'helloworldâ€¦3'
1581781576 [x] Done
1581781576 [x] Received 'helloworldâ€¦..5'
1581781576 [x] Done
1581781576 [x] Received 'helloworldâ€¦â€¦.7'
1581781576 [x] Done
1581781576 [x] Received 'helloworldâ€¦â€¦â€¦9'
1581781576 [x] Done
```

### å€¼å¾—æ³¨æ„çš„å‡ ç‚¹:

1. åœ¨æ¶ˆè´¹è€… 1 æ‰§è¡Œåˆ°ç¬¬ 2 ä¸ªä»»åŠ¡æ—¶ä¸­æ–­äº†,æ¶ˆè´¹è€…æ‰§è¡Œå®Œåˆ†é…çš„ä»»åŠ¡å,å¼€å§‹æ‰§è¡Œåˆ†é…ç»™æ¶ˆè´¹è€… 1 çš„ä»»åŠ¡
2. ä»»åŠ¡é‡å¤æ‰§è¡Œäº†
3. å½“å¼€å¯äº†æ¶ˆæ¯åº”ç­”çš„æ¶ˆè´¹è€…ä»»åŠ¡ä¸­æ–­å,æ­¤æ¶ˆè´¹è€…çš„ä»»åŠ¡ä¼šé‡æ–°åˆ†é…ç»™å…¶ä»–æ¶ˆè´¹è€…,ä¸”æ˜¯ä¸€æ¬¡åˆ†é…,ä¸”ä¸ç®¡æ˜¯å¦å·²ç»å®Œæˆçš„å·¥ä½œ,éƒ½ä¼šåˆ†é…ç»™å…¶ä»–æ¶ˆè´¹è€…

## æ¶ˆæ¯æŒä¹…åŒ–ï¼ˆMessage durabilityï¼‰

é€šè¿‡æ¶ˆæ¯åº”ç­”æœºåˆ¶,å³ä½¿æ¶ˆè´¹è€…è¢«æ€æ­»ï¼Œæ¶ˆæ¯ä¹Ÿä¸ä¼šè¢«ä¸¢å¤±ã€‚ä½†æ˜¯å¦‚æœæ­¤æ—¶ RabbitMQ æœåŠ¡è¢«åœæ­¢ï¼Œæˆ‘ä»¬çš„æ¶ˆæ¯ä»ç„¶ä¼šä¸¢å¤±ã€‚  
å½“ RabbitMQ é€€å‡ºæˆ–è€…å¼‚å¸¸é€€å‡ºï¼Œå°†ä¼šä¸¢å¤±æ‰€æœ‰çš„é˜Ÿåˆ—å’Œä¿¡æ¯ï¼Œé™¤éä½ å‘Šè¯‰å®ƒä¸è¦ä¸¢å¤±ã€‚æˆ‘ä»¬éœ€è¦åšä¸¤ä»¶äº‹æ¥ç¡®ä¿ä¿¡æ¯ä¸ä¼šè¢«ä¸¢å¤±ï¼šæˆ‘ä»¬éœ€è¦ç»™æ‰€æœ‰çš„é˜Ÿåˆ—å’Œæ¶ˆæ¯è®¾ç½®æŒä¹…åŒ–çš„æ ‡å¿—ã€‚

1. æˆ‘ä»¬éœ€è¦ç¡®è®¤ RabbitMQ æ°¸è¿œä¸ä¼šä¸¢å¤±æˆ‘ä»¬çš„é˜Ÿåˆ—ã€‚ä¸ºäº†è¿™æ ·ï¼Œæˆ‘ä»¬éœ€è¦å£°æ˜å®ƒä¸ºæŒä¹…åŒ–çš„ã€‚  
   boolean durable = true;  
   channel.queueDeclare("task_queue", durable, false, false, null);  
   æ³¨ï¼šRabbitMQ ä¸å…è®¸ä½¿ç”¨ä¸åŒçš„å‚æ•°é‡æ–°å®šä¹‰ä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ‰€ä»¥å·²ç»å­˜åœ¨çš„é˜Ÿåˆ—ï¼Œæˆ‘ä»¬æ— æ³•ä¿®æ”¹å…¶å±æ€§ã€‚

2. æˆ‘ä»¬éœ€è¦æ ‡è¯†æˆ‘ä»¬çš„ä¿¡æ¯ä¸ºæŒä¹…åŒ–çš„ã€‚é€šè¿‡è®¾ç½® MessagePropertiesï¼ˆimplements BasicPropertiesï¼‰å€¼ä¸º PERSISTENT_TEXT_PLAINã€‚  
   channel.basicPublish("", "task_queue",MessageProperties.PERSISTENT_TEXT_PLAIN,message.getBytes());  
   ç°åœ¨ä½ å¯ä»¥æ‰§è¡Œä¸€ä¸ªå‘é€æ¶ˆæ¯çš„ç¨‹åºï¼Œç„¶åå…³é—­æœåŠ¡ï¼Œå†é‡æ–°å¯åŠ¨æœåŠ¡ï¼Œè¿è¡Œæ¶ˆè´¹è€…ç¨‹åºåšä¸‹å®éªŒã€‚**åªæœ‰ç¬¬ä¸€ä¸ªæ¶ˆè´¹è€…æ‰ä¼šå¤„ç†æ¶ˆæ¯**.

## å…¬å¹³è½¬å‘ï¼ˆFair dispatchï¼‰

æˆ–è®¸ä¼šå‘ç°ï¼Œç›®å‰çš„æ¶ˆæ¯è½¬å‘æœºåˆ¶ï¼ˆRound-robinï¼‰å¹¶éæ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚ä¾‹å¦‚ï¼Œè¿™æ ·ä¸€ç§æƒ…å†µï¼Œå¯¹äºä¸¤ä¸ªæ¶ˆè´¹è€…ï¼Œæœ‰ä¸€ç³»åˆ—çš„ä»»åŠ¡ï¼Œå¥‡æ•°ä»»åŠ¡ç‰¹åˆ«è€—æ—¶ï¼Œè€Œå¶æ•°ä»»åŠ¡å´å¾ˆè½»æ¾ï¼Œè¿™æ ·é€ æˆä¸€ä¸ªæ¶ˆè´¹è€…ä¸€ç›´ç¹å¿™ï¼Œå¦ä¸€ä¸ªæ¶ˆè´¹è€…å´å¾ˆå¿«æ‰§è¡Œå®Œä»»åŠ¡åç­‰å¾…ã€‚  
é€ æˆè¿™æ ·çš„åŸå› æ˜¯å› ä¸º RabbitMQ ä»…ä»…æ˜¯å½“æ¶ˆæ¯åˆ°è¾¾é˜Ÿåˆ—è¿›è¡Œè½¬å‘æ¶ˆæ¯ã€‚å¹¶ä¸åœ¨ä¹æœ‰å¤šå°‘ä»»åŠ¡æ¶ˆè´¹è€…å¹¶æœªä¼ é€’ä¸€ä¸ªåº”ç­”ç»™ RabbitMQã€‚ä»…ä»…ç›²ç›®è½¬å‘æ‰€æœ‰çš„å¥‡æ•°ç»™ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œå¶æ•°ç»™å¦ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚  
ä¸ºäº†è§£å†³è¿™æ ·çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ basicQos æ–¹æ³•ï¼Œä¼ é€’å‚æ•°ä¸º prefetchCount = 1ã€‚è¿™æ ·å‘Šè¯‰ RabbitMQ ä¸è¦åœ¨åŒä¸€æ—¶é—´ç»™ä¸€ä¸ªæ¶ˆè´¹è€…è¶…è¿‡ä¸€æ¡æ¶ˆæ¯ã€‚æ¢å¥è¯è¯´ï¼Œåªæœ‰åœ¨æ¶ˆè´¹è€…ç©ºé—²çš„æ—¶å€™ä¼šå‘é€ä¸‹ä¸€æ¡ä¿¡æ¯ã€‚

ç”Ÿäº§è€…:

```java
public class NewTask
{
    // é˜Ÿåˆ—åç§°
    private final static String QUEUE_NAME = "workqueue_persistence";
    public static void main(String[] args) throws IOException
    {
        // åˆ›å»ºè¿æ¥å’Œé¢‘é“
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        // å£°æ˜é˜Ÿåˆ—
        boolean durable = true;// 1ã€è®¾ç½®é˜Ÿåˆ—æŒä¹…åŒ–
        channel.queueDeclare(QUEUE_NAME, durable, false, false, null);
        // å‘é€10æ¡æ¶ˆæ¯ï¼Œä¾æ¬¡åœ¨æ¶ˆæ¯åé¢é™„åŠ 1-10ä¸ªç‚¹
        for (int i = 5; i > 0; i--)
        {
            String dots = "";
            for (int j = 0; j <= i; j++)
            {
                dots += ".";
            }
            String message = "helloworld" + dots + dots.length();
            // MessageProperties 2ã€è®¾ç½®æ¶ˆæ¯æŒä¹…åŒ–
            channel.basicPublish("", QUEUE_NAME,
                    MessageProperties.PERSISTENT_TEXT_PLAIN, message.getBytes());
            System.out.println(" [x] Sent '" + message + "'");
        }
        // å…³é—­é¢‘é“å’Œèµ„æº
        channel.close();
        connection.close();
    }
}
```

æ¶ˆè´¹è€… 1:

```java
public class Work_1
{
    // é˜Ÿåˆ—åç§°
    private final static String QUEUE_NAME = "workqueue_persistence";

    public static void main(String[] argv) throws java.io.IOException,
            java.lang.InterruptedException
    {
        // åŒºåˆ†ä¸åŒå·¥ä½œè¿›ç¨‹çš„è¾“å‡º
        int hashCode = Work.class.hashCode();
        // åˆ›å»ºè¿æ¥å’Œé¢‘é“
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        // å£°æ˜é˜Ÿåˆ—
        boolean durable = true;
        channel.queueDeclare(QUEUE_NAME, durable, false, false, null);
        System.out.println(hashCode
                + " [*] Waiting for messages. To exit press CTRL+C");
        //è®¾ç½®æœ€å¤§æœåŠ¡è½¬å‘æ¶ˆæ¯æ•°é‡
        int prefetchCount = 1;
        channel.basicQos(prefetchCount);
        QueueingConsumer consumer = new QueueingConsumer(channel);
        // æŒ‡å®šæ¶ˆè´¹é˜Ÿåˆ—
        boolean ack = false; // æ‰“å¼€åº”ç­”æœºåˆ¶
        channel.basicConsume(QUEUE_NAME, ack, consumer);
        while (true)
        {
            QueueingConsumer.Delivery delivery = consumer.nextDelivery();
            String message = new String(delivery.getBody());

            System.out.println(hashCode + " [x] Received '" + message + "'");
            doWork(message);
            System.out.println(hashCode + " [x] Done");
            //channel.basicAck(delivery.getEnvelope().getDeliveryTag(), false);
            channel.basicAck(delivery.getEnvelope().getDeliveryTag(), false);

        }

    }

    /**
     * æ¯ä¸ªç‚¹è€—æ—¶1s
     *
     * @param task
     * @throws InterruptedException
     */
    private static void doWork(String task) throws InterruptedException
    {
        for (char ch : task.toCharArray())
        {
            if (ch == '.')
                Thread.sleep(1000);
        }
    }
}
```

æ¶ˆè´¹è€… 2:

```java
public class Work_2
{
    // é˜Ÿåˆ—åç§°
    private final static String QUEUE_NAME = "workqueue_persistence";

    public static void main(String[] argv) throws java.io.IOException,
            java.lang.InterruptedException
    {
        // åŒºåˆ†ä¸åŒå·¥ä½œè¿›ç¨‹çš„è¾“å‡º
        int hashCode = Work.class.hashCode();
        // åˆ›å»ºè¿æ¥å’Œé¢‘é“
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        // å£°æ˜é˜Ÿåˆ—
        boolean durable = true;
        channel.queueDeclare(QUEUE_NAME, durable, false, false, null);
        System.out.println(hashCode
                + " [*] Waiting for messages. To exit press CTRL+C");
        //è®¾ç½®æœ€å¤§æœåŠ¡è½¬å‘æ¶ˆæ¯æ•°é‡
        int prefetchCount = 1;
        channel.basicQos(prefetchCount);
        QueueingConsumer consumer = new QueueingConsumer(channel);
        // æŒ‡å®šæ¶ˆè´¹é˜Ÿåˆ—
        boolean ack = false; // æ‰“å¼€åº”ç­”æœºåˆ¶
        channel.basicConsume(QUEUE_NAME, ack, consumer);
        while (true)
        {
            QueueingConsumer.Delivery delivery = consumer.nextDelivery();
            String message = new String(delivery.getBody());

            System.out.println(hashCode + " [x] Received '" + message + "'");
            doWork(message);
            System.out.println(hashCode + " [x] Done");
            //channel.basicAck(delivery.getEnvelope().getDeliveryTag(), false);
            channel.basicAck(delivery.getEnvelope().getDeliveryTag(), false);

        }

    }

    /**
     * æ¯ä¸ªç‚¹è€—æ—¶1s
     *
     * @param task
     * @throws InterruptedException
     */
    private static void doWork(String task) throws InterruptedException
    {
        for (char ch : task.toCharArray())
        {
            if (ch == '.')
                Thread.sleep(1000);
        }
    }
}
```

æ­¤æ—¶å¹¶æ²¡æœ‰æŒ‰ç…§ä¹‹å‰çš„ Round-robin æœºåˆ¶è¿›è¡Œè½¬å‘æ¶ˆæ¯ï¼Œè€Œæ˜¯å½“æ¶ˆè´¹è€…ä¸å¿™æ—¶è¿›è¡Œè½¬å‘ã€‚ä¸”è¿™ç§æ¨¡å¼ä¸‹æ”¯æŒåŠ¨æ€å¢åŠ æ¶ˆè´¹è€…ï¼Œå› ä¸ºæ¶ˆæ¯å¹¶æ²¡æœ‰å‘é€å‡ºå»ï¼ŒåŠ¨æ€å¢åŠ äº†æ¶ˆè´¹è€…é©¬ä¸ŠæŠ•å…¥å·¥ä½œã€‚è€Œé»˜è®¤çš„è½¬å‘æœºåˆ¶ä¼šé€ æˆï¼Œå³ä½¿åŠ¨æ€å¢åŠ äº†æ¶ˆè´¹è€…ï¼Œæ­¤æ—¶çš„æ¶ˆæ¯å·²ç»åˆ†é…å®Œæ¯•ï¼Œæ— æ³•ç«‹å³åŠ å…¥å·¥ä½œï¼Œå³ä½¿æœ‰å¾ˆå¤šæœªå®Œæˆçš„ä»»åŠ¡ã€‚

## [RabbitMQå…¥é—¨ï¼šæ·±å…¥ç†è§£æ¶ˆæ¯é˜Ÿåˆ—æ ¸å¿ƒæ¦‚å¿µ](https://blog.dong4j.site/posts/90881fe0.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

RabbitMQ æ˜¯ä¸€ä¸ªç”± erlang å¼€å‘çš„ AMQPï¼ˆAdvanced Message Queue ï¼‰çš„å¼€æºå®ç°ã€‚AMQP çš„å‡ºç°å…¶å®ä¹Ÿæ˜¯åº”äº†å¹¿å¤§äººæ°‘ç¾¤ä¼—çš„éœ€æ±‚ï¼Œè™½ç„¶åœ¨åŒæ­¥æ¶ˆæ¯é€šè®¯çš„ä¸–ç•Œé‡Œæœ‰å¾ˆå¤šå…¬å¼€æ ‡å‡†ï¼ˆå¦‚ COBAR çš„ IIOP ï¼Œæˆ–è€…æ˜¯ SOAP ç­‰ï¼‰ï¼Œä½†æ˜¯åœ¨å¼‚æ­¥æ¶ˆæ¯å¤„ç†ä¸­å´ä¸æ˜¯è¿™æ ·ï¼Œåªæœ‰å¤§ä¼ä¸šæœ‰ä¸€äº›å•†ä¸šå®ç°ï¼ˆå¦‚å¾®è½¯çš„ MSMQ ï¼ŒIBM çš„ Websphere MQ ç­‰ï¼‰ï¼Œå› æ­¤ï¼Œåœ¨ 2006 å¹´çš„ 6 æœˆï¼ŒCisco ã€Redhatã€iMatix ç­‰è”åˆåˆ¶å®šäº† AMQP çš„å…¬å¼€æ ‡å‡†ã€‚

RabbitMQ æ˜¯ç”± RabbitMQ Technologies Ltd å¼€å‘å¹¶ä¸”æä¾›å•†ä¸šæ”¯æŒçš„ã€‚è¯¥å…¬å¸åœ¨ 2010 å¹´ 4 æœˆè¢« SpringSourceï¼ˆVMWare çš„ä¸€ä¸ªéƒ¨é—¨ï¼‰æ”¶è´­ã€‚åœ¨ 2013 å¹´ 5 æœˆè¢«å¹¶å…¥ Pivotalã€‚å…¶å® VMWareï¼ŒPivotal å’Œ EMC æœ¬è´¨ä¸Šæ˜¯ä¸€å®¶çš„ã€‚ä¸åŒçš„æ˜¯ VMWare æ˜¯ç‹¬ç«‹ä¸Šå¸‚å­å…¬å¸ï¼Œè€Œ Pivotal æ˜¯æ•´åˆäº† EMC çš„æŸäº›èµ„æºï¼Œç°åœ¨å¹¶æ²¡æœ‰ä¸Šå¸‚ã€‚

RabbitMQ çš„å®˜ç½‘æ˜¯<http://www.rabbitmq.com>

## åº”ç”¨

1. RabbitMQ Serverï¼š ä¹Ÿå« broker serverï¼Œå®ƒä¸æ˜¯è¿é€é£Ÿç‰©çš„å¡è½¦ï¼Œè€Œæ˜¯ä¸€ç§ä¼ è¾“æœåŠ¡ã€‚åŸè¯æ˜¯ RabbitMQisnâ€™t a food truck, itâ€™s a delivery service. ä»–çš„è§’è‰²å°±æ˜¯ç»´æŠ¤ä¸€æ¡ä» Producer åˆ° Consumer çš„è·¯çº¿ï¼Œä¿è¯æ•°æ®èƒ½å¤ŸæŒ‰ç…§æŒ‡å®šçš„æ–¹å¼è¿›è¡Œä¼ è¾“ã€‚ä½†æ˜¯è¿™ä¸ªä¿è¯ä¹Ÿä¸æ˜¯ 100% çš„ä¿è¯ï¼Œä½†æ˜¯å¯¹äºæ™®é€šçš„åº”ç”¨æ¥è¯´è¿™å·²ç»è¶³å¤Ÿäº†ã€‚å½“ç„¶å¯¹äºå•†ä¸šç³»ç»Ÿæ¥è¯´ï¼Œå¯ä»¥å†åšä¸€å±‚æ•°æ®ä¸€è‡´æ€§çš„ guardï¼Œå°±å¯ä»¥å½»åº•ä¿è¯ç³»ç»Ÿçš„ä¸€è‡´æ€§äº†ã€‚
2. Client A & Bï¼š ä¹Ÿå« Producerï¼Œæ•°æ®çš„å‘é€æ–¹ã€‚createmessages and publish (send) them to a broker server (RabbitMQ).ä¸€ä¸ª Message æœ‰ä¸¤ä¸ªéƒ¨åˆ†ï¼špayloadï¼ˆæœ‰æ•ˆè½½è·ï¼‰å’Œ labelï¼ˆæ ‡ç­¾ï¼‰ã€‚payload é¡¾åæ€ä¹‰å°±æ˜¯ä¼ è¾“çš„æ•°æ®ã€‚label æ˜¯ exchange çš„åå­—æˆ–è€…è¯´æ˜¯ä¸€ä¸ª tagï¼Œå®ƒæè¿°äº† payloadï¼Œè€Œä¸” RabbitMQ ä¹Ÿæ˜¯é€šè¿‡è¿™ä¸ª label æ¥å†³å®šæŠŠè¿™ä¸ª Message å‘ç»™å“ªä¸ª Consumerã€‚AMQP ä»…ä»…æè¿°äº† labelï¼Œè€Œ RabbitMQ å†³å®šäº†å¦‚ä½•ä½¿ç”¨è¿™ä¸ª label çš„è§„åˆ™ã€‚
3. Client 1ï¼Œ2ï¼Œ3ï¼šä¹Ÿå« Consumerï¼Œæ•°æ®çš„æ¥æ”¶æ–¹ã€‚Consumersattach to a broker server (RabbitMQ) and subscribe to a queueã€‚æŠŠ queue æ¯”ä½œæ˜¯ä¸€ä¸ªæœ‰åå­—çš„é‚®ç®±ã€‚å½“æœ‰ Message åˆ°è¾¾æŸä¸ªé‚®ç®±åï¼ŒRabbitMQ æŠŠå®ƒå‘é€ç»™å®ƒçš„æŸä¸ªè®¢é˜…è€…å³ Consumerã€‚å½“ç„¶å¯èƒ½ä¼šæŠŠåŒä¸€ä¸ª Message å‘é€ç»™å¾ˆå¤šçš„ Consumerã€‚åœ¨è¿™ä¸ª Message ä¸­ï¼Œåªæœ‰ payloadï¼Œlabel å·²ç»è¢«åˆ æ‰äº†ã€‚å¯¹äº Consumer æ¥è¯´ï¼Œå®ƒæ˜¯ä¸çŸ¥é“è°å‘é€çš„è¿™ä¸ªä¿¡æ¯çš„ã€‚å°±æ˜¯åè®®æœ¬èº«ä¸æ”¯æŒã€‚ä½†æ˜¯å½“ç„¶äº†å¦‚æœ Producer å‘é€çš„ payload åŒ…å«äº† Producer çš„ä¿¡æ¯å°±å¦å½“åˆ«è®ºäº†ã€‚

### ä¸ºä»€ä¹ˆä½¿ç”¨ Channelï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ TCP è¿æ¥ï¼Ÿ

å¯¹äº OS æ¥è¯´ï¼Œå»ºç«‹å’Œå…³é—­ TCP è¿æ¥æ˜¯æœ‰ä»£ä»·çš„ï¼Œé¢‘ç¹çš„å»ºç«‹å…³é—­ TCP è¿æ¥å¯¹äºç³»ç»Ÿçš„æ€§èƒ½æœ‰å¾ˆå¤§çš„å½±å“ï¼Œè€Œä¸” TCP çš„è¿æ¥æ•°ä¹Ÿæœ‰é™åˆ¶ï¼Œè¿™ä¹Ÿé™åˆ¶äº†ç³»ç»Ÿå¤„ç†é«˜å¹¶å‘çš„èƒ½åŠ›ã€‚ä½†æ˜¯ï¼Œåœ¨ TCP è¿æ¥ä¸­å»ºç«‹ Channel æ˜¯æ²¡æœ‰ä¸Šè¿°ä»£ä»·çš„ã€‚å¯¹äº Producer æˆ–è€… Consumer æ¥è¯´ï¼Œå¯ä»¥å¹¶å‘çš„ä½¿ç”¨å¤šä¸ª Channel è¿›è¡Œ Publish æˆ–è€… Receiveã€‚æœ‰å®éªŒè¡¨æ˜ï¼Œ1s çš„æ•°æ®å¯ä»¥ Publish10K çš„æ•°æ®åŒ…ã€‚å½“ç„¶å¯¹äºä¸åŒçš„ç¡¬ä»¶ç¯å¢ƒï¼Œä¸åŒçš„æ•°æ®åŒ…å¤§å°è¿™ä¸ªæ•°æ®è‚¯å®šä¸ä¸€æ ·ï¼Œä½†æ˜¯æˆ‘åªæƒ³è¯´æ˜ï¼Œå¯¹äºæ™®é€šçš„ Consumer æˆ–è€… Producer æ¥è¯´ï¼Œè¿™å·²ç»è¶³å¤Ÿäº†ã€‚å¦‚æœä¸å¤Ÿç”¨ï¼Œä½ è€ƒè™‘çš„åº”è¯¥æ˜¯å¦‚ä½•ç»†åŒ– split ä½ çš„è®¾è®¡ã€‚

## åˆ›å»ºæ­¥éª¤

ç”Ÿäº§è€…:

1. åˆ›å»ºè¿æ¥
2. åˆ›å»ºé¢‘é“
3. åˆ›å»ºæ¶ˆæ¯ä½“
4. å‘é€æ¶ˆæ¯

æ¶ˆè´¹è€…:

1. åˆ›å»ºè¿æ¥ (å¾ªç¯ç­‰å¾…è¿æ¥)
2. åˆ›å»ºé¢‘é“
3. æ¥æ”¶æ¶ˆæ¯

ä½¿ç”¨åœºæ™¯ï¼šç®€å•çš„å‘é€ä¸æ¥æ”¶ï¼Œæ²¡æœ‰ç‰¹åˆ«çš„å¤„ç†ã€‚

Producer: ç”Ÿäº§è€… å‘é€æ–¹

```java
public class Send {
    //é˜Ÿåˆ—åç§°
    private final static String QUEUE_NAME = "hello";
    public static void main(String[] argv) throws java.io.IOException, InterruptedException {
        /**
         * åˆ›å»ºè¿æ¥è¿æ¥åˆ°MabbitMQ
         */
        ConnectionFactory factory = new ConnectionFactory();
        //è®¾ç½®MabbitMQæ‰€åœ¨ä¸»æœºipæˆ–è€…ä¸»æœºå
        factory.setHost("localhost");
        //åˆ›å»ºä¸€ä¸ªè¿æ¥
        Connection connection = factory.newConnection();
        //åˆ›å»ºä¸€ä¸ªé¢‘é“
        Channel channel = connection.createChannel();
        //æŒ‡å®šä¸€ä¸ªé˜Ÿåˆ—
        channel.queueDeclare(QUEUE_NAME, false, false, false, null);
        //å‘é€çš„æ¶ˆæ¯
        String message = "";
        //å¾€é˜Ÿåˆ—ä¸­å‘å‡ºä¸€æ¡æ¶ˆæ¯
        for(int i = 0; i < 10; i++){
            message = "hello world!" + i;
            channel.basicPublish("", QUEUE_NAME, null, message.getBytes());
            System.out.println(" [x] Sent '" + message + "'");
            Thread.sleep(1000);
        }
        //å…³é—­é¢‘é“å’Œè¿æ¥
        channel.close();
        connection.close();
    }
}
```

Consumer: æ¶ˆè´¹è€…

```java
public class Recv {
   //é˜Ÿåˆ—åç§°
   private final static String QUEUE_NAME = "hello";
   public static void main(String[] argv) throws java.io.IOException,
           java.lang.InterruptedException {
       //æ‰“å¼€è¿æ¥å’Œåˆ›å»ºé¢‘é“ï¼Œä¸å‘é€ç«¯ä¸€æ ·
       ConnectionFactory factory = new ConnectionFactory();
       factory.setHost("localhost");
       Connection connection = factory.newConnection();
       Channel    channel    = connection.createChannel();
       //å£°æ˜é˜Ÿåˆ—ï¼Œä¸»è¦ä¸ºäº†é˜²æ­¢æ¶ˆæ¯æ¥æ”¶è€…å…ˆè¿è¡Œæ­¤ç¨‹åºï¼Œé˜Ÿåˆ—è¿˜ä¸å­˜åœ¨æ—¶åˆ›å»ºé˜Ÿåˆ—ã€‚
       channel.queueDeclare(QUEUE_NAME, false, false, false, null);
       System.out.println(" [*] Waiting for messages. To exit press CTRL+C");
       //åˆ›å»ºé˜Ÿåˆ—æ¶ˆè´¹è€…
       QueueingConsumer consumer = new QueueingConsumer(channel);
       //æŒ‡å®šæ¶ˆè´¹é˜Ÿåˆ—
       channel.basicConsume(QUEUE_NAME, true, consumer);
       while (true) {
           //nextDeliveryæ˜¯ä¸€ä¸ªé˜»å¡æ–¹æ³•ï¼ˆå†…éƒ¨å®ç°å…¶å®æ˜¯é˜»å¡é˜Ÿåˆ—çš„takeæ–¹æ³•ï¼‰
           QueueingConsumer.Delivery delivery = consumer.nextDelivery();
           String                    message  = new String(delivery.getBody());
           System.out.println(" [x] Received '" + message + "'");
       }
   }
}
```

### å€¼å¾—æ³¨æ„çš„å‡ ç‚¹

1. é˜Ÿåˆ—åªä¼šåœ¨å®ƒä¸å­˜åœ¨çš„æ—¶å€™åˆ›å»ºï¼Œå¤šæ¬¡å£°æ˜å¹¶ä¸ä¼šé‡å¤åˆ›å»º
2. ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å¯ä»¥ä¸å†åŒä¸€å°æœºå­ä¸Š
3. æ¶ˆæ¯é˜Ÿåˆ—ä¸ socket ç±»ä¼¼ éƒ½æ˜¯è¦æœ‰æ¥å—è€…å’Œå‘é€è€… æ¥å—è€…å¾ªç¯ç­‰å¾…å‘é€è€…å‘é€çš„æ¶ˆæ¯
4. æ¥å—è€…é€šè¿‡é˜Ÿåˆ—åæ¥åŒºåˆ†åˆ°åº•æ¥æ”¶å“ªé‡Œå‘é€è¿‡æ¥çš„æ¶ˆæ¯
5. å‘é€è€…å‘é€æ¶ˆæ¯æ—¶å¿…é¡»è¦ç”¨é˜Ÿåˆ—åæ ‡è¯†,æ¥å—è€…é€šè¿‡é˜Ÿåˆ—åæ¥æ”¶æŒ‡å®šçš„æ¶ˆæ¯
6. å‘é€è€…å¯ä»¥å‘ç›¸åŒçš„é˜Ÿåˆ—å‘é€æ¶ˆæ¯,å¤šä¸ªæ¥å—è€…å¯ä»¥æ¥æ”¶åŒä¸€ä¸ªé˜Ÿåˆ—çš„æ¶ˆæ¯

### å‡ ä¸ªæ¦‚å¿µè¯´æ˜ï¼š

**Broker**ï¼šç®€å•æ¥è¯´å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨å®ä½“ã€‚  
**Exchange**ï¼šæ¶ˆæ¯äº¤æ¢æœºï¼Œå®ƒæŒ‡å®šæ¶ˆæ¯æŒ‰ä»€ä¹ˆè§„åˆ™ï¼Œè·¯ç”±åˆ°å“ªä¸ªé˜Ÿåˆ—ã€‚  
**Queue**ï¼šæ¶ˆæ¯é˜Ÿåˆ—è½½ä½“ï¼Œæ¯ä¸ªæ¶ˆæ¯éƒ½ä¼šè¢«æŠ•å…¥åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—ã€‚  
**Binding**ï¼šç»‘å®šï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯æŠŠ exchange å’Œ queue æŒ‰ç…§è·¯ç”±è§„åˆ™ç»‘å®šèµ·æ¥ã€‚  
**Routing Key**ï¼šè·¯ç”±å…³é”®å­—ï¼Œexchange æ ¹æ®è¿™ä¸ªå…³é”®å­—è¿›è¡Œæ¶ˆæ¯æŠ•é€’ã€‚  
**vhost**ï¼šè™šæ‹Ÿä¸»æœºï¼Œä¸€ä¸ª broker é‡Œå¯ä»¥å¼€è®¾å¤šä¸ª vhostï¼Œç”¨ä½œä¸åŒç”¨æˆ·çš„æƒé™åˆ†ç¦»ã€‚  
**producer**ï¼šæ¶ˆæ¯ç”Ÿäº§è€…ï¼Œå°±æ˜¯æŠ•é€’æ¶ˆæ¯çš„ç¨‹åºã€‚  
**consumer**ï¼šæ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œå°±æ˜¯æ¥å—æ¶ˆæ¯çš„ç¨‹åºã€‚  
**channel**ï¼šæ¶ˆæ¯é€šé“ï¼Œåœ¨å®¢æˆ·ç«¯çš„æ¯ä¸ªè¿æ¥é‡Œï¼Œå¯å»ºç«‹å¤šä¸ª channelï¼Œæ¯ä¸ª channel ä»£è¡¨ä¸€ä¸ªä¼šè¯ä»»åŠ¡ã€‚  
æ¶ˆæ¯é˜Ÿåˆ—çš„ä½¿ç”¨è¿‡ç¨‹å¤§æ¦‚å¦‚ä¸‹ï¼š  
ï¼ˆ1ï¼‰å®¢æˆ·ç«¯è¿æ¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨ï¼Œæ‰“å¼€ä¸€ä¸ª channelã€‚  
ï¼ˆ2ï¼‰å®¢æˆ·ç«¯å£°æ˜ä¸€ä¸ª exchangeï¼Œå¹¶è®¾ç½®ç›¸å…³å±æ€§ã€‚  
ï¼ˆ3ï¼‰å®¢æˆ·ç«¯å£°æ˜ä¸€ä¸ª queueï¼Œå¹¶è®¾ç½®ç›¸å…³å±æ€§ã€‚  
ï¼ˆ4ï¼‰å®¢æˆ·ç«¯ä½¿ç”¨ routing keyï¼Œåœ¨ exchange å’Œ queue ä¹‹é—´å»ºç«‹å¥½ç»‘å®šå…³ç³»ã€‚  
ï¼ˆ5ï¼‰å®¢æˆ·ç«¯æŠ•é€’æ¶ˆæ¯åˆ° exchangeã€‚  
exchange æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œå°±æ ¹æ®æ¶ˆæ¯çš„ key å’Œå·²ç»è®¾ç½®çš„ bindingï¼Œè¿›è¡Œæ¶ˆæ¯è·¯ç”±ï¼Œå°†æ¶ˆæ¯æŠ•é€’åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—é‡Œã€‚  
exchange ä¹Ÿæœ‰å‡ ä¸ªç±»å‹ï¼Œå®Œå…¨æ ¹æ® key è¿›è¡ŒæŠ•é€’çš„å«åš Direct äº¤æ¢æœºï¼Œä¾‹å¦‚ï¼Œç»‘å®šæ—¶è®¾ç½®äº† routing key ä¸ºâ€abcâ€ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯æäº¤çš„æ¶ˆæ¯ï¼Œåªæœ‰è®¾ç½®äº† key ä¸ºâ€abcâ€çš„æ‰ä¼šæŠ•é€’åˆ°é˜Ÿåˆ—ã€‚å¯¹ key è¿›è¡Œæ¨¡å¼åŒ¹é…åè¿›è¡ŒæŠ•é€’çš„å«åš Topic äº¤æ¢æœºï¼Œç¬¦å·â€#â€åŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªè¯ï¼Œç¬¦å·â€_â€åŒ¹é…æ­£å¥½ä¸€ä¸ªè¯ã€‚ä¾‹å¦‚â€abc.#â€åŒ¹é…â€abc.def.ghiâ€ï¼Œâ€abc._â€åªåŒ¹é…â€abc.defâ€ã€‚è¿˜æœ‰ä¸€ç§ä¸éœ€è¦ key çš„ï¼Œå«åš Fanout äº¤æ¢æœºï¼Œå®ƒé‡‡å–å¹¿æ’­æ¨¡å¼ï¼Œä¸€ä¸ªæ¶ˆæ¯è¿›æ¥æ—¶ï¼ŒæŠ•é€’åˆ°ä¸è¯¥äº¤æ¢æœºç»‘å®šçš„æ‰€æœ‰é˜Ÿåˆ—ã€‚  
RabbitMQ æ”¯æŒæ¶ˆæ¯çš„æŒä¹…åŒ–ï¼Œä¹Ÿå°±æ˜¯æ•°æ®å†™åœ¨ç£ç›˜ä¸Šï¼Œä¸ºäº†æ•°æ®å®‰å…¨è€ƒè™‘ï¼Œæˆ‘æƒ³å¤§å¤šæ•°ç”¨æˆ·éƒ½ä¼šé€‰æ‹©æŒä¹…åŒ–ã€‚æ¶ˆæ¯é˜Ÿåˆ—æŒä¹…åŒ–åŒ…æ‹¬ 3 ä¸ªéƒ¨åˆ†ï¼š  
ï¼ˆ1ï¼‰exchange æŒä¹…åŒ–ï¼Œåœ¨å£°æ˜æ—¶æŒ‡å®š durable => 1  
ï¼ˆ2ï¼‰queue æŒä¹…åŒ–ï¼Œåœ¨å£°æ˜æ—¶æŒ‡å®š durable => 1  
ï¼ˆ3ï¼‰æ¶ˆæ¯æŒä¹…åŒ–ï¼Œåœ¨æŠ•é€’æ—¶æŒ‡å®š delivery_mode => 2ï¼ˆ1 æ˜¯éæŒä¹…åŒ–ï¼‰  
å¦‚æœ exchange å’Œ queue éƒ½æ˜¯æŒä¹…åŒ–çš„ï¼Œé‚£ä¹ˆå®ƒä»¬ä¹‹é—´çš„ binding ä¹Ÿæ˜¯æŒä¹…åŒ–çš„ã€‚å¦‚æœ exchange å’Œ queue ä¸¤è€…ä¹‹é—´æœ‰ä¸€ä¸ªæŒä¹…åŒ–ï¼Œä¸€ä¸ªéæŒä¹…åŒ–ï¼Œå°±ä¸å…è®¸å»ºç«‹ç»‘å®šã€‚

## [æŒæ¡è¿™6ç§ç®—æ³•ï¼Œæˆä¸ºè´Ÿè½½å‡è¡¡é«˜æ‰‹ï¼](https://blog.dong4j.site/posts/f1119903.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## 1. è½®è¯¢æ³•

å°†è¯·æ±‚æŒ‰é¡ºåºè½®æµåœ°åˆ†é…åˆ°åç«¯æœåŠ¡å™¨ä¸Šï¼Œå®ƒå‡è¡¡åœ°å¯¹å¾…åç«¯çš„æ¯ä¸€å°æœåŠ¡å™¨ï¼Œè€Œä¸å…³å¿ƒæœåŠ¡å™¨å®é™…çš„è¿æ¥æ•°å’Œå½“å‰çš„ç³»ç»Ÿè´Ÿè½½ã€‚

## 2.éšæœºæ³•

é€šè¿‡ç³»ç»Ÿçš„éšæœºç®—æ³•ï¼Œæ ¹æ®åç«¯æœåŠ¡å™¨çš„åˆ—è¡¨å¤§å°å€¼æ¥éšæœºé€‰å–å…¶ä¸­çš„ä¸€å°æœåŠ¡å™¨è¿›è¡Œè®¿é—®ã€‚ç”±æ¦‚ç‡ç»Ÿè®¡ç†è®ºå¯ä»¥å¾—çŸ¥ï¼Œéšç€å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡ç«¯çš„æ¬¡æ•°å¢å¤šï¼Œ
å…¶å®é™…æ•ˆæœè¶Šæ¥è¶Šæ¥è¿‘äºå¹³å‡åˆ†é…è°ƒç”¨é‡åˆ°åç«¯çš„æ¯ä¸€å°æœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯è½®è¯¢çš„ç»“æœã€‚

## 3. æºåœ°å€å“ˆå¸Œæ³•

æºåœ°å€å“ˆå¸Œçš„æ€æƒ³æ˜¯æ ¹æ®è·å–å®¢æˆ·ç«¯çš„ IP åœ°å€ï¼Œé€šè¿‡å“ˆå¸Œå‡½æ•°è®¡ç®—å¾—åˆ°çš„ä¸€ä¸ªæ•°å€¼ï¼Œç”¨è¯¥æ•°å€¼å¯¹æœåŠ¡å™¨åˆ—è¡¨çš„å¤§å°è¿›è¡Œå–æ¨¡è¿ç®—ï¼Œå¾—åˆ°çš„ç»“æœä¾¿æ˜¯å®¢æœç«¯è¦è®¿é—®æœåŠ¡å™¨çš„åºå·ã€‚é‡‡ç”¨æºåœ°å€å“ˆå¸Œæ³•è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼ŒåŒä¸€ IP åœ°å€çš„å®¢æˆ·ç«¯ï¼Œå½“åç«¯æœåŠ¡å™¨åˆ—è¡¨ä¸å˜æ—¶ï¼Œå®ƒæ¯æ¬¡éƒ½ä¼šæ˜ å°„åˆ°åŒä¸€å°åç«¯æœåŠ¡å™¨è¿›è¡Œè®¿é—®ã€‚

## 4. åŠ æƒè½®è¯¢æ³•

ä¸åŒçš„åç«¯æœåŠ¡å™¨å¯èƒ½æœºå™¨çš„é…ç½®å’Œå½“å‰ç³»ç»Ÿçš„è´Ÿè½½å¹¶ä¸ç›¸åŒï¼Œå› æ­¤å®ƒä»¬çš„æŠ—å‹èƒ½åŠ›ä¹Ÿä¸ç›¸åŒã€‚ç»™é…ç½®é«˜ã€è´Ÿè½½ä½çš„æœºå™¨é…ç½®æ›´é«˜çš„æƒé‡ï¼Œè®©å…¶å¤„ç†æ›´å¤šçš„è¯·ï¼›è€Œé…ç½®ä½ã€è´Ÿè½½é«˜çš„æœºå™¨ï¼Œç»™å…¶åˆ†é…è¾ƒä½çš„æƒé‡ï¼Œé™ä½å…¶ç³»ç»Ÿè´Ÿè½½ï¼ŒåŠ æƒè½®è¯¢èƒ½å¾ˆå¥½åœ°å¤„ç†è¿™ä¸€é—®é¢˜ï¼Œå¹¶å°†è¯·æ±‚é¡ºåºä¸”æŒ‰ç…§æƒé‡åˆ†é…åˆ°åç«¯ã€‚

## 5. åŠ æƒéšæœºæ³•

ä¸åŠ æƒè½®è¯¢æ³•ä¸€æ ·ï¼ŒåŠ æƒéšæœºæ³•ä¹Ÿæ ¹æ®åç«¯æœºå™¨çš„é…ç½®ï¼Œç³»ç»Ÿçš„è´Ÿè½½åˆ†é…ä¸åŒçš„æƒé‡ã€‚ä¸åŒçš„æ˜¯ï¼Œå®ƒæ˜¯æŒ‰ç…§æƒé‡éšæœºè¯·æ±‚åç«¯æœåŠ¡å™¨ï¼Œè€Œéé¡ºåºã€‚

## 6. æœ€å°è¿æ¥æ•°æ³•

æœ€å°è¿æ¥æ•°ç®—æ³•æ¯”è¾ƒçµæ´»å’Œæ™ºèƒ½ï¼Œç”±äºåç«¯æœåŠ¡å™¨çš„é…ç½®ä¸å°½ç›¸åŒï¼Œå¯¹äºè¯·æ±‚çš„å¤„ç†æœ‰å¿«æœ‰æ…¢ï¼Œå®ƒæ˜¯æ ¹æ®åç«¯æœåŠ¡å™¨å½“å‰çš„è¿æ¥æƒ…å†µï¼ŒåŠ¨æ€åœ°é€‰å–å…¶ä¸­å½“å‰
ç§¯å‹è¿æ¥æ•°æœ€å°‘çš„ä¸€å°æœåŠ¡å™¨æ¥å¤„ç†å½“å‰çš„è¯·æ±‚ï¼Œå°½å¯èƒ½åœ°æé«˜åç«¯æœåŠ¡çš„åˆ©ç”¨æ•ˆç‡ï¼Œå°†è´Ÿè´£åˆç†åœ°åˆ†æµåˆ°æ¯ä¸€å°æœåŠ¡å™¨ã€‚

## [Zookeeper Curatoré«˜çº§ç‰¹æ€§å®æˆ˜æŒ‡å—](https://blog.dong4j.site/posts/348a7282.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

Curator æ˜¯ Netflix å…¬å¸å¼€æºçš„ä¸€å¥— zookeeper å®¢æˆ·ç«¯æ¡†æ¶ï¼Œè§£å†³äº†å¾ˆå¤š Zookeeper å®¢æˆ·ç«¯éå¸¸åº•å±‚çš„ç»†èŠ‚å¼€å‘å·¥ä½œï¼ŒåŒ…æ‹¬è¿æ¥é‡è¿ã€åå¤æ³¨å†Œ Watcher å’Œ NodeExistsException å¼‚å¸¸ç­‰ç­‰ã€‚Patrixck Huntï¼ˆZookeeperï¼‰ä»¥ä¸€å¥â€œGuava is to Java that Curator to Zookeeperâ€ç»™ Curator äºˆé«˜åº¦è¯„ä»·ã€‚  
**å¼•å­å’Œè¶£é—»ï¼š**  
Zookeeper åå­—çš„ç”±æ¥æ˜¯æ¯”è¾ƒæœ‰è¶£çš„ï¼Œä¸‹é¢çš„ç‰‡æ®µæ‘˜æŠ„è‡ªã€Šä» PAXOS åˆ° ZOOKEEPER åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹ä¸€ä¹¦ï¼š  
Zookeeper æœ€æ—©èµ·æºäºé›…è™çš„ç ”ç©¶é™¢çš„ä¸€ä¸ªç ”ç©¶å°ç»„ã€‚åœ¨å½“æ—¶ï¼Œç ”ç©¶äººå‘˜å‘ç°ï¼Œåœ¨é›…è™å†…éƒ¨å¾ˆå¤šå¤§å‹çš„ç³»ç»Ÿéœ€è¦ä¾èµ–ä¸€ä¸ªç±»ä¼¼çš„ç³»ç»Ÿè¿›è¡Œåˆ†å¸ƒå¼åè°ƒï¼Œä½†æ˜¯è¿™äº›ç³»ç»Ÿå¾€å¾€å­˜åœ¨åˆ†å¸ƒå¼å•ç‚¹é—®é¢˜ã€‚æ‰€ä»¥é›…è™çš„å¼€å‘äººå‘˜å°±è¯•å›¾å¼€å‘ä¸€ä¸ªé€šç”¨çš„æ— å•ç‚¹é—®é¢˜çš„åˆ†å¸ƒå¼åè°ƒæ¡†æ¶ã€‚åœ¨ç«‹é¡¹åˆæœŸï¼Œè€ƒè™‘åˆ°å¾ˆå¤šé¡¹ç›®éƒ½æ˜¯ç”¨åŠ¨ç‰©çš„åå­—æ¥å‘½åçš„ (ä¾‹å¦‚è‘—åçš„ Pig é¡¹ç›®)ï¼Œé›…è™çš„å·¥ç¨‹å¸ˆå¸Œæœ›ç»™è¿™ä¸ªé¡¹ç›®ä¹Ÿå–ä¸€ä¸ªåŠ¨ç‰©çš„åå­—ã€‚æ—¶ä»»ç ”ç©¶é™¢çš„é¦–å¸­ç§‘å­¦å®¶ Raghu Ramakrishnan å¼€ç©ç¬‘è¯´ï¼šå†è¿™æ ·ä¸‹å»ï¼Œæˆ‘ä»¬è¿™å„¿å°±å˜æˆåŠ¨ç‰©å›­äº†ã€‚æ­¤è¯ä¸€å‡ºï¼Œå¤§å®¶çº·çº·è¡¨ç¤ºå°±å«åŠ¨ç‰©å›­ç®¡ç†å‘˜å§â€”â€”å› ä¸ºå„ä¸ªä»¥åŠ¨ç‰©å‘½åçš„åˆ†å¸ƒå¼ç»„ä»¶æ”¾åœ¨ä¸€èµ·ï¼Œé›…è™çš„æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿçœ‹ä¸Šå»å°±åƒä¸€ä¸ªå¤§å‹çš„åŠ¨ç‰©å›­äº†ï¼Œè€Œ Zookeeper æ­£å¥½ç”¨æ¥è¿›è¡Œåˆ†å¸ƒå¼ç¯å¢ƒçš„åè°ƒâ€”â€”äºæ˜¯ï¼ŒZookeeper çš„åå­—ç”±æ­¤è¯ç”Ÿäº†ã€‚

Curator æ— ç–‘æ˜¯ Zookeeper å®¢æˆ·ç«¯ä¸­çš„ç‘å£«å†›åˆ€ï¼Œå®ƒè¯‘ä½œ " é¦†é•¿ " æˆ–è€… '' ç®¡ç†è€… ''ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯å¼€å‘å°ç»„æœ‰æ„è€Œä¸ºä¹‹ï¼Œç¬”è€…çŒœæµ‹æœ‰å¯èƒ½è¿™æ ·å‘½åçš„åŸå› æ˜¯è¯´æ˜ Curator å°±æ˜¯ Zookeeper çš„é¦†é•¿ (è„‘æ´æœ‰ç‚¹å¤§ï¼šCurator å°±æ˜¯åŠ¨ç‰©å›­çš„å›­é•¿)ã€‚  
Curator åŒ…å«äº†å‡ ä¸ªåŒ…ï¼š  
**curator-frameworkï¼š**å¯¹ zookeeper çš„åº•å±‚ api çš„ä¸€äº›å°è£…  
**curator-clientï¼š**æä¾›ä¸€äº›å®¢æˆ·ç«¯çš„æ“ä½œï¼Œä¾‹å¦‚é‡è¯•ç­–ç•¥ç­‰  
**curator-recipesï¼š**å°è£…äº†ä¸€äº›é«˜çº§ç‰¹æ€§ï¼Œå¦‚ï¼šCache äº‹ä»¶ç›‘å¬ã€é€‰ä¸¾ã€åˆ†å¸ƒå¼é”ã€åˆ†å¸ƒå¼è®¡æ•°å™¨ã€åˆ†å¸ƒå¼ Barrier ç­‰  
Maven ä¾èµ– (ä½¿ç”¨ curator çš„ç‰ˆæœ¬ï¼š2.12.0ï¼Œå¯¹åº” Zookeeper çš„ç‰ˆæœ¬ä¸ºï¼š3.4.xï¼Œ**å¦‚æœè·¨ç‰ˆæœ¬ä¼šæœ‰å…¼å®¹æ€§é—®é¢˜ï¼Œå¾ˆæœ‰å¯èƒ½å¯¼è‡´èŠ‚ç‚¹æ“ä½œå¤±è´¥**)ï¼š

```xml
<dependency>
    <groupId>org.apache.curator</groupId>
    <artifactId>curator-framework</artifactId>
    <version>2.12.0</version>
</dependency>
<dependency>
    <groupId>org.apache.curator</groupId>
    <artifactId>curator-recipes</artifactId>
    <version>2.12.0</version>
</dependency>
```

# Curator çš„åŸºæœ¬ Api

## åˆ›å»ºä¼šè¯

### 1.ä½¿ç”¨é™æ€å·¥ç¨‹æ–¹æ³•åˆ›å»ºå®¢æˆ·ç«¯

ä¸€ä¸ªä¾‹å­å¦‚ä¸‹ï¼š

```java
RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000, 3);
CuratorFramework client =
CuratorFrameworkFactory.newClient(
                        connectionInfo,
                        5000,
                        3000,
                        retryPolicy);
```

newClient é™æ€å·¥å‚æ–¹æ³•åŒ…å«å››ä¸ªä¸»è¦å‚æ•°ï¼š

| å‚æ•°å              |                            è¯´æ˜                             |
| :------------------ | :---------------------------------------------------------: |
| connectionString    |         æœåŠ¡å™¨åˆ—è¡¨ï¼Œæ ¼å¼ host1:port1,host2:port2,â€¦          |
| retryPolicy         | é‡è¯•ç­–ç•¥,å†…å»ºæœ‰å››ç§é‡è¯•ç­–ç•¥,ä¹Ÿå¯ä»¥è‡ªè¡Œå®ç° RetryPolicy æ¥å£ |
| sessionTimeoutMs    |            ä¼šè¯è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ¯«ç§’ï¼Œé»˜è®¤ 60000ms             |
| connectionTimeoutMs |          è¿æ¥åˆ›å»ºè¶…æ—¶æ—¶é—´ï¼Œå•ä½æ¯«ç§’ï¼Œé»˜è®¤ 60000ms           |

### 2.ä½¿ç”¨ Fluent é£æ ¼çš„ Api åˆ›å»ºä¼šè¯

æ ¸å¿ƒå‚æ•°å˜ä¸ºæµå¼è®¾ç½®ï¼Œä¸€ä¸ªåˆ—å­å¦‚ä¸‹ï¼š

```java
RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000, 3);
CuratorFramework client =
CuratorFrameworkFactory.builder()
        .connectString(connectionInfo)
        .sessionTimeoutMs(5000)
        .connectionTimeoutMs(5000)
        .retryPolicy(retryPolicy)
        .build();
```

### 3.åˆ›å»ºåŒ…å«éš”ç¦»å‘½åç©ºé—´çš„ä¼šè¯

ä¸ºäº†å®ç°ä¸åŒçš„ Zookeeper ä¸šåŠ¡ä¹‹é—´çš„éš”ç¦»ï¼Œéœ€è¦ä¸ºæ¯ä¸ªä¸šåŠ¡åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„å‘½åç©ºé—´ï¼ˆ**NameSpace**ï¼‰ï¼Œå³æŒ‡å®šä¸€ä¸ª Zookeeper çš„æ ¹è·¯å¾„ï¼ˆå®˜æ–¹æœ¯è¯­ï¼š**_ä¸º Zookeeper æ·»åŠ â€œChrootâ€ç‰¹æ€§_**ï¼‰ã€‚ä¾‹å¦‚ï¼ˆä¸‹é¢çš„ä¾‹å­ï¼‰å½“å®¢æˆ·ç«¯æŒ‡å®šäº†ç‹¬ç«‹å‘½åç©ºé—´ä¸ºâ€œ/baseâ€ï¼Œé‚£ä¹ˆè¯¥å®¢æˆ·ç«¯å¯¹ Zookeeper ä¸Šçš„æ•°æ®èŠ‚ç‚¹çš„æ“ä½œéƒ½æ˜¯åŸºäºè¯¥ç›®å½•è¿›è¡Œçš„ã€‚é€šè¿‡è®¾ç½® Chroot å¯ä»¥å°†å®¢æˆ·ç«¯åº”ç”¨ä¸ Zookeeper æœåŠ¡ç«¯çš„ä¸€è¯¾å­æ ‘ç›¸å¯¹åº”ï¼Œåœ¨å¤šä¸ªåº”ç”¨å…±ç”¨ä¸€ä¸ª Zookeeper é›†ç¾¤çš„åœºæ™¯ä¸‹ï¼Œè¿™å¯¹äºå®ç°ä¸åŒåº”ç”¨ä¹‹é—´çš„ç›¸äº’éš”ç¦»ååˆ†æœ‰æ„ä¹‰ã€‚

```java
RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000, 3);
        CuratorFramework client =
        CuratorFrameworkFactory.builder()
                .connectString(connectionInfo)
                .sessionTimeoutMs(5000)
                .connectionTimeoutMs(5000)
                .retryPolicy(retryPolicy)
                .namespace("base")
                .build();
```

## å¯åŠ¨å®¢æˆ·ç«¯

å½“åˆ›å»ºä¼šè¯æˆåŠŸï¼Œå¾—åˆ° client çš„å®ä¾‹ç„¶åå¯ä»¥ç›´æ¥è°ƒç”¨å…¶ start( ) æ–¹æ³•ï¼š

```java
client.start();
```

## æ•°æ®èŠ‚ç‚¹æ“ä½œ

### åˆ›å»ºæ•°æ®èŠ‚ç‚¹

**Zookeeper çš„èŠ‚ç‚¹åˆ›å»ºæ¨¡å¼ï¼š**

- PERSISTENTï¼šæŒä¹…åŒ–
- PERSISTENT_SEQUENTIALï¼šæŒä¹…åŒ–å¹¶ä¸”å¸¦åºåˆ—å·
- EPHEMERALï¼šä¸´æ—¶
- EPHEMERAL_SEQUENTIALï¼šä¸´æ—¶å¹¶ä¸”å¸¦åºåˆ—å·

**åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆå§‹å†…å®¹ä¸ºç©º**

```java
client.create().forPath("path");
```

æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰è®¾ç½®èŠ‚ç‚¹å±æ€§ï¼ŒèŠ‚ç‚¹åˆ›å»ºæ¨¡å¼é»˜è®¤ä¸ºæŒä¹…åŒ–èŠ‚ç‚¹ï¼Œå†…å®¹é»˜è®¤ä¸ºç©º

**åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œé™„å¸¦åˆå§‹åŒ–å†…å®¹**

```java
client.create().forPath("path","init".getBytes());
```

**åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼ŒæŒ‡å®šåˆ›å»ºæ¨¡å¼ï¼ˆä¸´æ—¶èŠ‚ç‚¹ï¼‰ï¼Œå†…å®¹ä¸ºç©º**

```java
client.create().withMode(CreateMode.EPHEMERAL).forPath("path");
```

**åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼ŒæŒ‡å®šåˆ›å»ºæ¨¡å¼ï¼ˆä¸´æ—¶èŠ‚ç‚¹ï¼‰ï¼Œé™„å¸¦åˆå§‹åŒ–å†…å®¹**

```java
client.create().withMode(CreateMode.EPHEMERAL).forPath("path","init".getBytes());
```

**åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼ŒæŒ‡å®šåˆ›å»ºæ¨¡å¼ï¼ˆä¸´æ—¶èŠ‚ç‚¹ï¼‰ï¼Œé™„å¸¦åˆå§‹åŒ–å†…å®¹ï¼Œå¹¶ä¸”è‡ªåŠ¨é€’å½’åˆ›å»ºçˆ¶èŠ‚ç‚¹**

```java
client.create()
      .creatingParentContainersIfNeeded()
      .withMode(CreateMode.EPHEMERAL)
      .forPath("path","init".getBytes());
```

è¿™ä¸ª creatingParentContainersIfNeeded() æ¥å£éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºä¸€èˆ¬æƒ…å†µå¼€å‘äººå‘˜åœ¨åˆ›å»ºä¸€ä¸ªå­èŠ‚ç‚¹å¿…é¡»åˆ¤æ–­å®ƒçš„çˆ¶èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ç›´æ¥åˆ›å»ºä¼šæŠ›å‡º NoNodeExceptionï¼Œä½¿ç”¨ creatingParentContainersIfNeeded() ä¹‹å Curator èƒ½å¤Ÿè‡ªåŠ¨é€’å½’åˆ›å»ºæ‰€æœ‰æ‰€éœ€çš„çˆ¶èŠ‚ç‚¹ã€‚

### åˆ é™¤æ•°æ®èŠ‚ç‚¹

**åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹**

```java
client.delete().forPath("path");
```

æ³¨æ„ï¼Œæ­¤æ–¹æ³•åªèƒ½åˆ é™¤**å¶å­èŠ‚ç‚¹**ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚

**åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”é€’å½’åˆ é™¤å…¶æ‰€æœ‰çš„å­èŠ‚ç‚¹**

```java
client.delete().deletingChildrenIfNeeded().forPath("path");
```

**åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¼ºåˆ¶æŒ‡å®šç‰ˆæœ¬è¿›è¡Œåˆ é™¤**

```java
client.delete().withVersion(10086).forPath("path");
```

**åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¼ºåˆ¶ä¿è¯åˆ é™¤**

```java
client.delete().guaranteed().forPath("path");
```

guaranteed() æ¥å£æ˜¯ä¸€ä¸ªä¿éšœæªæ–½ï¼Œåªè¦å®¢æˆ·ç«¯ä¼šè¯æœ‰æ•ˆï¼Œé‚£ä¹ˆ Curator ä¼šåœ¨åå°æŒç»­è¿›è¡Œåˆ é™¤æ“ä½œï¼Œç›´åˆ°åˆ é™¤èŠ‚ç‚¹æˆåŠŸã€‚

**æ³¨æ„ï¼š**ä¸Šé¢çš„å¤šä¸ªæµå¼æ¥å£æ˜¯å¯ä»¥è‡ªç”±ç»„åˆçš„ï¼Œä¾‹å¦‚ï¼š

```java
client.delete().guaranteed().deletingChildrenIfNeeded().withVersion(10086).forPath("path");
```

### è¯»å–æ•°æ®èŠ‚ç‚¹æ•°æ®

**è¯»å–ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®å†…å®¹**

```java
client.getData().forPath("path");
```

æ³¨æ„ï¼Œæ­¤æ–¹æ³•è¿”çš„è¿”å›å€¼æ˜¯ byte[ ];

**è¯»å–ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®å†…å®¹ï¼ŒåŒæ—¶è·å–åˆ°è¯¥èŠ‚ç‚¹çš„ stat**

```java
Stat stat = new Stat();
client.getData().storingStatIn(stat).forPath("path");
```

### æ›´æ–°æ•°æ®èŠ‚ç‚¹æ•°æ®

**æ›´æ–°ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®å†…å®¹**

```java
client.setData().forPath("path","data".getBytes());
```

æ³¨æ„ï¼šè¯¥æ¥å£ä¼šè¿”å›ä¸€ä¸ª Stat å®ä¾‹

**æ›´æ–°ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®å†…å®¹ï¼Œå¼ºåˆ¶æŒ‡å®šç‰ˆæœ¬è¿›è¡Œæ›´æ–°**

```java
client.setData().withVersion(10086).forPath("path","data".getBytes());
```

### æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨

```java
client.checkExists().forPath("path");
```

æ³¨æ„ï¼šè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª Stat å®ä¾‹ï¼Œç”¨äºæ£€æŸ¥ ZNode æ˜¯å¦å­˜åœ¨çš„æ“ä½œ. å¯ä»¥è°ƒç”¨é¢å¤–çš„æ–¹æ³• (ç›‘æ§æˆ–è€…åå°å¤„ç†) å¹¶åœ¨æœ€åè°ƒç”¨ forPath( ) æŒ‡å®šè¦æ“ä½œçš„ ZNode

### è·å–æŸä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹è·¯å¾„

```java
client.getChildren().forPath("path");
```

æ³¨æ„ï¼šè¯¥æ–¹æ³•çš„è¿”å›å€¼ä¸º List,è·å¾— ZNode çš„å­èŠ‚ç‚¹ Path åˆ—è¡¨ã€‚ å¯ä»¥è°ƒç”¨é¢å¤–çš„æ–¹æ³• (ç›‘æ§ã€åå°å¤„ç†æˆ–è€…è·å–çŠ¶æ€ watch, background or get stat) å¹¶åœ¨æœ€åè°ƒç”¨ forPath() æŒ‡å®šè¦æ“ä½œçš„çˆ¶ ZNode

### äº‹åŠ¡

CuratorFramework çš„å®ä¾‹åŒ…å« inTransaction( ) æ¥å£æ–¹æ³•ï¼Œè°ƒç”¨æ­¤æ–¹æ³•å¼€å¯ä¸€ä¸ª ZooKeeper äº‹åŠ¡. å¯ä»¥å¤åˆ create, setData, check, and/or delete ç­‰æ“ä½œç„¶åè°ƒç”¨ commit() ä½œä¸ºä¸€ä¸ªåŸå­æ“ä½œæäº¤ã€‚ä¸€ä¸ªä¾‹å­å¦‚ä¸‹ï¼š

```java
client.inTransaction().check().forPath("path")
      .and()
      .create().withMode(CreateMode.EPHEMERAL).forPath("path","data".getBytes())
      .and()
      .setData().withVersion(10086).forPath("path","data2".getBytes())
      .and()
      .commit();
```

### å¼‚æ­¥æ¥å£

ä¸Šé¢æåˆ°çš„åˆ›å»ºã€åˆ é™¤ã€æ›´æ–°ã€è¯»å–ç­‰æ–¹æ³•éƒ½æ˜¯åŒæ­¥çš„ï¼ŒCurator æä¾›å¼‚æ­¥æ¥å£ï¼Œå¼•å…¥äº†**BackgroundCallback**æ¥å£ç”¨äºå¤„ç†å¼‚æ­¥æ¥å£è°ƒç”¨ä¹‹åæœåŠ¡ç«¯è¿”å›çš„ç»“æœä¿¡æ¯ã€‚**BackgroundCallback**æ¥å£ä¸­ä¸€ä¸ªé‡è¦çš„å›è°ƒå€¼ä¸º CuratorEventï¼Œé‡Œé¢åŒ…å«äº‹ä»¶ç±»å‹ã€å“åº”å—å’ŒèŠ‚ç‚¹çš„è¯¦ç»†ä¿¡æ¯ã€‚

**CuratorEventType**

| äº‹ä»¶ç±»å‹ | å¯¹åº” CuratorFramework å®ä¾‹çš„æ–¹æ³• |
| :------: | :------------------------------: |
|  CREATE  |            #create()             |
|  DELETE  |            #delete()             |
|  EXISTS  |          #checkExists()          |
| GET_DATA |            #getData()            |
| SET_DATA |            #setData()            |
| CHILDREN |          #getChildren()          |
|   SYNC   |       #sync(String,Object)       |
| GET_ACL  |            #getACL()             |
| SET_ACL  |            #setACL()             |
| WATCHED  |        #Watcher(Watcher)         |
| CLOSING  |             #close()             |

**å“åº”ç  (#getResultCode())**

| å“åº”ç  |                   æ„ä¹‰                   |
| :----: | :--------------------------------------: |
|   0    |              OKï¼Œå³è°ƒç”¨æˆåŠŸ              |
|   -4   | ConnectionLossï¼Œå³å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯æ–­å¼€è¿æ¥ |
|  -110  |        NodeExistsï¼Œå³èŠ‚ç‚¹å·²ç»å­˜åœ¨        |
|  -112  |        SessionExpiredï¼Œå³ä¼šè¯è¿‡æœŸ        |

ä¸€ä¸ªå¼‚æ­¥åˆ›å»ºèŠ‚ç‚¹çš„ä¾‹å­å¦‚ä¸‹ï¼š

```java
Executor executor = Executors.newFixedThreadPool(2);
client.create()
      .creatingParentsIfNeeded()
      .withMode(CreateMode.EPHEMERAL)
      .inBackground((curatorFramework, curatorEvent) -> {      System.out.println(String.format("eventType:%s,resultCode:%s",curatorEvent.getType(),curatorEvent.getResultCode()));
      },executor)
      .forPath("path");
```

æ³¨æ„ï¼šå¦‚æœ#inBackground() æ–¹æ³•ä¸æŒ‡å®š executorï¼Œé‚£ä¹ˆä¼šé»˜è®¤ä½¿ç”¨ Curator çš„ EventThread å»è¿›è¡Œå¼‚æ­¥å¤„ç†ã€‚

## Curator é£Ÿè°± (é«˜çº§ç‰¹æ€§)

**æé†’ï¼šé¦–å…ˆä½ å¿…é¡»æ·»åŠ  curator-recipes ä¾èµ–ï¼Œä¸‹æ–‡ä»…ä»…å¯¹ recipes ä¸€äº›ç‰¹æ€§çš„ä½¿ç”¨è¿›è¡Œè§£é‡Šå’Œä¸¾ä¾‹ï¼Œä¸æ‰“ç®—è¿›è¡Œæºç çº§åˆ«çš„æ¢è®¨**

```xml
<dependency>
    <groupId>org.apache.curator</groupId>
    <artifactId>curator-recipes</artifactId>
    <version>2.12.0</version>
</dependency>
```

**é‡è¦æé†’ï¼šå¼ºçƒˆæ¨èä½¿ç”¨ ConnectionStateListener ç›‘æ§è¿æ¥çš„çŠ¶æ€ï¼Œå½“è¿æ¥çŠ¶æ€ä¸º LOSTï¼Œcurator-recipes ä¸‹çš„æ‰€æœ‰ Api å°†ä¼šå¤±æ•ˆæˆ–è€…è¿‡æœŸï¼Œå°½ç®¡åé¢æ‰€æœ‰çš„ä¾‹å­éƒ½æ²¡æœ‰ä½¿ç”¨åˆ° ConnectionStateListenerã€‚**

### ç¼“å­˜

Zookeeper åŸç”Ÿæ”¯æŒé€šè¿‡æ³¨å†Œ Watcher æ¥è¿›è¡Œäº‹ä»¶ç›‘å¬ï¼Œä½†æ˜¯å¼€å‘è€…éœ€è¦åå¤æ³¨å†Œ (Watcher åªèƒ½å•æ¬¡æ³¨å†Œå•æ¬¡ä½¿ç”¨)ã€‚Cache æ˜¯ Curator ä¸­å¯¹äº‹ä»¶ç›‘å¬çš„åŒ…è£…ï¼Œå¯ä»¥çœ‹ä½œæ˜¯å¯¹äº‹ä»¶ç›‘å¬çš„æœ¬åœ°ç¼“å­˜è§†å›¾ï¼Œèƒ½å¤Ÿè‡ªåŠ¨ä¸ºå¼€å‘è€…å¤„ç†åå¤æ³¨å†Œç›‘å¬ã€‚Curator æä¾›äº†ä¸‰ç§ Watcher(Cache) æ¥ç›‘å¬ç»“ç‚¹çš„å˜åŒ–ã€‚

#### Path Cache

Path Cache ç”¨æ¥ç›‘æ§ä¸€ä¸ª ZNode çš„å­èŠ‚ç‚¹. å½“ä¸€ä¸ªå­èŠ‚ç‚¹å¢åŠ ï¼Œ æ›´æ–°ï¼Œåˆ é™¤æ—¶ï¼Œ Path Cache ä¼šæ”¹å˜å®ƒçš„çŠ¶æ€ï¼Œ ä¼šåŒ…å«æœ€æ–°çš„å­èŠ‚ç‚¹ï¼Œ å­èŠ‚ç‚¹çš„æ•°æ®å’ŒçŠ¶æ€ï¼Œè€ŒçŠ¶æ€çš„æ›´å˜å°†é€šè¿‡ PathChildrenCacheListener é€šçŸ¥ã€‚

å®é™…ä½¿ç”¨æ—¶ä¼šæ¶‰åŠåˆ°å››ä¸ªç±»ï¼š

- PathChildrenCache
- PathChildrenCacheEvent
- PathChildrenCacheListener
- ChildData

é€šè¿‡ä¸‹é¢çš„æ„é€ å‡½æ•°åˆ›å»º Path Cache:

```java
public PathChildrenCache(CuratorFramework client, String path, boolean cacheData)
```

æƒ³ä½¿ç”¨ cacheï¼Œå¿…é¡»è°ƒç”¨å®ƒçš„ `start` æ–¹æ³•ï¼Œä½¿ç”¨å®Œåè°ƒç”¨ `close` æ–¹æ³•ã€‚ å¯ä»¥è®¾ç½® StartMode æ¥å®ç°å¯åŠ¨çš„æ¨¡å¼ï¼Œ

StartMode æœ‰ä¸‹é¢å‡ ç§ï¼š

1. NORMALï¼šæ­£å¸¸åˆå§‹åŒ–ã€‚
2. BUILD_INITIAL_CACHEï¼šåœ¨è°ƒç”¨ `start()` ä¹‹å‰ä¼šè°ƒç”¨ `rebuild()`ã€‚
3. POST_INITIALIZED_EVENTï¼š å½“ Cache åˆå§‹åŒ–æ•°æ®åå‘é€ä¸€ä¸ª PathChildrenCacheEvent.Type#INITIALIZED äº‹ä»¶

`public void addListener(PathChildrenCacheListener listener)` å¯ä»¥å¢åŠ  listener ç›‘å¬ç¼“å­˜çš„å˜åŒ–ã€‚

`getCurrentData()` æ–¹æ³•è¿”å›ä¸€ä¸ª `List<ChildData>` å¯¹è±¡ï¼Œå¯ä»¥éå†æ‰€æœ‰çš„å­èŠ‚ç‚¹ã€‚

**è®¾ç½®/æ›´æ–°ã€ç§»é™¤å…¶å®æ˜¯ä½¿ç”¨ client (CuratorFramework) æ¥æ“ä½œ, ä¸é€šè¿‡ PathChildrenCache æ“ä½œï¼š**

```java
public class PathCacheDemo {

    private static final String PATH = "/example/pathCache";

    public static void main(String[] args) throws Exception {
        TestingServer server = new TestingServer();
        CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3));
        client.start();
        PathChildrenCache cache = new PathChildrenCache(client, PATH, true);
        cache.start();
        PathChildrenCacheListener cacheListener = (client1, event) -> {
            System.out.println("äº‹ä»¶ç±»å‹ï¼š" + event.getType());
            if (null != event.getData()) {
                System.out.println("èŠ‚ç‚¹æ•°æ®ï¼š" + event.getData().getPath() + " = " + new String(event.getData().getData()));
            }
        };
        cache.getListenable().addListener(cacheListener);
        client.create().creatingParentsIfNeeded().forPath("/example/pathCache/test01", "01".getBytes());
        Thread.sleep(10);
        client.create().creatingParentsIfNeeded().forPath("/example/pathCache/test02", "02".getBytes());
        Thread.sleep(10);
        client.setData().forPath("/example/pathCache/test01", "01_V2".getBytes());
        Thread.sleep(10);
        for (ChildData data : cache.getCurrentData()) {
            System.out.println("getCurrentData:" + data.getPath() + " = " + new String(data.getData()));
        }
        client.delete().forPath("/example/pathCache/test01");
        Thread.sleep(10);
        client.delete().forPath("/example/pathCache/test02");
        Thread.sleep(1000 * 5);
        cache.close();
        client.close();
        System.out.println("OK!");
    }
}
```

**æ³¨æ„ï¼š**å¦‚æœ new PathChildrenCache(client, PATH, true) ä¸­çš„å‚æ•° cacheData å€¼è®¾ç½®ä¸º falseï¼Œåˆ™ç¤ºä¾‹ä¸­çš„ event.getData().getData()ã€data.getData() å°†è¿”å› nullï¼Œcache å°†ä¸ä¼šç¼“å­˜èŠ‚ç‚¹æ•°æ®ã€‚

**æ³¨æ„ï¼š**ç¤ºä¾‹ä¸­çš„ Thread.sleep(10) å¯ä»¥æ³¨é‡Šæ‰ï¼Œä½†æ˜¯æ³¨é‡Šåäº‹ä»¶ç›‘å¬çš„è§¦å‘æ¬¡æ•°ä¼šä¸å…¨ï¼Œè¿™å¯èƒ½ä¸ PathCache çš„å®ç°åŸç†æœ‰å…³ï¼Œä¸èƒ½å¤ªè¿‡é¢‘ç¹çš„è§¦å‘äº‹ä»¶ï¼

#### Node Cache

Node Cache ä¸ Path Cache ç±»ä¼¼ï¼ŒNode Cache åªæ˜¯ç›‘å¬æŸä¸€ä¸ªç‰¹å®šçš„èŠ‚ç‚¹ã€‚å®ƒæ¶‰åŠåˆ°ä¸‹é¢çš„ä¸‰ä¸ªç±»ï¼š

- `NodeCache`Â - Node Cache å®ç°ç±»
- `NodeCacheListener`Â - èŠ‚ç‚¹ç›‘å¬å™¨
- `ChildData`Â - èŠ‚ç‚¹æ•°æ®

**æ³¨æ„ï¼š**ä½¿ç”¨ cacheï¼Œä¾ç„¶è¦è°ƒç”¨å®ƒçš„ `start()` æ–¹æ³•ï¼Œä½¿ç”¨å®Œåè°ƒç”¨ `close()` æ–¹æ³•ã€‚

getCurrentData() å°†å¾—åˆ°èŠ‚ç‚¹å½“å‰çš„çŠ¶æ€ï¼Œé€šè¿‡å®ƒçš„çŠ¶æ€å¯ä»¥å¾—åˆ°å½“å‰çš„å€¼ã€‚

```java
public class NodeCacheDemo {

    private static final String PATH = "/example/cache";

    public static void main(String[] args) throws Exception {
        TestingServer server = new TestingServer();
        CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3));
        client.start();
        client.create().creatingParentsIfNeeded().forPath(PATH);
        final NodeCache cache = new NodeCache(client, PATH);
        NodeCacheListener listener = () -> {
            ChildData data = cache.getCurrentData();
            if (null != data) {
                System.out.println("èŠ‚ç‚¹æ•°æ®ï¼š" + new String(cache.getCurrentData().getData()));
            } else {
                System.out.println("èŠ‚ç‚¹è¢«åˆ é™¤!");
            }
        };
        cache.getListenable().addListener(listener);
        cache.start();
        client.setData().forPath(PATH, "01".getBytes());
        Thread.sleep(100);
        client.setData().forPath(PATH, "02".getBytes());
        Thread.sleep(100);
        client.delete().deletingChildrenIfNeeded().forPath(PATH);
        Thread.sleep(1000 * 2);
        cache.close();
        client.close();
        System.out.println("OK!");
    }
}
```

**æ³¨æ„ï¼š**ç¤ºä¾‹ä¸­çš„ Thread.sleep(10) å¯ä»¥æ³¨é‡Šï¼Œä½†æ˜¯æ³¨é‡Šåäº‹ä»¶ç›‘å¬çš„è§¦å‘æ¬¡æ•°ä¼šä¸å…¨ï¼Œè¿™å¯èƒ½ä¸ NodeCache çš„å®ç°åŸç†æœ‰å…³ï¼Œä¸èƒ½å¤ªè¿‡é¢‘ç¹çš„è§¦å‘äº‹ä»¶ï¼

**æ³¨æ„ï¼š**NodeCache åªèƒ½ç›‘å¬ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€å˜åŒ–ã€‚

#### Tree Cache

Tree Cache å¯ä»¥ç›‘æ§æ•´ä¸ªæ ‘ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œç±»ä¼¼äº PathCache å’Œ NodeCache çš„ç»„åˆï¼Œä¸»è¦æ¶‰åŠåˆ°ä¸‹é¢å››ä¸ªç±»ï¼š

- TreeCache - Tree Cache å®ç°ç±»
- TreeCacheListener - ç›‘å¬å™¨ç±»
- TreeCacheEvent - è§¦å‘çš„äº‹ä»¶ç±»
- ChildData - èŠ‚ç‚¹æ•°æ®

```java
public class TreeCacheDemo {

    private static final String PATH = "/example/cache";

    public static void main(String[] args) throws Exception {
        TestingServer server = new TestingServer();
        CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3));
        client.start();
        client.create().creatingParentsIfNeeded().forPath(PATH);
        TreeCache cache = new TreeCache(client, PATH);
        TreeCacheListener listener = (client1, event) ->
                System.out.println("äº‹ä»¶ç±»å‹ï¼š" + event.getType() +
                        " | è·¯å¾„ï¼š" + (null != event.getData() ? event.getData().getPath() : null));
        cache.getListenable().addListener(listener);
        cache.start();
        client.setData().forPath(PATH, "01".getBytes());
        Thread.sleep(100);
        client.setData().forPath(PATH, "02".getBytes());
        Thread.sleep(100);
        client.delete().deletingChildrenIfNeeded().forPath(PATH);
        Thread.sleep(1000 * 2);
        cache.close();
        client.close();
        System.out.println("OK!");
    }
}
```

**æ³¨æ„ï¼š**åœ¨æ­¤ç¤ºä¾‹ä¸­æ²¡æœ‰ä½¿ç”¨ Thread.sleep(10)ï¼Œä½†æ˜¯äº‹ä»¶è§¦å‘æ¬¡æ•°ä¹Ÿæ˜¯æ­£å¸¸çš„ã€‚

**æ³¨æ„ï¼š**TreeCache åœ¨åˆå§‹åŒ– (è°ƒç”¨ `start()` æ–¹æ³•) çš„æ—¶å€™ä¼šå›è°ƒ `TreeCacheListener` å®ä¾‹ä¸€ä¸ªäº‹ TreeCacheEventï¼Œè€Œå›è°ƒçš„ TreeCacheEvent å¯¹è±¡çš„ Type ä¸º INITIALIZEDï¼ŒChildData ä¸º nullï¼Œæ­¤æ—¶ `event.getData().getPath()` å¾ˆæœ‰å¯èƒ½å¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œè¿™é‡Œåº”è¯¥ä¸»åŠ¨å¤„ç†å¹¶é¿å…è¿™ç§æƒ…å†µã€‚

### Leader é€‰ä¸¾

åœ¨åˆ†å¸ƒå¼è®¡ç®—ä¸­ï¼ŒÂ **leader elections**æ˜¯å¾ˆé‡è¦çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œ è¿™ä¸ªé€‰ä¸¾è¿‡ç¨‹æ˜¯è¿™æ ·å­çš„ï¼š æŒ‡æ´¾ä¸€ä¸ªè¿›ç¨‹ä½œä¸ºç»„ç»‡è€…ï¼Œå°†ä»»åŠ¡åˆ†å‘ç»™å„èŠ‚ç‚¹ã€‚ åœ¨ä»»åŠ¡å¼€å§‹å‰ï¼Œ å“ªä¸ªèŠ‚ç‚¹éƒ½ä¸çŸ¥é“è°æ˜¯ leader(é¢†å¯¼è€…) æˆ–è€… coordinator(åè°ƒè€…). å½“é€‰ä¸¾ç®—æ³•å¼€å§‹æ‰§è¡Œåï¼Œ æ¯ä¸ªèŠ‚ç‚¹æœ€ç»ˆä¼šå¾—åˆ°ä¸€ä¸ªå”¯ä¸€çš„èŠ‚ç‚¹ä½œä¸ºä»»åŠ¡ leader. é™¤æ­¤ä¹‹å¤–ï¼Œ é€‰ä¸¾è¿˜ç»å¸¸ä¼šå‘ç”Ÿåœ¨ leader æ„å¤–å®•æœºçš„æƒ…å†µä¸‹ï¼Œæ–°çš„ leader è¦è¢«é€‰ä¸¾å‡ºæ¥ã€‚

åœ¨ zookeeper é›†ç¾¤ä¸­ï¼Œleader è´Ÿè´£å†™æ“ä½œï¼Œç„¶åé€šè¿‡ Zab åè®®å®ç° follower çš„åŒæ­¥ï¼Œleader æˆ–è€… follower éƒ½å¯ä»¥å¤„ç†è¯»æ“ä½œã€‚

Curator æœ‰ä¸¤ç§ leader é€‰ä¸¾çš„ recipe,åˆ†åˆ«æ˜¯**LeaderSelector**å’Œ**LeaderLatch**ã€‚

å‰è€…æ˜¯æ‰€æœ‰å­˜æ´»çš„å®¢æˆ·ç«¯ä¸é—´æ–­çš„è½®æµåš Leaderï¼Œå¤§åŒç¤¾ä¼šã€‚åè€…æ˜¯ä¸€æ—¦é€‰ä¸¾å‡º Leaderï¼Œé™¤éæœ‰å®¢æˆ·ç«¯æŒ‚æ‰é‡æ–°è§¦å‘é€‰ä¸¾ï¼Œå¦åˆ™ä¸ä¼šäº¤å‡ºé¢†å¯¼æƒã€‚æŸå…š?

#### LeaderLatch

LeaderLatch æœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼š

```java
public LeaderLatch(CuratorFramework client, String latchPath)
public LeaderLatch(CuratorFramework client, String latchPath,  String id)
```

LeaderLatch çš„å¯åŠ¨ï¼š

**leaderLatch.start( );**

ä¸€æ—¦å¯åŠ¨ï¼ŒLeaderLatch ä¼šå’Œå…¶å®ƒä½¿ç”¨ç›¸åŒ latch path çš„å…¶å®ƒ LeaderLatch äº¤æ¶‰ï¼Œç„¶åå…¶ä¸­ä¸€ä¸ªæœ€ç»ˆä¼šè¢«é€‰ä¸¾ä¸º leaderï¼Œå¯ä»¥é€šè¿‡ `hasLeadership` æ–¹æ³•æŸ¥çœ‹ LeaderLatch å®ä¾‹æ˜¯å¦ leaderï¼š

**leaderLatch.hasLeadership( );**Â //è¿”å› true è¯´æ˜å½“å‰å®ä¾‹æ˜¯ leader

ç±»ä¼¼ JDK çš„ CountDownLatchï¼Œ LeaderLatch åœ¨è¯·æ±‚æˆä¸º leadership ä¼š block(é˜»å¡)ï¼Œä¸€æ—¦ä¸ä½¿ç”¨ LeaderLatch äº†ï¼Œå¿…é¡»è°ƒç”¨ `close` æ–¹æ³•ã€‚ å¦‚æœå®ƒæ˜¯ leader,ä¼šé‡Šæ”¾ leadershipï¼Œ å…¶å®ƒçš„å‚ä¸è€…å°†ä¼šé€‰ä¸¾ä¸€ä¸ª leaderã€‚

```java
public void await() throws InterruptedException,EOFException
/*Causes the current thread to wait until this instance acquires leadership
unless the thread is interrupted or closed.*/
public boolean await(long timeout,TimeUnit unit)throws InterruptedException
```

**å¼‚å¸¸å¤„ç†ï¼š**Â LeaderLatch å®ä¾‹å¯ä»¥å¢åŠ  ConnectionStateListener æ¥ç›‘å¬ç½‘ç»œè¿æ¥é—®é¢˜ã€‚ å½“ SUSPENDED æˆ– LOST æ—¶, leader ä¸å†è®¤ä¸ºè‡ªå·±è¿˜æ˜¯ leaderã€‚å½“ LOST åè¿æ¥é‡è¿å RECONNECTED,LeaderLatch ä¼šåˆ é™¤å…ˆå‰çš„ ZNode ç„¶åé‡æ–°åˆ›å»ºä¸€ä¸ªã€‚LeaderLatch ç”¨æˆ·å¿…é¡»è€ƒè™‘å¯¼è‡´ leadership ä¸¢å¤±çš„è¿æ¥é—®é¢˜ã€‚ å¼ºçƒˆæ¨èä½ ä½¿ç”¨ ConnectionStateListenerã€‚

ä¸€ä¸ª LeaderLatch çš„ä½¿ç”¨ä¾‹å­ï¼š

```java
public class LeaderLatchDemo extends BaseConnectionInfo {
    protected static String PATH = "/francis/leader";
    private static final int CLIENT_QTY = 10;

    public static void main(String[] args) throws Exception {
        List<CuratorFramework> clients = Lists.newArrayList();
        List<LeaderLatch> examples = Lists.newArrayList();
        TestingServer server=new TestingServer();
        try {
            for (int i = 0; i < CLIENT_QTY; i++) {
                CuratorFramework client
                        = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(20000, 3));
                clients.add(client);
                LeaderLatch latch = new LeaderLatch(client, PATH, "Client #" + i);
                latch.addListener(new LeaderLatchListener() {

                    @Override
                    public void isLeader() {
                        // TODO Auto-generated method stub
                        System.out.println("I am Leader");
                    }

                    @Override
                    public void notLeader() {
                        // TODO Auto-generated method stub
                        System.out.println("I am not Leader");
                    }
                });
                examples.add(latch);
                client.start();
                latch.start();
            }
            Thread.sleep(10000);
            LeaderLatch currentLeader = null;
            for (LeaderLatch latch : examples) {
                if (latch.hasLeadership()) {
                    currentLeader = latch;
                }
            }
            System.out.println("current leader is " + currentLeader.getId());
            System.out.println("release the leader " + currentLeader.getId());
            currentLeader.close();

            Thread.sleep(5000);

            for (LeaderLatch latch : examples) {
                if (latch.hasLeadership()) {
                    currentLeader = latch;
                }
            }
            System.out.println("current leader is " + currentLeader.getId());
            System.out.println("release the leader " + currentLeader.getId());
        } finally {
            for (LeaderLatch latch : examples) {
                if (null != latch.getState())
                CloseableUtils.closeQuietly(latch);
            }
            for (CuratorFramework client : clients) {
                CloseableUtils.closeQuietly(client);
            }
        }
    }
}
```

å¯ä»¥æ·»åŠ  test module çš„ä¾èµ–æ–¹ä¾¿è¿›è¡Œæµ‹è¯•ï¼Œä¸éœ€è¦å¯åŠ¨çœŸå®çš„ zookeeper æœåŠ¡ç«¯ï¼š

```xml
<dependency>
    <groupId>org.apache.curator</groupId>
    <artifactId>curator-test</artifactId>
    <version>2.12.0</version>
</dependency>
```

é¦–å…ˆæˆ‘ä»¬åˆ›å»ºäº† 10 ä¸ª LeaderLatchï¼Œå¯åŠ¨åå®ƒä»¬ä¸­çš„ä¸€ä¸ªä¼šè¢«é€‰ä¸¾ä¸º leaderã€‚ å› ä¸ºé€‰ä¸¾ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´ï¼Œstart åå¹¶ä¸èƒ½é©¬ä¸Šå°±å¾—åˆ° leaderã€‚  
é€šè¿‡ `hasLeadership` æŸ¥çœ‹è‡ªå·±æ˜¯å¦æ˜¯ leaderï¼Œ å¦‚æœæ˜¯çš„è¯è¿”å› trueã€‚  
å¯ä»¥é€šè¿‡ `.getLeader().getId()` å¯ä»¥å¾—åˆ°å½“å‰çš„ leader çš„ IDã€‚  
åªèƒ½é€šè¿‡ `close` é‡Šæ”¾å½“å‰çš„é¢†å¯¼æƒã€‚  
`await` æ˜¯ä¸€ä¸ªé˜»å¡æ–¹æ³•ï¼Œ å°è¯•è·å– leader åœ°ä½ï¼Œä½†æ˜¯æœªå¿…èƒ½ä¸Šä½ã€‚

#### LeaderSelector

LeaderSelector ä½¿ç”¨çš„æ—¶å€™ä¸»è¦æ¶‰åŠä¸‹é¢å‡ ä¸ªç±»ï¼š

- LeaderSelector
- LeaderSelectorListener
- LeaderSelectorListenerAdapter
- CancelLeadershipException

æ ¸å¿ƒç±»æ˜¯ LeaderSelectorï¼Œå®ƒçš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š

```java
public LeaderSelector(CuratorFramework client, String mutexPath,LeaderSelectorListener listener)
public LeaderSelector(CuratorFramework client, String mutexPath, ThreadFactory threadFactory, Executor executor, LeaderSelectorListener listener)
```

ç±»ä¼¼ LeaderLatch,LeaderSelector å¿…é¡» `start`:Â `leaderSelector.start();`Â  ä¸€æ—¦å¯åŠ¨ï¼Œå½“å®ä¾‹å–å¾—é¢†å¯¼æƒæ—¶ä½ çš„ listener çš„ `takeLeadership()` æ–¹æ³•è¢«è°ƒç”¨ã€‚è€Œ takeLeadership() æ–¹æ³•åªæœ‰é¢†å¯¼æƒè¢«é‡Šæ”¾æ—¶æ‰è¿”å›ã€‚ å½“ä½ ä¸å†ä½¿ç”¨ LeaderSelector å®ä¾‹æ—¶ï¼Œåº”è¯¥è°ƒç”¨å®ƒçš„ close æ–¹æ³•ã€‚

**å¼‚å¸¸å¤„ç†**Â LeaderSelectorListener ç±»ç»§æ‰¿ ConnectionStateListenerã€‚LeaderSelector å¿…é¡»å°å¿ƒè¿æ¥çŠ¶æ€çš„æ”¹å˜ã€‚å¦‚æœå®ä¾‹æˆä¸º leader, å®ƒåº”è¯¥å“åº” SUSPENDED æˆ– LOSTã€‚ å½“ SUSPENDED çŠ¶æ€å‡ºç°æ—¶ï¼Œ å®ä¾‹å¿…é¡»å‡å®šåœ¨é‡æ–°è¿æ¥æˆåŠŸä¹‹å‰å®ƒå¯èƒ½ä¸å†æ˜¯ leader äº†ã€‚ å¦‚æœ LOST çŠ¶æ€å‡ºç°ï¼Œ å®ä¾‹ä¸å†æ˜¯ leaderï¼Œ takeLeadership æ–¹æ³•è¿”å›ã€‚

**é‡è¦**: æ¨èå¤„ç†æ–¹å¼æ˜¯å½“æ”¶åˆ° SUSPENDED æˆ– LOST æ—¶æŠ›å‡º CancelLeadershipException å¼‚å¸¸.ã€‚è¿™ä¼šå¯¼è‡´ LeaderSelector å®ä¾‹ä¸­æ–­å¹¶å–æ¶ˆæ‰§è¡Œ takeLeadership æ–¹æ³•çš„å¼‚å¸¸.ã€‚è¿™éå¸¸é‡è¦ï¼Œ ä½ å¿…é¡»è€ƒè™‘æ‰©å±• LeaderSelectorListenerAdapter. LeaderSelectorListenerAdapter æä¾›äº†æ¨èçš„å¤„ç†é€»è¾‘ã€‚

ä¸‹é¢çš„ä¸€ä¸ªä¾‹å­æ‘˜æŠ„è‡ªå®˜æ–¹ï¼š

```java
public class LeaderSelectorAdapter extends LeaderSelectorListenerAdapter implements Closeable {
    private final String name;
    private final LeaderSelector leaderSelector;
    private final AtomicInteger leaderCount = new AtomicInteger();

    public LeaderSelectorAdapter(CuratorFramework client, String path, String name) {
        this.name = name;
        leaderSelector = new LeaderSelector(client, path, this);
        leaderSelector.autoRequeue();
    }

    public void start() throws IOException {
        leaderSelector.start();
    }

    @Override
    public void close() throws IOException {
        leaderSelector.close();
    }

    @Override
    public void takeLeadership(CuratorFramework client) throws Exception {
        final int waitSeconds = (int) (5 * Math.random()) + 1;
        System.out.println(name + " is now the leader. Waiting " + waitSeconds + " seconds...");
        System.out.println(name + " has been leader " + leaderCount.getAndIncrement() + " time(s) before.");
        try {
            Thread.sleep(TimeUnit.SECONDS.toMillis(waitSeconds));
        } catch (InterruptedException e) {
            System.err.println(name + " was interrupted.");
            Thread.currentThread().interrupt();
        } finally {
            System.out.println(name + " relinquishing leadership.\n");
        }
    }
}
```

ä½ å¯ä»¥åœ¨ takeLeadership è¿›è¡Œä»»åŠ¡çš„åˆ†é…ç­‰ç­‰ï¼Œå¹¶ä¸”ä¸è¦è¿”å›ï¼Œå¦‚æœä½ æƒ³è¦è¦æ­¤å®ä¾‹ä¸€ç›´æ˜¯ leader çš„è¯å¯ä»¥åŠ ä¸€ä¸ªæ­»å¾ªç¯ã€‚è°ƒç”¨ Â `leaderSelector.autoRequeue();` ä¿è¯åœ¨æ­¤å®ä¾‹é‡Šæ”¾é¢†å¯¼æƒä¹‹åè¿˜å¯èƒ½è·å¾—é¢†å¯¼æƒã€‚ åœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ AtomicInteger æ¥è®°å½•æ­¤ client è·å¾—é¢†å¯¼æƒçš„æ¬¡æ•°ï¼Œ å®ƒæ˜¯â€fairâ€ï¼Œ æ¯ä¸ª client æœ‰å¹³ç­‰çš„æœºä¼šè·å¾—é¢†å¯¼æƒã€‚

```java
public class LeaderSelectorDemo {

    protected static String PATH = "/francis/leader";
    private static final int CLIENT_QTY = 10;

    public static void main(String[] args) throws Exception {
        List<CuratorFramework> clients = Lists.newArrayList();
        List<LeaderSelectorAdapter> examples = Lists.newArrayList();
        TestingServer server = new TestingServer();
        try {
            for (int i = 0; i < CLIENT_QTY; i++) {
                CuratorFramework client
                        = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(20000, 3));
                clients.add(client);
                LeaderSelectorAdapter selectorAdapter = new LeaderSelectorAdapter(client, PATH, "Client #" + i);
                examples.add(selectorAdapter);
                client.start();
                selectorAdapter.start();
            }
            System.out.println("Press enter/return to quit\n");
            new BufferedReader(new InputStreamReader(System.in)).readLine();
        } finally {
            System.out.println("Shutting down...");
            for (LeaderSelectorAdapter exampleClient : examples) {
                CloseableUtils.closeQuietly(exampleClient);
            }
            for (CuratorFramework client : clients) {
                CloseableUtils.closeQuietly(client);
            }
            CloseableUtils.closeQuietly(server);
        }
    }
}
```

å¯¹æ¯”å¯çŸ¥ï¼ŒLeaderLatch å¿…é¡»è°ƒç”¨ `close()` æ–¹æ³•æ‰ä¼šé‡Šæ”¾é¢†å¯¼æƒï¼Œè€Œå¯¹äº LeaderSelectorï¼Œé€šè¿‡ `LeaderSelectorListener` å¯ä»¥å¯¹é¢†å¯¼æƒè¿›è¡Œæ§åˆ¶ï¼Œ åœ¨é€‚å½“çš„æ—¶å€™é‡Šæ”¾é¢†å¯¼æƒï¼Œè¿™æ ·æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰å¯èƒ½è·å¾—é¢†å¯¼æƒã€‚ä»è€Œï¼ŒLeaderSelector å…·æœ‰æ›´å¥½çš„çµæ´»æ€§å’Œå¯æ§æ€§ï¼Œå»ºè®®æœ‰ LeaderElection åº”ç”¨åœºæ™¯ä¸‹ä¼˜å…ˆä½¿ç”¨ LeaderSelectorã€‚

### åˆ†å¸ƒå¼é”

**æé†’ï¼š**

1.æ¨èä½¿ç”¨ ConnectionStateListener ç›‘æ§è¿æ¥çš„çŠ¶æ€ï¼Œå› ä¸ºå½“è¿æ¥ LOST æ—¶ä½ ä¸å†æ‹¥æœ‰é”

2.åˆ†å¸ƒå¼çš„é”å…¨å±€åŒæ­¥ï¼Œ è¿™æ„å‘³ç€ä»»ä½•ä¸€ä¸ªæ—¶é—´ç‚¹ä¸ä¼šæœ‰ä¸¤ä¸ªå®¢æˆ·ç«¯éƒ½æ‹¥æœ‰ç›¸åŒçš„é”ã€‚

#### å¯é‡å…¥å…±äº«é”â€”Shared Reentrant Lock

**Shared æ„å‘³ç€é”æ˜¯å…¨å±€å¯è§çš„**ï¼Œ å®¢æˆ·ç«¯éƒ½å¯ä»¥è¯·æ±‚é”ã€‚ Reentrant å’Œ JDK çš„ ReentrantLock ç±»ä¼¼ï¼Œå³å¯é‡å…¥ï¼Œ æ„å‘³ç€åŒä¸€ä¸ªå®¢æˆ·ç«¯åœ¨æ‹¥æœ‰é”çš„åŒæ—¶ï¼Œå¯ä»¥å¤šæ¬¡è·å–ï¼Œä¸ä¼šè¢«é˜»å¡ã€‚ å®ƒæ˜¯ç”±ç±» `InterProcessMutex` æ¥å®ç°ã€‚ å®ƒçš„æ„é€ å‡½æ•°ä¸ºï¼š

```java
public InterProcessMutex(CuratorFramework client, String path)
```

é€šè¿‡ `acquire()` è·å¾—é”ï¼Œå¹¶æä¾›è¶…æ—¶æœºåˆ¶ï¼š

```java
public void acquire()
Acquire the mutex - blocking until it's available. Note: the same thread can call acquire
re-entrantly. Each call to acquire must be balanced by a call to release()

public boolean acquire(long time,TimeUnit unit)
Acquire the mutex - blocks until it's available or the given time expires. Note: the same thread can call acquire re-entrantly. Each call to acquire that returns true must be balanced by a call to release()

Parameters:
time - time to wait
unit - time unit
Returns:
true if the mutex was acquired, false if not
```

é€šè¿‡ `release()` æ–¹æ³•é‡Šæ”¾é”ã€‚ InterProcessMutex å®ä¾‹å¯ä»¥é‡ç”¨ã€‚

**Revoking**Â ZooKeeper recipes wiki å®šä¹‰äº†å¯åå•†çš„æ’¤é”€æœºåˆ¶ã€‚ ä¸ºäº†æ’¤é”€ mutex, è°ƒç”¨ä¸‹é¢çš„æ–¹æ³•ï¼š

```java
public void makeRevocable(RevocationListener<T> listener)
å°†é”è®¾ä¸ºå¯æ’¤é”€çš„. å½“åˆ«çš„è¿›ç¨‹æˆ–çº¿ç¨‹æƒ³è®©ä½ é‡Šæ”¾é”æ—¶Listenerä¼šè¢«è°ƒç”¨ã€‚
Parameters:
listener - the listener
```

å¦‚æœä½ è¯·æ±‚æ’¤é”€å½“å‰çš„é”ï¼Œ è°ƒç”¨ `attemptRevoke()` æ–¹æ³•,æ³¨æ„é”é‡Šæ”¾æ—¶ `RevocationListener` å°†ä¼šå›è°ƒã€‚

```java
public static void attemptRevoke(CuratorFramework client,String path) throws Exception
Utility to mark a lock for revocation. Assuming that the lock has been registered
with a RevocationListener, it will get called and the lock should be released. Note,
however, that revocation is cooperative.
Parameters:
client - the client
path - the path of the lock - usually from something like InterProcessMutex.getParticipantNodes()
```

**äºŒæ¬¡æé†’ï¼šé”™è¯¯å¤„ç†**Â  è¿˜æ˜¯å¼ºçƒˆæ¨èä½ ä½¿ç”¨ `ConnectionStateListener` å¤„ç†è¿æ¥çŠ¶æ€çš„æ”¹å˜ã€‚ å½“è¿æ¥ LOST æ—¶ä½ ä¸å†æ‹¥æœ‰é”ã€‚

é¦–å…ˆè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿçš„å…±äº«èµ„æºï¼Œ è¿™ä¸ªèµ„æºæœŸæœ›åªèƒ½å•çº¿ç¨‹çš„è®¿é—®ï¼Œå¦åˆ™ä¼šæœ‰å¹¶å‘é—®é¢˜ã€‚

```java
public class FakeLimitedResource {
    private final AtomicBoolean inUse = new AtomicBoolean(false);

    public void use() throws InterruptedException {
        // çœŸå®ç¯å¢ƒä¸­æˆ‘ä»¬ä¼šåœ¨è¿™é‡Œè®¿é—®/ç»´æŠ¤ä¸€ä¸ªå…±äº«çš„èµ„æº
        //è¿™ä¸ªä¾‹å­åœ¨ä½¿ç”¨é”çš„æƒ…å†µä¸‹ä¸ä¼šéæ³•å¹¶å‘å¼‚å¸¸IllegalStateException
        //ä½†æ˜¯åœ¨æ— é”çš„æƒ…å†µç”±äºsleepäº†ä¸€æ®µæ—¶é—´ï¼Œå¾ˆå®¹æ˜“æŠ›å‡ºå¼‚å¸¸
        if (!inUse.compareAndSet(false, true)) {
            throw new IllegalStateException("Needs to be used by one client at a time");
        }
        try {
            Thread.sleep((long) (3 * Math.random()));
        } finally {
            inUse.set(false);
        }
    }
}
```

ç„¶ååˆ›å»ºä¸€ä¸ª `InterProcessMutexDemo` ç±»ï¼Œ å®ƒè´Ÿè´£è¯·æ±‚é”ï¼Œ ä½¿ç”¨èµ„æºï¼Œé‡Šæ”¾é”è¿™æ ·ä¸€ä¸ªå®Œæ•´çš„è®¿é—®è¿‡ç¨‹ã€‚

```java
public class InterProcessMutexDemo {

    private InterProcessMutex lock;
    private final FakeLimitedResource resource;
    private final String clientName;

    public InterProcessMutexDemo(CuratorFramework client, String lockPath, FakeLimitedResource resource, String clientName) {
        this.resource = resource;
        this.clientName = clientName;
        this.lock = new InterProcessMutex(client, lockPath);
    }

    public void doWork(long time, TimeUnit unit) throws Exception {
        if (!lock.acquire(time, unit)) {
            throw new IllegalStateException(clientName + " could not acquire the lock");
        }
        try {
            System.out.println(clientName + " get the lock");
            resource.use(); //access resource exclusively
        } finally {
            System.out.println(clientName + " releasing the lock");
            lock.release(); // always release the lock in a finally block
        }
    }

    private static final int QTY = 5;
    private static final int REPETITIONS = QTY * 10;
    private static final String PATH = "/examples/locks";

    public static void main(String[] args) throws Exception {
        final FakeLimitedResource resource = new FakeLimitedResource();
        ExecutorService service = Executors.newFixedThreadPool(QTY);
        final TestingServer server = new TestingServer();
        try {
            for (int i = 0; i < QTY; ++i) {
                final int index = i;
                Callable<Void> task = new Callable<Void>() {
                    @Override
                    public Void call() throws Exception {
                        CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3));
                        try {
                            client.start();
                            final InterProcessMutexDemo example = new InterProcessMutexDemo(client, PATH, resource, "Client " + index);
                            for (int j = 0; j < REPETITIONS; ++j) {
                                example.doWork(10, TimeUnit.SECONDS);
                            }
                        } catch (Throwable e) {
                            e.printStackTrace();
                        } finally {
                            CloseableUtils.closeQuietly(client);
                        }
                        return null;
                    }
                };
                service.submit(task);
            }
            service.shutdown();
            service.awaitTermination(10, TimeUnit.MINUTES);
        } finally {
            CloseableUtils.closeQuietly(server);
        }
    }
}
```

ä»£ç ä¹Ÿå¾ˆç®€å•ï¼Œç”Ÿæˆ 10 ä¸ª clientï¼Œ æ¯ä¸ª client é‡å¤æ‰§è¡Œ 10 æ¬¡ è¯·æ±‚é”â€“è®¿é—®èµ„æºâ€“é‡Šæ”¾é”çš„è¿‡ç¨‹ã€‚æ¯ä¸ª client éƒ½åœ¨ç‹¬ç«‹çš„çº¿ç¨‹ä¸­ã€‚ ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œé”æ˜¯éšæœºçš„è¢«æ¯ä¸ªå®ä¾‹æ’ä»–æ€§çš„ä½¿ç”¨ã€‚

æ—¢ç„¶æ˜¯å¯é‡ç”¨çš„ï¼Œä½ å¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¤šæ¬¡è°ƒç”¨ `acquire()`,åœ¨çº¿ç¨‹æ‹¥æœ‰é”æ—¶å®ƒæ€»æ˜¯è¿”å› trueã€‚

**ä½ ä¸åº”è¯¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­ç”¨åŒä¸€ä¸ª `InterProcessMutex`**ï¼Œ ä½ å¯ä»¥åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­éƒ½ç”Ÿæˆä¸€ä¸ªæ–°çš„ InterProcessMutex å®ä¾‹ï¼Œå®ƒä»¬çš„ path éƒ½ä¸€æ ·ï¼Œè¿™æ ·å®ƒä»¬å¯ä»¥å…±äº«åŒä¸€ä¸ªé”ã€‚

#### ä¸å¯é‡å…¥å…±äº«é”â€”Shared Lock

è¿™ä¸ªé”å’Œä¸Šé¢çš„ `InterProcessMutex` ç›¸æ¯”ï¼Œå°±æ˜¯å°‘äº† Reentrant çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ„å‘³ç€å®ƒä¸èƒ½åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­é‡å…¥ã€‚è¿™ä¸ªç±»æ˜¯ `InterProcessSemaphoreMutex`,ä½¿ç”¨æ–¹æ³•å’Œ `InterProcessMutex` ç±»ä¼¼

```java
public class InterProcessSemaphoreMutexDemo {

    private InterProcessSemaphoreMutex lock;
    private final FakeLimitedResource resource;
    private final String clientName;

    public InterProcessSemaphoreMutexDemo(CuratorFramework client, String lockPath, FakeLimitedResource resource, String clientName) {
        this.resource = resource;
        this.clientName = clientName;
        this.lock = new InterProcessSemaphoreMutex(client, lockPath);
    }

    public void doWork(long time, TimeUnit unit) throws Exception {
        if (!lock.acquire(time, unit))
        {
            throw new IllegalStateException(clientName + " ä¸èƒ½å¾—åˆ°äº’æ–¥é”");
        }
        System.out.println(clientName + " å·²è·å–åˆ°äº’æ–¥é”");
        if (!lock.acquire(time, unit))
        {
            throw new IllegalStateException(clientName + " ä¸èƒ½å¾—åˆ°äº’æ–¥é”");
        }
        System.out.println(clientName + " å†æ¬¡è·å–åˆ°äº’æ–¥é”");
        try {
            System.out.println(clientName + " get the lock");
            resource.use(); //access resource exclusively
        } finally {
            System.out.println(clientName + " releasing the lock");
            lock.release(); // always release the lock in a finally block
            lock.release(); // è·å–é”å‡ æ¬¡ é‡Šæ”¾é”ä¹Ÿè¦å‡ æ¬¡
        }
    }

    private static final int QTY = 5;
    private static final int REPETITIONS = QTY * 10;
    private static final String PATH = "/examples/locks";

    public static void main(String[] args) throws Exception {
        final FakeLimitedResource resource = new FakeLimitedResource();
        ExecutorService service = Executors.newFixedThreadPool(QTY);
        final TestingServer server = new TestingServer();
        try {
            for (int i = 0; i < QTY; ++i) {
                final int index = i;
                Callable<Void> task = new Callable<Void>() {
                    @Override
                    public Void call() throws Exception {
                        CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3));
                        try {
                            client.start();
                            final InterProcessSemaphoreMutexDemo example = new InterProcessSemaphoreMutexDemo(client, PATH, resource, "Client " + index);
                            for (int j = 0; j < REPETITIONS; ++j) {
                                example.doWork(10, TimeUnit.SECONDS);
                            }
                        } catch (Throwable e) {
                            e.printStackTrace();
                        } finally {
                            CloseableUtils.closeQuietly(client);
                        }
                        return null;
                    }
                };
                service.submit(task);
            }
            service.shutdown();
            service.awaitTermination(10, TimeUnit.MINUTES);
        } finally {
            CloseableUtils.closeQuietly(server);
        }
        Thread.sleep(Integer.MAX_VALUE);
    }
}
```

è¿è¡Œåå‘ç°ï¼Œæœ‰ä¸”åªæœ‰ä¸€ä¸ª client æˆåŠŸè·å–ç¬¬ä¸€ä¸ªé” (ç¬¬ä¸€ä¸ª `acquire()` æ–¹æ³•è¿”å› true)ï¼Œç„¶åå®ƒè‡ªå·±é˜»å¡åœ¨ç¬¬äºŒä¸ª `acquire()` æ–¹æ³•ï¼Œè·å–ç¬¬äºŒä¸ªé”è¶…æ—¶ï¼›å…¶ä»–æ‰€æœ‰çš„å®¢æˆ·ç«¯éƒ½é˜»å¡åœ¨ç¬¬ä¸€ä¸ª `acquire()` æ–¹æ³•è¶…æ—¶å¹¶ä¸”æŠ›å‡ºå¼‚å¸¸ã€‚

è¿™æ ·ä¹Ÿå°±éªŒè¯äº† `InterProcessSemaphoreMutex` å®ç°çš„é”æ˜¯ä¸å¯é‡å…¥çš„ã€‚

#### å¯é‡å…¥è¯»å†™é”â€”Shared Reentrant Read Write Lock

ç±»ä¼¼ JDK çš„**ReentrantReadWriteLock**ã€‚ä¸€ä¸ªè¯»å†™é”ç®¡ç†ä¸€å¯¹ç›¸å…³çš„é”ã€‚ä¸€ä¸ªè´Ÿè´£è¯»æ“ä½œï¼Œå¦å¤–ä¸€ä¸ªè´Ÿè´£å†™æ“ä½œã€‚è¯»æ“ä½œåœ¨å†™é”æ²¡è¢«ä½¿ç”¨æ—¶å¯åŒæ—¶ç”±å¤šä¸ªè¿›ç¨‹ä½¿ç”¨ï¼Œè€Œå†™é”åœ¨ä½¿ç”¨æ—¶ä¸å…è®¸è¯» (é˜»å¡)ã€‚

æ­¤é”æ˜¯å¯é‡å…¥çš„ã€‚**ä¸€ä¸ªæ‹¥æœ‰å†™é”çš„çº¿ç¨‹å¯é‡å…¥è¯»é”ï¼Œä½†æ˜¯è¯»é”å´ä¸èƒ½è¿›å…¥å†™é”**ã€‚è¿™ä¹Ÿæ„å‘³ç€**å†™é”å¯ä»¥é™çº§æˆè¯»é”ï¼Œ æ¯”å¦‚è¯·æ±‚å†™é” --->è¯·æ±‚è¯»é” --->é‡Šæ”¾è¯»é” ---->é‡Šæ”¾å†™é”**ã€‚ä»è¯»é”å‡çº§æˆå†™é”æ˜¯ä¸è¡Œçš„ã€‚

å¯é‡å…¥è¯»å†™é”ä¸»è¦ç”±ä¸¤ä¸ªç±»å®ç°ï¼š`InterProcessReadWriteLock`ã€`InterProcessMutex`ã€‚ä½¿ç”¨æ—¶é¦–å…ˆåˆ›å»ºä¸€ä¸ª `InterProcessReadWriteLock` å®ä¾‹ï¼Œç„¶åå†æ ¹æ®ä½ çš„éœ€æ±‚å¾—åˆ°è¯»é”æˆ–è€…å†™é”ï¼Œè¯»å†™é”çš„ç±»å‹æ˜¯ `InterProcessMutex`ã€‚

```java
public class ReentrantReadWriteLockDemo {

    private final InterProcessReadWriteLock lock;
    private final InterProcessMutex readLock;
    private final InterProcessMutex writeLock;
    private final FakeLimitedResource resource;
    private final String clientName;

    public ReentrantReadWriteLockDemo(CuratorFramework client, String lockPath, FakeLimitedResource resource, String clientName) {
        this.resource = resource;
        this.clientName = clientName;
        lock = new InterProcessReadWriteLock(client, lockPath);
        readLock = lock.readLock();
        writeLock = lock.writeLock();
    }

    public void doWork(long time, TimeUnit unit) throws Exception {
        // æ³¨æ„åªèƒ½å…ˆå¾—åˆ°å†™é”å†å¾—åˆ°è¯»é”ï¼Œä¸èƒ½åè¿‡æ¥ï¼ï¼ï¼
        if (!writeLock.acquire(time, unit)) {
            throw new IllegalStateException(clientName + " ä¸èƒ½å¾—åˆ°å†™é”");
        }
        System.out.println(clientName + " å·²å¾—åˆ°å†™é”");
        if (!readLock.acquire(time, unit)) {
            throw new IllegalStateException(clientName + " ä¸èƒ½å¾—åˆ°è¯»é”");
        }
        System.out.println(clientName + " å·²å¾—åˆ°è¯»é”");
        try {
            resource.use(); // ä½¿ç”¨èµ„æº
            Thread.sleep(1000);
        } finally {
            System.out.println(clientName + " é‡Šæ”¾è¯»å†™é”");
            readLock.release();
            writeLock.release();
        }
    }

    private static final int QTY = 5;
    private static final int REPETITIONS = QTY ;
    private static final String PATH = "/examples/locks";

    public static void main(String[] args) throws Exception {
        final FakeLimitedResource resource = new FakeLimitedResource();
        ExecutorService service = Executors.newFixedThreadPool(QTY);
        final TestingServer server = new TestingServer();
        try {
            for (int i = 0; i < QTY; ++i) {
                final int index = i;
                Callable<Void> task = new Callable<Void>() {
                    @Override
                    public Void call() throws Exception {
                        CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3));
                        try {
                            client.start();
                            final ReentrantReadWriteLockDemo example = new ReentrantReadWriteLockDemo(client, PATH, resource, "Client " + index);
                            for (int j = 0; j < REPETITIONS; ++j) {
                                example.doWork(10, TimeUnit.SECONDS);
                            }
                        } catch (Throwable e) {
                            e.printStackTrace();
                        } finally {
                            CloseableUtils.closeQuietly(client);
                        }
                        return null;
                    }
                };
                service.submit(task);
            }
            service.shutdown();
            service.awaitTermination(10, TimeUnit.MINUTES);
        } finally {
            CloseableUtils.closeQuietly(server);
        }
    }
}
```

#### ä¿¡å·é‡â€”Shared Semaphore

ä¸€ä¸ªè®¡æ•°çš„ä¿¡å·é‡ç±»ä¼¼ JDK çš„ Semaphoreã€‚ JDK ä¸­ Semaphore ç»´æŠ¤çš„ä¸€ç»„è®¸å¯ (**permits**)ï¼Œè€Œ Curator ä¸­ç§°ä¹‹ä¸ºç§Ÿçº¦ (**Lease**)ã€‚ æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥å†³å®š semaphore çš„æœ€å¤§ç§Ÿçº¦æ•°ã€‚ç¬¬ä¸€ç§æ–¹å¼æ˜¯ç”¨æˆ·ç»™å®š path å¹¶ä¸”æŒ‡å®šæœ€å¤§ LeaseSizeã€‚ç¬¬äºŒç§æ–¹å¼ç”¨æˆ·ç»™å®š path å¹¶ä¸”ä½¿ç”¨ `SharedCountReader` ç±»ã€‚**å¦‚æœä¸ä½¿ç”¨ SharedCountReader, å¿…é¡»ä¿è¯æ‰€æœ‰å®ä¾‹åœ¨å¤šè¿›ç¨‹ä¸­ä½¿ç”¨ç›¸åŒçš„ (æœ€å¤§) ç§Ÿçº¦æ•°é‡,å¦åˆ™æœ‰å¯èƒ½å‡ºç° A è¿›ç¨‹ä¸­çš„å®ä¾‹æŒæœ‰æœ€å¤§ç§Ÿçº¦æ•°é‡ä¸º 10ï¼Œä½†æ˜¯åœ¨ B è¿›ç¨‹ä¸­æŒæœ‰çš„æœ€å¤§ç§Ÿçº¦æ•°é‡ä¸º 20ï¼Œæ­¤æ—¶ç§Ÿçº¦çš„æ„ä¹‰å°±å¤±æ•ˆäº†ã€‚**

è¿™æ¬¡è°ƒç”¨ `acquire()` ä¼šè¿”å›ä¸€ä¸ªç§Ÿçº¦å¯¹è±¡ã€‚ å®¢æˆ·ç«¯å¿…é¡»åœ¨ finally ä¸­ close è¿™äº›ç§Ÿçº¦å¯¹è±¡ï¼Œå¦åˆ™è¿™äº›ç§Ÿçº¦ä¼šä¸¢å¤±æ‰ã€‚ ä½†æ˜¯ï¼Œ ä½†æ˜¯ï¼Œå¦‚æœå®¢æˆ·ç«¯ session ç”±äºæŸç§åŸå› æ¯”å¦‚ crash ä¸¢æ‰ï¼Œ é‚£ä¹ˆè¿™äº›å®¢æˆ·ç«¯æŒæœ‰çš„ç§Ÿçº¦ä¼šè‡ªåŠ¨ closeï¼Œ è¿™æ ·å…¶å®ƒå®¢æˆ·ç«¯å¯ä»¥ç»§ç»­ä½¿ç”¨è¿™äº›ç§Ÿçº¦ã€‚ ç§Ÿçº¦è¿˜å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼è¿”è¿˜ï¼š

```java
public void returnAll(Collection<Lease> leases)
public void returnLease(Lease lease)
```

æ³¨æ„ä½ å¯ä»¥ä¸€æ¬¡æ€§è¯·æ±‚å¤šä¸ªç§Ÿçº¦ï¼Œå¦‚æœ Semaphore å½“å‰çš„ç§Ÿçº¦ä¸å¤Ÿï¼Œåˆ™è¯·æ±‚çº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚ åŒæ—¶è¿˜æä¾›äº†è¶…æ—¶çš„é‡è½½æ–¹æ³•ã€‚

```java
public Lease acquire()
public Collection<Lease> acquire(int qty)
public Lease acquire(long time, TimeUnit unit)
public Collection<Lease> acquire(int qty, long time, TimeUnit unit)
```

Shared Semaphore ä½¿ç”¨çš„ä¸»è¦ç±»åŒ…æ‹¬ä¸‹é¢å‡ ä¸ªï¼š

- `InterProcessSemaphoreV2`
- `Lease`
- `SharedCountReader`

```java
public class InterProcessSemaphoreDemo {

    private static final int MAX_LEASE = 10;
    private static final String PATH = "/examples/locks";

    public static void main(String[] args) throws Exception {
        FakeLimitedResource resource = new FakeLimitedResource();
        try (TestingServer server = new TestingServer()) {

            CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3));
            client.start();

            InterProcessSemaphoreV2 semaphore = new InterProcessSemaphoreV2(client, PATH, MAX_LEASE);
            Collection<Lease> leases = semaphore.acquire(5);
            System.out.println("get " + leases.size() + " leases");
            Lease lease = semaphore.acquire();
            System.out.println("get another lease");

            resource.use();

            Collection<Lease> leases2 = semaphore.acquire(5, 10, TimeUnit.SECONDS);
            System.out.println("Should timeout and acquire return " + leases2);

            System.out.println("return one lease");
            semaphore.returnLease(lease);
            System.out.println("return another 5 leases");
            semaphore.returnAll(leases);
        }
    }
}
```

é¦–å…ˆæˆ‘ä»¬å…ˆè·å¾—äº† 5 ä¸ªç§Ÿçº¦ï¼Œ æœ€åæˆ‘ä»¬æŠŠå®ƒè¿˜ç»™äº† semaphoreã€‚ æ¥ç€è¯·æ±‚äº†ä¸€ä¸ªç§Ÿçº¦ï¼Œå› ä¸º semaphore è¿˜æœ‰ 5 ä¸ªç§Ÿçº¦ï¼Œæ‰€ä»¥è¯·æ±‚å¯ä»¥æ»¡è¶³ï¼Œè¿”å›ä¸€ä¸ªç§Ÿçº¦ï¼Œè¿˜å‰© 4 ä¸ªç§Ÿçº¦ã€‚ ç„¶åå†è¯·æ±‚ä¸€ä¸ªç§Ÿçº¦ï¼Œå› ä¸ºç§Ÿçº¦ä¸å¤Ÿï¼Œ**é˜»å¡åˆ°è¶…æ—¶ï¼Œè¿˜æ˜¯æ²¡èƒ½æ»¡è¶³ï¼Œè¿”å›ç»“æœä¸º null(ç§Ÿçº¦ä¸è¶³ä¼šé˜»å¡åˆ°è¶…æ—¶ï¼Œç„¶åè¿”å› nullï¼Œä¸ä¼šä¸»åŠ¨æŠ›å‡ºå¼‚å¸¸ï¼›å¦‚æœä¸è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œä¼šä¸€è‡´é˜»å¡)ã€‚**

ä¸Šé¢è¯´è®²çš„é”éƒ½æ˜¯å…¬å¹³é” (fair)ã€‚ æ€» ZooKeeper çš„è§’åº¦çœ‹ï¼Œ æ¯ä¸ªå®¢æˆ·ç«¯éƒ½æŒ‰ç…§è¯·æ±‚çš„é¡ºåºè·å¾—é”ï¼Œä¸å­˜åœ¨éå…¬å¹³çš„æŠ¢å çš„æƒ…å†µã€‚

#### å¤šå…±äº«é”å¯¹è±¡ â€”Multi Shared Lock

Multi Shared Lock æ˜¯ä¸€ä¸ªé”çš„å®¹å™¨ã€‚ å½“è°ƒç”¨ `acquire()`ï¼Œ æ‰€æœ‰çš„é”éƒ½ä¼šè¢« `acquire()`ï¼Œå¦‚æœè¯·æ±‚å¤±è´¥ï¼Œæ‰€æœ‰çš„é”éƒ½ä¼šè¢« releaseã€‚ åŒæ ·è°ƒç”¨ release æ—¶æ‰€æœ‰çš„é”éƒ½è¢« release(**å¤±è´¥è¢«å¿½ç•¥**)ã€‚ åŸºæœ¬ä¸Šï¼Œå®ƒå°±æ˜¯ç»„é”çš„ä»£è¡¨ï¼Œåœ¨å®ƒä¸Šé¢çš„è¯·æ±‚é‡Šæ”¾æ“ä½œéƒ½ä¼šä¼ é€’ç»™å®ƒåŒ…å«çš„æ‰€æœ‰çš„é”ã€‚

ä¸»è¦æ¶‰åŠä¸¤ä¸ªç±»ï¼š

- `InterProcessMultiLock`
- `InterProcessLock`

å®ƒçš„æ„é€ å‡½æ•°éœ€è¦åŒ…å«çš„é”çš„é›†åˆï¼Œæˆ–è€…ä¸€ç»„ ZooKeeper çš„ pathã€‚

```java
public InterProcessMultiLock(List<InterProcessLock> locks)
public InterProcessMultiLock(CuratorFramework client, List<String> paths)
```

ç”¨æ³•å’Œ Shared Lock ç›¸åŒã€‚

```java
public class MultiSharedLockDemo {

    private static final String PATH1 = "/examples/locks1";
    private static final String PATH2 = "/examples/locks2";

    public static void main(String[] args) throws Exception {
        FakeLimitedResource resource = new FakeLimitedResource();
        try (TestingServer server = new TestingServer()) {
            CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3));
            client.start();

            InterProcessLock lock1 = new InterProcessMutex(client, PATH1);
            InterProcessLock lock2 = new InterProcessSemaphoreMutex(client, PATH2);

            InterProcessMultiLock lock = new InterProcessMultiLock(Arrays.asList(lock1, lock2));

            if (!lock.acquire(10, TimeUnit.SECONDS)) {
                throw new IllegalStateException("could not acquire the lock");
            }
            System.out.println("has got all lock");

            System.out.println("has got lock1: " + lock1.isAcquiredInThisProcess());
            System.out.println("has got lock2: " + lock2.isAcquiredInThisProcess());

            try {
                resource.use(); //access resource exclusively
            } finally {
                System.out.println("releasing the lock");
                lock.release(); // always release the lock in a finally block
            }
            System.out.println("has got lock1: " + lock1.isAcquiredInThisProcess());
            System.out.println("has got lock2: " + lock2.isAcquiredInThisProcess());
        }
    }
}
```

æ–°å»ºä¸€ä¸ª `InterProcessMultiLock`ï¼Œ åŒ…å«ä¸€ä¸ªé‡å…¥é”å’Œä¸€ä¸ªéé‡å…¥é”ã€‚ è°ƒç”¨ `acquire()` åå¯ä»¥çœ‹åˆ°çº¿ç¨‹åŒæ—¶æ‹¥æœ‰äº†è¿™ä¸¤ä¸ªé”ã€‚ è°ƒç”¨ `release()` çœ‹åˆ°è¿™ä¸¤ä¸ªé”éƒ½è¢«é‡Šæ”¾äº†ã€‚

**æœ€åå†é‡ç”³ä¸€æ¬¡ï¼Œ å¼ºçƒˆæ¨èä½¿ç”¨ ConnectionStateListener ç›‘æ§è¿æ¥çš„çŠ¶æ€ï¼Œå½“è¿æ¥çŠ¶æ€ä¸º LOSTï¼Œé”å°†ä¼šä¸¢å¤±ã€‚**

### åˆ†å¸ƒå¼è®¡æ•°å™¨

é¡¾åæ€ä¹‰ï¼Œè®¡æ•°å™¨æ˜¯ç”¨æ¥è®¡æ•°çš„, åˆ©ç”¨ ZooKeeper å¯ä»¥å®ç°ä¸€ä¸ªé›†ç¾¤å…±äº«çš„è®¡æ•°å™¨ã€‚ åªè¦ä½¿ç”¨ç›¸åŒçš„ path å°±å¯ä»¥å¾—åˆ°æœ€æ–°çš„è®¡æ•°å™¨å€¼ï¼Œ è¿™æ˜¯ç”± ZooKeeper çš„ä¸€è‡´æ€§ä¿è¯çš„ã€‚Curator æœ‰ä¸¤ä¸ªè®¡æ•°å™¨ï¼Œ ä¸€ä¸ªæ˜¯ç”¨ int æ¥è®¡æ•° (`SharedCount`)ï¼Œä¸€ä¸ªç”¨ long æ¥è®¡æ•° (`DistributedAtomicLong`)ã€‚

#### åˆ†å¸ƒå¼ int è®¡æ•°å™¨â€”SharedCount

è¿™ä¸ªç±»ä½¿ç”¨ int ç±»å‹æ¥è®¡æ•°ã€‚ ä¸»è¦æ¶‰åŠä¸‰ä¸ªç±»ã€‚

- SharedCount
- SharedCountReader
- SharedCountListener

`SharedCount` ä»£è¡¨è®¡æ•°å™¨ï¼Œ å¯ä»¥ä¸ºå®ƒå¢åŠ ä¸€ä¸ª `SharedCountListener`ï¼Œå½“è®¡æ•°å™¨æ”¹å˜æ—¶æ­¤ Listener å¯ä»¥ç›‘å¬åˆ°æ”¹å˜çš„äº‹ä»¶ï¼Œè€Œ `SharedCountReader` å¯ä»¥è¯»å–åˆ°æœ€æ–°çš„å€¼ï¼Œ åŒ…æ‹¬å­—é¢å€¼å’Œå¸¦ç‰ˆæœ¬ä¿¡æ¯çš„å€¼ VersionedValueã€‚

```java
public class SharedCounterDemo implements SharedCountListener {

    private static final int QTY = 5;
    private static final String PATH = "/examples/counter";

    public static void main(String[] args) throws IOException, Exception {
        final Random rand = new Random();
        SharedCounterDemo example = new SharedCounterDemo();
        try (TestingServer server = new TestingServer()) {
            CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3));
            client.start();

            SharedCount baseCount = new SharedCount(client, PATH, 0);
            baseCount.addListener(example);
            baseCount.start();

            List<SharedCount> examples = Lists.newArrayList();
            ExecutorService service = Executors.newFixedThreadPool(QTY);
            for (int i = 0; i < QTY; ++i) {
                final SharedCount count = new SharedCount(client, PATH, 0);
                examples.add(count);
                Callable<Void> task = () -> {
                    count.start();
                    Thread.sleep(rand.nextInt(10000));
                    System.out.println("Increment:" + count.trySetCount(count.getVersionedValue(), count.getCount() + rand.nextInt(10)));
                    return null;
                };
                service.submit(task);
            }

            service.shutdown();
            service.awaitTermination(10, TimeUnit.MINUTES);

            for (int i = 0; i < QTY; ++i) {
                examples.get(i).close();
            }
            baseCount.close();
        }
        Thread.sleep(Integer.MAX_VALUE);
    }

    @Override
    public void stateChanged(CuratorFramework arg0, ConnectionState arg1) {
        System.out.println("State changed: " + arg1.toString());
    }

    @Override
    public void countHasChanged(SharedCountReader sharedCount, int newCount) throws Exception {
        System.out.println("Counter's value is changed to " + newCount);
    }
}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `baseCount` æ¥ç›‘å¬è®¡æ•°å€¼ (`addListener` æ–¹æ³•æ¥æ·»åŠ  SharedCountListener )ã€‚ ä»»æ„çš„ SharedCountï¼Œ åªè¦ä½¿ç”¨ç›¸åŒçš„ pathï¼Œéƒ½å¯ä»¥å¾—åˆ°è¿™ä¸ªè®¡æ•°å€¼ã€‚ ç„¶åæˆ‘ä»¬ä½¿ç”¨ 5 ä¸ªçº¿ç¨‹ä¸ºè®¡æ•°å€¼å¢åŠ ä¸€ä¸ª 10 ä»¥å†…çš„éšæœºæ•°ã€‚ç›¸åŒçš„ path çš„ SharedCount å¯¹è®¡æ•°å€¼è¿›è¡Œæ›´æ”¹ï¼Œå°†ä¼šå›è°ƒç»™ `baseCount` çš„ SharedCountListenerã€‚

```java
count.trySetCount(count.getVersionedValue(), count.getCount() + rand.nextInt(10))
```

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ `trySetCount` å»è®¾ç½®è®¡æ•°å™¨ã€‚Â **ç¬¬ä¸€ä¸ªå‚æ•°æä¾›å½“å‰çš„ VersionedValue,å¦‚æœæœŸé—´å…¶å®ƒ client æ›´æ–°äº†æ­¤è®¡æ•°å€¼ï¼Œ ä½ çš„æ›´æ–°å¯èƒ½ä¸æˆåŠŸï¼Œ ä½†æ˜¯è¿™æ—¶ä½ çš„ client æ›´æ–°äº†æœ€æ–°çš„å€¼ï¼Œæ‰€ä»¥å¤±è´¥äº†ä½ å¯ä»¥å°è¯•å†æ›´æ–°ä¸€æ¬¡ã€‚ è€Œ `setCount` æ˜¯å¼ºåˆ¶æ›´æ–°è®¡æ•°å™¨çš„å€¼**ã€‚

æ³¨æ„è®¡æ•°å™¨å¿…é¡» `start`,ä½¿ç”¨å®Œä¹‹åå¿…é¡»è°ƒç”¨ `close` å…³é—­å®ƒã€‚

å¼ºçƒˆæ¨èä½¿ç”¨ `ConnectionStateListener`ã€‚ åœ¨æœ¬ä¾‹ä¸­ `SharedCountListener` æ‰©å±• `ConnectionStateListener`ã€‚

#### åˆ†å¸ƒå¼ long è®¡æ•°å™¨â€”DistributedAtomicLong

å†çœ‹ä¸€ä¸ª Long ç±»å‹çš„è®¡æ•°å™¨ã€‚ é™¤äº†è®¡æ•°çš„èŒƒå›´æ¯” `SharedCount` å¤§äº†ä¹‹å¤–ï¼Œ å®ƒé¦–å…ˆå°è¯•ä½¿ç”¨ä¹è§‚é”çš„æ–¹å¼è®¾ç½®è®¡æ•°å™¨ï¼Œ å¦‚æœä¸æˆåŠŸ (æ¯”å¦‚æœŸé—´è®¡æ•°å™¨å·²ç»è¢«å…¶å®ƒ client æ›´æ–°äº†)ï¼Œ å®ƒä½¿ç”¨ `InterProcessMutex` æ–¹å¼æ¥æ›´æ–°è®¡æ•°å€¼ã€‚

å¯ä»¥ä»å®ƒçš„å†…éƒ¨å®ç° `DistributedAtomicValue.trySet()` ä¸­çœ‹å‡ºï¼š

```java
   AtomicValue<byte[]>   trySet(MakeValue makeValue) throws Exception
    {
        MutableAtomicValue<byte[]>  result = new MutableAtomicValue<byte[]>(null, null, false);

        tryOptimistic(result, makeValue);
        if ( !result.succeeded() && (mutex != null) )
        {
            tryWithMutex(result, makeValue);
        }

        return result;
    }
```

æ­¤è®¡æ•°å™¨æœ‰ä¸€ç³»åˆ—çš„æ“ä½œï¼š

- get(): è·å–å½“å‰å€¼
- increment()ï¼š åŠ ä¸€
- decrement(): å‡ä¸€
- add()ï¼š å¢åŠ ç‰¹å®šçš„å€¼
- subtract(): å‡å»ç‰¹å®šçš„å€¼
- trySet(): å°è¯•è®¾ç½®è®¡æ•°å€¼
- forceSet(): å¼ºåˆ¶è®¾ç½®è®¡æ•°å€¼

ä½ **å¿…é¡»**æ£€æŸ¥è¿”å›ç»“æœçš„ `succeeded()`ï¼Œ å®ƒä»£è¡¨æ­¤æ“ä½œæ˜¯å¦æˆåŠŸã€‚ å¦‚æœæ“ä½œæˆåŠŸï¼ŒÂ `preValue()` ä»£è¡¨æ“ä½œå‰çš„å€¼ï¼ŒÂ `postValue()` ä»£è¡¨æ“ä½œåçš„å€¼ã€‚

```java
public class DistributedAtomicLongDemo {

    private static final int QTY = 5;
    private static final String PATH = "/examples/counter";

    public static void main(String[] args) throws IOException, Exception {
        List<DistributedAtomicLong> examples = Lists.newArrayList();
        try (TestingServer server = new TestingServer()) {
            CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3));
            client.start();
            ExecutorService service = Executors.newFixedThreadPool(QTY);
            for (int i = 0; i < QTY; ++i) {
                final DistributedAtomicLong count = new DistributedAtomicLong(client, PATH, new RetryNTimes(10, 10));

                examples.add(count);
                Callable<Void> task = () -> {
                    try {
                        AtomicValue<Long> value = count.increment();
                        System.out.println("succeed: " + value.succeeded());
                        if (value.succeeded())
                            System.out.println("Increment: from " + value.preValue() + " to " + value.postValue());
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                    return null;
                };
                service.submit(task);
            }

            service.shutdown();
            service.awaitTermination(10, TimeUnit.MINUTES);
            Thread.sleep(Integer.MAX_VALUE);
        }
    }
}
```

### åˆ†å¸ƒå¼é˜Ÿåˆ—

ä½¿ç”¨ Curator ä¹Ÿå¯ä»¥ç®€åŒ– Ephemeral Node (**ä¸´æ—¶èŠ‚ç‚¹**) çš„æ“ä½œã€‚Curator ä¹Ÿæä¾› ZK Recipe çš„åˆ†å¸ƒå¼é˜Ÿåˆ—å®ç°ã€‚ åˆ©ç”¨ ZK çš„ PERSISTENTS_EQUENTIAL èŠ‚ç‚¹ï¼Œ å¯ä»¥ä¿è¯æ”¾å…¥åˆ°é˜Ÿåˆ—ä¸­çš„é¡¹ç›®æ˜¯æŒ‰ç…§é¡ºåºæ’é˜Ÿçš„ã€‚ å¦‚æœå•ä¸€çš„æ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­å–æ•°æ®ï¼Œ é‚£ä¹ˆå®ƒæ˜¯å…ˆå…¥å…ˆå‡ºçš„ï¼Œè¿™ä¹Ÿæ˜¯é˜Ÿåˆ—çš„ç‰¹ç‚¹ã€‚ å¦‚æœä½ ä¸¥æ ¼è¦æ±‚é¡ºåºï¼Œä½ å°±çš„ä½¿ç”¨å•ä¸€çš„æ¶ˆè´¹è€…ï¼Œå¯ä»¥ä½¿ç”¨ Leader é€‰ä¸¾åªè®© Leader ä½œä¸ºå”¯ä¸€çš„æ¶ˆè´¹è€…ã€‚

ä½†æ˜¯ï¼Œ æ ¹æ® Netflix çš„ Curator ä½œè€…æ‰€è¯´ï¼Œ ZooKeeper çœŸå¿ƒä¸é€‚åˆåš Queueï¼Œæˆ–è€…è¯´ ZK æ²¡æœ‰å®ç°ä¸€ä¸ªå¥½çš„ Queueï¼Œè¯¦ç»†å†…å®¹å¯ä»¥çœ‹ Â [Tech Note 4](https://cwiki.apache.org/confluence/display/CURATOR/TN4)ï¼Œ åŸå› æœ‰äº”ï¼š

1. ZK æœ‰ 1MB çš„ä¼ è¾“é™åˆ¶ã€‚ å®è·µä¸­ ZNode å¿…é¡»ç›¸å¯¹è¾ƒå°ï¼Œè€Œé˜Ÿåˆ—åŒ…å«æˆåƒä¸Šä¸‡çš„æ¶ˆæ¯ï¼Œéå¸¸çš„å¤§ã€‚
2. å¦‚æœæœ‰å¾ˆå¤šèŠ‚ç‚¹ï¼ŒZK å¯åŠ¨æ—¶ç›¸å½“çš„æ…¢ã€‚ è€Œä½¿ç”¨ queue ä¼šå¯¼è‡´å¥½å¤š ZNode. ä½ éœ€è¦æ˜¾è‘—å¢å¤§ initLimit å’Œ syncLimit.
3. ZNode å¾ˆå¤§çš„æ—¶å€™å¾ˆéš¾æ¸…ç†ã€‚Netflix ä¸å¾—ä¸åˆ›å»ºäº†ä¸€ä¸ªä¸“é—¨çš„ç¨‹åºåšè¿™äº‹ã€‚
4. å½“å¾ˆå¤§é‡çš„åŒ…å«æˆåƒä¸Šä¸‡çš„å­èŠ‚ç‚¹çš„ ZNode æ—¶ï¼Œ ZK çš„æ€§èƒ½å˜å¾—ä¸å¥½
5. ZK çš„æ•°æ®åº“å®Œå…¨æ”¾åœ¨å†…å­˜ä¸­ã€‚ å¤§é‡çš„ Queue æ„å‘³ç€ä¼šå ç”¨å¾ˆå¤šçš„å†…å­˜ç©ºé—´ã€‚

å°½ç®¡å¦‚æ­¤ï¼Œ Curator è¿˜æ˜¯åˆ›å»ºäº†å„ç§ Queue çš„å®ç°ã€‚ å¦‚æœ Queue çš„æ•°æ®é‡ä¸å¤ªå¤šï¼Œæ•°æ®é‡ä¸å¤ªå¤§çš„æƒ…å†µä¸‹ï¼Œé…Œæƒ…è€ƒè™‘ï¼Œè¿˜æ˜¯å¯ä»¥ä½¿ç”¨çš„ã€‚

#### åˆ†å¸ƒå¼é˜Ÿåˆ—â€”DistributedQueue

DistributedQueue æ˜¯æœ€æ™®é€šçš„ä¸€ç§é˜Ÿåˆ—ã€‚ å®ƒè®¾è®¡ä»¥ä¸‹å››ä¸ªç±»ï¼š

- QueueBuilder - åˆ›å»ºé˜Ÿåˆ—ä½¿ç”¨ QueueBuilder,å®ƒä¹Ÿæ˜¯å…¶å®ƒé˜Ÿåˆ—çš„åˆ›å»ºç±»
- QueueConsumer - é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ¶ˆè´¹è€…æ¥å£
- QueueSerializer - é˜Ÿåˆ—æ¶ˆæ¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ¥å£ï¼Œæä¾›äº†å¯¹é˜Ÿåˆ—ä¸­çš„å¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–
- DistributedQueue - é˜Ÿåˆ—å®ç°ç±»

QueueConsumer æ˜¯æ¶ˆè´¹è€…ï¼Œå®ƒå¯ä»¥æ¥æ”¶é˜Ÿåˆ—çš„æ•°æ®ã€‚å¤„ç†é˜Ÿåˆ—ä¸­çš„æ•°æ®çš„ä»£ç é€»è¾‘å¯ä»¥æ”¾åœ¨ QueueConsumer.consumeMessage() ä¸­ã€‚

æ­£å¸¸æƒ…å†µä¸‹å…ˆå°†æ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œå†äº¤ç»™æ¶ˆè´¹è€…æ¶ˆè´¹ã€‚ä½†è¿™æ˜¯ä¸¤ä¸ªæ­¥éª¤ï¼Œä¸æ˜¯åŸå­çš„ã€‚å¯ä»¥è°ƒç”¨ Builder çš„ lockPath() æ¶ˆè´¹è€…åŠ é”ï¼Œå½“æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®æ—¶æŒæœ‰é”ï¼Œè¿™æ ·å…¶å®ƒæ¶ˆè´¹è€…ä¸èƒ½æ¶ˆè´¹æ­¤æ¶ˆæ¯ã€‚å¦‚æœæ¶ˆè´¹å¤±è´¥æˆ–è€…è¿›ç¨‹æ­»æ‰ï¼Œæ¶ˆæ¯å¯ä»¥äº¤ç»™å…¶å®ƒè¿›ç¨‹ã€‚è¿™ä¼šå¸¦æ¥ä¸€ç‚¹æ€§èƒ½çš„æŸå¤±ã€‚æœ€å¥½è¿˜æ˜¯å•æ¶ˆè´¹è€…æ¨¡å¼ä½¿ç”¨é˜Ÿåˆ—ã€‚

```java
public class DistributedQueueDemo {

    private static final String PATH = "/example/queue";

    public static void main(String[] args) throws Exception {
        TestingServer server = new TestingServer();
        CuratorFramework clientA = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3));
        clientA.start();
        CuratorFramework clientB = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3));
        clientB.start();
        DistributedQueue<String> queueA;
        QueueBuilder<String> builderA = QueueBuilder.builder(clientA, createQueueConsumer("A"), createQueueSerializer(), PATH);
        queueA = builderA.buildQueue();
        queueA.start();

        DistributedQueue<String> queueB;
        QueueBuilder<String> builderB = QueueBuilder.builder(clientB, createQueueConsumer("B"), createQueueSerializer(), PATH);
        queueB = builderB.buildQueue();
        queueB.start();
        for (int i = 0; i < 100; i++) {
            queueA.put(" test-A-" + i);
            Thread.sleep(10);
            queueB.put(" test-B-" + i);
        }
        Thread.sleep(1000 * 10);// ç­‰å¾…æ¶ˆæ¯æ¶ˆè´¹å®Œæˆ
        queueB.close();
        queueA.close();
        clientB.close();
        clientA.close();
        System.out.println("OK!");
    }

    /**
     * é˜Ÿåˆ—æ¶ˆæ¯åºåˆ—åŒ–å®ç°ç±»
     */
    private static QueueSerializer<String> createQueueSerializer() {
        return new QueueSerializer<String>() {
            @Override
            public byte[] serialize(String item) {
                return item.getBytes();
            }

            @Override
            public String deserialize(byte[] bytes) {
                return new String(bytes);
            }
        };
    }

    /**
     * å®šä¹‰é˜Ÿåˆ—æ¶ˆè´¹è€…
     */
    private static QueueConsumer<String> createQueueConsumer(final String name) {
        return new QueueConsumer<String>() {
            @Override
            public void stateChanged(CuratorFramework client, ConnectionState newState) {
                System.out.println("è¿æ¥çŠ¶æ€æ”¹å˜: " + newState.name());
            }

            @Override
            public void consumeMessage(String message) throws Exception {
                System.out.println("æ¶ˆè´¹æ¶ˆæ¯(" + name + "): " + message);
            }
        };
    }
}
```

ä¾‹å­ä¸­å®šä¹‰äº†ä¸¤ä¸ªåˆ†å¸ƒå¼é˜Ÿåˆ—å’Œä¸¤ä¸ªæ¶ˆè´¹è€…ï¼Œå› ä¸º PATH æ˜¯ç›¸åŒçš„ï¼Œä¼šå­˜åœ¨æ¶ˆè´¹è€…æŠ¢å æ¶ˆè´¹æ¶ˆæ¯çš„æƒ…å†µã€‚

#### å¸¦ Id çš„åˆ†å¸ƒå¼é˜Ÿåˆ—â€”DistributedIdQueue

DistributedIdQueue å’Œä¸Šé¢çš„é˜Ÿåˆ—ç±»ä¼¼ï¼Œ**ä½†æ˜¯å¯ä»¥ä¸ºé˜Ÿåˆ—ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ è®¾ç½®ä¸€ä¸ª ID**ã€‚ å¯ä»¥é€šè¿‡ ID æŠŠé˜Ÿåˆ—ä¸­ä»»æ„çš„å…ƒç´ ç§»é™¤ã€‚ å®ƒæ¶‰åŠå‡ ä¸ªç±»ï¼š

- QueueBuilder
- QueueConsumer
- QueueSerializer
- DistributedQueue

é€šè¿‡ä¸‹é¢æ–¹æ³•åˆ›å»ºï¼š

```java
builder.buildIdQueue()
```

æ”¾å…¥å…ƒç´ æ—¶ï¼š

```java
queue.put(aMessage, messageId);
```

ç§»é™¤å…ƒç´ æ—¶ï¼š

```java
int numberRemoved = queue.remove(messageId);
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ æœ‰äº›å…ƒç´ è¿˜æ²¡æœ‰è¢«æ¶ˆè´¹è€…æ¶ˆè´¹å‰å°±ç§»é™¤äº†ï¼Œè¿™æ ·æ¶ˆè´¹è€…ä¸ä¼šæ”¶åˆ°åˆ é™¤çš„æ¶ˆæ¯ã€‚

```java
public class DistributedIdQueueDemo {

    private static final String PATH = "/example/queue";

    public static void main(String[] args) throws Exception {
        TestingServer server = new TestingServer();
        CuratorFramework client = null;
        DistributedIdQueue<String> queue = null;
        try {
            client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3));
            client.getCuratorListenable().addListener((client1, event) -> System.out.println("CuratorEvent: " + event.getType().name()));

            client.start();
            QueueConsumer<String> consumer = createQueueConsumer();
            QueueBuilder<String> builder = QueueBuilder.builder(client, consumer, createQueueSerializer(), PATH);
            queue = builder.buildIdQueue();
            queue.start();

            for (int i = 0; i < 10; i++) {
                queue.put(" test-" + i, "Id" + i);
                Thread.sleep((long) (15 * Math.random()));
                queue.remove("Id" + i);
            }

            Thread.sleep(20000);

        } catch (Exception ex) {

        } finally {
            CloseableUtils.closeQuietly(queue);
            CloseableUtils.closeQuietly(client);
            CloseableUtils.closeQuietly(server);
        }
    }

    private static QueueSerializer<String> createQueueSerializer() {
        return new QueueSerializer<String>() {

            @Override
            public byte[] serialize(String item) {
                return item.getBytes();
            }

            @Override
            public String deserialize(byte[] bytes) {
                return new String(bytes);
            }

        };
    }

    private static QueueConsumer<String> createQueueConsumer() {

        return new QueueConsumer<String>() {

            @Override
            public void stateChanged(CuratorFramework client, ConnectionState newState) {
                System.out.println("connection new state: " + newState.name());
            }

            @Override
            public void consumeMessage(String message) throws Exception {
                System.out.println("consume one message: " + message);
            }

        };
    }
}
```

#### ä¼˜å…ˆçº§åˆ†å¸ƒå¼é˜Ÿåˆ—â€”DistributedPriorityQueue

ä¼˜å…ˆçº§é˜Ÿåˆ—å¯¹é˜Ÿåˆ—ä¸­çš„å…ƒç´ æŒ‰ç…§ä¼˜å…ˆçº§è¿›è¡Œæ’åºã€‚Â **Priority è¶Šå°ï¼Œ å…ƒç´ è¶Šé å‰ï¼Œ è¶Šå…ˆè¢«æ¶ˆè´¹æ‰**ã€‚ å®ƒæ¶‰åŠä¸‹é¢å‡ ä¸ªç±»ï¼š

- QueueBuilder
- QueueConsumer
- QueueSerializer
- DistributedPriorityQueue

é€šè¿‡ builder.buildPriorityQueue(minItemsBeforeRefresh) æ–¹æ³•åˆ›å»ºã€‚ å½“ä¼˜å…ˆçº§é˜Ÿåˆ—å¾—åˆ°å…ƒç´ å¢åˆ æ¶ˆæ¯æ—¶ï¼Œå®ƒä¼šæš‚åœå¤„ç†å½“å‰çš„å…ƒç´ é˜Ÿåˆ—ï¼Œç„¶ååˆ·æ–°é˜Ÿåˆ—ã€‚minItemsBeforeRefresh æŒ‡å®šåˆ·æ–°å‰å½“å‰æ´»åŠ¨çš„é˜Ÿåˆ—çš„æœ€å°æ•°é‡ã€‚ ä¸»è¦è®¾ç½®ä½ çš„ç¨‹åºå¯ä»¥å®¹å¿çš„ä¸æ’åºçš„æœ€å°å€¼ã€‚

æ”¾å…¥é˜Ÿåˆ—æ—¶éœ€è¦æŒ‡å®šä¼˜å…ˆçº§ï¼š

```java
queue.put(aMessage, priority);
```

ä¾‹å­ï¼š

```java
public class DistributedPriorityQueueDemo {

    private static final String PATH = "/example/queue";

    public static void main(String[] args) throws Exception {
        TestingServer server = new TestingServer();
        CuratorFramework client = null;
        DistributedPriorityQueue<String> queue = null;
        try {
            client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3));
            client.getCuratorListenable().addListener((client1, event) -> System.out.println("CuratorEvent: " + event.getType().name()));

            client.start();
            QueueConsumer<String> consumer = createQueueConsumer();
            QueueBuilder<String> builder = QueueBuilder.builder(client, consumer, createQueueSerializer(), PATH);
            queue = builder.buildPriorityQueue(0);
            queue.start();

            for (int i = 0; i < 10; i++) {
                int priority = (int) (Math.random() * 100);
                System.out.println("test-" + i + " priority:" + priority);
                queue.put("test-" + i, priority);
                Thread.sleep((long) (50 * Math.random()));
            }

            Thread.sleep(20000);

        } catch (Exception ex) {

        } finally {
            CloseableUtils.closeQuietly(queue);
            CloseableUtils.closeQuietly(client);
            CloseableUtils.closeQuietly(server);
        }
    }

    private static QueueSerializer<String> createQueueSerializer() {
        return new QueueSerializer<String>() {

            @Override
            public byte[] serialize(String item) {
                return item.getBytes();
            }

            @Override
            public String deserialize(byte[] bytes) {
                return new String(bytes);
            }

        };
    }

    private static QueueConsumer<String> createQueueConsumer() {

        return new QueueConsumer<String>() {

            @Override
            public void stateChanged(CuratorFramework client, ConnectionState newState) {
                System.out.println("connection new state: " + newState.name());
            }

            @Override
            public void consumeMessage(String message) throws Exception {
                Thread.sleep(1000);
                System.out.println("consume one message: " + message);
            }

        };
    }

}
```

æœ‰æ—¶å€™ä½ å¯èƒ½ä¼šæœ‰é”™è§‰ï¼Œä¼˜å…ˆçº§è®¾ç½®å¹¶æ²¡æœ‰èµ·æ•ˆã€‚é‚£æ˜¯å› ä¸ºä¼˜å…ˆçº§æ˜¯å¯¹äºé˜Ÿåˆ—ç§¯å‹çš„å…ƒç´ è€Œè¨€ï¼Œå¦‚æœæ¶ˆè´¹é€Ÿåº¦è¿‡å¿«æœ‰å¯èƒ½å‡ºç°åœ¨åä¸€ä¸ªå…ƒç´ å…¥é˜Ÿæ“ä½œä¹‹å‰å‰ä¸€ä¸ªå…ƒç´ å·²ç»è¢«æ¶ˆè´¹ï¼Œè¿™ç§æƒ…å†µä¸‹ DistributedPriorityQueue ä¼šé€€åŒ–ä¸º DistributedQueueã€‚

#### åˆ†å¸ƒå¼å»¶è¿Ÿé˜Ÿåˆ—â€”DistributedDelayQueue

JDK ä¸­ä¹Ÿæœ‰ DelayQueueï¼Œä¸çŸ¥é“ä½ æ˜¯å¦ç†Ÿæ‚‰ã€‚ DistributedDelayQueue ä¹Ÿæä¾›äº†ç±»ä¼¼çš„åŠŸèƒ½ï¼Œ å…ƒç´ æœ‰ä¸ª delay å€¼ï¼Œ æ¶ˆè´¹è€…éš”ä¸€æ®µæ—¶é—´æ‰èƒ½æ”¶åˆ°å…ƒç´ ã€‚ æ¶‰åŠåˆ°ä¸‹é¢å››ä¸ªç±»ã€‚

- QueueBuilder
- QueueConsumer
- QueueSerializer
- DistributedDelayQueue

é€šè¿‡ä¸‹é¢çš„è¯­å¥åˆ›å»ºï¼š

```java
QueueBuilder<MessageType>    builder = QueueBuilder.builder(client, consumer, serializer, path);
... more builder method calls as needed ...
DistributedDelayQueue<MessageType> queue = builder.buildDelayQueue();
```

æ”¾å…¥å…ƒç´ æ—¶å¯ä»¥æŒ‡å®š `delayUntilEpoch`ï¼š

```java
queue.put(aMessage, delayUntilEpoch);
```

æ³¨æ„ `delayUntilEpoch` ä¸æ˜¯ç¦»ç°åœ¨çš„ä¸€ä¸ªæ—¶é—´é—´éš”ï¼Œ æ¯”å¦‚ 20 æ¯«ç§’ï¼Œè€Œæ˜¯æœªæ¥çš„ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œå¦‚ System.currentTimeMillis() + 10 ç§’ã€‚ å¦‚æœ delayUntilEpoch çš„æ—¶é—´å·²ç»è¿‡å»ï¼Œæ¶ˆæ¯ä¼šç«‹åˆ»è¢«æ¶ˆè´¹è€…æ¥æ”¶ã€‚

```java
public class DistributedDelayQueueDemo {

    private static final String PATH = "/example/queue";

    public static void main(String[] args) throws Exception {
        TestingServer server = new TestingServer();
        CuratorFramework client = null;
        DistributedDelayQueue<String> queue = null;
        try {
            client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3));
            client.getCuratorListenable().addListener((client1, event) -> System.out.println("CuratorEvent: " + event.getType().name()));

            client.start();
            QueueConsumer<String> consumer = createQueueConsumer();
            QueueBuilder<String> builder = QueueBuilder.builder(client, consumer, createQueueSerializer(), PATH);
            queue = builder.buildDelayQueue();
            queue.start();

            for (int i = 0; i < 10; i++) {
                queue.put("test-" + i, System.currentTimeMillis() + 10000);
            }
            System.out.println(new Date().getTime() + ": already put all items");

            Thread.sleep(20000);

        } catch (Exception ex) {

        } finally {
            CloseableUtils.closeQuietly(queue);
            CloseableUtils.closeQuietly(client);
            CloseableUtils.closeQuietly(server);
        }
    }

    private static QueueSerializer<String> createQueueSerializer() {
        return new QueueSerializer<String>() {

            @Override
            public byte[] serialize(String item) {
                return item.getBytes();
            }

            @Override
            public String deserialize(byte[] bytes) {
                return new String(bytes);
            }

        };
    }

    private static QueueConsumer<String> createQueueConsumer() {

        return new QueueConsumer<String>() {

            @Override
            public void stateChanged(CuratorFramework client, ConnectionState newState) {
                System.out.println("connection new state: " + newState.name());
            }

            @Override
            public void consumeMessage(String message) throws Exception {
                System.out.println(new Date().getTime() + ": consume one message: " + message);
            }

        };
    }
}
```

#### SimpleDistributedQueue

å‰é¢è™½ç„¶å®ç°äº†å„ç§é˜Ÿåˆ—ï¼Œä½†æ˜¯ä½ æ³¨æ„åˆ°æ²¡æœ‰ï¼Œè¿™äº›é˜Ÿåˆ—å¹¶æ²¡æœ‰å®ç°ç±»ä¼¼ JDK ä¸€æ ·çš„æ¥å£ã€‚Â `SimpleDistributedQueue` æä¾›äº†å’Œ JDK åŸºæœ¬ä¸€è‡´çš„æ¥å£ (ä½†æ˜¯æ²¡æœ‰å®ç° Queue æ¥å£)ã€‚ åˆ›å»ºå¾ˆç®€å•ï¼š

```java
public SimpleDistributedQueue(CuratorFramework client,String path)
```

å¢åŠ å…ƒç´ ï¼š

```java
public boolean offer(byte[] data) throws Exception
```

åˆ é™¤å…ƒç´ ï¼š

```java
public byte[] take() throws Exception
```

å¦å¤–è¿˜æä¾›äº†å…¶å®ƒæ–¹æ³•ï¼š

```java
public byte[] peek() throws Exception
public byte[] poll(long timeout, TimeUnit unit) throws Exception
public byte[] poll() throws Exception
public byte[] remove() throws Exception
public byte[] element() throws Exception
```

æ²¡æœ‰ `add` æ–¹æ³•ï¼Œ å¤šäº† `take` æ–¹æ³•ã€‚

`take` æ–¹æ³•åœ¨æˆåŠŸè¿”å›ä¹‹å‰ä¼šè¢«é˜»å¡ã€‚ è€Œ `poll` æ–¹æ³•åœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶ç›´æ¥è¿”å› nullã€‚

```java
public class SimpleDistributedQueueDemo {

    private static final String PATH = "/example/queue";

    public static void main(String[] args) throws Exception {
        TestingServer server = new TestingServer();
        CuratorFramework client = null;
        SimpleDistributedQueue queue;
        try {
            client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3));
            client.getCuratorListenable().addListener((client1, event) -> System.out.println("CuratorEvent: " + event.getType().name()));
            client.start();
            queue = new SimpleDistributedQueue(client, PATH);
            Producer producer = new Producer(queue);
            Consumer consumer = new Consumer(queue);
            new Thread(producer, "producer").start();
            new Thread(consumer, "consumer").start();
            Thread.sleep(20000);
        } catch (Exception ex) {

        } finally {
            CloseableUtils.closeQuietly(client);
            CloseableUtils.closeQuietly(server);
        }
    }

    public static class Producer implements Runnable {

        private SimpleDistributedQueue queue;

        public Producer(SimpleDistributedQueue queue) {
            this.queue = queue;
        }

        @Override
        public void run() {
            for (int i = 0; i < 100; i++) {
                try {
                    boolean flag = queue.offer(("zjc-" + i).getBytes());
                    if (flag) {
                        System.out.println("å‘é€ä¸€æ¡æ¶ˆæ¯æˆåŠŸï¼š" + "zjc-" + i);
                    } else {
                        System.out.println("å‘é€ä¸€æ¡æ¶ˆæ¯å¤±è´¥ï¼š" + "zjc-" + i);
                    }
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }
    }

    public static class Consumer implements Runnable {

        private SimpleDistributedQueue queue;

        public Consumer(SimpleDistributedQueue queue) {
            this.queue = queue;
        }

        @Override
        public void run() {
            try {
                byte[] datas = queue.take();
                System.out.println("æ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯æˆåŠŸï¼š" + new String(datas, "UTF-8"));
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

}
```

ä½†æ˜¯å®é™…ä¸Šå‘é€äº† 100 æ¡æ¶ˆæ¯ï¼Œæ¶ˆè´¹å®Œç¬¬ä¸€æ¡ä¹‹åï¼Œåé¢çš„æ¶ˆæ¯æ— æ³•æ¶ˆè´¹ï¼Œç›®å‰æ²¡æ‰¾åˆ°åŸå› ã€‚æŸ¥çœ‹ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£æ¨èçš„ demo ä½¿ç”¨ä¸‹é¢å‡ ä¸ª Apiï¼š

```java
Creating a SimpleDistributedQueue

public SimpleDistributedQueue(CuratorFramework client,
                              String path)
Parameters:
client - the client
path - path to store queue nodes
Add to the queue

public boolean offer(byte[] data)
             throws Exception
Inserts data into queue.
Parameters:
data - the data
Returns:
true if data was successfully added
Take from the queue

public byte[] take()
           throws Exception
Removes the head of the queue and returns it, blocks until it succeeds.
Returns:
The former head of the queue
NOTE: see the Javadoc for additional methods
```

ä½†æ˜¯å®é™…ä½¿ç”¨å‘ç°è¿˜æ˜¯å­˜åœ¨æ¶ˆè´¹é˜»å¡é—®é¢˜ã€‚

### åˆ†å¸ƒå¼å±éšœâ€”Barrier

åˆ†å¸ƒå¼ Barrier æ˜¯è¿™æ ·ä¸€ä¸ªç±»ï¼š å®ƒä¼šé˜»å¡æ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„ç­‰å¾…è¿›ç¨‹ï¼Œç›´åˆ°æŸä¸€ä¸ªè¢«æ»¡è¶³ï¼Œ ç„¶åæ‰€æœ‰çš„èŠ‚ç‚¹ç»§ç»­è¿›è¡Œã€‚

æ¯”å¦‚èµ›é©¬æ¯”èµ›ä¸­ï¼Œ ç­‰èµ›é©¬é™†ç»­æ¥åˆ°èµ·è·‘çº¿å‰ã€‚ ä¸€å£°ä»¤ä¸‹ï¼Œæ‰€æœ‰çš„èµ›é©¬éƒ½é£å¥”è€Œå‡ºã€‚

#### DistributedBarrier

`DistributedBarrier` ç±»å®ç°äº†æ …æ çš„åŠŸèƒ½ã€‚ å®ƒçš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š

```java
public DistributedBarrier(CuratorFramework client, String barrierPath)
Parameters:
client - client
barrierPath - path to use as the barrier
```

é¦–å…ˆä½ éœ€è¦è®¾ç½®æ …æ ï¼Œå®ƒå°†é˜»å¡åœ¨å®ƒä¸Šé¢ç­‰å¾…çš„çº¿ç¨‹:

```java
setBarrier();
```

ç„¶åéœ€è¦é˜»å¡çš„çº¿ç¨‹è°ƒç”¨æ–¹æ³•ç­‰å¾…æ”¾è¡Œæ¡ä»¶:

```java
public void waitOnBarrier()
```

å½“æ¡ä»¶æ»¡è¶³æ—¶ï¼Œç§»é™¤æ …æ ï¼Œæ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹å°†ç»§ç»­æ‰§è¡Œï¼š

```java
removeBarrier();
```

**å¼‚å¸¸å¤„ç†**Â DistributedBarrier ä¼šç›‘æ§è¿æ¥çŠ¶æ€ï¼Œå½“è¿æ¥æ–­æ‰æ—¶ `waitOnBarrier()` æ–¹æ³•ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚

```java
public class DistributedBarrierDemo {

    private static final int QTY = 5;
    private static final String PATH = "/examples/barrier";

    public static void main(String[] args) throws Exception {
        try (TestingServer server = new TestingServer()) {
            CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3));
            client.start();
            ExecutorService service = Executors.newFixedThreadPool(QTY);
            DistributedBarrier controlBarrier = new DistributedBarrier(client, PATH);
            controlBarrier.setBarrier();

            for (int i = 0; i < QTY; ++i) {
                final DistributedBarrier barrier = new DistributedBarrier(client, PATH);
                final int index = i;
                Callable<Void> task = () -> {
                    Thread.sleep((long) (3 * Math.random()));
                    System.out.println("Client #" + index + " waits on Barrier");
                    barrier.waitOnBarrier();
                    System.out.println("Client #" + index + " begins");
                    return null;
                };
                service.submit(task);
            }
            Thread.sleep(10000);
            System.out.println("all Barrier instances should wait the condition");
            controlBarrier.removeBarrier();
            service.shutdown();
            service.awaitTermination(10, TimeUnit.MINUTES);

            Thread.sleep(20000);
        }
    }
}
```

è¿™ä¸ªä¾‹å­åˆ›å»ºäº† `controlBarrier` æ¥è®¾ç½®æ …æ å’Œç§»é™¤æ …æ ã€‚ æˆ‘ä»¬åˆ›å»ºäº† 5 ä¸ªçº¿ç¨‹ï¼Œåœ¨æ­¤ Barrier ä¸Šç­‰å¾…ã€‚ æœ€åç§»é™¤æ …æ åæ‰€æœ‰çš„çº¿ç¨‹æ‰ç»§ç»­æ‰§è¡Œã€‚

å¦‚æœä½ å¼€å§‹ä¸è®¾ç½®æ …æ ï¼Œæ‰€æœ‰çš„çº¿ç¨‹å°±ä¸ä¼šé˜»å¡ä½ã€‚

#### åŒæ …æ â€”DistributedDoubleBarrier

åŒæ …æ å…è®¸å®¢æˆ·ç«¯åœ¨è®¡ç®—çš„å¼€å§‹å’Œç»“æŸæ—¶åŒæ­¥ã€‚å½“è¶³å¤Ÿçš„è¿›ç¨‹åŠ å…¥åˆ°åŒæ …æ æ—¶ï¼Œè¿›ç¨‹å¼€å§‹è®¡ç®—ï¼Œ å½“è®¡ç®—å®Œæˆæ—¶ï¼Œç¦»å¼€æ …æ ã€‚ åŒæ …æ ç±»æ˜¯ `DistributedDoubleBarrier`ã€‚ æ„é€ å‡½æ•°ä¸º:

```java
public DistributedDoubleBarrier(CuratorFramework client,
                                String barrierPath,
                                int memberQty)
Creates the barrier abstraction. memberQty is the number of members in the barrier. When enter() is called, it blocks until
all members have entered. When leave() is called, it blocks until all members have left.

Parameters:
client - the client
barrierPath - path to use
memberQty - the number of members in the barrier
```

`memberQty` æ˜¯æˆå‘˜æ•°é‡ï¼Œå½“ `enter()` æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œæˆå‘˜è¢«é˜»å¡ï¼Œç›´åˆ°æ‰€æœ‰çš„æˆå‘˜éƒ½è°ƒç”¨äº† `enter()`ã€‚ å½“ `leave()` æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä¹Ÿé˜»å¡è°ƒç”¨çº¿ç¨‹ï¼Œç›´åˆ°æ‰€æœ‰çš„æˆå‘˜éƒ½è°ƒç”¨äº† `leave()`ã€‚ å°±åƒç™¾ç±³èµ›è·‘æ¯”èµ›ï¼Œ å‘ä»¤æªå“ï¼Œ æ‰€æœ‰çš„è¿åŠ¨å‘˜å¼€å§‹è·‘ï¼Œç­‰æ‰€æœ‰çš„è¿åŠ¨å‘˜è·‘è¿‡ç»ˆç‚¹çº¿ï¼Œæ¯”èµ›æ‰ç»“æŸã€‚

DistributedDoubleBarrier ä¼šç›‘æ§è¿æ¥çŠ¶æ€ï¼Œå½“è¿æ¥æ–­æ‰æ—¶ `enter()` å’Œ `leave()` æ–¹æ³•ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚

```java
public class DistributedDoubleBarrierDemo {

    private static final int QTY = 5;
    private static final String PATH = "/examples/barrier";

    public static void main(String[] args) throws Exception {
        try (TestingServer server = new TestingServer()) {
            CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3));
            client.start();
            ExecutorService service = Executors.newFixedThreadPool(QTY);
            for (int i = 0; i < QTY; ++i) {
                final DistributedDoubleBarrier barrier = new DistributedDoubleBarrier(client, PATH, QTY);
                final int index = i;
                Callable<Void> task = () -> {

                    Thread.sleep((long) (3 * Math.random()));
                    System.out.println("Client #" + index + " enters");
                    barrier.enter();
                    System.out.println("Client #" + index + " begins");
                    Thread.sleep((long) (3000 * Math.random()));
                    barrier.leave();
                    System.out.println("Client #" + index + " left");
                    return null;
                };
                service.submit(task);
            }

            service.shutdown();
            service.awaitTermination(10, TimeUnit.MINUTES);
            Thread.sleep(Integer.MAX_VALUE);
        }
    }

}
```

**å‚è€ƒèµ„æ–™ï¼š**  
ã€Šä» PAXOS åˆ° ZOOKEEPER åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹  
ã€Š è·Ÿç€å®ä¾‹å­¦ä¹  ZooKeeper çš„ç”¨æ³•ã€‹åšå®¢ç³»åˆ—

## [Redisé«˜æ•ˆå¤„ç†ï¼šå­—ç¬¦ä¸²ã€å“ˆå¸Œã€åˆ—è¡¨å’Œæœ‰åºé›†åˆ](https://blog.dong4j.site/posts/5567a46d.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## åŸºç¡€æ•°æ®ç»“æ„

### å­—ç¬¦ä¸²

> å­—ç¬¦ä¸²ç±»å‹çš„å€¼å®é™…å¯ä»¥ æ˜¯å­—ç¬¦ä¸²ï¼ˆç®€å•çš„å­—ç¬¦ä¸²ã€å¤æ‚çš„å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ JSONã€XMLï¼‰ï¼‰ã€æ•°å­— ï¼ˆæ•´æ•°ã€æµ®ç‚¹æ•°ï¼‰ï¼Œç”šè‡³æ˜¯äºŒè¿›åˆ¶ï¼ˆå›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘ï¼‰ï¼Œä½†æ˜¯å€¼æœ€å¤§ä¸èƒ½ è¶…è¿‡ 512MBã€‚

![20241229154732_N5bzodwZ.webp](https://cdn.dong4j.site/source/image/20241229154732_N5bzodwZ.webp)

```shell
set key value [ex seconds] [px milliseconds] [nx|xx]


setex key seconds value
setnx key value
```

set å‘½ä»¤æœ‰å‡ ä¸ªé€‰é¡¹:

- ex secondsï¼šä¸ºé”®è®¾ç½®ç§’çº§è¿‡æœŸæ—¶é—´ã€‚
- px millisecondsï¼šä¸ºé”®è®¾ç½®æ¯«ç§’çº§è¿‡æœŸæ—¶é—´ã€‚
- nxï¼šé”®å¿…é¡»ä¸å­˜åœ¨ï¼Œæ‰å¯ä»¥è®¾ç½®æˆåŠŸï¼Œç”¨äºæ·»åŠ ã€‚
- xxï¼šä¸ nx ç›¸åï¼Œé”®å¿…é¡»å­˜åœ¨ï¼Œæ‰å¯ä»¥è®¾ç½®æˆåŠŸï¼Œç”¨äºæ›´æ–°ã€‚

#### setã€setnxã€set xx çš„åŒºåˆ«

```shell
redis> get name
dong4j
redis> setnx name dong
# å› ä¸º name å·²å­˜åœ¨, è®¾ç½®å¤±è´¥
0
redis> get name
dong4j
redis> set name dong4j xx
# name å­˜åœ¨æ‰èƒ½ä½¿ç”¨ xx
OK
redis> get name
dong4j
```

[ä½¿ç”¨ setnx å®ç°åˆ†å¸ƒå¼é”](https://www.cnblogs.com/linjiqin/p/8003838.html)

#### æ‰¹é‡å¤„ç†

```shell
redis> mset a 1 b 2 c 3
OK
redis> mget a b c d
0 1
1 2
2 3
3 null
```

#### è®¡æ•°æ“ä½œ

```shell
# è‡ªå¢
incr key
# è‡ªå‡
decr key
# è‡ªå¢æŒ‡å®šæ•°å­—
incrby key increment
# è‡ªå‡æŒ‡å®šæ•°å­—
decrby key decrement
# è‡ªå¢æµ®ç‚¹æ•°
incrbyfloat key increment
```

#### åº”ç”¨åœºæ™¯

ç”±äº Redis çš„å•çº¿ç¨‹å‘½ä»¤å¤„ç†æœºåˆ¶ï¼Œå¦‚æœæœ‰å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶æ‰§è¡Œ setnx key valueï¼Œ æ ¹æ® setnx çš„ç‰¹æ€§åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½è®¾ç½®æˆåŠŸï¼Œsetnx å¯ä»¥ä½œä¸ºåˆ†å¸ƒå¼é”çš„ä¸€ç§å®ç°æ–¹æ¡ˆ

1. ç¼“å­˜åŠŸèƒ½  
   ![20241229154732_bEHqjfIe.webp](https://cdn.dong4j.site/source/image/20241229154732_bEHqjfIe.webp)
2. è®¡æ•°

```shell
long incrVideoCounter(long id) {
        key = "video:playCount:" + id;
        return redis.incr(key);
}

```

3. å…±äº« Session
   ![20241229154732_faMHn3jj.webp](https://cdn.dong4j.site/source/image/20241229154732_faMHn3jj.webp)
4. é™é€Ÿ

   é™åˆ¶è·å–éªŒè¯ç çš„é¢‘ç‡ ä¸€åˆ†é’Ÿä¸èƒ½è¶…è¿‡ 5 æ¬¡

```shell
phoneNum = "138xxxxxxxx";
key = "shortMsg:limit:" + phoneNum;
// SET key value EX 60 NX
isExists = redis.set(key,1,"EX 60","NX");
if(isExists != null || redis.incr(key) <=5) {
        // é€šè¿‡
} else {
        // é™é€Ÿ
}
```

### å“ˆå¸Œ

![20241229154732_kwSAJr0I.webp](https://cdn.dong4j.site/source/image/20241229154732_kwSAJr0I.webp)

#### å¸¸ç”¨æ“ä½œ

```shell
# è®¾ç½®å€¼
hset key field value
# è·å–å€¼
hget key field
# åˆ é™¤ field
hdel key field [field ...]
# è®¡ç®— field ä¸ªæ•°
hlen key
# æ‰¹é‡è®¾ç½®æˆ–è·å– field-value
hmget key field [field ...]
# æ‰¹é‡è·å– field-value
hmset key field value [field value ...]
# åˆ¤æ–­ field æ˜¯å¦å­˜åœ¨
hexists key field
# è·å–æ‰€æœ‰field
hkeys key
# è·å–æ‰€æœ‰value
hvals key
# è·å–æ‰€æœ‰çš„field-value
hgetall key

# å¯¹ field è‡ªå¢
hincrby key field
hincrbyfloat key field
# è®¡ç®—valueçš„å­—ç¬¦ä¸²é•¿åº¦
hstrlen key field
```

#### ä½¿ç”¨åœºæ™¯

![20241229154732_W36e7jqG.webp](https://cdn.dong4j.site/source/image/20241229154732_W36e7jqG.webp)

```java
UserInfo getUserInfo(long id) {
    // ç”¨æˆ·idä½œä¸ºkeyåç¼€
    userRedisKey = "user:info:" + id;
    // ä½¿ç”¨hgetallè·å–æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯æ˜ å°„å…³ç³»
    userInfoMap = redis.hgetAll(userRedisKey);
    UserInfo userInfo;
    if (userInfoMap != null) {
        // å°†æ˜ å°„å…³ç³»è½¬æ¢ä¸ºUserInfo
        userInfo = transferMapToUserInfo(userInfoMap);
    } else {
        // ä»MySQLä¸­è·å–ç”¨æˆ·ä¿¡æ¯
        userInfo = mysql.get(id);
        // å°†userInfoå˜ä¸ºæ˜ å°„å…³ç³»ä½¿ç”¨hmsetä¿å­˜åˆ°Redisä¸­
        redis.hmset(userRedisKey, transferUserInfoToMap(userInfo));
        // æ·»åŠ è¿‡æœŸæ—¶é—´
        redis.expire(userRedisKey, 3600);
    } return userInfo;
}
```

### åˆ—è¡¨

åˆ—è¡¨ä¸­çš„æ¯ä¸ªå­—ç¬¦ä¸² ç§°ä¸ºå…ƒç´ ï¼ˆelementï¼‰ï¼Œä¸€ä¸ªåˆ—è¡¨æœ€å¤šå¯ä»¥å­˜å‚¨ 2 32 -1 ä¸ªå…ƒç´ ã€‚  
åœ¨ Redis ä¸­ï¼Œå¯ ä»¥å¯¹åˆ—è¡¨ä¸¤ç«¯æ’å…¥ï¼ˆpushï¼‰å’Œå¼¹å‡ºï¼ˆpopï¼‰ï¼Œè¿˜å¯ä»¥è·å–æŒ‡å®šèŒƒå›´çš„å…ƒç´ åˆ— è¡¨ã€è·å–æŒ‡å®šç´¢å¼•ä¸‹æ ‡çš„å…ƒç´ ç­‰

![20241229154732_ZXix2Mna.webp](https://cdn.dong4j.site/source/image/20241229154732_ZXix2Mna.webp)

![20241229154732_Q8kTkP5h.webp](https://cdn.dong4j.site/source/image/20241229154732_Q8kTkP5h.webp)

#### å¸¸ç”¨æ“ä½œ

| æ“ä½œç±»å‹ | æ“ä½œ                 |
| :------- | :------------------- |
| æ·»åŠ      | rpush lpush linsert  |
| æŸ¥è¯¢     | lrange lindex llen   |
| åˆ é™¤     | lpop rpop lrem ltrim |
| ä¿®æ”¹     | lset                 |
| é˜»å¡æ“ä½œ | blpop brpop          |

```shell
# å‘ poivt å‰æˆ–åæ’å…¥å…ƒç´ 
linsert key before|after pivot value
```

#### ä½¿ç”¨åœºæ™¯

**1. æ¶ˆæ¯é˜Ÿåˆ—**

Redis çš„ lpush+brpop å‘½ä»¤ç»„åˆå³å¯å®ç°é˜»å¡é˜Ÿåˆ—ï¼Œç”Ÿäº§ è€…å®¢æˆ·ç«¯ä½¿ç”¨ lrpush ä»åˆ—è¡¨å·¦ä¾§æ’å…¥å…ƒç´ ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å®¢æˆ·ç«¯ä½¿ç”¨ brpop å‘½ä»¤ é˜»å¡å¼çš„â€œæŠ¢â€åˆ—è¡¨å°¾éƒ¨çš„å…ƒç´ ï¼Œå¤šä¸ªå®¢æˆ·ç«¯ä¿è¯äº†æ¶ˆè´¹çš„è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨æ€§ã€‚

![20241229154732_p0w8fDqH.webp](https://cdn.dong4j.site/source/image/20241229154732_p0w8fDqH.webp)

**2. æ–‡ç« åˆ—è¡¨**

åœºæ™¯ä½¿ç”¨å£è¯€

- lpush+lpop=Stackï¼ˆæ ˆï¼‰
- lpush+rpop=Queueï¼ˆé˜Ÿåˆ—ï¼‰
- lpsh+ltrim=Capped Collectionï¼ˆæœ‰é™é›†åˆï¼‰
- lpush+brpop=Message Queueï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰

### é›†åˆ

![20241229154732_EH8AHkt5.webp](https://cdn.dong4j.site/source/image/20241229154732_EH8AHkt5.webp)

### æœ‰åºé›†åˆ

## é”®çš„ç®¡ç†

## [RedisèƒŒåçš„æŠ€æœ¯ï¼šå•çº¿ç¨‹å¦‚ä½•å®ç°é«˜æ€§èƒ½ï¼Ÿ](https://blog.dong4j.site/posts/1556580b.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## Redis çš„ 5 ç§æ•°æ®ç»“æ„

![20241229154732_VjP0mAw9.webp](https://cdn.dong4j.site/source/image/20241229154732_VjP0mAw9.webp)

## Redis æ•°æ®ç»“æ„å’Œå†…éƒ¨ç¼–ç 

![20241229154732_kNOvBCjM.webp](https://cdn.dong4j.site/source/image/20241229154732_kNOvBCjM.webp)

## Redis çš„å•çº¿ç¨‹æ¨¡å‹

Redis ä½¿ç”¨å•çº¿ç¨‹å¤„ç†å‘½ä»¤, æ‰€ä»¥ä¸€æ¡å‘½ä»¤ä»å®¢æˆ·ç«¯è¾¾åˆ°æœåŠ¡ç«¯ä¸ä¼šç«‹å³æ‰§è¡Œ, æ‰€æœ‰å‘½ä»¤éƒ½ä¼šè¿›å…¥ä¸€ä¸ªé˜Ÿåˆ—, ç„¶åé€ä¸ªè¢«æ‰§è¡Œ.

**Redis å•çº¿ç¨‹å¤„ç†é€Ÿåº¦å¿«çš„åŸå› **

1. çº¯å†…å­˜è®¿é—®, å†…å­˜çš„å“åº”æ—¶é•¿çº¦ä¸º 100 çº³ç§’
2. éé˜»å¡ I/O, Redis ä½¿ç”¨ epoll ä½œä¸º I/O å¤šè·¯å¤ç”¨æŠ€æœ¯çš„å®ç°, å†åŠ ä¸Š Redis è‡ªèº«çš„äº‹ä»¶å¤„ç†æ¨¡å‹å°† epoll ä¸­çš„è¿æ¥ã€è¯»å†™ã€å…³é—­éƒ½è½¬æ¢ä¸ºäº‹ä»¶ï¼Œä¸ åœ¨ç½‘ç»œ I/O ä¸Šæµªè´¹è¿‡å¤šçš„æ—¶é—´

   ![20241229154732_vK47Dk4P.webp](https://cdn.dong4j.site/source/image/20241229154732_vK47Dk4P.webp)

3. å•çº¿ç¨‹é¿å…äº†çº¿ç¨‹åˆ‡æ¢å’Œç«æ€äº§ç”Ÿçš„æ¶ˆè€—

**å­˜åœ¨çš„é—®é¢˜**

å¯¹äºæ¯ä¸ªå‘½ä»¤çš„æ‰§è¡Œæ—¶é—´æœ‰è¦æ±‚.

å¦‚æœæŸä¸ªå‘½ä»¤æ‰§è¡Œæ—¶é—´è¿‡é•¿, ä¼šé€ æˆå…¶ä»–å‘½ä»¤é˜»å¡

## [Rediså‘½ä»¤é€ŸæŸ¥æ‰‹å†Œï¼šå¸¸ç”¨æŒ‡ä»¤è¯¦è§£](https://blog.dong4j.site/posts/570ace06.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## Redis å¯æ‰§è¡Œæ–‡ä»¶è¯´æ˜

| å¯æ‰§è¡Œæ–‡ä»¶       | ä½œç”¨                               |
| :--------------- | :--------------------------------- |
| redis-server     | å¯åŠ¨ Redis                         |
| redis-cli        | Redis å‘½ä»¤è¡Œå®¢æˆ·ç«¯                 |
| redis-benchmark  | Redis åŸºå‡†æµ‹è¯•å·¥å…·                 |
| redis-check-aof  | Redis AOF æŒä¹…åŒ–æ–‡ä»¶æ£€æµ‹å’Œä¿®å¤å·¥å…· |
| redis-check-dump | Redis RDB æŒä¹…åŒ–æ–‡ä»¶æ£€æµ‹å’Œä¿®å¤å·¥å…· |
| redis-sentinel   | å¯åŠ¨ Redis Sentinel                |

## å¯åŠ¨æ–¹å¼

**1. é»˜è®¤é…ç½®**

```shell
redis-server
```

**2. è¿è¡Œå‚æ•°**

```shell
# æ ¼å¼
redis-server --configKey1 configValue1 --configKey2 configValue2

# ä½¿ç”¨ 6380 ç«¯å£å¯åŠ¨ redis
redis-server --port 6380
```

**3. é…ç½®æ–‡ä»¶**

```shell
redis-server /usr/local/redis/redis.conf
```

**3.1 åŸºç¡€é…ç½®**

| é…ç½®å    | è¯´æ˜                                      |
| :-------- | :---------------------------------------- |
| port      | ç«¯å£                                      |
| logfile   | æ—¥å¿—æ–‡ä»¶                                  |
| dir       | Redis å·¥ä½œç›®å½• (å­˜æ”¾æŒä¹…åŒ–æ–‡ä»¶å’Œæ—¥å¿—æ–‡ä»¶) |
| daemonize | æ˜¯å¦ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼å¯åŠ¨ Redis            |

## Redis å‘½ä»¤è¡Œå®¢æˆ·ç«¯

**1. äº¤äº’å¼**

```shell
redis-cli -h 127.0.0.1 -p 6379
```

**2. å‘½ä»¤æ–¹å¼**

```shell
redus-cli -h 127.0.0.1 -p 6379 get hello
```

## åœæ­¢ Redis æœåŠ¡

```shell
redis-cli shutdown
# å…³é—­ä¹‹å‰æ˜¯å¦ç”ŸæˆæŒä¹…åŒ–æ–‡ä»¶
redis-cli shutdown nosave|save
```

## å¤–æ”¾è®¿é—® Redis

1. å¼€å‘ Redis ç«¯å£
2. ä¿®æ”¹ redis.conf

```shell

bind 127.0.0.1
protected-mode yes

```

ä¿®æ”¹ä¸º

```shell
# bind 127.0.0.1
protected-mode no
```

## ä¿®æ”¹æŒä¹…åŒ–è·¯å¾„å’Œæ—¥å¿—è·¯å¾„

```shell
# æ—¥å¿—è·¯å¾„
logfile /data/redis_cache/logs/redis.log
# æŒä¹…åŒ–è·¯å¾„ï¼Œä¿®æ”¹å è®°å¾—è¦æŠŠdump.rdbæŒä¹…åŒ–æ–‡ä»¶
dir /data/redis_cache

dbsize

# åˆ é™¤æ‰€æœ‰æ•°æ®åº“ä¸­çš„key
flushall
# åˆ é™¤å½“å‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰Key
flushdb
```

## å…¨å±€å‘½ä»¤

**1. dbsize**

dbsize å‘½ä»¤åœ¨è®¡ç®—é”®æ€»æ•°æ—¶ä¸ä¼šéå†æ‰€æœ‰é”®ï¼Œè€Œæ˜¯ç›´æ¥è·å– Redis å†…ç½®çš„ é”®æ€»æ•°å˜é‡ï¼Œæ‰€ä»¥ dbsize å‘½ä»¤çš„æ—¶é—´å¤æ‚åº¦æ˜¯ Oï¼ˆ1ï¼‰

**2. keys**

keys å‘½ä»¤ä¼šéå†æ‰€ æœ‰é”®ï¼Œæ‰€ä»¥å®ƒçš„æ—¶é—´å¤æ‚åº¦æ˜¯ Oï¼ˆnï¼‰ï¼Œå½“ Redis ä¿å­˜äº†å¤§é‡é”®æ—¶ï¼Œçº¿ä¸Šç¯å¢ƒ ç¦æ­¢ä½¿ç”¨ã€‚

**3. exists key**

æ£€æŸ¥ key æ˜¯å¦å­˜åœ¨

**4. del key1 [key2]**

åˆ é™¤ key

del æ˜¯ä¸€ä¸ªé€šç”¨å‘½ä»¤ï¼Œæ— è®ºå€¼æ˜¯ä»€ä¹ˆæ•°æ®ç»“æ„ç±»å‹ï¼Œdel å‘½ä»¤éƒ½å¯ä»¥å°†å…¶ åˆ é™¤

**5. expire key seconds**

Redis æ”¯æŒå¯¹é”®æ·»åŠ è¿‡æœŸæ—¶é—´ï¼Œå½“è¶…è¿‡è¿‡æœŸæ—¶é—´åï¼Œä¼šè‡ªåŠ¨åˆ é™¤é”®

```shell
redis> expire name 10
1
redis> ttl name
3
redis> ttl name
0
redis> ttl name
# è¿”å› -2 æ—¶, è¯´æ˜ key å·²è¢«åˆ é™¤
-2
redis> get name
null
```

**6. type (key çš„æ•°æ®ç»“æ„)**

```shell
redis> set name dong4j
OK
redis> type name
string
redis> type aaa
none
redis> rpush list ab cd ef
3
redis> type list
list
```

## [ä»é›¶å¼€å§‹ï¼šå®‰è£…å¹¶é…ç½®CentOS NginxæœåŠ¡](https://blog.dong4j.site/posts/779e9fe6.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

ç³»ç»Ÿ Centos 64 ä½

## ç¬¬ä¸€æ­¥ï¼Œé¦–å…ˆä¸‹è½½ Nginx çš„ tar åŒ…åŠå®‰è£…ä¾èµ–çš„å·¥å…· tar åŒ…ã€‚

Nginx:Â [http://nginx.org/en/download.html](http://nginx.org/en/download.html)

Nginx éœ€è¦ä¾èµ–ä¸‹é¢ 3 ä¸ªåŒ…  
gzip æ¨¡å—éœ€è¦ zlib åº“ ( ä¸‹è½½:Â [http://www.zlib.net/](http://www.zlib.net/)Â )  
rewrite æ¨¡å—éœ€è¦ pcre åº“ ( ä¸‹è½½:Â [http://www.pcre.org/](http://www.pcre.org/)Â )  
ssl åŠŸèƒ½éœ€è¦ openssl åº“ ( ä¸‹è½½:Â [http://www.openssl.org/](http://www.openssl.org/)Â )

åˆ†åˆ«è§£å‹ã€‚  
å…·ä½“å‘½ä»¤ï¼š

```shell
wget http://nginx.org/download/nginx-1.13.2.tar.gz
wget http://www.zlib.net/zlib-1.2.11.tar.gz
wget https://ftp.pcre.org/pub/pcre/pcre-8.40.tar.gz
wget https://www.openssl.org/source/openssl-fips-2.0.16.tar.gz

tar zxvf openssl-fips-2.0.16.tar.gz
tar zxvf nginx-1.13.2.tar.gz
tar zxvf zlib-1.2.11.tar.gz
tar zxvf pcre-8.40.tar.gz
```

---

## ç¬¬äºŒæ­¥ ç¼–è¯‘å®‰è£…

å®‰è£…é¡ºåºï¼šå…ˆå®‰è£…ä¸‰ä¸ªä¾èµ–åŒ…å†å®‰è£… nginx

```shell
cd åˆ°å„ä¸ªè§£å‹ç›®å½•ä¸‹è¿è¡Œ
./configuer && make && make install
```

å®‰è£… c++ ç¼–è¯‘ç¯å¢ƒ

```shell
yum install gcc-c++
```

---

## ç¬¬ä¸‰æ­¥ è¿è¡Œ nginx

å®‰è£…å¥½çš„ nginx è·¯å¾„åœ¨ï¼š

```shell
/usr/local/nginx

```

é»˜è®¤çš„é…ç½®æ–‡ä»¶çš„è·¯å¾„åœ¨ï¼š

```shell
/usr/local/nginx/conf/nginx.conf
```

è¿è¡Œ nginxï¼š

```shell
/usr/local/nginx/sbin/nginx
```

é€šè¿‡æµè§ˆå™¨è®¿é—®æœåŠ¡å™¨ ipï¼Œå‡ºç°ä»¥ä¸‹æ ‡å¿—å°±æ˜¯å¯åŠ¨æˆåŠŸäº†ï¼š

```shell
Welcome to nginx!

If you see this page, the nginx web server is successfully installed and working. Further configuration is required.

For online documentation and support please refer to nginx.org.
Commercial support is available at nginx.com.

Thank you for using nginx.
```

æœ‰é—®é¢˜ä¹‹å¤„çƒ¦è¯·åœ¨ç•™è¨€ä¸­æŒ‡å‡ºï¼Œéå¸¸æ„Ÿè°¢ã€‚

## é—®é¢˜

Nginx å¯åŠ¨æç¤ºæ‰¾ä¸åˆ° libpcre.so.1 è§£å†³æ–¹æ³•  
WebServer 2012-08-26 Nginx,libpcre  
å¯åŠ¨ nginx æç¤ºï¼šerror while loading shared libraries: libpcre.so.1: cannot open shared object file: No such file or directoryï¼Œæ„æ€æ˜¯æ‰¾ä¸åˆ° libpcre.so.1 è¿™ä¸ªæ¨¡å—ï¼Œè€Œå¯¼è‡´å¯åŠ¨å¤±è´¥ã€‚

```shell
[root@lee ~]# /usr/local/webserver/nginx/sbin/nginx
nginx: error while loading shared libraries: libpcre.so.1: cannot open shared object file: No such file or directory
```

ç»è¿‡æœç´¢èµ„æ–™ï¼Œå‘ç°éƒ¨åˆ† linux ç³»ç»Ÿå­˜æœ‰çš„é€šç—…ã€‚è¦è§£å†³è¿™ä¸ªæ–¹æ³•éå¸¸å®¹æ˜“

å¦‚æœæ˜¯ 32 ä½ç³»ç»Ÿ

```shell
[root@lee ~]#  ln -s /usr/local/lib/libpcre.so.1 /lib
```

å¦‚æœæ˜¯ 64 ä½ç³»ç»Ÿ

```shell
[root@lee ~]#  ln -s /usr/local/lib/libpcre.so.1 /lib64
```

ç„¶ååœ¨å¯åŠ¨ nginx å°± OK äº†

```shell
[root@lee ~]# /usr/local/webserver/nginx/sbin/nginx
```

## [Rediså…¥é—¨ï¼šæŒæ¡åŸºç¡€ï¼Œå¼€å¯é«˜æ•ˆæ•°æ®å­˜å‚¨ä¹‹æ—…](https://blog.dong4j.site/posts/6c8ae0af.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## Redis çš„ 3 ç§ç”¨æ³•

1. å†…å­˜ç¼“å­˜
2. å®šé‡æ•°æ®æŒ‡æ ‡
3. å‘å¸ƒ/è®¢é˜…æ¨¡å‹

### ä½œä¸ºå†…å­˜ç¯å¢ƒ

#### æ•°æ®ç»“æ„

**1. å­—ç¬¦ä¸² string**

```shell
// è®¾ç½®å­—ç¬¦ä¸²ç±»å‹
set mystr "hello world!"
// è¯»å–å­—ç¬¦ä¸²ç±»å‹
get mystr

// é€šè¿‡å­—ç¬¦ä¸²ç±»å‹è¿›è¡Œæ•°å€¼æ“ä½œ åœ¨é‡åˆ°æ•°å€¼æ“ä½œæ—¶ï¼Œredis ä¼šå°†å­—ç¬¦ä¸²ç±»å‹è½¬æ¢æˆæ•°å€¼ã€‚
127.0.0.1:6379> set mynum "2"
OK
127.0.0.1:6379> get mynum
"2"
127.0.0.1:6379> incr mynum
(integer) 3
127.0.0.1:6379> get mynum
"3"
```

> INCR ç­‰æŒ‡ä»¤æœ¬èº«å°±å…·æœ‰åŸå­æ“ä½œçš„ç‰¹æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬å®Œå…¨å¯ä»¥åˆ©ç”¨ redis çš„ INCRã€INCRBYã€DECRã€DECRBY ç­‰æŒ‡ä»¤æ¥å®ç°åŸå­è®¡æ•°çš„æ•ˆæœï¼Œå‡å¦‚ï¼Œåœ¨æŸç§åœºæ™¯ä¸‹æœ‰ 3 ä¸ªå®¢æˆ·ç«¯åŒæ—¶è¯»å–äº† mynum çš„å€¼ï¼ˆå€¼ä¸º 2ï¼‰ï¼Œç„¶åå¯¹å…¶åŒæ—¶è¿›è¡Œäº†åŠ  1 çš„æ“ä½œï¼Œé‚£ä¹ˆï¼Œæœ€å mynum çš„å€¼ä¸€å®šæ˜¯ 5ã€‚ä¸å°‘ç½‘ç«™éƒ½åˆ©ç”¨ redis çš„è¿™ä¸ªç‰¹æ€§æ¥å®ç°ä¸šåŠ¡ä¸Šçš„ç»Ÿè®¡è®¡æ•°éœ€æ±‚ã€‚

**2. åˆ—è¡¨ list**

Redis list ä½¿ç”¨é“¾è¡¨å®ç°, æ‰€ä»¥æ’å…¥é€Ÿåº¦å¿«, æŸ¥è¯¢é€Ÿåº¦æ…¢

```shell
// æ–°å»ºä¸€ä¸ª list å«åš mylistï¼Œå¹¶åœ¨åˆ—è¡¨å¤´éƒ¨æ’å…¥å…ƒç´  "1"
127.0.0.1:6379> lpush mylist "1"
// è¿”å›å½“å‰ mylist ä¸­çš„å…ƒç´ ä¸ªæ•°
(integer) 1
// åœ¨ mylist å³ä¾§æ’å…¥å…ƒç´  "2"
127.0.0.1:6379> rpush mylist "2"
(integer) 2
// åœ¨ mylist å·¦ä¾§æ’å…¥å…ƒç´  "0"
127.0.0.1:6379> lpush mylist "0"
(integer) 3
// åˆ—å‡º mylist ä¸­ä»ç¼–å· 0 åˆ°ç¼–å· 1 çš„å…ƒç´ 
127.0.0.1:6379> lrange mylist 0 1
1) "0"
2) "1"
// åˆ—å‡º mylist ä¸­ä»ç¼–å· 0 åˆ°å€’æ•°ç¬¬ä¸€ä¸ªå…ƒç´ 
127.0.0.1:6379> lrange mylist 0 -1
1) "0"
2) "1"
3) "2"
```

lists çš„åº”ç”¨ç›¸å½“å¹¿æ³›ï¼Œéšä¾¿ä¸¾å‡ ä¸ªä¾‹å­ï¼š

1. æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ lists æ¥å®ç°ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè€Œä¸”å¯ä»¥ç¡®ä¿å…ˆåé¡ºåºï¼Œä¸å¿…åƒ MySQL é‚£æ ·è¿˜éœ€è¦é€šè¿‡ ORDER BY æ¥è¿›è¡Œæ’åºã€‚
2. åˆ©ç”¨ LRANGE è¿˜å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°åˆ†é¡µçš„åŠŸèƒ½ã€‚
3. åœ¨åšå®¢ç³»ç»Ÿä¸­ï¼Œæ¯ç‰‡åšæ–‡çš„è¯„è®ºä¹Ÿå¯ä»¥å­˜å…¥ä¸€ä¸ªå•ç‹¬çš„ list ä¸­ã€‚

**3. æ— åºé›†åˆ set**

```shell
// å‘é›†åˆ myset ä¸­åŠ å…¥ä¸€ä¸ªæ–°å…ƒç´  "one"
127.0.0.1:6379> sadd myset "one"
(integer) 1
127.0.0.1:6379> sadd myset "two"
(integer) 1
// åˆ—å‡ºé›†åˆ myset ä¸­çš„æ‰€æœ‰å…ƒç´ 
127.0.0.1:6379> smembers myset
1) "one"
2) "two"
// åˆ¤æ–­å…ƒç´  1 æ˜¯å¦åœ¨é›†åˆ myset ä¸­ï¼Œè¿”å› 1 è¡¨ç¤ºå­˜åœ¨
127.0.0.1:6379> sismember myset "one"
(integer) 1
// åˆ¤æ–­å…ƒç´  3 æ˜¯å¦åœ¨é›†åˆ myset ä¸­ï¼Œè¿”å› 0 è¡¨ç¤ºä¸å­˜åœ¨
127.0.0.1:6379> sismember myset "three"
(integer) 0
// æ–°å»ºä¸€ä¸ªæ–°çš„é›†åˆ yourset
127.0.0.1:6379> sadd yourset "1"
(integer) 1
127.0.0.1:6379> sadd yourset "2"
(integer) 1
127.0.0.1:6379> smembers yourset
1) "1"
2) "2"
// å¯¹ä¸¤ä¸ªé›†åˆæ±‚å¹¶é›†
127.0.0.1:6379> sunion myset yourset
1) "1"
2) "one"
3) "2"
4) "two"
```

> å¯¹äºé›†åˆçš„ä½¿ç”¨ï¼Œä¹Ÿæœ‰ä¸€äº›å¸¸è§çš„æ–¹å¼ï¼Œæ¯”å¦‚ï¼ŒQQ æœ‰ä¸€ä¸ªç¤¾äº¤åŠŸèƒ½å«åš â€œå¥½å‹æ ‡ç­¾â€ï¼Œå¤§å®¶å¯ä»¥ç»™ä½ çš„å¥½å‹è´´æ ‡ç­¾ï¼Œæ¯”å¦‚ â€œå¤§ç¾å¥³â€ã€â€œåœŸè±ªâ€ã€â€œæ¬§å·´â€ ç­‰ç­‰ï¼Œè¿™æ—¶å°±å¯ä»¥ä½¿ç”¨ redis çš„é›†åˆæ¥å®ç°ï¼ŒæŠŠæ¯ä¸€ä¸ªç”¨æˆ·çš„æ ‡ç­¾éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªé›†åˆä¹‹ä¸­ã€‚

**4. æœ‰åºé›†åˆ zset**

```shell
127.0.0.1:6379> zadd myzset 1 baidu.com
(integer) 1
// å‘ myzset ä¸­æ–°å¢ä¸€ä¸ªå…ƒç´  360.comï¼Œèµ‹äºˆå®ƒçš„åºå·æ˜¯ 3
127.0.0.1:6379> zadd myzset 3 360.com
(integer) 1
// å‘ myzset ä¸­æ–°å¢ä¸€ä¸ªå…ƒç´  google.comï¼Œèµ‹äºˆå®ƒçš„åºå·æ˜¯ 2
127.0.0.1:6379> zadd myzset 2 google.com
(integer) 1
// åˆ—å‡º myzset çš„æ‰€æœ‰å…ƒç´ ï¼ŒåŒæ—¶åˆ—å‡ºå…¶åºå·ï¼Œå¯ä»¥çœ‹å‡º myzset å·²ç»æ˜¯æœ‰åºçš„äº†ã€‚
127.0.0.1:6379> zrange myzset 0 -1 with scores
1) "baidu.com"
2) "1"
3) "google.com"
4) "2"
5) "360.com"
6) "3"
// åªåˆ—å‡º myzset çš„å…ƒç´ 
127.0.0.1:6379> zrange myzset 0 -1
1) "baidu.com"
2) "google.com"
3) "360.com"
```

**5. å“ˆå¸Œ hashes**

å“ˆå¸Œæ˜¯ä» redis-2.0.0 ç‰ˆæœ¬ä¹‹åæ‰æœ‰çš„æ•°æ®ç»“æ„ã€‚

hashes å­˜çš„æ˜¯å­—ç¬¦ä¸²å’Œå­—ç¬¦ä¸²å€¼ä¹‹é—´çš„æ˜ å°„ï¼Œæ¯”å¦‚ä¸€ä¸ªç”¨æˆ·è¦å­˜å‚¨å…¶å…¨åã€å§“æ°ã€å¹´é¾„ç­‰ç­‰ï¼Œå°±å¾ˆé€‚åˆä½¿ç”¨å“ˆå¸Œã€‚

```shell
// å»ºç«‹å“ˆå¸Œï¼Œå¹¶èµ‹å€¼
127.0.0.1:6379> HMSET user:001 username dong4j password 1234 age 29
OK
// åˆ—å‡ºå“ˆå¸Œçš„å†…å®¹
127.0.0.1:6379> HGETALL user:001
1) "username"
2) "dong4j"
3) "password"
4) "1234"
5) "age"
6) "29"
// æ›´æ”¹å“ˆå¸Œä¸­çš„æŸä¸€ä¸ªå€¼
127.0.0.1:6379> HSET user:001 password 12345
(integer) 0
// å†æ¬¡åˆ—å‡ºå“ˆå¸Œçš„å†…å®¹
127.0.0.1:6379> HGETALL user:001
1) "username"
2) "dong4j"
3) "password"
4) "12345"
5) "age"
6) "29"
```

**6. HyperLogLog**

Redis çš„ HyperLogLog ä½¿ç”¨éšæœºåŒ–ï¼Œä»¥æä¾›å”¯ä¸€çš„å…ƒç´ æ•°ç›®è¿‘ä¼¼çš„é›†åˆåªä½¿ç”¨ä¸€ä¸ªå¸¸æ•°ï¼Œå¹¶ä¸”ä½“ç§¯å°ï¼Œå°‘é‡å†…å­˜çš„ç®—æ³•ã€‚

HyperLogLog æä¾›ï¼Œå³ä½¿æ¯ä¸ªä½¿ç”¨äº†éå¸¸å°‘é‡çš„å†…å­˜ï¼ˆ12 åƒå­—èŠ‚ï¼‰ï¼Œæ ‡å‡†è¯¯å·®ä¸ºé›†åˆçš„åŸºæ•°éå¸¸è¿‘ä¼¼ï¼Œæ²¡æœ‰é™åˆ¶çš„æ¡ç›®æ•°ï¼Œå¯ä»¥æŒ‡å®šï¼Œé™¤éæ¥è¿‘ 264 ä¸ªæ¡ç›®ã€‚

```shell
redis 127.0.0.1:6379> PFADD tutorials "redis"
1) (integer) 1
redis 127.0.0.1:6379> PFADD tutorials "mongodb"
1) (integer) 1
redis 127.0.0.1:6379> PFADD tutorials "mysql"
1) (integer) 1
redis 127.0.0.1:6379> PFCOUNT tutorials
(integer) 3
```

### ä½œä¸ºå®šé‡æ•°æ®æŒ‡æ ‡

### å‘å¸ƒ/è®¢é˜…æ¨¡å‹

Redis çš„è®¢é˜…å®ç°äº†é‚®ä»¶ç³»ç»Ÿï¼Œå‘é€è€…ï¼ˆåœ¨ Redis çš„æœ¯è¯­ä¸­è¢«ç§°ä¸ºå‘å¸ƒè€…ï¼‰å‘é€çš„é‚®ä»¶ï¼Œè€Œæ¥æ”¶å™¨ï¼ˆç”¨æˆ·ï¼‰æ¥æ”¶å®ƒä»¬ã€‚ç”±è¯¥æ¶ˆæ¯ä¼ é€çš„é“¾è·¯è¢«ç§°ä¸ºé€šé“ã€‚

åœ¨ Redis å®¢æˆ·ç«¯å¯ä»¥è®¢é˜…ä»»ä½•æ•°ç›®çš„é€šé“ã€‚

```shell
redis 127.0.0.1:6379> SUBSCRIBE redisChat

Reading messages... (press Ctrl-C to quit)
1) "subscribe"
2) "redisChat"
3) (integer) 1
```

```shell
redis 127.0.0.1:6379> PUBLISH redisChat "Redis is a great caching technique"

(integer) 1

redis 127.0.0.1:6379> PUBLISH redisChat "Learn redis by tutorials point"

(integer) 1

1) "message"
2) "redisChat"
3) "Redis is a great caching technique"
1) "message"
2) "redisChat"
3) "Learn redis by tutorials point"
```

## Redis äº‹åŠ¡

Redis äº‹åŠ¡è®©ä¸€ç»„å‘½ä»¤åœ¨å•ä¸ªæ­¥éª¤æ‰§è¡Œã€‚äº‹åŠ¡ä¸­æœ‰ä¸¤ä¸ªå±æ€§ï¼Œè¯´æ˜å¦‚ä¸‹ï¼š

1. åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤æŒ‰é¡ºåºæ‰§è¡Œä½œä¸ºå•ä¸ªéš”ç¦»æ“ä½œã€‚é€šè¿‡å¦ä¸€ä¸ªå®¢æˆ·ç«¯å‘å‡ºçš„è¯·æ±‚åœ¨ Redis çš„äº‹åŠ¡çš„è¿‡ç¨‹ä¸­æ‰§è¡Œï¼Œè¿™æ˜¯ä¸å¯èƒ½çš„ã€‚
2. Redis çš„äº‹åŠ¡å…·æœ‰åŸå­æ€§ã€‚åŸå­æ„å‘³ç€è¦ä¹ˆæ‰€æœ‰çš„å‘½ä»¤éƒ½æ‰§è¡Œæˆ–éƒ½ä¸æ‰§è¡Œã€‚

> Redis çš„äº‹åŠ¡ç”±æŒ‡ä»¤å¤šé‡å‘èµ·ï¼Œç„¶åéœ€è¦ä¼ é€’åœ¨äº‹åŠ¡ï¼Œè€Œä¸”æ•´ä¸ªäº‹åŠ¡æ˜¯é€šè¿‡æ‰§è¡Œå‘½ä»¤ EXEC æ‰§è¡Œå‘½ä»¤åˆ—è¡¨ã€‚

```shell
redis 127.0.0.1:6379> MULTI
OK
List of commands here
redis 127.0.0.1:6379> EXEC
```

```shell
redis 127.0.0.1:6379> MULTI
OK
redis 127.0.0.1:6379> SET tutorial redis
QUEUED
redis 127.0.0.1:6379> GET tutorial
QUEUED
redis 127.0.0.1:6379> INCR visitors
QUEUED
redis 127.0.0.1:6379> EXEC

1) OK
2) "redis"
3) (integer) 1
```

## [CentOS7 MongoDB 3.0 å®‰è£…å…¨æ”»ç•¥](https://blog.dong4j.site/posts/53cebd27.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

### 1. ä¸‹è½½ & å®‰è£…

MongoDB 3.0 æ­£å¼ç‰ˆæœ¬å‘å¸ƒ! è¿™æ ‡å¿—ç€ MongoDB æ•°æ®åº“è¿›å…¥äº†ä¸€ä¸ªå…¨æ–°çš„å‘å±•é˜¶æ®µï¼Œæä¾›å¼ºå¤§ã€çµæ´»è€Œä¸”æ˜“äºç®¡ç†çš„æ•°æ®åº“ç®¡ç†ç³»ç»Ÿã€‚MongoDB å®£ç§°ï¼Œ3.0 æ–°ç‰ˆæœ¬ä¸åªæå‡ 7 åˆ° 10 å€çš„å†™å…¥æ•ˆç‡ä»¥åŠå¢åŠ  80% çš„æ•°æ®å‹ç¼©ç‡ï¼Œè¿˜èƒ½å‡å°‘ 95% çš„è¿ç»´æˆæœ¬ã€‚Â 
ã€€ã€€ MongoDB 3.0 ä¸»è¦æ–°ç‰¹æ€§åŒ…æ‹¬ï¼šÂ 
ã€€ã€€Â· å¯æ’å…¥å¼çš„å­˜å‚¨å¼•æ“ APIÂ 
ã€€ã€€Â· æ”¯æŒ WiredTiger å­˜å‚¨å¼•æ“ Â 
ã€€ã€€Â·MMAPv1 æå‡ Â 
ã€€ã€€Â· å¤åˆ¶é›†å…¨é¢æå‡ Â 
ã€€ã€€Â· é›†ç¾¤æ–¹é¢çš„æ”¹è¿› Â 
ã€€ã€€Â· æå‡äº†å®‰å…¨æ€§ Â 
ã€€ã€€Â· å·¥å…·çš„æå‡ Â 
WiredTiger å­˜å‚¨å¼•æ“æ˜¯ä¸€é¡¹éš¾ä»¥ç½®ä¿¡çš„æŠ€æœ¯å®ç°ï¼Œæä¾›æ— é—¨é—©ã€éå µå¡ç®—æ³•æ¥åˆ©ç”¨å…ˆè¿›çš„ç¡¬ä»¶å¹³å° (å¦‚å¤§å®¹é‡èŠ¯ç‰‡ç¼“å­˜å’Œçº¿ç¨‹åŒ–æ¶æ„) æ¥æå‡æ€§èƒ½ã€‚é€šè¿‡ WiredTigerï¼ŒMongoDB 3.0 å®ç°äº†æ–‡æ¡£çº§åˆ«çš„å¹¶å‘æ§åˆ¶ï¼Œå› æ­¤å¤§å¹…æå‡äº†å¤§å¹¶å‘ä¸‹çš„å†™è´Ÿè½½ã€‚

MongoDB æä¾›äº† centos yum å®‰è£…æ–¹å¼ã€‚

vi /etc/yum.repos.d/mongodb-org-3.0.repo

```shell
[mongodb-org-3.0]
name=MongoDB Repository
baseurl=http://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/3.0/x86_64/
gpgcheck=0
enabled=1
```

å®‰è£… mongodb

```shell
yum install -y mongodb-org
```

å®‰è£…äº†æ‰€æœ‰ç›¸å…³æœåŠ¡ã€‚

```shell
......
Running transaction
  Installing : mongodb-org-shell-3.0.2-1.el7.x86_64      1/5
  Installing : mongodb-org-tools-3.0.2-1.el7.x86_64      2/5
  Installing : mongodb-org-mongos-3.0.2-1.el7.x86_64     3/5
  Installing : mongodb-org-server-3.0.2-1.el7.x86_64     4/5
  Installing : mongodb-org-3.0.2-1.el7.x86_64            5/5
  Verifying  : mongodb-org-3.0.2-1.el7.x86_64           1/5
  Verifying  : mongodb-org-server-3.0.2-1.el7.x86_64    2/5
  Verifying  : mongodb-org-mongos-3.0.2-1.el7.x86_64    3/5
  Verifying  : mongodb-org-tools-3.0.2-1.el7.x86_64     4/5
  Verifying  : mongodb-org-shell-3.0.2-1.el7.x86_64     5/5
```

é…ç½®æ–‡ä»¶åœ¨ï¼š/etc/mongod.confÂ  æ•°æ®æ–‡ä»¶åœ¨ï¼š/var/lib/mongoÂ  æ—¥å¿—æ–‡ä»¶åœ¨ï¼š/var/log/mongodbÂ  mongodb æœåŠ¡ä½¿ç”¨

```shell
#å¯åŠ¨
service mongod start
#åœæ­¢
service mongod stop
#é‡å¯
service mongod restart
#å¢åŠ å¼€æœºå¯åŠ¨
chkconfig mongod on
```

### 2. MongoDB CRUD

è¿æ¥åˆ° MongoDBï¼Œå¾ˆç®€å•ï¼Œæ‰§è¡Œ mongo å°±å¯ä»¥äº†ã€‚

```shell
# mongo
MongoDB shell version: 3.0.2
connecting to: test
Welcome to the MongoDB shell.
For interactive help, type "help".
For more comprehensive documentation, see
        http://docs.mongodb.org/
Questions? Try the support group
        http://groups.google.com/group/mongodb-user
Server has startup warnings:
I STORAGE  [initandlisten]
I STORAGE  [initandlisten] ** WARNING: Readahead for /var/lib/mongo is set to 4096KB
I STORAGE  [initandlisten] **          We suggest setting it to 256KB (512 sectors) or less
I STORAGE  [initandlisten] **          http://dochub.mongodb.org/core/readahead
I CONTROL  [initandlisten]
I CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is 'always'.
I CONTROL  [initandlisten] **        We suggest setting it to 'never'
I CONTROL  [initandlisten]
I CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is 'always'.
I CONTROL  [initandlisten] **        We suggest setting it to 'never'
I CONTROL  [initandlisten]
I CONTROL  [initandlisten] ** WARNING: soft rlimits too low. rlimits set to 4096 processes, 64000 files. Number of processes should be at least 32000 : 0.5 times number of files.
I CONTROL  [initandlisten]
>
```

#### 2.1. åˆ›å»ºæ•°æ®ï¼š

http://docs.mongodb.org/manual/tutorial/insert-documents/Â  http://docs.mongodb.org/manual/reference/method/db.collection.insert/

```shell
> db.users.insert(
... {
... name:"zhang san",
... age:26,
... city:"bei jing"
... }
... )
WriteResult({ "nInserted" : 1 })
> db.users.insert(
... {
... _id:1,
... name:"zhang san",
... age:26,
... city:"bei jing"
... }
... )
WriteResult({ "nInserted" : 1 })
> db.users.insert(
... {
... _id:1,
... name:"zhang san",
... age:26,
... city:"bei jing"
... }
... )
WriteResult({
        "nInserted" : 0,
        "writeError" : {
                "code" : 11000,
                "errmsg" : "E11000 duplicate key error index: test.users.$_id_ dup key: { : 1.0 }"
        }
})
> db.users.insert(
... {
... _id:2,
... name:"li si",
... age:28,
... city:"shang hai"
... }
... )
WriteResult({ "nInserted" : 1 })
```

æ•°æ®å¯ä»¥æ²¡æœ‰ä¸»é”® idï¼Œå¦‚æœæ²¡æœ‰ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªã€‚å¦‚æœè®¾ç½®äº† `_id` ä¸»é”®ï¼Œå°±å¿…é¡»ä¸é‡å¤ã€‚Â  å¦åˆ™æŠ¥ä¸»é”®å†²çªï¼š`E11000 duplicate key error index: test.users.$_id* dup key: { : 1.0}`

#### 2.2. æ›´æ–°æ•°æ®ï¼š

http://docs.mongodb.org/manual/tutorial/modify-documents/

```shell
> db.users.update(
... {_id:2},
... {
... $set: {
... city:"guang zhou"
... }
... }
... )
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
> db.users.update(
... {_id:3},
... {
... $set: {
... city:"si chuan"
... }
... },
... { upsert: true }
... )
WriteResult({ "nMatched" : 0, "nUpserted" : 1, "nModified" : 0, "_id" : 3 })
```

æ›´æ–°ä½¿ç”¨ updateï¼Œå¦‚æœå¢åŠ  {upsert: true}ï¼Œåˆ™è¡¨ç¤ºæ²¡æœ‰æŸ¥è¯¢åˆ°æ•°æ®ç›´æ¥æ’å…¥ã€‚

#### 2.3. åˆ é™¤ï¼š

http://docs.mongodb.org/manual/tutorial/remove-documents/

```shell
> db.users.remove({_id:3})
WriteResult({ "nRemoved" : 1 })
> db.users.remove({_id:4})
WriteResult({ "nRemoved" : 0 })
```

æŸ¥è¯¢åˆ°æ•°æ®æ‰è¿›è¡Œåˆ é™¤ï¼Œå¹¶ä¸”è¿”å›åˆ é™¤æ•°é‡ã€‚

#### 2.4. æŸ¥è¯¢ï¼š

http://docs.mongodb.org/manual/tutorial/query-documents/

```shell
> db.users.find({age:{ $gt: 26}})
{ "_id" : 2, "name" : "li si", "age" : 28, "city" : "guang zhou" }
> db.users.find({age:{ $gt: 25}})
{ "_id" : ObjectId("5540adf29b0f52a6786de216"), "name" : "zhang san", "age" : 26, "city" : "bei jing" }
{ "_id" : 1, "name" : "zhang san", "age" : 26, "city" : "bei jing" }
{ "_id" : 2, "name" : "li si", "age" : 28, "city" : "guang zhou" }
#æŸ¥è¯¢å…¨éƒ¨æ•°æ®
> db.users.find()
{ "_id" : ObjectId("5540adf29b0f52a6786de216"), "name" : "zhang san", "age" : 26, "city" : "bei jing" }
{ "_id" : 1, "name" : "zhang san", "age" : 26, "city" : "bei jing" }
{ "_id" : 2, "name" : "li si", "age" : 28, "city" : "guang zhou" }
```

#### 2.5. æ›´å¤šæ–¹æ³•

db.collection.aggregate()Â  db.collection.count()Â  db.collection.copyTo()Â  db.collection.createIndex()Â  db.collection.getIndexStats()Â  db.collection.indexStats()Â  db.collection.dataSize()Â  db.collection.distinct()Â  db.collection.drop()Â  db.collection.dropIndex()Â  db.collection.dropIndexes()Â  db.collection.ensureIndex()Â  db.collection.explain()Â  db.collection.find()Â  db.collection.findAndModify()Â  db.collection.findOne()Â  db.collection.getIndexes()Â  db.collection.getShardDistribution()Â  db.collection.getShardVersion()Â  db.collection.group()Â  db.collection.insert()Â  db.collection.isCapped()Â  db.collection.mapReduce()Â  db.collection.reIndex()Â  db.collection.remove()Â  db.collection.renameCollection()Â  db.collection.save()Â  db.collection.stats()Â  db.collection.storageSize()Â  db.collection.totalSize()Â  db.collection.totalIndexSize()Â  db.collection.update()Â  db.collection.validate()

### 3. MongoDB å¯è§†åŒ–å·¥å…·

http://www.robomongo.org/

ä½¿ç”¨å¯è§†åŒ–å·¥å…·ï¼Œæ–¹ä¾¿ä½¿ç”¨ MongoDB ç®¡ç†ã€‚Â  é¦–å…ˆè¦ä¿®æ”¹ä¸‹ç«¯å£å’Œ ipÂ  vi /etc/mongod.conf

```shell
port=27017

dbpath=/var/lib/mongo

# location of pidfile
pidfilepath=/var/run/mongodb/mongod.pid

# Listen to local interface only. Comment out to listen on all interfaces.
bind_ip=192.168.1.36
```

ç„¶åé‡å¯ MongoDB

```shell
service mongod restart
```

### 4. æ€»ç»“

MongoDB 3.0 æ“ä½œèµ·æ¥è¿˜æ˜¯å¾ˆæ–¹ä¾¿çš„ã€‚èƒ½é«˜æ•ˆçš„ä½¿ç”¨ã€‚Â  åŒæ—¶ MongoDB æ‰©å±•ä¹Ÿå¾ˆæ–¹ä¾¿ã€‚æ¥ä¸‹æ¥ç ”ç©¶ã€‚Â  å¯¹åº”äº’è”ç½‘ä¸šåŠ¡æ¥è¯´æ²¡æœ‰å¤æ‚çš„ join æŸ¥è¯¢ã€‚åªè¿½æ±‚é«˜æ•ˆï¼Œå¿«é€Ÿè®¿é—®ã€‚

## [åœ¨CentOSä¸Šäº«å—æ›´é«˜æ•ˆçš„Shellä½“éªŒï¼šoh-my-zsh](https://blog.dong4j.site/posts/ac4909f7.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})


ä½¿ç”¨ root ç”¨æˆ·ç™»å½•ï¼Œä¸‹é¢çš„æ“ä½œåŸºæœ¬éƒ½æ²¡æœ‰ root çš„å›°æ‰°ï¼Œå¦‚æœé root ç”¨æˆ·è¯·åˆ‡æ¢è‡³ root ç”¨æˆ·æ“ä½œã€‚

**1ã€æŸ¥çœ‹ç³»ç»Ÿå½“å‰çš„ shell**

```shell
echo $SHELL
```

è¿”å›ç»“æœå¦‚ä¸‹ï¼š

```shell
/bin/bash
```

_PS. é»˜è®¤çš„ shell ä¸€èˆ¬éƒ½æ˜¯ bash_

---

**2ã€æŸ¥çœ‹ bin ä¸‹æ˜¯å¦æœ‰ zsh åŒ…**

```shell
cat /etc/shells
```

è¿”å›ç»“æœå¦‚ä¸‹ï¼š

```shell
/bin/sh
/bin/bash
/sbin/nologin
/bin/dash
/bin/tcsh
/bin/csh
```

_PS. é»˜è®¤æ²¡æœ‰å®‰è£… zsh_

---

**3ã€å®‰è£… zsh åŒ…**

```shell
yum -y install zsh
```

å®‰è£…å®ŒæˆåæŸ¥çœ‹ shell åˆ—è¡¨ï¼š

```shell
cat /etc/shells
```

è¿”å›ç»“æœå¦‚ä¸‹ï¼š

```shell
/bin/sh
/bin/bash
/sbin/nologin
/bin/dash
/bin/tcsh
/bin/csh
/bin/zsh
```

_ç°åœ¨ zsh å·²ç»å®‰è£…å®Œæˆäº†ï¼Œéœ€è¦æŠŠç³»ç»Ÿé»˜è®¤çš„ shell ç”± bash åˆ‡æ¢ä¸º zsh_

---

**3ã€åˆ‡æ¢ shell è‡³ zshï¼Œä»£ç å¦‚ä¸‹ï¼š**

```shell
chsh -s /bin/zsh
```

chsh ç”¨æ³•è¯·è‡ªè¡ŒæŸ¥æ‰¾ï¼Œè¿”å›ç»“æœå¦‚ä¸‹ï¼š

```shell
Changing shell for root.
Shell changed.
```

æŒ‰æç¤ºæ‰€è¿°ï¼Œshell å·²ç»æ›´æ”¹ä¸º zsh äº†ï¼Œç°åœ¨æŸ¥çœ‹ä¸€ä¸‹ç³»ç»Ÿå½“å‰ä½¿ç”¨çš„ shellï¼Œ

```shell
echo $SHELL
```

è¿”å›ç»“æœå¦‚ä¸‹ï¼š

```shell
/bin/bash
```

çœ‹æ ·å­è¿˜æ²¡åˆ‡æ¢è¿‡æ¥ï¼Œéœ€è¦é‡å¯ä¸€ä¸‹æœåŠ¡å™¨ï¼Œæˆ‘çš„ä¹ æƒ¯åšæ³•æ˜¯åœ¨ ECS çš„ web ç®¡ç†å¹³å°é‡å¯ï¼Œ`reboot`åˆ°åº•å¥½ä¸å¥½ä½¿è¿˜æ²¡è¯•è¿‡ï¼Œå¤§å®¶å¯ä»¥è¯•è¯•

é‡å¯è¿‡åï¼Œä½¿ç”¨ä»£ç æŸ¥çœ‹å½“å‰ä½¿ç”¨çš„ shell

```shell
echo $SHELL
```

è¿”å›ç»“æœï¼š

```shell
/bin/zsh
```

å¾—åˆ°å¦‚æ­¤ç»“æœï¼Œè¯æ˜ shell å·²ç»åˆ‡æ¢æˆåŠŸäº†ã€‚

---

**ä¸‹é¢å¼€å§‹å®‰è£… oh-my-zsh**
Â Â Â Â *oh-my-zsh æºç æ˜¯æ”¾åœ¨ github ä¸Šçš„ï¼Œæ‰€ä»¥å…ˆè¦å®‰è£… git*
**4ã€å®‰è£… gitï¼š**

```shell
yum -y install git
```

**5ã€å®‰è£… oh-my-zsh:**

```shell
wget https://github.com/robbyrussell/oh-my-zsh/raw/master/tools/install.sh -O - | sh
```

å¦‚æœæ˜¾ç¤ºå¦‚ä¸‹ç•Œé¢è¡¨ç¤ºæˆåŠŸï¼š

```shell
         __                                     __
  ____  / /_     ____ ___  __  __   ____  _____/ /_
 / __ \/ __ \   / __ `__ \/ / / /  /_  / / ___/ __ \
/ /_/ / / / /  / / / / / / /_/ /    / /_(__  ) / / /
\____/_/ /_/  /_/ /_/ /_/\__, /    /___/____/_/ /_/
                        /____/                       ....is now installed!
Please look over the ~/.zshrc file to select plugins, themes, and options.

p.s. Follow us at https://twitter.com/ohmyzsh.

p.p.s. Get stickers and t-shirts at http://shop.planetargon.com.
```

å¦‚æœæ·»åŠ æ’ä»¶ã€æ›´æ”¹ themes è¯·ä¿®æ”¹~/.zshrc æˆ–è‡ªè¡ŒæŸ¥è¯¢å…¶å®ƒèµ„æ–™ã€‚

è‡³æ­¤ï¼Œzsh å®‰è£…å®Œæ¯•ï¼Œå¼€å§‹äº«å— oh-my-zsh å§ï¼Œå¦‚æœæ‰§è¡Œå‘½ä»¤æ—¶æç¤º`warning: cannot set LC_CTYPE locale`å¯ç”¨ä»¥ä¸‹æ–¹æ³•è§£å†³ï¼š

ä¿®æ”¹ profileï¼š

```shell
vi /etc/profile
```

åœ¨ profile æœ«å°¾æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```shell
export LC_ALL=en_US.UTF-8
export LC_CTYPE=en_US.UTF-8
```

å¼•ç”¨æ›´æ”¹åçš„ profileï¼š

```shell
source /etc/profile
```

æ­¤æ—¶ bash å·²åˆ‡æ¢è‡³ zshã€‚

## [æŒæ¡ Shell ç¼–ç¨‹ï¼šLinux å¿…å¤‡æŠ€èƒ½](https://blog.dong4j.site/posts/441dc39d.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ç®€è¿°

ä½¿ç”¨ linux å°±ç¦»ä¸å¼€ shellï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´ä¹Ÿç¦»ä¸å¼€ shell ç¼–ç¨‹ã€‚å¾ˆå¤šæ—¶å€™æœåŠ¡å™¨éƒ½éœ€è¦ç¼–å†™ä¸€äº›è®¡åˆ’ä»»åŠ¡æ¥å®šæ—¶è¿è¡Œçš„ï¼Œæ‰€ä»¥æŒæ¡ä¸€äº›åŸºæœ¬çš„ shell ç¼–ç¨‹åŸºç¡€å¾ˆæœ‰å¿…è¦ã€‚

æœ¬æ–‡æ˜¯æˆ‘åœ¨ç½‘ä¸Šæ”¶é›†çš„ä¸€äº›èµ„æ–™ï¼Œä¸»è¦ç›®çš„æ˜¯å¸®åŠ©è‡ªå·±æ›´å¥½çš„äº†è§£æŒæ¡ shell ç¼–ç¨‹çš„ä¸€äº›åŸºç¡€çŸ¥è¯†ã€‚

## ä»€ä¹ˆæ˜¯ Shell è„šæœ¬

ç¤ºä¾‹çœ‹ä¸ªä¾‹å­å§ï¼š

```shell

#!/bin/sh

cd ~
mkdir shell_tut
cd shell_tut
for ((i=0; i<10; i++)); do
    touch test_$i.txt
done
```

ç¤ºä¾‹è§£é‡Šï¼š

- ç¬¬ 1 è¡Œï¼šæŒ‡å®šè„šæœ¬è§£é‡Šå™¨ï¼Œè¿™é‡Œæ˜¯ç”¨/bin/sh åšè§£é‡Šå™¨çš„
- ç¬¬ 2 è¡Œï¼šåˆ‡æ¢åˆ°å½“å‰ç”¨æˆ·çš„ home ç›®å½•
- ç¬¬ 3 è¡Œï¼šåˆ›å»ºä¸€ä¸ªç›®å½• shell_tut
- ç¬¬ 4 è¡Œï¼šåˆ‡æ¢åˆ° shell_tut ç›®å½•
- ç¬¬ 5 è¡Œï¼šå¾ªç¯æ¡ä»¶ï¼Œä¸€å…±å¾ªç¯ 10 æ¬¡
- ç¬¬ 6 è¡Œï¼šåˆ›å»ºä¸€ä¸ª test_1â€¦10.txt æ–‡ä»¶
- ç¬¬ 7 è¡Œï¼šå¾ªç¯ä½“ç»“æŸ

```shell

cd, mkdir, touch éƒ½æ˜¯ç³»ç»Ÿè‡ªå¸¦çš„ç¨‹åºï¼Œä¸€èˆ¬åœ¨/binæˆ–è€…/usr/binç›®å½•ä¸‹ã€‚
for, do, done æ˜¯shè„šæœ¬è¯­è¨€çš„å…³é”®å­—ã€‚
```

## shell å’Œ shell è„šæœ¬çš„æ¦‚å¿µ

shell æ˜¯æŒ‡ä¸€ç§åº”ç”¨ç¨‹åºï¼Œè¿™ä¸ªåº”ç”¨ç¨‹åºæä¾›äº†ä¸€ä¸ªç•Œé¢ï¼Œç”¨æˆ·é€šè¿‡è¿™ä¸ªç•Œé¢è®¿é—®æ“ä½œç³»ç»Ÿå†…æ ¸çš„æœåŠ¡ã€‚  
Ken Thompson çš„ sh æ˜¯ç¬¬ä¸€ç§ Unix Shellï¼ŒWindows Explorer æ˜¯ä¸€ä¸ªå…¸å‹çš„å›¾å½¢ç•Œé¢ Shellã€‚  
shell è„šæœ¬ï¼ˆshell scriptï¼‰ï¼Œæ˜¯ä¸€ç§ä¸º shell ç¼–å†™çš„è„šæœ¬ç¨‹åºã€‚  
ä¸šç•Œæ‰€è¯´çš„ shell é€šå¸¸éƒ½æ˜¯æŒ‡ shell è„šæœ¬ï¼Œä½†è¯»è€…æœ‹å‹è¦çŸ¥é“ï¼Œshell å’Œ shell script æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µã€‚  
ç”±äºä¹ æƒ¯çš„åŸå› ï¼Œç®€æ´èµ·è§ï¼Œæœ¬æ–‡å‡ºç°çš„â€œshell ç¼–ç¨‹â€éƒ½æ˜¯æŒ‡ shell è„šæœ¬ç¼–ç¨‹ï¼Œä¸æ˜¯æŒ‡å¼€å‘ shell è‡ªèº«ï¼ˆå¦‚ Windows Explorer æ‰©å±•å¼€å‘ï¼‰ã€‚  
ç¯å¢ƒ shell ç¼–ç¨‹è·Ÿ javaã€php ç¼–ç¨‹ä¸€æ ·ï¼Œåªè¦æœ‰ä¸€ä¸ªèƒ½ç¼–å†™ä»£ç çš„æ–‡æœ¬ç¼–è¾‘å™¨å’Œä¸€ä¸ªèƒ½è§£é‡Šæ‰§è¡Œçš„è„šæœ¬è§£é‡Šå™¨å°±å¯ä»¥äº†ã€‚  
OS å½“å‰ä¸»æµçš„æ“ä½œç³»ç»Ÿéƒ½æ”¯æŒ shell ç¼–ç¨‹ï¼Œæœ¬æ–‡æ¡£æ‰€è¿°çš„ shell ç¼–ç¨‹æ˜¯æŒ‡ Linux ä¸‹çš„ shellï¼Œè®²çš„åŸºæœ¬éƒ½æ˜¯ POSIX æ ‡å‡†ä¸‹çš„åŠŸèƒ½ï¼Œæ‰€ä»¥ï¼Œä¹Ÿé€‚ç”¨äº Unix åŠ BSDï¼ˆå¦‚ Mac OSï¼‰ã€‚  
LinuxLinux é»˜è®¤å®‰è£…å°±å¸¦äº† shell è§£é‡Šå™¨ã€‚  
Mac OSMac OS ä¸ä»…å¸¦äº† shã€bash è¿™ä¸¤ä¸ªæœ€åŸºç¡€çš„è§£é‡Šå™¨ï¼Œè¿˜å†…ç½®äº† kshã€cshã€zsh ç­‰ä¸å¸¸ç”¨çš„è§£é‡Šå™¨ã€‚  
Windows ä¸Šçš„æ¨¡æ‹Ÿå™¨ windows å‡ºå‚æ—¶æ²¡æœ‰å†…ç½® shell è§£é‡Šå™¨ï¼Œéœ€è¦è‡ªè¡Œå®‰è£…ï¼Œä¸ºäº†åŒæ—¶èƒ½ç”¨ grep, awk, curl ç­‰å·¥å…·ï¼Œæœ€å¥½è£…ä¸€ä¸ª cygwin æˆ–è€… mingw æ¥æ¨¡æ‹Ÿ linux ç¯å¢ƒã€‚

- cygwin
- mingw

## è„šæœ¬è§£é‡Šå™¨ sh

å³ Bourne shellï¼ŒPOSIXï¼ˆPortable Operating System Interfaceï¼‰æ ‡å‡†çš„ shell è§£é‡Šå™¨ï¼Œå®ƒçš„äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„é€šå¸¸æ˜¯/bin/shï¼Œç”± Bell Labs å¼€å‘ã€‚

bashBash æ˜¯ Bourne shell çš„æ›¿ä»£å“ï¼Œå± GNU Projectï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„é€šå¸¸æ˜¯/bin/bashã€‚ä¸šç•Œé€šå¸¸æ··ç”¨ bashã€shã€å’Œ shellï¼Œæ¯”å¦‚ä½ ä¼šç»å¸¸åœ¨æ‹›è˜è¿ç»´å·¥ç¨‹å¸ˆçš„æ–‡æ¡ˆä¸­è§åˆ°ï¼šç†Ÿæ‚‰ Linux Bash ç¼–ç¨‹ï¼Œç²¾é€š Shell ç¼–ç¨‹ã€‚

åœ¨ CentOS é‡Œï¼Œ/bin/sh æ˜¯ä¸€ä¸ªæŒ‡å‘/bin/bash çš„ç¬¦å·é“¾æ¥:

```shell

[root@centosraw ~]# ls -l /bin/*sh
-rwxr-xr-x. 1 root root 903272 Feb 22 05:09 /bin/bash
-rwxr-xr-x. 1 root root 106216 Oct 17 2012 /bin/dash
lrwxrwxrwx. 1 root root 4 Mar 22 10:22 /bin/sh -> bash

```

ä½†åœ¨ Mac OS ä¸Šä¸æ˜¯ï¼Œ/bin/sh å’Œ/bin/bash æ˜¯ä¸¤ä¸ªä¸åŒçš„æ–‡ä»¶ï¼Œå°½ç®¡å®ƒä»¬çš„å¤§å°åªç›¸å·® 100 å­—èŠ‚å·¦å³:

```shell

iMac:~ wuxiao$ ls -l /bin/*sh
-r-xr-xr-x 1 root wheel 1371648 6 Nov 16:52 /bin/bash
-rwxr-xr-x 2 root wheel 772992 6 Nov 16:52 /bin/csh
-r-xr-xr-x 1 root wheel 2180736 6 Nov 16:52 /bin/ksh
-r-xr-xr-x 1 root wheel 1371712 6 Nov 16:52 /bin/sh
-rwxr-xr-x 2 root wheel 772992 6 Nov 16:52 /bin/tcsh
-rwxr-xr-x 1 root wheel 1103984 6 Nov 16:52 /bin/zsh
```

## å¦‚ä½•é€‰æ‹© shell ç¼–ç¨‹è¯­è¨€

ç†Ÿæ‚‰ vs é™Œç”Ÿå¦‚æœä½ å·²ç»æŒæ¡äº†ä¸€é—¨ç¼–ç¨‹è¯­è¨€ï¼ˆå¦‚ PHPã€Pythonã€Javaã€JavaScriptï¼‰ï¼Œå»ºè®®ä½ å°±ç›´æ¥ä½¿ç”¨è¿™é—¨è¯­è¨€ç¼–å†™è„šæœ¬ç¨‹åºï¼Œè™½ç„¶æŸäº›åœ°æ–¹ä¼šæœ‰ç‚¹å•°å—¦ï¼Œä½†ä½ èƒ½åˆ©ç”¨åœ¨è¿™é—¨è¯­è¨€é¢†åŸŸé‡Œçš„ç»éªŒï¼ˆå•å…ƒæµ‹è¯•ã€å•æ­¥è°ƒè¯•ã€IDEã€ç¬¬ä¸‰æ–¹ç±»åº“ï¼‰ã€‚

æ–°å¢çš„å­¦ä¹ æˆæœ¬å¾ˆå°ï¼Œåªè¦å­¦ä¼šæ€ä¹ˆä½¿ç”¨ shell è§£é‡Šå™¨ï¼ˆJshellã€AdaScriptï¼‰å°±å¯ä»¥äº†ã€‚

ç®€å• vs é«˜çº§å¦‚æœä½ è§‰å¾—è‡ªå·±ç†Ÿæ‚‰çš„è¯­è¨€ï¼ˆå¦‚ Javaã€Cï¼‰å†™ shell è„šæœ¬å®åœ¨å¤ªå•°å—¦ï¼Œä½ åªæ˜¯æƒ³åšä¸€äº›å¤‡ä»½æ–‡ä»¶ã€å®‰è£…è½¯ä»¶ã€ä¸‹è½½æ•°æ®ä¹‹ç±»çš„äº‹æƒ…ï¼Œå­¦ç€ä½¿ç”¨ shï¼Œbash ä¼šæ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚

shell åªå®šä¹‰äº†ä¸€ä¸ªéå¸¸ç®€å•çš„ç¼–ç¨‹è¯­è¨€ï¼Œæ‰€ä»¥ï¼Œå¦‚æœä½ çš„è„šæœ¬ç¨‹åºå¤æ‚åº¦è¾ƒé«˜ï¼Œæˆ–è€…è¦æ“ä½œçš„æ•°æ®ç»“æ„æ¯”è¾ƒå¤æ‚ï¼Œé‚£ä¹ˆè¿˜æ˜¯åº”è¯¥ä½¿ç”¨ Pythonã€Perl è¿™æ ·çš„è„šæœ¬è¯­è¨€ï¼Œæˆ–è€…æ˜¯ä½ æœ¬æ¥å°±å·²ç»å¾ˆæ“…é•¿çš„é«˜çº§è¯­è¨€ã€‚

å› ä¸º sh å’Œ bash åœ¨è¿™æ–¹é¢å¾ˆå¼±ï¼Œæ¯”å¦‚è¯´ï¼š

- å®ƒçš„å‡½æ•°åªèƒ½è¿”å›å­—ä¸²ï¼Œæ— æ³•è¿”å›æ•°ç»„
- å®ƒä¸æ”¯æŒé¢å‘å¯¹è±¡ï¼Œä½ æ— æ³•å®ç°ä¸€äº›ä¼˜é›…çš„è®¾è®¡æ¨¡å¼
- å®ƒæ˜¯è§£é‡Šå‹çš„ï¼Œä¸€è¾¹è§£é‡Šä¸€è¾¹æ‰§è¡Œï¼Œè¿ PHP é‚£ç§é¢„ç¼–è¯‘éƒ½ä¸æ˜¯ï¼Œå¦‚æœä½ çš„è„šæœ¬åŒ…å«é”™è¯¯ (ä¾‹å¦‚è°ƒç”¨äº†ä¸å­˜åœ¨çš„å‡½æ•°)ï¼Œåªè¦æ²¡æ‰§è¡Œåˆ°è¿™ä¸€è¡Œï¼Œå°±ä¸ä¼šæŠ¥é”™

ç¯å¢ƒå…¼å®¹æ€§å¦‚æœä½ çš„è„šæœ¬æ˜¯æä¾›ç»™åˆ«çš„ç”¨æˆ·ä½¿ç”¨ï¼Œä½¿ç”¨ sh æˆ–è€… bashï¼Œä½ çš„è„šæœ¬å°†å…·æœ‰æœ€å¥½çš„ç¯å¢ƒå…¼å®¹æ€§ï¼Œperl å¾ˆæ—©å°±æ˜¯ linux æ ‡é…äº†ï¼Œpython è¿™äº›å¹´ä¹Ÿæˆäº†ä¸€äº› linux å‘è¡Œç‰ˆçš„æ ‡é…ï¼Œè‡³äº mac osï¼Œå®ƒé»˜è®¤å®‰è£…äº† perlã€pythonã€rubyã€phpã€java ç­‰ä¸»æµç¼–ç¨‹è¯­è¨€ã€‚

ç¬¬ä¸€ä¸ª shell è„šæœ¬ ç¼–å†™æ‰“å¼€æ–‡æœ¬ç¼–è¾‘å™¨ï¼Œæ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œæ‰©å±•åä¸º shï¼ˆsh ä»£è¡¨ shellï¼‰ï¼Œæ‰©å±•åå¹¶ä¸å½±å“è„šæœ¬æ‰§è¡Œï¼Œè§åçŸ¥æ„å°±å¥½ï¼Œå¦‚æœä½ ç”¨ php å†™ shell è„šæœ¬ï¼Œæ‰©å±•åå°±ç”¨ php å¥½äº†ã€‚

è¾“å…¥ä¸€äº›ä»£ç ï¼Œç¬¬ä¸€è¡Œä¸€èˆ¬æ˜¯è¿™æ ·ï¼š

```shell
#!/bin/bash

#!/usr/bin/php
```

â€œ#!â€æ˜¯ä¸€ä¸ªçº¦å®šçš„æ ‡è®°ï¼Œå®ƒå‘Šè¯‰ç³»ç»Ÿè¿™ä¸ªè„šæœ¬éœ€è¦ä»€ä¹ˆè§£é‡Šå™¨æ¥æ‰§è¡Œã€‚

## è¿è¡Œ

è¿è¡Œ Shell è„šæœ¬æœ‰ä¸¤ç§æ–¹æ³•ï¼š

**1ã€ä½œä¸ºå¯æ‰§è¡Œç¨‹åº**

å°†ä¸Šé¢çš„ä»£ç ä¿å­˜ä¸º test.shï¼Œå¹¶ cd åˆ°ç›¸åº”ç›®å½•ï¼š

```shell
chmod +x ./test.sh #ä½¿è„šæœ¬å…·æœ‰æ‰§è¡Œæƒé™
```

```shell
./test.sh #æ‰§è¡Œè„šæœ¬
```

æ³¨æ„ï¼š

- ä¸€å®šè¦å†™æˆ./test.shï¼Œè€Œä¸æ˜¯ test.shï¼Œè¿è¡Œå…¶å®ƒäºŒè¿›åˆ¶çš„ç¨‹åºä¹Ÿä¸€æ ·ã€‚
- ç›´æ¥å†™ test.shï¼Œlinux ç³»ç»Ÿä¼šå» PATH é‡Œå¯»æ‰¾æœ‰æ²¡æœ‰å« test.sh çš„ï¼Œåªæœ‰/bin, /sbin, /usr/binï¼Œ/usr/sbin ç­‰åœ¨ PATH é‡Œã€‚
- ä½ çš„å½“å‰ç›®å½•é€šå¸¸ä¸åœ¨ PATH é‡Œï¼Œæ‰€ä»¥å†™æˆ test.sh æ˜¯ä¼šæ‰¾ä¸åˆ°å‘½ä»¤çš„ï¼Œè¦ç”¨./test.sh å‘Šè¯‰ç³»ç»Ÿè¯´ï¼Œå°±åœ¨å½“å‰ç›®å½•æ‰¾ã€‚

**2ã€ä½œä¸ºè§£é‡Šå™¨å‚æ•°**

è¿™ç§è¿è¡Œæ–¹å¼æ˜¯ï¼Œç›´æ¥è¿è¡Œè§£é‡Šå™¨ï¼Œå…¶å‚æ•°å°±æ˜¯ shell è„šæœ¬çš„æ–‡ä»¶åï¼Œå¦‚ï¼š

```shell
/bin/sh test.sh
```

```shell
/bin/php test.php
```

è¿™ç§æ–¹å¼è¿è¡Œçš„è„šæœ¬ï¼Œä¸éœ€è¦åœ¨ç¬¬ä¸€è¡ŒæŒ‡å®šè§£é‡Šå™¨ä¿¡æ¯ï¼Œå†™äº†ä¹Ÿæ²¡ç”¨ã€‚

## å˜é‡

å®šä¹‰å˜é‡å®šä¹‰å˜é‡æ—¶ï¼Œå˜é‡åä¸åŠ ç¾å…ƒç¬¦å·ï¼ˆ$ï¼‰ï¼Œå¦‚ï¼š

```shell
your_name="qinjx"
```

æ³¨æ„ï¼Œå˜é‡åå’Œç­‰å·ä¹‹é—´ä¸èƒ½æœ‰ç©ºæ ¼ï¼Œè¿™å¯èƒ½å’Œä½ ç†Ÿæ‚‰çš„æ‰€æœ‰ç¼–ç¨‹è¯­è¨€éƒ½ä¸ä¸€æ ·ï¼š

- é¦–ä¸ªå­—æ¯å¿…é¡»ä¸ºå­—æ¯ï¼ˆa-z,A-Zï¼‰ã€‚
- ä¸­é—´ä¸èƒ½æœ‰ç©ºæ ¼ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹åˆ’çº¿ã€‚
- ä¸èƒ½ä½¿ç”¨è¡¨å•ç¬¦å·ã€‚
- ä¸èƒ½ä½¿ç”¨ bash é‡Œçš„å…³é”®å­—ï¼ˆå¦‚æœä¸æ¸…æ¥šï¼Œå¯ä»¥ç”¨ help å‘½ä»¤æŸ¥çœ‹ bash çš„ä¿ç•™å…³é”®å­—ï¼‰ã€‚

é™¤äº†æ˜¾å¼åœ°ç›´æ¥èµ‹å€¼ï¼Œè¿˜å¯ä»¥ç”¨è¯­å¥ç»™å˜é‡èµ‹å€¼ï¼Œå¦‚ï¼š

```shell
for file in `ls /etc`
```

- è¯´æ˜ï¼šä¸Šé¢çš„å‘½ä»¤çš„æ„æ€æ˜¯å®ç°å°† /etc ä¸‹ç›®å½•çš„æ–‡ä»¶åå¾ªç¯å‡ºæ¥ã€‚

**ä½¿ç”¨å˜é‡**

ä½¿ç”¨ä¸€ä¸ªå®šä¹‰è¿‡å¾—å˜é‡ï¼Œåªè¦åœ¨å˜é‡åä¹‹å‰åŠ ä¸Šç¾å…ƒç¬¦å· $ å³å¯ï¼Œæ¯”å¦‚ï¼š

```shell
your_name="qinjx"
echo $your_name
echo ${your_name}
```

å˜é‡åå¤–é¢çš„èŠ±æ‹¬å·æ˜¯å¯é€‰çš„ï¼Œå¯åŠ å¯ä¸åŠ ï¼ŒåŠ èŠ±æ‹¬å·æ˜¯ä¸ºäº†å¸®åŠ©è§£é‡Šå™¨è¯†åˆ«å˜é‡çš„è¾¹ç•Œï¼Œæ¯”å¦‚å½“é‡åˆ°ä¸‹é¢çš„æƒ…å†µæ—¶ï¼š

```shell
for skill in Ada Coffe Action Java; do
    echo "I am good at ${skill}Script"
done
```

å¦‚æœä¸ç»™ skill å˜é‡åŠ ä¸ŠèŠ±æ‹¬å·ï¼Œå˜é‡å†™æˆ skillScriptï¼Œé‚£ä¹ˆè§£é‡Šå™¨å°±è¯†åˆ«ä¸å‡º skill äº†ï¼Œé‚£ä¹ˆä»£ç çš„æœ€ç»ˆç»“æœå°±è·Ÿæˆ‘çš„é¢„æœŸç›¸å·®ç”šè¿œã€‚

æ¨èç»™æ‰€æœ‰å˜é‡åŠ ä¸ŠèŠ±æ‹¬å·ï¼Œè¿™æ˜¯ shell ç¼–ç¨‹çš„å¥½ä¹ æƒ¯ã€‚

å¯¹äºå·²å®šä¹‰çš„å˜é‡ï¼Œå¯ä»¥è¢«é‡æ–°å®šä¹‰ï¼Œæ¯”å¦‚ï¼š

```shell
your_name="tom"
echo $your_name
your_name="alibaba"
echo $your_name
```

æ³¨æ„ç¬¬äºŒæ¬¡èµ‹å€¼çš„æ—¶å€™ä¸èƒ½å†™æˆï¼š

```shell
$your_name="alibaba"
```

åªæœ‰åœ¨ä½¿ç”¨å˜é‡çš„æ—¶å€™æ‰åŠ ç¾å…ƒç¬¦ $ã€‚

**åªè¯»å˜é‡**

ä½¿ç”¨ readonly å‘½ä»¤å¯ä»¥å°†å˜é‡å®šä¹‰ä¸ºåªè¯»å˜é‡ï¼Œåªè¯»å˜é‡çš„å€¼ä¸èƒ½è¢«æ”¹å˜ã€‚

ä¸‹é¢çš„ä¾‹å­å°è¯•æ›´æ”¹åªè¯»å˜é‡ï¼Œç»“æœæŠ¥é”™ï¼š

```shell
#!/bin/bash
myUrl="http://www.w3cschool.cc"
readonly myUrl
myUrl="http://www.runoob.com"
```

è¿è¡Œè„šæœ¬ï¼Œç»“æœå¦‚ä¸‹ï¼š

```shell
/bin/sh: NAME: This variable is read only.
```

**åˆ é™¤å˜é‡**

ä½¿ç”¨ unset å‘½ä»¤å¯ä»¥åˆ é™¤å˜é‡ã€‚è¯­æ³•ï¼š

```shell
unset variable_name
```

å˜é‡è¢«åˆ é™¤åä¸èƒ½å†æ¬¡ä½¿ç”¨ã€‚unset å‘½ä»¤ä¸èƒ½åˆ é™¤åªè¯»å˜é‡ã€‚

æ¡ˆä¾‹ï¼š

```shell
#!/bin/sh
myUrl="http://www.baodu.com"
unset myUrl
echo $myUrl
```

ä¸Šé¢çš„ç¨‹åºæ‰§è¡Œå°†æ²¡æœ‰ä»»ä½•è¾“å‡ºã€‚

**å˜é‡ç±»å‹**

è¿è¡Œ shell ç¨‹åºæ—¶ï¼Œä¼šåŒæ—¶å­˜åœ¨ä¸‰ç§å˜é‡ï¼š

1. å±€éƒ¨å˜é‡ï¼š å±€éƒ¨å˜é‡åœ¨è„šæœ¬æˆ–å‘½ä»¤ä¸­å®šä¹‰ï¼Œä»…åœ¨å½“å‰ shell å®ä¾‹ä¸­æœ‰æ•ˆï¼Œå…¶ä»– shell å¯åŠ¨çš„ç¨‹åºä¸èƒ½è®¿é—®å±€éƒ¨å˜é‡ã€‚
2. ç¯å¢ƒå˜é‡ï¼š æ‰€æœ‰çš„ç¨‹åºï¼ŒåŒ…æ‹¬ shell å¯åŠ¨çš„ç¨‹åºï¼Œéƒ½èƒ½è®¿é—®ç¯å¢ƒå˜é‡ï¼Œæœ‰äº›ç¨‹åºéœ€è¦ç¯å¢ƒå˜é‡æ¥ä¿è¯å…¶æ­£å¸¸è¿è¡Œã€‚å¿…è¦çš„æ—¶å€™ shell è„šæœ¬ä¹Ÿå¯ä»¥å®šä¹‰ç¯å¢ƒå˜é‡ã€‚
3. shell å˜é‡ï¼šshell å˜é‡æ˜¯ç”± shell ç¨‹åºè®¾ç½®çš„ç‰¹æ®Šå˜é‡ã€‚shell å˜é‡ä¸­æœ‰ä¸€éƒ¨åˆ†æ˜¯ç¯å¢ƒå˜é‡ï¼Œæœ‰ä¸€éƒ¨åˆ†æ˜¯å±€éƒ¨å˜é‡ï¼Œè¿™äº›å˜é‡ä¿è¯äº† shell çš„æ­£å¸¸è¿è¡Œ

## å­—ç¬¦ä¸²

å­—ç¬¦ä¸²æ˜¯ shell ç¼–ç¨‹ä¸­æœ€å¸¸ç”¨æœ€æœ‰ç”¨çš„æ•°æ®ç±»å‹ï¼ˆé™¤äº†æ•°å­—å’Œå­—ç¬¦ä¸²ï¼Œä¹Ÿæ²¡å•¥å…¶å®ƒç±»å‹å¥½ç”¨äº†ï¼‰ã€‚  
å­—ç¬¦ä¸²å¯ä»¥ç”¨å•å¼•å·ï¼Œä¹Ÿå¯ä»¥ç”¨åŒå¼•å·ï¼Œä¹Ÿå¯ä»¥ä¸ç”¨å¼•å·ã€‚å•åŒå¼•å·çš„åŒºåˆ«è·Ÿ PHP ç±»ä¼¼ã€‚

**å•å¼•å·**

```shell
str='this is a string'
```

å•å¼•å·å­—ç¬¦ä¸²çš„é™åˆ¶ï¼š

- å•å¼•å·é‡Œçš„ä»»ä½•å­—ç¬¦éƒ½ä¼šåŸæ ·è¾“å‡ºï¼Œå•å¼•å·å­—ç¬¦ä¸²ä¸­çš„å˜é‡æ˜¯æ— æ•ˆçš„ã€‚
- å•å¼•å·å­—ä¸²ä¸­ä¸èƒ½å‡ºç°å•å¼•å·ï¼ˆå¯¹å•å¼•å·ä½¿ç”¨è½¬ä¹‰ç¬¦åä¹Ÿä¸è¡Œï¼‰ã€‚

**åŒå¼•å·**

```shell
your_name='qinjx'
str="Hello, I know your are \"$your_name\"! \n"
```

åŒå¼•å·çš„ä¼˜ç‚¹ï¼š

- åŒå¼•å·é‡Œå¯ä»¥æœ‰å˜é‡ã€‚
- åŒå¼•å·é‡Œå¯ä»¥å‡ºç°è½¬ä¹‰å­—ç¬¦ã€‚

**æ‹¼æ¥å­—ç¬¦ä¸²**

```shell
your_name="qinjx"
greeting="hello, "$your_name" !"
greeting_1="hello, ${your_name} !"
echo $greeting $greeting_1
```

**è·å–å­—ç¬¦ä¸²é•¿åº¦**

```shell
string="abcd"
echo ${#string} #è¾“å‡º 4
```

**æå–å­å­—ç¬¦ä¸²**

ä»¥ä¸‹å®ä¾‹ä»å­—ç¬¦ä¸²ç¬¬ 2 ä¸ªå­—ç¬¦å¼€å§‹æˆªå– 4 ä¸ªå­—ç¬¦ï¼š

```shell
string="runoob is a great site"
echo ${string:1:4} # è¾“å‡º unoo
```

**æŸ¥æ‰¾å­å­—ç¬¦ä¸²**

æŸ¥æ‰¾å­—ç¬¦ "i æˆ– s" çš„ä½ç½®ï¼š

```shell
string="runoob is a great company"
echo `expr index "$string" is` # è¾“å‡º 8
```

æ³¨æ„ï¼š ä»¥ä¸Šè„šæœ¬ä¸­ "`" æ˜¯åå¼•å·ï¼Œè€Œä¸æ˜¯å•å¼•å· "'"ï¼Œåƒä¸‡ä¸è¦çœ‹é”™äº†ã€‚

## æ•°ç»„

Bash Shell åªæ”¯æŒä¸€ç»´æ•°ç»„ï¼ˆä¸æ”¯æŒå¤šç»´æ•°ç»„ï¼‰ï¼Œåˆå§‹åŒ–æ—¶ä¸éœ€è¦å®šä¹‰æ•°ç»„å¤§å°ï¼ˆä¸ PHP ç±»ä¼¼ï¼‰ã€‚  
è·å–æ•°ç»„ä¸­çš„å…ƒç´ è¦åˆ©ç”¨ä¸‹æ ‡ï¼Œä¸‹æ ‡å¯ä»¥æ˜¯æ•´æ•°æˆ–ç®—æœ¯è¡¨è¾¾å¼ï¼Œå…¶å€¼åº”å¤§äºæˆ–ç­‰äº 0ã€‚  
æ•°ç»„ä¸­å¯ä»¥å­˜æ”¾å¤šä¸ªå€¼ï¼Œä¸å¤§éƒ¨åˆ†ç¼–ç¨‹è¯­è¨€ç±»ä¼¼ï¼Œæ•°ç»„å…ƒç´ çš„ä¸‹æ ‡ç”± 0 å¼€å§‹ã€‚

**å®šä¹‰æ•°ç»„**

åœ¨ Shell ä¸­ï¼Œç”¨æ‹¬å·æ¥è¡¨ç¤ºæ•°ç»„ï¼Œæ•°ç»„å…ƒç´ ç”¨ "ç©ºæ ¼ "ç¬¦å·åˆ†å‰²å¼€ã€‚  
å®šä¹‰æ•°ç»„çš„ä¸€èˆ¬å½¢å¼ä¸ºï¼š

```shell
æ•°ç»„å=(å€¼1 å€¼2 ... å€¼n)
```

ä¾‹å¦‚ï¼š

```shell
array_name=(value0 value1 value2 value3)
```

æˆ–è€…

```shell
array_name=(
value0
value1
value2
value3
)
```

è¿˜å¯ä»¥å•ç‹¬å®šä¹‰æ•°ç»„çš„å„ä¸ªåˆ†é‡ï¼š

```shell
array_name[0]=value0
array_name[1]=value1
array_name[n]=valuen
```

å¯ä»¥ä¸ä½¿ç”¨è¿ç»­çš„ä¸‹æ ‡ï¼Œè€Œä¸”ä¸‹æ ‡çš„èŒƒå›´æ²¡æœ‰é™åˆ¶ã€‚

**è¯»å–æ•°ç»„**

è¯»å–æ•°ç»„å…ƒç´ å€¼çš„ä¸€èˆ¬æ ¼å¼æ˜¯ï¼š

```shell
${æ•°ç»„å[ä¸‹æ ‡]}
```

ä¾‹å¦‚ï¼š

```shell
valuen=${array_name[n]}
```

shell ç¼–ç¨‹å®æˆ˜ï¼š

```shell
#!/bin/bash
my_array=(A B "C" D)
echo "ç¬¬ä¸€ä¸ªå…ƒç´ ä¸º: ${my_array[0]}"
echo "ç¬¬äºŒä¸ªå…ƒç´ ä¸º: ${my_array[1]}"
echo "ç¬¬ä¸‰ä¸ªå…ƒç´ ä¸º: ${my_array[2]}"
echo "ç¬¬å››ä¸ªå…ƒç´ ä¸º: ${my_array[3]}"
```

æ‰§è¡Œè„šæœ¬ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
$ chmod +x test.sh
$ ./test.sh
ç¬¬ä¸€ä¸ªå…ƒç´ ä¸º: A
ç¬¬äºŒä¸ªå…ƒç´ ä¸º: B
ç¬¬ä¸‰ä¸ªå…ƒç´ ä¸º: C
ç¬¬å››ä¸ªå…ƒç´ ä¸º: D
```

ä½¿ç”¨ `@` æˆ–è€… `*` ç¬¦å·å¯ä»¥è·å–æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œä¾‹å¦‚ï¼š

```shell
echo ${array_name[@]}
```

shell ç¼–ç¨‹å®æˆ˜ï¼š

```shell
#!/bin/bash
my_array[0]=A
my_array[1]=B
my_array[2]=C
my_array[3]=D
echo "æ•°ç»„çš„å…ƒç´ ä¸º: ${my_array[*]}"
echo "æ•°ç»„çš„å…ƒç´ ä¸º: ${my_array[@]}"
```

æ‰§è¡Œè„šæœ¬ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
$ chmod +x test.sh
$ ./test.sh
æ•°ç»„çš„å…ƒç´ ä¸º: A B C D
æ•°ç»„çš„å…ƒç´ ä¸º: A B C D
```

**è·å–æ•°ç»„çš„é•¿åº¦**

è·å–æ•°ç»„é•¿åº¦çš„æ–¹æ³•ä¸è·å–å­—ç¬¦ä¸²é•¿åº¦çš„æ–¹æ³•ç›¸åŒï¼Œä¾‹å¦‚ï¼š

```shell
# å–å¾—æ•°ç»„å…ƒç´ çš„ä¸ªæ•°
length=${#array_name[@]}
# æˆ–è€…
length=${#array_name[*]}
# å–å¾—æ•°ç»„å•ä¸ªå…ƒç´ çš„é•¿åº¦
lengthn=${#array_name[n]}
```

shell å®æˆ˜ç¼–ç¨‹ï¼š

```shell
#!/bin/bash
my_array[0]=A
my_array[1]=B
my_array[2]=C
my_array[3]=D
echo "æ•°ç»„å…ƒç´ ä¸ªæ•°ä¸º: ${#my_array[*]}"
echo "æ•°ç»„å…ƒç´ ä¸ªæ•°ä¸º: ${#my_array[@]}"
```

æ‰§è¡Œè„šæœ¬ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
$ chmod +x test.sh
$ ./test.sh
æ•°ç»„å…ƒç´ ä¸ªæ•°ä¸º: 4
æ•°ç»„å…ƒç´ ä¸ªæ•°ä¸º: 4
```

## æ³¨é‡Š

ä»¥ "#"å¼€å¤´çš„è¡Œå°±æ˜¯æ³¨é‡Šï¼Œä¼šè¢«è§£é‡Šå™¨å¿½ç•¥ã€‚

sh é‡Œæ²¡æœ‰å¤šè¡Œæ³¨é‡Šï¼Œåªèƒ½æ¯ä¸€è¡ŒåŠ ä¸€ä¸ª#å·ã€‚åªèƒ½åƒè¿™æ ·ï¼š

```shell
#--------------------------------------------
# è¿™æ˜¯ä¸€ä¸ªæ³¨é‡Š
#--------------------------------------------
##### ç”¨æˆ·é…ç½®åŒº å¼€å§‹ #####
#
#
# è¿™é‡Œå¯ä»¥æ·»åŠ è„šæœ¬æè¿°ä¿¡æ¯
#
#
##### ç”¨æˆ·é…ç½®åŒº ç»“æŸ #####
```

å¦‚æœåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°å¤§æ®µçš„ä»£ç éœ€è¦ä¸´æ—¶æ³¨é‡Šèµ·æ¥ï¼Œè¿‡ä¸€ä¼šå„¿åˆå–æ¶ˆæ³¨é‡Šï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿ

æ¯ä¸€è¡ŒåŠ ä¸ª#ç¬¦å·å¤ªè´¹åŠ›äº†ï¼Œå¯ä»¥æŠŠè¿™ä¸€æ®µè¦æ³¨é‡Šçš„ä»£ç ç”¨ä¸€å¯¹èŠ±æ‹¬å·æ‹¬èµ·æ¥ï¼Œå®šä¹‰æˆä¸€ä¸ªå‡½æ•°ï¼Œæ²¡æœ‰åœ°æ–¹è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œè¿™å—ä»£ç å°±ä¸ä¼šæ‰§è¡Œï¼Œè¾¾åˆ°äº†å’Œæ³¨é‡Šä¸€æ ·çš„æ•ˆæœã€‚

## ä¼ é€’å‚æ•°

æˆ‘ä»¬å¯ä»¥åœ¨æ‰§è¡Œ Shell è„šæœ¬æ—¶ï¼Œå‘è„šæœ¬ä¼ é€’å‚æ•°ï¼Œè„šæœ¬å†…è·å–å‚æ•°çš„æ ¼å¼ä¸ºï¼š$nã€‚

```shell
n ä»£è¡¨ä¸€ä¸ªæ•°å­—ï¼Œ1 ä¸ºæ‰§è¡Œè„šæœ¬çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œ2 ä¸ºæ‰§è¡Œè„šæœ¬çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œä»¥æ­¤ç±»æ¨â€¦â€¦
```

**å®ä¾‹**

ä»¥ä¸‹å®ä¾‹æˆ‘ä»¬å‘è„šæœ¬ä¼ é€’ä¸‰ä¸ªå‚æ•°ï¼Œå¹¶åˆ†åˆ«è¾“å‡ºï¼Œå…¶ä¸­ $0 ä¸ºæ‰§è¡Œçš„æ–‡ä»¶åï¼š

```shell
#!/bin/bash
echo "Shell ä¼ é€’å‚æ•°å®ä¾‹ï¼";
echo "æ‰§è¡Œçš„æ–‡ä»¶åï¼š$0";
echo "ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºï¼š$1";
echo "ç¬¬äºŒä¸ªå‚æ•°ä¸ºï¼š$2";
echo "ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºï¼š$3";
```

ä¸ºè„šæœ¬è®¾ç½®å¯æ‰§è¡Œæƒé™ï¼Œå¹¶æ‰§è¡Œè„šæœ¬ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
$ chmod +x test.sh
$ ./test.sh 1 2 3
Shell ä¼ é€’å‚æ•°å®ä¾‹ï¼
æ‰§è¡Œçš„æ–‡ä»¶åï¼štest.sh
ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºï¼š1
ç¬¬äºŒä¸ªå‚æ•°ä¸ºï¼š2
ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºï¼š3
```

å¦å¤–ï¼Œè¿˜æœ‰å‡ ä¸ªç‰¹æ®Šå­—ç¬¦ç”¨æ¥å¤„ç†å‚æ•°ï¼š

```shell
å‚æ•°å¤„ç† è¯´æ˜
$# ä¼ é€’åˆ°è„šæœ¬çš„å‚æ•°ä¸ªæ•°
$* ä»¥ä¸€ä¸ªå•å­—ç¬¦ä¸²æ˜¾ç¤ºæ‰€æœ‰å‘è„šæœ¬ä¼ é€’çš„å‚æ•°ã€‚
å¦‚"$*"ç”¨ã€Œ"ã€æ‹¬èµ·æ¥çš„æƒ…å†µã€ä»¥"$1 $2 â€¦ $n"çš„å½¢å¼è¾“å‡ºæ‰€æœ‰å‚æ•°ã€‚
$ è„šæœ¬è¿è¡Œçš„å½“å‰è¿›ç¨‹IDå·
$! åå°è¿è¡Œçš„æœ€åä¸€ä¸ªè¿›ç¨‹çš„IDå·
$@ ä¸$*ç›¸åŒï¼Œä½†æ˜¯ä½¿ç”¨æ—¶åŠ å¼•å·ï¼Œå¹¶åœ¨å¼•å·ä¸­è¿”å›æ¯ä¸ªå‚æ•°ã€‚
å¦‚"$@"ç”¨ã€Œ"ã€æ‹¬èµ·æ¥çš„æƒ…å†µã€ä»¥"$1" "$2" â€¦ "$n" çš„å½¢å¼è¾“å‡ºæ‰€æœ‰å‚æ•°ã€‚
$- æ˜¾ç¤ºShellä½¿ç”¨çš„å½“å‰é€‰é¡¹ï¼Œä¸setå‘½ä»¤åŠŸèƒ½ç›¸åŒã€‚
$? æ˜¾ç¤ºæœ€åå‘½ä»¤çš„é€€å‡ºçŠ¶æ€ã€‚0è¡¨ç¤ºæ²¡æœ‰é”™è¯¯ï¼Œå…¶ä»–ä»»ä½•å€¼è¡¨æ˜æœ‰é”™è¯¯ã€‚
```

```shell
#!/bin/bash
echo "Shell ä¼ é€’å‚æ•°å®ä¾‹ï¼";
echo "ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºï¼š$1";
echo "å‚æ•°ä¸ªæ•°ä¸ºï¼š$#";
echo "ä¼ é€’çš„å‚æ•°ä½œä¸ºä¸€ä¸ªå­—ç¬¦ä¸²æ˜¾ç¤ºï¼š$*";
```

æ‰§è¡Œè„šæœ¬ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
$ chmod +x test.sh
$ ./test.sh 1 2 3
Shell ä¼ é€’å‚æ•°å®ä¾‹ï¼
ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºï¼š1
å‚æ•°ä¸ªæ•°ä¸ºï¼š3
ä¼ é€’çš„å‚æ•°ä½œä¸ºä¸€ä¸ªå­—ç¬¦ä¸²æ˜¾ç¤ºï¼š1 2 3
```

âˆ— ä¸@ åŒºåˆ«ï¼š

- ç›¸åŒç‚¹ï¼šéƒ½æ˜¯å¼•ç”¨æ‰€æœ‰å‚æ•°ã€‚
- ä¸åŒç‚¹ï¼šåªæœ‰åœ¨åŒå¼•å·ä¸­ä½“ç°å‡ºæ¥ã€‚

```shell
å‡è®¾åœ¨è„šæœ¬è¿è¡Œæ—¶å†™äº†ä¸‰ä¸ªå‚æ•° 1ã€2ã€3ï¼Œï¼Œåˆ™ " * " ç­‰ä»·äº "1 2 3"ï¼ˆä¼ é€’äº†ä¸€ä¸ªå‚æ•°ï¼‰ï¼Œè€Œ "@" ç­‰ä»·äº "1" "2" "3"ï¼ˆä¼ é€’äº†ä¸‰ä¸ªå‚æ•°ï¼‰ã€‚
```

```shell
#!/bin/bash
echo "-- \$* æ¼”ç¤º ---"
for i in "$*"; do
    echo $i
done
echo "-- \$@ æ¼”ç¤º ---"
for i in "$@"; do
    echo $i
done
```

æ‰§è¡Œè„šæœ¬ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
$ chmod +x test.sh
$ ./test.sh 1 2 3
-- $* æ¼”ç¤º ---
1 2 3
-- $@ æ¼”ç¤º ---
1
2
3
```

## åŸºæœ¬è¿ç®—ç¬¦

Shell å’Œå…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸€æ ·ï¼Œæ”¯æŒå¤šç§è¿ç®—ç¬¦ï¼ŒåŒ…æ‹¬ï¼š

- ç®—æ•°è¿ç®—ç¬¦
- å…³ç³»è¿ç®—ç¬¦
- å¸ƒå°”è¿ç®—ç¬¦
- å­—ç¬¦ä¸²è¿ç®—ç¬¦
- æ–‡ä»¶æµ‹è¯•è¿ç®—ç¬¦

åŸç”Ÿ bash ä¸æ”¯æŒç®€å•çš„æ•°å­¦è¿ç®—ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å…¶ä»–å‘½ä»¤æ¥å®ç°ï¼Œä¾‹å¦‚ awk å’Œ exprï¼Œexpr æœ€å¸¸ç”¨ã€‚

expr æ˜¯ä¸€æ¬¾è¡¨è¾¾å¼è®¡ç®—å·¥å…·ï¼Œä½¿ç”¨å®ƒèƒ½å®Œæˆè¡¨è¾¾å¼çš„æ±‚å€¼æ“ä½œã€‚

ä¾‹å¦‚ï¼Œä¸¤ä¸ªæ•°ç›¸åŠ  (ç‰¹åˆ«æ³¨æ„ï¼šä½¿ç”¨çš„æ˜¯åå¼•å· ` è€Œä¸æ˜¯å•å¼•å· ')ï¼š

```shell
#!/bin/bash
val=`expr 2 + 2`
echo "ä¸¤æ•°ä¹‹å’Œä¸º : $val"
```

æ‰§è¡Œè„šæœ¬ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
ä¸¤æ•°ä¹‹å’Œä¸º : 4
```

ä¸¤ç‚¹æ³¨æ„ï¼š

- è¡¨è¾¾å¼å’Œè¿ç®—ç¬¦ä¹‹é—´è¦æœ‰ç©ºæ ¼ï¼Œä¾‹å¦‚ 2+2 æ˜¯ä¸å¯¹çš„ï¼Œå¿…é¡»å†™æˆ 2 + 2ï¼Œè¿™ä¸æˆ‘ä»¬ç†Ÿæ‚‰çš„å¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€ä¸ä¸€æ ·ã€‚
- å®Œæ•´çš„è¡¨è¾¾å¼è¦è¢« åŒ…å«ï¼Œæ³¨æ„è¿™ä¸ªå­—ç¬¦ä¸æ˜¯å¸¸ç”¨çš„å•å¼•å·ï¼Œåœ¨ Esc é”®ä¸‹è¾¹ã€‚

**ç®—æœ¯è¿ç®—ç¬¦**

ä¸‹é¢åˆ—å‡ºäº†å¸¸ç”¨çš„ç®—æœ¯è¿ç®—ç¬¦ï¼Œå‡å®šå˜é‡ a ä¸º 10ï¼Œå˜é‡ b ä¸º 20ï¼š

```shell
è¿ç®—ç¬¦ è¯´æ˜ ä¸¾ä¾‹
+ åŠ æ³• `expr $a + $b` ç»“æœä¸º 30ã€‚
+ å‡æ³• `expr $a - $b` ç»“æœä¸º 10ã€‚
+ ä¹˜æ³• `expr $a \* $b` ç»“æœä¸º 200ã€‚
/ é™¤æ³• `expr $b / $a` ç»“æœä¸º 2ã€‚
% å–ä½™ `expr $b % $a` ç»“æœä¸º 0ã€‚
= èµ‹å€¼ a=$b å°†æŠŠå˜é‡ b çš„å€¼èµ‹ç»™ aã€‚
== ç›¸ç­‰ã€‚ç”¨äºæ¯”è¾ƒä¸¤ä¸ªæ•°å­—ï¼Œç›¸åŒåˆ™è¿”å› trueã€‚ [ $a == $b ] è¿”å› falseã€‚
!= ä¸ç›¸ç­‰ã€‚ç”¨äºæ¯”è¾ƒä¸¤ä¸ªæ•°å­—ï¼Œä¸ç›¸åŒåˆ™è¿”å› trueã€‚ [ $a != $b ] è¿”å› trueã€‚
```

- æ³¨æ„ï¼šæ¡ä»¶è¡¨è¾¾å¼è¦æ”¾åœ¨æ–¹æ‹¬å·ä¹‹é—´ï¼Œå¹¶ä¸”è¦æœ‰ç©ºæ ¼ï¼Œä¾‹å¦‚: [a==b] æ˜¯é”™è¯¯çš„ï¼Œå¿…é¡»å†™æˆ [ a==b ]ã€‚

**ç¤ºä¾‹**

ç®—æœ¯è¿ç®—ç¬¦å®ä¾‹å¦‚ä¸‹ï¼š

```shell
#!/bin/bash
a=10
b=20
val=`expr $a + $b`
echo "a + b : $val"

val=`expr $a - $b`
echo "a - b : $val"

val=`expr $a \* $b`
echo "a * b : $val"

val=`expr $b / $a`
echo "b / a : $val"

val=`expr $b % $a`
echo "b % a : $val"

if [ $a == $b ]
then
    echo "a ç­‰äº b"
fi
if [ $a != $b ]
then
    echo "a ä¸ç­‰äº b"
fi
```

æ‰§è¡Œè„šæœ¬ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
a + b : 30
a - b : -10
a * b : 200
b / a : 2
b % a : 0
a ä¸ç­‰äº b
```

æ³¨æ„ï¼š

- ä¹˜å· (`*`) å‰è¾¹å¿…é¡»åŠ åæ–œæ  (`\`) æ‰èƒ½å®ç°ä¹˜æ³•è¿ç®—ã€‚
- ifâ€¦thenâ€¦fi æ˜¯æ¡ä»¶è¯­å¥ï¼Œåç»­ä¼šæœ‰è¯´æ˜ã€‚

**å…³ç³»è¿ç®—ç¬¦**

å…³ç³»è¿ç®—ç¬¦åªæ”¯æŒæ•°å­—ï¼Œä¸æ”¯æŒå­—ç¬¦ä¸²ï¼Œé™¤éå­—ç¬¦ä¸²çš„å€¼æ˜¯æ•°å­—ã€‚

ä¸‹é¢åˆ—å‡ºäº†å¸¸ç”¨çš„å…³ç³»è¿ç®—ç¬¦ï¼Œå‡å®šå˜é‡ a ä¸º 10ï¼Œå˜é‡ b ä¸º 20ï¼š

```shell
è¿ç®—ç¬¦ è¯´æ˜ ä¸¾ä¾‹
-eq æ£€æµ‹ä¸¤ä¸ªæ•°æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰è¿”å› trueã€‚ [ $a -eq $b ] è¿”å› falseã€‚
-ne æ£€æµ‹ä¸¤ä¸ªæ•°æ˜¯å¦ç›¸ç­‰ï¼Œä¸ç›¸ç­‰è¿”å› trueã€‚ [ $a -ne $b ] è¿”å› trueã€‚
-gt æ£€æµ‹å·¦è¾¹çš„æ•°æ˜¯å¦å¤§äºå³è¾¹çš„ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ $a -gt $b ] è¿”å› falseã€‚
-lt æ£€æµ‹å·¦è¾¹çš„æ•°æ˜¯å¦å°äºå³è¾¹çš„ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ $a -lt $b ] è¿”å› trueã€‚
-ge æ£€æµ‹å·¦è¾¹çš„æ•°æ˜¯å¦å¤§ç­‰äºå³è¾¹çš„ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ $a -ge $b ] è¿”å› falseã€‚
-le æ£€æµ‹å·¦è¾¹çš„æ•°æ˜¯å¦å°äºç­‰äºå³è¾¹çš„ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ $a -le $b ] è¿”å› trueã€‚
```

**å®ä¾‹**

å…³ç³»è¿ç®—ç¬¦å®ä¾‹å¦‚ä¸‹ï¼š

```shell
#!/bin/bash
a=10
b=20
if [ $a -eq $b ]
then
    echo "$a -eq $b : a ç­‰äº b"
else
    echo "$a -eq $b: a ä¸ç­‰äº b"
fi

if [ $a -ne $b ]
then
    echo "$a -ne $b: a ä¸ç­‰äº b"
else
    echo "$a -ne $b : a ç­‰äº b"
fi

if [ $a -gt $b ]
then
    echo "$a -gt $b: a å¤§äº b"
else
    echo "$a -gt $b: a ä¸å¤§äº b"
fi

if [ $a -lt $b ]
then
    echo "$a -lt $b: a å°äº b"
else
    echo "$a -lt $b: a ä¸å°äº b"
fi

if [ $a -ge $b ]
then
    echo "$a -ge $b: a å¤§äºæˆ–ç­‰äº b"
else
    echo "$a -ge $b: a å°äº b"
fi

if [ $a -le $b ]
then
    echo "$a -le $b: a å°äºæˆ–ç­‰äº b"
else
    echo "$a -le $b: a å¤§äº b"
fi

```

æ‰§è¡Œè„šæœ¬ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
10 -eq 20: a ä¸ç­‰äº b
10 -ne 20: a ä¸ç­‰äº b
10 -gt 20: a ä¸å¤§äº b
10 -lt 20: a å°äº b
10 -ge 20: a å°äº b
10 -le 20: a å°äºæˆ–ç­‰äº b
```

**å¸ƒå°”è¿ç®—ç¬¦**

ä¸‹é¢åˆ—å‡ºäº†å¸¸ç”¨çš„å¸ƒå°”è¿ç®—ç¬¦ï¼Œå‡å®šå˜é‡ a ä¸º 10ï¼Œå˜é‡ b ä¸º 20ï¼š

```shell
è¿ç®—ç¬¦ è¯´æ˜ ä¸¾ä¾‹
! éè¿ç®—ï¼Œè¡¨è¾¾å¼ä¸º true åˆ™è¿”å› falseï¼Œå¦åˆ™è¿”å› trueã€‚ [ ! false ] è¿”å› trueã€‚
-o æˆ–è¿ç®—ï¼Œæœ‰ä¸€ä¸ªè¡¨è¾¾å¼ä¸º true åˆ™è¿”å› trueã€‚ [ $a -lt 20 -o $b -gt 100 ] è¿”å› trueã€‚
-a ä¸è¿ç®—ï¼Œä¸¤ä¸ªè¡¨è¾¾å¼éƒ½ä¸º true æ‰è¿”å› trueã€‚ [ $a -lt 20 -a $b -gt 100 ] è¿”å› falseã€‚
```

**å®ä¾‹**

å¸ƒå°”è¿ç®—ç¬¦å®ä¾‹å¦‚ä¸‹ï¼š

```shell
#!/bin/bash
a=10
b=20

if [ $a != $b ]
then
    echo "$a != $b : a ä¸ç­‰äº b"
else
    echo "$a != $b: a ç­‰äº b"
fi

if [ $a -lt 100 -a $b -gt 15 ]
then
    echo "$a -lt 100 -a $b -gt 15 : è¿”å› true"
else
    echo "$a -lt 100 -a $b -gt 15 : è¿”å› false"
fi

if [ $a -lt 100 -o $b -gt 100 ]
then
    echo "$a -lt 100 -o $b -gt 100 : è¿”å› true"
else
    echo "$a -lt 100 -o $b -gt 100 : è¿”å› false"
fi

if [ $a -lt 5 -o $b -gt 100 ]
then
    echo "$a -lt 100 -o $b -gt 100 : è¿”å› true"
else
    echo "$a -lt 100 -o $b -gt 100 : è¿”å› false"
fi
```

æ‰§è¡Œè„šæœ¬ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
10 != 20 : a ä¸ç­‰äº b
10 -lt 100 -a 20 -gt 15 : è¿”å› true
10 -lt 100 -o 20 -gt 100 : è¿”å› true
10 -lt 100 -o 20 -gt 100 : è¿”å› false
```

**é€»è¾‘è¿ç®—ç¬¦**

ä»¥ä¸‹ä»‹ç» Shell çš„é€»è¾‘è¿ç®—ç¬¦ï¼Œå‡å®šå˜é‡ a ä¸º 10ï¼Œå˜é‡ b ä¸º 20:

```shell
è¿ç®—ç¬¦ è¯´æ˜ ä¸¾ä¾‹
&& é€»è¾‘çš„ AND [[ $a -lt 100 && $b -gt 100 ]] è¿”å› false
|| é€»è¾‘çš„ OR [[ $a -lt 100 || $b -gt 100 ]] è¿”å› true
```

**å®ä¾‹**

é€»è¾‘è¿ç®—ç¬¦å®ä¾‹å¦‚ä¸‹ï¼š

```shell
#!/bin/bash
a=10
b=20

if [[ $a -lt 100 && $b -gt 100 ]]
then
    echo "è¿”å› true"
else
    echo "è¿”å› false"
fi

if [[ $a -lt 100 || $b -gt 100 ]]
then
    echo "è¿”å› true"
else
    echo "è¿”å› false"
fi
```

æ‰§è¡Œè„šæœ¬ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
è¿”å› false
è¿”å› true
```

**å­—ç¬¦ä¸²è¿ç®—ç¬¦**

ä¸‹é¢åˆ—å‡ºäº†å¸¸ç”¨çš„å­—ç¬¦ä¸²è¿ç®—ç¬¦ï¼Œå‡å®šå˜é‡ a ä¸º "abc"ï¼Œå˜é‡ b ä¸º "efg"ï¼š

```shell
è¿ç®—ç¬¦ è¯´æ˜ ä¸¾ä¾‹
= æ£€æµ‹ä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰è¿”å› trueã€‚ [ $a = $b ] è¿”å› falseã€‚
!= æ£€æµ‹ä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ç›¸ç­‰ï¼Œä¸ç›¸ç­‰è¿”å› trueã€‚ [ $a != $b ] è¿”å› trueã€‚
-z æ£€æµ‹å­—ç¬¦ä¸²é•¿åº¦æ˜¯å¦ä¸º0ï¼Œä¸º0è¿”å› trueã€‚ [ -z $a ] è¿”å› falseã€‚
-n æ£€æµ‹å­—ç¬¦ä¸²é•¿åº¦æ˜¯å¦ä¸º0ï¼Œä¸ä¸º0è¿”å› trueã€‚ [ -n $a ] è¿”å› trueã€‚
str æ£€æµ‹å­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºè¿”å› trueã€‚ [ $a ] è¿”å› trueã€‚
```

**å®ä¾‹**

```shell
#!/bin/bash
a="abc"
b="efg"

if [ $a = $b ]
then
    echo "$a = $b : a ç­‰äº b"
else
    echo "$a = $b: a ä¸ç­‰äº b"
fi

if [ $a != $b ]
then
    echo "$a != $b : a ä¸ç­‰äº b"
else
    echo "$a != $b: a ç­‰äº b"
fi

if [ -z $a ]
then
    echo "-z $a : å­—ç¬¦ä¸²é•¿åº¦ä¸º 0"
else
    echo "-z $a : å­—ç¬¦ä¸²é•¿åº¦ä¸ä¸º 0"
fi

if [ -n $a ]
then
    echo "-n $a : å­—ç¬¦ä¸²é•¿åº¦ä¸ä¸º 0"
else
    echo "-n $a : å­—ç¬¦ä¸²é•¿åº¦ä¸º 0"
fi

if [ $a ]
then
    echo "$a : å­—ç¬¦ä¸²ä¸ä¸ºç©º"
else
    echo "$a : å­—ç¬¦ä¸²ä¸ºç©º"
fi
```

æ‰§è¡Œè„šæœ¬ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
abc = efg: a ä¸ç­‰äº b
abc != efg : a ä¸ç­‰äº b
-z abc : å­—ç¬¦ä¸²é•¿åº¦ä¸ä¸º 0
-n abc : å­—ç¬¦ä¸²é•¿åº¦ä¸ä¸º 0
abc : å­—ç¬¦ä¸²ä¸ä¸ºç©º
```

**æ–‡ä»¶æµ‹è¯•è¿ç®—ç¬¦**

æ–‡ä»¶æµ‹è¯•è¿ç®—ç¬¦ç”¨äºæ£€æµ‹ Unix æ–‡ä»¶çš„å„ç§å±æ€§ã€‚

å±æ€§æ£€æµ‹æè¿°å¦‚ä¸‹ï¼š

```shell
æ“ä½œç¬¦ è¯´æ˜ ä¸¾ä¾‹
-b file æ£€æµ‹æ–‡ä»¶æ˜¯å¦æ˜¯å—è®¾å¤‡æ–‡ä»¶ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -b $file ] è¿”å› falseã€‚
-c file æ£€æµ‹æ–‡ä»¶æ˜¯å¦æ˜¯å­—ç¬¦è®¾å¤‡æ–‡ä»¶ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -c $file ] è¿”å› falseã€‚
-d file æ£€æµ‹æ–‡ä»¶æ˜¯å¦æ˜¯ç›®å½•ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -d $file ] è¿”å› falseã€‚
-f file æ£€æµ‹æ–‡ä»¶æ˜¯å¦æ˜¯æ™®é€šæ–‡ä»¶ï¼ˆæ—¢ä¸æ˜¯ç›®å½•ï¼Œä¹Ÿä¸æ˜¯è®¾å¤‡æ–‡ä»¶ï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -f $file ] è¿”å› trueã€‚
-g file æ£€æµ‹æ–‡ä»¶æ˜¯å¦è®¾ç½®äº† SGID ä½ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -g $file ] è¿”å› falseã€‚
-k file æ£€æµ‹æ–‡ä»¶æ˜¯å¦è®¾ç½®äº†ç²˜ç€ä½(Sticky Bit)ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -k $file ] è¿”å› falseã€‚
-p file æ£€æµ‹æ–‡ä»¶æ˜¯å¦æ˜¯å…·åç®¡é“ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -p $file ] è¿”å› falseã€‚
-u file æ£€æµ‹æ–‡ä»¶æ˜¯å¦è®¾ç½®äº† SUID ä½ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -u $file ] è¿”å› falseã€‚
-r file æ£€æµ‹æ–‡ä»¶æ˜¯å¦å¯è¯»ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -r $file ] è¿”å› trueã€‚
-w file æ£€æµ‹æ–‡ä»¶æ˜¯å¦å¯å†™ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -w $file ] è¿”å› trueã€‚
-x file æ£€æµ‹æ–‡ä»¶æ˜¯å¦å¯æ‰§è¡Œï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -x $file ] è¿”å› trueã€‚
-s file æ£€æµ‹æ–‡ä»¶æ˜¯å¦ä¸ºç©ºï¼ˆæ–‡ä»¶å¤§å°æ˜¯å¦å¤§äº0ï¼‰ï¼Œä¸ä¸ºç©ºè¿”å› trueã€‚ [ -s $file ] è¿”å› trueã€‚
-e file æ£€æµ‹æ–‡ä»¶ï¼ˆåŒ…æ‹¬ç›®å½•ï¼‰æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› trueã€‚ [ -e $file ] è¿”å› trueã€‚
```

**å®ä¾‹**

å˜é‡ file è¡¨ç¤ºæ–‡ä»¶ "/var/www/runoob/test.sh"ï¼Œå®ƒçš„å¤§å°ä¸º 100 å­—èŠ‚ï¼Œå…·æœ‰ rwx æƒé™ã€‚ä¸‹é¢çš„ä»£ç ï¼Œå°†æ£€æµ‹è¯¥æ–‡ä»¶çš„å„ç§å±æ€§ï¼š

```shell
#!/bin/bash
file="/var/www/runoob/test.sh"

if [ -r $file ]
then
    echo "æ–‡ä»¶å¯è¯»"
else
    echo "æ–‡ä»¶ä¸å¯è¯»"
fi

if [ -w $file ]
then
    echo "æ–‡ä»¶å¯å†™"
else
    echo "æ–‡ä»¶ä¸å¯å†™"
fi

if [ -x $file ]
then
    echo "æ–‡ä»¶å¯æ‰§è¡Œ"
else
    echo "æ–‡ä»¶ä¸å¯æ‰§è¡Œ"
fi

if [ -f $file ]
then
    echo "æ–‡ä»¶ä¸ºæ™®é€šæ–‡ä»¶"
else
    echo "æ–‡ä»¶ä¸ºç‰¹æ®Šæ–‡ä»¶"
fi

if [ -d $file ]
then
    echo "æ–‡ä»¶æ˜¯ä¸ªç›®å½•"
else
    echo "æ–‡ä»¶ä¸æ˜¯ä¸ªç›®å½•"
fi

if [ -s $file ]
then
    echo "æ–‡ä»¶ä¸ä¸ºç©º"
else
    echo "æ–‡ä»¶ä¸ºç©º"
fi

if [ -e $file ]
then
    echo "æ–‡ä»¶å­˜åœ¨"
else
    echo "æ–‡ä»¶ä¸å­˜åœ¨"
fi
```

æ‰§è¡Œè„šæœ¬ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
æ–‡ä»¶å¯è¯»
æ–‡ä»¶å¯å†™
æ–‡ä»¶å¯æ‰§è¡Œ
æ–‡ä»¶ä¸ºæ™®é€šæ–‡ä»¶
æ–‡ä»¶ä¸æ˜¯ä¸ªç›®å½•
æ–‡ä»¶ä¸ä¸ºç©º
æ–‡ä»¶å­˜åœ¨
```

## echo å‘½ä»¤

Shell çš„ echo æŒ‡ä»¤ä¸ PHP çš„ echo æŒ‡ä»¤ç±»ä¼¼ï¼Œéƒ½æ˜¯ç”¨äºå­—ç¬¦ä¸²çš„è¾“å‡ºã€‚

å‘½ä»¤æ ¼å¼ï¼š

```shell
echo string
```

æ‚¨å¯ä»¥ä½¿ç”¨ echo å®ç°æ›´å¤æ‚çš„è¾“å‡ºæ ¼å¼æ§åˆ¶ã€‚

**1.æ˜¾ç¤ºæ™®é€šå­—ç¬¦ä¸²:**

```shell
echo "It is a test"
```

è¿™é‡Œçš„åŒå¼•å·å®Œå…¨å¯ä»¥çœç•¥ï¼Œä»¥ä¸‹å‘½ä»¤ä¸ä¸Šé¢å®ä¾‹æ•ˆæœä¸€è‡´ï¼š

```shell
echo It is a test
```

**2.æ˜¾ç¤ºè½¬ä¹‰å­—ç¬¦**

```shell
echo "\"It is a test\""
```

ç»“æœå°†æ˜¯:

```shell
"It is a test"
```

åŒæ ·ï¼ŒåŒå¼•å·ä¹Ÿå¯ä»¥çœç•¥

**3.æ˜¾ç¤ºå˜é‡**

read å‘½ä»¤ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–ä¸€è¡Œ,å¹¶æŠŠè¾“å…¥è¡Œçš„æ¯ä¸ªå­—æ®µçš„å€¼æŒ‡å®šç»™ shell å˜é‡:

```shell
#!/bin/sh
read name
echo "$name It is a test"
```

ä»¥ä¸Šä»£ç ä¿å­˜ä¸º test.shï¼Œname æ¥æ”¶æ ‡å‡†è¾“å…¥çš„å˜é‡ï¼Œç»“æœå°†æ˜¯:

```shell
[root@www ~]# sh test.sh
OK #æ ‡å‡†è¾“å…¥
OK It is a test #è¾“å‡º
```

**4.æ˜¾ç¤ºæ¢è¡Œ**

```shell
echo -e "OK! \n" # -e å¼€å¯è½¬ä¹‰
echo "It it a test"
```

è¾“å‡ºç»“æœï¼š

```shell
OK!
It it a test
```

**5.æ˜¾ç¤ºä¸æ¢è¡Œ**

```shell
#!/bin/sh
echo -e "OK! \c" # -e å¼€å¯è½¬ä¹‰ \c ä¸æ¢è¡Œ
echo "It is a test"
```

è¾“å‡ºç»“æœï¼š

```shell
OK! It is a test
```

**6.æ˜¾ç¤ºç»“æœå®šå‘è‡³æ–‡ä»¶**

```shell
echo "It is a test" > myfile
```

**7.åŸæ ·è¾“å‡ºå­—ç¬¦ä¸²ï¼Œä¸è¿›è¡Œè½¬ä¹‰æˆ–å–å˜é‡ (ç”¨å•å¼•å·)**

```shell
echo '$name\"'
```

è¾“å‡ºç»“æœï¼š

```shell
$name\"
```

**8.æ˜¾ç¤ºå‘½ä»¤æ‰§è¡Œç»“æœ**

```shell
echo `date`
```

ç»“æœå°†æ˜¾ç¤ºå½“å‰æ—¥æœŸ

```shell
Thu Jul 24 10:08:46 CST 2014
```

## printf å‘½ä»¤

printf å‘½ä»¤æ¨¡ä»¿ C ç¨‹åºåº“ï¼ˆlibraryï¼‰é‡Œçš„ printf() ç¨‹åºã€‚  
æ ‡å‡†æ‰€å®šä¹‰ï¼Œå› æ­¤ä½¿ç”¨ printf çš„è„šæœ¬æ¯”ä½¿ç”¨ echo ç§»æ¤æ€§å¥½ã€‚  
printf ä½¿ç”¨å¼•ç”¨æ–‡æœ¬æˆ–ç©ºæ ¼åˆ†éš”çš„å‚æ•°ï¼Œå¤–é¢å¯ä»¥åœ¨ printf ä¸­ä½¿ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œè¿˜å¯ä»¥åˆ¶å®šå­—ç¬¦ä¸²çš„å®½åº¦ã€å·¦å³å¯¹é½æ–¹å¼ç­‰ã€‚  
é»˜è®¤ printf ä¸ä¼šåƒ echo è‡ªåŠ¨æ·»åŠ æ¢è¡Œç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æ·»åŠ  nã€‚  
printf å‘½ä»¤çš„è¯­æ³•ï¼š

```shell
printf format-string [arguments...]
```

å‚æ•°è¯´æ˜ï¼š

- format-string: ä¸ºæ ¼å¼æ§åˆ¶å­—ç¬¦ä¸²
- arguments: ä¸ºå‚æ•°åˆ—è¡¨ã€‚

**å®ä¾‹ 1**

```shell
$ echo "Hello, Shell"
Hello, Shell
$ printf "Hello, Shell\n"
Hello, Shell
$
```

æ¥ä¸‹æ¥,æˆ‘æ¥ç”¨ä¸€ä¸ªè„šæœ¬æ¥ä½“ç° printf çš„å¼ºå¤§åŠŸèƒ½ï¼š

```shell
#!/bin/bash
printf "%-10s %-8s %-4s\n" å§“å æ€§åˆ« ä½“é‡kg
printf "%-10s %-8s %-4.2f\n" éƒ­é– ç”· 66.1234
printf "%-10s %-8s %-4.2f\n" æ¨è¿‡ ç”· 48.6543
printf "%-10s %-8s %-4.2f\n" éƒ­èŠ™ å¥³ 47.9876
```

æ‰§è¡Œè„šæœ¬ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
å§“å æ€§åˆ« ä½“é‡kg
éƒ­é– ç”· 66.12
æ¨è¿‡ ç”· 48.65
éƒ­èŠ™ å¥³ 47.99
```

```shell
%s %c %d %féƒ½æ˜¯æ ¼å¼æ›¿ä»£ç¬¦ã€‚
%-10s æŒ‡ä¸€ä¸ªå®½åº¦ä¸º10ä¸ªå­—ç¬¦ï¼ˆ-è¡¨ç¤ºå·¦å¯¹é½ï¼Œæ²¡æœ‰åˆ™è¡¨ç¤ºå³å¯¹é½ï¼‰ï¼Œä»»ä½•å­—ç¬¦éƒ½ä¼šè¢«æ˜¾ç¤ºåœ¨10ä¸ªå­—ç¬¦å®½çš„å­—ç¬¦å†…ï¼Œå¦‚æœä¸è¶³åˆ™è‡ªåŠ¨ä»¥ç©ºæ ¼å¡«å……ï¼Œè¶…è¿‡ä¹Ÿä¼šå°†å†…å®¹å…¨éƒ¨æ˜¾ç¤ºå‡ºæ¥ã€‚
%-4.2f æŒ‡æ ¼å¼åŒ–ä¸ºå°æ•°ï¼Œå…¶ä¸­.2æŒ‡ä¿ç•™2ä½å°æ•°ã€‚
```

**å®ä¾‹ 2**

```shell
#!/bin/bash
# format-stringä¸ºåŒå¼•å·
printf "%d %s\n" 1 "abc"

# å•å¼•å·ä¸åŒå¼•å·æ•ˆæœä¸€æ ·
printf '%d %s\n' 1 "abc"

# æ²¡æœ‰å¼•å·ä¹Ÿå¯ä»¥è¾“å‡º
printf %s abcdef

# æ ¼å¼åªæŒ‡å®šäº†ä¸€ä¸ªå‚æ•°ï¼Œä½†å¤šå‡ºçš„å‚æ•°ä»ç„¶ä¼šæŒ‰ç…§è¯¥æ ¼å¼è¾“å‡ºï¼Œformat-string è¢«é‡ç”¨
printf %s abc def

printf "%s\n" abc def
printf "%s %s %s\n" a b c d e f g h i j

# å¦‚æœæ²¡æœ‰ argumentsï¼Œé‚£ä¹ˆ %s ç”¨NULLä»£æ›¿ï¼Œ%d ç”¨ 0 ä»£æ›¿
printf "%s and %d \n"
```

æ‰§è¡Œè„šæœ¬ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
1 abc
1 abc
abcdefabcdefabc
def
a b c
d e f
g h i
j
and 0
```

**printf çš„è½¬ä¹‰åºåˆ—**

```shell
åºåˆ— è¯´æ˜
\a è­¦å‘Šå­—ç¬¦ï¼Œé€šå¸¸ä¸ºASCIIçš„BELå­—ç¬¦
\b åé€€
\c æŠ‘åˆ¶ï¼ˆä¸æ˜¾ç¤ºï¼‰è¾“å‡ºç»“æœä¸­ä»»ä½•ç»“å°¾çš„æ¢è¡Œå­—ç¬¦ï¼ˆåªåœ¨%bæ ¼å¼æŒ‡ç¤ºç¬¦æ§åˆ¶ä¸‹çš„å‚æ•°å­—ç¬¦ä¸²ä¸­æœ‰æ•ˆï¼‰ï¼Œè€Œä¸”ï¼Œä»»ä½•ç•™åœ¨å‚æ•°é‡Œçš„å­—ç¬¦ã€ä»»ä½•æ¥ä¸‹æ¥çš„å‚æ•°ä»¥åŠä»»ä½•ç•™åœ¨æ ¼å¼å­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦ï¼Œéƒ½è¢«å¿½ç•¥
\f æ¢é¡µï¼ˆformfeedï¼‰
\n æ¢è¡Œ
\r å›è½¦ï¼ˆCarriage returnï¼‰
\t æ°´å¹³åˆ¶è¡¨ç¬¦
\v å‚ç›´åˆ¶è¡¨ç¬¦
\\ ä¸€ä¸ªå­—é¢ä¸Šçš„åæ–œæ å­—ç¬¦
\ddd è¡¨ç¤º1åˆ°3ä½æ•°å…«è¿›åˆ¶å€¼çš„å­—ç¬¦ã€‚ä»…åœ¨æ ¼å¼å­—ç¬¦ä¸²ä¸­æœ‰æ•ˆ
\0ddd è¡¨ç¤º1åˆ°3ä½çš„å…«è¿›åˆ¶å€¼å­—ç¬¦
```

**å®ä¾‹**

```shell
$ printf "a string, no processing:<%s>\n" "A\nB"
a string, no processing:<A\nB>
$ printf "a string, no processing:<%b>\n" "A\nB"
a string, no processing:<A
B>
$ printf "www.runoob.com \a"
www.runoob.com $ #ä¸æ¢è¡Œ
```

## test å‘½ä»¤

Shell ä¸­çš„ test å‘½ä»¤ç”¨äºæ£€æŸ¥æŸä¸ªæ¡ä»¶æ˜¯å¦æˆç«‹ï¼Œå®ƒå¯ä»¥è¿›è¡Œæ•°å€¼ã€å­—ç¬¦å’Œæ–‡ä»¶ä¸‰ä¸ªæ–¹é¢çš„æµ‹è¯•ã€‚

**æ•°å€¼æµ‹è¯•**

```shell
å‚æ•° è¯´æ˜
-eq ç­‰äºåˆ™ä¸ºçœŸ
-ne ä¸ç­‰äºåˆ™ä¸ºçœŸ
-gt å¤§äºåˆ™ä¸ºçœŸ
-ge å¤§äºç­‰äºåˆ™ä¸ºçœŸ
-lt å°äºåˆ™ä¸ºçœŸ
-le å°äºç­‰äºåˆ™ä¸ºçœŸ
```

**å®ä¾‹**

```shell
num1=100
num2=100

if test $[num1] -eq $[num2]
then
    echo 'ä¸¤ä¸ªæ•°ç›¸ç­‰ï¼'
else
    echo 'ä¸¤ä¸ªæ•°ä¸ç›¸ç­‰ï¼'
fi
```

è¾“å‡ºç»“æœï¼š

```shell
ä¸¤ä¸ªæ•°ç›¸ç­‰ï¼
```

**å­—ç¬¦ä¸²æµ‹è¯•**

```shell
å‚æ•° è¯´æ˜
= ç­‰äºåˆ™ä¸ºçœŸ
!= ä¸ç›¸ç­‰åˆ™ä¸ºçœŸ
-z å­—ç¬¦ä¸² å­—ç¬¦ä¸²çš„é•¿åº¦ä¸ºé›¶åˆ™ä¸ºçœŸ
-n å­—ç¬¦ä¸² å­—ç¬¦ä¸²çš„é•¿åº¦ä¸ä¸ºé›¶åˆ™ä¸ºçœŸ
```

**å®ä¾‹**

```shell
num1="runoob"
num2="runoob"

if test num1=num2
then
    echo 'ä¸¤ä¸ªå­—ç¬¦ä¸²ç›¸ç­‰!'
else
    echo 'ä¸¤ä¸ªå­—ç¬¦ä¸²ä¸ç›¸ç­‰!'
fi
```

è¾“å‡ºç»“æœï¼š

```shell
ä¸¤ä¸ªå­—ç¬¦ä¸²ç›¸ç­‰ï¼
```

**æ–‡ä»¶æµ‹è¯•**

```shell
å‚æ•° è¯´æ˜
-e æ–‡ä»¶å å¦‚æœæ–‡ä»¶å­˜åœ¨åˆ™ä¸ºçœŸ
-r æ–‡ä»¶å å¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”å¯è¯»åˆ™ä¸ºçœŸ
-w æ–‡ä»¶å å¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”å¯å†™åˆ™ä¸ºçœŸ
-x æ–‡ä»¶å å¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”å¯æ‰§è¡Œåˆ™ä¸ºçœŸ
-s æ–‡ä»¶å å¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”è‡³å°‘æœ‰ä¸€ä¸ªå­—ç¬¦åˆ™ä¸ºçœŸ
-d æ–‡ä»¶å å¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”ä¸ºç›®å½•åˆ™ä¸ºçœŸ
-f æ–‡ä»¶å å¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”ä¸ºæ™®é€šæ–‡ä»¶åˆ™ä¸ºçœŸ
-c æ–‡ä»¶å å¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”ä¸ºå­—ç¬¦å‹ç‰¹æ®Šæ–‡ä»¶åˆ™ä¸ºçœŸ
-b æ–‡ä»¶å å¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”ä¸ºå—ç‰¹æ®Šæ–‡ä»¶åˆ™ä¸ºçœŸ
```

**å®ä¾‹**

```shell
cd /bin
if test -e ./bash
then
    echo 'æ–‡ä»¶å·²å­˜åœ¨!'
else
    echo 'æ–‡ä»¶ä¸å­˜åœ¨!'
fi
```

è¾“å‡ºç»“æœï¼š

```shell
æ–‡ä»¶å·²å­˜åœ¨!
```

```shell
å¦å¤–ï¼ŒShellè¿˜æä¾›äº†ä¸( -a )ã€æˆ–( -o )ã€é( ! )ä¸‰ä¸ªé€»è¾‘æ“ä½œç¬¦ç”¨äºå°†æµ‹è¯•æ¡ä»¶è¿æ¥èµ·æ¥ï¼Œå…¶ä¼˜å…ˆçº§ä¸ºï¼š"!"æœ€é«˜ï¼Œ"-a"æ¬¡ä¹‹ï¼Œ"-o"æœ€ä½ã€‚
```

ä¾‹å¦‚ï¼š

```shell
cd /bin
if test -e ./notFile -o -e ./bash
then
    echo 'æœ‰ä¸€ä¸ªæ–‡ä»¶å­˜åœ¨!'
else
    echo 'ä¸¤ä¸ªæ–‡ä»¶éƒ½ä¸å­˜åœ¨'
fi
```

è¾“å‡ºç»“æœï¼š

```shell
æœ‰ä¸€ä¸ªæ–‡ä»¶å­˜åœ¨!
```

## æµç¨‹æ§åˆ¶

å’Œ Javaã€PHP ç­‰è¯­è¨€ä¸ä¸€æ ·ï¼Œsh çš„æµç¨‹æ§åˆ¶ä¸å¯ä¸ºç©ºï¼Œå¦‚ (ä»¥ä¸‹ä¸º PHP æµç¨‹æ§åˆ¶å†™æ³•)ï¼š

```shell
<?php
if (isset($_GET["q"])) {
    search(q);
}
else {
    // ä¸åšä»»ä½•äº‹æƒ…
}
```

åœ¨ sh/bash é‡Œå¯ä¸èƒ½è¿™ä¹ˆå†™ï¼Œå¦‚æœ else åˆ†æ”¯æ²¡æœ‰è¯­å¥æ‰§è¡Œï¼Œå°±ä¸è¦å†™è¿™ä¸ª elseã€‚

## if else

**if**

if è¯­å¥è¯­æ³•æ ¼å¼ï¼š

```shell
if condition
then
    command1
    command2
    ...
    commandN
fi
```

å†™æˆä¸€è¡Œï¼ˆé€‚ç”¨äºç»ˆç«¯å‘½ä»¤æç¤ºç¬¦ï¼‰ï¼š

```shell
if [ $(ps -ef | grep -c "ssh") -gt 1 ]; then echo "true"; fi
```

æœ«å°¾çš„ fi å°±æ˜¯ if å€’è¿‡æ¥æ‹¼å†™ï¼Œåé¢è¿˜ä¼šé‡åˆ°ç±»ä¼¼çš„ã€‚

**if else**

if else è¯­æ³•æ ¼å¼ï¼š

```shell
if condition
then
    command1
    command2
    ...
    commandN
else
    command
fi
```

**if else-if else**

if else-if else è¯­æ³•æ ¼å¼ï¼š

```shell
if condition1
then
    command1
elif condition2
then
    command2
else
    commandN
fi
```

ä»¥ä¸‹å®ä¾‹åˆ¤æ–­ä¸¤ä¸ªå˜é‡æ˜¯å¦ç›¸ç­‰ï¼š

```shell
a=10
b=20

if [ $a == $b ]
then
    echo "a ç­‰äº b"
elif [ $a -gt $b ]
then
    echo "a å¤§äº b"
elif [ $a -lt $b ]
then
    echo "a å°äº b"
else
    echo "æ²¡æœ‰ç¬¦åˆçš„æ¡ä»¶"
fi
```

è¾“å‡ºç»“æœï¼š

```shell
a å°äº b
```

if else è¯­å¥ç»å¸¸ä¸ test å‘½ä»¤ç»“åˆä½¿ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
num1=$[2*3]
num2=$[1+5]

if test $[num1] -eq $[num2]
then
    echo 'ä¸¤ä¸ªæ•°å­—ç›¸ç­‰!'
else
    echo 'ä¸¤ä¸ªæ•°å­—ä¸ç›¸ç­‰!'
fi
```

è¾“å‡ºç»“æœï¼š

```shell
ä¸¤ä¸ªæ•°å­—ç›¸ç­‰!
```

## for å¾ªç¯

ä¸å…¶ä»–ç¼–ç¨‹è¯­è¨€ç±»ä¼¼ï¼ŒShell æ”¯æŒ for å¾ªç¯ã€‚

for å¾ªç¯ä¸€èˆ¬æ ¼å¼ä¸ºï¼š

```shell
for var in item1 item2 ... itemN
do
    command1
    command2
    ...
    commandN
done
```

å†™æˆä¸€è¡Œï¼š

```shell
for var in item1 item2 ... itemN; do command1; command2â€¦ done;
```

å½“å˜é‡å€¼åœ¨åˆ—è¡¨é‡Œï¼Œfor å¾ªç¯å³æ‰§è¡Œä¸€æ¬¡æ‰€æœ‰å‘½ä»¤ï¼Œä½¿ç”¨å˜é‡åè·å–åˆ—è¡¨ä¸­çš„å½“å‰å–å€¼ã€‚

å‘½ä»¤å¯ä¸ºä»»ä½•æœ‰æ•ˆçš„ shell å‘½ä»¤å’Œè¯­å¥ã€‚

in åˆ—è¡¨å¯ä»¥åŒ…å«æ›¿æ¢ã€å­—ç¬¦ä¸²å’Œæ–‡ä»¶åã€‚

in åˆ—è¡¨æ˜¯å¯é€‰çš„ï¼Œå¦‚æœä¸ç”¨å®ƒï¼Œfor å¾ªç¯ä½¿ç”¨å‘½ä»¤è¡Œçš„ä½ç½®å‚æ•°ã€‚

ä¾‹å¦‚ï¼Œé¡ºåºè¾“å‡ºå½“å‰åˆ—è¡¨ä¸­çš„æ•°å­—ï¼š

```shell
for loop in 1 2 3 4 5
do
    echo "The value is: $loop"
done
```

è¾“å‡ºç»“æœï¼š

```shell
The value is: 1
The value is: 2
The value is: 3
The value is: 4
The value is: 5
```

é¡ºåºè¾“å‡ºå­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦ï¼š

```shell
for str in 'This is a string'
do
    echo $str
done
```

è¾“å‡ºç»“æœï¼š

```shell
This is a string
```

## while è¯­å¥

while å¾ªç¯ç”¨äºä¸æ–­æ‰§è¡Œä¸€ç³»åˆ—å‘½ä»¤ï¼Œä¹Ÿç”¨äºä»è¾“å…¥æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œå‘½ä»¤é€šå¸¸ä¸ºæµ‹è¯•æ¡ä»¶ã€‚

å…¶æ ¼å¼ä¸ºï¼š

```shell
while condition
do
    command
done
```

ä»¥ä¸‹æ˜¯ä¸€ä¸ªåŸºæœ¬çš„ while å¾ªç¯ï¼Œæµ‹è¯•æ¡ä»¶æ˜¯ï¼šå¦‚æœ int å°äºç­‰äº 5ï¼Œé‚£ä¹ˆæ¡ä»¶è¿”å›çœŸã€‚

int ä» 0 å¼€å§‹ï¼Œæ¯æ¬¡å¾ªç¯å¤„ç†æ—¶ï¼Œint åŠ  1ã€‚

è¿è¡Œä¸Šè¿°è„šæœ¬ï¼Œè¿”å›æ•°å­— 1 åˆ° 5ï¼Œç„¶åç»ˆæ­¢ã€‚

```shell
#!/bin/sh

int=1
while(( $int<=5 ))
do
    echo $int
    let "int++"
done
```

è¿è¡Œè„šæœ¬ï¼Œè¾“å‡ºï¼š

```shell
1
2
3
4
5
```

è„šæœ¬ä¸­ä½¿ç”¨äº† let å‘½ä»¤ï¼Œå®ƒç”¨äºæ‰§è¡Œä¸€ä¸ªæˆ–å¤šä¸ªè¡¨è¾¾å¼ï¼Œå˜é‡è®¡ç®—ä¸­ä¸éœ€è¦åŠ ä¸Š $ æ¥è¡¨ç¤ºå˜é‡ã€‚

while å¾ªç¯å¯ç”¨äºè¯»å–é”®ç›˜ä¿¡æ¯ã€‚

ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œè¾“å…¥ä¿¡æ¯è¢«è®¾ç½®ä¸ºå˜é‡ FILMï¼ŒæŒ‰ç»“æŸå¾ªç¯ã€‚

```shell
echo 'æŒ‰ä¸‹ <CTRL-D> é€€å‡º'
echo -n 'è¾“å…¥ä½ æœ€å–œæ¬¢çš„ç”µå½±å: '
while read FILM
do
    echo "æ˜¯çš„ï¼$FILM æ˜¯ä¸€éƒ¨å¥½ç”µå½±"
done
```

è¿è¡Œè„šæœ¬ï¼Œè¾“å‡ºç±»ä¼¼ä¸‹é¢ï¼š

```shell
æŒ‰ä¸‹ <CTRL-D> é€€å‡º
è¾“å…¥ä½ æœ€å–œæ¬¢çš„ç”µå½±å: w3cschoolèœé¸Ÿæ•™ç¨‹
æ˜¯çš„ï¼w3cschoolèœé¸Ÿæ•™ç¨‹ æ˜¯ä¸€éƒ¨å¥½ç”µå½±
```

## æ— é™å¾ªç¯

æ— é™å¾ªç¯è¯­æ³•æ ¼å¼ï¼š

```shell
while :
do
    command
done
```

æˆ–è€…

```shell
while true
do
    command
done
```

æˆ–è€…

```shell
for (( ; ; ))
```

## until å¾ªç¯

until å¾ªç¯æ‰§è¡Œä¸€ç³»åˆ—å‘½ä»¤ç›´è‡³æ¡ä»¶ä¸ºçœŸæ—¶åœæ­¢ã€‚  
until å¾ªç¯ä¸ while å¾ªç¯åœ¨å¤„ç†æ–¹å¼ä¸Šåˆšå¥½ç›¸åã€‚  
ä¸€èˆ¬ while å¾ªç¯ä¼˜äº until å¾ªç¯ï¼Œä½†åœ¨æŸäº›æ—¶å€™â€”ä¹Ÿåªæ˜¯æå°‘æ•°æƒ…å†µä¸‹ï¼Œuntil å¾ªç¯æ›´åŠ æœ‰ç”¨ã€‚  
until è¯­æ³•æ ¼å¼:

```shell
until condition
do
    command
done
```

æ¡ä»¶å¯ä¸ºä»»æ„æµ‹è¯•æ¡ä»¶ï¼Œæµ‹è¯•å‘ç”Ÿåœ¨å¾ªç¯æœ«å°¾ï¼Œå› æ­¤å¾ªç¯è‡³å°‘æ‰§è¡Œä¸€æ¬¡â€”è¯·æ³¨æ„è¿™ä¸€ç‚¹ã€‚

## case

Shell case è¯­å¥ä¸ºå¤šé€‰æ‹©è¯­å¥ã€‚  
å¯ä»¥ç”¨ case è¯­å¥åŒ¹é…ä¸€ä¸ªå€¼ä¸ä¸€ä¸ªæ¨¡å¼ï¼Œå¦‚æœåŒ¹é…æˆåŠŸï¼Œæ‰§è¡Œç›¸åŒ¹é…çš„å‘½ä»¤ã€‚  
case è¯­å¥æ ¼å¼å¦‚ä¸‹ï¼š

```shell
case å€¼ in
æ¨¡å¼1)
    command1
    command2
    ...
    commandN

;;

æ¨¡å¼2ï¼‰
    command1
    command2
    ...
    commandN
;;
esac
```

case å·¥ä½œæ–¹å¼å¦‚ä¸Šæ‰€ç¤ºã€‚  
å–å€¼åé¢å¿…é¡»ä¸ºå•è¯ inï¼Œæ¯ä¸€æ¨¡å¼å¿…é¡»ä»¥å³æ‹¬å·ç»“æŸã€‚  
å–å€¼å¯ä»¥ä¸ºå˜é‡æˆ–å¸¸æ•°ã€‚  
åŒ¹é…å‘ç°å–å€¼ç¬¦åˆæŸä¸€æ¨¡å¼åï¼Œå…¶é—´æ‰€æœ‰å‘½ä»¤å¼€å§‹æ‰§è¡Œç›´è‡³ ;;ã€‚  
å–å€¼å°†æ£€æµ‹åŒ¹é…çš„æ¯ä¸€ä¸ªæ¨¡å¼ã€‚  
ä¸€æ—¦æ¨¡å¼åŒ¹é…ï¼Œåˆ™æ‰§è¡Œå®ŒåŒ¹é…æ¨¡å¼ç›¸åº”å‘½ä»¤åä¸å†ç»§ç»­å…¶ä»–æ¨¡å¼ã€‚  
å¦‚æœæ— ä¸€åŒ¹é…æ¨¡å¼ï¼Œä½¿ç”¨æ˜Ÿå· `*` æ•è·è¯¥å€¼ï¼Œå†æ‰§è¡Œåé¢çš„å‘½ä»¤ã€‚  
ä¸‹é¢çš„è„šæœ¬æç¤ºè¾“å…¥ 1 åˆ° 4ï¼Œä¸æ¯ä¸€ç§æ¨¡å¼è¿›è¡ŒåŒ¹é…ï¼š

```shell
echo 'è¾“å…¥ 1 åˆ° 4 ä¹‹é—´çš„æ•°å­—:'
echo 'ä½ è¾“å…¥çš„æ•°å­—ä¸º:'
read aNum
case $aNum in
1) echo 'ä½ é€‰æ‹©äº† 1'
;;

2) echo 'ä½ é€‰æ‹©äº† 2'
;;

3) echo 'ä½ é€‰æ‹©äº† 3'
;;

4) echo 'ä½ é€‰æ‹©äº† 4'
;;

*) echo 'ä½ æ²¡æœ‰è¾“å…¥ 1 åˆ° 4 ä¹‹é—´çš„æ•°å­—'
;;
esac
```

è¾“å…¥ä¸åŒçš„å†…å®¹ï¼Œä¼šæœ‰ä¸åŒçš„ç»“æœï¼Œä¾‹å¦‚ï¼š

```shell
è¾“å…¥ 1 åˆ° 4 ä¹‹é—´çš„æ•°å­—:
ä½ è¾“å…¥çš„æ•°å­—ä¸º:
3
ä½ é€‰æ‹©äº† 3
```

**esac**

case çš„è¯­æ³•å’Œ C family è¯­è¨€å·®åˆ«å¾ˆå¤§ï¼Œå®ƒéœ€è¦ä¸€ä¸ª esacï¼ˆå°±æ˜¯ case åè¿‡æ¥ï¼‰ä½œä¸ºç»“æŸæ ‡è®°ï¼Œæ¯ä¸ª case åˆ†æ”¯ç”¨å³åœ†æ‹¬å·ï¼Œç”¨ä¸¤ä¸ªåˆ†å·è¡¨ç¤º breakã€‚

## è·³å‡ºå¾ªç¯

åœ¨å¾ªç¯è¿‡ç¨‹ä¸­ï¼Œæœ‰æ—¶å€™éœ€è¦åœ¨æœªè¾¾åˆ°å¾ªç¯ç»“æŸæ¡ä»¶æ—¶å¼ºåˆ¶è·³å‡ºå¾ªç¯ï¼ŒShell ä½¿ç”¨ä¸¤ä¸ªå‘½ä»¤æ¥å®ç°è¯¥åŠŸèƒ½ï¼šbreak å’Œ continueã€‚  
**break å‘½ä»¤**  
break å‘½ä»¤å…è®¸è·³å‡ºæ‰€æœ‰å¾ªç¯ï¼ˆç»ˆæ­¢æ‰§è¡Œåé¢çš„æ‰€æœ‰å¾ªç¯ï¼‰ã€‚  
ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œè„šæœ¬è¿›å…¥æ­»å¾ªç¯ç›´è‡³ç”¨æˆ·è¾“å…¥æ•°å­—å¤§äº 5ã€‚  
è¦è·³å‡ºè¿™ä¸ªå¾ªç¯ï¼Œè¿”å›åˆ° shell æç¤ºç¬¦ä¸‹ï¼Œéœ€è¦ä½¿ç”¨ break å‘½ä»¤ã€‚

```shell
#!/bin/bash
while :
do
    echo -n "è¾“å…¥ 1 åˆ° 5 ä¹‹é—´çš„æ•°å­—:"
    read aNum
    case $aNum in

    1|2|3|4|5) echo "ä½ è¾“å…¥çš„æ•°å­—ä¸º $aNum!"
    ;;

    *) echo "ä½ è¾“å…¥çš„æ•°å­—ä¸æ˜¯ 1 åˆ° 5 ä¹‹é—´çš„! æ¸¸æˆç»“æŸ"
    break
    ;;
    esac
done
```

æ‰§è¡Œä»¥ä¸Šä»£ç ï¼Œè¾“å‡ºç»“æœä¸ºï¼š

```shell
è¾“å…¥ 1 åˆ° 5 ä¹‹é—´çš„æ•°å­—:3
ä½ è¾“å…¥çš„æ•°å­—ä¸º 3!
è¾“å…¥ 1 åˆ° 5 ä¹‹é—´çš„æ•°å­—:7
ä½ è¾“å…¥çš„æ•°å­—ä¸æ˜¯ 1 åˆ° 5 ä¹‹é—´çš„! æ¸¸æˆç»“æŸ
```

**continue**

continue å‘½ä»¤ä¸ break å‘½ä»¤ç±»ä¼¼ï¼Œåªæœ‰ä¸€ç‚¹å·®åˆ«ï¼Œå®ƒä¸ä¼šè·³å‡ºæ‰€æœ‰å¾ªç¯ï¼Œä»…ä»…è·³å‡ºå½“å‰å¾ªç¯ã€‚

å¯¹ä¸Šé¢çš„ä¾‹å­è¿›è¡Œä¿®æ”¹ï¼š

```shell
#!/bin/bash
while :
do
    echo -n "è¾“å…¥ 1 åˆ° 5 ä¹‹é—´çš„æ•°å­—: "
    read aNum
    case $aNum in
    1|2|3|4|5) echo "ä½ è¾“å…¥çš„æ•°å­—ä¸º $aNum!"
    ;;
    *) echo "ä½ è¾“å…¥çš„æ•°å­—ä¸æ˜¯ 1 åˆ° 5 ä¹‹é—´çš„!"
    continue
    echo "æ¸¸æˆç»“æŸ"
    ;;
    esac
done

```

è¿è¡Œä»£ç å‘ç°ï¼Œå½“è¾“å…¥å¤§äº 5 çš„æ•°å­—æ—¶ï¼Œè¯¥ä¾‹ä¸­çš„å¾ªç¯ä¸ä¼šç»“æŸï¼Œè¯­å¥ echo "Game is over!" æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œã€‚

## å‡½æ•°

linux shell å¯ä»¥ç”¨æˆ·å®šä¹‰å‡½æ•°ï¼Œç„¶ååœ¨ shell è„šæœ¬ä¸­å¯ä»¥éšä¾¿è°ƒç”¨ã€‚

shell ä¸­å‡½æ•°çš„å®šä¹‰æ ¼å¼å¦‚ä¸‹ï¼š

```shell
[ function ] funname [()]
{
    action;
    [return int;]
}
```

è¯´æ˜ï¼š

1. å¯ä»¥å¸¦ function fun() å®šä¹‰ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ fun() å®šä¹‰,ä¸å¸¦ä»»ä½•å‚æ•°ã€‚
2. å‚æ•°è¿”å›ï¼Œå¯ä»¥æ˜¾ç¤ºåŠ ï¼šreturn è¿”å›ï¼Œå¦‚æœä¸åŠ ï¼Œå°†ä»¥æœ€åä¸€æ¡å‘½ä»¤è¿è¡Œç»“æœï¼Œä½œä¸ºè¿”å›å€¼ã€‚ return åè·Ÿæ•°å€¼ n(0-255

ä¸‹é¢çš„ä¾‹å­å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°å¹¶è¿›è¡Œè°ƒç”¨ï¼š

```shell
#!/bin/bash

demoFun(){
    echo "è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ä¸ª shell å‡½æ•°!"
}

echo "-----å‡½æ•°å¼€å§‹æ‰§è¡Œ-----"

demoFun

echo "-----å‡½æ•°æ‰§è¡Œå®Œæ¯•-----"
```

è¾“å‡ºç»“æœï¼š

```shell
-----å‡½æ•°å¼€å§‹æ‰§è¡Œ-----
è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ä¸ª shell å‡½æ•°!
-----å‡½æ•°æ‰§è¡Œå®Œæ¯•-----
```

ä¸‹é¢å®šä¹‰ä¸€ä¸ªå¸¦æœ‰ return è¯­å¥çš„å‡½æ•°ï¼š

```shell
#!/bin/bash

funWithReturn(){
    echo "è¿™ä¸ªå‡½æ•°ä¼šå¯¹è¾“å…¥çš„ä¸¤ä¸ªæ•°å­—è¿›è¡Œç›¸åŠ è¿ç®—..."
    echo "è¾“å…¥ç¬¬ä¸€ä¸ªæ•°å­—: "
    read aNum
    echo "è¾“å…¥ç¬¬äºŒä¸ªæ•°å­—: "
    read anotherNum
    echo "ä¸¤ä¸ªæ•°å­—åˆ†åˆ«ä¸º $aNum å’Œ $anotherNum !"
    return $(($aNum+$anotherNum))
}

funWithReturn
echo "è¾“å…¥çš„ä¸¤ä¸ªæ•°å­—ä¹‹å’Œä¸º $? !"
```

è¾“å‡ºç±»ä¼¼ä¸‹é¢ï¼š

```shell
è¿™ä¸ªå‡½æ•°ä¼šå¯¹è¾“å…¥çš„ä¸¤ä¸ªæ•°å­—è¿›è¡Œç›¸åŠ è¿ç®—...
è¾“å…¥ç¬¬ä¸€ä¸ªæ•°å­—:
1
è¾“å…¥ç¬¬äºŒä¸ªæ•°å­—:
2
ä¸¤ä¸ªæ•°å­—åˆ†åˆ«ä¸º 1 å’Œ 2 !
è¾“å…¥çš„ä¸¤ä¸ªæ•°å­—ä¹‹å’Œä¸º 3 !
```

å‡½æ•°è¿”å›å€¼åœ¨è°ƒç”¨è¯¥å‡½æ•°åé€šè¿‡ $? æ¥è·å¾—ã€‚

æ³¨æ„ï¼š

- æ‰€æœ‰å‡½æ•°åœ¨ä½¿ç”¨å‰å¿…é¡»å®šä¹‰ã€‚
- è¿™æ„å‘³ç€å¿…é¡»å°†å‡½æ•°æ”¾åœ¨è„šæœ¬å¼€å§‹éƒ¨åˆ†ï¼Œç›´è‡³ shell è§£é‡Šå™¨é¦–æ¬¡å‘ç°å®ƒæ—¶ï¼Œæ‰å¯ä»¥ä½¿ç”¨ã€‚
- è°ƒç”¨å‡½æ•°ä»…ä½¿ç”¨å…¶å‡½æ•°åå³å¯ã€‚

**å‡½æ•°å‚æ•°**

åœ¨ Shell ä¸­ï¼Œè°ƒç”¨å‡½æ•°æ—¶å¯ä»¥å‘å…¶ä¼ é€’å‚æ•°ã€‚

åœ¨å‡½æ•°ä½“å†…éƒ¨ï¼Œé€šè¿‡ n çš„å½¢å¼æ¥è·å–å‚æ•°çš„å€¼ï¼Œä¾‹å¦‚ï¼Œ1 è¡¨ç¤ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œ$2 è¡¨ç¤ºç¬¬äºŒä¸ªå‚æ•°â€¦

å¸¦å‚æ•°çš„å‡½æ•°ç¤ºä¾‹ï¼š

```shell
#!/bin/bash
funWithParam(){
    echo "ç¬¬ä¸€ä¸ªå‚æ•°ä¸º $1 !"
    echo "ç¬¬äºŒä¸ªå‚æ•°ä¸º $2 !"
    echo "ç¬¬åä¸ªå‚æ•°ä¸º $10 !"
    echo "ç¬¬åä¸ªå‚æ•°ä¸º ${10} !"
    echo "ç¬¬åä¸€ä¸ªå‚æ•°ä¸º ${11} !"
    echo "å‚æ•°æ€»æ•°æœ‰ $# ä¸ª!"
    echo "ä½œä¸ºä¸€ä¸ªå­—ç¬¦ä¸²è¾“å‡ºæ‰€æœ‰å‚æ•° $* !"
}
funWithParam 1 2 3 4 5 6 7 8 9 34 73
```

è¾“å‡ºç»“æœï¼š

```shell
ç¬¬ä¸€ä¸ªå‚æ•°ä¸º 1 !
ç¬¬äºŒä¸ªå‚æ•°ä¸º 2 !
ç¬¬åä¸ªå‚æ•°ä¸º 10 !
ç¬¬åä¸ªå‚æ•°ä¸º 34 !
ç¬¬åä¸€ä¸ªå‚æ•°ä¸º 73 !
å‚æ•°æ€»æ•°æœ‰ 11 ä¸ª!
ä½œä¸ºä¸€ä¸ªå­—ç¬¦ä¸²è¾“å‡ºæ‰€æœ‰å‚æ•° 1 2 3 4 5 6 7 8 9 34 73 !
```

æ³¨æ„ï¼Œ10 ä¸èƒ½è·å–ç¬¬åä¸ªå‚æ•°ï¼Œè·å–ç¬¬åä¸ªå‚æ•°éœ€è¦{10}ã€‚å½“ n>=10 æ—¶ï¼Œéœ€è¦ä½¿ç”¨ ${n}æ¥è·å–å‚æ•°ã€‚

å¦å¤–ï¼Œè¿˜æœ‰å‡ ä¸ªç‰¹æ®Šå­—ç¬¦ç”¨æ¥å¤„ç†å‚æ•°ï¼š

```shell
å‚æ•°å¤„ç† è¯´æ˜
$# ä¼ é€’åˆ°è„šæœ¬çš„å‚æ•°ä¸ªæ•°
$* ä»¥ä¸€ä¸ªå•å­—ç¬¦ä¸²æ˜¾ç¤ºæ‰€æœ‰å‘è„šæœ¬ä¼ é€’çš„å‚æ•°
$ è„šæœ¬è¿è¡Œçš„å½“å‰è¿›ç¨‹IDå·
$! åå°è¿è¡Œçš„æœ€åä¸€ä¸ªè¿›ç¨‹çš„IDå·
$@ ä¸$*ç›¸åŒï¼Œä½†æ˜¯ä½¿ç”¨æ—¶åŠ å¼•å·ï¼Œå¹¶åœ¨å¼•å·ä¸­è¿”å›æ¯ä¸ªå‚æ•°ã€‚
$- æ˜¾ç¤ºShellä½¿ç”¨çš„å½“å‰é€‰é¡¹ï¼Œä¸setå‘½ä»¤åŠŸèƒ½ç›¸åŒã€‚
$? æ˜¾ç¤ºæœ€åå‘½ä»¤çš„é€€å‡ºçŠ¶æ€ã€‚0è¡¨ç¤ºæ²¡æœ‰é”™è¯¯ï¼Œå…¶ä»–ä»»ä½•å€¼è¡¨æ˜æœ‰é”™è¯¯ã€‚
```

## è¾“å…¥/è¾“å‡ºé‡å®šå‘

å¤§å¤šæ•° UNIX ç³»ç»Ÿå‘½ä»¤ä»ä½ çš„ç»ˆç«¯æ¥å—è¾“å…¥å¹¶å°†æ‰€äº§ç”Ÿçš„è¾“å‡ºå‘é€å› â€‹â€‹ åˆ°æ‚¨çš„ç»ˆç«¯ã€‚  
ä¸€ä¸ªå‘½ä»¤é€šå¸¸ä»ä¸€ä¸ªå«æ ‡å‡†è¾“å…¥çš„åœ°æ–¹è¯»å–è¾“å…¥ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™æ°å¥½æ˜¯ä½ çš„ç»ˆç«¯ã€‚  
åŒæ ·ï¼Œä¸€ä¸ªå‘½ä»¤é€šå¸¸å°†å…¶è¾“å‡ºå†™å…¥åˆ°æ ‡å‡†è¾“å‡ºï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¹Ÿæ˜¯ä½ çš„ç»ˆç«¯ã€‚  
é‡å®šå‘å‘½ä»¤å¦‚ä¸‹ï¼š

```shell
å‘½ä»¤ è¯´æ˜
command > file å°†è¾“å‡ºé‡å®šå‘åˆ° fileã€‚
command < file å°†è¾“å…¥é‡å®šå‘åˆ° fileã€‚
command >> file å°†è¾“å‡ºä»¥è¿½åŠ çš„æ–¹å¼é‡å®šå‘åˆ° fileã€‚
n > file å°†æ–‡ä»¶æè¿°ç¬¦ä¸º n çš„æ–‡ä»¶é‡å®šå‘åˆ° fileã€‚
n >> file å°†æ–‡ä»¶æè¿°ç¬¦ä¸º n çš„æ–‡ä»¶ä»¥è¿½åŠ çš„æ–¹å¼é‡å®šå‘åˆ° fileã€‚
n >& m å°†è¾“å‡ºæ–‡ä»¶ m å’Œ n åˆå¹¶ã€‚
n <& m å°†è¾“å…¥æ–‡ä»¶ m å’Œ n åˆå¹¶ã€‚
<< tag å°†å¼€å§‹æ ‡è®° tag å’Œç»“æŸæ ‡è®° tag ä¹‹é—´çš„å†…å®¹ä½œä¸ºè¾“å…¥ã€‚
```

```shell
éœ€è¦æ³¨æ„çš„æ˜¯æ–‡ä»¶æè¿°ç¬¦ 0 é€šå¸¸æ˜¯æ ‡å‡†è¾“å…¥ï¼ˆSTDINï¼‰ï¼Œ1 æ˜¯æ ‡å‡†è¾“å‡ºï¼ˆSTDOUTï¼‰ï¼Œ2 æ˜¯æ ‡å‡†é”™è¯¯è¾“å‡ºï¼ˆSTDERRï¼‰ã€‚
```

**è¾“å‡ºé‡å®šå‘**

é‡å®šå‘ä¸€èˆ¬é€šè¿‡åœ¨å‘½ä»¤é—´æ’å…¥ç‰¹å®šçš„ç¬¦å·æ¥å®ç°ã€‚ç‰¹åˆ«çš„ï¼Œè¿™äº›ç¬¦å·çš„è¯­æ³•å¦‚ä¸‹æ‰€ç¤º:

```shell
command1 > file1
```

ä¸Šé¢è¿™ä¸ªå‘½ä»¤æ‰§è¡Œ command1 ç„¶åå°†è¾“å‡ºçš„å†…å®¹å­˜å…¥ file1ã€‚

æ³¨æ„ï¼šä»»ä½• file1 å†…çš„å·²ç»å­˜åœ¨çš„å†…å®¹å°†è¢«æ–°å†…å®¹æ›¿ä»£ã€‚å¦‚æœè¦å°†æ–°å†…å®¹æ·»åŠ åœ¨æ–‡ä»¶æœ«å°¾ï¼Œè¯·ä½¿ç”¨>>æ“ä½œç¬¦ã€‚

**å®ä¾‹**

æ‰§è¡Œä¸‹é¢çš„ who å‘½ä»¤ï¼Œå®ƒå°†å‘½ä»¤çš„å®Œæ•´çš„è¾“å‡ºé‡å®šå‘åœ¨ç”¨æˆ·æ–‡ä»¶ä¸­ (users):

```shell
$ who > users
```

æ‰§è¡Œåï¼Œå¹¶æ²¡æœ‰åœ¨ç»ˆç«¯è¾“å‡ºä¿¡æ¯ï¼Œè¿™æ˜¯å› ä¸ºè¾“å‡ºå·²è¢«ä»é»˜è®¤çš„æ ‡å‡†è¾“å‡ºè®¾å¤‡ï¼ˆç»ˆç«¯ï¼‰é‡å®šå‘åˆ°æŒ‡å®šçš„æ–‡ä»¶ã€‚

ä½ å¯ä»¥ä½¿ç”¨ cat å‘½ä»¤æŸ¥çœ‹æ–‡ä»¶å†…å®¹ï¼š

```shell
$ cat users
_mbsetupuser console Oct 31 17:35
tianqixin console Oct 31 17:35
tianqixin ttys000 Dec 1 11:33
```

è¾“å‡ºé‡å®šå‘ä¼šè¦†ç›–æ–‡ä»¶å†…å®¹ï¼Œè¯·çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š

```shell
$ echo "æµ‹è¯•æµ‹è¯•ï¼šwww.runoob.com" > users
$ cat users
æµ‹è¯•æµ‹è¯•ï¼šwww.runoob.com
$
```

å¦‚æœä¸å¸Œæœ›æ–‡ä»¶å†…å®¹è¢«è¦†ç›–ï¼Œå¯ä»¥ä½¿ç”¨ >> è¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾ï¼Œä¾‹å¦‚ï¼š

```shell
$ echo "æµ‹è¯•æµ‹è¯•ï¼šwww.runoob.com" >> users
$ cat users
æµ‹è¯•æµ‹è¯•ï¼šwww.runoob.com
æµ‹è¯•æµ‹è¯•ï¼šwww.runoob.com
$
```

**è¾“å…¥é‡å®šå‘**

å’Œè¾“å‡ºé‡å®šå‘ä¸€æ ·ï¼ŒUnix å‘½ä»¤ä¹Ÿå¯ä»¥ä»æ–‡ä»¶è·å–è¾“å…¥ï¼Œè¯­æ³•ä¸ºï¼š

```shell
command1 < file1
```

è¿™æ ·ï¼Œæœ¬æ¥éœ€è¦ä»é”®ç›˜è·å–è¾“å…¥çš„å‘½ä»¤ä¼šè½¬ç§»åˆ°æ–‡ä»¶è¯»å–å†…å®¹ã€‚  
æ³¨æ„ï¼šè¾“å‡ºé‡å®šå‘æ˜¯å¤§äºå· (>)ï¼Œè¾“å…¥é‡å®šå‘æ˜¯å°äºå· ( outfile  
åŒæ—¶æ›¿æ¢è¾“å…¥å’Œè¾“å‡ºï¼Œæ‰§è¡Œ command1ï¼Œä»æ–‡ä»¶ infile è¯»å–å†…å®¹ï¼Œç„¶åå°†è¾“å‡ºå†™å…¥åˆ° outfile ä¸­ã€‚

**é‡å®šå‘æ·±å…¥ç†è§£**

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¯ä¸ª Unix/Linux å‘½ä»¤è¿è¡Œæ—¶éƒ½ä¼šæ‰“å¼€ä¸‰ä¸ªæ–‡ä»¶ï¼š

- æ ‡å‡†è¾“å…¥æ–‡ä»¶ (stdin)ï¼šstdin çš„æ–‡ä»¶æè¿°ç¬¦ä¸º 0ï¼ŒUnix ç¨‹åºé»˜è®¤ä» stdin è¯»å–æ•°æ®ã€‚
- æ ‡å‡†è¾“å‡ºæ–‡ä»¶ (stdout)ï¼šstdout çš„æ–‡ä»¶æè¿°ç¬¦ä¸º 1ï¼ŒUnix ç¨‹åºé»˜è®¤å‘ stdout è¾“å‡ºæ•°æ®ã€‚
- æ ‡å‡†é”™è¯¯æ–‡ä»¶ (stderr)ï¼šstderr çš„æ–‡ä»¶æè¿°ç¬¦ä¸º 2ï¼ŒUnix ç¨‹åºä¼šå‘ stderr æµä¸­å†™å…¥é”™è¯¯ä¿¡æ¯ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œcommand > file å°† stdout é‡å®šå‘åˆ° fileï¼Œcommand

## [Shellè„šæœ¬ç¼–å†™å…¨æ”»ç•¥ï¼šä»é›¶å¼€å§‹](https://blog.dong4j.site/posts/a77b2cc.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## å®šä¹‰å˜é‡

```shell
#!/bin/bash
# å®šä¹‰ å˜é‡åå’Œç­‰å·ä¹‹é—´ä¸èƒ½æœ‰ç©ºæ ¼
your_name="dong4j"
# ä½¿ç”¨
echo ${your_name}

# å¾ªç¯è¾“å‡º
for skill in Ada Coffe Action Java
do
    echo "I am good at ${skill} Script"
done
```

## åªè¯»å˜é‡

readonly å˜é‡å

## åˆ é™¤å˜é‡

unset å˜é‡å

## ç‰¹æ®Šå˜é‡

```
$0
å½“å‰è„šæœ¬çš„æ–‡ä»¶å
$n
ä¼ é€’ç»™è„šæœ¬æˆ–å‡½æ•°çš„å‚æ•°ã€‚n æ˜¯ä¸€ä¸ªæ•°å­—,è¡¨ç¤ºç¬¬å‡ ä¸ªå‚æ•°ã€‚ä¾‹å¦‚,ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯$1,ç¬¬äºŒä¸ªå‚æ•°æ˜¯$2ã€‚
$#
ä¼ é€’ç»™è„šæœ¬æˆ–å‡½æ•°çš„å‚æ•°ä¸ªæ•°ã€‚
$*
ä¼ é€’ç»™è„šæœ¬æˆ–å‡½æ•°çš„æ‰€æœ‰å‚æ•°ã€‚
$@
ä¼ é€’ç»™è„šæœ¬æˆ–å‡½æ•°çš„æ‰€æœ‰å‚æ•°ã€‚è¢«åŒå¼•å·(" ")åŒ…å«æ—¶,ä¸ $* ç¨æœ‰ä¸åŒ,ä¸‹é¢å°†ä¼šè®²åˆ°ã€‚
$?
ä¸Šä¸ªå‘½ä»¤çš„é€€å‡ºçŠ¶æ€,æˆ–å‡½æ•°çš„è¿”å›å€¼ã€‚
$$
å½“å‰ Shell è¿›ç¨‹ IDã€‚å¯¹äº Shell è„šæœ¬,å°±æ˜¯è¿™äº›è„šæœ¬æ‰€åœ¨çš„è¿›ç¨‹ IDã€‚
```

## shell æ›¿æ¢

### å‘½ä»¤æ›¿æ¢

```
#!/bin/bash
DATE=`date` echo "Date is $DATE"
USERS=`who | wc -l` echo "Logged in user are $USERS"
UP=`date ; uptime` echo "Uptime is $UP"
```

### å˜é‡æ›¿æ¢

```
#!/bin/bash

# å¦‚æœå˜é‡ä¸ºç©ºæˆ–è¢«åˆ é™¤(unset),åˆ™è¿”å› word,ä¸æ”¹å˜ varçš„å€¼
echo ${var:-"Variable is not set"}
echo "1 - Value of var is ${var}"

# å¦‚æœå˜é‡ä¸ºç©ºæˆ–è¢«åˆ é™¤(unset),åˆ™è¿”å› word,æ”¹å˜ varçš„å€¼ä¸º word
echo ${var:="Variable is not set"}
echo "2 - Value of var is ${var}"

unset var
# å¦‚æœå˜é‡ var è¢«å®šä¹‰,é‚£ä¹ˆè¿”å› word,ä½†ä¸æ”¹å˜ var çš„å€¼ã€‚
echo ${var:+"This is default value"}
echo "3 - Value of var is ${var}"

var="Prefix"
echo ${var:+"This is default value"}
echo "4 - Value of var is ${var}"

# å¦‚æœå˜é‡ var ä¸ºç©ºæˆ–å·²è¢«åˆ é™¤(unset),é‚£ä¹ˆå°†æ¶ˆæ¯ message é€åˆ°æ ‡ å‡†é”™è¯¯è¾“å‡º,å¯ä»¥ç”¨æ¥æ£€æµ‹å˜ é‡ var æ˜¯å¦å¯ä»¥è¢«æ­£å¸¸èµ‹å€¼ã€‚è‹¥æ­¤æ›¿æ¢å‡ºç°åœ¨ Shell è„šæœ¬ä¸­,é‚£ä¹ˆè„šæœ¬å°†åœæ­¢è¿è¡Œã€‚
echo ${var:?"Print this message"}
echo "5 - Value of var is ${var}"
```

## shell è¿ç®—ç¬¦

### ç®—æ•°è¿ç®—ç¬¦

```bash
#!/bin/bash
a=10 b=20
val=`expr $a + $b`
echo "a + b : $val"
val=`expr $a - $b`
echo "a - b : $val"
val=`expr $a * $b`
echo "a * b : $val"
val=`expr $b / $a`
echo "b / a : $val"
val=`expr $b % $a`
echo "b % a : $val"

# æ¡ä»¶è¡¨è¾¾å¼æ”¾åœ¨[]ä¸­,ä¸”å‰åå¿…é¡»ç•™ç©ºæ ¼
if [ $a == $b ]
then
    echo "a is equal to b"
fi
if [ $a != $b ]
then
    echo "a is not equal to b"
fi
```

### å…³ç³»è¿ç®—ç¬¦

```
#!/bin/bash
a=10 b=20
if [ $a -eq $b ]
then
    echo "$a -eq $b : a is equal to b"
else
    echo "$a -eq $b: a is not equal to b"
fi
```

`-eq`: æ£€æµ‹ä¸¤ä¸ªæ•°æ˜¯å¦ç›¸ç­‰,ç›¸ç­‰è¿”å› trueã€‚

```shell
[ $a -eq $b ]
```

è¿”å› trueã€‚

`-ne`: æ£€æµ‹ä¸¤ä¸ªæ•°æ˜¯å¦ç›¸ç­‰,ä¸ç›¸ç­‰è¿”å› trueã€‚

```shell
[ $a -ne $b ]
```

è¿”å› trueã€‚

`-gt`: æ£€æµ‹å·¦è¾¹çš„æ•°æ˜¯å¦å¤§äºå³è¾¹çš„,å¦‚æœæ˜¯,åˆ™è¿”å› trueã€‚

```shell
[ $a -gt $b ]
```

è¿”å› falseã€‚

`-lt`: æ£€æµ‹å·¦è¾¹çš„æ•°æ˜¯å¦å°äºå³è¾¹çš„,å¦‚æœæ˜¯,åˆ™è¿”å› trueã€‚

```shell
[ $a -lt $b ]
```

è¿”å› trueã€‚

`-ge`: æ£€æµ‹å·¦è¾¹çš„æ•°æ˜¯å¦å¤§ç­‰äºå³è¾¹çš„,å¦‚æœæ˜¯,åˆ™è¿”å› trueã€‚

```shell
[ $a -ge $b ]
```

è¿”å› falseã€‚

`-le`: æ£€æµ‹å·¦è¾¹çš„æ•°æ˜¯å¦å°äºç­‰äºå³è¾¹çš„,å¦‚æœæ˜¯,åˆ™è¿”å› trueã€‚

```shell
[ $a -le $b ]
```

è¿”å› trueã€‚

### å¸ƒå°”è¿ç®—ç¬¦

! : é  
-o : æˆ– æœ‰ä¸€ä¸ªä¸º true åˆ™è¿”å› true  
-a : ä¸ ä¸¤ä¸ªè¡¨è¾¾å¼éƒ½ä¸º true æ‰è¿”å› true

### å­—ç¬¦ä¸²è¿ç®—ç¬¦

`=` : æ£€æµ‹ä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰è¿”å› trueã€‚ `[ $a = $b ]` è¿”å› falseã€‚  
`!=` : æ£€æµ‹ä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ç›¸ç­‰ï¼Œä¸ç›¸ç­‰è¿”å› trueã€‚`[ $a != $b ]` è¿”å› trueã€‚  
`-z` : å­—ç¬¦ä¸²é•¿åº¦ä¸º 0 æ—¶è¿”å› true `[ -z ${str}]  `
`-n` : é•¿åº¦ä¸ä¸ºé›¶æ—¶è¿”å› true  
`str` æ£€æµ‹å­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©º, ä¸ä¸ºç©ºè¿”å› true `[ ${str} ]`

### æ–‡ä»¶æµ‹è¯•è¿ç®—ç¬¦

-b : æ˜¯å¦ä¸ºå—è®¾å¤‡æ–‡ä»¶  
-c : æ˜¯å¦ä¸ºå­—ç¬¦è®¾å¤‡æ–‡ä»¶  
-d : æ˜¯å¦ä¸ºç›®å½•  
-f : æ˜¯å¦ä¸ºæ™®é€šæ–‡ä»¶ (ä¸æ˜¯ç›®å½•ä¹Ÿä¸æ˜¯è®¾å¤‡æ–‡ä»¶)  
-g : æ˜¯å¦è®¾ç½®äº† SGID ä½  
-k : æ˜¯å¦è®¾ç½®äº†æ²¾ç€ä½ (Sticky Bit)  
-p : æ˜¯å¦æ˜¯å…·åç®¡é“  
-u : æ˜¯å¦è®¾ç½®äº† SUID ä½  
-r : æ˜¯å¦å¯è¯»  
-w : æ˜¯å¦å¯å†™  
-x : æ˜¯å¦å¯æ‰§è¡Œ  
-s : æ–‡ä»¶å¤§å°æ˜¯å¦ä¸ºç©º ä¸ä¸ºç©ºè¿”å› true  
-e : æ–‡ä»¶ (åŒ…æ‹¬ç›®å½•) æ˜¯å¦å­˜åœ¨,å­˜åœ¨è¿”å› true

## shell å­—ç¬¦ä¸²å¤„ç†

### å•å¼•å·

`str='this is a string'`

å•å¼•å·å­—ç¬¦ä¸²çš„é™åˆ¶: å•å¼•å·é‡Œçš„ä»»ä½•å­—ç¬¦éƒ½ä¼šåŸæ ·è¾“å‡º,å•å¼•å·å­—ç¬¦ä¸²ä¸­çš„å˜é‡æ˜¯æ— æ•ˆçš„; å•å¼•å·å­—ä¸²ä¸­ä¸èƒ½ å‡ºç°å•å¼•å· (å¯¹å•å¼•å·ä½¿ç”¨è½¬ä¹‰ç¬¦åä¹Ÿä¸è¡Œ)ã€‚

### åŒå¼•å·

```shell
your_name='qinjx'
str="Hello, I know your are \"${your_name}\"! \n"
```

åŒå¼•å·çš„ä¼˜ç‚¹: åŒå¼•å·é‡Œå¯ä»¥æœ‰å˜é‡ åŒå¼•å·é‡Œå¯ä»¥å‡ºç°è½¬ä¹‰å­—ç¬¦

### è·å–å­—ç¬¦ä¸²é•¿åº¦

```shell
string="abcd"
# è¾“å‡º4
echo ${#string}
```

### æå–å­å­—ç¬¦ä¸²

```shell
string="alibaba is a great company"
# è¾“å‡º liba æœ‰ç‚¹åƒ python çš„åˆ‡ç‰‡
echo ${string:1:4}
```

### æŸ¥è¯¢å­å­—ç¬¦ä¸²

```shell
string="alibaba is a great company"
echo `expr index "${string}" is`
```

## æ•°ç»„

### å®šä¹‰

ä½¿ç”¨ç©ºæ ¼åˆ†å‰²å…ƒç´   
`array_name=(value1 value2â€¦.)`  
æˆ–è€…

```shell
array_name=(
value0
value1
value2
...
)
```

æˆ–è€…å•ç‹¬è®¾ç½®

```shell
array_name[0]=value0
array_name[1]=value1
array_name[2]=value2
```

### è¯»å–æ•°ç»„æ•°æ®

1. è·å–æŒ‡å®šå…ƒç´   
   `${array_name[index]}`
2. è·å–å…¨éƒ¨å…ƒç´   
   `${array_name[*]}` æˆ–è€… `${array_name[@]}`

### è·å–æ•°ç»„é•¿åº¦

```shell
length=${#array_name[*]}
# æˆ–è€…
length=${#array_name[@]}
# è·å–æŒ‡å®šå…ƒç´ çš„é•¿åº¦
lengthn=${#array_name[index]}
```

## echo å‘½ä»¤

`echo "\"It is a test\"" --> "It is a test"`

æ˜¾ç¤ºç»“æœé‡å®šå‘è‡³æ–‡ä»¶

`echo "It is a test" > myfile`

åŸæ ·è¾“å‡ºå­—ç¬¦ä¸² ä½¿ç”¨å•å¼•å·

`echo '@name\" '`

æ˜¾ç¤ºå‘½ä»¤æ‰§è¡Œç»“æœ

`echo `date``

## printf å‘½ä»¤ æ ¼å¼åŒ–è¾“å‡ºè¯­å¥

```shell
# format-string ä¸ºåŒå¼•å·
$ printf "%d %s\n" 1 "abc" 1 abc
# å•å¼•å·ä¸åŒå¼•å·æ•ˆæœä¸€æ ·
$ printf '%d %s\n' 1 "abc" 1 abc
# æ²¡æœ‰å¼•å·ä¹Ÿå¯ä»¥è¾“å‡º
$ printf %s abcdef abcdef
# æ ¼å¼åªæŒ‡å®šäº†ä¸€ä¸ªå‚æ•°,ä½†å¤šå‡ºçš„å‚æ•°ä»ç„¶ä¼šæŒ‰ç…§è¯¥æ ¼å¼è¾“å‡º,format-string è¢«é‡ç”¨
$ printf %s abc def abcdef $ printf "%s\n" abc def
abc def $ printf "%s %s %s\n" a b c d e f g h i j abc def ghi j
# å¦‚æœæ²¡æœ‰ arguments,é‚£ä¹ˆ %s ç”¨ NULL ä»£æ›¿,%d ç”¨0ä»£æ›¿
$ printf "%s and %d \n" and 0
# å¦‚æœä»¥ %d çš„æ ¼å¼æ¥æ˜¾ç¤ºå­—ç¬¦ä¸²,é‚£ä¹ˆä¼šæœ‰è­¦å‘Š,æç¤ºæ— æ•ˆçš„æ•°å­—,æ­¤æ—¶é»˜è®¤ç½®ä¸º0
$ printf "The first program always prints'%s,%d\n'" Hello Shell -bash: printf: Shell: invalid number The first program always prints 'Hello,0' $
```

## if else è¯­å¥

### if .. eles

```shell
if [ expression ]
then
    do something
if
```

### if .. else .. fi

```shell
if [ expression ]
then
Statement(s) to be executed if expression is true else
Statement(s) to be executed if expression is not true fi
```

### if .. elif .. fi

```shell
if [ expression 1 ]
then
    Statement(s) to be executed if expression 1 is true
elif [ expression 2 ]
then
    Statement(s) to be executed if expression 2 is true
elif [ expression 3 ]
then
    Statement(s) to be executed if expression 3 is true
else
    Statement(s) to be executed if no expression is true
fi
```

## shell case esac (switch case)

```shell
case å€¼ in
æ¨¡å¼1)
 command1
 command2
 command3
 ;;
æ¨¡å¼2)
 command1
 command2
 command3
 ;;
*)
 command1
 command2
 command3
 ;;
esac
```

tomcat å‘½ä»¤

```shell
#!/bin/bash
# $0 ä»£è¡¨ sh æ–‡ä»¶å
# $1 ç¬¬ä¸€ä¸ªå‚æ•° å¦‚æœä¸º start åˆ™
case $1 in
start)
sh /Library/Tomcat/bin/startup.sh
;;
stop)
sh /Library/Tomcat/bin/shutdown.sh
;;
restart)
sh /Library/Tomcat/bin/shutdown.sh
sh /Library/Tomcat/bin/startup.sh
;;
*)
echo â€œUsage: start|stop|restartâ€
;;
esac
exit 0
```

## shell for

```shell
for å˜é‡ in åˆ—è¡¨
do
    command1
    command2
    ...
done
```

åˆ—è¡¨å¯ä»¥æ˜¯ä¸€ç»„å€¼ (æ•°å­— å­—ç¬¦ä¸²ç­‰) ç»„æˆçš„åºåˆ—,å››é€šç©ºæ ¼åˆ†éš”

## shell while

```shell
while command
do
    Statement(s) to be executed if command is true
done
```

```shell
COUNTER=0
while [ $COUNTER -lt 5 ]
do
    COUNTER='expr $COUNTER+1'
    echo $COUNTER
done
```

```shell
# å°†ä»é”®ç›˜è¯»åˆ°çš„å€¼ç»™ FILM
while read FILM
do
    echo "Yeah! great film the $FILM"
done
```

## shell until å¾ªç¯

ä¸ while ç›¸å

```shell
until command
do
    Statement(s) to be executed until command is true
done
```

## shell break å’Œ continue

```shell
#!/bin/bash

while :
do
    echo -n "Input a number between 1 to 5: "
    read aNum
    case $aNum
        in 1|2|3|4|5)
            echo "Your number is $aNum!"
        ;;
        *) echo "You do not select a number between 1 to 5, game is over!"
            break
        ;;
    esac
done

# è·³å‡ºç¬¬äºŒå±‚å¾ªç¯ ä»å†…å¾€å¤–æ•°
for var1 in 1 2 3
do
    for var2 in 0 5
    do
        if [ $var1 -eq 2 -a $var2 -eq 0 ]
        then
            break 2
        else
            echo "$var1 $var2"
        fi
    done
done
```

continue ä¸å…¶ä»–è¯­è¨€ä¸€æ ·

## shell ä¸­çš„å‡½æ•°

å…ˆå®šä¹‰ åä½¿ç”¨

```shell
(function) function_name () {
    list of commands
    # å¦‚æœä¸åŠ  return è¯­å¥,é»˜è®¤å°†æœ€åä¸€æ¡å‘½ä»¤çš„ç»“æœä½œä¸ºè¿”å›å€¼
    [ return value ]
}
```

```shell
#!/bin/bash

funWithReturn(){
    echo "The function is to get the sum of two numbers..."
    echo -n "Input first number: "
    read aNum
    echo -n "Input another number: "
    read anotherNum
    echo "The two numbers are $aNum and $anotherNum !"
    return $(($aNum+$anotherNum))

}

funWithReturn
# Capture value returnd by last command

ret=$1
echo "The sum of two numbers is $ret !"
```

åˆ é™¤å‡½æ•°

`unset.f function_name`

å¦‚æœä½ å¸Œæœ›ç›´æ¥ä»ç»ˆç«¯è°ƒç”¨å‡½æ•°,å¯ä»¥å°†å‡½æ•°å®šä¹‰åœ¨ä¸»ç›®å½•ä¸‹çš„ .profile æ–‡ä»¶,è¿™æ ·æ¯æ¬¡ç™»å½•å,åœ¨å‘½ä»¤æç¤ºç¬¦ åé¢è¾“å…¥å‡½æ•°åå­—å°±å¯ä»¥ç«‹å³è°ƒç”¨ã€‚

## shell å‡½æ•°å‚æ•°

åœ¨ Shell ä¸­,è°ƒç”¨å‡½æ•°æ—¶å¯ä»¥å‘å…¶ä¼ é€’å‚æ•°ã€‚åœ¨å‡½æ•°ä½“å†…éƒ¨,é€šè¿‡ $n çš„å½¢å¼æ¥è·å–å‚æ•°çš„å€¼,ä¾‹å¦‚,$1 è¡¨ç¤ºç¬¬ ä¸€ä¸ªå‚æ•°,$2 è¡¨ç¤ºç¬¬äºŒä¸ªå‚æ•°â€¦

```shell
#!/bin/bash

funWithParam(){
    echo "The value of the first parameter is $1 !"
    echo "The value of the second parameter is $2 !"
    echo "The value of the tenth parameter is $10 !"
    echo "The value of the tenth parameter is ${10} !"
    echo "The value of the eleventh parameter is ${11} !"
    echo "The amount of the parameters is $# !" # å‚æ•°ä¸ªæ•°
    echo "The string of the parameters is $* !" # ä¼ é€’ç»™å‡½æ•°çš„æ‰€æœ‰å‚æ•°

}

funWithParam 2 2 3 4 5 6 7 8 9 34 73

```

æ³¨æ„,$10 ä¸èƒ½è·å–ç¬¬åä¸ªå‚æ•°,è·å–ç¬¬åä¸ªå‚æ•°éœ€è¦ ${10}ã€‚å½“ n>=10 æ—¶,éœ€è¦ä½¿ç”¨ ${n} æ¥è·å–å‚æ•°ã€‚

```
$#  ä¼ é€’ç»™å‡½æ•°çš„å‚æ•°ä¸ªæ•°ã€‚
$_  æ˜¾ç¤ºæ‰€æœ‰ä¼ é€’ç»™å‡½æ•°çš„å‚æ•°ã€‚
$@  ä¸ $_ ç›¸åŒ,ä½†æ˜¯ç•¥æœ‰åŒºåˆ«,è¯·æŸ¥çœ‹ Shell ç‰¹æ®Šå˜é‡ã€‚
$?  å‡½æ•°çš„è¿”å›å€¼ã€‚
```

## shell è¾“å‡ºé‡å®šå‘ /dev/null

Unix å‘½ä»¤é»˜è®¤ä»æ ‡å‡†è¾“å…¥è®¾å¤‡ (stdin) è·å–è¾“å…¥,å°†ç»“æœè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºè®¾å¤‡ (stdout) æ˜¾ç¤ºã€‚ä¸€èˆ¬æƒ…å†µä¸‹,æ ‡å‡†è¾“ å…¥è®¾å¤‡å°±æ˜¯é”®ç›˜,æ ‡å‡†è¾“å‡ºè®¾å¤‡å°±æ˜¯ç»ˆç«¯,å³æ˜¾ç¤ºå™¨ã€‚

`>` filename  
é‡å®šå‘åˆ°æ–‡ä»¶

`>>` filename  
è¿½åŠ å†…å®¹åˆ°æ–‡ä»¶

`<` filename  
ä»æ–‡ä»¶è·å–è¾“å…¥

command > file

å°†è¾“å‡ºé‡å®šå‘åˆ° fileã€‚

command < file

å°†è¾“å…¥é‡å®šå‘åˆ° fileã€‚

command >> file

å°†è¾“å‡ºä»¥è¿½åŠ çš„æ–¹å¼é‡å®šå‘åˆ° fileã€‚

n > file

å°†æ–‡ä»¶æè¿°ç¬¦ä¸º n çš„æ–‡ä»¶é‡å®šå‘åˆ° fileã€‚

n >> file

å°†æ–‡ä»¶æè¿°ç¬¦ä¸º n çš„æ–‡ä»¶ä»¥è¿½åŠ çš„æ–¹å¼é‡å®šå‘åˆ° fileã€‚

n >& m

å°†è¾“å‡ºæ–‡ä»¶ m å’Œ n åˆå¹¶ã€‚

n <& m

å°†è¾“å…¥æ–‡ä»¶ m å’Œ n åˆå¹¶ã€‚

<< tag

å°†å¼€å§‹æ ‡è®° tag å’Œç»“æŸæ ‡è®° tag ä¹‹é—´çš„å†…å®¹ä½œä¸ºè¾“å…¥ã€‚

## shell here document

```shell
command << delimiter
    document
delimiter
```

```shell
#!/bin/sh

filename=test.txt
vi $filename <<EndOfCommands
i
This file was created automatically
from a shell script
^[
ZZ
EndOfCommands
```

$ command > /dev/null  
/dev/null æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶,å†™å…¥åˆ°å®ƒçš„å†…å®¹éƒ½ä¼šè¢«ä¸¢å¼ƒ; å¦‚æœå°è¯•ä»è¯¥æ–‡ä»¶è¯»å–å†…å®¹,é‚£ä¹ˆä»€ä¹ˆä¹Ÿè¯»ä¸åˆ°ã€‚ä½† æ˜¯ /dev/null æ–‡ä»¶éå¸¸æœ‰ç”¨,å°†å‘½ä»¤çš„è¾“å‡ºé‡å®šå‘åˆ°å®ƒ,ä¼šèµ·åˆ°â€ç¦æ­¢è¾“å‡ºâ€œçš„æ•ˆæœã€‚

## shell åŒ…å«å…¶ä»– sh æ–‡ä»¶

åƒå…¶ä»–è¯­è¨€ä¸€æ ·,Shell ä¹Ÿå¯ä»¥åŒ…å«å¤–éƒ¨è„šæœ¬,å°†å¤–éƒ¨è„šæœ¬çš„å†…å®¹åˆå¹¶åˆ°å½“å‰è„šæœ¬ã€‚

```shell
# sub.sh
my_name = "dong4j"

# main.sh
. sub.sh
echo $my_name
```

æ³¨æ„: è¢«åŒ…å«è„šæœ¬ä¸éœ€è¦æœ‰æ‰§è¡Œæƒé™ã€‚

## [Web appå¼€å‘ï¼šæˆæœ¬ä¸ä½“éªŒçš„æƒè¡¡ä¹‹é“](https://blog.dong4j.site/posts/390ff665.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

æœ€è¿‘åœ¨åšä¸€ä¸ªç¤¾äº¤åŒ–çš„åœ¨çº¿å•†åº—, æœ‰ Android å’Œ iOS å®¢æˆ·ç«¯, åå°ä½¿ç”¨ java, æˆ‘ä¸»è¦è´Ÿè´£æ¥å£è®¾è®¡å’Œå®ç°.
ç›®å‰äº§å“å·²ç»ä¸Šçº¿, ç°åœ¨ä¸»è¦æ˜¯å‰ç«¯çš„ä¸šåŠ¡æµç¨‹ä¼˜åŒ–, åå°çš„ä¼˜åŒ–å’Œéœ€æ±‚æ›´æ”¹. å®¢æˆ·ç«¯ä½¿ç”¨ Web app + Native app çš„å½¢å¼.
å¯¹äºèœé¸Ÿçº§æˆ‘çš„æ¥è¯´, ä»¥å‰çš„å°é¡¹ç›®éƒ½æ˜¯ 10 å¤šå¼ è¡¨å°±æå®šäº†, ç°åœ¨è¿™ä¸ªé¡¹ç›®æœ‰ 170 å¤šå¼ è¡¨, æƒ³æ¥è¦å®Œå…¨ç†Ÿæ‚‰å…¨éƒ¨çš„ä¸šåŠ¡æµç¨‹éœ€è¦èŠ±å†™åŠŸå¤«äº†.
ä»¥å‰éƒ½æ˜¯å†™çš„ Java Web é¡¹ç›®, ç°åœ¨ä¸€ä¸‹æ¥å†™ Web app é¡¹ç›®æœ‰ç‚¹ä¸ä¹ æƒ¯, ä¸»è¦æ˜¯æµ‹è¯•æœ‰ç‚¹éº»çƒ¦. æ¥ä¸‹æ¥, æˆ‘å°†å†™å†™æ¥å¯¹é¡¹ç›®çš„æ€»ä½“è®¤è¯†ä»¥åŠ Web app å¼€å‘å’Œ Java Web å¼€å‘çš„åŒºåˆ« (å…¶å®ä¹Ÿæ²¡å¤šå¤§åŒºåˆ«), ç®—æ˜¯åšä¸€ä¸ªæ€»ç»“å§.

### Web app å’Œ Native app çš„åŒºåˆ«

**Native Appï¼š**

1. å¼€å‘æˆæœ¬éå¸¸å¤§ã€‚ä¸€èˆ¬ä½¿ç”¨çš„å¼€å‘è¯­è¨€ä¸º Javaã€C++ã€Objective-Cã€‚
2. æ›´æ–°ä½“éªŒè¾ƒå·®ã€åŒæ—¶ä¹Ÿæ¯”è¾ƒéº»çƒ¦ã€‚æ¯ä¸€æ¬¡å‘å¸ƒæ–°çš„ç‰ˆæœ¬ï¼Œéƒ½éœ€è¦åšç‰ˆæœ¬æ‰“åŒ…ï¼Œä¸”éœ€è¦ç”¨æˆ·æ‰‹åŠ¨æ›´æ–°ï¼ˆæœ‰äº›åº”ç”¨ç¨‹åºå³ä½¿ä¸éœ€è¦ç”¨æˆ·æ‰‹åŠ¨æ›´æ–°ï¼Œä½†æ˜¯ä¹Ÿéœ€è¦æœ‰ä¸€ä¸ªæ¶å¿ƒçš„æç¤ºï¼‰ã€‚
3. éå¸¸é…·ã€‚å› ä¸º Native app å¯ä»¥è°ƒç”¨ iOS ä¸­çš„ UI æ§ä»¶ä»¥ UI æ–¹æ³•ï¼Œå®ƒå¯ä»¥å®ç° Web app æ— æ³•å®ç°çš„ä¸€äº›éå¸¸é…·çš„äº¤äº’æ•ˆæœã€‚
4. Native app æ˜¯è¢« Apple è®¤å¯çš„ã€‚Native app å¯ä»¥è¢« Apple è®¤å¯ä¸ºä¸€æ¬¾å¯ä¿¡ä»»çš„ç‹¬ç«‹è½¯ä»¶ï¼Œå¯ä»¥æ”¾åœ¨ Apple Stroe å‡ºå”®ï¼Œä½†æ˜¯ Web app å´ä¸è¡Œã€‚

**Web Appï¼š**

1. å¼€å‘æˆæœ¬è¾ƒä½ã€‚ä½¿ç”¨ Web å¼€å‘æŠ€æœ¯å°±å¯ä»¥è½»æ¾çš„å®Œæˆ Web app çš„å¼€å‘ã€‚
2. å‡çº§è¾ƒç®€å•ã€‚å‡çº§ä¸éœ€è¦é€šçŸ¥ç”¨æˆ·ï¼Œåœ¨æœåŠ¡ç«¯æ›´æ–°æ–‡ä»¶å³å¯ï¼Œç”¨æˆ·å®Œå…¨æ²¡æœ‰æ„Ÿè§‰ã€‚
3. ç»´æŠ¤æ¯”è¾ƒè½»æ¾ã€‚å’Œä¸€èˆ¬çš„ Web ä¸€æ ·ï¼Œç»´æŠ¤æ¯”è¾ƒç®€å•ï¼Œå®ƒå…¶å®å°±æ˜¯ä¸€ä¸ªç«™ç‚¹ã€‚

Web app è¯´ç™½äº†å°±æ˜¯ä¸€ä¸ªé’ˆå¯¹ iPhoneã€Android ä¼˜åŒ–åçš„ Web ç«™ç‚¹ï¼Œå®ƒä½¿ç”¨çš„æŠ€æœ¯æ— éå°±æ˜¯ HTML æˆ– HTML5ã€CSS3ã€JavaScriptï¼ŒæœåŠ¡ç«¯æŠ€æœ¯ Javaã€PHPã€ASPã€‚

è¯´åˆ°è¿™é‡Œ, æˆ‘æ›¾ç»æƒ³è¿‡, ä¸ºä»€ä¹ˆä¸ç›´æ¥å†™ä¸€ä¸ª Java Web é¡¹ç›®, ç„¶ååšä¸€ä¸ª Web app ç›´æ¥è®¿é—®è¿™ä¸ªç½‘ç«™, åªè¦ç½‘ç«™æ˜¯å“åº”å¼çš„, è¿™æ ·å°±ä¸éœ€è¦åšå¤šå°‘æ›´æ”¹è®©æ‰‹æœºå’Œ PC éƒ½èƒ½ä»¥è¾ƒå¥½çš„æ–¹å¼è®¿é—®, ä¸ç”¨é’ˆå¯¹æ‰‹æœºç‰¹å®šæ¥å¼€å‘ä¸€æ¬¾ app.  
ä½†æ˜¯æŸ¥äº†ä¸‹èµ„æ–™, è¿™ç§æ–¹å¼æœ‰å¾ˆå¤šå¼Šç«¯:

1. æœ€æœ€é‡è¦çš„ä¸€ç‚¹, è¿™ç§ app å…¶å®å°±æ˜¯ä¸€ä¸ªæµè§ˆå™¨, è™½ç„¶å¼€å‘é€Ÿåº¦å¿«, ä½†æ˜¯ä¸å¯èƒ½é€šè¿‡ AppStore çš„å®¡æ ¸, å›½å†…å‡ ä¸ªè¾ƒå¤§çš„ Android å¸‚åœºä¹Ÿé€šè¿‡ä¸äº†;
2. åš app å°±æ˜¯åšè‰¯å¿ƒ, ç»™äººä»¥æœ€å¥½çš„ç”¨æˆ·ä½“éªŒ, å¦‚æœç½‘ç»œç¯å¢ƒä¸ä½³çš„è¯, å°±æ˜¯ä¸€ä¸ªå¤§ç™½é¡µ, ç”¨æˆ·ä½“éªŒå€¼ä¸º 0;
3. å› ä¸º CSS å’Œ JS èµ„æºä¸åœ¨æœ¬åœ°, éœ€è¦è¿œç¨‹è½½å…¥, å¦‚æœä½¿ç”¨æ¯”è¾ƒå¤§çš„å‰ç«¯æ¡†æ¶, å¦‚ bootstrap ä¹‹ç±»æ—¶, åŠ ä¸Šç°åœ¨ 4G çš„æ™®åŠ, ç”¨æˆ·ä½¿ç”¨ app é€›ä¸‹å•†åŸ, ä¹°ä¹°ä¸œè¥¿, ä¸€å¥—æˆ¿å­å°±æ²¡ç”¨äº†â€¦.
4. åœ¨ç½‘é¡µä¸­ç»å¸¸ä½¿ç”¨çš„ jQuery æ¡†æ¶åœ¨ webview é‡Œçš„é€Ÿåº¦å¹¶ä¸ç†æƒ³, å†å¦‚æœä¸æ˜¯ ajax çš„ç½‘é¡µè¯·æ±‚, æ¯æ¬¡æ“ä½œéƒ½è¦æ¡æŠ“å’Œç½‘é¡µæ¸²æŸ“, æƒ³æƒ³æˆ‘ä¹Ÿæ˜¯é†‰äº†.

æ‰€ä»¥è¯´ä¸ºäº†å°½å¿«ä¸Šçº¿è€Œä¸ç®¡ç”¨æˆ·ä½“éªŒçš„è€æ¿éƒ½ä¸æ˜¯å¸æœº. æˆ‘ä»¬å…¬å¸çš„è€æ¿è¿˜è¡Œ, æ²¡ç”¨ä½¿ç”¨è¿™ç§æ–¹å¼, è€Œæ˜¯ä½¿ç”¨ Hrbird app(è€æ¿å£°éŸ³æœ‰ç‚¹åƒæ°æ£® Â· æ–¯å¦æ£®, ä¸çŸ¥é“æ˜¯ä¸æ˜¯å—¨æ­Œå—¨åˆ°å—“å­å“‘äº†â€¦.)

### Java Web ä¸ Web app æ•°æ®äº¤äº’çš„åŒºåˆ«

å¯¹äº Java Web å¼€å‘, å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚, ç»™ä¸Šä¸€äº›å‚æ•°, ç„¶åæŸ¥è¯¢æ•°æ®åº“, è¿”å›æ•°æ®åˆ°å‰å°, è¿™ä¸ªæµç¨‹ä¹ŸåŒæ ·é€‚ç”¨äº Web app, åªæ˜¯ Web app æ›´å¤šçš„æ˜¯ç›´æ¥è¿”å› json æ ¼å¼çš„æ•°æ®.  
æˆ‘ä»¬å¸¸è¯´çš„ app æ¥å£å¼€å‘, å¯¹äºåˆå­¦è€…, å¯èƒ½ä¸€ä¸‹å°±æƒ³åˆ°äº† interface(å…¶å®æˆ‘ä¹Ÿæ˜¯è¿™ä¹ˆæƒ³çš„), ä½†æ˜¯è¿™æ˜¯ä¸å‡†ç¡®çš„.  
æ¯”å¦‚ç°åœ¨æˆ‘è´Ÿè´£çš„æ¥å£å¼€å‘, æ˜¯è¦è´Ÿè´£ä» Controller åˆ° Service åˆ°æ•°æ®åº“æœ€åè¿”å› json æ•°æ®è¿™ä¹ˆä¸€æ•´æ¡æµç¨‹çš„å¼€å‘. å½“ç”¨æˆ·ç‚¹å‡» app ä¸Šä¸€ä¸ªæŒ‰é’®æˆ–è€…æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯æ—¶, app ä¼šè°ƒç”¨æˆ‘ä»¬å†™å¥½çš„æ¥å£ (å…¶å®è¯´ç™½äº†å°±æ˜¯ä¸€ URL), ç„¶åç»è¿‡ DispatcherServlet æ ¹æ® URL è°ƒç”¨ç‰¹å®šçš„ Controller è¿›è¡Œå¤„ç†, æœ€åè¿”å› json æ•°æ®ç»™ app.

**ä¸¾ä¸ªæœ€ç®€å•çš„ä¾‹å­, ç”¨æˆ·ç™»å½•.**  
ä¸€ä¸ª web ç³»ç»Ÿ, ç”¨æˆ·é€šè¿‡æµè§ˆå™¨æŠŠç”¨æˆ·åå¯†ç ä¼ é€’åˆ° web æœåŠ¡ç«¯, ä¹Ÿå°±æ˜¯åå°, é‚£ä¹ˆè¿™é‡Œå°±æœ‰ä¸ª URL æ¯”å¦‚å« `XXX\user\login.action?userid=zhangsan&pwd=123`
ç„¶åä½ åå°å°±èƒ½è·å–åˆ° userid å’Œ pwd ç„¶åå°±èƒ½è¿”å›ç»™æµè§ˆå™¨æˆåŠŸä¸å¦.  
åŒæ ·çš„é“ç†,  
app è°ƒç”¨ `XXX\user\login.action?userid=zhangsan&pwd=123`  
ä½ åå°ä¸€æ ·èƒ½è·å–åˆ° userid å’Œ pwd é‚£ä¹ˆä½ å°±å¯ä»¥ç»™å®‰å“ APP è¿”å›ä¿¡æ¯å‘Šè¯‰ä»–ç™»å½•æˆåŠŸä¸å¦.  
æ‰€ä»¥è¿™é‡Œæ‰€è°“çš„æ¥å£, å°±æ˜¯ä¸€ä¸ª URL ,

æ¥å£è¿”å› json æˆ– xml å°±å¯ä»¥äº†ï¼Œç„¶åä½ å¼€å‘çš„å½“ç„¶æ˜¯çŸ¥é“æ¥å£çš„ url äº†ï¼Œè¿˜æœ‰æ¥å£çš„ä¼ å‚ï¼Œè¿™æ ·å°±å¯ä»¥è®©å‰ç«¯è°ƒç”¨äº†ã€‚  
å‘Šè¯‰å‰ç«¯ï¼Œä½ çš„ url åœ°å€ï¼Œéœ€è¦ç»™è¿™ä¸ªæ¥å£ä¼ ä»€ä¹ˆå‚æ•°ï¼Œè¿”å›å‚æ•°æ˜¯ä»€ä¹ˆï¼ˆè¿”å›ä»–ä»¬å¯ä»¥æµ‹è¯•å¾—åˆ°ï¼Œä¸è¿‡æœ€å¥½è¿˜æ˜¯å…ˆå‘Šè¯‰ä»–ä»¬ï¼‰ï¼Œå­—æ®µè¯´æ˜ï¼Œè¿™æ ·å°±å¯ä»¥äº¤äº’äº†.

### è¯´è¯´å®¢æˆ·ç«¯çš„ç™»å½•

æ¥å…¬å¸çš„ç¬¬ä¸€å¤©å°±çœ‹çš„å®ç°ç™»å½•çš„ä»£ç , ä¸ Java web æœ€å¤§çš„åŒºåˆ«å°±æ˜¯ä¸€èˆ¬ web æ˜¯ä½¿ç”¨ session éªŒè¯ç™»å½•çŠ¶æ€ï¼Œè€Œ app åˆ™ä½¿ç”¨ token æ¥éªŒè¯ç™»å½•çŠ¶æ€ï¼ˆtoken æ˜¯è‡ªå·±å®šä¹‰çš„ä¸€ä¸ªå’Œç”¨æˆ· ID ç›¸å…³çš„åŠ å¯†å­—ç¬¦ä¸²ï¼Œä¼ å…¥åå°åä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼‰ã€‚è¿˜æœ‰å¦‚æœå¯¹å®‰å…¨æ€§è¦æ±‚è¾ƒé«˜ï¼Œapp ä¼ è¾“æ•°æ®æ—¶å¯èƒ½ä¼šå¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ï¼Œè€Œ web ä¸€èˆ¬æ²¡æœ‰è¿™ä¸€æ­¥ï¼Œweb çš„åŠ å¯†ä¸€èˆ¬æ˜¯ä½¿ç”¨ httpsã€‚

#### ä¸å®‰å…¨çš„æ–¹å¼

**åœ¨ app ä¸­ä¿å­˜ç™»å½•æ•°æ®, æ¯æ¬¡è°ƒç”¨æ¥å£æ—¶ä¼ è¾“**  
ä¸ºäº†å·æ‡’, ç¨‹åºå‘˜ä»€ä¹ˆéƒ½å¹²å¾—å‡ºæ¥. åœ¨ç”¨æˆ·ç™»å½•ä¹‹å, ç›´æ¥æŠŠç”¨æˆ·åå’Œå¯†ç ä¿å­˜åœ¨æœ¬åœ°, ç„¶åæ¯æ¬¡è°ƒç”¨åç«¯æ¥å£æ—¶ä½œä¸ºå‚æ•°ä¼ é€’, ä½†æ˜¯è¿™ç§æ–¹å¼åŠå…¶ä¸å®‰å…¨, éšä¾¿é‚£ä¸ªå—…æ¢å™¨å°±å¯ä»¥æŠŠç”¨æˆ·åå¯†ç å¼„åˆ°æ‰‹, å¦‚æœç”¨æˆ·ä¹ æƒ¯æ‰€æœ‰çš„åœ°æ–¹éƒ½ä½¿ç”¨åŒä¸€ç”¨æˆ·åå’Œå¯†ç , é‚£ä¹ˆé»‘å®¢é€šè¿‡æ’åº“çš„æ–¹å¼èƒ½æŠŠç”¨æˆ·çš„æ‰€æœ‰ä¿¡æ¯ä¸€é”…ç«¯ (è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸è¦ä½¿ç”¨å…¬å…±åœºåˆçš„ wifi).

#### å®‰å…¨çš„ç™»å½•æ–¹å¼

**ç™»å½•æ—¶è¯·æ±‚ä¸€æ¬¡ token, ä¹‹åç”¨ token è°ƒç”¨æ¥å£ (å…¬å¸å°±æ˜¯è¿™ä¹ˆæçš„)**  
å¤§ä½“çš„æµç¨‹:

1. ç”¨æˆ·è¾“å…¥ç”µè¯å·ç å’Œå¯†ç 
2. åœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢æœ‰æ— æ­¤ç”µè¯å·ç , æ²¡æœ‰åˆ™æç¤ºé”™è¯¯; æœ‰åˆ™å†éªŒè¯å¯†ç æ˜¯å¦æ­£ç¡®;
3. å¦‚æœç™»å½•æˆåŠŸ, è°ƒç”¨ api ç”Ÿæˆ token(ä½¿ç”¨ Base64 åŠ å¯†, ä½¿ç”¨ URLEncoder è§£å†³ä¸­æ–‡å‚æ•°é—®é¢˜) ;
4. å°† key = å®¢æˆ· ID,value=token æ”¾å…¥ redis ç¼“å­˜
5. è¿”å›å®¢æˆ·ä¿¡æ¯

ä»¥åç”¨æˆ·è¯·æ±‚æ—¶, éƒ½ä¼šå¸¦ä¸Š token è¿™ä¸ªå‚æ•°, å½“ token è¿‡æ—¶åå°†è·³è½¬åˆ°ç™»å½•ç•Œé¢é‡æ–°ç™»å½•

### é‡åˆ°çš„é—®é¢˜

#### åœ¨ windows ä¸‹æ­å»º redis æœåŠ¡å™¨

é¡¹ç›®ä¸­ç”¨åˆ°äº† redis ä½œç”¨ç¼“å­˜æœåŠ¡å™¨, ä»¥å‰ä»æ¥æ²¡æœ‰ä½¿ç”¨è¿‡, æ‰€ä»¥å­¦ä¹ äº†ä¸‹è½½ windows ä¸‹æ­å»º redis æœåŠ¡å™¨.  
redis æ˜¯ä¸€ä¸ªå¼€æºçš„ã€ä½¿ç”¨ C è¯­è¨€ç¼–å†™çš„ã€æ”¯æŒç½‘ç»œäº¤äº’çš„ã€å¯åŸºäºå†…å­˜ä¹Ÿå¯æŒä¹…åŒ–çš„ Key-Value æ•°æ®åº“ã€‚è¿™é‡Œå°±ä¸åšè¿‡å¤šä»‹ç»äº†, æœ‰å…´è¶£å¯ä»¥å»ç™¾åº¦ä¸€ä¸‹.

ç”±äº Redis å®˜ç½‘ä¸æ”¯æŒ windows çš„, åªæ˜¯ Microsoft Open Tech group åœ¨ GitHub ä¸Šå¼€å‘äº†ä¸€ä¸ª Win64 çš„ç‰ˆæœ¬, é¡¹ç›®åœ°å€æ˜¯ï¼š  
[https://github.com/MSOpenTech/redis](https://github.com/MSOpenTech/redis)

æ‰“å¼€ä»¥åï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨æµè§ˆå™¨ä¸‹è½½ï¼Œæˆ–è€… git å…‹éš†ã€‚  
å¯ä»¥åœ¨é¡¹ç›®ä¸»é¡µå³è¾¹æ‰¾åˆ° zip åŒ…ä¸‹è½½  
ä¸‹è½½è§£å‹ï¼Œæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œåœ¨è§£å‹åçš„ bin ç›®å½•ä¸‹æœ‰ä»¥ä¸‹è¿™äº›æ–‡ä»¶ï¼š

```
redis-benchmark.exe         #åŸºå‡†æµ‹è¯•
redis-check-aof.exe         # aof
redis-check-dump.exe        # dump
redis-cli.exe               # å®¢æˆ·ç«¯
redis-server.exe            # æœåŠ¡å™¨
redis.windows.conf          # é…ç½®æ–‡ä»¶
```

å¯åŠ¨æœåŠ¡å™¨å‘½ä»¤: redis-server redis.windows.conf  
å¯ä»¥å†™ä¸€ä¸ªæ‰¹å¤„ç†å‘½ä»¤, ä»¥åç›´æ¥åŒå‡»å¯åŠ¨, å…³é—­ cmd çª—å£å°±å…³é—­äº†æœåŠ¡å™¨

æˆ‘ç¬¬ä¸€æ¬¡å¯åŠ¨æŠ¥é”™äº†

> redis-server.exe redis.windows.conf  
> [7736] 10 Aug 21:39:42.974 #  
> The Windows version of Redis allocates a large memory mapped file for sharing  
> the heap with the forked process used in persistence operations. This file  
> will be created in the current working directory or the directory specified by  
> the â€˜dirâ€™ directive in the .conf file. Windows is reporting that there is  
> insufficient disk space available for this file (Windows error 0x70).
>
> You may fix this problem by either reducing the size of the Redis heap with  
> the â€“maxheap flag, or by starting redis from a working directory with  
> sufficient space available for the Redis heap.
>
> Please see the documentation included with the binary distributions for more  
> details on the â€“maxheap flag.
>
> Redis can not continue. Exiting.

æ ¹æ®æç¤ºï¼Œæ˜¯ maxheap æ ‡è¯†æœ‰é—®é¢˜, æ‰“å¼€é…ç½®æ–‡ä»¶ redis.windows.conf , æœç´¢ maxheap , ç„¶åç›´æ¥æŒ‡å®šå¥½å†…å®¹å³å¯.

```
.......
#
# maxheap <bytes>
maxheap 1024000000
.......
```

å†æ¬¡å¯åŠ¨æœåŠ¡å™¨  
![20241229154732_5mnRTEhd.webp](https://cdn.dong4j.site/source/image/20241229154732_5mnRTEhd.webp)

ç„¶åä½¿ç”¨è‡ªå¸¦çš„å®¢æˆ·ç«¯å·¥å…·è¿›è¡Œæµ‹è¯•  
![20241229154732_mA8ER0ZT.webp](https://cdn.dong4j.site/source/image/20241229154732_mA8ER0ZT.webp)

æˆåŠŸäº†, ç©å„¿å»å§

#### svn ç‰ˆæœ¬æ§åˆ¶é—®é¢˜

æ•´ä¸ªå·¥ç¨‹ä½¿ç”¨ Maven, å¹¶ä½¿ç”¨ svn è¿›è¡Œç‰ˆæœ¬æ§åˆ¶, ä½†æ˜¯å½“å¯¼å…¥å·¥ç¨‹æ—¶æŠ¥ svn é”™è¯¯, å¼€å§‹æ€€ç–‘é…ç½®ä¸æ­£ç¡®, è¿›å…¥ intellij çš„ svn è®¾ç½®, å»æ‰æ‰€æœ‰çš„å¤é€‰æ¡†  
![20241229154732_baVEVepE.webp](https://cdn.dong4j.site/source/image/20241229154732_baVEVepE.webp)

è¿˜æ˜¯æŠ¥é”™, æŸ¥è¯¢èµ„æ–™åå‘ç° 1.8 ä½¿ç”¨äº†å‘½ä»¤å·¥å…·ï¼ˆcommand line client toolsï¼‰é»˜è®¤å®‰è£… SVN æ—¶æ˜¯æœªå®‰è£…æ­¤å®¢æˆ·ç«¯çš„ã€‚  
![20241229154732_8P0pRg2X.webp](https://cdn.dong4j.site/source/image/20241229154732_8P0pRg2X.webp)

é‡æ–°å®‰è£…ä¹Œé¾Ÿ, ç„¶åæŠŠå‘½ä»¤å·¥å…·é€‰ä¸Š, svn é…ç½®ä¸å˜, éƒ½ä¸å‹¾é€‰, ç„¶åé‡å¯ IDEA å°±å¯ä»¥äº†.

## [JDKç‰ˆæœ¬å·®å¼‚åˆ†æï¼šæ–¹æ³•åŒºå’Œè¿è¡Œæ—¶å¸¸é‡æ± çš„æ¼”å˜](https://blog.dong4j.site/posts/27c94bc.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

## ç›¸å…³ç‰¹å¾

### æ–¹æ³•åŒºç‰¹å¾

- åŒ Java å †ä¸€æ ·ï¼Œæ–¹æ³•åŒºä¹Ÿæ˜¯å…¨å±€å…±äº«çš„ä¸€å—å†…å­˜åŒºåŸŸ
- æ–¹æ³•åŒºçš„ä½œç”¨æ˜¯å­˜å‚¨ Java ç±»çš„ç»“æ„ä¿¡æ¯ï¼Œå½“æˆ‘ä»¬åˆ›å»ºå¯¹è±¡å®ä¾‹åï¼Œ **å¯¹è±¡çš„ç±»å‹ä¿¡æ¯å­˜å‚¨åœ¨æ–¹æ³•å †ä¹‹ä¸­ï¼Œå®ä¾‹æ•°æ®å­˜æ”¾åœ¨å †ä¸­ï¼›å®ä¾‹æ•°æ®æŒ‡çš„æ˜¯åœ¨ Java ä¸­åˆ›å»ºçš„å„ç§å®ä¾‹å¯¹è±¡ä»¥åŠå®ƒä»¬çš„å€¼ï¼Œç±»å‹ä¿¡æ¯æŒ‡çš„æ˜¯å®šä¹‰åœ¨ Java ä»£ç ä¸­çš„å¸¸é‡ã€é™æ€å˜é‡ã€ä»¥åŠåœ¨ç±»ä¸­å£°æ˜çš„å„ç§æ–¹æ³•ã€æ–¹æ³•å­—æ®µç­‰ç­‰ï¼›åŒäº‹å¯èƒ½åŒ…æ‹¬å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åäº§ç”Ÿçš„ä»£ç æ•°æ®ã€‚**
- JVMS ä¸è¦æ±‚è¯¥åŒºåŸŸå®ç°è‡ªåŠ¨çš„å†…å­˜ç®¡ç†ï¼Œä½†æ˜¯å•†ç”¨ JVM ä¸€èˆ¬éƒ½å·²å®ç°è¯¥åŒºåŸŸçš„è‡ªåŠ¨å†…å­˜ç®¡ç†ã€‚
- æ–¹æ³•åŒºåˆ†é…å†…å­˜å¯ä»¥ä¸è¿ç»­ï¼Œå¯ä»¥åŠ¨æ€æ‰©å±•ã€‚
- è¯¥åŒºåŸŸå¹¶éåƒ JMM è§„èŒƒæè¿°çš„é‚£æ ·æ•°æ®ä¸€æ—¦æ”¾è¿›å»å°±å±äº â€œæ°¸ä¹…ä»£â€ï¼› **åœ¨è¯¥åŒºåŸŸè¿›è¡Œå†…å­˜å›æ”¶çš„ä¸»è¦ç›®çš„æ˜¯å¯¹å¸¸é‡æ± çš„å›æ”¶å’Œå¯¹å†…å­˜æ•°æ®çš„å¸è½½ï¼›ä¸€èˆ¬æ¥è¯´è¿™ä¸ªåŒºåŸŸçš„å†…å­˜å›æ”¶æ•ˆç‡æ¯”èµ· Java å †è¦ä½å¾—å¤šã€‚**
- å½“æ–¹æ³•åŒºæ— æ³•æ»¡è¶³å†…å­˜éœ€æ±‚æ—¶ï¼Œå°†æŠ›å‡º OutOfMemoryError å¼‚å¸¸ã€‚

### è¿è¡Œæ—¶å¸¸é‡æ± çš„ç‰¹å¾

- **è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ï¼Œ** æ‰€ä»¥ä¹Ÿæ˜¯å…¨å±€å…±äº«çš„ã€‚
- **å…¶ä½œç”¨æ˜¯å­˜å‚¨ Java ç±»æ–‡ä»¶å¸¸é‡æ± ä¸­çš„ç¬¦å·ä¿¡æ¯ã€‚**
- **class æ–‡ä»¶ä¸­å­˜åœ¨å¸¸é‡æ±  (éè¿è¡Œæ—¶å¸¸é‡æ± )ï¼Œå…¶åœ¨ç¼–è¯‘é˜¶æ®µå°±å·²ç»ç¡®å®šï¼›JVM è§„èŒƒå¯¹ class æ–‡ä»¶ç»“æ„æœ‰ç€ä¸¥æ ¼çš„è§„èŒƒï¼Œå¿…é¡»ç¬¦åˆæ­¤è§„èŒƒçš„ class æ–‡ä»¶æ‰ä¼šè¢« JVM è®¤å¯å’Œè£…è½½ã€‚**
- **è¿è¡Œæ—¶å¸¸é‡æ± ** ä¸­ä¿å­˜ç€ä¸€äº› class æ–‡ä»¶ä¸­æè¿°çš„ç¬¦å·å¼•ç”¨ï¼ŒåŒæ—¶è¿˜ä¼šå°†è¿™äº›ç¬¦å·å¼•ç”¨æ‰€ç¿»è¯‘å‡ºæ¥çš„ç›´æ¥å¼•ç”¨å­˜å‚¨åœ¨ **è¿è¡Œæ—¶å¸¸é‡æ± ** ä¸­ã€‚
- **è¿è¡Œæ—¶å¸¸é‡æ± ç›¸å¯¹äº class å¸¸é‡æ± ä¸€å¤§ç‰¹å¾å°±æ˜¯å…¶å…·æœ‰åŠ¨æ€æ€§ï¼ŒJava è§„èŒƒå¹¶ä¸è¦æ±‚å¸¸é‡åªèƒ½åœ¨è¿è¡Œæ—¶æ‰äº§ç”Ÿï¼Œä¹Ÿå°±æ˜¯è¯´è¿è¡Œæ—¶å¸¸é‡æ± ä¸­çš„å†…å®¹å¹¶ä¸å…¨éƒ¨æ¥è‡ª class å¸¸é‡æ± ï¼Œclass å¸¸é‡æ± å¹¶éè¿è¡Œæ—¶å¸¸é‡æ± çš„å”¯ä¸€æ•°æ®è¾“å…¥å£ï¼›åœ¨è¿è¡Œæ—¶å¯ä»¥é€šè¿‡ä»£ç ç”Ÿæˆå¸¸é‡å¹¶å°†å…¶æ”¾å…¥è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ã€‚**
- åŒæ–¹æ³•åŒºä¸€æ ·ï¼Œå½“è¿è¡Œæ—¶å¸¸é‡æ± æ— æ³•ç”³è¯·åˆ°æ–°çš„å†…å­˜æ—¶ï¼Œå°†æŠ›å‡º OutOfMemoryError å¼‚å¸¸ã€‚

## HotSpot æ–¹æ³•åŒºå˜è¿

### JDK1.2 ~ JDK6

åœ¨ JDK1.2 ~ JDK6 çš„å®ç°ä¸­ï¼ŒHotSpot ä½¿ç”¨æ°¸ä¹…ä»£å®ç°æ–¹æ³•åŒºï¼›HotSpot ä½¿ç”¨ GC åˆ†ä»£å®ç°æ–¹æ³•åŒºå¸¦æ¥äº†å¾ˆå¤§ä¾¿åˆ©ï¼›

### JDK7

ç”±äº GC åˆ†ä»£æŠ€æœ¯çš„å½±å“ï¼Œä½¿ä¹‹è®¸å¤šä¼˜ç§€çš„å†…å­˜è°ƒè¯•å·¥å…·æ— æ³•åœ¨ Oracle HotSpot ä¹‹ä¸Šè¿è¡Œï¼Œå¿…é¡»å•ç‹¬å¤„ç†ï¼›å¹¶ä¸” Oracle åŒæ—¶æ”¶è´­äº† BEA å’Œ Sun å…¬å¸ï¼ŒåŒæ—¶æ‹¥æœ‰ JRockit å’Œ HotSpotï¼Œåœ¨å°† JRockit è®¸å¤šä¼˜ç§€ç‰¹æ€§ç§»æ¤åˆ° HotSpot æ—¶ç”±äº GC åˆ†ä»£æŠ€æœ¯é‡åˆ°äº†ç§ç§å›°éš¾ï¼Œ **æ‰€ä»¥ä» JDK7 å¼€å§‹ Oracle HotSpot å¼€å§‹ç§»é™¤æ°¸ä¹…ä»£ã€‚**

**JDK7 ä¸­ç¬¦å·è¡¨è¢«ç§»åŠ¨åˆ° Native Heap ä¸­ï¼Œå­—ç¬¦ä¸²å¸¸é‡å’Œç±»å¼•ç”¨è¢«ç§»åŠ¨åˆ° Java Heap ä¸­ã€‚**

### JDK8

**åœ¨ JDK8 ä¸­ï¼Œæ°¸ä¹…ä»£å·²å®Œå…¨è¢«å…ƒç©ºé—´ (Meatspace) æ‰€å–ä»£ã€‚**

## æ°¸ä¹…ä»£å˜è¿äº§ç”Ÿçš„å½±å“

#### æµ‹è¯•ä»£ç  1

```java
public class Test1 {
    public static void main(String[] args) {
        String s1 = new StringBuilder("æ¼ ").append("ç„¶").toString();
        System.out.println(s1.intern() == s1);
        String s2 = new StringBuilder("æ¼ ").append("ç„¶").toString();
        System.out.println(s2.intern() == s2);
    }
}
```

ä»¥ä¸Šä»£ç ï¼Œåœ¨ JDK6 ä¸‹æ‰§è¡Œç»“æœä¸º falseã€falseï¼Œåœ¨ JDK7 ä»¥ä¸Šæ‰§è¡Œç»“æœä¸º trueã€falseã€‚

**é¦–å…ˆæ˜ç¡®ä¸¤ç‚¹ï¼š**  
1ã€åœ¨ Java ä¸­ç›´æ¥ä½¿ç”¨åŒå¼•å·å±•ç¤ºçš„å­—ç¬¦ä¸²å°†ä¼šåœ¨å¸¸é‡æ± ä¸­ç›´æ¥åˆ›å»ºã€‚  
2ã€String çš„ intern æ–¹æ³•é¦–å…ˆå°†å°è¯•åœ¨å¸¸é‡æ± ä¸­æŸ¥æ‰¾è¯¥å¯¹è±¡ï¼Œå¦‚æœæ‰¾åˆ°åˆ™ç›´æ¥è¿”å›è¯¥å¯¹è±¡åœ¨å¸¸é‡æ± ä¸­çš„åœ°å€ï¼›æ‰¾ä¸åˆ°åˆ™å°†è¯¥å¯¹è±¡æ”¾å…¥å¸¸é‡æ± åå†è¿”å›å…¶åœ°å€ã€‚**JDK6 å¸¸é‡æ± åœ¨æ–¹æ³•åŒºï¼Œé¢‘ç¹è°ƒç”¨è¯¥æ–¹æ³•å¯èƒ½é€ æˆ OutOfMemoryErrorã€‚**

**äº§ç”Ÿä¸¤ç§ç»“æœçš„åŸå› ï¼š**

åœ¨ JDK6 ä¸‹ s1ã€s2 æŒ‡å‘çš„æ˜¯æ–°åˆ›å»ºçš„å¯¹è±¡ï¼Œ **è¯¥å¯¹è±¡å°†åœ¨ Java Heap ä¸­åˆ›å»ºï¼Œæ‰€ä»¥ s1ã€s2 æŒ‡å‘çš„æ˜¯ Java Heap ä¸­çš„å†…å­˜åœ°å€ï¼›** è°ƒç”¨ intern æ–¹æ³•åå°†å°è¯•åœ¨å¸¸é‡æ± ä¸­æŸ¥æ‰¾è¯¥å¯¹è±¡ï¼Œæ²¡æ‰¾åˆ°åå°†å…¶æ”¾å…¥å¸¸é‡æ± å¹¶è¿”å›ï¼Œ **æ‰€ä»¥æ­¤æ—¶ s1/s2.intern() æŒ‡å‘çš„æ˜¯å¸¸é‡æ± ä¸­çš„åœ°å€ï¼ŒJDK6 å¸¸é‡æ± åœ¨æ–¹æ³•åŒºï¼Œä¸å †éš”ç¦»ï¼Œï¼›æ‰€ä»¥ `s1.intern()==s1 è¿”å› false` ã€‚**

#### æµ‹è¯•ä»£ç  2

```java
public class Test2 {
    public static void main(String[] args) {
        /**
         * é¦–å…ˆè®¾ç½® æŒä¹…ä»£æœ€å¤§å’Œæœ€å°å†…å­˜å ç”¨(é™å®šä¸º10M)
         * VM args: -XX:PermSize=10M -XX:MaxPremSize=10M
         */
        List<String> list = new ArrayList<String>();
        // æ— é™å¾ªç¯ ä½¿ç”¨ list å¯¹å…¶å¼•ç”¨ä¿è¯ ä¸è¢«GC  intern æ–¹æ³•ä¿è¯å…¶åŠ å…¥åˆ°å¸¸é‡æ± ä¸­
        int          i    = 0;
        while (true) {
            // æ­¤å¤„æ°¸ä¹…æ‰§è¡Œï¼Œæœ€å¤šå°±æ˜¯å°†æ•´ä¸ª int èŒƒå›´è½¬åŒ–æˆå­—ç¬¦ä¸²å¹¶æ”¾å…¥å¸¸é‡æ± 
            list.add(String.valueOf(i++).intern());
        }
    }
}
```

ä»¥ä¸Šä»£ç åœ¨ JDK6 ä¸‹ä¼šå‡ºç° Perm å†…å­˜æº¢å‡ºï¼ŒJDK7 or high åˆ™æ²¡é—®é¢˜ã€‚

**åŸå› åˆ†æï¼š**

**JDK6 å¸¸é‡æ± å­˜åœ¨æ–¹æ³•åŒºï¼Œè®¾ç½®äº†æŒä¹…ä»£å¤§å°åï¼Œä¸æ–­ while å¾ªç¯å¿…å°†æ’‘æ»¡ Perm å¯¼è‡´å†…å­˜æº¢å‡ºï¼›JDK7 å¸¸é‡æ± è¢«ç§»åŠ¨åˆ° Native Heap(Java Heap)ï¼Œæ‰€ä»¥å³ä½¿è®¾ç½®äº†æŒä¹…ä»£å¤§å°ï¼Œä¹Ÿä¸ä¼šå¯¹å¸¸é‡æ± äº§ç”Ÿå½±å“ï¼›ä¸æ–­ while å¾ªç¯åœ¨å½“å‰çš„ä»£ç ä¸­ï¼Œæ‰€æœ‰ int çš„å­—ç¬¦ä¸²ç›¸åŠ è¿˜ä¸è‡³äºæ’‘æ»¡ Heap åŒºï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å¼‚å¸¸ã€‚**

## [finalã€finallyå’Œfinalizeï¼šJavaç¼–ç¨‹å¿…å¤‡çŸ¥è¯†](https://blog.dong4j.site/posts/697d5753.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

finalã€finally å’Œ finalize è™½ç„¶é•¿å¾—åƒå­ªç”Ÿä¸‰å…„å¼Ÿä¸€æ ·ï¼Œä½†æ˜¯å®ƒä»¬çš„å«ä¹‰å’Œç”¨æ³•å´æ˜¯å¤§ç›¸å¾„åº­ã€‚è¿™ä¸€æ¬¡æˆ‘ä»¬å°±ä¸€èµ·æ¥å›é¡¾ä¸€ä¸‹è¿™æ–¹é¢çš„çŸ¥è¯†ã€‚

**_final å…³é”®å­—_**

æˆ‘ä»¬é¦–å…ˆæ¥è¯´è¯´ finalã€‚å®ƒå¯ä»¥ç”¨äºä»¥ä¸‹å››ä¸ªåœ°æ–¹ï¼š

1. å®šä¹‰å˜é‡ï¼ŒåŒ…æ‹¬é™æ€çš„å’Œéé™æ€çš„ã€‚
2. å®šä¹‰æ–¹æ³•çš„å‚æ•°ã€‚
3. å®šä¹‰æ–¹æ³•ã€‚
4. å®šä¹‰ç±»ã€‚

æˆ‘ä»¬ä¾æ¬¡æ¥å›é¡¾ä¸€ä¸‹æ¯ç§æƒ…å†µä¸‹ final çš„ä½œç”¨ã€‚é¦–å…ˆæ¥çœ‹ç¬¬ä¸€ç§æƒ…å†µï¼Œå¦‚æœ final ä¿®é¥°çš„æ˜¯ä¸€ä¸ªåŸºæœ¬ç±»å‹ï¼Œå°±è¡¨ç¤ºè¿™ä¸ªå˜é‡è¢«èµ‹äºˆçš„å€¼æ˜¯ä¸å¯å˜ çš„ï¼Œå³å®ƒæ˜¯ä¸ªå¸¸é‡ï¼›å¦‚æœ final ä¿®é¥°çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå°±è¡¨ç¤ºè¿™ä¸ªå˜é‡è¢«èµ‹äºˆçš„å¼•ç”¨æ˜¯ä¸å¯å˜çš„ï¼Œè¿™é‡Œéœ€è¦æé†’å¤§å®¶æ³¨æ„çš„æ˜¯ï¼Œä¸å¯æ”¹å˜çš„åªæ˜¯è¿™ä¸ªå˜é‡æ‰€ä¿å­˜çš„ å¼•ç”¨ï¼Œå¹¶ä¸æ˜¯è¿™ä¸ªå¼•ç”¨æ‰€æŒ‡å‘çš„å¯¹è±¡ã€‚åœ¨ç¬¬äºŒç§æƒ…å†µä¸‹ï¼Œfinal çš„å«ä¹‰ä¸ç¬¬ä¸€ç§æƒ…å†µç›¸åŒã€‚å®é™…ä¸Šå¯¹äºå‰ä¸¤ç§æƒ…å†µï¼Œæœ‰ä¸€ç§æ›´è´´åˆ‡çš„è¡¨è¿° final çš„å«ä¹‰çš„æ è¿°ï¼Œé‚£å°±æ˜¯ï¼Œå¦‚æœä¸€ä¸ªå˜é‡æˆ–æ–¹æ³•å‚æ•°è¢« final ä¿®é¥°ï¼Œå°±è¡¨ç¤ºå®ƒåªèƒ½è¢«èµ‹å€¼ä¸€æ¬¡ï¼Œä½†æ˜¯ JAVA è™šæ‹Ÿæœºä¸ºå˜é‡è®¾å®šçš„é»˜è®¤å€¼ä¸è®°ä½œä¸€æ¬¡èµ‹å€¼ã€‚

è¢« final ä¿®é¥°çš„å˜é‡å¿…é¡»è¢«åˆå§‹åŒ–ã€‚åˆå§‹åŒ–çš„æ–¹å¼æœ‰ä»¥ä¸‹å‡ ç§ï¼š

1. åœ¨å®šä¹‰çš„æ—¶å€™åˆå§‹åŒ–ã€‚
2. final å˜é‡å¯ä»¥åœ¨åˆå§‹åŒ–å—ä¸­åˆå§‹åŒ–ï¼Œä¸å¯ä»¥åœ¨é™æ€åˆå§‹åŒ–å—ä¸­åˆå§‹åŒ–ã€‚
3. é™æ€ final å˜é‡å¯ä»¥åœ¨é™æ€åˆå§‹åŒ–å—ä¸­åˆå§‹åŒ–ï¼Œä¸å¯ä»¥åœ¨åˆå§‹åŒ–å—ä¸­åˆå§‹åŒ–ã€‚
4. final å˜é‡è¿˜å¯ä»¥åœ¨ç±»çš„æ„é€ å™¨ä¸­åˆå§‹åŒ–ï¼Œä½†æ˜¯é™æ€ final å˜é‡ä¸å¯ä»¥ã€‚

é€šè¿‡ä¸‹é¢çš„ä»£ç å¯ä»¥éªŒè¯ä»¥ä¸Šçš„è§‚ç‚¹ï¼š

```java
public class FinalTest {
    // åœ¨å®šä¹‰æ—¶åˆå§‹åŒ–
    public final int A = 10;

    public final int B;
    // åœ¨åˆå§‹åŒ–å—ä¸­åˆå§‹åŒ–
    {
        B = 20;
    }

    // éé™æ€ final å˜é‡ä¸èƒ½åœ¨é™æ€åˆå§‹åŒ–å—ä¸­åˆå§‹åŒ–
    // public final int C;
    // static {
    // C = 30;
    // }

    // é™æ€å¸¸é‡ï¼Œåœ¨å®šä¹‰æ—¶åˆå§‹åŒ–
    public static final int STATIC_D = 40;

    public static final int STATIC_E;
    // é™æ€å¸¸é‡ï¼Œåœ¨é™æ€åˆå§‹åŒ–å—ä¸­åˆå§‹åŒ–
    static {
        STATIC_E = 50;
    }

    // é™æ€å˜é‡ä¸èƒ½åœ¨åˆå§‹åŒ–å—ä¸­åˆå§‹åŒ–
    // public static final int STATIC_F;
    // {
    // STATIC_F = 60;
    // }

    public final int G;

    // é™æ€ final å˜é‡ä¸å¯ä»¥åœ¨æ„é€ å™¨ä¸­åˆå§‹åŒ–
    // public static final int STATIC_H;

    // åœ¨æ„é€ å™¨ä¸­åˆå§‹åŒ–
    public FinalTest() {
        G = 70;
        // é™æ€ final å˜é‡ä¸å¯ä»¥åœ¨æ„é€ å™¨ä¸­åˆå§‹åŒ–
        // STATIC_H = 80;

        // ç»™ final çš„å˜é‡ç¬¬äºŒæ¬¡èµ‹å€¼æ—¶ï¼Œç¼–è¯‘ä¼šæŠ¥é”™
        // A = 99;
        // STATIC_D = 99;
    }

    // final å˜é‡æœªè¢«åˆå§‹åŒ–ï¼Œç¼–è¯‘æ—¶å°±ä¼šæŠ¥é”™
    // public final int I;

    // é™æ€ final å˜é‡æœªè¢«åˆå§‹åŒ–ï¼Œç¼–è¯‘æ—¶å°±ä¼šæŠ¥é”™
    // public static final int STATIC_J;
}
```

æˆ‘ä»¬è¿è¡Œä¸Šé¢çš„ä»£ç ä¹‹åå‡ºäº†å¯ä»¥å‘ç° final å˜é‡ï¼ˆå¸¸é‡ï¼‰å’Œé™æ€ final å˜é‡ï¼ˆé™æ€å¸¸é‡ï¼‰æœªè¢«åˆå§‹åŒ–æ—¶ï¼Œç¼–è¯‘ä¼šæŠ¥é”™ã€‚

ç”¨ final ä¿®é¥°çš„å˜é‡ï¼ˆå¸¸é‡ï¼‰æ¯”é final çš„å˜é‡ï¼ˆæ™®é€šå˜é‡ï¼‰æ‹¥æœ‰æ›´é«˜çš„æ•ˆç‡ï¼Œå› æ­¤æˆ‘ä»¬åœ¨å®é™…ç¼–ç¨‹ä¸­åº”è¯¥å°½å¯èƒ½å¤šçš„ç”¨å¸¸é‡æ¥ä»£æ›¿æ™®é€šå˜é‡ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ç¼–ç¨‹ä¹ æƒ¯ã€‚

å½“ final ç”¨æ¥å®šä¹‰ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œä¼šæœ‰ä»€ä¹ˆæ•ˆæœå‘¢ï¼Ÿæ­£å¦‚å¤§å®¶æ‰€çŸ¥ï¼Œå®ƒè¡¨ç¤ºè¿™ä¸ªæ–¹æ³•ä¸å¯ä»¥è¢«å­ç±»é‡å†™ï¼Œä½†æ˜¯å®ƒè¿™ä¸å½±å“å®ƒè¢«å­ç±»ç»§æ‰¿ã€‚æˆ‘ä»¬å†™æ®µä»£ç æ¥éªŒè¯ä¸€ä¸‹ï¼š

```java
class ParentClass {
    public final void TestFinal() {
        System.out.println("çˆ¶ç±» -- è¿™æ˜¯ä¸€ä¸ª final æ–¹æ³•");
    }
}

public class SubClass extends ParentClass {
    /**
     * å­ç±»æ— æ³•é‡å†™ï¼ˆoverrideï¼‰çˆ¶ç±»çš„ final æ–¹æ³•ï¼Œå¦åˆ™ç¼–è¯‘æ—¶ä¼šæŠ¥é”™
     */
    // public void TestFinal() {
    // System.out.println("å­ç±» -- é‡å†™ final æ–¹æ³•");
    // }

    public static void main(String[] args) {
        SubClass sc = new SubClass();
        sc.TestFinal();
    }
}
```

è¿™é‡Œéœ€è¦ç‰¹æ®Šè¯´æ˜çš„æ˜¯ï¼Œå…·æœ‰ private è®¿é—®æƒé™çš„æ–¹æ³•ä¹Ÿå¯ä»¥å¢åŠ  final ä¿®é¥°ï¼Œä½†æ˜¯ç”±äºå­ç±»æ— æ³•ç»§æ‰¿ private æ–¹æ³•ï¼Œå› æ­¤ä¹Ÿæ— æ³•é‡å†™ å®ƒã€‚ç¼–è¯‘å™¨åœ¨å¤„ç† private æ–¹æ³•æ—¶ï¼Œæ˜¯æŒ‰ç…§ final æ–¹æ³•æ¥å¯¹å¾…çš„ï¼Œè¿™æ ·å¯ä»¥æé«˜è¯¥æ–¹æ³•è¢«è°ƒç”¨æ—¶çš„æ•ˆç‡ã€‚ä¸è¿‡å­ç±»ä»ç„¶å¯ä»¥å®šä¹‰åŒçˆ¶ç±»ä¸­çš„ private æ–¹æ³•å…·æœ‰åŒæ ·ç»“æ„çš„æ–¹æ³•ï¼Œä½†æ˜¯è¿™å¹¶ä¸ä¼šäº§ç”Ÿé‡å†™çš„æ•ˆæœï¼Œè€Œä¸”å®ƒä»¬ä¹‹é—´ä¹Ÿä¸å­˜åœ¨å¿…ç„¶è”ç³»ã€‚

æœ€åæˆ‘ä»¬å†æ¥å›é¡¾ä¸€ä¸‹ final ç”¨äºç±»çš„æƒ…å†µã€‚è¿™ä¸ªå¤§å®¶åº”è¯¥ä¹Ÿå¾ˆç†Ÿæ‚‰äº†ï¼Œå› ä¸ºæˆ‘ä»¬æœ€å¸¸ç”¨çš„ String ç±»å°±æ˜¯ final çš„ã€‚ç”±äº final ç±»ä¸å… è®¸è¢«ç»§æ‰¿ï¼Œç¼–è¯‘å™¨åœ¨å¤„ç†æ—¶æŠŠå®ƒçš„æ‰€æœ‰æ–¹æ³•éƒ½å½“ä½œ final çš„ï¼Œå› æ­¤ final ç±»æ¯”æ™®é€šç±»æ‹¥æœ‰æ›´é«˜çš„æ•ˆç‡ã€‚final çš„ç±»çš„æ‰€æœ‰æ–¹æ³•éƒ½ä¸èƒ½è¢«é‡å†™ï¼Œä½†è¿™å¹¶ä¸ è¡¨ç¤º final çš„ç±»çš„å±æ€§ï¼ˆå˜é‡ï¼‰å€¼ä¹Ÿæ˜¯ä¸å¯æ”¹å˜çš„ï¼Œè¦æƒ³åšåˆ° final ç±»çš„å±æ€§å€¼ä¸å¯æ”¹å˜ï¼Œå¿…é¡»ç»™å®ƒå¢åŠ  final ä¿®é¥°ï¼Œè¯·çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š

```java
public final class FinalTest {

    int i = 10;

    public static void main(String[] args) {
        FinalTest ft = new FinalTest();
        ft.i = 99;
        System.out.println(ft.i);
    }
}
```

è¿è¡Œä¸Šé¢çš„ä»£ç è¯•è¯•çœ‹ï¼Œç»“æœæ˜¯ 99ï¼Œè€Œä¸æ˜¯åˆå§‹åŒ–æ—¶çš„ 10ã€‚

**_finally è¯­å¥_**

æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·å›é¡¾ä¸€ä¸‹ finally çš„ç”¨æ³•ã€‚è¿™ä¸ªå°±æ¯”è¾ƒç®€å•äº†ï¼Œå®ƒåªèƒ½ç”¨åœ¨ try/catch è¯­å¥ä¸­ï¼Œå¹¶ä¸”é™„å¸¦ç€ä¸€ä¸ªè¯­å¥å—ï¼Œè¡¨ç¤ºè¿™æ®µè¯­å¥æœ€ç»ˆæ€»æ˜¯è¢«æ‰§è¡Œã€‚è¯·çœ‹ä¸‹é¢çš„ä»£ç ï¼š

```java
public final class FinallyTest {
    public static void main(String[] args) {
        try {
            throw new NullPointerException();
        } catch (NullPointerException e) {
            System.out.println("ç¨‹åºæŠ›å‡ºäº†å¼‚å¸¸");
        } finally {
            System.out.println("æ‰§è¡Œäº† finally è¯­å¥å—");
        }
    }
}
```

è¿è¡Œç»“æœè¯´æ˜äº† finally çš„ä½œç”¨ï¼š

1. ç¨‹åºæŠ›å‡ºäº†å¼‚å¸¸
2. æ‰§è¡Œäº† finally è¯­å¥å—

è¯·å¤§å®¶æ³¨æ„ï¼Œæ•è·ç¨‹åºæŠ›å‡ºçš„å¼‚å¸¸ä¹‹åï¼Œæ—¢ä¸åŠ å¤„ç†ï¼Œä¹Ÿä¸ç»§ç»­å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸ï¼Œå¹¶ä¸æ˜¯è‰¯å¥½çš„ç¼–ç¨‹ä¹ æƒ¯ï¼Œå®ƒæ©ç›–äº†ç¨‹åºæ‰§è¡Œä¸­å‘ç”Ÿçš„é”™è¯¯ï¼Œè¿™é‡Œåªæ˜¯æ–¹ä¾¿æ¼”ç¤ºï¼Œè¯·ä¸è¦å­¦ä¹ ã€‚

é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰ä¸€ç§æƒ…å†µä½¿ finally è¯­å¥å—å¾—ä¸åˆ°æ‰§è¡Œå‘¢ï¼Ÿå¤§å®¶å¯èƒ½æƒ³åˆ°äº† returnã€continueã€break è¿™ä¸‰ä¸ªå¯ä»¥æ‰“ä¹±ä»£ç é¡ºåºæ‰§è¡Œè¯­å¥çš„è§„å¾‹ã€‚é‚£æˆ‘ä»¬å°±æ¥è¯•è¯•çœ‹ï¼Œè¿™ä¸‰ä¸ªè¯­å¥æ˜¯å¦èƒ½å½±å“ finally è¯­å¥å—çš„æ‰§è¡Œï¼š

```java
public final class FinallyTest {

    // æµ‹è¯• return è¯­å¥
    public ReturnClass testReturn() {
        try {
            return new ReturnClass();
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            System.out.println("æ‰§è¡Œäº† finally è¯­å¥");
        }
        return null;
    }

    // æµ‹è¯• continue è¯­å¥
    public void testContinue() {
        for (int i = 0; i < 3; i++) {
            try {
                System.out.println(i);
                if (i == 1) {
                    continue;
                }
            } catch (Exception e) {
                e.printStackTrace();
            } finally {
                System.out.println("æ‰§è¡Œäº† finally è¯­å¥");
            }
        }
    }

    // æµ‹è¯• break è¯­å¥
    public void testBreak() {
        for (int i = 0; i < 3; i++) {
            try {
                System.out.println(i);
                if (i == 1) {
                    break;
                }
            } catch (Exception e) {
                e.printStackTrace();
            } finally {
                System.out.println("æ‰§è¡Œäº† finally è¯­å¥");
            }
        }
    }

    public static void main(String[] args) {
        FinallyTest ft = new FinallyTest();
        // æµ‹è¯• return è¯­å¥
        ft.testReturn();
        System.out.println();
        // æµ‹è¯• continue è¯­å¥
        ft.testContinue();
        System.out.println();
        // æµ‹è¯• break è¯­å¥
        ft.testBreak();
    }
}

class ReturnClass {
    public ReturnClass() {
        System.out.println("æ‰§è¡Œäº† return è¯­å¥");
    }
}
```

ä¸Šé¢è¿™æ®µä»£ç çš„è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

```
æ‰§è¡Œäº† return è¯­å¥
æ‰§è¡Œäº† finally è¯­å¥
0
æ‰§è¡Œäº† finally è¯­å¥
1
æ‰§è¡Œäº† finally è¯­å¥
2
æ‰§è¡Œäº† finally è¯­å¥
0
æ‰§è¡Œäº† finally è¯­å¥
1
æ‰§è¡Œäº† finally è¯­å¥
```

å¾ˆæ˜æ˜¾ï¼Œreturnã€continue å’Œ break éƒ½æ²¡èƒ½é˜»æ­¢ finally è¯­å¥å—çš„æ‰§è¡Œã€‚ä»è¾“å‡ºçš„ç»“æœæ¥çœ‹ï¼Œreturn è¯­å¥ä¼¼ä¹åœ¨ finally è¯­å¥å—ä¹‹å‰æ‰§è¡Œäº†ï¼Œäº‹å®çœŸçš„å¦‚æ­¤å—ï¼Ÿæˆ‘ä»¬æ¥æƒ³æƒ³çœ‹ï¼Œreturn è¯­å¥çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ˜¯é€€å‡ºå½“å‰çš„æ–¹æ³•ï¼Œå¹¶å°†å€¼æˆ–å¯¹è±¡è¿”å›ã€‚å¦‚æœ finally è¯­å¥å—æ˜¯åœ¨ return è¯­å¥ä¹‹åæ‰§è¡Œçš„ï¼Œé‚£ä¹ˆ return è¯­å¥è¢«æ‰§è¡Œåå°±å·²ç»é€€å‡ºå½“å‰æ–¹æ³•äº†ï¼Œfinally è¯­å¥å—åˆå¦‚ä½•èƒ½è¢«æ‰§è¡Œå‘¢ï¼Ÿå›  æ­¤ï¼Œæ­£ç¡®çš„æ‰§è¡Œé¡ºåºåº”è¯¥æ˜¯è¿™æ ·çš„ï¼šç¼–è¯‘å™¨åœ¨ç¼–è¯‘ return new ReturnClass(); æ—¶ï¼Œå°†å®ƒåˆ†æˆäº†ä¸¤ä¸ªæ­¥éª¤ï¼Œnew ReturnClass() å’Œ returnï¼Œå‰ä¸€ä¸ªåˆ›å»ºå¯¹è±¡çš„è¯­å¥æ˜¯åœ¨ finally è¯­å¥å—ä¹‹å‰è¢«æ‰§è¡Œçš„ï¼Œè€Œåä¸€ä¸ª return è¯­å¥æ˜¯åœ¨ finally è¯­ å¥å—ä¹‹åæ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ finally è¯­å¥å—æ˜¯åœ¨ç¨‹åºé€€å‡ºæ–¹æ³•ä¹‹å‰è¢«æ‰§è¡Œçš„ã€‚åŒæ ·ï¼Œfinally è¯­å¥å—æ˜¯åœ¨å¾ªç¯è¢«è·³è¿‡ï¼ˆcontinueï¼‰å’Œä¸­æ–­ ï¼ˆbreakï¼‰ä¹‹å‰è¢«æ‰§è¡Œçš„ã€‚

**_finalize æ–¹æ³•_**

æœ€åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ finalizeï¼Œå®ƒæ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œå±äº java.lang.Object ç±»ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š

`protectedÂ voidÂ finalize()Â throwsÂ ThrowableÂ {Â }Â Â `

ä¼—æ‰€å‘¨çŸ¥ï¼Œfinalize() æ–¹æ³•æ˜¯ GCï¼ˆgarbage collectorï¼‰è¿è¡Œæœºåˆ¶çš„ä¸€éƒ¨åˆ†ï¼Œå…³äº GC çš„çŸ¥è¯†æˆ‘ä»¬å°†åœ¨åç»­çš„ç« èŠ‚ä¸­æ¥å›é¡¾ã€‚

åœ¨æ­¤æˆ‘ä»¬åªè¯´è¯´ finalize() æ–¹æ³•çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

finalize() æ–¹æ³•æ˜¯åœ¨ GC æ¸…ç†å®ƒæ‰€ä»å±çš„å¯¹è±¡æ—¶è¢«è°ƒç”¨çš„ï¼Œå¦‚æœæ‰§è¡Œå®ƒçš„è¿‡ç¨‹ä¸­æŠ›å‡ºäº†æ— æ³•æ•è·çš„å¼‚å¸¸ï¼ˆuncaught exceptionï¼‰ï¼ŒGC å°†ç»ˆæ­¢å¯¹æ”¹å¯¹è±¡çš„æ¸…ç†ï¼Œå¹¶ä¸”è¯¥å¼‚å¸¸ä¼šè¢«å¿½ç•¥ï¼›ç›´åˆ°ä¸‹ä¸€æ¬¡ GC å¼€å§‹æ¸…ç†è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œå®ƒçš„ finalize() ä¼šè¢«å†æ¬¡è°ƒç”¨ã€‚

è¯·çœ‹ä¸‹é¢çš„ç¤ºä¾‹ï¼š

```java
public final class FinallyTest {
    // é‡å†™ finalize() æ–¹æ³•
    protected void finalize() throws Throwable {
        System.out.println("æ‰§è¡Œäº† finalize() æ–¹æ³•");
    }

    public static void main(String[] args) {
        FinallyTest ft = new FinallyTest();
        ft = null;
        System.gc();
    }
}
```

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

- æ‰§è¡Œäº† finalize() æ–¹æ³•

ç¨‹åºè°ƒç”¨äº† java.lang.System ç±»çš„ gc() æ–¹æ³•ï¼Œå¼•èµ· GC çš„æ‰§è¡Œï¼ŒGC åœ¨æ¸…ç† ft å¯¹è±¡æ—¶è°ƒç”¨äº†å®ƒçš„ finalize() æ–¹æ³•ï¼Œå› æ­¤æ‰æœ‰äº†ä¸Šé¢çš„è¾“å‡ºç»“æœã€‚è°ƒç”¨ System.gc() ç­‰åŒäºè°ƒç”¨ä¸‹é¢è¿™è¡Œä»£ç ï¼š

`Runtime.getRuntime().gc();Â Â `

è°ƒç”¨å®ƒä»¬çš„ä½œç”¨åªæ˜¯å»ºè®®åƒåœ¾æ”¶é›†å™¨ï¼ˆGCï¼‰å¯åŠ¨ï¼Œæ¸…ç†æ— ç”¨çš„å¯¹è±¡é‡Šæ”¾å†…å­˜ç©ºé—´ï¼Œä½†æ˜¯ GC çš„å¯åŠ¨å¹¶ä¸æ˜¯ä¸€å®šçš„ï¼Œè¿™ç”± JAVA è™šæ‹Ÿæœºæ¥å†³å®šã€‚ç›´åˆ° JAVA è™šæ‹Ÿæœºåœæ­¢è¿è¡Œï¼Œæœ‰äº›å¯¹è±¡çš„ finalize() å¯èƒ½éƒ½æ²¡æœ‰è¢«è¿è¡Œè¿‡ï¼Œé‚£ä¹ˆæ€æ ·ä¿è¯æ‰€æœ‰å¯¹è±¡çš„è¿™ä¸ªæ–¹æ³•åœ¨ JAVA è™šæ‹Ÿæœºåœæ­¢è¿è¡Œä¹‹å‰ä¸€å®šè¢«è°ƒç”¨ å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æˆ‘ä»¬å¯ä»¥è°ƒç”¨ System ç±»çš„å¦ä¸€ä¸ªæ–¹æ³•ï¼š

```java
publicÂ staticÂ voidÂ runFinalizersOnExit(booleanÂ value)Â {Â Â 
Â Â Â Â //otherÂ codeÂ Â 
}Â Â 
```

ç»™è¿™ä¸ªæ–¹æ³•ä¼ å…¥ true å°±å¯ä»¥ä¿è¯å¯¹è±¡çš„ finalize() æ–¹æ³•åœ¨ JAVA è™šæ‹Ÿæœºåœæ­¢è¿è¡Œå‰ä¸€å®šè¢«è¿è¡Œäº†ï¼Œä¸è¿‡é—æ†¾çš„æ˜¯è¿™ä¸ªæ–¹æ³•æ˜¯ä¸å®‰å…¨çš„ï¼Œå®ƒä¼šå¯¼è‡´æœ‰ç”¨çš„å¯¹è±¡ finalize() è¢«è¯¯è°ƒç”¨ï¼Œå› æ­¤å·²ç»ä¸è¢«èµæˆä½¿ç”¨äº†ã€‚

ç”±äº finalize() å±äº Object ç±»ï¼Œå› æ­¤æ‰€æœ‰ç±»éƒ½æœ‰è¿™ä¸ªæ–¹æ³•ï¼ŒObject çš„ä»»æ„å­ç±»éƒ½å¯ä»¥é‡å†™ï¼ˆoverrideï¼‰è¯¥æ–¹æ³•ï¼Œåœ¨å…¶ä¸­é‡Šæ”¾ç³»ç»Ÿèµ„æºæˆ–è€…åšå…¶å®ƒçš„æ¸…ç†å·¥ä½œï¼Œå¦‚å…³é—­è¾“å…¥è¾“å‡ºæµã€‚

é€šè¿‡ä»¥ä¸ŠçŸ¥è¯†çš„å›é¡¾ï¼Œæˆ‘æƒ³å¤§å®¶å¯¹äº finalã€finallyã€finalize çš„ç”¨æ³•åŒºåˆ«å·²ç»å¾ˆæ¸…æ¥šäº†ã€‚

## [ä»é›¶åˆ°ä¸€å­¦ä¹ SQLï¼šå†…è¿æ¥ä¸å¤–è¿æ¥å®æˆ˜](https://blog.dong4j.site/posts/f9bb212c.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

#### èšåˆå‡½æ•°

- count è¿”å›ç»“æœé›†ä¸­è¡Œçš„æ•°ç›®
- sum è¿”å›ç»“æœé›†ä¸­æ‰€æœ‰å€¼å¾—æ€»å’Œ
- avg è¿”å›ç»“æœé›†ä¸­æ‰€æœ‰å€¼å¾—å¹³å‡å€¼
- max è¿”å›ç»“æœé›†ä¸­æ‰€æœ‰å€¼ä¸­æœ€å¤§å€¼
- min è¿”å›ç»“æœé›†ä¸­æ‰€æœ‰å€¼ä¸­æœ€å°å€¼

##### count

> select count([* | all | distinct] expr) from è¡¨å;

- - : è®¡ç®—æ‰€æœ‰é€‰æ‹©çš„è¡Œ, åŒ…æ‹¬ null
- all : è®¡ç®—æŒ‡å®šåˆ—æ‰€æœ‰çš„éç©ºè¡Œ, é»˜è®¤é€‰é¡¹
- distinct : è®¡ç®—æŒ‡å®šåˆ—æ‰€æœ‰å”¯ä¸€éç©ºå€¼

#### sum

> select sum([all | distinct] expr) as åˆ«å from è¡¨å;

#### avg

> select avg(mark) as â€˜å¹³å‡æˆç»©â€™ from sutdent  
> where studentID = 10;  
> è¾“å‡ºè¡¨ student ä¸­ studentID ä¸º 10 çš„æ‰€æœ‰ mark çš„å¹³å‡å€¼

#### æœ€å¤§å€¼å’Œæœ€å°å€¼

```sql
select max(mark) as 'æœ€é«˜æˆç»©', min(mark) as 'æœ€ä½æˆç»©'
from student
where examID = 6;
```

#### å¸¸ç”¨æ•°æ®åº“å‡½æ•°

[mysql å¸¸ç”¨å‡½æ•°](http://www.cnblogs.com/cocos/archive/2011/05/06/2039469.html)

### æ•°æ®åˆ†ç»„

å°†è¡¨æŒ‰æ¡ä»¶åˆ†ç»„, ç„¶ååœ¨ç»„ä¸­æŸ¥æ‰¾éœ€è¦çš„å€¼

```sql
select åˆ—A, èšåˆå‡½æ•°(èšåˆå‡½æ•°è§„èŒƒ)
from è¡¨å
where è¿‡æ»¤æ¡ä»¶
group by åˆ—A;
```

å½“éœ€è¦åˆ†ç»„æŸ¥è¯¢æ—¶éœ€è¦ä½¿ç”¨ GROUP BY å­å¥ï¼Œä¾‹å¦‚æŸ¥è¯¢æ¯ä¸ªéƒ¨é—¨çš„å·¥èµ„å’Œï¼Œè¿™è¯´æ˜è¦ä½¿ç”¨éƒ¨åˆ†æ¥åˆ†ç»„ã€‚

- æŸ¥è¯¢æ¯ä¸ªéƒ¨é—¨çš„éƒ¨é—¨ç¼–å·å’Œæ¯ä¸ªéƒ¨é—¨çš„å·¥èµ„å’Œï¼š

```sql
SELECT deptno, SUM(sal)
FROM emp
GROUP BY deptno;
```

- æŸ¥è¯¢æ¯ä¸ªéƒ¨é—¨çš„éƒ¨é—¨ç¼–å·ä»¥åŠæ¯ä¸ªéƒ¨é—¨çš„äººæ•°ï¼š

```sql
SELECT deptno,COUNT(*)
FROM emp
GROUP BY deptno;
```

- æŸ¥è¯¢æ¯ä¸ªéƒ¨é—¨çš„éƒ¨é—¨ç¼–å·ä»¥åŠæ¯ä¸ªéƒ¨é—¨å·¥èµ„å¤§äº 1500 çš„äººæ•°ï¼š

```sql
SELECT deptno,COUNT(*)
FROM emp
WHERE sal>1500
GROUP BY deptno;
```

#### HAVING å­å¥

- æŸ¥è¯¢å·¥èµ„æ€»å’Œå¤§äº 9000 çš„éƒ¨é—¨ç¼–å·ä»¥åŠå·¥èµ„å’Œ

```sql
SELECT deptno, SUM(sal)
FROM emp
GROUP BY deptno
HAVING SUM(sal) > 9000;
```

##### å­å¥é¡ºåºé—®é¢˜

å¦‚æœ where åœ¨ group by å‰é¢, å¹¶ä¸æ˜¯ä»åˆ†ç»„ä¸­æŸ¥è¯¢  
å¦‚æœ where åœ¨ group by åé¢, åˆ™æ˜¯ä»åˆ†ç»„ä¸­æŸ¥è¯¢éœ€è¦çš„ç»“æœ

select  
from  
where æ¡ä»¶ä¸­ä¸èƒ½æœ‰èšåˆå‡½æ•°  
group by  
[where]  
having æ¡ä»¶ä¸­éƒ½æ˜¯èšåˆå‡½æ•°, å°±åœ¨é€‰å‡ºçš„åˆ†ç»„ä¸­å†æ¬¡ç­›é€‰  
order by å¦‚æœéœ€è¦, æœ€åè¿›è¡Œæ’åº

æ³¨æ„ï¼ŒWHERE æ˜¯å¯¹åˆ†ç»„å‰è®°å½•çš„æ¡ä»¶ï¼Œå¦‚æœæŸè¡Œè®°å½•æ²¡æœ‰æ»¡è¶³ WHERE å­å¥çš„æ¡ä»¶ï¼Œé‚£ä¹ˆè¿™è¡Œè®°å½•ä¸ä¼šå‚åŠ åˆ†ç»„ï¼›è€Œ HAVING æ˜¯å¯¹åˆ†ç»„åæ•°æ®çš„çº¦æŸã€‚

#### åˆ†é¡µæŸ¥è¯¢

LIMIT ç”¨æ¥é™å®šæŸ¥è¯¢ç»“æœçš„èµ·å§‹è¡Œï¼Œä»¥åŠæ€»è¡Œæ•°ã€‚

- æŸ¥è¯¢ 5 è¡Œè®°å½•ï¼Œèµ·å§‹è¡Œä» 0 å¼€å§‹

> `SELECT * FROM emp LIMIT 0, 5;`

æ³¨æ„ï¼Œèµ·å§‹è¡Œä» 0 å¼€å§‹ï¼Œå³ç¬¬ä¸€è¡Œå¼€å§‹ï¼

- æŸ¥è¯¢ 10 è¡Œè®°å½•ï¼Œèµ·å§‹è¡Œä» 3 å¼€å§‹

> `SELECT * FROM emp LIMIT 3, 10;`

å¦‚æœä¸€é¡µè®°å½•ä¸º 10 æ¡ï¼Œå¸Œæœ›æŸ¥çœ‹ç¬¬ 3 é¡µè®°å½•åº”è¯¥æ€ä¹ˆæŸ¥å‘¢ï¼Ÿ

- ç¬¬ä¸€é¡µè®°å½•èµ·å§‹è¡Œä¸º 0ï¼Œä¸€å…±æŸ¥è¯¢ 10 è¡Œï¼›
- ç¬¬äºŒé¡µè®°å½•èµ·å§‹è¡Œä¸º 10ï¼Œä¸€å…±æŸ¥è¯¢ 10 è¡Œï¼›
- ç¬¬ä¸‰é¡µè®°å½•èµ·å§‹è¡Œä¸º 20ï¼Œä¸€å…±æŸ¥è¯¢ 10 è¡Œï¼›

æŸ¥è¯¢é¡µçš„ä¸‹æ ‡ = `(è¦æŸ¥è¯¢çš„é¡µæ•° - 1) * æ¯é¡µè®°å½•çš„è¡Œæ•°`

### å•è¡¨æŸ¥è¯¢

```sql
select åˆ—å1[, åˆ—å2,...]
from æ•°æ®æº
[where condition];
```

- æ•°æ®æºå¯ä»¥æ˜¯è¡¨ä¹Ÿå¯ä»¥æ˜¯è§†å›¾;
- åˆ—å å’Œ where å…³é”®å­—é€‰å‡ºçš„è¡Œç¡®å®šé€‰æ‹©çš„æŸ¥è¯¢ç»“æœ
- æ²¡æœ‰ where å…³é”®å­—åˆ™é€‰å‡ºæ‰€æœ‰çš„è¡Œ
- å¦‚æœä¸æŒ‡å®šé€‰æ‹©çš„åˆ—, ä½¿ç”¨ `*` ä»£è¡¨æ‰€æœ‰çš„åˆ—

#### å­—ç¬¦ä¸²çš„è¿æ¥

```sql
select concat(teacher_name,'xxx')
from teacher_table;
```

åœ¨ mysql ä¸­, å­—ç¬¦ä¸²å’Œ null è¿æ¥ä¼šè¿”å› null,  
å¯¹äºå…¶ä»–ä¸€äº›æ•°æ®åº“, å¦‚æœè®©å­—ç¬¦ä¸²å’Œ null è¿æ¥, ä¼šæŠŠ null å½“æˆç©ºå­—ç¬¦ä¸²å¤„ç†

#### å»é™¤é‡å¤è¡Œ

```sql
select distinct student_name ,java_teacher
from student_table;
```

#### where å…³é”®å­—

| è¿ç®—ç¬¦                          | å«ä¹‰                                      |
| :------------------------------ | :---------------------------------------- |
| `expr1 between expr2 and expr3` | è¦æ±‚ `expr2 <= expr1 <= expr3`            |
| `expr1 in (expr2, expr3, ..)`   | è¦æ±‚ `expr1` ç­‰äºæ‹¬å·å†…ä»»æ„è¡¨è¾¾å¼çš„å€¼     |
| `like`                          | å­—ç¬¦ä¸²åŒ¹é…ï¼Œ`like` åé¢çš„å­—ç¬¦ä¸²æ”¯æŒé€šé…ç¬¦ |
| `is null`                       | è¦æ±‚æŒ‡å®šå€¼ç­‰äº `null`                     |
| `=`                             | æ˜¯å¦ç›¸ç­‰                                  |
| `<>`                            | ä¸ç›¸ç­‰                                    |
| `:=`                            | èµ‹å€¼                                      |

##### like æ¨¡ç³ŠåŒ¹é…

SQL æ”¯æŒ 2 ä¸ªé€šé…ç¬¦

- ä¸‹åˆ’çº¿ `_` : ä»£è¡¨ä¸€ä¸ªä»»æ„çš„å­—ç¬¦
- ç™¾åˆ†å· %: ä»£è¡¨ä»»æ„å¤šä¸ªå­—ç¬¦

å½“æŸ¥è¯¢ä¸­éœ€è¦ä½¿ç”¨åˆ°ä¸‹åˆ’çº¿æˆ–ç™¾åˆ†å·æ—¶, å¯ä»¥ä½¿ç”¨ `\` è½¬ä¹‰,  
ä¹Ÿå¯ä½¿ç”¨ `escape` å…³é”®å­—

```sql
select * from student_table
where student_name like '_%' escape '\';
```

##### æ¡ä»¶ç»„åˆæŸ¥è¯¢

SQL æä¾›äº† `and` å’Œ `or` æ¥ç»„åˆ 2 ä¸ªæ¡ä»¶, å¹¶æä¾› `not` æ¥å¯¹é€»è¾‘è¡¨è¾¾å¼æ±‚å¦.

```sql
select * from student_table
where stduent_name like '__' and student_id > 3;
```

##### æ¯”è¾ƒè¿ç®—ç¬¦å’Œé€»è¾‘è¿ç®—ç¬¦çš„ä¼˜å…ˆçº§

| è¿ç®—ç¬¦           | ä¼˜å…ˆçº§ (å°çš„ä¼˜å…ˆ) |
| :--------------- | :---------------: |
| æ‰€æœ‰çš„æ¯”è¾ƒè¿ç®—ç¬¦ |         1         |
| not (é)         |         2         |
| and (ä¸”)         |         3         |
| or (æˆ–è€…)        |         4         |

æ‹¬å·çš„ä¼˜å…ˆçº§æœ€é«˜, æ‰€ä»¥å¯ä»¥ä½¿ç”¨æ‹¬å·æ¥æ”¹å˜é€»è¾‘è¿ç®—ç¬¦ä¼˜å…ˆçº§

```sql
select * from student_table
where (student_id > 3 or student_name > 'å¼ ') and java_teacher > 1;
```

##### æŸ¥è¯¢ç»“æœæ’åº

æŸ¥è¯¢ç»“æœé»˜è®¤æŒ‰æ’å…¥é¡ºåºæ’åº, å¦‚æœéœ€è¦æŸ¥è¯¢ç»“æœæŒ‰æŸåˆ—å€¼å¾—å¤§å°è¿›è¡Œæ’åº,  
åˆ™å¯ä»¥ä½¿ç”¨ `order by`

```sql
order by åˆ—å1 [desc] ,åˆ—å2,åˆ—å3,...;
```

ä¸Šé¢è¯­æ³•è¿›è¡Œæ’åºæ—¶å¯ä»¥é‡‡ç”¨åˆ—å, åˆ—åºå·å’Œåˆ—åˆ«å.

è¿›è¡Œæ’åºæ—¶é»˜è®¤è¿›è¡Œå‡åºæ’åº, å¦‚æœæƒ³æŒ‰é™åºæ’åˆ—, å¯ä»¥å†™ä¸Š `desc` å…³é”®å­—  
ä¸ä¹‹å¯¹åº”çš„æ˜¯ `asc` å…³é”®å­—

ä¸‹é¢çš„è¯­å¥é€‰å‡º student_table ä¸­æ‰€æœ‰çš„è®°å½•, ç„¶åæŒ‰ java_teacher åˆ—çš„å‡åºæ’åˆ—

```sql
select * from student_table
order by java_teacher;
```

å¦‚æœéœ€è¦æŒ‰å¤šè¡Œæ’åº, åˆ™æ¯è¡Œçš„ asc å’Œ desc å¿…é¡»å•ç‹¬æŒ‡å®š,  
å¦‚æœæŒ‡å®šäº†å¤šä¸ªæ’åºåˆ—, åˆ™ç¬¬ä¸€ä¸ªæ’åºåˆ—æ˜¯åˆè¦æ’åºåˆ—, åªè¦å½“ç¬¬ä¸€åˆ—ä¸­å­˜åœ¨å¤šä¸ªç›¸åŒçš„å€¼æ—¶, ç¬¬äºŒåˆ—æ‰ä¼šèµ·ä½œç”¨

```sql
select * from student_table
order by java_teacher desc , student_name;
```

å½“ java_teacher åˆ—çš„å€¼ç›¸åŒæ—¶, æŒ‰ç…§ student_name åˆ—çš„å‡åºæ’åˆ—.

### å¤šè¡¨æŸ¥è¯¢

- åˆå¹¶ç»“æœé›†
- è¿æ¥æŸ¥è¯¢
  - å†…è¿æ¥
  - å¤–é“¾æ¥
    - å·¦å¤–è¿æ¥
    - å³å¤–è¿æ¥
    - å¤–å…¨è¿æ¥ (mysql ä¸æ”¯æŒ, ä½¿ç”¨å·¦å¤–, å³å¤–ç»“åˆ)
  - è‡ªç„¶è¿æ¥
- å­æŸ¥è¯¢

#### åˆå¹¶ç»“æœé›†

1. ä½œç”¨: åˆå¹¶ç»“æœé›†å°±æ˜¯æŠŠä¸¤ä¸ª select è¯­å¥çš„æŸ¥è¯¢ç»“æœåˆå¹¶åˆ°ä¸€èµ·
2. ä¸¤ç§æ–¹å¼:

   - union: å»é™¤é‡å¤è®°å½•

> select _ from t1 union select _ from t2;

- union all : ä¸å»é™¤é‡è¯»è®°å½•

> select _ from t1 union all select _ from t2;

![20241229154732_Qcswql68.webp](https://cdn.dong4j.site/source/image/20241229154732_Qcswql68.webp)

![20241229154732_hLYA8bVL.webp](https://cdn.dong4j.site/source/image/20241229154732_hLYA8bVL.webp)

è¢«åˆå¹¶çš„ 2 ä¸ªç»“æœå¿…é¡»åˆ—æ•°, ç±»å‹ä¸€è‡´

#### è¿æ¥æŸ¥è¯¢

è¿æ¥æŸ¥è¯¢å°±æ˜¯æ±‚å‡ºå¤šä¸ªè¡¨çš„ä¹˜ç§¯, ä¾‹å¦‚ t1 å’Œ t2 è¿æ¥, é‚£ä¸ªæŸ¥è¯¢å‡ºçš„ç»“æœå°±æ˜¯ `t1*t2`

![20241229154732_iX48n3Ju.webp](https://cdn.dong4j.site/source/image/20241229154732_iX48n3Ju.webp)

å°±è¿™æ˜¯ç¬›å¡å°”ç§¯

æ‰€ä»¥æŸ¥è¯¢å‡ºæ¥çš„ç»“æœæœ‰é‡å¤çš„, æ‰€ä»¥éœ€è¦å»é™¤æ— ç”¨ä¿¡æ¯  
![20241229154732_K19FdTdE.webp](https://cdn.dong4j.site/source/image/20241229154732_K19FdTdE.webp)

> `select * from emp,dept where emp.deptno = dept.depton;`

![20241229154732_FCkyRd8h.webp](https://cdn.dong4j.site/source/image/20241229154732_FCkyRd8h.webp)

##### å†…è¿æ¥

æ ‡å‡†æ ¼å¼:

```sql
select * from empe
inner join dept
on empe.deptno = dept.deptno;
```

###### è‡ªç„¶è¿æ¥

```sql
select * from è¡¨1
natural join è¡¨2
```

ç³»ç»Ÿè‡ªåŠ¨æ‰¾åˆ°ä¸¤å¼ è¿æ¥çš„è¡¨ä¸­åç§°å’Œç±»å‹å®Œå…¨ä¸€è‡´çš„åˆ—

##### å¤–è¿æ¥

###### å·¦å¤–è¿æ¥

å…ˆæŸ¥è¯¢å‡ºå·¦è¡¨, ç„¶åæŸ¥è¯¢å³è¡¨, å³è¡¨ä¸­æ»¡è¶³æ¡ä»¶çš„æ˜¾ç¤ºå‡ºæ¥, ä¸æ»¡è¶³çš„æ˜¾ç¤ºä¸º null

```sql
SELECT * FROM emp e
LEFT OUTER JOIN dept d
ON e.deptno=d.deptno;
```

###### å³å¤–è¿æ¥

åŒå·¦å¤–è¿æ¥çš„æ•ˆæœç›¸å, å…ˆæŠŠå³è¡¨ä¸­æ‰€æœ‰çš„è®°å½•æŸ¥å‡ºæ¥, ç„¶åå·¦è¡¨æ»¡è¶³æ¡ä»¶çš„æ˜¾ç¤º, ä¸æ»¡è¶³çš„æ˜¾ç¤ºä¸º null

```sql
SELECT * FROM emp e
RIGHT OUTER JOIN dept d
ON e.deptno=d.deptno;
```

###### å¤–å…¨è¿æ¥

åœ¨ mysql ä¸­å®ç°å¤–å…¨è¿æ¥

```sql
SELECT * FROM emp e
LEFT OUTER JOIN dept d
ON e.deptno=d.deptno;
union
SELECT * FROM emp e
RIGHT OUTER JOIN dept d
ON e.deptno=d.deptno;
```

è¿æ¥ä¸é™ä¸ä¸¤å¼ è¡¨ï¼Œè¿æ¥æŸ¥è¯¢ä¹Ÿå¯ä»¥æ˜¯ä¸‰å¼ ã€å››å¼ ï¼Œç”šè‡³ N å¼ è¡¨çš„è¿æ¥æŸ¥è¯¢ã€‚é€šå¸¸è¿æ¥æŸ¥è¯¢ä¸å¯èƒ½éœ€è¦æ•´ä¸ªç¬›å¡å°”ç§¯ï¼Œè€Œåªæ˜¯éœ€è¦å…¶ä¸­ä¸€éƒ¨åˆ†ï¼Œé‚£ä¹ˆè¿™æ—¶å°±éœ€è¦ä½¿ç”¨æ¡ä»¶æ¥å»é™¤ä¸éœ€è¦çš„è®°å½•ã€‚è¿™ä¸ªæ¡ä»¶å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯ä½¿ç”¨ä¸»å¤–é”®å…³ç³»å»é™¤ã€‚  
ä¸¤å¼ è¡¨çš„è¿æ¥æŸ¥è¯¢ä¸€å®šæœ‰ä¸€ä¸ªä¸»å¤–é”®å…³ç³»ï¼Œä¸‰å¼ è¡¨çš„è¿æ¥æŸ¥è¯¢å°±ä¸€å®šæœ‰ä¸¤ä¸ªä¸»å¤–é”®å…³ç³»ï¼Œæ‰€ä»¥åœ¨å¤§å®¶ä¸æ˜¯å¾ˆç†Ÿæ‚‰è¿æ¥æŸ¥è¯¢æ—¶ï¼Œé¦–å…ˆè¦å­¦ä¼šå»é™¤æ— ç”¨ç¬›å¡å°”ç§¯ï¼Œé‚£ä¹ˆå°±æ˜¯ç”¨ä¸»å¤–é”®å…³ç³»ä½œä¸ºæ¡ä»¶æ¥å¤„ç†ã€‚å¦‚æœä¸¤å¼ è¡¨çš„æŸ¥è¯¢ï¼Œé‚£ä¹ˆè‡³å°‘æœ‰ä¸€ä¸ªä¸»å¤–é”®æ¡ä»¶ï¼Œä¸‰å¼ è¡¨è¿æ¥è‡³å°‘æœ‰ä¸¤ä¸ªä¸»å¤–é”®æ¡ä»¶ã€‚

##### å­æŸ¥è¯¢

å­æŸ¥è¯¢å°±æ˜¯åµŒå¥—æŸ¥è¯¢ï¼Œå³ SELECT ä¸­åŒ…å« SELECTï¼Œå¦‚æœä¸€æ¡è¯­å¥ä¸­å­˜åœ¨ä¸¤ä¸ªï¼Œæˆ–ä¸¤ä¸ªä»¥ä¸Š SELECTï¼Œé‚£ä¹ˆå°±æ˜¯å­æŸ¥è¯¢è¯­å¥äº†

1. å­æŸ¥è¯¢å‡ºç°çš„ä½ç½®ï¼š

   - where åï¼Œä½œä¸ºæ¡ä»¶çš„ä¸€éƒ¨åˆ†ï¼›
   - from åï¼Œä½œä¸ºè¢«æŸ¥è¯¢çš„ä¸€æ¡è¡¨;

2. å½“å­æŸ¥è¯¢å‡ºç°åœ¨ where åä½œä¸ºæ¡ä»¶æ—¶ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å…³é”®å­—ï¼š

   - any
   - all

3. å­æŸ¥è¯¢ç»“æœé›†çš„å½¢å¼

   - å•è¡Œå•åˆ—ï¼ˆç”¨äºæ¡ä»¶ï¼‰:

> `select * from è¡¨ 1 where åˆ— 1 [=,>,<,>=,<=,!=] (select åˆ— from è¡¨ where æ¡ä»¶)`

- å•è¡Œå¤šåˆ—ï¼ˆç”¨äºæ¡ä»¶ï¼‰:

> `select * from è¡¨ where (åˆ— 1, åˆ— 2) in (select åˆ— 1, åˆ— 2 from è¡¨ where æ¡ä»¶)`

- å¤šè¡Œå•åˆ—ï¼ˆç”¨äºæ¡ä»¶ï¼‰:

> `select * from è¡¨ where åˆ— 1 [in ,all ,any] (select åˆ— from è¡¨ where æ¡ä»¶)`

- å¤šè¡Œå¤šåˆ—ï¼ˆç”¨äºè¡¨ï¼‰:

> select _ from è¡¨ 1,(select _ from â€¦) where æ¡ä»¶

## [SQLåˆå­¦è€…å¿…çœ‹ï¼šDDLä¸DMLçš„åŒºåˆ«ä¸åº”ç”¨](https://blog.dong4j.site/posts/c3ab3ba4.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

æ“ä½œè¡¨ç»“æ„

#### create (åˆ›å»º)

- åˆ›å»ºè¡¨

```sql
create table [if not exists] è¡¨å(
    åˆ—å åˆ—ç±»å‹,
    åˆ—å åˆ—ç±»å‹,
    ...
);
```

- åˆ›å»ºè¡¨å¹¶ä»å…¶ä»–è¡¨ä¸­å¤åˆ¶æ•°æ®

```sql
create table è¡¨å
as
select * from è¡¨å
```

#### alter (ä¿®æ”¹)

- æ·»åŠ åˆ—å®šä¹‰ (åˆ—åå¿…é¡»æ˜¯åŸè¡¨ä¸­ä¸å­˜åœ¨çš„)

```sql
alter table è¡¨å add(
    åˆ—å æ•°æ®ç±»å‹ ,
    ...
);
```

- ä¿®æ”¹åˆ—å®šä¹‰ (åˆ—åå¿…é¡»æ˜¯åŸè¡¨ä¸­å­˜åœ¨çš„)

```sql
alter table è¡¨å modify åˆ—å æ•°æ®ç±»å‹;
```

MySQL ä¸­ ä¸€æ¬¡åªèƒ½ä¿®æ”¹ä¸€ä¸ªåˆ—å®šä¹‰

å¦‚æœä¿®æ”¹æ•°æ®åˆ—çš„é»˜è®¤å€¼, åªä¼šå¯¹ä»¥åæ’å…¥æ“ä½œæœ‰ä½œç”¨, å¯¹ä»¥å‰å·²ç»å­˜åœ¨çš„æ•°æ®ä¸ä¼šæœ‰ä»»ä½•å½±å“

- åˆ é™¤åˆ—

```sql
alter table è¡¨å drop åˆ—å;
```

- é‡å‘½åæ•°æ®è¡¨

```sql
alter table æ—§è¡¨å rename to/as æ–°è¡¨å;
```

- æ”¹åˆ—å

```sql
alter table è¡¨å change æ—§åˆ—å æ–°åˆ—å type;
```

- æ”¹åˆ—åå¹¶ä¿®æ”¹æ•°æ®ç±»å‹

```sql
alter table è¡¨å change æ—§è¡¨å æ–°è¡¨å type [default expr] [first | after åˆ—å];
```

1. ä¿®æ”¹æ•°æ®åº“æˆ utf8 çš„.  
   `mysql> alter database æ•°æ®åº“å character set utf8;`
2. ä¿®æ”¹è¡¨é»˜è®¤ç”¨ utf8.  
   `mysql> alter table è¡¨å character set utf8;`
3. ä¿®æ”¹å­—æ®µç”¨ utf8  
   `mysql> alter table è¡¨å modify type_name varchar(50) CHARACTER SET utf8;`

#### drop (åˆ é™¤)

- åˆ é™¤è¡¨

```sql
drop table è¡¨å
```

1. è¡¨ç»“æ„è¢«åˆ é™¤, è¡¨å¯¹è±¡ä¸å†å­˜åœ¨
2. è¡¨é‡Œçš„æ•°æ®ä¹Ÿè¢«åˆ é™¤
3. è¯¥è¡¨çš„æ‰€æœ‰ç›¸å…³ç´¢å¼•, çº¦æŸä¹Ÿè¢«åˆ é™¤

##### drop å’Œ delete çš„åŒºåˆ«

- drop åªæ˜¯é’ˆå¯¹è¡¨ç»“æ„  
   `drop table è¡¨å;`  
   ä»æ•°æ®åº“ä¸­åˆ é™¤è¿™å¼ è¡¨

- delete é’ˆå¯¹è¡¨æ•°æ®  
   `delete table è¡¨å;`  
   æ¸…ç©ºè¿™å¼ è¡¨ä¸­çš„æ‰€æœ‰æ•°æ®

#### truncate

```sql
truncate è¡¨å;
```

åˆ é™¤è¡¨ä¸­çš„å…¨éƒ¨æ•°æ®, ä½†ä¿ç•™è¡¨æ•°æ®.  
ç›¸å¯¹äº delete è€Œè¨€, é€Ÿåº¦æ›´å¿«,  
ä¸èƒ½åƒ delete èƒ½åˆ é™¤æŒ‡å®šçš„è®°å½•, truncate åªèƒ½ä¸€æ¬¡æ€§åˆ é™¤æ•´ä¸ªè¡¨ä¸­çš„å…¨éƒ¨è®°å½•

### DML (æ•°æ®æ“ä½œè¯­è¨€)

æ“ä½œæ•°æ®è¡¨ä¸­çš„æ•°æ®

#### insert (æ’å…¥æ•°æ®)

- æŒ‰åˆ—çš„åœ°ç†é¡ºåºæ’å…¥

```sql
insert into students values(
    1,'å¼ ä¸‰','ç”·',25,'123467890'
);
```

- å½“åªéœ€è¦æ’å…¥éƒ¨åˆ†æ•°æ®, æˆ–è€…ä¸æŒ‰ç…§é¡ºåºæ’å…¥

```sql
insert into students (name,sex,age) values('ç”°ä¸ƒ','ç”·',30);
```

- ä»å…¶ä»–è¡¨ä¸­ä¸€æ¬¡æ’å…¥å¤šæ¡æ•°æ®

```sql
inster into è¡¨å (åˆ—å1,åˆ—å2,...)
select åˆ—å from è¡¨å;
```

è¦æ±‚é€‰æ‹©å‡ºæ¥çš„æ•°æ®åˆ—å’Œæ’å…¥ç›®çš„åœ°çš„æ•°æ®åˆ—ä¸ªæ•°ç›¸åŒ, ç±»å‹åŒ¹é….  
MySQL æä¾›äº†ä¸€ç§æ‰©å±•è¯­å¥, å¯ä»¥ä¸€æ¬¡æ’å…¥å¤šæ¡è¯­å¥

```sql
insert into students values
    (1,'å¼ ä¸‰','ç”·',25,'123467890'),
    (2,'æå››','ç”·',22,'0987654321'),
    (3,'ç‹äº”','ç”·',20,'0984324321'),
    (4,'èµµå…­','ç”·',29,'0944654321');
```

#### update (ä¿®æ”¹å·²æœ‰æ•°æ®)

upadte ç”¨äºä¿®æ”¹æ•°æ®è¡¨çš„è®°å½•, æ¯æ¬¡å¯ä»¥ä¿®æ”¹å¤šæ¡è®°å½•. é€šè¿‡ä½¿ç”¨ `where` å­å¥é™å®šä¿®æ”¹å“ªäº›è®°å½•.  
`where` ç±»ä¼¼äº Java ä¸­çš„ `if`, åªæœ‰ç¬¦åˆæ¡ä»¶çš„è®°å½•æ‰ä¼šè¢«ä¿®æ”¹, æ²¡æœ‰ `where` é™å®šçš„å€¼æ€»æ˜¯ä¸º `true`,  
è¡¨ç¤ºè¯¥è¡¨çš„çš„æ‰€æœ‰è®°å½•éƒ½ä¼šè¢«ä¿®æ”¹

```sql
update è¡¨å set
åˆ—å1=å€¼1,
åˆ—å2=å€¼2,
...
[where æ¡ä»¶];
```

#### delete from(åˆ é™¤è¡¨ä¸­æ•°æ®)

`delete from` è¯­å¥ç”¨äºåˆ é™¤æŒ‡å®šæ•°æ®è¡¨è®°å½•, ä½¿ç”¨ `delete from` æ—¶ä¸éœ€è¦æŒ‡å®šåˆ—å, å› ä¸ºæ€»æ˜¯æ•´è¡Œçš„åˆ é™¤.

```sql
delete from è¡¨å [where æ¡ä»¶];
```

ä½¿ç”¨ `where` æŒ‡å®šåˆ é™¤æ»¡è¶³æ¡ä»¶çš„è®°å½•, ä¸ä½¿ç”¨ `where` æ—¶åˆ é™¤å…¨éƒ¨è®°å½•

### æ•°æ®åº“çº¦æŸ

- é€šè¿‡çº¦æŸå¯ä»¥æ›´å¥½çš„ä¿è¯æ•°æ®è¡¨ä¸­æ•°æ®çš„å®Œæ•´æ€§.
- çº¦æŸæ˜¯åœ¨è¡¨ä¸Šå¼ºåˆ¶æ‰§è¡Œçš„æ•°æ®æ ¡éªŒè§„åˆ™.
- å½“è¡¨ä¸­æ•°æ®å­˜åœ¨ç›¸äº’ä¾èµ–æ€§æ—¶, å¯ä»¥ä¿æŠ¤ç›¸å…³çš„æ•°æ®ä¸è¢«é”™è¯¯çš„åˆ é™¤.
- çº¦æŸåˆ†ä¸ºè¡¨çº§çº¦æŸå’Œåˆ—çº§çº¦æŸ
- çº¦æŸç±»å‹åŒ…æ‹¬
  - not null (éç©ºçº¦æŸ);
  - primary key (ä¸»é”®çº¦æŸ);
  - unique key (å”¯ä¸€çº¦æŸ);
  - default (é»˜è®¤çº¦æŸ);
  - foreign key (å¤–é”®çº¦æŸ);
  - check (æ£€æŸ¥) mysql ä¸­ä¸æ”¯æŒ

#### ç©ºå€¼ä¸éç©º

- NULL , å­—æ®µå€¼å¯ä»¥ä¸ºç©º
- NOT NULL, å­—æ®µå€¼ä¸å…è®¸ä¸ºç©º
- åˆ›å»ºè¡¨çš„æ—¶å€™æ·»åŠ çº¦æŸ

```sql
create table tb(
    username varchar(20) not null,
    age tinyint unsigned null
);
```

- è¡¨åˆ›å»ºå¥½ä¹‹åå¢åŠ åˆ é™¤éç©ºçº¦æŸ

```sql
--å¢åŠ éç©ºçº¦æŸ
alter table tb
modify age tinyint unsigned not null;
--åˆ é™¤éç©ºçº¦æŸ
alter table tb
modify username carchar(20) null;
--å–æ¶ˆéç©ºçº¦æŸå¹¶åˆ¶å®šé»˜è®¤å€¼
alter tabel tb
modify age tinyint unsigned null default 90;
```

#### primary key

- ä¸»é”®çº¦æŸç›¸å½“äºéç©ºçº¦æŸå’Œå”¯ä¸€çº¦æŸ, å³ä¸èƒ½å‡ºç°é‡å¤å€¼, ä¹Ÿä¸å…è®¸å‡ºç° null å€¼
- æ¯å¼ æ•°æ®è¡¨åªèƒ½å­˜åœ¨ä¸€ä¸ªä¸»é”®
- ä¸»é”®ä¿è¯è®°å½•çš„å”¯ä¸€æ€§
- ä¸»é”®è‡ªåŠ¨ä¸º `not null`

- åˆ›å»ºè¡¨æ—¶ä½¿ç”¨åˆ—çº§çº¦æŸè¯­æ³•

```sql
create table primary_test(
    --åˆ›å»ºä¸»é”®çº¦æŸ
    test_id int primary key,
    test_name varchar(255)
)
```

- åˆ›å»ºè¡¨æ—¶ä½¿ç”¨è¡¨çº§çº¦æŸè¯­æ³•

```sql
create table primary_tset2(
    test_id not null,
    test_name varchar(255),
    test_pass carchar(255),
    --æŒ‡å®šä¸»é”®çº¦æŸåä¸ºtest2_pk,å¯¹å¤§éƒ¨åˆ†æ•°æ®åº“æœ‰æ•ˆ,ä½†å¯¹mysqlæ— æ•ˆ,
    --mysqlæ•°æ®åº“ä¸­è¯¥ä¸»é”®çº¦æŸåä¾ç„¶æ˜¯PRI
    constraint test2_pk primary key(test_id)
);
```

- åˆ›å»ºè¡¨æ—¶å»ºç«‹ç»„åˆä¸»é”®çº¦æŸ

```sql
create table primary_test3(
    test_name varchar(255),
    test_pass varchar(255),
    primary key(test_name,test_pass)
);
```

- è¡¨è¢«åˆ›å»ºå¥½ä¹‹åæ·»åŠ ä¸»é”®çº¦æŸ

```sql
--ä½¿ç”¨addå…³é”®å­—
alter table primary_tset3
add primary key(test_name,test_pass);
--ä½¿ç”¨modifyå…³é”®å­—
--ä¸ºå•ç‹¬çš„åˆ—æ·»åŠ ä¸»é”®çº¦æŸ
alter table primary_test3
modify test_name varchar(255) primary key;
```

- åˆ é™¤æ•°æ®è¡¨çš„ä¸»é”®çº¦æŸ

```sql
alter table primary_test3
drop primary key;
```

#### auto_increment

- è‡ªåŠ¨ç¼–å·, ä¸”å¿…é¡»å’Œä¸»é”®ç»„åˆä½¿ç”¨
- é»˜è®¤æƒ…å†µä¸‹, èµ·å§‹å€¼ä¸º 1, æ¯æ¬¡çš„å¢é‡ä¸º 1

```sql
create table tb2(
    id smallint unsigned auto_increment primary key,
    username varchar(20) not null
);
```

ä¸€æ—¦æŒ‡å®šäº†æŸåˆ—å…·æœ‰è‡ªå¢é•¿ç‰¹æ€§, åˆ™å‘è¯¥è¡¨æ’å…¥è®°å½•çš„æ—¶å€™ä¸å¯ä¸ºè¯¥åˆ—æŒ‡å®šå€¼,  
è¯¥åˆ—çš„å€¼ç”±æ•°æ®åº“ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ

#### unique

- å”¯ä¸€çº¦æŸä¿è¯äº†è®°å½•çš„å”¯ä¸€æ€§
- å”¯ä¸€çº¦æŸçš„å­—æ®µå¯ä»¥ä¸ºç©º
- æ¯å¼ æ•°æ®è¡¨å¯ä»¥å­˜åœ¨å¤šä¸ªå”¯ä¸€çº¦æŸ

- å»ºè¡¨æ—¶åˆ›å»ºå”¯ä¸€çº¦æŸ ä½¿ç”¨åˆ—çº§çº¦æŸè¯­æ³•

```sql
create tabel unique_test(
    test_id int not null ,
    --å»ºç«‹å”¯ä¸€çº¦æŸ,test_nameä¸èƒ½å‡ºç°ç›¸åŒçš„å€¼
    test_name varchar(255) unique
);
```

- å»ºè¡¨æ—¶ä½¿ç”¨è¡¨çº§çº¦æŸä¸ºå¤šåˆ—ç»„åˆå»ºç«‹å”¯ä¸€çº¦æŸ

```sql
create table nuique_test2(
    test_id int not null,
    test_name varchar(255),
    test_pass varchar(255),
    --ä½¿ç”¨è¡¨çº§çº¦æŸè¯­æ³•å»ºç«‹å”¯ä¸€çº¦æŸ
    unique (test_name),
    --ä½¿ç”¨è¡¨çº§çº¦æŸè¯­æ³•å»ºç«‹å”¯ä¸€çº¦æŸ,å¹¶æŒ‡å®šçº¦æŸå
    constraint test2_nk unique (test_pass)
);
```

ä¸Šé¢åˆ†åˆ«ä¸º name å’Œ pass å»ºç«‹å”¯ä¸€çº¦æŸ, æ„å‘³ç€è¿™ä¸¤åˆ—éƒ½ä¸èƒ½å‡ºç°é‡å¤å€¼

- å»ºè¡¨æ—¶å»ºç«‹ç»„åˆå”¯ä¸€çº¦æŸ

```sql
create table nuique_test3(
    test_id int not null,
    test_name varchar(255),
    test_pass vatchar(255),
    --ä½¿ç”¨è¡¨çº§çº¦æŸè¯­æ³•å»ºç«‹å”¯ä¸€çº¦æŸ,æŒ‡å®šä¸¤åˆ—ç»„åˆä¸èƒ½ä¸ºç©º
    constraint test3_nk unique (test_name,test_pass)
);
```

ä¸Šé¢çš„æƒ…å†µè¦æ±‚ name å’Œ pass ç»„åˆçš„å€¼ä¸èƒ½å‡ºç°é‡å¤

- è¡¨åˆ›å»ºä»¥åä¿®æ”¹åˆ é™¤å”¯ä¸€çº¦æŸ

```sql
--æ·»åŠ å”¯ä¸€çº¦æŸ
alter table unique_test3
add unique(test_name,test_pass);
--ä½¿ç”¨modifyå…³é”®å­—ä¸ºå•åˆ—é‡‡ç”¨åˆ—çº§çº¦æŸè¯­æ³•æ·»åŠ å”¯ä¸€çº¦æŸ
alter table student
modify test_name varchar(255) unique;
--åˆ é™¤unique_tset3è¡¨ä¸Šçš„test3_ukå”¯ä¸€çº¦æŸ
alter table unique_test3
drop index test3_uk;
```

#### foreign key

- ä¿è¯æ•°æ®ä¸€è‡´æ€§, å®Œæ•´æ€§
- å®ç°ä¸€å¯¹ä¸€æˆ–ä¸€å¯¹å¤šå…³ç³»
- å¤–é”®çº¦æŸçš„è¦æ±‚
  - çˆ¶è¡¨å’Œå­è¡¨å¿…é¡»ä½¿ç”¨ç›¸åŒçš„å­˜å‚¨å¼•æ“, è€Œä¸”ç¦æ­¢ä½¿ç”¨ä¸´æ—¶è¡¨;
  - æ•°æ®è¡¨çš„å­˜å‚¨å¼•æ“åªèƒ½æ˜¯ InnoDB
  - å¤–é”®åˆ—å’Œå‚ç…§åˆ—å¿…é¡»å…·æœ‰ç›¸ä¼¼çš„æ•°æ®ç±»å‹, å…¶ä¸­æ•°å­—çš„é•¿åº¦æˆ–è€…æ˜¯æœ‰ç¬¦å·ä½å¿…é¡»ç›¸åŒ; è€Œå­—ç¬¦çš„é•¿åº¦åˆ™å¯ä»¥ä¸åŒ
  - å¤–é”®åˆ—å’Œå‚ç…§åˆ—å¿…é¡»åˆ›å»ºç´¢å¼•, å¦‚æœå¤–é”®åˆ—ä¸å­˜åœ¨ç´¢å¼•, MySQL å°†è‡ªåŠ¨åˆ›å»ºç´¢å¼•

å­è¡¨: æœ‰ foreign key çš„è¡¨  
çˆ¶è¡¨: è¢«å‚ç…§çš„è¡¨

![20241229154732_cdTiRaSI.webp](https://cdn.dong4j.site/source/image/20241229154732_cdTiRaSI.webp)

- é‡‡ç”¨åˆ—çº§çº¦æŸè¯­æ³•å»ºç«‹å¤–é”®çº¦æŸç›´æ¥ä½¿ç”¨ references å…³é”®å­—, references æŒ‡å®šè¯¥åˆ—å‚ç…§å“ªä¸ªä¸»è¡¨, ä»¥åŠå‚ç…§ä¸»è¡¨çš„å“ªä¸€ä¸ªåˆ—

```sql
--ä¸ºäº†ä¿è¯ä»è¡¨å‚ç…§çš„ä¸»è¡¨å­˜åœ¨,é€šå¸¸åº”è¯¥å…ˆå»ºç«‹ä¸»è¡¨
create table teacher_table1
(
    teacher_id int auto_increment,
    teacher_name carchar(255),
    primary key(teacher_id)
);
create table student_table1
(
    --ä¸ºæœ¬è¡¨å»ºç«‹ä¸»é”®çº¦æŸ
    sutdent_id int auto_increment primary key,
    sutdent_name carchar(255),
    --æŒ‡å®šjava_teacherå‚ç…§åˆ°teacher_table1çš„teahcer_idåˆ—
    java_teahcer int references teacher_table1 (teacher_id)
);
```

ä¸Šé¢è¿™ç§æ–¹æ³•åœ¨ mysql ä¸­ä¸ä¼šç”Ÿæ•ˆ, ä»…ä»…æ˜¯ä¸ºäº†å’Œæ ‡å‡†çš„ SQL ä¿æŒè‰¯å¥½çš„å…¼å®¹æ€§,  
å› æ­¤å¦‚æœè¦ä½¿ mysql ä¸­çš„å¤–é”®çº¦æŸç”Ÿæ•ˆ, åˆ™å¿…é¡»ä½¿ç”¨è¡¨çº§çº¦æŸè¯­æ³•

- è¡¨çº§çº¦æŸè¯­æ³•

```sql
create table teacher_table
(
    teacher_id int auto_increment,
    teacher_name varchar(255),
    primary key(teacher_id)
);
create table student_table
(
    student_id int auto_increment primary key,
    student_name varchar(255),
    java_teacher int,
    foreign key(java_teacher) references teacher_table(teacher_id)
);
```

ä»¥ä¸Šè¿™ç§æ–¹æ³•æ²¡æœ‰æŒ‡å®šçº¦æŸå, mysql åˆ™ä¼šä¸ºè¯¥å¤–é”®çº¦æŸåå‘½åä¸º table_name_ibfk_n, å…¶ä¸­ table_name æ—¶ä»è¡¨çš„è¡¨å, è€Œ n æ—¶ä» 1 å¼€å§‹çš„æ•´æ•°

å»ºç«‹å¤šåˆ—ç»„åˆçš„å¤–é”®çº¦æŸ

```sql
foreign key(åˆ—å1,åˆ—å2,...) references å¼•ç”¨çš„è¡¨å(å¼•ç”¨çš„åˆ—å1,å¼•ç”¨çš„åˆ—å2,...)
```

- è¡¨çº§çº¦æŸè¯­æ³•, å¹¶æŒ‡å®šå¤–é”®çº¦æŸå

```sql
create table teacher_table
(
    teacher_id int auto_increment,
    teacher_name varchar(255),
    primary key(teacher_id)
);
create table student_table
(
    student_id int auto_increment primary key,
    student_name varchar(255),
    java_teacher int,
    constraint student_teacher_fk foreign key(java_teacher) references teacher_table(teacher_id)
);
```

- æ·»åŠ å¤–é”®çº¦æŸ

```sql
alter table è¡¨å
add foreign key(åˆ—å1[,åˆ—å2,...])
references å¼•ç”¨çš„è¡¨å(å¼•ç”¨çš„åˆ—å1[,å¼•ç”¨çš„åˆ—å2,...]);
```

- åˆ é™¤å¤–é”®çº¦æŸè¯­æ³•

```sql
alter table è¡¨å
drop foreign key çº¦æŸå;
```

##### çº§è”åˆ é™¤

å¦‚æœæƒ³å®šä¹‰åˆ é™¤ä¸»è¡¨è®°å½•æ—¶, ä»è¡¨è®°å½•ä¹Ÿè¢«åˆ é™¤, åˆ™éœ€è¦åœ¨å»ºç«‹å¤–é”®çº¦æŸåæ·»åŠ   
`on delete cascade` æˆ–è€… `on delete set null`

ç¬¬ä¸€ç§æ˜¯åˆ é™¤ä¸»è¡¨è®°å½•æ—¶, æŠŠå‚ç…§è¯¥ä¸»è¡¨è®°å½•çš„ä»è¡¨è®°å½•å…¨éƒ¨çº§è”åˆ é™¤  
ç¬¬äºŒç§æ˜¯æŒ‡å®šå½“åˆ é™¤ä¸»è¡¨è®°å½•æ—¶, æŠŠå‚ç…§è¯¥ä¸»è¡¨è®°å½•çš„ä»è¡¨è®°å½•çš„å¤–é”®è®¾ç½®ä¸º null

#### default

- é»˜è®¤å€¼
- å½“æ’å…¥è®°å½•æ—¶, å¦‚æœæ²¡æœ‰æ˜ç¡®ä¸ºå­—æ®µèµ‹å€¼, åˆ™è‡ªåŠ¨èµ‹å€¼ä¸ºé»˜è®¤å€¼

### ç´¢å¼•

ç´¢å¼•æ€»æ˜¯ä»å±äºæ•°æ®è¡¨, ä½†å®ƒä¹Ÿå’Œæ•°æ®è¡¨ä¸€æ ·å±äºæ•°æ®åº“å¯¹è±¡.  
åˆ›å»ºç´¢å¼•çš„å”¯ä¸€ä½œç”¨å°±æ˜¯åŠ å¿«å¯¹è¡¨çš„æŸ¥è¯¢, ç´¢å¼•é€šè¿‡å››é€šå¿«é€Ÿè·¯å¾„è®¿é—®æ–¹æ³•æ¥å¿«é€Ÿå®šä½æ•°æ®,  
ä»è€Œå‡å°‘ç£ç›˜ I/O.

**åˆ›å»ºç´¢å¼•çš„ä¸¤ç§æ–¹å¼**

- è‡ªåŠ¨: å½“åœ¨è¡¨ä¸Šå®šä¹‰ä¸»é”®, å”¯ä¸€å’Œå¤–é”®çº¦æŸæ—¶, ç³»ç»Ÿè‡ªåŠ¨ä¸ºè¯¥æ•°æ®åˆ—åˆ›å»ºå¯¹åº”ç´¢å¼•
- æ‰‹åŠ¨: é€šè¿‡ `create index..` è¯­å¥åˆ›å»ºç´¢å¼•

**åˆ é™¤ç´¢å¼•çš„ä¸¤ç§æ–¹å¼**

- è‡ªåŠ¨: æ•°æ®è¡¨è¢«åˆ é™¤æ—¶, è¯¥è¡¨ä¸Šçš„ç´¢å¼•è‡ªåŠ¨è¢«åˆ é™¤
- æ‰‹åŠ¨: é€šè¿‡ `drop index..` è¯­å¥åˆ é™¤ç´¢å¼•
- åˆ›å»ºç´¢å¼•

```sql
create index index_name
on table_name (åˆ—å1[,åˆ—å2,...]);
```

- åˆ é™¤ç´¢å¼•

```sql
drop index index_name
on è¡¨å;
```

åœ¨ mysql æ•°æ®åº“ä¸­, ä»¥ä¸ºåªè¦æ±‚åŒä¸€ä¸ªè¡¨å†…ç´¢å¼•ä¸èƒ½åŒå, æ‰€ä»¥åˆ é™¤ç´¢å¼•æ—¶å¿…é¡»æŒ‡å®šè¡¨å  
è€Œåœ¨ä¾‹å¦‚ Oracle æ•°æ®åº“ä¸­è¦æ±‚ç´¢å¼•åå¿…é¡»ä¸åŒ, æ‰€ä»¥æ— é¡»æŒ‡å®šè¡¨å.

## [MySQL åŸºç¡€æ•™ç¨‹ï¼šä»åˆ›å»ºåˆ°å¤‡ä»½æ¢å¤](https://blog.dong4j.site/posts/329422b3.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

- è¡¨å¤´ (header): æ¯ä¸€åˆ—çš„åç§°;
- åˆ— (row): å…·æœ‰ç›¸åŒæ•°æ®ç±»å‹çš„æ•°æ®çš„é›†åˆ;
- è¡Œ (col): æ¯ä¸€è¡Œç”¨æ¥æè¿°æŸä¸ªäºº / ç‰©çš„å…·ä½“ä¿¡æ¯;
- å€¼ (value): è¡Œçš„å…·ä½“ä¿¡æ¯, æ¯ä¸ªå€¼å¿…é¡»ä¸è¯¥åˆ—çš„æ•°æ®ç±»å‹ç›¸åŒ;
- é”® (key): è¡¨ä¸­ç”¨æ¥è¯†åˆ«æŸä¸ªç‰¹å®šçš„äººæˆ–ç‰©çš„æ–¹æ³•, é”®çš„å€¼åœ¨å½“å‰åˆ—ä¸­å…·æœ‰å”¯ä¸€æ€§

### SQL è¯­å¥çš„åˆ†ç±»

- DQL æŸ¥è¯¢è¯­å¥ select
- DML æ“ä½œè¯­å¥ insert update delete
- DDL å®šä¹‰è¯­å¥ create alter drop truncate
- DCL æ§åˆ¶è¯­å¥ grant revoke
- å®åŠ¡æ§åˆ¶è¯­å¥ commit rollback savepoint

### MySQL æœåŠ¡çš„å¯åŠ¨ã€åœæ­¢ä¸å¸è½½

åœ¨ Windows å‘½ä»¤æç¤ºç¬¦ä¸‹è¿è¡Œ:  
å¯åŠ¨: net start MySQL  
åœæ­¢: net stop MySQL  
å¸è½½: sc delete MySQL

### MySQL çš„ç™»å½•

#### MySQL å‚æ•°

| å‚æ•°                 |               æè¿° |
| :------------------- | -----------------: |
| -D, â€“fatabase = name |     æ‰“å¼€æŒ‡å®šæ•°æ®åº“ |
| â€“delimiter = name    |         æŒ‡å®šåˆ†éš”ç¬¦ |
| -h, â€“host = name     |         æœåŠ¡å™¨åå­— |
| -p, â€“password[=name] |               å¯†ç  |
| -P, â€“port=#          |             ç«¯å£å· |
| â€“prompt=name         |         è®¾ç½®æç¤ºç¬¦ |
| -u, â€“user=name       |             ç”¨æˆ·å |
| -V, â€“version         | è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯å¹¶é€€å‡º |

![20241229154732_mIOdOceD.webp](https://cdn.dong4j.site/source/image/20241229154732_mIOdOceD.webp)

å¦‚æœç™»å½•æœ¬åœ°æœåŠ¡å™¨, åˆ™å¯ä»¥ä¸å†™ç«¯å£å·å’Œ IP åœ°å€

#### cmd ç™»å½• mysql

> mysql -h ä¸»æœºå -u ç”¨æˆ·å -p (å›è½¦)

##### ç™»å½•æ—¶é€‰æ‹©ä½¿ç”¨å“ªä¸ªæ•°æ®åº“

> mysql -D é€‰æ‹©çš„æ•°æ®åº“å -h ä¸»æœºå -u ç”¨æˆ·å -p

- h : è¯¥å‘½ä»¤ç”¨äºæŒ‡å®šå®¢æˆ·ç«¯æ‰€è¦ç™»å½•çš„ MySQL ä¸»æœºå, ç™»å½•å½“å‰æœºå™¨è¯¥å‚æ•°å¯ä»¥çœç•¥;
- u : æ‰€è¦ç™»å½•çš„ç”¨æˆ·å;
- p : å‘Šè¯‰æœåŠ¡å™¨å°†ä¼šä½¿ç”¨ä¸€ä¸ªå¯†ç æ¥ç™»å½•, å¦‚æœæ‰€è¦ç™»å½•çš„ç”¨æˆ·åå¯†ç ä¸ºç©º, å¯ä»¥å¿½ç•¥æ­¤é€‰é¡¹

#### ä¿®æ”¹ MySQL æç¤ºç¬¦

- è¿æ¥å®¢æˆ·ç«¯æ—¶é€šè¿‡å‚æ•°æŒ‡å®š

> mysql -uroot - p â€“prompt æç¤ºç¬¦

![20241229154732_11dDPovH.webp](https://cdn.dong4j.site/source/image/20241229154732_11dDPovH.webp)

`--prompt` åé¢è·Ÿçš„ `\h` å‚æ•°è¡¨ç¤ºæœåŠ¡å™¨åå­—

- è¿ä¸Šå®¢æˆ·ç«¯åé€šè¿‡ `prompt` å‘½ä»¤

> mysql > prompt æç¤ºç¬¦

![20241229154732_DKXsoFjh.webp](https://cdn.dong4j.site/source/image/20241229154732_DKXsoFjh.webp)

æç¤ºç¬¦ä»åŸæ¥çš„ `loaclhost` å˜æˆäº† `mysql>`

- æˆ–è€… `\R`

> mysql > `\R` æç¤ºç¬¦

![20241229154732_uzTrtuvG.webp](https://cdn.dong4j.site/source/image/20241229154732_uzTrtuvG.webp)

å‚çœ‹ mysql çš„å‘½ä»¤çŸ¥é“:

> prompt (`\R`) Change your mysql prompt.

å¯ä»¥ä½¿ç”¨ `\R` ä»£æ›¿ `prompt`

æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨æç¤ºç¬¦å‚æ•°æ¥å¢åŠ æç¤ºç¬¦ä¿¡æ¯

##### Mysql æç¤ºç¬¦

| å‚æ•° |       æè¿° |
| :--- | ---------: |
| `\D` | å®Œæ•´çš„æ—¥æœŸ |
| `\d` | å½“å‰æ•°æ®åº“ |
| `\h` | æœåŠ¡å™¨åç§° |
| `\u` |   å½“å‰ç”¨æˆ· |

![20241229154732_ZnBVWt71.webp](https://cdn.dong4j.site/source/image/20241229154732_ZnBVWt71.webp)

ä½¿ç”¨ `\d` å‚æ•°æ—¶, å¿…é¡»ä½¿ç”¨ `use æ•°æ®åº“å` åˆ‡æ¢åˆ°æŒ‡å®šæ•°æ®åº“  
ä¸ç„¶ä¼šæ˜¾ç¤ºä¸º null

![20241229154732_yJ1tKd1l.webp](https://cdn.dong4j.site/source/image/20241229154732_yJ1tKd1l.webp)

### é€€å‡º MySQL

- mysql > exit
- mysql > quit
- mysql > `\q`

### MySQL å¸¸ç”¨å‘½ä»¤

- æ˜¾ç¤ºå½“å‰æœåŠ¡å™¨ç‰ˆæœ¬
  - `SELECT VERSION();`
- æ˜¾ç¤ºå½“å‰æ—¥æœŸ
  - `SELECT NOW();`
- æ˜¾ç¤ºå½“å‰ç”¨æˆ·
  - `SELECT USER();`
- æ·»åŠ ç®¡ç†å‘˜è´¦æˆ·
  - `grant all on *.* to user@localhost identified by "password";`  
     ![20241229154732_nIq4S1eJ.webp](https://cdn.dong4j.site/source/image/20241229154732_nIq4S1eJ.webp)

#### ä¿®æ”¹å¯†ç 

> mysqladmin -u root -p password æ–°å¯†ç 

æ‰§è¡Œåæç¤ºè¾“å…¥æ—§å¯†ç å®Œæˆå¯†ç ä¿®æ”¹, å½“æ—§å¯†ç ä¸ºç©ºæ—¶ç›´æ¥æŒ‰å›è½¦é”®ç¡®è®¤å³å¯.

### MySQL è¯­å¥çš„è§„èŒƒ

- å…³é”®å­—ä¸å‡½æ•°åç§°å…¨éƒ¨å¤§å†™
- æ•°æ®åº“åç§°, è¡¨åç§°, å­—æ®µåç§°å°å†™
- SQL è¯­å¥å¿…é¡»ä»¥åˆ†å·ç»“å°¾

MySQL ä¹Ÿå¯ä»¥å…¨ç¨‹ä½¿ç”¨å°å†™  
(ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹, æœ¬æ–‡ä¸­å…¨éƒ¨ä½¿ç”¨å°å†™å‘½ä»¤)

### MySQL æ•°æ®åº“çš„æ“ä½œ

#### æ˜¾ç¤ºæ‰€æœ‰å­˜åœ¨çš„æ•°æ®åº“

> show databases;

#### åˆ›å»ºæ•°æ®åº“

> create{database| schema}  
> [if not exists] db_name â€“å¦‚æœä¸å­˜åœ¨ `db_name` è¿™ä¸ªæ•°æ®åº“å°±åˆ›å»º db_name æ•°æ®åº“  
> [defalut] character set [=] charset_name; â€“è®¾ç½®ç¼–ç æ ¼å¼

![20241229154732_NJFvISw9.webp](https://cdn.dong4j.site/source/image/20241229154732_NJFvISw9.webp)

- **åœ¨ç™»å½•çš„æ—¶å€™åˆ›å»º**

> mysqladmin -u root -p create demo_db

#### åˆ é™¤æ•°æ®åº“

> drop {database | schema} [if exists] db_name;

#### ä½¿ç”¨æ•°æ®åº“

> use æ•°æ®åº“åç§°;

æ˜¾ç¤ºå½“å‰é€‰æ‹©çš„æ•°æ®åº“

> select database();

## æ•°æ®ç±»å‹å’Œæ“ä½œæ•°æ®è¡¨

### æ•°æ®ç±»å‹

æ•°æ®ç±»å‹æŒ‡çš„æ˜¯åˆ—, å­˜å‚¨è¿‡ç¨‹å‚æ•°, è¡¨è¾¾å¼å’Œå±€éƒ¨å˜é‡çš„æ•°æ®ç‰¹å¾,  
ä»–å†³å®šäº†æ•°æ®çš„å­˜å‚¨æ ¼å¼, ä»£è¡¨äº†ä¸åŒçš„ä¿¡å¿ƒç±»å‹

### æ•´å‹

| æ•°æ®ç±»å‹  | å­—èŠ‚ |
| :-------- | ---: |
| tinyint   |    1 |
| smallint  |    2 |
| mediumint |    3 |
| int       |    4 |
| bigint    |    8 |

### æµ®ç‚¹å‹

| æ•°æ®ç±»å‹      | æè¿°                                        |
| :------------ | :------------------------------------------ |
| float[(m,d)]  | m æ˜¯æ•°å­—ä¸­ä½æ•°, d æ˜¯å°æ•°ä½æ•°                |
| double[(m,d)] | å¦‚æœçœç•¥ m å’Œ d, æ ¹æ®ç¡¬ä»¶å…è®¸çš„é™åˆ¶æ¥ä¿å­˜å€¼ |

### æ—¥æœŸç±»å‹

| åˆ—ç±»å‹    | å­˜å‚¨éœ€æ±‚ | æè¿°                                                                     |
| :-------- | :------: | :----------------------------------------------------------------------- |
| year      |    1     | é»˜è®¤å­˜å‚¨ 4 ä½æ•°å­—                                                        |
| time      |    3     | -8385959 åˆ° 8385959                                                      |
| date      |    3     | 1000 å¹´ 1 æœˆ 1 æ—¥åˆ° 9999 å¹´ 12 æœˆ 31 æ—¥ä¹‹é—´çš„æ—¥æœŸ                        |
| datetime  |    8     | 1000 å¹´ 1 æœˆ 1 æ—¥ 0 ç‚¹ 0 åˆ† 0 ç§’åˆ° 9999 å¹´ 12 æœˆ 31 æ—¥ 59 ç‚¹ 59 åˆ† 59 ç§’ |
| timestamp |    4     | æ—¶é—´æˆ³: 1970.1.1 åˆ° 2037 å¹´ 12.31                                        |

### å­—ç¬¦å‹

| åˆ—ç±»å‹                    | æè¿°                                                               |
| :------------------------ | :----------------------------------------------------------------- |
| char(m)                   | (å®šé•¿) m ä¸ªå­—èŠ‚, 0<=m<=255                                         |
| varchar(m)                | (å˜é•¿) L+1 ä¸ªå­—èŠ‚, L<=m ä¸” 0<=m<=65535                             |
| tinytext                  | L+1 ä¸ªå­—èŠ‚, L<2 çš„ 8 æ¬¡æ–¹                                          |
| text                      | L+2 ä¸ªå­—èŠ‚, L<2 çš„ 16 æ¬¡æ–¹                                         |
| mediumtext                | L+3 ä¸ªå­—èŠ‚, L<2 çš„ 24 æ¬¡æ–¹                                         |
| longtext                  | L+4 ä¸ªå­—èŠ‚, L<2 çš„ 32 æ¬¡æ–¹                                         |
| enum(â€˜value1â€™,â€™value2â€™,â€¦) | 1 æˆ– 2 ä¸ªå­—èŠ‚, å–å†³äºæšä¸¾å€¼çš„ä¸ªæ•° (æœ€å¤š 65535 ä¸ªå€¼)                |
| set(â€˜value1â€™,â€™value2â€™,â€¦)  | (é›†åˆ) 1,2,3,4 æˆ– 8 ä¸ªå­—èŠ‚, å–å†³äº set æˆå‘˜çš„æ•°ç›® (æœ€å¤š 64 ä¸ªæˆå‘˜) |

#### åˆ›å»ºæ•°æ®è¡¨

```
create table [if not exists] table_name(
    cloumn_name1 data_type,
    cloumn_name2 data_type,
    ...
);
```

æœ€åä¸€æ¡è¯­å¥ä¸éœ€è¦åŠ  `,`;

```
create table tb1(
    username varchar(20),
    age tinyint unsigned, --æ— ç¬¦å·
    salary float(8,2) unsigned
);
```

ä»¥åˆ›å»º students è¡¨ä¸ºä¾‹, è¡¨ä¸­å°†å­˜æ”¾ å­¦å· (id)ã€å§“å (name)ã€æ€§åˆ« (sex)ã€å¹´é¾„ (age)ã€è”ç³»ç”µè¯ (tel) è¿™äº›å†…å®¹:

```
create table students
ï¼ˆ
    id int unsigned not null auto_increment primary key,
    name char(8) not null,
    sex char(4) not null,
    age tinyint unsigned not null,
    tel char(13) null default '-'
);
```

(æç¤º: 1. å¦‚æœè¿æ¥è¿œç¨‹ä¸»æœºè¯·åŠ ä¸Š -h æŒ‡ä»¤; 2. createtable.sql æ–‡ä»¶è‹¥ä¸åœ¨å½“å‰å·¥ä½œç›®å½•ä¸‹éœ€æŒ‡å®šæ–‡ä»¶çš„å®Œæ•´è·¯å¾„ã€‚)

è¯­å¥è§£è¯´:

- create table tablename(columns) ä¸ºåˆ›å»ºæ•°æ®åº“è¡¨çš„å‘½ä»¤, åˆ—çš„åç§°ä»¥åŠè¯¥åˆ—çš„æ•°æ®ç±»å‹å°†åœ¨æ‹¬å·å†…å®Œæˆ;

æ‹¬å·å†…å£°æ˜äº† 5 åˆ—å†…å®¹, idã€nameã€sexã€ageã€tel ä¸ºæ¯åˆ—çš„åç§°, åé¢è·Ÿçš„æ˜¯æ•°æ®ç±»å‹æè¿°, åˆ—ä¸åˆ—çš„æè¿°ä¹‹é—´ç”¨é€—å· (,) éš”å¼€;

ä»¥ â€œid int unsigned not null auto_increment primary keyâ€ è¡Œè¿›è¡Œä»‹ç»:

- â€œidâ€ ä¸ºåˆ—çš„åç§°;
- â€œintâ€ æŒ‡å®šè¯¥åˆ—çš„ç±»å‹ä¸º int(å–å€¼èŒƒå›´ä¸º -8388608 åˆ° 8388607), åœ¨åé¢æˆ‘ä»¬åˆç”¨ - â€œunsignedâ€ åŠ ä»¥ä¿®é¥°, è¡¨ç¤ºè¯¥ç±»å‹ä¸ºæ— ç¬¦å·å‹, æ­¤æ—¶è¯¥åˆ—çš„å–å€¼èŒƒå›´ä¸º 0 åˆ° 16777215;
- â€œnot nullâ€ è¯´æ˜è¯¥åˆ—çš„å€¼ä¸èƒ½ä¸ºç©º, å¿…é¡»è¦å¡«, å¦‚æœä¸æŒ‡å®šè¯¥å±æ€§, é»˜è®¤å¯ä¸ºç©º;
- â€œauto_incrementâ€ éœ€åœ¨æ•´æ•°åˆ—ä¸­ä½¿ç”¨, å…¶ä½œç”¨æ˜¯åœ¨æ’å…¥æ•°æ®æ—¶è‹¥è¯¥åˆ—ä¸º NULL, MySQL å°†è‡ªåŠ¨äº§ç”Ÿä¸€ä¸ªæ¯”ç°å­˜å€¼æ›´å¤§çš„å”¯ä¸€æ ‡è¯†ç¬¦å€¼ã€‚åœ¨æ¯å¼ è¡¨ä¸­ä»…èƒ½æœ‰ä¸€ä¸ªè¿™æ ·çš„å€¼ä¸”æ‰€åœ¨åˆ—å¿…é¡»ä¸ºç´¢å¼•åˆ—ã€‚
- â€œprimary keyâ€ è¡¨ç¤ºè¯¥åˆ—æ˜¯è¡¨çš„ä¸»é”®, æœ¬åˆ—çš„å€¼å¿…é¡»å”¯ä¸€, MySQL å°†è‡ªåŠ¨ç´¢å¼•è¯¥åˆ—ã€‚  
   ä¸‹é¢çš„ char(8) è¡¨ç¤ºå­˜å‚¨çš„å­—ç¬¦é•¿åº¦ä¸º 8, tinyint çš„å–å€¼èŒƒå›´ä¸º -127 åˆ° 128, default å±æ€§æŒ‡å®šå½“è¯¥åˆ—å€¼ä¸ºç©ºæ—¶çš„é»˜è®¤å€¼ã€‚

#### å‚çœ‹æ•°æ®è¡¨åˆ—è¡¨

> show tables [from db_name] [like â€˜patternâ€™ | where expr];

å¦‚æœç›´æ¥å†™ `show tables` ä¼šæ˜¾ç¤ºå½“å‰æ‰€é€‰æ‹©çš„æ•°æ®åº“ä¸­çš„æ‰€æœ‰æ•°æ®è¡¨  
å¦‚æœåŠ ä¸Šäº† `from`, ä¼šæ˜¾ç¤ºç‰¹å®šæ•°æ®åº“ä¸­çš„è¡¨  
ä½†æ˜¯å½“å‰æ‰€åœ¨æ•°æ®åº“çš„ä½ç½®æ²¡æœ‰æ”¹å˜

#### å‚çœ‹æ•°æ®è¡¨ç»“æ„

> show columns from tb_name;  
> æˆ–è€…  
> describe (desc) tb_name;

#### æ’å…¥è®°å½•

> insert [into] tb_name [(col_name1,col_name2,â€¦)] values(val1,val2,..);

```
insert into students values
    (1,'å¼ ä¸‰','ç”·',25,'123467890'),
    (2,'æå››','ç”·',22,'0987654321'),
    (3,'ç‹äº”','ç”·',20,'0984324321'),
    (4,'èµµå…­','ç”·',29,'0944654321');
```

å½“åªéœ€è¦æ’å…¥éƒ¨åˆ†æ•°æ®, æˆ–è€…ä¸æŒ‰ç…§é¡ºåºæ’å…¥

> insert into students (name,sex,age) values(â€˜ç”°ä¸ƒâ€™,â€™ç”·â€™,30);

#### æ›´æ–°è®°å½•

> update students set age = 50 where name = â€˜å¼ ä¸‰â€™;

#### åˆ é™¤è®°å½•

> delete from students where id > 1; â€“åˆ é™¤ ID å¤§äº 1 çš„æ‰€æœ‰è®°å½•
>
> delete from students where id = 10 limit 1 â€“é™åˆ¶åˆ é™¤æ‰ 1 æ¡ id=10 çš„è®°å½•
>
> delete from students; â€“åˆ é™¤å…¨è¡¨è®°å½•
>
> drop table tablename1, tablename2, â€¦.; â€“åˆ é™¤å¤šä¸ªè¡¨

#### æ›´æ”¹è¡¨å

> alter table t1 rename t2;

#### ä¿®æ”¹å­—æ®µå±æ€§

> alter table tablename modify int(10) unsigned auto_increment primary key not null;

#### ä¿®æ”¹é»˜è®¤å€¼

> alter table tablename alter id default 0;

#### ç»™å­—æ®µæ·»åŠ ä¸»é”®

> alter table tablename add primary key(id);

#### åˆ é™¤ä¸»é”®

> alter table tablename drop primary key;

æˆ–è€…

> drop primary key on tablename;

#### ä¿®æ”¹è¡¨æ•°æ®å¼•æ“

> alter table tablename ENGINE = MyISAM(InnoDB);

#### å¢åŠ æ–°å­—æ®µ (åˆ—)

> alter table tablename add column single char(1);

æˆ–è€…

> alter table tablename add field int unsigned not null;

#### æ•°æ®çš„å¤‡ä»½å’Œæ¢å¤

##### å¤‡ä»½

> mysqldump -u root -p demo_db students > `C:\Users\CodeA\Desktop\abc.sql`

##### æ¢å¤

è¿›å…¥ mysql

> create database school;  
> use school;  
> source school.sql;

##### å¯¼å‡ºæ•°æ®åº“

mysqldump â€“databases db1 db2 >db1.db2.sql;

## [è½»æ¾æŒæ¡Java Propertiesæ–‡ä»¶æ“ä½œï¼Œä»å…¥é—¨åˆ°å®è·µ](https://blog.dong4j.site/posts/c89e3217.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

`public class Propertiesextends Hashtable<Object,Object>`  
Properties ç±»è¡¨ç¤ºäº†ä¸€ä¸ªæŒä¹…çš„å±æ€§é›†ã€‚Properties å¯ä¿å­˜åœ¨æµä¸­æˆ–ä»æµä¸­åŠ è½½ã€‚å±æ€§åˆ—è¡¨ä¸­æ¯ä¸ªé”®åŠå…¶å¯¹åº”å€¼éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚  
æ–°å»ºä¸€ä¸ªæ–‡ä»¶  
å†…å®¹ä¸º  
é”® 1 = å€¼ 1  
é”® 2 = å€¼ 2  
â€¦

ä½¿ç”¨æ­¤ç±»å¯ä»¥å¯¹æ–‡ä»¶æ•°æ®è¿›è¡ŒæŒä¹…åŒ–ä¿å­˜

### æ–¹æ³•çš„ä½¿ç”¨

- `load(InputStream inStream);` ä»è¾“å…¥æµä¸­è¯»å–å±æ€§åˆ—è¡¨ï¼ˆé”®å’Œå…ƒç´ å¯¹ï¼‰ã€‚

```
Properties pro = new Properties();
pro.load(new FileInputStream(ç›¸å¯¹è·¯å¾„æˆ–ç»å¯¹è·¯å¾„));//æ­¤æ–¹æ³•å°†æŠ›å‡ºFileNotFoundException
```

- `getPropertiy(String key)` ä½¿ç”¨æŒ‡å®šçš„é”®åœ¨æ­¤å±æ€§åˆ—è¡¨ä¸­æœç´¢å±æ€§, è¿”å› String
- `getProperty(String key, String defaultValue)` ç”¨æŒ‡å®šçš„é”®åœ¨å±æ€§åˆ—è¡¨ä¸­æœç´¢å±æ€§ã€‚è¿”å› String
- `setProperty(String key, String value)` å¦‚æœå­˜åœ¨äº†è¿™ä¸ªé”®, åˆ™æ›´æ”¹å¯¹åº”çš„å€¼, å¦‚æœä¸å­˜åœ¨, åˆ™æ·»åŠ è¿™ä¸ªå±æ€§, è¿™ä¸ªæ–¹æ³•æ˜¯è°ƒç”¨ Hashtable çš„ put çš„ç»“æœ
- `public void store(OutputStream out, String comments) throws IOException` å†™å…¥æ–‡ä»¶ä¸­

```java
props.store(new FileOutputStream(ç›¸å¯¹è·¯å¾„æˆ–ç»å¯¹è·¯å¾„), è¯´æ˜);
```

### Properties ç»¼åˆä½¿ç”¨

```java
import java.io.*;
import java.util.*;
public class PropertiesTest {
    static Properties props = new Properties();
    public static void main(String[] args) {
        //è¯»æ–‡ä»¶
        Read();
        System.out.println(props.getProperty("Teacher"));
        //æ·»åŠ æ•°æ®
        //ä½¿ç”¨setProperties()æ–¹æ³•,å¦‚æœæ–‡ä»¶ä¸­æ²¡æœ‰ç›¸åŒçš„é”®,åˆ™æ·»åŠ ,å¦‚æœæœ‰ç›¸åŒçš„,å°±è¦†ç›–
        props.setProperty("Teacher","èƒ¡è€å¤§");
        props.setProperty("Student","Code");
        System.out.println(props.getProperty("Student"));
        Save();
        //åˆ é™¤å…¨éƒ¨æ•°æ®
        //ç›´æ¥åœ¨æ²¡æœ‰åŠ è½½æ–‡ä»¶çš„æƒ…å†µä¸‹ä½¿ç”¨store()æ–¹æ³•å­˜å…¥ç©ºæ•°æ®åˆ°æ–‡ä»¶ä¸­
        Read();
        //å­˜å…¥Sudtentå¯¹è±¡
        for(int i = 0 ; i < 3; i++){
            Scanner scan = new Scanner(System.in);
            System.out.println("è¯·è¾“å…¥å­¦ç”Ÿåå­—ï¼š");
            String name = scan.next();
            System.out.println("è¯·è¾“å…¥å­¦ç”Ÿå¹´é¾„ï¼š");
            int age = scan.nextInt();
            System.out.println("è¯·è¾“å…¥å­¦ç”Ÿæˆç»©");
            int score = scan.nextInt();
            Student stu = new Student(name,age,score);
            props.setProperty(stu.getName(), stu.getName() + "&" + stu.getAge() + "&" + stu.getScore());
        }
        Save();
        //åˆ é™¤æŒ‡å®šçš„é”®  ç›´æ¥è°ƒç”¨Mapç±»çš„removeæ–¹æ³•
        props.remove("Student");
        Save();
        //æ„é€ å­¦ç”Ÿå¯¹è±¡
        //æŠŠå€¼å–å‡ºæ¥åˆ†è§£,ç„¶åèµ‹å€¼ç»™å­¦ç”Ÿ
        //è°ƒç”¨ç»§æ‰¿Mapçš„values()æ–¹æ³•,å–å¾—æ‰€æœ‰çš„å€¼
        Collection<String> cl = props.values();
        for(String str : cl){
            System.out.println(str);
            //æ‹†åˆ†å­—ç¬¦ä¸²
        }
    }
    public static void Read(){
        try {
            props.load(new FileInputStream("data.properties"));
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
    //å­˜æ–‡ä»¶
    public static void Save(){
        try {
            props.store(new FileOutputStream("data.properties"), null);
        } catch (FileNotFoundException e) {
        // TODO Auto-generated catch block
            e.printStackTrace();
        } catch (IOException e) {
        // TODO Auto-generated catch block
            e.printStackTrace();
        }
    }
}
```

## [HashSetã€TreeSetã€HashMapï¼šJavaé›†åˆç±»çš„æ ¸å¿ƒ](https://blog.dong4j.site/posts/220ed6be.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

Java Conllection Frame

![20241229154732_HsNl759p.webp](https://cdn.dong4j.site/source/image/20241229154732_HsNl759p.webp)

åœ¨é›†åˆæ¡†æ¶ä¸­ï¼Œåˆ†ä¸ºä¸¤ç§ APIï¼š

1. è£…è½½æ•°æ®çš„é›†åˆç±»

- HashSet ç±»
- ArrayList ç±»
- LinkedList ç±»
- HashMap ç±»
- â€¦.

2. æ“ä½œé›†åˆçš„å·¥å…·ç±»

- Arrays ç±»
- Collections ç±»

### Iterator æ¥å£

java.util  
`public interface Iterator`  
Iterator æ¨¡å¼æ˜¯ç”¨äºéå†é›†åˆç±»çš„æ ‡å‡†è®¿é—®æ–¹æ³•ã€‚  
å®ƒå¯ä»¥æŠŠè®¿é—®é€»è¾‘ä»ä¸åŒç±»å‹çš„é›†åˆç±»ä¸­æŠ½è±¡å‡ºæ¥ï¼Œä»è€Œé¿å…å‘å®¢æˆ·ç«¯æš´éœ²é›†åˆçš„å†…éƒ¨ç»“æ„

```java
public interface Iterator{
    boolean hasNext();//å¦‚æœä»æœ‰å…ƒç´ å¯ä»¥è¿­ä»£ï¼Œåˆ™è¿”å› true
    Object next();//è¿”å›è¿­ä»£çš„ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚ NoSuchElementException - æ²¡æœ‰å…ƒç´ å¯ä»¥è¿­ä»£ã€‚
    void remove();//ä»è¿­ä»£å™¨æŒ‡å‘çš„ collection ä¸­ç§»é™¤è¿­ä»£å™¨è¿”å›çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼ˆå¯é€‰æ“ä½œï¼‰ã€‚
}
```

### Iterable æ¥å£

java.lang  
`public interface Iterable`  
å®ç°è¿™ä¸ªæ¥å£å…è®¸å¯¹è±¡æˆä¸º â€œforeachâ€ è¯­å¥çš„ç›®æ ‡ã€‚

Iterable åªæœ‰ä¸€ä¸ªæ–¹æ³•  
`iterator()` è¿”å›ä¸€ä¸ªè¿­ä»£å™¨  
å®ç°ç±»åŒ…æ‹¬ä»Šå¤©æ‰€å­¦çš„ ArrayList,HashSet,LinkedList ç­‰ç±»  
ç„¶è€Œå¹¶æ²¡æœ‰è¢« HashMap ç±»å®ç°.

### æ³›å‹

æ³›å‹ï¼ˆGeneric type æˆ–è€… genericsï¼‰æ˜¯å¯¹ Java è¯­è¨€çš„ç±»å‹ç³»ç»Ÿçš„ä¸€ç§æ‰©å±•ï¼Œä»¥æ”¯æŒåˆ›å»ºå¯ä»¥æŒ‰ç±»å‹è¿›è¡Œå‚æ•°åŒ–çš„ç±»ã€‚å¯ä»¥æŠŠç±»å‹å‚æ•°çœ‹ä½œæ˜¯ä½¿ç”¨å‚æ•°åŒ–ç±»å‹æ—¶æŒ‡å®šçš„ç±»å‹çš„ä¸€ä¸ªå ä½ç¬¦ï¼Œå°±åƒæ–¹æ³•çš„å½¢å¼å‚æ•°æ˜¯è¿è¡Œæ—¶ä¼ é€’çš„å€¼çš„å ä½ç¬¦ä¸€æ ·ã€‚

å¯ä»¥åœ¨é›†åˆæ¡†æ¶ï¼ˆCollection frameworkï¼‰ä¸­çœ‹åˆ°æ³›å‹çš„åŠ¨æœºã€‚ä¾‹å¦‚ï¼ŒMap ç±»å…è®¸æ‚¨å‘ä¸€ä¸ª Map æ·»åŠ ä»»æ„ç±»çš„å¯¹è±¡ï¼Œå³ä½¿æœ€å¸¸è§çš„æƒ…å†µæ˜¯åœ¨ç»™å®šæ˜ å°„ï¼ˆmapï¼‰ä¸­ä¿å­˜æŸä¸ªç‰¹å®šç±»å‹ï¼ˆæ¯”å¦‚ Stringï¼‰çš„å¯¹è±¡ã€‚

å› ä¸º Map.get() è¢«å®šä¹‰ä¸ºè¿”å› Objectï¼Œæ‰€ä»¥ä¸€èˆ¬å¿…é¡»å°† Map.get() çš„ç»“æœå¼ºåˆ¶ç±»å‹è½¬æ¢ä¸ºæœŸæœ›çš„ç±»å‹ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š

```
HashMap m = new HashMap();
m.put("key", "blarg");
String s = (String) m.get("key");
```

è¦è®©ç¨‹åºé€šè¿‡ç¼–è¯‘ï¼Œå¿…é¡»å°† get() çš„ç»“æœå¼ºåˆ¶ç±»å‹è½¬æ¢ä¸º Stringï¼Œå¹¶ä¸”å¸Œæœ›ç»“æœçœŸçš„æ˜¯ä¸€ä¸ª Stringã€‚ä½†æ˜¯æœ‰å¯èƒ½æŸäººå·²ç»åœ¨è¯¥æ˜ å°„ä¸­ä¿å­˜äº†ä¸æ˜¯ String çš„ä¸œè¥¿ï¼Œè¿™æ ·çš„è¯ï¼Œä¸Šé¢çš„ä»£ç å°†ä¼šæŠ›å‡º ClassCastExceptionã€‚

```
HashMap<String,String> m = new HashMap<String,String>();
m.put("key", "blarg");
String s =  m.get("key");
```

ç†æƒ³æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå¾—å‡ºè¿™æ ·ä¸€ä¸ªè§‚ç‚¹ï¼Œå³ m æ˜¯ä¸€ä¸ª Mapï¼Œå®ƒå°† String é”®æ˜ å°„åˆ° String å€¼ã€‚è¿™å¯ä»¥**æ¶ˆé™¤ä»£ç ä¸­çš„å¼ºåˆ¶ç±»å‹è½¬æ¢**ï¼Œ**åŒæ—¶è·å¾—ä¸€ä¸ªé™„åŠ çš„ç±»å‹æ£€æŸ¥å±‚**ï¼Œè¯¥æ£€æŸ¥å±‚å¯ä»¥é˜²æ­¢æœ‰äººå°†é”™è¯¯ç±»å‹çš„é”®æˆ–å€¼ä¿å­˜åœ¨é›†åˆä¸­ã€‚è¿™å°±æ˜¯æ³›å‹æ‰€åšçš„å·¥ä½œã€‚

### Collection æ¥å£

`public interface Collection extends Iterable{}`

> Collection å±‚æ¬¡ç»“æ„ ä¸­çš„æ ¹æ¥å£ã€‚Collection è¡¨ç¤ºä¸€ç»„å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡ä¹Ÿç§°ä¸º collection çš„å…ƒç´ ã€‚ä¸€äº› collection å…è®¸æœ‰é‡å¤çš„å…ƒç´ ï¼Œè€Œå¦ä¸€äº›åˆ™ä¸å…è®¸ã€‚ä¸€äº› collection æ˜¯æœ‰åºçš„ï¼Œè€Œå¦ä¸€äº›åˆ™æ˜¯æ— åºçš„ã€‚JDK ä¸æä¾›æ­¤æ¥å£çš„ä»»ä½•ç›´æ¥ å®ç°ï¼šå®ƒæä¾›æ›´å…·ä½“çš„å­æ¥å£ï¼ˆå¦‚ Set å’Œ Listï¼‰å®ç°ã€‚æ­¤æ¥å£é€šå¸¸ç”¨æ¥ä¼ é€’ collectionï¼Œå¹¶åœ¨éœ€è¦æœ€å¤§æ™®éæ€§çš„åœ°æ–¹æ“ä½œè¿™äº› collectionã€‚

Collection æ¥å£å®šä¹‰äº† Collection å¯¹è±¡å…¬æœ‰çš„ä¸€äº›åŸºæœ¬æ–¹æ³•, è¿™äº›æ–¹æ³•åˆ†ä¸º:

- åŸºæœ¬æ“ä½œ
  - int size()
  - isEmpty()
  - boolean contains(Object obj) åˆ¤æ–­é›†åˆä¸­æ˜¯å¦åŒ…å«æŒ‡å®šå…ƒç´ 
  - boolean add(Object obj) å‘é›†åˆä¸­æ·»åŠ å…ƒç´ 
  - boolea remove(Object obj) åˆ é™¤æŸå…ƒç´ 
  - Iterator iterator() è¿”å›ä¸€ä¸ªéå†å™¨, ç”¨æ¥è®¿é—®é›†åˆä¸­çš„å„ä¸ªå…ƒç´ 
- æ‰¹é‡æ“ä½œ
  - containsAll(Collection c) åˆ¤æ–­é›†åˆä¸­æ˜¯å¦åŒ…å«æŒ‡å®šé›†åˆ
  - â€¦.
- æ•°ç»„æ“ä½œ
  - Object[] toArray() è¿”å›ä¸€ä¸ªåŒ…å«é›†åˆæ‰€æœ‰å…ƒç´ çš„ array æ•°ç»„.

#### List æ¥å£

ä¸€åˆ—æ•°æ®ï¼Œæ•°æ®å†…å®¹å¯ä»¥é‡å¤ï¼Œä»¥å…ƒç´ å®‰æ’çš„æ¬¡åºæ¥æ”¾ç½®å…ƒç´ ï¼Œä¸ä¼šé‡æ–°æ’åˆ—ã€‚

- ç‰¹ç‚¹
  - å…¶ä¸­çš„å…ƒç´ æ˜¯æœ‰é¡ºåºçš„
  - å…è®¸é‡å¤å…ƒç´ 
  - æ”¯æŒ null å…ƒç´ 
  - å¯ä»¥é€šè¿‡ç´¢å¼•è®¿é—®å…ƒç´ 
- List æ¥å£çš„å®ç°ç±»å…·æœ‰å…±åŒçš„æ–¹æ³•ï¼š
  - add() â€”â€” å‘é›†åˆä¸­æ·»åŠ å…ƒç´ ï¼ˆå¢ï¼‰
  - remove() â€“ å°†å…ƒç´ ä»é›†åˆä¸­ç§»é™¤ï¼ˆåˆ ï¼‰
  - get() â€”â€” ä»é›†åˆä¸­è·å–å…ƒç´ ï¼ˆæŸ¥ï¼‰
  - set() â€”â€” ä¿®æ”¹é›†åˆä¸­çš„å…ƒç´ ï¼ˆæ”¹ï¼‰
  - size() â€”â€” æŸ¥çœ‹é›†åˆé•¿åº¦

##### ArrayList

ç‰¹ç‚¹:

- æ•°ç»„å®ç°
- å¯ä»¥æ·»åŠ ç›¸åŒçš„å…ƒç´ 
- ä½¿ç”¨æœ€å¹¿æ³›ï¼Œé›†åˆå…ƒç´ å¢åŠ æˆ–åˆ é™¤æ“ä½œä¸é¢‘ç¹æ—¶ä½¿ç”¨ã€‚æœ€é€‚åˆæŸ¥è¯¢ã€‚

```java
ArrayList<Student> lst = new ArrayList<Student>();
        lst.add(new Student("zhang3",25,80));
        lst.add(new Student("li4",21,90));
        Student stu = lst.get(1);
        lst.size();
        for(Student stuTmp : lst){
            System.out.println(stuTmp.getName()+
                        stuTmp.getAge()+
                        stuTmp.getScore());
        }
```

##### LinkedList

ç‰¹ç‚¹:

- åŒå‘é“¾è¡¨å®ç°
- æ–¹æ³•å’Œ ArrayList ä¸€æ ·
- å½“éœ€è¦åœ¨é›†åˆçš„ä¸­é—´ä½ç½®ï¼Œé¢‘ç¹å¢åŠ æˆ–åˆ é™¤å…ƒç´ æ—¶ä½¿ç”¨ã€‚

```java
//ä½¿ç”¨éå†å™¨éå†å„ä¸ªå…ƒç´ 
Iterator it = al.iterator();
while(it.hasNext()){
    Object objtmp = it.next();
    System.out.println(objtmp);
}
```

##### Vector

ä¸ ArrayList ç±»ä¼¼ï¼Œä½† Vector æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥æ€§èƒ½è¦ä½äº ArrayList

#### Set æ¥å£

ä¸€åˆ—æ•°æ®ï¼Œ**æ•°æ®å†…å®¹ä¸èƒ½é‡å¤**ï¼Œä½¿ç”¨è‡ªå·±å†…éƒ¨çš„ä¸€ä¸ªæ’åˆ—æœºåˆ¶æ”¾ç½®å…ƒç´ ã€‚

- ç‰¹ç‚¹:
  - ä¸èƒ½åŒ…å«é‡å¤å…ƒç´  , å½“åŠ å…¥ä¸€ä¸ªå…ƒç´ åˆ°å®¹å™¨ä¸­æ—¶, è¦æ¯”è¾ƒå…ƒç´ çš„å†…å®¹æ˜¯å¦å­˜åœ¨é‡å¤, æ‰€ä»¥åŠ å…¥å®¹å™¨ä¸­çš„å¯¹è±¡å¿…é¡»é‡å†™ equals() æ–¹æ³•;
  - å…ƒç´ å¯èƒ½æœ‰åº, ä¹Ÿå¯èƒ½æ— åº
  - å› ä¸ºå…ƒç´ å¯èƒ½æ— åº, æ‰€ä»¥ä¸èƒ½ç”¨ç´¢å¼•è®¿é—® Set ä¸­çš„å…ƒç´ 
- Set æ¥å£çš„å®ç°ç±»å…·æœ‰å…±åŒçš„æ–¹æ³•ï¼š
  - add() â€”â€” å‘é›†åˆä¸­æ·»åŠ å…ƒç´ ï¼ˆå¢ï¼‰
  - remove(Object o) â€“ å°†å…ƒç´ ä»é›†åˆä¸­ç§»é™¤ï¼ˆåˆ ï¼‰
  - size() â€”â€” æŸ¥çœ‹é›†åˆé•¿åº¦

##### HashSet

ç‰¹ç‚¹:

- é€Ÿåº¦å¿«ï¼Œä¸æ’åºã€‚
- å½“éå† HashSet æ—¶, å…¶ä¸­çš„å…ƒç´ æ˜¯æ²¡æœ‰é¡ºåºçš„
- HashSet ä¸­ä¸å…è®¸å‡ºç°é‡å¤çš„å…ƒç´  (é‡å¤çš„å…ƒç´ æ˜¯æŒ‡ç”±ç›¸åŒçš„ hashCode, å¹¶ä¸” equals() æ¯”è¾ƒæ˜¯, è¿”å› true çš„ä¸¤ä¸ªå¯¹è±¡)
- å…è®¸åŒ…å« null çš„å…ƒç´ 

```java
import java.util.HashSet;
import java.util.Iterator;
public class TestSet {
    public static void main(String[] args) {
        HashSet<Student> set = new HashSet<Student>();
        set.add(new Student("zhang3",25,80));
        set.add(new Student("li4",21,90));
        set.add(new Student("wang5",27,70));
        Student stu = new Student("zhao6",22,65);
        set.add(stu);
        set.add(stu);//Seté›†åˆä¸èƒ½æ”¾å…¥é‡å¤å…ƒç´ 
        System.out.println(set.size());
        //è¦å–å‡ºå…ƒç´ åªèƒ½æœ‰éå†çš„æ–¹å¼ï¼Œè€Œä¸”ä¸æ”¯æŒæ™®é€šforå¾ªç¯(å› ä¸ºæ²¡æœ‰ä¸‹æ ‡)
        //è¿­ä»£å™¨
        Iterator<Student> it = set.iterator();
        while(it.hasNext()){
            Student stutmp = it.next();
            System.out.println(stutmp.getName());
        }
        for(Student stutmp : set){
            System.out.println(stutmp.getName());
        }
        //æ²¡æœ‰ä¿®æ”¹æ–¹æ³•
        //åˆ é™¤--åªèƒ½æŒ‰å¯¹è±¡ç§»é™¤ï¼Œæ²¡æœ‰æŒ‰ä½ç½®ç§»é™¤
        set.remove(stu);
    }
}
```

##### TreeSet

é€Ÿåº¦æ…¢ï¼Œæ’åºã€‚

### Map æ¥å£

ä¸€åˆ—æ•°æ®å¯¹ï¼Œä½¿ç”¨è‡ªå·±å†…éƒ¨çš„ä¸€ä¸ªæ’åˆ—æœºåˆ¶æ”¾ç½®å…ƒç´   
Map æ¥å£ç”¨äºç»´æŠ¤ é”® / å€¼å¯¹ (key/value pairs)ã€‚  
æ¯ä¸ªæ¡ç›®åŒ…æ‹¬å•ç‹¬çš„ä¸¤éƒ¨åˆ† :

- key
- Value

ç‰¹ç‚¹:

- åœ¨ Map ä¸­ä¸å…è®¸å‡ºç°é‡å¤çš„é”®, ä½†æ˜¯å¯ä»¥æœ‰é‡å¤çš„å€¼
- key å’Œ value å¯ä»¥æ˜¯ä»»ä½•ç±»çš„å®ä¾‹

å…±åŒçš„æ–¹æ³•:

- put() å°†é”®å€¼å¯¹å­˜å…¥é›†åˆ
- get() æ ¹æ®é”®å–å‡ºå…ƒç´ çš„å€¼
- keySet() å°† Map ä¸­çš„æ‰€æœ‰é”®å–å‡ºå½¢æˆä¸€ä¸ª Set
- values() å°† Map ä¸­çš„æ‰€æœ‰å€¼å–å‡ºå½¢æˆä¸€ä¸ª Collection
- remove() æ ¹æ®é”®ç§»é™¤å€¼
- containsKey åˆ¤æ–­ HashMap ä¸­æ˜¯å¦å­˜åœ¨è¿™ä¸ªé”®
- containsValue åˆ¤æ–­ HashMap ä¸­æ˜¯å¦å­˜åœ¨è¿™ä¸ªå€¼

#### HashMap

- é€Ÿåº¦å¿«ï¼Œä¸æ’åºã€‚

```java
import java.util.Collection;
import java.util.HashMap;
import java.util.Set;

public class TestMain {
    public static void main(String[] args) {
        HashMap<String, Student> map = new HashMap<String, Student>();

        //æ”¾å…ƒç´ 
        map.put("001", new Student("zhang3",25,80));
        map.put("002", new Student("li4",21,90));
        map.put("003", new Student("wang5",27,70));
        System.out.println(map.size());
        Student stu = new Student("zhao6",22,65);
        map.put("004", stu);
        map.put("005", stu);
        System.out.println(map.size());
        //å‘é‡å¤çš„é”®æ”¾å…¥æ–°çš„å€¼,ç›¸å½“äºåœ¨åšä¿®æ”¹åŠ¨ä½œ.
        map.put("005", new Student("chen7",18,62));

        //å–å…ƒç´ æ˜¯æ ¹æ®é”®å»å–å€¼
        Student stu1 = map.get("003");
        System.out.println(stu1.getName());

        //åˆ é™¤å…ƒç´ ä¹Ÿç»™æ ¹æ®é”®å»åˆ é™¤
        map.remove("002");
        System.out.println(map.size());

        //éå†
        Set<String> ks = map.keySet();//å¾—åˆ°æ‰€æœ‰çš„é”®
        for(String key : ks){
            System.out.println(map.get(key).getName());
        }

        Collection<Student> cl = map.values();//å¾—åˆ°æ‰€æœ‰çš„å€¼
        for(Student stutmp : cl){
            System.out.println(stutmp.getName());
        }

        //è·å–æŸä¸ªé”®æ˜¯å¦å­˜åœ¨äºMapå¯¹è±¡å½“ä¸­
        System.out.println(map.containsKey("007"));
        //è·å–æŸä¸ªå€¼æ˜¯å¦å­˜åœ¨äºMapå¯¹è±¡å½“ä¸­
        System.out.println(map.containsValue(stu));
    }
}
```

#### Properties æ–¹ä¾¿æ“ä½œå±æ€§æ–‡ä»¶)

![20241229154732_BjJ8f4hM.webp](https://cdn.dong4j.site/source/image/20241229154732_BjJ8f4hM.webp)

## [Javaç¼–ç¨‹åŸºç¡€ï¼šç±»å‹è½¬æ¢å’Œæ“ä½œæŠ€å·§è¯¦è§£](https://blog.dong4j.site/posts/eee067eb.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

1. çœ‹ä»£ç è¯´ç»“æœ:

```java
public static void main(String[] args){
    char x = â€˜bâ€™;
    int i = 0;
1.  System.out.println(true?x:0); //è¿™ä¸ª0æ˜¯shortç±»å‹
2.  System.out.println(true?x:1111111110);
3.  System.out.println(false?i:x);
}
```

**è¦ç±»å‹è½¬æ¢**  
**ç›´æ¥å†™å‡ºçš„ 0 æ˜¯ short ç±»å‹**

> b  
> 98  
> 98

è§£é‡Š:  
æ¡ä»¶è¿ç®—ç¬¦çš„ 3 ä¸ªæ ¸å¿ƒè¦ç‚¹

- å¦‚æœç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªæ“ä½œæ•°å…·æœ‰ç›¸åŒçš„ç±»å‹, é‚£ä¹ˆä»–å°±æ˜¯æ¡ä»¶è¡¨è¾¾å¼çš„ç±»å‹.
- å¦‚æœä¸€ä¸ªæ“ä½œæ•°çš„ç±»å‹æ˜¯ byte,shotr æˆ– char, è€Œå¦ä¸€ä¸ªæ“ä½œæ•°ç±»å‹æ˜¯ int çš„å¸¸é‡è¡¨è¾¾å¼, æ¡ä»¶è¡¨è¾¾å¼çš„å€¼æ˜¯å¯ä»¥ç”¨ç±»å‹ byte,short æˆ– char è¡¨ç¤ºçš„,
- å¦åˆ™, å°†æ“ä½œæ•°ç±»å‹è¿ç”¨äºŒè¿›åˆ¶æ•°å­—æå‡ (å‘ä¸Šè½¬å‹), äºŒè¡¨è¾¾å¼çš„ç±»å‹å°±æ˜¯ç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªæ“ä½œæ•°æå‡åçš„ç±»å‹

1. `System.out.println(true?x:0);`  
   å¯¹äºè¯­å¥ 1 ä¸­çš„æ¡ä»¶è¡¨è¾¾å¼, ç¬¬äºŒä¸ªæ“ä½œæ•°æ˜¯ char ç±»å‹, ç¬¬ä¸‰ä¸ªæ“ä½œæ•°æ˜¯ä¸€ä¸ªæ•´å‹å¸¸é‡, ç¬¦åˆæ ¸å¿ƒè¦ç‚¹çš„ç¬¬äºŒç‚¹.  
   å…¶å®è¿™é‡Œçš„å¸¸é‡ 0, å®è´¨æ˜¯ä¸€ä¸ª short ç±»å‹çš„å¸¸é‡, å’Œ char ç±»å‹ä¸€æ ·éƒ½å  2 ä¸ªå­—èŠ‚, æ‰€ä»¥ä¸ä¼šå‘ç”Ÿè½¬å‹.  
   å½“æ‰§è¡Œ print è¯­å¥çš„æ—¶å€™, å°†è°ƒç”¨ PrintStream.print(char) è¿™ä¸ªè¢«é‡è½½çš„æ–¹æ³•, è¾“å‡º b
2. `System.out.println(true?x:1111111110);`  
   è¿™æ¡è¯­å¥åŒæ ·é€‚ç”¨äºæ ¸å¿ƒè¦ç‚¹çš„ç¬¬äºŒç‚¹, å°†è°ƒç”¨ PrintStream.print(long) æ–¹æ³•, è¾“å‡º 98
3. `System.out.println(false?i:x)`  
   å› ä¸º x æ˜¯ int ç±»å‹çš„, æ‰€ä»¥å¿…å®šæ”¾ç”Ÿå‘ä¸Šè½¬å‹, char è‡ªåŠ¨è½¬å‹ä¸º int i çš„å€¼å˜ä¸º 98, è°ƒç”¨ PrintStream.print(int) æ–¹æ³•, è¾“å‡º 98.

## â€œ+â€ è¿ç®—ç¬¦å’Œ â€œ+=â€ è¿ç®—ç¬¦

```java
char a = 'A';
1. a = a + 1;//æŠ¥é”™
2. a += 1;
```

1.`a = a + 1;//æŠ¥é”™`  
è¿™æ¡è¯­å¥ä¸ºä»€ä¹ˆä¼šæŠ¥é”™?  
åœ¨ Java ç¼–ç¨‹æ€æƒ³ä¸­æœ‰è¿™æ ·ä¸€å¥è¯

> åŠ å·çš„å”¯ä¸€ä½œç”¨å°±æ˜¯å°†è¾ƒå°æ•°æ®ç±»å‹çš„æ“ä½œæ•°æå‡ä¸º **int**

è¿™å¥è¯æˆ‘ä»¬å¯ä»¥çš„å¾—çŸ¥, åªè¦æ˜¯æ¯” int å°çš„åŸºæœ¬æ•°æ®ç±»å‹, ç”¨åŠ å·ä¸ä¸€ä¸ªæ•´æ•°å¸¸é‡è¿æ¥çš„æ—¶å€™, ä¼šè¢«è‡ªåŠ¨è½¬å‹ä¸º int, è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ `a = a + 1` ä¼šæŠ¥ _int ç±»å‹ä¸èƒ½è½¬æ¢æˆ char ç±»å‹ _ çš„åŸå› äº†

2.`a += 1;`  
ä¸ºä»€ä¹ˆè¿™å¥æœ‰æ²¡æœ‰æŠ¥é”™?  
å› ä¸º += è¿ç®—ç¬¦å­˜åœ¨éšå¼å¼ºè½¬, è¿™æ¡è¯­å¥ç­‰ä»·äº:  
`a = (char)((int)a + 1 )`

## äº¤æ¢å€¼çš„é—®é¢˜

æœ‰ a,b ä¸ª int ç±»å‹çš„å˜é‡, è¦æ±‚ä¸é€šè¿‡ä¸´æ—¶å˜é‡äº¤æ¢ 2 ä¸ªå˜é‡çš„å€¼

```java
public class Change{
    public static void main(String[] args){
        int a = 7;
        int b = 5;
        a = a ^ b;
        b = b ^ a;
        a = a ^ b;
        System.out.println(a + "  " + b);
    }
}
```

è¿™ç§æ–¹æ³•æ˜¯æœ€æ­£ç¡®ä¹Ÿæ˜¯æœ€é«˜æ•ˆçš„

å¦ä¸€ç§æ–¹æ³•

```java
a = a + b ;
b = a - b ;
a = a - b ;
```

è¿™ç§æ–¹æ³•çœ‹ä¼¼å¯ä»¥, ä½†æ˜¯å´ä¸æ­£ç¡®, å› ä¸ºæ²¡æœ‰è€ƒè™‘åˆ°æ•°æ®æº¢å‡ºé—®é¢˜  
é¢˜ä¸Šå¹¶æ²¡æœ‰è¯´ a å’Œ b çš„å€¼æœ‰å¤šå¤§,  
a å’Œ b éƒ½æ˜¯ int ç±»å‹, æœ€å¤§å­˜å‚¨èŒƒå›´ä¸º `2147483647` åˆ° `-2147483648`

```java
class Test {
    public static void main(String[] args) {
        System.out.println(Integer.MAX_VALUE);
        System.out.println(Integer.MIN_VALUE);
    }
}
```

é—®é¢˜å‡ºåœ¨ `a = a + b;`  
å¦‚æœå½“ `a+b` çš„å€¼å¤§äºäº† `2147483647` å°±ä¼šå‘ç”Ÿæ•°æ®æº¢å‡º, ä»è€Œå¯¼è‡´åé¢çš„è¯­å¥å¾—ä¸åˆ°æ­£ç¡®çš„å€¼.

## [Javaç¼–ç¨‹è¿›é˜¶ä¹‹è·¯ï¼šå­¦ä¹ Collectionså’ŒArraysçš„å¼ºå¤§åŠŸèƒ½](https://blog.dong4j.site/posts/d366874c.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

### Collections ç±»

æ­¤ç±»æ–¹æ³•ä¼—å¤š, åªä»‹ç»å‡ ä¸ªå¸¸ç”¨æ–¹æ³•

- sort() å¯¹å…ƒç´ è¿›è¡Œæ’åº, å¯ä»¥ä¼ å…¥æ¯”è¾ƒå™¨
- max() è¿”å›æœ€å¤§å…ƒç´ , å¯ä»¥ä¼ å…¥æ¯”è¾ƒå™¨
- min() è¿”å›æœ€å°å…ƒç´ , å¯ä»¥ä¼ æ¯”è¾ƒå™¨
- reverse() åæ’åº
- shuffle() æ··æ’

### Arrays ç±»

æ­¤ç±»åŒ…å«ç”¨æ¥æ“ä½œæ•°ç»„ï¼ˆæ¯”å¦‚æ’åºå’Œæœç´¢ï¼‰çš„å„ç§æ–¹æ³•ã€‚  
æ–¹æ³•æ›´å¤š, è¿˜æ˜¯çœ‹ API å§

### æ¯”è¾ƒå™¨

#### Comparable

å†…éƒ¨æ¯”è¾ƒå™¨  
`public interface Comparable`  
æ­¤æ¥å£å¼ºè¡Œå¯¹å®ç°å®ƒçš„æ¯ä¸ªç±»çš„å¯¹è±¡è¿›è¡Œæ•´ä½“æ’åºã€‚è¿™ç§æ’åºè¢«ç§°ä¸ºç±»çš„è‡ªç„¶æ’åºï¼Œç±»çš„ compareTo æ–¹æ³•è¢«ç§°ä¸ºå®ƒçš„è‡ªç„¶æ¯”è¾ƒæ–¹æ³•ã€‚  
`int compareTo(T o)`  
ä¸€ä¸ªç±»ç»§æ‰¿äº† Comparable æ¥å£å, é‡å†™ compareTo() æ–¹æ³•, å°±èƒ½æŒ‰ç…§æˆ‘ä»¬è‡ªå·±çš„è§„åˆ™æ’åº

ä¾‹å­:

```java
public class Student implements Comparable<Student>{
    private String name;
    private int age;
    private int score;
    public Student() {
    }
    public Student(String name, int age, int score) {
        super();
        this.name = name;
        this.age = age;
        this.score = score;
    }
    public String getName() {
        return name;
    }
    public void setName(String name) {
        this.name = name;
    }
    public int getAge() {
        return age;
    }
    public void setAge(int age) {
        this.age = age;
    }
    public int getScore() {
        return score;
    }
    public void setScore(int score) {
        this.score = score;
    }
    /**
     * æ¯”è¾ƒè§„åˆ™æ˜¯æŒ‰ç…§å¹´é¾„æ¥æ’
     */
    @Override
    public int compareTo(Student stu) {
        // TODO Auto-generated method stub
        if(this.age > stu.getAge()){
            return 1;
        }else if(this.age < stu.getAge()){
            return -1;
        }else{
            return 0;
        }
    }
    @Override
    public String toString() {
        // TODO Auto-generated method stub
        return "åå­—:" + this.name + "ï¼›å¹´é¾„ï¼š" + this.age + ";æˆç»©ï¼š" + this.score;
    }
}
```

å½“æŠŠ Student å¯¹è±¡å­˜å‚¨åœ¨ List é›†åˆä¸­çš„æ—¶å€™,  
å¯ä»¥ä½¿ç”¨ Collections å·¥å…·ç±»å¯¹è¿™ä¸ª Student é›†åˆè¿›è¡Œæ’åº.

- å¦‚æœè°ƒç”¨ Collections çš„ `sort(List<T> list)` æ–¹æ³•, å°±ä¼šæ ¹æ®å…ƒç´ çš„è‡ªç„¶é¡ºåº å¯¹æŒ‡å®šåˆ—è¡¨æŒ‰å‡åºè¿›è¡Œæ’åº
- å½“è°ƒç”¨ `sort(List<T> list, Comparator<? super T> c)` æ–¹æ³•æ—¶,  
   å½“æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªæ¯”è¾ƒå™¨çš„æ—¶å€™, å°±ä¼šæ ¹æ®æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„è§„åˆ™è¿›è¡Œæ’åº

```java
ArrayList<Student> arrayStudent = new ArrayList<Student>();
arrayStudent.add(new Student("å¼ ä¸‰",26,90));
arrayStudent.add(new Student("æå››",20,76));
arrayStudent.add(new Student("ç‹æ­¦",24,68));
Collections.sort(arrayStudent);
```

å› ä¸ºåœ¨ Student ç±»ç»§æ‰¿ Comparable æ¥å£, é‡å†™äº†æ­¤æ¥å£çš„ compareTo() æ–¹æ³•, å½“å¯¹ arrayStudent é›†åˆè¿›è¡Œæ’åºçš„æ—¶å€™, ä¼šæŒ‰ç…§æˆ‘ä»¬é‡å†™åçš„è§„åˆ™è¿›è¡Œæ’åº

#### Comparator

å¤–éƒ¨æ¯”è¾ƒå™¨  
æ¥ç€ä¸Šé¢çš„ä¾‹å­

é‡æ–°å®šä¹‰ä¸€ä¸ªå®ç°äº† Comparator æ¥å£çš„ç±»

```java
public class StudentComparator implements Comparator<Student>{
    @Override
    public int compare(Student stu1, Student stu2) {
        // TODO Auto-generated method stub
        if(stu1.getName().length() > stu2.getName().length()){
            return 1;
        }else if(stu1.getName().length() < stu2.getName().length()){
            return -1;
        }else{
            return 0;
        }
    }
}
```

ç„¶åè°ƒç”¨  
`Collections.sort(arrayStudent,new StudentComparator());`  
å°†æŒ‰ç…§æˆ‘ä»¬çš„è§„åˆ™è¿›è¡Œæ’åº.

åœ¨ä»¥å‰æˆ‘ä»¬åªèƒ½æ¯”è¾ƒåŸºæœ¬æ•°æ®ç±»å‹å’Œå­—ç¬¦ä¸²  
ç°åœ¨å­¦ä¹ äº†æ¯”è¾ƒå™¨ä¹‹å, æˆ‘ä»¬å°±å¯ä»¥æ¯”è¾ƒ (æ’åº) å¯¹è±¡äº†,  
åªè¦ç»§æ‰¿äº† Comparable æˆ–è€…ä¼ å…¥ä¸€ä¸ªå®ç°äº† Comparator æ¥å£çš„è‡ªå·±å®šä¹‰çš„æ¯”è¾ƒè§„åˆ™çš„å¯¹è±¡,  
å°±å¯ä»¥æŒ‰ç…§æˆ‘ä»¬çš„æƒ³æ³•å¯¹å…ƒç´ è¿›è¡Œæ’åº.

## [Java ç¼–ç¨‹ï¼šæŠ½è±¡ç±»ä¸æ¥å£çš„ä½¿ç”¨æŒ‡å—](https://blog.dong4j.site/posts/64ccc6a0.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

### æŠ½è±¡ç±»

> æŠŠå¤šä¸ªç±»ä¸­ç›¸åŒçš„æ–¹æ³•å£°æ˜ç»™æŠ½å–å‡ºæ¥ã€‚å®šä¹‰åˆ°ä¸€ä¸ªç±»ä¸­ã€‚

- ä¸€ä¸ªæ–¹æ³•å¦‚æœåªæœ‰æ–¹æ³•å£°æ˜ï¼Œæ²¡æœ‰æ–¹æ³•ä½“ï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•å¿…é¡»å®šä¹‰ä¸ºæŠ½è±¡æ–¹æ³•ã€‚
- è€Œä¸€ä¸ªç±»ä¸­å¦‚æœæœ‰æŠ½è±¡æ–¹æ³•ï¼Œé‚£ä¹ˆï¼Œè¯¥ç±»å¿…é¡»å®šä¹‰ä¸ºæŠ½è±¡ç±»ã€‚

#### æŠ½è±¡ç±»çš„ç‰¹ç‚¹ï¼š

- æŠ½è±¡æ–¹æ³•å’ŒæŠ½è±¡ç±»éƒ½å¿…é¡»ç”¨ abstract è¡¨ç¤ºã€‚
- ä¸€ä¸ªç±»ç»§æ‰¿æŠ½è±¡ç±»çš„æ—¶å€™ï¼›
  - è¦ä¹ˆï¼šæœ¬èº«æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ã€‚
  - è¦ä¹ˆï¼šå®ç°æŠ½è±¡ç±»ä¸­çš„æ‰€æœ‰æŠ½è±¡æ–¹æ³•ã€‚
- æŠ½è±¡ç±»æœ‰æ„é€ æ–¹æ³•, ä½†æ˜¯ä¸èƒ½å®ä¾‹åŒ–, å¯ä»¥æŒ‰ç…§å¤šæ€çš„ä½¿ç”¨æ–¹å¼ä½¿ç”¨ã€‚
- æˆå‘˜ç‰¹ç‚¹ï¼š
  - æˆå‘˜å˜é‡
    - å¯ä»¥æ˜¯å˜é‡ï¼Œä¹Ÿå¯ä»¥æ˜¯å¸¸é‡ã€‚
- æ„é€ æ–¹æ³•
  - æœ‰ ç”¨äºå­ç±»è®¿é—®çˆ¶ç±»æ„é€ æ–¹æ³•ï¼Œåˆå§‹åŒ–çˆ¶ç±»æ•°æ®
- æˆå‘˜æ–¹æ³•
  - å¯ä»¥æ˜¯æŠ½è±¡ï¼Œä¹Ÿå¯ä»¥éæŠ½è±¡ã€‚
- æŠ½è±¡ç±»çš„å¥½å¤„ï¼š
  - æŠ½è±¡ç±»ä¸­çš„éæŠ½è±¡æ–¹æ³•æé«˜äº†ä»£ç çš„å¤ç”¨æ€§ã€‚
  - æŠ½è±¡ç±»ä¸­çš„æŠ½è±¡æ–¹æ³•å¼ºåˆ¶è¦æ±‚å­ç±»å¿…é¡»é‡å†™æŸäº›æ–¹æ³•ã€‚
- æŠ½è±¡ç±»ä¸­çš„å‡ ä¸ªå°é—®é¢˜ï¼š
  - æŠ½è±¡ç±»ä¸èƒ½å®ä¾‹åŒ–ï¼Œæ„é€ æ–¹æ³•æœ‰ä»€ä¹ˆç”¨å‘¢?
    - ç”¨äºå­ç±»è®¿é—®çˆ¶ç±»æ•°æ®çš„åˆå§‹åŒ–ã€‚
  - å¦‚æœä¸€ä¸ªç±»ä¸­æ²¡æœ‰æŠ½è±¡æ–¹æ³•ï¼Œè€Œç±»å´è¢«å®šä¹‰ä¸ºäº†æŠ½è±¡ç±»ï¼Œè¯·é—®ä¸ºä»€ä¹ˆ?
    - ä¸è®©åˆ›å»ºå¯¹è±¡ã€‚
  - abstract ä¸èƒ½å’Œå“ªäº›å…³é”®å­—å…±å­˜ï¼š
    - private: å†²çª
    - final: å†²çª
    - static: æ— æ„ä¹‰

### æ¥å£ (æŒæ¡)

> å¦‚æœä¸€ä¸ªæŠ½è±¡ç±»ä¸­çš„æ‰€æœ‰æˆå‘˜æ–¹æ³•éƒ½æ˜¯æŠ½è±¡çš„ï¼Œjava å°±æé«˜äº†ä¸€ç§æ›´æŠ½è±¡çš„è¡¨è¾¾æ–¹å¼ï¼šæ¥å£ã€‚

#### æ¥å£çš„ç‰¹ç‚¹ï¼š

- æ¥å£ç”¨ interface å®šä¹‰ã€‚  
   ç±»å®ç°æ¥å£ç”¨ implements å…³é”®å­—ã€‚

- ä¸€ä¸ªç±»è¦å®ç°æ¥å£ï¼š
  - æœ¬èº«æ˜¯æŠ½è±¡ç±»ã€‚
  - å®ç°æ¥å£ä¸­çš„æ‰€æœ‰æŠ½è±¡æ–¹æ³•ã€‚
- æ¥å£ä¸èƒ½å®ä¾‹åŒ–ã€‚å¯ä»¥æŒ‰ç…§å¤šæ€çš„ä½¿ç”¨æ–¹å¼ä½¿ç”¨ã€‚
- æˆå‘˜ç‰¹ç‚¹ï¼š
  - æˆå‘˜å˜é‡ï¼šåªèƒ½æ˜¯å¸¸é‡ã€‚
    - é»˜è®¤ä¿®é¥°ç¬¦ï¼špublic static final
    - æˆå‘˜æ–¹æ³•ï¼šåªèƒ½æ˜¯æŠ½è±¡æ–¹æ³•ã€‚
    - é»˜è®¤ä¿®é¥°ç¬¦ï¼špublic abstract

#### ä½¿ç”¨æ¥å£çš„åŸåˆ™

1. ä½¿ç”¨æ¥å£è§£å†³å¤šç»§æ‰¿
2. ä½¿ç”¨æ¥å£ä¸ºå¤–éƒ¨ç±»æ·»åŠ åŠŸèƒ½
3. ä»¥é¢å‘å¯¹è±¡çš„è§’åº¦è€ƒè™‘, å°†ä¸€ä¸ªç±»ä¸ç”Ÿä¿±æ¥çš„ç‰¹å¾å’Œè¡Œä¸ºå’Œä¾èµ–äºå¤–éƒ¨çš„å¯é€‰çš„ç‰¹å¾å’Œè¡Œä¸ºåˆ†ç¦», è®©ç±»å°½å¯èƒ½çš„å•çº¯, å³è§£è€¦

æ¥å£çš„ä¼˜ç‚¹

1. å°†è®¾è®¡å’Œå®ç°åˆ†ç¦», å¯¹å¤– (è°ƒç”¨è€…) éšè—äº†å®ç° (è€Œé€šå¸¸è°ƒç”¨è€…ä¹Ÿä¸éœ€è¦å…³å¿ƒå®ç°)
2. é¢å‘æ¥å£ç¼–ç¨‹æ˜¯ OOP çš„æ ¸å¿ƒ

#### ç±»ä¸æ¥å£çš„å…³ç³»ï¼š

- ç±»ä¸ç±»çš„å…³ç³»
  - ç»§æ‰¿: å•ç»§æ‰¿ã€‚
- ç±»ä¸æ¥å£çš„å…³ç³»
  - å®ç°: å•å®ç°ï¼Œå¤šå®ç°ã€‚
  - ç»§æ‰¿ä¸€ä¸ªç±»çš„åŒæ—¶å®ç°å¤šä¸ªæ¥å£ã€‚
- æ¥å£ä¸æ¥å£çš„å…³ç³»
  - ç»§æ‰¿: å•ç»§æ‰¿ï¼Œå¤šç»§æ‰¿ã€‚

#### æŠ½è±¡ç±»å’Œæ¥å£çš„åŒºåˆ«:

- æˆå‘˜åŒºåˆ«
  - æŠ½è±¡ç±»ï¼š
    - æˆå‘˜å˜é‡
      - å¯ä»¥æ˜¯å˜é‡ï¼Œä¹Ÿå¯ä»¥æ˜¯å¸¸é‡ã€‚
    - æ„é€ æ–¹æ³•
      - æœ‰
    - æˆå‘˜æ–¹æ³•
      - å¯ä»¥æ˜¯æŠ½è±¡ï¼Œä¹Ÿå¯ä»¥éæŠ½è±¡ã€‚
  - æ¥å£ï¼š
    - æˆå‘˜å˜é‡ï¼šåªèƒ½æ˜¯å¸¸é‡ã€‚
      - é»˜è®¤ä¿®é¥°ç¬¦ï¼špublic static final
    - æˆå‘˜æ–¹æ³•ï¼šåªèƒ½æ˜¯æŠ½è±¡æ–¹æ³•ã€‚
      - é»˜è®¤ä¿®é¥°ç¬¦ï¼špublic abstract
- å…³ç³»åŒºåˆ«
  - ç±»ä¸ç±»çš„å…³ç³»
    - ç»§æ‰¿ï¼Œå•ç»§æ‰¿ã€‚
  - ç±»ä¸æ¥å£çš„å…³ç³»
    - å®ç°ï¼Œå•å®ç°ï¼Œå¤šå®ç°ã€‚
    - ç»§æ‰¿ä¸€ä¸ªç±»çš„åŒæ—¶å®ç°å¤šä¸ªæ¥å£ã€‚
  - æ¥å£ä¸æ¥å£çš„å…³ç³»
    - ç»§æ‰¿ï¼Œå•ç»§æ‰¿ï¼Œå¤šç»§æ‰¿ã€‚
- è®¾è®¡ç†å¿µä¸åŒ
  - æŠ½è±¡ç±»è¢«ç»§æ‰¿ä½“ç°çš„æ˜¯ï¼šis a çš„å…³ç³»ã€‚æŠ½è±¡ç±»ä¸­å®šä¹‰çš„æ˜¯ç»§æ‰¿ä½“ç³»å…±æ€§åŠŸèƒ½ã€‚
  - æ¥å£è¢«å®ç°ä½“ç°çš„æ˜¯ï¼šlike a çš„å…³ç³»ã€‚æ¥å£ä¸­å®šä¹‰çš„æ˜¯ç»§æ‰¿ä½“ç³»çš„æ‰©å±•åŠŸèƒ½ã€‚

ä»€ä¹ˆæ—¶å€™æŠŠæŠ½è±¡æ–¹æ³•å†™åˆ°æŠ½è±¡ç±»ä¸­â€“> ä¸ç”Ÿä¿±æ¥çš„è¡Œä¸º  
ä»€ä¹ˆæ—¶å€™æŠŠæŠ½è±¡æ–¹æ³•å†™åˆ°æ¥å£ä¸­ â€“> é™„å±æ·»åŠ çš„ç¬¬ä¸‰æ–¹çš„è¡Œä¸º

### æ€»ç»“

1. æŠ½è±¡ç±»åœ¨ java è¯­è¨€ä¸­æ‰€è¡¨ç¤ºçš„æ˜¯ä¸€ç§ç»§æ‰¿å…³ç³»ï¼Œä¸€ä¸ªå­ç±»åªèƒ½å­˜åœ¨ä¸€ä¸ªçˆ¶ç±»ï¼Œä½†æ˜¯å¯ä»¥å­˜åœ¨å¤šä¸ªæ¥å£ã€‚
2. åœ¨æŠ½è±¡ç±»ä¸­å¯ä»¥æ‹¥æœ‰è‡ªå·±çš„æˆå‘˜å˜é‡å’ŒéæŠ½è±¡ç±»æ–¹æ³•ï¼Œä½†æ˜¯æ¥å£ä¸­åªèƒ½å­˜åœ¨é™æ€çš„ä¸å¯å˜çš„æˆå‘˜æ•°æ®ï¼ˆä¸è¿‡ä¸€èˆ¬éƒ½ä¸åœ¨æ¥å£ä¸­å®šä¹‰æˆå‘˜æ•°æ®ï¼‰ï¼Œè€Œä¸”å®ƒçš„æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯æŠ½è±¡çš„ã€‚
3. æŠ½è±¡ç±»å’Œæ¥å£æ‰€åæ˜ çš„è®¾è®¡ç†å¿µæ˜¯ä¸åŒçš„ï¼ŒæŠ½è±¡ç±»æ‰€ä»£è¡¨çš„æ˜¯ â€œis-aâ€ çš„å…³ç³»ï¼Œè€Œæ¥å£æ‰€ä»£è¡¨çš„æ˜¯ â€œlike-aâ€ çš„å…³ç³»ã€‚

æŠ½è±¡ç±»å’Œæ¥å£æ˜¯ java è¯­è¨€ä¸­ä¸¤ç§ä¸åŒçš„æŠ½è±¡æ¦‚å¿µï¼Œä»–ä»¬çš„å­˜åœ¨å¯¹å¤šæ€æä¾›äº†éå¸¸å¥½çš„æ”¯æŒï¼Œè™½ç„¶ä»–ä»¬ä¹‹é—´å­˜åœ¨å¾ˆå¤§çš„ç›¸ä¼¼æ€§ã€‚ä½†æ˜¯å¯¹äºä»–ä»¬çš„é€‰æ‹©å¾€å¾€ååº”äº†æ‚¨å¯¹é—®é¢˜åŸŸçš„ç†è§£ã€‚åªæœ‰å¯¹é—®é¢˜åŸŸçš„æœ¬è´¨æœ‰è‰¯å¥½çš„ç†è§£ï¼Œæ‰èƒ½åšå‡ºæ­£ç¡®ã€åˆç†çš„è®¾è®¡ã€‚

## [ç†è§£ Java å¤šæ€æ€§ï¼šç¼–è¯‘æ—¶å’Œè¿è¡Œæ—¶çš„åŒºåˆ«](https://blog.dong4j.site/posts/ac4294eb.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

> **ç›¸åŒçš„è¡Œä¸º, ä¸åŒçš„å®ç°**

å¤šæ€å¤šæ€, å¤šç§çŠ¶æ€, è€Œå¤šç§çŠ¶æ€çš„ä½“ç°å°±åœ¨ä¸åŒçš„å®ç°ä¸Šé¢, ä¹Ÿå¯ä»¥è¯´æ˜¯ä¸åŒçš„æ•ˆæœ.  
ä¸¾ä¸ªä¾‹å­:  
æˆ‘è¿™é‡Œæœ‰ 3 ä¸ªæ¯å­, é‡Œé¢éƒ½è£…äº†ç™½é…’, ä½ å¹¶ä¸çŸ¥é“å®ƒä»¬éƒ½æ˜¯ä»€ä¹ˆé…’, åªæœ‰ç­‰ä½ å–è¿‡ä¹‹åæ‰èƒ½çŸ¥é“, ç¬¬ä¸€ä¸ªæ¯å­æ˜¯äºŒé”…å¤´, ç¬¬äºŒä¸ªæ˜¯äº”ç²®æ¶², ç¬¬ä¸‰ä¸ªæ˜¯èŒ…å°.

```
Maotai mo = new Maotai();
Wine w = mo;
```

è¿™é‡Œæˆ‘ä»¬å¯ä»¥è¿™æ ·ç†è§£, èŒ…å°æ˜¯é…’ç±»çš„ä¸€ç§, å®ƒä»¬ä¹‹é—´æ˜¯ç»§æ‰¿å…³ç³», å½“ a æŒ‡å‘äº† mo è¿™ä¸ªå¯¹è±¡çš„æ—¶å€™, å®ƒä¼šè‡ªåŠ¨å‘ä¸Šè½¬å‹ä¸º Wine, è¿™ä¹Ÿå°±æ˜¯è¯´ w æ˜¯å¯ä»¥æŒ‡å‘èŒ…å°è¿™ä¸ªå®ä¾‹.

è¿™æ ·åšçš„å¥½å¤„å°±æ˜¯, åœ¨ç»§æ‰¿ä¸­æˆ‘ä»¬çŸ¥é“å­ç±»æ˜¯çˆ¶ç±»çš„æ‰©å±•, å®ƒå¯ä»¥æä¾›æ¯”çˆ¶ç±»æ›´åŠ å¼ºå¤§çš„åŠŸèƒ½ï¼Œå¦‚æœæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæŒ‡å‘å­ç±»çš„çˆ¶ç±»å¼•ç”¨ç±»å‹ï¼Œé‚£ä¹ˆå®ƒé™¤äº†èƒ½å¤Ÿå¼•ç”¨çˆ¶ç±»çš„å…±æ€§å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å­ç±»å¼ºå¤§çš„åŠŸèƒ½

ä½†æ˜¯å‘ä¸Šè½¬å‹å­˜åœ¨ä¸€äº›ç¼ºæ†¾ï¼Œé‚£å°±æ˜¯å®ƒå¿…å®šä¼šå¯¼è‡´ä¸€äº›æ–¹æ³•å’Œå±æ€§çš„ä¸¢å¤±ï¼Œè€Œå¯¼è‡´æˆ‘ä»¬ä¸èƒ½å¤Ÿè·å–å®ƒä»¬

æ‰€ä»¥å¯¹äºå¤šæ€æˆ‘ä»¬å¯ä»¥æ€»ç»“å¦‚ä¸‹ï¼š

- æŒ‡å‘å­ç±»çš„çˆ¶ç±»å¼•ç”¨ç”±äºå‘ä¸Šè½¬å‹äº†ï¼Œå®ƒåªèƒ½è®¿é—®çˆ¶ç±»ä¸­æ‹¥æœ‰çš„æ–¹æ³•å’Œå±æ€§ï¼Œè€Œå¯¹äºå­ç±»ä¸­å­˜åœ¨è€Œçˆ¶ç±»ä¸­ä¸å­˜åœ¨çš„æ–¹æ³•ï¼Œè¯¥å¼•ç”¨æ˜¯ä¸èƒ½ä½¿ç”¨çš„ï¼Œå°½ç®¡æ˜¯é‡è½½è¯¥æ–¹æ³•ã€‚è‹¥å­ç±»é‡å†™äº†çˆ¶ç±»ä¸­çš„æŸäº›æ–¹æ³•ï¼Œåœ¨è°ƒç”¨è¿™äº›æ–¹æ³•çš„æ—¶å€™ï¼Œå¿…å®šæ˜¯ä½¿ç”¨å­ç±»ä¸­å®šä¹‰çš„è¿™äº›æ–¹æ³•ï¼ˆåŠ¨æ€è¿æ¥ã€åŠ¨æ€è°ƒç”¨ï¼‰ã€‚  
  ä¸è¿‡è¿˜æ˜¯å¯ä»¥è°ƒç”¨å­ç±»ä¸­ç‰¹æœ‰çš„æ–¹æ³•, åæ–‡ä¸­å°†ä¼šè®²åˆ°.

- å¯¹äºé¢å‘å¯¹è±¡è€Œå·²ï¼Œå¤šæ€åˆ†ä¸ºç¼–è¯‘æ—¶å¤šæ€å’Œè¿è¡Œæ—¶å¤šæ€ã€‚
  - ç¼–è¾‘æ—¶å¤šæ€æ˜¯é™æ€çš„ï¼Œä¸»è¦æ˜¯æŒ‡æ–¹æ³•çš„é‡è½½ï¼Œå®ƒæ˜¯æ ¹æ®å‚æ•°åˆ—è¡¨çš„ä¸åŒæ¥åŒºåˆ†ä¸åŒçš„å‡½æ•°ï¼Œé€šè¿‡ç¼–è¾‘ä¹‹åä¼šå˜æˆä¸¤ä¸ªä¸åŒçš„å‡½æ•°ï¼Œåœ¨è¿è¡Œæ—¶è°ˆä¸ä¸Šå¤šæ€ã€‚
  - è¿è¡Œæ—¶å¤šæ€æ˜¯åŠ¨æ€çš„ï¼Œå®ƒæ˜¯é€šè¿‡åŠ¨æ€ç»‘å®šæ¥å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„å¤šæ€æ€§ã€‚

#### å¤šæ€çš„åˆ†ç±»

1. é™æ€å¤šæ€ (ç¼–è¯‘æœŸç¡®å®šè¦æ‰§è¡Œçš„æ•ˆæœ, ç¼–è¯‘å™¨åªæ˜¯åšè¯­æ³•æ£€æŸ¥)
   - é‡è½½ (Overload) å®ç°
2. åŠ¨æ€å¤šæ€ (ç¼–è¯‘æœŸä¸çŸ¥é“è¿è¡Œæ•ˆæœ, è€Œæ˜¯è¿è¡ŒæœŸæ ¹æ®ç»‘å®šå¯¹è±¡çš„ä¸åŒç¡®å®šç»“æœ)
   - é‡å†™ (Override)
   - åŠ¨æ€ç»‘å®š

å½“ä¸€ä¸ªçˆ¶ç±»å¼•ç”¨æŒ‡å‘å­ç±»å¯¹è±¡çš„æ—¶å€™  
ä¸ºä»€ä¹ˆçˆ¶ç±»ä¸èƒ½è°ƒç”¨å­ç±»é‡è½½ä¹‹åçš„æ–¹æ³•? ä¸ºä»€ä¹ˆçˆ¶ç±»è°ƒç”¨çš„æ–¹æ³•çš„å®ç°æ˜¯å­ç±»é‡å†™åçš„å®ç°?

- å› ä¸ºé‡è½½æ˜¯å¯¹äºä¸€ä¸ªç±»è€Œè¨€çš„, å½“å­ç±»ç»§æ‰¿çˆ¶ç±», ç„¶ååœ¨æœ¬ç±»ä¸­é‡è½½äº†çˆ¶ç±»çš„è¿™ä¸ªæ–¹æ³•, å¯¹äºçˆ¶ç±»è€Œè¨€æ˜¯çœ‹ä¸åˆ°è¿™ä¸ªåœ¨å­ç±»ä¸­é‡è½½ä¹‹åçš„æ–¹æ³•çš„, å› ä¸ºå®ƒåªå±äºå­ç±», æ‰€ä»¥å½“çˆ¶ç±»è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™, å› ä¸ºçˆ¶ç±»ä¸­æ ¹æœ¬å°±æ²¡æœ‰è¿™ä¸ªæ–¹æ³•, æ‰€ä»¥ç¼–è¯‘å™¨ä¼šæŠ¥é”™;
- ç„¶è€Œå½“çˆ¶ç±»è°ƒç”¨è¢«å­ç±»é‡å†™çš„è¿‡åçš„æ–¹æ³•æ—¶, å› ä¸ºçˆ¶ç±»ä¸­å­˜åœ¨åŒåæ–¹æ³•, ç¼–è¯‘å™¨ä¸ä¼šæŠ¥é”™, ç„¶åé€šè¿‡åŠ¨æ€ç»‘å®š, å°†è¢«è°ƒç”¨çš„è¿™ä¸ªæ–¹æ³•å’Œå­ç±»å…³è”èµ·æ¥, æ‰€ä»¥æ–¹æ³•å®ç°çš„æ˜¯å­ç±»é‡å†™è¿‡åçš„æ•ˆæœ.

##### åŠ¨æ€ç»‘å®š

- å°†ä¸€ä¸ªæ–¹æ³•è°ƒç”¨ä¸è¯¥æ–¹æ³•æ‰€åœ¨çš„ç±»å…³è”èµ·æ¥;
- åœ¨è¿è¡Œæ—¶å€™æ ¹æ®å…·ä½“å¯¹è±¡çš„ç±»å‹ç»‘å®š;
- å½“çˆ¶ç±»å¼•ç”¨æŒ‡å‘å­ç±»çš„å¯¹è±¡, è°ƒç”¨é‡å†™çš„æ–¹æ³•æ—¶, æ˜¯è°ƒç”¨å­ç±»ä¸­é‡å†™çš„æ–¹æ³•;

##### è½¬å‹æŠ€æœ¯ (ç±»ä¹‹é—´å¿…é¡»è¦æœ‰ç»§æ‰¿å…³ç³»)

å·¦å³ä¸¤è¾¹æ•°æ®ç±»å‹ä¸ä¸€è‡´

- å‘ä¸Šè½¬å‹ â€“> è‡ªåŠ¨  
   `Person p = new Man();`  
   æ­¤æ—¶çš„å¼•ç”¨ p åªèƒ½çœ‹è§çˆ¶ç±»çš„æ–¹æ³•, è€Œçœ‹ä¸åˆ°å­ç±»æ‰€ç‰¹æœ‰çš„æ–¹æ³•
- å‘ä¸‹è½¬å‹ â€“> å¼ºåˆ¶  
   `Man m = (Man)p`  
   æ­¤æ—¶ m å¼•ç”¨å¯ä»¥çœ‹åˆ°å…¨éƒ¨çš„æ–¹æ³•, å› ä¸º m æŒ‡å‘äº†ä¸€ä¸ª Man å¯¹è±¡.  
   è¿™æ ·å°±å¯ä»¥è°ƒç”¨å­ç±»å¯¹è±¡ä¸­è®¿é—®ä¿®é¥°ç¬¦å…è®¸çš„æ–¹æ³•å’Œå±æ€§äº†

#### å¤šæ€çš„å¼•ç”¨â€“å¼‚æ„ é›†åˆ

åˆ›å»ºä¸€ä¸ªä¸æ˜¯åŒä¸€ç±»å‹, ä½†æ˜¯æœ‰å…±åŒçˆ¶ç±»çš„æ•°æ®é›†åˆ, ä¸åŒå¯¹è±¡çš„é›†åˆç§°ä¸ºå¼‚æ„é›†åˆ

#### å¤šæ€çš„å¥½å¤„å’Œå¼Šç«¯ï¼š

A: å¥½å¤„  
æé«˜äº†ç¨‹åºçš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚  
ç»´æŠ¤æ€§ï¼šç»§æ‰¿ä¿è¯  
æ‰©å±•æ€§ï¼šå¤šæ€ä¿è¯  
B: å¼Šç«¯  
çˆ¶ç±» / çˆ¶æ¥å£ä¸èƒ½è®¿é—®å­ç±»ç‰¹æœ‰åŠŸèƒ½ã€‚

#### å¤šæ€çš„ä½“ç°å½¢å¼ï¼š

- å…·ä½“ç±»å¤šæ€

```java
class Fu {}
    class Zi extends Fu {}
    Fu f = new Zi();
```

- æŠ½è±¡ç±»å¤šæ€

```java
abstract class Fu {}
    class Zi extends Fu {}
    Fu f =  new Zi();
```

- æ¥å£å¤šæ€

```java
interface Inter {}
    //æ¥å£çš„å®ç°ç±»å‘½åï¼šæ¥å£å+Impl
    class InterImpl implements Inter{}
    Inter i = new InterImpl();
```

### æ€»ç»“

- ä½¿ç”¨çˆ¶ç±»ç±»å‹çš„å¼•ç”¨æŒ‡å‘å­ç±»çš„å¯¹è±¡;
- è¯¥å¼•ç”¨åªèƒ½è°ƒç”¨çˆ¶ç±»ä¸­å®šä¹‰çš„æ–¹æ³•, ä¸èƒ½è°ƒç”¨å­ç±»çš„ç‰¹æœ‰çš„å±æ€§å’Œæ–¹æ³•;
- å¦‚æœå­ç±»ä¸­é‡å†™çˆ¶ç±»çš„æ–¹æ³•, é‚£ä¹ˆè°ƒç”¨è¯¥æ–¹æ³•, å°†ä¼šè°ƒç”¨å­ç±»ä¸­é‡å†™åçš„å®ç°;
- åœ¨å¤šæ€ä¸­, å­ç±»å¯ä»¥è°ƒç”¨çˆ¶ç±»çš„æ‰€æœ‰éç§æœ‰æ–¹æ³•;
- çˆ¶ç±»çš„å¼•ç”¨å¯ä»¥æŒ‡å‘å­ç±»çš„å¯¹è±¡, å­ç±»çš„å¼•ç”¨ä¸èƒ½æŒ‡å‘çˆ¶ç±»çš„å¯¹è±¡;

## [Javaç»§æ‰¿çš„å¤šæ€é­…åŠ›ï¼šå‘ä¸Šè½¬å‹çš„è‰ºæœ¯](https://blog.dong4j.site/posts/11d8b32d.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

Java ç»§æ‰¿æ˜¯ä½¿ç”¨å·²å­˜åœ¨çš„ç±»çš„å®šä¹‰ä½œä¸ºåŸºç¡€å»ºç«‹æ–°ç±»çš„æŠ€æœ¯ï¼Œæ–°ç±»çš„å®šä¹‰å¯ä»¥å¢åŠ æ–°çš„æ•°æ®æˆ–æ–°çš„åŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥ç”¨çˆ¶ç±»çš„åŠŸèƒ½ï¼Œä½†ä¸èƒ½é€‰æ‹©æ€§åœ°ç»§æ‰¿çˆ¶ç±»ã€‚è¿™ç§æŠ€æœ¯ä½¿å¾—å¤ç”¨ä»¥å‰çš„ä»£ç éå¸¸å®¹æ˜“ï¼Œèƒ½å¤Ÿå¤§å¤§ç¼©çŸ­å¼€å‘å‘¨æœŸï¼Œé™ä½å¼€å‘è´¹ç”¨ã€‚æ¯”å¦‚å¯ä»¥å…ˆå®šä¹‰ä¸€ä¸ªç±»å«è½¦ï¼Œè½¦æœ‰ä»¥ä¸‹å±æ€§ï¼šè½¦ä½“å¤§å°ï¼Œé¢œè‰²ï¼Œæ–¹å‘ç›˜ï¼Œè½®èƒï¼Œè€Œåˆç”±è½¦è¿™ä¸ªç±»æ´¾ç”Ÿå‡ºè½¿è½¦å’Œå¡è½¦ä¸¤ä¸ªç±»ï¼Œä¸ºè½¿è½¦æ·»åŠ ä¸€ä¸ªå°åå¤‡ç®±ï¼Œè€Œä¸ºå¡è½¦æ·»åŠ ä¸€ä¸ªå¤§è´§ç®±ã€‚

1. å­ç±»æ‹¥æœ‰çˆ¶ç±»é private çš„å±æ€§å’Œæ–¹æ³•ã€‚
2. å­ç±»å¯ä»¥æ‹¥æœ‰è‡ªå·±å±æ€§å’Œæ–¹æ³•ï¼Œå³å­ç±»å¯ä»¥å¯¹çˆ¶ç±»è¿›è¡Œæ‰©å±•ã€‚
3. å­ç±»å¯ä»¥ç”¨è‡ªå·±çš„æ–¹å¼å®ç°çˆ¶ç±»çš„æ–¹æ³•ã€‚(é‡è½½)

### ç»§æ‰¿ (ç±»ä¸ç±»çš„å…³ç³»)

æœ‰ç›¸åŒçš„å±æ€§å’Œç›¸åŒçš„è¡Œä¸ºæ—¶, å®šä¹‰ä¸ºçˆ¶ç±»,  
å…¶ä»–çš„ å­ç±» åªéœ€è¦å†™ç‰¹æœ‰çš„å±æ€§å’Œæ–¹æ³•.

åœ¨é¢å‘å¯¹è±¡ä¸­, å¯ä»¥é€šè¿‡æ‰©å±•ä¸€ä¸ªå·²æœ‰çš„ç±», å¹¶ç»§æ‰¿è¯¥ç±»çš„å±æ€§å’Œè¡Œä¸º,  
æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ç±», ä»è€Œè¾¾åˆ°ä»£ç çš„å¤ç”¨.

ç»§æ‰¿æ˜¯æ‰€æœ‰ OOP è¯­è¨€ä¸å¯ç¼ºå°‘çš„éƒ¨åˆ†ï¼Œ  
åœ¨ java ä¸­ä½¿ç”¨ `extends` å…³é”®å­—æ¥è¡¨ç¤ºç»§æ‰¿å…³ç³»ã€‚  
å½“åˆ›å»ºä¸€ä¸ªç±»æ—¶ï¼Œæ€»æ˜¯åœ¨ç»§æ‰¿ï¼Œå¦‚æœæ²¡æœ‰æ˜ç¡®æŒ‡å‡ºè¦ç»§æ‰¿çš„ç±»ï¼Œ  
å°±æ€»æ˜¯éšå¼åœ°ä»æ ¹ç±» Object è¿›è¡Œç»§æ‰¿ã€‚

ç»§æ‰¿ä¸ä¼šç»§æ‰¿çˆ¶ç±»çš„æ„é€ æ–¹æ³•  
å› ä¸º:

1. è¯­æ³•ä¸Šå¦‚æœç»§æ‰¿æ¥äº†çˆ¶ç±»çš„æ„é€ æ–¹æ³•, ä½†æ˜¯ç±»åæ˜¯çˆ¶ç±»å, è·Ÿå­ç±»åä¸ä¸€æ ·
2. åœ¨é¢å‘å¯¹è±¡çš„æ€æƒ³ä¸Šè¯´ä¸é€š

**ç±»ä¸ç±»çš„å…³ç³»**

- has a (ç»„åˆ) - å±æ€§
- is a (ç»§æ‰¿)
- use a (ä½¿ç”¨) - å‚æ•°æˆ–å±€éƒ¨å˜é‡

**å…³äºç§æœ‰å±æ€§ æœ‰æ²¡æœ‰ç»§æ‰¿ èƒ½ä¸èƒ½ç»§æ‰¿ ç®—ä¸ç®—ç»§æ‰¿?**  
**ç§æœ‰å±æ€§åœ¨å­ç±»çš„å­˜å‚¨ç©ºé—´å½“ä¸­ä»–æ˜¯åˆ‡å®å­˜åœ¨çš„**  
å­ç±»å¯ä»¥ç»§æ‰¿çˆ¶ç±»çš„æ‰€æœ‰æˆå‘˜è·Ÿæ–¹æ³•ï¼Œç»§æ‰¿ä¸‹æ¥ä¸ä»£è¡¨å¯ä»¥è®¿é—®ï¼Œè¦è®¿é—®å¾—çœ‹è®¿é—®æ§åˆ¶è§„åˆ™ã€‚ç§æœ‰å±æ€§ä¹Ÿå¯ä»¥ç»§æ‰¿ï¼Œä¸è¿‡æ ¹æ®è®¿é—®æ§åˆ¶è§„åˆ™ï¼Œç§æœ‰å±æ€§è™½ç»§æ‰¿ä¸‹æ¥å´ä¸å¯ä»¥è®¿é—®çš„ï¼Œåªæœ‰é€šè¿‡ public çš„æ–¹æ³•æ‰èƒ½è®¿é—®ç»§æ‰¿ä¸‹æ¥çš„ç§æœ‰å±æ€§ã€‚

B ç»§æ‰¿ A ç±»ï¼Œã€‚A ç±»ä¸­çš„ç§æœ‰å±æ€§ï¼Œåˆ°äº† B ä¼šæ€ä¹ˆæ ·ï¼Œèƒ½ç»§æ‰¿ã€è®¿é—®å—ï¼Ÿ  
ç­”æ¡ˆæ˜¯ï¼šå¦‚æœ A ä¸­çš„å±æ€§æœ‰å¢åŠ  setter getter æ–¹æ³•ï¼Œå¯ä»¥è®¿é—®çš„ï¼š  
æ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼š

```java
class Person {
    private String name;
    private int age;
    public Person() {
    }
    public Person(String name, int age){
        this.name = name;
        this.age = age;
    }
    public void setName(String name){
        this.name = name;
    }
    public String getName(){
        return name;
    }
    public void setAge(int age){
        this.age = age;
    }
    public int getAge(){
        return age;
    }
}
class Man extends Person {

}
```

ç±» Man ç»§æ‰¿äº Person ç±»ï¼Œè¿™æ ·ä¸€æ¥çš„è¯ï¼Œ  
Person ç±»ç§°ä¸ºçˆ¶ç±»ï¼ˆåŸºç±»ï¼‰ï¼ŒMan ç±»ç§°ä¸ºå­ç±»ï¼ˆå¯¼å‡ºç±» / æ´¾ç”Ÿç±»ï¼‰ã€‚  
å¦‚æœä¸¤ä¸ªç±»å­˜åœ¨ç»§æ‰¿å…³ç³»ï¼Œåˆ™å­ç±»ä¼šè‡ªåŠ¨ç»§æ‰¿çˆ¶ç±»çš„æ–¹æ³•å’Œå˜é‡ï¼Œ  
åœ¨å­ç±»ä¸­å¯ä»¥è°ƒç”¨çˆ¶ç±»èŒƒå›´è®¿é—®ä¿®é¥°ç¬¦å…è®¸çš„æ–¹æ³•å’Œå˜é‡ã€‚

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­, å­ç±»å®ä¾‹å¯ä»¥é€šè¿‡ setter æ–¹æ³•è®¿é—®çˆ¶ç±»çš„ç§æœ‰å±æ€§, æ‰€ä»¥å°±è¯æ˜äº†å­ç±»æ˜¯ç»§æ‰¿äº†çˆ¶ç±»çš„å…¨éƒ¨å±æ€§å’Œæ–¹æ³•çš„.  
åªæ˜¯è¿™æ ·å°±ç ´åäº†å°è£…æ€§,

åœ¨ java ä¸­ï¼Œåªå…è®¸å•ç»§æ‰¿ï¼Œä¹Ÿå°±æ˜¯è¯´ ä¸€ä¸ªç±»æœ€å¤šåªèƒ½æ˜¾ç¤ºåœ°ç»§æ‰¿äºä¸€ä¸ªçˆ¶ç±»ã€‚  
ä½†æ˜¯ä¸€ä¸ªç±»å´å¯ä»¥è¢«å¤šä¸ªç±»ç»§æ‰¿ï¼Œä¸€ä¸ªç±»å¯ä»¥æ‹¥æœ‰å¤šä¸ªå­ç±»ã€‚

#### å­ç±»ç»§æ‰¿çˆ¶ç±»çš„æˆå‘˜å˜é‡

å½“å­ç±»ç»§æ‰¿äº†æŸä¸ªç±»ä¹‹åï¼Œä¾¿å¯ä»¥ä½¿ç”¨çˆ¶ç±»ä¸­çš„æˆå‘˜å˜é‡ï¼Œ  
ä½†æ˜¯å¹¶ä¸æ˜¯å®Œå…¨ç»§æ‰¿çˆ¶ç±»çš„æ‰€æœ‰æˆå‘˜å˜é‡ã€‚å…·ä½“çš„åŸåˆ™å¦‚ä¸‹ï¼š

- èƒ½å¤Ÿç»§æ‰¿çˆ¶ç±»çš„ public å’Œ protected æˆå‘˜å˜é‡ï¼›èƒ½å¤Ÿç»§æ‰¿çˆ¶ç±»çš„ private æˆå‘˜å˜é‡ (ç”¨ setter,getter æ–¹æ³•æ¥ä½¿ç”¨ private å±æ€§)ï¼›
- å¯¹äºçˆ¶ç±»çš„åŒ…è®¿é—®æƒé™æˆå‘˜å˜é‡ï¼Œå¦‚æœå­ç±»å’Œçˆ¶ç±»åœ¨åŒä¸€ä¸ªåŒ…ä¸‹ï¼Œåˆ™å­ç±»èƒ½å¤Ÿç»§æ‰¿ï¼›å¦åˆ™ï¼Œå­ç±»ä¸èƒ½å¤Ÿç»§æ‰¿ï¼›
- å¯¹äºå­ç±»å¯ä»¥ç»§æ‰¿çš„çˆ¶ç±»æˆå‘˜å˜é‡ï¼Œå¦‚æœåœ¨å­ç±»ä¸­å‡ºç°äº†åŒåç§°çš„æˆå‘˜å˜é‡ï¼Œåˆ™ä¼šå‘ç”Ÿéšè—ç°è±¡ï¼Œå³å­ç±»çš„æˆå‘˜å˜é‡ä¼šå±è”½æ‰çˆ¶ç±»çš„åŒåæˆå‘˜å˜é‡ã€‚å¦‚æœè¦åœ¨å­ç±»ä¸­è®¿é—®çˆ¶ç±»ä¸­åŒåæˆå‘˜å˜é‡ï¼Œéœ€è¦ä½¿ç”¨ `super` å…³é”®å­—æ¥è¿›è¡Œå¼•ç”¨

#### å­ç±»ç»§æ‰¿çˆ¶ç±»çš„æ–¹æ³•

- å¯¹äºçˆ¶ç±»çš„åŒ…è®¿é—®æƒé™æˆå‘˜æ–¹æ³•ï¼Œå¦‚æœå­ç±»å’Œçˆ¶ç±»åœ¨åŒä¸€ä¸ªåŒ…ä¸‹ï¼Œåˆ™å­ç±»èƒ½å¤Ÿç»§æ‰¿ï¼›å¦åˆ™ï¼Œå­ç±»ä¸èƒ½å¤Ÿç»§æ‰¿ï¼›
- å¯¹äºå­ç±»å¯ä»¥ç»§æ‰¿çš„çˆ¶ç±»æˆå‘˜æ–¹æ³•ï¼Œå¦‚æœåœ¨å­ç±»ä¸­å‡ºç°äº†åŒåç§°çš„æˆå‘˜æ–¹æ³•ï¼Œåˆ™ç§°ä¸ºè¦†ç›–ï¼Œå³å­ç±»çš„æˆå‘˜æ–¹æ³•ä¼šè¦†ç›–æ‰çˆ¶ç±»çš„åŒåæˆå‘˜æ–¹æ³•ã€‚å¦‚æœè¦åœ¨å­ç±»ä¸­è®¿é—®çˆ¶ç±»ä¸­åŒåæˆå‘˜æ–¹æ³•ï¼Œéœ€è¦ä½¿ç”¨ super å…³é”®å­—æ¥è¿›è¡Œå¼•ç”¨ã€‚

#### æ„é€ å™¨

å­ç±»æ˜¯ä¸èƒ½å¤Ÿç»§æ‰¿çˆ¶ç±»çš„æ„é€ å™¨ï¼Œå®ƒåªèƒ½å¤Ÿè¢«è°ƒç”¨.  
ã€€ã€€å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœçˆ¶ç±»çš„æ„é€ å™¨éƒ½æ˜¯å¸¦æœ‰å‚æ•°çš„ï¼Œ**åˆ™å¿…é¡»åœ¨å­ç±»çš„æ„é€ å™¨ä¸­æ˜¾ç¤ºåœ°é€šè¿‡ super å…³é”®å­—è°ƒç”¨çˆ¶ç±»çš„æ„é€ å™¨å¹¶é…ä»¥é€‚å½“çš„å‚æ•°åˆ—è¡¨ã€‚**å¦‚æœçˆ¶ç±»æœ‰æ— å‚æ„é€ å™¨ï¼Œåˆ™åœ¨å­ç±»çš„æ„é€ å™¨ä¸­ç”¨ super å…³é”®å­—è°ƒç”¨çˆ¶ç±»æ„é€ å™¨ä¸æ˜¯å¿…é¡»çš„ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨ super å…³é”®å­—ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒç”¨çˆ¶ç±»çš„æ— å‚æ„é€ å™¨ã€‚

**è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢?:**

å› ä¸ºä½¿ç”¨å­ç±»æ—¶å€™, å®ä¾‹åŒ–ä¸€ä¸ªå­ç±»å¯¹è±¡æ—¶, ç„¶åå°±å¯ä»¥è°ƒç”¨çˆ¶ç±»çš„ public å±æ€§å’Œæ–¹æ³•;  
ä½†æ˜¯åœ¨è°ƒç”¨çˆ¶ç±»å±æ€§å’Œæ–¹æ³•ä¹‹å‰, æˆ‘ä»¬å¹¶æ²¡æœ‰å®ä¾‹åŒ–çˆ¶ç±»å¯¹è±¡, æ‰€ä»¥è¿™ä¸ªæ—¶å€™,  
å¿…é¡»åœ¨å­ç±»æ„é€ å™¨ä¸­è°ƒç”¨çˆ¶ç±»æ„é€ å™¨;

- `å­ç±» a = new å­ç±»();`
- å¦‚æœçˆ¶ç±»æ²¡æœ‰æ— å‚æ„é€ å™¨, åˆ™åœ¨å­ç±»æ„é€ å™¨ä¸­å¿…é¡»æ˜¾ç¤ºçš„ç”¨ super è°ƒç”¨çˆ¶ç±»æ„é€ å™¨.
- å¦‚æœçˆ¶ç±»æœ‰æ— å‚æ„é€ , åˆ™å¯ä»¥ä¸å†™ super, ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨çˆ¶ç±»æ— å‚æ„é€ ;  
  å½“ new ä¸€ä¸ªå­ç±»æ—¶, è°ƒç”¨å­ç±»æ„é€ å™¨, ç„¶åå­ç±»æ„é€ å™¨ä¸­è°ƒç”¨çˆ¶ç±»æ„é€ å™¨,

çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­å°±æ¸…æ¥šäº†ï¼š

```java
class Shape {
    protected String name;
    public Shape(){  //æ— å‚æ„é€ æ–¹æ³• ä½œç”¨æ˜¯åˆå§‹åŒ–name
        name = "shape";
    }
    public Shape(String name) { //æœ‰å‚æ„é€ æ–¹æ³•  new shape( "å¼ ä¸‰")
        this.name = name;
    }
}
class Circle extends Shape { //Circle ç»§æ‰¿ Shape
    private double radius;
    public Circle() { //æ— å‚æ„é€ æ–¹æ³•
        radius = 0;
    }
    public Circle(double radius) {
        this.radius = radius;
    }
    public Circle(double radius,String name) {
        this.radius = radius;
        this.name = name;
    }
}
```

è¿™æ ·çš„ä»£ç æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå¦‚æœæŠŠçˆ¶ç±»çš„æ— å‚æ„é€ å™¨å»æ‰ï¼Œåˆ™ä¸‹é¢çš„ä»£ç å¿…ç„¶ä¼šå‡ºé”™ï¼š

æ”¹æˆä¸‹é¢è¿™æ ·å°±è¡Œäº†ï¼š

```java
class Shape {
    protected String name;
    //public Shape(){
        //name = "shape";
    //}
    public Shape(String name) {
        this.name = name;
    }
}
class Circle extends Shape {
    private double radius;
    public Circle() {
        radius = 0;
    }
    public Circle(double radius) {
        this.radius = radius;
    }
    public Circle(double radius,String name) {
        super(name);
        this.radius = radius;
        this.name = name;
    }
}
```

å­ç±»çš„æ„é€ æ–¹æ³•ï¼Œä¸ç®¡è¿™ä¸ªæ„é€ æ–¹æ³•å¸¦ä¸å¸¦å‚æ•°ï¼Œé»˜è®¤çš„å®ƒéƒ½ä¼šå…ˆå»å¯»æ‰¾çˆ¶ç±»çš„ä¸å¸¦å‚æ•°çš„æ„é€ æ–¹æ³•ã€‚å¦‚æœçˆ¶ç±»æ²¡æœ‰ä¸å¸¦å‚æ•°çš„æ„é€ æ–¹æ³•ï¼Œé‚£ä¹ˆå­ç±»å¿…é¡»ç”¨ supper å…³é”®å­æ¥è°ƒç”¨çˆ¶ç±»å¸¦å‚æ•°çš„æ„é€ æ–¹æ³•ï¼Œå¦åˆ™ç¼–è¯‘ä¸èƒ½é€šè¿‡

##### super

super ä¸»è¦æœ‰ä¸¤ç§ç”¨æ³•ï¼š

1. super. æˆå‘˜å˜é‡ / super. æˆå‘˜æ–¹æ³•;
2. super(parameter1,parameter2â€¦.)

ç¬¬ä¸€ç§ç”¨æ³•ä¸»è¦ç”¨æ¥åœ¨å­ç±»ä¸­è°ƒç”¨çˆ¶ç±»çš„åŒåæˆå‘˜å˜é‡æˆ–è€…æ–¹æ³•ï¼›ç¬¬äºŒç§ä¸»è¦ç”¨åœ¨å­ç±»çš„æ„é€ å™¨ä¸­æ˜¾ç¤ºåœ°è°ƒç”¨çˆ¶ç±»çš„æ„é€ å™¨ï¼Œè¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ˜¯ç”¨åœ¨å­ç±»æ„é€ å™¨ä¸­ï¼Œåˆ™å¿…é¡»æ˜¯å­ç±»æ„é€ å™¨çš„ç¬¬ä¸€ä¸ªè¯­å¥ã€‚

[this å’Œ super å…³é”®å­—çš„åŒºåˆ«](http://blog.csdn.net/codeai/article/details/46851293)

å¯ä»¥åœ¨æˆ‘çš„å¦ä¸€ç¯‡åšå®¢ä¸­çœ‹åˆ°

#### å‘ä¸Šè½¬å‹

åœ¨ä¸Šé¢çš„ç»§æ‰¿ä¸­æˆ‘ä»¬è°ˆåˆ°ç»§æ‰¿æ˜¯ is-a çš„ç›¸äº’å…³ç³»ï¼ŒçŒ«ç»§æ‰¿ä¸åŠ¨ç‰©ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¯´çŒ«æ˜¯åŠ¨ç‰©ï¼Œæˆ–è€…è¯´çŒ«æ˜¯åŠ¨ç‰©çš„ä¸€ç§ã€‚è¿™æ ·å°†çŒ«çœ‹åšåŠ¨ç‰©å°±æ˜¯å‘ä¸Šè½¬å‹ã€‚å¦‚ä¸‹ï¼š

```java
public class Person {
    public void display(){
        System.out.println("Play Person...");
    }

    static void display(Person person){
        person.display();
    }
}

public class Husband extends Person{
    public static void main(String[] args) {
        Husband husband = new Husband();
        Person.display(husband);      //å‘ä¸Šè½¬å‹
    }
}
```

åœ¨è¿™æˆ‘ä»¬é€šè¿‡ Person.display(husband)ã€‚è¿™å¥è¯å¯ä»¥çœ‹å‡º husband æ˜¯ person ç±»å‹ã€‚  
å°†å­ç±»è½¬æ¢æˆçˆ¶ç±»ï¼Œåœ¨ç»§æ‰¿å…³ç³»ä¸Šé¢æ˜¯å‘ä¸Šç§»åŠ¨çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬ç§°ä¹‹ä¸ºå‘ä¸Šè½¬å‹ã€‚ç”±äºå‘ä¸Šè½¬å‹æ˜¯ä»ä¸€ä¸ªå«ä¸“ç”¨ç±»å‹å‘è¾ƒé€šç”¨ç±»å‹è½¬æ¢ï¼Œæ‰€ä»¥å®ƒæ€»æ˜¯å®‰å…¨çš„ï¼Œå”¯ä¸€å‘ç”Ÿå˜åŒ–çš„å¯èƒ½å°±æ˜¯å±æ€§å’Œæ–¹æ³•çš„ä¸¢å¤±ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆç¼–è¯‘å™¨åœ¨ â€œæœªæ›¾æ˜ç¡®è¡¨ç¤ºè½¬å‹â€ æˆ–â€œæœªæ›¾æŒ‡å®šç‰¹æ®Šæ ‡è®°â€çš„æƒ…å†µä¸‹ï¼Œä»ç„¶å…è®¸å‘ä¸Šè½¬å‹çš„åŸå› ã€‚

è¿™ä¹Ÿæ˜¯å¤šæ€çš„ä¸€ç§, å…³äºå¤šæ€, å°†åœ¨ä¸‹ä¸€ç¯‡åšå®¢ä¸­æ€»ç»“.

**å¸¸è§çš„é¢è¯•ç¬”è¯•é¢˜**

1. ä¸‹é¢è¿™æ®µä»£ç çš„è¾“å‡ºç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ

```java
public class Test {
    public static void main(String[] args)  {
       new Circle();
    }
}
class Draw {
    public Draw(String type) {
        System.out.println(type+" draw constructor");
    }
}
class Shape {
    private Draw draw = new Draw("shape");
    public Shape(){
        System.out.println("shape constructor");
    }
}
class Circle extends Shape {
    private Draw draw = new Draw("circle");
    public Circle() {
        System.out.println("circle constructor");
    }
}
```

> è¾“å‡º 1.shape draw construtor  
> 2.shape construtor  
> 3.circle draw constructor  
> 4.circle constructor

è¿™é“é¢˜ç›®ä¸»è¦è€ƒå¯Ÿçš„æ˜¯ç±»ç»§æ‰¿æ—¶æ„é€ å™¨çš„è°ƒç”¨é¡ºåºå’Œåˆå§‹åŒ–é¡ºåºã€‚è¦è®°ä½ä¸€ç‚¹ï¼šçˆ¶ç±»çš„æ„é€ å™¨è°ƒç”¨ä»¥åŠåˆå§‹åŒ–è¿‡ç¨‹ä¸€å®šåœ¨å­ç±»çš„å‰é¢ã€‚ç”±äº Circle ç±»çš„çˆ¶ç±»æ˜¯ Shape ç±»ï¼Œæ‰€ä»¥ Shape ç±»å…ˆè¿›è¡Œåˆå§‹åŒ–ï¼Œç„¶åå†æ‰§è¡Œ Shape ç±»çš„æ„é€ å™¨ã€‚æ¥ç€æ‰æ˜¯å¯¹å­ç±» Circle è¿›è¡Œåˆå§‹åŒ–ï¼Œæœ€åæ‰§è¡Œ Circle çš„æ„é€ å™¨ã€‚

ç±»ç»§æ‰¿æ—¶æ„é€ å™¨çš„è°ƒç”¨é¡ºåºå’Œåˆå§‹åŒ–é¡ºåº  
![20241229154732_11OcFtmH.webp](https://cdn.dong4j.site/source/image/20241229154732_11OcFtmH.webp)

åœ¨å­ç±»ä¸­è®¿é—®ä¸€ä¸ªå˜é‡æ—¶çš„æŸ¥æ‰¾é¡ºåº (æŸ¥æ‰¾æ–¹æ³•ä¸€æ ·)  
![20241229154732_RJx49v3S.webp](https://cdn.dong4j.site/source/image/20241229154732_RJx49v3S.webp)

### é‡å†™ Override

å‘ç”Ÿåœ¨ç»§æ‰¿çš„æ—¶å€™, å­ç±»æ–¹æ³•è·Ÿçˆ¶ç±»æ–¹æ³•é‡å, å‘ç”Ÿäº†è¦†ç›–, é‡å†™å­ç±»æ–¹æ³•çš„å®ç°;

1. æ–¹æ³•åç›¸åŒ
2. å‚æ•°åˆ—è¡¨ç›¸åŒ
3. è¿”å›ç±»å‹ç›¸åŒ
4. è®¿é—®ä¿®é¥°ç¬¦å¿…é¡»å¤§äºç­‰äºçˆ¶ç±»
5. æŠ›å‡ºçš„å¼‚å¸¸ä¸èƒ½æ¯”çˆ¶ç±»å¤š

#### éšè—å’Œè¦†ç›–çš„åŒºåˆ«

- éšè—å‘ç”Ÿåœ¨å­ç±»å±æ€§åè·Ÿçˆ¶ç±»å±æ€§ååŒåçš„æ—¶å€™, åœ¨å­ç±»ä¸­è°ƒç”¨é‡åçš„å±æ€§çš„æ—¶å€™, åªèƒ½è®¿é—®åˆ°å­ç±»çš„é‚£ä¸ªå±æ€§; å¦‚æœè¦è°ƒç”¨çˆ¶ç±»çš„åŒåå±æ€§, å¿…é¡»ç”¨ super. å±æ€§åè°ƒç”¨
- è¦†ç›–å‘ç”Ÿåœ¨å­ç±»æ–¹æ³•åè·Ÿçˆ¶ç±»æ–¹æ³•åç›¸åŒçš„æ—¶å€™, ä¹Ÿè¦ç”¨ super. æ–¹æ³•å () æ¥è°ƒç”¨çˆ¶ç±»ä¸­çš„åŒåæ–¹æ³•;

#### é‡è½½å’Œé‡å†™

é‡å†™: æ˜¯æœ‰ç»§æ‰¿å…³ç³»çš„ 2 ä¸ªç±»å‘ç”Ÿçš„  
é‡è½½: ä¸€ä¸ªç±»ä¸­æœ‰å¤šä¸ªç›¸åŒçš„æ–¹æ³•å

### æ€»ç»“:

ç»§æ‰¿: æŠŠå…·æœ‰ç›¸åŒå±æ€§, ç›¸åŒè¡Œä¸ºçš„ç±»æŠ½å–å‡ºæ¥, ä½œä¸ºä¸€ä¸ªçˆ¶ç±», ç„¶åå¦ä¸€ä¸ªç±»å»ç»§æ‰¿è¿™ä¸ªç±», é‚£ä¹ˆè¿™ä¸ªç±»å°±æœ‰äº†çˆ¶ç±»çš„å±æ€§å’Œæ–¹æ³•

**å…³ç³»:**  
is a

**ç‰¹ç‚¹:**  
å†…å­˜ä¸Š, å åŠ 

**æ•ˆæœ:**  
å­ç±»æ‹¥æœ‰çˆ¶ç±»çš„å±æ€§å’Œè¡Œä¸ºæ–¹æ³•, ä½†æ˜¯ä¸ç»§æ‰¿çˆ¶ç±»çš„æ„é€ æ–¹æ³•;

**æ„é€ è°ƒç”¨é¡ºåº:**  
å…ˆçˆ¶ç±»æ„é€ , å†å­ç±»æ„é€   
ä¿®æ”¹çˆ¶ç±»çš„è¡Œä¸ºâ€“> é‡å†™

**è°¨æ…ç»§æ‰¿**  
ä¸Šé¢è®²äº†ç»§æ‰¿æ‰€å¸¦æ¥çš„è¯¸å¤šå¥½å¤„ï¼Œé‚£æˆ‘ä»¬æ˜¯ä¸æ˜¯å°±å¯ä»¥å¤§è‚†åœ°ä½¿ç”¨ç»§æ‰¿å‘¢ï¼Ÿé€ä½ ä¸€å¥è¯ï¼šæ…ç”¨ç»§æ‰¿ã€‚  
é¦–å…ˆæˆ‘ä»¬éœ€è¦æ˜ç¡®ï¼Œç»§æ‰¿å­˜åœ¨å¦‚ä¸‹ç¼ºé™·ï¼š  
1ã€çˆ¶ç±»å˜ï¼Œå­ç±»å°±å¿…é¡»å˜ã€‚  
2ã€ç»§æ‰¿ç ´åäº†å°è£…ï¼Œå¯¹äºçˆ¶ç±»è€Œè¨€ï¼Œå®ƒçš„å®ç°ç»†èŠ‚å¯¹ä¸å­ç±»æ¥è¯´éƒ½æ˜¯é€æ˜çš„ã€‚  
3ã€ç»§æ‰¿æ˜¯ä¸€ç§å¼ºè€¦åˆå…³ç³»ã€‚  
æ‰€ä»¥è¯´å½“æˆ‘ä»¬ä½¿ç”¨ç»§æ‰¿çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿¡ä½¿ç”¨ç»§æ‰¿ç¡®å®æ˜¯æœ‰æ•ˆå¯è¡Œçš„åŠæ³•ã€‚é‚£ä¹ˆåˆ°åº•è¦ä¸è¦ä½¿ç”¨ç»§æ‰¿å‘¢ï¼Ÿã€ŠThink in javaã€‹ä¸­æä¾›äº†è§£å†³åŠæ³•ï¼šé—®ä¸€é—®è‡ªå·±æ˜¯å¦éœ€è¦ä»å­ç±»å‘çˆ¶ç±»è¿›è¡Œå‘ä¸Šè½¬å‹ã€‚å¦‚æœå¿…é¡»å‘ä¸Šè½¬å‹ï¼Œåˆ™ç»§æ‰¿æ˜¯å¿…è¦çš„ï¼Œä½†æ˜¯å¦‚æœä¸éœ€è¦ï¼Œåˆ™åº”å½“å¥½å¥½è€ƒè™‘è‡ªå·±æ˜¯å¦éœ€è¦ç»§æ‰¿ã€‚

### Object ç±»

Object ç±»æ˜¯æ‰€æœ‰ç±»çš„ç›´æ¥çˆ¶ç±», å¦‚æœå£°æ˜ä¸€ä¸ªç±»æ—¶æ²¡æœ‰æ˜¾å¼çš„ç»§æ‰¿å¦ä¸€ä¸ªç±», é‚£ä¹ˆè¿™ä¸ªç±»å°±ä¼šç»§æ‰¿ Object ç±», ä»è€Œæ‹¥æœ‰äº† Object ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•, æ•°ç»„ä¹Ÿä¸ä¾‹å¤–.

#### Object ç±»çš„ä¸­æ–¹æ³•

Object ç±»ä¸€å…±æœ‰ 11 ä¸ªæ–¹æ³•, ä½œä¸ºç¥–å®—ç±», è€Œè¿™ 11 ä¸ªæ–¹æ³•è¿˜å¾—ä»¥ä¿ç•™, è¯´æ˜è¿™äº›æ–¹æ³•çš„é€šç”¨æ€§å¾ˆé«˜, æ‰€ä»¥æˆ‘ä»¬éƒ½å¿…é¡»æŒæ¡.

1. `protected Object clone()` åˆ›å»ºå¹¶è¿”å›æ­¤å¯¹è±¡çš„ä¸€ä¸ªå‰¯æœ¬
2. `boolean equals(Object obj)` æŒ‡ç¤ºå…¶ä»–æŸä¸ªå¯¹è±¡æ˜¯å¦ä¸æ­¤å¯¹è±¡ â€œç›¸ç­‰â€ã€‚

   - å¯¹äº Object ç±»ä¸­, equals çš„åº•å±‚å®ç°å°±æ˜¯ä½¿ç”¨çš„ `==` è¿ç®—ç¬¦, è€Œè¿™å¹¶ä¸èƒ½æ»¡è¶³æˆ‘ä»¬å¯¹å¯¹è±¡çš„æ¯”è¾ƒ, æ‰€ä»¥å¿…é¡»é‡å†™, åœ¨ String ç±»ä¸­å°±é‡å†™äº†æ­¤æ–¹æ³•
   - åŸºæœ¬æ€è·¯:
     - å…ˆåˆ¤æ–­æ˜¯å¦æ˜¯åŒä¸€ä¸ªç±»çš„å®ä¾‹, å¦‚æœæ˜¯å°±è¿”å› true;
     - å¦‚æœä¸æ˜¯, å†åˆ†åˆ«æ¯”è¾ƒæ¯ä¸ªå±æ€§å€¼, å¦‚æœæœ‰ä¸€ä¸ªä¸åŒ, å°±è¿”å› flase
     - å¦‚æœéƒ½ç›¸åŒ, å°±è¿”å› true

3. `protected void finalize()` å½“åƒåœ¾å›æ”¶å™¨ç¡®å®šä¸å­˜åœ¨å¯¹è¯¥å¯¹è±¡çš„æ›´å¤šå¼•ç”¨æ—¶ï¼Œç”±å¯¹è±¡çš„åƒåœ¾å›æ”¶å™¨è°ƒç”¨æ­¤æ–¹æ³•ã€‚
4. `Class<?> getClass()` è¿”å›æ­¤ Object çš„è¿è¡Œæ—¶ç±» (åå°„ä¸­ç”¨åˆ°)ã€‚
5. `int hash Code()` è¿”å›è¯¥å¯¹è±¡çš„å“ˆå¸Œç å€¼
6. `void notify()` å”¤é†’åœ¨æ­¤å¯¹è±¡ç›‘è§†å™¨ä¸Šç­‰å¾…çš„å•ä¸ªçº¿ç¨‹
7. `void notifyAll()` å”¤é†’åœ¨æ­¤å¯¹è±¡ç›‘è§†å™¨ä¸Šç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹
8. `String toString()` è¿”å›è¯¥å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤º

   - æ­¤æ–¹æ³•çš„å®ç°:
     - `getClass().getName() + '@' + Integer.toHexString(hashCode())`
   - å¦‚æœä¸é‡å†™è¿™ä¸ªæ­¤æ–¹æ³•, è¿”å›çš„æ˜¯ `ç±»å@å¼•ç”¨å€¼`, å¯¹äºæˆ‘ä»¬æ¥è¯´æ²¡ç”¨, æ‰€ä»¥ä¸€èˆ¬ä½¿ç”¨ toString æ–¹æ³•æ—¶éƒ½éœ€è¦é‡å†™

9. `void wait()` åœ¨å…¶ä»–çº¿ç¨‹è°ƒç”¨æ­¤å¯¹è±¡çš„ notify() æ–¹æ³•æˆ– notifyAll() æ–¹æ³•å‰ï¼Œå¯¼è‡´å½“å‰çº¿ç¨‹ç­‰å¾…ã€‚
10. `void wait(long timeout)` åœ¨å…¶ä»–çº¿ç¨‹è°ƒç”¨æ­¤å¯¹è±¡çš„ notify() æ–¹æ³•æˆ– notifyAll() æ–¹æ³•ï¼Œæˆ–è€…è¶…è¿‡æŒ‡å®šçš„æ—¶é—´é‡å‰ï¼Œå¯¼è‡´å½“å‰çº¿ç¨‹ç­‰å¾…
11. `void wait(long timeout, int nanos)` åœ¨å…¶ä»–çº¿ç¨‹è°ƒç”¨æ­¤å¯¹è±¡çš„ notify() æ–¹æ³•æˆ– notifyAll() æ–¹æ³•ï¼Œæˆ–è€…å…¶ä»–æŸä¸ªçº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹ï¼Œæˆ–è€…å·²è¶…è¿‡æŸä¸ªå®é™…æ—¶é—´é‡å‰ï¼Œå¯¼è‡´å½“å‰çº¿ç¨‹ç­‰å¾…ã€‚

## [å°è£…ä¸å¤šæ€ï¼šJavaç¼–ç¨‹çš„æ ¸å¿ƒ](https://blog.dong4j.site/posts/d60eb45.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

### ä»€ä¹ˆæ˜¯å°è£…

- éšè—å¯¹è±¡çš„å±æ€§å’Œå®ç°ç»†èŠ‚ï¼Œä»…å¯¹å¤–å…¬å¼€æ¥å£;
- æ§åˆ¶åœ¨ç¨‹åºä¸­å±æ€§çš„è¯»å’Œä¿®æ”¹çš„è®¿é—®çº§åˆ«ï¼›
- å°†æŠ½è±¡å¾—åˆ°çš„æ•°æ®å’Œè¡Œä¸ºï¼ˆæˆ–åŠŸèƒ½ï¼‰ç›¸ç»“åˆï¼Œå½¢æˆä¸€ä¸ªæœ‰æœºçš„æ•´ä½“ï¼Œä¹Ÿå°±æ˜¯å°†æ•°æ®ä¸æ“ä½œæ•°æ®çš„æºä»£ç è¿›è¡Œæœ‰æœºçš„ç»“åˆï¼Œå½¢æˆ â€œç±»â€ï¼Œå…¶ä¸­æ•°æ®å’Œå‡½æ•°éƒ½æ˜¯ç±»çš„æˆå‘˜ã€‚

**é€šä¿—çš„è¯´å°±æ˜¯:**  
åˆ©ç”¨æŠ½è±¡æ•°æ®ç±»å‹å°†æ•°æ®å’ŒåŸºäºæ•°æ®çš„æ“ä½œç»„åˆåœ¨ä¸€èµ·, æ˜¯å…¶æ„æˆä¸€ä¸ªä¸å¯åˆ†å‰²çš„ç‹¬ç«‹å®ä½“, æ•°æ®è¢«ä¿æŠ¤åœ¨æŠ½è±¡æ•°æ®ç±»å‹çš„å†…éƒ¨, å°½å¯èƒ½çš„éšè—å†…éƒ¨çš„ç»†èŠ‚, åªä¿ç•™ä¸€äº›å¯¹å¤–çš„æ¥å£ä½¿ä¹‹ä¸å¤–éƒ¨å‘ç”Ÿè”ç³».  
ç”¨æˆ·æ— éœ€çŸ¥é“å†…éƒ¨çš„å®ç°ç»†èŠ‚, ä½†å¯ä»¥é€šè¿‡è¯¥å¯¹è±¡å¯¹å¤–æä¾›çš„æ¥å£æ¥è®¿é—®è¯¥å¯¹è±¡.

#### å°è£…çš„å¥½å¤„

1. è‰¯å¥½çš„å°è£…èƒ½å¤Ÿå‡å°‘è€¦åˆ
2. ç±»å†…éƒ¨çš„ç»“æ„å¯ä»¥è‡ªç”±ä¿®æ”¹
3. å¯ä»¥å¯¹æˆå‘˜è¿›è¡Œæ›´ç²¾ç¡®çš„æ§åˆ¶
4. éšè—ä¿¡æ¯, å®ç°ç»†èŠ‚

#### JavaBean

**JavaBean è§„èŒƒ:** æ ‡å‡† java ç±» Sun å…¬å¸è§„å®š  
ä¸ºç§æœ‰å±æ€§æä¾›ç¬¦åˆå‘½åè§„èŒƒçš„ set å’Œ get æ–¹æ³•

2. JavaBean å¿…é¡»å£°æ˜ä¸º public class
3. JavaBean çš„æ‰€æœ‰å±æ€§å¿…é¡»å£°æ˜ä¸º private
4. é€šè¿‡ setter å’Œ getter æ–¹æ³•è®¾å€¼å’Œå–å€¼
5. é€šè¿‡ JSP è°ƒç”¨æ˜¯, åˆ™éœ€è¦ä¸€ä¸ªæ— å‚çš„æ„é€ æ–¹æ³•
6. ç¼–å†™ä»£ç è¦ä¸¥æ ¼éµå¾ª Java ç¨‹åºçš„å‘½åè§„èŒƒ

#### geter å’Œ setter æ›´æ·±å…¥ç†è§£

- å½“æŠŠç±»çš„å±æ€§å’Œæ–¹æ³•è®¿é—®æƒé™è®¾ç½®ä¸º private æ—¶, ä¸€èˆ¬éƒ½æä¾›ä¸Šé¢ 2 ä¸ªå…¬å…±æ–¹æ³•;  
   åœ¨è¿™ 2 ä¸ªæ–¹æ³•ä½“å†…, å¯ä»¥æ·»åŠ ä¸€äº›é™åˆ¶ä»£ç ;  
   æ¯”å¦‚è¯´ setter æ–¹æ³•, éœ€è¦ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç æ‰æœ‰æƒé™ä¿®æ”¹  
   getter ä¹Ÿå¯ä»¥è¿™ä¹ˆåš, è¿˜å¯ä»¥åœ¨è¿”å›å€¼çš„æ—¶å€™åšä¸€äº›åŠ¨ä½œ;  
   è¿™å°±æ˜¯éšè—.

- ä¹Ÿå¯ä»¥ç”¨ private ä¿®é¥° setter æ–¹æ³•æˆ–ä¸æä¾›, é‚£ä¹ˆè¿™ä¸ªå±æ€§å°±æ˜¯åªè¯»;
- ç”¨ private ä¿®é¥° getter æ–¹æ³•æˆ–ä¸æä¾›, è¿™ä¸ªå±æ€§å°±æ˜¯åªå†™;

##### ä¸€ä¸ªç®€å•çš„å°è£…

```java
class Person {
   private String name;
   private int age;
   private double weight;
   private boolean genger;

   private boolean count = true;
   public Person(){

   }
   public Person(String name, int age, double weight, boolean genger){
        this.name   = name;
        this.age    = age ;
        this.weight = weight;
        this.genger = genger;
   }

   public void setName(String name){
    //è®¿é—®ä¿®é¥°ç¬¦æ˜¯public,è¯´æ˜å¯ä»¥è¢«å¤–ç•Œè°ƒç”¨
    //ä½†æ˜¯æœ‰æ¡ä»¶,å€¼å…è®¸è¢«è°ƒç”¨ä¸€æ¬¡,æ„æ€æ˜¯å¯ä»¥ä¿®æ”¹ä¸€æ¬¡å§“å;
        if(count){
            this.name = name;
            count = false;
        }else
            System.out.println("å§“ååªå…è®¸è¢«ä¿®æ”¹ä¸€æ¬¡");
   }
   //å¤–ç•Œåªèƒ½å–å¾—åå­—
   public String getName(){
        return name;
   }
   //setAge,è®©å¤–ç•Œä¸èƒ½è°ƒç”¨æ­¤æ–¹æ³•,
   //è¡¨ç¤ºä¸€ä¸ªäººçš„å¹´é¾„æ˜¯åªè¯»çš„,åˆ«äººæ— æƒæ›´æ”¹
   private void setAge(int age){
        this.age = age;
   }
   public int getAge(){
        return age;
   }

   private void setWeight(double weight){
        this.weight = weight;
   }
   public double getWeight(){
        return weight;
   }

   //æ­¤å¤„æ²¡æœ‰setGengeræ–¹æ³•,è¡¨ç¤ºäººçš„æ€§åˆ«ä¸èƒ½è¢«æ›´æ”¹
   public String getGenger(){
        return genger ? "ç”·" : "å¥³";
   }

}

public class EncapsulationDemo{
    public static void main(String[] args) {
        Person p = new Person("å¼ ä¸‰",26,62.8,true);
        System.out.println("å§“å:" + p.getName() + "\n" +
                           "å¹´é¾„:" + p.getAge() + "å²\n" +
                           "ä½“é‡:" + p.getWeight() + "Kg\n" +
                           "æ€§åˆ«:" + p.getGenger() );
    }
}
```

**æ•°ç»„çš„å°è£…**

```
public class ArrayClass {
    private int[]   array;
    // ä¸‹æ ‡
    private int     index;
    // æ–°å»ºæ•°ç»„é•¿åº¦
    private int     size;

    // è°ƒç”¨æ— å‚æ„é€ çš„æ—¶å€™,é»˜è®¤åˆå§‹å¤§å°ä¸º1;
    public ArrayClass() {
        size = 1;
        array = new int[size];
        index = 0;
    }

    // è°ƒç”¨æœ‰å‚æ„é€ çš„æ—¶å€™,ç”¨æˆ·è‡ªå®šä¹‰æ•°å­—å¤§å°
    public ArrayClass(int size) {
        this.size = size;
        array = new int[size];
        index = 0;
    }
}
```

### æ–¹æ³•çš„é‡è½½ (Overload)

**åŒä¸€ä¸ªç±»ä¸­çš„æ–¹æ³•åç›¸åŒ, å‚æ•°åˆ—è¡¨ä¸åŒ; å’Œè¿”å›å€¼ç±»å‹æ— å…³**  
é‡è½½æ˜¯é™æ€å¤šæ€çš„å‰æ

æˆ‘æ˜¯è¿™æ ·ç†è§£é‡è½½çš„

> å¦ˆ, æˆ‘é¥¿äº†, æˆ‘æƒ³åƒè›‹ç‚’é¥­ â€“> ç„¶åæˆ‘å¦ˆç»™æˆ‘ç‚’äº†è›‹ç‚’é¥­åƒ  
> æˆ‘, æˆ‘é¥¿äº†, æˆ‘æƒ³åƒé¥ºå­ â€“> ç„¶åæˆ‘å¦ˆç»™æˆ‘ç…®äº†é¥ºå­åƒ  
> æˆ‘, æˆ‘é¥¿äº† â€“> ç„¶åæˆ‘å¦ˆç»™äº†æˆ‘ä¸€æ¯ç™½å¼€æ°´â€¦..

```java
//ä¼ªä»£ç 
//å¦ˆå¦ˆç±»
class Mon{
    public void ç…®é¥­çš„æ–¹æ³•(){
        System.out.println("å¤šå–ç‚¹å¼€æ°´å°±ä¸é¥¿äº†");
    }
    public void ç…®é¥­çš„æ–¹æ³•(è›‹ç‚’é¥­){
        System.out.println("ä¹–å„¿å­æ¥åƒè›‹ç‚’é¥­");
    }
    public void ç…®é¥­çš„æ–¹æ³•(é¥ºå­){
        System.out.println("ä¹–å„¿å­æ¥åƒé¥ºå­");
    }
}

public class Test{
    public static void main(String[] args){
        Mon m = new Mon();
        m.ç…®é¥­çš„æ–¹æ³•(é¥ºå­);
        m.ç…®é¥­çš„æ–¹æ³•(è›‹ç‚’é¥­);
        m.ç…®é¥­çš„æ–¹æ³•();
    }
}
```

æˆ‘è°ƒç”¨æˆ‘å¦ˆå¦ˆçš„ç…®é¥­çš„æ–¹æ³•, ä¼ å…¥ä¸åŒçš„å‚æ•°, æˆ‘å¦ˆå¦ˆåšå‡ºä¸åŒçš„ååº”.

å°±è¿™æ ·å§, è¿™å°±æ˜¯é‡è½½, ä¸çŸ¥é“æ‡‚äº†æ²¡æœ‰â€¦â€¦

**ä¸ºä»€ä¹ˆä¸èƒ½ç”¨è¿”å›å€¼ç±»å‹ç±»åŒºåˆ†é‡è½½**  
æ¯”å¦‚ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•ï¼Œè™½ç„¶ä»–ä»¬æœ‰åŒæ ·çš„åå­—å’Œå½¢å¼ï¼Œä½†å´å¾ˆå®¹æ˜“åŒºåˆ†å®ƒä»¬ï¼š  
Java ä»£ç  `void f(){}` `int f(){reurn1;}`  
åªè¦ç¼–è¯‘å™¨å¯ä»¥æ ¹æ®è¯­å¢ƒæ˜ç¡®åˆ¤æ–­å‡ºè¯­ä¹‰ï¼Œæ¯”å¦‚åœ¨ int x =f() ä¸­ï¼Œé‚£ä¹ˆçš„ç¡®å¯ä»¥æ®æ­¤åŒºåˆ†é‡è½½æ–¹æ³•ã€‚  
ä¸è¿‡ï¼Œæœ‰æ—¶ä½ å¹¶ä¸å…³å¿ƒæ–¹æ³•çš„è¿”å›å€¼ï¼Œä½ æƒ³è¦çš„æ˜¯æ–¹æ³•è°ƒç”¨çš„å…¶ä»–æ•ˆæœï¼Œè¿™æ—¶ä½ å¯èƒ½ä¼šè°ƒç”¨æ–¹æ³•è€Œå¿½ç•¥å…¶è¿”å›å€¼ã€‚  
æ‰€ä»¥ï¼Œå¦‚æœåƒä¸‹é¢è¿™æ ·è°ƒç”¨æ–¹æ³•ï¼šf()ï¼›æ­¤æ—¶ Java å¦‚ä½•æ‰èƒ½åˆ¤æ–­è¯¥è°ƒç”¨å“ªä¸€ä¸ª f() å‘¢ï¼Ÿ  
å› æ­¤ï¼Œæ ¹æ®æ–¹æ³•çš„è¿”å›å€¼æ¥åŒºåˆ†é‡è½½æ–¹æ³•æ˜¯è¡Œä¸é€šçš„

## [JavaåŸºç¡€åˆ°è¿›é˜¶ï¼šMathç±»ä¸åŒ…è£…ç±»çš„å­¦ä¹ ä¹‹è·¯](https://blog.dong4j.site/posts/5d1ffcf3.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

### Math ç±»

Math ç±»ä¸­æ‰€æœ‰çš„å±æ€§å’Œæ–¹æ³•éƒ½æ˜¯é™æ€çš„, ä¹Ÿå°±æ˜¯è¯´å…¨éœ²éƒ½å¯ä»¥å¯ç”¨ Math. å±æ€§å’Œ Math. æ–¹æ³•åè°ƒç”¨å±æ€§å’Œæ–¹æ³•.

- å±æ€§
- `static double E`: æ¯”ä»»ä½•å€¼éƒ½æ¥è¿‘ e çš„ double å€¼
- `static double PI`: æ¯”ä»»ä½•å€¼éƒ½æ¥è¿‘ pi çš„ double å€¼
- å‡ ä¸ªå¸¸ç”¨çš„æ–¹æ³•
  - `ceil(double a)` : è¿”å›å¤§äºç­‰äºè¿™ä¸ªå‚æ•°çš„æ•´æ•°
    - Math.ceil(-12.1) è¿”å› - 12 ; Math.ceil(12.8) è¿”å› 13;
  - `floor(double a)`: è¿”å›å°äºç­‰äºå‚æ•°çš„æ•´æ•°;
    - Math.floor(-12.1) è¿”å› - 13;Math.floor(12.9) è¿”å› 12;
  - `rint(double a)`: è¿”å›æ¥è¿‘å‚æ•°å¹¶ç­‰äºæŸä¸€æ•´æ•°çš„ double å€¼
    - Math.floor(-12.1) è¿”å› - 12;Math.floor(12.9) è¿”å› 13;
  - `random()`: è¿”å› `[0,1)` ä¹‹é—´çš„ double å€¼;

### éšæœºæ•°

è·å¾—éšæœºæ•°çš„ 3 ç§æ–¹æ³•

1. é€šè¿‡ `System.currentTimeMillis()` è·å–å½“å‰æ—¶é—´æ¯«ç§’æ•°çš„ long å‹æ•°å­—ä½œä¸ºéšæœºæ•°
2. ä½¿ç”¨ `Math.random()`
3. é€šè¿‡ `Random` ç±»äº§ç”Ÿä¸€ä¸ªéšæœºæ•°
   - `Random r = new Random()`
     - é»˜è®¤ä½¿ç”¨å½“å‰æ—¶é—´ `System.currentTimeMillis()` ä½œä¸ºç”Ÿæˆå™¨çš„ç§å­, æ¯æ¬¡äº§ç”Ÿçš„éšæœºæ•°éƒ½ä¸åŒ
   - `Random r1 = new Random(10)`
     - ä½¿ç”¨å›ºå®šçš„ç§å­, æ¯æ¬¡ç”Ÿæˆçš„éšæœºæ•°éƒ½ç›¸åŒ

### åŒ…è£…ç±»

ä¸ºäº†è´¯å½»æ‰§è¡Œ **ä¸€åˆ‡çš†æ˜¯å¯¹è±¡** çš„æŒ‡å¯¼æ–¹é’ˆ, å¯¹äºä¸æ˜¯å¯¹è±¡çš„ 8 ç§åŸºæœ¬ç±»å‹, æˆ‘ä»¬ä¹Ÿè¦æƒ³åŠæ³•ç»™ä»–ä»¬æ‰¾å¯¹è±¡, æ‰€ä»¥åŒ…è£…ç±»è¿™ä¸ªåª’å©†å°±å‡ºç°äº†.

| åŸºæœ¬æ•°æ®ç±»å‹ |    åŒ…è£…ç±» |
| :----------- | --------: |
| boolean      |   Boolean |
| byte         |      Byte |
| char         | Character |
| short        |     Short |
| int          |   Integer |
| long         |      Long |
| float        |     Float |
| double       |    Double |

å€¼å¾—æ³¨æ„çš„æ˜¯:

- æ‰€æœ‰åŒ…è£…ç±»éƒ½æ˜¯ final ç±»å‹, ä¸èƒ½åˆ›å»ºå­ç±»;
- åŒ…è£…ç±»æ˜¯ä¸å¯å˜çš„, ä¸€æ—¦åˆ›å»ºäº†ä¸€ä¸ªåŒ…è£…ç±»å¯¹è±¡, é‚£ä¹ˆå®ƒåŒ…å«çš„åŸºæœ¬ç±»å‹æ•°æ®å°±ä¸èƒ½æ”¹å˜

#### åŸºæœ¬æ•°æ®ç±»å‹, åŒ…è£…ç±»å’Œ String ç±»ä¹‹é—´çš„è½¬æ¢

**åŸºæœ¬ è½¬ åŒ…è£…**

1. è‡ªåŠ¨è£…ç®±;  
   `Integer in = 10;`
2. è°ƒç”¨åŒ…è£…ç±»çš„å¸¦å‚æ„é€ æ–¹æ³•;  
   `Integer in = new Integer(10);`
3. è°ƒç”¨åŒ…è£…å†…çš„é™æ€æ–¹æ³• valueOf(int i)  
   `int a = Integer.valueOf(10);`

**åŒ…è£… è½¬ åŸºæœ¬**

1. è‡ªåŠ¨æ‹†åŒ…;  
   `Integer in = 10;`  
   `int a = in;`
2. è°ƒç”¨åŒ…è£…ç±»å¯¹è±¡çš„ xxxValue() æ–¹æ³•;  
   `Integer in = 10;`  
   `int a = in.intValue();`

**åŸºæœ¬ç±»å‹ è½¬ String**

```java
int a = 10;
String str = "" ;
```

1. ç”¨ â€œ+â€;  
   `str = str + a;`
2. ç”¨åŒ…è£…ç±»çš„å·¥å…·ç±»è½¬æ¢æˆå¯¹è±¡, ç„¶åç”¨å¯¹åº”åŒ…è£…ç±»çš„ toString(å˜é‡) è½¬;  
   `new Integer(a).toString();`  
   æˆ–è€…  
   `Integer.toString(a);`

**String è½¬ åŸºæœ¬ç±»å‹**

```java
String s = "12345";
int a = Integer.parseInt(s);
```

**String è½¬ åŒ…è£…ç±»**

1. è°ƒç”¨åŒ…è£…ç±»çš„å¸¦å‚æ„é€ 

```java
String str = "200";
Integer in  = new Integer(str);
```

2. è°ƒç”¨åŒ…è£…ç±»çš„ valueOf() æ–¹æ³•  
   `Integer in = Integer.valueOf(str);`

**åŒ…è£…ç±» è½¬ String**

```java
Integer in = new Integer(10);
String s = "";
```

`s = in.toString();`

## [ä¸å¯å˜ä¸å¯å˜ï¼Œè§£æJavaä¸‰ç§å­—ç¬¦ä¸²ç±»å·®å¼‚](https://blog.dong4j.site/posts/58a301ae.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

å­—ç¬¦ä¸²æ“ä½œåœ¨ç¼–ç¨‹ä¸­æˆ‘ä»¬ä¼šå¤§é‡ä½¿ç”¨, æ‰€ä»¥æŒæ¡å­—ç¬¦ä¸²ç›¸å…³ç±»å¯¹æˆ‘ä»¬æ¥è¯´å¾ˆé‡è¦.  
Java ä¸ºæˆ‘ä»¬æä¾›äº† 3 ç§æ“ä½œå­—ç¬¦ä¸²çš„ç±». ç”±äº `String` ç±»çš„ç‰¹æ®Š, æœ‰å¿…è¦äº†è§£ä¸€ä¸‹ Java è¿è¡Œæ—¶å†…å­˜çš„æ¦‚å¿µ, æ‰èƒ½æ›´å¥½çš„ç†è§£å­—ç¬¦ä¸²ç›¸å…³ç±»çš„åº•å±‚æ“ä½œ.

### Java ä¸­å†…å­˜çŸ¥è¯†

åœ¨åå°„ä¸­æˆ‘ä»¬å­¦åˆ°, å¯¹äºæ¯ä¸€ä¸ªè¢« JVM åŠ è½½åˆ°å†…å­˜ä¸­çš„ç±», éƒ½ä¼šåœ¨æ–¹æ³•åŒºä¿å­˜ä¸€ä»½è¿™ä¸ªç±»çš„ä¿¡æ¯;  
åŒ…æ‹¬:

- ç±»çš„åŸºæœ¬ä¿¡æ¯
  - ç±»çš„å…¨å, ç›´æ¥çˆ¶ç±»çš„å…¨æ°‘
  - è¯¥ç±»çš„æ¥å£
  - è¯¥ç±»çš„è®¿é—®ä¿®é¥°ç¬¦
- ç±»çš„è¯¦ç»†ä¿¡æ¯
  - è¿è¡Œæ—¶å¸¸é‡æ±  â€“> å­—ç¬¦ä¸², å¸¸é‡, ç±»åå’Œæ–¹æ³•åå¸¸é‡.
  - å­—æ®µä¿¡æ¯ â€“> å­—æ®µå, ç±»å‹, ä¿®é¥°ç¬¦
  - æ–¹æ³•ä¿¡æ¯ â€“> æ–¹æ³•å, è¿”å›å€¼ç±»å‹, å‚æ•°ç±»å‹, ä¿®é¥°ç¬¦, å¼‚å¸¸, æ–¹æ³•çš„å­—èŠ‚ç 
  - é™æ€å˜é‡ â€“> åœ¨æ–¹æ³•åŒºä¸­çš„é™æ€åŒºä¿å­˜è¢«ç±»çš„æ‰€æœ‰å®ä¾‹å…±äº«çš„å˜é‡å’Œé™æ€å¿«
  - åˆ°ç±» classloader çš„å¼•ç”¨
  - åˆ°ç±» class çš„å¼•ç”¨ JVM ä¸ºæ¯ä¸€ä¸ªè¢«åŠ è½½åˆ°å†…å­˜çš„ç±»å‹åˆ›å»ºä¸€ä¸ª class å®ä¾‹, ç”¨å®ä¾‹ä»£è¡¨è¿™ä¸ªè¢«åŠ è½½çš„ç±»

ç”±æ­¤å¼•å‡ºåå°„çš„æ¦‚å¿µ:  
åœ¨åŠ è½½ç±»çš„æ—¶å€™, åŠ å…¥æ–¹æ³•åŒºçš„æ‰€æœ‰ä¿¡æ¯, æœ€åéƒ½ä¼šå½±åŸ Class ç±»çš„å®ä¾‹, ä»£è¡¨è¿™ä¸ªè¢«åŠ è½½çš„ç±». æ–¹æ³•å»ä¸­çš„æ‰€æœ‰ä¿¡æ¯, éƒ½æ˜¯å¯ä»¥é€šè¿‡è¿™ä¸ª Class ç±»å¯¹è±¡åå°„å¾—åˆ°.

#### Java è¿è¡Œæ—¶æ•°æ®åŒºçš„åˆ’åˆ†

- ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰
- æœ¬åœ°æ–¹æ³•æ ˆ (Native Method Stacks)
- Java è™šæ‹Ÿæœºæ ˆ (Java Visual Machine Stacks)
  - å±€éƒ¨å˜é‡, å¼•ç”¨åç­‰ä¿å­˜åœ¨æ ˆä¸­
  - ä¸å…±äº«, æ¯ä¸ªçº¿ç¨‹ä¼šæœ‰å±äºè‡ªå·±çš„æ ˆ
- Java å † (Java Heap)
  - è¢« `new` å…³é”®å­—æ‰€åˆ›å»ºå‡ºæ¥çš„æ‰€æœ‰å®ä¾‹å¯¹è±¡
  - è¢«å„ä¸ªçº¿ç¨‹å…±äº«
- æ–¹æ³•åŒº (Method Area)
  - è¢«å„ä¸ªçº¿ç¨‹å…±äº«
  - å­˜å‚¨ç±»ä¿¡æ¯, å¸¸é‡, é™æ€å˜é‡, ä»¥åŠç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®

### String ç±»

#### String ç±»çš„å£°æ˜

`public final class String extends Object implements Serializable, Comparable<String>, CharSequence`  
String ç±»å£°æ˜ä¸­, æ˜¯è¢« final ä¿®é¥°, æ‰€ä»¥å¯ä»¥çœ‹å‡ºå­—ç¬¦ä¸²çš„å†…å®¹æ˜¯ä¸å¯å˜çš„, è€Œä¸”æ˜¯ä¸èƒ½è¢«ç»§æ‰¿çš„ç±»; ä¸€æ—¦ä¸€ä¸ª String å¯¹è±¡è¢«åˆ›å»º, åŒ…å«åœ¨è¿™ä¸ªå¯¹è±¡ä¸­çš„å†…å®¹æ˜¯ä¸å¯æ”¹å˜çš„, ç›´è‡³è¿™ä¸ªå¯¹è±¡è¢«å›æ”¶;  
å…¶å® String ç±»åœ¨åº•å±‚å°±æ˜¯é€šè¿‡å­—ç¬¦æ•°ç»„æ¥å®ç°çš„, å¯¹äºæ•°ç»„, æˆ‘ä»¬çŸ¥é“å®ƒçš„é•¿åº¦ä¸å¯å˜, è‡ªç„¶è€Œç„¶çš„ String ç±»ä¹Ÿä¸å¯å˜äº†.

#### String ç±»åœ¨å†…å­˜ä¸­çš„è¡¨ç°å½¢å¼

1. éšå¼åˆ›å»º  
   `String str1 = "helloworld";`

   - åœ¨æ ˆä¸­å£°æ˜ä¸€ä¸ª str1 çš„å¼•ç”¨, ç„¶ååœ¨**å¸¸é‡åŒº**ä¸­æŸ¥æ‰¾æ˜¯å¦æœ‰â€helloworldâ€ è¿™ä¸ªå¸¸é‡;
     - å¦‚æœæœ‰, åˆ™ç›´æ¥è¿”å›ä¸€ä¸ªå¼•ç”¨ç»™ str1;
     - å¦‚æœæ²¡æœ‰, åˆ™å…ˆåœ¨å¸¸é‡åŒºä¸­åˆ›å»º â€˜helloworldâ€ å­—ç¬¦ä¸², ç„¶åè¿”å›å¼•ç”¨;

2. æ˜¾å¼åˆ›å»º  
   `String str2 = new String("å¼ ä¸‰");`

   - åœ¨æ ˆä¸­å£°æ˜ä¸€ä¸ª str2 çš„å¼•ç”¨, ç„¶ååœ¨**å †**ä¸­åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡, é‡Œé¢çš„å€¼æ˜¯â€ å¼ ä¸‰â€;
   - è¿”å›è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨;

ç„¶åæˆ‘ä»¬å¯ä»¥é€šè¿‡ å¯¹è±¡è°ƒç”¨ String ç±»çš„æ–¹æ³•, ä½†æ˜¯é—®é¢˜æ¥äº†, `"helloworld".toCharArray()` è¿™å¥ä»£ç ä¸ä¼šæŠ¥é”™, è¯´æ˜ `"helloworld"` å¯ä»¥å½“ä¸€ä¸ªå¯¹è±¡æ¥ä½¿ç”¨, é‚£ä¹ˆå †ä¸­çš„ `"helloworld"` å’Œå¸¸é‡æ± ä¸­çš„ `"helloworld"` æ˜¯ä»€ä¹ˆå…³ç³»å‘¢?  
é‚£å°±è®©æˆ‘ä»¬æ¥è¯´è¯´ä»–ä»¬ 2 ä¸ªä¹‹é—´ä¸å¾—ä¸è¯´çš„æ•…äº‹.

```java
1. String str1 = "helloworld";//helloworldåœ¨å¸¸é‡åŒºä¸­
2. String str2 = new String("helloworld");//å¯¹è±¡åœ¨å †ä¸­
```

![20241229154732_ZOosCdOB.webp](https://cdn.dong4j.site/source/image/20241229154732_ZOosCdOB.webp)

å¯¹äºä¸Šé¢ 2 è¡Œä»£ç , ä¼šåœ¨ä¸åŒçš„åŒºåŸŸåˆ›å»º 2 ä¸ªå¯¹è±¡.

- æ‰§è¡Œç¬¬ä¸€è¡Œæ—¶,
  - åœ¨æ ˆä¸­å£°æ˜ä¸€ä¸ª str1 çš„å¼•ç”¨, ç„¶ååœ¨**å¸¸é‡åŒº**ä¸­æŸ¥æ‰¾æ˜¯å¦æœ‰â€helloworldâ€ è¿™ä¸ªå¸¸é‡;
    - å¦‚æœæœ‰, åˆ™ç›´æ¥è¿”å›ä¸€ä¸ªå¼•ç”¨ç»™ str1;
    - å¦‚æœæ²¡æœ‰, åˆ™å…ˆåœ¨å¸¸é‡åŒºä¸­åˆ›å»º â€˜helloworldâ€ å­—ç¬¦ä¸², ç„¶åè¿”å›å¼•ç”¨;
- æ‰§è¡Œç¬¬äºŒè¡Œæ—¶, ä¼šåœ¨å †ä¸­åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡, è¿™ä¸ªå¯¹è±¡çš„å€¼ä¸º `"helloworld"`, ç„¶åå†å»å¸¸é‡åŒºå‚çœ‹æ˜¯å¦æœ‰ `"helloworld"` è¿™ä¸ªå¸¸é‡å­—ç¬¦ä¸²;
  - å¦‚æœæ²¡æœ‰, å°±åœ¨å¸¸é‡åŒºåˆ›å»ºä¸€ä¸ª `"helloworld"` å­—ç¬¦ä¸²å¸¸é‡, ç„¶åä¸è¿™ä¸ªå¯¹è±¡å…³è”;
  - å¦‚æœæœ‰, åˆ™æŠŠå¸¸é‡åŒºçš„ `"helloworld"` å¼•ç”¨åŒå †ä¸­å¯¹è±¡å…³è”èµ·æ¥;

æ— è®ºå¦‚ä½•, åªè¦ç”¨ new å…³é”®å­—å®ä¾‹åŒ–ä¸€ä¸ªä¸ªå­—ç¬¦ä¸²å¯¹è±¡, éƒ½ä¼šåœ¨å †ä¸­åˆ›å»ºå®ä¾‹, è€Œéšå¼åˆ›å»ºçš„è¯åˆ™ä¸ä¸€å®šæ–°å»ºä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡;

é‚£ä¹ˆé—®é¢˜æ¥äº†  
`String str2 = new String("helloworld");` ä¼šåœ¨å†…å­˜ä¸­åˆ›å»ºå‡ ä¸ªå¯¹è±¡, å‡ ä¸ªå¼•ç”¨?  
ç­”æ¡ˆæ˜¯ 3 ä¸ªå¯¹è±¡, 2 ä¸ªå¼•ç”¨;

- å¯¹è±¡
  - String è¿™ä¸ªç±»çš„å¯¹è±¡ (åå°„æœºåˆ¶)
  - String å®ä¾‹åŒ–å¯¹è±¡ (å †ä¸­)
  - å¸¸é‡åŒºä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡
- å¼•ç”¨
  - å †ä¸­å­—ç¬¦ä¸²å¯¹è±¡çš„å¼•ç”¨
  - å¸¸é‡åŒºä¸­å­—ç¬¦ä¸²çš„å¼•ç”¨

æˆ‘ä»¬å¯ä»¥é€šè¿‡ String ç±»çš„ intern() æ–¹æ³•æ¥å®éªŒä¸€ä¸‹  
å½“è°ƒç”¨ intern æ–¹æ³•æ—¶ï¼Œå¦‚æœå¸¸é‡æ± ä¸­å·²ç»åŒ…å«ä¸€ä¸ªç­‰äºæ­¤ String å¯¹è±¡çš„å­—ç¬¦ä¸²ï¼ˆç”¨ equals(Object) æ–¹æ³•ç¡®å®šï¼‰ï¼Œåˆ™è¿”å›æ± ä¸­çš„å­—ç¬¦ä¸²ã€‚å¦åˆ™ï¼Œå°†æ­¤ String å¯¹è±¡æ·»åŠ åˆ°æ± ä¸­ï¼Œå¹¶è¿”å›æ­¤ String å¯¹è±¡çš„å¼•ç”¨

```java
public static void main (String[] args) {
    String s1 = "osEye.net";
    String s2 = new String ("osEye.net");
    if (s1 == s2) {
        System.out.println ("å­—ç¬¦ä¸²å¼•ç”¨s1å’Œå­—ç¬¦ä¸²å¼•ç”¨s2æ‰€æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡");
    } else {
        System.out.println ("å­—ç¬¦ä¸²å¼•ç”¨s1å’Œå­—ç¬¦ä¸²å¼•ç”¨s2æ‰€æŒ‡å‘çš„ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡");
        if (s1.intern() == s2.intern() ) {
            System.out.println ("å­—ç¬¦ä¸²å¼•ç”¨s1å’Œå­—ç¬¦ä¸²å¼•ç”¨s2åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­è”ç³»çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡");
        } else {
            System.out.println ("å­—ç¬¦ä¸²å¼•ç”¨s1å’Œå­—ç¬¦ä¸²å¼•ç”¨s2åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­è”ç³»çš„ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡");
        }
    }
}
```

> è¾“å‡º  
> å­—ç¬¦ä¸²å¼•ç”¨ s1 å’Œå­—ç¬¦ä¸²å¼•ç”¨ s2 æ‰€æŒ‡å‘çš„ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡  
> å­—ç¬¦ä¸²å¼•ç”¨ s1 å’Œå­—ç¬¦ä¸²å¼•ç”¨ s2 åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­è”ç³»çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡

è¿™ç§æœºåˆ¶å¾ˆå¥½çš„å®ç°äº†å…±äº«å’ŒèŠ‚çœå†…å­˜ç©ºé—´, å½“æˆ‘éœ€è¦ä½¿ç”¨å­—ç¬¦ä¸²æ—¶, å¦‚æœå†…å­˜ä¸­æœ‰è¿™ä¸ªå­—ç¬¦ä¸²äº†, å°±ä¸ä¼šå†åˆ›å»º, è€Œæ˜¯ç›´æ¥è¿”å›å·²å­˜åœ¨çš„å­—ç¬¦ä¸²çš„å¼•ç”¨.

å¯¹äº  
`String s = "hello" + "world"` çš„åˆ†æ  
åœ¨ JDK1.5 ä¹‹å‰, è¿™æ¡è¯­å¥ä¼šç”Ÿæˆ 2 ä¸ªå­—ç¬¦ä¸²å¸¸é‡,  
ä½†æ˜¯åœ¨ JDK1.5 ä¹‹å, ç¼–è¯‘å™¨å¯¹æ­¤åšå‡ºäº†ä¼˜åŒ–, æœ€ç»ˆåªæœ‰ä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡â€helloworldâ€ å­˜å…¥å¸¸é‡åŒºä¸­.  
è¿™ç§ä¼˜åŒ–å°±æ˜¯é»˜è®¤çš„è°ƒç”¨äº† StringBuilder.append() æ–¹æ³•;

#### String ç±»çš„ä½¿ç”¨

ä»‹ç»å‡ ä¸ªå¸¸ç”¨çš„å­—ç¬¦ä¸²æ“ä½œçš„æ–¹æ³•

- `charAt(int index)` è¿”å›æŒ‡å®šç´¢å¼•å¤„çš„ char å€¼ã€‚
- `equals(Object anObject)` å°†æ­¤å­—ç¬¦ä¸²ä¸æŒ‡å®šçš„å¯¹è±¡æ¯”è¾ƒã€‚
- `equalsIgnoreCase(String anotherString)` å°†æ­¤ String ä¸å¦ä¸€ä¸ª String æ¯”è¾ƒï¼Œä¸è€ƒè™‘å¤§å°å†™
- `indexOf(int ch)` è¿”å›æŒ‡å®šå­—ç¬¦åœ¨æ­¤å­—ç¬¦ä¸²ä¸­ç¬¬ä¸€æ¬¡å‡ºç°å¤„çš„ç´¢å¼•ã€‚
- `length()` è¿”å›æ­¤å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚
- `matches(String regex)` å‘ŠçŸ¥æ­¤å­—ç¬¦ä¸²æ˜¯å¦åŒ¹é…ç»™å®šçš„æ­£åˆ™è¡¨è¾¾å¼ã€‚
- `replace(char oldChar, char newChar)` è¿”å›ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ï¼Œå®ƒæ˜¯é€šè¿‡ç”¨ newChar æ›¿æ¢æ­¤å­—ç¬¦ä¸²ä¸­å‡ºç°çš„æ‰€æœ‰ oldChar å¾—åˆ°çš„ã€‚
- `split(String regex)` æ ¹æ®ç»™å®šæ­£åˆ™è¡¨è¾¾å¼çš„åŒ¹é…æ‹†åˆ†æ­¤å­—ç¬¦ä¸²ã€‚
- `substring(int beginIndex)` è¿”å›ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ï¼Œå®ƒæ˜¯æ­¤å­—ç¬¦ä¸²çš„ä¸€ä¸ªå­å­—ç¬¦ä¸²ã€‚
- `trim()` è¿”å›å­—ç¬¦ä¸²çš„å‰¯æœ¬ï¼Œå¿½ç•¥å‰å¯¼ç©ºç™½å’Œå°¾éƒ¨ç©ºç™½ã€‚
- `toCharArray()` å°†æ­¤å­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸€ä¸ªæ–°çš„å­—ç¬¦æ•°ç»„ã€‚

åˆ¤æ–­æ˜¯å¦ä¸ºç©ºå­—ç¬¦ä¸²

`s != null && s != â€œâ€;  `

**æ³¨æ„**åˆ¤æ–­ä¸èƒ½ä¸ºç©ºå¿…é¡»æ”¾åœ¨å‰é¢, å› ä¸ºå¯èƒ½ä¼šæŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸

### StringBuffer ç±»

- ä¸ºäº†èƒ½è®© String é‡Œé¢çš„å†…å®¹èƒ½å¤Ÿæ”¹å˜, æ‰€ä»¥ç”¨ StringBuffer ç±»å°è£…äº† String ç±»;
- ä½¿ç”¨ append() æ–¹æ³•å‘å­—ç¬¦ä¸²æœ«å°¾æ·»åŠ å­—ç¬¦ä¸²,
- çº¿ç¨‹å®‰å…¨çš„, æ•ˆç‡æ¯” String é«˜
- ç»å¸¸ä½¿ç”¨åœ¨å­—ç¬¦ä¸²æ‹¼æ¥çš„åœ°æ–¹, æ¯”å¦‚è¯´æ•°æ®åº“è¯­å¥

### StringBuilder ç±»

#### ä¸ StringBuffer ç±»çš„å¯¹æ¯”

```java
//StringBuilderç±»çš„append()æ–¹æ³•
public synchronized StringBuffer append(String str){
    super.append(str);
    return this;
}

//StringBufferç±»çš„append()æ–¹æ³•
public StringBuffer append(String str){
    super.append(str);
    return this;
}
```

StringBuffer æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„, æ•ˆç‡æ¯” StringBuffer é«˜, åœ¨ä¸è€ƒè™‘çº¿ç¨‹å®‰å…¨çš„æ—¶å€™ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨ StringBuffer.

### 3 ç§å­—ç¬¦ä¸²å¯¹æ¯”

- å¼‚åŒç‚¹
  - éƒ½æ˜¯ `final` ç±», éƒ½ä¸å…è®¸è¢«ç»§æ‰¿;
  - `String` é•¿åº¦ä¸å¯æ”¹å˜, å…¶ä»– 2 ç§é•¿åº¦å¯å˜;
  - `StringBuffer` æ˜¯çº¿ç¨‹å®‰å…¨çš„, ä½†æ˜¯æ•ˆç‡ä½, `StringBuilder` çº¿ç¨‹ä¸å®‰å…¨ä½†æ˜¯æ•ˆç‡é«˜
  - æ€§èƒ½: `StringBuilder > StringBuffer > String`
- ä½¿ç”¨ç­–ç•¥
  - åŸºæœ¬åŸåˆ™:
    - å¦‚æœæ“ä½œå°‘é‡çš„æ•°æ®, ç”¨ `String` ;
    - å•çº¿ç¨‹æ“ä½œå¤§é‡æ•°æ®, ä½¿ç”¨ `StringBuilder` ;
    - å¤šçº¿ç¨‹æ“ä½œå¤§é‡æ•°æ®, ä½¿ç”¨ `StringBuffer` ;
  - ä¸å»ºè®®ä½¿ç”¨ `String` ç±»çš„ â€œ+â€ è¿›è¡Œé¢‘ç¹çš„å­—ç¬¦ä¸²æ‹¼æ¥, è€Œæ˜¯ä½¿ç”¨ `StringBuilder` æˆ–è€… `StringBuffer` ç±»;
  - `StringBuilder` ä¸€èˆ¬ä½¿ç”¨åœ¨æ–¹æ³•å†…éƒ¨æ¥å®Œæˆç±»ä¼¼â€+â€ åŠŸèƒ½, å› ä¸ºçº¿ç¨‹ä¸å®‰å…¨, ç”¨å®Œåä¸¢å¼ƒ;
  - `StringBuffer` ä¸»è¦ç”¨åœ¨å…¨å±€å˜é‡ä¸­;
  - ç›¸åŒæƒ…å†µä¸‹ä½¿ç”¨ `StirngBuilder` ç›¸æ¯”ä½¿ç”¨ `StringBuffer` ä»…èƒ½è·å¾— 10%~15% å·¦å³çš„æ€§èƒ½æå‡ï¼Œä½†å´è¦å†’å¤šçº¿ç¨‹ä¸å®‰å…¨çš„é£é™©ã€‚è€Œåœ¨ç°å®çš„æ¨¡å—åŒ–ç¼–ç¨‹ä¸­ï¼Œè´Ÿè´£æŸä¸€æ¨¡å—çš„ç¨‹åºå‘˜ä¸ä¸€å®šèƒ½æ¸…æ™°åœ°åˆ¤æ–­è¯¥æ¨¡å—æ˜¯å¦ä¼šæ”¾å…¥å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸­è¿è¡Œï¼Œå› æ­¤ï¼šé™¤éç¡®å®šç³»ç»Ÿçš„ç“¶é¢ˆæ˜¯åœ¨ `StringBuffer` ä¸Šï¼Œå¹¶ä¸”ç¡®å®šä½ çš„æ¨¡å—ä¸ä¼šè¿è¡Œåœ¨å¤šçº¿ç¨‹æ¨¡å¼ä¸‹ï¼Œæ‰å¯ä»¥é‡‡ç”¨ `StringBuilder` ï¼›å¦åˆ™è¿˜æ˜¯ç”¨ `StringBuffer` ã€‚

## [Javaå¼‚å¸¸å¤„ç†å…¨è§£æï¼šæŒæ¡try-catch-finallyï¼Œå¼€å¯æ›´å®‰å…¨çš„ç¼–ç¨‹ä¹‹æ—…](https://blog.dong4j.site/posts/28877bf.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

### æ¦‚è¿°

- Java å¼‚å¸¸æ˜¯ Java æä¾›çš„ä¸€ç§è¯†åˆ«åŠå“åº”é”™è¯¯çš„ä¸€è‡´æ€§æœºåˆ¶ã€‚
- Java å¼‚å¸¸æœºåˆ¶å¯ä»¥ä½¿ç¨‹åºä¸­å¼‚å¸¸å¤„ç†ä»£ç å’Œæ­£å¸¸ä¸šåŠ¡ä»£ç åˆ†ç¦»ï¼Œä¿è¯ç¨‹åºä»£ç æ›´åŠ ä¼˜é›…ï¼Œå¹¶æé«˜ç¨‹åºå¥å£®æ€§ã€‚
- åœ¨æœ‰æ•ˆä½¿ç”¨å¼‚å¸¸çš„æƒ…å†µä¸‹ï¼Œå¼‚å¸¸èƒ½æ¸…æ™°çš„å›ç­” what, where, why è¿™ 3 ä¸ªé—®é¢˜ï¼š
  - **å¼‚å¸¸ç±»å‹** â€“>â€ ä»€ä¹ˆâ€ è¢«æŠ›å‡º;
  - **å¼‚å¸¸å †æ ˆè·Ÿè¸ª** â€“>â€ åœ¨å“ªâ€ æŠ›å‡º;
  - **å¼‚å¸¸ä¿¡æ¯** â€“>â€ ä¸ºä»€ä¹ˆâ€ ä¼šæŠ›å‡º;

### Throwable ç±»

![20241229154732_Fgnc2ygU.webp](https://cdn.dong4j.site/source/image/20241229154732_Fgnc2ygU.webp)

Throwable æ˜¯ Java è¯­è¨€ä¸­æ‰€æœ‰é”™è¯¯æˆ–å¼‚å¸¸çš„è¶…ç±»ã€‚  
Throwable åŒ…å«ä¸¤ä¸ªå­ç±»: Error å’Œ Exceptionã€‚å®ƒä»¬é€šå¸¸ç”¨äºæŒ‡ç¤ºå‘ç”Ÿäº†å¼‚å¸¸æƒ…å†µã€‚  
Throwable åŒ…å«äº†å…¶çº¿ç¨‹åˆ›å»ºæ—¶çº¿ç¨‹æ‰§è¡Œå †æ ˆçš„å¿«ç…§ï¼Œå®ƒæä¾›äº† printStackTrace() ç­‰æ¥å£ç”¨äºè·å–å †æ ˆè·Ÿè¸ªæ•°æ®ç­‰ä¿¡æ¯ã€‚

#### Exception

Exception åŠå…¶å­ç±»æ˜¯ Throwable çš„ä¸€ç§å½¢å¼ï¼Œå®ƒæŒ‡å‡ºäº†åˆç†çš„åº”ç”¨ç¨‹åºæƒ³è¦æ•è·çš„æ¡ä»¶ã€‚

#### RuntimeException

RuntimeException æ˜¯é‚£äº›å¯èƒ½åœ¨ Java è™šæ‹Ÿæœºæ­£å¸¸è¿è¡ŒæœŸé—´æŠ›å‡ºçš„å¼‚å¸¸çš„è¶…ç±»ã€‚  
ç¼–è¯‘å™¨ä¸ä¼šæ£€æŸ¥ RuntimeException å¼‚å¸¸ã€‚ä¾‹å¦‚ï¼Œé™¤æ•°ä¸ºé›¶æ—¶ï¼ŒæŠ›å‡º ArithmeticException å¼‚å¸¸ã€‚RuntimeException æ˜¯ ArithmeticException çš„è¶…ç±»ã€‚å½“ä»£ç å‘ç”Ÿé™¤æ•°ä¸ºé›¶çš„æƒ…å†µæ—¶ï¼Œå€˜è‹¥æ—¢â€ æ²¡æœ‰é€šè¿‡ throws å£°æ˜æŠ›å‡º ArithmeticException å¼‚å¸¸â€ï¼Œä¹Ÿâ€ æ²¡æœ‰é€šè¿‡ tryâ€¦catchâ€¦ å¤„ç†è¯¥å¼‚å¸¸â€ï¼Œä¹Ÿèƒ½é€šè¿‡ç¼–è¯‘ã€‚è¿™å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„â€ ç¼–è¯‘å™¨ä¸ä¼šæ£€æŸ¥ RuntimeException å¼‚å¸¸â€ï¼  
å¦‚æœä»£ç ä¼šäº§ç”Ÿ RuntimeException å¼‚å¸¸ï¼Œåˆ™éœ€è¦é€šè¿‡ä¿®æ”¹ä»£ç è¿›è¡Œé¿å…ã€‚ä¾‹å¦‚ï¼Œè‹¥ä¼šå‘ç”Ÿé™¤æ•°ä¸ºé›¶çš„æƒ…å†µï¼Œåˆ™éœ€è¦é€šè¿‡ä»£ç é¿å…è¯¥æƒ…å†µçš„å‘ç”Ÿï¼

#### Error

å’Œ Exception ä¸€æ ·ï¼ŒError ä¹Ÿæ˜¯ Throwable çš„å­ç±»ã€‚å®ƒç”¨äºæŒ‡ç¤ºåˆç†çš„åº”ç”¨ç¨‹åºä¸åº”è¯¥è¯•å›¾æ•è·çš„ä¸¥é‡é—®é¢˜ï¼Œå¤§å¤šæ•°è¿™æ ·çš„é”™è¯¯éƒ½æ˜¯å¼‚å¸¸æ¡ä»¶ã€‚  
å’Œ RuntimeException ä¸€æ ·ï¼Œç¼–è¯‘å™¨ä¹Ÿä¸ä¼šæ£€æŸ¥ Errorã€‚

### å¼‚å¸¸åˆ†ç±» (Exception):

Java å°†å¯æŠ›å‡º (Throwable) çš„ç»“æ„åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼š

1. è¢«æ£€æŸ¥çš„å¼‚å¸¸ (CheckedException)
2. è¿è¡Œæ—¶å¼‚å¸¸ (RuntimeException)
3. é”™è¯¯ (Error)

#### **è¿è¡Œæ—¶å¼‚å¸¸**

- å®šä¹‰:  
   RuntimeException åŠå…¶å­ç±»éƒ½è¢«ç§°ä¸ºè¿è¡Œæ—¶å¼‚å¸¸ã€‚

- ç‰¹ç‚¹:  
   Java ç¼–è¯‘å™¨ä¸ä¼šæ£€æŸ¥å®ƒã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ç¨‹åºä¸­å¯èƒ½å‡ºç°è¿™ç±»å¼‚å¸¸æ—¶ï¼Œå€˜è‹¥æ—¢â€ æ²¡æœ‰é€šè¿‡ throws å£°æ˜æŠ›å‡ºå®ƒâ€ï¼Œä¹Ÿâ€ æ²¡æœ‰ç”¨ try-catch è¯­å¥æ•è·å®ƒâ€ï¼Œè¿˜æ˜¯ä¼šç¼–è¯‘é€šè¿‡ã€‚ä¾‹å¦‚ï¼Œé™¤æ•°ä¸ºé›¶æ—¶äº§ç”Ÿçš„ ArithmeticException å¼‚å¸¸ï¼Œæ•°ç»„è¶Šç•Œæ—¶äº§ç”Ÿçš„ IndexOutOfBoundsException å¼‚å¸¸ï¼Œfail-fail æœºåˆ¶äº§ç”Ÿçš„ ConcurrentModificationException å¼‚å¸¸ç­‰ï¼Œéƒ½å±äºè¿è¡Œæ—¶å¼‚å¸¸ã€‚  
   è™½ç„¶ Java ç¼–è¯‘å™¨ä¸ä¼šæ£€æŸ¥è¿è¡Œæ—¶å¼‚å¸¸ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ throws è¿›è¡Œå£°æ˜æŠ›å‡ºï¼Œä¹Ÿå¯ä»¥é€šè¿‡ try-catch å¯¹å®ƒè¿›è¡Œæ•è·å¤„ç†ã€‚  
   å¦‚æœäº§ç”Ÿè¿è¡Œæ—¶å¼‚å¸¸ï¼Œåˆ™éœ€è¦é€šè¿‡ä¿®æ”¹ä»£ç æ¥è¿›è¡Œé¿å…ã€‚ä¾‹å¦‚ï¼Œè‹¥ä¼šå‘ç”Ÿé™¤æ•°ä¸ºé›¶çš„æƒ…å†µï¼Œåˆ™éœ€è¦é€šè¿‡ä»£ç é¿å…è¯¥æƒ…å†µçš„å‘ç”Ÿï¼

#### **è¢«æ£€æŸ¥çš„å¼‚å¸¸** (ç¼–è¯‘æœŸå¼‚å¸¸)

- å®šä¹‰:  
   Exception ç±»æœ¬èº«ï¼Œä»¥åŠ Exception çš„å­ç±»ä¸­é™¤äº†â€ è¿è¡Œæ—¶å¼‚å¸¸â€ ä¹‹å¤–çš„å…¶å®ƒå­ç±»éƒ½å±äºè¢«æ£€æŸ¥å¼‚å¸¸ã€‚

- ç‰¹ç‚¹:  
   Java ç¼–è¯‘å™¨ä¼šæ£€æŸ¥å®ƒã€‚æ­¤ç±»å¼‚å¸¸ï¼Œè¦ä¹ˆé€šè¿‡ throws è¿›è¡Œå£°æ˜æŠ›å‡ºï¼Œè¦ä¹ˆé€šè¿‡ try-catch è¿›è¡Œæ•è·å¤„ç†ï¼Œå¦åˆ™ä¸èƒ½é€šè¿‡ç¼–è¯‘ã€‚ä¾‹å¦‚ï¼ŒCloneNotSupportedException å°±å±äºè¢«æ£€æŸ¥å¼‚å¸¸ã€‚å½“é€šè¿‡ clone() æ¥å£å»å…‹éš†ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œè¯¥å¯¹è±¡å¯¹åº”çš„ç±»æ²¡æœ‰å®ç° Cloneable æ¥å£ï¼Œå°±ä¼šæŠ›å‡º CloneNotSupportedException å¼‚å¸¸ã€‚  
   è¢«æ£€æŸ¥å¼‚å¸¸é€šå¸¸éƒ½æ˜¯å¯ä»¥æ¢å¤çš„ã€‚

#### **é”™è¯¯**

- å®šä¹‰:  
   Error ç±»åŠå…¶å­ç±»ã€‚

- ç‰¹ç‚¹:  
   å’Œè¿è¡Œæ—¶å¼‚å¸¸ä¸€æ ·ï¼Œç¼–è¯‘å™¨ä¹Ÿä¸ä¼šå¯¹é”™è¯¯è¿›è¡Œæ£€æŸ¥ã€‚  
   å½“èµ„æºä¸è¶³ã€çº¦æŸå¤±è´¥ã€æˆ–æ˜¯å…¶å®ƒç¨‹åºæ— æ³•ç»§ç»­è¿è¡Œçš„æ¡ä»¶å‘ç”Ÿæ—¶ï¼Œå°±äº§ç”Ÿé”™è¯¯ã€‚ç¨‹åºæœ¬èº«æ— æ³•ä¿®å¤è¿™äº›é”™è¯¯çš„ã€‚ä¾‹å¦‚ï¼ŒVirtualMachineError å°±å±äºé”™è¯¯ã€‚  
   æŒ‰ç…§ Java æƒ¯ä¾‹ï¼Œæˆ‘ä»¬æ˜¯ä¸åº”è¯¥å®ç°ä»»ä½•æ–°çš„ Error å­ç±»çš„ï¼  
   å¯¹äºä¸Šé¢çš„ 3 ç§ç»“æ„ï¼Œæˆ‘ä»¬åœ¨æŠ›å‡ºå¼‚å¸¸æˆ–é”™è¯¯æ—¶ï¼Œåˆ°åº•è¯¥å“ªä¸€ç§ï¼Ÿã€ŠEffective Javaã€‹ä¸­ç»™å‡ºçš„å»ºè®®æ˜¯ï¼š

  > **å¯¹äºå¯ä»¥æ¢å¤çš„æ¡ä»¶ä½¿ç”¨è¢«æ£€æŸ¥å¼‚å¸¸ï¼Œå¯¹äºç¨‹åºé”™è¯¯ä½¿ç”¨è¿è¡Œæ—¶å¼‚å¸¸**ã€‚

### å¼‚å¸¸å¤„ç†å…³é”®å­—

- **try** â€“> ç”¨äºç›‘å¬ã€‚å°†è¦è¢«ç›‘å¬çš„ä»£ç  (å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„ä»£ç ) æ”¾åœ¨ try è¯­å¥å—ä¹‹å†…ï¼Œå½“ try è¯­å¥å—å†…å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œå¼‚å¸¸å°±è¢«æŠ›å‡ºã€‚
- **catch** â€“> ç”¨äºæ•è·å¼‚å¸¸ã€‚catch ç”¨æ¥æ•è· try è¯­å¥å—ä¸­å‘ç”Ÿçš„å¼‚å¸¸ã€‚
- **finally** â€“> finally è¯­å¥å—æ€»æ˜¯ä¼šè¢«æ‰§è¡Œã€‚å®ƒä¸»è¦ç”¨äºå›æ”¶åœ¨ try å—é‡Œæ‰“å¼€çš„ç‰©åŠ›èµ„æº (å¦‚æ•°æ®åº“è¿æ¥ã€ç½‘ç»œè¿æ¥å’Œç£ç›˜æ–‡ä»¶)ã€‚åªæœ‰ finally å—ï¼Œæ‰§è¡Œå®Œæˆä¹‹åï¼Œæ‰ä¼šå›æ¥æ‰§è¡Œ try æˆ–è€… catch å—ä¸­çš„ return æˆ–è€… throw è¯­å¥ï¼Œå¦‚æœ finally ä¸­ä½¿ç”¨äº† return æˆ–è€… throw ç­‰ç»ˆæ­¢æ–¹æ³•çš„è¯­å¥ï¼Œåˆ™å°±ä¸ä¼šè·³å›æ‰§è¡Œï¼Œç›´æ¥åœæ­¢ã€‚

  > finalize() æ˜¯ Object ç±»çš„ä¸€ä¸ªæ–¹æ³•, ç”¨æ¥å›æ”¶æ²¡æœ‰è¢«å¼•ç”¨çš„å¯¹è±¡, è¢« GC è°ƒç”¨;

- **throw** â€“> ç”¨äºæŠ›å‡ºå¼‚å¸¸ã€‚
- **throws** â€“> ç”¨åœ¨æ–¹æ³•ç­¾åä¸­ï¼Œç”¨äºå£°æ˜è¯¥æ–¹æ³•å¯èƒ½æŠ›å‡ºçš„å¼‚å¸¸ã€‚

### å¼‚å¸¸çš„æ§åˆ¶æµç¨‹

åœ¨ java ä¸­, å¼‚å¸¸æ˜¯è¢«ä¸€ä¸ªæ–¹æ³•æŠ›å‡ºçš„å¯¹è±¡. å½“ä¸€ä¸ªæ–¹æ³•æŠ›å‡ºå¼‚å¸¸æ—¶, è¯¥æ–¹æ³•ä»è°ƒç”¨æ ˆä¸­è¢«å¼¹å‡º, åŒæ—¶æŠŠäº§ç”Ÿçš„å¼‚å¸¸çš„å¯¹è±¡æŠ›ç»™æ ˆä¸­çš„é’±ä¸€ä¸ªæ–¹æ³•.

#### å¼‚å¸¸å¤„ç†

- æ•è·è¿™ä¸ªå¼‚å¸¸, ä¸ç„¶å®ƒæ²¿ç€è°ƒç”¨æ ˆç»§ç»­å‘ä¸‹æŠ›å‡º
- æ•è·è¿™ä¸ªå¼‚å¸¸, å¹¶ç»§ç»­å‘ä¸‹æŠ›å‡º
- ä¸æ•è·è¿™ä¸ªå¼‚å¸¸, ä»è€Œå¯¼è‡´æ–¹æ³•ä»è°ƒç”¨æ ˆä¸­è¢«å¼¹å‡º, å¼‚å¸¸å¯¹è±¡ç»§ç»­æŠ›å‡ºç»™è°ƒç”¨æ ˆçš„ä¸‹é¢çš„æ–¹æ³•
- Try ç¨‹åºå—é‡Œé¢çš„è¯­å¥æ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„è¯­å¥
- å½“ try ç¨‹åºå—é‡Œé¢çš„è¯­å¥æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸çš„æ—¶å€™ï¼Œç¨‹åºçš„æ§åˆ¶è½¬å‘äº†ç›¸åŒ¹é…çš„ catch ç¨‹åºå—ï¼Œcatch ç¨‹åºå—é‡Œé¢çš„è¯­å¥è¢«æ‰§è¡Œã€‚
- å½“å¼‚å¸¸å‘ç”Ÿåï¼Œç¨‹åºæ‰§è¡Œå°†å¿½ç•¥ try ç¨‹åºå—ä¸­å‰©ä½™çš„è¯­å¥ï¼Œç»§ç»­æ‰§è¡Œç¨‹åºå—åé¢çš„è¯­å¥ã€‚
- å¦‚æœåœ¨ try ç¨‹åºå—ä¸­æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆ catch å—å°†è¢«å¿½ç•¥ã€‚ç¨‹åºå°†ç»§ç»­æ‰§è¡Œ try-catch ä¸‹é¢çš„è¯­å¥
- åœ¨ä¸€ä¸ª try-catch è¯­å¥ä¸­ï¼Œå½“æœ‰å¤šä¸ª catch å—çš„æ—¶å€™ï¼Œå®ƒä»¬è¢«é¡ºåºæ£€æŸ¥
- åœ¨æ£€æŸ¥è¿‡ç¨‹ä¸­ï¼Œæ³¨æ„å¼‚å¸¸çš„åŒ¹é…å…³ç³»æ˜¯å¾ˆé‡è¦çš„
- å½“ä¸€ä¸ªå¼‚å¸¸è¢«æŠ›å‡ºï¼Œä¸å®ƒç›¸åŒ¹é…çš„ catch å—è¢«æ‰§è¡Œï¼Œå…¶å®ƒçš„ catch å—ï¼Œå°±è¢«å¿½ç•¥æ‰ä¸å†æ‰§è¡Œ
- å¦‚æœæ²¡æœ‰ catch å—åŒ¹é…æŠ›å‡ºçš„å¼‚å¸¸ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šåœ¨å †æ ˆä¸­æœç´¢ï¼Œæ‰¾åˆ°ä¸€ä¸ªåŒ¹é…çš„æ•è·æ–¹æ³•ã€‚
- å¦‚æœä»ç„¶æ²¡æœ‰æ‰¾åˆ°ï¼Œé‚£ä¹ˆç³»ç»Ÿå°†å¤„ç†æŠ›å‡ºå¼‚å¸¸
- å³ä½¿åœ¨ try ç¨‹åºå—å†…éƒ¨æœ‰ä¸€ä¸ª return è¯­å¥ï¼Œfinally è¯­å¥å—ä¹Ÿè¦è¢«æ‰§è¡Œ
- å½“åœ¨ try ç¨‹åºå—ä¸­ï¼Œé‡åˆ° return è¯­å¥ï¼Œfinally å—ä¸­çš„è¯­å¥åœ¨æ–¹æ³•è¿”å›ä¹‹å‰è¢«æ‰§è¡Œ

### å¼‚å¸¸å¤„ç†æµç¨‹

1. å¦‚æœç¨‹åºäº§ç”Ÿäº†å¼‚å¸¸, é‚£ä¹ˆä¼šè‡ªåŠ¨çš„ç”± JVM æ ¹æ®å¼‚å¸¸çš„ç±»å‹, å®ä¾‹åŒ–ä¸€ä¸ªæŒ‡å®šå¼‚å¸¸ç±»çš„å¯¹è±¡;
2. å¦‚æœæ²¡æœ‰å¤„ç†å¼‚å¸¸çš„æ“ä½œ,

   - å°±äº¤ç»™ JVM é»˜è®¤å¤„ç†â€“> è¾“å‡ºå¼‚å¸¸ä¿¡æ¯

3. å¦‚æœæœ‰å¼‚å¸¸å¤„ç†,

   - åˆ™ç”± try è¯­å¥æ•è·å¼‚å¸¸ç±»å¯¹è±¡;
   - ç„¶ååŒ¹é…åé¢çš„ catch è¯­å¥,
     - å¦‚æœæˆåŠŸ, åˆ™ä½¿ç”¨æŒ‡å®šçš„å¤„ç†è¯­å¥
     - å¦‚æœéƒ½ä¸åŒ¹é…, åˆ™ç”± JVM é»˜è®¤å¤„ç†

4. ä¸ç®¡æ˜¯å¦æœ‰å¼‚å¸¸, éƒ½ä¼šæ‰§è¡Œ finally è¯­å¥, å¦‚æœæ²¡æœ‰å¼‚å¸¸, æ‰§è¡Œå®Œ finally, åˆ™ä¼šç»§ç»­æ‰§è¡Œä¹‹åçš„å…¶ä»–è¯­å¥; å¦‚æœæ­¤æ—¶æœ‰å¼‚å¸¸æ²¡æœ‰å¤„ç† (æ²¡æœ‰ catch åŒ¹é…), é‚£ä¹ˆæ‹½ä¼šæ‰§è¡Œ finally è¯­å¥, ä½†æ˜¯æ‰§è¡Œå®Œ finally å, å°†é»˜è®¤äº¤ç»™ JVM è¿›è¡Œå¼‚å¸¸çš„è¾“å‡º, å¹¶ä¸”ç¨‹åºä¸­æ–­.

![20241229154732_ngGAJMzB.webp](https://cdn.dong4j.site/source/image/20241229154732_ngGAJMzB.webp)

### å¼‚å¸¸çš„æŠ›å‡º

#### **throws**

ä¸€ä¸ªå®Œæ•´çš„æ–¹æ³•å£°æ˜:  
`è®¿é—®ä¿®é¥°ç¬¦ å¯é€‰ä¿®é¥°ç¬¦ è¿”å›ç±»å‹ æ–¹æ³•å(å‚æ•°åˆ—è¡¨) throws å¼‚å¸¸ç±»å‹`  
ä½œç”¨:

- é€šçŸ¥æœ¬æ–¹æ³•çš„è°ƒç”¨è€…, æœ¬æ–¹æ³•**æœ‰å¯èƒ½**æœ‰æŸç§æˆ–å‡ ç§ç±»å‹çš„å¼‚å¸¸
- å­ç±»é‡å†™çš„æ–¹æ³•ä¸èƒ½æŠ›å‡ºæ¯”çˆ¶ç±»æ›´å¤š (èŒƒå›´) çš„å¼‚å¸¸;

3 ç§ç±»:

- è¡¨ç¤ºå±‚ç±»: ä¸»è¦è´Ÿè´£ UI çš„, è·Ÿç”¨æˆ·æ‰“äº¤é“, æ”¾åœ¨æœ€å¤–é¢çš„ä¸€å±‚;
- ä¸šåŠ¡å±‚ç±»: å¤„ç†è¡¨ç¤ºå±‚æ¥å—åˆ°çš„æ•°æ®;
- æŒä¹…å±‚ç±»: å­˜å‚¨æ•°æ®;

#### **throw**

æŠ›å‡ºå¼‚å¸¸å¯¹è±¡  
throw new å¼‚å¸¸ç±» ();  
æ‰§è¡Œåˆ° throw æ—¶ä¸€å®šä¼šæœ‰å¼‚å¸¸çš„æŠ›å‡º, å°±ä¼šæ‰§è¡Œå¼‚å¸¸æŠ›å‡ºæ‰§è¡Œæµç¨‹

### è‡ªå®šä¹‰å¼‚å¸¸ç±»

- ç»§æ‰¿ Exception ç±»;
- é‡è½½ Exception çš„æ„é€ æ–¹æ³•, ä¸€èˆ¬éƒ½æ˜¯æ„é€  3 ä¸ªå¸¦å‚æ„é€ æ–¹æ³•;
  - ç›®çš„æ˜¯æŠŠå…¶ä»–å¼‚å¸¸çš„ä¿¡æ¯å°è£…åˆ°è‡ªå®šä¹‰å¼‚å¸¸ä¿¡æ¯ä¸­;
  - è‡ªå®šä¹‰éœ€è¦çš„ä¸šåŠ¡ä¸Šçš„å¼‚å¸¸æ¬£å–œ;
- æ·»åŠ è‡ªå®šä¹‰å¼‚å¸¸çš„ç‰¹æœ‰æ–¹æ³•;
  - å¤§æ¦‚æ€è·¯:
    - æ–°å®šä¹‰ä¸€ä¸ªå¼‚å¸¸ç±», ç»§æ‰¿ Exception ç±»
    - åœ¨ B å†…ä¸­çš„æ–¹æ³•ä¸­å£°æ˜æŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸
    - åœ¨ B æ–¹æ³•å†…ä¼šå‡ºç°å¼‚å¸¸çš„è¯­å¥ç”¨ try - catch åŒ…èµ·æ¥
    - åœ¨ catch è¯­å¥ä¸­ throw new è‡ªå®šä¹‰å¼‚å¸¸ç±»å (å‚æ•°åˆ—è¡¨);
    - å¦‚æœ A ç±»æ˜¯ B ç±»çš„æ–¹æ³•çš„è°ƒç”¨è€…, å¦‚æœä¸å¤„ç†å¼‚å¸¸, å¿…é¡»åœ¨æ–¹æ³•ä¸­å£°æ˜ throws è‡ªå®šä¹‰å¼‚å¸¸ç±»å
    - å¦‚æœ mian æ–¹æ³•æ˜¯ A çš„è°ƒç”¨è€…, å¦‚æœä¸æŠ›å‡ºå¼‚å¸¸, å°±å¿…é¡»å¤„ç†è¿™ä¸ªå¼‚å¸¸;
    - å¦‚æœæŠ›å‡ºå¼‚å¸¸, å¯ä»¥ä¸å¤„ç†, äº¤ç»™ JVM å¤„ç†;

### finall å…³é”®å­—

```java
public classTest {
    public static void main (String[] args) {
        System.out.println (new Test().test() );
    }
    static int test() {
        int x = 1;
        try {
            return x;
        }
        finally {
            ++x;
        }
    }
}
```

> è¾“å‡º â€“>1

```java
public class smallT {
    public static void main (String args[]) {
        smallT t = new smallT();
        int b = t.get();
        System.out.println (b);
    }

    public int get() {
        try {
            return 1 ;
        }
        finally {
            return 2 ;
        }
    }
}
```

> è¾“å‡º â€“>2

```java
public classTest {
    public static voidmain (String[] args) {
        System.out.println (newTest().test() );;
    }
    int test() {
        try {
            return func1();
        }
        finally {
            return func2();
        }
    }
    int func1() {
        System.out.println ("func1");
        return 1;
    }
    int func2() {
        System.out.println ("func2");
        return 2;
    }
}
```

> è¾“å‡º:  
> func1  
> func2  
> 2

## [Java å…³é”®å­—è§£æï¼šnewã€static ä¸ final](https://blog.dong4j.site/posts/fe7c7d2d.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

### new

è¦è°ˆ new å…³é”®å­—, å°±å¿…é¡»å…ˆè¯´è¯´æ„é€ æ–¹æ³•, å®ƒä»¬ 2 ä¸ªå°±æ˜¯ä¸€å¯¹å¥½åŸºå‹.

#### æ„é€ æ–¹æ³•

##### å®šä¹‰

- æ— å‚æ„é€ æ–¹æ³•:  
   `è®¿é—®ä¿®é¥°ç¬¦ ç±»å(){ }`

- å¸¦å‚æ„é€ æ–¹æ³•  
   `è®¿é—®ä¿®é¥°ç¬¦ ç±»å(å‚æ•°åˆ—è¡¨){ }`

##### è¯´æ˜

1. æ„é€ æ–¹æ³•å¯ä»¥è¢«é‡è½½;
2. æ²¡æœ‰è¿”å›ç±»å‹ (void ä¹Ÿç®—è¿”å›ç±»å‹, åªæ˜¯æ²¡æœ‰è¿”å›å€¼);
3. æ–¹æ³•åå’Œç±»åå¿…é¡»ä¸€æ ·;
4. å¦‚æœä¸å†™, ç³»ç»Ÿä¼šé»˜è®¤æä¾›ä¸€ä¸ªæ— å‚æ„é€ æ–¹æ³•;
5. å¦‚æœå†™äº†, ç³»ç»Ÿå°±ä¸ä¼šæä¾›ä»»ä½•æ„é€ æ–¹æ³•;
6. å­ç±»ä¸èƒ½ç»§æ‰¿çˆ¶ç±»çš„æ„é€ æ–¹æ³•;
7. æ¥å£æ²¡æœ‰æ„é€ æ–¹æ³•;

##### ä½œç”¨

**äº§ç”Ÿå¯¹è±¡**  
new ä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™æ„é€ å™¨æ‰€è¦åšçš„äº‹

1. åˆ›å»ºç©ºé—´;
2. åˆ’åˆ†å±æ€§;
3. åˆå§‹åŒ–å€¼;
4. æ‰§è¡Œæ„é€ æ–¹æ³•å†…çš„è¯­å¥;

#### å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡

ç”¨ new å…³é”®å­—å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡æ—¶, æ‰€ç”¨åšçš„äº‹:  
`People p = new People();`

1. åŠ è½½ People,class æ–‡ä»¶è¿›å…¥å†…å­˜;
2. åœ¨æ ˆå†…å­˜ä¸º p å˜é‡ç”³è¯·ä¸€ä¸ªç©ºé—´ (4 ä¸ªå­—èŠ‚);
3. åœ¨å †å†…å­˜ä¸º People å¯¹è±¡ç”³è¯·ç©ºé—´ (å¤§å°ä¸ºç±»ä¸­æ‰€æœ‰æˆå‘˜å˜é‡çš„å¤§å°);
4. å¯¹ç±»ä¸­çš„æˆå‘˜å˜é‡è¿›è¡Œé»˜è®¤åˆå§‹åŒ–;
5. (å¦‚æœæœ‰) å¯¹ç±»çš„æˆå‘˜å˜é‡è¿›è¡Œæ˜¾ç¤ºåˆå§‹åŒ–;
6. æœ‰æ„é€ ä»£ç å—, å…ˆæ‰§è¡Œæ„é€ ä»£ç å—ä¸­çš„è¯­å¥;
7. æ‰§è¡Œæ„é€ æ–¹æ³•ä¸­çš„è¯­å¥;
8. æŠŠå †å†…å­˜çš„å¼•ç”¨èµ‹ç»™ p å˜é‡;

### static

(ç±»çº§åˆ«çš„, ä¸å¯¹è±¡æ— å…³)  
å¯ä»¥ä¿®é¥°å±æ€§, æ–¹æ³•, ä»£ç å—å’Œå†…éƒ¨ç±»;

#### static ä¿®é¥°å±æ€§ (ç±»å˜é‡)

- é‚£ä¹ˆè¿™ä¸ªå±æ€§å°±å¯ä»¥ç”¨ `ç±»å.å±æ€§å` æ¥è®¿é—®, ä¹Ÿå°±æ˜¯ä½¿è¿™ä¸ªå±æ€§ç§°ä¸ºæœ¬é¢†çš„ç±»å˜é‡, ä¸ºæœ¬ç±»å¯¹è±¡æ‰€å…±äº«;

#### static ä¿®é¥°æ–¹æ³• (é™æ€æ–¹æ³•)

- ä¼šä½¿è¿™ä¸ªæ–¹æ³•ç§°ä¸ºæ•´ä¸ªç±»æ‰€å…¬æœ‰çš„æ–¹æ³•, å¯ä»¥ç”¨ `ç±»å.æ–¹æ³•å` è®¿é—®;
- static ä¿®é¥°çš„æ–¹æ³•, ä¸èƒ½ç›´æ¥è®¿é—®æœ¬ç±»ä¸­çš„éé™æ€æˆå‘˜, ä½†æœ¬ç±»çš„éé™æ€æ–¹æ³•å¯ä»¥è®¿é—®æœ¬ç±»çš„é™æ€æ–¹æ³•;
- åœ¨é™æ€æ–¹æ³•ä¸­ä¸èƒ½å‡ºç° `this` å…³é”®å­—;
- çˆ¶ç±»ä¸­æ˜¯é™æ€æ–¹æ³•, å­ç±»ä¸­ä¸èƒ½è¦†ç›–ä¸ºéé™æ€æ–¹æ³•;
- åœ¨ç¬¦åˆè¦†ç›–è§„åˆ™çš„å‰æä¸‹, åœ¨çˆ¶å­ç±»ä¸­, çˆ¶ç±»ä¸­çš„é™æ€æ–¹æ³•å¯ä»¥è¢«å­ç±»ä¸­çš„é™æ€æ–¹æ³•è¦†ç›–, ä½†æ˜¯æ²¡æœ‰å¤šæ€;
- åœ¨ä½¿ç”¨å¯¹è±¡è°ƒç”¨é™æ€æ–¹æ³•æ—¶, å…¶å®æ˜¯åœ¨è°ƒç”¨ç¼–è¯‘æ—¶ç±»å‹çš„é™æ€æ–¹æ³•;

#### static ä¿®é¥°åˆå§‹åŒ–ä»£ç å—

- æ­¤æ—¶åˆå§‹åŒ–ä»£ç å—å«åšé™æ€åˆå§‹åŒ–ä»£ç å—, è¿™ä¸ªä»£ç å—åªåœ¨ç±»åŠ è½½æ—¶è¢«æ‰§è¡Œä¸€æ¬¡;
- å¯ä»¥ç”¨é™æ€åˆå§‹åŒ–ä»£ç å—åˆå§‹åŒ–ä¸€ä¸ªç±»;
- åŠ¨æ€åˆå§‹åŒ–ä»£ç å—, äº›åœ¨ç±»ä½“çš„ `{}` ä¸­, è¿™ä¸ªä»£ç å—åœ¨ç”Ÿæˆå¯¹è±¡æ—¶è¿è¡Œ;

**ä¾‹å­**

```java
class StaticTest{
    static int a = 3;
    static int b ;
    static void method(int x){
        System.out.println("x = " + x);
        System.out.println("a = " + a);
        System.out.println("b = " + b);
    }
    static {
        System.out.println("é™æ€åˆå§‹åŒ–ä»£ç å—");
        b = a * 4;
    }
    public static void main(String[] args){
        method(5);
    }
}
```

> è¾“å‡ºç»“æœ:  
> é™æ€åˆå§‹åŒ–ä»£ç å—  
> x = 5  
> a = 3  
> b = 12

**æ‰§è¡Œé¡ºåº**

1. é¦–å…ˆåŠ è½½ `StaticTest` ç±», åœ¨é™æ€åŒºå¼€è¾Ÿç©ºé—´, ç»™ `a` èµ‹å€¼ä¸º `3`,`b` èµ‹å€¼ä¸º `0`;
2. æ¥ç€æ‰§è¡Œé™æ€åˆå§‹åŒ–å—, å…ˆæ‰“å°ä¸€æ¡è¯­å¥, ç„¶åæŠŠ `a*4` çš„å€¼èµ‹ç»™ `b`;
3. ç„¶åæŠŠ `main()` æ–¹æ³•è°ƒå…¥æ ˆä¸­,`main()` è°ƒç”¨ `method()` æ–¹æ³•, æŠŠ `3` ä¼ ç»™ `x`;
4. ç„¶åæ‰“å°;

**æ³¨æ„**: åœ¨ä¸€ä¸ª static æ–¹æ³•ä¸­å¼•ç”¨ä»»ä½•å®ä¾‹å˜é‡éƒ½æ˜¯éæ³•çš„.

#### main() ä¸­çš„ static

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸»æ–¹æ³•æ˜¯é™æ€æ–¹æ³•ï¼Œæ‰€ä»¥å¯è°ƒç”¨é™æ€æ–¹æ³•ï¼Œä¸»æ–¹æ³•ä¸ºé™æ€æ–¹æ³•æ˜¯å› ä¸ºå®ƒæ˜¯æ•´ä¸ªè½¯ä»¶ç³»ç»Ÿçš„å…¥å£ï¼Œè€Œè¿›å…¥å…¥å£æ—¶ç³»ç»Ÿä¸­æ²¡æœ‰ä»»ä½•å¯¹è±¡ï¼Œåªèƒ½ä½¿ç”¨ç±»è°ƒç”¨ã€‚

#### è¯´æ˜

åœ¨æœ‰ static å®šä¹‰çš„ç±»çš„å¤–é¢, static æ–¹æ³•å’Œå˜é‡èƒ½ç‹¬ç«‹äºä»»ä½•å¯¹è±¡è€Œè¢«ä½¿ç”¨.  
ä¾‹å¦‚æƒ³ä»ç±»çš„å¤–éƒ¨è°ƒç”¨ä¸€ä¸ª static æ–¹æ³•:  
`className.method();`  
æˆ–è€…è°ƒç”¨ä¸€ä¸ª static å±æ€§:  
`className.å±æ€§å;`  
è¿™å°±æ˜¯ Jaba å¦‚ä½•å®ç°å…¨å±€åŠŸèƒ½å’Œå…¨å±€å˜é‡çš„ä¸€ä¸ªæ§åˆ¶ç‰ˆæœ¬.  
**ä¾‹å­**

```java
class StaticDemo{
    static int a = 42;
    static int b = 99;
    static void callMe(){
        System.out.println("a = " +ã€€ï½);
    ï½
}
class StaticByName{
    public static void main(String[] args){
        StaticDemo.callMe();
        System.out.println("b = " + StaticDemo.b);
    }
}
```

> è¾“å‡ºç»“æœ:  
> a = 42  
> b = 99

æœ€åä¸€ç‚¹: static æˆå‘˜ä¸èƒ½è¢«å…¶æ‰€åœ¨ class åˆ›å»ºçš„å®ä¾‹è®¿é—®çš„.

**ç®€å•æ¥è¯´**

1. å¦‚æœä¸åŠ  static ä¿®é¥°çš„æˆå‘˜æ˜¯å¯¹è±¡æˆå‘˜, ä¹Ÿå°±æ˜¯å½’æ¯ä¸ªå¯¹è±¡æ‰€æœ‰;
2. åŠ  static ä¿®é¥°çš„æˆå‘˜æ˜¯ç±»æˆå‘˜, å°±æ˜¯å¯ä»¥ç”±ä¸€ä¸ªå¯¹è±¡ç›´æ¥è°ƒç”¨, ä¸ºæ‰€æœ‰å¯¹è±¡å…¬æœ‰.

#### ä»å†…å­˜çš„è§’åº¦æ¥çœ‹ static

ç±»åŠ è½½çš„è¿‡ç¨‹ä¸­, ç±»æœ¬èº«ä¹Ÿæ˜¯ä¿å­˜åœ¨æ–‡ä»¶ä¸­çš„ (å­—èŠ‚ç æ–‡ä»¶ä¿å­˜ç€ç±»çš„ä¿¡æ¯),  
java é€šè¿‡ I/O æµæŠŠç±»æ–‡ä»¶è¯»å…¥ JVM, è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºç±»çš„åŠ è½½.  
JVM ä¼šé€šè¿‡ç±»è·¯å¾„ (classpath) æ¥æ‰¾å­—èŠ‚ç æ–‡ä»¶.  
éœ€è¦çš„æ—¶å€™æ‰ä¼šè¿›è¡Œç±»çš„åŠ è½½, ç”Ÿæˆå¯¹è±¡æ—¶æ˜¯å…ˆåŠ è½½åæ„é€ .  
ç±»å˜é‡, ä¼šåœ¨åŠ è½½æ—¶è‡ªåŠ¨åˆå§‹åŒ–, åˆå§‹åŒ–è§„åˆ™å’Œå®ä¾‹å˜é‡ç›¸åŒ.  
**æ³¨æ„**:  
ç±»ä¸­çš„å®ä¾‹å˜é‡æ˜¯åœ¨åˆ›å»ºå¯¹è±¡æ—¶è¢«åˆå§‹åŒ–çš„.  
static ä¿®é¥°çš„å±æ€§, æ˜¯åœ¨ç±»åŠ è½½æ—¶è¢«åˆ›å»ºå¹¶è¿›è¡Œåˆå§‹åŒ–,  
ç±»åŠ è½½çš„è¿‡ç¨‹åªæœ‰ä¸€æ¬¡, ä¹Ÿå°±æ˜¯ç±»å˜é‡åªä¼šè¢«åˆ›å»ºä¸€æ¬¡.

#### é™æ€éé™æ€æˆå‘˜çš„è°ƒç”¨

- é™æ€æˆå‘˜èƒ½ç›´æ¥è°ƒç”¨é™æ€æˆå‘˜;
- éé™æ€æˆå‘˜ä¸èƒ½è°ƒç”¨é™æ€æˆå‘˜, èƒ½è°ƒç”¨éé™æ€æˆå‘˜;  
   **åŸå› :**  
   ä»å†…å­˜çš„è§’åº¦, static ä¿®é¥°çš„æˆå‘˜æ˜¯éšç€ç±»çš„åŠ è½½è€Œåˆ›å»ºçš„,  
   å¦‚æœæ­¤æ—¶ç”¨é™æ€æˆå‘˜è°ƒç”¨éé™æ€æˆå‘˜, åˆ™ä¼šæŠ¥é”™,  
   å› ä¸ºåœ¨å†…å­˜ä¸­è¿˜æ²¡æœ‰è¿™ä¸ªéé™æ€æˆå‘˜;  
   éé™æ€æˆå‘˜åªæœ‰åœ¨å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™æ‰åœ¨å†…å­˜ä¸­åˆ›å»º, æ‰€ä»¥éé™æ€æˆå‘˜å¯ä»¥è°ƒç”¨é™æ€æˆå‘˜.  
   è¯´ç™½äº†å°±ä¸€å¥è¯:

> å…ˆå‡ºç”Ÿçš„ä¸èƒ½å¨¶è¿˜æ²¡æœ‰å‡ºç”Ÿçš„;(æŒ‡è…¹ä¸ºå©šä¸åœ¨è®¨è®ºçš„èŒƒå›´ä¹‹å†…)  
> åå‡ºç”Ÿçš„é•¿å¤§äº†å¯ä»¥å¨¶å…ˆå‡ºç”Ÿçš„ (ç°åœ¨å¾ˆæµè¡Œå•Š), ä¹Ÿå¯ä»¥å¨¶ä¸€èµ·å‡ºç”Ÿçš„;

### final

æœ€ç»ˆçš„æ„æ€, ä¸å…è®¸æ”¹å˜;  
å¯ä»¥ä¿®é¥°å˜é‡, æ–¹æ³•å’Œç±».

#### final ä¿®é¥°å˜é‡

- ä¸€æ—¦è¢« final ä¿®é¥°çš„å˜é‡, å°±ä¼šå˜æˆå¸¸é‡, ä¸èƒ½è¢«é‡æ–°èµ‹å€¼.
- å¸¸é‡å¯ä»¥åœ¨åˆå§‹åŒ–çš„æ—¶å€™ç›´æ¥èµ‹å€¼, ä¹Ÿå¯ä»¥åœ¨æ„é€ æ–¹æ³•é‡Œèµ‹å€¼,
- åªèƒ½äºŒé€‰ä¸€, ä¸èƒ½ä¸ºå¸¸é‡é‡æ–°èµ‹å€¼;
- å¸¸é‡æ²¡æœ‰é»˜è®¤å€¼;
- é”å®šæ ˆ, ä½¿æ ˆä¸­çš„æ•°æ®ä¸å¯ä»¥æ”¹å˜;
- é™æ€å¸¸é‡åªèƒ½åœ¨åˆå§‹åŒ–æ—¶ç›´æ¥èµ‹å€¼;

##### å…³äºå¼•ç”¨çš„é—®é¢˜

**é—®é¢˜:** ä½¿ç”¨ final ä¿®é¥°çš„å˜é‡, æ˜¯å¼•ç”¨ä¸èƒ½å˜è¿˜æ˜¯å¼•ç”¨çš„å¯¹è±¡ä¸èƒ½å˜?

```java
final StringBuffer a = new StringBuffer("finalTest");
a = new StringBuffer("");//æŠ¥ç¼–è¯‘å™¨é”™è¯¯

a.append("finalTest");//è¿™æ ·å¯ä»¥
```

æ‰€ä»¥è¢« final ä¿®é¥°çš„å˜é‡, æ˜¯å¼•ç”¨å˜é‡ä¸èƒ½å˜, å¼•ç”¨å˜é‡æ‰€æŒ‡å‘çš„å¯¹è±¡ä¸­çš„å†…å®¹è¿˜æ˜¯å¯ä»¥æ”¹å˜çš„.

#### final ä¿®é¥°æ–¹æ³•

è¢« final ä¿®é¥°çš„æ–¹æ³•å°±ä¸èƒ½è¢«å­ç±»é‡å†™.

#### final ä¿®é¥°ç±»

- è¢« final ä¿®é¥°çš„ç±»å°†ä¸èƒ½è¢«ç»§æ‰¿.
- final ç±»ä¸­çš„æ–¹æ³•ä¹Ÿéƒ½æ˜¯ final çš„.

**æ³¨æ„**:  
final ä¸èƒ½ç”¨æ¥ä¿®é¥°æ„é€ æ–¹æ³•.

> public static final int MAX = 100;

å¸¸é‡å±æ€§å®šä¹‰ä¸º static, èŠ‚çº¦ç©ºé—´  
final: å› ä¸ºç”¨ final ä¿®é¥°, æ‰€ä»¥æ˜¯ä¸ªå¸¸é‡  
public: å› ä¸ºæ˜¯å¸¸é‡, æ‰€ä»¥ä¸èƒ½æ›´æ”¹, public ä¿®é¥°ç»™åˆ«äººçœ‹ä¹Ÿæ²¡äº‹  
static: å…±äº«, è¿™æ ·å°±ä¸ç”¨ new å‡ºæ¥æ‰èƒ½ä½¿ç”¨;

**è¡¥å……è¯´æ˜:**  
å†…éƒ¨ç±»è¦è®¿é—®å±€éƒ¨å˜é‡æ—¶, å±€éƒ¨å˜é‡å¿…é¡»å®šä¹‰ä¸º final.

**ä¸ºä»€ä¹ˆå±€éƒ¨å†…éƒ¨ç±»ä¸èƒ½è®¿é—®æ²¡æœ‰è¢« final ä¿®é¥°çš„å±€éƒ¨å˜é‡?**

> ä»å†…å­˜ä¸­çœ‹ï¼Œå½“æ–¹æ³•é‡Œçš„å±€éƒ¨å˜é‡æ‰€åœ¨æ–¹æ³•ç»“æŸæ—¶ï¼Œè¯¥å˜é‡å³åœ¨æ ˆå†…å­˜ä¸­æ¶ˆå¤±ï¼›è€Œå†…éƒ¨ç±»å…¶å®æ˜¯ä¸€ä¸ªç±»ï¼Œåªæœ‰å†…å­˜ä¸­å¯¹å®ƒçš„æ‰€æœ‰å¼•ç”¨éƒ½æ¶ˆå¤±åï¼Œè¯¥å†…éƒ¨ç±»æ‰â€æ­»äº¡â€ï¼Œå³å†…éƒ¨ç±»çš„ç”Ÿå‘½å‘¨æœŸå¯èƒ½æ¯”å±€éƒ¨å˜é‡é•¿ã€‚å¦‚æœå±€éƒ¨å†…éƒ¨ç±»èƒ½è®¿é—®ä¸€èˆ¬çš„å±€éƒ¨å˜é‡ï¼Œåˆ™åœ¨å¤šçº¿ç¨‹ä¸­ï¼Œå¯èƒ½å½“æ–¹æ³•ç»“æŸåï¼Œå±€éƒ¨å†…éƒ¨ç±» (æ˜¯çº¿ç¨‹ç±»æ—¶) è¿˜åœ¨ä½¿ç”¨å±€éƒ¨å˜é‡ã€‚ä¸ºäº†é¿å…æ–¹æ³•å†…çš„å˜é‡è„±ç¦»æ–¹æ³•è€Œå­˜åœ¨çš„ç°è±¡å‘ç”Ÿï¼Œäºæ˜¯ java è§„å®šå±€éƒ¨å†…éƒ¨ç±»ä¸èƒ½è®¿é—®ä¸€èˆ¬çš„å±€éƒ¨å˜é‡ã€‚ä½†èƒ½è®¿é—®è¢« final ä¿®é¥°çš„å±€éƒ¨å˜é‡ã€‚å› ä¸ºå¸¸é‡æ”¾åœ¨å †å†…å­˜ä¸­çš„æ•°æ®æ®µçš„å¸¸é‡æ± ä¸­

### finally

æ˜¯å¼‚å¸¸å¤„ç†è¯­å¥çš„ä¸€ä¸ªéƒ¨åˆ†, æ˜¯å¼‚å¸¸çš„åŒæ„å‡ºå£, è¡¨ç¤ºæ€»æ˜¯æ‰§è¡Œ.  
å°±ç®—æ˜¯æ²¡æœ‰ catch è¯­å¥åŒæ—¶åˆæŠ›å‡ºå¼‚å¸¸çš„æƒ…å†µä¸‹ï¼Œ  
finally ä»£ç å—ä»ç„¶ä¼šè¢«æ‰§è¡Œã€‚  
æœ€åè¦è¯´çš„æ˜¯ï¼Œfinally ä»£ç å—ä¸»è¦ç”¨æ¥é‡Šæ”¾èµ„æºï¼Œæ¯”å¦‚ï¼šI/O ç¼“å†²åŒºï¼Œæ•°æ®åº“è¿æ¥

### finalize()

æ˜¯ Object ç±»çš„ä¸€ä¸ªæ–¹æ³•, åœ¨åƒåœ¾æ”¶é›†å™¨æ‰§è¡Œçš„æ—¶å€™,  
ä¼šè°ƒç”¨è¢«å›æ”¶å¯¹è±¡çš„æ­¤æ–¹æ³•,  
å¯ä»¥è¦†ç›–æ­¤æ–¹æ³•æä¾›åƒåœ¾æ”¶é›†æ—¶çš„å…¶ä»–èµ„æºå›æ”¶, ä¾‹å¦‚å…³é—­æ–‡ä»¶ç­‰.  
JVM ä¸ä¿è¯æ­¤æ–¹æ³•æ€»è¢«æ‰§è¡Œ.

### abstract

- æŠ½è±¡ç±»ä¸èƒ½å®ä¾‹åŒ–å¯¹è±¡, ä½†æ˜¯æœ‰æ„é€ æ–¹æ³•, æŠ½è±¡ç±»ä¸­å¯ä»¥åŒ…å«å±æ€§, æŠ½è±¡ç±»ä¸­çš„æ„é€ æ–¹æ³•æ˜¯ç”¨æ¥åˆå§‹åŒ–æˆå‘˜å±æ€§çš„;
- æ‰€æœ‰æŠ½è±¡å¯¹è±¡å¿…é¡»è¢«é‡å†™, é™¤éå­ç±»ä¹Ÿæ˜¯æŠ½è±¡ç±»;
- å¯ä»¥å­˜åœ¨æ²¡æœ‰æŠ½è±¡æ–¹æ³•çš„æŠ½è±¡ç±»;
- æœ‰æŠ½è±¡æ–¹æ³•çš„ç±»å¿…é¡»å®šä¹‰ä¸ºæŠ½è±¡ç±»;
- `abstract type name_method();`
- åªèƒ½ä¿®é¥°æ–¹æ³•å’Œç±»;  
   å‰©ä¸‹çš„è¯¦ç»†æ€»ç»“å°†åœ¨é¢å‘å¯¹è±¡çš„ç‰¹å¾ä¸­ä»‹ç».

### instanceof

A instanceof B  
A å¯¹è±¡æ˜¯å¦æ˜¯ B å¯¹è±¡çš„å®ä¾‹

```java
public boolean equals(Object obj){
    if(obj instanceof Student){
        if(student.name.equals(name))
            return true;
    }
    return false;
}
```

### this

1. å¯¹å½“å‰ç±»çš„å¼•ç”¨;
2. æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªéšå«çš„ this å˜é‡, å®ƒå¯ä»¥è®¿é—®ç±»çš„æ‰€æœ‰ä¿¡æ¯;
3. æ„é€ æ–¹æ³•çš„ç›¸äº’è°ƒç”¨, å¿…é¡»æ”¾åœ¨æ„é€ æ–¹æ³•å†…çš„ç¬¬ä¸€ä¸ªè¯­å¥;  
   åœ¨é‡è½½çš„æ„é€ å™¨ä¸­, ä¸ºäº†é‡å¤åˆ©ç”¨ä»£ç 

```java
class Gril {
    private int age;
    private String name;
    //æ„é€ æ–¹æ³•
    public Gril(int age ,String name){
        this(name);
        this.age = age;
        //this.name = name;
    }
    public Gril(String name){
        this.name = name;
    }
    public Gril(){

    }
    //ç¡è§‰çš„æ–¹æ³•
    public void sleep(Car car){
        System.out.println("åœ¨è½¦ä¸Šç¡è§‰");
    }
    public void sleep(Bed bed){
        System.out.println("åœ¨åºŠä¸Šç¡è§‰");
    }
    public void sleep(){
        System.out.println("åœ¨é‡å¤–ç¡è§‰");
    }
}
```

### super

this å’Œ super è¯¦è§£

1. this  
   this.â€“> æ­¤æ—¶çš„ this ä»£è¡¨å½“å‰å¯¹è±¡, å¯ä»¥æ“ä½œå½“å‰ç±»ä¸­çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•; ä¹Ÿå¯ä»¥æ“ä½œå½“å‰ç±»çˆ¶ç±»è®¿é—®ä¿®é¥°ç¬¦å…è®¸çš„æ–¹æ³•å’Œå±æ€§

1. super ä»£è¡¨å½“å‰å¯¹è±¡çš„çˆ¶ç±», åªèƒ½æ“ä½œå½“å‰ç±»çˆ¶ç±»ä¸­è®¿é—®ä¿®é¥°ç¬¦å…è®¸çš„å±æ€§å’Œæ–¹æ³•;

   - this ä¸èƒ½çœ‹åˆ°çš„æ—¶å€™, super ä¹Ÿçœ‹ä¸åˆ°, this èƒ½çœ‹åˆ°çš„, super è¿˜æ˜¯çœ‹ä¸åˆ°;
   - åªæœ‰åœ¨å‘ç”Ÿé‡å†™çš„æ—¶å€™, æ‰ç”¨ super è°ƒç”¨å½“å‰å¯¹è±¡çš„çˆ¶ç±»ä¸­åŒåçš„æ–¹æ³•å’Œå±æ€§;
   - this() è°ƒç”¨æœ¬ç±»çš„å…¶ä»–æ„é€ æ–¹æ³•;
   - super() è°ƒç”¨å½“å‰å¯¹è±¡çš„çˆ¶ç±»çš„æ„é€ æ–¹æ³•;
   - éƒ½åªèƒ½æ”¾åœ¨æ„é€ æ–¹æ³•çš„ç¬¬ä¸€è¡Œ;
   - this() æ²¡æœ‰é»˜è®¤;
   - super() ä¸ºé»˜è®¤å…¬å…±æ— å‚æ„é€ ;

å…³äº super æ›´è¯¦ç»†çš„ä»‹ç»å°†åœ¨é¢å‘å¯¹è±¡ä¹‹ç»§æ‰¿ä¸­è§åˆ°.

## [Javaç¼–ç¨‹åŸºç¡€ï¼šæŒæ¡å››ç§è®¿é—®ä¿®é¥°ç¬¦ï¼ˆpublicã€protectedã€defaultå’Œprivateï¼‰](https://blog.dong4j.site/posts/f941d9b7.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

### public

> è°éƒ½å¯ä»¥æ“ä½œ
>
> - å½“åœ¨æ–¹æ³•æˆ–å±æ€§å‰é¢æ˜¾æ˜¾å¼çš„ç»™å®š public é™å®šç¬¦çš„æ—¶å€™, å…¶å…·æœ‰è¯¥æƒé™æ§åˆ¶.
> - public æƒé™æ˜¯æœ€ä¸ºå®½æ¾çš„ä¸€ç§æƒé™æ§åˆ¶, å¯¹åŒ…çš„å†…, å¤–éƒ¨éƒ½æ˜¯å®Œå…¨å¯è§çš„.
> - java æœ€å¤šåªå…è®¸ä¸€ä¸ª java æ–‡ä»¶ä¸­å‡ºç°ä¸€ä¸ª public ç±».(è¯¥ç±»å‘å¤–é—´æä¾›æ¥å£, å¹¶ä¸è¯¥ java æ–‡ä»¶çš„åç§°å®Œå…¨ä¸€è‡´)
> - å½“ä¸€ä¸ª java æ–‡ä»¶ä¸­æ— ä¸€ä¸ª public ç±»æ—¶, è¡¨æ˜å…¶ä»…ä¾›åŒ…è®¿é—®, å¯¹å¤–ç•Œä¸å¯è§.
> - **æ³¨æ„:** ç±»åªæœ‰åŒ…è®¿é—®æƒé™å’Œ public è®¿é—®æƒé™.

### é»˜è®¤è®¿é—®ä¿®é¥°ç¬¦ (friendly)

> åŒä¸€ä¸ªåŒ…å†…å¯ä»¥æ“ä½œ

- å½“æ–¹æ³•æˆ–å±æ€§æœªç»™å®šè®¿é—®ä¿®é¥°ç¬¦æ—¶, å…¶é»˜è®¤å…·æœ‰è¯¥æƒé™.
- å…·æœ‰è¯¥æƒé™çš„æ–¹æ³•å’Œæˆå‘˜, å…¶åŒ…å†…æ˜¯å®Œå…¨å¯è§çš„, è€ŒåŒ…å¤–ä¸å¯è§.

```java
//Animal.javaå’ŒTest.javaåœ¨åŒä¸€åŒ…ä¸‹;
//Animal.java
public class Animal{
    void eat(){
        System.out.println("Animalåƒä¸œè¥¿çš„æ–¹æ³•");
    }
}
//Test.java
public class Test{
    public static void main(String[] args){
        Animal a = new Animal();
        a.eat();
    }
}
```

ç”±äº Animal ç±»å’Œ Test ç±»éƒ½è¢«æ‰“åŒ…åœ¨åŒä¸€ä¸ª package ä¸‹, Animal ç±»ä¸­çš„ eat() æ–¹æ³•ä¸ºé»˜è®¤è®¿é—®æƒé™, æ•…å¯¹ Test å¯è§.  
å¯¹ java æ–‡ä»¶ä¸­çš„ç±»ä¹Ÿæ˜¯å¦‚æ­¤, å¦‚æœæœªæŒ‡å®šè®¿é—®æƒé™, å…¶é»˜è®¤ä¸ºåŒ…è®¿é—®æƒé™, åªèƒ½åœ¨åŒ…å†…è¢«è®¿é—®.  
åŒ…å¤–æ˜¯æ— æ³•åˆ©ç”¨å…¶å®ä¾‹åŒ–å¯¹è±¡çš„.

**æ³¨æ„:** å½“å†³å®šä¸€ä¸ªç±»å¯¹åŒ…å¤–å¯è§çš„æ—¶å€™,  
é™¤äº†è¦å°†ç±»çš„è®¿é—®ä¿®é¥°ç¬¦æ”¹ä¸º public å¤–, è‡ªå®šä¹‰çš„æ„é€ æ–¹æ³•é™å®šç¬¦ä¹Ÿå¿…é¡»æ”¹ä¸º public, ä¸ç„¶å°†å¯¼è‡´å¤–éƒ¨ä¸å¯è§.

### protected

> åŒåŒ…æˆ–è€…å¯¼å‡ºç±»å¯ä»¥æ“ä½œ
>
> - protected æƒé™æ˜¯ä¸€ç§ä¸¥æ ¼ç¨‹åº¦ä»‹äº public å’Œ private ä¹‹é—´çš„è®¿é—®ä¿®é¥°ç¬¦.
> - å…·æœ‰ protected æƒé™çš„æˆ–æ–¹æ³•åªèƒ½å¯¹è‡ªèº«å’Œå¯¼å‡ºç±»å¯è§.

### private

> é™¤äº†è‡ªå·±, è°éƒ½ä¸èƒ½æ“ä½œ
>
> - private æ˜¯è®¿é—®ä¿®é¥°ç¬¦ä¸­æœ€ä¸ºä¸¥æ ¼çš„ä¸€ç§æƒé™.
> - å½“æ–¹æ³•æˆ–å±æ€§ä¸º private æƒé™çš„æ—¶å€™, è¡¨æ˜å…¶åªé’ˆå¯¹è¯¥ç±»çš„å†…éƒ¨å¯è§, ç±»çš„å¤–éƒ¨ (åŒ…æ‹¬åŒåŒ…å†…çš„å…¶ä»–ç±») éƒ½æ˜¯ä¸å¯ä»¥è§çš„.

```java
//Animal.javaå’ŒTest.javaåœ¨åŒä¸€åŒ…ä¸‹;
//Animal.java
public class Animal{
    private void eat(){
    System.out.println("Animalåƒä¸œè¥¿çš„æ–¹æ³•");
    }
}

//Test.java
public class Test{
    public static void main(String[] args){
        Animal a = new Animal();
        a.eat();//å°†é€ æˆç¼–è¯‘é”™è¯¯,eat()æ–¹æ³•ä¸ºprivate,ä»…å¯¹Animalç±»å†…éƒ¨å¯è§,ç°åœ¨åœ¨Testç±»å†…éƒ¨,æ‰€ä»¥ä¸å¯è§.
    }
}
```

### æ€»ç»“

- åœ¨é¢å‘å¯¹è±¡çš„è®¾è®¡å½“ä¸­, æœ€å¸¸è§çš„ä¸º public å’Œ private æƒé™ä¿®é¥°ç¬¦.
- ä¸€èˆ¬æƒ…å†µä¸‹å°†å®šä¹‰ä¸º private, å°†æ–¹æ³•å®šä¹‰ä¸º public. å¤–ç•Œä½¿ç”¨è¯¥ç±»æ—¶, é€šè¿‡ public æ–¹æ³•æ˜¯ç”¨å…¶æ¥å£, è€Œå…·ä½“çš„æˆå‘˜åˆ™å¯¹å¤–å±è”½, åªèƒ½é€šè¿‡ç±»æä¾›çš„èŠ‚åé—´æ¥è®¿é—®.

```java
public class Dog{
    private int age ;
    public void setAge(int num){
        age = num + 1 ;
    }
}
```

æ­¤å¤„, age å¯¹å¤–éƒ¨ä¸å¯è§, è¦æƒ³å¯¹å…¶è¿›è¡Œæ“ä½œ, å¿…é¡»ä½¿ç”¨ Dog ç±»æä¾›çš„æ¥å£ setAge(int num).

æ­¤å¤„, age å¯¹å¤–éƒ¨ä¸å¯è§, è¦æƒ³å¯¹å…¶è¿›è¡Œæ“ä½œ, å¿…é¡»ä½¿ç”¨ Dog ç±»æä¾›çš„æ¥å£ setAge(int num).

|  ä½œç”¨åŸŸ   | å½“å‰ç±» | åŒåŒ… | å­ç±» | å…¶ä»–åŒ… |
| :-------: | :----: | :--: | :--: | :----: |
|  public   |   âˆš    |  âˆš   |  âˆš   |   âˆš    |
| protected |   âˆš    |  âˆš   |  âˆš   |   Ã—    |
|   é»˜è®¤    |   âˆš    |  âˆš   |  Ã—   |   Ã—    |
|  private  |   âˆš    |  Ã—   |  Ã—   |   Ã—    |

å…¨æ–‡å®Œ

## [åœ¨Javaä¸­æ­£ç¡®ä½¿ç”¨longç±»å‹ï¼šé¿å…è®¡ç®—æ—¶æ„å¤–ä¸¢å¤±ç²¾åº¦](https://blog.dong4j.site/posts/b0abc087.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

è¯è¯´æœ‰è¿™æ ·ä¸€ä¸ªå°ä¾‹å­:  
MICROS_PER_DAY è¡¨ç¤ºä¸€å¤©çš„å¾®ç§’æ•°  
MILLIS_PER_DAY è¡¨ç¤ºä¸€å¤©çš„æ¯«ç§’æ•°  
ç„¶åä¸‹é¢ä¾‹å­çš„ç»“æœæ˜¯å¤šå°‘å‘¢?

```java
public class Test3 {
    public static void main(String[] args) {
        final long MICROS_PER_DAY = 24 * 60 * 60 * 1000 * 1000;
        final long MILLIS_PER_DAY = 24 * 60 * 60 * 1000;
        System.out.println(MICROS_PER_DAY / MILLIS_PER_DAY);
    }
}
```

So easy  
æ•°æ®ç±»å‹ä¸º `long` , å¾ˆå®¹æ˜“ä¿å­˜è¿™ä¸¤ä¸ªä¹˜ç§¯ä¸äº§ç”Ÿæº¢å‡º.  
å› æ­¤, ç»“æœè‚¯å®šæ˜¯ `1000`!

butâ€¦..  
ç»“æœæ˜¯:  
![20241229154732_wTbwOPoH.webp](https://cdn.dong4j.site/source/image/20241229154732_wTbwOPoH.webp)

**è§£é‡Š:**  
ä¸ºä»€ä¹ˆç­”æ¡ˆä¸æˆ‘ä»¬æƒ³è±¡ä¸ä¸€æ ·å‘¢?  
å› ä¸ºæ•°æ®æº¢å‡ºäº†â€¦  
ä½ åœ¨é€—æˆ‘? ä½†æˆ‘æ²¡å­¦è¿‡ java?  
long èƒ½è¡¨ç¤º -2 çš„ 63 æ¬¡æ–¹åˆ° 2 çš„ 63 æ¬¡æ–¹ - 1 çš„æ•´æ•°.  
æ•°éƒ½æ•°ä¸è¿‡æ¥, æ€ä¹ˆä¼šæº¢å‡º?  
å“ˆå“ˆ, å°å¿ƒé™·é˜±å•Š, è™½ç„¶æˆ‘ä»¬å®šä¹‰çš„æ˜¯ `long` ç±»å‹,  
å‡†ç¡®çš„è¯´æœ€ç»ˆçš„ç»“æœåº”è¯¥æ˜¯ `long` ç±»å‹çš„.

æˆ‘ä»¬çœ‹çœ‹è¡¨è¾¾å¼å³è¾¹,  
`24 * 60 * 60 * 1000 * 1000`  
è¿™ä¸ªè¡¨è¾¾å¼æ˜¯ä»¥ `int` ç±»å‹ä½œä¸ºè¿ç®—çš„,  
`int` è·Ÿ `int` ç±»å‹ç›¸ä¹˜, ç»“æœè¿˜æ˜¯ `int` ç±»å‹,  
æœ€ç»ˆç»“æœè¶…è¿‡ int æ‰€èƒ½ä¿å­˜çš„èŒƒå›´, æ‰€ä»¥æ•°æ®æº¢å‡ºäº†,  
ç„¶åæ‰è¢« `long` æ‰€ä¿å­˜;

**æ”¹è¿›**  
`24 * 60 * 60 * 1000 * 1000`â€“>`24L * 60 * 60 * 1000 * 1000`  
åœ¨è¡¨è¾¾å¼éšä¾¿å“ªä¸ªæ•°å€¼åé¢åŠ ä¸Šä¸€ä¸ª `l` æˆ–è€… `L` å°±æå®šäº†,  
å…¶ç»“æœä¼šè‡ªåŠ¨è½¬æ¢ä¸º `long` è€Œä¸æ˜¯ `int` äº†, ç„¶åå†ä¿å­˜åˆ° `long` ç±»å‹å˜é‡ä¸­.  
å°±æ˜¯è¿™ä¹ˆç®€å•, å°±æ˜¯è¿™ä¹ˆä»»æ€§.

## [Javaç¼–ç¨‹åŸºç¡€ï¼šå¦‚ä½•æ­£ç¡®åˆ¤æ–­ä¸€ä¸ªæ•°å­—æ˜¯å¥‡æ•°è¿˜æ˜¯å¶æ•°](https://blog.dong4j.site/posts/2363f1e9.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

ä¸‹é¢çš„æ–¹æ³•æ„å›¾ç¡®å®šå®ƒé‚£å”¯ä¸€çš„å‚æ•°æ˜¯å¦æ˜¯ä¸€ä¸ªå¥‡æ•°. è¿™ä¸ªæ–¹æ³•èƒ½å¤Ÿæ­£ç¡®è¿è½¬å—?

```java
import javax.swing.JOptionPane;
public class Test1 {
    public static void main(String[] args) {
        String s = JOptionPane.showInputDialog("è¯·è¾“å…¥ä¸€ä¸ªæ•´æ•°");
        int a = Integer.parseInt(s);
        System.out.println(a);
        if (isOdd(a))
            System.out.println("å¥‡æ•°");
        else {
            System.out.println("å¶æ•°");
        }
    }

    public static boolean isOdd(int i) {
        return i % 2 == 1;
    }
}
```

ç»“æœ:

1. å½“è¾“å…¥æ­£æ•´æ•°æ—¶, å¯ä»¥æ­£ç¡®åˆ¤æ–­å¥‡å¶æ€§;
2. å½“è¾“å…¥è´Ÿæ•´æ•°æ—¶, ç»“æ„éƒ½ä¸º false;

è§£é‡Š:  
% è¿™ä¸ªè¿ç®—ç¬¦çš„ç»“æœ, æ˜¯æ ¹æ®å‰ä¸€ä¸ªæ•°å€¼çš„æ­£è´Ÿæ€§æ¥åˆ¤æ–­, å¦‚æœæ˜¯è´Ÿæ•°, ç»“æœå°±æ˜¯è´Ÿæ•°; æ‰€ä»¥å½“è¾“å…¥çš„å€¼æ˜¯è´Ÿæ•°æ—¶, ç»“æœéƒ½æ˜¯è´Ÿæ•°, è¿”å›çš„ç»“æœæ˜¯ false;

æ”¹è¿›:

1. åªè¦ `i % 2` çš„ç»“æœä¸ä¸ºé›¶, i å°±æ˜¯ä¸€ä¸ªå¥‡æ•°;

```java
public static boolean isOdd(int i) {
        return i % 2 != 0;
}
```

2. ç”¨æŒ‰ä½äº (&) è¿ç®—ç¬¦ `i & 1` ç»“æœå¦‚æœä¸º `1`, åˆ™ `i` ä¸ºå¥‡æ•°, ç»“æœä¸º `0`, åˆ™ `i` ä¸ºå¶æ•°

```java
public static boolean isOdd(int i) {
        return i & 1 == 1;
}
```

**% æ“ä½œç¬¦è¯¦è§£:**  
å¦‚æœæœ‰:  
a: int ç±»å‹  
b: é 0 çš„ int ç±»å‹  
åˆ™æœ‰æ’ç­‰å¼:`(a / b)*b + (a % b) == a;` æˆç«‹

- å¦‚æœ `a` ä¸ºæ­£æ•´æ•°,`b` ä¸ºæ­£æ•´æ•°; ç­‰å¼æˆç«‹;
- å¦‚æœ `a` ä¸ºæ­£æ•´æ•°,`b` ä¸ºè´Ÿæ•´æ•°; ä¸ºäº†ä¿è¯ç­‰å¼æˆç«‹,`a % b` çš„ç»“æœå¿…é¡»ä¸ºæ­£æ•°;
- å¦‚æœ `a` ä¸ºè´Ÿæ•´æ•°,`b` ä¸ºæ­£æ•´æ•°; ä¸ºäº†ä¿è¯ç­‰å¼æˆç«‹,`a % b` çš„ç»“æœå¿…é¡»ä¸ºè´Ÿæ•°;
- å¦‚æœ `a` ä¸ºè´Ÿæ•´æ•°,`b` ä¸ºè´Ÿæ•´æ•°; ä¸ºäº†ä¿è¯ç­‰å¼æˆç«‹,`a % b` çš„ç»“æœå¿…é¡»ä¸ºè´Ÿæ•°;

ç”±æ­¤å¯ä»¥å¾—å‡º, % è¿ç®—ç¬¦å¾—å‡ºçš„ç»“æœéƒ½æ˜¯æ ¹æ® `%` å‰é¢çš„æ•°å€¼çš„æ­£è´Ÿæ€§ç»™å®šç»“æœçš„æ­£è´Ÿæ€§.

## [Javaç¼–ç¨‹ï¼šç»“æ„åŒ–ä¸é¢å‘å¯¹è±¡çš„å¯¹å†³](https://blog.dong4j.site/posts/c8b315d3.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

- ç†è§£ç»“æ„åŒ–ç¼–ç¨‹å’Œé¢å‘å¯¹è±¡ç¼–ç¨‹çš„åŒºåˆ«
- æŒæ¡å¦‚ä½•ç¼–å†™ java ç±»
- æŒæ¡å¦‚ä½•å®ä¾‹åŒ–å¯¹è±¡
- æŒæ¡å¦‚ä½•è®¿é—®å¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•
- ç†è§£ this å¼•ç”¨
- æŒæ¡å¦‚ä½•ä½¿ç”¨åŒ…ç»„ç»‡ç±»

##### ç»“æ„åŒ–ç¼–ç¨‹

æŒ‰ç…§æ­¥éª¤æ¥ç¼–å†™ä»£ç   
å›´ç»•è¦è§£å†³çš„ä»»åŠ¡æ¥è®¾è®¡

##### é¢å‘å¯¹è±¡ç¼–ç¨‹ (Object Oriented Programming)

ç¨‹åºä¸æ˜¯å›´ç»•è¦è§£å†³ä»»åŠ¡æ¥è®¾è®¡, è€Œæ˜¯å›´ç»•è¦è§£å†³çš„é—®é¢˜ä¸­çš„å¯¹è±¡æ¥è®¾è®¡  
å»ºç«‹å¯¹è±¡æ¨¡å‹, å°†é—®é¢˜åŸŸåŒ–ä¸ºä¸åŒçš„å¯¹è±¡å»å¤„ç†

**ä¸‡ç‰©çš†å¯¹è±¡, å¯¹è±¡å› å…³æ³¨è€Œäº§ç”Ÿ**

å¯¹è±¡ç»„æˆ

1. å±æ€§

- å¯¹è±¡èº«ä¸Šçš„å€¼æ•°æ®

2. è¡Œä¸º

- è¯¥å¯¹è±¡èƒ½å¤Ÿåšä»€ä¹ˆ

ç±»æ˜¯å¯¹è±¡çš„æŠ½è±¡, å¯¹è±¡æ˜¯ç±»çš„å®ä¾‹  
ç±»æ˜¯å…·æœ‰ç›¸åŒå±æ€§å’Œè¡Œä¸ºçš„ä¸€ç»„å¯¹è±¡çš„æŠ½è±¡

#### é¢å‘å¯¹è±¡ç‰¹ç‚¹

1. å°è£…
2. ç»§æ‰¿
3. å¤šæ€
4. æ–¹æ³•é‡è½½
5. æ–¹æ³•è¦†ç›–

**åŸºæœ¬æ•°æ®ç±»å‹å’Œå¼•ç”¨ç±»å‹çš„ä¼ é€’çš„ç‰¹ç‚¹**

- å€¼ä¼ é€’ï¼š(å½¢å¼å‚æ•°ç±»å‹æ˜¯åŸºæœ¬æ•°æ®ç±»å‹)ï¼šæ–¹æ³•è°ƒç”¨æ—¶ï¼Œå®é™…å‚æ•°æŠŠå®ƒçš„å€¼ä¼ é€’ç»™å¯¹åº”çš„å½¢å¼å‚æ•°ï¼Œå½¢å¼å‚æ•°åªæ˜¯ç”¨å®é™…å‚æ•°çš„å€¼åˆå§‹åŒ–è‡ªå·±çš„å­˜å‚¨å•å…ƒå†…å®¹ï¼Œæ˜¯ä¸¤ä¸ªä¸åŒçš„å­˜å‚¨å•å…ƒï¼Œæ‰€ä»¥æ–¹æ³•æ‰§è¡Œä¸­å½¢å¼å‚æ•°å€¼çš„æ”¹å˜ä¸å½±å“å®é™…å‚æ•°çš„å€¼ã€‚
- å¼•ç”¨ä¼ é€’ï¼š(å½¢å¼å‚æ•°ç±»å‹æ˜¯å¼•ç”¨æ•°æ®ç±»å‹å‚æ•°)ï¼šä¹Ÿç§°ä¸ºä¼ åœ°å€ã€‚æ–¹æ³•è°ƒç”¨æ—¶ï¼Œå®é™…å‚æ•°æ˜¯å¯¹è±¡ (æˆ–æ•°ç»„)ï¼Œè¿™æ—¶å®é™…å‚æ•°ä¸å½¢å¼å‚æ•°æŒ‡å‘åŒä¸€ä¸ªåœ°å€ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œä¸­ï¼Œå¯¹å½¢å¼å‚æ•°çš„æ“ä½œå®é™…ä¸Šå°±æ˜¯å¯¹å®é™…å‚æ•°çš„æ“ä½œï¼Œè¿™ä¸ªç»“æœåœ¨æ–¹æ³•ç»“æŸåè¢«ä¿ç•™äº†ä¸‹æ¥ï¼Œæ‰€ä»¥æ–¹æ³•æ‰§è¡Œä¸­å½¢å¼å‚æ•°çš„æ”¹å˜å°†ä¼šå½±å“å®é™…å‚æ•°

**å¯¹è±¡çš„é”€æ¯**

- äº§ç”Ÿäº†å¯¹è±¡, ç”¨å®Œä¹‹å, è‡ªç„¶è¦å…³å¿ƒå®ƒçš„é”€æ¯
- å¦‚æœä¸€ä¸ªå¯¹è±¡æ²¡æœ‰ä»»ä½•å¼•ç”¨, é‚£ä¹ˆå°±å…·å¤‡äº†è¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶çš„æ¡ä»¶
- å¦‚æœæˆ‘ä»¬æƒ³ä¸»åŠ¨é€šçŸ¥åƒåœ¾å›æ”¶æœºåˆ¶ä¸€ä¸ªå¯¹è±¡, åªéœ€è¦ â€“> å¯¹è±¡ = null;

åªç”¨ä¸€æ¬¡çš„å¯¹è±¡, å¯ä»¥ç”¨åŒ¿åå¯¹è±¡, å°±æ˜¯æ²¡æœ‰å¼•ç”¨æŒ‡å‘è¿™ä¸ªå¯¹è±¡çš„å¯¹è±¡

**è®¿é—®ä¿®é¥°ç¬¦**  
public: è°éƒ½å¯ä»¥æ“æ§  
private: é™¤äº†è‡ªå·±, è°éƒ½ä¸èƒ½æ“ä½œ  
é»˜è®¤: åŒä¸€ä¸ªåŒ…å†…å¯ä»¥æ“ä½œ  
protected: åŒåŒ…æˆ–è€…ä¹‹å†…å¯ä»¥æ“ä½œ

**this:**

1. å¯¹å½“å‰ç±»çš„å¼•ç”¨;
2. æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªéšå«çš„ this å˜é‡, å®ƒå¯ä»¥è®¿é—®ç±»çš„æ‰€æœ‰ä¿¡æ¯;
3. æ„é€ æ–¹æ³•çš„ç›¸äº’è°ƒç”¨, å¿…é¡»æ”¾åœ¨æ„é€ æ–¹æ³•å†…çš„ç¬¬ä¸€ä¸ªè¯­å¥;

this å…³é”®å­—çš„ç¬¬äºŒç§ç”¨æ³•  
åœ¨é‡è½½çš„æ„é€ å™¨ä¸­, ä¸ºäº†é‡å¤åˆ©ç”¨ä»£ç 

```java
class Gril {
    private int age;
    private String name;
    //æ„é€ æ–¹æ³•
    public Gril(int age ,String name){
        this(name);
        this.age = age;
        //this.name = name;
    }
    public Gril(String name){
        this.name = name;
    }
    public Gril(){

    }
    //ç¡è§‰çš„æ–¹æ³•
    public void sleep(Car car){
        System.out.println("åœ¨è½¦ä¸Šç¡è§‰");
    }
    public void sleep(Bed bed){
        System.out.println("åœ¨åºŠä¸Šç¡è§‰");
    }
    public void sleep(){
        System.out.println("åœ¨é‡å¤–ç¡è§‰");
    }
}
```

**JavaBean è§„èŒƒ:**  
ä¸ºç§æœ‰å±æ€§æä¾›ç¬¦åˆå‘½åè§„èŒƒçš„ set å’Œ get æ–¹æ³•

1. JavaBean å¿…é¡»æ–¹æ³•ä¸€ä¸ªåŒ…ä¸­
2. JavaBean å¿…é¡»å£°æ˜ä¸º public class
3. JavaBean çš„æ‰€æœ‰å±æ€§å¿…é¡»å£°æ˜ä¸º private
4. é€šè¿‡ setter å’Œ getter æ–¹æ³•è®¾å€¼å’Œå–å€¼
5. é€šè¿‡ JSP è°ƒç”¨æ˜¯, åˆ™éœ€è¦ä¸€ä¸ªæ— å‚çš„æ„é€ æ–¹æ³•
6. ç¼–å†™ä»£ç è¦ä¸¥æ ¼éµå¾ª Java ç¨‹åºçš„å‘½åè§„èŒƒ

**å¯¹è±¡å’Œå¯¹è±¡çš„å…³ç³»**

1. **has a**(æ‹¥æœ‰ä¸€ä¸ª):  
   å¦‚æœ a å¯¹è±¡å’Œ b å¯¹è±¡æ˜¯è¿™ç§å…³ç³», åˆ™æŠŠ b ä½œä¸º a çš„å±æ€§
2. **use a**(ä½¿ç”¨ä¸€ä¸ª):  
   å¦‚æœ a åªæ˜¯ä½¿ç”¨ä¸€ä¸‹ b å¯¹è±¡, åˆ™ä½œä¸ºå±€éƒ¨å˜é‡  
   2 ç§æ–¹æ³•: new ä¸€ä¸ªæ–°å¯¹è±¡; é€šè¿‡å‚æ•°ä¼ é€’

### ç›®æ ‡

1. æŒæ¡æ–¹æ³•çš„ç”³æ˜ä¸è°ƒç”¨
2. ç†è§£æ–¹æ³•è°ƒç”¨æ ˆ
3. ç†è§£æ–¹æ³•é‡è½½
4. ç†è§£æ„é€ å™¨

### 1. æ–¹æ³•è°ƒç”¨æ ˆ (stack)

- é€‰æ‹©è¯­å¥
- å¾ªç¯è¯­å¥
- æ–¹æ³•çš„è°ƒç”¨ (å…ˆè¿›åå‡º)
  - å½“ä¸€ä¸ªæ–¹æ³•æ­£åœ¨æ‰§è¡Œæ—¶çš„ä¸‰ç§æƒ…å†µ
    - æ–¹æ³•è¿”å›ä¸€ä¸ªå€¼, åœ¨è¿™ç§æƒ…å†µä¸‹, ä¸€ä¸ªåŸºæœ¬æ•°æ®ç±»å‹æˆ–å¼•ç”¨ç±»å‹è¢«ä¼ å›ç»™æ–¹æ³•çš„è°ƒç”¨è€…
    - æ–¹æ³•ä¸è¿”å›, è¿”å›å€¼è¢«å£°æ˜ä¸º void
    - æ–¹æ³•æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ç»™æ–¹æ³•çš„è°ƒç”¨è€…

### 2. æ–¹æ³•çš„ç”Ÿå‘½å’Œè°ƒç”¨

#### æ–¹æ³•ç­¾å

- æ–¹æ³•çš„ç­¾ååŒ…æ‹¬æ–¹æ³•å, å‚æ•°åˆ—è¡¨, è¿”å›å€¼çš„æ•°æ®ç±»å‹  
   `public static void main(String[] args)`

  - è®¿é—®ä¿®é¥°ç¬¦
  - å¯é€‰ä¿®é¥°ç¬¦
  - è¿”å›ç±»å‹
  - æ–¹æ³•å
  - å½¢å‚åˆ—è¡¨
    - ä¸ªæ•°, é¡ºåº, ç±»å‹
  - æŠ›å‡ºçš„
  - å¼‚å¸¸åˆ—è¡¨

### 3. æ–¹æ³•é‡è½½

åŒä¸€ä¸ªç±»ä¸­çš„æ–¹æ³•åç›¸åŒ, å‚æ•°åˆ—è¡¨ä¸åŒ; å’Œè¿”å›å€¼ç±»å‹æ— å…³  
**ä¸ºä»€ä¹ˆä¸èƒ½ç”¨è¿”å›å€¼ç±»å‹ç±»åŒºåˆ†é‡è½½**  
æ¯”å¦‚ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•ï¼Œè™½ç„¶ä»–ä»¬æœ‰åŒæ ·çš„åå­—å’Œå½¢å¼ï¼Œä½†å´å¾ˆå®¹æ˜“åŒºåˆ†å®ƒä»¬ï¼š  
Java ä»£ç  `void f(){}` `int f(){reurn1;}`  
åªè¦ç¼–è¯‘å™¨å¯ä»¥æ ¹æ®è¯­å¢ƒæ˜ç¡®åˆ¤æ–­å‡ºè¯­ä¹‰ï¼Œæ¯”å¦‚åœ¨ int x =f() ä¸­ï¼Œé‚£ä¹ˆçš„ç¡®å¯ä»¥æ®æ­¤åŒºåˆ†é‡è½½æ–¹æ³•ã€‚  
ä¸è¿‡ï¼Œæœ‰æ—¶ä½ å¹¶ä¸å…³å¿ƒæ–¹æ³•çš„è¿”å›å€¼ï¼Œä½ æƒ³è¦çš„æ˜¯æ–¹æ³•è°ƒç”¨çš„å…¶ä»–æ•ˆæœï¼Œè¿™æ—¶ä½ å¯èƒ½ä¼šè°ƒç”¨æ–¹æ³•è€Œå¿½ç•¥å…¶è¿”å›å€¼ã€‚  
æ‰€ä»¥ï¼Œå¦‚æœåƒä¸‹é¢è¿™æ ·è°ƒç”¨æ–¹æ³•ï¼šf()ï¼›æ­¤æ—¶ Java å¦‚ä½•æ‰èƒ½åˆ¤æ–­è¯¥è°ƒç”¨å“ªä¸€ä¸ª f() å‘¢ï¼Ÿ  
å› æ­¤ï¼Œæ ¹æ®æ–¹æ³•çš„è¿”å›å€¼æ¥åŒºåˆ†é‡è½½æ–¹æ³•æ˜¯è¡Œä¸é€šçš„

### 4. æ„é€ å™¨

`è®¿é—®ä¿®é¥°ç¬¦ ç±»å(){}`

1. æ²¡æœ‰è¿”å›ç±»å‹
2. æ–¹æ³•åå’Œç±»åä¸€æ ·
3. å¦‚æœä¸å†™, ç³»ç»Ÿä¼šé»˜è®¤æä¾›ä¸€ä¸ªæ„é€ æ–¹æ³•
4. å¦‚æœå†™äº†, ç³»ç»Ÿå°±ä¸ä¼šæä¾›ä»»ä½•æ„é€ æ–¹æ³•

**ä½œç”¨:** äº§ç”Ÿå¯¹è±¡  
new ä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™æ„é€ å™¨æ‰€è¦åšçš„äº‹

1. åˆ›å»ºç©ºé—´
2. åˆ’åˆ†å±æ€§
3. åˆå§‹åŒ–å€¼
4. æ‰§è¡Œæ„é€ æ–¹æ³•å†…çš„è¯­å¥

## [Javaæ­ç§˜ï¼šæ·±å…¥æµ…å‡ºå±€éƒ¨å˜é‡ä¸å¸¸é‡æ± ](https://blog.dong4j.site/posts/aa0f783a.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

è¢«è®¿é—®è¢«è°ƒç”¨çš„èŒƒå›´

- public : å…¨éƒ¨
- é»˜è®¤ : åŒåŒ…
- protected : åŒåŒ…æˆ–æœ‰ç»§æ‰¿å…³ç³»çš„ç±»
- private : åªæœ‰åŒç±»

#### åœ¨ A ç±»ä¸­å®šä¹‰å±æ€§å’Œæ–¹æ³•:

- public: è¿™ä¸ªç±»çš„å®ä¾‹åŒ–å¯¹è±¡å¯ä»¥è®¿é—®;
- é»˜è®¤: å¦‚æœåœ¨åŒåŒ…ä¸‹å®šä¹‰ä¸€ä¸ªä¸»ç±», ç„¶ååœ¨ä¸»ç±»çš„ä¸»æ–¹æ³•é‡Œé¢ new A çš„ä¸€ä¸ªå¯¹è±¡å‡ºæ¥, åˆ™è¿™ä¸ªå¯¹è±¡å¯ä»¥è®¿é—®è¢«é»˜è®¤ä¿®é¥°çš„å±æ€§å’Œæ–¹æ³•;
- protected: åœ¨åŒä¸€ä¸ªåŒ…ä¸‹çš„ç±»ä¸­ new çš„ A ç±»å¯¹è±¡å’Œç»§æ‰¿äº† A ç±»çš„ç›¸åŒæˆ–ä¸åŒåŒ…ä¸‹çš„å­ç±»ä¸­ new A ç±»å¯¹è±¡, è¿™ä¸ªå¯¹è±¡èƒ½è°ƒç”¨ A ç±»ä¸­æ‰€æœ‰çš„å±æ€§å’Œæ–¹æ³• (ä¸åŒåŒ…ä¸‹æ²¡æœ‰ç»§æ‰¿å…³ç³»çš„ç±»ä¸èƒ½è®¿é—®)
- private: åªæœ‰è¿™ä¸ªç±»ä¸­çš„å±æ€§å’Œæˆå‘˜æ–¹æ³•èƒ½è®¿é—®

### geter å’Œ setter æ›´æ·±å…¥ç†è§£

- å½“æŠŠç±»çš„å±æ€§å’Œæ–¹æ³•è®¿é—®æƒé™è®¾ç½®ä¸º private æ—¶, ä¸€èˆ¬éƒ½æä¾›ä¸Šé¢ 2 ä¸ªå…¬å…±æ–¹æ³•;  
   åœ¨è¿™ 2 ä¸ªæ–¹æ³•ä½“å†…, å¯ä»¥æ·»åŠ ä¸€äº›é™åˆ¶ä»£ç ;  
   æ¯”å¦‚è¯´ setter æ–¹æ³•, éœ€è¦ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç æ‰æœ‰æƒé™ä¿®æ”¹  
   getter ä¹Ÿå¯ä»¥è¿™ä¹ˆåš, è¿˜å¯ä»¥åœ¨è¿”å›å€¼çš„æ—¶å€™åšä¸€äº›åŠ¨ä½œ;  
   è¿™å°±æ˜¯éšè—.
- ä¹Ÿå¯ä»¥ç”¨ private ä¿®é¥° setter æ–¹æ³•, é‚£ä¹ˆè¿™ä¸ªå±æ€§å°±æ˜¯åªè¯»;
- ç”¨ private ä¿®é¥° getter æ–¹æ³•, è¿™ä¸ªå±æ€§å°±æ˜¯åªå†™;

#### å°è£…çš„å¥½å¤„

1. ç±»çš„æˆå‘˜å˜é‡å¯ä»¥æˆä¸ºåªè¯»æˆ–åªå†™
2. ç±»å¯ä»¥å¯¹å­˜å‚¨åœ¨å…¶æˆå‘˜å˜é‡ä¸­çš„å†…å®¹æœ‰ä¸€ä¸ªæ•´ä½“çš„æ§åˆ¶
3. ç±»çš„ç”¨æˆ·ä¸éœ€è¦çŸ¥é“ç±»æ˜¯å¦‚ä½•å­˜å‚¨æ•°æ®çš„

### static å…³é”®å­— (ç±»çº§åˆ«çš„, ä¸å¯¹è±¡æ— å…³)

1. static ä¿®é¥°çš„å…¨å±€å˜é‡å«é™æ€å˜é‡, ä¹Ÿå«ç±»å˜é‡, è¢«æ‰€æœ‰çš„å¯¹è±¡æ‰€å…±äº«, ç”¨ç±»å. å±æ€§è®¿é—®;
2. static ä¿®é¥°çš„æ–¹æ³•å«é™æ€æ–¹æ³•, å³ç±»æ–¹æ³•; å¯ä»¥ç›´æ¥ç”¨ç±»å. æ–¹æ³•è®¿é—®;
3. ç±»åªèƒ½ä½¿ç”¨ç±»æ–¹æ³•, è€Œä¸èƒ½ä½¿ç”¨é™æ€å˜é‡;
4. ç±»åŠ è½½ä»¥åå°±å­˜åœ¨å†…å­˜ä¸­äº†, åœ¨ mian æ–¹æ³•æ‰§è¡Œä¹‹å‰;
5. ç”¨ static ä¿®é¥°çš„å˜é‡å­˜åœ¨å †å†…å­˜çš„æ•°æ®æ®µçš„é™æ€åŒºä¸­

> public static final int MAX = 100;

å¸¸é‡å±æ€§å®šä¹‰ä¸º static, èŠ‚çº¦ç©ºé—´  
final: å› ä¸ºç”¨ final ä¿®é¥°, æ‰€ä»¥æ˜¯ä¸ªå¸¸é‡  
public: å› ä¸ºæ˜¯å¸¸é‡, æ‰€ä»¥ä¸èƒ½æ›´æ”¹, public ä¿®é¥°ç»™åˆ«äººçœ‹ä¹Ÿæ²¡äº‹  
static: å…±äº«, è¿™æ ·å°±ä¸ç”¨ new å‡ºæ¥æ‰èƒ½ä½¿ç”¨;

- é™æ€æ–¹æ³•åªèƒ½è®¿é—®æˆ–è°ƒç”¨é™æ€å±æ€§å’Œé™æ€æ–¹æ³•
- éé™æ€æ–¹æ³•æ³•æ—¢èƒ½è®¿é—®è°ƒç”¨éé™æ€å±æ€§å’Œæ–¹æ³•, ä¹Ÿèƒ½è®¿é—®é™æ€æ–¹æ³•å’Œå±æ€§  
   åŸå› : é™æ€å±æ€§å’Œæ–¹æ³•åœ¨ç±»åŠ è½½çš„æ—¶å€™å°±åŠ è½½åˆ°å†…å­˜ä¸­äº†, è€Œéé™æ€å±æ€§å’Œæ–¹æ³•å¿…é¡»ç»‘å®šåœ¨å¯¹è±¡ä¸Š, è€Œå¯¹è±¡å¿…é¡»å…ˆå®ä¾‹åŒ–æ‰èƒ½è°ƒç”¨;  
   å¦‚æœç”¨é™æ€æ–¹æ³•è®¿é—®éé™æ€å±æ€§, ä½†æ˜¯å†…å­˜ä¸­å´ä¸å­˜åœ¨éé™æ€å±æ€§, æ‰€ä»¥ç¼–è¯‘å™¨ä¼šæŠ¥é”™.

### ä»£ç å—

#### é™æ€åˆå§‹åŒ–å—

- è¯­æ³•: static {è¯­å¥ 1; è¯­å¥ 2;â€¦;};
- è°ƒç”¨é¡ºåº: å½“ç±»è¢« JVM çš„ç±»åŠ è½½å™¨åŠ è½½çš„æ—¶å€™æ‰§è¡Œ,  
   åªåŠ è½½ä¸€æ¬¡, å› ä¸º JVM åªåŠ è½½ä¸€æ¬¡ç±».

#### å®ä¾‹åŒ–åˆå§‹åŒ–å—

- è¯­æ³•:{è¯­å¥ 1; è¯­å¥ 2;â€¦;};
- è°ƒç”¨é¡ºåº: åœ¨ç±»çš„å¯¹è±¡æ¯æ¬¡å®ä¾‹åŒ–çš„æ—¶å€™æ‰§è¡Œä¸€æ¬¡, åœ¨æ„é€ å™¨ä¹‹å‰è°ƒç”¨;

```java
class A {
    public String name = "æˆå‘˜å±æ€§" ;
    static {
        System.out.println("é™æ€åˆå§‹åŒ–å—");
    }

    {
        this.name = "name";
        this.age  = 26;
        System.out.println("å®ä¾‹åˆå§‹åŒ–å—å†…");
        System.out.println(this.name);
        System.out.println(this.age);
    }
    public int age = 10;

    public A ( ) {
        System.out.println("æ„é€ æ–¹æ³•å†…");
        System.out.println(name);
        System.out.println(age);
    }
}
//ä¸»æ–¹æ³•
class ClassName {
    public static void main(String[] args) {
        new A();
    }
}

è¾“å‡ºç»“æœ :
é™æ€åˆå§‹åŒ–å—
å®ä¾‹åˆå§‹åŒ–å—
name
æ„é€ æ–¹æ³•å†…
name
```

æ­¥éª¤:

1. æ‰§è¡Œåˆ° `new A();` æ—¶, åŠ è½½ A.class åˆ°å†…å­˜ä¸­;
2. static éšç€ç±»çš„åŠ è½½è€Œåˆ›å»º (åœ¨å †å†…å­˜çš„æ•°æ®æ®µä¸­çš„é™æ€åŒºä¸­, å­˜æ”¾çš„æ˜¯é™æ€å˜é‡å’Œé™æ€æ–¹æ³•, å¸¸é‡å­˜æ”¾åœ¨å †å†…å­˜çš„æ•°æ®æ®µçš„å¸¸é‡æ± ä¸­)
3. è¾“å‡º `é™æ€åˆå§‹åŒ–ä»£ç å—`
4. æ‰§è¡Œæ„é€ æ–¹æ³•æ—¶è¦åšçš„äº‹:

- åœ¨å †å†…å­˜ä¸­ç”³è¯·å†…å­˜;(size = int + String)
- åˆ†é…è¿™å—å†…å­˜;(ç»™ name åˆ†é… 4 å­—èŠ‚ç©ºé—´, å› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå¼•ç”¨; ç»™ age åˆ†é… 4 ä¸ªå­—èŠ‚);
- åˆå§‹åŒ–è¿™å—å†…å­˜ä¸­çš„å˜é‡,`;age=10;`
- è°ƒç”¨å®ä¾‹åˆå§‹åŒ–ä»£ç å—, æ‰§è¡Œä»£ç å—ä¸­çš„è¯­å¥ `name = name,age=26;`
- æ‰§è¡Œå®ä¾‹ä»£ç å—åé¢çš„è¯­å¥;`public int age = 10;`
- æ‰§è¡Œæ„é€ æ–¹æ³•å†…çš„è¯­å¥ è¾“å‡º `name` å’Œ `age` çš„å€¼;

### å†…éƒ¨ç±» (å…ˆå¤§æ¦‚äº†è§£)

- åœ¨ç±»çš„é‡Œé¢å†å®šä¹‰ä¸€ä¸ªç±», è¿™ä¸ªç±»å°±å«å†…éƒ¨ç±»;
- å®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç±»;
- å¯ä»¥äº§ç”Ÿå¯¹è±¡ä½¿ç”¨;
- ç¼–è¯‘ååˆç‹¬ç«‹çš„ class æ–‡ä»¶;
  - classA$1classB â€“> æ˜¯å±€éƒ¨å†…éƒ¨ç±»;(æ¯”æˆå‘˜å†…éƒ¨ç±»å°‘äº†ä¸€ä¸ªæ•°å­—, å› ä¸ºä¸€ä¸ªç±»æœ‰å¤šä¸ªæ–¹æ³•, åœ¨ä¸åŒçš„æ–¹æ³•é‡Œé¢å¯ä»¥å®šä¹‰ç›¸åŒåå­—çš„å†…éƒ¨ç±», ä¸ºäº†åŒºåˆ†, ç¼–è¯‘å™¨è‡ªåŠ¨ä¸ºæˆ‘ä»¬æ·»åŠ ä½ ä¸€ä¸ªæ•°å­—ä½œä¸ºåŒºåˆ†)
  - classA$classB â€“> æ˜¯æˆå‘˜å†…éƒ¨ç±»;(æŠŠæˆå‘˜å†…éƒ¨ç±»ä½œä¸ºå¤–éƒ¨ç±»çš„å±æ€§, å±æ€§å½“ç„¶ä¸èƒ½é‡åäº†, æ‰€ä»¥æˆå‘˜å†…éƒ¨ç±»çš„åå­—ä¸èƒ½ç›¸åŒ)

#### åˆ†ç±»

- æˆå‘˜å†…éƒ¨ç±» â€“> å®šä¹‰åœ¨å¤–éƒ¨ç±»ä¸­æ–¹æ³•å¤–é¢çš„ç±»;
  - é™æ€å†…éƒ¨ç±»:(æˆå‘˜å†…éƒ¨ç±»çš„ä¸€ç§)
- å±€éƒ¨å†…éƒ¨ç±» â€“> å®šä¹‰åœ¨å¤–éƒ¨ç±»çš„æ–¹æ³•é‡Œé¢, å®šä¹‰çš„æ—¶å€™ä¸èƒ½åŠ è®¿é—®ä¿®é¥°ç¬¦
  - åŒ¿åå†…éƒ¨ç±»: æ²¡åå­—, ä¸»è¦ç”¨äºå®ç°æ¥å£çš„æ–¹æ³•.

**ä¸ºä»€ä¹ˆå±€éƒ¨å†…éƒ¨ç±»ä¸èƒ½ç”¨è®¿é—®ä¿®é¥°ç¬¦ä¿®é¥°?**

> ä»å†…å­˜ä¸­çœ‹ï¼Œå½“æ–¹æ³•é‡Œçš„å±€éƒ¨å˜é‡æ‰€åœ¨æ–¹æ³•ç»“æŸæ—¶ï¼Œè¯¥å˜é‡å³åœ¨æ ˆå†…å­˜ä¸­æ¶ˆå¤±ï¼›è€Œå†…éƒ¨ç±»å…¶å®æ˜¯ä¸€ä¸ªç±»ï¼Œåªæœ‰å†…å­˜ä¸­å¯¹å®ƒçš„æ‰€æœ‰å¼•ç”¨éƒ½æ¶ˆå¤±åï¼Œè¯¥å†…éƒ¨ç±»æ‰â€æ­»äº¡â€ï¼Œå³å†…éƒ¨ç±»çš„ç”Ÿå‘½å‘¨æœŸå¯èƒ½æ¯”å±€éƒ¨å˜é‡é•¿ã€‚å¦‚æœå±€éƒ¨å†…éƒ¨ç±»èƒ½è®¿é—®ä¸€èˆ¬çš„å±€éƒ¨å˜é‡ï¼Œåˆ™åœ¨å¤šçº¿ç¨‹ä¸­ï¼Œå¯èƒ½å½“æ–¹æ³•ç»“æŸåï¼Œå±€éƒ¨å†…éƒ¨ç±» (æ˜¯çº¿ç¨‹ç±»æ—¶) è¿˜åœ¨ä½¿ç”¨å±€éƒ¨å˜é‡ã€‚ä¸ºäº†é¿å…æ–¹æ³•å†…çš„å˜é‡è„±ç¦»æ–¹æ³•è€Œå­˜åœ¨çš„ç°è±¡å‘ç”Ÿï¼Œäºæ˜¯ java è§„å®šå±€éƒ¨å†…éƒ¨ç±»ä¸èƒ½è®¿é—®ä¸€èˆ¬çš„å±€éƒ¨å˜é‡ã€‚ä½†èƒ½è®¿é—®è¢« final ä¿®é¥°çš„å±€éƒ¨å˜é‡ã€‚å› ä¸ºå¸¸é‡æ”¾åœ¨å †å†…å­˜ä¸­çš„æ•°æ®æ®µçš„å¸¸é‡æ± ä¸­

## [æŒæ¡Javaæ•°ç»„ï¼šå…¥é—¨åˆ°è¿›é˜¶æŒ‡å—](https://blog.dong4j.site/posts/340249a9.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

1.  æ•°ç»„æ˜¯ä¸€ä¸ªè¿ç»­çš„å†…å­˜ç©ºé—´, å­˜å‚¨äº†å¤šä¸ªç›¸åŒæ•°æ®ç±»å‹çš„æ•°æ®, æ˜¯å¯¹è¿™äº›æ•°æ®çš„ç»Ÿä¸€ç®¡ç†; é‡Œé¢çš„å…ƒç´ å¯ä»¥æ˜¯ä»»ä½•ç±»å‹, åŒ…æ‹¬åŸºæœ¬ç±»å‹å’Œå¼•ç”¨ç±»å‹;
2.  æ•°ç»„ä¸­çš„å…ƒç´ çš„å˜é‡æ˜¯å¼•ç”¨ç±»å‹, æ•°ç»„ä¹Ÿå¯ä»¥çœ‹æˆæ˜¯å¯¹è±¡ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ç›¸å½“äºè¯¥å¯¹è±¡çš„æˆå‘˜å˜é‡;
3.  æ•°ç»„å˜é‡å­˜æ”¾çš„æ˜¯è¿ç»­ç©ºé—´ç¬¬ä¸€ä¸ªå…ƒç´ çš„åœ°å€;
4.  ä¸ºä»€ä¹ˆæ•°ç»„ä¸‹æ ‡è¦ä» 0 å¼€å§‹
    - æ•°ç»„æ˜¯ä¸€æ®µè¿ç»­çš„ç©ºé—´ï¼Œè¦æ±‚ a[i] å°±æ˜¯æ±‚å®ƒçš„åœ°å€ï¼Œç„¶åæ‰¾åˆ°å®ƒã€‚å¦‚æœä» 0 å¼€å§‹ï¼Œåˆ™ a[i] çš„åœ°å€ = é¦–åœ°å€ + i _ æ¯ä¸ªæ•°æ®æ‰€å çš„é•¿åº¦ï¼›å¦‚æœä» 1 å¼€å§‹, åˆ™ a[i] çš„åœ°å€ = é¦–åœ°å€ + (i-1)_ æ¯ä¸ªæ•°æ®æ‰€å çš„é•¿åº¦
5.  æ•°ç»„ä¸­å˜é‡çš„ç±»å‹ , å°±æ˜¯å£°æ˜æ•°ç»„æ—¶å®šä¹‰çš„ç±»å‹.
6.  java ä¸­å£°æ˜æ•°ç»„æ˜¯ä¸èƒ½æŒ‡å®šé•¿åº¦; æ•°ç»„åˆ›å»ºå, é•¿åº¦ä¸å¯å˜åŒ–.
7.  java ä¸­æ•°ç»„ä¸èƒ½è¶Šç•Œ, å¦åˆ™ç¼–è¯‘å™¨ä¼šæŠ¥æ•°ç»„è¶Šç•Œé”™è¯¯.(ArrayIndexOutOfBoundsException)
8.  æ•°ç»„å­˜å‚¨åœ¨ Java å †çš„è¿ç»­å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥å¦‚æœä½ åˆ›å»ºä¸€ä¸ªå¤§çš„ç´¢å¼•ï¼Œä½ å¯ä»¥æœ‰è¶³å¤Ÿçš„å †ç©ºé—´ç›´åˆ°æŠ›å‡º OutofmemoryErrorï¼Œå› ä¸ºè¯·æ±‚çš„å†…å­˜å¤§å°åœ¨è¿ç»­çš„å†…å­˜ç©ºé—´ä¸å¯ç”¨ã€‚
9.  æ•°ç»„åˆ›å»ºå, æ¯ä¸ªå…ƒç´ éƒ½ä¼šè‡ªåŠ¨åˆå§‹åŒ–

| ç±»å‹   | byet | short | int | long | float | double |  char   | booble | å¼•ç”¨ç±»å‹ |
| :----- | ---: | :---: | :-: | :--: | :---: | :----: | :-----: | :----: | -------- |
| é»˜è®¤å€¼ |    0 |   0   |  0  |  0   | 0.0f  |  0.0d  | `u0000` | false  | null     |

#### ä¸€ç»´æ•°ç»„

1.  å®šä¹‰  
    `type[] arrayName`; æˆ–è€… `type arrayName[];`  
    ä¾‹å¦‚: `int[] intArray;` `double doubleArray[];`
2.  åˆå§‹åŒ–
    - é™æ€åˆå§‹åŒ–  
      `int[] intArray = {1,2,3,4};`  
      `String stringArray[] = {"hello","world"};`  
      `char[] charArray = new char[]{'a','b','c'};`
    - åŠ¨æ€åˆå§‹åŒ–
      - ç®€å•ç±»å‹çš„æ•°ç»„  
        `int[] intArray;`  
        `intArray = new int[5];`
      - å¤åˆç±»å‹çš„æ•°ç»„

```java
String[] stringArray = new String[3];
stringArray[0]= new String("How");
stringArray[1]= new String("are");
stringArray[2]= new String("you");
```

3. æ•°ç»„å…ƒç´ çš„å¼•ç”¨  
   æ•°ç»„å…ƒç´ çš„å¼•ç”¨æ–¹å¼ä¸ºï¼š  
   ã€€ã€€ã€€ã€€ã€€ arrayName[index]

index ä¸ºæ•°ç»„ä¸‹æ ‡ï¼Œå®ƒå¯ä»¥ä¸ºæ•´å‹å¸¸æ•°æˆ–è¡¨è¾¾å¼ï¼Œä¸‹æ ‡ä» 0 å¼€å§‹ã€‚æ¯ä¸ªæ•°ç»„éƒ½æœ‰ä¸€ä¸ªå±æ€§ length æŒ‡æ˜å®ƒçš„é•¿åº¦ï¼Œä¾‹å¦‚ï¼šintArray.length æŒ‡æ˜æ•°ç»„ intArray çš„é•¿åº¦

**ä»£ç ä¸¾ä¾‹**  
**1. æ•°ç»„å¯¹è±¡çš„åˆ›å»º**  
æ•°ç»„å = new æ•°ç»„å…ƒç´ ç±»å‹ [æ•°ç»„å…ƒç´ ä¸ªæ•°]  
ä¾‹å¦‚:

```java
public class TestArray{
        public static void main(String args[]){
            int[] arr;
            arr = new int[5];
            for(int i=0;i<5;i++){
                arr[i] = i;
                System.out.println(arr[i]);
            }
        }
    }
```

**å…ƒç´ ä¸ºå¼•ç”¨ç±»å‹çš„æ•°æ®ï¼ˆæ³¨æ„ï¼šå…ƒç´ ä¸ºå¼•ç”¨æ•°æ®ç±»å‹çš„æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½éœ€è¦å®ä¾‹åŒ–ï¼‰**

```java
public class TestArray{
    public static void main(String args[]){
        Student[] student;
        student = new student[3];
        for(int i=0; i<3; i++){
            student[i] = new Student("æå››",89,9527);
            System.out.println("å§“å:"
            +student[i].name
            +"  åˆ†æ•°:"+student[i].score
            +"  å­¦å·:"+student[i].ID);
       }
   }
}
class Student{
    int name,score,ID;
    public Student(String name,
                            int score,
                            int ID){
        this.name = name;
        this.score = score;
        this.ID = ID;
    }
}
```

**2. æ•°ç»„åˆå§‹åŒ–ï¼š**

1. åŠ¨æ€åˆå§‹åŒ–ï¼š  
   æ•°ç»„å®šä¹‰ä¸ä¸ºæ•°ç»„å…ƒç´ åˆ†é…ç©ºé—´å’Œèµ‹å€¼çš„æ“ä½œåˆ†å¼€è¿›è¡Œï¼Œ  
   ä¾‹å¦‚ï¼š

```java
public class TestArray{
        public static void main(String args[]){
            int[] arr = new int[3];
            arr[0] = 1 ;
            arr[1] = 2 ;
            arr[2] = 3 ;

            Student[] student = new Student[3];
            student[0] = new Student("å¼ ä¸‰",87,0528);
            student[1] = new Student("æå››",76,0529);
            student[2] = new Student("èµµå…­",91,0530);
        }
    }

    class Student{
        int name,score,ID;
        public Student(String name,int score,int ID){
            this.name = name;
            this.score = score;
            this.ID = ID;
        }
    }
```

1.  é™æ€åˆå§‹åŒ–  
    åœ¨å®šä¹‰æ•°ç»„çš„åŒæ—¶å°±ä¸ºæ•°ç»„å…ƒç´ åˆ†é…ç©ºé—´å¹¶èµ‹å€¼ï¼Œ  
    ä¾‹å¦‚ï¼š

```java
public class TestArray{
    public static void main(String args[]){
        int[] arr = {1,2,3}


        Student[] student = {new Student("å¼ ä¸‰",87,0528),
                            new Student("æå››",76,0529),
                            new Student("èµµå…­",91,0530)};
    }
}
class Student{
    int name,score,ID;
    public Student(String name,int score,int ID){
        this.name = name;
        this.score = score;
        this.ID = ID;
    }
}
```

**æ³¨æ„:**

- int[] a ; ç­‰ä»·äº int a[]; â€“> å®šä¹‰ä¸€ä¸ª int ç±»å‹æ•°ç»„çš„å¼•ç”¨ a;
- int[] a = new int[5]; â€“> å®šä¹‰ä¸€ä¸ª int ç±»å‹å¼•ç”¨å¹¶ä¸”åˆ†é…ç©ºé—´, ä½†æ˜¯å…ƒç´ æ²¡æœ‰åˆå§‹åŒ–, ç³»ç»Ÿæ ¹æ®æ•°ç»„ç±»å‹è‡ªåŠ¨åˆå§‹åŒ–
- int[] a = {1,2,2,3,4}; ç­‰ä»·äº int[] a = new int[]{1,2,2,3,4}â€“> å®šä¹‰å¹¶åˆå§‹åŒ–;
- æ¯ä¸ªæ•°ç»„éƒ½æœ‰ä¸€ä¸ªé™æ€çš„å±æ€§, length, å®ƒæ˜¯è¿™ä¸ªæ•°ç»„çš„é•¿åº¦; å®ƒæ˜¯ä¸€ä¸ªæˆå‘˜å±æ€§, æ²¡æœ‰åŠ  (), åŒ String æ±‚å­—ç¬¦ä¸²é•¿åº¦çš„ length() æ–¹æ³•æœ‰åŒºåˆ«

**å­—ç¬¦ä¸²æ•°ç»„**

```java
String[] s = {"ss","bb","cc","rr"};
for(int i = 0 ; i < s.length ; i++){
    System.out.println(s[i]);
}
```

**å­—ç¬¦ä¸²**

```java
String s = "aabbccdd";
    int length = s.length();
```

**ä¸»æ–¹æ³•ä¸­çš„å­—ç¬¦ä¸²æ•°ç»„**  
`public static void main(String[] args){}`  
æˆ‘ä»¬æ¯ä¸ªç±»ä¸­çš„ä¸»å‡½æ•°ä¹Ÿæœ‰ä¸€ä¸ªæ•°ç»„ï¼Œåå« args.  
é‚£ä¹ˆè¿™ä¸ªæ•°ç»„æ—¶å¹²å˜›ç”¨çš„å‘¢ï¼Ÿ  
è¿™ä¸ªæ•°ç»„å°±å¥½æ¯”ï¼Œæˆ‘ä»¬åœ¨å‘½ä»¤è¡Œä¸­æ³¨å…¥ ipconfig -all ä¸­çš„ all. æˆ‘ä»¬å¯ä»¥åœ¨è¾“å…¥  
`java ç±»å 23,12,aa,bbb` è¿™ä¸ªè·Ÿå‡ ä¸ªå‚æ•°ã€‚ç„¶åå¯ä»¥åœ¨ä»£ç ä¸­è¾“å‡ºæ¥çœ‹åˆ°

```java
class ClassName {
    public static void main(String[] args) {
        for(int i = 0 ; i < args.length;i ++){
            System.out.println(args[i]);
        }
    }
}
```

è¿è¡Œçš„æ—¶å€™ ç”¨å‘½å `java ClassName 1,2,3,4,5`, å°±ä¼šåœ¨æ§åˆ¶å°è¾“å‡º `1,2,3,4,5`  
è¿™å¥å‘½ä»¤çš„æ„æ€æ˜¯: args[0] = â€œ1,2,3,4,5â€; args.length çš„å€¼ä¸º 1  
å¦‚æœæˆ‘ä»¬è¾“å…¥ `java ClassName 1 2 3 4 5`;  
è¿™å¥å‘½ä»¤çš„æ„æ€æ˜¯: args[0] = â€œ1â€;  
args[1] = â€œ2â€;  
â€¦â€¦  
args.length çš„å€¼ä¸º 5.

ä¸¾ä¸€ä¸ª args[] å‚æ•°å’ŒåŸºç¡€ç±»å‹åŒ…è£…ç±»ä¸€èµ·ä½¿ç”¨çš„ä¾‹å­ï¼Œç”¨æ¥è®¡ç®— +-x/ï¼š

```java
public class ClassName{
    public static void main(String args[]){
        if(args.length<3){//å¿…é¡»è¦è¾“å…¥3ä¸ªå­—ç¬¦,ä¸­é—´å­—ç¬¦æ˜¯è¿ç®—ç¬¦
        //å…¶ä»–2ä¸ªå­—ç¬¦æ˜¯è¦è¿ç®—çš„å€¼
            System.out.println("error~~~");
            System.exit(0);
        }
        //æŠŠå­—ç¬¦ä¸²è½¬æ¢ä¸ºdoubleç±»å‹
        double  b1 = Double.parseDouble(args[0]);
        double  b2 = Double.parseDouble(args[2]);
        double  b = 0;
        if(args[1].equals("+")){
            b = b1 + b2;
        }else if(args[1].equals("-")){
            b = b1-b2;
        }else if(args[1].equals("x")){
            b = b1*b2;
        }else if(args[1].equals("/")){
            b = b1/b2;
        }else{
            System.out.println("error operation!!!");
        }
        System.out.println(b);
    }
}
```

ä¸‹é¢ä¸¾ä¸€ä¸ªç”¨ ars è¾“å…¥ 10 ä¸ªæ•°ï¼Œå¹¶ä¸”ç”¨é€‰æ‹©æ’åºï¼Œä»å°åˆ°å¤§æ’åºçš„ç¤ºä¾‹ï¼š

```java
public class TestSortInt{
    public static void main(String args[]){
        int[] a = new int[args.length];
        for(int i=0; i<args.length; i++){
            a[i] = Integer.parseInt(args[i]);
        }
        int k,temp;
        for(int i=0; i<a.length; i++){
            k = i;
            for(int j=i+1; j<a.length; j++){
                if(a[k]>a[j]){
                    k=j;//kå­˜å‚¨çš„æ˜¯æœ€å°å€¼çš„ä¸‹æ ‡
                 }
            }
            if(k!=i){
                temp = a[i];
                a[i] = a[k];
                a[k] = temp;
            }
        }
        for(int i=0; i<a.length; i++){
            System.out.print(a[i] + " ");
        }
    }
}
```

ä¸‹é¢æˆ‘ä»¬ç”¨æ•°ç»„é‡Œé¢è£…ä¸€ä¸ªæ—¥æœŸç±»å‹åšæ’åºçš„ç¤ºä¾‹ï¼Œç”¨äº†å†’æ³¡æ’åºã€‚

```java
public class TestDateSort{
    public static void main(String args[]){
        Date[] date = new Date[5];
        date[0] = new Date(2006,5,4);
        date[1] = new Date(2006,7,4);
        date[2] = new Date(2008,5,4);
        date[3] = new Date(2004,5,9);
        date[4] = new Date(2006,5,4);

        bubbleSort(date);

        for(int i=0; i < date.length; i++){
            System.out.println(date[i]);
        }
    }
    public static Date[] bubbleSort(Date[] a){
        int len = a.length;
        for(int i=len; i>=1; i--){
            for(int j=0; j<i-1; j++){
                if(a[j].compare(a[j+1])>0){
                    Date temp = a[j+1];
                    a[j+1] = a[j];
                    a[j] = temp;
                }
            }
        }
        return a;
    }
}
class Date{
    private int year,month,day;
    public Date(int year,int month,int day){
        this.year = year;
        this.month = month;
        this.day = day;
    }
    public int compare(Date date){
        return year>date.year?1
               :year<date.year?-1
               :month>date.month?1
               :month<date.month?-1
               :day>date.day?1
               :day<date.day?-1
               :0;
    }
    public String toString(){
        return "year,month,day ---- " +year+" - "+month+" - "+day;
    }
}
```

ä¸‹é¢æˆ‘ä»¬ç”¨æ•°ç»„åšä¸€ä¸ªæ•°ä¸‰é€€ä¸€çš„æ¸¸æˆï¼Œå°±æ˜¯è¯´ï¼Œå¥½å¤šäººå›´åŸä¸€åœˆï¼Œæ•° 1,2,3 ä¸‰ä¸ªæ•°ï¼Œæ•°åˆ° 3 çš„äººé€€å‡ºï¼Œå‰©ä½™çš„äººç»§ç»­é‡æ–°ä» 1 å¼€å§‹æ•°æ•°ï¼ŒçŸ¥é“å‰©ä¸‹æœ€åä¸€ä¸ªäººï¼Œæˆ‘ä»¬ç”¨æ•°ç»„æ±‚æœ€åä¸€ä¸ªäººæ˜¯è°ï¼Ÿ

```java
public class Count3Quit{
    public static void main(String args[]){
        boolean[] arr = new boolean[500];
        for(int i=0; i<arr.length; i++){
            arr[i] = true;
        }

        int leftCount = arr.length;
        int count = 0;
        int index = 0;
        while(leftCount > 1){
            if(arr[index] == true){
                count++;
                if(count == 3){
                    count = 0;
                    arr[index] = false;
                    leftCount --;
                }
            }
            index ++;
            if(index == arr.length){
                index=0;
            }
        }

        for(int i=0; i<arr.length; i++){
            if(arr[i]==true){
                System.out.println(i);
            }
        }
    }
}
```

æœ‰äº†æ•°ç»„ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥è®¾è®¡å„ç§å„æ ·çš„æ’åºç®—æ³•ã€‚ç„¶ååœ¨æ’å¥½åºçš„æ—¶å€™ï¼Œæˆ‘ä»¬åˆå¯ä»¥è®¾è®¡å„ç§å„æ ·çš„æŸ¥æ‰¾ç®—æ³•ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç”¨æ•°ç»„å®ç°ä¸€ä¸ªç®€å•çš„äºŒåˆ†æ³•æŸ¥æ‰¾ç®—æ³•

```java
public class TestSearch{
    public static void main(String args[]){
        int[] a = {12,23,41,53,24,57,32,52,98,43,19,73};
        int postion = binarySearch(a,57);
        System.out.println(postion);
    }
    public static int binarySearch(int[] a, int searchNum){

        if(a.length==0)return -1;

        int startFlag = 0;
        int endFlag = a.length-1;
        int m = (startFlag+endFlag)/2;
        while(startFlag<=endFlag){
            if(a[m] == searchNum){
                return m;
            }else if(a[m]<searchNum){
                startFlag = m+1;
            }else if(a[m]>searchNum){
                startFlag = m+1;
            }
            m = (startFlag+endFlag)/2;
        }
        return -1;
    }
}
```

#### å¤šç»´æ•°ç»„

1ï¼äºŒç»´æ•°ç»„çš„å®šä¹‰

```ã€€ã€€
type arrayName[][]ï¼›
type [][]arrayName;
```

2ï¼äºŒç»´æ•°ç»„çš„åˆå§‹åŒ–

- é™æ€åˆå§‹åŒ–

`int intArray[][]={{1,2},{2,3},{3,4,5}};`

Java è¯­è¨€ä¸­ï¼Œç”±äºæŠŠäºŒç»´æ•°ç»„çœ‹ä½œæ˜¯æ•°ç»„çš„æ•°ç»„ï¼Œæ•°ç»„ç©ºé—´ä¸æ˜¯è¿ç»­åˆ†é…çš„ï¼Œæ‰€ä»¥ä¸è¦æ±‚äºŒç»´æ•°ç»„æ¯ä¸€ç»´çš„å¤§å°ç›¸åŒã€‚

    - åŠ¨æ€åˆå§‹åŒ–

- ç›´æ¥ä¸ºæ¯ä¸€ç»´åˆ†é…ç©ºé—´ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```java
arrayName = new type[arrayLength1][arrayLength2];
int a[][] = new int[2][3]ï¼›
```

      - ä»æœ€é«˜ç»´å¼€å§‹ï¼Œåˆ†åˆ«ä¸ºæ¯ä¸€ç»´åˆ†é…ç©ºé—´ï¼š

```java
arrayName = new type[arrayLength1][ ];
arrayName[0] = new type[arrayLength20];
arrayName[1] = new type[arrayLength21];
â€¦
arrayName[arrayLength1-1] = new type[arrayLength2n];
```

1. ä¾‹ï¼š  
   ã€€ã€€äºŒç»´ç®€å•æ•°æ®ç±»å‹æ•°ç»„çš„åŠ¨æ€åˆå§‹åŒ–å¦‚ä¸‹:

```java
int a[][] = new int[2][ ]ï¼›
a[0] = new int[3];
a[1] = new int[5];
```

å¯¹äºŒç»´å¤åˆæ•°æ®ç±»å‹çš„æ•°ç»„ï¼Œå¿…é¡»é¦–å…ˆä¸ºæœ€é«˜ç»´åˆ†é…å¼•ç”¨ç©ºé—´ï¼Œç„¶åå†é¡ºæ¬¡ä¸ºä½ç»´åˆ†é…ç©ºé—´ã€‚  
ã€€ã€€è€Œä¸”ï¼Œå¿…é¡»ä¸ºæ¯ä¸ªæ•°ç»„å…ƒç´ å•ç‹¬åˆ†é…ç©ºé—´ã€‚

ä¾‹å¦‚ï¼š

```java
String s[][] = new String[2][ ];
s[0]= new String[2];// ä¸ºæœ€é«˜ç»´åˆ†é…å¼•ç”¨ç©ºé—´
s[1]= new String[2]; // ä¸ºæœ€é«˜ç»´åˆ†é…å¼•ç”¨ç©ºé—´
s[0][0]= new String(â€œGoodâ€);// ä¸ºæ¯ä¸ªæ•°ç»„å…ƒç´ å•ç‹¬åˆ†é…ç©ºé—´
s[0][1]= new String(â€œLuckâ€);// ä¸ºæ¯ä¸ªæ•°ç»„å…ƒç´ å•ç‹¬åˆ†é…ç©ºé—´
s[1][0]= new String(â€œtoâ€);// ä¸ºæ¯ä¸ªæ•°ç»„å…ƒç´ å•ç‹¬åˆ†é…ç©ºé—´
s[1][1]= new String(â€œYouâ€);// ä¸ºæ¯ä¸ªæ•°ç»„å…ƒç´ å•ç‹¬åˆ†é…ç©ºé—´
```

3ï¼äºŒç»´æ•°ç»„å…ƒç´ çš„å¼•ç”¨

å¯¹äºŒç»´æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œå¼•ç”¨æ–¹å¼ä¸ºï¼šarrayName[index1][index2]  
ã€€ã€€ä¾‹å¦‚ï¼š num[1][0];  
ã€€ã€€ä¸¤ä¸ªçŸ©é˜µäº¤æ¢:

```java
class twoArrayTest {
    public static void main(String[] args) {
        int arry[][] = {{1,2,3},{4,5,6},{7,8,9}};
        for(int i = 0 ; i <= 2 ; i++){
            for(int j = 0 ; j <= 2 ; j++){
                System.out.print(arry[i][j]+" ");
            }
            System.out.println();
        }
        for(int i = 0 ; i <= 2 ; i++){
            for(int j =  i; j <= 2 ; j++){
                int temp = arry[i][j];
                arry[i][j] = arry[j][i];
                arry[j][i] = temp;
            }
        }
        System.out.println("è½¬æ¢å");
        for(int i = 0 ; i <= 2 ; i++){
            for(int j = 0 ; j <= 2 ; j++){
                System.out.print(arry[i][j]+" ");
            }
            System.out.println();
        }
    }
}
```

### 2. ä½è¿ç®—

#### æŒ‰ä½ä¸ & (AND)

**éƒ½ä¸º 1 æ‰ä¸º 1, å¦åˆ™ä¸º 0**

```java
public class Demo1 {
    public static void main(String[] args) {
        int a = 4 ;// 00000000 00000000 00000000 00000100
        int b = 7 ;// 00000000 00000000 00000000 00000111
        int c = a & b ; //                       00000100
        System.out.println(c);
    }
}
```

åº”ç”¨:

1. è¿…é€Ÿæ¸…é›¶  
   `int a = 4 ;`  
   `a = a & 0; //ç»“æœä¸º0`
2. ä¿ç•™æŒ‡å®šä½æ•°æ®  
   `int a = 409; // 00000000 00000000 00000001 10011001`  
   `int b = 255; // 00000000 00000000 00000000 11111111`  
   // å– a çš„ä½ 8 ä½  
   `a = a & b ; // 00000000 00000000 00000000 10011001`

3. åˆ¤æ–­å¥‡å¶æ€§  
   int a = æ•´æ•° ;  
   `int b = a & 1;`  
   å¦‚æœ b = 1, åˆ™ a æ˜¯å¥‡æ•°;  
   å¦‚æœ b = 0, åˆ™ a æ˜¯å¶æ•°;  
   è§£é‡Š: æŠŠä¸€ä¸ªæ•´æ•°ç”¨äºŒè¿›åˆ¶è¡¨ç¤º, å¦‚æœæœ€ä½ä½æ˜¯ 1 çš„è¯, åˆ™è¿™ä¸ªæ•´æ•°è‚¯å®šæ˜¯å¥‡æ•°;  
   è¿™ä¸ªæ•´æ•°è·Ÿ 1 æŒ‰ä½ä¸çš„æ—¶å€™, å³æœ€ä½ä½è·ŸäºŒè¿›åˆ¶ 001 æŒ‰ä½ä¸, å¦‚æœç»“æœä¸º 1, åˆ™è¿™ä¸ªæ•´  
   æ•°å¯¹åº”äºŒè¿›åˆ¶ä½çš„æœ€ä½ä½å¿…å®šä¹Ÿä¸º 1, æ‰€ä»¥è¿™ä¸ªæ•´æ•°å¿…å®šæ˜¯å¥‡æ•°.

#### æŒ‰ä½æˆ– | (OR)

**æœ‰ä¸€ä¸ªä¸º 1, ç»“æœå°±ä¸º 1; å…¨ä¸º 0, ç»“æœæ‰ä¸º 0**

```java
public class Demo2 {
        public static void main(String[] args) {
            int a = 9 ;// 00000000 00000000 00000000 00001001
            int b = 5 ;// 00000000 00000000 00000000 00000101
            int c = a | b ; //                       00001101
            System.out.println(c);
    }
}
```

åº”ç”¨:

1. è®¾å®šæ•°æ®çš„æŒ‡å®šä½ç½®  
   å°† Demo2 ä¸­ a çš„ä½ 8 ä½å…¨éƒ¨è®¾ç½®ä¸º 1  
   `a = a | 0xFF;`//0xFFâ€“>255â€“>10000000

#### æŒ‰ä½å¼‚æˆ– ^ (XOR)

**å½“å¯¹åº”ä½äº’æ–¥çš„æ—¶å€™, ç»“æœæ‰ä¸º 1, å¦åˆ™ä¸º 0**

```java
public class Demo3 {
        public static void main(String[] args) {
            int a = 10;// 00000000 00000000 00000000 00001010
            int b = 7 ;// 00000000 00000000 00000000 00000111
            int c = a ^ b ; //                       00001101
            System.out.println(c);
    }
}
```

- æ€§è´¨:

  1.  äº¤æ¢å¾‹
  2.  ç»“åˆå¾‹
  3.  å¯¹äºä»»ä½•æ•° xï¼Œéƒ½æœ‰ x^x=0ï¼Œx^0=x
  4.  è‡ªåæ€§ A XOR B XOR B = A xor 0 = A

- åº”ç”¨:

  1.  å®šä½åè½¬  
      `a = a ^ x;` //(x æ˜¯ä¸€ä¸ªè·Ÿ a å¯¹åº”çš„äºŒè¿›åˆ¶æœ‰ç›¸åŒä½æ•°çš„å…¨ä¸ºä¸€çš„äºŒè¿›åˆ¶æ•°)
  2.  æ•°å€¼äº¤æ¢  
      `a = a ^ b;`  
      `b = b ^ a;`  
      `a = a ^ b;`

- ç»ƒä¹ :  
  1-1000 æ”¾åœ¨å«æœ‰ 1001 ä¸ªå…ƒç´ çš„æ•°ç»„ä¸­ï¼Œåªæœ‰å”¯ä¸€çš„ä¸€ä¸ªå…ƒç´ å€¼é‡å¤ï¼Œå…¶å®ƒå‡åªå‡ºç°ä¸€æ¬¡ã€‚æ¯ä¸ªæ•°ç»„å…ƒç´ åªèƒ½è®¿é—®ä¸€æ¬¡ï¼Œè®¾è®¡ä¸€ä¸ªç®—æ³•ï¼Œå°†å®ƒæ‰¾å‡ºæ¥ï¼›ä¸ç”¨è¾…åŠ©å­˜å‚¨ç©º  
  é—´ï¼Œèƒ½å¦è®¾è®¡ä¸€ä¸ªç®—æ³•å®ç°ï¼Ÿ

  - ç®—æ³•ä¸€:  
    æŠŠæ‰€æœ‰æ•°åŠ èµ·æ¥å†å‡å» 1+2+..+1000 çš„å’Œ, å‰©ä¸‹çš„å°±æ˜¯é‚£ä¸ªæ•°  
    ç¼ºç‚¹æ˜¯å¦‚æœæ•°æ®è¶³å¤Ÿå¤§, ä¼šè¶…è¿‡æ•°æ®å­˜å‚¨èŒƒå›´

    ```java
    public static int methode (int[] a) {
        int arraySum = 0 ;
        int sum = 0;
        for(int i = 0 ; i < a.length ; i ++){
            arraySum += a[i];
        }
        for(int j = 1 ; j <= 1000 ; j ++){
            sum += j;
        }
        return arraySum - sum;
    }
    ```

  - ç®—æ³•äºŒ:  
    å°†æ‰€æœ‰çš„æ•°å…¨éƒ¨å¼‚æˆ–ï¼Œå¾—åˆ°çš„ç»“æœä¸ 1^2^3^â€¦^1000 çš„ç»“æœè¿›è¡Œå¼‚æˆ–ï¼Œå¾—åˆ°çš„ç»“æœå°±æ˜¯é‡å¤æ•°  
    è¯æ˜: ç”± ^ æ“ä½œç¬¦çš„ 4 ä¸ªæ€§è´¨, å‡è®¾å¤šå‡ºçš„é‚£ä¸ªæ•°ä¸º n,  
    åˆ™ 1^2^â€¦^n^n^â€¦^1000 = (1^2^..^1000)^n^n= a (è¿™ä¸ªç»“æœé‡Œé¢æ²¡æœ‰ n)  
    ç„¶åæŠŠè¿™ä¸ªç»“æœåŒä» 1 å¼‚æˆ–åˆ° 1000 çš„ç»“æœå¼‚æˆ–,  
    å‡è®¾ b = 1^2^3^â€¦^1000(æœ‰ n)â€“> b = a ^ n  
    åˆ™ a ^ b = a ^ (a ^ n) å°±ç­‰äº n (å¯¹äºä»»ä½•æ•° xï¼Œéƒ½æœ‰ x^x=0ï¼Œx^0=x)

```java
public static int method(int[] a) {
        int resultA = 0;
        int resultB = 0;
        for(int i = 0 ; i < a.length ; i++){
            resultA ^= a[i];
        }
        for(int j = 1 ; j <= 1000 ; j++){
            resultB ^= j;
        }
        return resultA ^ resultB;
    }
```

#### å–å ~

~(00001011)

#### å·¦ç§» <<å³ç§»>>

å·¦ç§» n ä½, å°±æ˜¯ä¹˜ä»¥ 2 çš„ n æ¬¡æ–¹  
å³ç§» n ä½, å°±æ˜¯é™¤ä»¥ 2 çš„ n æ¬¡æ–¹

```java
public class Demo4 {
        public static void main(String[] args) {
            int a = 10;// 00000000 00000000 00000000 00001010
            int c = a << 4 ; //                      11010000
            System.out.println(c);
    }
}
```

## [Javaè™šæ‹Ÿæœºæ¢ç§˜ï¼šå­—èŠ‚ç ä¸ç±»æ–‡ä»¶](https://blog.dong4j.site/posts/c69e2769.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

- åœ¨ä¸€æ¡è®¡ç®—æœºä¸Šç”±è½¯ä»¶æˆ–ç¡¬ä»¶æ¨¡æ‹Ÿçš„è®¡ç®—æœºæˆ–ç¡¬ä»¶æ¨¡æ‹Ÿçš„è®¡ç®—æœº. JVM è¯»å–å¹¶å¤„ç†ç»ç¼–è¯‘åçš„å¹³å°æ— å…³çš„å­—èŠ‚ç  class æ–‡ä»¶
- java ç¼–è¯‘å™¨é’ˆå¯¹ java è™šæ‹Ÿæœºäº§ç”Ÿçš„ class æ–‡ä»¶, å› æ­¤æ˜¯ç‹¬ç«‹äºå¹³å°çš„
- java è§£é‡Šå™¨è´Ÿè´£å°† java è™šæ‹Ÿæœºçš„ä»£ç åœ¨ç‰¹å®šçš„å¹³å°ä¸Šè¿è¡Œ

### **ç±»çš„å®šä¹‰**

```java
public class HelloWorld {
    public static void mian(String[] args) {
        System.out.println("HelloWorld");
    }
}
```

`[public] class ç±»åç§° {}`  
å¯¹äºç±»çš„å®šä¹‰æœ‰ä¸¤ç§å½¢å¼:

1. public class å®šä¹‰: å†…åç§°å¿…é¡»å’Œæ–‡ä»¶åç§°ä¸€è‡´, åœ¨ä¸€ä¸ª java æ–‡ä»¶é‡Œåªèƒ½æœ‰ä¸€ä¸ª public ä¿®é¥°çš„ç±»
2. class å®šä¹‰: ç±»åç§°å¯ä»¥å’Œæ–‡ä»¶åä¸ä¸€è‡´, ä½†æ˜¯ç”Ÿæˆçš„æ˜¯ class å®šä¹‰çš„åç§°, åœ¨ä¸€ä¸ª java ç¨‹åºä¹‹ä¸­å¯ä»¥åŒæ—¶å­˜åœ¨å¤šä¸ª class çš„å®šä¹‰, ç¼–è¯‘ä¹‹åä¼šåˆ†ä¸ºä¸åŒ class æ–‡ä»¶.

### **ä¸»æ–¹æ³•**

ä¸»æ–¹æ³•è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªç¨‹åºçš„èµ·ç‚¹, è¦æ”¾åœ¨ä¸€ä¸ªç±»ä¸­, ä¸»æ–¹æ³•å®šä¹‰æ ¼å¼å¦‚ä¸‹:  
`public static void main(String[] args){}`

### **ç³»ç»Ÿè¾“å‡º**

å¯ä»¥ç›´æ¥åœ¨å±å¹•ä¸Šæ˜¾ç¤ºè¾“å‡ºä¿¡æ¯  
è¾“å‡ºä¸åŠ æ¢è¡Œ: `System.out.print(è¾“å‡ºå†…å®¹);`  
è¾“å‡ºåŠ æ¢è¡Œ :`System.out.println(è¾“å‡ºå†…å®¹);`

### **classPath é…ç½®**

å¦‚æœè¦è¦æƒ³æ‰§è¡ŒæŸä¸€ä¸ª java ç¨‹åº, é‚£ä¹ˆä¸€å®šè¦è¿›å…¥åˆ°ç¨‹åºæ‰€åœ¨çš„è·¯å¾„ä¸‹æ‰å¯ä»¥.  
å¦‚æœè¦æƒ³æ‰§è¡Œè¿™ä¸ªæ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰ class æ–‡ä»¶, åˆ™éœ€è¦è¿›å…¥åˆ°æ­¤ç›®å½•é¡¹æ‰§è¡Œ, é‚£ä¹ˆå¦‚æœç°åœ¨å¸Œæœ›åœ¨ä¸åŒçš„ç›®å½•ä¸‹æ‰§è¡Œå‘¢? ä¼šæç¤ºç”¨æˆ·æ‰¾ä¸åˆ°è¿™ä¸ªç±»., è¿™æ—¶å€™å°±éœ€è¦é…ç½® classpath

`SET CLASSPATH=*.classæ–‡ä»¶æ‰€åœ¨è·¯å¾„`

æ¯”å¦‚: classpath é…ç½®åˆ° `d:\testjava` ç›®å½•ä¹‹ä¸­  
`SET CLASSPATH=D:\testjava`

**ç»“è®º**: å½“ä½¿ç”¨ java å‘½ä»¤æ‰§è¡Œä¸€ä¸ªç±»çš„æ—¶å€™, ä¼šé¦–å…ˆé€šè¿‡ classpath æ‰¾åˆ°æŒ‡å®šçš„è·¯å¾„,  
è€Œååœ¨æ­¤è·¯å¾„ä¸‹åŠ è½½æ‰€éœ€è¦çš„ class æ–‡ä»¶  
ä½†æ˜¯, å¦‚æœè¿™æ ·åˆ°å¤„æŒ‡å®š classpath å¤ªä¹±ä¹Ÿå¤ªéº»çƒ¦, æ‰€ä»¥æœ€å¥½çš„åšæ³•è¿˜æ˜¯ä»å½“å‰è·¯å¾„ä¸‹åŠ è½½ class æ–‡ä»¶, é‚£ä¹ˆè¿™ä¸ªé¢æ—¶å€™å¾€å¾€å°† classpath è®¾ç½®ä¸º â€œ.â€

- **é¢è¯•é¢˜**: è¯·è§£é‡Š classpath å’Œ path çš„åŒºåˆ«
  - path: æ˜¯æ“ä½œç³»ç»Ÿçš„ç¯å¢ƒå±æ€§, æŒ‡çš„æ˜¯å¯ä»¥æ‰§è¡Œå‘½ä»¤çš„ç¨‹åºè·¯å¾„
  - classpath: æ˜¯æ‰€æœ‰ class æ–‡ä»¶çš„æ‰§è¡Œè·¯å¾„, java å‘½ä»¤æ‰§è¡Œçš„æ—¶å€™å°†åˆ©ç”¨æ­¤è·¯å¾„åŠ è½½æ‰€éœ€è¦çš„ class æ–‡ä»¶

### æ ‡è¯†ç¬¦å’Œå…³é”®å­—

- **æ ‡è¯†ç¬¦**: ç”±å­—æ¯, æ•°å­—,`_`,$ ç»„æˆ, å…¶ä¸­ä¸èƒ½ä»¥æ•°å­—å¼€å¤´, è€Œä¸”ä¸èƒ½æ˜¯ java çš„ä¿ç•™å­—
- **å®šä¹‰å˜é‡ (æ ‡è¯†ç¬¦) æˆ–æ–¹æ³•æ—¶**: ç¬¬ä¸€ä¸ªå•è¯çš„é¦–å­—æ¯å°å†™, ä¹‹åæ¯ä¸ªå•è¯çš„é¦–å­—æ¯å¤§å†™. â€“> String studentName ;
- **å®šä¹‰ç±»çš„æ—¶å€™**: ç¬¬ä¸€ä¸ªå•è¯çš„é¦–å­—æ¯å¤§å†™, ä¹‹åæ¯ä¸ªå•è¯çš„é¦–å­—æ¯å¤§å†™ â€“> class TestDemo {}
- **å…³é”®å­—**  
  å¸¸ç”¨çš„å‡ ç§ç±»å‹:
- int:
  - å–å¾—æœ€å¤§å€¼:`Integer.MAX_VALUE;`
  - å–å¾—æœ€å°å€¼:`Integer.MIN_VALUE;`
  - æœ€å¤§å€¼ + 1 = æœ€å°å€¼ æœ€å°å€¼ - 1 = æœ€å¤§å€¼ (æ•°æ®æº¢å‡º)
- double
- byte
  - åœ¨ä¸º byte èµ‹å€¼çš„æ—¶å€™, å¦‚æœç»™å‡ºçš„æ•°å€¼èŒƒå›´åœ¨ byte èŒƒå›´å†…, åˆ™è‡ªåŠ¨å°† int ç±»å‹å˜ä¸º byte ç±»å‹, è¿™ç§æ“ä½œåªæ˜¯åœ¨ç›´æ¥èµ‹å€¼çš„æƒ…å†µä¸‹

```java
class Test {
        public static void main(String[] args) {
            byte = 20 ;//20æ˜¯intç±»å‹
            System.out.println(b);
        }
    }
```

- boolean : true å’Œ false
  - å¸ƒå°”å‹ä¸»è¦è¡¨ç¤ºä¸€ç§é€»è¾‘åˆ¤æ–­, å¸ƒå°”æ˜¯ä¸€ä¸ªäººå‘½, ä»–å‘æ˜äº†é€»è¾‘è¿ç®— (AND,NOT,OR)
- long
- char
  - åœ¨å„ä¸ªè¯­è¨€ä¸­, char å’Œ int å¯ä»¥ç›¸äº’è½¬æ¢, åœ¨ c è¯­è¨€ä¸­è½¬æ¢çš„ç¼–ç æ˜¯ ASCII ç , èŒƒå›´:
    - å¤§å†™å­—æ¯èŒƒå›´: 65-90
    - å°å†™å­—æ¯èŒƒå›´: 97-122
  - java åœ¨å®šä¹‰å­—ç¬¦çš„æ—¶å€™æ‰€ä½¿ç”¨çš„ä¸æ˜¯ ASCII ç¼–ç , è€Œæ˜¯ UNICODE ç¼–ç , è¿™æ˜¯ä¸€ç§ä½¿ç”¨åå…­è¿›åˆ¶å®šä¹‰çš„ç¼–ç , å¯ä»¥è¡¨ç¤ºä»»ä½•æ–‡å­—, å…¶ä¸­åŒ…å«äº†ä¸­æ–‡

æŒæ¡ç±»å‹ä¹‹é—´çš„è½¬æ¢:

- è‡ªåŠ¨è½¬å‹ (ä»å°åˆ°å¤§):byteâ€“>shortâ€“>intâ€“>longâ€“>floatâ€“>double
- å¼ºåˆ¶è½¬å‹ (ä»å¤§åˆ°å°):doubleâ€“>floatâ€“>longâ€“>intâ€“>shortâ€“>byte

**åˆè§ String**  
String æœ¬äº‹ä¸å±äº java åŸºæœ¬æ•°æ®ç±»å‹, å› ä¸ºå®ƒå±äºä¸€ä¸ªç±» (åº”ç”¨å‹æ•°æ®), ä½†æ˜¯è¿™ä¸ªç±»å‹ä½¿ç”¨èµ·æ¥å¯ä»¥åƒåŸºæœ¬ç±»å‹ä¸€æ ·æ–¹ä¾¿, è€Œä¸”ä½¿ç”¨ä¹Ÿå¾ˆå¤š

- å­—ç¬¦ä¸²çš„å®šä¹‰ :
- `String str = "aabbccdd";`
- å­—ç¬¦ä¸²æ•°ç»„:
- `String[] str = {"aa","bb","cc"};`
- å­—ç¬¦ä¸²è¿æ¥:
- `String str = "Hello"; str = str + " World";`

**s += 1.0 å’Œ s = s + 1.0 çš„åŒºåˆ«**

- s += 1.0 éšå«äº†å¼ºåˆ¶è½¬æ¢,, å¦‚æœ s æ˜¯ int ç±»å‹, åˆ™è¿™å¥ä¸ä¼šæŠ¥é”™, è‡ªåŠ¨æŠŠç»“æœå¼ºåˆ¶è½¬æ¢ä¸º int ç±»å‹çš„
- è€Œ s = s + 1.0 åˆ™æ²¡æœ‰å¼ºåˆ¶è½¬æ¢, å¦‚æœ s åŒæ ·æ˜¯ int ç±»å‹çš„å˜é‡, åˆ™ç»“æœæ˜¯ double ç±»å‹, å¤§ç±»å‹è½¬æ¢ä¸ºå°ç±»å‹ä¼šå‘ç”Ÿç²¾åº¦ä¸¢å¤±, å¦‚æœæˆ‘ä»¬æ²¡æœ‰æ˜¾ç¤ºå¼ºåˆ¶è½¬æ¢, ç¼–è¯‘å™¨å°±ä¼šæŠ¥é”™

### ç¨‹åºé€»è¾‘

- é¡ºåºç»“æ„
  - æ‰€æœ‰ä»£ç æŒ‰ä¿®åé¡ºåºæ‰§è¡Œ
- é€‰æ‹©ç»“æ„
  - (å¤š) æ¡ä»¶åˆ¤æ–­: if , ifâ€¦else, if..else if â€¦else ;
  - (å¤š) æ•°å€¼åˆ¤æ–­: switch â€¦.case ;
- å¾ªç¯ç»“æ„
  - for å¾ªç¯, çŸ¥é“å¾ªç¯æ¬¡æ•°çš„æ—¶å€™ç”¨, ç”¨å¯ä»¥ä¸ç”¨çŸ¥é“, ç›´æ¥æ»¡è¶³æ¡ä»¶çš„æ—¶å€™ç”¨ break è·³å‡ºå¾ªç¯
  - while å¾ªç¯ , çŸ¥é“æ¡ä»¶ä¸æ»¡è¶³çš„æ—¶å€™è·³å‡ºå¾ªç¯
  - doâ€¦while å¾ªç¯, å…ˆå¾ªç¯ä¸€æ¬¡, ç„¶ååˆ¤æ–­å¾ªç¯æ¡ä»¶æ˜¯å¦æ»¡è¶³
  - foreach å¾ªç¯: ä¸€ç§ for å¾ªç¯çš„ç®€å•å†™æ³•, ä¸€èˆ¬ç”¨æ¥å¾ªç¯éå†æ•°ç»„.

```java
//è¾“å‡ºä¸€ä¸ªä¹˜æ³•è¡¨
class MultiplicationTable {
    public static void main(String[] args) {
        for(int i = 1 ; i <= 9 ; i ++){
            for(int j = 1 ; j <= i ; j ++){
                System.out.print(j+"*"+i+"="+j*i+" ");
            }
            System.out.println(" ");
        }
    }
}
```

æ‰“å°ä¸€ä¸ªä¸‰è§’

```java
int i,j,k;
        for(i = 1 ; i <= 7; i++){
            //æ‰“å°å‰é¢çš„ç©ºæ ¼
            for(j = 1;j < 7 - i+1;j++)
                System.out.print(" ");
            for(k = 1 ;k <= i*2 -1 ;k++)
                System.out.print("*");
            //å¾ªç¯å®Œä¸€æ¬¡,æ¢è¡Œ
            System.out.println();
        }
```

### ç»ƒä¹ 

1.  è¾“å…¥æˆç»©, åˆ¤æ–­ç­‰çº§

```java
//è¾“å…¥æˆç»©,ç»™å‡ºç­‰çº§
import javax.swing.JOptionPane;
import java.util.regex.Matcher; //æ­£åˆ™è¡¨è¾¾å¼çš„ç±»
class Demo {
    public static void main(String[] args) {
        while(true){
            String s = JOptionPane.showInputDialog(null,"è¯·è¾“å…¥æˆç»©");
            //å¦‚æœè¾“å…¥çš„æ˜¯æ•°å­—,åˆ™åˆ¤æ–­æˆç»©;
            if(s.matches("^[0-9]{1,3}$")){
                int num = Integer.parseInt(s);
                //System.out.println(num);
                if(num >= 90 )
                    JOptionPane.showMessageDialog(null,"ç­‰çº§:A");
                else if(num >= 80)
                    JOptionPane.showMessageDialog(null,"ç­‰çº§:B");
                else if(num >= 70)
                    JOptionPane.showMessageDialog(null,"ç­‰çº§:C");
                else if(num >= 60)
                    JOptionPane.showMessageDialog(null,"ç­‰çº§:D");
                else if(num <= 59 )
                    JOptionPane.showMessageDialog(null,"ä¸åŠæ ¼");
            }
            //è¾“å…¥quitæ—¶é€€å‡ºç¨‹åº
            else if(s.equals("quit")){
                return ;
            }
            else
                JOptionPane.showMessageDialog(null,"è¾“å…¥é”™è¯¯,è¯·é‡æ–°è¾“å…¥");
        }
    }
}
```

1.  åˆ¤æ–­ä¸€ä¸ªæ•°æ˜¯ä¸æ˜¯æ°´ä»™èŠ±æ•°

```java
//åˆ¤æ–­ä¸€ä¸ªæ•°æ˜¯ä¸æ˜¯æ°´ä»™èŠ±æ•°
import javax.swing.JOptionPane;

class Demo4 {
    public static void main(String[] args) {
        while(true){
            String s = JOptionPane.showInputDialog(null,"è¯·è¾“å…¥ä¸‰ä½æ•°");
            int  num  = Integer.parseInt(s);
            //ç™¾ä½ num / 100 = 153 / 100 = 1
            //ä¸ªä½  num % 10 = 3
            //åä½ (num /10)%10 = 5
            int a = num / 100 ;
            int b = num % 10 ;
            int c = (num / 10 )% 10 ;
            if(a*a*a + b*b*b + c*c*c == num){
                JOptionPane.showMessageDialog(null,"æ˜¯æ°´ä»™èŠ±ä¹¦æ•°");
                return;
            }
            else
                JOptionPane.showMessageDialog(null,"ä¸æ˜¯æ°´ä»™èŠ±æ•°");
        }
    }
}
```

1.  æ±‚ 100-999 ä¹‹é—´çš„æ°´ä»™èŠ±æ•°

```java

//æ±‚100-999ä¹‹é—´çš„æ°´ä»™èŠ±æ•°

class Demo5 {
    public static void main(String[] args) {
        int a ;
        int b ;
        int c ;

        for(int i = 100 ; i <=999 ; i++){
            a = i / 100 ;
            b = i % 10 ;
            c = (i / 10 )% 10;
            if(a*a*a + b*b*b +c*c*c == i)
                System.out.println(i);
        }
    }
}
```

1. è¿ç®—

```java
import javax.swing.JOptionPane;
public class Test2 {
    public static void main(String[] args) {
        String s1 = JOptionPane.showInputDialog(null,"è¯·è¾“å…¥ç¬¬ä¸€ä¸ªæ•°å­—");
        String aa = JOptionPane.showInputDialog(null,"è¯·è¾“å…¥è¿ç®—ç¬¦å·");
        String s2 = JOptionPane.showInputDialog(null,"è¯·è¾“å…¥ç¬¬äºŒä¸ªæ•°å­—");

        int x = Integer.parseInt(s1);
        int y = Integer.parseInt(s2);
        switch (aa) {
            case "+": {
                JOptionPane.showMessageDialog(null,x+"+"+y+"="+(x+y));
                break;
            }
            case "-" :{
                JOptionPane.showMessageDialog(null,x+"-"+y+"="+(x-y));
                break;
            }
            case "*" :{
                JOptionPane.showMessageDialog(null,x+"*"+y+"="+(x*y));
                break;
            }
            case "/" :{
                JOptionPane.showMessageDialog(null,x+"/"+y+"="+(x/y));
                break;
            }

        }


    }
}
```

1.  JOptionPane ç±»

```java
import javax.swing.JOptionPane;
class JOptionPaneTest {
    public static void main(String[] args) {
        //æ˜¾ç¤ºä¸€ä¸ªé”™è¯¯å¯¹è¯æ¡†ï¼Œè¯¥å¯¹è¯æ¡†æ˜¾ç¤ºçš„ message ä¸º 'alert'ï¼š
        JOptionPane.showMessageDialog(null,
                                    "alert",
                                    "alert",
                                    JOptionPane.ERROR_MESSAGE);

        //æ˜¾ç¤ºä¸€ä¸ªå†…éƒ¨ä¿¡æ¯å¯¹è¯æ¡†ï¼Œå…¶ message ä¸º 'information'ï¼š
        JOptionPane.showInternalMessageDialog(frame,
                                            "information",
                                            "information",
                                            JOptionPane.INFORMATION_MESSAGE);

        //æ˜¾ç¤ºä¸€ä¸ªä¿¡æ¯é¢æ¿ï¼Œå…¶ options ä¸º "yes/no"ï¼Œmessage ä¸º 'choose one'ï¼š
        JOptionPane.showConfirmDialog(null,
                                    "choose one",
                                    "choose one",
                                    JOptionPane.YES_NO_OPTION);

        //æ˜¾ç¤ºä¸€ä¸ªå†…éƒ¨ä¿¡æ¯å¯¹è¯æ¡†ï¼Œå…¶ options ä¸º "yes/no/cancel"ï¼Œmessage ä¸º 'please choose one'ï¼Œå¹¶å…·æœ‰ title ä¿¡æ¯ï¼š
        JOptionPane.showInternalConfirmDialog(frame,
                                            "please choose one",
                                            "information",
                                            JOptionPane.YES_NO_CANCEL_OPTION,
                                            JOptionPane.INFORMATION_MESSAGE);

        //æ˜¾ç¤ºä¸€ä¸ªè­¦å‘Šå¯¹è¯æ¡†ï¼Œå…¶ options ä¸º OKã€CANCELï¼Œtitle ä¸º 'Warning'ï¼Œmessage ä¸º 'Click OK to continue'ï¼š
        Object[] options = { "OK", "CANCEL" };
        JOptionPane.showOptionDialog(null,
                                    "Click OK to continue",
                                    "Warning",
                                    JOptionPane.DEFAULT_OPTION,
                                    JOptionPane.WARNING_MESSAGE,
                                    null,
                                    options, options[0]);

        //æ˜¾ç¤ºä¸€ä¸ªè¦æ±‚ç”¨æˆ·é”®å…¥ String çš„å¯¹è¯æ¡†ï¼š
        String inputValue = JOptionPane.showInputDialog("Please input a value");

        //æ˜¾ç¤ºä¸€ä¸ªè¦æ±‚ç”¨æˆ·é€‰æ‹© String çš„å¯¹è¯æ¡†ï¼š
        Object[] possibleValues = { "First", "Second", "Third" };
        Object selectedValue = JOptionPane.showInputDialog(null,
                                                            "Choose one",
                                                            "Input",
                                                            JOptionPane.INFORMATION_MESSAGE,
                                                            null,
                                                            possibleValues,
                                                            possibleValues[0]);
    }
}
```

1.  2

```java
import javax.swing.JOptionPane;
class xunhuanTest {
    public static void main(String[] args) {
        /*int i = 0 ;
        int j = 0;
        while(i < 10){
            while(j < 10){
                System.out.print("*");
                j++;
            }
            j = 0;
            i++;
            System.out.println("");
        }*/

        /*int count = 0;
        String s ;
        int num = 0;
        int sum = 0;
        while (count < 5){
            count++;
            s= JOptionPane.showInputDialog(null,"è¯·è¾“å…¥ç¬¬"+count+"ä¸ªäººçš„æˆç»©");
            num = Integer.parseInt(s);
            sum +=  num;
        }
        JOptionPane.showMessageDialog(null,"å¹³å±€æˆç»©ä¸º:"+sum / 5.0);*/

        /*int sum = 0;
        int i = 1;
        while(i < 101){
            sum = sum + i ;
            i++;
        }
        System.out.println(sum);*/

       /* int i = 1 ;
        int sum = 0;
        while (i < 100){
            sum = sum + i;
            System.out.println(i);
            i += 2 ;

        }
        System.out.println(i);
        System.out.println(sum);*/

        //3çš„å€æ•°å’Œå¸¦3çš„æ•°éƒ½è¦æ•²æ¡Œå­å…¶ä»–çš„æŠ¥æ•°

        /*int i = 0;
        while (i < 50) {
            i++;
            if(i % 3 == 0 ||  i/10 == 3 ||  i%10 == 3 )
                System.out.println("æ•²æ¡Œå­");
            else
                System.out.println(i);
        }*/


        /*//è¾“å…¥5ä¸ªæ•°,ç»™å‡ºæœ€å¤§å€¼
        int count = 1;
        String str = "";
        int[] intArray = new int[5];
        int i = 0 ;
        int num ;
        while(count <=5 ){
            String s = JOptionPane.showInputDialog(null,"è¯·è¾“å…¥ç¬¬"+count+"ä¸ªæ•°");
            count++;
            //str = str + s;
            num = Integer.parseInt(s);
            intArray[i] = num;
            i++;
        }
        int mix = intArray[0] ;
        for(int j = 0 ; j < intArray.length - 1; j++){
            if(mix < intArray[j+1]){
                mix = intArray[j+1];
            }
        }
        System.out.println(mix);*/
    }
}
```

1.  å¼‚æˆ–

```java
class Demo2 {
    public static void main(String[] args) {
        int a = 5;
        int b = 8;
        //å¼‚æˆ–æ€§è´¨ :1.äº¤æ¢å¾‹;2.ç»“åˆå¾‹;3.x^x = 0 , x^0 = x;4.è‡ªåæ€§
        a = a^b;
        b = b^a;
        a = a^b;
        System.out.println("a = "+a+" b = "+b);
    }
}
```

1.  è¾“å‡º 3-100 ä¹‹é—´çš„ç´ æ•°

```java

//è¾“å‡º3-100ä¹‹é—´çš„ç´ æ•°
class Test4 {
    public static void main(String[] args) {
        for(int i = 3 ; i <= 100 ; i++){
            boolean on_off = true ;
            for(int j = 2 ; j < i ; j++){
                if(i % j == 0){
                    on_off = false ;
                    //ç»“æŸå†…å±‚å¾ªç¯
                    break ;
                }
            }
            if(on_off){
                System.out.println(i);

            }
        }
    }
}
```

1.  æ±‚ 2 ä¸ªæ•°çš„æœ€å¤§å…¬çº¦æ•°

```java
import javax.swing.JOptionPane;
class Test3 {
    public static void main(String[] args) {
        int a = Integer.parseInt(JOptionPane.showInputDialog("ç¬¬ä¸€ä¸ªæ•°"));
        int b = Integer.parseInt(JOptionPane.showInputDialog("ç¬¬äºŒä¸ªæ•°"));
        //æ±‚2ä¸ªæ•°çš„æœ€å¤§å…¬çº¦æ•°
        int a1 = 0 ;
        for(int i = 1; i <= a && i <= b; i++){
            //æ‰¾å‡ºèƒ½è¢«aæ•´é™¤å’Œbæ•´é™¤çš„æ•°
            if(a % i == 0 && b % i == 0){
                //æ‰¾å‡ºæœ€å¤§çš„å…¬çº¦æ•°
                    a1 = i ;
            }
        }
        System.out.println(a1);
    }
}
```

1.  æ•°ç»„çš„å®šä¹‰åŠåˆå§‹åŒ–

```java
//æ•°ç»„çš„å®šä¹‰ èµ‹å€¼
import javax.swing.JOptionPane ;
class Test1 {
    public static void main(String[] args) {
        int[] a = new int[10];
        for(int i = 0 ; i <= 9 ; i++)
            a[i] = i+1;
        for(int j = 0 ; j <= 9 ; j++)
            System.out.println(a[j]);

        int[] a1 = new int[4];
        for(int i = 0 ; i < a1.length ;  i++){
            a1[i] = Integer.parseInt(JOptionPane.showInputDialog("è¯·è¾“å…¥ç¬¬"+(i+1)+"ä¸ªæ•°"));
        }
        for(int i = 0 ;i < a1.length; i++){
            System.out.println(a1[i]);
        }
    }
}
```

1.  å­—ç¬¦ä¸²æ•°ç»„çš„å®šä¹‰åŠèµ‹å€¼

```java
import javax.swing.JOptionPane;
class Test2 {
    public static void main(String[] args) {
        String[] name = new String[3];
        //String name ;
        for(int i = 0 ; i < name.length; i++){
            name[i] = JOptionPane.showInputDialog("è¯·è¾“å…¥å§“å");
        }
        for(int i = 0 ; i < name.length ; i++)
            System.out.println(name[i]);
    }
}
```

1.  æ±‚æ•°ç»„ä¸­æœ€å¤§å€¼

```java

class Test3 {
    public static void main(String[] args) {
        int[] a = {4,58,34,50,21,42};
        //æ‰¾å‡ºæ•°ç»„ä¸­æœ€å¤§çš„æ•°
        int count = 0;
        int max = a[0];
        for(int i = 1 ; i < a.length - 1 ; i ++){
            if(max < a[i]){
                max = a[i];
                count = i;
            }
        }
        System.out.println("æœ€å¤§çš„æ•°æ˜¯: "+ max+"æœ€å¤§æ•°çš„ä¸‹æ ‡:"+count);


    }
}
```

1.  æŸ¥æ‰¾å­—ç¬¦ä¸²æ•°ç»„ä¸­çš„ç‰¹å®šå€¼

```java
import javax.swing.JOptionPane;
class Test4 {
    public static void main(String[] args) {
        String[] str = {"å¼ ä¸‰","æå››","ç‹å…­åŠ äºŒ","èµµå…­","ç”°ä¸ƒ"};
        String s = JOptionPane.showInputDialog("æ‰¾è°?");
        int count = -1 ;
        //boolean on_off = true;
        for(int i = 0 ; i < str.length ; i ++){
            //on_off = false;
            if(s.equals(str[i])){
                count  = i;
                JOptionPane.showMessageDialog(null,"æ‰¾åˆ°äº†"+"ä½ç½®åœ¨:"+(count+1));
                //on_off = true ;
                break ;
            }
        }
        if(count == -1)
            JOptionPane.showMessageDialog(null,"æœªæ‰¾åˆ°");
    }
}
```

1.  5.

```java
import javax.swing.JOptionPane;
class Test5 {
    public static void main(String[] args) {
        String[] nameArray = new String[4];
        int[] moneyArray = new int[4];
        for(int i = 0 ; i < nameArray.length ; i ++){
            nameArray[i] = JOptionPane.showInputDialog("è¯·è¾“å…¥ç¬¬"+(i+1)+"ä¸ªäººçš„åå­—");
            moneyArray[i] = Integer.parseInt(JOptionPane.showInputDialog("è¯·è¾“å…¥ç¬¬"+(i+1)+"ä¸ªäººçš„å·¥èµ„"));
        }
        int max = -1 ;
        int bb =  -1 ;
        for(int k = 0 ; k < moneyArray.length ; k ++){
            if(max < moneyArray[k]){
                max = moneyArray[k];
                bb = k ;
            }
        }
        String s = "å§“å:           å·¥èµ„\n";

        for(int j = 0 ; j < nameArray.length; j++){
            /*System.out.print(nameArray[j]+" ");
            System.out.print(moneyArray[j]);
            System.out.println();*/
            s +=nameArray[j] + "          "+moneyArray[j]+"\n";
        }
        JOptionPane.showMessageDialog(null,s);
        JOptionPane.showMessageDialog(null,"å·¥èµ„æœ€é«˜:"+ max +"äºº:"+nameArray[bb]);
    }
}
```

1.  6.

```java

//æŸ¥æ‰¾å·¥èµ„
import javax.swing.JOptionPane;
class Test6 {
    public static void main(String[] args) {
        String[] nameArray = {"é˜¿ä¸€","é˜¿äºŒ","é˜¿ä¸‰","é˜¿å››","é˜¿äº”","é˜¿å…­"};
        int[] moneyArray = {3500,8500,6412,8964,5105,6982};
        //è¦æ±‚:è¾“å…¥å§“å,è¾“å‡ºä»–çš„å·¥èµ„
        String s = JOptionPane.showInputDialog("è¯·è¾“å…¥è¦æŸ¥æ‰¾çš„å§“å:");
        int index = -1 ;
        for(int i = 0 ; i < nameArray.length ; i ++) {
            if(s.equals(nameArray[i])){
                index = i;
                break ;
            }
        }

        if(index == -1 )
            JOptionPane.showMessageDialog(null,"æ— æ­¤äºº,  æ»šç²—");
        else
            JOptionPane.showMessageDialog(null,"å§“å:"+nameArray[index] + " å·¥èµ„:"+moneyArray[index]);
    }
}
```

1.  åˆ é™¤æ•°ç»„ä¸­æŸä¸ªå…ƒç´ 

```java

//åˆ é™¤æ•°ç»„ä¸­çš„æŸä¸ªå…ƒç´ 
import javax.swing.JOptionPane;
class Test7 {
    public static void main(String[] args) {
        int[] a = {3,5,7,9,12};
        int length = a.length;
        for(int i = 0 ; i < a.length ; i ++)
            System.out.println(a[i]);
        int deletNum = Integer.parseInt(JOptionPane.showInputDialog("è¯·è¾“å…¥ä¸€ä¸ªæ•°"));
        for(int j = 0 ; j < length ; j ++){
            //æ‰¾å‡ºé‚£ä¸ªæ•°,åˆ é™¤
            if(deletNum == a[j]) {
                //ç”¨åä¸€ä¸ªæ•°è¦†ç›–å‰é¢çš„æ•°
                for(int k = j ; k < length -1; k ++){
                    a[k] = a[k+1];
                }
            }
        }
        for(int i = 0 ; i < a.length-1 ; i ++)
            System.out.println(a[i]);
    }
}
```

1.  æ’åº

```java

class Test9 {
    public static void main(String[] args) {
        int[] a = {3,8,2,1,6};

        for(int i = 0 ; i < a.length ; i ++){
            for(int j = i + 1 ; j < a.length ; j ++){
                //ç¬¬ä¸€è½®,æ‰¾å‡ºæœ€å°çš„æ•°,æ”¾åˆ°0å·ä½
                if(a[i] > a[j]) {
                    a[i] = a[i] ^ a[j];
                    a[j] = a[j] ^ a[i];
                    a[i] = a[i] ^ a[j];
                }
            }
        }
        for(int k = 0 ; k < a.length; k++)
            System.out.println(a[k]);
    }
}
```

```java

import javax.swing.JOptionPane;
class Demo {
    public static void main(String[] args) {
        //åˆå§‹åŒ–æ•°ç»„
        String[] nameArray = new String[4];
        int[] moneyArray = new int[4];
        for(int i = 0 ; i < nameArray.length ; i ++){
            nameArray[i] = JOptionPane.showInputDialog("è¯·è¾“å…¥ç¬¬"+(i+1)+"ä¸ªäººçš„åå­—");
            moneyArray[i] = Integer.parseInt(JOptionPane.showInputDialog("è¯·è¾“å…¥ç¬¬"+(i+1)+"ä¸ªäººçš„å·¥èµ„"));
        }

        String s = "å§“å:             å·¥èµ„:"+"\n";
        for(int j = 0 ; j < nameArray.length ; j++){
            System.out.println(nameArray[j]+"     "+moneyArray[j]);
            s += nameArray[j]+"                 "+moneyArray[j]+"\n";
        }
        JOptionPane.showMessageDialog(null,"æ’åºå‰:\n"+s);

        //æ’åº æŒ‰ç…§å·¥èµ„æ’ååå­—ï¼Œå¹¶ä¸”ç”¨å¼¹å‡ºæ¡†å¼¹å‡ºæ¥.
        //å› ä¸ºå­˜å‚¨åå­—çš„æ•°ç»„å’Œå·¥èµ„çš„æ•°ç»„é•¿åº¦ä¸€æ ·,åªè¦å°†å·¥èµ„æ•°ç»„æ’åº,é¡ºå¸¦å°†åå­—ä¹Ÿæ’åºäº†,ç„¶åæ‰“å°è¾“å‡º
        //moneyArrayæ•°ç»„-->ç”±å¤§åˆ°å°æ’åº
        //ç¬¬ä¸€æ¬¡å¾ªç¯,æŠŠç¬¬ä¸€ä¸ªå…ƒç´ åŒåé¢çš„å…ƒç´ ä¸€ä¸€å¯¹æ¯”,å°†ç¬¬ä¸€å¤§çš„æ•°æ’åˆ°ç¬¬ä¸€ä½
        String temp = null;
        for(int i = 0 ; i < moneyArray.length ; i ++) {
            for(int j = i + 1 ; j < moneyArray.length ; j++) {
                //äº¤æ¢æ•°å€¼,æŠŠå¤§æ•°æ”¾ç¬¬ä¸€ä½
                if(moneyArray[i] < moneyArray[j]) {
                    //è¿™æ˜¯æ’çš„å·¥èµ„
                    moneyArray[i] = moneyArray[i] ^ moneyArray[j];
                    moneyArray[j] = moneyArray[j] ^ moneyArray[i];
                    moneyArray[i] = moneyArray[i] ^ moneyArray[j];

                    //æ’åå­—
                    temp = nameArray[i] ;
                    nameArray[i] = nameArray[j];
                    nameArray[j] = temp ;
                }
            }
        }
        String str = "å§“å:             å·¥èµ„:"+"\n";
        for(int j = 0 ; j < moneyArray.length ; j++)
            str += nameArray[j]+"                 "+moneyArray[j]+"\n";
        JOptionPane.showMessageDialog(null,"æ’åºå:\n"+str);
    }
}
```

## [Javaæ•°æ®ç±»å‹è½¬æ¢ï¼šå®æˆ˜æ¡ˆä¾‹è§£æ](https://blog.dong4j.site/posts/3daa4bf4.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

double > float > long > int > short > byte  
A. å°ç±»å‹è½¬å¤§ç±»å‹æ˜¯è‡ªåŠ¨è½¬æ¢ (å‘ä¸Šè½¬å‹);  
B. å¤§ç±»å‹è½¬å°ç±»å‹ä¼šå‘ç”Ÿç²¾åº¦ä¸¢å¤±, ä¹Ÿæœ‰å¯èƒ½å‘ç”Ÿæ•°æ®æº¢å‡º, æ‰€ä»¥ç¼–è¯‘å™¨è¦æ±‚æˆ‘ä»¬å¿…é¡»å¼ºåˆ¶è½¬æ¢, å¦åˆ™ä¼šæœ‰ç¼–è¯‘é”™è¯¯.

```
int i = 1 , j ;                     //æ­£ç¡®:å¯¹äº j è¿™é‡Œåªæ˜¯å®šä¹‰,æ²¡æœ‰åˆå§‹åŒ–.
float f1  = 0.1 ;                   //é”™è¯¯:åœ¨javaä¸­,æœ‰å°æ•°çš„æ•°å€¼é»˜è®¤ä¸ºdoubleç±»å‹,æ‰€ä»¥ç»“æœä¸ºdoubleç±»å‹ï¼Œçœ‹Bè§£é‡Š
float f2 = 123;                     //æ­£ç¡®: ç»“æœä¸ºintç±»å‹,è‡ªåŠ¨è½¬æ¢æˆfloatç±»å‹,Aè§£é‡Š
double d1 = 2e20,d2 = 123;          //æ­£ç¡®:Aè§£é‡Š
byte b1 = 1,b2 = 2 ,b3 = 129;       //é”™è¯¯: b1,b2æ²¡æœ‰é”™,Aè§£é‡Š;b3è¶…è¿‡èŒƒå›´.
j = j + 10;                         //é”™è¯¯:åªæœ‰å®šä¹‰ æ²¡æœ‰åˆå§‹åŒ–
i= i / 10;                          //æ­£ç¡®:
i = i * 0.1;                        //é”™è¯¯:iå…ˆè‡ªåŠ¨è½¬å‹ä¸ºdouble,æ‰€ä»¥ç»“æœä¸ºdoubleç±»å‹,çœ‹Bè§£é‡Š.
char c1 = 'a',c2 = 125;             //æ­£ç¡®:
byte b = b1 - b2;                   //é”™è¯¯:ç»“æœä¸ºinç±»å‹
char c = c1 + c2 -1;                //é”™è¯¯:ç»“æœä¸ºintç±»å‹,çœ‹Bè§£é‡Š
float f3 = f1 + f2 ;                //æ­£ç¡®:åœ¨f1å’Œf2ä¸ºfloatä¸ºå‰ææ¡ä»¶ä¸‹
float f4 = f1 + f2*0.1;             //é”™è¯¯:å…ˆæ˜¯f2è½¬æ¢æˆdouble,ç„¶åf1è½¬æ¢ä¸ºdouble,æ‰€ä»¥ç»“æœä¸ºdoubleç±»å‹,çœ‹Bè§£é‡Š
double d = d1*i + j;                //é”™è¯¯:jæœªåˆå§‹åŒ–.
float f = (float)(d1*5 + d2);       //æ­£ç¡®:ç»“æœä¸ºdouble,ä½†æ˜¯å¼ºåˆ¶è½¬æ¢æˆäº†float,çœ‹Bè§£é‡Š.
```

## **if åˆ¤æ–­è¯­å¥**

1.  if - else

```java
if(åˆ¤æ–­æ¡ä»¶) {
    æ‰§è¡Œè¯­å¥;
}else {
    æ‰§è¡Œè¯­å¥;
}
```

1.  if - else if

```java
if(åˆ¤æ–­æ¡ä»¶){
    æ‰§è¡Œè¯­å¥;
}else if(åˆ¤æ–­æ¡ä»¶) {
    æ‰§è¡Œè¯­å¥;
}
...
else if(åˆ¤æ–­æ¡ä»¶) {
    æ‰§è¡Œè¯­å¥;
}
```

3.

```java
if(åˆ¤æ–­æ¡ä»¶){
    æ‰§è¡Œè¯­å¥;
}else if(åˆ¤æ–­æ¡ä»¶) {
    æ‰§è¡Œè¯­å¥;
}
...
else if(åˆ¤æ–­æ¡ä»¶) {
    æ‰§è¡Œè¯­å¥;
}else {
    æ‰§è¡Œè¯­å¥;
}
```

### **ç»ƒä¹ :**

è¦æ±‚:

- è¾“å…¥æˆç»©, ç»™å‡ºç­‰çº§;
- A:100-90;
- B:89-80
- C:79-70
- D:69-60
- ä¸åŠæ ¼: å°äº 59
- è¾“å…¥ quit é€€å‡ºç¨‹åº;

```java
import javax.swing.JOptionPane;
import java.util.regex.Matcher; //æ­£åˆ™è¡¨è¾¾å¼çš„ç±»
class Demo {
    public static void main(String[] args) {
        while(true){
            String s = JOptionPane.showInputDialog(null,"è¯·è¾“å…¥æˆç»©");
            //å¦‚æœè¾“å…¥çš„æ˜¯æ•°å­—,åˆ™åˆ¤æ–­æˆç»©;
            if(s.matches("^[0-9]{1,3}$")){
                int num = Integer.parseInt(s);
                //System.out.println(num);
                if(num >= 90 )
                    JOptionPane.showMessageDialog(null,"ç­‰çº§:A");
                else if(num >= 80)
                    JOptionPane.showMessageDialog(null,"ç­‰çº§:B");
                else if(num >= 70)
                    JOptionPane.showMessageDialog(null,"ç­‰çº§:C");
                else if(num >= 60)
                    JOptionPane.showMessageDialog(null,"ç­‰çº§:D");
                else if(num <= 59 )
                    JOptionPane.showMessageDialog(null,"ä¸åŠæ ¼");
            }
            //è¾“å…¥quitæ—¶é€€å‡ºç¨‹åº
            else if(s.equals("quit")){
                return ;
            }
            else
                JOptionPane.showMessageDialog(null,"è¾“å…¥é”™è¯¯,è¯·é‡æ–°è¾“å…¥");
        }
    }
}
```

### **ä½œä¸šä¸€**

```java
/*
* è¾“å…¥ä¸¤ä¸ªæ•°,ç„¶åå¼¹å‡ºé€‰æ‹©æ¡†:1.åŠ ,2.å‡,3.ä¹˜,4.é™¤.ç„¶åæ ¹æ®é€‰æ‹©æ“ä½œç¬¦,è®¡ç®—ç»“æœ
*  ä¸¤ä¸ªæ•°å¯ä»¥æ˜¯æ­£è´Ÿæ•°,å¯ä»¥æ˜¯å°æ•°
*/
import javax.swing.JOptionPane;
class Operation {
    public static void Result (double number1, double number2 ,String operate) {
        switch (operate){
            case "1":{
                JOptionPane.showMessageDialog(null,number1+" + "+number2+" = "+(number1+number2));
                break;
            }
            case "2":{
                JOptionPane.showMessageDialog(null,number1+" - "+number2+" = "+(number1-number2));
                break;
            }
            case "3":{
                JOptionPane.showMessageDialog(null,number1+" * "+number2+" = "+(number1*number2));
                break;
            }
            case "4":{
                if(number2 != 0){
                    JOptionPane.showMessageDialog(null,number1+" / "+number2+" = "+(number1/number2));
                }else
                    JOptionPane.showMessageDialog(null,"è¢«é™¤æ•°ä¸èƒ½ä¸º0");
                break;
            }

        }
    }
}
class OperationTest {
    public static void main(String[] args) {
        while(true){
            try{//try catch è¯­å¥æ˜¯ä¸ºäº†åˆ¤æ–­è¾“å…¥æ˜¯å¦ç¬¦åˆè¦æ±‚,å¦‚æœä¸æ˜¯ä¸€ä¸ªæ•°å­—,åˆ™è½¬åˆ°catchè¯­å¥
                String s1 = JOptionPane.showInputDialog(null,"è¯·è¾“å…¥ç¬¬ä¸€ä¸ªæ•°");
                String s2 = JOptionPane.showInputDialog(null,"è¯·è¾“å…¥ç¬¬äºŒä¸ªæ•°");
                String s = JOptionPane.showInputDialog(null,"è¯·é€‰æ‹©ç®—æ³•:1.åŠ æ³•,2.å‡æ³•,3.ä¹˜æ³•,4.é™¤æ³•;\"quit\"é€€å‡º");
                if (s.equals("quit"))
                    return ;
                //System.out.println(s);
                double firstNumber = Double.parseDouble(s1);
                double secondNumber = Double.parseDouble(s2);
                Operation.Result(firstNumber,secondNumber,s);
            }catch(Exception e){
                JOptionPane.showMessageDialog(null,"è¾“å…¥æœ‰è¯¯,è¯·é‡æ–°è¾“å…¥");
            }
        }
    }
}
```

### **ä½œä¸šäºŒ**

```java
// é”®ç›˜è¾“å…¥ä¸€ä¸ªäº”ä½æ•°,åˆ¤æ–­è¿™ä¸ªæ•°æ˜¯å¦ä¸ºå›æ–‡(1.å®ƒçš„æ˜¯æ•°å­—;2.æ˜¯æ­£æ•´æ•°;3.5ä½æ•°;4.æ˜¯å¦ä¸ºå›æ–‡æ•°)
import javax.swing.JOptionPane;
class PalindromicNumber {
    public static void main(String[] args) {
        String s ;
        int num ;
        JOptionPane.showMessageDialog(null,"è¾“å…¥ quit é€€å‡º,å›è½¦ç»§ç»­");
        //åˆ¤æ–­è¿™ä¸ªæ•°æ˜¯å¦ç¬¦åˆè¦æ±‚ å…ˆåˆ¤æ–­å®ƒæ˜¯ä¸æ˜¯ä¸€ä¸ªæ•°å­—
        while(true){
            s =  JOptionPane.showInputDialog(null,"è¯·è¾“å…¥ä¸€ä¸ª5ä½æ•´æ•°");
            try {
            //åˆ¤æ–­å®ƒæ˜¯ä¸æ˜¯ä¸€ä¸ª5ä½æ•°,2ç§æ–¹æ³•:1.9 <= num/10000 >= 1; 2.toCharArray.length == 5
            num = Integer.parseInt(s); //è¿™ä¸ªæ˜¯ä¸ºäº†try catchè¯­å¥åˆ¤æ–­æ˜¯ä¸æ˜¯ä¸€ä¸ªæ•°å­—
            if(num < 0 ){
                JOptionPane.showMessageDialog(null,"è¯·è¾“å…¥æ­£æ•´æ•°");
                continue ;
            }
            //System.out.println(num);
            //ç”¨ç¬¬äºŒä¸­æ–¹æ³•åˆ¤æ–­å®ƒæ˜¯ä¸æ˜¯ä¸€ä¸ª5ä½æ•°
            char[] charArray = s.toCharArray();
            System.out.println(charArray.length);
            if(5 == charArray.length){
                //åˆ¤æ–­æ˜¯ä¸æ˜¯å›æ–‡æ•°
                //for(int i = 0 ; i < charArray.length ; i++)
                //  System.out.println( charArray[i] );//æ‰“å°è¾“å…¥æ•°ç»„
                boolean on_off = false ;
                for(int j = 0 ; j < charArray.length/2 ;j++) {
                    if(charArray[j] == charArray[charArray.length -1 - j])
                        on_off = true ;
                }
                if (on_off)
                    JOptionPane.showMessageDialog(null,"æ˜¯å›æ–‡æ•°");
                else
                    JOptionPane.showMessageDialog(null,"ä¸æ˜¯å›æ–‡æ•°");
            }else
                JOptionPane.showMessageDialog(null,"è¯·è¾“å…¥ä¸€ä¸ª5ä½çš„æ•´æ•°");
            }catch (Exception e){
                if(s.equals("quit"))
                    return ;
                JOptionPane.showMessageDialog(null,"è¯·æ­£ç¡®è¾“å…¥ä¸€ä¸ª5ä½æ•´æ•°");
            }
        }
    }
}
```

### **å›æ–‡æ•°ç»ƒä¹ **

ä¸ç”¨æ•°ç»„çš„æ–¹æ³•æ‰“å° 1-100000 ä¹‹é—´æ‰€æœ‰çš„å›æ–‡æ•°

```java
class PalindromicNumber2 {
    public static void main(String[] args) {
       int k = 0,num;
       for(int i = 0 ; i <= 1000000 ; i++){
            num = i ;
            while (num != 0){
                //å°†numçš„æ•°åè½¬å­˜å‚¨åˆ°kä¸­
                k = k*10 + num%10;
                num = num/10;
                //System.out.println("k= "+k+"\n"+"i = "+i+"\n");
            }
            if(k == i){
                System.out.println(i);
            }
            k = 0;
       }
    }
}
```

## [Javaå…¥é—¨å¿…å¤‡ï¼šç¯å¢ƒé…ç½®ä¸é«˜æ•ˆå¼€å‘æŠ€å·§](https://blog.dong4j.site/posts/ff9e7ddd.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

Java æ˜¯ä¸€ç§å¯ä»¥æ’°å†™è·¨å¹³å°åº”ç”¨è½¯ä»¶çš„é¢å‘å¯¹è±¡çš„ç¨‹åºè®¾è®¡è¯­è¨€ã€‚Java æŠ€æœ¯å…·æœ‰å“è¶Šçš„é€šç”¨æ€§ã€é«˜æ•ˆæ€§ã€å¹³å°ç§»æ¤æ€§å’Œå®‰å…¨æ€§ï¼Œå¹¿æ³›åº”ç”¨äº PCã€æ•°æ®ä¸­å¿ƒã€æ¸¸æˆæ§åˆ¶å°ã€ç§‘å­¦è¶…çº§è®¡ç®—æœºã€ç§»åŠ¨ç”µè¯å’Œäº’è”ç½‘ï¼ŒåŒæ—¶æ‹¥æœ‰å…¨çƒæœ€å¤§çš„å¼€å‘è€…ä¸“ä¸šç¤¾ç¾¤ã€‚

### **èƒŒæ™¯**

Java æ˜¯ç”± Sun Microsystems å…¬å¸æ¨å‡ºçš„ Java é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡è¯­è¨€ï¼ˆä»¥ä¸‹ç®€ç§° Java è¯­è¨€ï¼‰å’Œ Java å¹³å°çš„æ€»ç§°ã€‚ç”± James Gosling å’ŒåŒäº‹ä»¬å…±åŒç ”å‘ï¼Œå¹¶åœ¨ 1995 å¹´æ­£å¼æ¨å‡ºã€‚Java æœ€åˆè¢«ç§°ä¸º Oakï¼Œæ˜¯ 1991 å¹´ä¸ºæ¶ˆè´¹ç±»ç”µå­äº§å“çš„åµŒå…¥å¼èŠ¯ç‰‡è€Œè®¾è®¡çš„ã€‚1995 å¹´æ›´åä¸º Javaï¼Œå¹¶é‡æ–°è®¾è®¡ç”¨äºå¼€å‘ Internet åº”ç”¨ç¨‹åºã€‚ç”¨ Java å®ç°çš„ HotJava æµè§ˆå™¨ï¼ˆæ”¯æŒ Java appletï¼‰æ˜¾ç¤ºäº† Java çš„é­…åŠ›ï¼šè·¨å¹³å°ã€åŠ¨æ€ Webã€Internet è®¡ç®—ã€‚ä»æ­¤ï¼ŒJava è¢«å¹¿æ³›æ¥å—å¹¶æ¨åŠ¨äº† Web çš„è¿…é€Ÿå‘å±•ï¼Œå¸¸ç”¨çš„æµè§ˆå™¨å‡æ”¯æŒ Javaappletã€‚å¦ä¸€æ–¹é¢ï¼ŒJava æŠ€æœ¯ä¹Ÿä¸æ–­æ›´æ–°ã€‚Java è‡ªé¢ä¸–åå°±éå¸¸æµè¡Œï¼Œå‘å±•è¿…é€Ÿï¼Œå¯¹ C++ è¯­è¨€å½¢æˆæœ‰åŠ›å†²å‡»ã€‚åœ¨å…¨çƒäº‘è®¡ç®—å’Œç§»åŠ¨äº’è”ç½‘çš„äº§ä¸šç¯å¢ƒä¸‹ï¼ŒJava æ›´å…·å¤‡äº†æ˜¾è‘—ä¼˜åŠ¿å’Œå¹¿é˜”å‰æ™¯ã€‚2010 å¹´ Oracle å…¬å¸æ”¶è´­ Sun Microsystemsã€‚

### **ä½“ç³»**

java åˆ†ä¸‰ä¸ªä½“ç³»

1. JavaSE ï¼ˆJava 2 Platform, Standard Editionï¼‰
2. JavaEE ï¼ˆJava 2 Platform, Enterprise Editionï¼‰
3. JavaME ï¼ˆJava 2 Platform, Micro Editionï¼‰

### **ç‰¹ç‚¹**

- ç®€å•æ€§
  - Java å®¹æ˜“å­¦ä¹ ï¼Œç›¸å¯¹äº C++ è€Œè¨€æ›´åŠ çº¯å‡€ã€‚
  - å°ï¼ŒåŸºæœ¬çš„è§£é‡Šå™¨ä»¥åŠç±»æ”¯æŒä»…æœ‰ 40k.
- é¢å‘å¯¹è±¡çš„è¯­è¨€ï¼ˆOOï¼‰
  - å°è£…
  - ç»§æ‰¿
  - å¤šè‚½
  - æ–¹æ³•é‡è½½
  - æ–¹æ³•è¦†ç›–
- ä¸€ç§ä¸å¹³å°æ— å…³çš„è¯­è¨€
  - è§£é‡Šæ€§è¯­è¨€ï¼Œä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œï¼ˆJVMï¼‰
- å¥å£®æ€§å’Œå®‰å…¨æ€§
  - åˆ é™¤äº†æŒ‡é’ˆå’Œé‡Šæ”¾å†…å­˜ç­‰ C++ åŠŸèƒ½ï¼Œé¿å…äº†éæ³•å†…å­˜æ“ä½œã€‚
  - é€šè¿‡ Java çš„å®‰å…¨ä½“ç³»æ¶æ„æ¥ç¡®ä¿ Java ä»£ç çš„å®‰å…¨æ€§ã€‚
- å¤šçº¿ç¨‹
  - å¤šçº¿ç¨‹åº”ç”¨ç¨‹åºèƒ½å¤ŸåŒæ—¶è¿è¡Œå¤šé¡¹ä»»åŠ¡ã€‚
  - Java ä¸­å®ç°å¤šçº¿ç¨‹ç›¸å¯¹äºå…¶ä»–è¯­è¨€å…·æœ‰ç‹¬ç‰¹çš„ä¼˜åŠ¿ã€‚
- åƒåœ¾å›æ”¶
  - åƒåœ¾æ”¶é›†æœºåˆ¶ï¼ˆGarbage collectionï¼‰
    - ä»€ä¹ˆæ˜¯åƒåœ¾ï¼Ÿ  
      æ— ä»»ä½•å¼•ç”¨çš„å¯¹è±¡å æ®çš„å†…å­˜ç©ºé—´  
      C/C++ æ˜¯ç”±ç¨‹åºå‘˜è´Ÿè´£å›æ”¶æ— ç”¨å†…å­˜ï¼Œ  
      **java ä¸­ç¨‹åºå‘˜æ— æ³•æ§åˆ¶å’Œå¹²é¢„ï¼Œåªèƒ½ç”±ç³»ç»Ÿå†³å®šä»€ä¹ˆæ—¶å€™å›æ”¶åƒåœ¾**

### **å…³é”®å­—**

| å…³é”®å­—       | æè¿°                                         |
| ------------ | -------------------------------------------- |
| abstract     | æŠ½è±¡æ–¹æ³•ï¼ŒæŠ½è±¡ç±»çš„ä¿®é¥°ç¬¦                     |
| assert       | æ–­è¨€æ¡ä»¶æ˜¯å¦æ»¡è¶³                             |
| continue     | ä¸æ‰§è¡Œå¾ªç¯ä½“å‰©ä½™éƒ¨åˆ†                         |
| default      | switch è¯­å¥ä¸­çš„é»˜è®¤åˆ†æ”¯                      |
| do-while     | å¾ªç¯è¯­å¥ï¼Œå¾ªç¯ä½“è‡³å°‘ä¼šæ‰§è¡Œä¸€æ¬¡               |
| double       | 64-bit åŒç²¾åº¦æµ®ç‚¹æ•°                          |
| else         | if æ¡ä»¶ä¸æˆç«‹æ—¶æ‰§è¡Œçš„åˆ†æ”¯                    |
| enum         | æšä¸¾ç±»å‹                                     |
| extends      | è¡¨ç¤ºä¸€ä¸ªç±»æ˜¯å¦ä¸€ä¸ªç±»çš„å­ç±»                   |
| final        | è¡¨ç¤ºå®šä¹‰å¸¸é‡                                 |
| finally      | æ— è®ºæœ‰æ²¡æœ‰å¼‚å¸¸å‘ç”Ÿéƒ½æ‰§è¡Œä»£ç                  |
| float        | 32-bit å•ç²¾åº¦æµ®ç‚¹æ•°                          |
| for          | for å¾ªç¯è¯­å¥                                 |
| goto         | ç”¨äºæµç¨‹æ§åˆ¶                                 |
| if           | æ¡ä»¶è¯­å¥                                     |
| implements   | è¡¨ç¤ºä¸€ä¸ªç±»å®ç°äº†æ¥å£                         |
| import       | å¯¼å…¥ç±»                                       |
| implements   | æµ‹è¯•ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æ˜¯æŸä¸ªç±»çš„å®ä¾‹               |
| int          | 32 ä½æ•´å‹æ•°                                  |
| interface    | æ¥å£ï¼Œä¸€ç§æŠ½è±¡çš„ç±»å‹ï¼Œä»…æœ‰æ–¹æ³•å’Œå¸¸é‡çš„å®šä¹‰   |
| long         | 64 ä½æ•´å‹æ•°                                  |
| native       | è¡¨ç¤ºæ–¹æ³•ç”¨é java ä»£ç å®ç°                   |
| new          | åˆ†é…æ–°çš„ç±»å®ä¾‹                               |
| package      | ä¸€ç³»åˆ—ç›¸å…³ç±»ç»„æˆä¸€ä¸ªåŒ…                       |
| private      | è¡¨ç¤ºç§æœ‰å­—æ®µï¼Œæˆ–è€…æ–¹æ³•ç­‰ï¼Œåªèƒ½ä»ç±»å†…éƒ¨è®¿é—®   |
| protected    | è¡¨ç¤ºä¿æŠ¤ç±»å‹å­—æ®µ                             |
| public       | è¡¨ç¤ºå…±æœ‰å±æ€§æˆ–è€…æ–¹æ³•                         |
| return       | æ–¹æ³•è¿”å›å€¼                                   |
| short        | 16 ä½æ•°å­—                                    |
| static       | è¡¨ç¤ºåœ¨ç±»çº§åˆ«å®šä¹‰ï¼Œæ‰€æœ‰å®ä¾‹å…±äº«çš„             |
| strictfp     | æµ®ç‚¹æ•°æ¯”è¾ƒä½¿ç”¨ä¸¥æ ¼çš„è§„åˆ™                     |
| super        | è¡¨ç¤ºåŸºç±»                                     |
| switch       | é€‰æ‹©è¯­å¥                                     |
| while        | while å¾ªç¯                                   |
| volatile     | æ ‡è®°å­—æ®µå¯èƒ½ä¼šè¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼Œè€Œä¸åšåŒæ­¥ |
| void         | æ ‡è®°æ–¹æ³•ä¸è¿”å›ä»»ä½•å€¼                         |
| try          | è¡¨ç¤ºä»£ç å—è¦åšå¼‚å¸¸å¤„ç†                       |
| transient    | ä¿®é¥°ä¸è¦åºåˆ—åŒ–çš„å­—æ®µ                         |
| throw        | æŠ›å‡ºå¼‚å¸¸                                     |
| this         | è°ƒç”¨å½“å‰å®ä¾‹æˆ–è€…è°ƒç”¨å¦ä¸€ä¸ªæ„é€ å‡½æ•°           |
| synchronized | è¡¨ç¤ºåŒä¸€æ—¶é—´åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹è®¿é—®çš„ä»£ç å—       |

### **JDK å’Œ JRE**

- JDK å«åš java å¼€å‘å·¥å…·é›†ã€‚åŒ…æ‹¬ java çš„ç¼–è¯‘ç¯å¢ƒã€è¿è¡Œç¯å¢ƒã€è°ƒè¯•ç¯å¢ƒï¼Œä»¥åŠåŸºç¡€ç±»åº“ã€‚
- JRE å«åš java è¿è¡Œç¯å¢ƒã€‚åŒ…æ‹¬è™šæ‹Ÿæœºã€æ ¸å¿ƒç±»åº“ï¼Œä»¥åŠé“¾æ¥æ–‡ä»¶ã€‚  
  **JDK åŒ…å« JRE**

## **æ•°æ®ç±»å‹ã€å˜é‡ã€å¸¸é‡**

### **æ•°æ®ç±»å‹**

- æ•°æ®ç±»å‹æ˜¯ä¸€ç§æ˜“äºäººç±»é˜…è¯»çš„æ ‡è®°ï¼Œç”¨æ¥è¡¨ç¤ºè®¡ç®—æœºå†…å­˜çš„ç‰¹å®šç”¨æ³•ã€‚
- åœ¨ç¨‹åºä¸­ä½¿ç”¨æ—¶ï¼Œæ•°æ®ç±»å‹è§„å®šæ‰€ä½¿ç”¨å†…å­˜çš„å¤§å°ä»¥åŠåœ¨è¯¥å†…å­˜ä¸­å¯å­˜æ”¾çš„æœ‰æ•ˆå€¼ã€‚
- Java æ˜¯ä¸€ç§å¼ºç±»å‹ç¼–ç¨‹è¯­è¨€ï¼Œè¿™æ„å‘³ç€åœ¨ Java ç¨‹åºä¸­ç”¨åˆ°çš„æ‰€æœ‰å˜é‡éƒ½å¿…é¡»æœ‰æ˜ç¡®å®šä¹‰çš„æ•°æ®ç±»å‹

#### **åŸºæœ¬æ•°æ®ç±»å‹**

##### æ•°å€¼å‹

| ç±»å‹   | A å ç”¨å­˜å‚¨ç©ºé—´  | èŒƒå›´                                                                   |
| ------ | --------------- | ---------------------------------------------------------------------- |
| byte   | 1 å­—èŠ‚ï¼ˆ8 ä½ï¼‰  | âˆ’27âˆ’27 åˆ° 27âˆ’127âˆ’1                                                     |
| short  | 2 å­—èŠ‚ï¼ˆ16 ä½ï¼‰ | âˆ’2Â  çš„ Â 15Â  æ¬¡æ–¹ âˆ’2 çš„ 15 æ¬¡æ–¹ Â  åˆ° Â 2Â  çš„ Â 15Â  æ¬¡æ–¹ âˆ’12 çš„ 15 æ¬¡æ–¹ âˆ’1 |
| int    | 4 å­—èŠ‚ï¼ˆ32 ä½ï¼‰ | âˆ’2Â  çš„ Â 31Â  æ¬¡æ–¹ âˆ’2 çš„ 31 æ¬¡æ–¹åˆ° 2Â  çš„ Â 31Â  æ¬¡æ–¹ âˆ’12 çš„ 31 æ¬¡æ–¹ âˆ’1     |
| long   | 8 å­—èŠ‚ï¼ˆ64 ä½ï¼‰ | âˆ’2Â  çš„ Â 63Â  æ¬¡æ–¹ âˆ’2 çš„ 63 æ¬¡æ–¹åˆ° 2Â  çš„ Â 63Â  æ¬¡æ–¹ âˆ’12 çš„ 63 æ¬¡æ–¹ âˆ’1     |
| float  | 4 å­—èŠ‚ï¼ˆ32 ä½ï¼‰ | âˆ’2Â  çš„ Â 31Â  æ¬¡æ–¹ âˆ’2 çš„ 31 æ¬¡æ–¹åˆ° 2Â  çš„ Â 31Â  æ¬¡æ–¹ âˆ’12 çš„ 31 æ¬¡æ–¹ âˆ’1     |
| double | 8 å­—èŠ‚ï¼ˆ64 ä½ï¼‰ | âˆ’2Â  çš„ Â 63Â  æ¬¡æ–¹ âˆ’2 çš„ 63 æ¬¡æ–¹åˆ° 2Â  çš„ Â 63Â  æ¬¡æ–¹ âˆ’12 çš„ 63 æ¬¡æ–¹ âˆ’1     |

##### **å­—ç¬¦å‹**

- char å‹æ•°æ®ç”¨æ¥è¡¨ç¤ºé€šå¸¸æ„ä¹‰ä¸Š â€œå­—ç¬¦â€ã€‚
- å­—ç¬¦å¸¸é‡ä¸ºç”¨å•å¼•å·æ‹¬èµ·æ¥çš„å•ä¸ªå­—ç¬¦ã€‚
- Java å­—ç¬¦é‡‡ç”¨ Unicode ç¼–ç ï¼Œæ¯ä¸ªå­—ç¬¦å ä¸¤ä¸ªå­—èŠ‚ã€‚
  - â€˜Aâ€™çš„ç¼–ç æ˜¯ï¼š65 ä¾æ¬¡ç±»æ¨
  - â€˜aâ€™çš„ç¼–ç æ˜¯ï¼š97 ä¾æ¬¡ç±»æ¨
- Java è¯­è¨€ä¸­è¿˜å…è®¸ä½¿ç”¨è½¬ä¹‰ç¬¦ `\` æ¥å°†å…¶åçš„å­—ç¬¦è½¬å˜ä¸ºå…¶å®ƒçš„å«ä¹‰ã€‚ä¾‹å¦‚ `\n`,`\t`ã€‚

##### **boolean**

- boolean ç±»å‹é€‚äºé€»è¾‘è¿ç®—ï¼Œä¸€èˆ¬ç”¨äºç¨‹åºæµç¨‹æ§åˆ¶ã€‚
- boolean ç±»å‹æ•°æ®åªå…è®¸å–å€¼ true æˆ– false, ä¸å¯ä»¥ 0 æˆ–é 0 çš„æ•´æ•°æ›¿ä»£ false å’Œ true ï¼Œè¿™ç‚¹å’Œ C è¯­è¨€ä¸åŒã€‚
  - ç”¨æ³•ä¸¾ä¾‹ï¼š  
    boolean flag = true;  
    flag = 5 > 3;

##### **å£°æ˜å’Œåˆ›å»ºå˜é‡**

- Java å˜é‡æ˜¯ç¨‹åºä¸­æœ€åŸºæœ¬çš„å­˜å‚¨å•å…ƒï¼Œå…¶è¦ç´ åŒ…æ‹¬æ•°æ®ç±»å‹ï¼Œå˜é‡åå’Œå˜é‡å€¼ã€‚
- Java ç¨‹åºä¸­æ¯ä¸€ä¸ªå˜é‡éƒ½å±äºç‰¹å®šçš„æ•°æ®ç±»å‹ï¼Œåœ¨ä½¿ç”¨å‰å¿…é¡»å¯¹å…¶å£°æ˜ï¼Œå£°æ˜æ ¼å¼ä¸ºï¼š  
  æ•°æ®ç±»å‹ å˜é‡åï¼Œå˜é‡å€¼ï¼›
- å˜é‡å…¶å®æ˜¯å†…å­˜ä¸­çš„ä¸€å°å—åŒºåŸŸï¼Œä½¿ç”¨å˜é‡åæ¥è®¿é—®è¿™å—åŒºåŸŸã€‚

##### å˜é‡çš„åˆå§‹åŒ–

- å£°æ˜å˜é‡åï¼Œåº”è¯¥å¯¹å˜é‡è¿›è¡Œåˆå§‹åŒ–ï¼ˆå…»æˆä¹ æƒ¯ï¼‰
- åˆå§‹åŒ–çš„è¯­æ³•ï¼š  
  æ•°æ®ç±»å‹ å˜é‡å = åˆå§‹å€¼ï¼›
  - æ¯”å¦‚ï¼š  
    int i = 0;  
    ç­‰åŒäºï¼š  
    int i;  
    i = 0;

##### **å˜é‡çš„å†…å­˜ç»„ç»‡æ–¹å¼**

##### **å¸¸é‡**

- Java çš„å¸¸é‡å€¼ç”¨å­—ç¬¦ä¸²è¡¨ç¤ºï¼ŒåŒºåˆ†ä¸ºä¸åŒçš„æ•°æ®ç±»å‹ã€‚

  - å¦‚æ•´å‹å¸¸é‡ 123
  - å®å‹å¸¸é‡ 3.14
  - å­—ç¬¦å¸¸é‡â€™aâ€™
  - é€»è¾‘å¸¸é‡ trueã€false
  - å­—ç¬¦ä¸²å¸¸é‡â€helloworldâ€

- æ³¨æ„ï¼šåŒºåˆ†å­—ç¬¦å¸¸é‡å’Œå­—ç¬¦ä¸²å¸¸é‡ã€‚
- Java æµ®ç‚¹å‹å¸¸é‡é»˜è®¤ä¸º double å‹ï¼Œå¦‚è¦å£°æ˜ä¸€ä¸ªå¸¸é‡ä¸º float å‹ï¼Œåˆ™éœ€åœ¨æ•°å­—åé¢åŠ  f æˆ– Fã€‚
- æˆ‘ä»¬ä¹Ÿå¯ä»¥ç»™å¸¸é‡å‘½ä¸€ä¸ªæ ‡ç¤ºç¬¦å
- è¯­æ³•å¦‚ä¸‹ï¼š

  - final æ•°æ®ç±»å‹ æ ‡ç¤ºç¬¦ = å¸¸é‡å€¼ï¼›

- ç¬¦å·å¸¸é‡å£°æ˜çš„æ—¶å€™å¿…é¡»èµ‹å€¼
- åœ¨æ•´ä¸ªç¨‹åºä¸­ä¸èƒ½æ”¹å˜ä¸èƒ½é‡æ–°èµ‹å€¼

###### **ä¸ºä»€ä¹ˆä½¿ç”¨å¸¸é‡**

- ä½¿ç”¨ç¬¦å·å¸¸é‡çš„å¥½å¤„æ˜¯ï¼š
  - å«ä¹‰æ¸…æ¥šã€‚å¦‚ä¸Šé¢çš„ç¨‹åºä¸­ï¼Œçœ‹ç¨‹åºæ—¶ä» PRICE å°±å¯çŸ¥é“å®ƒä»£è¡¨ä»·æ ¼ã€‚
  - åœ¨éœ€è¦æ”¹å˜ä¸€ä¸ªå¸¸é‡æ—¶èƒ½åšåˆ° â€œä¸€æ”¹å…¨æ”¹â€ã€‚ä¾‹å¦‚åœ¨ç¨‹åºä¸­å¤šå¤„ç”¨åˆ°æŸç‰©å“çš„ä»·æ ¼ï¼Œå¦‚æœä»·æ ¼ç”¨å¸¸æ•°è¡¨ç¤ºï¼Œåˆ™åœ¨ä»·æ ¼è°ƒæ•´æ—¶ï¼Œå°±éœ€è¦åœ¨ç¨‹åºä¸­ä½œä½œå‡ºä¿®æ”¹ï¼Œè‹¥ç”¨ç¬¦å·å¸¸é‡ PRICE ä»£è¡¨ä»·æ ¼ï¼Œåªéœ€æ”¹åŠ¨ä¸€å¤„å³å¯ã€‚

##### **æ ‡è¯†ç¬¦**

- Java æ ‡è¯†ç¬¦å‘½åè§„åˆ™ï¼š
  - æ ‡è¯†ç¬¦ç”±å­—æ¯ã€ä¸‹åˆ’çº¿ `_`ã€ç¾å…ƒç¬¦â€œ$â€ æˆ–æ•°å­—ç»„æˆã€‚
  - æ ‡è¯†ç¬¦åº”ä»¥å­—æ¯ã€ä¸‹åˆ’çº¿ã€ç¾å…ƒç¬¦å¼€å¤´ã€‚
  - Java æ ‡è¯†ç¬¦å¤§å°å†™æ•æ„Ÿï¼Œé•¿åº¦æ— é™åˆ¶ã€‚
  - â€œè§åçŸ¥æ„â€ ã€‚
  - çº¦å®šä¿—æˆçš„è§„åˆ™

### **java ç¯å¢ƒå˜é‡é…ç½®**

#### ä»€ä¹ˆæ˜¯ç¯å¢ƒå˜é‡

ç¯å¢ƒå˜é‡ï¼ˆenvironment variablesï¼‰ä¸€èˆ¬æ˜¯æŒ‡åœ¨æ“ä½œç³»ç»Ÿä¸­ç”¨æ¥æŒ‡å®šæ“ä½œç³»ç»Ÿè¿è¡Œç¯å¢ƒçš„ä¸€äº›å‚æ•°ï¼Œå¦‚ï¼šä¸´æ—¶æ–‡ä»¶å¤¹ä½ç½®å’Œç³»ç»Ÿæ–‡ä»¶å¤¹ä½ç½®ç­‰ã€‚

ç¯å¢ƒå˜é‡æ˜¯åœ¨æ“ä½œç³»ç»Ÿä¸­ä¸€ä¸ªå…·æœ‰ç‰¹å®šåå­—çš„å¯¹è±¡ï¼Œå®ƒåŒ…å«äº†ä¸€ä¸ªæˆ–è€…å¤šä¸ªåº”ç”¨ç¨‹åºæ‰€å°†ä½¿ç”¨åˆ°çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ Windows å’Œ DOS æ“ä½œç³»ç»Ÿä¸­çš„ path ç¯å¢ƒå˜é‡ï¼Œå½“è¦æ±‚ç³»ç»Ÿè¿è¡Œä¸€ä¸ªç¨‹åºè€Œæ²¡æœ‰å‘Šè¯‰å®ƒç¨‹åºæ‰€åœ¨çš„å®Œæ•´è·¯å¾„æ—¶ï¼Œç³»ç»Ÿé™¤äº†åœ¨å½“å‰ç›®å½•ä¸‹é¢å¯»æ‰¾æ­¤ç¨‹åºå¤–ï¼Œè¿˜åº”åˆ° path ä¸­æŒ‡å®šçš„è·¯å¾„å»æ‰¾ã€‚ç”¨æˆ·é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæ¥æ›´å¥½çš„è¿è¡Œè¿›ç¨‹ã€‚

å¯ä»¥åœ¨ç”¨æˆ·å˜é‡å’Œç³»ç»Ÿç¯å¢ƒå˜é‡è®¾ç½®

**åŒºåˆ«**ï¼š ç”¨æˆ·å˜é‡åªèƒ½æ˜¯å½“å‰ç™»å½•çš„ç”¨æˆ·æ‰æœ‰æ•ˆæœ  
ç³»ç»Ÿå˜é‡æ˜¯ä½ ç”µè„‘ä¸Šçš„å…¨éƒ¨ç”¨æˆ·éƒ½å¯ä»¥ä½¿ç”¨

**ç¬¬ä¸€æ­¥**ï¼šè®¾ç½® JAVA_HOME å˜é‡  
JAVA_HOME çš„å€¼æ˜¯ä½ å®‰è£… java çš„ç›®å½•è·¯å¾„  
æ¯”å¦‚æˆ‘çš„ java å®‰è£…è·¯å¾„ `D:\java\jdk1.8.0_45`
**è®¾ç½®ï¼š**  
å˜é‡åï¼š**JAVA_HONE**  
å€¼ï¼š`D:\java\jdk1.8.0_45`
ç¬¬äºŒæ­¥ï¼šè®¾ç½® classpath å˜é‡  
è®¾ç½®  
å˜é‡åï¼š**classpath**  
å€¼ï¼š`.;%JAVA_HOME%\lib\dt.jar;%JAVA_HOME%\lib\tooles.jar`  
æ³¨æ„ï¼šä¸€å®šè¦åœ¨æœ€å‰é¢åŠ ä¸Š .; è¡¨ç¤ºåœ¨å½“å‰è·¯å¾„ä¸‹æŸ¥æ‰¾

ç¬¬ä¸‰æ­¥ï¼šè®¾ç½® Path å˜é‡ ï¼ˆç¯å¢ƒå˜é‡æœ‰ Path å˜é‡ï¼Œåªéœ€è¦åœ¨åé¢æ·»åŠ å€¼å³å¯ï¼‰  
è®¾ç½®ï¼š  
å˜é‡åï¼š**Path**  
å€¼ï¼š `;%JAVA_HOME%\bin;%JAVA_HOME%\jre\bin;(æ·»åŠ åˆ°æœ€åé¢ï¼Œæ³¨æ„åˆ†å·)`

**dt.jar** å’Œ **tools.jar** æ˜¯ä¸¤ä¸ª java æœ€åŸºæœ¬çš„åŒ…ï¼Œé‡Œé¢åŒ…å«äº†ä» java æœ€é‡è¦çš„ lang åŒ…åˆ°å„ç§é«˜çº§åŠŸèƒ½å¦‚å¯è§†åŒ–çš„ swing åŒ…ï¼Œæ˜¯ java å¿…ä¸å¯å°‘çš„ã€‚  
è€Œ path ä¸‹é¢çš„ bin é‡Œé¢éƒ½æ˜¯ java çš„å¯æ‰§è¡Œçš„ç¼–è¯‘å™¨åŠå…¶å·¥å…·ï¼Œå¦‚ javaï¼Œjavadoc ç­‰ï¼Œä½ åœ¨ä»»æ„çš„æ–‡ä»¶å¤¹ä¸‹é¢è¿è¡Œ cmd é”®å…¥ javacï¼Œç³»ç»Ÿå°±èƒ½è‡ªåŠ¨å¬è§ java çš„ç¼–è¯‘å™¨å°±æ˜¯å½’åŠŸäºè¿™ä¸ªç¯å¢ƒå˜é‡çš„è®¾ç½®

**rt.jar** æ˜¯ JAVA åŸºç¡€ç±»åº“ï¼Œ**dt.jar** æ˜¯å…³äºè¿è¡Œç¯å¢ƒçš„ç±»åº“ï¼Œ**tools.jar** æ˜¯å·¥å…·ç±»åº“

### **æŠŠ javac å’Œ java å‘½ä»¤æ·»åŠ åˆ°é¼ æ ‡å³é”®è¿è¡Œ**

æœ€å¸¸ç”¨çš„æ–¹æ³•å°±æ˜¯åœ¨ java æ–‡ä»¶ä¸Šå³é”®æ‰“å¼€æ–¹å¼é€‰ javac.exe æ‰“å¼€è¿™ä¸ª java æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰è¯­æ³•é”™è¯¯ï¼Œä¼šç”Ÿæˆä¸€ä¸ª XXX.class æ–‡ä»¶  
ä½†æ˜¯æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š

- å½“è¿™ä¸ª java æ–‡ä»¶æœ‰é”™è¯¯çš„æ—¶å€™ï¼Œå³é”®ç”¨ jacac.exe æ‰“å¼€ä¼šå‡ºç° cmd çª—å£ï¼Œä½†æ˜¯å®ƒä¼šé©¬ä¸Šå…³é—­ï¼Œå¯ä»¥è¯´æ˜¯ä¸€é—ªè€Œè¿‡ï¼Œæˆ‘ä»¬çœ‹ä¸åˆ°é”™è¯¯ä¿¡æ¯ã€‚
- å¦‚æœæˆ‘ä»¬ç¼–è¯‘é€šè¿‡äº†ï¼Œç„¶åè¿˜è¦å³é”®é‚£ä¸ª class æ–‡ä»¶ï¼Œç„¶åç”¨ java.exe æ‰“å¼€ï¼Œè¿™æ ·å¾ˆéº»çƒ¦ã€‚

æ‰€ä»¥æˆ‘æ¨èä¸‹é¢è¿™ç§æ–¹æ³•  
ä¸æ˜¯ç®€å•çš„ç”¨ java å’Œ javac å‘½ä»¤æ‰“å¼€  
è¿™æ ·æˆ‘ä»¬å°±ä¸ç”¨æ¯æ¬¡éƒ½è¿›å…¥ cmd ç„¶åè¿›å»åˆ° java æ–‡ä»¶æ‰€åœ¨è·¯å¾„ï¼Œç„¶ååœ¨è¾“å…¥ javac xxx.java ç¼–è¯‘ å’Œ java xxx è¿è¡Œäº†  
ç›´æ¥é¼ æ ‡å³é”® å•å‡» ç¼–è¯‘å¹¶è¿è¡Œ å°±å¯ä»¥ç›´æ¥ç¼–è¯‘å¹¶ä¸”è¾“å‡ºç»“æœã€‚å¦‚æœæœ‰é”™è¯¯ï¼Œä¹Ÿä¼šæ˜¾ç¤ºå®Œæ•´é”™è¯¯ä¿¡æ¯ï¼Œä¸ä¼šä¸€é—ªè€Œè¿‡ã€‚

- æ–°å»º runJava.txtï¼Œæ”¹åç¼€ä¸º batï¼Œç”¨è®°äº‹æœ¬æ‰“å¼€ï¼Œå¤åˆ¶ä»¥ä¸‹ä»£ç åˆ°è¿™ä¸ªæ–‡ä»¶ä¸­ ç„¶åä¿å­˜å¹¶æŠŠè¿™ä¸ªæ–‡ä»¶æ”¾åœ¨ä¸€ä¸ªä¸ç»å¸¸åŠ¨çš„åœ°æ–¹  
  æˆ‘æ”¾åœ¨äº† F ç›˜çš„ java æ–‡ä»¶å¤¹ä¸‹

```
@ECHO OFF
cd %~dp1                    %è½¬åˆ°å½“å‰ç›®å½•ä¸‹%
IF EXIST %~n1.class (      %å¦‚æœæœ‰xxx.class åˆ™æ‰§è¡Œ åˆ é™¤å‘½ä»¤ï¼Œå°†åŸæ¥æ—§çš„classæ–‡ä»¶ %
    DEL %~n1.class
)
ECHO Compiling %~nx1        %åœ¨æ§åˆ¶å°æ˜¾ç¤º Compiling xxx.java%
javac -d . %~nx1            %æ‰§è¡Œjavacå‘½ä»¤ -d  å‚æ•°çš„æ„æ€æ˜¯ æŒ‡å®šæ”¾ç½®ç”Ÿæˆçš„ç±»æ–‡ä»¶çš„ä½ç½®  . çš„æ„æ€æ˜¯æ”¾åœ¨å½“å‰ç›®å½•ä¸‹ %
@ECHO OFF
IF EXIST %~n1.class (       %å¦‚æœå­˜åœ¨xxx.class è¯´æ˜ç¼–è¯‘æˆåŠŸ åˆ™æ‰§è¡Œjavaå‘½ä»¤ %
ECHO ---------Out----------
java %~n1  %æ‰§è¡Œjavaå‘½ä»¤%
)
pause
```

- **æ·»åŠ åˆ°é¼ æ ‡å³é”®**ï¼šæ–°å»º java.txt æ–‡ä»¶ï¼Œæ”¹åç¼€ä¸º regï¼Œç”¨è®°äº‹æœ¬æ‰“å¼€ å¤åˆ¶ä»¥ä¸‹ä»£ç åˆ°æ–‡ä»¶ä¸­  
  **è¯´æ˜**ï¼š`@=â€\â€F:\Java\runJava.bat\â€ \â€%1\â€â€` è¿™ä¸€è¡Œéœ€è¦æ”¹æˆç¬¬ä¸€æ­¥ä¸­ runJava.bat æ‰€åœ¨æ–‡ä»¶å¤¹ç›®å½•

```
Windows Registry Editor Version 5.00
[HKEY_CLASSES_ROOT\*\shell\java]
@="ç¼–è¯‘å¹¶è¿è¡Œ"
[HKEY_CLASSES_ROOT\*\shell\java\Command]
@="\"F:\\Java\\runJava.bat\" \"%1\""
```

ç„¶ååŒå‡»è¿™ä¸ªæ–‡ä»¶ï¼Œå°†è¿™ä¸ªé”®å€¼æ·»åŠ åˆ°æ³¨å†Œè¡¨ä¸­ã€‚  
**æ³¨æ„**ï¼šè¿™é‡Œæ¶‰åŠåˆ°æ”¹æ³¨å†Œè¡¨ï¼Œæœ‰é£é™©ï¼Œå¦‚æœä¿¡å¾—è¿‡æˆ‘ï¼Œåªç®¡ç‚¹å°±æ˜¯ï¼Œæˆ‘å°±æ˜¯è¿™ä¸ªåšçš„ã€‚

## [Javaç¨‹åºè®¾è®¡åŸºç¡€å…¥é—¨æŒ‡å—](https://blog.dong4j.site/posts/ca7b1ce7.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

è®¡ç®—æœºç¨‹åºï¼ˆComputer programï¼‰ï¼Œä¹Ÿç§°ä¸ºè½¯ä»¶ï¼ˆsoftwareï¼‰ï¼Œç®€ç§°ç¨‹åºï¼ˆProgramï¼‰æ˜¯æŒ‡ä¸€ç»„æŒ‡ç¤ºè®¡ç®—æœºæˆ–å…¶ä»–å…·æœ‰ä¿¡æ¯å¤„ç†èƒ½åŠ›è£…ç½®æ¯ä¸€æ­¥åŠ¨ä½œçš„æŒ‡ä»¤ï¼Œé€šå¸¸ç”¨æŸç§ç¨‹åºè®¾è®¡è¯­è¨€ç¼–å†™ï¼Œè¿è¡ŒäºæŸç§ç›®æ ‡ä½“ç³»ç»“æ„ä¸Šã€‚å°±è·Ÿæˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ä¸­åšé¥­ä¸€æ ·ï¼Œä¸€é“èœçš„å®Œæˆéœ€è¦ä»ä¹°èœï¼Œæ´—èœï¼Œç‚’èœï¼Œå‡ºé”…ç­‰æ­¥éª¤å®Œæˆã€‚  
**ç¨‹åºï¼šä¸ºäº†è®©è®¡ç®—æœºæ‰§è¡ŒæŸäº›æ“ä½œæˆ–è§£å†³æŸä¸ªé—®é¢˜è€Œç¼–å†™çš„ä¸€ç³»åˆ—æœ‰åºæŒ‡ä»¤çš„é›†åˆï¼Œé€šè¿‡ç¨‹åºå®ç°äººæœºå¯¹è¯çš„è¿‡ç¨‹**

### **è¿›åˆ¶è½¬æ¢**

#### **ä»€ä¹ˆæ˜¯äºŒè¿›åˆ¶**

äºŒè¿›åˆ¶æ˜¯è®¡ç®—æŠ€æœ¯ä¸­å¹¿æ³›é‡‡ç”¨çš„ä¸€ç§æ•°åˆ¶ã€‚äºŒè¿›åˆ¶æ•°æ®æ˜¯ç”¨ 0 å’Œ 1 ä¸¤ä¸ªæ•°ç æ¥è¡¨ç¤ºçš„æ•°ã€‚å®ƒçš„åŸºæ•°ä¸º 2ï¼Œè¿›ä½è§„åˆ™æ˜¯ â€œé€¢äºŒè¿›ä¸€â€ï¼Œå€Ÿä½è§„åˆ™æ˜¯ â€œå€Ÿä¸€å½“äºŒâ€ï¼Œç”± 18 ä¸–çºªå¾·å›½æ•°ç†å“²å­¦å¤§å¸ˆè±å¸ƒå°¼å…¹å‘ç°ã€‚å½“å‰çš„è®¡ç®—æœºç³»ç»Ÿä½¿ç”¨çš„åŸºæœ¬ä¸Šæ˜¯äºŒè¿›åˆ¶ç³»ç»Ÿï¼Œæ•°æ®åœ¨è®¡ç®—æœºä¸­ä¸»è¦æ˜¯ä»¥è¡¥ç çš„å½¢å¼å­˜å‚¨çš„ã€‚è®¡ç®—æœºä¸­çš„äºŒè¿›åˆ¶åˆ™æ˜¯ä¸€ä¸ªéå¸¸å¾®å°çš„å¼€å…³ï¼Œç”¨ â€œå¼€â€ æ¥è¡¨ç¤º 1ï¼Œâ€œå…³â€æ¥è¡¨ç¤º 0ã€‚ [[ç™¾åº¦ç™¾ç§‘]](http://baike.baidu.com/view/18536.htm)

#### **ç‰¹ç‚¹**

##### **ä¼˜ç‚¹**

æ•°å­—è£…ç½®ç®€å•å¯é ï¼Œæ‰€ç”¨å…ƒä»¶å°‘ï¼›  
åªæœ‰ä¸¤ä¸ªæ•°ç  0 å’Œ 1ï¼Œå› æ­¤å®ƒçš„æ¯ä¸€ä½æ•°éƒ½å¯ç”¨ä»»ä½•å…·æœ‰ä¸¤ä¸ªä¸åŒç¨³å®šçŠ¶æ€çš„å…ƒä»¶æ¥è¡¨ç¤ºï¼›  
åŸºæœ¬è¿ç®—è§„åˆ™ç®€å•ï¼Œè¿ç®—æ“ä½œæ–¹ä¾¿ã€‚

##### **ç¼ºç‚¹**

ç”¨äºŒè¿›åˆ¶è¡¨ç¤ºä¸€ä¸ªæ•°æ—¶ï¼Œä½æ•°å¤šã€‚å› æ­¤å®é™…ä½¿ç”¨ä¸­å¤šé‡‡ç”¨é€å…¥æ•°å­—ç³»ç»Ÿå‰ç”¨åè¿›åˆ¶ï¼Œé€å…¥æœºå™¨åå†è½¬æ¢æˆäºŒè¿›åˆ¶æ•°ï¼Œè®©æ•°å­—ç³»ç»Ÿè¿›è¡Œè¿ç®—ï¼Œè¿ç®—ç»“æŸåå†å°†äºŒè¿›åˆ¶è½¬æ¢ä¸ºåè¿›åˆ¶ä¾›äººä»¬é˜…è¯»ã€‚

##### **é‡‡ç”¨åŸå› **

1.  æŠ€æœ¯å®ç°ç®€å•ï¼Œè®¡ç®—æœºæ˜¯ç”±é€»è¾‘ç”µè·¯ç»„æˆï¼Œé€»è¾‘ç”µè·¯é€šå¸¸åªæœ‰ä¸¤ä¸ªçŠ¶æ€ï¼Œå¼€å…³çš„æ¥é€šä¸æ–­å¼€ï¼Œè¿™ä¸¤ç§çŠ¶æ€æ­£å¥½å¯ä»¥ç”¨ â€œ1â€ å’Œâ€œ0â€è¡¨ç¤ºã€‚
2.  ç®€åŒ–è¿ç®—è§„åˆ™ï¼šä¸¤ä¸ªäºŒè¿›åˆ¶æ•°å’Œã€ç§¯è¿ç®—ç»„åˆå„æœ‰ä¸‰ç§ï¼Œè¿ç®—è§„åˆ™ç®€å•ï¼Œæœ‰åˆ©äºç®€åŒ–è®¡ç®—æœºå†…éƒ¨ç»“æ„ï¼Œæé«˜è¿ç®—é€Ÿåº¦ã€‚
3.  é€‚åˆé€»è¾‘è¿ç®—ï¼šé€»è¾‘ä»£æ•°æ˜¯é€»è¾‘è¿ç®—çš„ç†è®ºä¾æ®ï¼ŒäºŒè¿›åˆ¶åªæœ‰ä¸¤ä¸ªæ•°ç ï¼Œæ­£å¥½ä¸é€»è¾‘ä»£æ•°ä¸­çš„ â€œçœŸâ€ å’Œâ€œå‡â€ç›¸å»åˆã€‚
4.  æ˜“äºè¿›è¡Œè½¬æ¢ï¼ŒäºŒè¿›åˆ¶ä¸åè¿›åˆ¶æ•°æ˜“äºäº’ç›¸è½¬æ¢ã€‚
5.  ç”¨äºŒè¿›åˆ¶è¡¨ç¤ºæ•°æ®å…·æœ‰æŠ—å¹²æ‰°èƒ½åŠ›å¼ºï¼Œå¯é æ€§é«˜ç­‰ä¼˜ç‚¹ã€‚å› ä¸ºæ¯ä½æ•°æ®åªæœ‰é«˜ä½ä¸¤ä¸ªçŠ¶æ€ï¼Œå½“å—åˆ°ä¸€å®šç¨‹åº¦çš„å¹²æ‰°æ—¶ï¼Œä»èƒ½å¯é åœ°åˆ†è¾¨å‡ºå®ƒæ˜¯é«˜è¿˜æ˜¯ä½ã€‚

##### ä¸ºä»€ä¹ˆä¸é‡‡ç”¨ç”µå‹é«˜ä½æ¥æ¨¡æ‹Ÿåè¿›åˆ¶

å› ä¸ºç”µé˜»å—çƒ­åä¼šå‘ç”Ÿæ”¹å˜ï¼Œå¯¼è‡´ç”µå‹ä¸ç¨³ï¼Œé€ æˆå­˜å‚¨çš„æ•°æ®ä¸ç¡®å®šæ€§ã€‚

##### **ä»£ç å®ç°åè¿›åˆ¶è½¬äºŒè¿›åˆ¶**

```java
class toBinary {
    //å®šä¹‰ç”¨äºè¿æ¥ä½™æ•°çš„å­—ç¬¦ä¸²ã€‚
    private static String s = "";
    public static void IntToBinary(int num){
        //å½“numç­‰äº1çš„æ—¶å€™ï¼Œæ˜¯æœ€åä¸€ä½æ•°ã€‚
        while(num >= 1){
            s = num % 2 + s;
            num = num / 2;
        }
        System.out.println(s);
    }
}
public class toBinaryTest{
    public static void main(String[] args){
        //ç”¨åè¿›åˆ¶129æµ‹è¯•ä¸€ä¸‹è¿™ä¸ªç±»
        toBinary.IntToBinary(129);
    }
}
```

### **ç¨‹åºï¼Œè½¯ä»¶å’Œè®¡ç®—æœºè¯­è¨€çš„å…³ç³»**

- å¯ä»¥è¢«è®¡ç®—æœºè¿ç»­æ‰§è¡Œçš„æŒ‡ä»¤é›†åˆç§°ä¸ºè®¡ç®—æœºç¨‹åº
- è½¯ä»¶æ˜¯ä¸ºäº†å®ŒæˆæŸäº›ç‰¹å®šåŠŸèƒ½è€Œç¼–å†™çš„ä¸€åˆ°å¤šä¸ªç¨‹åºæ–‡ä»¶çš„é›†åˆ
- è®¡ç®—æœºè¯­è¨€æ˜¯äººä»¬å‘æ˜çš„å¯ä»¥å’Œè®¡ç®—æœºè¿›è¡Œæ²Ÿé€šäº¤æµçš„ä¸€ç§å·¥å…·

### **è®¡ç®—æœºè¯­è¨€çš„åˆ†ç±»**

- æœºå™¨è¯­è¨€
  - è®¡ç®—æœºå”¯ä¸€èƒ½æ¥å—å’Œæ‰§è¡Œçš„è¯­è¨€
  - ç”±äºŒè¿›åˆ¶ç»„æˆ
  - æ¯ä¸€ä¸²äºŒè¿›åˆ¶ç§°ä¸ºä¸€æ¡æŒ‡ä»¤ï¼Œä¸€æ¡æŒ‡ä»¤è§„å®šäº†è®¡ç®—æœºæ‰§è¡Œçš„ä¸€ä¸ªåŠ¨ä½œ
  - ä¸€å°è®¡ç®—æœºæ‰€èƒ½æ‡‚çš„æŒ‡ä»¤çš„å…¨ä½“ï¼Œå«åšè¿™ä¸ªä¸»è®¡ç®—æœºçš„æŒ‡ä»¤ç³»ç»Ÿ
  - ä¸åŒå‹å·çš„è®¡ç®—æœºçš„æŒ‡ä»¤ç³»ç»Ÿä¸åŒ  
    **ç‰¹ç‚¹**
  1.  ç¼–å†™å‡ºæ¥çš„ç¨‹åºå…¨éƒ¨éƒ½æ˜¯ç”± 0 å’Œ 1 ç»„æˆâ€˜
  2.  è®¡ç®—æœºå¯ä»¥ç›´æ¥è¯†åˆ«ã€‚
  3.  æœºå™¨è¯­è¨€å¯¹ä¸åŒå‹å·çš„è®¡ç®—æœºä¸€èˆ¬ä¸åŒï¼Œæ‰€ä»¥åˆè¢«ç§°ä¸ºé¢å‘æœºå™¨çš„è¯­è¨€  
      **ç¼ºç‚¹**
      - æŒ‡ä»¤éš¾ä»¥è®°å¿†ã€‚
      - ä»£ç å®ç°å¤æ‚ï¼Œå¼€å‘å‘¨æœŸé•¿
      - ä¸ä¾¿äºæ¨å¹¿ï¼Œäº¤æµï¼Œåˆä½œã€‚
      - ä¸¥é‡çš„ä¾èµ–å…·ä½“çš„è®¡ç®—æœºï¼Œå¯ç§»æ¤æ€§å·®ï¼Œé‡ç”¨æ€§å·®ã€‚
- æ±‡ç¼–è¯­è¨€
  - ç”¨åŠ©è®°ç¬¦è¡¨ç¤ºæŒ‡ä»¤åŠŸèƒ½çš„è®¡ç®—æœºè¯­è¨€
  - æ±‡ç¼–è¯­è¨€ç¼–å†™çš„ä»£ç è®¡ç®—æœºæ— æ³•ç›´æ¥è¯†åˆ«
- é«˜çº§è¯­è¨€

  - ä¸è‡ªç„¶è¯­è¨€ç°é‡‘å¹¶ä¸ºè®¡ç®—æœºæ‰€æ¥å—å’Œæ‰§è¡Œçš„è®¡ç®—æœºè¯­è¨€

  ***

### ç¿»è¯‘ç¨‹åº

è®¡ç®—æœºå¹¶ä¸èƒ½ç›´æ¥åœ°æ¥å—å’Œæ‰§è¡Œç”¨é«˜çº§è¯­è¨€ç¼–å†™çš„æºç¨‹åº, æºç¨‹åºåœ¨è¾“å…¥è®¡ç®—æœºæ—¶, é€šè¿‡ â€œç¿»è¯‘ç¨‹åºâ€ ç¿»è¯‘æˆæœºå™¨è¯­è¨€å½¢å¼çš„ç›®æ ‡ç¨‹åº, è®¡ç®—æœºæ‰èƒ½è¯†åˆ«å’Œæ‰§è¡Œã€‚  
ç¿»è¯‘åˆ†æˆäº†ä¸¤ç§å½¢å¼

- ç¼–è¯‘
  - ç¼–è¯‘å‹è¯­è¨€çš„é¦–å…ˆå°†æºä»£ç ç¼–è¯‘ç”Ÿæˆæœºå™¨è¯­è¨€ï¼Œå†ç”±æœºå™¨è¿è¡Œæœºå™¨ç ï¼ˆäºŒè¿›åˆ¶ï¼‰ã€‚åƒ C/C++ ç­‰éƒ½æ˜¯ç¼–è¯‘å‹è¯­è¨€ã€‚
- è§£é‡Š
  - è§£é‡Šæ€§è¯­è¨€åœ¨è¿è¡Œç¨‹åºçš„æ—¶å€™æ‰ç¿»è¯‘ï¼Œæ¯”å¦‚è§£é‡Šæ€§ java è¯­è¨€ï¼Œä¸“é—¨æœ‰ä¸€ä¸ªè§£é‡Šå™¨èƒ½å¤Ÿç›´æ¥æ‰§è¡Œ java ç¨‹åºï¼Œæ¯ä¸ªè¯­å¥éƒ½æ˜¯æ‰§è¡Œçš„æ—¶å€™æ‰ç¿»è¯‘ã€‚è¿™æ ·è§£é‡Šæ€§è¯­è¨€æ¯æ‰§è¡Œä¸€æ¬¡å°±è¦ç¿»è¯‘ä¸€æ¬¡ï¼Œæ•ˆç‡æ¯”è¾ƒä½ã€‚

### ç®—æ³•

ç®—æ³•ï¼šè§£å†³é—®é¢˜çš„å…·ä½“æ–¹æ³•å’Œæ­¥éª¤  
ä¾‹å¦‚ï¼š  
è®¡ç®—é•¿æ–¹å½¢çš„é¢ç§¯

1. æ¥æ”¶ç”¨æˆ·è¾“å…¥çš„é•¿æ–¹å½¢é•¿åº¦å’Œå®½åº¦ä¸¤ä¸ªå€¼ï¼›
2. åˆ¤æ–­é•¿åº¦å’Œå®½åº¦çš„å€¼æ˜¯å¦å¤§äºé›¶ï¼›
3. å¦‚æœå¤§äºé›¶ï¼Œå°†é•¿åº¦å’Œå®½åº¦ä¸¤ä¸ªå€¼ç›¸ä¹˜å¾—åˆ°é¢ç§¯ï¼Œå¦åˆ™æ˜¾ç¤ºè¾“å…¥é”™è¯¯ï¼›
4. æ˜¾ç¤ºé¢ç§¯ã€‚

#### ç®—æ³•çš„åŸºæœ¬ç‰¹å¾

**æœ‰ç©·æ€§**ï¼šä¸€ä¸ªç®—æ³•å¿…é¡»åœ¨æ‰§è¡Œæœ‰é™ä¸ªæ“ä½œæ­¥éª¤åç»ˆæ­¢ã€‚  
**ç¡®å®šæ€§**ï¼šç®—æ³•ä¸­æ¯ä¸€æ­¥çš„å«ä¹‰å¿…é¡»æ˜¯ç¡®åˆ‡çš„ï¼Œä¸å¯å‡ºç°ä»»ä½•äºŒä¹‰æ€§ã€‚  
**æœ‰æ•ˆæ€§**ï¼šç®—æ³•ä¸­çš„æ¯ä¸€æ­¥æ“ä½œéƒ½åº”è¯¥èƒ½æœ‰æ•ˆæ‰§è¡Œï¼Œä¸€ä¸ªä¸å¯æ‰§è¡Œçš„æ“ä½œæ˜¯æ— æ•ˆçš„ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªæ•°è¢« 0 é™¤çš„æ“ä½œå°±æ˜¯æ— æ•ˆçš„ï¼Œåº”å½“é¿å…è¿™ç§æ“ä½œã€‚  
**æœ‰é›¶ä¸ªæˆ–å¤šä¸ªè¾“å…¥**ï¼šè¿™é‡Œçš„è¾“å…¥æ˜¯æŒ‡åœ¨ç®—æ³•å¼€å§‹ä¹‹å‰æ‰€éœ€è¦çš„åˆå§‹æ•°æ®ã€‚è¿™äº›è¾“å…¥çš„å¤šå°‘å–å†³äºç‰¹å®šçš„é—®é¢˜ã€‚  
**æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªè¾“å‡º**ï¼šæ‰€è°“è¾“å‡ºæ˜¯æŒ‡ä¸è¾“å…¥æœ‰æŸç§ç‰¹å®šå…³ç³»çš„é‡ï¼Œåœ¨ä¸€ä¸ªå®Œæ•´çš„ç®—æ³•ä¸­è‡³å°‘ä¼šæœ‰ä¸€ä¸ªè¾“å‡ºã€‚ä¾‹å¦‚ï¼Œè¦è®¡ç®—ä» 1 ç´¯åŠ åˆ° 100ï¼Œå¦‚æœè¿™ä¸ªç¨‹åºæ²¡æœ‰è¾“å‡ºç»“æœï¼Œé‚£ä¹ˆå®ƒå°†å˜å¾—æ¯«æ— æ„ä¹‰ã€‚

### ç¨‹åºè®¾è®¡çš„äº”ä¸ªæ­¥éª¤

- åˆ†æ
  - æ¸…æ¥šä¸šåŠ¡æµç¨‹ï¼ˆåšä»€ä¹ˆï¼‰
  - æ¸…æ¥šè¾“å…¥è¾“å‡ºè¦æ±‚ï¼ˆå·²çŸ¥ä»€ä¹ˆ & è¦å¾—åˆ°ä»€ä¹ˆï¼‰
  - æ¸…æ¥šå¼€å‘æœŸé™
- è®¾è®¡
  - ä¼˜ç§€çš„ç¨‹åºåœ¨å¼€å‘å‰ä»¥åŠå¼€å‘ä¸­ï¼Œéƒ½è¦ç²¾å¿ƒè®¾è®¡
  - å¯¹äºç¨‹åºå‘˜è€Œè¨€ï¼Œæœ€é‡è¦çš„æ˜¯ç¡®ç«‹ç®—æ³•ã€‚ï¼ˆæ€ä¹ˆåšï¼‰
  - åœ¨ç¼–ç¨‹ä¹‹å‰ï¼Œåº”è¯¥å…ˆè®¾è®¡ä¸€ä¸‹ã€‚è¯•å›¾ä¸éµå¾ªè®¾è®¡è€Œç¼–å†™ç¨‹åºï¼Œå°±å¥½åƒæ²¡æœ‰æˆ¿å±‹å¹³é¢å›¾å°±å»ºé€ æˆ¿å±‹ï¼Œæˆ‘ä»¬æ— æ³•ç¡®å®šæœ€ç»ˆä¼šåšæˆä»€ä¹ˆæ ·å­ã€‚
- ç¼–ç å®ç°
  - ç¼–å†™æºä»£ç 
  - å°†åŸä»£ç ç¼–è¯‘æˆå­—èŠ‚ç 
  - è®©è®¡ç®—æœºè¿è¡Œæˆ‘ä»¬çš„ç¨‹åº
- è°ƒè¯•
  - ç¨‹åºä¸­æœ€æ˜“å‡ºç°çš„å‡ ç§ä¸åŒç±»å‹é”™è¯¯æ˜¯è¯­æ³•é”™è¯¯ã€é€»è¾‘é”™è¯¯å’Œè¿è¡Œé”™è¯¯ã€‚
- ç»´æŠ¤

#### ç”¨ java å®ç°çŒœæ•°å­—

ç¬¬ä¸€ç§

```java
/**
 * @describe   çŒœæ•°å­— ç”¨æˆ·ç»™å‡ºçš„æ•°å­—è·Ÿç”µè„‘éšæœºç»™å‡ºçš„æ•°å­—å¯¹æ¯”ï¼Œ
 *             çŸ¥é“çŒœä¸­ä¸ºæ­¢ã€‚æœ€åç»™å‡ºçŒœæ•°çš„æ¬¡æ•°ã€‚
 */
import java.util.Scanner;

class GuessNumber{
    public static void main(String[] args) {
        int count = 0;
        int num = (int)(Math.random()*100)+1;
        System.out.println(num);
        Scanner sc = new Scanner(System.in);
        int user ;
        while(true){
            System.out.println("è¯·è¾“å…¥ä½ çŒœçš„æ•°å­—");
            user = sc.nextInt();
            count++;
                if(num > user) {
                    System.out.println("å°äº†");
                }else if(num < user){
                    System.out.println("å¤§äº†");
                }else{
                    System.out.println("çŒœä¸­äº†");
                    break ;
                }
        }
        if(count <= 5)
            System.out.println("å¤©æ‰çŒœäº† "+ count+ " æ¬¡");
        else
            System.out.println("ç¬¨è›‹çŒœäº† "+ count+ " æ¬¡");
    }
}
```

ç¬¬äºŒç§

```java
/**
 * @describe   çŒœæ•°å­—æ”¹è¿›ç‰ˆ è®©è®¡ç®—æœºå¸®æˆ‘ä»¬çŒœæ•°å­—
 *             å®ç°ï¼š1.éšæœºç»™å‡ºä¸€ä¸ª1åˆ°100çš„æ•°å­—
 *                   2.å®šä¹‰ä¸€ä¸ªæ•°ç»„ï¼Œé‡Œé¢å­˜æ”¾ä»1åˆ°100çš„æ•°å­—
 *                   3.åœ¨æ•°ç»„ä¸­ç”¨äºŒåˆ†æ³•æŸ¥æ‰¾è¿™ä¸ªå€¼
 */

class GuessNumber2 {
    //äºŒåˆ†æ³•æŸ¥æ‰¾æ³•ï¼ˆæŠ˜åŠæŸ¥æ‰¾ï¼‰
    public static int checkNumber(int[] arr, int a ) {
        //lowæŒ‡å‘æ•°ç»„çš„ä½ä½
        int low = 0;
        //æŒ‡å‘æ•°ç»„çš„ä¸­é—´
        int middle;
        //hightæŒ‡å‘æ•°ç»„çš„é«˜ä½
        int hight = arr.length - 1;
        //æ¬¡æ•°
        int count = 0;
        //å½“æŒ‡å‘ä½ä½çš„lowå¤§äºæŒ‡å‘é«˜ä½çš„hightæ—¶ï¼Œè¯´æ˜
        while(low <= hight) {
            count++;
            middle = (low + hight) / 2;
            if(a > arr[middle]){
                System.out.println("ç¬¬ "+count+" æ¬¡æŸ¥æ‰¾çš„æ•°å­—ä¸º "+arr[middle]);
                //å¦‚æœè®¡ç®—æœºæ‰¾å‡ºçš„å€¼æ¯”éšæœºå€¼å°ï¼Œå°±åº”è¯¥åœ¨æ•°ç»„çš„ååŠéƒ¨åˆ†å»æŸ¥æ‰¾ã€‚
                low = middle + 1;
            }

            else if(a < arr[middle]) {
                System.out.println("ç¬¬ "+count+" æ¬¡æŸ¥æ‰¾çš„æ•°å­—ä¸º "+arr[middle]);
                //å¦‚æœæ‰¾å‡ºçš„å€¼æ¯”éšæœºæ•°å¤§ï¼Œåˆ™åœ¨æ•°ç»„çš„å‰åŠéƒ¨æ‰¾ã€‚
                hight = middle - 1 ;
            }

            //å¦‚æœarr[middle] == a ,åˆ™æ‰¾åˆ°äº†éšæœºæ•°ã€‚
            else {
                System.out.println("æŸ¥æ‰¾äº† "+ count +" æ¬¡");
                return arr[middle];
            }
        }
        return -1 ;
    }
}
public class GuessNumberTest {
    public static void main(String[] args) {
        //ç»™å‡ºä¸€ä¸ª1åˆ°100çš„éšæœºæ•°
        int a = (int)(Math.random() * 100) + 1;
        System.out.println("è®¡ç®—æœºéšæœºç»™å‡ºçš„å€¼ï¼š" + a);
        //å®šä¹‰ä¸€ä¸ªæ•°ç»„ï¼Œå­˜æ”¾1åˆ°100çš„æ•°å­—
        int[] arr = new int[100];
        for(int i = 0 ;i < arr.length ;i++) {
            arr[i] = i + 1;
            //System.out.println(arr[i]);
        }
        int value = GuessNumber2.checkNumber(arr,a);
        if ( value != -1)
               System.out.println("è®¡ç®—æœºçŒœåˆ°éšæœºæ•°çš„å€¼= "+ value );
          else
               System.out.println("æœªçŒœåˆ°");

    }
}
```

## [æ‰“é€ ä¸ªæ€§åŒ–ç¼–ç¨‹ç¯å¢ƒï¼šSublime Textæ’ä»¶æ·±åº¦ä½“éªŒ](https://blog.dong4j.site/posts/b5d8b5d5.md)

<!-- markdownlint-disable-next-line MD033 -->
<meta name="referrer" content="no-referrer"/>

![random-pic-api](https://api.dong4j.ink:1024/cover?spm={{spm}})

Sublime Text æ˜¯ä¸€æ¬¾æ¬¾å¹³å°ä»£ç ç¼–è¾‘å™¨, å¾ˆé€‚åˆå‰ç«¯å¼€å‘ä½¿ç”¨.  
å®ƒçš„æ’ä»¶è¶³å¤Ÿä¸°å¯Œ, æˆ‘åªæ˜¯æ‹¿æ¥å½“ java ç¼–è¾‘å™¨ä½¿ç”¨, å› ä¸ºæˆ‘è§‰å¾—å®ƒçš„ç•Œé¢å¾ˆå¥½çœ‹.  
ä½†æ˜¯å®ƒå¯¹ä¸­æ–‡æ”¯æŒä¸å¤Ÿå¥½ (æ˜¯ä¸æ˜¯è·¨å¹³å°çš„ç¼–è¾‘å™¨å¯¹ä¸­æ–‡æ”¯æŒéƒ½ä¸å¥½?).  
ä¸‹é¢æˆ‘å°±å¯¹æˆ‘ä½¿ç”¨ Sublime æœŸé—´é‡åˆ°çš„é—®é¢˜å’Œè§£å†³é—®é¢˜åšä¸€ä¸ªå¤‡å¿˜å½•.

### ç¼–è¾‘å™¨çš„é€‰æ‹©

æˆ‘æ˜¯ä¸€ä¸ªåˆå­¦ç¼–ç¨‹çš„äºº, å¯¹ç¼–è¾‘å™¨çš„é€‰æ‹©ä¸æ˜¯å¾ˆå¤š, å°±ç”¨è¿‡ Eclipse å’Œ Sublime.  
Eclipse å¯¹äºåˆå­¦è€…çš„æˆ‘æ¥è¯´, æ˜¾å¾—è¿‡äºåºå¤§, å¹³æ—¶å°±è”ç³»ä¸€äº›å°ä¾‹å­, è¿˜ç”¨ä¸ä¸Šè¿™ä¹ˆé«˜å¤§ä¸Šçš„ç¼–è¾‘å™¨.  
ä¸ºä»€ä¹ˆé€‰æ‹© Sublime?  
æˆ‘è§‰å¾—å®ƒæ€§æ„Ÿ, ç•Œé¢å¥½çœ‹, æ’ä»¶ä¸°å¯Œ, æ•™ç¨‹ä¹Ÿå¤š, æ‰€ä»¥é€‰æ‹©äº†å®ƒ. è™½ç„¶ Sublime ä¸æ˜¯å…è´¹çš„, ä½†æ˜¯åœ¨ä¼Ÿå¤§çš„å¤©æœ, ä¸€åˆ‡çš†æœ‰å¯èƒ½.

### æ’ä»¶

#### Package Control

Package Control æ˜¯ Sublime å¿…è£…çš„æ’ä»¶ä¹‹ä¸€, å®ƒå°±åƒä¸€ä¸ªç®¡å®¶, ä¸‹è½½, ç®¡ç†å…¶å®ƒæ’ä»¶

- **ä½¿ç”¨ Ctrl+` æ‰“å¼€ Sublime Text æ§åˆ¶å°**
- **å¤åˆ¶ä¸‹é¢ä»£ç åˆ°æ§åˆ¶å°**

```
import urllib.request,os,hashlib;
    h = '7183a2d3e96f11eeadd761d777e62404' + 'e330c659d4bb41d3bdf022e94cab3cd0';
    pf = 'Package Control.sublime-package';
    ipp = sublime.installed_packages_path();
    urllib.request.install_opener( urllib.request.build_opener( urllib.request.ProxyHandler()) );
    by = urllib.request.urlopen( 'http://sublime.wbond.net/' + pf.replace(' ', '%20')).read();
    dh = hashlib.sha256(by).hexdigest();
    print('Error validating download (got %s instead of %s), please try manual install' % (dh, h)) if dh != h else open(os.path.join( ipp, pf), 'wb' ).write(by)
```

- **ç­‰å¾… Package Control å®‰è£…å®Œæˆ, ç„¶åä½¿ç”¨`Ctrl+Shift+P`æ‰“å¼€å‘½ä»¤é¢æ¿, è¾“å…¥ intsall, å›è½¦ï¼Œç„¶åé€‰æ‹©æˆ–è€…è¾“å…¥è¦å®‰è£…çš„æ’ä»¶**

#### ä¸€äº›å¸¸ç”¨çš„æ’ä»¶

1.  ConvertToUTF8ï¼šè§£å†³ä¸­æ–‡ä¹±ç é—®é¢˜
2.  Alignmentï¼šä¸»è¦ç”¨äºä»£ç å¯¹é½
3.  Autoprefixerï¼šè‡ªåŠ¨æ·»åŠ å…¼å®¹å‰ç¼€
4.  BracketHighlighterï¼šèƒ½ä¸º ST æä¾›æ‹¬å·ï¼Œå¼•å·è¿™ç±»é«˜äº®åŠŸèƒ½.
5.  AutoFileNameï¼šè‡ªåŠ¨è¡¥å…¨æ–‡ä»¶å
6.  Terminalï¼šå”¤èµ·ç»ˆç«¯æ§åˆ¶å°
7.  SublimeLinterï¼šä»£ç æç¤ºé«˜äº®
8.  CodeFormatterï¼šä»£ç æ ¼å¼åŒ–
9.  Colorcoderï¼šé«˜äº®æ‰€æœ‰å˜é‡
10. ColorPickerï¼šè°ƒè‰²ç›˜ ï¼š
11. SideBarEnhancementsï¼šå®ç”¨çš„å³é”®èœå•å¢å¼ºæ’ä»¶
12. Sublimeâ€‹Codeâ€‹Intelï¼šæ˜¯ä¸€ä¸ªä»£ç æç¤ºã€è¡¥å…¨æ’ä»¶
13. Git æ’ä»¶é›†æˆäº† git çš„å¸¸ç”¨åŠŸèƒ½
14. Emmetï¼šå‰èº«æ˜¯å¤§åé¼é¼çš„ Zen codingï¼Œå¦‚æœä½ ä»äº‹ Web å‰ç«¯å¼€å‘çš„è¯ï¼Œå¯¹è¯¥æ’ä»¶ä¸€å®šä¸ä¼šé™Œç”Ÿã€‚å®ƒä½¿ç”¨ä»¿ CSS é€‰æ‹©å™¨çš„è¯­æ³•æ¥ç”Ÿæˆä»£ç ï¼Œå¤§å¤§æé«˜äº† HTML/CSS ä»£ç ç¼–å†™çš„é€Ÿåº¦.
15. FileHeaderï¼šå½“æ‰“å¼€ä¸€ä¸ªç©ºæ–‡ä»¶æ—¶, åˆ¤æ–­æ–‡ä»¶åç¼€è‡ªåŠ¨æ·»åŠ è¯­æ³•æ¨¡æ¿.
16. GoSublimeï¼šæ˜¯ä¸€ä¸ª sublime çš„ go è¯­è¨€æ’ä»¶æä¾›è‡ªåŠ¨è¡¥å…¨å’Œå…¶ä»– IDE ç‰¹æ€§ã€‚
17. SublimeLinterï¼šä¸€ä¸ªæ”¯æŒ lint è¯­æ³•çš„æ’ä»¶ï¼Œctrl+alt+l å‘¼å‡ºï¼ˆä¸ qq çš„é”å®šå†²çªï¼Œè‡ªå·±å»æ”¹çƒ­é”®å§ï¼‰å¯ä»¥é«˜äº® linter è®¤ä¸ºæœ‰é”™è¯¯çš„ä»£ç è¡Œ
18. IMESupportï¼šè¾“å…¥ä¸­æ–‡æ—¶, è®©è¾“å…¥æ¡†è·Ÿéš
19. markdownPreviewï¼šsublime ä¸­çš„ MoarkDwn ç¼–è¾‘å™¨

### Sublime ä¸‹æ­å»º Java å¼€å‘ç¯å¢ƒ

- å®‰è£…ç›®å½•ä¸‹ Packagesâ€“>Java.sublime-package æ–‡ä»¶æ”¹åç¼€å zip è§£å‹æ‰¾åˆ° Java.sublime-build ç”¨è®°äº‹æœ¬æ‰“å¼€å¤åˆ¶ä»¥ä¸‹ä»£ç 

```
{
    "cmd": "runJava.bat \"$file\"",
    "file_regex": "^(...*?):([0-9]*):?([0-9]*)",
    "selector": "source.java",
     "encoding":"GBK"
}
```

- åœ¨ JDK å®‰è£…ç›®å½•ä¸‹çš„ bin ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª **runJava.bat**
- å¤åˆ¶ä¸€ä¸‹ä»£ç 

```
@ECHO OFF
ECHO Compiling   %~nx1
IF EXIST %~n1.class (
DEL %~n1.class
)
 javac -encoding UTF-8  %~nx1
::å¦‚æœæ­£ç¡® æ‰“å¼€cmdè¾“å‡º
IF EXIST %~n1.class (
ECHO ---------Out----------
start cmd /k java %~n1
)
```

- æ³¨æ„åå­—è¦è·Ÿ Java.sublime-build é‡Œé¢çš„ä¸€æ ·

### å¿«æ·é”®

#### é€‰æ‹©ç±»

Ctrl+D é€‰ä¸­å…‰æ ‡æ‰€å çš„æ–‡æœ¬ï¼Œç»§ç»­æ“ä½œåˆ™ä¼šé€‰ä¸­ä¸‹ä¸€ä¸ªç›¸åŒçš„æ–‡æœ¬ã€‚  
Alt+F3 é€‰ä¸­æ–‡æœ¬æŒ‰ä¸‹å¿«æ·é”®ï¼Œå³å¯ä¸€æ¬¡æ€§é€‰æ‹©å…¨éƒ¨çš„ç›¸åŒæ–‡æœ¬è¿›è¡ŒåŒæ—¶ç¼–è¾‘ã€‚ä¸¾ä¸ªæ —å­ï¼šå¿«é€Ÿé€‰ä¸­å¹¶æ›´æ”¹æ‰€æœ‰ç›¸åŒçš„å˜é‡åã€å‡½æ•°åç­‰ã€‚  
Ctrl+L é€‰ä¸­æ•´è¡Œï¼Œç»§ç»­æ“ä½œåˆ™ç»§ç»­é€‰æ‹©ä¸‹ä¸€è¡Œï¼Œæ•ˆæœå’Œ Shift+â†“ æ•ˆæœä¸€æ ·ã€‚  
Ctrl+Shift+L å…ˆé€‰ä¸­å¤šè¡Œï¼Œå†æŒ‰ä¸‹å¿«æ·é”®ï¼Œä¼šåœ¨æ¯è¡Œè¡Œå°¾æ’å…¥å…‰æ ‡ï¼Œå³å¯åŒæ—¶ç¼–è¾‘è¿™äº›è¡Œã€‚  
Ctrl+Shift+M é€‰æ‹©æ‹¬å·å†…çš„å†…å®¹ï¼ˆç»§ç»­é€‰æ‹©çˆ¶æ‹¬å·ï¼‰ã€‚ä¸¾ä¸ªæ —å­ï¼šå¿«é€Ÿé€‰ä¸­åˆ é™¤å‡½æ•°ä¸­çš„ä»£ç ï¼Œé‡å†™å‡½æ•°ä½“ä»£ç æˆ–é‡å†™æ‹¬å·å†…é‡Œçš„å†…å®¹ã€‚  
Ctrl+M å…‰æ ‡ç§»åŠ¨è‡³æ‹¬å·å†…ç»“æŸæˆ–å¼€å§‹çš„ä½ç½®ã€‚  
Ctrl+Enter åœ¨ä¸‹ä¸€è¡Œæ’å…¥æ–°è¡Œã€‚ä¸¾ä¸ªæ —å­ï¼šå³ä½¿å…‰æ ‡ä¸åœ¨è¡Œå°¾ï¼Œä¹Ÿèƒ½å¿«é€Ÿå‘ä¸‹æ’å…¥ä¸€è¡Œã€‚  
Ctrl+Shift+Enter åœ¨ä¸Šä¸€è¡Œæ’å…¥æ–°è¡Œã€‚ä¸¾ä¸ªæ —å­ï¼šå³ä½¿å…‰æ ‡ä¸åœ¨è¡Œé¦–ï¼Œä¹Ÿèƒ½å¿«é€Ÿå‘ä¸Šæ’å…¥ä¸€è¡Œã€‚  
Ctrl+Shift+[ é€‰ä¸­ä»£ç ï¼ŒæŒ‰ä¸‹å¿«æ·é”®ï¼ŒæŠ˜å ä»£ç ã€‚
Ctrl+Shift+] é€‰ä¸­ä»£ç ï¼ŒæŒ‰ä¸‹å¿«æ·é”®ï¼Œå±•å¼€ä»£ç ã€‚  
Ctrl+K+0 å±•å¼€æ‰€æœ‰æŠ˜å ä»£ç ã€‚  
Ctrl+â† å‘å·¦å•ä½æ€§åœ°ç§»åŠ¨å…‰æ ‡ï¼Œå¿«é€Ÿç§»åŠ¨å…‰æ ‡ã€‚  
Ctrl+â†’ å‘å³å•ä½æ€§åœ°ç§»åŠ¨å…‰æ ‡ï¼Œå¿«é€Ÿç§»åŠ¨å…‰æ ‡ã€‚  
shift+â†‘ å‘ä¸Šé€‰ä¸­å¤šè¡Œã€‚  
shift+â†“ å‘ä¸‹é€‰ä¸­å¤šè¡Œã€‚  
Shift+â† å‘å·¦é€‰ä¸­æ–‡æœ¬ã€‚  
Shift+â†’ å‘å³é€‰ä¸­æ–‡æœ¬ã€‚  
Ctrl+Shift+â† å‘å·¦å•ä½æ€§åœ°é€‰ä¸­æ–‡æœ¬ã€‚  
Ctrl+Shift+â†’ å‘å³å•ä½æ€§åœ°é€‰ä¸­æ–‡æœ¬ã€‚  
Ctrl+Shift+â†‘ å°†å…‰æ ‡æ‰€åœ¨è¡Œå’Œä¸Šä¸€è¡Œä»£ç äº’æ¢ï¼ˆå°†å…‰æ ‡æ‰€åœ¨è¡Œæ’å…¥åˆ°ä¸Šä¸€è¡Œä¹‹å‰ï¼‰ã€‚  
Ctrl+Shift+â†“ å°†å…‰æ ‡æ‰€åœ¨è¡Œå’Œä¸‹ä¸€è¡Œä»£ç äº’æ¢ï¼ˆå°†å…‰æ ‡æ‰€åœ¨è¡Œæ’å…¥åˆ°ä¸‹ä¸€è¡Œä¹‹åï¼‰ã€‚  
Ctrl+Alt+â†‘ å‘ä¸Šæ·»åŠ å¤šè¡Œå…‰æ ‡ï¼Œå¯åŒæ—¶ç¼–è¾‘å¤šè¡Œã€‚  
Ctrl+Alt+â†“ å‘ä¸‹æ·»åŠ å¤šè¡Œå…‰æ ‡ï¼Œå¯åŒæ—¶ç¼–è¾‘å¤šè¡Œã€‚

#### ç¼–è¾‘ç±»

Ctrl+J åˆå¹¶é€‰ä¸­çš„å¤šè¡Œä»£ç ä¸ºä¸€è¡Œã€‚ä¸¾ä¸ªæ —å­ï¼šå°†å¤šè¡Œæ ¼å¼çš„ CSS å±æ€§åˆå¹¶ä¸ºä¸€è¡Œã€‚  
Ctrl+Shift+D å¤åˆ¶å…‰æ ‡æ‰€åœ¨æ•´è¡Œï¼Œæ’å…¥åˆ°ä¸‹ä¸€è¡Œã€‚  
Tab å‘å³ç¼©è¿›ã€‚  
Shift+Tab å‘å·¦ç¼©è¿›ã€‚  
Ctrl+K+K ä»å…‰æ ‡å¤„å¼€å§‹åˆ é™¤ä»£ç è‡³è¡Œå°¾ã€‚  
Ctrl+Shift+K åˆ é™¤æ•´è¡Œã€‚  
Ctrl+/ æ³¨é‡Šå•è¡Œã€‚  
Ctrl+Shift+/ æ³¨é‡Šå¤šè¡Œã€‚  
Ctrl+K+U è½¬æ¢å¤§å†™ã€‚  
Ctrl+K+L è½¬æ¢å°å†™ã€‚  
Ctrl+Z æ’¤é”€ã€‚  
Ctrl+Y æ¢å¤æ’¤é”€ã€‚  
Ctrl+U è½¯æ’¤é”€ï¼Œæ„Ÿè§‰å’Œ Gtrl+Z ä¸€æ ·ã€‚  
Ctrl+F2 è®¾ç½®ä¹¦ç­¾  
Ctrl+T å·¦å³å­—æ¯äº’æ¢ã€‚  
F6 å•è¯æ£€æµ‹æ‹¼å†™

#### æœç´¢ç±»

Ctrl+F æ‰“å¼€åº•éƒ¨æœç´¢æ¡†ï¼ŒæŸ¥æ‰¾å…³é”®å­—ã€‚  
Ctrl+shift+F åœ¨æ–‡ä»¶å¤¹å†…æŸ¥æ‰¾ï¼Œä¸æ™®é€šç¼–è¾‘å™¨ä¸åŒçš„åœ°æ–¹æ˜¯ sublime å…è®¸æ·»åŠ å¤šä¸ªæ–‡ä»¶å¤¹è¿›è¡ŒæŸ¥æ‰¾ï¼Œç•¥é«˜ç«¯ï¼Œæœªç ”ç©¶ã€‚  
Ctrl+P æ‰“å¼€æœç´¢æ¡†ã€‚ä¸¾ä¸ªæ —å­ï¼š1ã€è¾“å…¥å½“å‰é¡¹ç›®ä¸­çš„æ–‡ä»¶åï¼Œå¿«é€Ÿæœç´¢æ–‡ä»¶ï¼Œ2ã€è¾“å…¥ @å’Œå…³é”®å­—ï¼ŒæŸ¥æ‰¾æ–‡ä»¶ä¸­å‡½æ•°åï¼Œ3ã€è¾“å…¥ï¼šå’Œæ•°å­—ï¼Œè·³è½¬åˆ°æ–‡ä»¶ä¸­è¯¥è¡Œä»£ç ï¼Œ4ã€è¾“å…¥ #å’Œå…³é”®å­—ï¼ŒæŸ¥æ‰¾å˜é‡åã€‚  
Ctrl+G æ‰“å¼€æœç´¢æ¡†ï¼Œè‡ªåŠ¨å¸¦ï¼šï¼Œè¾“å…¥æ•°å­—è·³è½¬åˆ°è¯¥è¡Œä»£ç ã€‚ä¸¾ä¸ªæ —å­ï¼šåœ¨é¡µé¢ä»£ç æ¯”è¾ƒé•¿çš„æ–‡ä»¶ä¸­å¿«é€Ÿå®šä½ã€‚  
Ctrl+R æ‰“å¼€æœç´¢æ¡†ï¼Œè‡ªåŠ¨å¸¦ @ï¼Œè¾“å…¥å…³é”®å­—ï¼ŒæŸ¥æ‰¾æ–‡ä»¶ä¸­çš„å‡½æ•°åã€‚ä¸¾ä¸ªæ —å­ï¼šåœ¨å‡½æ•°è¾ƒå¤šçš„é¡µé¢å¿«é€ŸæŸ¥æ‰¾æŸä¸ªå‡½æ•°ã€‚  
Ctrl+ï¼š æ‰“å¼€æœç´¢æ¡†ï¼Œè‡ªåŠ¨å¸¦ #ï¼Œè¾“å…¥å…³é”®å­—ï¼ŒæŸ¥æ‰¾æ–‡ä»¶ä¸­çš„å˜é‡åã€å±æ€§åç­‰ã€‚  
Ctrl+Shift+P æ‰“å¼€å‘½ä»¤æ¡†ã€‚åœºæ™¯æ —å­ï¼šæ‰“å¼€å‘½åæ¡†ï¼Œè¾“å…¥å…³é”®å­—ï¼Œè°ƒç”¨ sublime text æˆ–æ’ä»¶çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ä½¿ç”¨ package å®‰è£…æ’ä»¶ã€‚  
Esc é€€å‡ºå…‰æ ‡å¤šè¡Œé€‰æ‹©ï¼Œé€€å‡ºæœç´¢æ¡†ï¼Œå‘½ä»¤æ¡†ç­‰ã€‚

#### æ˜¾ç¤ºç±»

Ctrl+Tab æŒ‰æ–‡ä»¶æµè§ˆè¿‡çš„é¡ºåºï¼Œåˆ‡æ¢å½“å‰çª—å£çš„æ ‡ç­¾é¡µã€‚  
Ctrl+PageDown å‘å·¦åˆ‡æ¢å½“å‰çª—å£çš„æ ‡ç­¾é¡µã€‚  
Ctrl+PageUp å‘å³åˆ‡æ¢å½“å‰çª—å£çš„æ ‡ç­¾é¡µã€‚  
Alt+Shift+1 çª—å£åˆ†å±ï¼Œæ¢å¤é»˜è®¤ 1 å±ï¼ˆéå°é”®ç›˜çš„æ•°å­—ï¼‰  
Alt+Shift+2 å·¦å³åˆ†å± - 2 åˆ—  
Alt+Shift+3 å·¦å³åˆ†å± - 3 åˆ—  
Alt+Shift+4 å·¦å³åˆ†å± - 4 åˆ—  
Alt+Shift+5 ç­‰åˆ† 4 å±  
Alt+Shift+8 å‚ç›´åˆ†å± - 2 å±  
Alt+Shift+9 å‚ç›´åˆ†å± - 3 å±  
Ctrl+K+B å¼€å¯ / å…³é—­ä¾§è¾¹æ ã€‚  
F11 å…¨å±æ¨¡å¼  
Shift+F11 å…æ‰“æ‰°æ¨¡å¼

